---
title: "Обновление приложения мобильных служб до службы приложений Azure"
description: "Узнайте, как без труда обновить приложение мобильных служб до мобильного приложения службы приложений."
services: app-service\mobile
documentationcenter: 
author: conceptdev
manager: crdun
editor: 
ms.assetid: 9c0ac353-afb6-462b-ab94-d91b8247322f
ms.service: app-service-mobile
ms.workload: mobile
ms.tgt_pltfrm: mobile
ms.devlang: dotnet
ms.topic: article
ms.date: 10/01/2016
ms.author: crdun
ms.openlocfilehash: f07b1d6037ff8ca16b673e6a1a235769355a9993
ms.sourcegitcommit: df4ddc55b42b593f165d56531f591fdb1e689686
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/04/2018
---
# <a name="upgrade-your-existing-net-azure-mobile-service-to-app-service"></a>Обновление существующего приложения мобильной службы Azure .NET до службы приложений
Мобильное приложение службы приложений — это новый способ сборки мобильных приложений с помощью Microsoft Azure. Дополнительные сведения см. в статье [Общие сведения о мобильных приложениях].

В этой статье описывается процесс обновления имеющегося серверного приложения .NET мобильных служб Azure до нового мобильного приложения службы приложений. Во время обновления существующее приложение мобильных служб может продолжать работать.   Если необходимо выполнить обновление серверной части приложения Node.js, см. статью [Обновление существующего приложения мобильной службы Azure Node.js до службы приложений](app-service-mobile-node-backend-upgrading-from-mobile-services.md).

Когда мобильное серверное приложение обновляется до службы приложений Azure, оно получает доступ ко всем возможностям службы приложений. Тарификация при этом будет осуществляться в соответствии с [ценами службы приложений], а не мобильных служб.

## <a name="migrate-vs-upgrade"></a>Миграция или обновление
[!INCLUDE [app-service-mobile-migrate-vs-upgrade](../../includes/app-service-mobile-migrate-vs-upgrade.md)]

> [!TIP]
> Перед обновлением рекомендуется [выполнить миграцию](app-service-mobile-migrating-from-mobile-services.md) . Таким образом, к обеим версиям приложения будет применен один тарифный план службы, и дополнительные затраты будут исключены.
>
>

### <a name="improvements-in-mobile-apps-net-server-sdk"></a>Улучшения в пакете SDK сервера .NET мобильных приложений
Обновление до новой версии [пакета SDK для мобильных приложений](https://www.nuget.org/packages/Microsoft.Azure.Mobile.Server/) обеспечивает перечисленные ниже преимущества.

* Дополнительная гибкость для зависимостей NuGet. Среда размещения больше не предоставляет собственные версии пакетов NuGet, позволяя вам использовать альтернативные совместимые версии. Однако при наличии новых критических исправлений или обновлений для системы безопасности для пакета SDK мобильного сервера или зависимостей службу потребуется обновить вручную.
* Дополнительная гибкость пакета SDK мобильных приложений. Можно явно управлять настройкой конкретных компонентов и маршрутов, таких как проверка подлинности, API таблиц и конечная точка регистрации push-уведомлений. Дополнительные сведения см. в статье [Работа с пакетом SDK для внутреннего сервера .NET для мобильных приложений Azure](app-service-mobile-dotnet-backend-how-to-use-server-sdk.md).
* Поддержка других маршрутов и типов проектов ASP.NET. Теперь вы можете размещать контроллеры MVC и веб-API в том же проекте, что и проект мобильного внутреннего сервера.
* Поддержка новых функций проверки подлинности службы приложений, которые позволяют использовать общую конфигурацию проверки подлинности для веб- и мобильных приложений.

## <a name="overview"></a>Общие сведения об обновлении
Во многих случаях обновление будет представлять собой просто переход на новый пакет SDK сервера для мобильных приложений и повторную публикацию кода в новом экземпляре мобильного приложения. Однако существует несколько сценариев, в которых потребуется дополнительная настройка, например расширенные сценарии проверки подлинности и работа с запланированными заданиями. Все они описываются в следующих разделах.

> [!TIP]
> Перед началом обновления рекомендуется полностью ознакомиться с остальной частью этого раздела. Запишите все используемые функции, которые вызываются ниже.
>
>

Пакеты SDK клиента для мобильных служб **не совместимы** с новым пакетом SDK сервера для мобильных приложений. Чтобы обеспечить непрерывность обслуживания приложения, не следует публиковать изменения на сайте, который в настоящее время обслуживает опубликованные клиенты. Вместо этого нужно создать новое мобильное приложение, которое является дубликатом. Это приложение можно включить в тот же план службы приложений, чтобы избежать дополнительных финансовых затрат.

После этого у вас будет две версии приложения: одна, которая остается без изменений и обслуживает опубликованные приложения на практике, и другая, которую можно обновить и ориентировать на новый выпуск клиента. Переносить и тестировать код можно в любое удобное для вас время. Однако перед этим необходимо убедиться, что внесенные исправления применены к обеим версиям. Если вы считаете, что до последней версии уже обновлено требуемое количество клиентских приложений, при желании можно удалить исходное перенесенное приложение.

Полная схема процесса обновления выглядит следующим образом.

1. Создание нового мобильного приложения.
2. Обновление проекта для использования новых пакетов SDK для сервера.
3. Выпуск новой версии клиентского приложения.
4. (Необязательно) Удаление исходного перенесенного экземпляра миграции

## <a name="mobile-app-version"></a>Создание второго экземпляра приложения
Первый этап обновления — создание ресурса мобильного приложения, в котором будет размещаться новая версия вашего приложения. Если вы уже перенесли существующую мобильную службу, необходимо создать эту версию в том же плане размещения. Откройте [портал Azure] и перейдите к перенесенному приложению. Запишите план службы приложений, в котором оно выполняется.

Создайте второй экземпляр приложения, следуя [инструкциям по созданию серверной части .NET](app-service-mobile-dotnet-backend-how-to-use-server-sdk.md#create-app). При запросе на выбор плана службы приложений или "плана размещения" выберите план перенесенного приложения.

Скорее всего, вы захотите использовать ту же базу данных и концентратор уведомлений, которые использовали в мобильных службах. Вы можете скопировать эти значения. Для этого откройте [портал Azure], перейдите к исходному приложению и выберите **Параметры** > **Параметры приложения**. В разделе **Строки подключения** скопируйте `MS_NotificationHubConnectionString` и `MS_TableConnectionString`. Перейдите на новый сайт обновления и вставьте эти значения, перезаписав все существующие значения. Повторите эту процедуру для других необходимых параметров приложения. Если перенесенная служба не используется, строки подключения и параметры приложения можно просмотреть на вкладке **Настройка** раздела "Мобильные службы" на [классическом портале Azure].

Сделайте копию проекта ASP.NET для приложения и опубликуйте его на новом сайте. Используя копию клиентского приложения, обновленную с помощью нового URL-адреса, убедитесь, что все работает правильно.

## <a name="updating-the-server-project"></a>Обновление серверного проекта
Мобильные приложения предоставляют новый [пакет SDK для сервера мобильных приложений] , который предоставляет практически те же функции, что и среда выполнения мобильных служб. Во-первых, следует удалить все ссылки на пакеты мобильных служб. В диспетчере пакетов NuGet найдите `WindowsAzure.MobileServices.Backend`. Для большинства пакетов здесь будет отображаться несколько пакетов, включая `WindowsAzure.MobileServices.Backend.Tables` и `WindowsAzure.MobileServices.Backend.Entity`. В этом случае необходимо начать удаление с пакета в самой нижней части в дереве зависимостей, такого как `Entity`. При выводе запроса не удаляйте все зависимые пакеты. Повторяйте этот процесс, пока не будет удален сам `WindowsAzure.MobileServices.Backend` .

На этом этапе в вашем распоряжении будет находиться проект, который больше не ссылается на пакеты SDK мобильных служб.

Затем выполняется добавление ссылок на пакет SDK для мобильных приложений. Для данного обновления большинство разработчиков будет загружать и устанавливать пакет `Microsoft.Azure.Mobile.Server.Quickstart`, тем самым извлекая весь необходимый набор.

Различия между пакетами SDK приведут к возникновению ряда ошибок компилятора, однако их легко устранить (см. оставшуюся часть этого раздела).

### <a name="base-configuration"></a>Базовая конфигурация
Затем в файле WebApiConfig.cs можно заменить

        // Use this class to set configuration options for your mobile service
        ConfigOptions options = new ConfigOptions();

        // Use this class to set WebAPI configuration options
        HttpConfiguration config = ServiceConfig.Initialize(new ConfigBuilder(options));

на

        HttpConfiguration config = new HttpConfiguration();
        new MobileAppConfiguration()
            .UseDefaultConfiguration()
        .ApplyTo(config);

> [!NOTE]
> Дополнительные сведения о новом пакете SDK для сервера .NET и о том, как добавить или удалить компоненты из приложения, см. в статье [Работа с пакетом SDK для внутреннего сервера .NET для мобильных приложений Azure].
>
>

Если в приложении используются функции проверки подлинности, также потребуется зарегистрировать ПО промежуточного слоя OWIN. В этом случае приведенный выше код конфигурации следует переместить в новый класс запуска OWIN.

1. Добавьте пакет NuGet `Microsoft.Owin.Host.SystemWeb` , если он еще не добавлен в проект.
2. В Visual Studio щелкните правой кнопкой мыши проект и последовательно выберите **Добавить** -> **Новый элемент**. Выберите **Интернет** -> **Общие** -> **Класс Startup OWIN**.
3. Перенесите приведенный выше код для MobileAppConfiguration из `WebApiConfig.Register()` в метод `Configuration()` нового класса запуска.

Убедитесь, что в конце метода `Configuration()` указано следующее:

        app.UseWebApi(config)
        app.UseAppServiceAuthentication(config);

Дополнительные изменения, связанные с проверкой подлинности, рассматриваются в разделе о полной проверке подлинности.

### <a name="working-with-data"></a>Работа с данными
В мобильных службах имя мобильного приложения являлось именем схемы по умолчанию в настройках Entity Framework.

Чтобы убедиться, что указывается та же схема, что и прежде, используйте следующий код, чтобы задать схему в DbContext для вашего приложения:

        string schema = System.Configuration.ConfigurationManager.AppSettings.Get("MS_MobileServiceName");

В этом случае проверьте, что задан параметр MS_MobileServiceName. Если имя схемы в приложении было настроено ранее, можно также указать другое имя.

### <a name="system-properties"></a>Свойства системы
#### <a name="naming"></a>Именование
В пакете SDK сервера для мобильных служб Azure свойства системы всегда содержат префикс в виде двойного символа подчеркивания (`__`) для следующих свойств:

* __createdAt
* __updatedAt
* __deleted
* __version

Пакеты SDK клиента мобильных служб имеют специальную логику для анализа свойства системы в данном формате.

В мобильных приложениях Azure свойства системы больше не имеют особого формата, и им заданы следующие имена:

* дата создания
* дата обновления
* deleted
* версия

В пакетах SDK клиента для мобильных приложений используются новые имена свойств системы, поэтому изменять клиентский код не требуется. Однако если вызовы REST к службе выполняются напрямую, следует соответствующим образом изменить запросы.

#### <a name="local-store"></a>Локальное хранилище
Изменения имен свойств системы означают, что локальная база данных автономной синхронизации для мобильных служб не совместима с мобильными приложениями. По возможности следует избегать обновления клиентский приложений с мобильных служб до мобильных приложений до тех пор, пока ожидающие изменения не будут отправлены на сервер. После этого обновленное приложение должно использовать новое имя файла базы данных.

Если клиентское приложение обновляется с мобильных служб до мобильных приложений при наличии в очереди операций ожидающих автономных изменений, системная база данных должна быть обновлена для использования новых имен столбцов. В iOS изменить имена столбцов можно с помощью упрощенных миграций. В ОС Android и управляемом клиенте .NET необходимо написать настраиваемый SQL для переименования столбцов для таблиц объектов данных.

В iOS необходимо изменить схему основных данных для сущностей данных в соответствии с приведенными ниже условиями. Обратите внимание, что у свойств `createdAt`, `updatedAt` и `version` больше нет префикса `ms_`.

| Атрибут | type | Примечание |
| --- | --- | --- |
| id |Строка, помеченная как обязательная |первичный ключ в удаленном хранилище |
| дата создания |Дата |(необязательно) сопоставляется с системным свойством createdAt |
| дата обновления |Дата |(необязательно) сопоставляется с системным свойством updatedAt |
| версия |Строка |(необязательно) используется для обнаружения конфликтов, сопоставляется со свойством version |

#### <a name="querying-system-properties"></a>Выполнение запросов к свойствам системы
В мобильных службах Azure свойства системы не отправляются по умолчанию. Однако это происходит только в том случае, когда они запрашиваются с помощью строки запроса `__systemProperties`. Напротив, свойства системы мобильных приложений Azure **всегда выбираются**, так как они являются частью объектной модели серверного пакета SDK.

Это изменение влияет главным образом на настраиваемые реализации диспетчеров доменов, такие как расширения `MappedEntityDomainManager`. Если клиент в мобильных службах никогда не запрашивает свойства системы, можно использовать `MappedEntityDomainManager` , который на самом деле не сопоставляет все свойства. Однако в мобильных приложениях Azure эти несопоставленные свойства приведут к возникновению ошибок в запросах GET.

Самым простым способом решения этой проблемы является изменение объектов DTO таким образом, чтобы они наследовали `ITableData` вместо `EntityData`. Затем добавьте атрибут `[NotMapped]` в поля, которые следует пропустить.

Например, следующий код определяет `TodoItem` без свойств системы:

    using System.ComponentModel.DataAnnotations.Schema;

    public class TodoItem : ITableData
    {
        public string Text { get; set; }

        public bool Complete { get; set; }

        public string Id { get; set; }

        [NotMapped]
        public DateTimeOffset? CreatedAt { get; set; }

        [NotMapped]
        public DateTimeOffset? UpdatedAt { get; set; }

        [NotMapped]
        public bool Deleted { get; set; }

        [NotMapped]
        public byte[] Version { get; set; }
    }

Примечание. Если возникли ошибки в `NotMapped`, добавьте ссылку на сборку `System.ComponentModel.DataAnnotations`.

### <a name="cors"></a>CORS
Мобильные службы обеспечивают определенную поддержку CORS путем заключения решения ASP.NET CORS в оболочку. Этот уровень заключения был удален в целях предоставления разработчикам дополнительного контроля для непосредственного использования [поддержки ASP.NET CORS](http://www.asp.net/web-api/overview/security/enabling-cross-origin-requests-in-web-api).

Основные проблемы при использовании CORS заключаются в необходимости разрешить заголовки `eTag` и `Location` для правильной работы пакетов SDK клиента.

### <a name="push-notifications"></a>Push-уведомления
Для отправки основной элемент, который может отсутствовать в пакете SDK для сервера, — это класс PushRegistrationHandler. Регистрации в мобильных приложениях обрабатываются немного по-другому, и способы регистрации без тегов включены по умолчанию. Управление тегами осуществляется с помощью пользовательских API. Дополнительные сведения см. в инструкциях по [регистрации для использования тегов](app-service-mobile-dotnet-backend-how-to-use-server-sdk.md#tags).

### <a name="scheduled-jobs"></a>Запланированные задания
Запланированные задания не встраиваются в мобильные приложения, поэтому все существующие задания в серверной части .NET потребуется обновлять по отдельности. Один из вариантов — создать запланированное [веб-задание] на сайте кода мобильных приложений. Можно также настроить контроллер, содержащий код задания, и задать в [планировщике Azure] вызов конечной точки по ожидаемому расписанию.

### <a name="miscellaneous-changes"></a>Прочие изменения
Теперь все классы ApiController, которые будут использоваться мобильным клиентом, должны иметь атрибут `[MobileAppController]` . Это больше не является условием по умолчанию, поэтому другие классы ApiController не будут затрагиваться мобильными средствами форматирования.

Объект `ApiServices` больше не входит в пакет SDK. Для доступа к параметрам мобильного приложения можно использовать следующее:

    MobileAppSettingsDictionary settings = this.Configuration.GetMobileAppSettingsProvider().GetMobileAppSettings();

Аналогично, теперь ведение журнала выполняется с помощью стандартной записи трассировки ASP.NET:

    ITraceWriter traceWriter = this.Configuration.Services.GetTraceWriter();
    traceWriter.Info("Hello, World");  

## <a name="authentication"></a>Рекомендации по проверке подлинности
Компоненты проверки подлинности мобильных служб перемещены в функцию проверки подлинности и авторизации службы приложений. Дополнительные сведения о том, как это сделать для сайта, см. в статье [Add authentication to your mobile app](app-service-mobile-ios-get-started-users.md) (Добавление проверки подлинности в мобильное приложение).

При работе с некоторыми поставщиками, например AAD, Facebook и Google, требуется возможность использования существующей регистрации из копии приложения. Нужно просто перейти на портал поставщика удостоверений и добавить к регистрации новый URL-адрес перенаправления. Затем настройте проверку подлинности и авторизацию службы приложений с идентификатором клиента и секретом.

### <a name="controller-action-authorization"></a>Авторизация действий контроллера
Теперь все экземпляры атрибута `[AuthorizeLevel(AuthorizationLevel.User)]` необходимо изменить для использования стандартного атрибута ASP.NET `[Authorize]`. Кроме того, теперь контроллеры являются анонимными по умолчанию, как и в других приложениях ASP.NET.
Если вы использовали один из других параметров AuthorizeLevel, например Admin или Application, обратите внимание, что их больше нет. Вместо этого можно настроить атрибут AuthorizationFilters для общих секретов или настроить участника службы AAD для безопасного выполнения вызовов между службами.

### <a name="getting-additional-user-information"></a>Получение дополнительных сведений о пользователе
Дополнительные сведения о пользователях, включая маркеры доступа, можно получить с помощью метода `GetAppServiceIdentityAsync()` .

        FacebookCredentials creds = await this.User.GetAppServiceIdentityAsync<FacebookCredentials>();

Кроме того, если приложение получает зависимости в идентификаторах пользователей, например сохраняет их в базе данных, важно обратить внимание на то, что идентификаторы пользователей в мобильных службах и мобильных приложениях служб приложений отличаются. Однако можно по-прежнему получить идентификатор пользователя мобильных служб. Все подклассы ProviderCredentials имеют свойство UserId. Продолжим с предыдущим примером:

        string mobileServicesUserId = creds.Provider + ":" + creds.UserId;

Если ваше приложение получает зависимости от идентификаторов пользователей, важно использовать тот же способ регистрации и того же поставщика удостоверений, если это возможно. Идентификаторы пользователей обычно относятся к использованному способу регистрации приложений, поэтому новый способ регистрации может вызвать проблемы с сопоставлением пользователей с их данными.

### <a name="custom-authentication"></a>Настраиваемая проверка подлинности
Если ваше приложение использует решение для настраиваемой проверки подлинности, необходимо убедиться, что обновленный сайт имеет доступ к системе. Инструкции по интеграции решения см. в статье [Работа с пакетом SDK для внутреннего сервера .NET для мобильных приложений Azure]. Обратите внимание, что компоненты настраиваемой проверки подлинности все еще находятся на стадии предварительной версии.

## <a name="updating-clients"></a>Обновление клиентов
После получения рабочей серверной части мобильных приложений вы можете работать с новой версией клиентского приложения, которое использует эту серверную часть. Мобильные приложения также содержат новую версию клиентских пакетов SDK. Поэтому, как и при обновлении сервера, перед установкой версий мобильных приложений потребуется удалить все ссылки на пакеты SDK для мобильных служб.

Одно из основных различий между версиями заключается в том, что конструкторам больше не требуется ключ приложения. Просто передайте URL-адрес мобильного приложения. Например, в клиентах .NET конструктор `MobileServiceClient` теперь выглядит так:

        public static MobileServiceClient MobileService = new MobileServiceClient(
            "https://contoso.azurewebsites.net", // URL of the Mobile App
        );

Сведения об установке новых пакетов SDK и использовании новой структуры см. по ссылкам ниже:

* [iOS 3.0.0 или более поздней версии](app-service-mobile-ios-how-to-use-client-library.md)
* [.NET (Windows/Xamarin) 2.0.0 или более поздней версии](app-service-mobile-dotnet-how-to-use-client-library.md)

Если приложение использует push-уведомления, обратите внимание на особые инструкции по регистрации для каждой платформы, так как они немного изменились.

Когда новая версия клиента будет готова, испробуйте ее в новом обновленном серверном проекте. После проверки ее работы вы можете предоставить новую версию приложения клиентам. Когда как клиенты смогут получить эти обновления, версию мобильных служб приложения можно удалить. Этот шаг завершает обновление до мобильного приложения службы приложений с помощью последнего пакета SDK сервера мобильных приложений.

<!-- URLs. -->

[портал Azure]: https://portal.azure.com/
[классическом портале Azure]: https://manage.windowsazure.com/
[Общие сведения о мобильных приложениях]: app-service-mobile-value-prop.md
[I already use web sites and mobile services – how does App Service help me?]: /en-us/documentation/articles/app-service-mobile-value-prop-migration-from-mobile-services
[пакет SDK для сервера мобильных приложений]: http://www.nuget.org/packages/microsoft.azure.mobile.server
[Create a Mobile App]: app-service-mobile-xamarin-ios-get-started.md
[Add push notifications to your mobile app]: app-service-mobile-xamarin-ios-get-started-push.md
[Add authentication to your mobile app]: app-service-mobile-xamarin-ios-get-started-users.md
[планировщике Azure]: /en-us/documentation/services/scheduler/
[веб-задание]: https://github.com/Azure/azure-webjobs-sdk/wiki
[Работа с пакетом SDK для внутреннего сервера .NET для мобильных приложений Azure]: app-service-mobile-dotnet-backend-how-to-use-server-sdk.md
[Migrate from Mobile Services to an App Service Mobile App]: app-service-mobile-migrating-from-mobile-services.md
[Migrate your existing Mobile Service to App Service]: app-service-mobile-migrating-from-mobile-services.md
[ценами службы приложений]: https://azure.microsoft.com/en-us/pricing/details/app-service/
[Работа с пакетом SDK для внутреннего сервера .NET для мобильных приложений Azure]: app-service-mobile-dotnet-backend-how-to-use-server-sdk.md

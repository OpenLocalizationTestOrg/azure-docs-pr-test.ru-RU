---
title: "aaaAnalyze Application Insight заносит в журнал с Spark - Azure HDInsight | Документы Microsoft"
description: "Узнайте, каким образом tooexport Application Insight ведет журнал tooblob хранилища, а затем проанализировать журналы hello с Spark в HDInsight."
services: hdinsight
documentationcenter: 
author: Blackmist
manager: jhubbard
editor: cgronlun
ms.assetid: 883beae6-9839-45b5-94f7-7eb0f4534ad5
ms.service: hdinsight
ms.custom: hdinsightactive
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: big-data
ms.date: 08/15/2017
ms.author: larryfr
ms.openlocfilehash: 11ed8cf68dba8d5f9d6e4a65eba0d2b5a950cd00
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="analyze-application-insights-telemetry-logs-with-spark-on-hdinsight"></a><span data-ttu-id="232e0-103">Анализ журналов телеметрии Application Insights с помощью Spark в HDInsight</span><span class="sxs-lookup"><span data-stu-id="232e0-103">Analyze Application Insights telemetry logs with Spark on HDInsight</span></span>

<span data-ttu-id="232e0-104">Узнайте, как любые блестящие toouse на HDInsight tooanalyze данные телеметрии Application Insight.</span><span class="sxs-lookup"><span data-stu-id="232e0-104">Learn how toouse Spark on HDInsight tooanalyze Application Insight telemetry data.</span></span>

<span data-ttu-id="232e0-105">[Visual Studio Application Insights](../application-insights/app-insights-overview.md) — это служба аналитики, которая отслеживает ваши веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="232e0-105">[Visual Studio Application Insights](../application-insights/app-insights-overview.md) is an analytics service that monitors your web applications.</span></span> <span data-ttu-id="232e0-106">Данные телеметрии, созданные Application Insights может быть экспортированного tooAzure хранилища.</span><span class="sxs-lookup"><span data-stu-id="232e0-106">Telemetry data generated by Application Insights can be exported tooAzure Storage.</span></span> <span data-ttu-id="232e0-107">После hello данных в хранилище Azure, HDInsight можно использовать tooanalyze его.</span><span class="sxs-lookup"><span data-stu-id="232e0-107">Once hello data is in Azure Storage, HDInsight can be used tooanalyze it.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="232e0-108">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="232e0-108">Prerequisites</span></span>

* <span data-ttu-id="232e0-109">Это приложение, настроить toouse Application Insights.</span><span class="sxs-lookup"><span data-stu-id="232e0-109">An application that is configured toouse Application Insights.</span></span>

* <span data-ttu-id="232e0-110">Умение создавать кластеры HDInsight под управлением Linux.</span><span class="sxs-lookup"><span data-stu-id="232e0-110">Familiarity with creating a Linux-based HDInsight cluster.</span></span> <span data-ttu-id="232e0-111">Дополнительные сведения см. в статье [Начало работы. Создание кластера Apache Spark в Azure HDInsight и выполнение интерактивных запросов с помощью SQL Spark](hdinsight-apache-spark-jupyter-spark-sql.md).</span><span class="sxs-lookup"><span data-stu-id="232e0-111">For more information, see [Create Spark on HDInsight](hdinsight-apache-spark-jupyter-spark-sql.md).</span></span>

  > [!IMPORTANT]
  > <span data-ttu-id="232e0-112">Hello в данном пошаговом руководстве требуется кластер HDInsight, использующий Linux.</span><span class="sxs-lookup"><span data-stu-id="232e0-112">hello steps in this document require an HDInsight cluster that uses Linux.</span></span> <span data-ttu-id="232e0-113">Linux — hello только операционную систему, используемую в HDInsight версии 3.4 или более поздней.</span><span class="sxs-lookup"><span data-stu-id="232e0-113">Linux is hello only operating system used on HDInsight version 3.4 or greater.</span></span> <span data-ttu-id="232e0-114">Дополнительные сведения см. в разделе [Приближается дата прекращения сопровождения HDI версии 3.3](hdinsight-component-versioning.md#hdinsight-windows-retirement).</span><span class="sxs-lookup"><span data-stu-id="232e0-114">For more information, see [HDInsight retirement on Windows](hdinsight-component-versioning.md#hdinsight-windows-retirement).</span></span>

* <span data-ttu-id="232e0-115">Веб-браузер.</span><span class="sxs-lookup"><span data-stu-id="232e0-115">A web browser.</span></span>

<span data-ttu-id="232e0-116">Hello следующие ресурсы были использованы при разработке и тестировании, в этом документе:</span><span class="sxs-lookup"><span data-stu-id="232e0-116">hello following resources were used in developing and testing this document:</span></span>

* <span data-ttu-id="232e0-117">Данные телеметрии Application Insights была создана с помощью [toouse Application Insights настроена веб-приложение Node.js](../application-insights/app-insights-nodejs.md).</span><span class="sxs-lookup"><span data-stu-id="232e0-117">Application Insights telemetry data was generated using a [Node.js web app configured toouse Application Insights](../application-insights/app-insights-nodejs.md).</span></span>

* <span data-ttu-id="232e0-118">Spark на основе Linux в кластере HDInsight версии 3.5 был данных используется tooanalyze hello.</span><span class="sxs-lookup"><span data-stu-id="232e0-118">A Linux-based Spark on HDInsight cluster version 3.5 was used tooanalyze hello data.</span></span>

## <a name="architecture-and-planning"></a><span data-ttu-id="232e0-119">Архитектура и планирование</span><span class="sxs-lookup"><span data-stu-id="232e0-119">Architecture and planning</span></span>

<span data-ttu-id="232e0-120">Следующая схема Hello показана архитектура службы hello в этом примере:</span><span class="sxs-lookup"><span data-stu-id="232e0-120">hello following diagram illustrates hello service architecture of this example:</span></span>

![Схема, показывающая данных, передаваемых из хранилища tooblob Application Insights, а затем, обрабатываемых Spark в HDInsight](./media/hdinsight-spark-analyze-application-insight-logs/appinsightshdinsight.png)

### <a name="azure-storage"></a><span data-ttu-id="232e0-122">Хранилище Azure</span><span class="sxs-lookup"><span data-stu-id="232e0-122">Azure storage</span></span>

<span data-ttu-id="232e0-123">Application Insights может быть настроенный toocontinuously экспорта телеметрии сведения tooblobs.</span><span class="sxs-lookup"><span data-stu-id="232e0-123">Application Insights can be configured toocontinuously export telemetry information tooblobs.</span></span> <span data-ttu-id="232e0-124">HDInsight затем может считывать данные, хранящиеся в hello больших двоичных объектов.</span><span class="sxs-lookup"><span data-stu-id="232e0-124">HDInsight can then read data stored in hello blobs.</span></span> <span data-ttu-id="232e0-125">Однако существует ряд требований, которые необходимо выполнить. Они описаны ниже.</span><span class="sxs-lookup"><span data-stu-id="232e0-125">However, there are some requirements that you must follow:</span></span>

* <span data-ttu-id="232e0-126">**Расположение**: hello учетной записи хранилища и HDInsight находятся в разных регионах, это может увеличить Если задержки.</span><span class="sxs-lookup"><span data-stu-id="232e0-126">**Location**: If hello Storage Account and HDInsight are in different locations, it may increase latency.</span></span> <span data-ttu-id="232e0-127">Также увеличивает затраты, как расходов на исходящие данные будут применяться toodata перемещение между областями.</span><span class="sxs-lookup"><span data-stu-id="232e0-127">It also increases cost, as egress charges are applied toodata moving between regions.</span></span>

    > [!WARNING]
    > <span data-ttu-id="232e0-128">Использование учетной записи хранения, расположение которой отличается от расположения кластера HDInsight, не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="232e0-128">Using a Storage Account in a different location than HDInsight is not supported.</span></span>

* <span data-ttu-id="232e0-129">**Тип большого двоичного объекта.** HDInsight поддерживает только блочные BLOB-объекты.</span><span class="sxs-lookup"><span data-stu-id="232e0-129">**Blob type**: HDInsight only supports block blobs.</span></span> <span data-ttu-id="232e0-130">Application Insights по умолчанию toousing блочных больших двоичных объектов, поэтому должны работать по умолчанию с HDInsight.</span><span class="sxs-lookup"><span data-stu-id="232e0-130">Application Insights defaults toousing block blobs, so should work by default with HDInsight.</span></span>

<span data-ttu-id="232e0-131">Сведения о добавлении существующий кластер HDInsight tooan дополнительного хранилища см. в разделе hello [добавить дополнительные учетные записи хранения](hdinsight-hadoop-add-storage.md) документа.</span><span class="sxs-lookup"><span data-stu-id="232e0-131">For information on adding additional storage tooan existing HDInsight cluster, see hello [Add additional storage accounts](hdinsight-hadoop-add-storage.md) document.</span></span>

### <a name="data-schema"></a><span data-ttu-id="232e0-132">Схема данных</span><span class="sxs-lookup"><span data-stu-id="232e0-132">Data schema</span></span>

<span data-ttu-id="232e0-133">Предоставляет Application Insights [Экспорт модели данных](../application-insights/app-insights-export-data-model.md) tooblobs экспортировать сведения о формате данных телеметрии hello.</span><span class="sxs-lookup"><span data-stu-id="232e0-133">Application Insights provides [export data model](../application-insights/app-insights-export-data-model.md) information for hello telemetry data format exported tooblobs.</span></span> <span data-ttu-id="232e0-134">Hello в данном пошаговом руководстве используется toowork Spark SQL с данными hello.</span><span class="sxs-lookup"><span data-stu-id="232e0-134">hello steps in this document use Spark SQL toowork with hello data.</span></span> <span data-ttu-id="232e0-135">Spark SQL может автоматически сформировать схему для структуры данных JSON hello, записанных службой Application Insights.</span><span class="sxs-lookup"><span data-stu-id="232e0-135">Spark SQL can automatically generate a schema for hello JSON data structure logged by Application Insights.</span></span>

## <a name="export-telemetry-data"></a><span data-ttu-id="232e0-136">Экспорт данных телеметрии</span><span class="sxs-lookup"><span data-stu-id="232e0-136">Export telemetry data</span></span>

<span data-ttu-id="232e0-137">Следуйте указаниям hello [Настройка непрерывного экспорта](../application-insights/app-insights-export-telemetry.md) tooconfigure к Application Insights tooexport телеметрии сведения tooan хранилища Azure BLOB-объектов.</span><span class="sxs-lookup"><span data-stu-id="232e0-137">Follow hello steps in [Configure Continuous Export](../application-insights/app-insights-export-telemetry.md) tooconfigure your Application Insights tooexport telemetry information tooan Azure storage blob.</span></span>

## <a name="configure-hdinsight-tooaccess-hello-data"></a><span data-ttu-id="232e0-138">Настройка данных hello tooaccess HDInsight</span><span class="sxs-lookup"><span data-stu-id="232e0-138">Configure HDInsight tooaccess hello data</span></span>

<span data-ttu-id="232e0-139">При создании кластера HDInsight, добавьте учетную запись хранилища hello во время создания кластера.</span><span class="sxs-lookup"><span data-stu-id="232e0-139">If you are creating an HDInsight cluster, add hello storage account during cluster creation.</span></span>

<span data-ttu-id="232e0-140">hello tooadd существующего кластера tooan учетной записи хранилища Azure, используйте сведения hello hello [добавить дополнительные учетные записи хранения](hdinsight-hadoop-add-storage.md) документа.</span><span class="sxs-lookup"><span data-stu-id="232e0-140">tooadd hello Azure Storage Account tooan existing cluster, use hello information in hello [Add additional Storage Accounts](hdinsight-hadoop-add-storage.md) document.</span></span>

## <a name="analyze-hello-data-pyspark"></a><span data-ttu-id="232e0-141">Анализ данных hello: PySpark</span><span class="sxs-lookup"><span data-stu-id="232e0-141">Analyze hello data: PySpark</span></span>

1. <span data-ttu-id="232e0-142">Из hello [портал Azure](https://portal.azure.com), выберите в кластере HDInsight Spark.</span><span class="sxs-lookup"><span data-stu-id="232e0-142">From hello [Azure portal](https://portal.azure.com), select your Spark on HDInsight cluster.</span></span> <span data-ttu-id="232e0-143">Из hello **быстрые ссылки** выберите **панели мониторинга кластера**, а затем выберите **книжке Jupyter** из колонки Dashboard__ кластера hello.</span><span class="sxs-lookup"><span data-stu-id="232e0-143">From hello **Quick Links** section, select **Cluster Dashboards**, and then select **Jupyter Notebook** from hello Cluster Dashboard__ blade.</span></span>

    ![панели мониторинга кластера Hello](./media/hdinsight-spark-analyze-application-insight-logs/clusterdashboards.png)

2. <span data-ttu-id="232e0-145">Hello верхний правый угол hello Jupyter страницы, выберите **New**, а затем **PySpark**.</span><span class="sxs-lookup"><span data-stu-id="232e0-145">In hello upper right corner of hello Jupyter page, select **New**, and then **PySpark**.</span></span> <span data-ttu-id="232e0-146">При этом откроется новая вкладка браузера, содержащая записную книжку Jupyter на основе Python.</span><span class="sxs-lookup"><span data-stu-id="232e0-146">A new browser tab containing a Python-based Jupyter Notebook opens.</span></span>

3. <span data-ttu-id="232e0-147">В первом поле hello (называется **ячейки**) на странице приветствия введите следующий текст hello:</span><span class="sxs-lookup"><span data-stu-id="232e0-147">In hello first field (called a **cell**) on hello page, enter hello following text:</span></span>

   ```python
   sc._jsc.hadoopConfiguration().set('mapreduce.input.fileinputformat.input.dir.recursive', 'true')
   ```

    <span data-ttu-id="232e0-148">Этот код настраивает Spark toorecursively доступа hello структуру каталогов hello входных данных.</span><span class="sxs-lookup"><span data-stu-id="232e0-148">This code configures Spark toorecursively access hello directory structure for hello input data.</span></span> <span data-ttu-id="232e0-149">Телеметрию Application Insights — toohello аналогичные структуры каталогов регистрируется tooa `/{telemetry type}/YYYY-MM-DD/{##}/`.</span><span class="sxs-lookup"><span data-stu-id="232e0-149">Application Insights telemetry is logged tooa directory structure similar toohello `/{telemetry type}/YYYY-MM-DD/{##}/`.</span></span>

4. <span data-ttu-id="232e0-150">Используйте **SHIFT + ВВОД** toorun кода hello.</span><span class="sxs-lookup"><span data-stu-id="232e0-150">Use **SHIFT+ENTER** toorun hello code.</span></span> <span data-ttu-id="232e0-151">На hello левая сторона ячейки hello "\*" отображается между hello скобки tooindicate выполнение кода hello в этой ячейке.</span><span class="sxs-lookup"><span data-stu-id="232e0-151">On hello left side of hello cell, an '\*' appears between hello brackets tooindicate that hello code in this cell is being executed.</span></span> <span data-ttu-id="232e0-152">По завершении его hello "\*" изменяет номер tooa и выходные данные, аналогичные toohello после текста отображается под hello ячейки:</span><span class="sxs-lookup"><span data-stu-id="232e0-152">Once it completes, hello '\*' changes tooa number, and output similar toohello following text is displayed below hello cell:</span></span>

        Creating SparkContext as 'sc'

        ID    YARN Application ID    Kind    State    Spark UI    Driver log    Current session?
        3    application_1468969497124_0001    pyspark    idle    Link    Link    ✔

        Creating HiveContext as 'sqlContext'
        SparkContext and HiveContext created. Executing user code ...
5. <span data-ttu-id="232e0-153">Ниже hello создается новая ячейка первый из них.</span><span class="sxs-lookup"><span data-stu-id="232e0-153">A new cell is created below hello first one.</span></span> <span data-ttu-id="232e0-154">Введите следующий текст в новую ячейку hello hello.</span><span class="sxs-lookup"><span data-stu-id="232e0-154">Enter hello following text in hello new cell.</span></span> <span data-ttu-id="232e0-155">Замените `CONTAINER` и `STORAGEACCOUNT` с именем учетной записи хранилища Azure hello и имя контейнера BLOB-объект, содержащий данные Application Insights.</span><span class="sxs-lookup"><span data-stu-id="232e0-155">Replace `CONTAINER` and `STORAGEACCOUNT` with hello Azure storage account name and blob container name that contains Application Insights data.</span></span>

   ```python
   %%bash
   hdfs dfs -ls wasb://CONTAINER@STORAGEACCOUNT.blob.core.windows.net/
   ```

    <span data-ttu-id="232e0-156">Используйте **SHIFT + ВВОД** tooexecute эту ячейку.</span><span class="sxs-lookup"><span data-stu-id="232e0-156">Use **SHIFT+ENTER** tooexecute this cell.</span></span> <span data-ttu-id="232e0-157">Можно увидеть примерно toohello результат, следующий текст:</span><span class="sxs-lookup"><span data-stu-id="232e0-157">You see a result similar toohello following text:</span></span>

        Found 1 items
        drwxrwxrwx   -          0 1970-01-01 00:00 wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_2bededa61bc741fbdee6b556571a4831

    <span data-ttu-id="232e0-158">Возвращаемый путь wasb Hello — расположение hello hello данные телеметрии Application Insights.</span><span class="sxs-lookup"><span data-stu-id="232e0-158">hello wasb path returned is hello location of hello Application Insights telemetry data.</span></span> <span data-ttu-id="232e0-159">Изменение hello `hdfs dfs -ls` hello ячейки toouse hello wasb пути возвращаются строки, а затем используйте **SHIFT + ВВОД** ячейки hello toorun еще раз.</span><span class="sxs-lookup"><span data-stu-id="232e0-159">Change hello `hdfs dfs -ls` line in hello cell toouse hello wasb path returned, and then use **SHIFT+ENTER** toorun hello cell again.</span></span> <span data-ttu-id="232e0-160">На этот раз результаты hello отображать hello каталогов, содержащих данные телеметрии.</span><span class="sxs-lookup"><span data-stu-id="232e0-160">This time, hello results should display hello directories that contain telemetry data.</span></span>

   > [!NOTE]
   > <span data-ttu-id="232e0-161">Здравствуйте, hello оставшуюся часть hello шагов в этом разделе, `wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_{ID}/Requests` каталог был использован.</span><span class="sxs-lookup"><span data-stu-id="232e0-161">For hello remainder of hello steps in this section, hello `wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_{ID}/Requests` directory was used.</span></span> <span data-ttu-id="232e0-162">Структура каталога может отличаться.</span><span class="sxs-lookup"><span data-stu-id="232e0-162">Your directory structure may be different.</span></span>

6. <span data-ttu-id="232e0-163">В следующей ячейке hello, введите после кода hello: замените `WASB_PATH` с путем hello из предыдущего шага hello.</span><span class="sxs-lookup"><span data-stu-id="232e0-163">In hello next cell, enter hello following code: Replace `WASB_PATH` with hello path from hello previous step.</span></span>

   ```python
   jsonFiles = sc.textFile('WASB_PATH')
   jsonData = sqlContext.read.json(jsonFiles)
   ```

    <span data-ttu-id="232e0-164">Этот код создает кадр данных из файлов JSON hello экспортировать процессом hello непрерывный экспорт.</span><span class="sxs-lookup"><span data-stu-id="232e0-164">This code creates a dataframe from hello JSON files exported by hello continuous export process.</span></span> <span data-ttu-id="232e0-165">Используйте **SHIFT + ВВОД** toorun эту ячейку.</span><span class="sxs-lookup"><span data-stu-id="232e0-165">Use **SHIFT+ENTER** toorun this cell.</span></span>
7. <span data-ttu-id="232e0-166">Hello следующую ячейку введите и выполните следующие схемы hello tooview создания Spark для файлов JSON hello hello.</span><span class="sxs-lookup"><span data-stu-id="232e0-166">In hello next cell, enter and run hello following tooview hello schema that Spark created for hello JSON files:</span></span>

   ```python
   jsonData.printSchema()
   ```

    <span data-ttu-id="232e0-167">Схема Hello для каждого типа телеметрии отличается.</span><span class="sxs-lookup"><span data-stu-id="232e0-167">hello schema for each type of telemetry is different.</span></span> <span data-ttu-id="232e0-168">Hello следующий пример является hello схемы, формируемой для веб-запросов (данные, хранящиеся в hello `Requests` подкаталог):</span><span class="sxs-lookup"><span data-stu-id="232e0-168">hello following example is hello schema that is generated for web requests (data stored in hello `Requests` subdirectory):</span></span>

        root
        |-- context: struct (nullable = true)
        |    |-- application: struct (nullable = true)
        |    |    |-- version: string (nullable = true)
        |    |-- custom: struct (nullable = true)
        |    |    |-- dimensions: array (nullable = true)
        |    |    |    |-- element: string (containsNull = true)
        |    |    |-- metrics: array (nullable = true)
        |    |    |    |-- element: string (containsNull = true)
        |    |-- data: struct (nullable = true)
        |    |    |-- eventTime: string (nullable = true)
        |    |    |-- isSynthetic: boolean (nullable = true)
        |    |    |-- samplingRate: double (nullable = true)
        |    |    |-- syntheticSource: string (nullable = true)
        |    |-- device: struct (nullable = true)
        |    |    |-- browser: string (nullable = true)
        |    |    |-- browserVersion: string (nullable = true)
        |    |    |-- deviceModel: string (nullable = true)
        |    |    |-- deviceName: string (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- osVersion: string (nullable = true)
        |    |    |-- type: string (nullable = true)
        |    |-- location: struct (nullable = true)
        |    |    |-- city: string (nullable = true)
        |    |    |-- clientip: string (nullable = true)
        |    |    |-- continent: string (nullable = true)
        |    |    |-- country: string (nullable = true)
        |    |    |-- province: string (nullable = true)
        |    |-- operation: struct (nullable = true)
        |    |    |-- name: string (nullable = true)
        |    |-- session: struct (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- isFirst: boolean (nullable = true)
        |    |-- user: struct (nullable = true)
        |    |    |-- anonId: string (nullable = true)
        |    |    |-- isAuthenticated: boolean (nullable = true)
        |-- internal: struct (nullable = true)
        |    |-- data: struct (nullable = true)
        |    |    |-- documentVersion: string (nullable = true)
        |    |    |-- id: string (nullable = true)
        |-- request: array (nullable = true)
        |    |-- element: struct (containsNull = true)
        |    |    |-- count: long (nullable = true)
        |    |    |-- durationMetric: struct (nullable = true)
        |    |    |    |-- count: double (nullable = true)
        |    |    |    |-- max: double (nullable = true)
        |    |    |    |-- min: double (nullable = true)
        |    |    |    |-- sampledValue: double (nullable = true)
        |    |    |    |-- stdDev: double (nullable = true)
        |    |    |    |-- value: double (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- name: string (nullable = true)
        |    |    |-- responseCode: long (nullable = true)
        |    |    |-- success: boolean (nullable = true)
        |    |    |-- url: string (nullable = true)
        |    |    |-- urlData: struct (nullable = true)
        |    |    |    |-- base: string (nullable = true)
        |    |    |    |-- hashTag: string (nullable = true)
        |    |    |    |-- host: string (nullable = true)
        |    |    |    |-- protocol: string (nullable = true)
8. <span data-ttu-id="232e0-169">Используйте следующий кадр данных hello tooregister как временную таблицу hello и выполнить запрос данных hello:</span><span class="sxs-lookup"><span data-stu-id="232e0-169">Use hello following tooregister hello dataframe as a temporary table and run a query against hello data:</span></span>

   ```python
   jsonData.registerTempTable("requests")
   df = sqlContext.sql("select context.location.city from requests where context.location.city is not null")
   df.show()
   ```

    <span data-ttu-id="232e0-170">Этот запрос возвращает сведения о городе hello для hello top 20 записей, где context.location.city не имеет значение null.</span><span class="sxs-lookup"><span data-stu-id="232e0-170">This query returns hello city information for hello top 20 records where context.location.city is not null.</span></span>

   > [!NOTE]
   > <span data-ttu-id="232e0-171">структура контекста Hello присутствует во все данные телеметрии, записанных службой Application Insights.</span><span class="sxs-lookup"><span data-stu-id="232e0-171">hello context structure is present in all telemetry logged by Application Insights.</span></span> <span data-ttu-id="232e0-172">элемент Город Hello не могут быть заполнены в журналах.</span><span class="sxs-lookup"><span data-stu-id="232e0-172">hello city element may not be populated in your logs.</span></span> <span data-ttu-id="232e0-173">Используйте схему tooidentify hello другим элементам, которые можно выполнить запрос, может содержать данные для журналов.</span><span class="sxs-lookup"><span data-stu-id="232e0-173">Use hello schema tooidentify other elements that you can query that may contain data for your logs.</span></span>

    <span data-ttu-id="232e0-174">Этот запрос возвращает сведения аналогичные toohello следующий текст:</span><span class="sxs-lookup"><span data-stu-id="232e0-174">This query returns information similar toohello following text:</span></span>

        +---------+
        |     city|
        +---------+
        | Bellevue|
        |  Redmond|
        |  Seattle|
        |Charlotte|
        ...
        +---------+

## <a name="analyze-hello-data-scala"></a><span data-ttu-id="232e0-175">Анализ данных hello: Scala</span><span class="sxs-lookup"><span data-stu-id="232e0-175">Analyze hello data: Scala</span></span>

1. <span data-ttu-id="232e0-176">Из hello [портал Azure](https://portal.azure.com), выберите в кластере HDInsight Spark.</span><span class="sxs-lookup"><span data-stu-id="232e0-176">From hello [Azure portal](https://portal.azure.com), select your Spark on HDInsight cluster.</span></span> <span data-ttu-id="232e0-177">Из hello **быстрые ссылки** выберите **панели мониторинга кластера**, а затем выберите **книжке Jupyter** из колонки Dashboard__ кластера hello.</span><span class="sxs-lookup"><span data-stu-id="232e0-177">From hello **Quick Links** section, select **Cluster Dashboards**, and then select **Jupyter Notebook** from hello Cluster Dashboard__ blade.</span></span>

    ![панели мониторинга кластера Hello](./media/hdinsight-spark-analyze-application-insight-logs/clusterdashboards.png)
2. <span data-ttu-id="232e0-179">Hello верхний правый угол hello Jupyter страницы, выберите **New**, а затем **Scala**.</span><span class="sxs-lookup"><span data-stu-id="232e0-179">In hello upper right corner of hello Jupyter page, select **New**, and then **Scala**.</span></span> <span data-ttu-id="232e0-180">При этом откроется новая вкладка браузера, содержащая записную книжку Jupyter на основе Scala.</span><span class="sxs-lookup"><span data-stu-id="232e0-180">A new browser tab containing a Scala-based Jupyter Notebook appears.</span></span>
3. <span data-ttu-id="232e0-181">В первом поле hello (называется **ячейки**) на странице приветствия введите следующий текст hello:</span><span class="sxs-lookup"><span data-stu-id="232e0-181">In hello first field (called a **cell**) on hello page, enter hello following text:</span></span>

   ```scala
   sc.hadoopConfiguration.set("mapreduce.input.fileinputformat.input.dir.recursive", "true")
   ```

    <span data-ttu-id="232e0-182">Этот код настраивает Spark toorecursively доступа hello структуру каталогов hello входных данных.</span><span class="sxs-lookup"><span data-stu-id="232e0-182">This code configures Spark toorecursively access hello directory structure for hello input data.</span></span> <span data-ttu-id="232e0-183">Данные телеметрии Application Insights в журнал аналогичную структуру каталогов tooa слишком`/{telemetry type}/YYYY-MM-DD/{##}/`.</span><span class="sxs-lookup"><span data-stu-id="232e0-183">Application Insights telemetry is logged tooa directory structure similar too`/{telemetry type}/YYYY-MM-DD/{##}/`.</span></span>

4. <span data-ttu-id="232e0-184">Используйте **SHIFT + ВВОД** toorun кода hello.</span><span class="sxs-lookup"><span data-stu-id="232e0-184">Use **SHIFT+ENTER** toorun hello code.</span></span> <span data-ttu-id="232e0-185">На hello левая сторона ячейки hello "\*" отображается между hello скобки tooindicate выполнение кода hello в этой ячейке.</span><span class="sxs-lookup"><span data-stu-id="232e0-185">On hello left side of hello cell, an '\*' appears between hello brackets tooindicate that hello code in this cell is being executed.</span></span> <span data-ttu-id="232e0-186">По завершении его hello "\*" изменяет номер tooa и выходные данные, аналогичные toohello после текста отображается под hello ячейки:</span><span class="sxs-lookup"><span data-stu-id="232e0-186">Once it completes, hello '\*' changes tooa number, and output similar toohello following text is displayed below hello cell:</span></span>

        Creating SparkContext as 'sc'

        ID    YARN Application ID    Kind    State    Spark UI    Driver log    Current session?
        3    application_1468969497124_0001    spark    idle    Link    Link    ✔

        Creating HiveContext as 'sqlContext'
        SparkContext and HiveContext created. Executing user code ...
5. <span data-ttu-id="232e0-187">Ниже hello создается новая ячейка первый из них.</span><span class="sxs-lookup"><span data-stu-id="232e0-187">A new cell is created below hello first one.</span></span> <span data-ttu-id="232e0-188">Введите следующий текст в новую ячейку hello hello.</span><span class="sxs-lookup"><span data-stu-id="232e0-188">Enter hello following text in hello new cell.</span></span> <span data-ttu-id="232e0-189">Замените `CONTAINER` и `STORAGEACCOUNT` с именем учетной записи хранилища Azure hello и имя контейнера BLOB-объект, содержащий Application Insights журналы.</span><span class="sxs-lookup"><span data-stu-id="232e0-189">Replace `CONTAINER` and `STORAGEACCOUNT` with hello Azure storage account name and blob container name that contains Application Insights logs.</span></span>

   ```scala
   %%bash
   hdfs dfs -ls wasb://CONTAINER@STORAGEACCOUNT.blob.core.windows.net/
   ```

    <span data-ttu-id="232e0-190">Используйте **SHIFT + ВВОД** tooexecute эту ячейку.</span><span class="sxs-lookup"><span data-stu-id="232e0-190">Use **SHIFT+ENTER** tooexecute this cell.</span></span> <span data-ttu-id="232e0-191">Можно увидеть примерно toohello результат, следующий текст:</span><span class="sxs-lookup"><span data-stu-id="232e0-191">You see a result similar toohello following text:</span></span>

        Found 1 items
        drwxrwxrwx   -          0 1970-01-01 00:00 wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_2bededa61bc741fbdee6b556571a4831

    <span data-ttu-id="232e0-192">Возвращаемый путь wasb Hello — расположение hello hello данные телеметрии Application Insights.</span><span class="sxs-lookup"><span data-stu-id="232e0-192">hello wasb path returned is hello location of hello Application Insights telemetry data.</span></span> <span data-ttu-id="232e0-193">Изменение hello `hdfs dfs -ls` hello ячейки toouse hello wasb пути возвращаются строки, а затем используйте **SHIFT + ВВОД** ячейки hello toorun еще раз.</span><span class="sxs-lookup"><span data-stu-id="232e0-193">Change hello `hdfs dfs -ls` line in hello cell toouse hello wasb path returned, and then use **SHIFT+ENTER** toorun hello cell again.</span></span> <span data-ttu-id="232e0-194">На этот раз результаты hello отображать hello каталогов, содержащих данные телеметрии.</span><span class="sxs-lookup"><span data-stu-id="232e0-194">This time, hello results should display hello directories that contain telemetry data.</span></span>

   > [!NOTE]
   > <span data-ttu-id="232e0-195">Здравствуйте, hello оставшуюся часть hello шагов в этом разделе, `wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_{ID}/Requests` каталог был использован.</span><span class="sxs-lookup"><span data-stu-id="232e0-195">For hello remainder of hello steps in this section, hello `wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_{ID}/Requests` directory was used.</span></span> <span data-ttu-id="232e0-196">Этот каталог может отсутствовать, если ваши данные телеметрии не предназначены для веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="232e0-196">This directory may not exist unless your telemetry data is for a web app.</span></span>

6. <span data-ttu-id="232e0-197">В следующей ячейке hello, введите после кода hello: замените `WASB\_PATH` с путем hello из предыдущего шага hello.</span><span class="sxs-lookup"><span data-stu-id="232e0-197">In hello next cell, enter hello following code: Replace `WASB\_PATH` with hello path from hello previous step.</span></span>

   ```scala
   var jsonFiles = sc.textFile('WASB_PATH')
   val sqlContext = new org.apache.spark.sql.SQLContext(sc)
   var jsonData = sqlContext.read.json(jsonFiles)
   ```

    <span data-ttu-id="232e0-198">Этот код создает кадр данных из файлов JSON hello экспортировать процессом hello непрерывный экспорт.</span><span class="sxs-lookup"><span data-stu-id="232e0-198">This code creates a dataframe from hello JSON files exported by hello continuous export process.</span></span> <span data-ttu-id="232e0-199">Используйте **SHIFT + ВВОД** toorun эту ячейку.</span><span class="sxs-lookup"><span data-stu-id="232e0-199">Use **SHIFT+ENTER** toorun this cell.</span></span>

7. <span data-ttu-id="232e0-200">Hello следующую ячейку введите и выполните следующие схемы hello tooview создания Spark для файлов JSON hello hello.</span><span class="sxs-lookup"><span data-stu-id="232e0-200">In hello next cell, enter and run hello following tooview hello schema that Spark created for hello JSON files:</span></span>

   ```scala
   jsonData.printSchema
   ```

    <span data-ttu-id="232e0-201">Схема Hello для каждого типа телеметрии отличается.</span><span class="sxs-lookup"><span data-stu-id="232e0-201">hello schema for each type of telemetry is different.</span></span> <span data-ttu-id="232e0-202">Hello следующий пример является hello схемы, формируемой для веб-запросов (данные, хранящиеся в hello `Requests` подкаталог):</span><span class="sxs-lookup"><span data-stu-id="232e0-202">hello following example is hello schema that is generated for web requests (data stored in hello `Requests` subdirectory):</span></span>

        root
        |-- context: struct (nullable = true)
        |    |-- application: struct (nullable = true)
        |    |    |-- version: string (nullable = true)
        |    |-- custom: struct (nullable = true)
        |    |    |-- dimensions: array (nullable = true)
        |    |    |    |-- element: string (containsNull = true)
        |    |    |-- metrics: array (nullable = true)
        |    |    |    |-- element: string (containsNull = true)
        |    |-- data: struct (nullable = true)
        |    |    |-- eventTime: string (nullable = true)
        |    |    |-- isSynthetic: boolean (nullable = true)
        |    |    |-- samplingRate: double (nullable = true)
        |    |    |-- syntheticSource: string (nullable = true)
        |    |-- device: struct (nullable = true)
        |    |    |-- browser: string (nullable = true)
        |    |    |-- browserVersion: string (nullable = true)
        |    |    |-- deviceModel: string (nullable = true)
        |    |    |-- deviceName: string (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- osVersion: string (nullable = true)
        |    |    |-- type: string (nullable = true)
        |    |-- location: struct (nullable = true)
        |    |    |-- city: string (nullable = true)
        |    |    |-- clientip: string (nullable = true)
        |    |    |-- continent: string (nullable = true)
        |    |    |-- country: string (nullable = true)
        |    |    |-- province: string (nullable = true)
        |    |-- operation: struct (nullable = true)
        |    |    |-- name: string (nullable = true)
        |    |-- session: struct (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- isFirst: boolean (nullable = true)
        |    |-- user: struct (nullable = true)
        |    |    |-- anonId: string (nullable = true)
        |    |    |-- isAuthenticated: boolean (nullable = true)
        |-- internal: struct (nullable = true)
        |    |-- data: struct (nullable = true)
        |    |    |-- documentVersion: string (nullable = true)
        |    |    |-- id: string (nullable = true)
        |-- request: array (nullable = true)
        |    |-- element: struct (containsNull = true)
        |    |    |-- count: long (nullable = true)
        |    |    |-- durationMetric: struct (nullable = true)
        |    |    |    |-- count: double (nullable = true)
        |    |    |    |-- max: double (nullable = true)
        |    |    |    |-- min: double (nullable = true)
        |    |    |    |-- sampledValue: double (nullable = true)
        |    |    |    |-- stdDev: double (nullable = true)
        |    |    |    |-- value: double (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- name: string (nullable = true)
        |    |    |-- responseCode: long (nullable = true)
        |    |    |-- success: boolean (nullable = true)
        |    |    |-- url: string (nullable = true)
        |    |    |-- urlData: struct (nullable = true)
        |    |    |    |-- base: string (nullable = true)
        |    |    |    |-- hashTag: string (nullable = true)
        |    |    |    |-- host: string (nullable = true)
        |    |    |    |-- protocol: string (nullable = true)

8. <span data-ttu-id="232e0-203">Используйте следующий кадр данных hello tooregister как временную таблицу hello и выполнить запрос данных hello:</span><span class="sxs-lookup"><span data-stu-id="232e0-203">Use hello following tooregister hello dataframe as a temporary table and run a query against hello data:</span></span>

   ```scala
   jsonData.registerTempTable("requests")
   var city = sqlContext.sql("select context.location.city from requests where context.location.city is not null limit 10").show()
   ```

    <span data-ttu-id="232e0-204">Этот запрос возвращает сведения о городе hello для hello top 20 записей, где context.location.city не имеет значение null.</span><span class="sxs-lookup"><span data-stu-id="232e0-204">This query returns hello city information for hello top 20 records where context.location.city is not null.</span></span>

   > [!NOTE]
   > <span data-ttu-id="232e0-205">структура контекста Hello присутствует во все данные телеметрии, записанных службой Application Insights.</span><span class="sxs-lookup"><span data-stu-id="232e0-205">hello context structure is present in all telemetry logged by Application Insights.</span></span> <span data-ttu-id="232e0-206">элемент Город Hello не могут быть заполнены в журналах.</span><span class="sxs-lookup"><span data-stu-id="232e0-206">hello city element may not be populated in your logs.</span></span> <span data-ttu-id="232e0-207">Используйте схему tooidentify hello другим элементам, которые можно выполнить запрос, может содержать данные для журналов.</span><span class="sxs-lookup"><span data-stu-id="232e0-207">Use hello schema tooidentify other elements that you can query that may contain data for your logs.</span></span>
   >
   >

    <span data-ttu-id="232e0-208">Этот запрос возвращает сведения аналогичные toohello следующий текст:</span><span class="sxs-lookup"><span data-stu-id="232e0-208">This query returns information similar toohello following text:</span></span>

        +---------+
        |     city|
        +---------+
        | Bellevue|
        |  Redmond|
        |  Seattle|
        |Charlotte|
        ...
        +---------+

## <a name="next-steps"></a><span data-ttu-id="232e0-209">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="232e0-209">Next steps</span></span>

<span data-ttu-id="232e0-210">Дополнительные примеры использования Spark toowork с данными и служб в Azure см. в разделе hello следующие документы:</span><span class="sxs-lookup"><span data-stu-id="232e0-210">For more examples of using Spark toowork with data and services in Azure, see hello following documents:</span></span>

* [<span data-ttu-id="232e0-211">Использование Spark со средствами бизнес-аналитики. Выполнение интерактивного анализа данных с использованием Spark в HDInsight с помощью средств бизнес-аналитики</span><span class="sxs-lookup"><span data-stu-id="232e0-211">Spark with BI: Perform interactive data analysis using Spark in HDInsight with BI tools</span></span>](hdinsight-apache-spark-use-bi-tools.md)
* [<span data-ttu-id="232e0-212">Использование Spark с машинным обучением. Использование Spark в HDInsight для анализа температуры в здании на основе данных системы кондиционирования</span><span class="sxs-lookup"><span data-stu-id="232e0-212">Spark with Machine Learning: Use Spark in HDInsight for analyzing building temperature using HVAC data</span></span>](hdinsight-apache-spark-ipython-notebook-machine-learning.md)
* [<span data-ttu-id="232e0-213">Spark с машинного обучения: используйте Spark в HDInsight toopredict food проверки результатов</span><span class="sxs-lookup"><span data-stu-id="232e0-213">Spark with Machine Learning: Use Spark in HDInsight toopredict food inspection results</span></span>](hdinsight-apache-spark-machine-learning-mllib-ipython.md)
* [<span data-ttu-id="232e0-214">Потоковая передача Spark. Обработка событий из концентраторов событий Azure с помощью кластера Apache Spark в HDInsight</span><span class="sxs-lookup"><span data-stu-id="232e0-214">Spark Streaming: Use Spark in HDInsight for building streaming applications</span></span>](hdinsight-apache-spark-eventhub-streaming.md)
* [<span data-ttu-id="232e0-215">Анализ журнала веб-сайта с использованием Spark в HDInsight</span><span class="sxs-lookup"><span data-stu-id="232e0-215">Website log analysis using Spark in HDInsight</span></span>](hdinsight-apache-spark-custom-library-website-log-analysis.md)

<span data-ttu-id="232e0-216">См. сведения о создании и запуске приложений Spark hello следующие документы:</span><span class="sxs-lookup"><span data-stu-id="232e0-216">For information on creating and running Spark applications, see hello following documents:</span></span>

* [<span data-ttu-id="232e0-217">Создание автономного приложения с использованием Scala</span><span class="sxs-lookup"><span data-stu-id="232e0-217">Create a standalone application using Scala</span></span>](hdinsight-apache-spark-create-standalone-application.md)
* [<span data-ttu-id="232e0-218">Удаленный запуск заданий с помощью Livy в кластере Spark</span><span class="sxs-lookup"><span data-stu-id="232e0-218">Run jobs remotely on a Spark cluster using Livy</span></span>](hdinsight-apache-spark-livy-rest-interface.md)

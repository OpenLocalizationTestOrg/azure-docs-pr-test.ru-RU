---
title: "Настройка присоединенных к домену кластеров HDInsight с помощью Azure PowerShell | Документация Майкрософт"
description: "Узнайте, как установить и настроить присоединенные к домену кластеры HDInsight с помощью Azure PowerShell."
services: hdinsight
documentationcenter: 
author: saurinsh
manager: jhubbard
editor: cgronlun
tags: 
ms.assetid: a13b2f7a-612d-4800-bc92-7fc0524f3e89
ms.service: hdinsight
ms.custom: hdinsightactive
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: big-data
ms.date: 11/02/2016
ms.author: saurinsh
ms.openlocfilehash: 9da76bb5f649817cd2f027f3d0eb46d58a996b4f
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="configure-domain-joined-hdinsight-clusters-preview-using-azure-powershell"></a>Настройка присоединенных к домену кластеров HDInsight (предварительная версия) с помощью Azure PowerShell
Узнайте, как настроить кластер Azure HDInsight со службой Azure Active Directory (Azure AD) и платформой [Apache Ranger](http://hortonworks.com/apache/ranger/) с помощью Azure PowerShell. Предоставленный скрипт Azure PowerShell позволяет настроить конфигурацию быстро и без ошибок. Присоединенный к домену кластер HDInsight можно настроить только с помощью кластеров под управлением Linux. Дополнительные сведения см. в статье [Introduce Domain-joined HDInsight clusters](hdinsight-domain-joined-introduction.md) (Введение в присоединенные к домену кластеры HDInsight).

> [!IMPORTANT]
> Oozie не включен в присоединенный к домену HDInsight.

Ниже описано, как поэтапно настроить типичную конфигурацию кластера HDInsight, присоединенного к домену.

1. Создайте классическую виртуальную сеть Azure для Azure AD.  
2. Создайте и настройте Azure AD и доменные службы Azure Active Directory.
3. Добавьте виртуальную машину в классическую виртуальную сеть для создания подразделения. 
4. Создайте подразделение для доменных служб Azure Active Directory.
5. Создайте виртуальную сеть HDInsight в режиме управления ресурсами Azure.
6. Настройте обратные зоны DNS для доменных служб Azure Active Directory.
7. Установите пиринг между двумя виртуальными сетями.
8. Создание кластера HDInsight.

Предоставленный скрипт PowerShell выполняет шаги 3–7. Шаги 1–2 выполняются вручную.  Если вы не хотите использовать Azure PowerShell, см. статью [Настройка присоединенных к домену кластеров HDInsight (предварительная версия)](hdinsight-domain-joined-configure.md). 

Пример итоговой топологии выглядит следующим образом:

![Топология присоединенного к домену кластера HDInsight](./media/hdinsight-domain-joined-configure/hdinsight-domain-joined-topology.png)

Так как в настоящее время Azure AD поддерживает только классические виртуальные сети, а кластеры HDInsight под управлением Linux поддерживают только виртуальные сети на основе Azure Resource Manager, для интеграции HDInsight с Azure AD нужно создать две виртуальные сети и настроить пиринг между ними. Сравнительные сведения о двух моделях развертывания см. в статье [Развертывание с помощью Azure Resource Manager и классическое развертывание: сведения о моделях развертывания и состоянии ресурсов](../azure-resource-manager/resource-manager-deployment-model.md). Две виртуальные сети должны находиться в одном регионе с доменными службами Azure Active Directory.

> [!NOTE]
> В этом руководстве предполагается, что служба Azure AD не установлена. Если она установлена, можно пропустить часть инструкций на шаге 2.
> 
> 

## <a name="prerequisites"></a>Предварительные требования
Перед началом работы с этим руководством, сделайте следующее:

* Ознакомьтесь с [доменными службами Azure AD](https://azure.microsoft.com/services/active-directory-ds/) и их [ценовой](https://azure.microsoft.com/pricing/details/active-directory-ds/) структурой.
* Убедитесь, что ваша подписка внесена в список разрешенных подписок для этой общедоступной предварительной версии. Для этого можно отправить сообщение с идентификатором подписки по адресу hdipreview@microsoft.com.
* SSL-сертификат, подписанный заверителем подписи для вашего домена. Сертификат требуется для настройки защищенного протокола LDAP. Нельзя использовать самозаверяющие сертификаты.
* Установите Azure PowerShell.  См. руководство по [установке и настройке Azure PowerShell](/powershell/azure/overview).

## <a name="create-an-azure-classic-vnet-for-your-azure-ad"></a>Создайте классическую виртуальную сеть Azure для Azure AD.
Инструкции см. [здесь](hdinsight-domain-joined-configure.md#create-an-azure-virtual-network-classic).

## <a name="create-and-configure-azure-ad-and-azure-ad-ds"></a>Создайте и настройте Azure AD и доменные службы Azure Active Directory.
Инструкции см. [здесь](hdinsight-domain-joined-configure.md#create-and-configure-azure-ad-ds-for-your-azure-ad).

## <a name="run-the-powershell-script"></a>Запуск сценария PowerShell
Скрипт PowerShell можно загрузить на сайте [GitHub](https://github.com/hdinsight/DomainJoinedHDInsight). Извлеките файлы из ZIP-архива и сохраните их локально.

**Изменение скрипта PowerShell**

1. Откройте файл run.ps1 с помощью интегрированной среды сценариев Windows PowerShell или любого текстового редактора.
2. Присвойте значения следующим переменным:
   
   * **$SubscriptionName** — имя подписки Azure, в которой будет создан кластер HDInsight. В этой подписке вы уже создали классическую виртуальную сеть, а теперь создадите виртуальную сеть Azure Resource Manager для кластера HDInsight.
   * **$ClassicVNetName** —классическая виртуальная сеть, которая содержит доменные службы Azure AD. Эта виртуальная сеть должна быть в подписке, которая упомянута выше. Виртуальная сеть должна быть создана с помощью портала Azure, а не классического портала. Если вы создадите сеть в соответствии с руководством по [настройке присоединенных к домену кластеров HDInsight (предварительная версия)](hdinsight-domain-joined-configure.md#create-an-azure-virtual-network-classic), по умолчанию у сети будет имя contosoaadvnet.
   * **$ClassicResourceGroupName** — имя группы Resource Manager для классической виртуальной сети, упомянутой выше. Например, contosoaadrg. 
   * **$ArmResourceGroupName** — имя группы ресурсов, в которой будет создан кластер HDInsight. Можно использовать группу ресурсов $ArmResourceGroupName.  Если группа ресурсов не существует, скрипт создаст ее.
   * **$ArmVNetName** — имя виртуальной сети Resource Manager, в которой будет создан кластер HDInsight. Эта виртуальная сеть будет помещена в группу $ArmResourceGroupName.  Если виртуальная сеть не существует, скрипт PowerShell создаст ее. Если сеть существует, она должна входить в указанную выше группу ресурсов.
   * **$AddressVnetAddressSpace** — адресное пространство сети для виртуальной сети Resource Manager. Убедитесь, что это адресное пространство доступно. Оно не должно совпадать с адресным пространством классической виртуальной сети. Например, 10.1.0.0/16.
   * **$ArmVnetSubnetName** — имя подсети виртуальной сети Resource Manager, в которой будут размещены виртуальные машины кластера HDInsight. Если подсеть не существует, скрипт PowerShell создаст ее. Если подсеть существует, она должна входить в указанную выше виртуальную сеть.
   * **$AddressSubnetAddressSpace** — диапазон сетевых адресов для подсети виртуальной сети Resource Manager. Виртуальные машины кластера HDInsight будут получать IP-адреса из этого диапазона. Например, 10.1.0.0/24.
   * **$ActiveDirectoryDomainName** — имя домена Azure AD, к которому будут присоединены виртуальные машины кластера HDInsight. Например, contoso.onmicrosoft.com.
   * **$ClusterUsersGroups** — общее имя групп безопасности в службе AD, с которыми будет синхронизироваться кластер HDInsight. Пользователи, входящие в эту группу безопасности, смогут подключаться к панели мониторинга кластера, используя свои учетные данные для домена Active Directory. Эти группы безопасности должны существовать в службе Active Directory. Например, hiveusers или clusteroperatorusers.
   * **$OrganizationalUnitName** — подразделение в домене, в котором будут размещены входящие в кластер HDInsight виртуальные машины и используемые в кластере субъекты-службы. Если подразделение не существует, скрипт PowerShell создаст его. Например, HDInsightOU.
3. Сохраните изменения.

**Запуск скрипта**

1. Запустите **Windows PowerShell** от имени администратора.
2. Перейдите в папку с файлом run.ps1. 
3. Запустите скрипт, введя имя файла и нажав клавишу **ВВОД**.  Откроется 3 диалоговых окна.
   
   1. **Вход на классический портал Azure**. Введите учетные данные, которые вы используете для входа на классический портал Azure. Эти учетные данные должны были использоваться при создании Azure AD и доменных служб Azure AD.
   2. **Вход на портал Azure Resource Manager**. Введите учетные данные, которые вы используете для входа на портал Azure Resource Manager.
   3. **Имя пользователя в домене**. Введите учетные данные пользователя в домене, которого вы хотите назначить администратором кластера HDInsight. Если вы создали службу Azure AD с нуля, вы также должны были создать этого пользователя (как описано в этой документации). 
      
      > [!IMPORTANT]
      > Имя пользователя необходимо вводить в таком формате: 
      > 
      > Имя_домена\имя_пользователя (например, contoso.onmicrosoft.com\clusteradmin).
      > 
      > 
      
      У этого пользователя должны быть права выполнять следующие три операции: присоединять виртуальные машины к соответствующему домену Active Directory; создавать субъекты-службы и объекты виртуальных машин в рамках соответствующего подразделения; добавлять правила обратного прокси-сервера DNS.

При создании обратных зон DNS скрипт предложит указать идентификатор сети. Этот идентификатор должен соответствовать префиксу адреса виртуальной сети Resource Manager. Например, если адресное пространство подсети виртуальной сети Resource Manager — 10.2.0.0/24, при запросе в качестве идентификатора сети введите 10.2.0.0/24. 

## <a name="create-hdinsight-cluster"></a>Создание кластера HDInsight
В этом разделе вы создадите в HDInsight кластер Hadoop под управлением Linux с помощью портала Azure или [шаблона Azure Resource Manager](../azure-resource-manager/resource-group-template-deploy.md). Сведения о других способах создания кластеров и их параметрах см. в статье [Создание кластеров Hadoop под управлением Linux в HDInsight](hdinsight-hadoop-provision-linux-clusters.md). Дополнительные сведения о создании в HDInsight кластеров Hadoop с помощью шаблонов Resource Manager см. в статье [Создание кластеров Hadoop под управлением Windows в HDInsight с помощью шаблонов Azure Resource Manager](hdinsight-hadoop-create-windows-clusters-arm-templates.md).

**Создание присоединенного к домену кластера HDInsight с помощью портала Azure**

1. Выполните вход на [портал Azure](https://portal.azure.com).
2. Щелкните **Создать**, **Аналитика** и **HDInsight**.
3. В колонке **Новый кластер HDInsight** введите или выберите следующие значения:
   
   * **Имя кластера**. Введите имя нового кластера для присоединенного к домену кластера HDInsight.
   * **Подписка**. Выберите подписку Azure, используемую для создания этого кластера.
   * **Конфигурация кластера**:
     
     * **Тип кластера**: Hadoop. В настоящее время присоединенный к домену кластер HDInsight поддерживают только кластеры Hadoop.
     * **Операционная система**: Linux.  Присоединенный к домену кластер HDInsight поддерживают только кластеры HDInsight под управлением Linux.
     * **Версия**: Hadoop 2.7.3 (HDI 3.5). Присоединенный к домену кластер HDInsight поддерживает только кластер HDInsight версии 3.5.
     * **Тип кластера**: PREMIUM.
       
       Щелкните **Выбрать**, чтобы сохранить изменения.
   * **Учетные данные**. Настройте учетные данные для пользователя кластера и SSH.
   * **Источник данных**. Создайте учетную запись хранения или используйте существующую учетную запись хранения в качестве учетной записи хранения по умолчанию для кластера HDInsight. Расположение должно совпадать с расположением для двух виртуальных сетей.  В этом расположении также находится кластер HDInsight.
   * **Цены**. Выберите количество рабочих узлов для кластера.
   * **Advanced configurations** (Расширенные настройки): 
     
     * **Domain-joining & Vnet/Subnet** (Присоединение к домену, виртуальная сеть и подсеть): 
       
       * **Параметры домена**: 
         
         * **Доменное имя**: contoso.onmicrosoft.com.
         * **Имя пользователя в домене**. Введите имя пользователя домена. Назначьте этому домену следующие права: присоединение компьютеров к домену и их помещение в настроенное ранее подразделение, создание субъектов-служб в настроенном ранее подразделении, создание обратных записей DNS. Этот пользователь домена станет администратором присоединенного к домену кластера HDInsight.
         * **Пароль домена**. Введите пароль пользователя домена.
         * **Подразделение**. Введите уникальное имя подразделения, настроенного ранее. Например, OU=HDInsightOU,DC=contoso,DC=onmicrosoft,DC=com.
         * **LDAPS URL** (URL-адрес LDAPS): ldaps://contoso.onmicrosoft.com:636.
         * **Access user group** (Группа доступа пользователей). Укажите группу безопасности, пользователей которой требуется синхронизировать с кластером. Например, HiveUsers.
           
           Щелкните **Выбрать**, чтобы сохранить изменения.
           
           ![Настройка параметров домена на портале для присоединенного к домену кластера HDInsight](./media/hdinsight-domain-joined-configure/hdinsight-domain-joined-portal-domain-setting.png)
       * **Виртуальная сеть**: contosohdivnet.
       * **Подсеть**: Subnet1.
         
         Щелкните **Выбрать**, чтобы сохранить изменения.        
         Щелкните **Выбрать**, чтобы сохранить изменения.
   * **Группа ресурсов**. Выберите группу ресурсов, использованную для виртуальной сети HDInsight (contosohdirg).
4. Щелкните **Создать**.  

Присоединенный к домену кластер HDInsight можно также создать с помощью шаблона управления ресурсами Azure. Эта процедура представлена далее.

**Создание присоединенного к домену кластера HDInsight с помощью шаблона управления ресурсами**

1. Щелкните следующее изображение, чтобы открыть шаблон Resource Manager на портале Azure. Шаблон Resource Manager хранится в общедоступном контейнере BLOB-объектов. 
   
    <a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fhditutorialdata.blob.core.windows.net%2Farmtemplates%2Fcreate-domain-joined-hdinsight-cluster.json" target="_blank"><img src="./media/hdinsight-domain-joined-configure-use-powershell/deploy-to-azure.png" alt="Deploy to Azure"></a>
2. В колонке **Параметры** задайте следующие значения:
   
   * **Подписка**. Выберите подписку Azure.
   * **Группа ресурсов**. Щелкните **Использовать существующий** и укажите используемую группу ресурсов.  Например, contosohdirg. 
   * **Расположение**. Укажите расположение группы ресурсов.
   * **Имя кластера**. Введите имя создаваемого кластера Hadoop. Например, contosohdicluster.
   * **Тип кластера**. Выберите тип кластера.  Значение по умолчанию — **Hadoop**.
   * **Расположение**. Выберите расположение кластера.  Учетная запись хранения по умолчанию использует то же расположение.
   * **Cluster Worker Node count** (Количество рабочих узлов кластера). Выберите количество рабочих узлов.
   * **Имя для входа и пароль кластера**: имя для входа по умолчанию — **admin**.
   * **Имя пользователя SSH и пароль**: по умолчанию используется имя **sshuser**.  Это имя можно изменить. 
   * **Код виртуальной сети**: /subscriptions/&lt;идентификатор_подписки>/resourceGroups/&lt;имя_группы_ресурсов>/providers/Microsoft.Network/virtualNetworks/&lt;имя_виртуальной сети>.
   * **Подсеть виртуальной сети**: /subscriptions/&lt;идентификатор_подписки>/resourceGroups/&lt;имя_группы_ресурсов>/providers/Microsoft.Network/virtualNetworks/&lt;имя_виртуальной сети>/subnets/Subnet1.
   * **Доменное имя**: contoso.onmicrosoft.com.
   * **Organization Unit DN** (Различающееся имя подразделения): OU=HDInsightOU,DC=contoso,DC=onmicrosoft,DC=com.
   * **Cluster Users Group D Ns** (Различающиеся имена группы пользователей кластера): "\"CN=HiveUsers,OU=AADDC Users,DC=<DomainName>,DC=onmicrosoft,DC=com\"".
   * **LDAPUrls** (URL-адреса LDAPS): ["ldaps://contoso.onmicrosoft.com:636"].
   * **DomainAdminUserName** (Имя пользователя администратора домена). Введите имя пользователя администратора домена.
   * **DomainAdminPassword** (Пароль пользователя администратора домена). Введите пароль пользователя администратора домена.
   * **Я принимаю указанные выше условия**. Установите этот флажок.
   * **Закрепить на панели мониторинга**. Установите этот флажок.
3. Щелкните **Приобрести**. Вы увидите новый элемент под названием **Развертывание для развертывания шаблона**. Процесс создания кластера занимает около 20 минут. Когда кластер будет создан, щелкните его колонку на портале, чтобы открыть его.

После завершения работы с этим руководством кластер можно удалить. В случае с HDInsight ваши данные хранятся в службе хранилища Azure, что позволяет безопасно удалить неиспользуемый кластер. Плата за кластеры HDInsight взимается, даже когда они не используются. Поскольку стоимость кластера во много раз превышает стоимость хранилища, экономически целесообразно удалять неиспользуемые кластеры. Инструкции по удалению кластера см. в статье [Управление кластерами Hadoop в HDInsight с помощью портала Azure](hdinsight-administer-use-management-portal.md#delete-clusters).

## <a name="next-steps"></a>Дальнейшие действия

* Сведения о настройке политик Hive и выполнении запросов Hive для присоединенного к домену кластера HDInsight см. [здесь](hdinsight-domain-joined-run-hive.md).
* Сведения об использовании SSH для подключения к присоединенных к домену кластерам HDInsight см. в статье [Подключение к HDInsight (Hadoop) с помощью SSH](hdinsight-hadoop-linux-use-ssh-unix.md#domainjoined).


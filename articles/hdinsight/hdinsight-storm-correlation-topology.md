---
title: "Сопоставление событий в динамике по времени с помощью Storm и HBase в HDInsight"
description: "Узнайте, как сопоставлять события, поступающие в разное время, с помощью Storm и HBase в HDInsight."
services: hdinsight
documentationcenter: 
author: Blackmist
manager: jhubbard
editor: cgronlun
tags: azure-portal
ms.assetid: 17d11479-2d02-4790-8d29-05fb38351479
ms.service: hdinsight
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: big-data
ms.date: 08/07/2017
ms.author: larryfr
ms.custom: H1Hack27Feb2017,hdinsightactive
ms.openlocfilehash: 06630096383601e48e8f69f8553314cee42f5f3e
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="correlate-events-that-arrive-at-different-times-using-storm-and-hbase"></a>Сопоставление событий, поступающих в разное время, с помощью Storm и HBase

Благодаря сохранению постоянных данных в Apache Storm можно сопоставлять данные, поступающие в разное время. Например, связывание событий входа и выхода в пользовательском сеансе для расчета продолжительности сеанса.

В этом документе рассматривается создание базовой топологии Storm C#, которая отслеживает события входа и выхода в пользовательских сеансах и рассчитывает продолжительность сеанса. Топология использует HBase как хранилище постоянных данных. HBase также позволяет выполнять пакетные запросы к историческим данным для получения дополнительных сведений. Например, количество пользовательских сеансов, начатых или завершенных за определенный период времени.

## <a name="prerequisites"></a>Предварительные требования

* Инструменты Visual Studio и средства HDInsight для Visual Studio. Дополнительные сведения см. в статье [Начало работы со средствами HDInsight для Visual Studio](hdinsight-hadoop-visual-studio-tools-get-started.md).

* Apache Storm в кластере HDInsight (под управлением Windows).

  > [!WARNING]
  > Топологии SCP.NET поддерживаются в кластерах Storm под управлением Linux с 28 октября 2016 года, однако пакет SDK .NET для HBase, доступный с этой же даты, некорректно работает в HDInsight под управлением Linux.

* Apache HBase в кластере HDInsight (под управлением Linux или Windows).

  > [!IMPORTANT]
  > Linux — это единственная операционная система, используемая для работы с HDInsight 3.4 или более поздних версий. Дополнительные сведения см. в разделе [Приближается дата прекращения сопровождения HDI версии 3.3](hdinsight-component-versioning.md#hdinsight-windows-retirement).

* [Java](https://java.com) 1.7 или более поздняя версия в среде разработки. Java используется для упаковки топологии при отправке в кластер HDInsight.

  * Переменная среды **JAVA_HOME** должна указывать на каталог, содержащий Java.
  * В этом каталоге должен быть вложенный каталог **%JAVA_HOME%/bin**.

## <a name="architecture"></a>Архитектура

![Диаграмма потока данных через топологию](./media/hdinsight-storm-correlation-topology/correlationtopology.png)

Для сопоставления событий требуется стандартный идентификатор источника события. Например, идентификатор пользователя, идентификатор сеанса или другой элемент данных, который является: a) уникальным и (b) включен во все данные, отправляемые в Storm. В этом примере в качестве идентификатора сеанса используется значение GUID.

В примере есть два кластера HDInsight:

* HBase: хранилище постоянных данных для исторических данных;
* Storm: используется для получения входящих данных.

Данные генерируются топологией Storm случайным образом и включают следующие элементы:

* идентификатор сеанса: GUID, который однозначно определяет каждый сеанс;
* событие: событие НАЧАЛО или КОНЕЦ, в этом примере НАЧАЛО всегда раньше КОНЦА;
* Время: время события.

Эти данные обрабатываются и хранятся в HBase.

### <a name="storm-topology"></a>Топология Storm

При запуске сеанса событие **НАЧАЛО** принимается топологией и записывается в HBase. При получении события **КОНЕЦ** топология извлекает событие **НАЧАЛО** и вычисляет время между двумя этими событиями. Это значение **продолжительности** сохраняется в HBase вместе с информацией о событии **КОНЕЦ**.

> [!IMPORTANT]
> Эта топология представляет собой базовый шаблон, но в продуктивном решении  потребуется учесть следующие сценарии:
>
> * события, поступающие не по порядку;
> * повторяющиеся события;
> * удаленные события.

Пример топологии состоит из следующих компонентов:

* Session.cs: моделирование пользовательского сеанса путем создания случайного идентификатора сеанса, времени начала и его продолжительности.

* Spout.cs: создание 100 сеансов, генерация события НАЧАЛО, ожидание случайного тайм-аута для каждого сеанса и генерация события КОНЕЦ. Затем завершенные сеансы удаляются для создания новых.

* HBaseLookupBolt.cs: использование идентификатора сеанса для поиска информации о сеансе из HBase. При обработке события КОНЕЦ обнаруживается соответствующее событие НАЧАЛО и рассчитывается длительность сеанса.

* HBaseBolt.cs: сохранение информации в HBase.

* TypeHelper.cs: преобразование типа при считывании из/записи в HBase.

### <a name="hbase-schema"></a>Схема HBase

В HBase данные хранятся в таблице со следующей схемой и параметрами:

* Ключ строки: идентификатор сеанса используется как ключ для строк в этой таблице.

* Семейство столбцов: имя семейства — cf. В этом семействе хранятся столбцы:

  * событие: НАЧАЛО или КОНЕЦ;

  * время: время события в миллисекундах;

  * продолжительность: интервал между событиями НАЧАЛО и КОНЕЦ.

* версии: для семейства cf установлено сохранение 5 версий каждой строки.

  > [!NOTE]
  > Версии представляют собой запись предыдущих значений, сохраненных для конкретного ключа строки. По умолчанию HBase возвращает значение только для самой последней версии строки. В этом случае та же строка используется для всех событий (НАЧАЛО, КОНЕЦ). Каждая версия строки идентифицируется по метке времени. Версии предоставляют обзор прошлых событий, зарегистрированных для определенного идентификатора.

## <a name="download-the-project"></a>Скачивание проекта

Пример проекта можно загрузить на странице [https://github.com/Azure-Samples/hdinsight-storm-dotnet-event-correlation](https://github.com/Azure-Samples/hdinsight-storm-dotnet-event-correlation).

Данный файл содержит следующие проекты C#:

* CorrelationTopology: топология C# Storm, которая случайным образом генерирует события начала и конца для пользовательских сеансов. Каждый сеанс продолжается от 1 до 5 минут.

* SessionInfo: консольное приложение C#, в котором создается таблица HBase и предоставляются примеры запросов для получения информации о хранимых данных сеанса.

## <a name="create-the-table"></a>Создание таблицы

1. Откройте проект **SessionInfo** в Visual Studio.

2. В **обозревателе решений** щелкните правой кнопкой мыши проект **SessionInfo** и выберите **Свойства**.

    ![Снимок экрана меню с выбранными свойствами](./media/hdinsight-storm-correlation-topology/selectproperties.png)

3. Выберите **Параметры**и установите следующие значения:

   * HBaseClusterURL: URL-адрес кластера HBase. Например, https://myhbasecluster.azurehdinsight.net.

   * HBaseClusterUserName: учетная запись администратора/пользователя HTTP для кластера.

   * HBaseClusterPassword: пароль для учетной записи администратора/пользователя HTTP.

   * HBaseTableName: имя таблицы для использования с этим примером.

   * HBaseTableColumnFamily: имя семейства столбцов.

     ![Изображение окна "Параметры"](./media/hdinsight-storm-correlation-topology/settings.png)

4. Запустите решение. При появлении запроса нажмите клавишу C для создания таблицы в кластере HBase.

## <a name="build-and-deploy-the-storm-topology"></a>Построение и развертывание топологии Storm

1. Откройте решение **CorrelationTopology** в Visual Studio.

2. В **обозревателе решений** щелкните правой кнопкой мыши проект **CorrelationTopology** и выберите "Свойства".

3. В окне "Свойства" выберите **Параметры** и введите значения конфигурации для этого проекта. Первые пять значений должны быть теми же значениями, которые используются в проекте **SessionInfo**.

   * HBaseClusterURL: URL-адрес кластера HBase. Например, https://myhbasecluster.azurehdinsight.net.

   * HBaseClusterUserName: учетная запись администратора или учетная запись пользователя HTTP для кластера.

   * HBaseClusterPassword: пароль для учетной записи администратора или учетной записи пользователя HTTP.

   * HBaseTableName: имя таблицы для использования с этим примером. Это то же имя таблицы, которое используется в проекте SessionInfo.

   * HBaseTableColumnFamily: имя семейства столбцов. Это то же имя семейства столбцов, которое используется в проекте SessionInfo.

   > [!IMPORTANT]
   > Не изменяйте HBaseTableColumnNames, поскольку по умолчанию указаны имена, которые используются в проекте **SessionInfo** для получения данных.

4. Сохраните свойства и создайте проект.

5. В **обозревателе решений** щелкните правой кнопкой мыши проект и выберите **Submit to Storm on HDInsight** (Отправить в Storm в HDInsight). При появлении запроса введите учетные данные для своей подписки Azure.

   ![Изображение пункта меню "Отправить в Storm"](./media/hdinsight-storm-correlation-topology/submittostorm.png)

6. В диалоговом окне **Submit Topology** (Отправить топологию) выберите кластер Storm для развертывания этой топологии.

   > [!NOTE]
   > Первая отправка топологии может занять несколько секунд, необходимых для получения имени кластеров HDInsight.

7. После передачи и отправки топологии в кластер откроется окно **Storm Topology View** (Представление топологии Storm) с отображенной запущенной топологией. Чтобы обновить сведения о топологии, выберите **CorrelationTopology** и нажмите кнопку "Обновить" в верхней правой части страницы.

   ![Изображение представления топологии](./media/hdinsight-storm-correlation-topology/topologyview.png)

   Когда топология начнет создавать данные, значение в столбце **Emitted** (Сгенерированный) начнет увеличиваться.

   > [!NOTE]
   > Если **представление топологии Storm** не открывается автоматически, выполните следующие действия:
   >
   > 1. В **обозревателе решений** разверните **Azure**, а затем — **HDInsight**.
   > 2. Щелкните правой кнопкой мыши кластер Storm, в котором запущена топология, а затем выберите **Просмотреть топологии Storm**.

## <a name="query-the-data"></a>Запрос данных

После генерации данных выполните следующие действия для запроса данных.

1. Вернитесь в проект **SessionInfo** . Если он не открыт, запустите новый экземпляр.

2. При появлении запроса выберите **s** для поиска события START. Вам будет предложено ввести время начала и окончания, чтобы определить диапазон времени. Будут возвращены только те события, которые произошли между этими двумя моментами времени.

    При вводе значения времени начала и окончания используйте следующий формат: ЧЧ:ММ и am или pm. Например, 11:20 pm.

    Чтобы вернуть зарегистрированные события, используйте время начала до развертывания топологии Storm и актуальное время окончания. Возвращенные данные содержат записи, аналогичные следующим:

        Session e6992b3e-79be-4991-afcf-5cb47dd1c81c started at 6/5/2015 6:10:15 PM. Timestamp = 1433527820737

Поиск событий КОНЕЦ выполняется так же, как и для событий НАЧАЛО. Однако события КОНЕЦ генерируются случайным образом спустя 1–5 минут после  события НАЧАЛО. Для поиска событий КОНЕЦ может потребоваться попробовать несколько временных диапазонов. События КОНЕЦ также содержат продолжительность сеанса, т. е. разницу между событием НАЧАЛО и временем окончания события КОНЕЦ. Ниже приведен пример данных для событий КОНЕЦ:

    Session fc9fa8e6-6892-4073-93b3-a587040d892e lasted 2 minutes, and ended at 6/5/2015 6:12:15 PM

> [!NOTE]
> Хотя значения времени вводятся в местном часовом поясе, возвращаемые значения времени указываются для UTC.

## <a name="stop-the-topology"></a>Остановка топологии

Когда вы будете готовы остановить топологию, вернитесь в проект **CorrelationTopology** в Visual Studio. В **представлении топологии Storm** выберите топологию и нажмите кнопку **Прервать** в верхней части представления топологии.

## <a name="delete-your-cluster"></a>Удаление кластера

[!INCLUDE [delete-cluster-warning](../../includes/hdinsight-delete-cluster-warning.md)]

## <a name="next-steps"></a>Дальнейшие действия

Другие примеры топологий для Storm см. в разделе [Примеры топологий для Storm в HDInsight](hdinsight-storm-example-topology.md).

---
title: "TSQL. Выполнение отработки отказа для базы данных SQL Azure | Документация Майкрософт"
description: "Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью Transact-SQL"
services: sql-database
documentationcenter: 
author: CarlRabeler
manager: jhubbard
editor: 
ms.assetid: 5eb2d256-025d-4f5a-99d4-17f702b37f14
ms.service: sql-database
ms.custom: business continuity
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: data-management
ms.date: 01/10/2017
ms.author: carlrab
ms.openlocfilehash: 418953e044ba84ce758063d56a371af45d5cdfe1
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="initiate-a-planned-or-unplanned-failover-for-azure-sql-database-with-transact-sql"></a><span data-ttu-id="457d1-103">Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="457d1-103">Initiate a planned or unplanned failover for Azure SQL Database with Transact-SQL</span></span>

<span data-ttu-id="457d1-104">В этой статье показано, как tooa tooinitiate отработки отказа SQL базы данных-получателя с помощью Transact-SQL.</span><span class="sxs-lookup"><span data-stu-id="457d1-104">This article shows you how tooinitiate failover tooa secondary SQL Database using Transact-SQL.</span></span> <span data-ttu-id="457d1-105">tooconfigure георепликации, в разделе [Настройка географической репликации для базы данных SQL Azure](sql-database-geo-replication-transact-sql.md).</span><span class="sxs-lookup"><span data-stu-id="457d1-105">tooconfigure geo-replication, see [Configure geo-replication for Azure SQL Database](sql-database-geo-replication-transact-sql.md).</span></span>

<span data-ttu-id="457d1-106">tooinitiate перехода на другой ресурс требуется hello следующее:</span><span class="sxs-lookup"><span data-stu-id="457d1-106">tooinitiate failover, you need hello following:</span></span>

* <span data-ttu-id="457d1-107">Имя входа, которое является DBManager на основной hello</span><span class="sxs-lookup"><span data-stu-id="457d1-107">A login that is DBManager on hello primary</span></span>
* <span data-ttu-id="457d1-108">У db_ownership hello локальной базы данных, что вы будете репликации</span><span class="sxs-lookup"><span data-stu-id="457d1-108">Have db_ownership of hello local database that you will geo-replicate</span></span>
* <span data-ttu-id="457d1-109">Быть DBManager на серверы toowhich hello партнера вы настроите географической репликации</span><span class="sxs-lookup"><span data-stu-id="457d1-109">Be DBManager on hello partner server(s) toowhich you will configure geo-replication</span></span>
* <span data-ttu-id="457d1-110">последняя версия SQL Server Management Studio (SSMS).</span><span class="sxs-lookup"><span data-stu-id="457d1-110">Newest version of SQL Server Management Studio (SSMS)</span></span>

> [!IMPORTANT]
> <span data-ttu-id="457d1-111">Рекомендуется всегда использовать hello последнюю версию среды Management Studio tooremain синхронизированы с tooMicrosoft обновления Azure и базы данных SQL.</span><span class="sxs-lookup"><span data-stu-id="457d1-111">It is recommended that you always use hello latest version of Management Studio tooremain synchronized with updates tooMicrosoft Azure and SQL Database.</span></span> <span data-ttu-id="457d1-112">[Обновите среду SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).</span><span class="sxs-lookup"><span data-stu-id="457d1-112">[Update SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).</span></span>
>  

## <a name="initiate-a-planned-failover-promoting-a-secondary-database-toobecome-hello-new-primary"></a><span data-ttu-id="457d1-113">Повышение уровня новой основной базы данных-получателя toobecome hello запланированная отработка отказа</span><span class="sxs-lookup"><span data-stu-id="457d1-113">Initiate a planned failover promoting a secondary database toobecome hello new primary</span></span>
<span data-ttu-id="457d1-114">Можно использовать hello **инструкции ALTER DATABASE** toopromote инструкции новой основной базы данных-получателя toobecome hello база данных, в запланированной перебора, при понижении роли существующего первичного toobecome hello получателя.</span><span class="sxs-lookup"><span data-stu-id="457d1-114">You can use hello **ALTER DATABASE** statement toopromote a secondary database toobecome hello new primary database in a planned fashion, demoting hello existing primary toobecome a secondary.</span></span> <span data-ttu-id="457d1-115">Эта инструкция выполняется на hello базы данных master логического сервера базы данных SQL Azure hello в какой hello находится географическая репликация базы данных-получателя, выдвинут на роль.</span><span class="sxs-lookup"><span data-stu-id="457d1-115">This statement is executed on hello master database on hello Azure SQL Database logical server in which hello geo-replicated secondary database that is being promoted resides.</span></span> <span data-ttu-id="457d1-116">Эта возможность предназначена для плановой отработки отказа, например, во время Детализирует hello аварийного восстановления и требуется, чтобы доступные базы данных-источника, hello.</span><span class="sxs-lookup"><span data-stu-id="457d1-116">This functionality is designed for planned failover, such as during hello DR drills, and requires that hello primary database be available.</span></span>

<span data-ttu-id="457d1-117">Команда Hello выполняет hello, следуя рабочего процесса:</span><span class="sxs-lookup"><span data-stu-id="457d1-117">hello command performs hello following workflow:</span></span>

1. <span data-ttu-id="457d1-118">Временно режима toosynchronous коммутаторы репликации, вызывая все ожидающие обработки транзакции toobe сброшены toohello получателя, а также блокирует все новые транзакции;</span><span class="sxs-lookup"><span data-stu-id="457d1-118">Temporarily switches replication toosynchronous mode, causing all outstanding transactions toobe flushed toohello secondary and blocking all new transactions;</span></span>
2. <span data-ttu-id="457d1-119">Коммутаторы hello ролей hello двух баз данных в связи георепликации hello.</span><span class="sxs-lookup"><span data-stu-id="457d1-119">Switches hello roles of hello two databases in hello geo-replication partnership.</span></span>  

<span data-ttu-id="457d1-120">Эта последовательность гарантирует, что приветствия синхронизацию двух баз данных перед переключение ролей hello и поэтому произойдет без потери данных.</span><span class="sxs-lookup"><span data-stu-id="457d1-120">This sequence guarantees that hello two databases are synchronized before hello roles switch and therefore no data loss will occur.</span></span> <span data-ttu-id="457d1-121">Отсутствует короткий период, в течение которого обеих баз данных недоступны (в порядке hello 0 секунд too25) во время переключения ролей hello.</span><span class="sxs-lookup"><span data-stu-id="457d1-121">There is a short period during which both databases are unavailable (on hello order of 0 too25 seconds) while hello roles are switched.</span></span> <span data-ttu-id="457d1-122">Если база данных-источник hello имеет несколько баз данных-получателей, команда hello будет автоматически reconfigure hello других баз данных-получателей tooconnect toohello новом сервере-источнике.</span><span class="sxs-lookup"><span data-stu-id="457d1-122">If hello primary database has multiple secondary databases, hello command will automatically reconfigure hello other secondaries tooconnect toohello new primary.</span></span>  <span data-ttu-id="457d1-123">вся операция Hello занимает меньше минуты toocomplete в обычных условиях.</span><span class="sxs-lookup"><span data-stu-id="457d1-123">hello entire operation should take less than a minute toocomplete under normal circumstances.</span></span> <span data-ttu-id="457d1-124">Дополнительные сведения см. в статьях [ALTER DATABASE (база данных SQL Azure)](https://msdn.microsoft.com/library/mt574871.aspx) и [Уровни служб базы данных SQL для отдельных баз данных и пулов эластичных баз данных](sql-database-service-tiers.md).</span><span class="sxs-lookup"><span data-stu-id="457d1-124">For more information, see [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) and [Service Tiers](sql-database-service-tiers.md).</span></span>

<span data-ttu-id="457d1-125">Используйте следующие шаги tooinitiate плановой отработки отказа hello.</span><span class="sxs-lookup"><span data-stu-id="457d1-125">Use hello following steps tooinitiate a planned failover.</span></span>

1. <span data-ttu-id="457d1-126">В среде Management Studio подключитесь логический сервер базы данных SQL Azure toohello в которой находится географическая репликация базы данных-получателя.</span><span class="sxs-lookup"><span data-stu-id="457d1-126">In Management Studio, connect toohello Azure SQL Database logical server in which a geo-replicated secondary database resides.</span></span>
2. <span data-ttu-id="457d1-127">Откройте папку баз данных hello, разверните узел hello **системных баз данных** папку, щелкните правой кнопкой мыши **master**и нажмите кнопку **новый запрос**.</span><span class="sxs-lookup"><span data-stu-id="457d1-127">Open hello Databases folder, expand hello **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="457d1-128">Используйте следующие hello **инструкции ALTER DATABASE** инструкции tooswitch hello баз данных-получателей toohello первичной роли.</span><span class="sxs-lookup"><span data-stu-id="457d1-128">Use hello following **ALTER DATABASE** statement tooswitch hello secondary database toohello primary role.</span></span>
   
        ALTER DATABASE <MyDB> FAILOVER;
4. <span data-ttu-id="457d1-129">Нажмите кнопку **Execute** toorun hello запроса.</span><span class="sxs-lookup"><span data-stu-id="457d1-129">Click **Execute** toorun hello query.</span></span>

> [!NOTE]
> <span data-ttu-id="457d1-130">В редких случаях это возможно, операция hello не удается завершить и может отображаться постоянный.</span><span class="sxs-lookup"><span data-stu-id="457d1-130">In rare cases, it is possible that hello operation cannot complete and may appear stuck.</span></span> <span data-ttu-id="457d1-131">В этом случае hello пользователь может выполнить команду перехода на другой ресурс принудительное hello и принять потери данных.</span><span class="sxs-lookup"><span data-stu-id="457d1-131">In this case, hello user can execute hello force failover command and accept data loss.</span></span>
> 
> 

## <a name="initiate-an-unplanned-failover-from-hello-primary-database-toohello-secondary-database"></a><span data-ttu-id="457d1-132">Запуск внеплановой отработки отказа из hello базы данных-источника toohello базы данных-получателя</span><span class="sxs-lookup"><span data-stu-id="457d1-132">Initiate an unplanned failover from hello primary database toohello secondary database</span></span>
<span data-ttu-id="457d1-133">Можно использовать hello **инструкции ALTER DATABASE** toopromote инструкции новой основной базы данных-получателя toobecome hello базы данных незапланированных способом, принудительное понижение уровня hello hello существующего первичного toobecome дополнительного одновременно при hello База данных-источник недоступен.</span><span class="sxs-lookup"><span data-stu-id="457d1-133">You can use hello **ALTER DATABASE** statement toopromote a secondary database toobecome hello new primary database in an unplanned fashion, forcing hello demotion of hello existing primary toobecome a secondary at a time when hello primary database is no longer available.</span></span> <span data-ttu-id="457d1-134">Эта инструкция выполняется на hello базы данных master логического сервера базы данных SQL Azure hello в какой hello находится географическая репликация базы данных-получателя, выдвинут на роль.</span><span class="sxs-lookup"><span data-stu-id="457d1-134">This statement is executed on hello master database on hello Azure SQL Database logical server in which hello geo-replicated secondary database that is being promoted resides.</span></span>

<span data-ttu-id="457d1-135">Эта функциональность предназначен для аварийного восстановления, когда важна доступность восстановления hello базы данных и потеря некоторых данных допустима.</span><span class="sxs-lookup"><span data-stu-id="457d1-135">This functionality is designed for disaster recovery when restoring availability of hello database is critical and some data loss is acceptable.</span></span> <span data-ttu-id="457d1-136">При вызове принудительной отработки отказа hello указана база данных-получатель немедленно становится hello базы данных-источника и начинается принятие транзакций записи.</span><span class="sxs-lookup"><span data-stu-id="457d1-136">When forced failover is invoked, hello specified secondary database immediately becomes hello primary database and begins accepting write transactions.</span></span> <span data-ttu-id="457d1-137">Сразу hello исходной базы данных-источника может tooreconnect с этой базой данных-источником, добавочное резервное копирование берется hello исходной базы данных-источника и преобразовании hello старой базы данных-источника в базы данных-получателя для hello новой базы данных-источника; Следовательно это просто синхронизации реплики hello новой первичной.</span><span class="sxs-lookup"><span data-stu-id="457d1-137">As soon as hello original primary database is able tooreconnect with this new primary database, an incremental backup is taken on hello original primary database and hello old primary database is made into a secondary database for hello new primary database; subsequently, it is merely a synchronizing replica of hello new primary.</span></span>

<span data-ttu-id="457d1-138">Тем не менее так как в время восстановления на момент не поддерживается hello баз данных-получателей, если пользователь hello зафиксированных данных toorecover toohello старой базы данных-источника, не было реплицируются toohello новой базы данных-источника до возникновения hello Принудительный переход на другой ресурс, Hello пользователю будет необходимо toorecover поддержки tooengage это потеряны данные.</span><span class="sxs-lookup"><span data-stu-id="457d1-138">However, because Point In Time Restore is not supported on hello secondary databases, if hello user wishes toorecover data committed toohello old primary database that had not been replicated toohello new primary database before hello forced failover occurred, hello user will need tooengage support toorecover this lost data.</span></span>

<span data-ttu-id="457d1-139">Если база данных-источник hello имеет несколько баз данных-получателей, команда hello будет автоматически reconfigure hello других баз данных-получателей tooconnect toohello новом сервере-источнике.</span><span class="sxs-lookup"><span data-stu-id="457d1-139">If hello primary database has multiple secondary databases, hello command will automatically reconfigure hello other secondaries tooconnect toohello new primary.</span></span>

<span data-ttu-id="457d1-140">Используйте следующие шаги tooinitiate незапланированной отработки отказа hello.</span><span class="sxs-lookup"><span data-stu-id="457d1-140">Use hello following steps tooinitiate an unplanned failover.</span></span>

1. <span data-ttu-id="457d1-141">В среде Management Studio подключитесь логический сервер базы данных SQL Azure toohello в которой находится географическая репликация базы данных-получателя.</span><span class="sxs-lookup"><span data-stu-id="457d1-141">In Management Studio, connect toohello Azure SQL Database logical server in which a geo-replicated secondary database resides.</span></span>
2. <span data-ttu-id="457d1-142">Откройте папку баз данных hello, разверните узел hello **системных баз данных** папку, щелкните правой кнопкой мыши **master**и нажмите кнопку **новый запрос**.</span><span class="sxs-lookup"><span data-stu-id="457d1-142">Open hello Databases folder, expand hello **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="457d1-143">Используйте следующие hello **инструкции ALTER DATABASE** инструкции tooswitch hello баз данных-получателей toohello первичной роли.</span><span class="sxs-lookup"><span data-stu-id="457d1-143">Use hello following **ALTER DATABASE** statement tooswitch hello secondary database toohello primary role.</span></span>
   
        ALTER DATABASE <MyDB>   FORCE_FAILOVER_ALLOW_DATA_LOSS;
4. <span data-ttu-id="457d1-144">Нажмите кнопку **Execute** toorun hello запроса.</span><span class="sxs-lookup"><span data-stu-id="457d1-144">Click **Execute** toorun hello query.</span></span>

> [!NOTE]
> <span data-ttu-id="457d1-145">Если hello команды при первичной и вторичной находятся в оперативном режиме, может стать старая первичная hello hello новом сервере-получателе немедленно, без синхронизации данных.</span><span class="sxs-lookup"><span data-stu-id="457d1-145">If hello command is issued when both primary and secondary are online hello old primary will become hello new secondary immediately without data synchronization.</span></span> <span data-ttu-id="457d1-146">В случае основной hello возможна Фиксация транзакции при hello команды потери данных.</span><span class="sxs-lookup"><span data-stu-id="457d1-146">If hello primary is committing transactions when hello command is issued some data loss may occur.</span></span>
> 
> 

## <a name="next-steps"></a><span data-ttu-id="457d1-147">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="457d1-147">Next steps</span></span>
* <span data-ttu-id="457d1-148">После отработки отказа убедитесь, что hello требования проверки подлинности для сервера и базы данных можно настроить на новом сервере-источнике hello.</span><span class="sxs-lookup"><span data-stu-id="457d1-148">After failover, ensure hello authentication requirements for your server and database are configured on hello new primary.</span></span> <span data-ttu-id="457d1-149">Дополнительные сведения см. в разделе [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).</span><span class="sxs-lookup"><span data-stu-id="457d1-149">For details, see [SQL Database security after disaster recovery](sql-database-geo-replication-security-config.md).</span></span>
* <span data-ttu-id="457d1-150">toolearn восстановление по журналу после сбоя с помощью активной георепликации, включая шаги для восстановления до и после восстановления и выполнения аварийного восстановления, в разделе [аварийного восстановления](sql-database-disaster-recovery.md)</span><span class="sxs-lookup"><span data-stu-id="457d1-150">toolearn recovering after a disaster using active geo-replication, including pre-recovery and post-recovery steps and performing a disaster recovery drill, see [Disaster Recovery](sql-database-disaster-recovery.md)</span></span>
* <span data-ttu-id="457d1-151">Прочитайте запись блога Александра Носова об активной георепликации: [Spotlight on new capabilities of Azure SQL Database geo-replication](https://azure.microsoft.com/blog/spotlight-on-new-capabilities-of-azure-sql-database-geo-replication/) (Полезные сведения о новых возможностях георепликации базы данных SQL).</span><span class="sxs-lookup"><span data-stu-id="457d1-151">For a Sasha Nosov blog post about active geo-replication, see [Spotlight on new geo-replication capabilities](https://azure.microsoft.com/blog/spotlight-on-new-capabilities-of-azure-sql-database-geo-replication/)</span></span>
* <span data-ttu-id="457d1-152">Сведения о разработке облачных приложений toouse активной георепликации см. в разделе [разработке облачных приложений для обеспечения непрерывности бизнеса, с помощью георепликации](sql-database-designing-cloud-solutions-for-disaster-recovery.md)</span><span class="sxs-lookup"><span data-stu-id="457d1-152">For information about designing cloud applications toouse active geo-replication, see [Designing cloud applications for business continuity using geo-replication](sql-database-designing-cloud-solutions-for-disaster-recovery.md)</span></span>
* <span data-ttu-id="457d1-153">Сведения об использовании активной георепликации с эластичными пулами см. в статье [Стратегии аварийного восстановления для приложений с использованием пула эластичных баз данных SQL](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md).</span><span class="sxs-lookup"><span data-stu-id="457d1-153">For information about using active geo-replication with elastic pools, see [Elastic Pool disaster recovery strategies](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md).</span></span>
* <span data-ttu-id="457d1-154">Общие сведения об обеспечении непрерывности бизнес-процессов можно узнать в статье [Обзор обеспечения непрерывности бизнес-процессов с помощью базы данных SQL Azure](sql-database-business-continuity.md).</span><span class="sxs-lookup"><span data-stu-id="457d1-154">For an overview of business continuity, see [Business Continuity Overview](sql-database-business-continuity.md)</span></span>


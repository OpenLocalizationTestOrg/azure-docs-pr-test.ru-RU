---
title: "TSQL. Выполнение отработки отказа для базы данных SQL Azure | Документация Майкрософт"
description: "Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью Transact-SQL"
services: sql-database
documentationcenter: 
author: CarlRabeler
manager: jhubbard
editor: 
ms.assetid: 5eb2d256-025d-4f5a-99d4-17f702b37f14
ms.service: sql-database
ms.custom: business continuity
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: data-management
ms.date: 01/10/2017
ms.author: carlrab
ms.openlocfilehash: 459941d2c82e5d4ef62beab4ccf775ab8f5efce4
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="initiate-a-planned-or-unplanned-failover-for-azure-sql-database-with-transact-sql"></a><span data-ttu-id="4ccc3-103">Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="4ccc3-103">Initiate a planned or unplanned failover for Azure SQL Database with Transact-SQL</span></span>

<span data-ttu-id="4ccc3-104">В этой статье объясняется, как запустить отработку отказа в базе данных-получателе SQL Azure с помощью Transact-SQL.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-104">This article shows you how to initiate failover to a secondary SQL Database using Transact-SQL.</span></span> <span data-ttu-id="4ccc3-105">Сведения о настройке георепликации для баз данных SQL Azure см. в статье [Настройка активной георепликации базы данных SQL Azure с помощью Transact-SQL](sql-database-geo-replication-transact-sql.md).</span><span class="sxs-lookup"><span data-stu-id="4ccc3-105">To configure geo-replication, see [Configure geo-replication for Azure SQL Database](sql-database-geo-replication-transact-sql.md).</span></span>

<span data-ttu-id="4ccc3-106">Чтобы инициировать отработку отказа, необходимо следующее:</span><span class="sxs-lookup"><span data-stu-id="4ccc3-106">To initiate failover, you need the following:</span></span>

* <span data-ttu-id="4ccc3-107">имя для входа с ролью DBManager в базе данных-источнике;</span><span class="sxs-lookup"><span data-stu-id="4ccc3-107">A login that is DBManager on the primary</span></span>
* <span data-ttu-id="4ccc3-108">Привилегии db_ownership локальной базы данных, которую вы собираетесь геореплицировать.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-108">Have db_ownership of the local database that you will geo-replicate</span></span>
* <span data-ttu-id="4ccc3-109">роль DBManager на серверах-партнерах, для которых вы настроите георепликацию;</span><span class="sxs-lookup"><span data-stu-id="4ccc3-109">Be DBManager on the partner server(s) to which you will configure geo-replication</span></span>
* <span data-ttu-id="4ccc3-110">последняя версия SQL Server Management Studio (SSMS).</span><span class="sxs-lookup"><span data-stu-id="4ccc3-110">Newest version of SQL Server Management Studio (SSMS)</span></span>

> [!IMPORTANT]
> <span data-ttu-id="4ccc3-111">Чтобы обеспечить синхронизацию с обновлениями Microsoft Azure и Базой данных SQL, рекомендуется всегда использовать последнюю версию Management Studio.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-111">It is recommended that you always use the latest version of Management Studio to remain synchronized with updates to Microsoft Azure and SQL Database.</span></span> <span data-ttu-id="4ccc3-112">[Обновите среду SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).</span><span class="sxs-lookup"><span data-stu-id="4ccc3-112">[Update SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).</span></span>
>  

## <a name="initiate-a-planned-failover-promoting-a-secondary-database-to-become-the-new-primary"></a><span data-ttu-id="4ccc3-113">Запуск плановой отработки отказа для превращения базы данных-получателя в базу данных-источник</span><span class="sxs-lookup"><span data-stu-id="4ccc3-113">Initiate a planned failover promoting a secondary database to become the new primary</span></span>
<span data-ttu-id="4ccc3-114">Инструкция **ALTER DATABASE** позволяет в запланированном порядке сделать базу данных-получатель источником. При этом текущая база данных-источник станет получателем.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-114">You can use the **ALTER DATABASE** statement to promote a secondary database to become the new primary database in a planned fashion, demoting the existing primary to become a secondary.</span></span> <span data-ttu-id="4ccc3-115">Эта инструкция выполняется в базе данных master на логическом сервере базы данных SQL Azure, на котором находится геореплицированная база данных-получатель, статус которой повышается.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-115">This statement is executed on the master database on the Azure SQL Database logical server in which the geo-replicated secondary database that is being promoted resides.</span></span> <span data-ttu-id="4ccc3-116">Эта функция предназначена для плановой отработки отказа (как во время отработки аварийного восстановления). Чтобы ее использовать, нужно, чтобы база данных-источник была доступна.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-116">This functionality is designed for planned failover, such as during the DR drills, and requires that the primary database be available.</span></span>

<span data-ttu-id="4ccc3-117">Эта команда выполняет следующий рабочий процесс:</span><span class="sxs-lookup"><span data-stu-id="4ccc3-117">The command performs the following workflow:</span></span>

1. <span data-ttu-id="4ccc3-118">Временно переводит репликацию в синхронный режим. В результате все транзакции, ожидающие обработки, переносятся в базу данных-получателя, а новые транзакции блокируются.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-118">Temporarily switches replication to synchronous mode, causing all outstanding transactions to be flushed to the secondary and blocking all new transactions;</span></span>
2. <span data-ttu-id="4ccc3-119">Две базы данных, связанные георепликацией, обмениваются ролями.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-119">Switches the roles of the two databases in the geo-replication partnership.</span></span>  

<span data-ttu-id="4ccc3-120">Эта последовательность гарантирует, что базы данных будут синхронизированы до переключения ролей, а значит потери данных не возникнут.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-120">This sequence guarantees that the two databases are synchronized before the roles switch and therefore no data loss will occur.</span></span> <span data-ttu-id="4ccc3-121">В течение короткого периода (от 0 до 25 секунд), пока переключаются роли, обе базы данных будут недоступны.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-121">There is a short period during which both databases are unavailable (on the order of 0 to 25 seconds) while the roles are switched.</span></span> <span data-ttu-id="4ccc3-122">Если база данных-источник имеет несколько баз данных-получателей, команда автоматически перенастроится на другие базы данных-получатели для подключения к новой базе данных-источнику.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-122">If the primary database has multiple secondary databases, the command will automatically reconfigure the other secondaries to connect to the new primary.</span></span>  <span data-ttu-id="4ccc3-123">Обычно вся операция занимает меньше минуты.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-123">The entire operation should take less than a minute to complete under normal circumstances.</span></span> <span data-ttu-id="4ccc3-124">Дополнительные сведения см. в статьях [ALTER DATABASE (база данных SQL Azure)](https://msdn.microsoft.com/library/mt574871.aspx) и [Уровни служб базы данных SQL для отдельных баз данных и пулов эластичных баз данных](sql-database-service-tiers.md).</span><span class="sxs-lookup"><span data-stu-id="4ccc3-124">For more information, see [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) and [Service Tiers](sql-database-service-tiers.md).</span></span>

<span data-ttu-id="4ccc3-125">Чтобы запустить плановую отработку отказа, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-125">Use the following steps to initiate a planned failover.</span></span>

1. <span data-ttu-id="4ccc3-126">В Management Studio подключитесь к логическому серверу базы данных SQL Azure, на котором находится геореплицированная база данных-получатель.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-126">In Management Studio, connect to the Azure SQL Database logical server in which a geo-replicated secondary database resides.</span></span>
2. <span data-ttu-id="4ccc3-127">Откройте папку "Базы данных", разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-127">Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="4ccc3-128">Чтобы базу данных-получатель сделать базой данных-источником, используйте следующую операцию **ALTER DATABASE** .</span><span class="sxs-lookup"><span data-stu-id="4ccc3-128">Use the following **ALTER DATABASE** statement to switch the secondary database to the primary role.</span></span>
   
        ALTER DATABASE <MyDB> FAILOVER;
4. <span data-ttu-id="4ccc3-129">Нажмите кнопку **Выполнить** для выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-129">Click **Execute** to run the query.</span></span>

> [!NOTE]
> <span data-ttu-id="4ccc3-130">В редких случаях бывает, что операцию нельзя завершить и что она зависла.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-130">In rare cases, it is possible that the operation cannot complete and may appear stuck.</span></span> <span data-ttu-id="4ccc3-131">Тогда вы можете выполнить команду принудительной отработки отказа (при этом будут потеряны данные).</span><span class="sxs-lookup"><span data-stu-id="4ccc3-131">In this case, the user can execute the force failover command and accept data loss.</span></span>
> 
> 

## <a name="initiate-an-unplanned-failover-from-the-primary-database-to-the-secondary-database"></a><span data-ttu-id="4ccc3-132">Запуск внеплановой отработки отказа для превращения базы данных-источника в базу данных-получателя</span><span class="sxs-lookup"><span data-stu-id="4ccc3-132">Initiate an unplanned failover from the primary database to the secondary database</span></span>
<span data-ttu-id="4ccc3-133">Инструкция **ALTER DATABASE** позволяет во внеплановом порядке сделать базу данных-получатель источником. При этом текущая база данных-источник станет получателем, когда база данных-источник перестанет быть доступной.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-133">You can use the **ALTER DATABASE** statement to promote a secondary database to become the new primary database in an unplanned fashion, forcing the demotion of the existing primary to become a secondary at a time when the primary database is no longer available.</span></span> <span data-ttu-id="4ccc3-134">Эта инструкция выполняется в базе данных master на логическом сервере базы данных SQL Azure, на котором находится геореплицированная база данных-получатель, статус которой повышается.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-134">This statement is executed on the master database on the Azure SQL Database logical server in which the geo-replicated secondary database that is being promoted resides.</span></span>

<span data-ttu-id="4ccc3-135">Эта функция предназначена для аварийного восстановления в случаях, когда восстановить доступность базы данных крайне необходимо, а потеря некоторого объема данных является приемлемой.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-135">This functionality is designed for disaster recovery when restoring availability of the database is critical and some data loss is acceptable.</span></span> <span data-ttu-id="4ccc3-136">Когда вызывается принудительная отработка отказа, указанная база данных-получатель сразу становится источником и начинает принимать транзакции записи.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-136">When forced failover is invoked, the specified secondary database immediately becomes the primary database and begins accepting write transactions.</span></span> <span data-ttu-id="4ccc3-137">Когда становится возможным повторно подключить первоначальную базу данных-источник к новой базе данных-источнику, сразу выполняется добавочная архивация первоначальной базы данных-источника, которая при этом становится получателем по отношению к новому источнику, то есть его репликой, выполняющей функцию синхронизации.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-137">As soon as the original primary database is able to reconnect with this new primary database, an incremental backup is taken on the original primary database and the old primary database is made into a secondary database for the new primary database; subsequently, it is merely a synchronizing replica of the new primary.</span></span>

<span data-ttu-id="4ccc3-138">При этом функция «Восстановление до точки во времени» не поддерживается в базах данных-получателях. Поэтому следует обращаться в службу поддержки, если нужно восстановить потерянные данные, которые были записаны в прошлую базу данных-источник и которые перед принудительной отработкой отказа не удалось реплицировать в новый источник.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-138">However, because Point In Time Restore is not supported on the secondary databases, if the user wishes to recover data committed to the old primary database that had not been replicated to the new primary database before the forced failover occurred, the user will need to engage support to recover this lost data.</span></span>

<span data-ttu-id="4ccc3-139">Если база данных-источник имеет несколько баз данных-получателей, команда автоматически перенастроится на другие базы данных-получатели для подключения к новой базе данных-источнику.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-139">If the primary database has multiple secondary databases, the command will automatically reconfigure the other secondaries to connect to the new primary.</span></span>

<span data-ttu-id="4ccc3-140">Чтобы запустить плановую отработку отказа, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-140">Use the following steps to initiate an unplanned failover.</span></span>

1. <span data-ttu-id="4ccc3-141">В Management Studio подключитесь к логическому серверу базы данных SQL Azure, на котором находится геореплицированная база данных-получатель.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-141">In Management Studio, connect to the Azure SQL Database logical server in which a geo-replicated secondary database resides.</span></span>
2. <span data-ttu-id="4ccc3-142">Откройте папку "Базы данных", разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-142">Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="4ccc3-143">Чтобы базу данных-получатель сделать базой данных-источником, используйте следующую операцию **ALTER DATABASE** .</span><span class="sxs-lookup"><span data-stu-id="4ccc3-143">Use the following **ALTER DATABASE** statement to switch the secondary database to the primary role.</span></span>
   
        ALTER DATABASE <MyDB>   FORCE_FAILOVER_ALLOW_DATA_LOSS;
4. <span data-ttu-id="4ccc3-144">Нажмите кнопку **Выполнить** для выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-144">Click **Execute** to run the query.</span></span>

> [!NOTE]
> <span data-ttu-id="4ccc3-145">Если команда выполняется, когда одновременно доступны база данных-источник и база данных-получатель, старый источник становится новым получателем мгновенно и без синхронизации данных.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-145">If the command is issued when both primary and secondary are online the old primary will become the new secondary immediately without data synchronization.</span></span> <span data-ttu-id="4ccc3-146">Если при отправке команды источник выполняет транзакции, некоторые данные могут быть утеряны.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-146">If the primary is committing transactions when the command is issued some data loss may occur.</span></span>
> 
> 

## <a name="next-steps"></a><span data-ttu-id="4ccc3-147">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="4ccc3-147">Next steps</span></span>
* <span data-ttu-id="4ccc3-148">После отработки отказа убедитесь, что для новой базы данных-источника настроены требования аутентификации ваших сервера и базы данных.</span><span class="sxs-lookup"><span data-stu-id="4ccc3-148">After failover, ensure the authentication requirements for your server and database are configured on the new primary.</span></span> <span data-ttu-id="4ccc3-149">Дополнительные сведения см. в разделе [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).</span><span class="sxs-lookup"><span data-stu-id="4ccc3-149">For details, see [SQL Database security after disaster recovery](sql-database-geo-replication-security-config.md).</span></span>
* <span data-ttu-id="4ccc3-150">Чтобы изучить восстановление после сбоя с помощью активной георепликации, включая предварительные и последующие действия и отработку аварийного восстановления, ознакомьтесь со статьей [Восстановление базы данных SQL Azure или переход на базу данных-получатель при отказе](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="4ccc3-150">To learn recovering after a disaster using active geo-replication, including pre-recovery and post-recovery steps and performing a disaster recovery drill, see [Disaster Recovery](sql-database-disaster-recovery.md)</span></span>
* <span data-ttu-id="4ccc3-151">Прочитайте запись блога Александра Носова об активной георепликации: [Spotlight on new capabilities of Azure SQL Database geo-replication](https://azure.microsoft.com/blog/spotlight-on-new-capabilities-of-azure-sql-database-geo-replication/) (Полезные сведения о новых возможностях георепликации базы данных SQL).</span><span class="sxs-lookup"><span data-stu-id="4ccc3-151">For a Sasha Nosov blog post about active geo-replication, see [Spotlight on new geo-replication capabilities](https://azure.microsoft.com/blog/spotlight-on-new-capabilities-of-azure-sql-database-geo-replication/)</span></span>
* <span data-ttu-id="4ccc3-152">Сведения о проектировании облачных приложений для использования активной георепликации см. в статье [Разработка службы высокой доступности с помощью базы данных SQL Azure](sql-database-designing-cloud-solutions-for-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="4ccc3-152">For information about designing cloud applications to use active geo-replication, see [Designing cloud applications for business continuity using geo-replication](sql-database-designing-cloud-solutions-for-disaster-recovery.md)</span></span>
* <span data-ttu-id="4ccc3-153">Сведения об использовании активной георепликации с эластичными пулами см. в статье [Стратегии аварийного восстановления для приложений с использованием пула эластичных баз данных SQL](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md).</span><span class="sxs-lookup"><span data-stu-id="4ccc3-153">For information about using active geo-replication with elastic pools, see [Elastic Pool disaster recovery strategies](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md).</span></span>
* <span data-ttu-id="4ccc3-154">Общие сведения об обеспечении непрерывности бизнес-процессов можно узнать в статье [Обзор обеспечения непрерывности бизнес-процессов с помощью базы данных SQL Azure](sql-database-business-continuity.md).</span><span class="sxs-lookup"><span data-stu-id="4ccc3-154">For an overview of business continuity, see [Business Continuity Overview](sql-database-business-continuity.md)</span></span>


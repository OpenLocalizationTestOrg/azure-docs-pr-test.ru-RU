---
title: "TSQL. Выполнение отработки отказа для базы данных SQL Azure | Документация Майкрософт"
description: "Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью Transact-SQL"
services: sql-database
documentationcenter: 
author: CarlRabeler
manager: jhubbard
editor: 
ms.assetid: 5eb2d256-025d-4f5a-99d4-17f702b37f14
ms.service: sql-database
ms.custom: business continuity
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: data-management
ms.date: 01/10/2017
ms.author: carlrab
ms.openlocfilehash: 459941d2c82e5d4ef62beab4ccf775ab8f5efce4
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="initiate-a-planned-or-unplanned-failover-for-azure-sql-database-with-transact-sql"></a>Запуск плановой или незапланированной отработки отказа для базы данных SQL Azure с помощью Transact-SQL

В этой статье объясняется, как запустить отработку отказа в базе данных-получателе SQL Azure с помощью Transact-SQL. Сведения о настройке георепликации для баз данных SQL Azure см. в статье [Настройка активной георепликации базы данных SQL Azure с помощью Transact-SQL](sql-database-geo-replication-transact-sql.md).

Чтобы инициировать отработку отказа, необходимо следующее:

* имя для входа с ролью DBManager в базе данных-источнике;
* Привилегии db_ownership локальной базы данных, которую вы собираетесь геореплицировать.
* роль DBManager на серверах-партнерах, для которых вы настроите георепликацию;
* последняя версия SQL Server Management Studio (SSMS).

> [!IMPORTANT]
> Чтобы обеспечить синхронизацию с обновлениями Microsoft Azure и Базой данных SQL, рекомендуется всегда использовать последнюю версию Management Studio. [Обновите среду SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).
>  

## <a name="initiate-a-planned-failover-promoting-a-secondary-database-to-become-the-new-primary"></a>Запуск плановой отработки отказа для превращения базы данных-получателя в базу данных-источник
Инструкция **ALTER DATABASE** позволяет в запланированном порядке сделать базу данных-получатель источником. При этом текущая база данных-источник станет получателем. Эта инструкция выполняется в базе данных master на логическом сервере базы данных SQL Azure, на котором находится геореплицированная база данных-получатель, статус которой повышается. Эта функция предназначена для плановой отработки отказа (как во время отработки аварийного восстановления). Чтобы ее использовать, нужно, чтобы база данных-источник была доступна.

Эта команда выполняет следующий рабочий процесс:

1. Временно переводит репликацию в синхронный режим. В результате все транзакции, ожидающие обработки, переносятся в базу данных-получателя, а новые транзакции блокируются.
2. Две базы данных, связанные георепликацией, обмениваются ролями.  

Эта последовательность гарантирует, что базы данных будут синхронизированы до переключения ролей, а значит потери данных не возникнут. В течение короткого периода (от 0 до 25 секунд), пока переключаются роли, обе базы данных будут недоступны. Если база данных-источник имеет несколько баз данных-получателей, команда автоматически перенастроится на другие базы данных-получатели для подключения к новой базе данных-источнику.  Обычно вся операция занимает меньше минуты. Дополнительные сведения см. в статьях [ALTER DATABASE (база данных SQL Azure)](https://msdn.microsoft.com/library/mt574871.aspx) и [Уровни служб базы данных SQL для отдельных баз данных и пулов эластичных баз данных](sql-database-service-tiers.md).

Чтобы запустить плановую отработку отказа, выполните следующие действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure, на котором находится геореплицированная база данных-получатель.
2. Откройте папку "Базы данных", разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.
3. Чтобы базу данных-получатель сделать базой данных-источником, используйте следующую операцию **ALTER DATABASE** .
   
        ALTER DATABASE <MyDB> FAILOVER;
4. Нажмите кнопку **Выполнить** для выполнения запроса.

> [!NOTE]
> В редких случаях бывает, что операцию нельзя завершить и что она зависла. Тогда вы можете выполнить команду принудительной отработки отказа (при этом будут потеряны данные).
> 
> 

## <a name="initiate-an-unplanned-failover-from-the-primary-database-to-the-secondary-database"></a>Запуск внеплановой отработки отказа для превращения базы данных-источника в базу данных-получателя
Инструкция **ALTER DATABASE** позволяет во внеплановом порядке сделать базу данных-получатель источником. При этом текущая база данных-источник станет получателем, когда база данных-источник перестанет быть доступной. Эта инструкция выполняется в базе данных master на логическом сервере базы данных SQL Azure, на котором находится геореплицированная база данных-получатель, статус которой повышается.

Эта функция предназначена для аварийного восстановления в случаях, когда восстановить доступность базы данных крайне необходимо, а потеря некоторого объема данных является приемлемой. Когда вызывается принудительная отработка отказа, указанная база данных-получатель сразу становится источником и начинает принимать транзакции записи. Когда становится возможным повторно подключить первоначальную базу данных-источник к новой базе данных-источнику, сразу выполняется добавочная архивация первоначальной базы данных-источника, которая при этом становится получателем по отношению к новому источнику, то есть его репликой, выполняющей функцию синхронизации.

При этом функция «Восстановление до точки во времени» не поддерживается в базах данных-получателях. Поэтому следует обращаться в службу поддержки, если нужно восстановить потерянные данные, которые были записаны в прошлую базу данных-источник и которые перед принудительной отработкой отказа не удалось реплицировать в новый источник.

Если база данных-источник имеет несколько баз данных-получателей, команда автоматически перенастроится на другие базы данных-получатели для подключения к новой базе данных-источнику.

Чтобы запустить плановую отработку отказа, выполните следующие действия.

1. В Management Studio подключитесь к логическому серверу базы данных SQL Azure, на котором находится геореплицированная база данных-получатель.
2. Откройте папку "Базы данных", разверните папку **Системные базы данных**, щелкните правой кнопкой мыши базу данных **master** и щелкните **Создать запрос**.
3. Чтобы базу данных-получатель сделать базой данных-источником, используйте следующую операцию **ALTER DATABASE** .
   
        ALTER DATABASE <MyDB>   FORCE_FAILOVER_ALLOW_DATA_LOSS;
4. Нажмите кнопку **Выполнить** для выполнения запроса.

> [!NOTE]
> Если команда выполняется, когда одновременно доступны база данных-источник и база данных-получатель, старый источник становится новым получателем мгновенно и без синхронизации данных. Если при отправке команды источник выполняет транзакции, некоторые данные могут быть утеряны.
> 
> 

## <a name="next-steps"></a>Дальнейшие действия
* После отработки отказа убедитесь, что для новой базы данных-источника настроены требования аутентификации ваших сервера и базы данных. Дополнительные сведения см. в разделе [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).
* Чтобы изучить восстановление после сбоя с помощью активной георепликации, включая предварительные и последующие действия и отработку аварийного восстановления, ознакомьтесь со статьей [Восстановление базы данных SQL Azure или переход на базу данных-получатель при отказе](sql-database-disaster-recovery.md).
* Прочитайте запись блога Александра Носова об активной георепликации: [Spotlight on new capabilities of Azure SQL Database geo-replication](https://azure.microsoft.com/blog/spotlight-on-new-capabilities-of-azure-sql-database-geo-replication/) (Полезные сведения о новых возможностях георепликации базы данных SQL).
* Сведения о проектировании облачных приложений для использования активной георепликации см. в статье [Разработка службы высокой доступности с помощью базы данных SQL Azure](sql-database-designing-cloud-solutions-for-disaster-recovery.md).
* Сведения об использовании активной георепликации с эластичными пулами см. в статье [Стратегии аварийного восстановления для приложений с использованием пула эластичных баз данных SQL](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md).
* Общие сведения об обеспечении непрерывности бизнес-процессов можно узнать в статье [Обзор обеспечения непрерывности бизнес-процессов с помощью базы данных SQL Azure](sql-database-business-continuity.md).


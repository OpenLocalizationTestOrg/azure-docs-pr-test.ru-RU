---
title: "Учебник SaaS базы данных каждого клиента - базы данных SQL Azure | Документы Microsoft"
description: "Разверните и изучите мультитенантное приложение SaaS Wingtip Tickets, которое демонстрирует создание отдельной базы данных для каждого клиента и другие схемы работы с приложениями SaaS и базами данных SQL Azure."
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: MightyPen
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: Inactive
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/07/2017
ms.author: genemi
ms.openlocfilehash: 5342b5290fab9826a2b38cd7ada63a6736c77601
ms.sourcegitcommit: 094061b19b0a707eace42ae47f39d7a666364d58
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/08/2017
---
# <a name="deploy-and-explore-a-multi-tenant-saas-application-that-uses-the-database-per-tenant-pattern-with-azure-sql-database"></a>Развертывание и изучение мультитенантного приложения SaaS на основе базы данных SQL Azure, в котором используется отдельная база данных для каждого клиента

В этом учебнике, развернуть и изучить SaaS билеты Wingtip *базы данных каждому клиенту* приложения (Wingtip). Приложение использует в шаблон клиента базы данных для хранения данных нескольких клиентов. Это приложение предназначено для демонстрации функции базы данных SQL Azure, которые упрощают Включение сценарии SaaS.

Пять минут после запуска нажмите синюю кнопку с меткой **развертыванию в Azure**, у вас есть многопользовательского приложения SaaS. Приложение включает базы данных SQL Azure в облаке Microsoft Azure. Приложение развертывается с тремя клиентами образца, каждый из которых свою собственную базу данных. Все базы данных развертываются в SQL *эластичного пула*. К подписке Azure развертывается приложение. Имеется полный доступ для просмотра и работы с отдельными компонентами приложения. C# исходный код приложения и скрипты управления доступны в [в репозитории GitHub WingtipTicketsSaaS DbPerTenant][github-wingtip-dpt].

Из этого руководства вы узнаете следующее:

> [!div class="checklist"]
> - как развернуть приложение SaaS Wingtip;
> - где можно получить исходный код приложения и скрипты управления;
> - О серверах, пулы и баз данных, составляющих приложение.
> - как сопоставить клиентов с данными с помощью *каталога*;
> - как подготовить новый клиент;
> - как выполнить мониторинг активности клиента в приложении.

Объект [серию учебников, связанных](saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials) предлагает для просмотра различных шаблонов проектирования и управления SaaS. Учебники последовательно за пределами этого первоначального развертывания.
При использовании учебников, вы увидите реализации различных шаблонов SaaS с помощью предоставленного сценарии проверки.
Сценарии показано, как функциональные возможности базы данных SQL упрощают разработку приложений SaaS.

## <a name="prerequisites"></a>Технические условия

Для работы с этим руководством выполните следующие предварительные требования:

* Установите Azure PowerShell. Дополнительные сведения см. в разделе [Приступая к работе с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

## <a name="deploy-the-wingtip-tickets-saas-application"></a>Развертывание приложения SaaS Wingtip Tickets

Разверните приложения, выполнив следующие действия.

1. Выбрать и запомнить значения, которые потребуются для следующих параметров:

    - **Пользователь**: выберите короткое значение, например инициалы следуют цифры. Например *af1*. Если параметр может содержать только буквы, цифры и дефисы (без пробелов). Первый и последний символ должен быть буквой или цифрой. Рекомендуется все буквы нижнего регистра.
    - **Группа ресурсов**: каждый раз при развертывании приложения Wingtip, необходимо выбрать другой уникальное имя для новой группы ресурсов. Рекомендуется добавлять имя пользователя для базовое имя для группы ресурсов. Пример имени группы ресурсов может быть *wingtip af1*. Еще раз рекомендуется все буквы нижнего регистра.

2. Открыть базу данных SaaS Wingtip билеты в шаблон развертывания клиента на портале Azure, щелкнув синий **развертыванию в Azure** кнопки.

   <a href="https://aka.ms/deploywingtipdpt" target="_blank"><img src="http://azuredeploy.net/deploybutton.png"/></a>

3. В шаблоне введите значения для обязательных параметров:

    > [!IMPORTANT]
    > Некоторые проверки подлинности и брандмауэры сервера не защищены специально, так как предназначены для демонстрации. Мы рекомендуем вам *создать новую группу ресурсов*. Не используйте существующие группы ресурсов, серверы или пулы. Не используйте в рабочей среде это приложение, его скрипты или созданные им ресурсы. Поработав с приложением, удалите эту группу ресурсов, чтобы завершить связанное выставление счетов.

    - **Группа ресурсов** — выберите **создать новый** и укажите уникальный **имя** ранее выбранным для группы ресурсов. 
    - **Расположение** — выберите **Расположение** из раскрывающегося списка.
    - **Пользователь** -использовать ранее выбранным значение имени пользователя.

4. Разверните приложения.

    - Установите флажок, чтобы принять условия.
    - Щелкните **Приобрести**.

5. Мониторинг состояния развертывания, щелкнув **уведомления**, который является значок колокольчика справа от поля поиска. Развертывание приложения SaaS Wingtip Tickets занимает примерно пять минут.

   ![Развертывание выполнено](media/saas-dbpertenant-get-started-deploy/succeeded.png)

## <a name="download-and-unblock-the-wingtip-tickets-management-scripts"></a>Загрузка и разблокировка скриптов управления для приложения Wingtip Tickets

Пока выполняется развертывание приложения, загрузите исходный код и скрипты управления.

> [!IMPORTANT]
> ZIP-файлов загруженных из внешнего источника и извлечь содержимое исполняемый файл (сценарии, библиотеки DLL) могут быть заблокированы Windows. Перед извлечением скриптов из ZIP-файла выполните указанные ниже действия, чтобы разблокировать ZIP-файл. Разблокировка гарантирует, что разрешено запускать скрипты.

1. Перейдите к [в репозитории GitHub WingtipTicketsSaaS DbPerTenant][github-wingtip-dpt].
2. Выберите **Clone or download** (Клонировать или скачать).
3. Нажмите кнопку **загрузить ZIP**, а затем сохраните файл.
4. Щелкните правой кнопкой мыши **WingtipTicketsSaaS DbPerTenant-master.zip** файла, а затем выберите **свойства**.
5. На **Общие** выберите **Unblock**, а затем нажмите кнопку **применить**.
6. Последовательно выберите **ОК**.
7. Извлеките файлы.

Скрипты находятся в папке *..\\WingtipTicketsSaaS-DbPerTenant-master\\Learning Modules*.

## <a name="update-the-user-configuration-file-for-this-deployment"></a>Обновление файла конфигурации пользователя для развертывания

Прежде чем запускать любые скрипты, настройте значения *группы ресурсов* и *пользователя* в файле **UserConfig.psm1**. Задайте для этих переменных значения, указанные во время развертывания.

1. В *интегрированной среде сценариев PowerShell* откройте файл ...\\Learning Modules\\*UserConfig.psm1*. 
2. В полях *ResourceGroupName* и *Name* введите специфические для развертывания значения (только в строках 10 и 11).
3. Сохраните изменения.

Эти значения используются почти во всех скриптах.

## <a name="run-the-application"></a>Выполнение приложения

Приложение служит витриной для объектов, в которых проводятся культурные мероприятия. Чаще всего это концертные залы, джаз-клубы, спортивные клубы и т. п. В билеты Wingtip местоположения зарегистрированных клиентов. Это дает каждому из них простую возможность предоставлять клиентам список мероприятий и продавать билеты. Для каждого объекта создается персонализированный веб-сайт для отображения списка мероприятий и продажи билетов.

Внутренне в приложении, каждый клиент получает базы данных SQL, развернутых в пуле эластичных БД SQL.

Центральная страница **Концентратор событий** содержит список клиентов в вашем развертывании со ссылками.

1. Откройте *концентратор событий* в веб-браузере по адресу: http://events.wingtip-dpt.&lt;ПОЛЬЗОВАТЕЛЬ&gt;.trafficmanager.net. Строку &lt;Пользователь&gt; замените именем пользователя для конкретного развертывания.

    ![Концентратор событий](media/saas-dbpertenant-get-started-deploy/events-hub.png)

2. Щелкните **Fabrikam Jazz Club** в *концентраторе событий*.

    ![События](./media/saas-dbpertenant-get-started-deploy/fabrikam.png)

#### <a name="azure-traffic-manager"></a>Azure Traffic Manager

Wingtip приложение использует [ *диспетчера трафика Azure* ](../traffic-manager/traffic-manager-overview.md) для управления распределением входящие запросы. URL-адрес для доступа к концентратору событий для одного клиента должна иметь следующий формат:

- http://Events.Wingtip-DPT.&lt;пользователя&gt;.trafficmanager.net/fabrikamjazzclub

В следующей таблице описываются части предыдущего формата.

| Часть URL-адреса | ОПИСАНИЕ |
| :------- | :---------- |
| http://Events.Wingtip-DPT | Части приложения Wingtip события.<br /><br />***-dpt*** часть отличает *базы данных для клиента* реализация Wingtip от других реализаций немного отличается. Например, в других статьях документации предложить Wingtip для *Standalong* (*-sa*), или для *DB несколькими клиентами*. |
| .  *&lt;ПОЛЬЗОВАТЕЛЯ&gt;* | *af1* в нашем примере. |
| .trafficmanager.NET/ | Диспетчер трафика Azure, базовый URL-адрес. |
| fabrikamjazzclub | Для клиента с именем *сообщество Jazz Fabrikam*. |
| &nbsp; | &nbsp; |

1. Имя клиента выполняется синтаксический анализ по URL-адресу в приложении события.
2. Имя клиента используется для создания ключа.
3. Ключ используется для доступа к каталогу, чтобы получить расположение базы данных клиента.
    - Каталог реализуется с помощью *управления карты сегментов*.
4. *Концентратора событий* использует расширенные метаданные в каталоге для получения списка событий URL-адресов.

В рабочей среде обычно создать запись CNAME DNS для [ *направление домена Интернета компании* ](../traffic-manager/traffic-manager-point-internet-domain.md) в профиле диспетчера трафика.

## <a name="start-generating-load-on-the-tenant-databases"></a>Запуск создания нагрузки в базах данных клиента

Теперь после развертывания приложение готово к работе.
Скрипт *Demo-LoadGenerator* PowerShell запускает рабочую нагрузку, выполняющуюся во всех клиентских базах данных.
Реальной нагрузки на многих приложений SaaS случайные и непредсказуемым.
Для имитации нагрузки этого типа, генератор выдает нагрузки с помощью случайного пиков или резкого возрастания активности на каждого клиента.
Образуются, случайного интервалы.
Он занимает несколько минут для шаблона нагрузки вырисовываться. Поэтому лучше позволить работать по крайней мере трех или четырех минут перед мониторинга нагрузки генератора.

1. В *интегрированной среде сценариев PowerShell* откройте скрипт ...\\Learning Modules\\Utilities\\*Demo-LoadGenerator.ps1*.
2. Нажмите клавишу **F5** для запуска скрипта и запуска генератор нагрузки. (Оставить значение по умолчанию значения параметров сейчас).

Не используйте повторно один и тот же экземпляр интегрированной среды Сценариев PowerShell в остальных, возможно, запустите из *LoadGenerator.ps1 Демонстрация*. Если требуется запускать другие сценарии PowerShell, запустите отдельные интегрированной среды Сценариев PowerShell.

#### <a name="rerun-with-different-parameters"></a>Повторно запустите с различными параметрами

Если вы хотите повторить выполнение теста с другими параметрами рабочей нагрузки, выполните следующие действия.

1. Остановить *LoadGenerator.ps1*.
    - Используйте **Ctrl + C**, или нажмите кнопку **остановить** кнопки.
    - Это остановки остановить или не влияют на все незавершенные фоновые задания, по-прежнему работают.

2. Запустите *LoadGenerator.ps1 Демонстрация*.
    - Этом перезапустите сначала останавливает все фоновые задания, которые могут работать по-прежнему *sp_CpuLoadGenerator*.

Или можно завершить экземпляр интегрированной среды Сценариев PowerShell, который останавливает все фоновые задания. Затем запустите новый экземпляр интегрированной среды сценариев PowerShell и запустите программу *LoadGenerator.ps1 Демонстрация*.

#### <a name="monitor-the-background-jobs"></a>Мониторинг фоновых заданий

Если вы хотите управлять и отслеживать фоновых заданий, можно использовать следующие командлеты:

- Get-Job
- Получение задания
- Остановка задания

#### <a name="demo-loadgeneratorps1-actions"></a>Демонстрация LoadGenerator.ps1 действия

*Демонстрация LoadGenerator.ps1* имитирует Активная рабочая нагрузка операций клиента. Следующие шаги описывают последовательность действий, *LoadGenerator.ps1 Демонстрация* инициирует:

1. *Демонстрация LoadGenerator.ps1* запускает *LoadGenerator.ps1* на переднем плане.
    - Оба эти ps1-файлы хранятся в папках *модулей обучения\\программы\\*.

2. *LoadGenerator.ps1* перебирает все базы данных клиента, которые зарегистрированы в каталоге.

3. Для каждой базы данных клиента *LoadGenerator.ps1* начинается выполнение инструкции Transact-SQL хранимой процедуру с именем *sp_CpuLoadGenerator*.
    - Выполнений запускаются в фоновом режиме, путем вызова *Invoke SqlAzureWithRetry* командлета.
    - *sp_CpuLoadGenerator* рамок вокруг инструкции SQL SELECT по умолчанию в течение 60 секунд. Интервал времени между проблемы выбора варьируется в зависимости от значения параметра.
    - Этот SQL-файл хранится в *WingtipTenantDB\\dbo\\StoredProcedures\\*.

4. Для каждой базы данных клиента *LoadGenerator.ps1* также запускает *Start-Job* командлета.
    - *Start-Job* имитирует рабочей нагрузки билет продаж.

5. *LoadGenerator.ps1* продолжает работать, наблюдение за любой новых клиентов, которые подготовлены.

&nbsp;

Прежде чем переходить к следующему разделу, оставьте генератор нагрузки, в состоянии вызова задания.

## <a name="provision-a-new-tenant"></a>Подготовка нового клиента

Первоначального развертывания создает три образца клиента. Теперь можно создать другого клиента, чтобы узнать, какое влияние для развернутого приложения. В приложении Wingtip описывается рабочий процесс для подготовки новых клиентов в [учебника подготовки и каталога](saas-dbpertenant-provision-and-catalog.md). На этом этапе создания нового клиента, что занимает меньше минуты.

1. В *интегрированной среде сценариев PowerShell* откройте файл ...\\Learning Modules\Provision and Catalog\\*Demo-ProvisionAndCatalog.ps1*.
2. Нажмите клавишу **F5** для запуска скрипта. (Оставьте значения по умолчанию сейчас).

   > [!NOTE]
   > Во многих скриптах SaaS Wingtip Tickets переменная *$PSScriptRoot* используется для перехода по папкам и вызова функций из других скриптов. Эта переменная вычисляется только при выполнении полного скрипта путем нажатия клавиши **F5**.  Выделение и под управлением выбранных объектов с **F8** может привести к ошибкам. Выполните сценарии, нажав клавишу **F5**.

Новая база данных клиента является:

- Созданные в пуле эластичных БД SQL.
- Инициализирован.
- Зарегистрировано в каталоге.

После успешной подготовки *событий* в браузере откроется сайт нового клиента:

![Новый клиент](./media/saas-dbpertenant-get-started-deploy/red-maple-racing.png)

Обновить *концентратора событий* вносить нового клиента, которые отображаются в списке.

## <a name="explore-the-servers-pools-and-tenant-databases"></a>Изучение серверов, пулов и клиентских баз данных

Теперь, когда вы запустили выполнение нагрузки в коллекции клиентов, давайте рассмотрим некоторые из развернутых ресурсов.

1. В [портал Azure](http://portal.azure.com), перейдите к списку серверов SQL Server, а затем откройте **каталога-dpt -&lt;пользователя&gt;**  сервера.
    - Этот сервер каталога содержит две базы данных: **tenantcatalog** и **basetenantdb**. Вторая из них является шаблоном базы данных, который копируется для создания новых клиентов.

   ![databases](./media/saas-dbpertenant-get-started-deploy/databases.png)

2. Вы можете вернуться к списку серверов SQL Server.

3. Откройте **tenants1-dpt -&lt;пользователя&gt;**  сервер, содержащий базы данных клиента.

4. См. следующие элементы:
    - Каждая клиентская база данных является эластичной базой данных *уровня "Стандартный"* в пуле уровня "Стандартный" на 50 eDTU.
    - *Трассировки клен Red* базы данных, которая является базой данных клиентов, подготовлены в ранее.

   ![server](./media/saas-dbpertenant-get-started-deploy/server.png)

## <a name="monitor-the-pool"></a>Отслеживание пула

После *LoadGenerator.ps1* запуски для нескольких минут достаточно данные должны быть доступны для поиска в некоторых возможностей наблюдения. Эти возможности встроены в пулы и баз данных.

Перейдите к серверу **tenants1-dpt -&lt;пользователя&gt;**и нажмите кнопку **Pool1** об использовании ресурсов для пула. На следующих диаграммах генератор нагрузки запуска для одного часа.

   ![Отслеживание пула](./media/saas-dbpertenant-get-started-deploy/monitor-pool.png)

- Первую диаграмму, с меткой **использование ресурсов**, показан пул использования eDTU.
- Вторая диаграмма отображается использование eDTU пять баз данных в пуле.

Две диаграммы показывают, что эластичные пулы и базы данных SQL хорошо подходят для рабочих нагрузок приложений SaaS.
Диаграммы показывают 4 базы данных, каждый всплеск настолько, насколько 40 число Edtu, которое еще удобно поддерживаются все базы данных с помощью 50 eDTU пула. 50 eDTU пула может поддерживать даже более сложной рабочих нагрузок.
Если они были подготовлены как автономные базы данных, каждая из них должна быть уровня S2 (50 DTU), чтобы поддерживать пиковые нагрузки.
Затраты на 4 S2 автономные базы данных будет почти 3 раза цена пула.
На самом деле клиенты базы данных SQL используют до 500 баз данных в пулах на 200 eDTU.
Дополнительные сведения см. в статье об [отслеживании производительности примера приложения SaaS для WTP](saas-dbpertenant-performance-monitoring.md).

## <a name="additional-resources"></a>Дополнительные ресурсы

- Дополнительные [руководства на основе приложения SaaS Wingtip Tickets с отдельной базой данных для каждого клиента](saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials).
- Дополнительные сведения об эластичных пулах см. в статье [*Эластичные пулы помогают управлять несколькими базами данных SQL и масштабировать их*](sql-database-elastic-pool.md).
- Дополнительные сведения об эластичных заданиях см. в статье [*Управление масштабируемыми облачными базами данных*](sql-database-elastic-jobs-overview.md).
- Дополнительные сведения о шаблонах разработки для мультитенантных приложений SaaS и базы данных SQL Azure см. в [*этой статье*](saas-tenancy-app-design-patterns.md).


## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали следующее:

> [!div class="checklist"]
> - Развертывание приложения SaaS Wingtip Tickets
> - О серверах, пулах и базах данных, формирующих приложение.
> - О клиентах, сопоставленных с данными с помощью *каталога*.
> - Как подготовить новые клиенты.
> - Как просмотреть историю использования пула для отслеживания работы клиента.
> - Как удалить примеры ресурсов, чтобы прекратить связанное выставление счетов.

После этого повторите [учебника подготовки и каталога](saas-dbpertenant-provision-and-catalog.md).



<!-- Link references. -->

[github-wingtip-dpt]: https://github.com/Microsoft/WingtipTicketsSaaS-DbPerTenant 


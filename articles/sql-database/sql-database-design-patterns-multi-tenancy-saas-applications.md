---
title: "Шаблоны разработки мультитенантных приложений SaaS и базы данных SQL Azure | Документация Майкрософт"
description: "В этой статье описаны требования и общие шаблоны архитектуры данных мультитенантных приложений баз данных, работающих в облачной среде, а также различные компромиссы, связанные с этими шаблонами. Здесь также объясняется, как База данных SQL Azure с пулами эластичных БД и инструментами эластичных баз данных позволяет выполнить эти требования без компромиссов."
keywords: 
services: sql-database
documentationcenter: 
author: srinia
manager: jhubbard
editor: 
ms.assetid: 1dd20c6b-ddbb-40ef-ad34-609d398d008a
ms.service: sql-database
ms.custom: scale out apps
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: sqldb-design
ms.date: 02/01/2017
ms.author: srinia
ms.openlocfilehash: 0f6ba62a01f3211ccaae6b6c48f72e0de54aad78
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="design-patterns-for-multi-tenant-saas-applications-and-azure-sql-database"></a>Шаблоны разработки для мультитенантных приложений SaaS и база данных SQL Azure
В этой статье рассматриваются требования и общие шаблоны архитектуры данных для мультитенантных приложений базы данных программного обеспечения как услуги (SaaS), работающих в облачной среде. Здесь также описываются факторы, которые необходимо учесть, и компромиссы различных шаблонов разработки. Пулы эластичных БД и инструменты эластичных баз данных в Базе данных SQL Azure помогают обеспечить соответствие конкретным требованиям без ущерба для других целей.

При разработке клиентских моделей для уровней данных мультитенантных приложений разработчики иногда принимают решения, которые идут вразрез с их долгосрочными целями. По меньшей мере изначально простота разработки и низкая стоимость услуг поставщика облачных служб имела для разработчика большее значение, чем изоляция клиентов и масштабируемость приложений. Как результат — неудовлетворенные клиенты и дорогостоящее изменение стратегии в будущем.

Мультитенатное приложение — это приложение, расположенное в облачной среде и предоставляющее одинаковый набор служб сотням или тысячам клиентов, которые не используют данные совместно и не обращаются к данным друг друга. В качестве примера можно привести приложение SaaS, которое предоставляет службы для клиентов в размещенной в облаке среде.

## <a name="multi-tenant-applications"></a>Мультитенантные приложения
В мультитенантных приложениях данные и рабочую нагрузку можно легко секционировать. Это можно сделать, к примеру, вдоль границ между клиентами, так как большинство запросов выполняются в пределах клиента. Это свойство присуще данным и рабочей нагрузке, а шаблоны приложений, рассматриваемые в этой статье, поддерживают его.

Разработчики используют этот тип приложения по всему спектру облачных приложений, включая следующие:

* приложения партнерской базы данных, перемещаемые в облако в качестве приложений SaaS;
* приложения SaaS, созданные для облака с нуля;
* приложения, напрямую предоставляемые потребителям;
* корпоративные приложения для сотрудников.

Приложения SaaS, предназначенные для облака, и приложения базы данных от партнеров, как правило, представляют собой мультитенантные приложения. Эти приложения SaaS предоставляют клиентам возможности специального программного приложения как услуги. У клиентов есть доступ к службе приложения, и они полностью владеют связанными данными, хранимыми в приложении. Но чтобы воспользоваться преимуществами SaaS, клиенты должны отказаться от определенной части контроля над своими данными. Они передают их доверенному поставщику службы SaaS, который сможет обеспечить защиту этих данных и изолировать их от данных других клиентов. Примерами такого мультитенантного приложения SaaS являются MYOB, SnelStart и Salesforce.com. Каждое из этих приложений можно секционировать вдоль границ между клиентами. Кроме того, они поддерживают шаблоны разработки приложений, рассмотренные в этой статье.

Приложения, предоставляющие службы пользователям или сотрудникам в организации напрямую (их зачастую называют пользователями, а не клиентами), представляют другую категорию в спектре мультитенантных приложений. Клиенты подписываются на службу и не владеют данными, которые собирает и хранит поставщик услуг. К поставщикам услуг применяются менее строгие требования относительно изоляции данных клиентов, помимо принятых государством законов о конфиденциальности. Примерами такого мультитенантного приложения для клиентов выступают поставщики мультимедийного содержимого, например Netflix, Spotify и Xbox LIVE. К другим примерам приложений с простым секционированием можно отнести веб-приложения для клиентов или приложения "Интернета вещей", где каждый клиент или каждое устройство может служить в качестве секции. При этом границы секций могут отделять разных пользователей или устройства.

Не все приложения можно легко секционировать по одному свойству, например клиент, потребитель, пользователь или устройство. В сложном приложении планирования ресурсов, например, содержатся продукты, заказы и клиенты. Как правило, у них сложная схема с тысячами тесно взаимосвязанных таблиц.

Невозможно разработать такую стратегию секционирования, которая охватывала бы все таблицы и задания в рабочей нагрузке приложения. В этой статье рассматриваются мультитенантные приложения, данные и рабочие нагрузки которых легко секционировать.

## <a name="multi-tenant-application-design-trade-offs"></a>Компромиссы при разработке мультитенантного приложения
Выбирая шаблон разработки, разработчику мультитенантного приложения следует учитывать следующие факторы:

* **Изоляция клиентов**. Разработчик должен обеспечить, чтобы ни один клиент не смог получить несанкционированный доступ к данным других клиентов. Это требование изоляции распространяется и на другие свойства, например защиту от "шумных соседей", возможность восстановления данных конкретного клиента и выполнение настройки для определенного клиента.
* **Стоимость облачных ресурсов**. Цена приложения SaaS должна быть оптимальной. Используя облачные ресурсы, разработчик мультитенантного приложения может снизить затраты на ресурсы хранения и вычислительные ресурсы.
* **Простота разработки и выполнения операций**. Разработчику мультитенантного приложения необходимо внедрить защиту путем изоляции, поддерживать и отслеживать работоспособность приложений и схемы базы данных, а также устранять неполадки клиентов. Сложность разработки и выполнения операций приложения создает дополнительные расходы и влечет неудовлетворенность клиентов.
* **Масштабируемость**. Чтобы приложение SaaS успешно работало, оно должно иметь возможность поэтапного добавления дополнительных клиентов, а также дополнительной емкости для клиентов, которым она необходима.

Каждый из этих факторов в сравнении характеризуется определенными компромиссами. Облачное решение с минимальной стоимостью может оказаться не самым удобным в плане разработки. В процессе разработки приложения разработчику очень важно принимать осознанные решения относительно этих аспектов, учитывая их компромиссы.

Популярный шаблон разработки — объединение нескольких клиентов в одной или в нескольких базах данных. Преимуществом этого подхода является более низкая стоимость, так как вы платите за небольшое количество баз данных, и относительная простота работы с ограниченным количеством баз данных. Но со временем разработчик мультитенантного приложения SaaS увидит, что у этого варианта есть существенные недостатки, касающиеся изоляции и масштабируемости клиентов. Когда возникает необходимость в изоляции клиентов, приходится прилагать дополнительные усилия, чтобы защитить данные клиента в общем хранилище от несанкционированного доступа или "шумных соседей". Из-за этих дополнительных усилий процесс разработки может значительно усложниться, а затраты на поддержку изоляции — повыситься. Аналогичным образом, если необходимо добавить клиентов, потребуется определенный опыт, чтобы с помощью этого шаблона разработки перераспределить данные клиента между базами данных для надлежащего масштабирования уровня данных приложения.  

Изоляция клиентов зачастую является фундаментальным требованием в мультитенантных приложениях SaaS, предназначенных для предприятий и организаций. Разработчиков привлекают явные преимущества простоты и стоимости, и они игнорируют изоляцию клиентов и масштабируемость. Из-за такого компромисса в будущем придется приложить дополнительные усилия и потратить дополнительные средства, так как по мере роста службы требования к изоляции клиентов становятся все более важными и должны выполняться на уровне приложения. Тем не менее для мультитенантных приложений, предоставляющих потребительские службы для пользователей напрямую, изоляция клиентов может оказаться не столь приоритетной, как оптимизация стоимости облачных ресурсов.

## <a name="multi-tenant-data-models"></a>Мультитенантные модели данных
Общие рекомендации по разработке для размещения данных клиента можно представить в виде трех отдельных моделей, показанных на рис. 1.

![модели данных мультитенантного приложения](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-multi-tenant-data-models.png)

Рис. 1. Общие рекомендации по разработке для моделей данных мультитенантных приложений

* **База данных для каждого клиента**. У каждого клиента есть своя база данных. Все данные конкретного клиента ограничены его базой данных и изолированы от других клиентов и их данных.
* **Сегментированная общая база данных**. Несколько клиентов совместно используют одну из нескольких баз данных. Каждой базе данных назначается отдельный набор клиентов с использованием стратегии секционирования, например хэш-секционирования, секционирования по диапазонам или по спискам. Эту стратегию распределения данных часто называют сегментированием.
* **Отдельная общая база данных**. Отдельная большая база данных содержит данные для всех клиентов, которые различаются по столбцу идентификатора клиента.

> [!NOTE]
> Разработчик приложения может разместить разные клиенты в разных схемах баз данных, а затем использовать имя схемы для устранения неоднозначностей между разными клиентами. Мы не рекомендуем использовать этот подход, так как он, как правило, требует использования динамического SQL. Кроме того, он не может обеспечить эффективное кэширование плана. В оставшейся части этой статьи для этой категории мультитенантного приложения рассматривается подход, предусматривающий использование общей таблицы.
> 
> 

## <a name="popular-multi-tenant-data-models"></a>Популярные модели данных мультитенантного приложения
Очень важно оценивать различные типы моделей данных мультитенантного приложения с точки зрения компромиссов разработки приложения, которые мы уже обозначили. Эти факторы позволяют охарактеризовать три самые распространенные модели данных мультитенантного приложения, описанные ранее, и соответствующее использование базы данных, как показано на рис. 2.

* **Изоляция**. Уровень изоляции клиентов — это мера, определяющая степень изоляции клиентов, которой можно добиться при использовании модели данных.
* **Стоимость облачных ресурсов**. При оптимизации стоимости облачных ресурсов учитывается объем общих ресурсов для клиентов. Стоимость ресурсов можно определить как стоимость вычислительных ресурсов и ресурсов хранения.
* **Стоимость разработки и выполнения операций**. Простота разработки и развертывания приложений, а также управления ими позволяет уменьшить общую стоимость работы приложения SaaS.  

На рис. 2 на оси Y показан уровень изоляции клиентов. На оси X показан уровень совместного использования ресурсов. Серая диагональная стрелка посередине указывает направление стоимости разработки и операций в сторону увеличения или уменьшения.

![Популярные шаблоны разработки мультитенантного приложения](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-popular-application-patterns.png)

Рис. 2. Популярные мультитенантные модели данных

На рисунке 2 в нижнем правом квадранте представлен шаблон приложения, в котором используется подход с применением потенциально большой отдельной общей базы данных и общей таблицы (или отдельной схемы). Этот вариант подходит для совместного использования ресурсов, так как все клиенты используют одни и те же ресурсы базы данных (ЦП, память, операции ввода-вывода) в одной базе данных. Но изоляция клиентов ограничена. Возможно, потребуется принять дополнительные меры, чтобы защитить клиенты друг от друга на уровне приложения. Из-за этих дополнительных действий может значительно увеличиться стоимость разработки и выполнения операций при разработке приложения и управлении им. Масштабируемость ограничивается масштабом оборудования, используемого для размещения базы данных.

На рис. 2 в нижнем левом квадранте показаны несколько клиентов, сегментированных между несколькими базами данных (как правило, между разными единицами масштабирования оборудования). В каждой базе данных содержится подмножество клиентов. Такой подход решает проблему масштабируемости других шаблонов. Если требуется дополнительная емкость для добавления клиентов, их можно легко разместить в новых базах данных, выделенных новым единицам масштабирования оборудования. Но из-за этого уменьшится объем общих ресурсов. Совместно использовать ресурсы могут только клиенты, размещенные в одной и той же единице масштабирования. При этом подходе уровень изоляции клиентов меняется несущественно, так как множество клиентов по-прежнему находятся в одном размещении и для них не реализована автоматическая защита от взаимного вмешательства. Сложность приложения остается высокой.

Верхний левый квадрант на рис. 2 представляет собой третий подход. При этом данные каждого клиента помещаются в отдельную базу данных. Для такого подхода характерны высокий уровень изоляции клиентов и ограничение объема общих ресурсов, так как в каждой базе данных есть собственные выделенные ресурсы. Этот подход эффективен при наличии у всех клиентов прогнозируемых рабочих нагрузок. Но поставщик не может оптимизировать совместное использование ресурсов, если рабочие нагрузки клиентов становятся менее предсказуемыми. А для приложений SaaS характерна непредсказуемость. Поставщику необходимо выделить избыточное количество ресурсов в соответствии с требованиями или сократить количество ресурсов. В обоих случаях это приведет к увеличению затрат или неудовлетворенности клиентов. Предпочтительно увеличить объем общих ресурсов для клиентов, чтобы еще больше снизить стоимость решения. Увеличение количества баз данных также приводит к увеличению стоимости разработки и выполнения операций при разработке и обслуживании приложений. Несмотря на эти проблемы, этот метод обеспечивает максимальный уровень изоляции с минимальными усилиями для клиентов.

При выборе шаблона разработки также учитываются следующие факторы:

* **Владение данными клиента**. Для приложения, в котором клиенты являются владельцами своих данных, лучше всего подходит шаблон с использованием отдельной базы данных на клиента.
* **Масштабирование**. Для приложения, предназначенного для множества клиентов, лучше всего применить подход с совместным использованием базы данных, например сегментирование. В этом случае по-прежнему остаются жесткие требования к изоляции.
* **Стоимость и бизнес-модель.** Если доход на клиента приложения мал (менее одного доллара), то требования к изоляции отходят на второй план. В этом случае разумно использовать общую базу данных. Если доход для клиента составляет несколько долларов или более, целесообразно использовать базу данных для каждого клиента. Благодаря этому можно снизить затраты на разработку.

Учитывая компромиссы разработки, как показано на рис. 2, идеальная мультитенантная модель должна предусматривать высокий уровень изоляции клиентов и оптимальный уровень совместного использования ресурсов между клиентами. Эта модель подходит для категории, описанной в правом верхнем квадранте на рисунке 2.

## <a name="multi-tenancy-support-in-azure-sql-database"></a>Поддержка мультитенантности в базе данных SQL Azure
База данных SQL Azure поддерживает все шаблоны мультитенантных приложений, указанных на рис. 2. Благодаря пулам эластичных БД она также поддерживает шаблон приложения, который объединяет в себе преимущества изоляции и совместного использования ресурсов, характерных для подхода с использованием одной базы данных для каждого клиента (см. верхний правый квадрант на рисунке 3). С помощью инструментов эластичных баз данных и возможностей в Базе данных SQL можно уменьшить стоимость разработки и эксплуатации приложения с несколькими базами данных (как показано в затененной области на рисунке 3). Эти инструменты позволяют создавать приложения, в которых используется любой из шаблонов с использованием нескольких баз данных, и управлять ими.

![Шаблоны в Базе данных SQL Azure](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-patterns-sqldb.png)

Рис. 3. Шаблоны мультитенантного приложения в базе данных SQL Azure

## <a name="database-per-tenant-model-with-elastic-pools-and-tools"></a>Модель, предусматривающая использование одной базы данных для каждого клиента, с пулами и инструментами эластичных БД
Пулы эластичных БД в Базе данных SQL объединяют преимущества изоляции клиентов и совместного использования ресурсов в базах данных. Таким образом, улучшается поддержка подхода с использованием базы данных для каждого клиента. База данных SQL является решением уровня данных для поставщиков SaaS, которые создают мультитенантные приложения. Задача предоставления клиентам общего доступа к ресурсам перемещается с уровня приложения на уровень службы базы данных. Управление или выполнение запросов в масштабе в нескольких базах данных упрощается благодаря заданиям обработки эластичных БД, эластичным запросам, эластичным транзакциям и клиентской библиотеке эластичной базы данных.

| Требования к приложению | Возможности Базы данных SQL |
| --- | --- |
| Изоляция клиентов и совместное использование ресурсов |[Пулы эластичных БД](sql-database-elastic-pool.md)позволяют выделить пул ресурсов Базы данных SQL и распределить эти ресурсы между разными базами данных. Кроме того, отдельные базы данных могут извлекать из пула ресурсы, необходимые при пиковом потреблении емкости из-за изменений рабочей нагрузки клиентов. При необходимости масштаб пула эластичных БД можно увеличить или уменьшить. Пулы эластичных БД также обеспечивают простоту управления, мониторинга и устранения неполадок на уровне пула. |
| Простота разработки и выполнения операций в базах данных |[Пулы эластичных БД](sql-database-elastic-pool.md) (см. выше). |
| | [Эластичные запросы](sql-database-elastic-query-horizontal-partitioning.md)позволяют выполнять запросы к базам данных для формирования отчетов или выполнения анализа между клиентами. |
| | [Задания обработки эластичных БД](sql-database-elastic-jobs-overview.md)упаковывают и надежно развертывают операции обслуживания или изменения схемы в нескольких базах данных. |
| | [Эластичные транзакции](sql-database-elastic-transactions-overview.md)обрабатывают изменения в нескольких базах данных в атомарном и изолированном режиме. Эластичные транзакции необходимы, если приложение требует абсолютно гарантированного выполнения операций с несколькими базами данных. |
| | [Клиентская библиотека эластичной базы данных](sql-database-elastic-database-client-library.md)обеспечивает управление распределением данных и сопоставляет клиенты с базами данных. |

## <a name="shared-models"></a>Общие модели
Как описано выше, для большинства поставщиков SaaS подходы с использованием общей модели могут создавать проблемы с изоляцией клиентов, а также вызывать трудности при разработке и обслуживании приложений. Но для мультитенантных приложений, предоставляющих службы пользователям напрямую, требования к изоляции клиентов могут быть не такими приоритетными, как оптимизация затрат. В них можно плотно разместить клиенты в одной или нескольких базах данных, чтобы снизить затраты. Модели с общими базами данных, в которых используется одна или несколько сегментированных баз данных, повышают эффективность совместного использования ресурсов и уменьшают совокупную стоимость. База данных SQL Azure предоставляет некоторые возможности, которые позволяют клиентам повысить безопасность и обеспечить управление путем изоляции в масштабе на уровне данных.

| Требования к приложению | Возможности Базы данных SQL |
| --- | --- |
| Возможности обеспечения защиты путем изоляции |[Безопасность на уровне строк](https://msdn.microsoft.com/library/dn765131.aspx) |
| [Схема базы данных](https://msdn.microsoft.com/library/dd207005.aspx) | |
| Простота разработки и выполнения операций в базах данных |[Запросы к эластичным БД](sql-database-elastic-query-horizontal-partitioning.md) |
| | [Задания обработки эластичных БД](sql-database-elastic-jobs-overview.md) |
| | [Эластичные транзакции](sql-database-elastic-transactions-overview.md) |
| | [Клиентская библиотека эластичной базы данных](sql-database-elastic-database-client-library.md) |
| | [Разделение и объединение эластичной базы данных](sql-database-elastic-scale-overview-split-and-merge.md) |

## <a name="summary"></a>Сводка
Требования к изоляции клиентов важны для большинства мультитенантных приложений SaaS. Самый лучший вариант с точки зрения изоляции — это подход с использованием одной базы данных для каждого клиента. Остальные два подхода требуют множества дополнительных действий на уровне приложения. Изоляцию при этом должны обеспечивать опытные разработчики, что заметно повышает затраты и риск. Если требования к изоляции не учитываются на ранней стадии разработки службы, в первых двух моделях со временем это может создать больше затрат. Основные недостатки модели с использованием одной базы данных для каждого клиента связаны с увеличением стоимости облачных ресурсов, вызванным ограниченным совместным использованием, а также обслуживанием множества баз данных и управлением ими. Зачастую разработчикам приложений SaaS очень сложно идти на эти компромиссы.

Хотя эти компромиссы и могут быть главными препятствиями для большинства поставщиков облачных служб баз данных, пул эластичных БД и возможности эластичных баз данных Базы данных Azure SQL позволяют устранить их. Разработчики SaaS могут сочетать характеристики изоляции, которые предлагает модель с использованием одной базы данных для каждого клиента, оптимизировать совместное использование ресурсов и применять улучшенное управление множеством баз данных, используя пулы эластичных БД и связанные инструменты.

Для поставщиков мультитенантных приложений, которые не предъявляют требования к изоляции клиентов и могут плотно разместить клиентов в базе данных, могут быть полезны общие модели данных. Они позволят повысить эффективность совместного использования ресурсов и уменьшить общую стоимость. Используя средства эластичных баз данных, библиотеки сегментирования и функции обеспечения безопасности базы данных SQL Azure, поставщики SaaS могут создавать такие приложения и управлять ими.

## <a name="next-steps"></a>Дальнейшие действия
[Приступите к работе с инструментами эластичных баз данных](sql-database-elastic-scale-get-started.md) с помощью примера приложения, демонстрирующего клиентскую библиотеку.

Создайте [настраиваемую панель мониторинга пула эластичных БД для SaaS](https://github.com/Microsoft/sql-server-samples/tree/master/samples/manage/azure-sql-db-elastic-pools-custom-dashboard) с помощью примера приложения, использующего пулы эластичных БД для экономичного и масштабируемого решения базы данных.

Воспользуйтесь инструментами Базы данных SQL Azure, чтобы [перенести имеющиеся базы данных для масштабирования](sql-database-elastic-convert-to-use-elastic-tools.md).

О том, как создать эластичный пул с помощью портала Azure, можно узнать в разделе [Создание эластичного пула](sql-database-elastic-pool-manage-portal.md).  

Узнайте, как осуществлять [мониторинг пула эластичных БД и управлять им](sql-database-elastic-pool-manage-portal.md).

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Развертывание и изучение мультитенантного приложения SaaS, использующего базу данных SQL Azure](sql-database-saas-tutorial.md)
* [Что такое пул эластичных БД Azure?](sql-database-elastic-pool.md)
* [Общие сведения о возможностях эластичных баз данных](sql-database-elastic-scale-introduction.md)
* [Мультитенантные приложения со средствами эластичных баз данных и безопасностью на уровне строк](sql-database-elastic-tools-multi-tenant-row-level-security.md)
* [Authenticate using Azure AD and OpenID Connect](../guidance/guidance-multitenant-identity-authenticate.md) (Проверка подлинности с помощью Azure AD и OpenID Connect)
* [Сведения о приложении Tailspin Surveys](../guidance/guidance-multitenant-identity-tailspin.md)


## <a name="questions-and-feature-requests"></a>Вопросы и запросы на функции

Вопросы можно задать на [форуме по Базе данных SQL](http://social.msdn.microsoft.com/forums/azure/home?forum=ssdsgetstarted). Запрос на функцию можно добавить на [форуме обратной связи Базы данных SQL](https://feedback.azure.com/forums/217321-sql-database/).


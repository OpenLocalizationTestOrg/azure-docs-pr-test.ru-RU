---
title: "Перемещение данных между масштабируемыми облачными базами данных | Документация Майкрософт"
description: "Объясняет, как управлять сегментами и перемещать данные с помощью размещенной службы с применением интерфейсов API эластичного масштабирования."
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 204fd902-0397-4185-985a-dea3ed7c7d9f
ms.service: sql-database
ms.custom: scale out apps
ms.workload: Inactive
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/24/2016
ms.author: ddove
ms.openlocfilehash: 328989c4fc1f9a404d4c048eb148a95e9105bdf5
ms.sourcegitcommit: dfd49613fce4ce917e844d205c85359ff093bb9c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/31/2017
---
# <a name="moving-data-between-scaled-out-cloud-databases"></a>Перемещение данных между масштабируемыми облачными базами данных
Если вы разрабатываете программное обеспечение как услугу и ваше предложение внезапно становится популярным, к этому росту нужно как-то адаптироваться. В результате добавляются новые базы данных (сегменты). Как перераспределить данные с учетом новых баз данных, не нарушив целостность данных? Для перемещения данных из ограниченных баз данных во вновь созданные используйте **средство разбиения и слияния** .  

Средство разбиения и объединения выполняется как веб-служба Azure. Оно позволяет администратору или разработчику перемещать шардлеты (данные из сегмента) между разными базами данных (сегментами). Средство разбиения и объединения ведет базу метаданных службы, используя управление сопоставлениями сегментов, и обеспечивает согласованность сопоставлений.

![Обзор][1]

## <a name="download"></a>Скачивание
[Microsoft.Azure.SqlDatabase.ElasticScale.Service.SplitMerge](http://www.nuget.org/packages/Microsoft.Azure.SqlDatabase.ElasticScale.Service.SplitMerge/)

## <a name="documentation"></a>Документация
1. [Учебник по инструменту разбиения и объединения эластичной базы данных](sql-database-elastic-scale-configure-deploy-split-and-merge.md)
2. [Настройка безопасности служб разделения и объединения](sql-database-elastic-scale-split-merge-security-configuration.md)
3. [Вопросы безопасности служб разделения и объединения](sql-database-elastic-scale-split-merge-security-configuration.md)
4. [Управление размещением сегментов](sql-database-elastic-scale-shard-map-management.md)
5. [Перенос существующих баз данных для масштабирования](sql-database-elastic-convert-to-use-elastic-tools.md)
6. [Инструменты эластичных баз данных](sql-database-elastic-scale-introduction.md)
7. [Глоссарий по средствам работы с эластичными базами данных](sql-database-elastic-scale-glossary.md)

## <a name="why-use-the-split-merge-tool"></a>Зачем использовать службу разбиения и объединения?
**Гибкость**

Приложениям требуется расширение за пределы отдельной базы данных SQL Azure. Используйте средство для переноса необходимых данных в новые базы данных без потерь.

**Рост путем деления** 

В случае быстрого роста необходимо увеличить общую емкость. Для этого создайте дополнительную емкость путем сегментирования данных и распределения информации по постепенно возрастающему количеству баз данных, пока не будет достигнут нужный объем. Это — отличный пример работы компонента «разделение». 

**Сжатием путем слияния**

Из-за сезонных изменений в характере бизнеса потребности в емкости могут меняться. Это средство позволяет сократить число единиц масштабирования, когда бизнес временно замедляется. Функция объединения в службе разбиения и объединения эластичного масштабирования отвечает данному требованию. 

**Управление хот-спотами путем перемещения шардлетов**

При использовании одной базы данных несколькими клиентами определенное размещение шардлетов по сегментам может привести к падению производительности в некоторых сегментах. В такой ситуации потребуется перераспределить шардлеты или переместить нагруженные шардлеты в новые или менее загруженные сегменты. 

## <a name="concepts--key-features"></a>Концепции и основные функции
**Службы, размещаемые на стороне клиента**

Служба разбиения/объединения реализуется в виде службы, размещаемой на стороне клиента. Необходимо развернуть и разместить службу в вашей подписке Microsoft Azure. Пакет, загружаемый через NuGet, содержит шаблон конфигурации, в который нужно внести информацию о вашем развертывании. Подробнее см. в [руководстве по службе разбиения и слияния](sql-database-elastic-scale-configure-deploy-split-and-merge.md). Так как служба выполняется в подписке Azure, вы можете настроить большинство аспектов безопасности службы и управлять ими. Шаблон по умолчанию включает параметры настройки SSL, проверку подлинности клиента на основе сертификатов, шифрование хранимых учетных записей, защиту от DoS-атак и ограничения IP-адресов. Дополнительные сведения об аспектах безопасности можно получить в документе [Настройка параметров безопасности для службы разбиения и объединения](sql-database-elastic-scale-split-merge-security-configuration.md).

Служба, развернутая в стандартном виде, выполняется с одной рабочей ролью и одной веб-ролью. Каждая использует размер виртуальной машины A1 в облачных службах Azure. Эти параметры нельзя изменить при развертывании пакета, но можно изменить их после успешного развертывания в работающей облачной службе (через портал Azure). Обратите внимание, что рабочая роль по техническим причинам не должна быть настроена для более чем одного экземпляра. 

**Интеграция сопоставлений сегментов**

Служба разбиения и объединения взаимодействует с картой сопоставления сегментов приложения. При использовании службы для разбиения и объединения диапазонов или перемещения данных между сегментами служба автоматически обновляет сопоставления сегментов. Для этого во время обработки запросов служба подключается к базе данных диспетчера сопоставления сегментов приложения и обновляет диапазоны ключей и сопоставления. Это гарантирует, что при выполнении операций разбиения и объединения задействованные сопоставления сегментов всегда будут иметь актуальные данные. Операции разбиения, объединения и перемещения шардлетов осуществляются перемещением пакетов шардлетов из исходного сегмента в целевой сегмент. Во время перемещения шардлета данные обрабатываемого шардлета отмечаются в карте сегментов как автономные и будут недоступны для подключений маршрутизации, управляемой данными, посредством API-интерфейса **OpenConnectionForKey** . 

**Согласованные подключения к шардлетам**

При начале перемещения нового пакета шардлетов любые предоставленные картой сегментов подключения по маршрутизации на основе данных к сегменту, где хранится шардлет, обрываются и последующие подключения от API карты сегментов к этим шардлетам блокируются на время перемещения данных с целью предотвращения несогласованности. Подключения к другим шардлетам в пределах этого сегмента будут также разорваны, но могут быть немедленно восстановлены. После перемещения пакета шардлеты отмечаются как включенные в целевом сегменте, а исходные данные из исходного сегмента удаляются. Служба выполняет эти действия для каждого пакета, пока не будут перемещены все шардлеты. В результате во время выполнения операции разбиения, объединения или перемещения могут быть разорваны несколько подключений.  

**Управление доступностью шардлетов**

Ограничение разрыва подключений рамками обрабатываемого в данный момент пакета шардлетов, как оговорено выше, ограничивает объем недоступных данных одним пакетом шардлетов. Такой подход более предпочтителен, чем если бы во время осуществления операции разбиения/объединения был недоступен весь сегмент. Размер пакета, который определяется количеством уникальных шардлетов для перемещения за момент времени, – это настраиваемый параметр. Его можно задать для каждой операции разбиения и объединения, в зависимости от требований доступности и производительности приложения. Обратите внимание, что сегмент, заблокированный в сопоставлении сегментов, может превышать заданные размеры пакета. Это происходит потому, что служба выбирает размер диапазона таким образом, чтобы фактическое количество значений ключа сегментирования в данных примерно соответствовало размеру пакета. Это важно помнить, в особенности при наличии разреженных ключей сегментирования. 

**Хранилище метаданных**

Служба разбиения и объединения использует базу данных для хранения состояния и журналов во время обработки запроса. Пользователь создает эту базу данных в своей подписке и указывает строку подключения в файле конфигурации для развертывания службы. Администраторы из организации пользователя также могут подключаться к этой базе данных, чтобы просматривать ход выполнения запроса и изучать подробности потенциальных сбоев.

**Сведения о сегментировании**

Служба разбиения и объединения различает сегментированные таблицы (1), ссылочные таблицы (2) и обычные таблицы (3). Семантика операций разбиения, объединения и перемещения зависит от типа таблицы и определяется следующим образом: 

* **Сегментированные таблицы**: операции разбиения, слияния и перемещения переносят шардлеты из исходного сегмента в целевой. После успешного завершения всего запроса эти шардлеты удаляются из исходного сегмента. Обратите внимание, что целевые таблицы должны существовать на целевом сегменте до начала обработки операции и не должны содержать данных в целевом диапазоне. 
* **Ссылочные таблицы**: для ссылочных таблиц операции разбиения, слияния и перемещения копируют данные из исходного сегмента в целевой. Однако, обратите внимание, что в целевом сегменте не происходит изменений, если в заданной таблице уже присутствуют какие-либо строки. Для осуществления операции копирования ссылочной таблицы целевая таблица должна быть пустой.
* **Другие таблицы**: в исходном или целевом сегменте операции разбиения и слияния могут присутствовать другие таблицы. Служба разбиения и объединения не затрагивает эти таблицы при любых операциях перемещения или копирования данных. Учтите, что они могут помешать этим операциям в случае наличия ограничений.

Информация о ссылочных и сегментированных таблицах предоставляется API **SchemaInfo** в карте сегментов. Следующий пример демонстрирует использование этих API для объекта smm диспетчера сопоставления сегментов: 

    // Create the schema annotations 
    SchemaInfo schemaInfo = new SchemaInfo(); 

    // Reference tables 
    schemaInfo.Add(new ReferenceTableInfo("dbo", "region")); 
    schemaInfo.Add(new ReferenceTableInfo("dbo", "nation")); 

    // Sharded tables 
    schemaInfo.Add(new ShardedTableInfo("dbo", "customer", "C_CUSTKEY")); 
    schemaInfo.Add(new ShardedTableInfo("dbo", "orders", "O_CUSTKEY")); 

    // Publish 
    smm.GetSchemaInfoCollection().Add(Configuration.ShardMapName, schemaInfo); 

Таблицы "регион" и "страна" определяются как ссылочные таблицы и будут скопированы с помощью операций разбиения и объединения. "клиент" и "заказы", в свою очередь, определяются как сегментированные таблицы. C_CUSTKEY и O_CUSTKEY служат в качестве ключа сегментирования. 

**Ссылочная целостность**

Служба разбиения и объединения анализирует зависимости между таблицами и использует связи внешнего ключа и первичного ключа для выполнения операций перемещения ссылочных таблиц и шардлетов. В общем случае в первую очередь копируются ссылочные таблицы в порядке зависимости, затем копируются шардлеты в порядке их зависимостей в каждом пакете. Это нужно для того, чтобы учитывать ограничения внешнего ключа-основного ключа целевого сегмента при поступлении новых данных. 

**Согласованность сопоставления сегментов и завершение операций**

Служба разбиения и объединения возобновляет работу после любого сбоя и стремится завершить любые активные запросы. Тем не менее, могут возникнуть неустранимые ситуации, например, когда целевой сегмент утерян или поврежден без возможности восстановления. В таком случае некоторые шардлеты, предназначенные для перемещения, могут сохраниться в исходном сегменте. Служба обеспечивает обновление сопоставления шардлетов только после успешного копирования необходимых данных в целевой сегмент. Шардлеты удаляются только после копирования всех данных в целевой сегмент и успешного обновления соответствующих сопоставлений. Операция удаления осуществляется в фоновом режиме, после того как диапазон данных уже стал доступен на целевом сегменте. Служба разбиения и объединения всегда гарантирует правильность сопоставлений в сопоставлении сегментов.

## <a name="the-split-merge-user-interface"></a>Пользовательский интерфейс службы разбиения и объединения
Пакет службы разбиения и объединения включает рабочую роль и веб-роль. Веб-роль используется для отправки запросов на разбиение и объединение в интерактивном режиме. Существуют следующие основные компоненты пользовательского интерфейса.

* Тип операции. Тип операции — это переключатель, определяющий вид операции, выполняемой службой для данного запроса. Для выбора доступны сценарии разбиения, объединения и перемещения. Кроме того, запрошенную ранее операцию можно отменить. Можно использовать запросы на разбиение или объединение, а также перемещать запросы сопоставлений сегментов по диапазону. Сопоставления сегментов по списку поддерживают только операции перемещения.
* Сопоставление сегментов. Следующий раздел параметров запроса описывает сопоставление сегментов и базу данных, в которой размещается сопоставление сегментов. В частности, необходимо указать имя сервера базы данных SQL Azure и базы данных, в которой размещается карта сегментов, данные для подключения к базе данных c картой сегментов и, наконец, имя карты. В настоящее время операция принимает только один набор учетных данных. Эти учетные данные должны иметь достаточные разрешения для изменения сопоставления сегментов, а также пользовательских данных в этих сегментах.
* Диапазон источника (операции разбиения и объединения). Операции разбиения и объединения обрабатывают диапазон, используя его нижний и верхний ключ. To specify an operation with an unbounded high key value, check the “High key is max” check box and leave the high key field empty. Значения ключей диапазона, заданные вами, могут не полностью совпадать с сопоставляемыми значениями и их границами в сопоставлении сегментов. If you do not specify any range boundaries at all the service will infer the closest range for you automatically. Сценарий PowerShell GetMappings.ps1 можно использовать для получения текущего сопоставления для данного сопоставления сегментов.
* Поведение источника разбиения (разбиение). Для операций разбиения необходимо указать точку для разделения исходного диапазона. Это делается путем ввода ключа сегментирования для того места, в котором необходимо выполнить разбиение. Используйте расположенный рядом переключатель, чтобы указать, следует ли переместить нижнюю часть диапазона (за исключением ключа разбиения), или верхнюю часть диапазона (включая ключ разбиения).
* Исходный шардлет (перемещение). Операции перемещения отличаются от операций разбиения или объединения тем, что для них не требуется указание диапазона в источнике данных. Источник данных для перемещения просто определяется значением ключа сегментирования, который планируется переместить.
* Целевой сегмент (разбиение). После введения информации об исходном сегменте для операции разбиения необходимо указать, куда следует скопировать данные, предоставив серверу базы данных SQL Azure имя базы данных для целевого сегмента.
* Целевой диапазон (объединение). Операции объединения перемещают шардлеты в существующий сегмент. Существующий сегмент указывается путем ввода пределов диапазона сегмента, с которым необходимо выполнить объединение.
* Размер пакета. Размер пакета определяет количество шардлетов, которые будут отключены во время перемещения данных. Это целое число; когда нежелательны продолжительные периоды простоя сегментов, можно использовать маленькие значения. Большие значения увеличат продолжительность отключения шардлетов, но могут повысить производительность.
* Идентификатор операции (отмена). Если идет выполнение операции, в которой больше нет потребности, можно отменить эту операцию, указав в этом поле ее идентификатор. Идентификатор операции можно получить из таблицы состояний запросов (см. раздел 8.1) или из выходных данных в браузере, через который был послан запрос.

## <a name="requirements-and-limitations"></a>Требования и ограничения
Текущая реализация службы разбиения и объединения соответствует следующим требованиям и ограничениям. 

* Сегменты должны существовать и быть зарегистрированы в сопоставлении сегментов до выполнения операций разбиения и объединения над этими сегментами. 
* При исполнении операций служба не создает таблицы или другие объекты базы данных автоматически. Это означает, что схемы для всех сегментированных таблиц и ссылочных таблиц целевого сегмента должны существовать до начала любой операции разбиения, объединения и перемещения. В частности, сегментированные таблицы должны быть пустыми в диапазоне, в который операцией будут добавляться новые данные. В противном случае операция завершится ошибкой при начальной проверке согласованности целевого сегмента. Также обратите внимание на то, что ссылочные данные копируются только в случае, если ссылочная таблица пуста. Не гарантируется согласованность с другими параллельными операциями записи в эти ссылочные таблицы. Рекомендуется не осуществлять другие операции записи для внесения изменений в эти ссылочные таблицы во время выполнения операции разбиения и объединения.
* Служба использует идентификатор строки, который задается уникальным индексом или ключом, включая ключ сегментирования, который повышает надежность больших шардлетов. Это позволяет службе перемещать данные с еще большей степенью детализации, чем просто значение ключа сегментирования. Это позволяет уменьшить максимальный объем пространства журнала и количество требуемых блокировок для проведения операции. Рекомендуется для данной таблицы создать уникальный индекс или первичный ключ, включая ключ сегментирования, если вы хотите использовать эту таблицу вместе с запросами разбиения, объединения и перемещения. Чтобы производительность повысилась, ключ сегментирования должен находиться в первом столбце ключа или индекса.
* Во время обработки запроса некоторые данные шардлета могут одновременно быть и в исходном и в целевом сегменте. Это необходимо для защиты от сбоев при перемещении шардлетов. Интеграция разбиения и слияния с картой сегментов гарантирует, что в подключениях посредством API-интерфейса управляемой данными маршрутизации, в которых используется метод **OpenConnectionForKey** для карты сегментов, не возникнет несогласованных промежуточных состояний. Тем не менее при подключении к исходным или целевым сегментам без использования метода **OpenConnectionForKey** во время обработки запросов разбиения, слияния и перемещения могут наблюдаться несогласованные промежуточные состояния. Эти подключения могут показывать частичные или повторяющиеся результаты в зависимости от времени выполнения или используемых в подключении сегментов. В настоящий момент это ограничение распространяется на подключения, созданные многосегментными запросами эластичного масштабирования.
* База метаданных для службы разбиения и объединения не должна быть общей для различных ролей. Например, роль службы разбиения и объединения во время работы в промежуточном режиме должна ссылаться на базу метаданных, отличную от базы данных рабочей роли.

## <a name="billing"></a>Выставление счетов
Служба разбиения и объединения выполняется как облачная служба в подписке Microsoft Azure. Поэтому плата взимается с вашего экземпляра облачных служб. Если вы нечасто выполняете операции разбиения, объединения и перемещения, рекомендуем удалить облачную службу разбиения и объединения. Это поможет сократить расходы на действующие или развернутые экземпляры облачной службы. Готовую к работе конфигурацию можно повторно развернуть и запустить всякий раз, когда потребуется выполнить операции разбиения и объединения. 

## <a name="monitoring"></a>Мониторинг
### <a name="status-tables"></a>Таблицы состояния
Служба разбиения и слияния предоставляет таблицу **RequestStatus** в базе данных хранилища метаданных для отслеживания завершенных и выполняемых запросов. В таблице перечислены строки для каждого запроса разбиения и объединения в данном экземпляре службы. В ней представлена следующая информация для каждого запроса:

* **Timestamp**— время и дата начала запроса.
* **OperationId**— идентификатор GUID, однозначно определяющий запрос. Этот идентификатор также может использоваться для отмены операции во время ее выполнения.
* **Status**— текущее состояние запроса. Для выполняемых запросов в ней также приведен текущий этап выполнения запроса.
* **CancelRequest** — флаг, указывающий, является ли запрос отмененным.
* **Progress**— процентная оценка хода выполнения операции. Значение 50, указывает, что операция завершена примерно на 50 %.
* **Details**: более подробный отчет о ходе выполнения в формате XML. Отчет о ходе выполнения периодически обновляется по мере копирования наборов строк из исходного в целевой сегмент. В случаях ошибок или исключений в этом столбце также содержится более подробная информация об ошибке.

### <a name="azure-diagnostics"></a>Диагностика Azure
Служба разбиения и объединения для наблюдения и диагностики использует систему диагностики Azure из Azure SDK 2.5. Управление конфигурацией диагностики описано в разделе [Включение диагностики в облачных службах Azure и виртуальных машинах](../cloud-services/cloud-services-dotnet-diagnostics.md). Загружаемый пакет содержит две конфигурации диагностики: для веб-роли и для рабочей роли. Эти конфигурации диагностики для службы соответствуют инструкциям из раздела [Основы облачных служб в Microsoft Azure](https://code.msdn.microsoft.com/windowsazure/Cloud-Service-Fundamentals-4ca72649). В нем описаны журналы счетчиков производительности, журналы IIS, журналы событий Windows и событий приложения разбиения и объединения. 

## <a name="deploy-diagnostics"></a>Развертывание диагностики
Чтобы включить наблюдение и диагностику с помощью конфигурации диагностики для веб- и рабочих ролей, предоставленных пакетом NuGet, выполните следующие команды с помощью Azure PowerShell: 

    $storage_name = "<YourAzureStorageAccount>" 

    $key = "<YourAzureStorageAccountKey" 

    $storageContext = New-AzureStorageContext -StorageAccountName $storage_name -StorageAccountKey $key  


    $config_path = "<YourFilePath>\SplitMergeWebContent.diagnostics.xml" 

    $service_name = "<YourCloudServiceName>" 

    Set-AzureServiceDiagnosticsExtension -StorageContext $storageContext -DiagnosticsConfigurationPath $config_path -ServiceName $service_name -Slot Production -Role "SplitMergeWeb" 


    $config_path = "<YourFilePath>\SplitMergeWorkerContent.diagnostics.xml" 

    $service_name = "<YourCloudServiceName>" 

    Set-AzureServiceDiagnosticsExtension -StorageContext $storageContext -DiagnosticsConfigurationPath $config_path -ServiceName $service_name -Slot Production -Role "SplitMergeWorker" 

Дополнительные сведения о настройке и развертывании параметров диагностики можно найти в разделе [Включение диагностики в облачных службах Azure и виртуальных машинах](../cloud-services/cloud-services-dotnet-diagnostics.md). 

## <a name="retrieve-diagnostics"></a>Получение диагностики
Диагностику можно получить при помощи Visual Studio Server Explorer, смотрите узел Azure в дереве обозревателя сервера. Откройте экземпляр Visual Studio и в строке меню щелкните Вид, затем Обозреватель серверов. Щелкните значок Azure, чтобы подключиться к подписке Azure. Перейдите в Azure -> Хранилище -> <your storage account> -> Таблицы -> WADLogsTable. Дополнительные сведения см. в статье с [обзором ресурсов хранилища с помощью обозревателя сервера](http://msdn.microsoft.com/library/azure/ff683677.aspx). 

![WADLogsTable][2]

Таблица WADLogsTable, выделенная на рисунке выше, содержит подробные события из журнала приложения службы разбиения/объединения. Обратите внимание, что конфигурация по умолчанию, которая предоставляется в составе загружаемого пакета, предназначена для рабочего развертывания. Как следствие, интервал извлечения журналов и счетчиков из экземпляров службы достаточно большой (5 минут). Для тестирования и разработки можно сократить этот интервал, изменив настройки параметров диагностики веб-роли или рабочей роли. Щелкните правой кнопкой мыши роль в Visual Studio Server Explorer (см. выше) и затем измените период передачи в диалоговом окне настройки параметров диагностики: 

![Конфигурация][3]

## <a name="performance"></a>Производительность
Обычно высокая производительность ожидается на высших, более производительных уровнях базы данных SQL Azure. Более высокая скорость ввода-вывода, мощные ЦП и большая память для высших уровней служб предоставляют преимущества при осуществлении операций массового копирования и удаления данных, которые используются внутри службы разбиения и объединения. По этой причине повышать уровень обслуживания нужно только для этих баз данных на ограниченный период времени.

Служба также выполняет запросы проверки в процессе обычной работы. Эти запросы проверяют непредвиденное наличие данных в целевом диапазоне и контролируют запуск любой операции разбиения, объединения и перемещения из согласованного состояния. Все эти запросы работают с ключом сегментирования, который задает область действия операции. С запросом также передается размер пакета. Эти запросы лучше всего выполнять при наличии индекса с ключом сегментирования в первом столбце. 

Кроме того, свойство уникальности при наличии ключа сегментирования в первом столбце позволят службе использовать оптимизированный алгоритм ограничения потребления ресурсов для журналов и памяти. Это свойство уникальности необходимо для перемещения больших объемов данных (обычно свыше 1 ГБ). 

## <a name="how-to-upgrade"></a>Обновление
1. Следуйте инструкциям в разделе [Развертывание службы разбиения и объединения](sql-database-elastic-scale-configure-deploy-split-and-merge.md).
2. Измените файл конфигурации облачной службы для развертывания разбиения и объединения, чтобы были отражены новые параметры конфигурации. Новый обязательный параметр — это сведения о сертификате, используемом для шифрования. Проще всего сделать это, сравнив загруженный новый шаблон конфигурации с существующей конфигурацией. Обязательно добавьте параметры для DataEncryptionPrimaryCertificateThumbprint и DataEncryptionPrimary для веб-роли и рабочей роли.
3. Перед развертыванием обновления в Azure убедитесь, что завершены все текущие операции разбиения и объединения. Это можно сделать, запросив таблицы RequestStatus и PendingWorkflows в базе данных метаданных разбиения и объединения для текущих запросов.
4. Обновите существующее развертывание облачной службы для разбиения и объединения в подписке Azure с новым пакетом и обновленным файлом конфигурации службы.

Вам не требуется предоставлять новую базу метаданных для обновления средства разбиения и объединения. Новая версия метаданных существующей базы данных автоматически обновляется до новой версии. 

## <a name="best-practices--troubleshooting"></a>Рекомендации и устранение неполадок
* Рекомендуется создать клиент для тестов и проверить наиболее важные операции разбиения, объединения и перемещения на нескольких сегментах с использованием этого тестового клиента. Убедитесь, что все метаданные определены корректно в сопоставлении сегментов и что операции не нарушают ограничения и не повреждают внешние ключи.
* Стоит поддерживать размер данных тестового клиента так, чтобы он был больше максимального размера данных вашего крупнейшего клиента. Это позволит избежать проблем, связанных с размером данных. Это позволит оценить верхнюю границу времени перемещения всех данных одного клиента. 
* Убедитесь, что схема допускает удаления. Службе разбиения и объединения требуется возможность удаления данных из исходного сегмента после успешного копирования данных в целевой сегмент. Например, **удаление триггеров** может препятствовать удалению данных службой в источнике данных и привести к сбою операции.
* Ключ сегментирования должен быть первым столбцом первичного ключа или определения уникального индекса. Это обеспечивает наилучшую производительность как для запросов проверки разбиения и объединения, так и для фактических операций перемещения и удаления данных, которые всегда работают с диапазонами ключей сегментирования.
* Разместите свою службу разбиения и объединения в области и центре данных, где располагаются ваши базы данных. 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Anchors-->
<!--Image references-->
[1]:./media/sql-database-elastic-scale-overview-split-and-merge/split-merge-overview.png
[2]:./media/sql-database-elastic-scale-overview-split-and-merge/diagnostics.png
[3]:./media/sql-database-elastic-scale-overview-split-and-merge/diagnostics-config.png


---
title: "aaaData зависимой маршрутизации с базой данных SQL Azure | Документы Microsoft"
description: "Как toouse hello класс ShardMapManager в приложениях .NET для зависящих от данных маршрутизации, функция сегментированных баз данных в базе данных SQL Azure"
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: cad09e15-5561-4448-aa18-b38f54cda004
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/27/2017
ms.author: ddove
ms.openlocfilehash: 34014508ae01905686791fe096bb275cb84f53b4
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="data-dependent-routing"></a><span data-ttu-id="58f84-103">Маршрутизация, зависящая от данных</span><span class="sxs-lookup"><span data-stu-id="58f84-103">Data dependent routing</span></span>
<span data-ttu-id="58f84-104">**Управляемой данными маршрутизацией** hello возможность toouse hello в данных запроса tooroute hello запроса tooan соответствующие базы данных.</span><span class="sxs-lookup"><span data-stu-id="58f84-104">**Data dependent routing** is hello ability toouse hello data in a query tooroute hello request tooan appropriate database.</span></span> <span data-ttu-id="58f84-105">Это основная модель при работе с сегментированными базами данных.</span><span class="sxs-lookup"><span data-stu-id="58f84-105">This is a fundamental pattern when working with sharded databases.</span></span> <span data-ttu-id="58f84-106">контекст запроса Hello также может быть запроса используется tooroute hello, особенно в том случае, если ключ сегментирования hello не является частью запроса hello.</span><span class="sxs-lookup"><span data-stu-id="58f84-106">hello request context may also be used tooroute hello request, especially if hello sharding key is not part of hello query.</span></span> <span data-ttu-id="58f84-107">Каждой определенный запрос или транзакции в приложении с помощью управляемой данными маршрутизацией является ограниченным tooaccessing одной базы данных на один запрос.</span><span class="sxs-lookup"><span data-stu-id="58f84-107">Each specific query or transaction in an application using data dependent routing is restricted tooaccessing a single database per request.</span></span> <span data-ttu-id="58f84-108">Hello инструментов эластичной базы данных SQL Azure, это Маршрутизация осуществляется с помощью hello  **[класса ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx)**  приложений ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="58f84-108">For hello Azure SQL Database Elastic tools, this routing is accomplished with hello **[ShardMapManager class](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx)** in ADO.NET applications.</span></span>

<span data-ttu-id="58f84-109">приложение Hello не требует tootrack различные строки подключения или расположений базы данных, связанных с различные срезы данных в среде сегментированных hello.</span><span class="sxs-lookup"><span data-stu-id="58f84-109">hello application does not need tootrack various connection strings or DB locations associated with different slices of data in hello sharded environment.</span></span> <span data-ttu-id="58f84-110">Вместо этого hello [диспетчера карты сегментов](sql-database-elastic-scale-shard-map-management.md) открывает подключения toohello правильный базы данных при необходимости на основании данных hello в карте сегментов hello и hello значение ключа сегментирования hello, который является целевым объектом hello запроса приложения hello.</span><span class="sxs-lookup"><span data-stu-id="58f84-110">Instead, hello [Shard Map Manager](sql-database-elastic-scale-shard-map-management.md) opens connections toohello correct databases when needed, based on hello data in hello shard map and hello value of hello sharding key that is hello target of hello application’s request.</span></span> <span data-ttu-id="58f84-111">Hello ключ обычно является hello *customer_id*, *tenant_id*, *date_key*, или некоторые определенный идентификатор фундаментальные параметра запроса hello базы данных).</span><span class="sxs-lookup"><span data-stu-id="58f84-111">hello key is typically hello *customer_id*, *tenant_id*, *date_key*, or some other specific identifier that is a fundamental parameter of hello database request).</span></span> 

<span data-ttu-id="58f84-112">Дополнительные сведения см. в статье [Scaling Out SQL Server with Data Dependent Routing](https://technet.microsoft.com/library/cc966448.aspx) (Масштабирование SQL Server с помощью маршрутизации на основе данных).</span><span class="sxs-lookup"><span data-stu-id="58f84-112">For more information, see [Scaling Out SQL Server with Data Dependent Routing](https://technet.microsoft.com/library/cc966448.aspx).</span></span>

## <a name="download-hello-client-library"></a><span data-ttu-id="58f84-113">Загрузка клиентской библиотеки hello</span><span class="sxs-lookup"><span data-stu-id="58f84-113">Download hello client library</span></span>
<span data-ttu-id="58f84-114">Класс tooget hello, установка hello [клиентской библиотеке эластичной базы данных](http://www.nuget.org/packages/Microsoft.Azure.SqlDatabase.ElasticScale.Client/).</span><span class="sxs-lookup"><span data-stu-id="58f84-114">tooget hello class, install hello [Elastic Database Client Library](http://www.nuget.org/packages/Microsoft.Azure.SqlDatabase.ElasticScale.Client/).</span></span> 

## <a name="using-a-shardmapmanager-in-a-data-dependent-routing-application"></a><span data-ttu-id="58f84-115">Использование ShardMapManager при маршрутизации с зависимостью от данных</span><span class="sxs-lookup"><span data-stu-id="58f84-115">Using a ShardMapManager in a data dependent routing application</span></span>
<span data-ttu-id="58f84-116">Приложения следует создать hello **ShardMapManager** во время инициализации, с помощью вызова фабрики hello  **[GetSQLShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanagerfactory.getsqlshardmapmanager.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="58f84-116">Applications should instantiate hello **ShardMapManager** during initialization, using hello factory call **[GetSQLShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanagerfactory.getsqlshardmapmanager.aspx)**.</span></span> <span data-ttu-id="58f84-117">В этом примере инициализируются как диспетчер **ShardMapManager**, так и конкретное сопоставление **ShardMap**, которое он содержит.</span><span class="sxs-lookup"><span data-stu-id="58f84-117">In this example, both a **ShardMapManager** and a specific **ShardMap** that it contains are initialized.</span></span> <span data-ttu-id="58f84-118">В этом примере показано hello GetSqlShardMapManager и [GetRangeShardMap](https://msdn.microsoft.com/library/azure/dn824173.aspx) методы.</span><span class="sxs-lookup"><span data-stu-id="58f84-118">This example shows hello GetSqlShardMapManager and [GetRangeShardMap](https://msdn.microsoft.com/library/azure/dn824173.aspx) methods.</span></span>

    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString, 
                      ShardMapManagerLoadPolicy.Lazy);
    RangeShardMap<int> customerShardMap = smm.GetRangeShardMap<int>("customerMap"); 

### <a name="use-lowest-privilege-credentials-possible-for-getting-hello-shard-map"></a><span data-ttu-id="58f84-119">Использовать наименьшее учетные прав доступа, данные можно для получения карты сегментов hello</span><span class="sxs-lookup"><span data-stu-id="58f84-119">Use lowest privilege credentials possible for getting hello shard map</span></span>
<span data-ttu-id="58f84-120">Если приложение не имеет дело с hello саму карту сегментов, hello учетные данные, используемые в hello фабричный метод должен иметь разрешения только доступна только для чтения на hello **глобальной карты сегментов** базы данных.</span><span class="sxs-lookup"><span data-stu-id="58f84-120">If an application is not manipulating hello shard map itself, hello credentials used in hello factory method should have just read-only permissions on hello **Global Shard Map** database.</span></span> <span data-ttu-id="58f84-121">Обычно эти учетные данные отличаются от диспетчера карты сегментов toohello соединения учетные данные, используемые tooopen.</span><span class="sxs-lookup"><span data-stu-id="58f84-121">These credentials are typically different from credentials used tooopen connections toohello shard map manager.</span></span> <span data-ttu-id="58f84-122">См. также [учетные данные, используемые tooaccess hello эластичной базы данных клиентской библиотеки](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="58f84-122">See also [Credentials used tooaccess hello Elastic Database client library](sql-database-elastic-scale-manage-credentials.md).</span></span> 

## <a name="call-hello-openconnectionforkey-method"></a><span data-ttu-id="58f84-123">Вызовите метод OpenConnectionForKey hello</span><span class="sxs-lookup"><span data-stu-id="58f84-123">Call hello OpenConnectionForKey method</span></span>
<span data-ttu-id="58f84-124">Hello  **[метод ShardMap.OpenConnectionForKey](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmap.openconnectionforkey.aspx)**  возвращает соединение ADO.Net готов для выдачи toohello соответствующей команды базы данных, на основе значения hello hello **ключ**параметра.</span><span class="sxs-lookup"><span data-stu-id="58f84-124">hello **[ShardMap.OpenConnectionForKey method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmap.openconnectionforkey.aspx)** returns an ADO.Net connection ready for issuing commands toohello appropriate database based on hello value of hello **key** parameter.</span></span> <span data-ttu-id="58f84-125">Сегмент информация кэшируется в приложения hello, hello **ShardMapManager**, поэтому эти запросы не включают в себя обычно поиск в базе данных для hello **глобальной карты сегментов** базы данных.</span><span class="sxs-lookup"><span data-stu-id="58f84-125">Shard information is cached in hello application by hello **ShardMapManager**, so these requests do not typically involve a database lookup against hello **Global Shard Map** database.</span></span> 

    // Syntax: 
    public SqlConnection OpenConnectionForKey<TKey>(
        TKey key,
        string connectionString,
        ConnectionOptions options
    )


* <span data-ttu-id="58f84-126">Hello **ключ** параметр используется как ключ поиска в hello сегментов карты toodetermine hello соответствующую базу данных для запроса hello.</span><span class="sxs-lookup"><span data-stu-id="58f84-126">hello **key** parameter is used as a lookup key into hello shard map toodetermine hello appropriate database for hello request.</span></span> 
* <span data-ttu-id="58f84-127">Hello **connectionString** — используется toopass только учетные данные пользователя hello hello требуемого подключения.</span><span class="sxs-lookup"><span data-stu-id="58f84-127">hello **connectionString** is used toopass only hello user credentials for hello desired connection.</span></span> <span data-ttu-id="58f84-128">Нет имя базы данных или имя сервера включены в это *connectionString* , так как метод hello определит hello базы данных и сервера, с помощью hello **ShardMap**.</span><span class="sxs-lookup"><span data-stu-id="58f84-128">No database name or server name are included in this *connectionString* since hello method will determine hello database and server using hello **ShardMap**.</span></span> 
* <span data-ttu-id="58f84-129">Hello  **[connectionOptions](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.connectionoptions.aspx)**  должно быть задано слишком**ConnectionOptions.Validate** Если могут изменяться в среде, где сегмент соответствует и строк может перемещать базы данных в качестве tooother результат операции разбиения или слияния.</span><span class="sxs-lookup"><span data-stu-id="58f84-129">hello **[connectionOptions](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.connectionoptions.aspx)** should be set too**ConnectionOptions.Validate** if an environment where shard maps may change and rows may move tooother databases as a result of split or merge operations.</span></span> <span data-ttu-id="58f84-130">Для этого необходимо сопоставление локальных сегментов toohello кратким запросом на hello целевой базы данных (не карта сегментов глобального toohello) перед подключением hello доставляется toohello приложения.</span><span class="sxs-lookup"><span data-stu-id="58f84-130">This involves a brief query toohello local shard map on hello target database (not toohello global shard map) before hello connection is delivered toohello application.</span></span> 

<span data-ttu-id="58f84-131">В случае hello проверки на соответствие сопоставление локальных сегментов hello (это означает, что кэш hello неправильный), hello диспетчера карты сегментов будет запрашивать hello глобального сегментов карты tooobtain hello новый правильное значение для поиска hello обновить кэш hello и получить и возвращают hello соединение с соответствующей базы данных.</span><span class="sxs-lookup"><span data-stu-id="58f84-131">If hello validation against hello local shard map fails (indicating that hello cache is incorrect), hello Shard Map Manager will query hello global shard map tooobtain hello new correct value for hello lookup, update hello cache, and obtain and return hello appropriate database connection.</span></span> 

<span data-ttu-id="58f84-132">Используйте **ConnectionOptions.None** только в том случае, если внесение изменений в сопоставление сегментов не предполагается, т. е. когда приложение подключено к сети.</span><span class="sxs-lookup"><span data-stu-id="58f84-132">Use **ConnectionOptions.None** only when shard mapping changes are not expected while an application is online.</span></span> <span data-ttu-id="58f84-133">В этом случае значения hello в кэше можно предположить, что tooalways верна и hello лишние приема-передачи вызовов toohello целевой базой данных проверки можно безопасно пропустить.</span><span class="sxs-lookup"><span data-stu-id="58f84-133">In that case, hello cached values can be assumed tooalways be correct, and hello extra round-trip validation call toohello target database can be safely skipped.</span></span> <span data-ttu-id="58f84-134">Это позволяет снизить объем трафика базы данных.</span><span class="sxs-lookup"><span data-stu-id="58f84-134">That reduces database traffic.</span></span> <span data-ttu-id="58f84-135">Hello **connectionOptions** также можно задать через значение в файле конфигурации tooindicate ожидаются изменения сегментирования или не в период времени.</span><span class="sxs-lookup"><span data-stu-id="58f84-135">hello **connectionOptions** may also be set via a value in a configuration file tooindicate whether sharding changes are expected or not during a period of time.</span></span>  

<span data-ttu-id="58f84-136">В этом примере используется значение hello целочисленный ключ **CustomerID**, с использованием **ShardMap** объект с именем **customerShardMap**.</span><span class="sxs-lookup"><span data-stu-id="58f84-136">This example uses hello value of an integer key **CustomerID**, using a **ShardMap** object named **customerShardMap**.</span></span>  

    int customerId = 12345; 
    int newPersonId = 4321; 

    // Connect toohello shard for that customer ID. No need toocall a SqlConnection 
    // constructor followed by hello Open method.
    using (SqlConnection conn = customerShardMap.OpenConnectionForKey(customerId, 
        Configuration.GetCredentialsConnectionString(), ConnectionOptions.Validate)) 
    { 
        // Execute a simple command. 
        SqlCommand cmd = conn.CreateCommand(); 
        cmd.CommandText = @"UPDATE Sales.Customer 
                            SET PersonID = @newPersonID 
                            WHERE CustomerID = @customerID"; 

        cmd.Parameters.AddWithValue("@customerID", customerId); 
        cmd.Parameters.AddWithValue("@newPersonID", newPersonId); 
        cmd.ExecuteNonQuery(); 
    }  

<span data-ttu-id="58f84-137">Hello **OpenConnectionForKey** метод возвращает новую подключения уже открыта toohello правильный базу данных.</span><span class="sxs-lookup"><span data-stu-id="58f84-137">hello **OpenConnectionForKey** method returns a new already-open connection toohello correct database.</span></span> <span data-ttu-id="58f84-138">Подключения, используемые в этом случае, по-прежнему имеют все преимущества объединенных подключений ADO.Net.</span><span class="sxs-lookup"><span data-stu-id="58f84-138">Connections utilized in this way still take full advantage of ADO.Net connection pooling.</span></span> <span data-ttu-id="58f84-139">При условии, что запросы и транзакции могут быть удовлетворены один сегмент одновременно, это должно быть hello только изменения, необходимые в приложении уже с использованием ADO.Net.</span><span class="sxs-lookup"><span data-stu-id="58f84-139">As long as transactions and requests can be satisfied by one shard at a time, this should be hello only modification necessary in an application already using ADO.Net.</span></span> 

<span data-ttu-id="58f84-140">Hello  **[метод OpenConnectionForKeyAsync](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmap.openconnectionforkeyasync.aspx)**  также доступна, если приложение принимает использование асинхронного программирования с помощью ADO.Net.</span><span class="sxs-lookup"><span data-stu-id="58f84-140">hello **[OpenConnectionForKeyAsync method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmap.openconnectionforkeyasync.aspx)** is also available if your application makes use asynchronous programming with ADO.Net.</span></span> <span data-ttu-id="58f84-141">Его поведение не hello данных зависимых маршрутизации эквивалент ADO. NET  **[Connection.OpenAsync](https://msdn.microsoft.com/library/hh223688\(v=vs.110\).aspx)**  метод.</span><span class="sxs-lookup"><span data-stu-id="58f84-141">Its behavior is hello data dependent routing equivalent of ADO.Net's **[Connection.OpenAsync](https://msdn.microsoft.com/library/hh223688\(v=vs.110\).aspx)** method.</span></span>

## <a name="integrating-with-transient-fault-handling"></a><span data-ttu-id="58f84-142">Интеграция с обработкой временных сбоев</span><span class="sxs-lookup"><span data-stu-id="58f84-142">Integrating with transient fault handling</span></span>
<span data-ttu-id="58f84-143">При разработке приложений доступа к данным в облаке hello рекомендуется tooensure временных сбоев и перехватываются приложение hello и hello операций выполняется повторная попытка добавления несколько раз до возникновения ошибки.</span><span class="sxs-lookup"><span data-stu-id="58f84-143">A best practice in developing data access applications in hello cloud is tooensure that transient faults are caught by hello app, and that hello operations are retried several times before throwing an error.</span></span> <span data-ttu-id="58f84-144">Обработка временных сбоев в облачных приложениях рассматривается в статье [4 - Perseverance, Secret of All Triumphs: Using the Transient Fault Handling Application Block](https://msdn.microsoft.com/library/dn440719\(v=pandp.60\).aspx) (4. Настойчивость — секрет всех побед. Использование блока приложения для обработки временных ошибок).</span><span class="sxs-lookup"><span data-stu-id="58f84-144">Transient fault handling for cloud applications is discussed at [Transient Fault Handling](https://msdn.microsoft.com/library/dn440719\(v=pandp.60\).aspx).</span></span> 

<span data-ttu-id="58f84-145">Обработки временных сбоев может сосуществовать с управляемой данными маршрутизацией шаблон Здравствуй естественным образом.</span><span class="sxs-lookup"><span data-stu-id="58f84-145">Transient fault handling can coexist naturally with hello Data Dependent Routing pattern.</span></span> <span data-ttu-id="58f84-146">Hello основным требованием является tooretry данных целиком hello доступ запроса, включая hello **с помощью** блок, который получен подключения маршрутизации в зависимости от данных hello.</span><span class="sxs-lookup"><span data-stu-id="58f84-146">hello key requirement is tooretry hello entire data access request including hello **using** block that obtained hello data-dependent routing connection.</span></span> <span data-ttu-id="58f84-147">Hello примера можно переписать следующим образом (Обратите внимание, выделенная изменений).</span><span class="sxs-lookup"><span data-stu-id="58f84-147">hello example above could be rewritten as follows (note highlighted change).</span></span> 

### <a name="example---data-dependent-routing-with-transient-fault-handling"></a><span data-ttu-id="58f84-148">Пример. Маршрутизация, зависящая от данных, с обработкой временных сбоев</span><span class="sxs-lookup"><span data-stu-id="58f84-148">Example - data dependent routing with transient fault handling</span></span>
<pre><code>int customerId = 12345; 
int newPersonId = 4321; 

<span style="background-color:  #FFFF00">Configuration.SqlRetryPolicy.ExecuteAction(() =&gt; </span> 
<span style="background-color:  #FFFF00">    { </span>
        // Connect toohello shard for a customer ID. 
        using (SqlConnection conn = customerShardMap.OpenConnectionForKey(customerId,  
        Configuration.GetCredentialsConnectionString(), ConnectionOptions.Validate)) 
        { 
            // Execute a simple command 
            SqlCommand cmd = conn.CreateCommand(); 

            cmd.CommandText = @&quot;UPDATE Sales.Customer 
                            SET PersonID = @newPersonID 
                            WHERE CustomerID = @customerID&quot;; 

            cmd.Parameters.AddWithValue(&quot;@customerID&quot;, customerId); 
            cmd.Parameters.AddWithValue(&quot;@newPersonID&quot;, newPersonId); 
            cmd.ExecuteNonQuery(); 

            Console.WriteLine(&quot;Update completed&quot;); 
        } 
<span style="background-color:  #FFFF00">    }); </span> 
</code></pre>


<span data-ttu-id="58f84-149">Автоматически загружать пакеты, необходимые tooimplement обработки временных сбоев при построении образца приложения hello эластичной базы данных.</span><span class="sxs-lookup"><span data-stu-id="58f84-149">Packages necessary tooimplement transient fault handling are downloaded automatically when you build hello elastic database sample application.</span></span> <span data-ttu-id="58f84-150">Пакеты также доступны по отдельности в библиотеке [Enterprise Library — блок приложений для обработки временных сбоев](http://www.nuget.org/packages/EnterpriseLibrary.TransientFaultHandling/).</span><span class="sxs-lookup"><span data-stu-id="58f84-150">Packages are also available separately at [Enterprise Library - Transient Fault Handling Application Block](http://www.nuget.org/packages/EnterpriseLibrary.TransientFaultHandling/).</span></span> <span data-ttu-id="58f84-151">Используйте версию 6.0 или более позднюю.</span><span class="sxs-lookup"><span data-stu-id="58f84-151">Use version 6.0 or later.</span></span> 

## <a name="transactional-consistency"></a><span data-ttu-id="58f84-152">Согласованность транзакций</span><span class="sxs-lookup"><span data-stu-id="58f84-152">Transactional consistency</span></span>
<span data-ttu-id="58f84-153">Свойства транзакций гарантируется для всех сегментов локальной tooa операций.</span><span class="sxs-lookup"><span data-stu-id="58f84-153">Transactional properties are guaranteed for all operations local tooa shard.</span></span> <span data-ttu-id="58f84-154">Например транзакций, переданных через маршрутизации в зависимости от данных выполняются в области hello hello целевой сегментов для подключения hello.</span><span class="sxs-lookup"><span data-stu-id="58f84-154">For example, transactions submitted through data-dependent routing execute within hello scope of hello target shard for hello connection.</span></span> <span data-ttu-id="58f84-155">В данный момент нет возможности связывания нескольких подключений с транзакцией, поэтому невозможно гарантировать осуществление транзакций для операций, выполняемых через сегменты.</span><span class="sxs-lookup"><span data-stu-id="58f84-155">At this time, there are no capabilities provided for enlisting multiple connections into a transaction, and therefore there are no transactional guarantees for operations performed across shards.</span></span>

## <a name="next-steps"></a><span data-ttu-id="58f84-156">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="58f84-156">Next steps</span></span>
<span data-ttu-id="58f84-157">toodetach сегментом или tooreattach сегментов, см. в разделе [с помощью карты проблем сегментов toofix hello RecoveryManager классов](sql-database-elastic-database-recovery-manager.md)</span><span class="sxs-lookup"><span data-stu-id="58f84-157">toodetach a shard, or tooreattach a shard, see [Using hello RecoveryManager class toofix shard map problems](sql-database-elastic-database-recovery-manager.md)</span></span>

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]


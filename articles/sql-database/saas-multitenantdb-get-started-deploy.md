---
title: "Развертывание SaaS-приложения с сегментированной мультитенантной БД, использующего базу данных SQL Azure | Документация Майкрософт"
description: "Разверните и изучите SaaS-приложение Wingtip Tickets с сегментированной мультитенантной БД, которое демонстрирует шаблоны SaaS с помощью базы данных SQL Azure."
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: MightyPen
manager: craigg
editor: billgib;anjangsh
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/18/2017
ms.author: genemi
ms.openlocfilehash: a7e6e319fb2fa8fee762055b625427403d14d679
ms.sourcegitcommit: b7adce69c06b6e70493d13bc02bd31e06f291a91
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/19/2017
---
# <a name="deploy-and-explore-a-sharded-multi-tenant-application-that-uses-azure-sql-database"></a>Развертывание и изучение сегментированного мультитенантного приложения, использующего базу данных SQL Azure

В этом руководстве вы развернете и проанализируете пример SaaS-приложения с мультитенантной БД, которое называется Wingtip Tickets. Приложение Wingtip Tickets предназначено для демонстрации возможностей базы данных SQL Azure, которые упрощают реализацию сценариев SaaS.

Эта реализация Wingtips использует шаблон сегментированной мультитенатной базы данных. Сегментирование выполняется по идентификатору клиента. Распределения данных клиента в определенную базу данных в соответствии со значениями идентификатора клиента. Независимо от того, сколько клиентов содержит какая-либо база данных, все базы данных являются мультитенатными в том смысле, что схемы таблиц включают идентификатор клиента. 

Этот шаблон базы данных позволяет хранить один или несколько клиентов в каждом сегменте или базе данных. Вы можете оптимизировать затраты за счет того, что каждая база данных сегментируется несколькими клиентами. Или можно выполнить оптимизацию для изоляции, задав для каждого хранилища базы данных только один клиент. Можно выбрать разные варианты оптимизации отдельно для каждого клиента. Можно сделать этот выбор при первом сохранении клиента или изменить его позже. Приложение поддерживает любой из этих вариантов.

#### <a name="app-deploys-quickly"></a>Быстрое развертывание приложения

В следующем разделе развертывания предоставляет синий **развертыванию в Azure** кнопки. Если ее нажать, приложение Wingtip будет полностью развернуто через пять минут. Приложение Wingtip выполняется в облаке Azure и использует базу данных SQL Azure. Wingtip развертывается в подписку Azure. Вы получите полный доступ для работы с отдельными компонентами приложения.

Приложение развертывается с данными для трех примеров клиентов. Клиенты будут храниться вместе в одной мультитенантной базе данных.

Любой пользователь, можно загрузить исходный код C# и PowerShell для билетов Wingtip из [своего репозитория GitHub][link-github-wingtip-multitenantdb-55g].

#### <a name="learn-in-this-tutorial"></a>В этом руководстве рассматривается:

> [!div class="checklist"]
> - как развернуть приложение SaaS Wingtip;
> - где можно получить исходный код приложения и скрипты управления;
> - сведения о серверах и базах данных, формирующих приложение;
> - как сопоставить клиентов с данными с помощью *каталога*;
> - как подготовить новый клиент;
> - как выполнить мониторинг активности клиента в приложении.

Доступна серия связанных руководств, в основе которых лежит это первоначальное развертывание. В них рассматривается ряд шаблонов проектирования и управления SaaS. При работе с руководствами рекомендуется пошагово выполнять указанные выше скрипты, чтобы увидеть, как реализованы различные шаблоны SaaS.

## <a name="prerequisites"></a>Технические условия

Для работы с этим руководством выполните следующие предварительные требования:

- Установите последнюю версию Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell][link-azure-get-started-powershell-41q].

## <a name="deploy-the-wingtip-tickets-app"></a>Развертывание приложения Wingtip Tickets

#### <a name="plan-the-names"></a>Планирование имена

В шагах в этом разделе, есть два места, где необходимо ввести имена для вас в качестве *пользователя* и для нового *группы ресурсов*. Для пользователя с именем *Finley Анна*, мы советуем использовать следующие имена:
- *Пользователь:* &nbsp; **af1** &nbsp; *(ее инициалы, а также цифры.)*
- *Группа ресурсов:* &nbsp; **wingtip af1** &nbsp; *(рекомендуется прописными буквами. Добавление дефис, а затем имя пользователя.)*

Теперь выберите имена и записывать их.

#### <a name="steps"></a>Действия

1. Нажмите синюю следующие **развертыванию в Azure** кнопки.
    - Откроется портал Azure с шаблоном развертывания SaaS-приложения Wingtip Tickets.

    [![Кнопка для развертывания в Azure.][image-deploy-to-azure-blue-48d]][link-aka-ms-deploywtp-mtapp-52k]

2. Введите значения параметров, необходимых для развертывания.

    > [!IMPORTANT]
    > Для этого примера следует использовать все существующие группы ресурсов, серверам или пулов. Вместо этого выберите **создать новую группу ресурсов**. Поработав с приложением, удалите эту группу ресурсов, чтобы завершить связанное выставление счетов.
    > Не используйте это приложение или ресурсы, которые оно создает, для рабочей среды. Некоторые аспекты проверки подлинности и параметры брандмауэра сервера, намеренно небезопасен в приложении для упрощения демонстрации.

    - Для параметра **Группа ресурсов** выберите действие **Создать** и предоставьте **имя** новой группы ресурсов (с учетом регистра).
        - **Расположение** — выберите расположение из раскрывающегося списка.
    - Для **пользователя** -рекомендуется выбрать короткие **пользователя** значение.

3. **Разверните приложение.**

    - Установите флажок, чтобы принять условия.
    - Щелкните **Приобрести**.

4. Отслеживайте состояние развертывания. Для этого щелкните **Уведомления** (значок колокольчика справа от поля поиска). Развертывание приложения Wingtip занимает примерно пять минут.

   ![Развертывание выполнено](media/saas-multitenantdb-get-started-deploy/succeeded.png)

## <a name="download-and-unblock-the-management-scripts"></a>Скачивание и разблокирование скриптов управления

Пока выполняется развертывание приложения, скачайте исходный код приложения и скрипты управления.

> [!NOTE]
> ZIP-файлов загруженных из внешнего источника и извлечь содержимое исполняемый файл (сценарии, библиотеки DLL) могут быть заблокированы Windows. Перед извлечением скриптов из ZIP-файла выполните указанные ниже действия, чтобы разблокировать ZIP-файл. Разблокировать ZIP-файл, вы убедитесь, что разрешено запускать скрипты.

1. Перейдите к [репозиторию GitHub WingtipTicketsSaaS-MultiTenantDb](https://github.com/Microsoft/WingtipTicketsSaaS-MultiTenantDb).
2. Выберите **Clone or download** (Клонировать или скачать).
3. Выберите **Download ZIP** (Загрузить ZIP) и сохраните файл.
4. Щелкните правой кнопкой мыши файл **WingtipTicketsSaaS-MultiTenantDb-master.zip** и выберите **Свойства**.
5. На вкладке **Общие** выберите **Разблокировать** и **Применить**.
6. Последовательно выберите **ОК**.
7. Извлеките файлы.

Скрипты находятся в папке *..\\WingtipTicketsSaaS-MultiTenantDb-master\\Learning Modules\\*.

## <a name="update-the-configuration-file-for-this-deployment"></a>Обновление файла конфигурации для развертывания

Перед запуском каких-либо скриптов настройте значения *группы ресурсов* и *пользователя* в файле **UserConfig.psm1**. Задайте для этих переменных те же значения, которые были указаны во время развертывания.

1. Открыть... \\Модулях обучения\\*UserConfig.psm1* в *интегрированной среды Сценариев PowerShell*.
2. В полях *ResourceGroupName* и *Name* введите специфические для развертывания значения (только в строках 10 и 11).
3. Сохраните изменения.

Значения, заданные в этом файле используются с помощью сценариев, поэтому очень важно, что они являются точными. При повторном развертывании приложения, необходимо выбрать разные значения для пользователей и групп ресурсов. Затем обновите файл UserConfig.psm1 попытку с новыми значениями.

## <a name="run-the-application"></a>Выполнение приложения

В приложении Wingtip клиенты являются местоположения. Место проведения может быть совместно hall, сообщество спортивных или любое другое местоположение, на котором размещена события. Зарегистрировать местоположения в Wingtip как клиентов, а идентификатор клиента создается для каждого место проведения. Помещение каждой выводит список его предстоящих событий в Wingtip, чтобы открытый можно купить билеты на события.

Помещение каждой Возвращает настраиваемый веб-приложения и в списке событий продажу билетов. Каждый веб-приложения является независимым и изолирован от других клиентов. Внутренне в базы данных SQL Azure, каждый из данных для каждого клиента, в котором хранятся сегментированной базы данных нескольких клиентов, по умолчанию. Все данные отмечаются тегами с идентификатором клиента.

Центральный **концентратора событий** веб-страница содержит список ссылок для клиентов в конкретного развертывания. Выполните следующие действия, чтобы в полной мере **концентратора событий** веб-страницы и отдельных веб-приложение:

1. Откройте **концентратор событий** в браузере:
    - http://Events.Wingtip. &lt;Пользователя&gt;. trafficmanager.net &nbsp; *(Замените &lt;пользователя&gt; со значением пользователя развертывания.)*

    ![Концентратор событий](media/saas-multitenantdb-get-started-deploy/events-hub.png)

2. Щелкните **Fabrikam Jazz Club** в **концентраторе событий**.

   ![События](./media/saas-multitenantdb-get-started-deploy/fabrikam.png)

#### <a name="azure-traffic-manager"></a>Azure Traffic Manager

Для управления распределением входящих запросов, Wingtip приложение использует [диспетчера трафика Azure](../traffic-manager/traffic-manager-overview.md). Имя клиента включает страницы событий для каждого клиента в его URL-адрес. Каждый URL-адрес также включает значение конкретного пользователя. Каждый URL-адрес подчиняется показано формат, выполнив следующие действия:

- http://events.wingtip.&lt;ПОЛЬЗОВАТЕЛЬ&gt;.trafficmanager.net/*fabrikamjazzclub*

1. События приложения выполняет синтаксический анализ имени клиента в URL-адресе. Имя клиента — *fabrikamjazzclub* в предыдущем примере URL-адрес.
2. Приложение затем хэширует имя клиента, чтобы создать ключ для доступа к каталогу с помощью [управления карты сегментов](sql-database-elastic-scale-shard-map-management.md).
3. Приложение ключ находится в каталоге и получает соответствующие расположения базы данных клиента.
4. Приложение использует данные расположения для поиска и получить доступ к одной базы данных, который содержит все данные клиента.

#### <a name="events-hub"></a>Концентратор событий

1. **Концентратора событий** список всех клиентов, которые зарегистрированы в каталоге и их местоположения.
2. **Концентратор событий** использует расширенные метаданные в каталоге, чтобы получить имя клиента, связанное с каждым сопоставлением, для создания URL-адресов.

В рабочей среде обычно создать запись CNAME DNS для [направление домена Интернета компании](../traffic-manager/traffic-manager-point-internet-domain.md) в профиле диспетчера трафика.

## <a name="start-generating-load-on-the-tenant-databases"></a>Запуск создания нагрузки в базах данных клиента

Теперь после развертывания приложение готово к работе. Скрипт *Demo-LoadGenerator* PowerShell запускает рабочую нагрузку, выполняющуюся во всех клиентах. Реальная нагрузка в приложении SaaS обычно случайна и непредсказуема. Для моделирования этого типа нагрузки генератор создает нагрузку, распределенную по всем клиентам. В нагрузку включены случайные пиковые нагрузки в каждом клиенте, происходящие со случайными интервалами. Шаблон нагрузки появляется в течение нескольких минут, поэтому перед мониторингом нагрузки генератор должен работать по крайней мере три или четыре минуты.

1. В *интегрированной среде сценариев PowerShell* откройте скрипт ...\\Learning Modules\\Utilities\\*Demo-LoadGenerator.ps1*.
2. Нажмите клавишу **F5**, чтобы запустить скрипт и генератор нагрузки (оставьте значения параметра по умолчанию).

Скрипт *Demo-LoadGenerator.ps1* отрывает другой сеанс PowerShell, где выполняется генератор нагрузки. Он выполняется в сеансе в качестве задачи переднего плана, которая вызывает фоновые задания создания нагрузки для каждого клиента.

После запуска задачи переднего плана она остается в состоянии вызова задания. Задача запускает дополнительные фоновые задания для любых новых клиентов, которые затем подготавливаются.

Закрытие сеанса PowerShell останавливает все задания.

Может потребоваться перезапустить сеанс генератора нагрузки для использования других значений параметров. Если да, закройте сеанс PowerShell для создания нагрузки и повторно запустите *Demo-LoadGenerator.ps1*.

## <a name="provision-a-new-tenant-into-the-sharded-database"></a>Подготовка нового клиента в сегментированной базе данных

Первоначальное развертывание включает в себя три примера клиентов в базе данных *Tenants1*. Давайте создать другого клиента и просмотрите его влияние на развернутого приложения. На этом шаге нажмите один ключ используется для создания нового клиента:

1. Открыть... \\Модулях обучения\\подготовки и каталога\\*Демонстрация ProvisionTenants.ps1* в *интегрированной среды Сценариев PowerShell*.
2. Нажмите клавишу **F5** (не **F8**) для запуска сценария (оставьте значения по умолчанию сейчас).

   > [!NOTE]
   > Необходимо выполнить скрипты PowerShell только нажатием **F5** ключа, не нажав **F8** для запуска выбранной части скрипта. Проблема с **F8** является то, что *$PSScriptRoot* переменной не вычисляется. Эта переменная Затребован много сценариев для перехода из папок, или вызывать другие сценарии или для импорта модулей.

Новый клиент Red Maple Racing добавлен в базу данных *Tenants1* и зарегистрирован в каталоге. В вашем браузере откроется новый сайт продажи билетов **Events** клиента:

![Новый клиент](./media/saas-multitenantdb-get-started-deploy/red-maple-racing.png)

Обновить **концентратора событий**, и в списке появится новый клиент.

## <a name="provision-a-new-tenant-in-its-own-database"></a>подготовка нового клиента в собственной базе данных.

Сегментированных мультитенантной модели позволяет выбрать, следует ли подготовить новый клиент в базу данных, содержащий других клиентов или в базу данных свои собственные. Клиент, изолированных в собственную базу данных имеет следующие преимущества:
- Производительность базы данных клиента можно управлять без необходимости злоумышленнику вместе с другими клиентами.
- При необходимости базы данных могут восстанавливаться на более ранний момент времени, так как другие клиенты не затрагиваются.

Вы можете поместить бесплатной пробной версии клиентов или заказчиков экономика базам данных нескольких клиентов. Каждый клиент premium может быть помещена в собственную выделенную базу данных. При создании большого количества баз данных, содержащих только один клиент, можно управлять их все вместе в пуле эластичных оптимизировать затраты ресурсов.

Далее мы Подготовьте другого клиента, это время, в свою собственную базу данных:

1. В... \\Модулей обучения\\подготовки и каталога\\*Демонстрация ProvisionTenants.ps1*, изменить *$TenantName* для **Salix Salsa**, *$VenueType* для **танца** и *$Scenario* для **2**.

2. Нажмите клавишу **F5** для повторного запуска скрипта.
    - Это **F5** клавишу подготавливает новый клиент в отдельной базе данных. Базы данных и клиент регистрируются в каталоге. Затем браузер открывает страницу мероприятий клиента.

   ![Страница мероприятий Salix Salsa](./media/saas-multitenantdb-get-started-deploy/salix-salsa.png)

   - Прокрутите до нижней части страницы. В баннере отображается имя базы данных, в которой хранятся данные клиента.

3. Обновить **концентратора событий** и два новых клиентов появится в списке.

## <a name="explore-the-servers-and-tenant-databases"></a>Изучение серверов и клиентских баз данных

Теперь рассмотрим подробнее некоторые из развернутых ресурсов:

1. На [портале Azure](http://portal.azure.com) перейдите к списку групп ресурсов. Откройте группу ресурсов, которая была создана при развертывании приложения.

   ![resource group](./media/saas-multitenantdb-get-started-deploy/resource-group.png)

2. Щелкните сервер **catalog-mt&lt;ПОЛЬЗОВАТЕЛЬ&gt;**. На сервере каталога содержится две базы данных с именем *tenantcatalog* и *basetenantdb*. База данных *basetenantdb* — это пустой шаблон базы данных. Он копируется для создания клиентской базы данных, используемой для нескольких клиентов или только для одного.

   ![сервер каталога](./media/saas-multitenantdb-get-started-deploy/catalog-server.png)

3. Вернитесь в группу ресурсов и выберите сервер *tenants1-mt*, который содержит клиентские базы данных.
    - База данных tenants1 — это мультитенантная база данных, в которой хранятся три исходных клиента, а также первый добавленный вами клиент. Она настроена как стандартная база данных с 50 DTU.
    - База данных **salixsalsa** содержит место проведения Salix Salsa в качестве единственного клиента. Она настроена в качестве стандартной базы данных с 50 DTU по умолчанию.

   ![Сервер клиентов](./media/saas-multitenantdb-get-started-deploy/tenants-server.png)


## <a name="monitor-the-performance-of-the-database"></a>Мониторинг производительности базы данных

Если генератор нагрузки выполнения в течение нескольких минут, достаточно данных телеметрии доступен для поиска в базе данных наблюдения за средств, встроенных в портале Azure.

1. Перейдите на сервер **tenants1-mt&lt;ПОЛЬЗОВАТЕЛЬ&gt;** и щелкните **tenants1**, чтобы просмотреть сведения об использовании ресурсов базы данных, в которой есть четыре клиента. Каждый арендатор подвергается случайной высокой нагрузке от генератора нагрузки:

   ![Мониторинг tenants1](./media/saas-multitenantdb-get-started-deploy/monitor-tenants1.png)

   Диаграмма использования DTU хорошо демонстрирует, как мультитенантная база данных может поддерживать непредсказуемую рабочую нагрузку во многих клиентах. В этом случае генератор нагрузки применяет случайные нагрузки примерно по 30 DTU для каждого клиента. Эта нагрузка равнозначна использованию базы данных с 50 DTU на 60 %. Пики, которые превышают 60 %, являются результатом нагрузки, применяемой к более чем одному клиенту одновременно.

2. Перейдите к **tenants1 mt&lt;пользователя&gt;**  сервера и нажмите кнопку **salixsalsa** базы данных. Использование ресурсов можно увидеть в этой базе данных, который содержит только один клиент.

   ![База данных salixsalsa](./media/saas-multitenantdb-get-started-deploy/monitor-salix.png)

Генератор нагрузки применяет аналогичную нагрузку для всех клиентов, независимо от того, в какой базе данных находится каждый клиент. База данных **salixsalsa** с одним клиентом может выдержать гораздо большую нагрузку, чем база данных с несколькими клиентами. 

#### <a name="resource-allocations-vary-by-workload"></a>Выделение ресурсов различаются в зависимости от рабочей нагрузки

Иногда базы данных несколькими клиентами требуется больший объем ресурсов для оптимальной производительности, чем базы данных одного клиента, но не всегда. Оптимальное распределение ресурсов зависит от характеристик конкретной рабочей нагрузки для клиентов в системе.

Рабочие нагрузки, созданные сценарием генератор нагрузки — только для иллюстрации.

## <a name="additional-resources"></a>Дополнительные ресурсы

- Дополнительные сведения о конструктивных шаблонах для мультитенантных приложений SaaS и базы данных SQL Azure см. в [этой статье](saas-tenancy-app-design-patterns.md).

- Дополнительные сведения о пулах эластичных БД см. в разделе:
    - [Эластичных пулов помогают управлять и масштабировать несколько баз данных Azure SQL](sql-database-elastic-pool.md)
    - [Общие сведения о возможностях эластичных баз данных](sql-database-elastic-scale-introduction.md)

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали следующее:

> [!div class="checklist"]
> - Способ развертывания приложения Wingtip билеты SaaS несколькими клиентами, базы данных.
> - О серверах и баз данных, составляющих приложение.
> - Клиенты, сопоставляются с свои данные с *каталога*.
> - как подготавливать новые клиенты в мультитенатной базе данных и базе данных с одним клиентом.
> - Как просмотреть использование пула для мониторинга активности клиента.
> - как удалить примеры ресурсов, чтобы не оплачивать их.

А теперь рекомендуем ознакомиться со статьей [Provision new tenants and register them in the catalog](sql-database-saas-tutorial-provision-and-catalog.md) (Подготовка новых клиентов и их регистрация в каталоге).


<!--  Link references.

A [series of related tutorials] is available that build upon this initial deployment.
[link-wtp-overivew-jumpto-saas-tutorials-97j]: saas-multitenantdb-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials

-->

[link-aka-ms-deploywtp-mtapp-52k]: http://aka.ms/deploywtp-mtapp


[link-azure-get-started-powershell-41q]: https://docs.microsoft.com/powershell/azure/get-started-azureps

[link-github-wingtip-multitenantdb-55g]: https://github.com/Microsoft/WingtipTicketsSaaS-MultiTenantDB/



<!--  Image references.

[image-deploy-to-azure-blue-48d]: http://aka.ms/deploywtp-mtapp "Button for Deploy to Azure."
-->

[image-deploy-to-azure-blue-48d]: media/saas-multitenantdb-get-started-deploy/deploy.png "Кнопка развертывания в Azure."


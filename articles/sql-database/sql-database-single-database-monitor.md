---
title: "Мониторинг производительности базы данных в базе данных SQL Azure | Документация Майкрософт"
description: "Узнайте о возможностях мониторинга своей базы данных с помощью средств Azure и динамических административных представлений."
keywords: "мониторинг базы данных, производительность облачной базы данных"
services: sql-database
documentationcenter: 
author: CarlRabeler
manager: jhubbard
editor: 
ms.assetid: a2e47475-c955-4a8d-a65c-cbef9a6d9b9f
ms.service: sql-database
ms.custom: monitor & tune
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: data-management
ms.date: 01/10/2017
ms.author: carlrab
ms.openlocfilehash: e11ed3275413b428523eef78a5a89b537f6a4afc
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="monitoring-database-performance-in-azure-sql-database"></a><span data-ttu-id="e2f5d-104">Мониторинг производительности базы данных в базе данных SQL Azure</span><span class="sxs-lookup"><span data-stu-id="e2f5d-104">Monitoring database performance in Azure SQL Database</span></span>
<span data-ttu-id="e2f5d-105">Мониторинг производительности базы данных SQL в Azure начинается с мониторинга использования ресурсов в соответствии с выбранным уровнем производительности базы данных.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-105">Monitoring the performance of a SQL database in Azure starts with monitoring the resource utilization relative to the level of database performance you choose.</span></span> <span data-ttu-id="e2f5d-106">С помощью мониторинга можно определить, является ли емкость базы данных избыточной или же проблема возникает из-за того, что ресурсы используются на пределе возможностей. Затем при необходимости можно изменить уровень производительности и [уровень службы](sql-database-service-tiers.md) такой базы данных.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-106">Monitoring helps you  determine whether your database has excess capacity or is having trouble because resources are maxed out, and then decide whether it's time to adjust the performance level and [service tier](sql-database-service-tiers.md) of your database.</span></span> <span data-ttu-id="e2f5d-107">Вы можете выполнять мониторинг базы данных с помощью графических средств на [портале Azure](https://portal.azure.com) или с использованием [динамических административных представлений](https://msdn.microsoft.com/library/ms188754.aspx).</span><span class="sxs-lookup"><span data-stu-id="e2f5d-107">You can monitor your database using graphical tools in the [Azure portal](https://portal.azure.com) or using SQL [dynamic management views](https://msdn.microsoft.com/library/ms188754.aspx).</span></span>

## <a name="monitor-databases-using-the-azure-portal"></a><span data-ttu-id="e2f5d-108">Мониторинг баз данных с помощью портала Azure</span><span class="sxs-lookup"><span data-stu-id="e2f5d-108">Monitor databases using the Azure portal</span></span>
<span data-ttu-id="e2f5d-109">На [портале Azure](https://portal.azure.com/) можно отслеживать использование отдельной базы данных. Для этого нужно выбрать базу данных и щелкнуть диаграмму **Мониторинг**.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-109">In the [Azure portal](https://portal.azure.com/), you can monitor a single database’s utilization by selecting your database and clicking the **Monitoring** chart.</span></span> <span data-ttu-id="e2f5d-110">Появится окно **Метрика**, которое можно изменить, нажав кнопку **Изменить диаграмму**.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-110">This brings up a **Metric** window that you can change by clicking the **Edit chart** button.</span></span> <span data-ttu-id="e2f5d-111">Добавьте следующие метрики:</span><span class="sxs-lookup"><span data-stu-id="e2f5d-111">Add the following metrics:</span></span>

* <span data-ttu-id="e2f5d-112">Процент использования ЦП</span><span class="sxs-lookup"><span data-stu-id="e2f5d-112">CPU percentage</span></span>
* <span data-ttu-id="e2f5d-113">Процент использования DTU</span><span class="sxs-lookup"><span data-stu-id="e2f5d-113">DTU percentage</span></span>
* <span data-ttu-id="e2f5d-114">Процент операций ввода/вывода данных</span><span class="sxs-lookup"><span data-stu-id="e2f5d-114">Data IO percentage</span></span>
* <span data-ttu-id="e2f5d-115">Размер базы данных в процентах</span><span class="sxs-lookup"><span data-stu-id="e2f5d-115">Database size percentage</span></span>

<span data-ttu-id="e2f5d-116">После добавления этих метрик можно продолжить наблюдение за ними на диаграмме **Мониторинг** с более подробными сведениями в окне **Метрика**.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-116">Once you’ve added these metrics, you can continue to view them in the **Monitoring** chart with more details on the **Metric** window.</span></span> <span data-ttu-id="e2f5d-117">Все четыре метрики показывают средний процент использования в соответствии с количеством единиц **DTU** для вашей базы данных.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-117">All four metrics show the average utilization percentage relative to the **DTU** of your database.</span></span> <span data-ttu-id="e2f5d-118">Дополнительные сведения о единицах DTU см. в статье, посвященной [уровням служб](sql-database-service-tiers.md).</span><span class="sxs-lookup"><span data-stu-id="e2f5d-118">See the [service tiers](sql-database-service-tiers.md) article for details about DTUs.</span></span>

![Мониторинг производительности базы данных для разных уровней служб.](./media/sql-database-service-tiers/sqldb_service_tier_monitoring.png)

<span data-ttu-id="e2f5d-120">Также можно настроить оповещения для метрик производительности.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-120">You can also configure alerts on the performance metrics.</span></span> <span data-ttu-id="e2f5d-121">В окне **Метрика** нажмите кнопку **Добавить оповещение**.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-121">Click the **Add alert** button in the **Metric** window.</span></span> <span data-ttu-id="e2f5d-122">Следуйте инструкциям мастера для настройки оповещения.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-122">Follow the wizard to configure your alert.</span></span> <span data-ttu-id="e2f5d-123">Можно настроить предупреждение, информирующее либо о превышении показателями определенного порога, либо о падении показателей ниже определенного порога.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-123">You have the option to alert if the metrics exceed a certain threshold or if the metric falls below a certain threshold.</span></span>

<span data-ttu-id="e2f5d-124">Например, если предполагается, что рабочая нагрузка базы данных будет расти, можно настроить отправку оповещения по электронной почте каждый раз, когда любой из показателей производительности для вашей базы данных достигнет 80%.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-124">For example, if you expect the workload on your database to grow, you can choose to configure an email alert whenever your database reaches 80% on any of the performance metrics.</span></span> <span data-ttu-id="e2f5d-125">Это оповещение можно использовать как предварительное предупреждение о том, что необходимо перейти на следующий, более высокий уровень производительности.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-125">You can use this as an early warning to figure out when you might have to switch to the next higher performance level.</span></span>

<span data-ttu-id="e2f5d-126">Метрики производительности также помогут определить, можете ли вы перейти на более низкий уровень производительности.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-126">The performance metrics can also help you determine if you are able to downgrade to a lower performance level.</span></span> <span data-ttu-id="e2f5d-127">Предположим, вы используете базу данных размера S2 уровня Стандартный, и все метрики производительности показывают, что база данных никогда не используется более чем на 10%.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-127">Assume you are using a Standard S2 database and all performance metrics show that the database on average does not use more than 10% at any given time.</span></span> <span data-ttu-id="e2f5d-128">Вполне вероятно, что эта база данных будет хорошо работать с размером S1 уровня Стандартный.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-128">It is likely that the database will work well in Standard S1.</span></span> <span data-ttu-id="e2f5d-129">Однако перед переходом на более низкий уровень производительности следует учитывать скачки и колебания рабочих нагрузок.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-129">However, be aware of workloads that spike or fluctuate before making the decision to move to a lower performance level.</span></span>

## <a name="monitor-databases-using-dmvs"></a><span data-ttu-id="e2f5d-130">Мониторинг баз данных с помощью динамических административных представлений</span><span class="sxs-lookup"><span data-stu-id="e2f5d-130">Monitor databases using DMVs</span></span>
<span data-ttu-id="e2f5d-131">Метрики, которые отображаются на портале, доступны также в системных представлениях: [sys.resource_stats](https://msdn.microsoft.com/library/dn269979.aspx) — в логической базе данных **master** вашего сервера, а также [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx) — в пользовательской базе данных.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-131">The same metrics that are exposed in the portal are also available through system views: [sys.resource_stats](https://msdn.microsoft.com/library/dn269979.aspx) in the logical **master** database of your server, and [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx) in the user database.</span></span> <span data-ttu-id="e2f5d-132">Используйте **sys.resource_stats**, если необходимо отслеживать менее детализированные данные для длительного периода времени.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-132">Use **sys.resource_stats** if you need to monitor less granular data across a longer period of time.</span></span> <span data-ttu-id="e2f5d-133">Используйте **sys.dm_db_resource_stats**, если необходимо отслеживать более детализированные данные для менее длительного периода времени.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-133">Use **sys.dm_db_resource_stats** if you need to monitor more granular data within a smaller time frame.</span></span> <span data-ttu-id="e2f5d-134">Дополнительные сведения см. в статье [База данных SQL Azure и производительность отдельных баз данных](sql-database-single-database-monitor.md#monitor-resource-use).</span><span class="sxs-lookup"><span data-stu-id="e2f5d-134">For more information, see [Azure SQL Database Performance Guidance](sql-database-single-database-monitor.md#monitor-resource-use).</span></span>

> [!NOTE]
> <span data-ttu-id="e2f5d-135">При использовании в базах данных устаревших выпусков Web Edition и Business Edition **sys.dm_db_resource_stats** возвращает пустой результирующий набор.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-135">**sys.dm_db_resource_stats** returns an empty result set when used in Web and Business edition databases, which are retired.</span></span>
>
>

### <a name="monitor-resource-use"></a><span data-ttu-id="e2f5d-136">Отслеживание использования ресурсов</span><span class="sxs-lookup"><span data-stu-id="e2f5d-136">Monitor resource use</span></span>

<span data-ttu-id="e2f5d-137">Использование ресурсов можно отслеживать с помощью [анализа производительности запросов базы данных SQL](sql-database-query-performance.md) и [хранилища запросов](https://msdn.microsoft.com/library/dn817826.aspx).</span><span class="sxs-lookup"><span data-stu-id="e2f5d-137">You can monitor resource usage using [SQL Database Query Performance Insight](sql-database-query-performance.md) and [Query Store](https://msdn.microsoft.com/library/dn817826.aspx).</span></span>

<span data-ttu-id="e2f5d-138">Кроме того, для отслеживания использования можно применять два приведенных ниже представления.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-138">You can also monitor usage using these two views:</span></span>

* [<span data-ttu-id="e2f5d-139">sys.dm_db_resource_stats</span><span class="sxs-lookup"><span data-stu-id="e2f5d-139">sys.dm_db_resource_stats</span></span>](https://msdn.microsoft.com/library/dn800981.aspx)
* [<span data-ttu-id="e2f5d-140">sys.resource_stats</span><span class="sxs-lookup"><span data-stu-id="e2f5d-140">sys.resource_stats</span></span>](https://msdn.microsoft.com/library/dn269979.aspx)

#### <a name="sysdmdbresourcestats"></a><span data-ttu-id="e2f5d-141">sys.dm_db_resource_stats</span><span class="sxs-lookup"><span data-stu-id="e2f5d-141">sys.dm_db_resource_stats</span></span>
<span data-ttu-id="e2f5d-142">Представление [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx) можно использовать в каждой базе данных SQL.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-142">You can use the [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx) view in every SQL database.</span></span> <span data-ttu-id="e2f5d-143">В представлении **sys.dm_db_resource_stats** отображаются последние данные использования ресурсов в соответствии с уровнем служб.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-143">The **sys.dm_db_resource_stats** view shows recent resource use data relative to the service tier.</span></span> <span data-ttu-id="e2f5d-144">Средний процент нагрузки ЦП, показатели операций ввода-вывода данных, записи в журнал и данные о памяти записываются каждые 15 секунд и хранятся 1 час.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-144">Average percentages for CPU, data I/O, log writes, and memory are recorded every 15 seconds and are maintained for 1 hour.</span></span>

<span data-ttu-id="e2f5d-145">Так как это представление содержит более подробные сведения об использовании ресурсов, сначала используйте представление **sys.dm_db_resource_stats** для любого анализа текущего состояния и устранения неполадок.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-145">Because this view provides a more granular look at resource use, use **sys.dm_db_resource_stats** first for any current-state analysis or troubleshooting.</span></span> <span data-ttu-id="e2f5d-146">Например, этот запрос показывает среднее и максимальное использование ресурсов для текущей базы данных за последний час:</span><span class="sxs-lookup"><span data-stu-id="e2f5d-146">For example, this query shows the average and maximum resource use for the current database over the past hour:</span></span>

    SELECT  
        AVG(avg_cpu_percent) AS 'Average CPU use in percent',
        MAX(avg_cpu_percent) AS 'Maximum CPU use in percent',
        AVG(avg_data_io_percent) AS 'Average data I/O in percent',
        MAX(avg_data_io_percent) AS 'Maximum data I/O in percent',
        AVG(avg_log_write_percent) AS 'Average log write use in percent',
        MAX(avg_log_write_percent) AS 'Maximum log write use in percent',
        AVG(avg_memory_usage_percent) AS 'Average memory use in percent',
        MAX(avg_memory_usage_percent) AS 'Maximum memory use in percent'
    FROM sys.dm_db_resource_stats;  

<span data-ttu-id="e2f5d-147">Примеры других запросов см. в [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx).</span><span class="sxs-lookup"><span data-stu-id="e2f5d-147">For other queries, see the examples in [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx).</span></span>

#### <a name="sysresourcestats"></a><span data-ttu-id="e2f5d-148">sys.resource_stats</span><span class="sxs-lookup"><span data-stu-id="e2f5d-148">sys.resource_stats</span></span>
<span data-ttu-id="e2f5d-149">Представление [sys.resource_stats](https://msdn.microsoft.com/library/dn269979.aspx) в базе данных **master** предоставляет дополнительные сведения, с помощью которых можно контролировать производительность базы данных SQL в рамках конкретного уровня службы и производительности.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-149">The [sys.resource_stats](https://msdn.microsoft.com/library/dn269979.aspx) view in the **master** database has additional information that can help you monitor the performance of your SQL database at its specific service tier and performance level.</span></span> <span data-ttu-id="e2f5d-150">Данные собираются каждые 5 минут и хранятся приблизительно 35 дней.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-150">The data is collected every 5 minutes and is maintained for approximately 35 days.</span></span> <span data-ttu-id="e2f5d-151">Это представление полезно для анализа использования ресурсов Базы данных SQL за более долгий период.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-151">This view is useful for a longer-term historical analysis of how your SQL database uses resources.</span></span>

<span data-ttu-id="e2f5d-152">На следующей диаграмме показано почасовое использование ресурсов процессора для базы данных уровня "Премиум" с уровнем производительности P2 в течение недели.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-152">The following graph shows the CPU resource use for a Premium database with the P2 performance level for each hour in a week.</span></span> <span data-ttu-id="e2f5d-153">Диаграмма начинается в понедельник, охватывает 5 рабочих дней и выходные, когда нагрузка заметно ниже.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-153">This graph starts on a Monday, shows 5 work days, and then shows a weekend, when much less happens on the application.</span></span>

![Использование ресурсов Базы данных SQL](./media/sql-database-performance-guidance/sql_db_resource_utilization.png)

<span data-ttu-id="e2f5d-155">Судя по этим данным, пиковая нагрузка на процессор составляет чуть более 50 % от максимальной нагрузки на уровне производительности P2 (полдень вторника).</span><span class="sxs-lookup"><span data-stu-id="e2f5d-155">From the data, this database currently has a peak CPU load of just over 50 percent CPU use relative to the P2 performance level (midday on Tuesday).</span></span> <span data-ttu-id="e2f5d-156">Если мощность процессора была главным фактором ресурсного профиля приложения, то клиент может решить, что P2 — оптимальный уровень производительности, который гарантирует стабильную работу с учетом средней нагрузки.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-156">If CPU is the dominant factor in the application’s resource profile, then you might decide that P2 is the right performance level to guarantee that the workload always fits.</span></span> <span data-ttu-id="e2f5d-157">Если ожидается рост нагрузки на приложение с течением времени, рекомендуется увеличить запас ресурсов, чтобы приложения не достигло предела производительности.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-157">If you expect an application to grow over time, it's a good idea to have an extra resource buffer so that the application doesn't ever reach the performance-level limit.</span></span> <span data-ttu-id="e2f5d-158">Увеличив уровень производительности, можно избежать заметных пользователю ошибок, которые могут возникнуть из-за нехватки в базе данных мощности для эффективной обработки запросов, особенно в средах, чувствительных к задержкам.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-158">If you increase the performance level, you can help avoid customer-visible errors that might occur when a database doesn't have enough power to process requests effectively, especially in latency-sensitive environments.</span></span> <span data-ttu-id="e2f5d-159">Это может быть база данных, поддерживающая приложение, создающее веб-страницы на основе запросов к базе данных.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-159">An example is a database that supports an application that paints webpages based on the results of database calls.</span></span>

<span data-ttu-id="e2f5d-160">Для других приложений эту диаграмму можно интерпретировать иначе.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-160">Other application types might interpret the same graph differently.</span></span> <span data-ttu-id="e2f5d-161">Например, если приложение обрабатывало данные по зарплате каждый день и получало ту же диаграмму, то выполнение таких "пакетных заданий" будет эффективным и на уровне производительности P1.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-161">For example, if an application tries to process payroll data each day and has the same chart, this kind of "batch job" model might do fine at a P1 performance level.</span></span> <span data-ttu-id="e2f5d-162">Уровень производительности P1 предоставляет 100 DTU, а P2 — 200 DTU.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-162">The P1 performance level has 100 DTUs compared to 200 DTUs at the P2 performance level.</span></span> <span data-ttu-id="e2f5d-163">P1 обеспечивает производительность в два раза меньше, чем P2.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-163">The P1 performance level provides half the performance of the P2 performance level.</span></span> <span data-ttu-id="e2f5d-164">Таким образом, 50 процентов использования ЦП на уровне P2 равняется 100 процентам использования ЦП на уровне P1.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-164">So, 50 percent of CPU use in P2 equals 100 percent CPU use in P1.</span></span> <span data-ttu-id="e2f5d-165">Если в работе приложения не возникает пауз, возможно, не имеет значения, сколько времени выполняется задание — 2 или 2,5 часа, а важно только, чтобы оно было завершено сегодня.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-165">If the application does not have timeouts, it might not matter if a job takes 2 hours or 2.5 hours to finish, if it gets done today.</span></span> <span data-ttu-id="e2f5d-166">Приложение такой категории может использовать уровень Р1.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-166">An application in this category probably can use a P1 performance level.</span></span> <span data-ttu-id="e2f5d-167">Вы можете воспользоваться тем, что в определенное время дня использование ресурсов ниже, и перенести пиковую нагрузку именно на этот период.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-167">You can take advantage of the fact that there are periods of time during the day when resource use is lower, so that any "big peak" might spill over into one of the troughs later in the day.</span></span> <span data-ttu-id="e2f5d-168">Уровень производительности Р1 может отлично подойти для такого приложения (и сэкономить деньги), если задания будут завершаться вовремя в течение одного дня.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-168">The P1 performance level might be good for that kind of application (and save money), as long as the jobs can finish on time each day.</span></span>

<span data-ttu-id="e2f5d-169">База данных SQL Azure предоставляет сведения об использовании ресурсов по каждой активной базе данных в представлении **sys.resource_stats** для базы данных **master** на каждом сервере.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-169">Azure SQL Database exposes consumed resource information for each active database in the **sys.resource_stats** view of the **master** database in each server.</span></span> <span data-ttu-id="e2f5d-170">Данные в таблице агрегируются каждые 5 минут.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-170">The data in the table is aggregated for 5-minute intervals.</span></span> <span data-ttu-id="e2f5d-171">На уровнях служб "Базовый", "Стандартный" и "Премиум" может потребоваться более 5 минут, прежде чем данные появятся в таблице, то есть эти данные лучше подходят для ретроспективного анализа, чем для анализа в режиме реального времени.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-171">With the Basic, Standard, and Premium service tiers, the data can take more than 5 minutes to appear in the table, so this data is more useful for historical analysis rather than near-real-time analysis.</span></span> <span data-ttu-id="e2f5d-172">Выполните запрос представления **sys.resource_stats**, чтобы просмотреть журнал базы данных и проверить, обеспечил ли выбранный уровень резервирования требуемую производительность.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-172">Query the **sys.resource_stats** view to see the recent history of a database and to validate whether the reservation you chose delivered the performance you want when needed.</span></span>

> [!NOTE]
> <span data-ttu-id="e2f5d-173">Вы должны быть подключены к базе данных **master** логического сервера базы данных SQL, чтобы отправить запрос **sys.resource_stats** в следующих примерах.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-173">You must be connected to the **master** database of your logical SQL database server to query **sys.resource_stats** in the following examples.</span></span>
> 
> 

<span data-ttu-id="e2f5d-174">В этом примере показано, как отображаются данные в этом представлении.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-174">This example shows you how the data in this view is exposed:</span></span>

    SELECT TOP 10 *
    FROM sys.resource_stats
    WHERE database_name = 'resource1'
    ORDER BY start_time DESC

![Представление каталога sys.resource_stats](./media/sql-database-performance-guidance/sys_resource_stats.png)

<span data-ttu-id="e2f5d-176">Ниже показаны различные способы использования представления каталога **sys.resource_stats** для получения сведений об использовании ресурсов в базе данных SQL.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-176">The next example shows you different ways that you can use the **sys.resource_stats** catalog view to get information about how your SQL database uses resources:</span></span>

1. <span data-ttu-id="e2f5d-177">Чтобы просмотреть данные использования ресурсов на прошлой неделе для базы данных userdb1, можно выполнить следующий запрос:</span><span class="sxs-lookup"><span data-stu-id="e2f5d-177">To look at the past week’s resource use for the database userdb1, you can run this query:</span></span>
   
        SELECT *
        FROM sys.resource_stats
        WHERE database_name = 'userdb1' AND
              start_time > DATEADD(day, -7, GETDATE())
        ORDER BY start_time DESC;
2. <span data-ttu-id="e2f5d-178">Чтобы определить, какой уровень производительности лучше всего подходит для конкретной рабочей нагрузки, нужно детализировать все значения использования ресурсов: процессор, операции чтения и записи, количество рабочих ролей и количество сеансов.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-178">To evaluate how well your workload fits the performance level, you need to drill down into each aspect of the resource metrics: CPU, reads, writes, number of workers, and number of sessions.</span></span> <span data-ttu-id="e2f5d-179">Ниже приведен измененный запрос, использующий **sys.resource_stats** для получения отчета о средних и максимальных значениях использования ресурсов.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-179">Here's a revised query using **sys.resource_stats** to report the average and maximum values of these resource metrics:</span></span>
   
        SELECT
            avg(avg_cpu_percent) AS 'Average CPU use in percent',
            max(avg_cpu_percent) AS 'Maximum CPU use in percent',
            avg(avg_data_io_percent) AS 'Average physical data I/O use in percent',
            max(avg_data_io_percent) AS 'Maximum physical data I/O use in percent',
            avg(avg_log_write_percent) AS 'Average log write use in percent',
            max(avg_log_write_percent) AS 'Maximum log write use in percent',
            avg(max_session_percent) AS 'Average % of sessions',
            max(max_session_percent) AS 'Maximum % of sessions',
            avg(max_worker_percent) AS 'Average % of workers',
            max(max_worker_percent) AS 'Maximum % of workers'
        FROM sys.resource_stats
        WHERE database_name = 'userdb1' AND start_time > DATEADD(day, -7, GETDATE());
3. <span data-ttu-id="e2f5d-180">С помощью средних и максимальных значений по каждому ресурсу можно оценить, насколько выбранный уровень производительности подходит для вашей рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-180">With this information about the average and maximum values of each resource metric, you can assess how well your workload fits into the performance level you chose.</span></span> <span data-ttu-id="e2f5d-181">Как правило, средние значения из **sys.resource_stats** дают хорошую основу для определения целевого резервирования.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-181">Usually, average values from **sys.resource_stats** give you a good baseline to use against the target size.</span></span> <span data-ttu-id="e2f5d-182">Эти сведения следует использовать в качестве отправной точки анализа.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-182">It should be your primary measurement stick.</span></span> <span data-ttu-id="e2f5d-183">Например, вы можете использовать уровень служб "Стандартный" с уровнем производительности S2.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-183">For an example, you might be using the Standard service tier with S2 performance level.</span></span> <span data-ttu-id="e2f5d-184">При этом средняя нагрузка на процессор и число операций чтения и записи ввода-вывода составляют меньше 40 %, среднее число рабочих ролей — меньше 50, а среднее количество сеансов — меньше 200.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-184">The average use percentages for CPU and I/O reads and writes are below 40 percent, the average number of workers is below 50, and the average number of sessions is below 200.</span></span> <span data-ttu-id="e2f5d-185">Для такой рабочей нагрузки может подойти уровень производительности S1.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-185">Your workload might fit into the S1 performance level.</span></span> <span data-ttu-id="e2f5d-186">Вы легко можете определить, отвечает ли уровень базы данных ограничениям рабочих ролей и сеансов.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-186">It's easy to see whether your database fits in the worker and session limits.</span></span> <span data-ttu-id="e2f5d-187">Чтобы узнать, можно ли для базы данных использовать более низкий уровень производительности с учетом нагрузки на процессор, количества операций чтения и записи, разделите число DTU более низкого уровня на DTU текущего уровня производительности и умножьте результат на 100.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-187">To see whether a database fits into a lower performance level with regards to CPU, reads, and writes, divide the DTU number of the lower performance level by the DTU number of your current performance level, and then multiply the result by 100:</span></span>
   
    <span data-ttu-id="e2f5d-188">**DTU S1 / DTU S2 * 100 = 20 / 50 * 100 = 40**</span><span class="sxs-lookup"><span data-stu-id="e2f5d-188">**S1 DTU / S2 DTU * 100 = 20 / 50 * 100 = 40**</span></span>
   
    <span data-ttu-id="e2f5d-189">Результатом будет относительная разница производительности между двумя уровнями в процентах.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-189">The result is the relative performance difference between the two performance levels in percentage.</span></span> <span data-ttu-id="e2f5d-190">Если использование ресурсов не превышает это значение, для рабочей нагрузки может подойти более низкий уровень производительности.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-190">If your resource use doesn't exceed this amount, your workload might fit into the lower performance level.</span></span> <span data-ttu-id="e2f5d-191">Однако необходимо рассмотреть все диапазоны значений использования ресурсов, а также определить (в процентном отношении), как часто рабочая нагрузка будет вписываться в рамки более низкого уровня производительности.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-191">However, you need to look at all ranges of resource use values, and determine, by percentage, how often your database workload would fit into the lower performance level.</span></span> <span data-ttu-id="e2f5d-192">Следующий запрос отображает процентный показатель измерения ресурсов, исходя из 40-процентного порога, вычисленного в предыдущем примере.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-192">The following query outputs the fit percentage per resource dimension, based on the threshold of 40 percent that we calculated in this example:</span></span>
   
        SELECT
            (COUNT(database_name) - SUM(CASE WHEN avg_cpu_percent >= 40 THEN 1 ELSE 0 END) * 1.0) / COUNT(database_name) AS 'CPU Fit Percent'
            ,(COUNT(database_name) - SUM(CASE WHEN avg_log_write_percent >= 40 THEN 1 ELSE 0 END) * 1.0) / COUNT(database_name) AS 'Log Write Fit Percent'
            ,(COUNT(database_name) - SUM(CASE WHEN avg_data_io_percent >= 40 THEN 1 ELSE 0 END) * 1.0) / COUNT(database_name) AS 'Physical Data IO Fit Percent'
        FROM sys.resource_stats
        WHERE database_name = 'userdb1' AND start_time > DATEADD(day, -7, GETDATE());
   
    <span data-ttu-id="e2f5d-193">В зависимости от целевого уровня обслуживания (SLO) базы данных вы можете определить, подходит ли более низкий уровень производительности для вашей рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-193">Based on your database service level objective (SLO), you can decide whether your workload fits into the lower performance level.</span></span> <span data-ttu-id="e2f5d-194">Если SLO составляет 99,9 % и указанный выше запрос возвращает значение больше 99,9 % для всех трех измерений ресурсов, весьма вероятно, что рабочую нагрузку можно выполнять на более низком уровне производительности.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-194">If your database workload SLO is 99.9 percent and the preceding query returns values greater than 99.9 percent for all three resource dimensions, your workload likely fits into the lower performance level.</span></span>
   
    <span data-ttu-id="e2f5d-195">Процентное значение также поможет вам понять, следует ли перейти на следующий уровень производительности для выполнения требований SLO.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-195">Looking at the fit percentage also gives you insight into whether you should move to the next higher performance level to meet your SLO.</span></span> <span data-ttu-id="e2f5d-196">Например, для userdb1 мы видим следующую нагрузку ЦП за прошлую неделю.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-196">For example, userdb1 shows the following CPU use for the past week:</span></span>
   
   | <span data-ttu-id="e2f5d-197">Средняя нагрузка ЦП, %</span><span class="sxs-lookup"><span data-stu-id="e2f5d-197">Average CPU percent</span></span> | <span data-ttu-id="e2f5d-198">Максимальная нагрузка ЦП, %</span><span class="sxs-lookup"><span data-stu-id="e2f5d-198">Maximum CPU percent</span></span> |
   | --- | --- |
   | <span data-ttu-id="e2f5d-199">24,5</span><span class="sxs-lookup"><span data-stu-id="e2f5d-199">24.5</span></span> |<span data-ttu-id="e2f5d-200">100,00</span><span class="sxs-lookup"><span data-stu-id="e2f5d-200">100.00</span></span> |
   
    <span data-ttu-id="e2f5d-201">Средняя нагрузка процессора равна приблизительно одной четвертой ограничения уровня производительности, что вполне соответствует уровню производительности базы данных.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-201">The average CPU is about a quarter of the limit of the performance level, which would fit well into the performance level of the database.</span></span> <span data-ttu-id="e2f5d-202">Однако максимальное значение показывает, что база данных достигла ограничения уровня производительности.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-202">But, the maximum value shows that the database reaches the limit of the performance level.</span></span> <span data-ttu-id="e2f5d-203">Требуется ли перейти на следующий уровень производительности?</span><span class="sxs-lookup"><span data-stu-id="e2f5d-203">Do you need to move to the next higher performance level?</span></span> <span data-ttu-id="e2f5d-204">Определите, сколько раз рабочая нагрузка достигает 100 %, и сравните это значение с SLO рабочей нагрузки базы данных.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-204">Look at how many times your workload reaches 100 percent, and then compare it to your database workload SLO.</span></span>
   
        SELECT
        (COUNT(database_name) - SUM(CASE WHEN avg_cpu_percent >= 100 THEN 1 ELSE 0 END) * 1.0) / COUNT(database_name) AS 'CPU fit percent'
        ,(COUNT(database_name) - SUM(CASE WHEN avg_log_write_percent >= 100 THEN 1 ELSE 0 END) * 1.0) / COUNT(database_name) AS 'Log write fit percent'
        ,(COUNT(database_name) - SUM(CASE WHEN avg_data_io_percent >= 100 THEN 1 ELSE 0 END) * 1.0) / COUNT(database_name) AS 'Physical data I/O fit percent'
        FROM sys.resource_stats
        WHERE database_name = 'userdb1' AND start_time > DATEADD(day, -7, GETDATE());
   
    <span data-ttu-id="e2f5d-205">Если этот запрос возвращает значение меньше 99,9 для любого из трех измерений ресурсов, следует перейти на следующий уровень или использовать методы оптимизации приложения для сокращения нагрузки на Базу данных SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-205">If this query returns a value less than 99.9 percent for any of the three resource dimensions, consider either moving to the next higher performance level or use application-tuning techniques to reduce the load on the SQL database.</span></span>
4. <span data-ttu-id="e2f5d-206">В таких расчетах также следует учитывать возможное увеличение рабочей нагрузки в будущем.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-206">This exercise also considers your projected workload increase in the future.</span></span>

<span data-ttu-id="e2f5d-207">Для эластичных пулов можно отслеживать отдельные базы данных в пуле с помощью способов, описанных в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-207">For elastic pools, you can monitor individual databases in the pool with the techniques described in this section.</span></span> <span data-ttu-id="e2f5d-208">Но также можно отслеживать и пул в целом.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-208">But you can also monitor the pool as a whole.</span></span> <span data-ttu-id="e2f5d-209">Дополнительные сведения см. в статье [Мониторинг пула эластичных баз данных и управление им на портале Azure](sql-database-elastic-pool-manage-portal.md).</span><span class="sxs-lookup"><span data-stu-id="e2f5d-209">For information, see [Monitor and manage an elastic pool](sql-database-elastic-pool-manage-portal.md).</span></span>


### <a name="maximum-concurrent-requests"></a><span data-ttu-id="e2f5d-210">Максимальное количество параллельных запросов</span><span class="sxs-lookup"><span data-stu-id="e2f5d-210">Maximum concurrent requests</span></span>
<span data-ttu-id="e2f5d-211">Чтобы просмотреть число параллельных запросов, выполните в Базе данных SQL этот запрос Transact-SQL:</span><span class="sxs-lookup"><span data-stu-id="e2f5d-211">To see the number of concurrent requests, run this Transact-SQL query on your SQL database:</span></span>

    SELECT COUNT(*) AS [Concurrent_Requests]
    FROM sys.dm_exec_requests R

<span data-ttu-id="e2f5d-212">Чтобы проанализировать рабочую нагрузку локальной базы данных SQL Server, следует изменить этот запрос для фильтрации конкретной базы данных, которую необходимо проанализировать.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-212">To analyze the workload of an on-premises SQL Server database, modify this query to filter on the specific database you want to analyze.</span></span> <span data-ttu-id="e2f5d-213">Например, если у вас есть локальная база данных с именем MyDatabase, для получения числа параллельных запросов в этой базе данных можно использовать следующий запрос Transact-SQL:</span><span class="sxs-lookup"><span data-stu-id="e2f5d-213">For example, if you have an on-premises database named MyDatabase, this Transact-SQL query returns the count of concurrent requests in that database:</span></span>

    SELECT COUNT(*) AS [Concurrent_Requests]
    FROM sys.dm_exec_requests R
    INNER JOIN sys.databases D ON D.database_id = R.database_id
    AND D.name = 'MyDatabase'

<span data-ttu-id="e2f5d-214">Это только моментальный снимок в один момент времени.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-214">This is just a snapshot at a single point in time.</span></span> <span data-ttu-id="e2f5d-215">Для лучшего понимания рабочей нагрузки и требований к параллельным запросам потребуется собрать большое количество примеров с течением времени.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-215">To get a better understanding of your workload and concurrent request requirements, you'll need to collect many samples over time.</span></span>

### <a name="maximum-concurrent-logins"></a><span data-ttu-id="e2f5d-216">Максимальное число параллельных операций входа</span><span class="sxs-lookup"><span data-stu-id="e2f5d-216">Maximum concurrent logins</span></span>
<span data-ttu-id="e2f5d-217">Чтобы получить представление о частоте входа, можно проанализировать шаблоны работы пользователей и приложений.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-217">You can analyze your user and application patterns to get an idea of the frequency of logins.</span></span> <span data-ttu-id="e2f5d-218">Кроме того, можно запустить реальные нагрузки в тестовой среде, чтобы убедиться в том, что вы не приближаетесь к этим или другим ограничениям, описанным в этой статье.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-218">You also can run real-world loads in a test environment to make sure that you're not hitting this or other limits we discuss in this article.</span></span> <span data-ttu-id="e2f5d-219">Нет единого запроса или динамического административного представления, с помощью которых можно просмотреть количество параллельных операций входа или журнал.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-219">There isn’t a single query or dynamic management view (DMV) that can show you concurrent login counts or history.</span></span>

<span data-ttu-id="e2f5d-220">Если несколько клиентов используют ту же строку подключения, служба проверяет подлинность каждого входа.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-220">If multiple clients use the same connection string, the service authenticates each login.</span></span> <span data-ttu-id="e2f5d-221">Если 10 пользователей одновременно подключаются к базе данных с использованием того же имени пользователя и пароля, это будет 10 параллельных операций входа.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-221">If 10 users simultaneously connect to a database by using the same username and password, there would be 10 concurrent logins.</span></span> <span data-ttu-id="e2f5d-222">Это ограничение применяется только на время входа и проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-222">This limit applies only to the duration of the login and authentication.</span></span> <span data-ttu-id="e2f5d-223">Если те же 10 пользователей последовательно подключатся к базе данных, количество параллельных операций входа никогда не будет больше 1.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-223">If the same 10 users connect to the database sequentially, the number of concurrent logins would never be greater than 1.</span></span>

> [!NOTE]
> <span data-ttu-id="e2f5d-224">Сейчас это ограничение не применимо к базам данных в пулах эластичных баз данных.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-224">Currently, this limit does not apply to databases in elastic pools.</span></span>
> 
> 

### <a name="maximum-sessions"></a><span data-ttu-id="e2f5d-225">Максимальное число сеансов</span><span class="sxs-lookup"><span data-stu-id="e2f5d-225">Maximum sessions</span></span>
<span data-ttu-id="e2f5d-226">Чтобы просмотреть число текущих активных сеансов, выполните в Базе данных SQL этот запрос Transact-SQL:</span><span class="sxs-lookup"><span data-stu-id="e2f5d-226">To see the number of current active sessions, run this Transact-SQL query on your SQL database:</span></span>

    SELECT COUNT(*) AS [Sessions]
    FROM sys.dm_exec_connections

<span data-ttu-id="e2f5d-227">При анализе рабочей нагрузки локального SQL Server измените запрос, чтобы сосредоточиться на определенной базе данных.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-227">If you're analyzing an on-premises SQL Server workload, modify the query to focus on a specific database.</span></span> <span data-ttu-id="e2f5d-228">Это поможет определить возможные потребности в сеансах для этой базы данных, если вы собираетесь переместить ее в Базу данных SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-228">This query helps you determine possible session needs for the database if you are considering moving it to Azure SQL Database.</span></span>

    SELECT COUNT(*)  AS [Sessions]
    FROM sys.dm_exec_connections C
    INNER JOIN sys.dm_exec_sessions S ON (S.session_id = C.session_id)
    INNER JOIN sys.databases D ON (D.database_id = S.database_id)
    WHERE D.name = 'MyDatabase'

<span data-ttu-id="e2f5d-229">Опять же, эти запросы возвращают значение счетчика на определенный момент времени.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-229">Again, these queries return a point-in-time count.</span></span> <span data-ttu-id="e2f5d-230">Сбор нескольких образцов за определенный период времени обеспечивает лучшее понимание использования сеансов.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-230">If you collect multiple samples over time, you’ll have the best understanding of your session use.</span></span>

<span data-ttu-id="e2f5d-231">Для анализа базы данных SQL можно получить журнал статистики использования сеансов, запросив представление [sys.resource_stats](https://msdn.microsoft.com/library/dn269979.aspx) и просмотрев столбец **active_session_count**.</span><span class="sxs-lookup"><span data-stu-id="e2f5d-231">For SQL Database analysis, you can get historical statistics on sessions by querying the [sys.resource_stats](https://msdn.microsoft.com/library/dn269979.aspx) view and reviewing the **active_session_count** column.</span></span> 

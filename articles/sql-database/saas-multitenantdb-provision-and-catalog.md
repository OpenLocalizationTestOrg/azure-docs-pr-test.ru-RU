---
title: "Подготовка к работе в нескольких клиентов SaaS Azure | Документы Microsoft"
description: "Сведения о подготовке и каталогизации новых клиентов в приложении SaaS мультитенантной базы данных SQL Azure"
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: MightyPen
manager: craigg
editor: MightyPen
ms.reviewer: billgib;andrela;genemi
ms.assetid: 
ms.service: sql-database
ms.custom: saas apps
ms.workload: Inactive
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/19/2017
ms.author: billgib
ms.openlocfilehash: 42bbb6131aa71520410b22af4d74e99a63fe81cf
ms.sourcegitcommit: f46cbcff710f590aebe437c6dd459452ddf0af09
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/20/2017
---
# <a name="provision-and-catalog-new-tenants-in-a-saas-application-using-a-sharded-multi-tenant-azure-sql-database"></a>Подготовка к работе и каталога новых клиентов в приложении SaaS, с помощью сегментированной базы данных Azure SQL несколькими клиентами

В этой статье рассматриваются подготовки и создания каталога для новых клиентов в *сегментированной базы данных нескольких клиентов* модель или шаблон.

В этой статье состоит из двух основных частей:

- [Описание](#goto_2_conceptual) подготовки и создания каталога для новых клиентов.

- [Учебник по](#goto_1_tutorial) , выделяет код скрипта PowerShell, которое выполняет подготовку и создания каталога.
    - Учебник используется приложение SaaS билеты Wingtip адаптировать шаблону сегментированной базы данных несколькими клиентами.

<a name="goto_2_conceptual"/>

## <a name="database-pattern"></a>Шаблон базы данных

В этом разделе, плюс несколько, которые следует выполнить, рассматриваются основные понятия шаблон сегментированной базы данных несколькими клиентами.

В этой модели сегментированных несколькими клиентами схемы таблиц в каждой базе данных включают ключ клиента в первичном ключе таблицы, в которых хранятся данные клиента. Ключ клиента позволяет каждая отдельная база данных для хранения 0, 1 или несколько клиентов. Использование сегментированных баз данных упрощает системы приложений для поддержки очень большого количества клиентов. Все данные для любого одного клиента хранятся в одной базе данных. С большим количеством клиентов распределяются между многие сегментированной базы данных. База данных каталога хранит сопоставление каждого из них для своей базы данных.

#### <a name="isolation-versus-lower-cost"></a>Изоляции в сравнении с меньшей стоимостью

Преимущества изоляции с удовольствием клиента с базы данных все самому себе. Клиент может иметь базу данных, восстановить на более раннюю дату без ограничений, влияние на других клиентов. Для оптимизации для одного клиента, еще раз без необходимости взлома совместно с другими клиентами, можно оптимизировать производительность базы данных. Проблема заключается в том, что изоляции стоит дороже, чем издержки на совместное использование базы данных с другими клиентами.

При подготовке нового клиента базы данных могут совместно использовать с другими клиентами, или она может быть помещена в собственную новой базы данных. Позже можно изменить свое решение и переместить базы данных в другой ситуации.

Базы данных с нескольких клиентов и один клиентов смешиваются в одном приложении SaaS, для оптимизации затрат или изоляции для каждого клиента.

   ![Приложение с сегментированной мультитенантной базой данных и каталогом клиента](media/saas-multitenantdb-provision-and-catalog/MultiTenantCatalog.png)

## <a name="tenant-catalog-pattern"></a>Шаблон каталога клиента

При наличии двух или более баз данных, каждый из которых содержит по крайней мере одного клиента, приложение должно иметь возможность обнаруживать базу данных, которая хранит клиента текущий процент. Каталог базы данных сохраняет данное сопоставление.

#### <a name="tenant-key"></a>Ключ клиента

Для каждого клиента приложения Wingtip могут наследовать уникальный ключ, который представляет ключ клиента. Приложение извлекает имя клиента из URL-адрес веб-страницы. Приложение хэширует именем, чтобы получить ключ. Приложение использует ключ для доступа к каталогу. Перекрестные ссылки каталога сведения о базе данных, в которой хранится клиента. Приложение использует сведения о базе данных для подключения. Вы также можете использовать и другие схемы ключа клиента.

Благодаря использованию каталога можно изменить имя или расположение базы данных клиента после подготовки, не прерывая работу приложения. В модели базы данных нескольких клиентов каталога обеспечивает перемещение между базами данных клиента.

#### <a name="tenant-metadata-beyond-location"></a>Метаданные клиента за пределами расположения

Каталога можно также указать, является ли клиент находится в автономном режиме для обслуживания или других действий. И каталог может быть расширен для хранения дополнительных клиента или метаданных базы данных, например, следующие элементы:
- Уровень обслуживания или выпуск базы данных.
- Версия схемы базы данных.
- Имя клиента и его соглашения об уровне ОБСЛУЖИВАНИЯ (соглашение об уровне обслуживания).
- Сведения, чтобы включить управление приложениями, службу поддержки или devops процессов.  

Каталог можно также использовать, чтобы создавать отчеты между клиентами, управлять схемой и извлекать данные для аналитики. 

### <a name="elastic-database-client-library"></a>Клиентская библиотека эластичной базы данных 

Каталог в Wingtip, реализуются в *tenantcatalog* базы данных. *Tenantcatalog* создается с помощью функций управления сегментами [библиотеки клиента эластичной базы данных (EDCL)](sql-database-elastic-database-client-library.md). Библиотека позволяет приложению создавать, управлять и использовать *карта сегментов* , хранится в базе данных. Карта сегментов связан с ключом клиента с его сегментов, то есть его сегментированной базы данных.

Во время подготовки клиента EDCL функции может использоваться из приложения или скрипты PowerShell для создания записей на карте сегментов. Позже EDCL функции могут использоваться для подключения к нужной базе данных. EDCL кэширует сведения о подключении, чтобы уменьшить объем трафика в базе данных каталога и ускорить процесс подключения.

> [!IMPORTANT]
> Сделать *не* изменение данных в базе данных каталога через прямой доступ. Прямое обновление не поддерживается из-за высокой риск повреждения данных. Вместо этого измените сопоставление данных только с помощью API-интерфейсов EDCL.

## <a name="tenant-provisioning-pattern"></a>Шаблон подготовки клиента

#### <a name="checklist"></a>Контрольный список

Если вы хотите подготовить новый клиент в существующей общей базы данных, из общей базы данных необходимо задайте следующие вопросы:
- Имеет недостаточно места для нового клиента?
- Содержать таблиц, необходимые ссылочные данные для нового клиента, или можно добавить данные?
- Имеет аналогичную базовой схемы для нового клиента?
- Это в соответствующем географическом близко к новым клиентом?
- Это на уровне нужную службу для нового клиента?

При необходимости нового клиента возможность быть изолирован в собственную базу данных можно создать его для спецификаций для клиента.

После завершения подготовки клиента необходимо зарегистрировать в каталоге. Наконец, можно добавить сопоставление клиентов, чтобы ссылаться на соответствующий сегмент.

#### <a name="template-database"></a>Шаблон базы данных

Чтобы подготовить базу данных, выполните скрипты SQL, разверните файл BACPAC или скопируйте шаблон базы данных. Приложения Wingtip копирования шаблона базы данных для создания новой базы данных клиента.

Как и любое приложение Wingtip будет меняться с течением времени. В некоторых случаях Wingtip потребует изменения в базе данных. Изменения могут включать следующие элементы:
- Новые или измененные схемы.
- Новые или измененные ссылочных данных.
- Задачи обслуживания сопоставление базы данных для обеспечения оптимальной производительности приложения.

С приложением SaaS эти изменения необходимо развертывать скоординировано в потенциально большом количестве баз данных клиентов. Чтобы эти изменения были внесены в будущие базы данных клиентов, их нужно включить в процесс подготовки. Изучена этой проблемы в [схемы управления учебника](saas-tenancy-schema-management.md).

#### <a name="scripts"></a>Сценарии

Скрипты инициализации клиента в этом учебнике поддерживает оба из следующих сценариев:
- Подготовка клиента в существующей базе данных совместно с другими клиентами.
- Подготовка клиента в собственную базу данных.

Данные клиента затем инициализируются и регистрируются в карте сегментов каталога. В примере приложения баз данных, содержащих несколько клиентов, получают общее имя, например *tenants1* или *tenants2*. Базы данных, содержащие один клиент, получают имя клиента. Определенные соглашения об именовании, используемые в примере, не являются критически важным требованием для шаблона, так как благодаря применению каталога базе данных можно присвоить любое имя.  

<a name="goto_1_tutorial"/>

## <a name="tutorial-begins"></a>Начинает учебника

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * подготавливать клиента в мультитенантной базе данных;
> * подготавливать клиента в однотенантной базе данных;
> * подготавливать пакет клиентов в мультитенантной и однотенантной базе данных;
> * регистрировать сопоставление баз данных и клиентов в каталоге.

#### <a name="prerequisites"></a>Технические условия

Для работы с этим руководством выполните следующие предварительные требования:

- Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

- Разверните приложение SaaS-приложение Wingtip Tickets c мультитенантной БД. Вы можете развернуть его менее чем за пять минут, используя инструкцию из статьи [Deploy and explore a sharded multi-tenant application that uses Azure SQL Database](saas-multitenantdb-get-started-deploy.md) (Развертывание и изучение сегментированного мультитенантного приложения, использующего Базу данных SQL Azure).

- Получите Wingtip скрипты и исходный код:
    - Сценарии для приложения SaaS Wingtip Tickets c мультитенантной базой данных и исходный код этого приложения вы найдете в репозитории GitHub [WingtipTicketsSaaS-MultitenantDB](https://github.com/microsoft/WingtipTicketsSaaS-MultiTenantDB).
    - В разделе [Общие рекомендации](saas-tenancy-wingtip-app-guidance-tips.md) для действия для загрузки и разблокировать сценарии Wingtip. 

## <a name="provision-a-tenant-into-a-database-shared-with-other-tenants"></a>Подготовка клиента в базу данных *общего* совместно с другими клиентами

В этом разделе просмотреть список основных действий для подготовки, производимые с помощью сценариев PowerShell. Затем можно использовать отладчик интегрированной среды Сценариев PowerShell осуществлять пошаговое выполнение, чтобы увидеть действия в коде.

#### <a name="major-actions-of-provisioning"></a>Основные действия подготовки

Ниже приведены основные этапы рабочего процесса подготовки.

- **Вычислить новый ключ клиента**: хэш-функции используется для создания ключа клиента от имени клиента.
- **Проверьте, существует ли ключ клиента**: каталог будет проверен на соответствие ключ еще не зарегистрирован.
- **Инициализация клиента в базе данных клиента по умолчанию**: базы данных клиента обновляется путем добавления новых данных клиента.  
- **Регистрация клиента в каталоге**: сопоставление новый ключ клиента и существующей базы данных tenants1 добавляется в каталог. 
- **Добавление имени клиента в таблицу расширения каталога**: имя проведения добавляется к таблице клиентов в каталоге.  Это дополнение показано, как база данных каталога может быть расширен для поддержки дополнительных данных приложения.
- **Откройте страницу событий для нового клиента**: *Bushwillow синего* события страница откроется в браузере.

   ![events](media/saas-multitenantdb-provision-and-catalog/bushwillow.png)

#### <a name="debugger-steps"></a>Отладчик действия

Чтобы понять, как приложения Wingtip реализует новый клиент подготовки в общей базе данных, добавьте точку останова и пошаговое выполнение рабочего процесса:

1. В *интегрированной среде сценариев PowerShell* откройте файл …\\Learning Modules\\ProvisionTenants\\*Demo-ProvisionTenants.ps1* и задайте следующие параметры.
   - **$TenantName** = **Bushwillow Blues** — имя нового места проведения.
   - **$VenueType** = **синего**, один из предварительно определенных проведения типов: синего, classicalmusic, танец, jazz, judo, motorracing, многоцелевых, opera, rockmusic, футбольной (нижнего регистра, без пробелов).
   - **$DemoScenario** = **1**, для подготовки клиента в общей базе данных с другими клиентами.

2. Добавьте точку останова, поместив курсор в любом месте в строке 38 строки с текстом: *клиента New "*, а затем нажмите клавишу **F9**.

   ![точка останова](media/saas-multitenantdb-provision-and-catalog/breakpoint.png)

3. Запустите скрипт, нажав клавишу **F5**.

4. После остановки выполнения скрипта в точке останова нажмите клавишу **F11**, чтобы пошагово выполнить код.

   ![debug](media/saas-multitenantdb-provision-and-catalog/debug.png)

5. Отслеживайте выполнение скрипта и используйте клавиши **F10** и **F11** (меню **Отладка**), чтобы обойти вызываемые функции или перейти в них по очереди.

Дополнительные сведения об отладке сценариев PowerShell см. в разделе [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise).

## <a name="provision-a-tenant-in-its-own-database"></a>Подготовка клиента в его *собственной* базы данных

#### <a name="major-actions-of-provisioning"></a>Основные действия подготовки

Ниже приведены основные этапы рабочего процесса при трассировке скрипта.

- **Вычислить новый ключ клиента**: хэш-функции используется для создания ключа клиента от имени клиента.
- **Проверьте, существует ли ключ клиента**: каталог будет проверен на соответствие ключ еще не зарегистрирован.
- **Создание новой базы данных клиента**: база данных создается путем копирования *basetenantdb* базы данных с помощью шаблона диспетчера ресурсов.  Имя новой базы данных основано на имени клиента.
- **Добавление базы данных в каталоге**: новая база данных клиента регистрируется как сегментов в каталоге.
- **Инициализация клиента в базе данных клиента по умолчанию**: базы данных клиента обновляется путем добавления новых данных клиента.  
- **Регистрация клиента в каталоге**: сопоставление между новый ключ клиента и *sequoiasoccer* базы данных добавляется в каталог.
- **Имя клиента добавляется в каталог**: имя проведения добавляется к таблице клиентов расширения в каталоге.
- **Откройте страницу событий для нового клиента**: *Sequoia футбольной* события страница откроется в браузере.

   ![events](media/saas-multitenantdb-provision-and-catalog/sequoiasoccer.png)

#### <a name="debugger-steps"></a>Отладчик действия

Продемонстрирован процесс скрипта при создании клиента в своей собственной базы данных:

1. В файле …\\Learning Modules\\ProvisionTenants\\*Demo-ProvisionTenants.ps1* задайте следующие параметры.
   - **$TenantName** = **Sequoia Soccer** — имя нового места проведения.
   - **$VenueType** = **soccer** — один из предопределенных типов мест проведения: blues, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer (строчными буквами, без пробелов).
   - **$DemoScenario** = **2**, для подготовки клиента в собственную базу данных.

2. Добавьте новую точку останова, поместив курсор в любом месте строки 57, содержащей *&&nbsp;$PSScriptRoot\New-TenantAndDatabase `*, и нажмите клавишу **F9**.

   ![точка останова](media/saas-multitenantdb-provision-and-catalog/breakpoint2.png)

3. Запустите скрипт, нажав клавишу **F5**.

4. После остановки выполнения сценария в точке останова нажмите клавишу **F11**, чтобы пошагово выполнить код.  С помощью клавиш **F10** и **F11** можно обойти функцию или перейти в нее для отслеживания выполнения.

## <a name="provision-a-batch-of-tenants"></a>Подготовка пакета клиентов

В этом упражнении подготавливается пакет из 17 клиентов. Рекомендуется подготовить этот пакет клиентов перед выполнением задач других руководств по Wingtip Tickets, чтобы вы могли работать с большим количеством баз данных.

1. В *интегрированной среде сценариев PowerShell* откройте файл …\\Learning Modules\\ProvisionTenants\\*Demo-ProvisionTenants.ps1* и измените значение параметра *$DemoScenario* на 4.
   - **$DemoScenario** = **4**, для подготовки пакета клиенты в общей базе данных.

2. Нажмите клавишу **F5** для запуска скрипта.

### <a name="verify-the-deployed-set-of-tenants"></a>Проверка развернутого набора клиентов 

На этом этапе у вас есть клиенты в общей базе данных и клиентов, развернутых в своих собственных баз данных. С помощью портала Azure можно просмотреть созданные базы данных. На [портале Azure](https://portal.azure.com) откройте сервер **tenants1-mt-\<Пользователь\>**, перейдя к списку серверов SQL.  Список **баз данных SQL** должен включать общую базу данных **tenants1** и базы данных для клиентов, которые расположены в собственных базах данных.

   ![список баз данных](media/saas-multitenantdb-provision-and-catalog/Databases.png)

Хотя на портале Azure отображаются базы данных клиентов, вы не можете просмотреть клиенты *внутри* общих баз данных. Полный список клиентов, которые можно увидеть в **концентратора событий** Wingtip и перейдя в каталоге веб-страницы.

#### <a name="using-wingtip-tickets-events-hub-page"></a>С помощью страницы концентратора событий Wingtip билетов

Откройте страницу концентратора событий в браузере (http:events.wingtip-mt.\<Пользователь\>.trafficmanager.net).  

#### <a name="using-catalog-database"></a>С помощью базы данных каталога

Полный список клиентов и для каждой соответствующей базы данных доступен в каталоге. Представление SQL — при условии, что соединения имя клиента, имя базы данных. Представление хорошо показано значение расширение метаданных, который хранится в каталоге.
- Представление SQL в базе данных tenantcatalog.
- Имя клиента хранится в таблице клиентов.
- Имя базы данных хранятся в таблицах управления сегментами.

1. В SQL Server Management Studio (SSMS), соединиться с сервером клиентам в **каталога-машинного перевода.\<пользователя\>. database.windows.net**, с именем входа = **разработчика**и пароль =**P@ssword1**

    ![Диалоговое окно подключения SSMS](media/saas-multitenantdb-provision-and-catalog/SSMSConnection.png)

2. В обозревателе объектов SSMS, перейдите к представлениям в *tenantcatalog* базы данных.

3. Щелкните правой кнопкой мыши представление *TenantsExtended* и выберите **Select Top 1000 Rows** (Выбрать первые 1000 строк). Обратите внимание на сопоставление имени клиента и базы данных для разных клиентов.

    ![Представление ExtendedTenants в SSMS](media/saas-multitenantdb-provision-and-catalog/extendedtenantsview.png)
      
## <a name="other-provisioning-patterns"></a>Другие шаблоны подготовки

В этом разделе рассматриваются другие интересные подготовки модели.

#### <a name="pre-provisioning-databases-in-elastic-pools"></a>Предварительно подготовка баз данных в пулах эластичных БД

В шаблоне предварительной подготовки учитывается тот факт, что при использовании эластичных пулов счета выставляются за пулы, а не за базы данных. Таким образом, можно добавить базы данных в эластичный пул до того, как они понадобятся, чтобы избежать лишних расходов. Это предварительно администрирования многочисленного парка значительно уменьшает время, необходимое для подготовки клиента в базе данных. Вы можете заранее подготовить любое удобное количество баз данных, чтобы поддерживать буфер достаточного размера для ожидаемого темпа добавления клиентов.

#### <a name="auto-provisioning"></a>Автоматическую подготовку

В шаблоне автоматическую подготовку выделенной подготовки службы используется для подготовки серверов, пулы и баз данных автоматически при необходимости. Автоматизация включает предварительно подготовку баз данных в пулах эластичных БД. И если вывода из эксплуатации, удалении баз данных пропуски, это создает в пулах эластичных БД может заполняться подготовки службы в случае необходимости.

Этот тип автоматические службы может быть простыми или сложными. Например автоматизации может обрабатывать подготовки в нескольких географических регионов и настроить георепликацию для аварийного восстановления. С шаблоном автоматическую подготовку клиентское приложение или скрипт может отправить запрос на инициализацию в очередь для обработки инициализации службы. Скрипт будет затем опроса для обнаружения завершения. При использовании предварительной подготовки запросов обрабатывается быстро, во время фоновой службы будет управлять подготовки заменяющей базы данных.

## <a name="additional-resources"></a>Дополнительные ресурсы

<!-- - Additional [tutorials that build upon the Wingtip SaaS application](saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials)-->
- [Клиентская библиотека эластичной базы данных](sql-database-elastic-database-client-library.md)
- [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise)


## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * Подготовка нового клиента в общей мультитенантной базе данных и в собственной базе данных.
> * Подготовка пакета дополнительных клиентов.
> * Получение сведений о подготовке клиентов и их регистрация в каталоге.

Ознакомьтесь с [руководством по мониторингу производительности](saas-multitenantdb-performance-monitoring.md).


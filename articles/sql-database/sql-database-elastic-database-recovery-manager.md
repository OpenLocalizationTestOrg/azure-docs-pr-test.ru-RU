---
title: "aaaUsing сегментов toofix диспетчера восстановления сопоставить проблемы | Документы Microsoft"
description: "Используйте hello RecoveryManager класса toosolve проблемы с картами сегментов"
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: 2218fb15122f1df466e65483480461e366317f2f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="using-hello-recoverymanager-class-toofix-shard-map-problems"></a><span data-ttu-id="1c148-103">С помощью карты проблем сегментов toofix hello RecoveryManager классов</span><span class="sxs-lookup"><span data-stu-id="1c148-103">Using hello RecoveryManager class toofix shard map problems</span></span>
<span data-ttu-id="1c148-104">Hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) класс предоставляет приложений ADO.Net tooeasily hello возможность обнаружить и исправить все несоответствия между hello сегментов глобальной карты (GSM) и карты сегментов локальной hello (LSM) в среде сегментированной базы данных.</span><span class="sxs-lookup"><span data-stu-id="1c148-104">hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications hello ability tooeasily detect and correct any inconsistencies between hello global shard map (GSM) and hello local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="1c148-105">Hello GSM и LSM отслеживания hello сопоставление каждой базы данных в сегментированных среде.</span><span class="sxs-lookup"><span data-stu-id="1c148-105">hello GSM and LSM track hello mapping of each database in a sharded environment.</span></span> <span data-ttu-id="1c148-106">В некоторых случаях между hello GSM и hello LSM возникновении прерывания.</span><span class="sxs-lookup"><span data-stu-id="1c148-106">Occasionally, a break occurs between hello GSM and hello LSM.</span></span> <span data-ttu-id="1c148-107">В этом случае используйте toodetect класса RecoveryManager hello и восстановить hello break.</span><span class="sxs-lookup"><span data-stu-id="1c148-107">In that case, use hello RecoveryManager class toodetect and repair hello break.</span></span>

<span data-ttu-id="1c148-108">Hello RecoveryManager класс является частью hello [клиентской библиотеке эластичной базы данных](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="1c148-108">hello RecoveryManager class is part of hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Карта сегментов][1]

<span data-ttu-id="1c148-110">Определения терминов см. в статье [Глоссарий по средствам работы с эластичными базами данных](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="1c148-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="1c148-111">как hello toounderstand **ShardMapManager** — это данные, используемые toomanage в решении сегментирования, в разделе [управления карты сегментов](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="1c148-111">toounderstand how hello **ShardMapManager** is used toomanage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-hello-recovery-manager"></a><span data-ttu-id="1c148-112">Зачем использовать hello диспетчера восстановления?</span><span class="sxs-lookup"><span data-stu-id="1c148-112">Why use hello recovery manager?</span></span>
<span data-ttu-id="1c148-113">В среде сегментированной базы данных на каждую базу данных приходится по одному клиенту и на каждый сервер — по несколько баз данных.</span><span class="sxs-lookup"><span data-stu-id="1c148-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="1c148-114">Может существовать несколько серверов в среде hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-114">There can also be many servers in hello environment.</span></span> <span data-ttu-id="1c148-115">Каждая база данных определено в hello карта сегментов, так, чтобы вызовы перенаправленное toohello нужный сервер и базу данных.</span><span class="sxs-lookup"><span data-stu-id="1c148-115">Each database is mapped in hello shard map, so calls can be routed toohello correct server and database.</span></span> <span data-ttu-id="1c148-116">Базы данных, отслеживаются в соответствии с tooa **ключа сегментирования**, и назначить каждый сегмент **диапазон значений ключа**.</span><span class="sxs-lookup"><span data-stu-id="1c148-116">Databases are tracked according tooa **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="1c148-117">Например ключ сегментирования может представлять hello имена заказчиков из «D» слишком «F.»</span><span class="sxs-lookup"><span data-stu-id="1c148-117">For example, a sharding key may represent hello customer names from "D" too"F."</span></span> <span data-ttu-id="1c148-118">Здравствуйте, сопоставление всех сегментов (также называемого баз данных) и их диапазоны сопоставления содержатся в hello **сегментов глобальной карты (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="1c148-118">hello mapping of all shards (aka databases) and their mapping ranges are contained in hello **global shard map (GSM)**.</span></span> <span data-ttu-id="1c148-119">Каждая база данных также содержит сопоставления диапазонов hello, содержащиеся на hello сегментов, известный как hello **карты локальной сегментов (LSM)**.</span><span class="sxs-lookup"><span data-stu-id="1c148-119">Each database also contains a map of hello ranges contained on hello shard that is known as hello **local shard map (LSM)**.</span></span> <span data-ttu-id="1c148-120">Когда приложение подключается tooa сегментов, сопоставление hello кэшируется приложение hello для быстрого извлечения.</span><span class="sxs-lookup"><span data-stu-id="1c148-120">When an app connects tooa shard, hello mapping is cached with hello app for quick retrieval.</span></span> <span data-ttu-id="1c148-121">Hello LSM — используется toovalidate кэшированные данные.</span><span class="sxs-lookup"><span data-stu-id="1c148-121">hello LSM is used toovalidate cached data.</span></span> 

<span data-ttu-id="1c148-122">Hello GSM и LSM могут стать синхронизированы для hello следующих причин:</span><span class="sxs-lookup"><span data-stu-id="1c148-122">hello GSM and LSM may become out of sync for hello following reasons:</span></span>

1. <span data-ttu-id="1c148-123">Удаление Hello сегментов, чей диапазон считается toono больше времени, быть используется или переименование сегментом.</span><span class="sxs-lookup"><span data-stu-id="1c148-123">hello deletion of a shard whose range is believed toono longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="1c148-124">Удаление сегмента приводит к **потере сопоставления сегментов**.</span><span class="sxs-lookup"><span data-stu-id="1c148-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="1c148-125">Переименование базы данных точно так же может привести к потере сопоставления сегментов.</span><span class="sxs-lookup"><span data-stu-id="1c148-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="1c148-126">В зависимости от hello целью изменения hello hello сегментов может потребоваться удалить toobe или расположение сегментов hello должно toobe обновлены.</span><span class="sxs-lookup"><span data-stu-id="1c148-126">Depending on hello intent of hello change, hello shard may need toobe removed or hello shard location needs toobe updated.</span></span> <span data-ttu-id="1c148-127">toorecover удаленной базы данных, в разделе [Восстановление удаленной базы данных](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="1c148-127">toorecover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="1c148-128">Происходит событие географической отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="1c148-128">A geo-failover event occurs.</span></span> <span data-ttu-id="1c148-129">toocontinue, один необходимо обновить hello имя сервера и имя базы данных диспетчера карты сегментов в приложение hello, а затем сведения о сопоставлении сегментов hello обновления для всех сегментов в карте сегментов.</span><span class="sxs-lookup"><span data-stu-id="1c148-129">toocontinue, one must update hello server name, and database name of shard map manager in hello application and then update hello shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="1c148-130">Если географическая отработка отказа, такую логику восстановления следует автоматизировать в рабочем процессе отработки отказа hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-130">If there is a geo-failover, such recovery logic should be automated within hello failover workflow.</span></span> <span data-ttu-id="1c148-131">Автоматизация действий по восстановлению гарантирует удобную управляемость для баз данных с поддержкой определения географического расположения и позволяет избежать выполнение действий пользователем вручную.</span><span class="sxs-lookup"><span data-stu-id="1c148-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="1c148-132">toolearn о toorecover параметры базы данных при наличии сбоя центра обработки данных. в разделе [непрерывности](sql-database-business-continuity.md) и [аварийного восстановления](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="1c148-132">toolearn about options toorecover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="1c148-133">Hello или сегментов ShardMapManager базы данных является восстановленной tooan ранее на момент времени.</span><span class="sxs-lookup"><span data-stu-id="1c148-133">Either a shard or hello ShardMapManager database is restored tooan earlier point-in time.</span></span> <span data-ttu-id="1c148-134">toolearn о моменту времени восстановления, использование резервных копий, в разделе [восстановление резервных копий с помощью](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="1c148-134">toolearn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="1c148-135">Дополнительные сведения о инструментов эластичной базы данных базы данных SQL Azure, георепликация и восстановление см. в следующем hello:</span><span class="sxs-lookup"><span data-stu-id="1c148-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see hello following:</span></span> 

* [<span data-ttu-id="1c148-136">Обзор. Непрерывность облачных бизнес-процессов и аварийное восстановление баз данных с базой данных SQL</span><span class="sxs-lookup"><span data-stu-id="1c148-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="1c148-137">Приступая к работе с инструментами эластичной базы данных</span><span class="sxs-lookup"><span data-stu-id="1c148-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="1c148-138">Управление ShardMap</span><span class="sxs-lookup"><span data-stu-id="1c148-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="1c148-139">Извлечение RecoveryManager из ShardMapManager</span><span class="sxs-lookup"><span data-stu-id="1c148-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="1c148-140">Hello первым шагом является toocreate экземпляра RecoveryManager.</span><span class="sxs-lookup"><span data-stu-id="1c148-140">hello first step is toocreate a RecoveryManager instance.</span></span> <span data-ttu-id="1c148-141">Hello [метод GetRecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) возвращает hello диспетчера восстановления для текущего hello [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) экземпляра.</span><span class="sxs-lookup"><span data-stu-id="1c148-141">hello [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns hello recovery manager for hello current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="1c148-142">сопоставить несогласованностей в сегменте hello tooaddress, сначала необходимо получить hello RecoveryManager для hello определенного сегмента карты.</span><span class="sxs-lookup"><span data-stu-id="1c148-142">tooaddress any inconsistencies in hello shard map, you must first retrieve hello RecoveryManager for hello particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="1c148-143">В этом примере инициализируется hello RecoveryManager hello ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="1c148-143">In this example, hello RecoveryManager is initialized from hello ShardMapManager.</span></span> <span data-ttu-id="1c148-144">Hello ShardMapManager, содержащий ShardMap также уже инициализирован.</span><span class="sxs-lookup"><span data-stu-id="1c148-144">hello ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="1c148-145">Так как этот код приложения управляет hello саму карту сегментов, hello учетные данные, используемые в методе фабрики hello (в предыдущих примере hello smmConnectionString) должны быть учетные данные, имеющие разрешения на чтение запись в базе данных GSM hello, ссылается hello Строка подключения.</span><span class="sxs-lookup"><span data-stu-id="1c148-145">Since this application code manipulates hello shard map itself, hello credentials used in hello factory method (in hello preceding example, smmConnectionString) should be credentials that have read-write permissions on hello GSM database referenced by hello connection string.</span></span> <span data-ttu-id="1c148-146">Обычно эти учетные данные отличаются от соединений tooopen учетные данные, используемые для маршрутизации в зависимости от данных.</span><span class="sxs-lookup"><span data-stu-id="1c148-146">These credentials are typically different from credentials used tooopen connections for data-dependent routing.</span></span> <span data-ttu-id="1c148-147">Дополнительные сведения см. в разделе [с использованием учетных данных в клиенте hello эластичной базы данных](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="1c148-147">For more information, see [Using credentials in hello elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-hello-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="1c148-148">Снятие hello ShardMap тот или иной сегмент после удаления сегментов</span><span class="sxs-lookup"><span data-stu-id="1c148-148">Removing a shard from hello ShardMap after a shard is deleted</span></span>
<span data-ttu-id="1c148-149">Hello [DetachShard метод](https://msdn.microsoft.com/library/azure/dn842083.aspx) отсоединяет hello даны сегментов карты сегментов hello и удаляет сопоставления, связанные с сегментом hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-149">hello [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches hello given shard from hello shard map and deletes mappings associated with hello shard.</span></span>  

* <span data-ttu-id="1c148-150">Параметр расположения Hello — расположение сегментов hello, в частности имя сервера и имя базы данных, сегментов hello и после отключения.</span><span class="sxs-lookup"><span data-stu-id="1c148-150">hello location parameter is hello shard location, specifically server name and database name, of hello shard being detached.</span></span> 
* <span data-ttu-id="1c148-151">параметр shardMapName Hello является имя сопоставления сегментов hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-151">hello shardMapName parameter is hello shard map name.</span></span> <span data-ttu-id="1c148-152">Это только требуется, если несколько карт сегментов управляются hello же диспетчера карты сегментов.</span><span class="sxs-lookup"><span data-stu-id="1c148-152">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="1c148-153">необязательный параметр.</span><span class="sxs-lookup"><span data-stu-id="1c148-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="1c148-154">Этот способ следует используйте только в том случае, если вы уверены, что hello диапазона для hello обновить сопоставление является пустым.</span><span class="sxs-lookup"><span data-stu-id="1c148-154">Use this technique only if you are certain that hello range for hello updated mapping is empty.</span></span> <span data-ttu-id="1c148-155">выше методов Hello не проверять данные для перемещения диапазона hello, поэтому лучше tooinclude проверяет в коде.</span><span class="sxs-lookup"><span data-stu-id="1c148-155">hello methods above do not check data for hello range being moved, so it is best tooinclude checks in your code.</span></span>
>

<span data-ttu-id="1c148-156">Этот пример удаляет сегменты из карты сегментов hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-156">This example removes shards from hello shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="1c148-157">карта сегментов Hello отражает расположение сегментов hello в hello GSM перед удалением hello hello сегментов.</span><span class="sxs-lookup"><span data-stu-id="1c148-157">hello shard map reflects hello shard location in hello GSM before hello deletion of hello shard.</span></span> <span data-ttu-id="1c148-158">Из-за удаления сегментов hello, предполагается, что это было намеренное действие, и диапазон ключа сегментирования hello больше не используется.</span><span class="sxs-lookup"><span data-stu-id="1c148-158">Because hello shard was deleted, it is assumed this was intentional, and hello sharding key range is no longer in use.</span></span> <span data-ttu-id="1c148-159">Если это не так, можно выполнить восстановление до точки во времени,</span><span class="sxs-lookup"><span data-stu-id="1c148-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="1c148-160">Сегмент hello toorecover из более ранней точке времени.</span><span class="sxs-lookup"><span data-stu-id="1c148-160">toorecover hello shard from an earlier point-in-time.</span></span> <span data-ttu-id="1c148-161">(В этом случае просмотрите следующий раздел toodetect сегментов несоответствия hello). toorecover, в разделе [моменту времени восстановления](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="1c148-161">(In that case, review hello following section toodetect shard inconsistencies.) toorecover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="1c148-162">Так, как предполагалось, что hello удаления баз данных было намеренное действие, hello действий административных завершающих — toodelete hello запись toohello сегментов в hello диспетчера карты сегментов.</span><span class="sxs-lookup"><span data-stu-id="1c148-162">Since it is assumed hello database deletion was intentional, hello final administrative cleanup action is toodelete hello entry toohello shard in hello shard map manager.</span></span> <span data-ttu-id="1c148-163">Это предотвращает приложения hello из случайная запись сведения tooa диапазон, который не ожидается.</span><span class="sxs-lookup"><span data-stu-id="1c148-163">This prevents hello application from inadvertently writing information tooa range that is not expected.</span></span>

## <a name="toodetect-mapping-differences"></a><span data-ttu-id="1c148-164">различия toodetect сопоставления</span><span class="sxs-lookup"><span data-stu-id="1c148-164">toodetect mapping differences</span></span>
<span data-ttu-id="1c148-165">Hello [DetectMappingDifferences метод](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) выбирает и возвращает одно из карт сегментов hello (локальных или глобальных) как источник достоверных hello и согласовывает сопоставления на обе карты сегментов (GSM и LSM).</span><span class="sxs-lookup"><span data-stu-id="1c148-165">hello [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="1c148-166">Hello *расположение* hello имя сервера и имя базы данных.</span><span class="sxs-lookup"><span data-stu-id="1c148-166">hello *location* specifies hello server name and database name.</span></span> 
* <span data-ttu-id="1c148-167">Hello *shardMapName* параметр является имя сопоставления сегментов hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-167">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="1c148-168">Это только требуется, если несколько карт сегментов управляются hello же диспетчера карты сегментов.</span><span class="sxs-lookup"><span data-stu-id="1c148-168">This is only required if multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="1c148-169">необязательный параметр.</span><span class="sxs-lookup"><span data-stu-id="1c148-169">Optional.</span></span> 

## <a name="tooresolve-mapping-differences"></a><span data-ttu-id="1c148-170">различия tooresolve сопоставления</span><span class="sxs-lookup"><span data-stu-id="1c148-170">tooresolve mapping differences</span></span>
<span data-ttu-id="1c148-171">Hello [ResolveMappingDifferences метод](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) выбирает одну из карт сегментов hello (локальных или глобальных) как источник достоверных hello и согласовывает сопоставления на обе карты сегментов (GSM и LSM).</span><span class="sxs-lookup"><span data-stu-id="1c148-171">hello [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="1c148-172">Hello *RecoveryToken* параметр перечисляет hello различия в сопоставлениях hello hello GSM и hello LSM для конкретных сегментов hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-172">hello *RecoveryToken* parameter enumerates hello differences in hello mappings between hello GSM and hello LSM for hello specific shard.</span></span> 
* <span data-ttu-id="1c148-173">Hello [MappingDifferenceResolution перечисления](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) — метод hello tooindicate используется для разрешения hello различие между hello сопоставления сегментов.</span><span class="sxs-lookup"><span data-stu-id="1c148-173">hello [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used tooindicate hello method for resolving hello difference between hello shard mappings.</span></span> 
* <span data-ttu-id="1c148-174">**MappingDifferenceResolution.KeepShardMapping** рекомендуется, когда hello LSM содержит точное сопоставление hello и поэтому должны использоваться сопоставление hello в сегменте hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when hello LSM contains hello accurate mapping and therefore hello mapping in hello shard should be used.</span></span> <span data-ttu-id="1c148-175">Это обычно hello так, если происходит переход: hello сегмент теперь находится на новом сервере.</span><span class="sxs-lookup"><span data-stu-id="1c148-175">This is typically hello case if there is a failover: hello shard now resides on a new server.</span></span> <span data-ttu-id="1c148-176">Поскольку сегментов hello сначала должны быть удалены из hello GSM (с помощью метода RecoveryManager.DetachShard hello), сопоставление больше не существует в hello GSM.</span><span class="sxs-lookup"><span data-stu-id="1c148-176">Since hello shard must first be removed from hello GSM (using hello RecoveryManager.DetachShard method), a mapping no longer exists on hello GSM.</span></span> <span data-ttu-id="1c148-177">Поэтому hello LSM должен быть используется toore-Установка hello сопоставления сегментов.</span><span class="sxs-lookup"><span data-stu-id="1c148-177">Therefore, hello LSM must be used toore-establish hello shard mapping.</span></span>

## <a name="attach-a-shard-toohello-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="1c148-178">Присоединение сегментов toohello ShardMap после восстановления сегментом</span><span class="sxs-lookup"><span data-stu-id="1c148-178">Attach a shard toohello ShardMap after a shard is restored</span></span>
<span data-ttu-id="1c148-179">Hello [AttachShard метод](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) присоединяет hello карта сегментов toohello данного сегмента.</span><span class="sxs-lookup"><span data-stu-id="1c148-179">hello [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches hello given shard toohello shard map.</span></span> <span data-ttu-id="1c148-180">Он обнаруживает несогласованностей карты сегментов и обновляет hello сопоставления toomatch hello сегментов в точке восстановления сегментов hello hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-180">It then detects any shard map inconsistencies and updates hello mappings toomatch hello shard at hello point of hello shard restoration.</span></span> <span data-ttu-id="1c148-181">Предполагается, что hello базы данных также переименованный tooreflect hello исходное имя базы данных (до была восстановлена hello сегментов), с момента восстановления на момент времени hello по умолчанию tooa дополненная hello timestamp новой базы данных.</span><span class="sxs-lookup"><span data-stu-id="1c148-181">It is assumed that hello database is also renamed tooreflect hello original database name (before hello shard was restored), since hello point-in time restoration defaults tooa new database appended with hello timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="1c148-182">Hello *расположение* параметр является hello имя сервера и имя базы данных, сегментов hello и присоединения.</span><span class="sxs-lookup"><span data-stu-id="1c148-182">hello *location* parameter is hello server name and database name, of hello shard being attached.</span></span> 
* <span data-ttu-id="1c148-183">Hello *shardMapName* параметр является имя сопоставления сегментов hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-183">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="1c148-184">Это только требуется, если несколько карт сегментов управляются hello же диспетчера карты сегментов.</span><span class="sxs-lookup"><span data-stu-id="1c148-184">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="1c148-185">необязательный параметр.</span><span class="sxs-lookup"><span data-stu-id="1c148-185">Optional.</span></span> 

<span data-ttu-id="1c148-186">В этом примере добавляется карта сегментов toohello сегментов, был недавно восстановлен из более ранних на момент времени.</span><span class="sxs-lookup"><span data-stu-id="1c148-186">This example adds a shard toohello shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="1c148-187">Поскольку восстановила приветствия сегментов (а именно: hello сопоставления для сегмента hello в hello LSM) потенциально несовместим с записью сегментов hello в hello GSM.</span><span class="sxs-lookup"><span data-stu-id="1c148-187">Since hello shard (namely hello mapping for hello shard in hello LSM) has been restored, it is potentially inconsistent with hello shard entry in hello GSM.</span></span> <span data-ttu-id="1c148-188">За пределами этот пример кода hello сегментов была восстановлена и переименовывается toohello исходное имя базы данных hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-188">Outside of this example code, hello shard was restored and renamed toohello original name of hello database.</span></span> <span data-ttu-id="1c148-189">Так как она была восстановлена, предполагается, что сопоставление hello в hello LSM является доверенным сопоставления hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-189">Since it was restored, it is assumed hello mapping in hello LSM is hello trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-hello-shards"></a><span data-ttu-id="1c148-190">Обновление расположения сегментов после выполнена географическая отработка отказа (восстановление) hello сегментов</span><span class="sxs-lookup"><span data-stu-id="1c148-190">Updating shard locations after a geo-failover (restore) of hello shards</span></span>
<span data-ttu-id="1c148-191">В случае географическая отработка отказа базы данных-получателя hello не будет доступна запись и становится новой первичной базы данных hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-191">If there is a geo-failover, hello secondary database is made write accessible and becomes hello new primary database.</span></span> <span data-ttu-id="1c148-192">Здравствуйте, имя сервера hello и, потенциально, hello базы данных (в зависимости от настройки), может отличаться от исходного основного hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-192">hello name of hello server, and potentially hello database (depending on your configuration), may be different from hello original primary.</span></span> <span data-ttu-id="1c148-193">Поэтому hello записи сопоставления для сегментов hello в hello GSM и LSM должны быть исправлены.</span><span class="sxs-lookup"><span data-stu-id="1c148-193">Therefore hello mapping entries for hello shard in hello GSM and LSM must be fixed.</span></span> <span data-ttu-id="1c148-194">Аналогичным образом, если hello базы данных будет восстановленной tooa другое имя или расположение или tooan более раннего момента времени, это может привести к несогласованности в картах сегментов hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-194">Similarly, if hello database is restored tooa different name or location, or tooan earlier point in time, this might cause inconsistencies in hello shard maps.</span></span> <span data-ttu-id="1c148-195">Hello диспетчера карты сегментов обрабатывает hello распределение нужную базу данных toohello открытых соединений.</span><span class="sxs-lookup"><span data-stu-id="1c148-195">hello Shard Map Manager handles hello distribution of open connections toohello correct database.</span></span> <span data-ttu-id="1c148-196">Распределение основывается на данных hello в карте сегментов hello и hello значение ключа сегментирования hello, который является целевым объектом hello запроса приложения hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-196">Distribution is based on hello data in hello shard map and hello value of hello sharding key that is hello target of hello applications request.</span></span> <span data-ttu-id="1c148-197">После выполнена географическая отработка отказа необходимо обновить эти сведения с точным имя_сервера hello, имя базы данных и сопоставления сегментов hello восстановленной базы данных.</span><span class="sxs-lookup"><span data-stu-id="1c148-197">After a geo-failover, this information must be updated with hello accurate server name, database name and shard mapping of hello recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="1c148-198">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="1c148-198">Best practices</span></span>
<span data-ttu-id="1c148-199">Географическая отработка отказа и восстановления являются операциями, обычно управляется администратором облачные приложения hello намеренно использование одной из функций обеспечения непрерывности бизнеса баз данных SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="1c148-199">Geo-failover and recovery are operations typically managed by a cloud administrator of hello application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="1c148-200">Для планирования непрерывности бизнеса требуется процессы, процедуры и меры tooensure, бизнес-операции можно продолжить работу без прерывания.</span><span class="sxs-lookup"><span data-stu-id="1c148-200">Business continuity planning requires processes, procedures, and measures tooensure that business operations can continue without interruption.</span></span> <span data-ttu-id="1c148-201">Здравствуйте, методы доступны как часть hello RecoveryManager класса следует использовать в рамках этого рабочего потока tooensure hello GSM и LSM постоянно обновляются в зависимости от действий восстановления hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-201">hello methods available as part of hello RecoveryManager class should be used within this work flow tooensure hello GSM and LSM are kept up-to-date based on hello recovery action taken.</span></span> <span data-ttu-id="1c148-202">Существует пять простых шагов tooproperly, обеспечивая hello GSM и LSM отражают hello точной информации после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="1c148-202">There are five basic steps tooproperly ensuring hello GSM and LSM reflect hello accurate information after a failover event.</span></span> <span data-ttu-id="1c148-203">Здравствуйте, tooexecute код приложения, эти действия могут быть интегрированы в существующих средств и рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="1c148-203">hello application code tooexecute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="1c148-204">Получить hello RecoveryManager из hello ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="1c148-204">Retrieve hello RecoveryManager from hello ShardMapManager.</span></span> 
2. <span data-ttu-id="1c148-205">Отсоедините hello старый сегмент из карты сегментов hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-205">Detach hello old shard from hello shard map.</span></span>
3. <span data-ttu-id="1c148-206">Присоедините hello новых сегментов toohello карта сегментов, включая hello новое расположение сегментов.</span><span class="sxs-lookup"><span data-stu-id="1c148-206">Attach hello new shard toohello shard map, including hello new shard location.</span></span>
4. <span data-ttu-id="1c148-207">Обнаружены несоответствия в сопоставление hello GSM и LSM hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-207">Detect inconsistencies in hello mapping between hello GSM and LSM.</span></span> 
5. <span data-ttu-id="1c148-208">Устраните различия между hello GSM и hello LSM, доверяющих hello LSM.</span><span class="sxs-lookup"><span data-stu-id="1c148-208">Resolve differences between hello GSM and hello LSM, trusting hello LSM.</span></span> 

<span data-ttu-id="1c148-209">В этом примере выполняет следующие шаги hello.</span><span class="sxs-lookup"><span data-stu-id="1c148-209">This example performs hello following steps:</span></span>

1. <span data-ttu-id="1c148-210">Удаляет сегменты из hello карта сегментов, с учетом расположения сегментов перед hello отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="1c148-210">Removes shards from hello Shard Map that reflect shard locations before hello failover event.</span></span>
2. <span data-ttu-id="1c148-211">Присоединяет сегментов toohello карта сегментов отражающей hello новых сегментов ячеек (hello параметр «Configuration.SecondaryServer» является hello нового имени сервера, но hello же имя базы данных).</span><span class="sxs-lookup"><span data-stu-id="1c148-211">Attaches shards toohello Shard Map reflecting hello new shard locations (hello parameter "Configuration.SecondaryServer" is hello new server name but hello same database name).</span></span>
3. <span data-ttu-id="1c148-212">Получает маркеры восстановления hello, обнаруживая сопоставления различия между hello GSM и hello LSM для каждого сегмента.</span><span class="sxs-lookup"><span data-stu-id="1c148-212">Retrieves hello recovery tokens by detecting mapping differences between hello GSM and hello LSM for each shard.</span></span> 
4. <span data-ttu-id="1c148-213">Разрешает несоответствия hello, доверяющих сопоставление hello hello LSM для каждого сегмента.</span><span class="sxs-lookup"><span data-stu-id="1c148-213">Resolves hello inconsistencies by trusting hello mapping from hello LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png


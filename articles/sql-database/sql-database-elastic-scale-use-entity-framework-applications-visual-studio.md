---
title: "aaaUsing эластичной базы данных клиентской библиотеки с Entity Framework | Документы Microsoft"
description: "Использование клиентской библиотеки эластичной базы данных и Entity Framework для создания баз данных"
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: b9c3065b-cb92-41be-aa7f-deba23e7e159
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/06/2017
ms.author: torsteng
ms.openlocfilehash: 917f6d28d9855c0b42afe2c008613a9bbb3ec6b6
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="elastic-database-client-library-with-entity-framework"></a><span data-ttu-id="127d7-103">Использование клиентской библиотеки эластичных баз данных с Entity Framework</span><span class="sxs-lookup"><span data-stu-id="127d7-103">Elastic Database client library with Entity Framework</span></span>
<span data-ttu-id="127d7-104">В этом документе показаны изменения hello в приложении Entity Framework, которые требуется toointegrate с hello [эластичной базы данных средства](sql-database-elastic-scale-introduction.md).</span><span class="sxs-lookup"><span data-stu-id="127d7-104">This document shows hello changes in an Entity Framework application that are needed toointegrate with hello [Elastic Database tools](sql-database-elastic-scale-introduction.md).</span></span> <span data-ttu-id="127d7-105">Hello основное внимание уделяется составление [управления карты сегментов](sql-database-elastic-scale-shard-map-management.md) и [маршрутизации в зависимости от данных](sql-database-elastic-scale-data-dependent-routing.md) с Entity Framework hello **Code First** подход.</span><span class="sxs-lookup"><span data-stu-id="127d7-105">hello focus is on composing [shard map management](sql-database-elastic-scale-shard-map-management.md) and [data-dependent routing](sql-database-elastic-scale-data-dependent-routing.md) with hello Entity Framework **Code First** approach.</span></span> <span data-ttu-id="127d7-106">Hello [сначала - код новой базы данных](http://msdn.microsoft.com/data/jj193542.aspx) учебник по EF служит в качестве рабочего примера в этом документе.</span><span class="sxs-lookup"><span data-stu-id="127d7-106">hello [Code First - New Database](http://msdn.microsoft.com/data/jj193542.aspx) tutorial for EF serves as our running example throughout this document.</span></span> <span data-ttu-id="127d7-107">Образец кода Hello, сопровождающие данный документ является частью эластичной базы данных средства набор образцов для hello примеры кода Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="127d7-107">hello sample code accompanying this document is part of elastic database tools' set of samples in hello Visual Studio Code Samples.</span></span>

## <a name="downloading-and-running-hello-sample-code"></a><span data-ttu-id="127d7-108">Загрузка и запуск образца кода hello</span><span class="sxs-lookup"><span data-stu-id="127d7-108">Downloading and Running hello Sample Code</span></span>
<span data-ttu-id="127d7-109">toodownload hello код для этой статьи:</span><span class="sxs-lookup"><span data-stu-id="127d7-109">toodownload hello code for this article:</span></span>

* <span data-ttu-id="127d7-110">Требуется Visual Studio 2012 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="127d7-110">Visual Studio 2012 or later is required.</span></span> 
* <span data-ttu-id="127d7-111">Загрузите hello [эластичных БД средства для SQL Azure — пример интеграции Entity Framework](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) с MSDN.</span><span class="sxs-lookup"><span data-stu-id="127d7-111">Download hello [Elastic DB Tools for Azure SQL - Entity Framework Integration sample](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) from MSDN.</span></span> <span data-ttu-id="127d7-112">Распакуйте папку tooa образец hello по своему усмотрению.</span><span class="sxs-lookup"><span data-stu-id="127d7-112">Unzip hello sample tooa location of your choosing.</span></span>
* <span data-ttu-id="127d7-113">Запустите Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="127d7-113">Start Visual Studio.</span></span> 
* <span data-ttu-id="127d7-114">Откройте Visual Studio, выберите "Файл" -> "Открыть проект или решение".</span><span class="sxs-lookup"><span data-stu-id="127d7-114">In Visual Studio, select File -> Open Project/Solution.</span></span> 
* <span data-ttu-id="127d7-115">В hello **Открытие проекта** диалоговое окно, найдите загруженный образец toohello и выберите **EntityFrameworkCodeFirst.sln** tooopen образец hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-115">In hello **Open Project** dialog, navigate toohello sample you downloaded and select **EntityFrameworkCodeFirst.sln** tooopen hello sample.</span></span> 

<span data-ttu-id="127d7-116">Образец hello toorun, необходимые toocreate три пустых баз данных в базе данных SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="127d7-116">toorun hello sample, you need toocreate three empty databases in Azure SQL Database:</span></span>

* <span data-ttu-id="127d7-117">База данных диспетчера сопоставления сегментов</span><span class="sxs-lookup"><span data-stu-id="127d7-117">Shard Map Manager database</span></span>
* <span data-ttu-id="127d7-118">База данных сегмента 1</span><span class="sxs-lookup"><span data-stu-id="127d7-118">Shard 1 database</span></span>
* <span data-ttu-id="127d7-119">База данных сегмента 2</span><span class="sxs-lookup"><span data-stu-id="127d7-119">Shard 2 database</span></span>

<span data-ttu-id="127d7-120">После создания этих баз данных, заполните заполнителями hello в **Program.cs** имя сервера базы данных SQL Azure, hello имена баз данных и баз данных toohello tooconnect учетные данные.</span><span class="sxs-lookup"><span data-stu-id="127d7-120">Once you have created these databases, fill in hello place holders in **Program.cs** with your Azure SQL DB server name, hello database names and your credentials tooconnect toohello databases.</span></span> <span data-ttu-id="127d7-121">Выполните сборку решения hello в Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="127d7-121">Build hello solution in Visual Studio.</span></span> <span data-ttu-id="127d7-122">Visual Studio загрузит hello необходимые пакеты NuGet для hello эластичной базы данных клиентской библиотеки, Entity Framework и Transient Fault handling как часть процесса построения hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-122">Visual Studio will download hello required NuGet packages for hello elastic database client library, Entity Framework, and Transient Fault handling as part of hello build process.</span></span> <span data-ttu-id="127d7-123">Убедитесь, что для вашего решения включена функция восстановления пакетов NuGet.</span><span class="sxs-lookup"><span data-stu-id="127d7-123">Make sure that restoring NuGet packages is enabled for your solution.</span></span> <span data-ttu-id="127d7-124">Этот параметр можно включить, щелкнув hello файл решения в обозревателе решений Visual Studio hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-124">You can enable this setting by right-clicking on hello solution file in hello Visual Studio Solution Explorer.</span></span> 

## <a name="entity-framework-workflows"></a><span data-ttu-id="127d7-125">Рабочие процессы Entity Framework</span><span class="sxs-lookup"><span data-stu-id="127d7-125">Entity Framework workflows</span></span>
<span data-ttu-id="127d7-126">Entity Framework разработчики основываются на одном из следующих четырех toobuild приложений рабочих процессов и tooensure сохраняемости для объектов приложения hello:</span><span class="sxs-lookup"><span data-stu-id="127d7-126">Entity Framework developers rely on one of hello following four workflows toobuild applications and tooensure persistence for application objects:</span></span> 

* <span data-ttu-id="127d7-127">**Code First (новая база данных)**: hello EF разработчик создает модель hello в коде приложения hello и затем EF приводит к возникновению ошибки hello базы данных из него.</span><span class="sxs-lookup"><span data-stu-id="127d7-127">**Code First (New Database)**: hello EF developer creates hello model in hello application code and then EF generates hello database from it.</span></span> 
* <span data-ttu-id="127d7-128">**Code First (существующей базы данных)**: hello developer позволяет EF создание кода приложения hello hello модели из существующей базы данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-128">**Code First (Existing Database)**: hello developer lets EF generate hello application code for hello model from an existing database.</span></span>
* <span data-ttu-id="127d7-129">**Модели первого**: hello разработчик создает модель hello в конструкторе EF hello и затем EF создает hello базы данных из модели hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-129">**Model First**: hello developer creates hello model in hello EF designer and then EF creates hello database from hello model.</span></span>
* <span data-ttu-id="127d7-130">**Базы данных первой**: hello разработчик использует EF tooinfer hello модели из существующей базы данных для работы с проектами.</span><span class="sxs-lookup"><span data-stu-id="127d7-130">**Database First**: hello developer uses EF tooling tooinfer hello model from an existing database.</span></span> 

<span data-ttu-id="127d7-131">Все эти подходы полагаться на tootransparently класса DbContext hello управление подключения к базе данных и схемы базы данных для приложения.</span><span class="sxs-lookup"><span data-stu-id="127d7-131">All these approaches rely on hello DbContext class tootransparently manage database connections and database schema for an application.</span></span> <span data-ttu-id="127d7-132">Обсуждаются более подробно далее в документе hello различные конструкторы базового класса DbContext hello Разрешить разные уровни контроля над создания соединения в базе данных создания начальной загрузки и схемы.</span><span class="sxs-lookup"><span data-stu-id="127d7-132">As we will discuss in more detail later in hello document, different constructors on hello DbContext base class allow for different levels of control over connection creation, database bootstrapping and schema creation.</span></span> <span data-ttu-id="127d7-133">Проблемы возникают в первую очередь по hello факт, что управление соединениями hello базы данных, предоставляемые EF пересекается с возможность управления подключения hello hello данных зависимых маршрутизации интерфейсов, предоставляемых клиентской библиотекой hello эластичной базы данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-133">Challenges arise primarily from hello fact that hello database connection management provided by EF intersects with hello connection management capabilities of hello data dependent routing interfaces provided by hello elastic database client library.</span></span> 

## <a name="elastic-database-tools-assumptions"></a><span data-ttu-id="127d7-134">Допущения в отношении средств эластичной базы данных</span><span class="sxs-lookup"><span data-stu-id="127d7-134">Elastic database tools assumptions</span></span>
<span data-ttu-id="127d7-135">Определения терминов см. в статье [Глоссарий по средствам работы с эластичными базами данных](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="127d7-135">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span>

<span data-ttu-id="127d7-136">При использовании клиентской библиотеки эластичной базы данных данные приложения разделяются на сегменты, называемые шардлетами.</span><span class="sxs-lookup"><span data-stu-id="127d7-136">With elastic database client library, you define partitions of your application data called shardlets.</span></span> <span data-ttu-id="127d7-137">Подсегменты идентифицируются ключ сегментирования и сопоставленные toospecific баз данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-137">Shardlets are identified by a sharding key and are mapped toospecific databases.</span></span> <span data-ttu-id="127d7-138">Приложения могут содержать любое количество баз данных, при необходимости и распределить Подсегменты tooprovide hello Недостаточно емкости или производительности, заданному текущим требованиям бизнеса.</span><span class="sxs-lookup"><span data-stu-id="127d7-138">An application may have as many databases as needed and distribute hello shardlets tooprovide enough capacity or performance given current business requirements.</span></span> <span data-ttu-id="127d7-139">сопоставление Hello баз данных toohello значения ключа сегментирования хранится hello эластичной базы данных клиентские API, предоставляемые карта сегментов.</span><span class="sxs-lookup"><span data-stu-id="127d7-139">hello mapping of sharding key values toohello databases is stored by a shard map provided by hello elastic database client APIs.</span></span> <span data-ttu-id="127d7-140">Для краткости мы называем эту функцию **Shard Map Management**(Управление сопоставлениями сегментов), или SMM.</span><span class="sxs-lookup"><span data-stu-id="127d7-140">We call this capability **Shard Map Management**, or SMM for short.</span></span> <span data-ttu-id="127d7-141">карта сегментов Hello также служит в качестве hello посредника подключений к базе данных для запросов, которые используются для передачи ключа сегментирования.</span><span class="sxs-lookup"><span data-stu-id="127d7-141">hello shard map also serves as hello broker of database connections for requests that carry a sharding key.</span></span> <span data-ttu-id="127d7-142">Мы называем возможность toothis как **маршрутизации в зависимости от данных**.</span><span class="sxs-lookup"><span data-stu-id="127d7-142">We refer toothis capability as **data-dependent routing**.</span></span> 

<span data-ttu-id="127d7-143">диспетчера карты сегментов Hello помогает защитить пользователей от несогласованные представления данных подсегмента, может возникать, когда выполняются операции Подсегмент одновременных операций управления (например, перемещению данных из одного сегмента tooanother).</span><span class="sxs-lookup"><span data-stu-id="127d7-143">hello shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations (such as relocating data from one shard tooanother) are happening.</span></span> <span data-ttu-id="127d7-144">Таким образом, toodo hello карт сегментов, которые управляются hello клиента библиотеки broker hello подключения к базе данных для приложения.</span><span class="sxs-lookup"><span data-stu-id="127d7-144">toodo so, hello shard maps managed by hello client library broker hello database connections for an application.</span></span> <span data-ttu-id="127d7-145">Это позволяет hello сегментов карты функциональность tooautomatically kill подключения к базе данных при операции управления сегментов может повлиять на hello подсегмента, hello подключение будет создано для.</span><span class="sxs-lookup"><span data-stu-id="127d7-145">This allows hello shard map functionality tooautomatically kill a database connection when shard management operations could impact hello shardlet that hello connection has been created for.</span></span> <span data-ttu-id="127d7-146">Этот подход должен toointegrate с некоторыми EF функциональных возможностей, таких как создание новых соединений с существующие один toocheck наличие базы данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-146">This approach needs toointegrate with some of EF’s functionality, such as creating new connections from an existing one toocheck for database existence.</span></span> <span data-ttu-id="127d7-147">Как правило, наши наблюдения был что стандартные конструкторы DbContext hello работать только надежно подключений закрытых базы данных, которые можно безопасно клонировать EF работ.</span><span class="sxs-lookup"><span data-stu-id="127d7-147">In general, our observation has been that hello standard DbContext constructors only work reliably for closed database connections that can safely be cloned for EF work.</span></span> <span data-ttu-id="127d7-148">Принцип разработки Hello эластичной базы данных вместо является tooonly broker открыт соединений.</span><span class="sxs-lookup"><span data-stu-id="127d7-148">hello design principle of elastic database instead is tooonly broker opened connections.</span></span> <span data-ttu-id="127d7-149">Может показаться, что закрытие подключения через посредника клиентской библиотекой hello перед передачей его по toohello EF DbContext можно решить эту проблему.</span><span class="sxs-lookup"><span data-stu-id="127d7-149">One might think that closing a connection brokered by hello client library before handing it over toohello EF DbContext may solve this issue.</span></span> <span data-ttu-id="127d7-150">Тем не менее, закрыв соединения hello и полагаться на toore открытия EF, один foregoes hello проверки и согласованность проверок библиотекой hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-150">However, by closing hello connection and relying on EF toore-open it, one foregoes hello validation and consistency checks performed by hello library.</span></span> <span data-ttu-id="127d7-151">функциональные возможности миграции Hello в EF, однако использует базовой схемы базы данных, в результате которого является прозрачным toohello приложение toomanage hello эти подключения система.</span><span class="sxs-lookup"><span data-stu-id="127d7-151">hello migrations functionality in EF, however, uses these connections toomanage hello underlying database schema in a way that is transparent toohello application.</span></span> <span data-ttu-id="127d7-152">В идеальном случае бы как tooretain и объединить все эти возможности из клиентской библиотеке эластичной базы данных hello и EF hello того же приложения.</span><span class="sxs-lookup"><span data-stu-id="127d7-152">Ideally, we would like tooretain and combine all these capabilities from both hello elastic database client library and EF in hello same application.</span></span> <span data-ttu-id="127d7-153">Hello следующем разделе описываются эти свойства и требования к более подробно.</span><span class="sxs-lookup"><span data-stu-id="127d7-153">hello following section discusses these properties and requirements in more detail.</span></span> 

## <a name="requirements"></a><span data-ttu-id="127d7-154">Требования</span><span class="sxs-lookup"><span data-stu-id="127d7-154">Requirements</span></span>
<span data-ttu-id="127d7-155">При работе с клиентской библиотеке эластичной базы данных hello и API платформы Entity Framework, мы хотим tooretain hello следующие свойства:</span><span class="sxs-lookup"><span data-stu-id="127d7-155">When working with both hello elastic database client library and Entity Framework APIs, we want tooretain hello following properties:</span></span> 

* <span data-ttu-id="127d7-156">**Масштабирование**: tooadd или удаление баз данных с уровня данных hello сегментированных приложения hello согласно требованиям к емкости hello приложения hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-156">**Scale-out**: tooadd or remove databases from hello data tier of hello sharded application as necessary for hello capacity demands of hello application.</span></span> <span data-ttu-id="127d7-157">Это значит, контроль над hello hello Создание и удаление баз данных и с помощью hello эластичной базы данных сегментов карты диспетчера API-интерфейсы toomanage баз данных и сопоставления подсегментов.</span><span class="sxs-lookup"><span data-stu-id="127d7-157">This means control over hello hello creation and deletion of databases and using hello elastic database shard map manager APIs toomanage databases, and mappings of shardlets.</span></span> 
* <span data-ttu-id="127d7-158">**Согласованность**: hello приложение использует сегментирования и использует hello зависимые функции маршрутизации данных hello клиентской библиотеки.</span><span class="sxs-lookup"><span data-stu-id="127d7-158">**Consistency**: hello application employs sharding, and uses hello data dependent routing capabilities of hello client library.</span></span> <span data-ttu-id="127d7-159">повреждение tooavoid или результаты запроса неправильный, подключения через посредника, hello диспетчера карты сегментов.</span><span class="sxs-lookup"><span data-stu-id="127d7-159">tooavoid corruption or wrong query results, connections are brokered through hello shard map manager.</span></span> <span data-ttu-id="127d7-160">Это также позволяет использовать проверки и поддерживать согласованность данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-160">This also retains validation and consistency.</span></span>
* <span data-ttu-id="127d7-161">**Code First**: tooretain удобства hello первого подхода EF элемента кода.</span><span class="sxs-lookup"><span data-stu-id="127d7-161">**Code First**: tooretain hello convenience of EF’s code first paradigm.</span></span> <span data-ttu-id="127d7-162">Code First классов в приложении hello сопоставления прозрачно toohello базовые структуры базы данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-162">In Code First, classes in hello application are mapped transparently toohello underlying database structures.</span></span> <span data-ttu-id="127d7-163">код приложения Hello взаимодействует с DbSets, маску основные аспекты, участвующих в hello базовый обработку базы данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-163">hello application code interacts with DbSets that mask most aspects involved in hello underlying database processing.</span></span>
* <span data-ttu-id="127d7-164">**Схема.**Entity Framework берет на себя создание начальной схемы базы данных и последующего развития схемы в ходе миграций.</span><span class="sxs-lookup"><span data-stu-id="127d7-164">**Schema**: Entity Framework handles initial database schema creation and subsequent schema evolution through migrations.</span></span> <span data-ttu-id="127d7-165">Сохраняя эти возможности, адаптации приложения можно легко, как приветствия развития данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-165">By retaining these capabilities, adapting your app is easy as hello data evolves.</span></span> 

<span data-ttu-id="127d7-166">Hello приводимых предписывает как toosatisfy эти требования для первого кода приложений, с помощью средств эластичной базы данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-166">hello following guidance instructs how toosatisfy these requirements for Code First applications using elastic database tools.</span></span> 

## <a name="data-dependent-routing-using-ef-dbcontext"></a><span data-ttu-id="127d7-167">Маршрутизация на основе данных с помощью EF DbContext</span><span class="sxs-lookup"><span data-stu-id="127d7-167">Data dependent routing using EF DbContext</span></span>
<span data-ttu-id="127d7-168">Подключения к базам данных в платформе Entity Framework обычно управляются через подклассы **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="127d7-168">Database connections with Entity Framework are typically managed through subclasses of **DbContext**.</span></span> <span data-ttu-id="127d7-169">Создайте эти подклассы, сделав их производными от **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="127d7-169">Create these subclasses by deriving from **DbContext**.</span></span> <span data-ttu-id="127d7-170">Это поле определяется вашей **DbSets** , которые реализуют hello резервной базы данных коллекции объектов среда CLR для вашего приложения.</span><span class="sxs-lookup"><span data-stu-id="127d7-170">This is where you define your **DbSets** that implement hello database-backed collections of CLR objects for your application.</span></span> <span data-ttu-id="127d7-171">В контексте hello управляемой данными маршрутизацией можно определить несколько полезных свойств, которые не обязательно будет верным для других сценариев EF кода первого приложения:</span><span class="sxs-lookup"><span data-stu-id="127d7-171">In hello context of data dependent routing, we can identify several helpful properties that do not necessarily hold for other EF code first application scenarios:</span></span> 

* <span data-ttu-id="127d7-172">Hello базы данных уже существует и был зарегистрирован в карте сегментов hello эластичной базы данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-172">hello database already exists and has been registered in hello elastic database shard map.</span></span> 
* <span data-ttu-id="127d7-173">Hello схемы приложения hello уже развернутой toohello базы данных (как описано ниже).</span><span class="sxs-lookup"><span data-stu-id="127d7-173">hello schema of hello application has already been deployed toohello database (explained below).</span></span> 
* <span data-ttu-id="127d7-174">База данных маршрутизации подключений toohello зависимости от данных посредника по карте сегментов hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-174">Data-dependent routing connections toohello database are brokered by hello shard map.</span></span> 

<span data-ttu-id="127d7-175">toointegrate **DbContexts** с маршрутизации в зависимости от данных для масштабного развертывания:</span><span class="sxs-lookup"><span data-stu-id="127d7-175">toointegrate **DbContexts** with data-dependent routing for scale-out:</span></span>

1. <span data-ttu-id="127d7-176">Создать соединения физической базы данных через клиентские интерфейсы hello эластичной базы данных диспетчера карты сегментов hello,</span><span class="sxs-lookup"><span data-stu-id="127d7-176">Create physical database connections through hello elastic database client interfaces of hello shard map manager,</span></span> 
2. <span data-ttu-id="127d7-177">Перенос hello соединения с hello **DbContext** подкласс</span><span class="sxs-lookup"><span data-stu-id="127d7-177">Wrap hello connection with hello **DbContext** subclass</span></span>
3. <span data-ttu-id="127d7-178">Передайте hello подключения в hello **DbContext** базовые классы tooensure вся обработка hello hello EF стороны также происходит.</span><span class="sxs-lookup"><span data-stu-id="127d7-178">Pass hello connection down into hello **DbContext** base classes tooensure all hello processing on hello EF side happens as well.</span></span> 

<span data-ttu-id="127d7-179">Этот подход показан в следующем примере кода Hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-179">hello following code example illustrates this approach.</span></span> <span data-ttu-id="127d7-180">(Этот код также является в hello, сопровождающие проекта Visual Studio)</span><span class="sxs-lookup"><span data-stu-id="127d7-180">(This code is also in hello accompanying Visual Studio project)</span></span>

    public class ElasticScaleContext<T> : DbContext
    {
    public DbSet<Blog> Blogs { get; set; }
    …

        // C'tor for data dependent routing. This call will open a validated connection 
        // routed toohello proper shard by hello shard map manager. 
        // Note that hello base class c'tor call will fail for an open connection
        // if migrations need toobe done and SQL credentials are used. This is hello reason for hello 
        // separation of c'tors into hello data-dependent routing case (this c'tor) and hello internal c'tor for new shards.
        public ElasticScaleContext(ShardMap shardMap, T shardingKey, string connectionStr)
            : base(CreateDDRConnection(shardMap, shardingKey, connectionStr), 
            true /* contextOwnsConnection */)
        {
        }

        // Only static methods are allowed in calls into base class c'tors.
        private static DbConnection CreateDDRConnection(
        ShardMap shardMap, 
        T shardingKey, 
        string connectionStr)
        {
            // No initialization
            Database.SetInitializer<ElasticScaleContext<T>>(null);

            // Ask shard map toobroker a validated connection for hello given key
            SqlConnection conn = shardMap.OpenConnectionForKey<T>
                                (shardingKey, connectionStr, ConnectionOptions.Validate);
            return conn;
        }    

## <a name="main-points"></a><span data-ttu-id="127d7-181">Основные положения</span><span class="sxs-lookup"><span data-stu-id="127d7-181">Main points</span></span>
* <span data-ttu-id="127d7-182">Новый конструктор заменяет конструктор по умолчанию hello в подкласс DbContext hello</span><span class="sxs-lookup"><span data-stu-id="127d7-182">A new constructor replaces hello default constructor in hello DbContext subclass</span></span> 
* <span data-ttu-id="127d7-183">новый конструктор Hello принимает hello аргументы, которые требуются для управляемой данными маршрутизацией по клиентской библиотеке эластичной базы данных:</span><span class="sxs-lookup"><span data-stu-id="127d7-183">hello new constructor takes hello arguments that are required for data dependent routing through elastic database client library:</span></span>
  
  * <span data-ttu-id="127d7-184">tooaccess карты сегментов Hello hello интерфейсов маршрутизации в зависимости от данных,</span><span class="sxs-lookup"><span data-stu-id="127d7-184">hello shard map tooaccess hello data-dependent routing interfaces,</span></span>
  * <span data-ttu-id="127d7-185">Подсегмент hello tooidentify ключа сегментирования Hello,</span><span class="sxs-lookup"><span data-stu-id="127d7-185">hello sharding key tooidentify hello shardlet,</span></span>
  * <span data-ttu-id="127d7-186">Строка подключения с учетными данными hello для hello зависимости от данных маршрутизации соединений toohello сегментов.</span><span class="sxs-lookup"><span data-stu-id="127d7-186">a connection string with hello credentials for hello data-dependent routing connection toohello shard.</span></span> 
* <span data-ttu-id="127d7-187">конструктор базового класса toohello вызов Hello учитывает обход статический метод, который выполняет все действия hello необходимые для маршрутизации в зависимости от данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-187">hello call toohello base class constructor takes a detour into a static method that performs all hello steps necessary for data-dependent routing.</span></span> 
  
  * <span data-ttu-id="127d7-188">Он использует вызов OpenConnectionForKey hello интерфейсов клиента hello эластичной базы данных на tooestablish карты сегментов hello открытое соединение.</span><span class="sxs-lookup"><span data-stu-id="127d7-188">It uses hello OpenConnectionForKey call of hello elastic database client interfaces on hello shard map tooestablish an open connection.</span></span>
  * <span data-ttu-id="127d7-189">карта сегментов Hello создает hello открытое соединение toohello сегмент, содержащий hello Подсегмент для заданного ключа сегментирования hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-189">hello shard map creates hello open connection toohello shard that holds hello shardlet for hello given sharding key.</span></span>
  * <span data-ttu-id="127d7-190">Это открытое подключение передается в конструктор базового класса назад toohello tooindicate DbContext, что данное подключение относится toobe используемые EF фиксированного EF автоматически создать новое соединение.</span><span class="sxs-lookup"><span data-stu-id="127d7-190">This open connection is passed back toohello base class constructor of DbContext tooindicate that this connection is toobe used by EF instead of letting EF create a new connection automatically.</span></span> <span data-ttu-id="127d7-191">Это подключение hello способом был помечен клиентом hello эластичной базы данных API, чтобы он может гарантировать согласованность в операции управления сопоставлениями сегментов.</span><span class="sxs-lookup"><span data-stu-id="127d7-191">This way hello connection has been tagged by hello elastic database client API so that it can guarantee consistency under shard map management operations.</span></span>

<span data-ttu-id="127d7-192">Используйте новый конструктор hello для подкласс DbContext вместо конструктор по умолчанию hello в коде.</span><span class="sxs-lookup"><span data-stu-id="127d7-192">Use hello new constructor for your DbContext subclass instead of hello default constructor in your code.</span></span> <span data-ttu-id="127d7-193">Пример:</span><span class="sxs-lookup"><span data-stu-id="127d7-193">Here is an example:</span></span> 

    // Create and save a new blog.

    Console.Write("Enter a name for a new blog: "); 
    var name = Console.ReadLine(); 

    using (var db = new ElasticScaleContext<int>( 
                            sharding.ShardMap,  
                            tenantId1,  
                            connStrBldr.ConnectionString)) 
    { 
        var blog = new Blog { Name = name }; 
        db.Blogs.Add(blog); 
        db.SaveChanges(); 

        // Display all Blogs for tenant 1 
        var query = from b in db.Blogs 
                    orderby b.Name 
                    select b; 
     … 
    }

<span data-ttu-id="127d7-194">новый конструктор Hello открывает hello подключения toohello сегментов hello для сохранения данных Подсегмент hello, определяется значением hello объекта **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="127d7-194">hello new constructor opens hello connection toohello shard that holds hello data for hello shardlet identified by hello value of **tenantid1**.</span></span> <span data-ttu-id="127d7-195">Здравствуйте, код в hello **с помощью** блока остается неизменным tooaccess hello **DbSet** для блогов, с помощью EF на hello сегментов для **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="127d7-195">hello code in hello **using** block stays unchanged tooaccess hello **DbSet** for blogs using EF on hello shard for **tenantid1**.</span></span> <span data-ttu-id="127d7-196">Это изменяет семантику для кода hello в hello, с помощью блока, теперь являются всех операций базы данных, областью действия один сегмент toohello где **tenantid1** сохраняется.</span><span class="sxs-lookup"><span data-stu-id="127d7-196">This changes semantics for hello code in hello using block such that all database operations are now scoped toohello one shard where **tenantid1** is kept.</span></span> <span data-ttu-id="127d7-197">Например, запрос LINQ через блоги hello **DbSet** будут возвращать только блоги, хранящиеся на текущий сегмент hello, но не те, хранящиеся на другие сегменты hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-197">For instance, a LINQ query over hello blogs **DbSet** would only return blogs stored on hello current shard, but not hello ones stored on other shards.</span></span>  

#### <a name="transient-faults-handling"></a><span data-ttu-id="127d7-198">Обработка временных сбоев</span><span class="sxs-lookup"><span data-stu-id="127d7-198">Transient faults handling</span></span>
<span data-ttu-id="127d7-199">Hello шаблонов и практик Майкрософт team опубликованных hello [hello временных Fault Handling Application Block](https://msdn.microsoft.com/library/dn440719.aspx).</span><span class="sxs-lookup"><span data-stu-id="127d7-199">hello Microsoft Patterns & Practices team published hello [hello Transient Fault Handling Application Block](https://msdn.microsoft.com/library/dn440719.aspx).</span></span> <span data-ttu-id="127d7-200">Библиотека Hello используется с клиентской библиотеки гибкого масштабирования в сочетании с EF.</span><span class="sxs-lookup"><span data-stu-id="127d7-200">hello library is used with elastic scale client library in combination with EF.</span></span> <span data-ttu-id="127d7-201">Тем не менее убедитесь, что все временные исключения возвращает tooa месте, где можно гарантировать, что новый конструктор hello используется после временных сбоев, таким образом, все новые попытки подключения выполнялась с использованием hello конструкторов, которые мы слегка изменить.</span><span class="sxs-lookup"><span data-stu-id="127d7-201">However, ensure that any transient exception returns tooa place where we can ensure that hello new constructor is being used after a transient fault so that any new connection attempt is made using hello constructors we have tweaked.</span></span> <span data-ttu-id="127d7-202">В противном случае toohello подключение, подключение hello существует, без подтверждения, а не гарантируется, что сегмент поддерживаются как карта сегментов toohello происходят изменения.</span><span class="sxs-lookup"><span data-stu-id="127d7-202">Otherwise, a connection toohello correct shard is not guaranteed, and there are no assurances hello connection is maintained as changes toohello shard map occur.</span></span> 

<span data-ttu-id="127d7-203">Hello следующем образце кода показано, как политику повтора SQL можно использовать вокруг hello новый **DbContext** подкласс конструкторы:</span><span class="sxs-lookup"><span data-stu-id="127d7-203">hello following code sample illustrates how a SQL retry policy can be used around hello new **DbContext** subclass constructors:</span></span> 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() => 
    { 
        using (var db = new ElasticScaleContext<int>( 
                                sharding.ShardMap,  
                                tenantId1,  
                                connStrBldr.ConnectionString)) 
            { 
                    var blog = new Blog { Name = name }; 
                    db.Blogs.Add(blog); 
                    db.SaveChanges(); 
            … 
            } 
        }); 

<span data-ttu-id="127d7-204">**SqlDatabaseUtils.SqlRetryPolicy** в hello приведенный выше код определяется как **SqlDatabaseTransientErrorDetectionStrategy** с числом повторов, равным 10 и 5 секунд время ожидания между повторными попытками.</span><span class="sxs-lookup"><span data-stu-id="127d7-204">**SqlDatabaseUtils.SqlRetryPolicy** in hello code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span></span> <span data-ttu-id="127d7-205">Этот подход является аналогичные toohello руководство по EF и транзакции, инициированной пользователем (в разделе [ограничения, связанные с повторной попыткой выполнения стратегии (начиная EF6)](http://msdn.microsoft.com/data/dn307226).</span><span class="sxs-lookup"><span data-stu-id="127d7-205">This approach is similar toohello guidance for EF and user-initiated transactions (see [Limitations with Retrying Execution Strategies (EF6 onwards)](http://msdn.microsoft.com/data/dn307226).</span></span> <span data-ttu-id="127d7-206">Оба ситуациях требуется hello области toowhich hello Временное исключение возвращает управляет этой программы приложения hello: tooeither повторно открыть транзакции hello, или (как показано) повторно создать контекст hello из конструктора правильную hello, что использует hello эластичной базы данных Клиентская библиотека.</span><span class="sxs-lookup"><span data-stu-id="127d7-206">Both situations require that hello application program controls hello scope toowhich hello transient exception returns: tooeither reopen hello transaction, or (as shown) recreate hello context from hello proper constructor that uses hello elastic database client library.</span></span>

<span data-ttu-id="127d7-207">Hello toocontrol необходимость, где временные исключения занять обратно в области не позволяет использовать hello встроенных hello **использовать SqlAzureExecutionStrategy** , который поставляется вместе с EF.</span><span class="sxs-lookup"><span data-stu-id="127d7-207">hello need toocontrol where transient exceptions take us back in scope also precludes hello use of hello built-in **SqlAzureExecutionStrategy** that comes with EF.</span></span> <span data-ttu-id="127d7-208">**Использовать SqlAzureExecutionStrategy** будут повторно открыть соединение, но не использовать **OpenConnectionForKey** и поэтому не все проверочные hello, которое выполняется как часть hello **OpenConnectionForKey** вызова.</span><span class="sxs-lookup"><span data-stu-id="127d7-208">**SqlAzureExecutionStrategy** would reopen a connection but not use **OpenConnectionForKey** and therefore bypass all hello validation that is performed as part of hello **OpenConnectionForKey** call.</span></span> <span data-ttu-id="127d7-209">Вместо этого образца кода hello использует встроенные hello **DefaultExecutionStrategy** , также имеет EF.</span><span class="sxs-lookup"><span data-stu-id="127d7-209">Instead, hello code sample uses hello built-in **DefaultExecutionStrategy** that also comes with EF.</span></span> <span data-ttu-id="127d7-210">В отличие от слишком**использовать SqlAzureExecutionStrategy**, оно правильно работает в сочетании с hello политику повтора из обработка временных сбоев.</span><span class="sxs-lookup"><span data-stu-id="127d7-210">As opposed too**SqlAzureExecutionStrategy**, it works correctly in combination with hello retry policy from Transient Fault Handling.</span></span> <span data-ttu-id="127d7-211">политика выполнения Hello задана в hello **ElasticScaleDbConfiguration** класса.</span><span class="sxs-lookup"><span data-stu-id="127d7-211">hello execution policy is set in hello **ElasticScaleDbConfiguration** class.</span></span> <span data-ttu-id="127d7-212">Обратите внимание, что мы решили не toouse **DefaultSqlExecutionStrategy** , так как он предлагает toouse **использовать SqlAzureExecutionStrategy** при временных исключений - которого может привести toowrong поведение, как описано.</span><span class="sxs-lookup"><span data-stu-id="127d7-212">Note that we decided not toouse **DefaultSqlExecutionStrategy** since it suggests toouse **SqlAzureExecutionStrategy** if transient exceptions occur - which would lead toowrong behavior as discussed.</span></span> <span data-ttu-id="127d7-213">Дополнительные сведения о различных политик hello и EF см. в разделе [устойчивость подключения в EF](http://msdn.microsoft.com/data/dn456835.aspx).</span><span class="sxs-lookup"><span data-stu-id="127d7-213">For more information on hello different retry policies and EF, see [Connection Resiliency in EF](http://msdn.microsoft.com/data/dn456835.aspx).</span></span>     

#### <a name="constructor-rewrites"></a><span data-ttu-id="127d7-214">Переделка конструктора</span><span class="sxs-lookup"><span data-stu-id="127d7-214">Constructor rewrites</span></span>
<span data-ttu-id="127d7-215">Hello Вышеприведенные примеры кода показывают по умолчанию hello конструктор загрузочную запись, необходимый для приложения в порядке toouse данных зависимых маршрутизации с hello Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="127d7-215">hello code examples above illustrate hello default constructor re-writes required for your application in order toouse  data dependent routing with hello Entity Framework.</span></span> <span data-ttu-id="127d7-216">в следующей таблице Hello обобщает конструкторы tooother этот подход.</span><span class="sxs-lookup"><span data-stu-id="127d7-216">hello following table generalizes this approach tooother constructors.</span></span> 

| <span data-ttu-id="127d7-217">Текущий конструктор</span><span class="sxs-lookup"><span data-stu-id="127d7-217">Current Constructor</span></span> | <span data-ttu-id="127d7-218">Переделанный конструктор для данных</span><span class="sxs-lookup"><span data-stu-id="127d7-218">Rewritten Constructor for data</span></span> | <span data-ttu-id="127d7-219">Базовый конструктор</span><span class="sxs-lookup"><span data-stu-id="127d7-219">Base Constructor</span></span> | <span data-ttu-id="127d7-220">Примечания</span><span class="sxs-lookup"><span data-stu-id="127d7-220">Notes</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="127d7-221">MyContext()</span><span class="sxs-lookup"><span data-stu-id="127d7-221">MyContext()</span></span> |<span data-ttu-id="127d7-222">ElasticScaleContext(ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="127d7-222">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="127d7-223">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="127d7-223">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="127d7-224">Hello подключение должно toobe функция карты сегментов hello и маршрутизации ключ hello зависимости от данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-224">hello connection needs toobe a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="127d7-225">Требуется создание автоматическое подключение с отрицательным tooby EF и вместо этого используйте hello сегментов карты toobroker hello соединения.</span><span class="sxs-lookup"><span data-stu-id="127d7-225">You need tooby-pass automatic connection creation by EF and instead use hello shard map toobroker hello connection.</span></span> |
| <span data-ttu-id="127d7-226">MyContext(string)</span><span class="sxs-lookup"><span data-stu-id="127d7-226">MyContext(string)</span></span> |<span data-ttu-id="127d7-227">ElasticScaleContext(ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="127d7-227">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="127d7-228">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="127d7-228">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="127d7-229">Hello подключения — это функция карты сегментов hello и hello зависимости от данных маршрутизации ключа.</span><span class="sxs-lookup"><span data-stu-id="127d7-229">hello connection is a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="127d7-230">Строка имени или подключения базы данных не будет работать как только они обойти проверку по карте сегментов hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-230">A fixed database name or connection string will not work as they by-pass validation by hello shard map.</span></span> |
| <span data-ttu-id="127d7-231">MyContext(DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="127d7-231">MyContext(DbCompiledModel)</span></span> |<span data-ttu-id="127d7-232">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="127d7-232">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="127d7-233">DbContext(DbConnection, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="127d7-233">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="127d7-234">Создать соединение Hello будет получить заданный ключ сегментирования карты и сегментирования с hello модели, предоставляемой hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-234">hello connection will get created for hello given shard map and sharding key with hello model provided.</span></span> <span data-ttu-id="127d7-235">Hello скомпилированных модели будут передаваться в базовый c'tor toohello.</span><span class="sxs-lookup"><span data-stu-id="127d7-235">hello compiled model will be passed on toohello base c’tor.</span></span> |
| <span data-ttu-id="127d7-236">MyContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="127d7-236">MyContext(DbConnection, bool)</span></span> |<span data-ttu-id="127d7-237">ElasticScaleContext(ShardMap, TKey, bool)</span><span class="sxs-lookup"><span data-stu-id="127d7-237">ElasticScaleContext(ShardMap, TKey, bool)</span></span> |<span data-ttu-id="127d7-238">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="127d7-238">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="127d7-239">Hello подключение должно выводиться из карты сегментов hello и ключ hello toobe.</span><span class="sxs-lookup"><span data-stu-id="127d7-239">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="127d7-240">Его нельзя указать в качестве ввода (если входа была использована карта сегментов hello и ключ hello).</span><span class="sxs-lookup"><span data-stu-id="127d7-240">It cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="127d7-241">будет передаваться Hello логическое значение.</span><span class="sxs-lookup"><span data-stu-id="127d7-241">hello Boolean will be passed on.</span></span> |
| <span data-ttu-id="127d7-242">MyContext(string, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="127d7-242">MyContext(string, DbCompiledModel)</span></span> |<span data-ttu-id="127d7-243">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="127d7-243">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="127d7-244">DbContext(DbConnection, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="127d7-244">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="127d7-245">Hello подключение должно выводиться из карты сегментов hello и ключ hello toobe.</span><span class="sxs-lookup"><span data-stu-id="127d7-245">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="127d7-246">Его нельзя указать в качестве ввода (если эти входные данные использовался карта сегментов hello и ключ hello).</span><span class="sxs-lookup"><span data-stu-id="127d7-246">It cannot be provided as an input (unless that input was using hello shard map and hello key).</span></span> <span data-ttu-id="127d7-247">Hello скомпилированных модели будут передаваться в.</span><span class="sxs-lookup"><span data-stu-id="127d7-247">hello compiled model will be passed on.</span></span> |
| <span data-ttu-id="127d7-248">MyContext(ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="127d7-248">MyContext(ObjectContext, bool)</span></span> |<span data-ttu-id="127d7-249">ElasticScaleContext(ShardMap, TKey, ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="127d7-249">ElasticScaleContext(ShardMap, TKey, ObjectContext, bool)</span></span> |<span data-ttu-id="127d7-250">DbContext(ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="127d7-250">DbContext(ObjectContext, bool)</span></span> |<span data-ttu-id="127d7-251">новый конструктор Hello должен tooensure, перенаправлен tooa соединения, управляемого компонентом гибкого масштабирования any connection в hello ObjectContext, переданных в качестве входных данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-251">hello new constructor needs tooensure that any connection in hello ObjectContext passed as an input is re-routed tooa connection managed by Elastic Scale.</span></span> <span data-ttu-id="127d7-252">Подробный рассказ о ObjectContexts выходит за рамки данного документа hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-252">A detailed discussion of ObjectContexts is beyond hello scope of this document.</span></span> |
| <span data-ttu-id="127d7-253">MyContext(DbConnection, DbCompiledModel,bool)</span><span class="sxs-lookup"><span data-stu-id="127d7-253">MyContext(DbConnection, DbCompiledModel,bool)</span></span> |<span data-ttu-id="127d7-254">ElasticScaleContext(ShardMap, TKey, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="127d7-254">ElasticScaleContext(ShardMap, TKey, DbCompiledModel, bool)</span></span> |<span data-ttu-id="127d7-255">DbContext(DbConnection, DbCompiledModel, bool);</span><span class="sxs-lookup"><span data-stu-id="127d7-255">DbContext(DbConnection, DbCompiledModel, bool);</span></span> |<span data-ttu-id="127d7-256">Hello подключение должно выводиться из карты сегментов hello и ключ hello toobe.</span><span class="sxs-lookup"><span data-stu-id="127d7-256">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="127d7-257">подключение Hello нельзя указать в качестве ввода (если входа была использована карта сегментов hello и ключ hello).</span><span class="sxs-lookup"><span data-stu-id="127d7-257">hello connection cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="127d7-258">Модель и логическое значение, передаются toohello конструктор базового класса.</span><span class="sxs-lookup"><span data-stu-id="127d7-258">Model and Boolean are passed on toohello base class constructor.</span></span> |

## <a name="shard-schema-deployment-through-ef-migrations"></a><span data-ttu-id="127d7-259">Развертывание схемы сегментирования через миграции EF</span><span class="sxs-lookup"><span data-stu-id="127d7-259">Shard schema deployment through EF migrations</span></span>
<span data-ttu-id="127d7-260">Управление схемой автоматического — удобный метод, предоставляемые hello Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="127d7-260">Automatic schema management is a convenience provided by hello Entity Framework.</span></span> <span data-ttu-id="127d7-261">В контексте hello приложений с помощью средств эластичной базы данных мы хотим tooretain этой возможности tooautomatically подготовки hello схемы toonewly создания сегментов при добавлении toohello сегментированных приложений баз данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-261">In hello context of applications using elastic database tools, we want tooretain this capability tooautomatically provision hello schema toonewly created shards when databases are added toohello sharded application.</span></span> <span data-ttu-id="127d7-262">Hello основном используются tooincrease емкости на уровне данных hello сегментированных приложений с помощью EF.</span><span class="sxs-lookup"><span data-stu-id="127d7-262">hello primary use case is tooincrease capacity at hello data tier for sharded applications using EF.</span></span> <span data-ttu-id="127d7-263">Полагаться на возможности EF элемента схемы управления уменьшает трудозатраты администрирования hello базы данных с сегментированных приложения, созданного на EF.</span><span class="sxs-lookup"><span data-stu-id="127d7-263">Relying on EF’s capabilities for schema management reduces hello database administration effort with a sharded application built on EF.</span></span> 

<span data-ttu-id="127d7-264">Развертывание схемы с помощью миграций EF лучше всего работает для **неоткрытых подключений**.</span><span class="sxs-lookup"><span data-stu-id="127d7-264">Schema deployment through EF migrations works best on **unopened connections**.</span></span> <span data-ttu-id="127d7-265">В отличие от toohello сценарий не управляемой данными маршрутизацией, основанный на Привет открыть соединение, предоставляемое API hello эластичной базы данных клиента.</span><span class="sxs-lookup"><span data-stu-id="127d7-265">This is in contrast toohello scenario for data dependent routing that relies on hello opened connection provided by hello elastic database client API.</span></span> <span data-ttu-id="127d7-266">Другое отличие состоит в требовании hello: при желательно tooensure согласованности для всех зависящих от данных маршрутизации tooprotect подключений для обработки параллельных сегментов карты, он не важен с новой базой данных tooa развертывания Исходная схема где имеется еще не был зарегистрирован в карте сегментов hello и еще не был выделен toohold подсегментов.</span><span class="sxs-lookup"><span data-stu-id="127d7-266">Another difference is hello consistency requirement: While desirable tooensure consistency for all data-dependent routing connections tooprotect against concurrent shard map manipulation, it is not a concern with initial schema deployment tooa new database that has not yet been registered in hello shard map, and not yet been allocated toohold shardlets.</span></span> <span data-ttu-id="127d7-267">Мы рассчитывать на подключения обычной базой данных для этого сценарии маршрутизации в противоположность toodata зависимости.</span><span class="sxs-lookup"><span data-stu-id="127d7-267">We can therefore rely on regular database connections for this scenarios, as opposed toodata-dependent routing.</span></span>  

<span data-ttu-id="127d7-268">Это порождает tooan подход, где развертывания схемы с помощью EF миграции тесно связана с регистрации hello hello новой базы данных как сегментов в карте сегментов приложения hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-268">This leads tooan approach where schema deployment through EF migrations is tightly coupled with hello registration of hello new database as a shard in hello application’s shard map.</span></span> <span data-ttu-id="127d7-269">Это зависит от hello следующие предварительные требования:</span><span class="sxs-lookup"><span data-stu-id="127d7-269">This relies on hello following prerequisites:</span></span> 

* <span data-ttu-id="127d7-270">Hello базы данных уже был создан.</span><span class="sxs-lookup"><span data-stu-id="127d7-270">hello database has already been created.</span></span> 
* <span data-ttu-id="127d7-271">Hello база данных пуста - в ней нет пользовательской схемы и отсутствуют данные пользователя.</span><span class="sxs-lookup"><span data-stu-id="127d7-271">hello database is empty - it holds no user schema and no user data.</span></span>
* <span data-ttu-id="127d7-272">Hello базы данных еще не доступен через клиент hello эластичной базы данных API-интерфейсы для маршрутизации в зависимости от данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-272">hello database cannot yet be accessed through hello elastic database client APIs for data-dependent routing.</span></span> 

<span data-ttu-id="127d7-273">Эти условия можно создать обычную без открытого **SqlConnection** tookick off EF миграции для развертывания схемы.</span><span class="sxs-lookup"><span data-stu-id="127d7-273">With these prerequisites in place, we can create a regular un-opened **SqlConnection** tookick off EF migrations for schema deployment.</span></span> <span data-ttu-id="127d7-274">Этот подход показан следующий образец кода Hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-274">hello following code sample illustrates this approach.</span></span> 

        // Enter a new shard - i.e. an empty database - toohello shard map, allocate a first tenant tooit  
        // and kick off EF intialization of hello database toodeploy schema 

        public void RegisterNewShard(string server, string database, string connStr, int key) 
        { 

            Shard shard = this.ShardMap.CreateShard(new ShardLocation(server, database)); 

            SqlConnectionStringBuilder connStrBldr = new SqlConnectionStringBuilder(connStr); 
            connStrBldr.DataSource = server; 
            connStrBldr.InitialCatalog = database; 

            // Go into a DbContext tootrigger migrations and schema deployment for hello new shard. 
            // This requires an un-opened connection. 
            using (var db = new ElasticScaleContext<int>(connStrBldr.ConnectionString)) 
            { 
                // Run a query tooengage EF migrations 
                (from b in db.Blogs 
                    select b).Count(); 
            } 

            // Register hello mapping of hello tenant toohello shard in hello shard map. 
            // After this step, data-dependent routing on hello shard map can be used 

            this.ShardMap.CreatePointMapping(key, shard); 
        } 


<span data-ttu-id="127d7-275">В этом примере показан метод hello **RegisterNewShard** hello, регистров сегментов в карте сегментов hello, развертывает hello схемы с использованием EF миграции и сохраняет сопоставление сегментом toohello ключа сегментирования.</span><span class="sxs-lookup"><span data-stu-id="127d7-275">This sample shows hello method **RegisterNewShard** that registers hello shard in hello shard map, deploys hello schema through EF migrations, and stores a mapping of a sharding key toohello shard.</span></span> <span data-ttu-id="127d7-276">Он основывается на конструктор hello **DbContext** подкласс (**ElasticScaleContext** в образце hello), который принимает строку подключения SQL в качестве входных данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-276">It relies on a constructor of hello **DbContext** subclass (**ElasticScaleContext** in hello sample) that takes a SQL connection string as input.</span></span> <span data-ttu-id="127d7-277">Код Hello этот конструктор является очевидно, как следующий пример показывает hello:</span><span class="sxs-lookup"><span data-stu-id="127d7-277">hello code of this constructor is straight-forward, as hello following example shows:</span></span> 

        // C'tor toodeploy schema and migrations tooa new shard 
        protected internal ElasticScaleContext(string connectionString) 
            : base(SetInitializerForConnection(connectionString)) 
        { 
        } 

        // Only static methods are allowed in calls into base class c'tors 
        private static string SetInitializerForConnection(string connnectionString) 
        { 
            // We want existence checks so that hello schema can get deployed 
            Database.SetInitializer<ElasticScaleContext<T>>( 
        new CreateDatabaseIfNotExists<ElasticScaleContext<T>>()); 

            return connnectionString; 
        } 

<span data-ttu-id="127d7-278">Вероятно, один использован hello версия конструктора hello, унаследованные от базового класса hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-278">One might have used hello version of hello constructor inherited from hello base class.</span></span> <span data-ttu-id="127d7-279">Однако tooensure потребностей кода hello, hello инициализатор по умолчанию для EF используется при подключении.</span><span class="sxs-lookup"><span data-stu-id="127d7-279">But hello code needs tooensure that hello default initializer for EF is used when connecting.</span></span> <span data-ttu-id="127d7-280">Поэтому hello короткий перенаправление в статический метод hello перед вызовом конструктора базового класса hello со строкой подключения hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-280">Hence hello short detour into hello static method before calling into hello base class constructor with hello connection string.</span></span> <span data-ttu-id="127d7-281">Обратите внимание, что регистрация hello сегментов следует выполнять в другое приложение для домена или процесс tooensure, параметры hello инициализатор для EF не конфликтуют.</span><span class="sxs-lookup"><span data-stu-id="127d7-281">Note that hello registration of shards should run in a different app domain or process tooensure that hello initializer settings for EF do not conflict.</span></span> 

## <a name="limitations"></a><span data-ttu-id="127d7-282">Ограничения</span><span class="sxs-lookup"><span data-stu-id="127d7-282">Limitations</span></span>
<span data-ttu-id="127d7-283">Hello подходов, описанных в этом документе включают несколько ограничений:</span><span class="sxs-lookup"><span data-stu-id="127d7-283">hello approaches outlined in this document entail a couple of limitations:</span></span> 

* <span data-ttu-id="127d7-284">EF приложений, использующих **LocalDb** сначала необходимо регулярное SQL Server базы данных toomigrate tooa перед использованием клиентской библиотеке эластичной базы данных.</span><span class="sxs-lookup"><span data-stu-id="127d7-284">EF applications that use **LocalDb** first need toomigrate tooa regular SQL Server database before using elastic database client library.</span></span> <span data-ttu-id="127d7-285">Горизонтальное масштабирование приложения через сегментирование с помощью эластичного масштабирования невозможно с **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="127d7-285">Scaling out an application through sharding with Elastic Scale is not possible with **LocalDb**.</span></span> <span data-ttu-id="127d7-286">Обратите внимание, что во время разработки **LocalDb**по-прежнему можно использовать.</span><span class="sxs-lookup"><span data-stu-id="127d7-286">Note that development can still use **LocalDb**.</span></span> 
* <span data-ttu-id="127d7-287">Любое приложение toohello изменения, подразумевают изменения схемы базы данных должны toogo через миграций EF на всех сегментах.</span><span class="sxs-lookup"><span data-stu-id="127d7-287">Any changes toohello application that imply database schema changes need toogo through EF migrations on all shards.</span></span> <span data-ttu-id="127d7-288">Hello образцы кода для этого документа не демонстрирует способ toodo это.</span><span class="sxs-lookup"><span data-stu-id="127d7-288">hello sample code for this document does not demonstrate how toodo this.</span></span> <span data-ttu-id="127d7-289">Рассмотрите возможность использования Update-Database с параметром ConnectionString tooiterate по всем сегментам; или извлечения hello T-SQL сценарий hello ожидает обновления базы данных с помощью переноса hello - параметр «скрипт» и применить сегменты tooyour сценария hello T-SQL.</span><span class="sxs-lookup"><span data-stu-id="127d7-289">Consider using Update-Database with a ConnectionString parameter tooiterate over all shards; or extract hello T-SQL script for hello pending migration using Update-Database with hello -Script option and apply hello T-SQL script tooyour shards.</span></span>  
* <span data-ttu-id="127d7-290">Получает запрос, предполагается, что все его обработку базы данных содержатся в одном сегменте, идентифицируемый hello сегментирования ключ, указанный в запросе hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-290">Given a request, it is assumed that all of its database processing is contained within a single shard as identified by hello sharding key provided by hello request.</span></span> <span data-ttu-id="127d7-291">Однако это предположение не всегда является верным.</span><span class="sxs-lookup"><span data-stu-id="127d7-291">However, this assumption does not always hold true.</span></span> <span data-ttu-id="127d7-292">Например, когда это не возможные toomake ключ сегментирования доступны.</span><span class="sxs-lookup"><span data-stu-id="127d7-292">For example, when it is not possible toomake a sharding key available.</span></span> <span data-ttu-id="127d7-293">tooaddress hello, клиентская библиотека предоставляет hello **MultiShardQuery** класс, который реализует абстракцию подключения для выполнения запросов через несколько сегментов.</span><span class="sxs-lookup"><span data-stu-id="127d7-293">tooaddress this, hello client library provides hello **MultiShardQuery** class that implements a connection abstraction for querying over several shards.</span></span> <span data-ttu-id="127d7-294">Изучение toouse hello **MultiShardQuery** в сочетании с EF выходит за рамки данного документа hello</span><span class="sxs-lookup"><span data-stu-id="127d7-294">Learning toouse hello **MultiShardQuery** in combination with EF is beyond hello scope of this document</span></span>

## <a name="conclusion"></a><span data-ttu-id="127d7-295">Заключение</span><span class="sxs-lookup"><span data-stu-id="127d7-295">Conclusion</span></span>
<span data-ttu-id="127d7-296">Через hello шаги, описанные в этом документе, EF приложения могут использовать возможности hello эластичной базы данных клиентской библиотеки для данных зависимых маршрутизации командой рефакторинга конструкторы hello **DbContext** подклассов, используемых в hello EF приложение.</span><span class="sxs-lookup"><span data-stu-id="127d7-296">Through hello steps outlined in this document, EF applications can use hello elastic database client library's capability for data dependent routing by refactoring constructors of hello **DbContext** subclasses used in hello EF application.</span></span> <span data-ttu-id="127d7-297">Необходимые изменения hello этого ограничения toothose мест, где **DbContext** классы уже существуют.</span><span class="sxs-lookup"><span data-stu-id="127d7-297">This limits hello  changes required toothose places where **DbContext** classes already exist.</span></span> <span data-ttu-id="127d7-298">Кроме того EF приложения сохраняют toobenefit из схемы автоматического развертывания, объединяя hello действия, которые вызывают hello необходимые EF миграции с регистрацией hello новых сегментов и сопоставления в карте сегментов hello.</span><span class="sxs-lookup"><span data-stu-id="127d7-298">In addition, EF applications can continue toobenefit from automatic schema deployment by combining hello steps that invoke hello necessary EF migrations with hello registration of new shards and mappings in hello shard map.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-use-entity-framework-applications-visual-studio/sample.png

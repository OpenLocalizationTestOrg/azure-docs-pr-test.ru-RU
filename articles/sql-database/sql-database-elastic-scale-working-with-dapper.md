---
title: "Использование клиентской библиотеки эластичной базы данных с Dapper | Документация Майкрософт"
description: "Использование клиентской библиотеки эластичной базы данных с Dapper."
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
ms.assetid: 463d2676-3b19-47c2-83df-f8c50492c9d2
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/27/2016
ms.author: torsteng
ms.openlocfilehash: f0efd37a39c1a60eee7b47304483c27727ca8833
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="using-elastic-database-client-library-with-dapper"></a><span data-ttu-id="ba515-103">Использование клиентской библиотеки эластичной базы данных с Dapper</span><span class="sxs-lookup"><span data-stu-id="ba515-103">Using elastic database client library with Dapper</span></span>
<span data-ttu-id="ba515-104">Документ предназначен для разработчиков, которые используют Dapper для создания приложений, но также хотят применять [средства эластичной базы данных](sql-database-elastic-scale-introduction.md) , позволяющие создавать приложения, реализующие сегментирование для горизонтального масштабирования своего уровня данных.</span><span class="sxs-lookup"><span data-stu-id="ba515-104">This document is for developers that rely on Dapper to build applications, but also want to embrace [elastic database tooling](sql-database-elastic-scale-introduction.md) to create applications that implement sharding to scale-out their data tier.</span></span>  <span data-ttu-id="ba515-105">В документе показаны изменения, которые следует внести в приложениях на базе Dapper, для интеграции со средствами эластичной базы данных.</span><span class="sxs-lookup"><span data-stu-id="ba515-105">This document illustrates the changes in Dapper-based applications that are necessary to integrate with elastic database tools.</span></span> <span data-ttu-id="ba515-106">Внимание уделяется совмещению методов управления сегментами эластичной базы данных и маршрутизации на основе данных с помощью Dapper.</span><span class="sxs-lookup"><span data-stu-id="ba515-106">Our focus is on composing the elastic database shard management and data dependent routing with Dapper.</span></span> 

<span data-ttu-id="ba515-107">**Пример кода.** [Elastic DB Tools for Azure SQL - Dapper Integration](https://code.msdn.microsoft.com/Elastic-Scale-with-Azure-e19fc77f) (Средства эластичной базы данных для базы данных SQL Azure — интеграция с Dapper).</span><span class="sxs-lookup"><span data-stu-id="ba515-107">**Sample Code**: [Elastic database tools for Azure SQL Database - Dapper integration](https://code.msdn.microsoft.com/Elastic-Scale-with-Azure-e19fc77f).</span></span>

<span data-ttu-id="ba515-108">Интеграция **Dapper** и **DapperExtensions** с клиентской библиотекой эластичной базы данных для базы данных SQL Azure — это просто.</span><span class="sxs-lookup"><span data-stu-id="ba515-108">Integrating **Dapper** and **DapperExtensions** with the elastic database client library for Azure SQL Database is easy.</span></span> <span data-ttu-id="ba515-109">Приложения могут использовать данные в зависимости от маршрутизации путем создания и открытия новых объектов [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx), чтобы использовать вызов [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) из [клиентской библиотеки](http://msdn.microsoft.com/library/azure/dn765902.aspx).</span><span class="sxs-lookup"><span data-stu-id="ba515-109">Your applications can use data dependent routing by changing the creation and opening of new [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects to use the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call from the [client library](http://msdn.microsoft.com/library/azure/dn765902.aspx).</span></span> <span data-ttu-id="ba515-110">Это ограничивает внесение изменений в приложении местами создания и открытия новых подключений.</span><span class="sxs-lookup"><span data-stu-id="ba515-110">This limits changes in your application to only where new connections are created and opened.</span></span> 

## <a name="dapper-overview"></a><span data-ttu-id="ba515-111">Обзор Dapper</span><span class="sxs-lookup"><span data-stu-id="ba515-111">Dapper overview</span></span>
<span data-ttu-id="ba515-112">**Dapper** — это объектно-реляционный модуль сопоставления.</span><span class="sxs-lookup"><span data-stu-id="ba515-112">**Dapper** is an object-relational mapper.</span></span> <span data-ttu-id="ba515-113">Оно сопоставляет объекты .NET в приложении с объектами в реляционной базе данных (и наоборот).</span><span class="sxs-lookup"><span data-stu-id="ba515-113">It maps .NET objects from your application to a relational database (and vice versa).</span></span> <span data-ttu-id="ba515-114">В первой части примера кода показано, как можно интегрировать клиентскую библиотеку эластичной базы данных с приложениями, созданными с помощью Dapper.</span><span class="sxs-lookup"><span data-stu-id="ba515-114">The first part of the sample code illustrates how you can integrate the elastic database client library with Dapper-based applications.</span></span> <span data-ttu-id="ba515-115">Во второй части примера кода показано, как выполнить интеграцию при одновременном использовании Dapper и DapperExtensions.</span><span class="sxs-lookup"><span data-stu-id="ba515-115">The second part of the sample code illustrates how to integrate when using both Dapper and DapperExtensions.</span></span>  

<span data-ttu-id="ba515-116">Средство сопоставления в Dapper предоставляет методы расширения для подключений к базе данных, упрощающие отправку операторов T-SQL для выполнения базы данных или создания адресуемых ей запросов.</span><span class="sxs-lookup"><span data-stu-id="ba515-116">The mapper functionality in Dapper provides extension methods on database connections that simplify submitting T-SQL statements for execution or querying the database.</span></span> <span data-ttu-id="ba515-117">Например, Dapper упрощает сопоставление объектов .NET и параметров операторов SQL для вызовов **Execute** и использование результатов SQL-запросов объектов .NET с помощью вызовов **Query** из Dapper.</span><span class="sxs-lookup"><span data-stu-id="ba515-117">For instance, Dapper makes it easy to map between your .NET objects and the parameters of SQL statements for **Execute** calls, or to consume the results of your SQL queries into .NET objects using **Query** calls from Dapper.</span></span> 

<span data-ttu-id="ba515-118">При использовании DapperExtensions больше не требуется предоставлять операторы SQL.</span><span class="sxs-lookup"><span data-stu-id="ba515-118">When using DapperExtensions, you no longer need to provide the SQL statements.</span></span> <span data-ttu-id="ba515-119">Методы расширения для подключений к базе данных, такие как **GetList** или **Insert**, создают инструкции SQL в фоновом режиме.</span><span class="sxs-lookup"><span data-stu-id="ba515-119">Extensions methods such as **GetList** or **Insert** over the database connection create the SQL statements behind the scenes.</span></span>

<span data-ttu-id="ba515-120">Другое преимущество использования Dapper и DapperExtensions заключается в том, что приложение контролирует создание подключения к базе данных.</span><span class="sxs-lookup"><span data-stu-id="ba515-120">Another benefit of Dapper and also DapperExtensions is that the application controls the creation of the database connection.</span></span> <span data-ttu-id="ba515-121">Это позволяет взаимодействовать с клиентской библиотекой эластичной базы данных, действующей в качестве посредника при подключении к базе данных, на основе сопоставления шардлетов с базами данных.</span><span class="sxs-lookup"><span data-stu-id="ba515-121">This helps interact with the elastic database client library which brokers database connections based on the mapping of shardlets to databases.</span></span>

<span data-ttu-id="ba515-122">Сведения о получении сборок Dapper см. в статье [Dapper dot net 1.50.2](http://www.nuget.org/packages/Dapper/) (Dapper .NET 1.50.2).</span><span class="sxs-lookup"><span data-stu-id="ba515-122">To get the Dapper assemblies, see [Dapper dot net](http://www.nuget.org/packages/Dapper/).</span></span> <span data-ttu-id="ba515-123">Сведения о расширениях Dapper см. в статье [DapperExtensions 1.5.0](http://www.nuget.org/packages/DapperExtensions).</span><span class="sxs-lookup"><span data-stu-id="ba515-123">For the Dapper extensions, see [DapperExtensions](http://www.nuget.org/packages/DapperExtensions).</span></span>

## <a name="a-quick-look-at-the-elastic-database-client-library"></a><span data-ttu-id="ba515-124">Краткий обзор клиентской библиотеки эластичной базы данных</span><span class="sxs-lookup"><span data-stu-id="ba515-124">A quick Look at the elastic database client library</span></span>
<span data-ttu-id="ba515-125">Клиентская библиотека эластичной базы данных позволяет определять разделы данных приложения, которые называются *шардлетами*, сопоставлять их с базами данных и определять с помощью *ключей сегментирования*.</span><span class="sxs-lookup"><span data-stu-id="ba515-125">With the elastic database client library, you define partitions of your application data called *shardlets* , map them to databases, and identify them by *sharding keys*.</span></span> <span data-ttu-id="ba515-126">Вы можете использовать любое количество баз данных и распределять свои шардлеты между этими базами данных.</span><span class="sxs-lookup"><span data-stu-id="ba515-126">You can have as many databases as you need and distribute your shardlets across these databases.</span></span> <span data-ttu-id="ba515-127">Сопоставление значений ключей сегментирования с базами данных хранится в сопоставлении сегментов, которое обеспечивается API-интерфейсами библиотеки.</span><span class="sxs-lookup"><span data-stu-id="ba515-127">The mapping of sharding key values to the databases is stored by a shard map provided by the library’s APIs.</span></span> <span data-ttu-id="ba515-128">Эта функция называется **управление сопоставлением сегментов**.</span><span class="sxs-lookup"><span data-stu-id="ba515-128">This capability is called **shard map management**.</span></span> <span data-ttu-id="ba515-129">Сопоставление сегментов также выступает в качестве посредника подключений к базе данных для запросов с ключом сегментирования.</span><span class="sxs-lookup"><span data-stu-id="ba515-129">The shard map also serves as the broker of database connections for requests that carry a sharding key.</span></span> <span data-ttu-id="ba515-130">Эта функция называется **маршрутизация на основе данных**.</span><span class="sxs-lookup"><span data-stu-id="ba515-130">This capability is referred to as **data dependent routing**.</span></span>

![Сопоставления сегментов и маршрутизация на основе данных][1]

<span data-ttu-id="ba515-132">Диспетчер сопоставления сегментов защищает пользователей от получения несогласованных представлений данных шардлета, которые могут иметь место при выполнении параллельных операций управления шардлетом в базе данных.</span><span class="sxs-lookup"><span data-stu-id="ba515-132">The shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations are happening on the databases.</span></span> <span data-ttu-id="ba515-133">Для этого сопоставления сегментов опосредуют подключения к базе данных для приложения, созданного с помощью библиотеки.</span><span class="sxs-lookup"><span data-stu-id="ba515-133">To do so, the shard maps broker the database connections for an application built with the library.</span></span> <span data-ttu-id="ba515-134">Так как операции управления сегментами могут повлиять на шардлет, функция сопоставления сегментов может завершать подключение к базе данных автоматически.</span><span class="sxs-lookup"><span data-stu-id="ba515-134">When shard management operations could impact the shardlet, this allows the shard map functionality to automatically kill a database connection.</span></span> 

<span data-ttu-id="ba515-135">Вместо стандартных способов создания подключений для Dapper необходимо использовать метод [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn824099.aspx).</span><span class="sxs-lookup"><span data-stu-id="ba515-135">Instead of using the traditional way to create connections for Dapper, we need to use the [OpenConnectionForKey method](http://msdn.microsoft.com/library/azure/dn824099.aspx).</span></span> <span data-ttu-id="ba515-136">Это гарантирует, что при перемещении данных между сегментами выполняется полная проверка и надлежащее управление сегментами.</span><span class="sxs-lookup"><span data-stu-id="ba515-136">This ensures that all the validation takes place and connections are managed properly when any data moves between shards.</span></span>

### <a name="requirements-for-dapper-integration"></a><span data-ttu-id="ba515-137">Требования к интеграции Dapper</span><span class="sxs-lookup"><span data-stu-id="ba515-137">Requirements for Dapper integration</span></span>
<span data-ttu-id="ba515-138">Во время работы одновременно с клиентской библиотекой эластичной базы данных и API-интерфейсами Dapper цель заключается в том, чтобы сохранить следующие свойства.</span><span class="sxs-lookup"><span data-stu-id="ba515-138">When working with both the elastic database client library and the Dapper APIs, we want to retain the following properties:</span></span>

* <span data-ttu-id="ba515-139">**Горизонтальное масштабирование.**Необходимо добавлять базы данных в уровень данных сегментированного приложения и удалять их из него согласно потребности приложения в ресурсах.</span><span class="sxs-lookup"><span data-stu-id="ba515-139">**Scaleout**: We want to add or remove databases from the data tier of the sharded application as necessary for the capacity demands of the application.</span></span> 
* <span data-ttu-id="ba515-140">**Непрерывность.**Так как наше приложение масштабируется путем сегментирования, необходимо выполнять маршрутизацию на основе данных.</span><span class="sxs-lookup"><span data-stu-id="ba515-140">**Consistency**: Since our application is scaled out using sharding, we need to perform data dependent routing.</span></span> <span data-ttu-id="ba515-141">Для этого нам понадобится использовать возможности маршрутизации на основе данных.</span><span class="sxs-lookup"><span data-stu-id="ba515-141">We want to use the Data dependent routing capabilities of the library to do so.</span></span> <span data-ttu-id="ba515-142">В частности, нам необходимо сохранить гарантии проверки и согласованности, предоставляемые с помощью подключений, которые проходят через диспетчер сопоставления сегментов, во избежание повреждения или получения неправильных результатов запросов.</span><span class="sxs-lookup"><span data-stu-id="ba515-142">In particular, we want to retain the validation and consistency guarantees provided by connections that are brokered through the shard map manager in order to avoid corruption or wrong query results.</span></span> <span data-ttu-id="ba515-143">Это гарантирует, что подключения к заданному шардлету отклоняются или останавливаются, если (например) в настоящее время шардлет перемещается в другой сегмент с помощью API для разделения и объединения.</span><span class="sxs-lookup"><span data-stu-id="ba515-143">This ensures that connections to a given shardlet are rejected or stopped if (for instance) the shardlet is currently moved to a different shard using Split/Merge APIs.</span></span>
* <span data-ttu-id="ba515-144">**Сопоставление объектов.**Необходимо сохранить удобство сопоставлений, предоставляемое Dapper, для преобразования между классами в приложении и базовыми структурами базы данных.</span><span class="sxs-lookup"><span data-stu-id="ba515-144">**Object Mapping**: We want to retain the convenience of the mappings provided by Dapper to translate between classes in the application and the underlying database structures.</span></span> 

<span data-ttu-id="ba515-145">В следующем разделе приведены рекомендации по этим требованиям для приложений, созданных с помощью **Dapper** и **DapperExtensions**.</span><span class="sxs-lookup"><span data-stu-id="ba515-145">The following section provides guidance for these requirements for applications based on **Dapper** and **DapperExtensions**.</span></span>

## <a name="technical-guidance"></a><span data-ttu-id="ba515-146">Техническое руководство</span><span class="sxs-lookup"><span data-stu-id="ba515-146">Technical Guidance</span></span>
### <a name="data-dependent-routing-with-dapper"></a><span data-ttu-id="ba515-147">Маршрутизация на основе данных с помощью Dapper</span><span class="sxs-lookup"><span data-stu-id="ba515-147">Data dependent routing with Dapper</span></span>
<span data-ttu-id="ba515-148">При использовании Dapper приложение, как правило, отвечает за создание и открытие подключений к базе данных.</span><span class="sxs-lookup"><span data-stu-id="ba515-148">With Dapper, the application is typically responsible for creating and opening the connections to the underlying database.</span></span> <span data-ttu-id="ba515-149">Если присвоить приложению тип T, Dapper возвращает результаты запроса в качестве коллекции .NET типа T. Dapper сопоставляет данные в строках результатов T-SQL с объектами типа T. Аналогичным образом Dapper сопоставляет объекты .NET в значениях или параметрах SQL для операторов языка обработки данных (DML).</span><span class="sxs-lookup"><span data-stu-id="ba515-149">Given a type T by the application, Dapper returns query results as .NET collections of type T. Dapper performs the mapping from the T-SQL result rows to the objects of type T. Similarly, Dapper maps .NET objects into SQL values or parameters for data manipulation language (DML) statements.</span></span> <span data-ttu-id="ba515-150">Dapper обеспечивает эти функциональные возможности с помощью методов расширения в регулярном объекте [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) из библиотек ADO.NET для клиента SQL.</span><span class="sxs-lookup"><span data-stu-id="ba515-150">Dapper offers this functionality via extension methods on the regular [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) object from the ADO .NET SQL Client libraries.</span></span> <span data-ttu-id="ba515-151">Подключения SQL, возвращенные API-интерфейсами эластичного масштабирования для DDR, также являются регулярными объектами [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx).</span><span class="sxs-lookup"><span data-stu-id="ba515-151">The SQL connection returned by the Elastic Scale APIs for DDR are also regular [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects.</span></span> <span data-ttu-id="ba515-152">Это позволяет использовать расширения Dapper непосредственно для типа объекта, возвращаемого API-интерфейсом клиентской библиотеки для DDR, так как он также является простым подключением клиента SQL.</span><span class="sxs-lookup"><span data-stu-id="ba515-152">This allows us to directly use Dapper extensions over the type returned by the client library’s DDR API, as it is also a simple SQL Client connection.</span></span>

<span data-ttu-id="ba515-153">Эти наблюдения упрощают использование подключений, которые проходят через клиентскую библиотеку эластичной базы данных для Dapper.</span><span class="sxs-lookup"><span data-stu-id="ba515-153">These observations make it straightforward to use connections brokered by the elastic database client library for Dapper.</span></span>

<span data-ttu-id="ba515-154">В этом примере кода (из соответствующего примера) показан подход, в котором приложение предоставляет ключ сегментирования библиотеке, чтобы подключение прошло через посредника к правильному сегменту.</span><span class="sxs-lookup"><span data-stu-id="ba515-154">This code example (from the accompanying sample) illustrates the approach where the sharding key is provided by the application to the library to broker the connection to the right shard.</span></span>   

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                     key: tenantId1, 
                     connectionString: connStrBldr.ConnectionString, 
                     options: ConnectionOptions.Validate))
    {
        var blog = new Blog { Name = name };
        sqlconn.Execute(@"
                      INSERT INTO
                            Blog (Name)
                            VALUES (@name)", new { name = blog.Name }
                        );
    }

<span data-ttu-id="ba515-155">Чтобы вызвать [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) , API-интерфейс заменяет создание и открытие подключения клиента SQL по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="ba515-155">The call to the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) API replaces the default creation and opening of a SQL Client connection.</span></span> <span data-ttu-id="ba515-156">Метод [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) при вызове принимает аргументы, которые требуются для маршрутизации на основе данных:</span><span class="sxs-lookup"><span data-stu-id="ba515-156">The [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call takes the arguments that are required for data dependent routing:</span></span> 

* <span data-ttu-id="ba515-157">сопоставление сегментов для доступа к интерфейсам маршрутизации на основе данных;</span><span class="sxs-lookup"><span data-stu-id="ba515-157">The shard map to access the data dependent routing interfaces</span></span>
* <span data-ttu-id="ba515-158">ключ сегментирования для определения шардлета;</span><span class="sxs-lookup"><span data-stu-id="ba515-158">The sharding key to identify the shardlet</span></span>
* <span data-ttu-id="ba515-159">учетные данные (имя пользователя и пароль) для подключения к сегменту.</span><span class="sxs-lookup"><span data-stu-id="ba515-159">The credentials (user name and password) to connect to the shard</span></span>

<span data-ttu-id="ba515-160">Объект сопоставления сегментов создает открытое подключение к сегменту, в котором содержится шардлет, соответствующий заданному ключу сегментирования.</span><span class="sxs-lookup"><span data-stu-id="ba515-160">The shard map object creates a connection to the shard that holds the shardlet for the given sharding key.</span></span> <span data-ttu-id="ba515-161">Клиентские API-интерфейсы эластичной базы данных также помечают подключение тегом для реализации гарантий согласованности.</span><span class="sxs-lookup"><span data-stu-id="ba515-161">The elastic database client APIs also tag the connection to implement its consistency guarantees.</span></span> <span data-ttu-id="ba515-162">Так как при вызове [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) возвращается регулярный объект подключения клиента SQL, последующий вызов метода расширения **Execute** из Dapper выполняется по стандартной схеме.</span><span class="sxs-lookup"><span data-stu-id="ba515-162">Since the call to [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) returns a regular SQL Client connection object, the subsequent call to the **Execute** extension method from Dapper follows the standard Dapper practice.</span></span>

<span data-ttu-id="ba515-163">Запросы формируются в целом одинаково: сначала открывается подключение с помощью [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) из клиентского API-интерфейса,</span><span class="sxs-lookup"><span data-stu-id="ba515-163">Queries work very much the same way - you first open the connection using [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) from the client API.</span></span> <span data-ttu-id="ba515-164">а затем используются регулярные методы расширения Dapper для сопоставления результатов SQL-запроса в объектах .NET:</span><span class="sxs-lookup"><span data-stu-id="ba515-164">Then you use the regular Dapper extension methods to map the results of your SQL query into .NET objects:</span></span>

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId1, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate ))
    {    
           // Display all Blogs for tenant 1
           IEnumerable<Blog> result = sqlconn.Query<Blog>(@"
                                SELECT * 
                                FROM Blog
                                ORDER BY Name");

           Console.WriteLine("All blogs for tenant id {0}:", tenantId1);
           foreach (var item in result)
           {
                Console.WriteLine(item.Name);
            }
    }

<span data-ttu-id="ba515-165">Обратите внимание, что блок **using** с подключением DDR ограничивает все операции базы данных в пределах блока к одному сегменту, в котором хранится tenantId1.</span><span class="sxs-lookup"><span data-stu-id="ba515-165">Note that the **using** block with the DDR connection scopes all database operations within the block to the one shard where tenantId1 is kept.</span></span> <span data-ttu-id="ba515-166">Запрос возвращает только блоги, хранящиеся в текущем сегменте, а не в любых других сегментах.</span><span class="sxs-lookup"><span data-stu-id="ba515-166">The query only returns blogs stored on the current shard, but not the ones stored on any other shards.</span></span> 

## <a name="data-dependent-routing-with-dapper-and-dapperextensions"></a><span data-ttu-id="ba515-167">Маршрутизация на основе данных с помощью Dapper и DapperExtensions</span><span class="sxs-lookup"><span data-stu-id="ba515-167">Data dependent routing with Dapper and DapperExtensions</span></span>
<span data-ttu-id="ba515-168">В Dapper включена экосистема дополнительных расширений, которые могут обеспечивать дополнительное удобство и предоставлять абстракцию из базы данных при разработке приложений баз данных.</span><span class="sxs-lookup"><span data-stu-id="ba515-168">Dapper comes with an ecosystem of additional extensions that can provide further convenience and abstraction from the database when developing database applications.</span></span> <span data-ttu-id="ba515-169">И примером таких расширений является DapperExtensions.</span><span class="sxs-lookup"><span data-stu-id="ba515-169">DapperExtensions is an example.</span></span> 

<span data-ttu-id="ba515-170">При использовании DapperExtensions в приложении способ создания подключений к базе данных и управления ими не меняется.</span><span class="sxs-lookup"><span data-stu-id="ba515-170">Using DapperExtensions in your application does not change how database connections are created and managed.</span></span> <span data-ttu-id="ba515-171">Приложение все еще отвечает за открытие подключений, а методы расширения ожидают регулярные объекты подключений клиента SQL.</span><span class="sxs-lookup"><span data-stu-id="ba515-171">It is still the application’s responsibility to open connections, and regular SQL Client connection objects are expected by the extension methods.</span></span> <span data-ttu-id="ba515-172">Мы можем использовать [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) , как описано выше.</span><span class="sxs-lookup"><span data-stu-id="ba515-172">We can rely on the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) as outlined above.</span></span> <span data-ttu-id="ba515-173">Единственное изменение заключается в том, что больше не нужно писать операторы T-SQL, как показано в следующих примерах кода:</span><span class="sxs-lookup"><span data-stu-id="ba515-173">As the following code samples show, the only change is that we do no longer have to write the T-SQL statements:</span></span>

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId2, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate))
    {
           var blog = new Blog { Name = name2 };
           sqlconn.Insert(blog);
    }

<span data-ttu-id="ba515-174">А вот пример кода для запроса:</span><span class="sxs-lookup"><span data-stu-id="ba515-174">And here is the code sample for the query:</span></span> 

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId2, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate))
    {
           // Display all Blogs for tenant 2
           IEnumerable<Blog> result = sqlconn.GetList<Blog>();
           Console.WriteLine("All blogs for tenant id {0}:", tenantId2);
           foreach (var item in result)
           {
               Console.WriteLine(item.Name);
           }
    }

### <a name="handling-transient-faults"></a><span data-ttu-id="ba515-175">Обработка временных сбоев</span><span class="sxs-lookup"><span data-stu-id="ba515-175">Handling transient faults</span></span>
<span data-ttu-id="ba515-176">Команда Microsoft Patterns & Practices опубликовала [блок приложений обработки временных сбоев](http://msdn.microsoft.com/library/hh680934.aspx), чтобы позволить разработчикам приложений устранять распространенные временные сбои при выполнении в облаке.</span><span class="sxs-lookup"><span data-stu-id="ba515-176">The Microsoft Patterns & Practices team published the [Transient Fault Handling Application Block](http://msdn.microsoft.com/library/hh680934.aspx) to help application developers mitigate common transient fault conditions encountered when running in the cloud.</span></span> <span data-ttu-id="ba515-177">Дополнительные сведения см. в статье [4 - Perseverance, Secret of All Triumphs: Using the Transient Fault Handling Application Block](http://msdn.microsoft.com/library/dn440719.aspx) (4. Настойчивость — секрет всех побед. Использование блока приложения для обработки временных ошибок).</span><span class="sxs-lookup"><span data-stu-id="ba515-177">For more information, see [Perseverance, Secret of All Triumphs: Using the Transient Fault Handling Application Block](http://msdn.microsoft.com/library/dn440719.aspx).</span></span>

<span data-ttu-id="ba515-178">В примере кода для защиты от временных сбоев используется библиотека временных сбоев.</span><span class="sxs-lookup"><span data-stu-id="ba515-178">The code sample relies on the transient fault library to protect against transient faults.</span></span> 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() =>
    {
       using (SqlConnection sqlconn = 
          shardingLayer.ShardMap.OpenConnectionForKey(tenantId2, connStrBldr.ConnectionString, ConnectionOptions.Validate))
          {
              var blog = new Blog { Name = name2 };
              sqlconn.Insert(blog);
          }
    });

<span data-ttu-id="ba515-179">Политика **SqlDatabaseUtils.SqlRetryPolicy** в приведенном выше коде определена как **SqlDatabaseTransientErrorDetectionStrategy** с числом попыток, равным 10, и 5-секундным временем ожидания между повторами попытки.</span><span class="sxs-lookup"><span data-stu-id="ba515-179">**SqlDatabaseUtils.SqlRetryPolicy** in the code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span></span> <span data-ttu-id="ba515-180">При использовании транзакций убедитесь, что при возникновении временного сбоя область повтора переходит к началу транзакции.</span><span class="sxs-lookup"><span data-stu-id="ba515-180">If you are using transactions, make sure that your retry scope goes back to the beginning of the transaction in the case of a transient fault.</span></span>

## <a name="limitations"></a><span data-ttu-id="ba515-181">Ограничения</span><span class="sxs-lookup"><span data-stu-id="ba515-181">Limitations</span></span>
<span data-ttu-id="ba515-182">Подходы, описанные в данном документе, имеют несколько ограничений:</span><span class="sxs-lookup"><span data-stu-id="ba515-182">The approaches outlined in this document entail a couple of limitations:</span></span>

* <span data-ttu-id="ba515-183">В примере кода для этого документа не показано, как управлять схемой для разных сегментов.</span><span class="sxs-lookup"><span data-stu-id="ba515-183">The sample code for this document does not demonstrate how to manage schema across shards.</span></span>
* <span data-ttu-id="ba515-184">Предполагается, что вся обработка в базе данных для выполнения запроса ведется в пределах одного сегмента, который идентифицируется ключом сегментирования, предоставленном в запросе.</span><span class="sxs-lookup"><span data-stu-id="ba515-184">Given a request, we assume that all its database processing is contained within a single shard as identified by the sharding key provided by the request.</span></span> <span data-ttu-id="ba515-185">Тем не менее, это не всегда так, например, в случае, если невозможно сделать ключ сегментирования доступным.</span><span class="sxs-lookup"><span data-stu-id="ba515-185">However, this assumption does not always hold, for example, when it is not possible to make a sharding key available.</span></span> <span data-ttu-id="ba515-186">Для решения этой проблемы клиентская библиотека эластичной базы данных включает класс [MultiShardQuery](http://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardexception.aspx).</span><span class="sxs-lookup"><span data-stu-id="ba515-186">To address this, the elastic database client library includes the [MultiShardQuery class](http://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardexception.aspx).</span></span> <span data-ttu-id="ba515-187">Этот класс реализует абстракцию подключения для выполнения запросов нескольких сегментов.</span><span class="sxs-lookup"><span data-stu-id="ba515-187">The class implements a connection abstraction for querying over several shards.</span></span> <span data-ttu-id="ba515-188">Использование MultiShardQuery вместе с EF выходит за рамки данного документа</span><span class="sxs-lookup"><span data-stu-id="ba515-188">Using MultiShardQuery in combination with Dapper is beyond the scope of this document.</span></span>

## <a name="conclusion"></a><span data-ttu-id="ba515-189">Заключение</span><span class="sxs-lookup"><span data-stu-id="ba515-189">Conclusion</span></span>
<span data-ttu-id="ba515-190">Приложения, использующие Dapper и DapperExtensions, могут легко использовать преимущества средств эластичной базы данных SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="ba515-190">Applications using Dapper and DapperExtensions can easily benefit from elastic database tools for Azure SQL Database.</span></span> <span data-ttu-id="ba515-191">С помощью шагов, описанных в этом документе, приложения могут использовать возможности средства для маршрутизации на основе данных. Для этого требуется изменить создание и открытие новых объектов [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx), чтобы использовать вызов [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) клиентской библиотеки эластичной базы данных.</span><span class="sxs-lookup"><span data-stu-id="ba515-191">Through the steps outlined in this document, those applications can use the tool's capability for data dependent routing by changing the creation and opening of new [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects to use the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call of the elastic database client library.</span></span> <span data-ttu-id="ba515-192">Это ограничивает внесение требуемых изменений в приложении местами создания и открытия новых подключений.</span><span class="sxs-lookup"><span data-stu-id="ba515-192">This limits the application changes required to those places where new connections are created and opened.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-working-with-dapper/dapperimage1.png

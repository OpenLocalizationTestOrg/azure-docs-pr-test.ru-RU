---
title: "библиотека клиента aaaUsing эластичной базы данных с Dapper | Документы Microsoft"
description: "Использование клиентской библиотеки эластичной базы данных с Dapper."
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
ms.assetid: 463d2676-3b19-47c2-83df-f8c50492c9d2
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/27/2016
ms.author: torsteng
ms.openlocfilehash: c22ece2a977265e93850f0ad3f3ca48f0a8733ac
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="using-elastic-database-client-library-with-dapper"></a><span data-ttu-id="f794a-103">Использование клиентской библиотеки эластичной базы данных с Dapper</span><span class="sxs-lookup"><span data-stu-id="f794a-103">Using elastic database client library with Dapper</span></span>
<span data-ttu-id="f794a-104">Данный документ предназначен для разработчиков, которые используют Dapper toobuild приложений, но при этом tooembrace [эластичной базы данных средства](sql-database-elastic-scale-introduction.md) toocreate приложения, которые реализуют горизонтального tooscale сегментирования уровень данных.</span><span class="sxs-lookup"><span data-stu-id="f794a-104">This document is for developers that rely on Dapper toobuild applications, but also want tooembrace [elastic database tooling](sql-database-elastic-scale-introduction.md) toocreate applications that implement sharding tooscale-out their data tier.</span></span>  <span data-ttu-id="f794a-105">Этот документ описывает hello изменений в приложениях на базе Dapper, необходимые toointegrate со средствами эластичной базы данных.</span><span class="sxs-lookup"><span data-stu-id="f794a-105">This document illustrates hello changes in Dapper-based applications that are necessary toointegrate with elastic database tools.</span></span> <span data-ttu-id="f794a-106">Наши фокус на составление зависит от данных и управления сегментами hello эластичной базы данных маршрутизации с Dapper.</span><span class="sxs-lookup"><span data-stu-id="f794a-106">Our focus is on composing hello elastic database shard management and data dependent routing with Dapper.</span></span> 

<span data-ttu-id="f794a-107">**Пример кода.** [Elastic DB Tools for Azure SQL - Dapper Integration](https://code.msdn.microsoft.com/Elastic-Scale-with-Azure-e19fc77f) (Средства эластичной базы данных для базы данных SQL Azure — интеграция с Dapper).</span><span class="sxs-lookup"><span data-stu-id="f794a-107">**Sample Code**: [Elastic database tools for Azure SQL Database - Dapper integration](https://code.msdn.microsoft.com/Elastic-Scale-with-Azure-e19fc77f).</span></span>

<span data-ttu-id="f794a-108">Интеграция **Dapper** и **DapperExtensions** с hello несложно клиентской библиотеке эластичной базы данных для базы данных SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="f794a-108">Integrating **Dapper** and **DapperExtensions** with hello elastic database client library for Azure SQL Database is easy.</span></span> <span data-ttu-id="f794a-109">Приложения могут использовать данные зависимой маршрутизации, изменив hello создания и открытия нового [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) объектов toouse hello [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) вызов из hello [клиента Библиотека](http://msdn.microsoft.com/library/azure/dn765902.aspx).</span><span class="sxs-lookup"><span data-stu-id="f794a-109">Your applications can use data dependent routing by changing hello creation and opening of new [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects toouse hello [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call from hello [client library](http://msdn.microsoft.com/library/azure/dn765902.aspx).</span></span> <span data-ttu-id="f794a-110">Это ограничивает изменения в вашей tooonly приложения, где создается и открывается новые соединения.</span><span class="sxs-lookup"><span data-stu-id="f794a-110">This limits changes in your application tooonly where new connections are created and opened.</span></span> 

## <a name="dapper-overview"></a><span data-ttu-id="f794a-111">Обзор Dapper</span><span class="sxs-lookup"><span data-stu-id="f794a-111">Dapper overview</span></span>
<span data-ttu-id="f794a-112">**Dapper** — это объектно-реляционный модуль сопоставления.</span><span class="sxs-lookup"><span data-stu-id="f794a-112">**Dapper** is an object-relational mapper.</span></span> <span data-ttu-id="f794a-113">Он был сопоставлен объектов .NET из реляционной базы данных приложения tooa (и наоборот).</span><span class="sxs-lookup"><span data-stu-id="f794a-113">It maps .NET objects from your application tooa relational database (and vice versa).</span></span> <span data-ttu-id="f794a-114">Hello первой части образца кода hello показано, как клиентская библиотека hello эластичной базы данных могут интегрироваться с Dapper-приложениям.</span><span class="sxs-lookup"><span data-stu-id="f794a-114">hello first part of hello sample code illustrates how you can integrate hello elastic database client library with Dapper-based applications.</span></span> <span data-ttu-id="f794a-115">во второй части Hello hello образец кода иллюстрирует способ toointegrate при использовании Dapper и DapperExtensions.</span><span class="sxs-lookup"><span data-stu-id="f794a-115">hello second part of hello sample code illustrates how toointegrate when using both Dapper and DapperExtensions.</span></span>  

<span data-ttu-id="f794a-116">функциональность сопоставления Hello в Dapper содержит методы расширения, упрощающие Отправка инструкций T-SQL для выполнения или запроса базы данных hello подключения к базе данных.</span><span class="sxs-lookup"><span data-stu-id="f794a-116">hello mapper functionality in Dapper provides extension methods on database connections that simplify submitting T-SQL statements for execution or querying hello database.</span></span> <span data-ttu-id="f794a-117">Для экземпляра Dapper делает его легко toomap между объектов .NET и параметры hello инструкций SQL для **Execute** вызовы или tooconsume hello результаты запросов SQL в объекты .NET с помощью **запроса**вызовы из Dapper.</span><span class="sxs-lookup"><span data-stu-id="f794a-117">For instance, Dapper makes it easy toomap between your .NET objects and hello parameters of SQL statements for **Execute** calls, or tooconsume hello results of your SQL queries into .NET objects using **Query** calls from Dapper.</span></span> 

<span data-ttu-id="f794a-118">При использовании DapperExtensions, больше не нужна инструкций SQL tooprovide hello.</span><span class="sxs-lookup"><span data-stu-id="f794a-118">When using DapperExtensions, you no longer need tooprovide hello SQL statements.</span></span> <span data-ttu-id="f794a-119">Методы расширения, например **GetList, выдающего** или **вставить** через подключение к базе данных hello создания hello инструкций SQL, фоновом hello.</span><span class="sxs-lookup"><span data-stu-id="f794a-119">Extensions methods such as **GetList** or **Insert** over hello database connection create hello SQL statements behind hello scenes.</span></span>

<span data-ttu-id="f794a-120">Еще одним преимуществом Dapper, а также DapperExtensions — что элементы управления приложения hello hello создания подключения к базе данных hello.</span><span class="sxs-lookup"><span data-stu-id="f794a-120">Another benefit of Dapper and also DapperExtensions is that hello application controls hello creation of hello database connection.</span></span> <span data-ttu-id="f794a-121">Это позволяет взаимодействовать с клиентской библиотеки hello эластичной базы данных, которой брокеры подключений, на основе сопоставления hello объекта Подсегменты toodatabases к базе данных.</span><span class="sxs-lookup"><span data-stu-id="f794a-121">This helps interact with hello elastic database client library which brokers database connections based on hello mapping of shardlets toodatabases.</span></span>

<span data-ttu-id="f794a-122">tooget hello Dapper, см. [Dapper точка net](http://www.nuget.org/packages/Dapper/).</span><span class="sxs-lookup"><span data-stu-id="f794a-122">tooget hello Dapper assemblies, see [Dapper dot net](http://www.nuget.org/packages/Dapper/).</span></span> <span data-ttu-id="f794a-123">Hello Dapper расширения, в разделе [DapperExtensions](http://www.nuget.org/packages/DapperExtensions).</span><span class="sxs-lookup"><span data-stu-id="f794a-123">For hello Dapper extensions, see [DapperExtensions](http://www.nuget.org/packages/DapperExtensions).</span></span>

## <a name="a-quick-look-at-hello-elastic-database-client-library"></a><span data-ttu-id="f794a-124">Кратко рассмотрим клиентская библиотека hello эластичной базы данных</span><span class="sxs-lookup"><span data-stu-id="f794a-124">A quick Look at hello elastic database client library</span></span>
<span data-ttu-id="f794a-125">С помощью клиентской библиотеки hello эластичной базы данных, определить секции данных приложения вызывается *подсегментов* , сопоставьте их toodatabases и определить их по *ключи сегментирования*.</span><span class="sxs-lookup"><span data-stu-id="f794a-125">With hello elastic database client library, you define partitions of your application data called *shardlets* , map them toodatabases, and identify them by *sharding keys*.</span></span> <span data-ttu-id="f794a-126">Вы можете использовать любое количество баз данных и распределять свои шардлеты между этими базами данных.</span><span class="sxs-lookup"><span data-stu-id="f794a-126">You can have as many databases as you need and distribute your shardlets across these databases.</span></span> <span data-ttu-id="f794a-127">сопоставление Hello баз данных toohello значения ключа сегментирования хранится по карте сегментов, предоставляемые API-интерфейсы hello библиотеки.</span><span class="sxs-lookup"><span data-stu-id="f794a-127">hello mapping of sharding key values toohello databases is stored by a shard map provided by hello library’s APIs.</span></span> <span data-ttu-id="f794a-128">Эта функция называется **управление сопоставлением сегментов**.</span><span class="sxs-lookup"><span data-stu-id="f794a-128">This capability is called **shard map management**.</span></span> <span data-ttu-id="f794a-129">карта сегментов Hello также служит в качестве hello посредника подключений к базе данных для запросов, которые используются для передачи ключа сегментирования.</span><span class="sxs-lookup"><span data-stu-id="f794a-129">hello shard map also serves as hello broker of database connections for requests that carry a sharding key.</span></span> <span data-ttu-id="f794a-130">Эта возможность является ссылка tooas **управляемой данными маршрутизацией**.</span><span class="sxs-lookup"><span data-stu-id="f794a-130">This capability is referred tooas **data dependent routing**.</span></span>

![Сопоставления сегментов и маршрутизация на основе данных][1]

<span data-ttu-id="f794a-132">диспетчера карты сегментов Hello помогает защитить пользователей от несогласованные представления данных подсегмента, может возникать, когда операции управления параллельных подсегмента выполняются операции в базах данных hello.</span><span class="sxs-lookup"><span data-stu-id="f794a-132">hello shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations are happening on hello databases.</span></span> <span data-ttu-id="f794a-133">Таким образом, toodo hello сегментов карты broker hello подключения к базе данных для приложения, созданного с помощью библиотеки hello.</span><span class="sxs-lookup"><span data-stu-id="f794a-133">toodo so, hello shard maps broker hello database connections for an application built with hello library.</span></span> <span data-ttu-id="f794a-134">Операции управления сегментов может повлиять на hello подсегмента, обеспечит hello сегментов карты функциональность tooautomatically kill подключения к базе данных.</span><span class="sxs-lookup"><span data-stu-id="f794a-134">When shard management operations could impact hello shardlet, this allows hello shard map functionality tooautomatically kill a database connection.</span></span> 

<span data-ttu-id="f794a-135">Вместо соединения toocreate традиционным способом hello Dapper, нам нужно toouse hello [OpenConnectionForKey метод](http://msdn.microsoft.com/library/azure/dn824099.aspx).</span><span class="sxs-lookup"><span data-stu-id="f794a-135">Instead of using hello traditional way toocreate connections for Dapper, we need toouse hello [OpenConnectionForKey method](http://msdn.microsoft.com/library/azure/dn824099.aspx).</span></span> <span data-ttu-id="f794a-136">Это гарантирует, что все проверкой hello и подключениями должным образом при перемещении данных между сегментами.</span><span class="sxs-lookup"><span data-stu-id="f794a-136">This ensures that all hello validation takes place and connections are managed properly when any data moves between shards.</span></span>

### <a name="requirements-for-dapper-integration"></a><span data-ttu-id="f794a-137">Требования к интеграции Dapper</span><span class="sxs-lookup"><span data-stu-id="f794a-137">Requirements for Dapper integration</span></span>
<span data-ttu-id="f794a-138">При работе с клиентской библиотеке эластичной базы данных hello и hello Dapper интерфейсы API, мы хотим tooretain hello следующие свойства:</span><span class="sxs-lookup"><span data-stu-id="f794a-138">When working with both hello elastic database client library and hello Dapper APIs, we want tooretain hello following properties:</span></span>

* <span data-ttu-id="f794a-139">**Горизонтального масштабирования**: мы должны tooadd или удалить базы данных с уровня данных hello сегментированных приложения hello согласно требованиям к емкости hello приложения hello.</span><span class="sxs-lookup"><span data-stu-id="f794a-139">**Scaleout**: We want tooadd or remove databases from hello data tier of hello sharded application as necessary for hello capacity demands of hello application.</span></span> 
* <span data-ttu-id="f794a-140">**Согласованность**: поскольку наше приложение масштабирован с использованием сегментирования, нам нужно tooperform управляемой данными маршрутизацией.</span><span class="sxs-lookup"><span data-stu-id="f794a-140">**Consistency**: Since our application is scaled out using sharding, we need tooperform data dependent routing.</span></span> <span data-ttu-id="f794a-141">Таким образом мы хотим toouse hello зависимой маршрутизации возможностей данных toodo библиотеки hello.</span><span class="sxs-lookup"><span data-stu-id="f794a-141">We want toouse hello Data dependent routing capabilities of hello library toodo so.</span></span> <span data-ttu-id="f794a-142">В частности мы хотим tooretain проверки hello и гарантирует согласованность, предоставляемые через диспетчера карты сегментов hello в порядке tooavoid повреждение или результаты запроса неправильный посредника подключений.</span><span class="sxs-lookup"><span data-stu-id="f794a-142">In particular, we want tooretain hello validation and consistency guarantees provided by connections that are brokered through hello shard map manager in order tooavoid corruption or wrong query results.</span></span> <span data-ttu-id="f794a-143">Это гарантирует, что tooa, подключений, заданному подсегмента отклонен или останавливается, если (например) hello Подсегмент является в настоящее время перемещенный tooa другой сегмент с помощью интерфейсов API разделения или слияния.</span><span class="sxs-lookup"><span data-stu-id="f794a-143">This ensures that connections tooa given shardlet are rejected or stopped if (for instance) hello shardlet is currently moved tooa different shard using Split/Merge APIs.</span></span>
* <span data-ttu-id="f794a-144">**Сопоставление объектов**: мы хотим tooretain удобства hello сопоставлений hello, предоставляемые Dapper tootranslate между классами в приложение hello и hello базовые структуры базы данных.</span><span class="sxs-lookup"><span data-stu-id="f794a-144">**Object Mapping**: We want tooretain hello convenience of hello mappings provided by Dapper tootranslate between classes in hello application and hello underlying database structures.</span></span> 

<span data-ttu-id="f794a-145">Hello следующий раздел содержит инструкции для этих требований для приложений на основе **Dapper** и **DapperExtensions**.</span><span class="sxs-lookup"><span data-stu-id="f794a-145">hello following section provides guidance for these requirements for applications based on **Dapper** and **DapperExtensions**.</span></span>

## <a name="technical-guidance"></a><span data-ttu-id="f794a-146">Техническое руководство</span><span class="sxs-lookup"><span data-stu-id="f794a-146">Technical Guidance</span></span>
### <a name="data-dependent-routing-with-dapper"></a><span data-ttu-id="f794a-147">Маршрутизация на основе данных с помощью Dapper</span><span class="sxs-lookup"><span data-stu-id="f794a-147">Data dependent routing with Dapper</span></span>
<span data-ttu-id="f794a-148">С Dapper приложение hello обычно отвечает за создание и открытие toohello подключений hello основной базы данных.</span><span class="sxs-lookup"><span data-stu-id="f794a-148">With Dapper, hello application is typically responsible for creating and opening hello connections toohello underlying database.</span></span> <span data-ttu-id="f794a-149">Назначает ему тип T приложения hello, Dapper возвращает результаты запроса, как .NET коллекции типа T. Dapper выполняет сопоставление hello от hello T-SQL результат строк toohello объектов типа T. Аналогичным образом Dapper сопоставляет объекты .NET SQL значения или параметры для инструкции языка обработки данных.</span><span class="sxs-lookup"><span data-stu-id="f794a-149">Given a type T by hello application, Dapper returns query results as .NET collections of type T. Dapper performs hello mapping from hello T-SQL result rows toohello objects of type T. Similarly, Dapper maps .NET objects into SQL values or parameters for data manipulation language (DML) statements.</span></span> <span data-ttu-id="f794a-150">Dapper предоставляет эту функцию через методы расширения в hello регулярного [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) объекта из hello ADO .NET SQL клиентских библиотек.</span><span class="sxs-lookup"><span data-stu-id="f794a-150">Dapper offers this functionality via extension methods on hello regular [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) object from hello ADO .NET SQL Client libraries.</span></span> <span data-ttu-id="f794a-151">Hello соединения SQL, возвращенный hello API динамического масштабирования для DDR также регулярные [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) объектов.</span><span class="sxs-lookup"><span data-stu-id="f794a-151">hello SQL connection returned by hello Elastic Scale APIs for DDR are also regular [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects.</span></span> <span data-ttu-id="f794a-152">Это позволяет нам toodirectly используйте Dapper расширения через hello тип, возвращенный API DDR hello клиентской библиотеки, это простого подключения клиента SQL.</span><span class="sxs-lookup"><span data-stu-id="f794a-152">This allows us toodirectly use Dapper extensions over hello type returned by hello client library’s DDR API, as it is also a simple SQL Client connection.</span></span>

<span data-ttu-id="f794a-153">Эти данные позволяют простой toouse подключения через посредника клиентской библиотекой hello эластичной базы данных для Dapper.</span><span class="sxs-lookup"><span data-stu-id="f794a-153">These observations make it straightforward toouse connections brokered by hello elastic database client library for Dapper.</span></span>

<span data-ttu-id="f794a-154">Данный пример кода (из сообщения, сопровождающие образец hello) иллюстрирует hello подход, где ключ сегментирования hello обеспечивается hello приложения toohello библиотеки toobroker hello подключения toohello вправо сегментов.</span><span class="sxs-lookup"><span data-stu-id="f794a-154">This code example (from hello accompanying sample) illustrates hello approach where hello sharding key is provided by hello application toohello library toobroker hello connection toohello right shard.</span></span>   

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                     key: tenantId1, 
                     connectionString: connStrBldr.ConnectionString, 
                     options: ConnectionOptions.Validate))
    {
        var blog = new Blog { Name = name };
        sqlconn.Execute(@"
                      INSERT INTO
                            Blog (Name)
                            VALUES (@name)", new { name = blog.Name }
                        );
    }

<span data-ttu-id="f794a-155">Hello вызовов toohello [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) API заменяет создания по умолчанию hello и открытие подключения клиента SQL.</span><span class="sxs-lookup"><span data-stu-id="f794a-155">hello call toohello [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) API replaces hello default creation and opening of a SQL Client connection.</span></span> <span data-ttu-id="f794a-156">Hello [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) hello аргументы, которые требуются для управляемой данными маршрутизацией принимает вызов:</span><span class="sxs-lookup"><span data-stu-id="f794a-156">hello [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call takes hello arguments that are required for data dependent routing:</span></span> 

* <span data-ttu-id="f794a-157">tooaccess карты сегментов Hello hello зависимых интерфейсов маршрутизации данных</span><span class="sxs-lookup"><span data-stu-id="f794a-157">hello shard map tooaccess hello data dependent routing interfaces</span></span>
* <span data-ttu-id="f794a-158">Подсегмент hello tooidentify ключа сегментирования Hello</span><span class="sxs-lookup"><span data-stu-id="f794a-158">hello sharding key tooidentify hello shardlet</span></span>
* <span data-ttu-id="f794a-159">Hello учетные данные (имя пользователя и пароль) tooconnect toohello сегментов</span><span class="sxs-lookup"><span data-stu-id="f794a-159">hello credentials (user name and password) tooconnect toohello shard</span></span>

<span data-ttu-id="f794a-160">Объект карты сегментов Hello создает подключение toohello сегмент, содержащий hello Подсегмент для заданного ключа сегментирования hello.</span><span class="sxs-lookup"><span data-stu-id="f794a-160">hello shard map object creates a connection toohello shard that holds hello shardlet for hello given sharding key.</span></span> <span data-ttu-id="f794a-161">Hello эластичной базы данных клиентские API также тега tooimplement подключения hello гарантирует ее согласованности.</span><span class="sxs-lookup"><span data-stu-id="f794a-161">hello elastic database client APIs also tag hello connection tooimplement its consistency guarantees.</span></span> <span data-ttu-id="f794a-162">С момента hello вызвать слишком[OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) возвращает обычный объект подключения клиента SQL, последующий вызов toohello hello **Execute** метод расширения из Dapper следующим hello Стандартная Dapper практика.</span><span class="sxs-lookup"><span data-stu-id="f794a-162">Since hello call too[OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) returns a regular SQL Client connection object, hello subsequent call toohello **Execute** extension method from Dapper follows hello standard Dapper practice.</span></span>

<span data-ttu-id="f794a-163">Запросы рабочих сильно hello таким же, каким образом - первом открытии соединения с помощью hello [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) из API клиента hello.</span><span class="sxs-lookup"><span data-stu-id="f794a-163">Queries work very much hello same way - you first open hello connection using [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) from hello client API.</span></span> <span data-ttu-id="f794a-164">Затем с помощью hello регулярное расширение Dapper методы toomap hello результаты SQL-запроса в объекты .NET:</span><span class="sxs-lookup"><span data-stu-id="f794a-164">Then you use hello regular Dapper extension methods toomap hello results of your SQL query into .NET objects:</span></span>

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId1, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate ))
    {    
           // Display all Blogs for tenant 1
           IEnumerable<Blog> result = sqlconn.Query<Blog>(@"
                                SELECT * 
                                FROM Blog
                                ORDER BY Name");

           Console.WriteLine("All blogs for tenant id {0}:", tenantId1);
           foreach (var item in result)
           {
                Console.WriteLine(item.Name);
            }
    }

<span data-ttu-id="f794a-165">Обратите внимание, что hello **с помощью** блок с областями подключения DDR hello всех операций базы данных в пределах hello блока toohello один сегмент хранения tenantId1.</span><span class="sxs-lookup"><span data-stu-id="f794a-165">Note that hello **using** block with hello DDR connection scopes all database operations within hello block toohello one shard where tenantId1 is kept.</span></span> <span data-ttu-id="f794a-166">Hello запрос возвращает только блоги, хранящиеся на текущий сегмент hello, но не hello тех, которые хранятся на любые другие сегменты.</span><span class="sxs-lookup"><span data-stu-id="f794a-166">hello query only returns blogs stored on hello current shard, but not hello ones stored on any other shards.</span></span> 

## <a name="data-dependent-routing-with-dapper-and-dapperextensions"></a><span data-ttu-id="f794a-167">Маршрутизация на основе данных с помощью Dapper и DapperExtensions</span><span class="sxs-lookup"><span data-stu-id="f794a-167">Data dependent routing with Dapper and DapperExtensions</span></span>
<span data-ttu-id="f794a-168">Dapper поставляется с экосистемы Дополнительные расширения, которые могут предоставить дополнительные удобства и абстракции из базы данных hello при разработке приложений баз данных.</span><span class="sxs-lookup"><span data-stu-id="f794a-168">Dapper comes with an ecosystem of additional extensions that can provide further convenience and abstraction from hello database when developing database applications.</span></span> <span data-ttu-id="f794a-169">И примером таких расширений является DapperExtensions.</span><span class="sxs-lookup"><span data-stu-id="f794a-169">DapperExtensions is an example.</span></span> 

<span data-ttu-id="f794a-170">При использовании DapperExtensions в приложении способ создания подключений к базе данных и управления ими не меняется.</span><span class="sxs-lookup"><span data-stu-id="f794a-170">Using DapperExtensions in your application does not change how database connections are created and managed.</span></span> <span data-ttu-id="f794a-171">Она по-прежнему tooopen подключения приложения hello ответственность, а обычных объектов подключения клиента SQL ожидаются методами расширения hello.</span><span class="sxs-lookup"><span data-stu-id="f794a-171">It is still hello application’s responsibility tooopen connections, and regular SQL Client connection objects are expected by hello extension methods.</span></span> <span data-ttu-id="f794a-172">Мы можно положиться на hello [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) как описано выше.</span><span class="sxs-lookup"><span data-stu-id="f794a-172">We can rely on hello [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) as outlined above.</span></span> <span data-ttu-id="f794a-173">Как hello приведенных ниже примерах кода показаны программы, hello единственным изменением является то, что мы больше не toowrite hello T-SQL инструкции:</span><span class="sxs-lookup"><span data-stu-id="f794a-173">As hello following code samples show, hello only change is that we do no longer have toowrite hello T-SQL statements:</span></span>

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId2, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate))
    {
           var blog = new Blog { Name = name2 };
           sqlconn.Insert(blog);
    }

<span data-ttu-id="f794a-174">А Вот пример кода hello для hello запроса:</span><span class="sxs-lookup"><span data-stu-id="f794a-174">And here is hello code sample for hello query:</span></span> 

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId2, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate))
    {
           // Display all Blogs for tenant 2
           IEnumerable<Blog> result = sqlconn.GetList<Blog>();
           Console.WriteLine("All blogs for tenant id {0}:", tenantId2);
           foreach (var item in result)
           {
               Console.WriteLine(item.Name);
           }
    }

### <a name="handling-transient-faults"></a><span data-ttu-id="f794a-175">Обработка временных сбоев</span><span class="sxs-lookup"><span data-stu-id="f794a-175">Handling transient faults</span></span>
<span data-ttu-id="f794a-176">Hello шаблонов и практик Майкрософт team опубликованных hello [временных Fault Handling Application Block](http://msdn.microsoft.com/library/hh680934.aspx) toohelp разработчикам устранить распространенные временная ошибка возникла при выполнении в облаке hello.</span><span class="sxs-lookup"><span data-stu-id="f794a-176">hello Microsoft Patterns & Practices team published hello [Transient Fault Handling Application Block](http://msdn.microsoft.com/library/hh680934.aspx) toohelp application developers mitigate common transient fault conditions encountered when running in hello cloud.</span></span> <span data-ttu-id="f794a-177">Дополнительные сведения см. в разделе [Perseverance, секрет все Triumphs: с помощью hello временных Fault Handling Application Block](http://msdn.microsoft.com/library/dn440719.aspx).</span><span class="sxs-lookup"><span data-stu-id="f794a-177">For more information, see [Perseverance, Secret of All Triumphs: Using hello Transient Fault Handling Application Block](http://msdn.microsoft.com/library/dn440719.aspx).</span></span>

<span data-ttu-id="f794a-178">Образец кода Hello использует hello временных сбоев библиотека tooprotect от временных сбоев.</span><span class="sxs-lookup"><span data-stu-id="f794a-178">hello code sample relies on hello transient fault library tooprotect against transient faults.</span></span> 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() =>
    {
       using (SqlConnection sqlconn = 
          shardingLayer.ShardMap.OpenConnectionForKey(tenantId2, connStrBldr.ConnectionString, ConnectionOptions.Validate))
          {
              var blog = new Blog { Name = name2 };
              sqlconn.Insert(blog);
          }
    });

<span data-ttu-id="f794a-179">**SqlDatabaseUtils.SqlRetryPolicy** в hello приведенный выше код определяется как **SqlDatabaseTransientErrorDetectionStrategy** с числом повторов, равным 10 и 5 секунд время ожидания между повторными попытками.</span><span class="sxs-lookup"><span data-stu-id="f794a-179">**SqlDatabaseUtils.SqlRetryPolicy** in hello code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span></span> <span data-ttu-id="f794a-180">При использовании транзакций убедитесь, что в данной области повтора вновь переходит toohello начало транзакции hello в случае, когда hello временных ошибок.</span><span class="sxs-lookup"><span data-stu-id="f794a-180">If you are using transactions, make sure that your retry scope goes back toohello beginning of hello transaction in hello case of a transient fault.</span></span>

## <a name="limitations"></a><span data-ttu-id="f794a-181">Ограничения</span><span class="sxs-lookup"><span data-stu-id="f794a-181">Limitations</span></span>
<span data-ttu-id="f794a-182">Hello подходов, описанных в этом документе включают несколько ограничений:</span><span class="sxs-lookup"><span data-stu-id="f794a-182">hello approaches outlined in this document entail a couple of limitations:</span></span>

* <span data-ttu-id="f794a-183">Hello образцы кода для этого документа не показано, как схема toomanage по сегментам.</span><span class="sxs-lookup"><span data-stu-id="f794a-183">hello sample code for this document does not demonstrate how toomanage schema across shards.</span></span>
* <span data-ttu-id="f794a-184">Получает запрос, мы предполагаем, что его обработку базы данных содержится в одном сегменте, идентифицируемый hello сегментирования ключ, указанный в запросе hello.</span><span class="sxs-lookup"><span data-stu-id="f794a-184">Given a request, we assume that all its database processing is contained within a single shard as identified by hello sharding key provided by hello request.</span></span> <span data-ttu-id="f794a-185">Тем не менее это предположение не всегда удерживает, например, если она не возможные toomake ключ сегментирования доступны.</span><span class="sxs-lookup"><span data-stu-id="f794a-185">However, this assumption does not always hold, for example, when it is not possible toomake a sharding key available.</span></span> <span data-ttu-id="f794a-186">tooaddress, hello клиентской библиотеке эластичной базы данных включает в себя hello [MultiShardQuery класса](http://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardexception.aspx).</span><span class="sxs-lookup"><span data-stu-id="f794a-186">tooaddress this, hello elastic database client library includes hello [MultiShardQuery class](http://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardexception.aspx).</span></span> <span data-ttu-id="f794a-187">Hello класс реализует абстракцию подключения для выполнения запросов через несколько сегментов.</span><span class="sxs-lookup"><span data-stu-id="f794a-187">hello class implements a connection abstraction for querying over several shards.</span></span> <span data-ttu-id="f794a-188">С помощью MultiShardQuery в сочетании с Dapper выходит за рамки данного документа hello.</span><span class="sxs-lookup"><span data-stu-id="f794a-188">Using MultiShardQuery in combination with Dapper is beyond hello scope of this document.</span></span>

## <a name="conclusion"></a><span data-ttu-id="f794a-189">Заключение</span><span class="sxs-lookup"><span data-stu-id="f794a-189">Conclusion</span></span>
<span data-ttu-id="f794a-190">Приложения, использующие Dapper и DapperExtensions, могут легко использовать преимущества средств эластичной базы данных SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="f794a-190">Applications using Dapper and DapperExtensions can easily benefit from elastic database tools for Azure SQL Database.</span></span> <span data-ttu-id="f794a-191">Через hello шаги, описанные в этом документе, эти приложения можно использовать средство hello возможность для данных зависимой маршрутизации, изменив hello создания и открытия нового [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) объектов toouse hello [ OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) вызов hello эластичной базы данных клиентской библиотеки.</span><span class="sxs-lookup"><span data-stu-id="f794a-191">Through hello steps outlined in this document, those applications can use hello tool's capability for data dependent routing by changing hello creation and opening of new [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects toouse hello [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call of hello elastic database client library.</span></span> <span data-ttu-id="f794a-192">Это ограничивает изменения требуется toothose приложения hello местах, где создается и открывается новые соединения.</span><span class="sxs-lookup"><span data-stu-id="f794a-192">This limits hello application changes required toothose places where new connections are created and opened.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-working-with-dapper/dapperimage1.png

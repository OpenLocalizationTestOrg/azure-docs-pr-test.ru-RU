---
title: "aaaQuery подробных сведений о производительности для базы данных SQL Azure | Документы Microsoft"
description: "Наблюдение за производительностью запросов идентифицирует hello большинство использование ЦП запрашивает в базе данных SQL Azure."
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: monicar
ms.assetid: c2f580b2-3835-453f-89f5-140e02dd2ea7
ms.service: sql-database
ms.custom: monitor & tune
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: data-management
ms.date: 07/05/2017
ms.author: sstein
ms.openlocfilehash: 01cca26f85193c679365585cd676449c9db00e1e
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="azure-sql-database-query-performance-insight"></a>Анализ производительности запросов базы данных Azure SQL
Управление и настройка производительности hello реляционных баз данных является сложной задачу, которая требуется значительный опыт и время. Анализ производительности запросов позволяет toospend меньше времени, устранение неполадок производительности базы данных, предоставляя hello следующее:

* Более глубокое понимание потребления ресурсов базы данных (DTU). 
* Hello первых запросах по количеству ЦП или длительность или выполнения, который потенциально может настраиваться для повышения производительности.
* Здравствуйте возможность toodrill вниз hello Дополнительные сведения о запросе, просмотреть его текст и журнал использования ресурсов. 
* Заметки к настройке производительности, отображающие действия [помощника по базам данных SQL Azure](sql-database-advisor.md)  



## <a name="prerequisites"></a>Предварительные требования
* Для анализа производительности запросов в базе данных должно быть активно [хранилище запросов](https://msdn.microsoft.com/library/dn817826.aspx) . Если хранилище запросов не выполняется, портал hello запрашивает tooturn ее на.

## <a name="permissions"></a>Разрешения
следующие Hello [управления доступом на основе ролей](../active-directory/role-based-access-control-what-is.md) разрешения, необходимые toouse анализ производительности запросов: 

* **Модуль чтения**, **владельца**, **участника**, **участника базы данных SQL**, или **участника SQL Server** разрешения требуется tooview hello потреблением ресурсов запросы и диаграммы. 
* **Владелец**, **участника**, **участника базы данных SQL**, или **участника SQL Server** разрешения, необходимые tooview текст запроса.

## <a name="using-query-performance-insight"></a>Использование анализа производительности запросов
Анализ производительности запросов является простой toouse:

* Откройте [портал Azure](https://portal.azure.com/) и базы данных поиска, которые должны tooexamine. 
  * В меню слева, в разделе поддержки и устранения неполадок, выберите "Анализ производительности запросов".
* На первой вкладке hello просмотрите список hello ведущих ресурсоемких запросов.
* Выберите tooview отдельного запроса сведений о нем.
* Откройте [помощник по базам данных SQL Azure](sql-database-advisor.md) и проверьте наличие рекомендаций.
* С помощью ползунков или масштабирования toochange значки наблюдается интервал.
  
    ![панель мониторинга производительности](./media/sql-database-query-performance/performance.png)

> [!NOTE]
> На пару часов данных должен toobe, записываемого хранилищем запросов для подробных сведений о производительности запросов tooprovide базы данных SQL. Если hello базы данных не содержит действий или хранилище запросов не работало в течение определенного периода времени, hello диаграммы будет пустым при отображении этого периода времени. Можно включить хранилище запросов в любой момент, если оно не запущено.   
> 
> 

## <a name="review-top-cpu-consuming-queries"></a>Просмотр запросов, максимально использующих ресурсы процессора
В hello [портала](http://portal.azure.com) hello следующие:

1. Обзор tooa базы данных SQL и нажмите кнопку **все параметры** > **поддержки + Устранение неполадок** > **анализу производительности запросов**. 
   
    ![Анализ производительности запросов][1]
   
    Откроется представление первых запросов Hello и перечислены hello первых ЦП много запросов.
2. Щелкните вокруг диаграммы hello подробные сведения.<br>Hello верхняя строка показывает общую % DTU для базы данных hello, а hello полосы показывают % ЦП, используемые запросами hello выбраны во время выбранного интервала hello (например, если **прошлая неделя** выбран каждый столбец представляет один день).
   
    ![наиболее ресурсоемкие запросы][2]
   
    Hello нижней сетке представляет статистические данные для запросов видимым hello.
   
   * Идентификатор запроса — уникальный идентификатор запроса внутри базы данных.
   * Загрузка ЦП на запрос за период наблюдения (зависит от статистической функции).
   * Длительность запроса (зависит от статистической функции).
   * Общее число выполнений определенного запроса.
     
     Установите или снимите tooinclude отдельные запросы или исключить их из диаграммы hello, с помощью флажков.
3. Если данные устаревает, щелкните hello **обновление** кнопки.
4. Можно использовать ползунки и интервал toochange кнопки масштаба и исследовать пики: ![параметры](./media/sql-database-query-performance/zoom.png)
5. При необходимости, если требуется другое представление, можно выбрать вкладку **Пользовательские** и задать:
   
   * метрику (ЦП, длительность, число выполнений);
   * интервал времени (последние 24 часа, за прошлую неделю, за прошлый месяц); 
   * количество запросов;
   * статистическую функцию.
     
     ![Параметры](./media/sql-database-query-performance/custom-tab.png)

## <a name="viewing-individual-query-details"></a>Просмотр подробных сведений для отдельного запроса
сведения о запросе tooview:

1. Щелкните любой запрос в списке hello первых запросов.
   
    ![сведения](./media/sql-database-query-performance/details.png)
2. Откроется представление сведений Hello и разбивкой число потребления или длительность или выполнения ЦП hello запросов со временем.
3. Щелкните вокруг диаграммы hello подробные сведения.
   
   * Верхней диаграмме показано строки с общей базы данных % DTU и гистограммы hello — % ЦП, использованное hello выбранного запроса.
   * Второй диаграмме показана общая длительность при hello выбранного запроса.
   * Нижней диаграмме показано общее число выполнений при hello выбранного запроса.
     
     ![сведения о запросе][3]
4. При необходимости используйте ползунки, кнопки масштаба или **параметры** toocustomize отображением данных, запросов или toopick к другому периоду времени.

## <a name="review-top-queries-per-duration"></a>Просмотр запросов с наибольшей длительностью
В hello последнее обновление анализ производительности запросов, мы представили два новых метрики, которые могут помочь выявить потенциальные узкие места: счетчика длительности и выполнения.<br>

Длительные запросы имеют наибольшую вероятность блокировки больше ресурсов, блокировки других пользователей и ограничение масштабируемости hello. Они также являются hello наиболее подходящих для оптимизации.<br>

tooidentify длительных запросов:

1. Откройте вкладку **Пользовательские** в колонке "Анализ производительности запросов" для выбранной базы данных.
2. Изменение метрики toobe **длительность**
3. Выберите количество запросов и интервал наблюдения.
4. Выберите статистическую функцию.
   
   * **Сумма** суммирует время выполнения запроса на протяжении всего интервала наблюдения.
   * **Максимум** находит запросы, время выполнения которых было максимальным на всем интервале наблюдения.
   * **AVG** находит среднее время выполнения всех выполнений запрос и Показать hello верхней вне эти средние значения. 
     
     ![Длительность запроса][4]

## <a name="review-top-queries-per-execution-count"></a>Просмотр запросов с наибольшим числом выполнений
Большое число выполнений может не влиять на саму базу данных, и использование ресурсов может быть небольшим, но общая производительность приложения может понизиться.

В некоторых случаях большое число выполнений может вызвать tooincrease сети циклов приема-передачи. Круговые пути существенно влияют на производительность. Они являются задержки toonetwork субъекта и задержка toodownstream сервера. 

Например многие веб-сайты, управляемые данными сильно доступа к базе данных hello для каждого запроса пользователя. При организации пулов соединений помогает, hello увеличить сетевой трафик и нагрузку на сервер базы данных hello может отрицательно сказаться на производительности.  Общие рекомендации — tookeep round абсолютному минимуму tooan приема-передачи.

tooidentify часто выполняемые запросы («нестабильной») запросы:

1. Откройте вкладку **Пользовательские** в колонке "Анализ производительности запросов" для выбранной базы данных.
2. Изменение метрики toobe **число выполнений**
3. Выберите количество запросов и интервал наблюдения.
   
    ![Число выполнений запроса][5]

## <a name="understanding-performance-tuning-annotations"></a>Основные сведения о заметках к настройке производительности
При просмотре в анализ производительности запросов рабочей нагрузки, можно заметить значков с вертикальной линии в верхней части диаграммы hello.<br>

Эти значки — заметки. Они представляют действия, влияющие на производительность, которые выполняет [помощник по базам данных SQL Azure](sql-database-advisor.md). Путем наведения указателя заметки получить основные сведения о действии hello:

![Заметка к запросу][6]

Если требуется несколько tooknow или применить рекомендации, щелкните значок hello. Отобразятся подробные сведения о действии. При наличии активной рекомендации ее можно немедленно применить с помощью команды.

![Сведения заметки к запросу][7]

### <a name="multiple-annotations"></a>Несколько заметок
Это возможно, что из-за уровень масштаба заметки, закрыть tooeach других будет получить сворачиваться в один. В этом случае отображается специальный значок. Если щелкнуть его, откроется новая колонка со списком сгруппированных заметок.
Корреляция запросов и действий по настройке производительности могут помочь toobetter сведения о рабочей нагрузке. 

## <a name="optimizing-hello-query-store-configuration-for-query-performance-insight"></a>Оптимизация hello конфигурацию хранилища запросов для анализ производительности запросов
Во время использования анализ производительности запросов могут возникнуть следующие хранилища запросов сообщений hello:

* "Хранилище запросов настроено неоптимальным образом для этой базы данных. Щелкните здесь, дополнительные toolearn.»
* "Хранилище запросов настроено неоптимальным образом для этой базы данных. Щелкните здесь параметры toochange.» 

Эти сообщения обычно отображаются, когда хранилище запросов не может toocollect новых данных. 

Первый случай происходит, когда хранилище запросов находится в состоянии "только чтение" и заданы оптимальные параметры. Это можно исправить, увеличив размер хранилища запросов или очистив его.

![Кнопка для qds][8]

Второй случай происходит, когда хранилище запросов отключено или не заданы оптимальные параметры. <br>Hello хранения и отслеживания политик и включить хранилище запросов можно изменить, выполнив приведенную ниже команду, или непосредственно с портала:

![Кнопка для qds][9]

### <a name="recommended-retention-and-capture-policy"></a>Рекомендуемая политика хранения и отслеживания
Политики хранения бывают двух видов.

* Размер от - при достижении tooAUTO набора, он будет очистить данные автоматически при рядом с максимальным размером.
* На основе - времени по умолчанию, мы установим too30 дней, означающее, что, если хранилище запросов будет не останется свободного места, он приведет к удалению запрашивать данные старше 30 дней

Для политики отслеживания доступны следующие параметры.

* **All** — фиксируются все запросы.
* **Auto** — редкие запросы и запросы с незначительным временем компиляции и выполнения игнорируются. Пороговые значения счетчика, а также времени компиляции и выполнения определяются внутренним образом. Это параметр по умолчанию hello.
* **Нет** — хранилище запросов прекращает запись новых запросов, однако по-прежнему собирает статистику выполнения уже записанных запросов.

Рекомендуется установить все tooAUTO политики и политики чистой too30 дней:

    ALTER DATABASE [YourDB] 
    SET QUERY_STORE (SIZE_BASED_CLEANUP_MODE = AUTO);

    ALTER DATABASE [YourDB] 
    SET QUERY_STORE (CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 30));

    ALTER DATABASE [YourDB] 
    SET QUERY_STORE (QUERY_CAPTURE_MODE = AUTO);

Увеличение размера хранилища запросов. Это может быть выполнено подключение базы данных tooa и выдают следующий запрос:

    ALTER DATABASE [YourDB]
    SET QUERY_STORE (MAX_STORAGE_SIZE_MB = 1024);

Применение этих параметров в конечном счете хранилище запросов, сбор новых запросов, однако если вы не хотите toowait можно очистить хранилище запросов. 

> [!NOTE]
> Выполнение следующего запроса приведет к удалению всех текущие данные в хранилище запросов hello. 
> 
> 

    ALTER DATABASE [YourDB] SET QUERY_STORE CLEAR;


## <a name="summary"></a>Сводка
Анализ производительности запросов помогает понять влияние рабочей нагрузки запросов hello и его связь toodatabase потребления ресурсов. С помощью этой функции будет Узнайте о hello самые ресурсоемкие запросы и легко определять toofix hello из них, прежде чем они станут проблемы.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные рекомендации о повышении производительности hello вашей базы данных SQL щелкните [рекомендации](sql-database-advisor.md) на hello **анализ производительности запросов** колонку.

![Помощник по производительности](./media/sql-database-query-performance/ia.png)

<!--Image references-->
[1]: ./media/sql-database-query-performance/tile.png
[2]: ./media/sql-database-query-performance/top-queries.png
[3]: ./media/sql-database-query-performance/query-details.png
[4]: ./media/sql-database-query-performance/top-duration.png
[5]: ./media/sql-database-query-performance/top-execution.png
[6]: ./media/sql-database-query-performance/annotation.png
[7]: ./media/sql-database-query-performance/annotation-details.png
[8]: ./media/sql-database-query-performance/qds-off.png
[9]: ./media/sql-database-query-performance/qds-button.png


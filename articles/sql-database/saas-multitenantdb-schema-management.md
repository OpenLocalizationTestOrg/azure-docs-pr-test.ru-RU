---
title: "Управление схемой базы данных SQL Azure в примере мультитенантного приложения | Документация Майкрософт"
description: "Управление схемой для нескольких клиентов в мультитенантном приложении, использующем базу данных SQL Azure"
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: MightyPen
manager: craigg
editor: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: Inactive
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/03/2018
ms.reviewers: billgib
ms.author: genemi
ms.openlocfilehash: 135764a7d89dcf711ff7fe9416850f1af9329479
ms.sourcegitcommit: df4ddc55b42b593f165d56531f591fdb1e689686
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/04/2018
---
# <a name="manage-schema-for-multiple-tenants-in-a-multi-tenant-application-that-uses-azure-sql-database"></a>Управление схемой для нескольких клиентов в мультитенантном приложении, использующем Базу данных SQL Azure

Этот учебник анализирует трудности при обеспечении потенциально больших флот баз данных в программное обеспечение как услуга (SaaS) приложение в облаке. Демонстрируются решения по управлению расширения схемы, которые разрабатываются и реализована в течение жизненного цикла приложения.

По мере развития любого приложения, изменения могут возникнуть в столбцах таблицы или другую схему или ее ссылочных данных или производительности, связанных элементов. С помощью приложения SaaS эти изменения должны быть развернуты в виде согласованных через многочисленные базы данных клиента. И эти изменения должны быть включены в будущем клиента базы данных, которые будут добавлены в приложение. Поэтому изменения также должны быть включены в процесс, который подготавливает новые базы данных.

#### <a name="two-scenarios"></a>Два сценария

Этот учебник рассматриваются следующие два сценария:
- Развертывание обновлений данных ссылку для всех клиентов.
- Retuning индекса для таблицы, содержащей ссылочных данных.

[Эластичной задания](sql-database-elastic-jobs-overview.md) функции базы данных SQL Azure используется для выполнения этих операций в базах данных клиента. Задания также работают с золотой шаблона базы данных клиента. Этот шаблон используется в том случае, когда подготовлены новых баз данных.

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * Создайте учетную запись задания.
> * Запрос нескольких клиентов.
> * Обновление данных во всех базах данных клиента.
> * Создайте индекс для таблицы во всех базах данных клиента.

## <a name="prerequisites"></a>Технические условия

- Уже должно быть развернуто приложение Wingtip билеты:
    - Инструкции см. в разделе первый учебник, в котором описана *билеты Wingtip* приложению SaaS базы данных нескольких клиентов:<br />[Развернуть и изучить сегментированных мультитенантное приложение, который использует базу данных SQL Azure](saas-multitenantdb-get-started-deploy.md).
        - Процесс развертывания выполняется меньше, чем на пять минут.
    - Необходимо иметь *сегментированных несколькими клиентами* версии Wingtip установлен. Версии для *автономный* и *базы данных каждому клиенту* не поддерживают присутствует учебника.

- Должна быть установлена последняя версия служб SQL Server Management Studio (SSMS). [Загрузите и установите SSMS](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).

- Необходимо установить Azure PowerShell. Дополнительные сведения см. в разделе [Приступая к работе с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

> [!NOTE]
> В этом учебнике используются функции службы базы данных SQL Azure, в ограниченной предварительной версии ([заданий эластичных баз данных](sql-database-elastic-database-client-library.md)). Если вы хотите выполнить задания этого учебника, укажите идентификатор своей подписки для  *SaaSFeedback@microsoft.com*  с темой = предварительной версией гибкого заданий. Получив подтверждение о включении подписки, [скачайте и установите предварительную версию командлетов заданий](https://github.com/jaredmoo/azure-powershell/releases). Эта предварительная версия ограничен, поэтому обратитесь к  *SaaSFeedback@microsoft.com*  для связанных вопросы или в службу поддержки.

## <a name="introduction-to-saas-schema-management-patterns"></a>Общие сведения о шаблонах управления схемой SaaS

Модель сегментированной базы данных нескольких клиентов, используемый в этом примере позволяет клиентам базу данных для одного или нескольких клиентов. В этом примере рассматриваются могут использовать сочетание многие клиента и один клиент базы данных, включение *гибридных* модель управления клиента. Управление этими базами данных сложен. [Задания обработки эластичных БД](sql-database-elastic-jobs-overview.md) упрощают администрирование уровня данных SQL и управление им. Задания позволяют безопасно и быстро запустить скрипты Transact-SQL как задачи для группы баз данных клиента. Задачи не зависят от взаимодействия с пользователем или входные данные. Этот метод можно использовать для развертывания изменений схемы или общие ссылочных данных распределяются по всем клиентам в приложении. Эластичной задания может также использоваться для поддержания копии золотой шаблона базы данных. Этот шаблон используется для создания новых клиентов, всегда обеспечивая последнюю схему и ссылочных данных, используются.

![экран](media/saas-multitenantdb-schema-management/schema-management.png)

## <a name="elastic-jobs-limited-preview"></a>Ограниченная предварительная версия заданий обработки эластичных БД

Имеется новая версия эластичной заданий, теперь является интегрированной функцией базы данных SQL Azure. По интеграции означает, что он не требует дополнительных служб или компонентов. Сейчас новая версия заданий обработки эластичных БД находится на этапе ограниченной предварительной версии. Ограниченной предварительной версии в настоящее время поддерживает PowerShell для создания учетных записей заданий и T-SQL для создания и управления заданиями.

## <a name="get-the-wingtip-tickets-saas-multi-tenant-database-application-source-code-and-scripts"></a>Получение скриптов и исходного кода для SaaS-приложения Wingtip Tickets c мультитенантной БД

Скрипты базы данных для нескольких клиентов SaaS билеты Wingtip и исходный код приложения были доступны в [WingtipTicketsSaaS MultitenantDB](https://github.com/microsoft/WingtipTicketsSaaS-MultiTenantDB) репозитория в Github. В разделе [Общие рекомендации](saas-tenancy-wingtip-app-guidance-tips.md) для действия для загрузки и разблокировать сценарии SaaS Wingtip билетов. 

## <a name="create-a-job-account-database-and-new-job-account"></a>Создание базы данных учетных записей заданий и учетной записи задания

Этот учебник требует использовать PowerShell для создания базы данных учетных записей задания и задания учетной записи. Как базы данных MSDB используется агентом SQL эластичной заданий использует базу данных Azure SQL для хранения определения заданий, состояние задания и журнал. После создания учетной записи задания можно создавать и отслеживать задания немедленно.

1. В **интегрированной среды Сценариев PowerShell**откройте *... \\Модулях обучения\\управление схемой\\SchemaManagement.ps1 Демонстрация*.
2. Нажмите клавишу **F5** для запуска скрипта.

*Демонстрация SchemaManagement.ps1* скрипт вызывает *развернуть SchemaManagement.ps1* скрипт для создания уровня *S2* базы данных с именем **jobaccount** на сервере каталога. После этого скрипт создает задание учетной записи, передавая jobaccount базы данных в качестве параметра для вызова метода задания создания учетной записи.

## <a name="create-a-job-to-deploy-new-reference-data-to-all-tenants"></a>Создание задания и развертывание новых справочных данных на всех клиентах

#### <a name="prepare"></a>Подготовка.

Каждая база данных клиентов включает набор типов помещения в **VenueTypes** таблицы. Типы проведения определять тип событий, которые размещаются на место проведения. В этом упражнении развернуть обновление для всех баз данных для добавления двух дополнительных проведения типов: *мотоцикла трассировки* и *сообщество бассейне*. Эти типы объектов соответствуют фоновому изображению, которое отображается в приложении событий клиента.

Перед развертыванием нового ссылочных данных, запишите номер помещения типов, которые уже существуют, который может быть 10. Take заметки, щелкните следующую ссылку, чтобы Wingtip веб-интерфейса и выбрав **проведения тип** раскрывающееся меню:
- http://Events.Wingtip-MT.<USER>. trafficmanager.net

Теперь можно подсчитать количество типов исходное место проведения. В частности, обратите внимание, что ни один *мотоцикла трассировки* , ни *сообщество бассейне* еще существует.

#### <a name="steps"></a>Действия

Теперь можно создавать задания по обновлению **VenueTypes** таблицы в каждой базе данных клиентов, добавив два новых типа место проведения.

Чтобы создать новое задание, используйте набор системных хранимых процедур заданий, которые были созданы в *jobaccount* базы данных. Процедуры были созданы при создании задания учетной записи.

1. В среде SSMS подключитесь к серверу клиента: tenants1-mt-\<пользователь\>.database.windows.net

2. Перейдите к *tenants1* базы данных на *tenants1-mt -\<пользователя\>. database.windows.net* сервера.

3. Запрос *VenueTypes* таблицы, чтобы убедиться, что *мотоцикла трассировки* и *сообщество бассейне* которых еще нет в списке результатов.

4. Подключиться к серверу каталога, который является *каталога-mt -\<пользователя\>. database.windows.net*.

5. Подключиться к *jobaccount* базы данных на сервере каталога.

6. Откройте файл в SSMS, *... \\Модулях обучения\\управление схемой\\DeployReferenceData.sql*.

7. Измените инструкцию: set @User = &lt;пользователь&gt;, заменив значение "пользователь" значением, использованным при развертывании SaaS-приложения Wingtip Tickets c мультитенантной базой данных.

8. Нажмите клавишу **F5** для запуска скрипта.

#### <a name="observe"></a>Наблюдение

Просмотрите следующие элементы в *DeployReferenceData.sql* сценария:

- **SP\_добавить\_целевой\_группы** создает имя целевой группы *DemoServerGroup*, и добавляет в группу целевые элементы.

- **SP\_добавить\_целевой\_группы\_члена** добавляет следующие элементы:
    - Объект *сервера* целевой тип члена.
        - Это *tenants1-mt -&lt;пользователя&gt;*  сервер, содержащий базы данных клиентов.
        - Таким образом все базы данных на сервере будут включены в задание, при выполнении задания.
    - Объект *базы данных* целевой тип члена эталонные базы данных (*basetenantdb*), находящийся на *каталога-mt -&lt;пользователя&gt;*  server,
    - Объект *базы данных* целевой тип члена, чтобы включить *adhocreporting* базы данных, используемый в этом руководстве.

- **SP\_добавить\_задания** создает задание называется *развертывания ссылочных данных*.

- **sp\_add\_jobstep** создает шаг задания, содержащий текст команды T-SQL для обновления ссылочной таблицы VenueTypes.

- Остальные представления в скрипте отображают сведения о существовании объектов и отслеживают выполнение задания мониторинга. На эти запросы можно просмотреть значения состояния в **жизненного цикла** столбца, чтобы определить, когда задание успешно выполнено. Задание обновляет базу данных клиентов и обновляет два дополнительных баз данных, содержащих ссылочной таблицы.

В SSMS, найдите баз данных клиентов на *tenants1-mt -&lt;пользователя&gt;*  сервера. Запрос *VenueTypes* таблицы, чтобы убедиться, что *мотоцикла трассировки* и *сообщество бассейне* добавляются в таблицу. Общее число типов проведения должно увеличиться на два.

## <a name="create-a-job-to-manage-the-reference-table-index"></a>Создание задания для управления индексом справочной таблицы

В этом упражнении похож на предыдущем упражнении. В этом упражнении создает задание для перестроения индекса для первичного ключа таблицы ссылок. Перестроение индекса является операция управления обычной базой данных, администратор может выполняться после загрузки больших объемов данных в таблицу, чтобы повысить производительность.

1. В среде SSMS, подключиться к *jobaccount* базы данных в *каталога-mt -&lt;пользователя&gt;. database.windows.net* сервера.

2. Откройте в среде SSMS *... \\Модулях обучения\\управление схемой\\OnlineReindex.sql*.

3. Нажмите клавишу **F5** для запуска скрипта.

#### <a name="observe"></a>Наблюдение

Просмотрите следующие элементы в *OnlineReindex.sql* сценария:

* **SP\_добавить\_задания** создает новое задание называется *Online переиндексации PK\_\_VenueTyp\_\_265E44FD7FD4C885*.

* **sp\_add\_jobstep** создает шаг задания, содержащий текст команды T-SQL для обновления индекса.

* Остальные представления в скрипте отслеживают выполнение задания. На эти запросы можно просмотреть значения состояния в **жизненного цикла** столбца, чтобы определить, когда задание успешного завершения работы на все члены группы целевых.

## <a name="additional-resources"></a>Дополнительные ресурсы

<!-- TODO: Additional tutorials that build upon the Wingtip Tickets SaaS Multi-tenant Database application deployment (*Tutorial link to come*)
(saas-multitenantdb-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials)
-->
* [Управление масштабируемыми облачными базами данных](sql-database-elastic-jobs-overview.md)
* [Создание развернутых баз данных SQL Azure и управление ими с помощью заданий обработки эластичных БД (предварительная версия)](sql-database-elastic-jobs-create-and-manage.md)

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> - Создайте учетную запись задания для запроса нескольких клиентов.
> - Обновление данных во всех базах данных клиента.
> - Создайте индекс для таблицы во всех базах данных клиента.

Далее см. статью [Выполнение запросов автоматизированной системы отчетности к нескольким базам данных SQL Azure](saas-multitenantdb-adhoc-reporting.md).


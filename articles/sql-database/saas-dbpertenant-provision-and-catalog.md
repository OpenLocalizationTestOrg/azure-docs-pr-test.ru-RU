---
title: "Подготовка новых клиентов в мультитенантном приложении, использующем базу данных SQL Azure | Документация Майкрософт"
description: "Сведения о подготовке и каталогизации новых клиентов в приложении SaaS мультитенантной базы данных SQL Azure"
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: Inactive
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/11/2017
ms.author: sstein
ms.openlocfilehash: b82623f63681daff502f1e23d052da7480dda942
ms.sourcegitcommit: f847fcbf7f89405c1e2d327702cbd3f2399c4bc2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2017
---
# <a name="learn-how-to-provision-new-tenants-and-register-them-in-the-catalog"></a>Сведения о подготовке новых клиентов и их регистрации в каталоге

Из этого руководства вы узнаете о шаблонах SaaS для подготовки и каталогизации, а также об их реализации в SaaS-приложении Wingtip Tickets c однотенантной БД. Мы создадим и инициализируем базы данных клиента, а также зарегистрируем их в каталоге приложения клиента. Каталог — это база данных, поддерживающая сопоставление между разными клиентами приложений SaaS и их данными. Каталог играет важную роль, направляя запросы приложений и управляющие запросы к надлежащим базам данных.  

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]

> * Подготовка и пошаговая реализация отдельного нового клиента.
> * Подготовка пакета дополнительных клиентов.


Для работы с этим руководством выполните следующие предварительные требования:

* Разверните SaaS-приложение Wingtip Tickets c однотенантной БД для каждого клиента. Вы можете развернуть SaaS-приложение Wingtip Tickets c однотенантной БД менее чем за пять минут, используя инструкции из [этой статьи](saas-dbpertenant-get-started-deploy.md).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

## <a name="introduction-to-the-saas-catalog-pattern"></a>Общие сведения о шаблоне каталога SaaS

В мультитенантном приложении SaaS на основе базы данных важно знать, где хранятся сведения для каждого клиента. В схеме работы с каталогом SaaS используется база данных каталога, в которой содержатся сопоставления между клиентами и их базами данных. В этом руководстве мы рассмотрим SaaS-приложение Wingtip Tickets c однотенантной БД. Базовая схема хранения в каталоге сопоставлений клиентов с базами данных применяется при любом распределении данных между несколькими базами данных независимо от количества клиентов.

Каждому клиенту присваивается ключ, идентифицирующий его в каталоге и сопоставленный с расположением соответствующей базы данных. В SaaS-приложении Wingtip Tickets ключ формируется из хэша имени клиента. Это позволяет использовать часть имени клиента, представляющую URL-адрес приложения, для создания ключа. Можно использовать и другие схемы ключа клиента.  

Каталог позволяет изменять имя или расположение базы данных с минимальным воздействием на приложение.  В мультитенантной модели базы данных это также обеспечивает перемещение клиента между базами данных.  Кроме того, каталог можно использовать, чтобы указать, находится ли клиент или база данных в автономном режиме для обслуживания или других действий. Это рассматривается в руководстве [Восстановление базы данных SQL клиентов SaaS Wingtip](saas-dbpertenant-restore-single-tenant.md).

Кроме того, в каталоге, который, по сути, является базой данных управления для приложения SaaS, можно сохранить дополнительные метаданные клиента или базы данных. Например, сведения об уровне или выпуске базы данных, версии схемы, плане обслуживания, а также соглашения об уровне обслуживания, доступные для клиентов, и другую информацию, которая позволяет осуществлять управление приложениями, поддержку пользователей или процессы DevOps.  

Помимо функций для приложения SaaS, каталог позволяет включить средства для баз данных.  В нашем примере SaaS-приложения Wingtip Tickets c однотенантной БД каталог поддерживает запросы для нескольких клиентов. Такая схема подробно описана в [руководстве по автоматизированной системе аналитики](saas-tenancy-adhoc-analytics.md). Межбазовое управление заданиями рассматривается в руководствах [Управление схемой для нескольких клиентов в приложении SaaS Wingtip](saas-tenancy-schema-management.md) и [Извлечение данных из баз данных клиента в базу данных аналитики для автономного анализа](saas-tenancy-tenant-analytics.md). 

Каталог в SaaS-приложении Wingtip Tickets реализуется с помощью функций управления сегментами из [клиентской библиотеки эластичной базы данных (EDCL)](sql-database-elastic-database-client-library.md). EDCL доступна для Java и платформы .NET. EDCL позволяет приложению создавать, администрировать и использовать карту сегментов на основе базы данных. Карта сегментов содержит список сегментов (баз данных) и сопоставления между ключами (клиентами) и сегментами.  Функции EDCL можно использовать в приложениях или скриптах PowerShell при подготовке клиента, чтобы создавать записи в карте сегментов, а также в приложениях для эффективного подключения к нужной базе данных. EDCL кэширует сведения о подключении, чтобы уменьшить объем входящего трафика для базы данных каталога и ускорить работу приложения.  

> [!IMPORTANT]
> Данные сопоставления доступны в базе данных каталога. *Не изменяйте их*. Изменяйте данные сопоставления только с помощью интерфейсов API EDCL. Прямые манипуляции с данными сопоставления могут привести к повреждению каталога. Такие операции не поддерживаются.


## <a name="introduction-to-the-saas-provisioning-pattern"></a>Общие сведения о шаблоне подготовки SaaS

Когда в приложении SaaS подключается новый клиент, использующей модель базы данных с одним клиентом, базу данных клиента необходимо подготовить.  Она должна быть создана в нужном расположении с настройкой требуемого уровня обслуживания, инициализирована с надлежащей схемой и ссылочными данными, а затем зарегистрирована в каталоге с соответствующим ключом клиента.  

При подготовке базы данных можно использовать разные подходы, например скрипты SQL, развертывание BACPAC или копирование шаблона базы данных.  

Используемый метод подготовки должен охватывать общую стратегию управления схемой, чтобы обеспечить подготовку новых баз по последней схеме.  Это описано в руководстве [Управление схемой для нескольких клиентов в приложении SaaS Wingtip](saas-tenancy-schema-management.md).  

Рассматриваемое SaaS-приложение Wingtip Tickets c однотенантной БД предоставляет для каждого клиента отдельную копию базы данных, шаблон которой развернут на сервере каталога с именем _basetenantdb_.  Подготовку можно интегрировать в приложение как часть процесса регистрации, и (или) поддерживать в автономном режиме с помощью скриптов. В этом руководстве описана подготовка с помощью PowerShell. При помощи скриптов подготовки копируется база данных basetenantdb и для клиента создается новая база данных в эластичном пуле. Затем в нее вносятся начальные сведения о клиенте и новая база данных регистрируется в карте сегментов каталога.  В нашем примере SaaS-приложения Wingtip Tickets c однотенантной БД все имена баз данных создаются на основе имени клиента. Но такое именование использовать не обязательно. Каталог позволяет присвоить базе данных клиента любое имя.+ 


## <a name="get-the-wingtip-tickets-saas-database-per-tenant-application-scripts"></a>Получение скриптов для SaaS-приложения Wingtip Tickets c однотенантной БД

Сценарии для приложения SaaS Wingtip Tickets c мультитенантной базой данных и исходный код этого приложения вы найдете в репозитории GitHub [WingtipTicketsSaaS-DbPerTenant](https://github.com/Microsoft/WingtipTicketsSaaS-DbPerTenant). Инструкции по скачиванию и разблокированию сценариев приложения SaaS Wingtip Tickets см. в статье [Общие рекомендации по работе с примерами приложений SaaS Wingtip Tickets](saas-tenancy-wingtip-app-guidance-tips.md).


## <a name="provision-and-catalog-detailed-walkthrough"></a>Подробное пошаговое руководство по подготовке и каталогизации

Чтобы понять, как приложение Wingtip подготавливает новый клиент, добавьте точку останова и ознакомьтесь с пошаговым процессом подготовки клиента:

1. В _интегрированной среде сценариев PowerShell_ откройте файл …\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ и задайте следующие параметры:
   * **$TenantName** — имя нового мероприятия (например, *Bushwillow Blues*).
   * **$VenueType** — один из предопределенных типов мероприятия: *blues*, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer.
   * Для параметра **$DemoScenario** =  установите значение **1**, чтобы *подготовить один клиент*.

1. Добавьте точку останова, поместив курсор в любом месте строки 48, содержащей *New-Tenant `*, и нажмите клавишу **F9**.

   ![точка останова](media/saas-dbpertenant-provision-and-catalog/breakpoint.png)

1. Нажмите клавишу **F5** для запуска сценария.

1. После остановки выполнения сценария в точке останова нажмите клавишу **F11**, чтобы пошагово выполнить код.

   ![Отладка](media/saas-dbpertenant-provision-and-catalog/debug.png)



Отслеживайте выполнение сценария и используйте клавиши **F10** и **F11** (меню **Отладка**), чтобы обойти вызываемые функции или перейти в них по очереди. Дополнительные сведения об отладке сценариев PowerShell см. в разделе [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise).


Ниже приведены не конкретные действия, а описание рабочего процесса отладки сценария.

1. **Импорт модуля SubscriptionManagement.psm1**, который содержит функции для входа в Azure и выбора рабочей подписки Azure.
1. **Импорт модуля CatalogAndDatabaseManagement.psm1**, предоставляющего каталог и абстракцию на уровне клиента с помощью функций[управления сегментами](sql-database-elastic-scale-shard-map-management.md). Это важный модуль, который инкапсулирует большую часть шаблона каталога. Его следует изучить.
1. **Получение сведений о конфигурации.** Перейдите к Get-Configuration (нажав клавишу F11) и посмотрите, как указывается конфигурация приложения. Здесь определяются имена ресурсов и другие значения для конкретного приложения, но не изменяйте эти значения, пока вы не изучите скрипты.
1. **Получение объекта каталога.** Перейдите к функции Get-Catalog, которая составляет и возвращает объект каталога, используемый в скрипте более высокого уровня.  При этом используются функции управления сегментами, импортируемые из **AzureShardManagement.psm1**. Каталог состоит из следующих компонентов:
   * $catalogServerFullyQualifiedName создается с использованием стандартного корня, а также имени пользователя: _catalog-\<пользователь\>.database.windows.net_.
   * $catalogDatabaseName извлекается из файла конфигурации: *tenantcatalog*.
   * Объект $shardMapManager инициализируется из базы данных каталога.
   * Объект $shardMap инициализируется из карты сегментов *tenantcatalog* в базе данных каталога.
   Объект каталога формируется, возвращается и используется в скрипте более высокого уровня.
1. **Вычисление нового ключа клиента.** Для создания ключа клиента из имени клиента используется хэш-функция.
1. **Проверка наличия ключа клиента.** Каталог проверяется, чтобы убедиться, что ключ доступен.
1. **Подготовка базы данных клиента с помощью New-TenantDatabase.** Используйте клавишу **F11**, чтобы перейти к функции и узнать, как база данных подготавливается с помощью [шаблона Azure Resource Manager](../azure-resource-manager/resource-manager-template-walkthrough.md).

    Имя базы данных создается на основе имени клиента, чтобы было ясно, какие сегменты принадлежит определенному клиенту. (Вы можете использовать другие стратегии именования базы данных.) При помощи шаблона Resource Manager создается база данных клиента. Для этого шаблон базы данных baseTenantDB копируется на сервер каталога. Альтернативный подход заключается в том, чтобы создать пустую базу данных, а затем инициализировать ее, импортировав BACPAC-файл, или выполнить скрипт инициализации из хорошо известного расположения.  

    Шаблон Resource Manager находится в папке …\Learning Modules\Common\: *tenantdatabasecopytemplate.json*

1. Созданная база данных клиента **инициализируется с помощью имени мероприятия (клиента) и его типа**. Также здесь можно выполнить другие действия по инициализации.

1. **База данных клиента регистрируется в каталоге** с использованием функции *Add-TenantDatabaseToCatalog* и ключа клиента. Используйте клавишу **F11**, чтобы просмотреть подробные сведения:

    * База данных каталога добавляется на карту сегментов (список известных баз данных).
    * Создается сопоставление, которое связывает значение ключа с сегментом.
    * В таблицу Tenants в каталоге добавляются дополнительные метаданные о клиенте (имя объекта).  Таблица клиентов не входит в схему ShardManagement и не устанавливается EDCL.  В этой таблице показано, как базу данных каталога можно расширить для поддержки дополнительных данных приложения.   


По завершении подготовки возобновляется выполнение исходного скрипта *Demo-ProvisionAndCatalog*, который открывает в браузере страницу **События** для нового клиента:

   ![events](media/saas-dbpertenant-provision-and-catalog/new-tenant.png)


## <a name="provision-a-batch-of-tenants"></a>Подготовка пакета клиентов

В этом упражнении подготавливается пакет из 17 клиентов. Рекомендуем подготовить этот пакет клиентов перед переходом к другим руководствам по SaaS-приложению Wingtip Tickets c однотенантной БД. Вам будет удобнее с ними работать при наличии достаточного количества баз данных.

1. В *интегрированной среде сценариев PowerShell* откройте файл …\\Learning Modules\\ProvisionAndCatalog\\*Demo-ProvisionAndCatalog.ps1* и измените значение параметра *$DemoScenario* на 3.
   * Для параметра **$DemoScenario** =  установите значение **3**, чтобы *подготовить пакет клиентов*.
1. Нажмите клавишу **F5** для запуска скрипта.

Скрипт подготовит пакет дополнительных клиентов. Он использует [шаблон Azure Resource Manager](../azure-resource-manager/resource-manager-template-walkthrough.md), который управляет пакетом, а затем подготавливает каждую базу данных в связанном шаблоне. При использовании шаблонов таким способом Azure Resource Manager выступает в качестве посредника в процессе подготовки скрипта. Шаблоны подготавливают базы данных в параллельном режиме, когда это возможно, и выполняют повторные попытки в случае необходимости, чтобы оптимизировать общий процесс. Сценарий является идемпотентным, поэтому, если при его выполнении произойдет сбой или по какой-либо причине он остановится, запустите его еще раз.

### <a name="verify-the-batch-of-tenants-successfully-deployed"></a>Проверка успешного развертывания пакета клиентов

* На [портале Azure](https://portal.azure.com) перейдите к списку серверов и откройте сервер *tenants1*. Щелкните **Базы данных SQL** и убедитесь, что в списке появились 17 новых баз данных.

   ![список баз данных](media/saas-dbpertenant-provision-and-catalog/database-list.png)



## <a name="other-provisioning-patterns"></a>Другие шаблоны подготовки

Далее представлены другие шаблоны подготовки, которые не рассматриваются в этом руководстве.

**Предварительная подготовка баз данных.** В шаблоне предварительной подготовки учитывается тот факт, что базы данных в эластичном пуле не создают дополнительных затрат. Счета выставляются за эластичный пул, а не за базы данных, и простаивающие базы данных не потребляют ресурсы. Предварительная подготовка баз данных в пуле и их выделение при необходимости может значительно сократить время адаптации клиента. Вы можете заранее подготовить любое удобное количество баз данных, чтобы поддерживать буфер достаточного размера для ожидаемого темпа добавления клиентов.

**Автоматическая подготовка.** В схеме автоматической подготовки используется служба, которая по мере необходимости автоматически подготавливает новые серверы, пулы и базы данных, в том числе при необходимости предварительно подготавливает базы данных в эластичных пулах. Также служба подготовки заполняет свободные места, которые появляются в эластичных пулах по мере вывода из эксплуатации и удаления баз данных. Такая служба может быть простой или более сложной. С ее помощью можно, например, управлять подготовкой в нескольких географических регионах и (или) настраивать георепликацию для аварийного восстановления. При использовании схемы автоматической подготовки запрос на подготовку с помощью клиентского приложения или скрипта помещается в очередь службы подготовки. Затем из этой службы поступает информация о завершении подготовки. Если используется предварительная подготовка, запрос обрабатывается быстро и служба подготовки в фоновом режиме создает новую базу данных взамен использованной.



## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]

> * Подготовка нового клиента.
> * Подготовка пакета дополнительных клиентов.
> * Получение сведений о подготовке клиентов и их регистрация в каталоге.

Ознакомьтесь с [руководством по мониторингу производительности](saas-dbpertenant-performance-monitoring.md).

## <a name="additional-resources"></a>дополнительные ресурсы.

* Дополнительные [руководства по SaaS-приложению Wingtip Tickets c однотенантной БД](saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials).
* [Клиентская библиотека эластичной базы данных](sql-database-elastic-database-client-library.md)
* [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise)

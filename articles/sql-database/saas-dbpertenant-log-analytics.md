---
title: "Использование Log Analytics с помощью мультитенантного приложения базы данных SQL | Документация Майкрософт"
description: "Настройка и использование Log Analytics (OMS) с мультитенантным приложением SaaS для Базы данных SQL Azure"
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: Inactive
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 11/13/2017
ms.author: billgib; sstein
ms.openlocfilehash: 48e8eb91a5febcc1109bee3404bb534bd0391f88
ms.sourcegitcommit: f847fcbf7f89405c1e2d327702cbd3f2399c4bc2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2017
---
# <a name="set-up-and-use-log-analytics-oms-with-a-multi-tenant-azure-sql-database-saas-app"></a>Настройка и использование Log Analytics (OMS) с мультитенантным приложением SaaS для базы данных SQL Azure

В этом руководстве описывается настройка и использование *Log Analytics ([OMS](https://www.microsoft.com/cloud-platform/operations-management-suite))* для мониторинга эластичных пулов и баз данных. Это руководство основано на [руководстве по мониторингу производительности и управлению ею](saas-dbpertenant-performance-monitoring.md). Здесь показано, как использовать *Log Analytics* для расширения возможностей мониторинга и оповещений на портале Azure. Служба Log Analytics хорошо подходит для мониторинга и создания оповещений с возможностью масштабирования, так как она поддерживает сотни пулов и сотни тысяч баз данных. Она также обеспечивает единое решение для мониторинга, с помощью которого можно отслеживать интеграцию разных приложений и служб Azure в нескольких подписках Azure.

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Установка и настройка Log Analytics (OMS).
> * Использование Log Analytics для мониторинга пулов и баз данных.

Для работы с этим руководством выполните следующие предварительные требования:

* Развернуть SaaS-приложение Wingtip Tickets c однотенантной базой данных. См. инструкции из руководства по быстрому [развертыванию SaaS-приложение Wingtip Tickets c однотенантной БД](saas-dbpertenant-get-started-deploy.md).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

Обсуждение сценариев и шаблонов SaaS и их влияния на требования к решениям для мониторинга см. в статье [Мониторинг производительности примера приложения SaaS WTP](saas-dbpertenant-performance-monitoring.md).

## <a name="monitoring-and-managing-performance-with-log-analytics-oms"></a>Мониторинг производительности и управление ею с помощью Log Analytics (OMS)

Для базы данных SQL средства мониторинга и создания оповещений доступны в базах данных и пулах. Встроенные возможности мониторинга и оповещений ресурса удобно использовать для небольшого количества ресурсов. Они менее подходят для мониторинга крупных сред или обеспечения единого представления для разных ресурсов и подписок.

Log Analytics можно использовать для сценариев с большим количеством операций. Это отдельная служба Azure, которая предоставляет аналитические сведения на основе журналов диагностики и данных телеметрии, собранных в рабочей области Log Analytics. Эта служба может собирать данные телеметрии из многих служб, а также позволяет выполнять запросы и настраивать оповещения. Log Analytics предоставляет встроенный язык запросов и средства визуализации данных, позволяющие выполнять аналитику и визуализацию рабочих данных. Решения службы "Аналитика SQL Azure" предоставляют несколько предопределенных представлений и запросов мониторинга и оповещений эластичных пулов и баз данных, а также позволяют добавлять собственные ad-hoc-запросы и сохранять их при необходимости. OMS также предоставляет конструктор пользовательского представления.

Решения аналитики и рабочих областей Log Analytics можно запустить на порталах Azure и OMS. Портал Azure является новой точкой доступа, однако может уступать порталу OMS в некоторых областях.

### <a name="create-data-by-starting-the-load-generator"></a>Создание данных при помощи генератора нагрузки 

1. В **интегрированной среде сценариев PowerShell** откройте **Demo-PerformanceMonitoringAndManagement.ps1**. Не закрывайте этот скрипт, так как при работе с этим руководством может потребоваться запустить несколько сценариев генератора нагрузки.
1. Если у вас меньше пяти клиентов, подготовьте пакет клиентов, чтобы предоставить более содержательный контекст мониторинга:
   1. Чтобы выбрать скрипт **подготовки пакета клиентов**, задайте для параметра **$DemoScenario** значение 1.
   1. Нажмите клавишу **F5** для запуска сценария.

1. Чтобы **создать обычную нагрузку (около 40 DTU)**, задайте для параметра **$DemoScenario** значение 2.
1. Нажмите клавишу **F5** для запуска сценария.

## <a name="get-the-wingtip-tickets-saas-database-per-tenant-application-scripts"></a>Получение скриптов для SaaS-приложения Wingtip Tickets c однотенантной БД

Сценарии для приложения SaaS Wingtip Tickets c мультитенантной базой данных и исходный код этого приложения вы найдете в репозитории GitHub [WingtipTicketsSaaS-DbPerTenant](https://github.com/Microsoft/WingtipTicketsSaaS-DbPerTenant). Инструкции по скачиванию и разблокированию сценариев приложения SaaS Wingtip Tickets см. в статье [Общие рекомендации по работе с примерами приложений SaaS Wingtip Tickets](saas-tenancy-wingtip-app-guidance-tips.md).

## <a name="installing-and-configuring-log-analytics-and-the-azure-sql-analytics-solution"></a>Установка и настройка Log Analytics и решений Аналитики SQL Azure

Log Analytics — это отдельная служба, которую необходимо настроить. Log Analytics собирает данные журнала, телеметрию и метрики в рабочей области Log Analytics. Создайте рабочую область, которая ничем не отличается от других ресурсов в Azure. Рабочую область не обязательно создавать в одной и той же группе ресурсов с приложением, которое она отслеживает, однако зачастую это самый оптимальный вариант. При использовании приложения Tickets SaaS Database Per Tenant SaaS можно удалить рабочую область вместе с приложением, удалив группу ресурсов.

1. В **интегрированной среде сценариев PowerShell** откройте файл \\Learning Modules\\Performance Monitoring and Management\\Log Analytics\\*Demo-LogAnalytics.ps1*.
1. Нажмите клавишу **F5** для запуска сценария.

На этом этапе можно будет открыть Log Analytics на портале Azure (или на портале OMS). Чтобы собрать данные телеметрии и отобразить их в рабочей области Log Analytics, требуется несколько минут. Чем дольше выполняется сбор системных данных, тем содержательнее результат. Сейчас самое время сделать перерыв. Только убедитесь, что генератор нагрузки все еще работает.


## <a name="use-log-analytics-and-the-sql-analytics-solution-to-monitor-pools-and-databases"></a>Использование Log Analytics и решений Аналитики SQL для мониторинга пулов и баз данных


В этом упражнении откройте Log Analytics и портал OMS для просмотра данных телеметрии, собираемых для баз данных и пулов.

1. Перейдите на [портал Azure](https://portal.azure.com) и откройте Log Analytics, щелкнув "Больше служб" и выполнив поиск Log Analytics:

   ![Открытие службы Log Analytics](media/saas-dbpertenant-log-analytics/log-analytics-open.png)

1. Выберите рабочую область *wtploganalytics-&lt;пользователь&gt;*.

1. Щелкните **Обзор**, чтобы открыть решение Log Analytics на портале Azure.
   ![Ссылка на параметр "Обзор"](media/saas-dbpertenant-log-analytics/click-overview.png)

    > [!IMPORTANT]
    > Активация решения может занять несколько минут. Подождите.

1. Щелкните элемент Аналитики SQL Azure, чтобы открыть его.

    ![Обзор](media/saas-dbpertenant-log-analytics/overview.png)

    ![Аналитика](media/saas-dbpertenant-log-analytics/analytics.png)

1. Используйте полосу прокрутки внизу, чтобы просмотреть колонку решения (при необходимости можно обновить колонку).

1. Просмотрите различные представления (щелкнув их) или выберите отдельные ресурсы, чтобы открыть детальный обозреватель. Воспользуйтесь ползунком с показателем времени в верхнем левом углу или щелкните вертикальную черту, чтобы изучить данные за конкретный временной интервал. В этом представлении можно выбрать отдельные базы данных или пулы, чтобы уделить внимание конкретным ресурсам:

    ![Диаграмма](media/saas-dbpertenant-log-analytics/chart.png)

1. Прокрутите колонку решений вправо, чтобы отобразить некоторые сохраненные запросы. Щелкните, чтобы просмотреть эти запросы. Вы можете поэкспериментировать с их изменением, а затем сохранить интересные сформированные запросы, которые можно будет повторно открыть и использовать с другими ресурсами.

1. В колонке рабочей области Log Analytics выберите портал OMS, чтобы открыть в нем решение.

    ![OMS](media/saas-dbpertenant-log-analytics/oms.png)

1. На портале OMS можно настроить оповещения. Щелкните область оповещений в представлении DTU базы данных.

1. В открывшемся представлении Log Search появится линейная диаграмма представляемой метрики.

    ![Поиск в журналах](media/saas-dbpertenant-log-analytics/log-search.png)

1. Если щелкнуть оповещение на панели инструментов, отобразится конфигурация оповещений, которую можно изменить.

    ![Добавление правила оповещения](media/saas-dbpertenant-log-analytics/add-alert.png)

В отличие от создания оповещений для каждого ресурса в колонке для конкретного ресурса, мониторинг и оповещения в Log Analytics и OMS основаны на запросах к данным в рабочей области. Таким образом, вместо того чтобы определять оповещение для каждой базы данных, можно определить одно общее оповещение для всех баз данных или создать оповещение, использующее составной запрос по нескольким типам ресурсов. Запросы ограничиваются только данными, доступными в рабочей области.

За использование Log Analytics для базы данных SQL будет взиматься плата, которая зависит от потребляемого объема данных в рабочей области. В этом руководстве вы создали бесплатную рабочую область с ограничением на 500 МБ в день. При достижении лимита данные больше не будут добавляться в рабочую область.


## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * Установка и настройка Log Analytics (OMS).
> * Использование Log Analytics для мониторинга пулов и баз данных.

[Выполнение распределенных запросов в нескольких базах данных SQL Azure](saas-dbpertenant-log-analytics.md)

## <a name="additional-resources"></a>Дополнительные ресурсы

* [SQL Database Wingtip SaaS tutorials](saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials) (Руководства по SQL Database Wingtip SaaS)
* [Мониторинг базы данных SQL Azure с помощью служб анализа SQL Azure (предварительная версия) в Log Analytics](../log-analytics/log-analytics-azure-sql.md).
* [OMS](https://blogs.technet.microsoft.com/msoms/2017/02/21/azure-sql-analytics-solution-public-preview/)

---
title: "Приступая к работе с аудитом баз данных SQL Azure | Документация Майкрософт"
description: "Приступая к работе с аудитом баз данных SQL Azure"
services: sql-database
documentationcenter: 
author: giladm
manager: jhubbard
editor: giladm
ms.assetid: 89c2a155-c2fb-4b67-bc19-9b4e03c6d3bc
ms.service: sql-database
ms.custom: security
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/07/2017
ms.author: giladm
ms.openlocfilehash: f4324a59b5fa4c2e1ab5b1d7fc7e5fe986ea80f8
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="get-started-with-sql-database-auditing"></a>Приступая к работе с аудитом базы данных SQL
Аудит базы данных SQL Azure позволяет отслеживать события базы данных и записывать их в журнал аудита в учетной записи хранения Azure. Аудит также дает следующие возможности:

* Аудит может помочь вам соблюсти требования нормативов, проанализировать работу с базой данных и получить представление о расхождениях и аномалиях, которые могут указывать на бизнес-проблемы или предполагаемые нарушения безопасности.

* Средства аудита способствуют соблюдению стандартов соответствия, но не гарантируют их выполнение. Дополнительную информацию о программах Azure, поддерживающих проверку соблюдения стандартов, см. в [Центре управления безопасностью Azure](https://azure.microsoft.com/support/trust-center/compliance/).


## <a id="subheading-1"></a>Обзор аудита баз данных SQL Azure
Используйте аудит базы данных SQL, чтобы выполнять следующие действия:


* **Сохранить** журнал аудита выбранных событий. Вы можете указать, какие категории действий базы данных должны проходить аудит.
* **Создавать отчеты** по действиям, производимым с базой данных. Вы можете использовать предварительно настроенные отчеты и панель мониторинга для быстрого начала работы с отчетностью по действиям и событиям.
* **Анализировать** отчеты. Вы можете искать подозрительные события, необычную деятельность и тенденции.

Аудит можно настроить для различных типов категорий событий (см. раздел [Настройка аудита базы данных](#subheading-2)).

Журналы аудита записываются в хранилище BLOB-объектов Azure в подписке Azure.


## <a id="subheading-8"></a>Определение политики аудита уровня сервера и базы данных

Политику аудита можно определить для конкретной базы данных или как политику сервера по умолчанию.

* Политика сервера применяется ко всем существующим и новым базам данных на сервере.

* Если включен *аудит больших двоичных объектов для сервера*, он *всегда применяется к базе данных* (т. е. выполняется аудит базы данных). Это поведение не зависит от параметров аудита базы данных.

* Включение аудита больших двоичных объектов для базы данных (кроме его включения для сервера), *не* приведет к переопределению или изменению настроек аудита больших двоичных объектов для сервера. Оба аудита будут выполняться параллельно. Таким образом, аудит базы данных будет выполняться дважды: один раз в соответствии с политикой сервера и еще раз в соответствии с политикой базы данных.

   > [!NOTE]
   > Не устанавливайте политику аудита больших двоичных объектов одновременно для сервера и базы данных, за исключением следующих случаев.
    > * Если для определенной базы данных нужно использовать другую *учетную запись хранения* или другой *срок хранения*.
    > * Нужно провести аудит типов событий или категорий для конкретной базы данных, которые отличаются от типов событий и категорий, проверенных для остальной части базы данных на сервере. Например, может потребоваться выполнить аудит вставки данных в таблицу только для конкретной базы данных.
   > 
   > Во всех остальных случаях мы рекомендуем включать аудит больших двоичных объектов только на уровне сервера, а на уровне баз данных отключить все параметры аудита для всех баз данных.


## <a id="subheading-2"></a>Настройка аудита базы данных
В следующем разделе описывается настройка аудита на портале Azure.

1. Перейдите на [портал Azure](https://portal.azure.com).
2. Перейдите в колонку **параметров** базы данных SQL или SQL Server, где нужно выполнить аудит. В колонке **Параметры** выберите **Аудит и обнаружение угроз**.

    <a id="auditing-screenshot"></a> ![Область навигации][1]
3. Если вы предпочитаете настроить политику аудита сервера (которая будет применяться ко всем имеющимся и новым базам данных на этом сервере), можно выбрать ссылку **просмотра параметров сервера** в колонке аудита базы данных. Вы можете затем просмотреть или изменить параметры аудита сервера.

    ![Область навигации][2]
4. Если вы предпочитаете включить аудит больших двоичных объектов на уровне базы данных (кроме или вместо аудита на уровне сервера), тогда для параметра **Аудит** выберите значение **Вкл.**, а для параметра **Тип аудита** — **Большой двоичный объект**.

    Если включен аудит больших двоичных объектов сервера, настроенный аудит для базы данных будет существовать параллельно с ним.  

    ![Область навигации][3]
5. Выберите **Сведения о хранилище**, чтобы открыть колонку **Хранилище журналов аудита**. Выберите учетную запись хранения Azure, в которой будут сохраняться журналы, и срок хранения, по истечении которого старые журналы будут удалены. Нажмите кнопку **ОК**. 
   >[!TIP] 
   >Чтобы в полной мере воспользоваться возможностями шаблонов отчетов об аудите, используйте одну и ту же учетную запись хранения для всех баз данных. 

    <a id="storage-screenshot"></a> ![Область навигации][4]
6. Настроить события аудита можно с помощью PowerShell или REST API. Дополнительные сведения см. в разделе [Автоматизация (PowerShell или REST API)](#subheading-7).
7. После настройки параметров аудита можно включить новую функцию обнаружения угроз и настроить адреса электронной почты для получения предупреждений системы безопасности. Использование функции обнаружения угроз позволяет настроить упреждающие оповещения об аномальной активности в базах данных, которая может указывать на потенциальные угрозы безопасности. Дополнительные сведения см. в статье [Обнаружение угроз для базы данных SQL](sql-database-threat-detection-get-started.md).
8. Щелкните **Сохранить**.





## <a id="subheading-3"></a>Анализ журналов и отчетов аудита
Журналы аудита объединяются в учетной записи хранения Azure, выбранной на этапе настройки. Журналы аудита можно просматривать с помощью таких инструментов, как [обозреватель хранилищ Azure](http://storageexplorer.com/).

Журналы аудита больших двоичных объектов сохраняются в виде коллекции файлов больших двоичных объектов в контейнере **sqldbauditlogs**.

Дополнительные сведения об иерархии папки для хранения журналов аудита больших двоичных объектов, соглашении об именовании больших двоичных объектов и формате журнала см. в [документации по формату журнала аудита (скачать DOC-файл)](https://go.microsoft.com/fwlink/?linkid=829599).

Просмотреть журналы аудита больших двоичных объектов можно несколькими способами:

* Используйте [портал Azure](https://portal.azure.com).  Откройте соответствующую базу данных. В верхней области колонки **Auditing & Threat detection** (Аудит и обнаружение угроз) щелкните **Ознакомиться с журналами аудита**.

    ![Область навигации][7]

    Откроется колонка **Записи аудита**, в которой вы сможете просматривать журналы.

    - Для просмотра записей за определенную дату щелкните **Фильтр** в верхней области колонки **записей аудита**.
    - Вы можете переключаться между записями аудита, созданными политиками аудита для сервера и для базы данных.

       ![Область навигации][8]

* Используйте системную функцию **sys.fn_get_audit_file** (T-SQL), чтобы вернуть данные журнала аудита в табличном формате. Дополнительные сведения об использовании этой функции см. в статье [sys.fn_get_audit_file (Transact-SQL)](https://docs.microsoft.com/sql/relational-databases/system-functions/sys-fn-get-audit-file-transact-sql).


* Используйте **объединение файлов аудита** в SQL Server Management Studio (начиная с SSMS 17):  
    1. В меню SSMS выберите **Файл** > **Открыть** > **Объединение файлов аудита**.

        ![Область навигации][9]
    2. Откроется диалоговое окно **Добавление файлов аудита**. Выберите один из способов **добавления**. Вы можете использовать объединение файлов аудита из локального диска или импортировать их из хранилища Azure (вам потребуется предоставить сведения о хранилище Azure и ключ учетной записи).

    3. После добавления всех файлов для слияния нажмите кнопку **OK** для завершения операции слияния.

    4. Объединенный файл откроется в SSMS, где вы сможете его просмотреть и проанализировать, а также экспортировать в XEL- или CSV-файл или в таблицу.

* Используйте созданное [приложение синхронизации](https://github.com/Microsoft/Azure-SQL-DB-auditing-OMS-integration). Оно работает в Azure и использует общие API-интерфейсы службы Log Analytics для Operations Management Suite (OMS) для передачи журналов аудита SQL в OMS. Приложение синхронизации отправляет журналы аудита SQL в OMS Log Analytics для использования через панель мониторинга OMS Log Analytics. 

* Используйте Power BI. Вы можете просматривать и анализировать данные журнала аудита в Power BI. Вы можете узнать больше о [Power BI, а также скачать шаблон](https://blogs.msdn.microsoft.com/azuresqldbsupport/2017/05/26/sql-azure-blob-auditing-basic-power-bi-dashboard/).

* Скачайте файлы журналов из контейнера больших двоичных объектов хранилища Azure из портала или с помощью [обозревателя хранилища Azure](http://storageexplorer.com/).
    * После загрузки файла дважды щелкните по нему, чтобы открыть, просмотреть и проанализировать файл в среде SSMS.
    * Вы также можете загрузить одновременно несколько файлов через обозреватель хранилища Azure. Щелкните правой кнопкой мыши конкретную вложенную папку (например, вложенную папку, содержащую все файлы журналов для определенной даты), а затем выберите **Сохранить как**, чтобы сохранить ее в локальной папке.

* Дополнительные методы
   * После загрузки нескольких файлов (или вложенной папки, содержащей файлы журнала за целый день, как описано в предыдущем пункте в этом списке), можно объединить их локально, как описано в приведенных выше инструкциях по объединению файлов аудита в SSMS.

   * Чтобы просмотреть журналы аудита больших двоичных объектов программным способом:

     * Используйте библиотеку C# [для считывания расширенных событий](https://blogs.msdn.microsoft.com/extended_events/2011/07/20/introducing-the-extended-events-reader/).
     * Используйте [запросы к файлам расширенных событий](https://sqlscope.wordpress.com/2014/11/15/reading-extended-event-files-using-client-side-tools-only/) с помощью PowerShell.




## <a id="subheading-5"></a>Рекомендации для рабочей среды
<!--The description in this section refers to preceding screen captures.-->

### <a id="subheading-6">Аудит геореплицированных баз данных</a>
При использовании географически реплицированных баз данных можно настроить аудит для базы данных-источника, базы данных-получателя или для обеих баз данных в зависимости от типа аудита.

Следуйте инструкциям ниже (помните, что аудит больших двоичных объектов можно включить или отключить только в параметрах аудита базы данных-источника):

* **База данных-источник**. Включите аудит больших двоичных объектов на сервере или в базе данных, как описано в разделе [настройки аудита базы данных](#subheading-2).
* **База данных-получатель**. Включите аудит больших двоичных объектов в базе данных-источнике, как описано в разделе [настройки аудита базы данных](#subheading-2). 
   * Его необходимо включить для самой *базы данных-источника*, а не для сервера.
   * После включения аудита больших двоичных объектов в базе данных-источнике он станет доступным в базе данных-получателе.

     >[!IMPORTANT]
     >По умолчанию настройки хранилища для базы данных-получателя будут совпадать с настройками для базы данных-источника, что приведет к появлению трафика между регионами. Этого можно избежать, включив аудит больших двоичных объектов на сервере-получателе, а также настроив локальное хранилище в параметрах хранилища сервера-получателя. Это приведет к переопределению расположения хранилища для базы данных-получателя, и каждая база данных сохранит свои журналы аудита в локальном хранилище.  
<br>

### <a id="subheading-6">Повторное создание ключа к хранилищу данных</a>
Обычно в рабочей среде приходится периодически обновлять ключи хранилища. При обновлении ключей необходимо повторно сохранить политику аудита. Процесс таков:

1. Откройте колонку **Сведения о хранилище**. В поле **Ключ доступа к хранилищу** выберите **Вторичный**, а затем нажмите кнопку **OK**. Затем щелкните **Сохранить** в верхней области колонки настройки аудита.

    ![Область навигации][5]
2. Перейдите в колонку конфигурации хранилища и повторно создайте первичный ключ доступа.

    ![Область навигации][6]
3. Вернитесь в колонку настройки аудита, измените значение ключа доступа к хранилищу с вторичного на первичный, затем нажмите кнопку **OK**. Затем щелкните **Сохранить** в верхней области колонки настройки аудита.
4. Вернитесь в колонку настройки хранилища и повторно создайте ключ доступа получателя (для подготовки к следующему циклу обновления ключей).

## <a id="subheading-7"></a>Автоматизация (PowerShell или REST API)
Аудит в базе данных SQL Azure также можно настроить с помощью следующих средств автоматизации:

* **Командлеты PowerShell**

   * [Get-AzureRMSqlDatabaseAuditingPolicy][101]
   * [Get-AzureRMSqlServerAuditingPolicy][102]
   * [Remove-AzureRMSqlDatabaseAuditing][103]
   * [Remove-AzureRMSqlServerAuditing][104]
   * [Set-AzureRMSqlDatabaseAuditingPolicy][105]
   * [Set-AzureRMSqlServerAuditingPolicy][106]
   * [Use-AzureRMSqlServerAuditingPolicy][107]

   Пример сценария см. в статье [Настройка аудита и обнаружения угроз для базы данных SQL с помощью PowerShell](scripts/sql-database-auditing-and-threat-detection-powershell.md).

* **REST API — аудит больших двоичных объектов**:

   * [Создание или обновление политики аудита BLOB-объектов базы данных](https://msdn.microsoft.com/library/azure/mt695939.aspx)
   * [Создание или обновление политики аудита BLOB-объектов сервера](https://msdn.microsoft.com/library/azure/mt771861.aspx)
   * [Получение политики аудита BLOB-объектов базы данных](https://msdn.microsoft.com/library/azure/mt695938.aspx)
   * [Получение политики аудита BLOB-объектов сервера](https://msdn.microsoft.com/library/azure/mt771860.aspx)
   * [Получение результата операции аудита для BLOB-объектов сервера](https://msdn.microsoft.com/library/azure/mt771862.aspx)


<!--Anchors-->
[Azure SQL Database Auditing overview]: #subheading-1
[Set up auditing for your database]: #subheading-2
[Analyze audit logs and reports]: #subheading-3
[Practices for usage in production]: #subheading-5
[Storage Key Regeneration]: #subheading-6
[Automation (PowerShell / REST API)]: #subheading-7
[Blob/Table differences in Server auditing policy inheritance]: (#subheading-8)  

<!--Image references-->
[1]: ./media/sql-database-auditing-get-started/1_auditing_get_started_settings.png
[2]: ./media/sql-database-auditing-get-started/2_auditing_get_started_server_inherit.png
[3]: ./media/sql-database-auditing-get-started/3_auditing_get_started_turn_on.png
[4]: ./media/sql-database-auditing-get-started/4_auditing_get_started_storage_details.png
[5]: ./media/sql-database-auditing-get-started/5_auditing_get_started_storage_key_regeneration.png
[6]: ./media/sql-database-auditing-get-started/6_auditing_get_started_regenerate_key.png
[7]: ./media/sql-database-auditing-get-started/7_auditing_get_started_blob_view_audit_logs.png
[8]: ./media/sql-database-auditing-get-started/8_auditing_get_started_blob_audit_records.png
[9]: ./media/sql-database-auditing-get-started/9_auditing_get_started_ssms_1.png
[10]: ./media/sql-database-auditing-get-started/10_auditing_get_started_ssms_2.png

[101]: /powershell/module/azurerm.sql/get-azurermsqldatabaseauditingpolicy
[102]: /powershell/module/azurerm.sql/Get-AzureRMSqlServerAuditingPolicy
[103]: /powershell/module/azurerm.sql/Remove-AzureRMSqlDatabaseAuditing
[104]: /powershell/module/azurerm.sql/Remove-AzureRMSqlServerAuditing
[105]: /powershell/module/azurerm.sql/Set-AzureRMSqlDatabaseAuditingPolicy
[106]: /powershell/module/azurerm.sql/Set-AzureRMSqlServerAuditingPolicy
[107]: /powershell/module/azurerm.sql/Use-AzureRMSqlServerAuditingPolicy

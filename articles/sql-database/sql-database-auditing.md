---
title: "aaaGet работы с аудитом базы данных Azure SQL | Документы Microsoft"
description: "Приступая к работе с аудитом баз данных SQL Azure"
services: sql-database
documentationcenter: 
author: giladm
manager: jhubbard
editor: giladm
ms.assetid: 89c2a155-c2fb-4b67-bc19-9b4e03c6d3bc
ms.service: sql-database
ms.custom: security
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/07/2017
ms.author: giladm
ms.openlocfilehash: 5494c602d702ac41992520f900c393a98cc7c989
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="get-started-with-sql-database-auditing"></a>Приступая к работе с аудитом базы данных SQL
Аудита базы данных Azure отслеживает события базы данных и записывает их tooan журнал аудита вашей учетной записи хранилища Azure. Аудит также дает следующие возможности:

* Аудит может помочь вам соблюсти требования нормативов, проанализировать работу с базой данных и получить представление о расхождениях и аномалиях, которые могут указывать на бизнес-проблемы или предполагаемые нарушения безопасности.

* Позволяет и обеспечивает соблюдение стандартов toocompliance, несмотря на то, что он не гарантирует соответствие. Дополнительные сведения о Azure программы, соответствие стандартам поддержки, см. в разделе hello [Центр управления безопасностью Azure](https://azure.microsoft.com/support/trust-center/compliance/).


## <a id="subheading-1"></a>Обзор аудита баз данных SQL Azure
Используйте аудит базы данных SQL, чтобы выполнять следующие действия:


* **Сохранить** журнал аудита выбранных событий. Можно определить категории аудита toobe действия базы данных.
* **Создавать отчеты** по действиям, производимым с базой данных. Можно использовать готовые отчеты и панели мониторинга tooget, быстро начать работу с действия и уведомления о событиях.
* **Анализировать** отчеты. Вы можете искать подозрительные события, необычную деятельность и тенденции.

Можно настроить аудит для различных категорий событий, как описано в hello [настройки аудита для базы данных](#subheading-2) раздела.

Журналы аудита записываются tooAzure хранилища больших двоичных объектов в вашей подписке Azure.


## <a id="subheading-8"></a>Определение политики аудита уровня сервера и базы данных

Политику аудита можно определить для конкретной базы данных или как политику сервера по умолчанию.

* Политика сервера применяется tooall существующих и новых баз данных на сервере hello.

* Если *включен аудит больших двоичных объектов сервера*, его *всегда применяется базы данных toohello* (то есть hello базы данных будет выполняться аудит), независимо от базы данных hello параметры аудита.

* Включение аудита для базы данных hello в tooenabling сложения его на сервере hello большого двоичного объекта будет *не* переопределить или изменить любые параметры hello hello server большого двоичного объекта аудита. Оба аудита будут выполняться параллельно. Другими словами hello базы данных будет выполняться аудит дважды в параллельном режиме (один раз политикой сервера hello и один раз политикой hello базы данных).

   > [!NOTE]
   > Не устанавливайте политику аудита больших двоичных объектов одновременно для сервера и базы данных, за исключением следующих случаев.
    > * Требуется другой toouse *учетной записи хранилища* или *срок хранения* для конкретной базы данных.
    > * Типы событий tooaudit или категорий, необходимой для конкретной базы данных, отличные от типов событий или категорий, которые проверяются для hello rest hello баз данных на сервере hello. Например может потребоваться вставки для таблицы, требующих аудита toobe только для конкретной базы данных.
   > 
   > В противном случае рекомендуется включить аудит больших двоичных объектов только на уровне сервера, так и оставьте hello уровня базы данных аудита выключены для всех баз данных.


## <a id="subheading-2"></a>Настройка аудита базы данных
Hello следующем разделе описана конфигурация hello аудита с помощью портала Azure hello.

1. Go toohello [портал Azure](https://portal.azure.com).
2. Go toohello **параметры** колонке SQL базы данных и SQL server требуется tooaudit hello. В hello **параметры** колонке выберите **обнаружения аудита и угрозы**.

    <a id="auditing-screenshot"></a> ![Область навигации][1]
3. Если вы предпочитаете tooset политику аудита сервера (который будет применяться tooall существующих и новых баз данных на этом сервере), можно выбрать hello **проверить параметры сервера** ссылку в колонке аудита hello базы данных. Можно просмотреть или изменить параметры аудита сервера hello.

    ![Область навигации][2]
4. Если вы предпочитаете tooenable большого двоичного объекта аудита на уровне hello базы данных (в дополнение tooor вместо аудит на уровне сервера), для **аудита**выберите **ON**и для **аудита тип** , выберите **большого двоичного объекта**.

    Если включен аудит сервера больших двоичных объектов, hello база данных настроена аудита будет существовать параллельно с hello server большого двоичного объекта аудита.  

    ![Область навигации][3]
5. tooopen hello **хранения журналов аудита** колонке выберите **сведения о хранилище**. Выберите учетную запись хранилища Azure hello где журналы будут сохранены, а затем выберите срок хранения hello, после которого hello старые журналы будут удалены. Нажмите кнопку **ОК**. 
   >[!TIP] 
   >hello tooget наиболее эффективно использовать hello аудита шаблоны отчетов, используйте hello учетную запись хранения для всех баз данных аудита. 

    <a id="storage-screenshot"></a> ![Область навигации][4]
6. Следует toocustomize hello аудиту события можно сделать это с помощью PowerShell или hello REST API. Дополнительные сведения см. в разделе hello [автоматизации (PowerShell или REST API)](#subheading-7) раздела.
7. После настройки параметров аудита, можно включить возможность обнаружения новых угроз hello и настройка оповещений безопасности tooreceive сообщений электронной почты. Использование функции обнаружения угроз позволяет настроить упреждающие оповещения об аномальной активности в базах данных, которая может указывать на потенциальные угрозы безопасности. Дополнительные сведения см. в статье [Обнаружение угроз для базы данных SQL](sql-database-threat-detection-get-started.md).
8. Щелкните **Сохранить**.





## <a id="subheading-3"></a>Анализ журналов и отчетов аудита
Журналы аудита, собираются в учетной записи хранилища Azure, которые были выбраны во время установки hello. Журналы аудита можно просматривать с помощью таких инструментов, как [обозреватель хранилищ Azure](http://storageexplorer.com/).

Журналы аудита больших двоичных объектов сохраняются в виде коллекции файлов больших двоичных объектов в контейнере **sqldbauditlogs**.

Дополнительные сведения об иерархии hello папки хранения журналов аудита blob hello, соглашения об именовании для BLOB-объектов и формат журнала см. в разделе hello [большой двоичный объект аудита формат ссылку на журнал (Загрузка файла .docx)](https://go.microsoft.com/fwlink/?linkid=829599).

Большой двоичный объект tooview журналы аудита можно использовать несколькими способами:

* Используйте hello [портал Azure](https://portal.azure.com).  Откройте hello соответствующей базы данных. AT hello верхней части базы данных hello **аудита и угрозы обнаружения** колонке нажмите кнопку **Просмотр журналов аудита**.

    ![Область навигации][7]

    **Записи аудита** открывается колонка, из которых вы будете иметь доступ tooview hello журналы.

    - Определенные даты можно просмотреть, щелкнув **фильтра** вверху hello hello **записи аудита** колонку.
    - Вы можете переключаться между записями аудита, созданными политиками аудита для сервера и для базы данных.

       ![Область навигации][8]

* Используйте системную функцию hello **sys.fn_get_audit_file** данные журнала аудита hello tooreturn (T-SQL) в табличном формате. Дополнительные сведения об использовании этой функции см. в разделе hello [sys.fn_get_audit_file документации](https://docs.microsoft.com/sql/relational-databases/system-functions/sys-fn-get-audit-file-transact-sql).


* Используйте **объединение файлов аудита** в SQL Server Management Studio (начиная с SSMS 17):  
    1. Hello меню среды SSMS выберите **файл** > **откройте** > **слияние файлов аудита**.

        ![Область навигации][9]
    2. Hello **добавить файлы аудита** откроется диалоговое окно. Выберите один из hello **добавить** вариантов ли toomerge аудита файлов из локального диска или импортировать их из хранилища Azure (вам будет tooprovide необходимые сведения о хранилище Azure и ключа учетной записи).

    3. После добавления всех файлов toomerge щелкните **ОК** операции слияния toocomplete hello.

    4. Hello объединенный файл откроется в среде SSMS, где можно просмотреть и проанализировать их, а также экспорта его tooan XEL или CSV-файла или tooa таблицы.

* Используйте hello [синхронизации приложения](https://github.com/Microsoft/Azure-SQL-DB-auditing-OMS-integration) , мы создали. Он работает в Azure и использует служба аналитики журналов Operations Management Suite (OMS) открытого API-интерфейсы toopush SQL журналы аудита в OMS. Синхронизация приложения Hello журналы аудита SQL помещает в аналитику журнала OMS для использования через панель мониторинга службы анализа журналов OMS hello. 

* Используйте Power BI. Вы можете просматривать и анализировать данные журнала аудита в Power BI. Вы можете узнать больше о [Power BI, а также скачать шаблон](https://blogs.msdn.microsoft.com/azuresqldbsupport/2017/05/26/sql-azure-blob-auditing-basic-power-bi-dashboard/).

* Загрузите файлы журналов из контейнера больших двоичных объектов хранилища Azure через портал hello, или с помощью средства, такие как [обозреватель хранилищ Azure](http://storageexplorer.com/).
    * После загрузки файла журнала локально, можно дважды щелкнуть tooopen файл hello, просмотр и анализ журналов hello в среде SSMS.
    * Вы также можете загрузить одновременно несколько файлов через обозреватель хранилища Azure. Щелкните правой кнопкой мыши конкретную вложенную папку (например, вложенную папку, содержащую все файлы журналов для определенной даты) и выберите **сохранение** toosave в локальной папке.

* Дополнительные методы
   * После загрузки нескольких файлов (или вложенную папку, содержащую файлы журнала для целый день, как описано в hello предыдущему элементу этого списка), можно объединить их локально как описано hello файлов аудита слияния SSMS описано выше.

   * Чтобы просмотреть журналы аудита больших двоичных объектов программным способом:

     * Используйте hello [чтения расширенных событий](https://blogs.msdn.microsoft.com/extended_events/2011/07/20/introducing-the-extended-events-reader/) библиотеки C#.
     * Используйте [запросы к файлам расширенных событий](https://sqlscope.wordpress.com/2014/11/15/reading-extended-event-files-using-client-side-tools-only/) с помощью PowerShell.




## <a id="subheading-5"></a>Рекомендации для рабочей среды
<!--hello description in this section refers toopreceding screen captures.-->

### <a id="subheading-6">Аудит геореплицированных баз данных</a>
При использовании географически реплицируемых баз данных, это возможно tooset аудита для базы данных-источника hello, базы данных-получателя hello или оба, в зависимости от типа аудита hello.

Следуйте данным инструкциям (Помните, что аудит больших двоичных объектов можно включить или отключить только от hello основной базы данных, параметры аудита).

* **База данных-источник**. Включить аудит больших двоичных объектов, либо на сервере hello, либо на саму базу данных hello, следуя инструкциям в hello [настройки аудита для базы данных](#subheading-2) раздела.
* **База данных-получатель**. Включить аудит больших двоичных объектов на hello базы данных-источника, как описано в hello [настройки аудита для базы данных](#subheading-2) раздела. 
   * Большой двоичный объект должен быть включен аудит на hello *базы данных-источника самого*, не hello server.
   * Включив аудит больших двоичных объектов в базе данных-источнике hello, он также становятся доступными на базу данных-получатель hello.

     >[!IMPORTANT]
     >По умолчанию hello параметры хранилища для баз данных-получателей hello будет идентичные toothose hello базы данных-источника, вызывают трафика между язык. Этого можно избежать, включив аудит больших двоичных объектов на сервере-получателе hello и настройки локального хранения в параметрах хранилища сервера-получателя hello. Место хранения hello hello базы данных-получателя, для них в каждой базе данных, сохранении свое хранилище toolocal журналы аудита будут переопределены.  
<br>

### <a id="subheading-6">Повторное создание ключа к хранилищу данных</a>
В рабочей среде, скорее всего, toorefresh хранилища ключей периодически. При обновлении ключей, требуется политика аудита tooresave hello. Hello процесс выглядит следующим образом:

1. Откройте hello **сведения о хранилище** колонку. В hello **ключ доступа к хранилищу** выберите **получателя**и нажмите кнопку **ОК**. Нажмите кнопку **Сохранить** вверху hello hello аудит колонке конфигурации.

    ![Область навигации][5]
2. Вернитесь к колонке конфигурации toohello хранилища и повторно создать hello первичный ключ доступа.

    ![Область навигации][6]
3. Вернитесь к предыдущему окну toohello аудит колонке конфигурации, переключение hello ключ доступа к хранилищу из вторичного tooprimary и нажмите кнопку **ОК**. Нажмите кнопку **Сохранить** вверху hello hello аудит колонке конфигурации.
4. Вы можете вернуться в колонке конфигурации хранилища toohello и hello повторно создать вторичный ключ доступа (в процессе подготовки для следующего ключа hello цикл обновления).

## <a id="subheading-7"></a>Автоматизация (PowerShell или REST API)
Также можно настроить аудит в базе данных SQL Azure с помощью следующих средств автоматизации hello.

* **Командлеты PowerShell**

   * [Get-AzureRMSqlDatabaseAuditingPolicy][101]
   * [Get-AzureRMSqlServerAuditingPolicy][102]
   * [Remove-AzureRMSqlDatabaseAuditing][103]
   * [Remove-AzureRMSqlServerAuditing][104]
   * [Set-AzureRMSqlDatabaseAuditingPolicy][105]
   * [Set-AzureRMSqlServerAuditingPolicy][106]
   * [Use-AzureRMSqlServerAuditingPolicy][107]

   Пример сценария см. в статье [Настройка аудита и обнаружения угроз для базы данных SQL с помощью PowerShell](scripts/sql-database-auditing-and-threat-detection-powershell.md).

* **REST API — аудит больших двоичных объектов**:

   * [Создание или обновление политики аудита BLOB-объектов базы данных](https://msdn.microsoft.com/library/azure/mt695939.aspx)
   * [Создание или обновление политики аудита BLOB-объектов сервера](https://msdn.microsoft.com/library/azure/mt771861.aspx)
   * [Получение политики аудита BLOB-объектов базы данных](https://msdn.microsoft.com/library/azure/mt695938.aspx)
   * [Получение политики аудита BLOB-объектов сервера](https://msdn.microsoft.com/library/azure/mt771860.aspx)
   * [Получение результата операции аудита для BLOB-объектов сервера](https://msdn.microsoft.com/library/azure/mt771862.aspx)


<!--Anchors-->
[Azure SQL Database Auditing overview]: #subheading-1
[Set up auditing for your database]: #subheading-2
[Analyze audit logs and reports]: #subheading-3
[Practices for usage in production]: #subheading-5
[Storage Key Regeneration]: #subheading-6
[Automation (PowerShell / REST API)]: #subheading-7
[Blob/Table differences in Server auditing policy inheritance]: (#subheading-8)  

<!--Image references-->
[1]: ./media/sql-database-auditing-get-started/1_auditing_get_started_settings.png
[2]: ./media/sql-database-auditing-get-started/2_auditing_get_started_server_inherit.png
[3]: ./media/sql-database-auditing-get-started/3_auditing_get_started_turn_on.png
[4]: ./media/sql-database-auditing-get-started/4_auditing_get_started_storage_details.png
[5]: ./media/sql-database-auditing-get-started/5_auditing_get_started_storage_key_regeneration.png
[6]: ./media/sql-database-auditing-get-started/6_auditing_get_started_regenerate_key.png
[7]: ./media/sql-database-auditing-get-started/7_auditing_get_started_blob_view_audit_logs.png
[8]: ./media/sql-database-auditing-get-started/8_auditing_get_started_blob_audit_records.png
[9]: ./media/sql-database-auditing-get-started/9_auditing_get_started_ssms_1.png
[10]: ./media/sql-database-auditing-get-started/10_auditing_get_started_ssms_2.png

[101]: /powershell/module/azurerm.sql/get-azurermsqldatabaseauditingpolicy
[102]: /powershell/module/azurerm.sql/Get-AzureRMSqlServerAuditingPolicy
[103]: /powershell/module/azurerm.sql/Remove-AzureRMSqlDatabaseAuditing
[104]: /powershell/module/azurerm.sql/Remove-AzureRMSqlServerAuditing
[105]: /powershell/module/azurerm.sql/Set-AzureRMSqlDatabaseAuditingPolicy
[106]: /powershell/module/azurerm.sql/Set-AzureRMSqlServerAuditingPolicy
[107]: /powershell/module/azurerm.sql/Use-AzureRMSqlServerAuditingPolicy

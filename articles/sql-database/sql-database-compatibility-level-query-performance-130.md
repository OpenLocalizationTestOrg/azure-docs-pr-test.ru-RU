---
title: "уровень совместимости aaaDatabase 130 - базы данных SQL Azure | Документы Microsoft"
description: "В этой статье мы исследовать преимущества hello, используя преимущества hello hello новый оптимизатор запросов и запуска базы данных SQL Azure на уровне совместимости 130 и запросить набор функций процессора. Мы обсудим вопросы hello побочные эффекты на производительность запросов hello hello существующих приложений SQL."
services: sql-database
documentationcenter: 
author: alainlissoir
manager: jhubbard
editor: 
ms.assetid: 8619f90b-7516-46dc-9885-98429add0053
ms.service: sql-database
ms.custom: monitor & tune
ms.workload: data-management
ms.devlang: NA
ms.tgt_pltfrm: NA
ms.topic: article
ms.date: 08/08/2016
ms.author: alainl
ms.openlocfilehash: 25693c5f7b01405b7073fa7d4cc2833fbe125e2f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="improved-query-performance-with-compatibility-level-130-in-azure-sql-database"></a>Повышение производительности запросов с использованием уровня совместимости 130 в базе данных SQL Azure
База данных SQL Azure выполняется прозрачно сотни тысяч баз данных на многих различных совместимости уровнях, сохранение и обеспечивая hello обратной совместимости toohello соответствующую версию Microsoft SQL Server для всех клиентов!

В этой статье мы исследовать преимущества hello под управлением вашей базе данных SQL Azure на уровне совместимости 130 и использование преимуществ hello hello новый оптимизатор запросов и запросов функций процессора. Мы обсудим вопросы hello побочные эффекты на производительность запросов hello hello существующих приложений SQL.

Напоминаем журнала выравнивание hello уровни совместимости toodefault версии SQL выглядят следующим образом:

* 100 — в SQL Server 2008 и Базе данных SQL Azure версии 11;
* 110 — в SQL Server 2012 и Базе данных SQL Azure версии 11;
* 120 — в SQL Server 2014 и Базе данных SQL Azure версии 12;
* 130 — в SQL Server 2016 и <азе данных SQL Azure версии 12.

> [!IMPORTANT]
> Начиная с версии **mid июня 2016 г.**, в базе данных SQL Azure, уровень совместимости по умолчанию hello будет 130 вместо 120 для **только что созданный** баз данных.
> 
> Это *не* касается баз данных, созданных до середины июня 2016 года. Они сохранят текущий уровень совместимости (100, 110 и 120). Базы данных, перенесенные из базы данных SQL Azure версии V11 tooV12 будет иметь уровень совместимости 100 и 110. 
> 

## <a name="about-compatibility-level-130"></a>Об уровне совместимости 130
Во-первых Если вы хотите tooknow hello текущий уровень совместимости базы данных, выполните hello, следующем за инструкцией Transact-SQL.

```
SELECT compatibility_level
    FROM sys.databases
    WHERE name = '<YOUR DATABASE_NAME>’;
```


До этого изменения toolevel 130 происходит для **вновь** создаваемых баз данных, давайте просмотрите все о — это изменение некоторых примеров очень простой запрос и посмотрим, как любой пользователь, могут помочь от него.

Обработка запросов в реляционных базах данных могут быть очень сложными и может привести toolots компьютера научных вычислений и математические toounderstand hello связаны конкретные варианты и поведений. В этом документе hello содержимого был намеренно упрощенная tooensure, что любой пользователь с минимальным технические сведения понять влияние hello изменение уровня совместимости hello и определить его преимущества приложений.

Давайте рассмотрим быстрого hello уровень совместимости 130 переводит в таблице hello.  Дополнительные сведения см. в статье [Уровень совместимости инструкции ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/bb510680.aspx). Ниже представлены краткие сведения.

* Hello операции вставки в инструкции Insert select может быть многопоточных или параллельный план, а перед эта операция была однопотоковой.
* У запроса оптимизированной для памяти таблицы и табличных переменных теперь могут быть параллельные планы. Раньше у этой операции также был один поток.
* Теперь можно выполнять выборку статистики для оптимизированных для памяти таблиц, а также автоматически обновлять ее. Дополнительные сведения см. в подразделе о [выполняющейся в памяти OLTP раздела "Новые возможности в ядре СУБД"](https://msdn.microsoft.com/library/bb510411.aspx#InMemory).
* Изменения в пакетном режиме и в режиме строки, связанные с индексами хранилища столбцов
  * Сортировка в таблице с индексом хранилища столбцов теперь выполняется в пакетном режиме.
  * Оконные статистические выражения, например инструкции TSQL LAG или LEAD, теперь работают в пакетном режиме.
  * Запросы к таблицам хранилища столбцов с несколькими отдельными предложениями работают в пакетном режиме.
  * Запросы со степенью параллелизма DOP=1 или с последовательным планом также выполняются в пакетном режиме.
* И, наконец усовершенствования кратности фактически соединяющиеся с уровнем совместимости 120, но для тех, запущенные в совместимости ниже уровня (т. е. 100 или 110), hello уровня toocompatibility перемещения 130 будет также восстановить эти усовершенствования и их можно также повышения производительности запросов hello приложений.

## <a name="practicing-compatibility-level-130"></a>Использование уровня совместимости 130
Первый давайте некоторых таблиц, индексов и случайные данные, созданные toopractice некоторые из этих новых возможностей. Примеры сценариев TSQL Hello может выполняться в SQL Server 2016 или в базе данных SQL Azure. Тем не менее при создании базы данных Azure SQL, убедитесь, что выберите не hello минимальное P2 базы данных, поскольку требуется по крайней мере несколько ядер tooallow многопоточность и поэтому преимущества этих функций.

```
-- Create a Premium P2 Database in Azure SQL Database

CREATE DATABASE MyTestDB
    (EDITION=’Premium’, SERVICE_OBJECTIVE=’P2′);
GO

-- Create 2 tables with a column store index on
-- hello second one (only available on Premium databases)

CREATE TABLE T_source
    (Color varchar(10), c1 bigint, c2 bigint);

CREATE TABLE T_target
    (c1 bigint, c2 bigint);

CREATE CLUSTERED COLUMNSTORE INDEX CCI ON T_target;
GO

-- Insert few rows.

INSERT T_source VALUES
    (‘Blue’, RAND() * 100000, RAND() * 100000),
    (‘Yellow’, RAND() * 100000, RAND() * 100000),
    (‘Red’, RAND() * 100000, RAND() * 100000),
    (‘Green’, RAND() * 100000, RAND() * 100000),
    (‘Black’, RAND() * 100000, RAND() * 100000);

GO 200

INSERT T_source SELECT * FROM T_source;

GO 10
```


Теперь давайте имеют вид toosome функций обработки запроса hello, поступающих с уровнем совместимости 130.

## <a name="parallel-insert"></a>Параллельное выполнение операции INSERT
Выполнение инструкций TSQL hello ниже выполняется hello операции вставки при уровне совместимости 120 и 130, выполняющего соответственно hello операции вставки в одной модели потоков (120), а также в многопоточной модели (130).

```
-- Parallel INSERT … SELECT … in heap or CCI
-- is available under 130 only

SET STATISTICS XML ON;

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 120;
GO 

-- hello INSERT part is in serial

INSERT t_target WITH (tablock)
    SELECT C1, COUNT(C2) * 10 * RAND()
        FROM T_source
        GROUP BY C1
    OPTION (RECOMPILE);

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130
GO

-- hello INSERT part is in parallel

INSERT t_target WITH (tablock)
    SELECT C1, COUNT(C2) * 10 * RAND()
        FROM T_source
        GROUP BY C1
    OPTION (RECOMPILE);

SET STATISTICS XML OFF;
```


Запросив план запроса фактический hello hello, просмотрев его графическое представление или его содержимое XML, можно определить, какие функции является играют оценки количества элементов. Глядя hello планы side-by-side на рисунке 1, четко видно, что hello выполнения вставки хранилища столбца выходит из последовательного в 120 tooparallel в 130. Кроме того Обратите внимание hello изменения значка итератора hello в 130 плана hello отображение параллельных со стрелками, демонстрирующая hello факт, что теперь hello итератора выполнение на самом деле параллельных. При наличии больших toocomplete операций INSERT, параллельное выполнение hello, количество связанных toohello core вами в вашем распоряжении для hello базы данных, увеличивается производительность; копирование tooa 100 раз быстрее, в зависимости от ситуации!

*Рисунок 1: Вставка операции изменения из последовательного tooparallel с уровнем совместимости 130.*

![На рисунке 1](./media/sql-database-compatibility-level-query-performance-130/figure-1.jpg)

## <a name="serial-batch-mode"></a>Последовательный пакетный режим
Аналогичным образом перемещение уровня toocompatibility 130 при обработке строки данных включает пакетную обработку. Во-первых, выполнение операций в пакетном режиме доступно только при наличии индекса хранилища столбцов. Во-вторых пакет обычно представляет ~ 900 строк и использует логику кода, оптимизированный для несколькими ядрами ЦП, пропускную способность памяти, и непосредственно использует hello сжатых данных hello хранилища столбцов, когда это возможно. В этих условиях SQL Server 2016 может обрабатывать ~ 900 строк за один раз вместо 1 строку во время hello и как следствие, hello в целом накладные расходы hello операции теперь совместно используется весь пакет hello, уменьшая hello Общая стоимость по строкам. Этот общий объем вкупе с hello сжатие хранилища столбцов, по сути снижает задержку hello в режиме ВЫБЕРИТЕ пакетной операции. Можно получить дополнительные сведения о хранилище столбцов hello и пакета режиме на [руководство по индексам Columnstore](https://msdn.microsoft.com/library/gg492088.aspx).

```
-- Serial batch mode execution

SET STATISTICS XML ON;

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 120;
GO

-- hello scan and aggregate are in row mode

SELECT C1, COUNT (C2)
    FROM T_target
    GROUP BY C1
    OPTION (MAXDOP 1, RECOMPILE);
GO

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130;
GO 

-- hello scan and aggregate are in batch mode,
-- and force MAXDOP too1 tooshow that batch mode
-- also now works in serial mode.

SELECT C1, COUNT(C2)
    FROM T_target
    GROUP BY C1
    OPTION (MAXDOP 1, RECOMPILE);
GO

SET STATISTICS XML OFF;
```


Как видимый ниже просматривая hello запроса планы side-by-side на рис. 2, мы видим, режим обработки hello изменилось с уровнем совместимости hello и вследствие этого, при выполнении запросов hello в обоих уровень совместимости полностью, можно видеть, что большую часть времени обработки hello, затраченное на строки режима (86%) по сравнению toohello пакетный режим (14%), где были обработаны 2 пакетов. Увеличить hello набора данных, hello преимущество увеличится.

*Рисунок 2: ВЫБЕРИТЕ режим последовательного toobatch с уровнем совместимости 130 операции изменения.*

![На рис. 2](./media/sql-database-compatibility-level-query-performance-130/figure-2.jpg)

## <a name="batch-mode-on-sort-execution"></a>Пакетный режим при выполнении сортировки
Аналогичные toohello выше, но применяется tooa операцию сортировки, hello переход из режима toobatch режиме (при уровне совместимости 120) строки (при уровне совместимости 130) повышает производительность hello hello операция СОРТИРОВКИ для hello те же причины.

```
-- Batch mode on sort execution

SET STATISTICS XML ON;

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 120;
GO

-- hello scan and aggregate are in row mode

SELECT C1, COUNT(C2)
    FROM T_target
    GROUP BY C1
    ORDER BY C1
    OPTION (MAXDOP 1, RECOMPILE);
GO

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130;
GO

-- hello scan and aggregate are in batch mode,
-- and force MAXDOP too1 tooshow that batch mode
-- also now works in serial mode.

SELECT C1, COUNT(C2)
    FROM T_target
    GROUP BY C1
    ORDER BY C1
    OPTION (MAXDOP 1, RECOMPILE);
GO

SET STATISTICS XML OFF;
```


Отображается side-by-side на рис. 3, можно увидеть, операция сортировки hello в режиме "строка" представляет 81% hello затрат, пока hello пакетный режим только представляет % 19 hello затрат (соответственно 81% и % 56 сортировать hello сам).

*Рисунок 3: Операция СОРТИРОВКИ изменяет режим toobatch строк с уровнем совместимости 130.*

![Рис. 3](./media/sql-database-compatibility-level-query-performance-130/figure-3.png)

Очевидно, что в этих примерах только содержат десятки тысяч строк, никаких действий при просмотре в наши дни hello данные, доступные в большинство серверов SQL. Только их к нескольким миллионам строк вместо этого проекта, и это можно легко преобразовать в несколько минут выполнения перенести каждый день, ожидающих hello характер рабочей нагрузки.

## <a name="cardinality-estimation-ce-improvements"></a>Улучшение оценки количества элементов
Появилась в SQL Server 2014, сделает все базы данных уровня совместимости 120 или выше используйте hello новые возможности для оценки количества элементов. По существу оценки количества элементов — использовать логику hello toodetermine, как SQL server выполняет запрос на расчетные затраты на его основе. Оценка Hello вычисляется с помощью входных данных из статистические данные, связанные с объектами, участвующих в этом запросе. На практике на высоком уровне, функции оценки количества элементов являются оценочными счетчик строк наряду с информацией о распределении hello hello значений счетчиков уникальное значение, и повторяющиеся количество содержащихся в hello таблиц и объектов, указанных в запросе hello. Получение этих оценок так, может привести к toounnecessary дискового ввода-вывода из-за выделения памяти tooinsufficient (т. е. сбросы TempDB) или выбор tooa за параллельного выполнения последовательного плана план выполнения, tooname несколько. Заключение, неправильное оценки может привести tooan общего снижения производительности выполнения запросов hello. На hello другой стороне лучше оценивает, более точным оценкам, выполнения запросов интересы toobetter!

Как упоминалось ранее, оптимизации запросов и оценки являются просто, но если вы хотите toolearn Дополнительные сведения о планы запросов и механизм оценки количества элементов, можно ссылаться toohello документ в [оптимизация свои планы запросов с hello SQL Server 2014 Механизм оценки количества элементов](https://msdn.microsoft.com/library/dn673537.aspx) для более подробного изучения.

## <a name="which-cardinality-estimation-do-you-currently-use"></a>Определение используемой оценки количества элементов
toodetermine, под которой выполняются запросы оценки количества элементов, давайте просто использовать запрос hello примеры ниже. Обратите внимание, что в первом примере будет запускаться при уровне совместимости 110, подразумевает использование hello hello старые функции оценки количества элементов.

```
-- Old CE

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 110;
GO

SET STATISTICS XML ON;

SELECT [c1]
    FROM [dbo].[T_target]
    WHERE [c1] > 20000;
GO

SET STATISTICS XML OFF;
```


После завершения выполнения, щелкните ссылку XML hello и просмотрите свойства hello hello первый итератора, как показано ниже. Имя свойства hello вызывается CardinalityEstimationModelVersion, заданных в настоящее время на 70. Это не значит, что hello базы данных имеет уровень совместимости версии SQL Server 7.0 toohello (устанавливается на 110 как видимый в инструкциях TSQL hello выше), но hello значение 70 просто представляет hello кратности функциональные возможности прошлых доступно с версии SQL Сервер 7.0, которых нет основной номер версии до SQL Server 2014 (который поставляется с уровнем совместимости 120).

*Рис. 4: hello CardinalityEstimationModelVersion установлено too70, при использовании уровнем совместимости 110 и ниже.*

![Рис. 4](./media/sql-database-compatibility-level-query-performance-130/figure-4.png)

Кроме того, можно изменить too130 уровня совместимости hello и отключить использование hello hello новая функция оценки количества элементов с помощью hello LEGACY_CARDINALITY_ESTIMATION задать tooON с [ALTER DATABASE SCOPED CONFIGURATION](https://msdn.microsoft.com/library/mt629158.aspx). Это будет иметь ровно hello такой же, как с помощью 110 с кратности функция точки зрения, при использовании hello последнего запроса, уровень совместимости обработки. Таким образом, можно использовать преимущества hello новый запрос, функциях, поступающих с hello последний уровень совместимости (т. е. пакетный режим), но по-прежнему использует Здравствуй, старый функциональные возможности оценки количества элементов при необходимости.

```
-- Old CE

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130;
GO

ALTER DATABASE
    SCOPED CONFIGURATION
    SET LEGACY_CARDINALITY_ESTIMATION = ON;
GO

SET STATISTICS XML ON;

SELECT [c1]
    FROM [dbo].[T_target]
    WHERE [c1] > 20000;
GO

SET STATISTICS XML OFF;
```


Просто перемещаются toohello уровня совместимости 120 или 130 позволяет hello новые функциональные возможности оценки количества элементов. В этом случае по умолчанию hello CardinalityEstimationModelVersion задается соответствующим образом too120 или 130 как видимый ниже.

```
-- New CE

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130;
GO

ALTER DATABASE
    SCOPED CONFIGURATION
    SET LEGACY_CARDINALITY_ESTIMATION = OFF;
GO

SET STATISTICS XML ON;

SELECT [c1]
    FROM [dbo].[T_target]
    WHERE [c1] > 20000;
GO

SET STATISTICS XML OFF;
```


*Рисунок 5: hello CardinalityEstimationModelVersion установлено too130, при использовании уровень совместимости 130.*

![Рис. 5](./media/sql-database-compatibility-level-query-performance-130/figure-5.jpg)

## <a name="witnessing-hello-cardinality-estimation-differences"></a>Witnessing различия hello оценки количества элементов
Теперь запустим немного более сложная запросов, включающих INNER JOIN с предложением WHERE, и некоторые предикатов и рассмотрим hello предполагаемое число строк из старой кратности функции hello сначала.

```
-- Old CE row estimate with INNER JOIN and WHERE clause

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130;
GO

ALTER DATABASE
    SCOPED CONFIGURATION
    SET LEGACY_CARDINALITY_ESTIMATION = ON;
GO

SET STATISTICS XML ON;

SELECT T.[c2]
    FROM
                   [dbo].[T_source] S
        INNER JOIN [dbo].[T_target] T  ON T.c1=S.c1
    WHERE
        S.[Color] = ‘Red’  AND
        S.[c2] > 2000  AND
        T.[c2] > 2000
    OPTION (RECOMPILE);
GO

SET STATISTICS XML OFF;
```


Для эффективного выполнения этого запроса возвращает 200,704 строки, во время оценки строку hello hello старого функциональность для оценки количества элементов утверждений 194,284 строк. Очевидно, что как отмечалось ранее, результаты вычислений эти строки также зависят от как часто вы выполняли hello предыдущих примерах, который заполняет таблиц образец hello снова и снова при каждом запуске. Очевидно, что предикаты hello в запросе также будет иметь влияет на фактическое оценки hello помимо hello таблицы форму, содержимое данных и как эти данные фактически сопоставлять друг с другом.

*Рисунок 6: предполагаемое число строк hello отключено 194,284 или 6 000 строк из ожидаемых 200,704 строк hello.*

![Рис. 6](./media/sql-database-compatibility-level-query-performance-130/figure-6.jpg)

В hello аналогичным образом, давайте теперь можно выполнить hello же запрос с новыми возможностями кратности hello.

```
-- New CE row estimate with INNER JOIN and WHERE clause

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130;
GO

ALTER DATABASE
    SCOPED CONFIGURATION
    SET LEGACY_CARDINALITY_ESTIMATION = OFF;
GO

SET STATISTICS XML ON;

SELECT T.[c2]
    FROM
                   [dbo].[T_source] S
        INNER JOIN [dbo].[T_target] T  ON T.c1=S.c1
    WHERE
        S.[Color] = ‘Red’  AND
        S.[c2] > 2000  AND
        T.[c2] > 2000
    OPTION (RECOMPILE);
GO

SET STATISTICS XML OFF;
```


Просматривая ниже hello, теперь видно, что эту оценку строку hello 202,877, или гораздо более подробно и выше, чем hello старого оценки количества элементов.

*Рисунок 7: предполагаемое число строк hello сейчас 202,877 вместо 194,284.*

![Рис. 7](./media/sql-database-compatibility-level-query-performance-130/figure-7.jpg)

На самом деле hello результирующий набор будет 200,704 строк (все они зависит, как часто вы запускали hello запросы hello предыдущих примерах, но что более важно, так как hello TSQL использует инструкцию RAND() hello, hello фактические значения, возвращаемые может меняться от одного выполнения toohello далее). Таким образом в данном конкретном примере hello Новая оценка кратности возникновения в оценка hello количество строк, так как 202,877 гораздо ближе too200, 704, чем 194,284 задание лучше! Наконец, если изменить предложение WHERE предикаты tooequality hello (вместо «>» для экземпляра), это может сделать оценки hello между hello старые и новые функции количества элементов еще более другой, в зависимости от того, сколько результатов можно получить.

Очевидно, что в этом случае погрешность в 6000 строк от действительного количества — сравнительно небольшой объем данных в некоторых ситуациях. Теперь Транспонирование этой toomillions строк на несколько таблиц и более сложные запросы, и во время оценки hello предположительно расходится с миллионами строк и таким образом, hello риск неверный план выполнения, или запрос нехватки памяти предоставляет начальные hello комплектации вверх достигнута максимальная планка tooTempDB и поэтому дополнительные операции ввода-вывода, являются гораздо более высокий.

Если у вас есть возможность hello, практики это сравнение с наиболее типичных запросов и наборов данных и узнайте, сколько некоторых старых и новых оценок hello повреждены, хотя некоторые просто станут более off условиях hello или некоторые другие просто Подсчет ближе действительного числа toohello строк, фактически извлеченных в hello результирующих наборов. Все они будут зависеть от фигуры hello запросов, характеристики базы данных Azure SQL hello, hello характер и размер hello наборов данных и hello статистики о них. Если вы только что создали вы экземпляр базы данных SQL Azure, hello запроса оптимизатор будет иметь toobuild выполняется знаний с нуля вместо повторное использование статистики, состоящие из предыдущего запроса hello. Таким образом hello оценки являются очень контекстные и почти конкретные tooevery ситуации сервера и приложения. Это важный аспект tookeep помнить!

## <a name="some-considerations-tootake-into-account"></a>Некоторые особенности tootake в учетную запись
Несмотря на то, что большинство рабочих нагрузок будет полезным hello уровень совместимости 130, прежде чем переходить на уровень совместимости hello для рабочей среды, по сути доступны 3.

1. Перемещение toocompatibility 130 и увидеть, как работают вещей. В случае, если вы заметили регрессий, просто задайте tooits уровень обратной совместимости hello исходный уровень или сохранить 130 и только обратного hello кратности задней toohello устаревший режим (как описано выше, это отдельно решить проблему hello).
2. Тщательно проверьте существующие приложения в аналогичные рабочей нагрузки, тонкой настройки и проверка производительности hello перед выходом tooproduction. В случае проблемы такой же, как показано выше, можно всегда вернуться toohello исходный уровень совместимости, или просто отменить hello кратности задней toohello устаревший режим.
3. Последний вариант и hello последней tooaddress способом эти вопросы, — хранилище запросов tooleverage hello. Это рекомендуемый вариант для современной среды. Анализ hello tooassist запросов в режиме совместимости на уровне 120 или ниже и 130, не рекомендуем вам достаточно toouse хранилище запросов. Хранилище запросов доступен в последнюю версию базы данных SQL Azure V12 hello, и она предназначена toohelp вам в устранении неполадок производительности запроса. Hello хранилище запросов можно рассматривать как "черный ящик" данных для базы данных, собирая и предоставляя подробные исторические сведения обо всех запросах. Это значительно упрощает расследований производительности за счет уменьшения времени toodiagnose hello и устранения проблем. Дополнительные сведения см. в записи блога [Query Store: A flight data recorder for your database](https://azure.microsoft.com/blog/query-store-a-flight-data-recorder-for-your-database/) (Хранилище данных: черный ящик для базы данных).

В hello высокого уровня, если уже имеется набор баз данных с уровнем совместимости 120 или ниже и планирование toomove некоторые из них too130, или так как рабочая нагрузка Автоматическая подготовка новых баз данных, которая будет в скором времени станет значение по умолчанию too130, попробуйте Hello следующие действия:

* Прежде чем изменять toohello новый уровень совместимости в рабочей среде, включите хранилище запросов. Можно ссылаться слишком[изменить hello режима совместимости базы данных и использование hello хранилище запросов](https://msdn.microsoft.com/library/bb895281.aspx) для получения дополнительной информации.
* Теперь необходимо протестируйте всех критических рабочих нагрузок, использующих репрезентативные данные и запросы рабочей среды и сравните производительность hello произошел, а указанная хранилищем запросов. При возникновении некоторых регрессии можно определить hello регрессионных запросов с hello хранилище запросов и использовать форсирования планов hello параметр из хранилища запросов (также называемого планирование закрепление). В этом случае вы точно оставался у hello уровень совместимости 130 и использовать hello бывшая запросов плана предполагается по hello хранилища запросов.
* Если tooleverage новые функции и возможности базы данных SQL Azure (который работает под управлением SQL Server 2016), но являются конфиденциальных toochanges переведена в режим hello уровень совместимости 130, в качестве последнего средства может можно воспользоваться режимом вынужденного hello обратно уровень совместимости уровень toohello, который подходит для рабочей нагрузки с помощью инструкции ALTER DATABASE. Но во-первых, помните, что хранилище запросов плана hello закрепление параметр является наилучшим вариантом, так как не используется 130 по сути остаются на уровне функций hello более раннюю версию SQL Server.
* При наличии многопользовательских приложений, объединение нескольких баз данных, возможно, она hello необходимые tooupdate подготовки логику tooensure вашей базы данных уровень совместимости согласованность всех баз данных; старые и новые подготовленные признаков. Производительность рабочей нагрузки приложения может быть конфиденциальных toohello факт, что некоторые базы данных выполняются на уровнях совместимости разных и таким образом, может потребоваться согласованность на уровне совместимости между любой базы данных в порядке tooprovide hello же интерфейс для работы клиентов tooyour все доски hello. Обратите внимание, что это не требование это зависит влияние уровня совместимости hello приложения.
* И, наконец, касающиеся hello оценки количества элементов, а так же, как изменение уровня совместимости hello, прежде чем продолжить, в рабочей среде, это рекомендуется tootest рабочей нагрузкой в новые условия toodetermine hello, если приложение использует преимущества Улучшение оценки количества элементов Hello.

## <a name="conclusion"></a>Заключение
Использование базы данных SQL Azure toobenefit всех возможностей SQL Server 2016 четко повышает вашей выполнения запросов. Все очень просто. Конечно так же, как любые новые, правильного определения должно производиться toodetermine hello точные условия при которых рабочей нагрузки базы данных работает hello, наилучшим образом. Опыт показывает, что большая часть рабочей нагрузки, ожидаемое tooat бы незаметно при уровне совместимости 130, используя новый запрос, обработка функций и новые оценки количества элементов при этом. Говорят, что, в действительности всегда существуют некоторые исключения и выполнив соответствующие заказа экспертизы является важным оценки toodetermine, насколько вы можете выиграть от этих улучшений. И опять же, hello хранилище запросов может быть очень поможет в выполнении!

По мере развития SQL Azure, можно ожидать уровнем совместимости 140 hello будущих. Тогда мы расскажем о возможностях уровня совместимости 140 так же, как сделали это для уровня совместимости 130.

На данном этапе не стоит забывать, начиная с июня 2016 года базы данных SQL Azure будет заменен уровень совместимости по умолчанию hello 120 too130 для новых баз данных. Помните об этом.

## <a name="references"></a>Ссылки
* [Новые возможности (компонент Database Engine)](https://msdn.microsoft.com/library/bb510411.aspx#InMemory)
* [Запись блога. Query Store: A flight data recorder for your database (Хранилище данных: черный ящик для базы данных). Автор: Борко Новакович (Borko Novakovic). 8 июня 2016 года](https://azure.microsoft.com/blog/query-store-a-flight-data-recorder-for-your-database/)
* [Уровень совместимости инструкции ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/bb510680.aspx)
* [ALTER DATABASE SCOPED CONFIGURATION](https://msdn.microsoft.com/library/mt629158.aspx)
* [Compatibility Level 130 for Azure SQL Database V12](https://azure.microsoft.com/updates/compatibility-level-130-for-azure-sql-database-v12/)
* [Оптимизация свои планы запросов с hello механизм оценки количества элементов SQL Server 2014](https://msdn.microsoft.com/library/dn673537.aspx)
* [Описание индексов columnstore](https://msdn.microsoft.com/library/gg492088.aspx)
* [Запись блога. Повышение производительности запросов с использованием уровня совместимости 130 в базе данных SQL Azure. Автор: Ален Лиссуар (Alain Lissoir). 6 мая 2016 года](https://blogs.msdn.microsoft.com/sqlserverstorageengine/2016/05/06/improved-query-performance-with-compatibility-level-130-in-azure-sql-database/)

<!--
Improved Query Performance with Compatibility Level 130 in Azure SQL Database

May 6, 2016 by Alain Lissoir (AlainL), on GitHub 'alainlissoir'.

https://blogs.msdn.microsoft.com/sqlserverstorageengine/2016/05/06/improved-query-performance-with-compatibility-level-130-in-azure-sql-database/

..... Now, above.
....................
..... Soon, below?

CAPS / MSDN ideally, but instead on ACom:
.. # Assess effects of latest compatibility level on query performance, how to

sql-database-compatibility-level-query-performance-130.md

genemi = MightyPen , 2016-05-20  Friday  17:00pm
-->

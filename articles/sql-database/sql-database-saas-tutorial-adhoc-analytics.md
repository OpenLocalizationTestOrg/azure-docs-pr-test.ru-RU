---
title: "aaaRun ad-hoc аналитические запросы по нескольким базам данных Azure SQL | Документы Microsoft"
description: "Запустите ad-hoc аналитические запросы по нескольким базам данных SQL в приложении несколькими клиентами Wingtip SaaS hello."
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/23/2017
ms.author: billgib; sstein
ms.openlocfilehash: 140cd51fdd03b5a548147282b51ceb0ad80c944d
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="run-ad-hoc-analytics-queries-across-all-wingtip-saas-tenants"></a><span data-ttu-id="33970-104">Выполнение запросов ad-hoc-аналитики по всем клиентам SaaS Wingtip</span><span class="sxs-lookup"><span data-stu-id="33970-104">Run ad-hoc analytics queries across all Wingtip SaaS tenants</span></span>

<span data-ttu-id="33970-105">В этом учебнике вы выполнять распределенные запросы между hello весь набор баз данных клиента tooenable ad-hoc аналитику.</span><span class="sxs-lookup"><span data-stu-id="33970-105">In this tutorial, you run distributed queries across hello entire set of tenant databases tooenable ad-hoc analytics.</span></span> <span data-ttu-id="33970-106">Эластичный запрос является используется tooenable распределенных запросов, которая требует дополнительной аналитики база данных развернута (сервер каталога toohello).</span><span class="sxs-lookup"><span data-stu-id="33970-106">Elastic Query is used tooenable distributed queries, which requires an additional analytics database is deployed (toohello catalog server).</span></span> <span data-ttu-id="33970-107">Эти запросы можно извлекать аналитики содержатся в hello повседневных рабочих данных приложение Wingtip SaaS hello.</span><span class="sxs-lookup"><span data-stu-id="33970-107">These queries can extract insights buried in hello day-to-day operational data of hello Wingtip SaaS app.</span></span>


<span data-ttu-id="33970-108">Из этого руководства вы узнаете следующее:</span><span class="sxs-lookup"><span data-stu-id="33970-108">In this tutorial you learn:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="33970-109">О hello глобальные представления в каждой базе данных позволяющие эффективно опрашивать клиентов</span><span class="sxs-lookup"><span data-stu-id="33970-109">About hello global views in each database, that enable efficient querying across tenants</span></span>
> * <span data-ttu-id="33970-110">Как toodeploy базы данных служб аналитики ad-hoc</span><span class="sxs-lookup"><span data-stu-id="33970-110">How toodeploy an ad-hoc analytics database</span></span>
> * <span data-ttu-id="33970-111">Как toorun распределенные запросы по всем базам данных клиента</span><span class="sxs-lookup"><span data-stu-id="33970-111">How toorun distributed queries across all tenant databases</span></span>



<span data-ttu-id="33970-112">toocomplete завершения этого учебника, убедитесь, что hello следующие предварительные требования:</span><span class="sxs-lookup"><span data-stu-id="33970-112">toocomplete this tutorial, make sure hello following prerequisites are completed:</span></span>

* <span data-ttu-id="33970-113">приложение Wingtip SaaS Hello развертывается.</span><span class="sxs-lookup"><span data-stu-id="33970-113">hello Wingtip SaaS app is deployed.</span></span> <span data-ttu-id="33970-114">toodeploy менее чем за пять минут. в разделе [развертывание и просмотр приложения Wingtip SaaS hello](sql-database-saas-tutorial.md)</span><span class="sxs-lookup"><span data-stu-id="33970-114">toodeploy in less than five minutes, see [Deploy and explore hello Wingtip SaaS application](sql-database-saas-tutorial.md)</span></span>
* <span data-ttu-id="33970-115">Установите Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="33970-115">Azure PowerShell is installed.</span></span> <span data-ttu-id="33970-116">Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).</span><span class="sxs-lookup"><span data-stu-id="33970-116">For details, see [Getting started with Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span></span>
* <span data-ttu-id="33970-117">Установите SQL Server Management Studio (SSMS).</span><span class="sxs-lookup"><span data-stu-id="33970-117">SQL Server Management Studio (SSMS) is installed.</span></span> <span data-ttu-id="33970-118">toodownload и установки SSMS, в разделе [загрузить SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span><span class="sxs-lookup"><span data-stu-id="33970-118">toodownload and install SSMS, see [Download SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span></span>


## <a name="ad-hoc-analytics-pattern"></a><span data-ttu-id="33970-119">Модель ad-hoc-аналитики</span><span class="sxs-lookup"><span data-stu-id="33970-119">Ad-hoc analytics pattern</span></span>

<span data-ttu-id="33970-120">Одним из hello значительные возможности с приложениями SaaS является toouse hello огромное количество данных клиента, централизованно хранятся в облаке hello.</span><span class="sxs-lookup"><span data-stu-id="33970-120">One of hello great opportunities with SaaS applications is toouse hello vast amount of tenant data stored centrally in hello cloud.</span></span> <span data-ttu-id="33970-121">Используйте этот данных toogain анализировать операции hello и использование приложения, вашим клиентам, их пользователям, параметры, поведений, и т. д. Эти сведения будут полезны при разработке функций, помогут повысить удобство использования, а также обеспечить вложение дополнительных средств в приложения и службы.</span><span class="sxs-lookup"><span data-stu-id="33970-121">Use this data toogain insights into hello operation and usage of your application, your tenants, their users, preferences, behaviors, etc. These insights can guide feature development, usability improvements, and other investments in your apps and services.</span></span>

<span data-ttu-id="33970-122">Доступ к этим данным получить очень просто, если они содержатся в отдельной мультитенантной базе данных, но не так просто, если они распределены по тысячам масштабируемых баз данных.</span><span class="sxs-lookup"><span data-stu-id="33970-122">Accessing this data in a single multi-tenant database is easy, but not so easy when distributed at scale across potentially thousands of databases.</span></span> <span data-ttu-id="33970-123">Одним из подходов является toouse [эластичной запроса](sql-database-elastic-query-overview.md), что обеспечивает выполнение запросов в распределенный набор баз данных с общей схемой.</span><span class="sxs-lookup"><span data-stu-id="33970-123">One approach is toouse [Elastic Query](sql-database-elastic-query-overview.md), which enables querying across a distributed set of databases with common schema.</span></span> <span data-ttu-id="33970-124">Эластичный запроса используется один *head* базы данных, в котором определены внешние таблицы, зеркальных таблиц или представлений в hello распределенных баз данных (клиента).</span><span class="sxs-lookup"><span data-stu-id="33970-124">Elastic Query uses a single *head* database in which external tables are defined that mirror tables or views in hello distributed (tenant) databases.</span></span> <span data-ttu-id="33970-125">Запросы отправлен toothis head базы данных являются tooproduce скомпилированный план распределенного запроса с части запроса hello сместить вниз toohello базы данных клиента, при необходимости.</span><span class="sxs-lookup"><span data-stu-id="33970-125">Queries submitted toothis head database are compiled tooproduce a distributed query plan, with portions of hello query pushed down toohello tenant databases as needed.</span></span> <span data-ttu-id="33970-126">Эластичный запрос использует карта сегментов hello в hello каталога базы данных tooprovide hello папку hello базы данных клиента.</span><span class="sxs-lookup"><span data-stu-id="33970-126">Elastic Query uses hello shard map in hello catalog database tooprovide hello location of hello tenant databases.</span></span> <span data-ttu-id="33970-127">При настройке и выполнении запроса используется стандартный язык [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), поддерживающий ad-hoc-запросы из таких инструментов, как Power BI и Excel.</span><span class="sxs-lookup"><span data-stu-id="33970-127">Setup and query are straightforward using standard [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), and support ad-hoc querying from tools like Power BI and Excel.</span></span>

<span data-ttu-id="33970-128">Путем распределения запросов между базами данных клиента hello, эластичной запрос предоставляет непосредственное представление о реальных производственных данных.</span><span class="sxs-lookup"><span data-stu-id="33970-128">By distributing queries across hello tenant databases, Elastic Query provides immediate insight into live production data.</span></span> <span data-ttu-id="33970-129">Тем не менее как эластичный запрос извлекает данные из возможного множества баз данных, запросов задержки иногда может быть выше, чем для эквивалентных запросов передавать tooa одной базы данных с несколькими клиентами.</span><span class="sxs-lookup"><span data-stu-id="33970-129">However, as Elastic Query pulls data from potentially many databases, query latency can sometimes be higher than for equivalent queries submitted tooa single multi-tenant database.</span></span> <span data-ttu-id="33970-130">При создании запросов toominimize hello данные, возвращаемые следует соблюдать осторожность.</span><span class="sxs-lookup"><span data-stu-id="33970-130">Care should be taken when designing queries toominimize hello data that is returned.</span></span> <span data-ttu-id="33970-131">Эластичный запрос часто лучше всего подходит для запросов небольших объемов данных в реальном времени, как противоположность toobuilding часто используются сложные аналитические запросы или отчеты.</span><span class="sxs-lookup"><span data-stu-id="33970-131">Elastic Query is often best suited for querying small amounts of real-time data, as opposed toobuilding frequently used or complex analytics queries or reports.</span></span> <span data-ttu-id="33970-132">Если также не выполнить запросы, посмотрите hello [план выполнения](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) toosee, какая часть запроса hello переданное вниз toohello удаленной базы данных и о том, сколько данных возвращается.</span><span class="sxs-lookup"><span data-stu-id="33970-132">If queries don't perform well, look at hello [execution plan](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) toosee what part of hello query has been pushed down toohello remote database and how much data is being returned.</span></span> <span data-ttu-id="33970-133">Запросы, требующие сложной аналитической обработки, в некоторых случаях могут обслуживаться лучше, если данные клиента будут извлечены в выделенную базу данных или хранилище данных, оптимизированное для аналитических запросов.</span><span class="sxs-lookup"><span data-stu-id="33970-133">Queries that require complex analytical processing may be better served in some cases by extracting tenant data into a dedicated database or data warehouse optimized for analytics queries.</span></span> <span data-ttu-id="33970-134">Этот шаблон подробно описан hello [учебника аналитика клиента](sql-database-saas-tutorial-tenant-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="33970-134">This pattern is explained in hello [tenant analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md).</span></span> 

## <a name="get-hello-wingtip-application-scripts"></a><span data-ttu-id="33970-135">Получение скриптов приложения Wingtip hello</span><span class="sxs-lookup"><span data-stu-id="33970-135">Get hello Wingtip application scripts</span></span>

<span data-ttu-id="33970-136">Hello Wingtip SaaS скриптов и исходный код приложения были доступны в hello [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) в репозитории github.</span><span class="sxs-lookup"><span data-stu-id="33970-136">hello Wingtip SaaS scripts and application source code are available in hello [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github repo.</span></span> <span data-ttu-id="33970-137">[Действия скриптов Wingtip SaaS hello toodownload](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span><span class="sxs-lookup"><span data-stu-id="33970-137">[Steps toodownload hello Wingtip SaaS scripts](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span></span>

## <a name="create-ticket-sales-data"></a><span data-ttu-id="33970-138">Создание данных о продажах билетов</span><span class="sxs-lookup"><span data-stu-id="33970-138">Create ticket sales data</span></span>

<span data-ttu-id="33970-139">toorun запросов к более интересный набор данных, создайте билет данные о продажах, запустив билет генератор hello.</span><span class="sxs-lookup"><span data-stu-id="33970-139">toorun queries against a more interesting data set, create ticket sales data by running hello ticket-generator.</span></span>

1. <span data-ttu-id="33970-140">В hello *интегрированной среды Сценариев PowerShell*откройте hello... \\Модулей обучения\\оперативной аналитики\\Adhoc Analytics\\*AdhocAnalytics.ps1 Демонстрация* сценариев и задайте следующие значения hello:</span><span class="sxs-lookup"><span data-stu-id="33970-140">In hello *PowerShell ISE*, open hello ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* script and set hello following values:</span></span>
   * <span data-ttu-id="33970-141">**$DemoScenario** = 1, чтобы **приобрести билеты на мероприятия во всех местах проведения**.</span><span class="sxs-lookup"><span data-stu-id="33970-141">**$DemoScenario** = 1, **Purchase tickets for events at all venues**.</span></span>
2. <span data-ttu-id="33970-142">Нажмите клавишу **F5** запустить сценарий hello и создать билет продаж.</span><span class="sxs-lookup"><span data-stu-id="33970-142">Press **F5** to run hello script and generate ticket sales.</span></span> <span data-ttu-id="33970-143">Пока выполняется скрипт hello, выполните шаги hello в этом учебнике.</span><span class="sxs-lookup"><span data-stu-id="33970-143">While hello script is running, continue hello steps in this tutorial.</span></span> <span data-ttu-id="33970-144">данные билета Hello запрашивается в hello *выполнение нерегламентированных распределенных запросов* статьи, таким образом дождитесь toocomplete генератор hello билет, если по-прежнему выполняется при получении toothat упражнения.</span><span class="sxs-lookup"><span data-stu-id="33970-144">hello ticket data is queried in hello *Run ad-hoc distributed queries* section, so wait for hello ticket generator toocomplete if it's still running when you get toothat exercise.</span></span>

## <a name="explore-hello-global-views"></a><span data-ttu-id="33970-145">Просмотр hello глобальные представления</span><span class="sxs-lookup"><span data-stu-id="33970-145">Explore hello global views</span></span>

<span data-ttu-id="33970-146">Hello приложения Wingtip SaaS построена на основе модели клиента на основе баз данных, поэтому схема базы данных клиента hello определяется с точки зрения одного клиента.</span><span class="sxs-lookup"><span data-stu-id="33970-146">hello Wingtip SaaS application is built using a tenant-per-database model, so hello tenant database schema is defined from a single-tenant perspective.</span></span> <span data-ttu-id="33970-147">Сведения для конкретного клиента находятся в одной таблице, *Venue*, в которой всегда есть одна строка. Эта таблица создается как куча, без первичного ключа.</span><span class="sxs-lookup"><span data-stu-id="33970-147">Tenant-specific information exists in one table, *Venue*, which always has a single row, and is implemented as a heap, without a primary key.</span></span> <span data-ttu-id="33970-148">Другие таблицы в схеме hello не нужен toobe связанные toohello *проведения* таблицы, так как при нормальном использовании никогда нет каких-либо сомнений, какие данные клиента hello принадлежит.</span><span class="sxs-lookup"><span data-stu-id="33970-148">Other tables in hello schema don't need toobe related toohello *Venue* table, because in normal use, there is never any doubt which tenant hello data belongs to.</span></span>

<span data-ttu-id="33970-149">Тем не менее при выполнении запросов по всем базам данных, очень важно, что эластичной запроса можно считать, hello данных входит в состав одной логической базы данных сегментированной клиентом.</span><span class="sxs-lookup"><span data-stu-id="33970-149">However, when querying across all databases, it's important that Elastic Query can treat hello data as if it is part of a single logical database sharded by tenant.</span></span> <span data-ttu-id="33970-150">tooachieve это набор представлений «global» будут добавлены toohello базы данных клиента, проекцию ИД клиента в каждой из таблиц hello, запрашиваемых глобально.</span><span class="sxs-lookup"><span data-stu-id="33970-150">tooachieve this, a set of 'global' views are added toohello tenant database that project a tenant id into each of hello tables that are queried globally.</span></span> <span data-ttu-id="33970-151">Здравствуйте, например, *VenueEvents* представление добавляет вычисляемый *VenueId* спроецировано toohello столбцы из hello *события* таблицы.</span><span class="sxs-lookup"><span data-stu-id="33970-151">For example, hello *VenueEvents* view adds a computed *VenueId* toohello columns projected from hello *Events* table.</span></span> <span data-ttu-id="33970-152">Определив hello внешней таблицы в базе данных головного hello через *VenueEvents* (вместо базового hello *событий* таблицы), эластичной запрос является может toopush работу соединений, основанных на *VenueId* , они могут выполняться параллельно для каждой удаленной базы данных (а не в базе данных головного hello).</span><span class="sxs-lookup"><span data-stu-id="33970-152">By defining hello external table in hello head database over *VenueEvents* (rather than hello underlying *Events* table), Elastic Query is able toopush down joins based on *VenueId* so they can be executed in parallel on each remote database (rather than on hello head database).</span></span> <span data-ttu-id="33970-153">Это значительно сокращает hello объем данных, возвращаемых, что приводит к значительное увеличение производительности для нескольких запросов.</span><span class="sxs-lookup"><span data-stu-id="33970-153">This dramatically reduces hello amount of data that is returned, which results in a substantial increase in performance for many queries.</span></span> <span data-ttu-id="33970-154">Данные глобальные представления предварительно созданы во всех базах данных клиента (и в *basetenantdb*).</span><span class="sxs-lookup"><span data-stu-id="33970-154">These global views have been pre-created in all tenant databases (and in *basetenantdb*).</span></span>

1. <span data-ttu-id="33970-155">Откройте SSMS и [connect toohello tenants1 -&lt;пользователя&gt; сервера](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span><span class="sxs-lookup"><span data-stu-id="33970-155">Open SSMS and [connect toohello tenants1-&lt;USER&gt; server](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span></span>
2. <span data-ttu-id="33970-156">Разверните узел **Базы данных**, щелкните **contosoconcerthall** правой кнопкой мыши и выберите **Создать запрос**.</span><span class="sxs-lookup"><span data-stu-id="33970-156">Expand **Databases**, right-click **contosoconcerthall**, and select **New Query**.</span></span>
3. <span data-ttu-id="33970-157">Выполните следующие запросы tooexplore hello разность hello одного клиента таблиц и представлений глобального hello hello.</span><span class="sxs-lookup"><span data-stu-id="33970-157">Run hello following queries tooexplore hello difference between hello single-tenant tables and hello global views:</span></span>

   ```T-SQL
   -- hello base Venue table, that has no VenueId associated.
   SELECT * FROM Venue

   -- Notice hello plural name 'Venues'. This view projects a VenueId column.
   SELECT * FROM Venues

   -- hello base Events table, which has no VenueId column.
   SELECT * FROM Events

   -- This view projects hello VenueId retrieved from hello Venues table.
   SELECT * FROM VenueEvents
   ```

<span data-ttu-id="33970-158">В этих представлениях hello *VenueId* вычисляется как хэш hello проведения имя, но любой подход может быть используется toointroduce уникальное значение.</span><span class="sxs-lookup"><span data-stu-id="33970-158">In these views, hello *VenueId* is computed as a hash of hello Venue name, but any approach could be used toointroduce a unique value.</span></span> <span data-ttu-id="33970-159">Этот подход является сходным образом toohello ключ клиента hello вычисляется для использования в каталоге hello.</span><span class="sxs-lookup"><span data-stu-id="33970-159">This approach is similar toohello way hello tenant key is computed for use in hello catalog.</span></span>

<span data-ttu-id="33970-160">Определение hello tooexamine hello *местоположения* представления:</span><span class="sxs-lookup"><span data-stu-id="33970-160">tooexamine hello definition of hello *Venues* view:</span></span>

1. <span data-ttu-id="33970-161">В **обозревателе объектов** разверните узел **contosoconcethall** > **Представления**:</span><span class="sxs-lookup"><span data-stu-id="33970-161">In **Object Explorer**, expand **contosoconcethall** > **Views**:</span></span>

   ![узел "Представления"](media/sql-database-saas-tutorial-adhoc-analytics/views.png)

2. <span data-ttu-id="33970-163">Щелкните **dbo.Venues** правой кнопкой мыши.</span><span class="sxs-lookup"><span data-stu-id="33970-163">Right-click **dbo.Venues**.</span></span>
3. <span data-ttu-id="33970-164">Выберите **Создать скрипт для представления** > **Используя CREATE** > **В новом окне редактора запросов**.</span><span class="sxs-lookup"><span data-stu-id="33970-164">Select **Script View as** > **CREATE To** > **New Query Editor Window**</span></span>

<span data-ttu-id="33970-165">Скрипт, любой из других hello *проведения* представления toosee как добавляют hello *VenueId*.</span><span class="sxs-lookup"><span data-stu-id="33970-165">Script any of hello other *Venue* views toosee how they add hello *VenueId*.</span></span>

## <a name="deploy-hello-database-used-for-ad-hoc-distributed-queries"></a><span data-ttu-id="33970-166">Развертывание базы данных hello, используемой для нерегламентированных распределенных запросов</span><span class="sxs-lookup"><span data-stu-id="33970-166">Deploy hello database used for ad-hoc distributed queries</span></span>

<span data-ttu-id="33970-167">В этом упражнении развертывает hello *adhocanalytics* базы данных.</span><span class="sxs-lookup"><span data-stu-id="33970-167">This exercise deploys hello *adhocanalytics* database.</span></span> <span data-ttu-id="33970-168">Это hello головного базы данных, который будет содержать hello схемы, используемой для выполнения запросов по всем базам данных клиента.</span><span class="sxs-lookup"><span data-stu-id="33970-168">This is hello head database that will contain hello schema used for querying across all tenant databases.</span></span> <span data-ttu-id="33970-169">База данных Hello — развернутой toohello существующий сервер каталога, который hello сервера, используемого для всех связанных с управлением баз данных в пример приложения hello.</span><span class="sxs-lookup"><span data-stu-id="33970-169">hello database is deployed toohello existing catalog server, which is hello server used for all management-related databases in hello sample app.</span></span>

1. <span data-ttu-id="33970-170">Открыть... \\Модулей обучения\\оперативной аналитики\\Adhoc Analytics\\*Демонстрация AdhocAnalytics.ps1* в hello *интегрированной среды Сценариев PowerShell* и набор hello следующие значения:</span><span class="sxs-lookup"><span data-stu-id="33970-170">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* in hello *PowerShell ISE* and set hello following values:</span></span>
   * <span data-ttu-id="33970-171">**$DemoScenario** = 2, **Deploy Ad-hoc analytics database**.</span><span class="sxs-lookup"><span data-stu-id="33970-171">**$DemoScenario** = 2, **Deploy Ad-hoc analytics database**.</span></span>

2. <span data-ttu-id="33970-172">Нажмите клавишу **F5** toorun hello скрипт и создать hello *adhocanalytics* базы данных.</span><span class="sxs-lookup"><span data-stu-id="33970-172">Press **F5** toorun hello script and create hello *adhocanalytics* database.</span></span>

<span data-ttu-id="33970-173">В следующем разделе hello добавьте базу данных toohello схемы, его можно использовать toorun распределенных запросов.</span><span class="sxs-lookup"><span data-stu-id="33970-173">In hello next section, you add schema toohello database so it can be used toorun distributed queries.</span></span>

## <a name="configure-hello-database-for-running-distributed-queries"></a><span data-ttu-id="33970-174">Настройка hello базы данных для выполнения распределенных запросов</span><span class="sxs-lookup"><span data-stu-id="33970-174">Configure hello database for running distributed queries</span></span>

<span data-ttu-id="33970-175">В этом упражнении добавляет базу данных аналитики схемой (hello внешнего источника данных и определения внешних таблиц) toohello ad-hoc, позволяющее выполнять запросы по всем базам данных клиента.</span><span class="sxs-lookup"><span data-stu-id="33970-175">This exercise adds schema (hello external data source and external table definitions) toohello ad-hoc analytics database that enables querying across all tenant databases.</span></span>

1. <span data-ttu-id="33970-176">Откройте SQL Server Management Studio и подключитесь toohello нерегламентированного анализа базы данных, созданный на предыдущем шаге hello.</span><span class="sxs-lookup"><span data-stu-id="33970-176">Open SQL Server Management Studio, and connect toohello Adhoc Analytics database you created in hello previous step.</span></span> <span data-ttu-id="33970-177">Hello hello база данных будет называться adhocanalytics.</span><span class="sxs-lookup"><span data-stu-id="33970-177">hello name of hello database will be adhocanalytics.</span></span>
2. <span data-ttu-id="33970-178">Откройте файл …\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* в SSMS.</span><span class="sxs-lookup"><span data-stu-id="33970-178">Open ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* in SSMS.</span></span>
3. <span data-ttu-id="33970-179">Просмотреть скрипт SQL hello и обратите внимание hello следующее:</span><span class="sxs-lookup"><span data-stu-id="33970-179">Review hello SQL script and note hello following:</span></span>

   <span data-ttu-id="33970-180">Эластичный запрос с помощью учетных данных области базы данных tooaccess каждой из баз данных клиента hello.</span><span class="sxs-lookup"><span data-stu-id="33970-180">Elastic Query uses a database-scoped credential tooaccess each of hello tenant databases.</span></span> <span data-ttu-id="33970-181">Эти учетные данные должен toobe доступны во всех базах данных hello и обычно должны предоставляться hello минимальные права, необходимые tooenable эти нерегламентированные запросы.</span><span class="sxs-lookup"><span data-stu-id="33970-181">This credential needs toobe available in all hello databases and should normally be granted hello minimum rights required tooenable these ad-hoc queries.</span></span>

    ![Создание учетных данных](media/sql-database-saas-tutorial-adhoc-analytics/create-credential.png)

   <span data-ttu-id="33970-183">Hello определить внешний источник данных, карта сегментов toouse hello клиента в базе данных каталога hello.</span><span class="sxs-lookup"><span data-stu-id="33970-183">hello external data source, that is defined toouse hello tenant shard map in hello catalog database.</span></span> <span data-ttu-id="33970-184">С помощью этого как hello внешнему источнику данных, запросы, tooall распределенной базы данных, зарегистрированные в каталоге hello, при выполнении запроса hello.</span><span class="sxs-lookup"><span data-stu-id="33970-184">By using this as hello external data source, queries are distributed tooall databases registered in hello catalog when hello query is run.</span></span> <span data-ttu-id="33970-185">Так как имена серверов различны для каждого развертывания, этот сценарий инициализации получает hello расположение базы данных каталога hello, получая текущего сервера hello (@@servername) которой выполняется сценарий hello.</span><span class="sxs-lookup"><span data-stu-id="33970-185">Because server names are different for each deployment, this initialization script gets hello location of hello catalog database by retrieving hello current server (@@servername) where hello script is executed.</span></span>

    ![Создание внешнего источника данных](media/sql-database-saas-tutorial-adhoc-analytics/create-external-data-source.png)

   <span data-ttu-id="33970-187">Здравствуйте, внешней таблицы, которые ссылаются hello глобальные представления описано в предыдущем разделе hello и определенного с **РАСПРОСТРАНЕНИЯ = SHARDED(VenueId)**.</span><span class="sxs-lookup"><span data-stu-id="33970-187">hello external tables that reference hello global views described in hello previous section, and defined with **DISTRIBUTION = SHARDED(VenueId)**.</span></span> <span data-ttu-id="33970-188">Поскольку каждый *VenueId* tooa отдельную базу данных сопоставляет это повышает производительность для многих сценариев, как показано в следующем разделе hello.</span><span class="sxs-lookup"><span data-stu-id="33970-188">Because each *VenueId* maps tooa single database, this improves performance for many scenarios as shown in hello next section.</span></span>

    ![Создание внешних таблиц](media/sql-database-saas-tutorial-adhoc-analytics/external-tables.png)

   <span data-ttu-id="33970-190">Hello локальной таблицы *VenueTypes* , создается и заполняется.</span><span class="sxs-lookup"><span data-stu-id="33970-190">hello local table *VenueTypes* that is created and populated.</span></span> <span data-ttu-id="33970-191">Эту ссылочную таблицу данных проявляется во всех базах данных клиента, поэтому он может быть представлен здесь в качестве локальной таблицы и заполненная hello общих данных.</span><span class="sxs-lookup"><span data-stu-id="33970-191">This reference data table is common in all tenant databases, so it can be represented here as a local table and populated with hello common data.</span></span> <span data-ttu-id="33970-192">Для некоторых запросов hello, это может снизить объем данных перемещать между базами данных клиента hello и hello *adhocanalytics* базы данных.</span><span class="sxs-lookup"><span data-stu-id="33970-192">For some queries this may reduce hello amount of data moved between hello tenant databases and hello *adhocanalytics* database.</span></span>

    ![Создание таблицы](media/sql-database-saas-tutorial-adhoc-analytics/create-table.png)

   <span data-ttu-id="33970-194">Если ссылочные таблицы таким образом, следует убедиться, что tooupdate hello схемы и данных таблицы, при каждом обновлении базы данных клиента hello.</span><span class="sxs-lookup"><span data-stu-id="33970-194">If you include reference tables in this manner, be sure tooupdate hello table schema and data whenever you update hello tenant databases.</span></span>

4. <span data-ttu-id="33970-195">Нажмите клавишу **F5** toorun hello сценариев и инициализации hello *adhocanalytics* базы данных.</span><span class="sxs-lookup"><span data-stu-id="33970-195">Press **F5** toorun hello script and initialize hello *adhocanalytics* database.</span></span> 

<span data-ttu-id="33970-196">Теперь можно выполнять распределенные запросы и собирать данные аналитики по всем клиентам.</span><span class="sxs-lookup"><span data-stu-id="33970-196">Now you can run distributed queries, and gather insights across all tenants!</span></span>

## <a name="run-ad-hoc-distributed-queries"></a><span data-ttu-id="33970-197">Выполнение распределенных ad-hoc-запросов</span><span class="sxs-lookup"><span data-stu-id="33970-197">Run ad-hoc distributed queries</span></span>

<span data-ttu-id="33970-198">Теперь этот hello *adhocanalytics* база данных не установлено, загрузив и выполните несколько распределенных запросов.</span><span class="sxs-lookup"><span data-stu-id="33970-198">Now that hello *adhocanalytics* database is set up, go ahead and run some distributed queries.</span></span> <span data-ttu-id="33970-199">Включить hello план выполнения для лучшего понимания того, где происходит обработка запросов hello.</span><span class="sxs-lookup"><span data-stu-id="33970-199">Include hello execution plan for a better understanding of where hello query processing is happening.</span></span> 

<span data-ttu-id="33970-200">При проверке плана выполнения hello, наведите курсор на значки плана hello подробные сведения.</span><span class="sxs-lookup"><span data-stu-id="33970-200">When inspecting hello execution plan, hover over hello plan icons for details.</span></span> 

<span data-ttu-id="33970-201">Этот параметр является важным toonote **РАСПРОСТРАНЕНИЯ = SHARDED(VenueId)** при определении hello внешнего источника данных, повышает производительность для многих сценариев.</span><span class="sxs-lookup"><span data-stu-id="33970-201">Important toonote, is that setting **DISTRIBUTION = SHARDED(VenueId)** when we defined hello external data source, improves performance for many scenarios.</span></span> <span data-ttu-id="33970-202">Так как каждый *VenueId* сопоставляет tooa отдельную базу данных фильтрации является данных легко выполняется удаленно, возвращающий только hello, нам нужно.</span><span class="sxs-lookup"><span data-stu-id="33970-202">Because each *VenueId* maps tooa single database, filtering is easily done remotely, returning only hello data we need.</span></span>

1. <span data-ttu-id="33970-203">Откройте в SSMS \\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql*.</span><span class="sxs-lookup"><span data-stu-id="33970-203">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql* in SSMS.</span></span>
2. <span data-ttu-id="33970-204">Убедитесь, подключенных toohello **adhocanalytics** базы данных.</span><span class="sxs-lookup"><span data-stu-id="33970-204">Ensure you are connected toohello **adhocanalytics** database.</span></span>
3. <span data-ttu-id="33970-205">Выберите hello **запроса** меню и выберите пункт **Включить действительный план выполнения**</span><span class="sxs-lookup"><span data-stu-id="33970-205">Select hello **Query** menu and click **Include Actual Execution Plan**</span></span>
4. <span data-ttu-id="33970-206">Выделите hello *какие местоположения в настоящее время зарегистрированы?* запрос и нажмите клавишу **F5**.</span><span class="sxs-lookup"><span data-stu-id="33970-206">Highlight hello *Which venues are currently registered?* query, and press **F5**.</span></span>

   <span data-ttu-id="33970-207">Hello запрос возвращает список всего проведения hello, демонстрирующая способ быстрого и удобное tooquery для всех клиентов и получение данных для каждого клиента.</span><span class="sxs-lookup"><span data-stu-id="33970-207">hello query returns hello entire venue list, illustrating how quick and easy it is tooquery across all tenants and return data from each tenant.</span></span>

   <span data-ttu-id="33970-208">Проверять план hello, где затраты на hello hello удаленного запроса, так как мы просто базы данных клиента tooeach переход и выбор информации место проведения hello.</span><span class="sxs-lookup"><span data-stu-id="33970-208">Inspect hello plan and see that hello entire cost is hello remote query because we're simply going tooeach tenant database and selecting hello venue information.</span></span>

   ![SELECT * FROM dbo.Venues](media/sql-database-saas-tutorial-adhoc-analytics/query1-plan.png)

5. <span data-ttu-id="33970-210">Следующий запрос SELECT hello и нажмите клавишу **F5**.</span><span class="sxs-lookup"><span data-stu-id="33970-210">Select hello next query, and press **F5**.</span></span>

   <span data-ttu-id="33970-211">Этот запрос объединяет данные из базы данных клиента hello и локальный hello *VenueTypes* таблицы (локально, как оно является таблицей в hello *adhocanalytics* базы данных).</span><span class="sxs-lookup"><span data-stu-id="33970-211">This query joins data from hello tenant databases and hello local *VenueTypes* table (local, as its a table in hello *adhocanalytics* database).</span></span>

   <span data-ttu-id="33970-212">Проверять план hello и разделе hello, большая часть стоимости является hello удаленного запроса, так как мы запрос информации место проведения каждого клиента (dbo. Местоположения), а затем выполните быстрый локального соединения с локальным hello *VenueTypes* понятное имя таблицы toodisplay hello.</span><span class="sxs-lookup"><span data-stu-id="33970-212">Inspect hello plan and see that hello majority of cost is hello remote query because we query each tenant's venue info (dbo.Venues), and then do a quick local join with hello local *VenueTypes* table toodisplay hello friendly name.</span></span>

   ![Соединение удаленных и локальных данных](media/sql-database-saas-tutorial-adhoc-analytics/query2-plan.png)

6. <span data-ttu-id="33970-214">Теперь выберите hello *на какой день были hello большинство билеты проданных?* запрос и нажмите клавишу **F5**.</span><span class="sxs-lookup"><span data-stu-id="33970-214">Now select hello *On which day were hello most tickets sold?* query, and press **F5**.</span></span>

   <span data-ttu-id="33970-215">Этот запрос выполняет более сложное соединение и агрегирование.</span><span class="sxs-lookup"><span data-stu-id="33970-215">This query does a bit more complex joining and aggregation.</span></span> <span data-ttu-id="33970-216">Важным toonote является большая часть обработки hello выполняется удаленно, что опять же, мы вернуть только строки hello нужные нам, возвращая только одну строку для каждого проведения статистические билет продажи числа в день.</span><span class="sxs-lookup"><span data-stu-id="33970-216">What's important toonote is that most of hello processing is done remotely, and once again, we bring back only hello rows we need, returning just a single row for each venue's aggregate ticket sale count per day.</span></span>

   ![query](media/sql-database-saas-tutorial-adhoc-analytics/query3-plan.png)


## <a name="next-steps"></a><span data-ttu-id="33970-218">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="33970-218">Next steps</span></span>

<span data-ttu-id="33970-219">Из этого руководства вы узнали следующее:</span><span class="sxs-lookup"><span data-stu-id="33970-219">In this tutorial you learned how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="33970-220">как выполнить распределенные запросы по всем клиентским базам данных.</span><span class="sxs-lookup"><span data-stu-id="33970-220">Run distributed queries across all tenant databases</span></span>
> * <span data-ttu-id="33970-221">Развертывание базы данных служб аналитики ad-hoc и добавление схемы tooit toorun распределенных запросов.</span><span class="sxs-lookup"><span data-stu-id="33970-221">Deploy an ad-hoc analytics database and add schema tooit toorun distributed queries.</span></span>


<span data-ttu-id="33970-222">Теперь попробуйте hello [аналитика клиента учебника](sql-database-saas-tutorial-tenant-analytics.md) tooexplore извлечение данных базы данных отдельных analytics tooa для более сложную обработку analytics...</span><span class="sxs-lookup"><span data-stu-id="33970-222">Now try hello [Tenant Analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md) tooexplore extracting data tooa separate analytics database for more complex analytics processing...</span></span>

## <a name="additional-resources"></a><span data-ttu-id="33970-223">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="33970-223">Additional resources</span></span>

* <span data-ttu-id="33970-224">Дополнительные [учебники, которые созданы на основе Wingtip SaaS приложения hello](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span><span class="sxs-lookup"><span data-stu-id="33970-224">Additional [tutorials that build upon hello Wingtip SaaS application](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span></span>
* [<span data-ttu-id="33970-225">Обзор эластичных запросов к базе данных SQL Azure (предварительная версия)</span><span class="sxs-lookup"><span data-stu-id="33970-225">Elastic Query</span></span>](sql-database-elastic-query-overview.md)

---
title: "Выполнение специальных запросов аналитики к нескольким базам данных SQL Azure | Документация Майкрософт"
description: "Выполнение запросов ad-hoc-аналитики к нескольким базам данных SQL в примере мультитенантного приложения."
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/23/2017
ms.author: billgib; sstein
ms.openlocfilehash: a27a65627fecf35b59122110250a40c6fe8077b5
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="run-ad-hoc-analytics-queries-across-multiple-azure-sql-databases"></a>Выполнение запросов ad-hoc-аналитики к нескольким базам данных SQL Azure

В этом руководстве выполняются распределенные запросы ко всему набору мультитенантных баз данных, чтобы включить ad-hoc-аналитику. Функция эластичных запросов используется для выполнения распределенных запросов, что требует развертывания дополнительной базы данных аналитики (на сервере каталога). С помощью этих запросов можно извлекать сводки, скрытые в текущих операционных данных приложения Wingtip SaaS.


Из этого руководства вы узнаете следующее:

> [!div class="checklist"]

> * сведения о глобальных представлениях в каждой из баз данных, обеспечивающих эффективные запросы ко всем клиентам;
> * как развертывать базу данных ad-hoc-аналитики;
> * как выполнять распределенные запросы по всем клиентским базам данных.



Для работы с этим руководством выполните следующие предварительные требования:

* Разверните приложение SaaS Wingtip. Чтобы развернуть его менее чем за пять минут, см. сведения в статье [Развертывание и изучение мультитенантного приложения SaaS, использующего базу данных SQL Azure](sql-database-saas-tutorial.md).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).
* Установите SQL Server Management Studio (SSMS). Сведения о том, как скачать и установить SSMS, см. в статье [Скачивание SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).


## <a name="ad-hoc-analytics-pattern"></a>Модель ad-hoc-аналитики

Одной из основных возможностей приложений SaaS является использование огромного числа клиентских данных, хранящихся в облаке. С помощью этих данных можно проанализировать работу и использование приложения. Эти сведения будут полезны при разработке функций, помогут повысить удобство использования, а также обеспечить вложение дополнительных средств в приложения и службы.

Доступ к этим данным получить очень просто, если они содержатся в отдельной мультитенантной базе данных, но не так просто, если они распределены по тысячам масштабируемых баз данных. Одним из подходов является использование [эластичного запроса](sql-database-elastic-query-overview.md), который позволяет выполнять запросы в распределенном наборе баз данных с общей схемой. Эластичный запрос использует отдельную *головную* базу данных, в которой внешние таблицы определены как зеркальные таблицы или представления в распределенных (клиентских) базах данных. Запросы, отправленные к этой головной базе данных, компилируются для создания распределенного плана запроса с частями запроса, которые при необходимости можно принудительно установить в клиентских базах данных. Эластичный запрос использует карту сегментов в базе данных каталога для предоставления расположения клиентских баз данных. При настройке и выполнении запроса используется стандартный язык [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), поддерживающий ad-hoc-запросы из таких инструментов, как Power BI и Excel.

Благодаря распределению запросов между базами данных клиента эластичный запрос позволяет мгновенно получить представление о текущих производственных данных. Тем не менее, так как потенциально эластичный запрос извлекает данные из множества баз данных, задержка при выполнении запроса иногда может быть выше, чем для аналогичных запросов, отправляемых к отдельной мультитенантной базе данных. Чтобы сократить объем возвращаемых данных следует применить проектирование запросов. Как правило, эластичный запрос лучше всего подходит для получения небольших объемов данных в реальном времени, в отличие от часто используемых или сложных аналитических запросов или отчетов. Если запросы не выполняются надлежащим образом, изучите [план выполнения](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan), чтобы узнать, какая часть запроса перемещалась на удаленную базу данных и сколько данных возвращалось. Запросы, требующие сложной аналитической обработки, в некоторых случаях могут обслуживаться лучше, если данные клиента будут извлечены в выделенную базу данных или хранилище данных, оптимизированное для аналитических запросов. Эта схема описана в [руководстве по аналитическим запросам с использованием клиентов](sql-database-saas-tutorial-tenant-analytics.md). 

## <a name="get-the-wingtip-application-scripts"></a>Получение сценариев приложения Wingtip

Скрипты и исходный код приложения SaaS Wingtip доступны в репозитории GitHub [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS). Указания по скачиванию скриптов SaaS Wingtip см. [здесь](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).

## <a name="create-ticket-sales-data"></a>Создание данных о продажах билетов

Чтобы выполнять запросы к более интересному набору данных, создайте данные о продаже билетов, запустив генератор данных билетов.

1. В *интегрированной среде сценариев PowerShell* откройте сценарий …\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1*, а затем задайте следующие значения.
   * **$DemoScenario** = 1, чтобы **приобрести билеты на мероприятия во всех местах проведения**.
2. Нажмите клавишу **F5**, чтобы запустить сценарий и создать данные о продаже билетов. Пока сценарий выполняется, продолжите процедуру, описанную в этом руководстве. Данные билетов запрашиваются в разделе *Выполнение распределенных ad-hoc-запросов*, поэтому дождитесь, пока генератор данных билетов завершит работу.

## <a name="explore-the-global-views"></a>Обзор глобальных представлений

Приложение SaaS Wingtip создано по модели, предусматривающей использование одного клиента для базы данных, поэтому схема базы данных клиента определяется с учетом одного клиента. Сведения для конкретного клиента находятся в одной таблице, *Venue*, в которой всегда есть одна строка. Эта таблица создается как куча, без первичного ключа. Не нужно связывать таблицу *Venue* с другими таблицами в схеме, так как при нормальном использовании вы точно знаете, какому клиенту принадлежат данные.

Тем не менее при выполнении запросов по всем базам данных важно, чтобы эластичный запрос мог рассматривать данные как часть отдельной логической базы данных, сегментированной по клиентам. Чтобы смоделировать такой подход, в базу данных клиента добавлен набор глобальных представлений, которые проецируют идентификатор клиента на каждую из таблиц, к которым выполняются глобальные запросы. Например, представление *VenueEvents* добавляет вычисляемый столбец *VenueId* к столбцам, спроецированным из таблицы *Events*. Определяя внешнюю таблицу в головной базе данных посредством *VenueEvents* (а не базовой таблицы *Events*), эластичный запрос способен перемещать операции соединения в соответствии с *VenueId*, чтобы они могли выполняться параллельно на каждой удаленной базе данных (а не на головной базе данных). Это значительно сокращает объем возвращаемых данных, что приводит к заметному увеличению производительности множества запросов. Данные глобальные представления предварительно созданы во всех базах данных клиента (и в *basetenantdb*).

1. Откройте среду SSMS и подключитесь к серверу [tenants1-&lt;пользователь&gt;](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).
2. Разверните узел **Базы данных**, щелкните **contosoconcerthall** правой кнопкой мыши и выберите **Создать запрос**.
3. Выполните следующие запросы, чтобы увидеть разницу между таблицами одного клиента и глобальными представлениями:

   ```T-SQL
   -- The base Venue table, that has no VenueId associated.
   SELECT * FROM Venue

   -- Notice the plural name 'Venues'. This view projects a VenueId column.
   SELECT * FROM Venues

   -- The base Events table, which has no VenueId column.
   SELECT * FROM Events

   -- This view projects the VenueId retrieved from the Venues table.
   SELECT * FROM VenueEvents
   ```

В этих представлениях значение *VenueId* было вычислено как хэш названия места проведения (Venue), но уникальное значение можно ввести любым другим способом. Аналогичным способом вычисляется в ключ клиента для использования в каталоге.

Вот как можно просмотреть определение представления *Venues*.

1. В **обозревателе объектов** разверните узел **contosoconcethall** > **Представления**:

   ![узел "Представления"](media/sql-database-saas-tutorial-adhoc-analytics/views.png)

2. Щелкните **dbo.Venues** правой кнопкой мыши.
3. Выберите **Создать скрипт для представления** > **Используя CREATE** > **В новом окне редактора запросов**.

Создайте сценарий, используя любые другие представления *Venue*, чтобы увидеть, как они добавляют *VenueId*.

## <a name="deploy-the-database-used-for-ad-hoc-distributed-queries"></a>Развертывание базы данных, используемой для распределенных ad-hoc-запросов

В этом упражнении развертывается база данных *adhocanalytics*. Это головная база данных, которая будет содержать схему, используемую для выполнения запросов по всем базам данных клиента. Эта база данных развертывается на имеющемся сервере каталога, используемом для всех баз данных для управления в данном примере приложения.

1. Откройте в *интегрированной среде сценариев PowerShell* \\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1*, а затем задайте следующие значения:
   * **$DemoScenario** = 2, **Deploy Ad-hoc analytics database**.

2. Нажмите клавишу **F5**, чтобы выполнить скрипт и создать базу данных *adhocanalytics*.

В следующем разделе вы добавите схему в базу данных, чтобы ее можно было использовать для выполнения распределенных запросов.

## <a name="configure-the-database-for-running-distributed-queries"></a>Настройка базы данных для выполнения распределенных запросов

В этом упражнении в базу данных ad-hoc-аналитики добавляется схема (внешний источник данных и определения внешних таблиц), позволяющая выполнять запросы по всем базам данных клиента.

1. Откройте SQL Server Management Studio и подключитесь к базе данных ad-hoc-аналитики, созданной на предыдущем шаге. Имя базы данных — *adhocanalytics*.
2. Откройте файл …\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* в SSMS.
3. Просмотрите этот сценарий SQL и обратите внимание на следующее.

   Эластичный запрос использует учетные данные уровня базы данных для доступа к каждой базе данных клиента. Эти учетные данные должны быть доступны во всех базах данных. Обычно им предоставляются минимальные права, необходимые для включения этих ad-hoc-запросов.

    ![Создание учетных данных](media/sql-database-saas-tutorial-adhoc-analytics/create-credential.png)

   Внешний источник данных, для которого определено использование карты сегментов клиента в базе данных каталога. При использовании этого внешнего источника данных запросы распределяются по всем базам данных, зарегистрированным в каталоге, при выполнении. Так как имена серверов для каждого развертывания отличаются, этот сценарий инициализации получает расположение каталога базы данных, извлекая имя текущего сервера (@@servername), на котором выполняется сценарий.

    ![Создание внешнего источника данных](media/sql-database-saas-tutorial-adhoc-analytics/create-external-data-source.png)

   Внешние таблицы, которые ссылаются на глобальные представления, описаны в предыдущем разделе и определены с помощью параметра **DISTRIBUTION = SHARDED(VenueId)**. Так как каждое значение *VenueId* сопоставляется с отдельной базой данных, это повышает производительность во многих ситуациях, как показано в следующем разделе.

    ![Создание внешних таблиц](media/sql-database-saas-tutorial-adhoc-analytics/external-tables.png)

   Локальная таблица *VenueTypes*, которая создается и заполняется. Эта таблица эталонных данных является общей во всех базах данных клиента, поэтому здесь ее можно представить в качестве локальной таблицы и заполнить общими данными. Для некоторых запросов это может уменьшить объем данных, перемещаемых между базами данных клиента и базой данных *adhocanalytics*.

    ![Создание таблицы](media/sql-database-saas-tutorial-adhoc-analytics/create-table.png)

   В случае добавления ссылочных таблиц таким способом необходимо обновлять схему и данные таблицы при каждом обновлении базы данных клиента.

4. Нажмите клавишу **F5**, чтобы выполнить сценарий и инициализировать базу данных *adhocanalytics*. 

Теперь можно выполнять распределенные запросы и собирать данные аналитики по всем клиентам.

## <a name="run-ad-hoc-distributed-queries"></a>Выполнение распределенных ad-hoc-запросов

Теперь, когда база данных *adhocanalytics* настроена, выполните несколько распределенных запросов. Добавьте план выполнения, чтобы лучше понимать, где происходит обработка запросов. 

При проверке плана выполнения наведите указатель мыши на значки плана, чтобы получить дополнительные сведения. 

Важно отметить, что параметр **DISTRIBUTION = SHARDED(VenueId)**, заданный при определении внешнего источника данных, повышает производительность во многих ситуациях. Так как каждое значение *VenueId* сопоставляется с отдельной базой данных, фильтрацию легко выполнять удаленно, возвращая только те данные, которые необходимы.

1. Откройте в SSMS \\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql*.
2. Убедитесь в наличии подключения к базе данных **adhocanalytics**.
3. В меню **Запрос** выберите **Включить действительный план выполнения**.
4. Выделите запрос *Which venues are currently registered?* и нажмите клавишу **F5**.

   Запрос вернет полный список мест проведения, демонстрируя, как быстро и легко можно выполнить запрос по всем клиентам и вернуть данные из каждого из них.

   Просмотрите план, и вы увидите, что все затраты связаны исключительно с удаленным запросом, так как мы просто перебираем базы данных клиента и выбираем информацию о местах проведения.

   ![SELECT * FROM dbo.Venues](media/sql-database-saas-tutorial-adhoc-analytics/query1-plan.png)

5. Выберите следующий запрос и нажмите клавишу **F5**.

   Этот запрос объединяет данные из баз данных клиента и локальной таблицы *VenueTypes* (она локальная, так как является таблицей базы данных *adhocanalytics*).

   Просмотрите план, и вы увидите, что большая часть затрат связана с удаленным запросом, так как мы запрашиваем информацию о месте проведения каждого клиента (dbo.Venues), а затем быстро выполняем локальное соединение с локальной таблицей *VenueTypes*, чтобы отобразить понятные имена.

   ![Соединение удаленных и локальных данных](media/sql-database-saas-tutorial-adhoc-analytics/query2-plan.png)

6. Теперь выберите запрос *On which day were the most tickets sold?* и нажмите клавишу **F5**.

   Этот запрос выполняет более сложное соединение и агрегирование. Важно отметить, что большая часть обработки выполняется удаленно, и опять же, мы возвращаем только те строки, которые необходимы, получая только одну строку для общего числа проданных билетов за день для каждого места проведения.

   ![query](media/sql-database-saas-tutorial-adhoc-analytics/query3-plan.png)


## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали следующее:

> [!div class="checklist"]

> * как выполнить распределенные запросы по всем клиентским базам данных.
> * как развернуть базу данных ad-hoc-аналитики и добавить в нее схему для выполнения распределенных запросов.


Теперь ознакомьтесь с руководством [Выполнение распределенных запросов в нескольких базах данных SQL Azure](sql-database-saas-tutorial-tenant-analytics.md), чтобы изучить извлечение данных в отдельную базу данных аналитики для более сложной аналитической обработки.

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Руководства по SaaS WTP базы данных SQL](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)
* [Обзор эластичных запросов к базе данных SQL Azure (предварительная версия)](sql-database-elastic-query-overview.md)

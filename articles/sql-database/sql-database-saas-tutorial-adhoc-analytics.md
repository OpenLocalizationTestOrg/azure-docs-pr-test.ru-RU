---
title: "aaaRun ad-hoc аналитические запросы по нескольким базам данных Azure SQL | Документы Microsoft"
description: "Запустите ad-hoc аналитические запросы по нескольким базам данных SQL в приложении несколькими клиентами Wingtip SaaS hello."
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/23/2017
ms.author: billgib; sstein
ms.openlocfilehash: 140cd51fdd03b5a548147282b51ceb0ad80c944d
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="run-ad-hoc-analytics-queries-across-all-wingtip-saas-tenants"></a>Выполнение запросов ad-hoc-аналитики по всем клиентам SaaS Wingtip

В этом учебнике вы выполнять распределенные запросы между hello весь набор баз данных клиента tooenable ad-hoc аналитику. Эластичный запрос является используется tooenable распределенных запросов, которая требует дополнительной аналитики база данных развернута (сервер каталога toohello). Эти запросы можно извлекать аналитики содержатся в hello повседневных рабочих данных приложение Wingtip SaaS hello.


Из этого руководства вы узнаете следующее:

> [!div class="checklist"]

> * О hello глобальные представления в каждой базе данных позволяющие эффективно опрашивать клиентов
> * Как toodeploy базы данных служб аналитики ad-hoc
> * Как toorun распределенные запросы по всем базам данных клиента



toocomplete завершения этого учебника, убедитесь, что hello следующие предварительные требования:

* приложение Wingtip SaaS Hello развертывается. toodeploy менее чем за пять минут. в разделе [развертывание и просмотр приложения Wingtip SaaS hello](sql-database-saas-tutorial.md)
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).
* Установите SQL Server Management Studio (SSMS). toodownload и установки SSMS, в разделе [загрузить SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).


## <a name="ad-hoc-analytics-pattern"></a>Модель ad-hoc-аналитики

Одним из hello значительные возможности с приложениями SaaS является toouse hello огромное количество данных клиента, централизованно хранятся в облаке hello. Используйте этот данных toogain анализировать операции hello и использование приложения, вашим клиентам, их пользователям, параметры, поведений, и т. д. Эти сведения будут полезны при разработке функций, помогут повысить удобство использования, а также обеспечить вложение дополнительных средств в приложения и службы.

Доступ к этим данным получить очень просто, если они содержатся в отдельной мультитенантной базе данных, но не так просто, если они распределены по тысячам масштабируемых баз данных. Одним из подходов является toouse [эластичной запроса](sql-database-elastic-query-overview.md), что обеспечивает выполнение запросов в распределенный набор баз данных с общей схемой. Эластичный запроса используется один *head* базы данных, в котором определены внешние таблицы, зеркальных таблиц или представлений в hello распределенных баз данных (клиента). Запросы отправлен toothis head базы данных являются tooproduce скомпилированный план распределенного запроса с части запроса hello сместить вниз toohello базы данных клиента, при необходимости. Эластичный запрос использует карта сегментов hello в hello каталога базы данных tooprovide hello папку hello базы данных клиента. При настройке и выполнении запроса используется стандартный язык [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), поддерживающий ad-hoc-запросы из таких инструментов, как Power BI и Excel.

Путем распределения запросов между базами данных клиента hello, эластичной запрос предоставляет непосредственное представление о реальных производственных данных. Тем не менее как эластичный запрос извлекает данные из возможного множества баз данных, запросов задержки иногда может быть выше, чем для эквивалентных запросов передавать tooa одной базы данных с несколькими клиентами. При создании запросов toominimize hello данные, возвращаемые следует соблюдать осторожность. Эластичный запрос часто лучше всего подходит для запросов небольших объемов данных в реальном времени, как противоположность toobuilding часто используются сложные аналитические запросы или отчеты. Если также не выполнить запросы, посмотрите hello [план выполнения](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) toosee, какая часть запроса hello переданное вниз toohello удаленной базы данных и о том, сколько данных возвращается. Запросы, требующие сложной аналитической обработки, в некоторых случаях могут обслуживаться лучше, если данные клиента будут извлечены в выделенную базу данных или хранилище данных, оптимизированное для аналитических запросов. Этот шаблон подробно описан hello [учебника аналитика клиента](sql-database-saas-tutorial-tenant-analytics.md). 

## <a name="get-hello-wingtip-application-scripts"></a>Получение скриптов приложения Wingtip hello

Hello Wingtip SaaS скриптов и исходный код приложения были доступны в hello [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) в репозитории github. [Действия скриптов Wingtip SaaS hello toodownload](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).

## <a name="create-ticket-sales-data"></a>Создание данных о продажах билетов

toorun запросов к более интересный набор данных, создайте билет данные о продажах, запустив билет генератор hello.

1. В hello *интегрированной среды Сценариев PowerShell*откройте hello... \\Модулей обучения\\оперативной аналитики\\Adhoc Analytics\\*AdhocAnalytics.ps1 Демонстрация* сценариев и задайте следующие значения hello:
   * **$DemoScenario** = 1, чтобы **приобрести билеты на мероприятия во всех местах проведения**.
2. Нажмите клавишу **F5** запустить сценарий hello и создать билет продаж. Пока выполняется скрипт hello, выполните шаги hello в этом учебнике. данные билета Hello запрашивается в hello *выполнение нерегламентированных распределенных запросов* статьи, таким образом дождитесь toocomplete генератор hello билет, если по-прежнему выполняется при получении toothat упражнения.

## <a name="explore-hello-global-views"></a>Просмотр hello глобальные представления

Hello приложения Wingtip SaaS построена на основе модели клиента на основе баз данных, поэтому схема базы данных клиента hello определяется с точки зрения одного клиента. Сведения для конкретного клиента находятся в одной таблице, *Venue*, в которой всегда есть одна строка. Эта таблица создается как куча, без первичного ключа. Другие таблицы в схеме hello не нужен toobe связанные toohello *проведения* таблицы, так как при нормальном использовании никогда нет каких-либо сомнений, какие данные клиента hello принадлежит.

Тем не менее при выполнении запросов по всем базам данных, очень важно, что эластичной запроса можно считать, hello данных входит в состав одной логической базы данных сегментированной клиентом. tooachieve это набор представлений «global» будут добавлены toohello базы данных клиента, проекцию ИД клиента в каждой из таблиц hello, запрашиваемых глобально. Здравствуйте, например, *VenueEvents* представление добавляет вычисляемый *VenueId* спроецировано toohello столбцы из hello *события* таблицы. Определив hello внешней таблицы в базе данных головного hello через *VenueEvents* (вместо базового hello *событий* таблицы), эластичной запрос является может toopush работу соединений, основанных на *VenueId* , они могут выполняться параллельно для каждой удаленной базы данных (а не в базе данных головного hello). Это значительно сокращает hello объем данных, возвращаемых, что приводит к значительное увеличение производительности для нескольких запросов. Данные глобальные представления предварительно созданы во всех базах данных клиента (и в *basetenantdb*).

1. Откройте SSMS и [connect toohello tenants1 -&lt;пользователя&gt; сервера](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).
2. Разверните узел **Базы данных**, щелкните **contosoconcerthall** правой кнопкой мыши и выберите **Создать запрос**.
3. Выполните следующие запросы tooexplore hello разность hello одного клиента таблиц и представлений глобального hello hello.

   ```T-SQL
   -- hello base Venue table, that has no VenueId associated.
   SELECT * FROM Venue

   -- Notice hello plural name 'Venues'. This view projects a VenueId column.
   SELECT * FROM Venues

   -- hello base Events table, which has no VenueId column.
   SELECT * FROM Events

   -- This view projects hello VenueId retrieved from hello Venues table.
   SELECT * FROM VenueEvents
   ```

В этих представлениях hello *VenueId* вычисляется как хэш hello проведения имя, но любой подход может быть используется toointroduce уникальное значение. Этот подход является сходным образом toohello ключ клиента hello вычисляется для использования в каталоге hello.

Определение hello tooexamine hello *местоположения* представления:

1. В **обозревателе объектов** разверните узел **contosoconcethall** > **Представления**:

   ![узел "Представления"](media/sql-database-saas-tutorial-adhoc-analytics/views.png)

2. Щелкните **dbo.Venues** правой кнопкой мыши.
3. Выберите **Создать скрипт для представления** > **Используя CREATE** > **В новом окне редактора запросов**.

Скрипт, любой из других hello *проведения* представления toosee как добавляют hello *VenueId*.

## <a name="deploy-hello-database-used-for-ad-hoc-distributed-queries"></a>Развертывание базы данных hello, используемой для нерегламентированных распределенных запросов

В этом упражнении развертывает hello *adhocanalytics* базы данных. Это hello головного базы данных, который будет содержать hello схемы, используемой для выполнения запросов по всем базам данных клиента. База данных Hello — развернутой toohello существующий сервер каталога, который hello сервера, используемого для всех связанных с управлением баз данных в пример приложения hello.

1. Открыть... \\Модулей обучения\\оперативной аналитики\\Adhoc Analytics\\*Демонстрация AdhocAnalytics.ps1* в hello *интегрированной среды Сценариев PowerShell* и набор hello следующие значения:
   * **$DemoScenario** = 2, **Deploy Ad-hoc analytics database**.

2. Нажмите клавишу **F5** toorun hello скрипт и создать hello *adhocanalytics* базы данных.

В следующем разделе hello добавьте базу данных toohello схемы, его можно использовать toorun распределенных запросов.

## <a name="configure-hello-database-for-running-distributed-queries"></a>Настройка hello базы данных для выполнения распределенных запросов

В этом упражнении добавляет базу данных аналитики схемой (hello внешнего источника данных и определения внешних таблиц) toohello ad-hoc, позволяющее выполнять запросы по всем базам данных клиента.

1. Откройте SQL Server Management Studio и подключитесь toohello нерегламентированного анализа базы данных, созданный на предыдущем шаге hello. Hello hello база данных будет называться adhocanalytics.
2. Откройте файл …\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* в SSMS.
3. Просмотреть скрипт SQL hello и обратите внимание hello следующее:

   Эластичный запрос с помощью учетных данных области базы данных tooaccess каждой из баз данных клиента hello. Эти учетные данные должен toobe доступны во всех базах данных hello и обычно должны предоставляться hello минимальные права, необходимые tooenable эти нерегламентированные запросы.

    ![Создание учетных данных](media/sql-database-saas-tutorial-adhoc-analytics/create-credential.png)

   Hello определить внешний источник данных, карта сегментов toouse hello клиента в базе данных каталога hello. С помощью этого как hello внешнему источнику данных, запросы, tooall распределенной базы данных, зарегистрированные в каталоге hello, при выполнении запроса hello. Так как имена серверов различны для каждого развертывания, этот сценарий инициализации получает hello расположение базы данных каталога hello, получая текущего сервера hello (@@servername) которой выполняется сценарий hello.

    ![Создание внешнего источника данных](media/sql-database-saas-tutorial-adhoc-analytics/create-external-data-source.png)

   Здравствуйте, внешней таблицы, которые ссылаются hello глобальные представления описано в предыдущем разделе hello и определенного с **РАСПРОСТРАНЕНИЯ = SHARDED(VenueId)**. Поскольку каждый *VenueId* tooa отдельную базу данных сопоставляет это повышает производительность для многих сценариев, как показано в следующем разделе hello.

    ![Создание внешних таблиц](media/sql-database-saas-tutorial-adhoc-analytics/external-tables.png)

   Hello локальной таблицы *VenueTypes* , создается и заполняется. Эту ссылочную таблицу данных проявляется во всех базах данных клиента, поэтому он может быть представлен здесь в качестве локальной таблицы и заполненная hello общих данных. Для некоторых запросов hello, это может снизить объем данных перемещать между базами данных клиента hello и hello *adhocanalytics* базы данных.

    ![Создание таблицы](media/sql-database-saas-tutorial-adhoc-analytics/create-table.png)

   Если ссылочные таблицы таким образом, следует убедиться, что tooupdate hello схемы и данных таблицы, при каждом обновлении базы данных клиента hello.

4. Нажмите клавишу **F5** toorun hello сценариев и инициализации hello *adhocanalytics* базы данных. 

Теперь можно выполнять распределенные запросы и собирать данные аналитики по всем клиентам.

## <a name="run-ad-hoc-distributed-queries"></a>Выполнение распределенных ad-hoc-запросов

Теперь этот hello *adhocanalytics* база данных не установлено, загрузив и выполните несколько распределенных запросов. Включить hello план выполнения для лучшего понимания того, где происходит обработка запросов hello. 

При проверке плана выполнения hello, наведите курсор на значки плана hello подробные сведения. 

Этот параметр является важным toonote **РАСПРОСТРАНЕНИЯ = SHARDED(VenueId)** при определении hello внешнего источника данных, повышает производительность для многих сценариев. Так как каждый *VenueId* сопоставляет tooa отдельную базу данных фильтрации является данных легко выполняется удаленно, возвращающий только hello, нам нужно.

1. Откройте в SSMS \\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql*.
2. Убедитесь, подключенных toohello **adhocanalytics** базы данных.
3. Выберите hello **запроса** меню и выберите пункт **Включить действительный план выполнения**
4. Выделите hello *какие местоположения в настоящее время зарегистрированы?* запрос и нажмите клавишу **F5**.

   Hello запрос возвращает список всего проведения hello, демонстрирующая способ быстрого и удобное tooquery для всех клиентов и получение данных для каждого клиента.

   Проверять план hello, где затраты на hello hello удаленного запроса, так как мы просто базы данных клиента tooeach переход и выбор информации место проведения hello.

   ![SELECT * FROM dbo.Venues](media/sql-database-saas-tutorial-adhoc-analytics/query1-plan.png)

5. Следующий запрос SELECT hello и нажмите клавишу **F5**.

   Этот запрос объединяет данные из базы данных клиента hello и локальный hello *VenueTypes* таблицы (локально, как оно является таблицей в hello *adhocanalytics* базы данных).

   Проверять план hello и разделе hello, большая часть стоимости является hello удаленного запроса, так как мы запрос информации место проведения каждого клиента (dbo. Местоположения), а затем выполните быстрый локального соединения с локальным hello *VenueTypes* понятное имя таблицы toodisplay hello.

   ![Соединение удаленных и локальных данных](media/sql-database-saas-tutorial-adhoc-analytics/query2-plan.png)

6. Теперь выберите hello *на какой день были hello большинство билеты проданных?* запрос и нажмите клавишу **F5**.

   Этот запрос выполняет более сложное соединение и агрегирование. Важным toonote является большая часть обработки hello выполняется удаленно, что опять же, мы вернуть только строки hello нужные нам, возвращая только одну строку для каждого проведения статистические билет продажи числа в день.

   ![query](media/sql-database-saas-tutorial-adhoc-analytics/query3-plan.png)


## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали следующее:

> [!div class="checklist"]

> * как выполнить распределенные запросы по всем клиентским базам данных.
> * Развертывание базы данных служб аналитики ad-hoc и добавление схемы tooit toorun распределенных запросов.


Теперь попробуйте hello [аналитика клиента учебника](sql-database-saas-tutorial-tenant-analytics.md) tooexplore извлечение данных базы данных отдельных analytics tooa для более сложную обработку analytics...

## <a name="additional-resources"></a>Дополнительные ресурсы

* Дополнительные [учебники, которые созданы на основе Wingtip SaaS приложения hello](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)
* [Обзор эластичных запросов к базе данных SQL Azure (предварительная версия)](sql-database-elastic-query-overview.md)

---
title: "Управление хранилищем запросов в базе данных SQL Azure"
description: "Узнайте, как управлять хранилищем запросов в базе данных SQL Azure"
keywords: 
services: sql-database
documentationcenter: 
author: bonova
manager: jhubbard
editor: 
ms.assetid: 0cccf6bd-1327-44f7-a6f9-8eff0c210463
ms.service: sql-database
ms.custom: monitor & tune
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: sqldb-performance
ms.workload: data-management
ms.date: 11/08/2016
ms.author: bonova
ms.openlocfilehash: 4e13f265c32037abdba67a68ca5be81e167c01e4
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="operating-the-query-store-in-azure-sql-database"></a><span data-ttu-id="b5b9f-103">Управление хранилищем запросов в базе данных SQL Azure</span><span class="sxs-lookup"><span data-stu-id="b5b9f-103">Operating the Query Store in Azure SQL Database</span></span>
<span data-ttu-id="b5b9f-104">Хранилище запросов в Azure является полностью управляемой службой базы данных, которая непрерывно собирает и предоставляет подробные статистические сведения обо всех запросах.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-104">Query Store in Azure is a fully managed database feature that continuously collects and presents detailed historic information about all queries.</span></span> <span data-ttu-id="b5b9f-105">Хранилище запросов можно рассматривать как аналог бортового самописца, который значительно упрощает устранение проблем, отражающихся на производительности запросов, для клиентов в облаке и в локальной среде.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-105">You can think about Query Store as similar to an airplane's flight data recorder that significantly simplifies query performance troubleshooting both for cloud and on-premises customers.</span></span> <span data-ttu-id="b5b9f-106">В этой статье объясняются некоторые аспекты управления хранилищем запросов в Azure.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-106">This article explains specific aspects of operating Query Store in Azure.</span></span> <span data-ttu-id="b5b9f-107">С помощью предварительно собранных данных о запросах можно быстро диагностировать и устранять проблемы с производительностью, что позволяет уделять больше времени основным рабочим задачам.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-107">Using this pre-collected query data, you can quickly diagnose and resolve performance problems and thus spend more time focusing on their business.</span></span> 

<span data-ttu-id="b5b9f-108">Хранилище запросов [глобально доступно](https://azure.microsoft.com/updates/general-availability-azure-sql-database-query-store/) в базе данных SQL Azure с ноября 2015 г.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-108">Query Store has been [globally available](https://azure.microsoft.com/updates/general-availability-azure-sql-database-query-store/) in Azure SQL Database since November, 2015.</span></span> <span data-ttu-id="b5b9f-109">Хранилище запросов является основой для анализа производительности и настройки компонентов, таких как [помощник по настройке базы данных SQL и панель мониторинга производительности](https://azure.microsoft.com/updates/sqldatabaseadvisorga/).</span><span class="sxs-lookup"><span data-stu-id="b5b9f-109">Query Store is the foundation for performance analysis and tuning features, such as [SQL Database Advisor and Performance Dashboard](https://azure.microsoft.com/updates/sqldatabaseadvisorga/).</span></span> <span data-ttu-id="b5b9f-110">На момент публикации этой статьи хранилище запросов работает в более чем 200 000 пользовательских баз данных в Azure, безостановочно собирая информацию о запросах за несколько месяцев.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-110">At the moment of publishing this article, Query Store is running in more than 200,000 user databases in Azure, collecting query-related information for several months, without interruption.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="b5b9f-111">Корпорация Майкрософт работает над тем, чтобы хранилище запросов стало доступно для всех баз данных SQL Azure (как существующих, так и новых).</span><span class="sxs-lookup"><span data-stu-id="b5b9f-111">Microsoft is in the process of activating Query Store for all Azure SQL databases (existing and new).</span></span> 
> 
> 

## <a name="optimal-query-store-configuration"></a><span data-ttu-id="b5b9f-112">Оптимальная конфигурация хранилища запросов</span><span class="sxs-lookup"><span data-stu-id="b5b9f-112">Optimal Query Store Configuration</span></span>
<span data-ttu-id="b5b9f-113">В этом разделе описываются оптимальные настройки по умолчанию, призванные обеспечить надежную работу хранилища запросов и зависимых компонентов, таких как [помощник по базам данных SQL Azure и панель мониторинга производительности](https://azure.microsoft.com/updates/sqldatabaseadvisorga/).</span><span class="sxs-lookup"><span data-stu-id="b5b9f-113">This section describes optimal configuration defaults that are designed to ensure reliable operation of the Query Store and dependent features, such as [SQL Database Advisor and Performance Dashboard](https://azure.microsoft.com/updates/sqldatabaseadvisorga/).</span></span> <span data-ttu-id="b5b9f-114">По умолчанию конфигурация оптимизирована для постоянного сбора данных, т. е. для минимальной продолжительности состояний "Отключено" и "Только для чтения".</span><span class="sxs-lookup"><span data-stu-id="b5b9f-114">Default configuration is optimized for continuous data collection, that is minimal time spent in OFF/READ_ONLY states.</span></span>

| <span data-ttu-id="b5b9f-115">Конфигурация</span><span class="sxs-lookup"><span data-stu-id="b5b9f-115">Configuration</span></span> | <span data-ttu-id="b5b9f-116">Description (Описание)</span><span class="sxs-lookup"><span data-stu-id="b5b9f-116">Description</span></span> | <span data-ttu-id="b5b9f-117">значение по умолчанию</span><span class="sxs-lookup"><span data-stu-id="b5b9f-117">Default</span></span> | <span data-ttu-id="b5b9f-118">Комментарий</span><span class="sxs-lookup"><span data-stu-id="b5b9f-118">Comment</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="b5b9f-119">MAX_STORAGE_SIZE_MB</span><span class="sxs-lookup"><span data-stu-id="b5b9f-119">MAX_STORAGE_SIZE_MB</span></span> |<span data-ttu-id="b5b9f-120">Предельный размер пространства данных, которое хранилище запросов использует в базе данных клиента.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-120">Specifies the limit for the data space that Query Store can take inside z customer database</span></span> |<span data-ttu-id="b5b9f-121">100</span><span class="sxs-lookup"><span data-stu-id="b5b9f-121">100</span></span> |<span data-ttu-id="b5b9f-122">Принудительно для новых баз данных</span><span class="sxs-lookup"><span data-stu-id="b5b9f-122">Enforced for new databases</span></span> |
| <span data-ttu-id="b5b9f-123">INTERVAL_LENGTH_MINUTES</span><span class="sxs-lookup"><span data-stu-id="b5b9f-123">INTERVAL_LENGTH_MINUTES</span></span> |<span data-ttu-id="b5b9f-124">Определяет время, в течение которого объединяются и сохраняются собранные статистические данные среды выполнения по планам запросов.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-124">Defines size of time window during which collected runtime statistics for query plans are aggregated and persisted.</span></span> <span data-ttu-id="b5b9f-125">Для каждого активного плана запроса в течение периода, заданного в этом параметре, будет сохраняться только одна строка.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-125">Every active query plan has at most one row for a period of time defined with this configuration</span></span> |<span data-ttu-id="b5b9f-126">60</span><span class="sxs-lookup"><span data-stu-id="b5b9f-126">60</span></span> |<span data-ttu-id="b5b9f-127">Принудительно для новых баз данных</span><span class="sxs-lookup"><span data-stu-id="b5b9f-127">Enforced for new databases</span></span> |
| <span data-ttu-id="b5b9f-128">STALE_QUERY_THRESHOLD_DAYS</span><span class="sxs-lookup"><span data-stu-id="b5b9f-128">STALE_QUERY_THRESHOLD_DAYS</span></span> |<span data-ttu-id="b5b9f-129">Политика очистки на основе времени, которая контролирует срок хранения статистики для среды выполнения и неактивных запросов.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-129">Time-based cleanup policy that controls the retention period of persisted runtime statistics and inactive queries</span></span> |<span data-ttu-id="b5b9f-130">30</span><span class="sxs-lookup"><span data-stu-id="b5b9f-130">30</span></span> |<span data-ttu-id="b5b9f-131">Принудительно для новых баз данных и баз данных с предыдущим значением по умолчанию (367)</span><span class="sxs-lookup"><span data-stu-id="b5b9f-131">Enforced for new databases and databases with previous default (367)</span></span> |
| <span data-ttu-id="b5b9f-132">SIZE_BASED_CLEANUP_MODE</span><span class="sxs-lookup"><span data-stu-id="b5b9f-132">SIZE_BASED_CLEANUP_MODE</span></span> |<span data-ttu-id="b5b9f-133">Указывает, нужно ли выполнять автоматическую очистку данных при приближении к предельному значению, установленному для размера данных хранилища запросов.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-133">Specifies whether automatic data cleanup takes place when Query Store data size approaches the limit</span></span> |<span data-ttu-id="b5b9f-134">AUTO (АВТОМАТИЧЕСКИ)</span><span class="sxs-lookup"><span data-stu-id="b5b9f-134">AUTO</span></span> |<span data-ttu-id="b5b9f-135">Принудительно для всех баз данных</span><span class="sxs-lookup"><span data-stu-id="b5b9f-135">Enforced for all databases</span></span> |
| <span data-ttu-id="b5b9f-136">QUERY_CAPTURE_MODE</span><span class="sxs-lookup"><span data-stu-id="b5b9f-136">QUERY_CAPTURE_MODE</span></span> |<span data-ttu-id="b5b9f-137">Указывает, следует ли отслеживать все запросы или только определенное подмножество.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-137">Specifies whether all queries or only a subset of queries are tracked</span></span> |<span data-ttu-id="b5b9f-138">AUTO (АВТОМАТИЧЕСКИ)</span><span class="sxs-lookup"><span data-stu-id="b5b9f-138">AUTO</span></span> |<span data-ttu-id="b5b9f-139">Принудительно для всех баз данных</span><span class="sxs-lookup"><span data-stu-id="b5b9f-139">Enforced for all databases</span></span> |
| <span data-ttu-id="b5b9f-140">FLUSH_INTERVAL_SECONDS</span><span class="sxs-lookup"><span data-stu-id="b5b9f-140">FLUSH_INTERVAL_SECONDS</span></span> |<span data-ttu-id="b5b9f-141">Указывает максимальный период, в течение которого статистика среды выполнения будет храниться в памяти перед записью на диск.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-141">Specifies maximum period during which captured runtime statistics are kept in memory, before flushing to disk</span></span> |<span data-ttu-id="b5b9f-142">900</span><span class="sxs-lookup"><span data-stu-id="b5b9f-142">900</span></span> |<span data-ttu-id="b5b9f-143">Принудительно для новых баз данных</span><span class="sxs-lookup"><span data-stu-id="b5b9f-143">Enforced for new databases</span></span> |
|  | | | |

> [!IMPORTANT]
> <span data-ttu-id="b5b9f-144">Эти значения по умолчанию будут автоматически применяться на последнем этапе активации хранилища запросов для всех баз данных Azure SQL (см. важное примечание выше).</span><span class="sxs-lookup"><span data-stu-id="b5b9f-144">These defaults are automatically applied in the final stage of Query Store activation in all Azure SQL databases (see preceding important note).</span></span> <span data-ttu-id="b5b9f-145">После этого база данных SQL Azure не будет изменять значения настроек, заданные пользователями, за исключением случаев негативного влияния на основную рабочую нагрузку или на надежность работы хранилища запросов.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-145">After this light up, Azure SQL Database won’t be changing configuration values set by customers, unless they negatively impact primary workload or reliable operations of the Query Store.</span></span>
> 
> 

<span data-ttu-id="b5b9f-146">Если вы хотите сохранить свои пользовательские настройки, используйте [параметры ALTER DATABASE для хранилища запросов](https://msdn.microsoft.com/library/bb522682.aspx) , чтобы восстановить предыдущее состояние конфигурации.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-146">If you want to stay with your custom settings, use [ALTER DATABASE with Query Store options](https://msdn.microsoft.com/library/bb522682.aspx) to revert configuration to the previous state.</span></span> <span data-ttu-id="b5b9f-147">Изучите [рекомендации по использованию хранилища запросов](https://msdn.microsoft.com/library/mt604821.aspx) , чтобы научиться правильно выбирать оптимальные параметры конфигурации.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-147">Check out [Best Practices with the Query Store](https://msdn.microsoft.com/library/mt604821.aspx) in order to learn how top chose optimal configuration parameters.</span></span>

## <a name="next-steps"></a><span data-ttu-id="b5b9f-148">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="b5b9f-148">Next steps</span></span>
[<span data-ttu-id="b5b9f-149">Анализ производительности базы данных SQL</span><span class="sxs-lookup"><span data-stu-id="b5b9f-149">SQL Database Performance Insight</span></span>](sql-database-performance.md)

## <a name="additional-resources"></a><span data-ttu-id="b5b9f-150">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="b5b9f-150">Additional resources</span></span>
<span data-ttu-id="b5b9f-151">Дополнительные сведения вы найдете в следующих статьях.</span><span class="sxs-lookup"><span data-stu-id="b5b9f-151">For more information check out the following articles:</span></span>

* [<span data-ttu-id="b5b9f-152">Query Store: A flight data recorder for your database (Хранилище запросов: "бортовой самописец" для вашей базы данных)</span><span class="sxs-lookup"><span data-stu-id="b5b9f-152">A flight data recorder for your database</span></span>](https://azure.microsoft.com/blog/query-store-a-flight-data-recorder-for-your-database) 
* [<span data-ttu-id="b5b9f-153">Мониторинг производительности с использованием хранилища запросов</span><span class="sxs-lookup"><span data-stu-id="b5b9f-153">Monitoring Performance By Using the Query Store</span></span>](https://msdn.microsoft.com/library/dn817826.aspx)
* [<span data-ttu-id="b5b9f-154">Query Store Usage Scenarios (Сценарии использования хранилища запросов)</span><span class="sxs-lookup"><span data-stu-id="b5b9f-154">Query Store Usage Scenarios</span></span>](https://msdn.microsoft.com/library/mt614796.aspx)
* [<span data-ttu-id="b5b9f-155">Мониторинг производительности с использованием хранилища запросов</span><span class="sxs-lookup"><span data-stu-id="b5b9f-155">Monitoring Performance By Using the Query Store</span></span>](https://msdn.microsoft.com/library/dn817826.aspx) 


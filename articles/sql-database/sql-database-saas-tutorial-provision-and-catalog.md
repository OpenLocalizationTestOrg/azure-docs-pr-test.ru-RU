---
title: "Подготовка новых клиентов в мультитенантном приложении, использующем базу данных SQL Azure | Документация Майкрософт"
description: "Узнайте, как подготовить и каталогизировать новые клиенты в приложении SaaS Wingtip."
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/11/2017
ms.author: sstein
ms.openlocfilehash: 8fa4c4f95386a92c8c818eef1a5b4de5a086fe07
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="provision-new-tenants-and-register-them-in-the-catalog"></a><span data-ttu-id="45def-104">Подготовка новых клиентов и их регистрация в каталоге</span><span class="sxs-lookup"><span data-stu-id="45def-104">Provision new tenants and register them in the catalog</span></span>

<span data-ttu-id="45def-105">Из этого руководства вы узнаете о шаблонах SaaS для подготовки и каталогизации, а также об их реализации в приложении Wingtip SaaS.</span><span class="sxs-lookup"><span data-stu-id="45def-105">In this tutorial, you learn about the provision and catalog SaaS patterns, and how they are implemented in the Wingtip SaaS application.</span></span> <span data-ttu-id="45def-106">Мы создадим и инициализируем базы данных клиента, а также зарегистрируем их в каталоге приложения клиента.</span><span class="sxs-lookup"><span data-stu-id="45def-106">You create and initialize new tenant databases, and register them in the application’s tenant catalog.</span></span> <span data-ttu-id="45def-107">Каталог — это база данных, поддерживающая сопоставление между разными клиентами приложений SaaS и их данными.</span><span class="sxs-lookup"><span data-stu-id="45def-107">The catalog is a database that maintains the mapping between the SaaS application's many tenants and their data.</span></span> <span data-ttu-id="45def-108">Каталог играет важную роль в направлении запросов приложения к правильным базам данных.</span><span class="sxs-lookup"><span data-stu-id="45def-108">The catalog plays an important role directing application requests to the correct database.</span></span>  

<span data-ttu-id="45def-109">Из этого руководства вы узнаете, как выполнять такие задачи:</span><span class="sxs-lookup"><span data-stu-id="45def-109">In this tutorial, you learn how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="45def-110">Подготовка и пошаговая реализация отдельного нового клиента.</span><span class="sxs-lookup"><span data-stu-id="45def-110">Provision a single new tenant, including stepping through how this is implemented</span></span>
> * <span data-ttu-id="45def-111">Подготовка пакета дополнительных клиентов.</span><span class="sxs-lookup"><span data-stu-id="45def-111">Provision a batch of additional tenants</span></span>


<span data-ttu-id="45def-112">Для работы с этим руководством выполните следующие предварительные требования:</span><span class="sxs-lookup"><span data-stu-id="45def-112">To complete this tutorial, make sure the following prerequisites are completed:</span></span>

* <span data-ttu-id="45def-113">Разверните приложение SaaS Wingtip.</span><span class="sxs-lookup"><span data-stu-id="45def-113">The Wingtip SaaS app is deployed.</span></span> <span data-ttu-id="45def-114">Чтобы развернуть его менее чем за пять минут, см. сведения в статье [Развертывание и изучение мультитенантного приложения SaaS, использующего базу данных SQL Azure](sql-database-saas-tutorial.md).</span><span class="sxs-lookup"><span data-stu-id="45def-114">To deploy in less than five minutes, see [Deploy and explore the Wingtip SaaS application](sql-database-saas-tutorial.md)</span></span>
* <span data-ttu-id="45def-115">Установите Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="45def-115">Azure PowerShell is installed.</span></span> <span data-ttu-id="45def-116">Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).</span><span class="sxs-lookup"><span data-stu-id="45def-116">For details, see [Getting started with Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span></span>

## <a name="introduction-to-the-saas-catalog-pattern"></a><span data-ttu-id="45def-117">Общие сведения о шаблоне каталога SaaS</span><span class="sxs-lookup"><span data-stu-id="45def-117">Introduction to the SaaS Catalog pattern</span></span>

<span data-ttu-id="45def-118">В мультитенантном приложении SaaS на основе базы данных важно знать, где хранятся сведения для каждого клиента.</span><span class="sxs-lookup"><span data-stu-id="45def-118">In a database-backed multi-tenant SaaS application, it's important to know where information for each tenant is stored.</span></span> <span data-ttu-id="45def-119">В шаблоне каталога SaaS база данных используется для поддержки сопоставления между клиентами и хранения их данных.</span><span class="sxs-lookup"><span data-stu-id="45def-119">In the SaaS catalog pattern, a catalog database is used to hold the mapping between each tenant and where their data is stored.</span></span> <span data-ttu-id="45def-120">Приложение SaaS Wingtip использует архитектуру базы данных с одним клиентом, но базовый шаблон (хранение сопоставления клиента с базой данных в каталоге) применяется при использовании базы данных с несколькими или с одним клиентом.</span><span class="sxs-lookup"><span data-stu-id="45def-120">The Wingtip SaaS app uses a single-tenant per database architecture, but the basic pattern of storing tenant-to-database mapping in a catalog applies whether a multi-tenant or single-tenant database is used.</span></span>

<span data-ttu-id="45def-121">Каждому клиенту присваивается ключ, идентифицирующий его в каталоге и сопоставленный с расположением соответствующей базы данных.</span><span class="sxs-lookup"><span data-stu-id="45def-121">Each tenant is assigned a key that identifies them in the catalog and which is mapped to the location of the appropriate database.</span></span> <span data-ttu-id="45def-122">В приложении SaaS Wingtip ключ формируется из хэша имени клиента.</span><span class="sxs-lookup"><span data-stu-id="45def-122">In the Wingtip SaaS app, the key is formed from a hash of the tenant’s name.</span></span> <span data-ttu-id="45def-123">Это позволяет использовать часть имени клиента, представляющую URL-адрес приложения, для создания ключа.</span><span class="sxs-lookup"><span data-stu-id="45def-123">This allows the tenant name portion of the application URL to be used to construct the key.</span></span> <span data-ttu-id="45def-124">Можно использовать и другие схемы ключа клиента.</span><span class="sxs-lookup"><span data-stu-id="45def-124">Other tenant key schemes could be used.</span></span>  

<span data-ttu-id="45def-125">Каталог позволяет изменять имя или расположение базы данных с минимальным воздействием на приложение.</span><span class="sxs-lookup"><span data-stu-id="45def-125">The catalog allows the name or location of the database to be changed with minimal impact on the application.</span></span>  <span data-ttu-id="45def-126">В мультитенантной модели базы данных это также обеспечивает перемещение клиента между базами данных.</span><span class="sxs-lookup"><span data-stu-id="45def-126">In a multi-tenant database model, this also accommodates ‘moving’ a tenant between databases.</span></span>  <span data-ttu-id="45def-127">Кроме того, каталог можно использовать, чтобы указать, находится ли клиент или база данных в автономном режиме для обслуживания или других действий.</span><span class="sxs-lookup"><span data-stu-id="45def-127">The catalog can also be used to indicate whether a tenant or database is offline for maintenance or other actions.</span></span> <span data-ttu-id="45def-128">Это рассматривается в руководстве [Восстановление базы данных SQL клиентов SaaS Wingtip](sql-database-saas-tutorial-restore-single-tenant.md).</span><span class="sxs-lookup"><span data-stu-id="45def-128">This is explored in the [restore single tenant tutorial](sql-database-saas-tutorial-restore-single-tenant.md).</span></span>

<span data-ttu-id="45def-129">Кроме того, в каталоге, который, по сути, является базой данных управления для приложения SaaS, можно сохранить дополнительные метаданные клиента или базы данных. Например, сведения об уровне или выпуске базы данных, версии схемы, плане обслуживания, а также соглашения об уровне обслуживания, доступные для клиентов, и другую информацию, которая позволяет осуществлять управление приложениями, поддержку пользователей или процессы DevOps.</span><span class="sxs-lookup"><span data-stu-id="45def-129">In addition, the catalog, which is in effect a management database for a SaaS application, can store additional tenant or database metadata, such as the tier or edition of a database, schema version, service plan, or SLAs offered to tenants, and other info that enables application management, customer support, or devops processes.</span></span>  

<span data-ttu-id="45def-130">Помимо функций для приложения SaaS, каталог позволяет включить средства для баз данных.</span><span class="sxs-lookup"><span data-stu-id="45def-130">Beyond the SaaS application, the catalog can enable database tools.</span></span>  <span data-ttu-id="45def-131">В примере каталог Wingtip SaaS используется, чтобы включить обмен запросами между клиентами. Подробнее это описано в руководстве [Выполнение запросов ad-hoc-аналитики по всем клиентам SaaS Wingtip](sql-database-saas-tutorial-adhoc-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="45def-131">In the Wingtip SaaS sample, the catalog is used to enable cross-tenant query, explored in the [ad hoc analytics tutorial](sql-database-saas-tutorial-adhoc-analytics.md).</span></span> <span data-ttu-id="45def-132">Межбазовое управление заданиями рассматривается в руководствах [Управление схемой для нескольких клиентов в приложении SaaS Wingtip](sql-database-saas-tutorial-schema-management.md) и [Извлечение данных из баз данных клиента в базу данных аналитики для автономного анализа](sql-database-saas-tutorial-tenant-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="45def-132">Cross-database job management is explored in the [schema management](sql-database-saas-tutorial-schema-management.md) and [tenant analytics](sql-database-saas-tutorial-tenant-analytics.md) tutorials.</span></span> 

<span data-ttu-id="45def-133">Каталог в приложении Wingtip SaaS реализуется с помощью функций управления сегментами в [клиентской библиотеке эластичной базы данных (EDCL)](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="45def-133">In the Wingtip SaaS app, the catalog is implemented using the Shard Management features of the [Elastic Database Client Library (EDCL)](sql-database-elastic-database-client-library.md).</span></span> <span data-ttu-id="45def-134">EDCL позволяет приложению создавать, администрировать и использовать карту сегментов на основе базы данных.</span><span class="sxs-lookup"><span data-stu-id="45def-134">The EDCL enables an application to create, manage, and use a database-backed shard map.</span></span> <span data-ttu-id="45def-135">Карта содержит список сегментов (баз данных) и обеспечивает сопоставление ключей (клиентов) и баз данных.</span><span class="sxs-lookup"><span data-stu-id="45def-135">A shard map contains a list of shards (databases) and the mapping between keys (tenants) and databases.</span></span>  <span data-ttu-id="45def-136">Функции EDCL можно использовать в приложениях или скриптах PowerShell при подготовке клиента, чтобы создавать записи в карте сегментов, а также в приложениях для эффективного подключения к нужной базе данных.</span><span class="sxs-lookup"><span data-stu-id="45def-136">EDCL functions can be used from applications or PowerShell scripts during tenant provisioning to create the entries in the shard map, and from applications to efficiently connect to the correct database.</span></span> <span data-ttu-id="45def-137">EDCL кэширует сведения о подключении, чтобы уменьшить объем входящего трафика для базы данных каталога и ускорить работу приложения.</span><span class="sxs-lookup"><span data-stu-id="45def-137">EDCL caches connection information to minimize the traffic to the catalog database and speed up the application.</span></span>  

> [!IMPORTANT]
> <span data-ttu-id="45def-138">Данные сопоставления доступны в базе данных каталога. *Не изменяйте их*.</span><span class="sxs-lookup"><span data-stu-id="45def-138">The mapping data is accessible in the catalog database, but *don't edit it*!</span></span> <span data-ttu-id="45def-139">Изменяйте данные сопоставления только с помощью интерфейсов API EDCL.</span><span class="sxs-lookup"><span data-stu-id="45def-139">Edit mapping data using Elastic Database Client Library APIs only.</span></span> <span data-ttu-id="45def-140">Прямые манипуляции с данными сопоставления могут привести к повреждению каталога. Такие операции не поддерживаются.</span><span class="sxs-lookup"><span data-stu-id="45def-140">Directly manipulating the mapping data risks corrupting the catalog and is not supported.</span></span>


## <a name="introduction-to-the-saas-provisioning-pattern"></a><span data-ttu-id="45def-141">Общие сведения о шаблоне подготовки SaaS</span><span class="sxs-lookup"><span data-stu-id="45def-141">Introduction to the SaaS Provisioning pattern</span></span>

<span data-ttu-id="45def-142">Когда в приложении SaaS подключается новый клиент, использующей модель базы данных с одним клиентом, базу данных клиента необходимо подготовить.</span><span class="sxs-lookup"><span data-stu-id="45def-142">When onboarding a new tenant in a SaaS application that uses a single-tenant database model a new tenant database must be provisioned.</span></span>  <span data-ttu-id="45def-143">Она должна быть создана в нужном расположении с настройкой требуемого уровня обслуживания, инициализирована с надлежащей схемой и ссылочными данными, а затем зарегистрирована в каталоге с соответствующим ключом клиента.</span><span class="sxs-lookup"><span data-stu-id="45def-143">It must be created in the appropriate location and service tier, initialized with appropriate schema and reference data, and then registered in the catalog under the appropriate tenant key.</span></span>  

<span data-ttu-id="45def-144">При подготовке базы данных можно использовать разные подходы, включая выполнение скриптов SQL, развертывание BACPAC или копирование шаблона окончательной базы данных.</span><span class="sxs-lookup"><span data-stu-id="45def-144">Different approaches can be used to database provisioning, which could include executing SQL scripts, deploying a bacpac, or copying a 'golden' template database.</span></span>  

<span data-ttu-id="45def-145">Используемый метод подготовки должен охватывать общую стратегию управления схемой, чтобы обеспечить подготовку новых баз по последней схеме.</span><span class="sxs-lookup"><span data-stu-id="45def-145">The provisioning approach you use must be comprehended in your overall schema management strategy, which must ensure that new databases are provisioned with the latest schema.</span></span>  <span data-ttu-id="45def-146">Это описано в руководстве [Управление схемой для нескольких клиентов в приложении SaaS Wingtip](sql-database-saas-tutorial-schema-management.md).</span><span class="sxs-lookup"><span data-stu-id="45def-146">This is explored in the [schema management tutorial](sql-database-saas-tutorial-schema-management.md).</span></span>  

<span data-ttu-id="45def-147">Приложение Wingtip SaaS подготавливает новые клиенты, копируя окончательную базу данных с именем basetenantdb, развернутую на сервере каталога.</span><span class="sxs-lookup"><span data-stu-id="45def-147">The Wingtip SaaS app provisions new tenants by copying a golden database named basetenantdb, deployed on the catalog server.</span></span>  <span data-ttu-id="45def-148">Подготовку можно интегрировать в приложение как часть процесса регистрации, и (или) поддерживать в автономном режиме с помощью скриптов.</span><span class="sxs-lookup"><span data-stu-id="45def-148">Provisioning could be integrated into the application as part of a sign-up experience, and/or supported offline using scripts.</span></span> <span data-ttu-id="45def-149">В этом руководстве рассматривается подготовка с помощью PowerShell.</span><span class="sxs-lookup"><span data-stu-id="45def-149">This tutorial will explore provisioning using PowerShell.</span></span> <span data-ttu-id="45def-150">Скрипты подготовки копируют basetenantdb, чтобы создать новую базу данных клиента в эластичном пуле. Затем она инициализируется с определенными данными клиента и регистрируется в карте сегментов каталога.</span><span class="sxs-lookup"><span data-stu-id="45def-150">The provisioning scripts copy the basetenantdb to create a new tenant database in an elastic pool, then initialize it with tenant-specific info and register it in the catalog shard map.</span></span>  <span data-ttu-id="45def-151">В примере приложения базы данных именуются на основе имени клиента, но это не является критически важным требованием для шаблона — каталог позволяет присвоить базе данных любое имя.+</span><span class="sxs-lookup"><span data-stu-id="45def-151">In the sample app, databases are given names based on the tenant name, but this is not a critical part of the pattern – the use of the catalog allows any name to be assigned to the database.+</span></span> 


## <a name="get-the-wingtip-application-scripts"></a><span data-ttu-id="45def-152">Получение сценариев приложения Wingtip</span><span class="sxs-lookup"><span data-stu-id="45def-152">Get the Wingtip application scripts</span></span>

<span data-ttu-id="45def-153">Скрипты и исходный код приложения SaaS Wingtip доступны в репозитории GitHub [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS).</span><span class="sxs-lookup"><span data-stu-id="45def-153">The Wingtip SaaS scripts and application source code are available in the [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github repo.</span></span> <span data-ttu-id="45def-154">Указания по скачиванию скриптов SaaS Wingtip см. [здесь](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span><span class="sxs-lookup"><span data-stu-id="45def-154">[Steps to download the Wingtip SaaS scripts](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span></span>


## <a name="provision-and-catalog-detailed-walkthrough"></a><span data-ttu-id="45def-155">Подробное пошаговое руководство по подготовке и каталогизации</span><span class="sxs-lookup"><span data-stu-id="45def-155">Provision and catalog detailed walkthrough</span></span>

<span data-ttu-id="45def-156">Чтобы понять, как приложение Wingtip подготавливает новый клиент, добавьте точку останова и ознакомьтесь с пошаговым процессом подготовки клиента:</span><span class="sxs-lookup"><span data-stu-id="45def-156">To understand how the Wingtip application implements new tenant provisioning, add a breakpoint and step through the workflow while provisioning a tenant:</span></span>

1. <span data-ttu-id="45def-157">Откройте файл …\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ и задайте следующие параметры.</span><span class="sxs-lookup"><span data-stu-id="45def-157">Open ...\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ and set the following parameters:</span></span>
   * <span data-ttu-id="45def-158">**$TenantName** — имя нового мероприятия (например, *Bushwillow Blues*).</span><span class="sxs-lookup"><span data-stu-id="45def-158">**$TenantName** = the name of the new venue (for example, *Bushwillow Blues*).</span></span>
   * <span data-ttu-id="45def-159">**$VenueType** — один из предопределенных типов мероприятия: *blues*, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer.</span><span class="sxs-lookup"><span data-stu-id="45def-159">**$VenueType** = one of the pre-defined venue types: *blues*, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer.</span></span>
   * <span data-ttu-id="45def-160">**$DemoScenario** = **1**. Установите значение **1** для *подготовки одного клиента*.</span><span class="sxs-lookup"><span data-stu-id="45def-160">**$DemoScenario** = **1**, Set to **1** to *Provision a single tenant*.</span></span>

1. <span data-ttu-id="45def-161">Добавьте точку останова, поместив курсор в любом месте строки 48, содержащей *New-Tenant \`*, и нажмите клавишу **F9**.</span><span class="sxs-lookup"><span data-stu-id="45def-161">Add a breakpoint by putting your cursor anywhere on line 48, the line that says: *New-Tenant \`*, and press **F9**.</span></span>

   ![точка останова](media/sql-database-saas-tutorial-provision-and-catalog/breakpoint.png)

1. <span data-ttu-id="45def-163">Нажмите клавишу **F5** для запуска сценария.</span><span class="sxs-lookup"><span data-stu-id="45def-163">To run the script press **F5**.</span></span>

1. <span data-ttu-id="45def-164">После остановки выполнения сценария в точке останова нажмите клавишу **F11**, чтобы пошагово выполнить код.</span><span class="sxs-lookup"><span data-stu-id="45def-164">After the script execution stops at the breakpoint, press **F11** to step into the code.</span></span>

   ![точка останова](media/sql-database-saas-tutorial-provision-and-catalog/debug.png)



<span data-ttu-id="45def-166">Отслеживайте выполнение сценария и используйте клавиши **F10** и **F11** (меню **Отладка**), чтобы обойти вызываемые функции или перейти в них по очереди.</span><span class="sxs-lookup"><span data-stu-id="45def-166">Trace the script's execution using the **Debug** menu options - **F10** and **F11** to step over or into the called functions.</span></span> <span data-ttu-id="45def-167">Дополнительные сведения об отладке сценариев PowerShell см. в разделе [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise).</span><span class="sxs-lookup"><span data-stu-id="45def-167">For more information about debugging PowerShell scripts, see [Tips on working with and debugging PowerShell scripts](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise).</span></span>


<span data-ttu-id="45def-168">Ниже приведены не конкретные действия, а описание рабочего процесса отладки сценария.</span><span class="sxs-lookup"><span data-stu-id="45def-168">The following are not steps to explicitly follow, but an explanation of the workflow you step through while debugging the script:</span></span>

1. <span data-ttu-id="45def-169">**Импорт модуля SubscriptionManagement.psm1**, который содержит функции для входа в Azure и выбора рабочей подписки Azure.</span><span class="sxs-lookup"><span data-stu-id="45def-169">**Import the SubscriptionManagement.psm1** module that contains functions for signing in to Azure and selecting the Azure subscription you are working with.</span></span>
1. <span data-ttu-id="45def-170">**Импорт модуля CatalogAndDatabaseManagement.psm1**, предоставляющего каталог и абстракцию на уровне клиента с помощью функций[управления сегментами](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="45def-170">**Import the CatalogAndDatabaseManagement.psm1** module that provides a catalog and tenant-level abstraction over the [Shard Management](sql-database-elastic-scale-shard-map-management.md) functions.</span></span> <span data-ttu-id="45def-171">Это важный модуль, который инкапсулирует большую часть шаблона каталога. Его следует изучить.</span><span class="sxs-lookup"><span data-stu-id="45def-171">This is an important module that encapsulates much of the catalog pattern and is worth exploring.</span></span>
1. <span data-ttu-id="45def-172">**Получение сведений о конфигурации.**</span><span class="sxs-lookup"><span data-stu-id="45def-172">**Get configuration details**.</span></span> <span data-ttu-id="45def-173">Перейдите к Get-Configuration (нажав клавишу F11) и посмотрите, как указывается конфигурация приложения.</span><span class="sxs-lookup"><span data-stu-id="45def-173">Step into Get-Configuration (with F11) and see how the app config is specified.</span></span> <span data-ttu-id="45def-174">Здесь определяются имена ресурсов и другие значения для конкретного приложения, но не изменяйте эти значения, пока вы не изучите скрипты.</span><span class="sxs-lookup"><span data-stu-id="45def-174">Resource names and other app-specific values are defined here, but do not change any of these values until you are familiar with the scripts.</span></span>
1. <span data-ttu-id="45def-175">**Получение объекта каталога.**</span><span class="sxs-lookup"><span data-stu-id="45def-175">**Get the catalog object**.</span></span> <span data-ttu-id="45def-176">Перейдите к функции Get-Catalog, которая составляет и возвращает объект каталога, используемый в скрипте более высокого уровня.</span><span class="sxs-lookup"><span data-stu-id="45def-176">Step into Get-Catalog which composes and returns a catalog object that is used in the higher-level script.</span></span>  <span data-ttu-id="45def-177">При этом используются функции управления сегментами, импортируемые из **AzureShardManagement.psm1**.</span><span class="sxs-lookup"><span data-stu-id="45def-177">This function uses Shard Management functions that are imported from **AzureShardManagement.psm1**.</span></span> <span data-ttu-id="45def-178">Каталог состоит из следующих компонентов:</span><span class="sxs-lookup"><span data-stu-id="45def-178">The catalog object is composed of the following:</span></span>
   * <span data-ttu-id="45def-179">$catalogServerFullyQualifiedName создается с использованием стандартного корня, а также имени пользователя: _catalog-\<пользователь\>.database.windows.net_.</span><span class="sxs-lookup"><span data-stu-id="45def-179">$catalogServerFullyQualifiedName is constructed using the standard stem plus your User name: _catalog-\<user\>.database.windows.net_.</span></span>
   * <span data-ttu-id="45def-180">$catalogDatabaseName извлекается из файла конфигурации: *tenantcatalog*.</span><span class="sxs-lookup"><span data-stu-id="45def-180">$catalogDatabaseName is retrieved from the config: *tenantcatalog*.</span></span>
   * <span data-ttu-id="45def-181">Объект $shardMapManager инициализируется из базы данных каталога.</span><span class="sxs-lookup"><span data-stu-id="45def-181">$shardMapManager object is initialized from the catalog database.</span></span>
   * <span data-ttu-id="45def-182">Объект $shardMap инициализируется из карты сегментов *tenantcatalog* в базе данных каталога.</span><span class="sxs-lookup"><span data-stu-id="45def-182">$shardMap object is initialized from the *tenantcatalog* shard map in the catalog database.</span></span>
   <span data-ttu-id="45def-183">Объект каталога формируется, возвращается и используется в скрипте более высокого уровня.</span><span class="sxs-lookup"><span data-stu-id="45def-183">A catalog object is composed and returned, and used in the higher-level script.</span></span>
1. <span data-ttu-id="45def-184">**Вычисление нового ключа клиента.**</span><span class="sxs-lookup"><span data-stu-id="45def-184">**Calculate the new tenant key**.</span></span> <span data-ttu-id="45def-185">Для создания ключа клиента из имени клиента используется хэш-функция.</span><span class="sxs-lookup"><span data-stu-id="45def-185">A hash function is used to create the tenant key from the tenant name.</span></span>
1. <span data-ttu-id="45def-186">**Проверка наличия ключа клиента.**</span><span class="sxs-lookup"><span data-stu-id="45def-186">**Check if the tenant key already exists**.</span></span> <span data-ttu-id="45def-187">Каталог проверяется, чтобы убедиться, что ключ доступен.</span><span class="sxs-lookup"><span data-stu-id="45def-187">The catalog is checked to ensure the key is available.</span></span>
1. <span data-ttu-id="45def-188">**Подготовка базы данных клиента с помощью New-TenantDatabase.**</span><span class="sxs-lookup"><span data-stu-id="45def-188">**The tenant database is provisioned with New-TenantDatabase.**</span></span> <span data-ttu-id="45def-189">Используйте клавишу **F11**, чтобы перейти к функции и узнать, как база данных подготавливается с помощью [шаблона Azure Resource Manager](../azure-resource-manager/resource-manager-template-walkthrough.md).</span><span class="sxs-lookup"><span data-stu-id="45def-189">Use **F11** to step in and see how the database is provisioned using an [Azure Resource Manager template](../azure-resource-manager/resource-manager-template-walkthrough.md).</span></span>

<span data-ttu-id="45def-190">Имя базы данных создается на основе имени клиента, чтобы было ясно, какие сегменты принадлежит определенному клиенту.</span><span class="sxs-lookup"><span data-stu-id="45def-190">The database name is constructed from the tenant name to make it clear which shard belongs to which tenant.</span></span> <span data-ttu-id="45def-191">(Можно свободно использовать другие стратегии именования баз данных.)+ Шаблон Resource Manager применяется, чтобы создать базу данных клиента в ходе копирования окончательной базы данных (baseTenantDB) на сервер каталога.</span><span class="sxs-lookup"><span data-stu-id="45def-191">(Other strategies for database naming could easily be used.)+ A Resource Manager template is used to create a tenant database by copying a golden database (baseTenantDB) on the catalog server.</span></span> <span data-ttu-id="45def-192">Альтернативный подход заключается в том, чтобы создать пустую базу данных, а затем инициализировать ее, импортировав BACPAC-файл, или выполнить скрипт инициализации из хорошо известного расположения.</span><span class="sxs-lookup"><span data-stu-id="45def-192">An alternative approach could be to create an empty database and then initialize it by importing a bacpac, or to execute an initialization script from a well-known location.</span></span>  

<span data-ttu-id="45def-193">Шаблон Resource Manager находится в папке …\Learning Modules\Common\: *tenantdatabasecopytemplate.json*</span><span class="sxs-lookup"><span data-stu-id="45def-193">The Resource Manager template is in the …\Learning Modules\Common\ folder: *tenantdatabasecopytemplate.json*</span></span>

<span data-ttu-id="45def-194">Созданная база данных клиента **инициализируется с помощью имени мероприятия (клиента) и его типа**.</span><span class="sxs-lookup"><span data-stu-id="45def-194">After the tenant database is created, it is then further **initialized with the venue (tenant) name and the venue type**.</span></span> <span data-ttu-id="45def-195">Также здесь можно выполнить другие действия по инициализации.</span><span class="sxs-lookup"><span data-stu-id="45def-195">Other initialization could also be done here.</span></span>

<span data-ttu-id="45def-196">**База данных клиента регистрируется в каталоге** с использованием функции *Add-TenantDatabaseToCatalog* и ключа клиента.</span><span class="sxs-lookup"><span data-stu-id="45def-196">The **tenant database is registered in the catalog** with *Add-TenantDatabaseToCatalog* using the tenant key.</span></span> <span data-ttu-id="45def-197">Используйте клавишу **F11**, чтобы просмотреть подробные сведения:</span><span class="sxs-lookup"><span data-stu-id="45def-197">Use **F11** to step into the details:</span></span>

* <span data-ttu-id="45def-198">База данных каталога добавляется на карту сегментов (список известных баз данных).</span><span class="sxs-lookup"><span data-stu-id="45def-198">The catalog database is added to the shard map (the list of known databases).</span></span>
* <span data-ttu-id="45def-199">Создается сопоставление, которое связывает значение ключа с сегментом.</span><span class="sxs-lookup"><span data-stu-id="45def-199">The mapping that links the key value to the shard is created.</span></span>
* <span data-ttu-id="45def-200">В таблицу клиентов в каталоге добавляются дополнительные метаданные о клиенте (имя мероприятия).</span><span class="sxs-lookup"><span data-stu-id="45def-200">Additional meta data (the venue's name) about the tenant is added to the Tenants table in the catalog.</span></span>  <span data-ttu-id="45def-201">Таблица клиентов не входит в схему ShardManagement и не устанавливается EDCL.</span><span class="sxs-lookup"><span data-stu-id="45def-201">The Tenants table is not part of the ShardManagement schema and is not installed by the EDCL.</span></span>  <span data-ttu-id="45def-202">В этой таблице показано, как базу данных каталога можно расширить для поддержки дополнительных данных приложения.</span><span class="sxs-lookup"><span data-stu-id="45def-202">This table illustrates how the Catalog database can be extended to support additional application-specific data.</span></span>   


<span data-ttu-id="45def-203">По завершении подготовки возобновляется выполнение исходного скрипта *Demo-ProvisionAndCatalog*, который открывает в браузере страницу **События** для нового клиента:</span><span class="sxs-lookup"><span data-stu-id="45def-203">After provisioning completes, execution returns to the original *Demo-ProvisionAndCatalog* script, which opens the **Events** page for the new tenant in the browser:</span></span>

   ![events](media/sql-database-saas-tutorial-provision-and-catalog/new-tenant.png)


## <a name="provision-a-batch-of-tenants"></a><span data-ttu-id="45def-205">Подготовка пакета клиентов</span><span class="sxs-lookup"><span data-stu-id="45def-205">Provision a batch of tenants</span></span>

<span data-ttu-id="45def-206">В этом упражнении подготавливается пакет из 17 клиентов.</span><span class="sxs-lookup"><span data-stu-id="45def-206">This exercise provisions a batch of 17 tenants.</span></span> <span data-ttu-id="45def-207">Рекомендуется подготовить этот пакет клиентов перед выполнением задач других руководств по SaaS Wingtip, чтобы вы могли работать не только с небольшим количеством баз данных.</span><span class="sxs-lookup"><span data-stu-id="45def-207">It’s recommended you provision this batch of tenants before starting other Wingtip SaaS tutorials, so there's more than just a few databases to work with.</span></span>

1. <span data-ttu-id="45def-208">Откройте файл …\\Learning Modules\\ProvisionAndCatalog\\*Demo-ProvisionAndCatalog.ps1* в *интегрированной среде сценариев PowerShell* и задайте для параметра *$DemoScenario* значение 3.</span><span class="sxs-lookup"><span data-stu-id="45def-208">Open ...\\Learning Modules\\ProvisionAndCatalog\\*Demo-ProvisionAndCatalog.ps1* in the *PowerShell ISE* and change the *$DemoScenario* parameter to 3:</span></span>
   * <span data-ttu-id="45def-209">**$DemoScenario** = **3**. Установите значение **3** для *подготовки пакета клиентов*.</span><span class="sxs-lookup"><span data-stu-id="45def-209">**$DemoScenario** = **3**, change to **3** to *Provision a batch of tenants*.</span></span>
1. <span data-ttu-id="45def-210">Нажмите клавишу **F5** для запуска скрипта.</span><span class="sxs-lookup"><span data-stu-id="45def-210">Press **F5** and run the script.</span></span>

<span data-ttu-id="45def-211">Скрипт подготовит пакет дополнительных клиентов.</span><span class="sxs-lookup"><span data-stu-id="45def-211">The script deploys a batch of additional tenants.</span></span> <span data-ttu-id="45def-212">Он использует [шаблон Azure Resource Manager](../azure-resource-manager/resource-manager-template-walkthrough.md), который управляет пакетом, а затем подготавливает каждую базу данных в связанном шаблоне.</span><span class="sxs-lookup"><span data-stu-id="45def-212">It uses an [Azure Resource Manager template](../azure-resource-manager/resource-manager-template-walkthrough.md) that controls the batch and then delegates provisioning of each database to a linked template.</span></span> <span data-ttu-id="45def-213">При использовании шаблонов таким способом Azure Resource Manager выступает в качестве посредника в процессе подготовки скрипта.</span><span class="sxs-lookup"><span data-stu-id="45def-213">Using templates in this way allows Azure Resource Manager to broker the provisioning process for your script.</span></span> <span data-ttu-id="45def-214">Шаблоны подготавливают базы данных в параллельном режиме, когда это возможно, и выполняют повторные попытки в случае необходимости, чтобы оптимизировать общий процесс.</span><span class="sxs-lookup"><span data-stu-id="45def-214">Templates provision databases in parallel where it can, and handles retries if needed, optimizing the overall process.</span></span> <span data-ttu-id="45def-215">Сценарий является идемпотентным, поэтому, если при его выполнении произойдет сбой или по какой-либо причине он остановится, запустите его еще раз.</span><span class="sxs-lookup"><span data-stu-id="45def-215">The script is idempotent so if it fails or stops for any reason, run it again.</span></span>

### <a name="verify-the-batch-of-tenants-successfully-deployed"></a><span data-ttu-id="45def-216">Проверка успешного развертывания пакета клиентов</span><span class="sxs-lookup"><span data-stu-id="45def-216">Verify the batch of tenants successfully deployed</span></span>

* <span data-ttu-id="45def-217">Откройте сервер *tenants1*, перейдя к списку серверов на [портале Azure](https://portal.azure.com), щелкните **Базы данных SQL** и проверьте пакет из 17 дополнительных баз данных в списке.</span><span class="sxs-lookup"><span data-stu-id="45def-217">Open the *tenants1* server by browsing to your list of servers in the [Azure portal](https://portal.azure.com), click **SQL databases**, and verify the batch of 17 additional databases are now in the list:</span></span>

   ![список баз данных](media/sql-database-saas-tutorial-provision-and-catalog/database-list.png)



## <a name="other-provisioning-patterns"></a><span data-ttu-id="45def-219">Другие шаблоны подготовки</span><span class="sxs-lookup"><span data-stu-id="45def-219">Other provisioning patterns</span></span>

<span data-ttu-id="45def-220">Далее представлены другие шаблоны подготовки, которые не рассматриваются в этом руководстве.</span><span class="sxs-lookup"><span data-stu-id="45def-220">Other provisioning patterns not included in this tutorial include:</span></span>

<span data-ttu-id="45def-221">**Предварительная подготовка баз данных.**</span><span class="sxs-lookup"><span data-stu-id="45def-221">**Pre-provisioning databases.**</span></span> <span data-ttu-id="45def-222">В шаблоне предварительной подготовки учитывается тот факт, что базы данных в эластичном пуле не создают дополнительных затрат.</span><span class="sxs-lookup"><span data-stu-id="45def-222">The pre-provisioning pattern exploits the fact that databases in an elastic pool do not add extra cost.</span></span> <span data-ttu-id="45def-223">Счета выставляются за эластичный пул, а не за базы данных, и простаивающие базы данных не потребляют ресурсы.</span><span class="sxs-lookup"><span data-stu-id="45def-223">Billing is for the elastic pool, not the databases, and idle databases consume no resources.</span></span> <span data-ttu-id="45def-224">Предварительная подготовка баз данных в пуле и их выделение при необходимости может значительно сократить время адаптации клиента.</span><span class="sxs-lookup"><span data-stu-id="45def-224">By pre-provisioning databases in a pool and allocating them when needed, tenant onboarding time can be reduced significantly.</span></span> <span data-ttu-id="45def-225">Количество заранее подготовленных баз данных можно настраивать при необходимости, чтобы обеспечивать готовность буфера к предполагаемой скорости подготовки.</span><span class="sxs-lookup"><span data-stu-id="45def-225">The number of databases pre-provisioned could be adjusted as needed to keep a buffer suitable for the anticipated provisioning rate.</span></span>

<span data-ttu-id="45def-226">**Автоматическая подготовка.**</span><span class="sxs-lookup"><span data-stu-id="45def-226">**Auto-provisioning.**</span></span> <span data-ttu-id="45def-227">В шаблоне автоматической подготовки используется выделенная служба для автоматической подготовки серверов, пулов и баз данных по мере необходимости, включая предварительную подготовку баз данных в эластичных пулах.</span><span class="sxs-lookup"><span data-stu-id="45def-227">In the auto-provisioning pattern, a dedicated provisioning service is used to provision servers, pools, and databases automatically as needed – including pre-provisioning databases in elastic pools if desired.</span></span> <span data-ttu-id="45def-228">При списании и удалении баз данных "пропуски" в эластичных пулах могут заполняться службой подготовки в случае необходимости.</span><span class="sxs-lookup"><span data-stu-id="45def-228">And if databases are de-commissioned and deleted, gaps in elastic pools can be filled by the provisioning service as desired.</span></span> <span data-ttu-id="45def-229">Такие службы могут быть простыми или сложными. Они могут, например, управлять подготовкой в нескольких географических регионах и автоматически настраивать георепликацию, если эта стратегия используется для аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="45def-229">Such a service could be simple or complex – for example, handling provisioning across multiple geographies, and could set up geo-replication automatically if that strategy is being used for disaster recovery.</span></span> <span data-ttu-id="45def-230">С помощью шаблона автоматической подготовки клиентское приложение или скрипт может отправить запрос на подготовку в очередь для обработки службой подготовки, а затем будет запрашивать службу, чтобы получить данные о завершении.</span><span class="sxs-lookup"><span data-stu-id="45def-230">With the auto-provisioning pattern, a client application or script would submit a provisioning request to a queue to be processed by the provisioning service, and would then poll the service to determine completion.</span></span> <span data-ttu-id="45def-231">Если используется предварительная подготовка, запросы будут обрабатываться быстро, если служба, управляющая подготовкой базы данных для замены, работает в фоновом режиме.</span><span class="sxs-lookup"><span data-stu-id="45def-231">If pre-provisioning is used, requests would be handled quickly with the service managing provisioning of a replacement database running in the background.</span></span>



## <a name="next-steps"></a><span data-ttu-id="45def-232">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="45def-232">Next steps</span></span>

<span data-ttu-id="45def-233">Из этого руководства вы узнали, как выполнять такие задачи:</span><span class="sxs-lookup"><span data-stu-id="45def-233">In this tutorial you learned how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="45def-234">Подготовка нового клиента.</span><span class="sxs-lookup"><span data-stu-id="45def-234">Provision a single new tenant</span></span>
> * <span data-ttu-id="45def-235">Подготовка пакета дополнительных клиентов.</span><span class="sxs-lookup"><span data-stu-id="45def-235">Provision a batch of additional tenants</span></span>
> * <span data-ttu-id="45def-236">Получение сведений о подготовке клиентов и их регистрация в каталоге.</span><span class="sxs-lookup"><span data-stu-id="45def-236">Step into the details of provisioning tenants, and registering them into the catalog</span></span>

<span data-ttu-id="45def-237">Ознакомьтесь с [руководством по мониторингу производительности](sql-database-saas-tutorial-performance-monitoring.md).</span><span class="sxs-lookup"><span data-stu-id="45def-237">Try the [Performance monitoring tutorial](sql-database-saas-tutorial-performance-monitoring.md).</span></span>

## <a name="additional-resources"></a><span data-ttu-id="45def-238">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="45def-238">Additional Resources</span></span>

* <span data-ttu-id="45def-239">[Руководства по SaaS WTP базы данных SQL](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span><span class="sxs-lookup"><span data-stu-id="45def-239">Additional [tutorials that build upon the Wingtip SaaS application](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span></span>
* [<span data-ttu-id="45def-240">Клиентская библиотека эластичной базы данных</span><span class="sxs-lookup"><span data-stu-id="45def-240">Elastic database client library</span></span>](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-database-client-library)
* [<span data-ttu-id="45def-241">Отладка сценариев в интегрированной среде сценариев Windows PowerShell</span><span class="sxs-lookup"><span data-stu-id="45def-241">How to Debug Scripts in Windows PowerShell ISE</span></span>](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise)

---
title: "Подготовка новых клиентов в мультитенантном приложении, использующем базу данных SQL Azure | Документация Майкрософт"
description: "Узнайте, как подготовить и каталогизировать новые клиенты в приложении SaaS Wingtip."
keywords: "руководство по базе данных sql"
services: sql-database
documentationcenter: 
author: stevestein
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/11/2017
ms.author: sstein
ms.openlocfilehash: 8fa4c4f95386a92c8c818eef1a5b4de5a086fe07
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="provision-new-tenants-and-register-them-in-the-catalog"></a>Подготовка новых клиентов и их регистрация в каталоге

Из этого руководства вы узнаете о шаблонах SaaS для подготовки и каталогизации, а также об их реализации в приложении Wingtip SaaS. Мы создадим и инициализируем базы данных клиента, а также зарегистрируем их в каталоге приложения клиента. Каталог — это база данных, поддерживающая сопоставление между разными клиентами приложений SaaS и их данными. Каталог играет важную роль в направлении запросов приложения к правильным базам данных.  

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]

> * Подготовка и пошаговая реализация отдельного нового клиента.
> * Подготовка пакета дополнительных клиентов.


Для работы с этим руководством выполните следующие предварительные требования:

* Разверните приложение SaaS Wingtip. Чтобы развернуть его менее чем за пять минут, см. сведения в статье [Развертывание и изучение мультитенантного приложения SaaS, использующего базу данных SQL Azure](sql-database-saas-tutorial.md).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).

## <a name="introduction-to-the-saas-catalog-pattern"></a>Общие сведения о шаблоне каталога SaaS

В мультитенантном приложении SaaS на основе базы данных важно знать, где хранятся сведения для каждого клиента. В шаблоне каталога SaaS база данных используется для поддержки сопоставления между клиентами и хранения их данных. Приложение SaaS Wingtip использует архитектуру базы данных с одним клиентом, но базовый шаблон (хранение сопоставления клиента с базой данных в каталоге) применяется при использовании базы данных с несколькими или с одним клиентом.

Каждому клиенту присваивается ключ, идентифицирующий его в каталоге и сопоставленный с расположением соответствующей базы данных. В приложении SaaS Wingtip ключ формируется из хэша имени клиента. Это позволяет использовать часть имени клиента, представляющую URL-адрес приложения, для создания ключа. Можно использовать и другие схемы ключа клиента.  

Каталог позволяет изменять имя или расположение базы данных с минимальным воздействием на приложение.  В мультитенантной модели базы данных это также обеспечивает перемещение клиента между базами данных.  Кроме того, каталог можно использовать, чтобы указать, находится ли клиент или база данных в автономном режиме для обслуживания или других действий. Это рассматривается в руководстве [Восстановление базы данных SQL клиентов SaaS Wingtip](sql-database-saas-tutorial-restore-single-tenant.md).

Кроме того, в каталоге, который, по сути, является базой данных управления для приложения SaaS, можно сохранить дополнительные метаданные клиента или базы данных. Например, сведения об уровне или выпуске базы данных, версии схемы, плане обслуживания, а также соглашения об уровне обслуживания, доступные для клиентов, и другую информацию, которая позволяет осуществлять управление приложениями, поддержку пользователей или процессы DevOps.  

Помимо функций для приложения SaaS, каталог позволяет включить средства для баз данных.  В примере каталог Wingtip SaaS используется, чтобы включить обмен запросами между клиентами. Подробнее это описано в руководстве [Выполнение запросов ad-hoc-аналитики по всем клиентам SaaS Wingtip](sql-database-saas-tutorial-adhoc-analytics.md). Межбазовое управление заданиями рассматривается в руководствах [Управление схемой для нескольких клиентов в приложении SaaS Wingtip](sql-database-saas-tutorial-schema-management.md) и [Извлечение данных из баз данных клиента в базу данных аналитики для автономного анализа](sql-database-saas-tutorial-tenant-analytics.md). 

Каталог в приложении Wingtip SaaS реализуется с помощью функций управления сегментами в [клиентской библиотеке эластичной базы данных (EDCL)](sql-database-elastic-database-client-library.md). EDCL позволяет приложению создавать, администрировать и использовать карту сегментов на основе базы данных. Карта содержит список сегментов (баз данных) и обеспечивает сопоставление ключей (клиентов) и баз данных.  Функции EDCL можно использовать в приложениях или скриптах PowerShell при подготовке клиента, чтобы создавать записи в карте сегментов, а также в приложениях для эффективного подключения к нужной базе данных. EDCL кэширует сведения о подключении, чтобы уменьшить объем входящего трафика для базы данных каталога и ускорить работу приложения.  

> [!IMPORTANT]
> Данные сопоставления доступны в базе данных каталога. *Не изменяйте их*. Изменяйте данные сопоставления только с помощью интерфейсов API EDCL. Прямые манипуляции с данными сопоставления могут привести к повреждению каталога. Такие операции не поддерживаются.


## <a name="introduction-to-the-saas-provisioning-pattern"></a>Общие сведения о шаблоне подготовки SaaS

Когда в приложении SaaS подключается новый клиент, использующей модель базы данных с одним клиентом, базу данных клиента необходимо подготовить.  Она должна быть создана в нужном расположении с настройкой требуемого уровня обслуживания, инициализирована с надлежащей схемой и ссылочными данными, а затем зарегистрирована в каталоге с соответствующим ключом клиента.  

При подготовке базы данных можно использовать разные подходы, включая выполнение скриптов SQL, развертывание BACPAC или копирование шаблона окончательной базы данных.  

Используемый метод подготовки должен охватывать общую стратегию управления схемой, чтобы обеспечить подготовку новых баз по последней схеме.  Это описано в руководстве [Управление схемой для нескольких клиентов в приложении SaaS Wingtip](sql-database-saas-tutorial-schema-management.md).  

Приложение Wingtip SaaS подготавливает новые клиенты, копируя окончательную базу данных с именем basetenantdb, развернутую на сервере каталога.  Подготовку можно интегрировать в приложение как часть процесса регистрации, и (или) поддерживать в автономном режиме с помощью скриптов. В этом руководстве рассматривается подготовка с помощью PowerShell. Скрипты подготовки копируют basetenantdb, чтобы создать новую базу данных клиента в эластичном пуле. Затем она инициализируется с определенными данными клиента и регистрируется в карте сегментов каталога.  В примере приложения базы данных именуются на основе имени клиента, но это не является критически важным требованием для шаблона — каталог позволяет присвоить базе данных любое имя.+ 


## <a name="get-the-wingtip-application-scripts"></a>Получение сценариев приложения Wingtip

Скрипты и исходный код приложения SaaS Wingtip доступны в репозитории GitHub [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS). Указания по скачиванию скриптов SaaS Wingtip см. [здесь](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).


## <a name="provision-and-catalog-detailed-walkthrough"></a>Подробное пошаговое руководство по подготовке и каталогизации

Чтобы понять, как приложение Wingtip подготавливает новый клиент, добавьте точку останова и ознакомьтесь с пошаговым процессом подготовки клиента:

1. Откройте файл …\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ и задайте следующие параметры.
   * **$TenantName** — имя нового мероприятия (например, *Bushwillow Blues*).
   * **$VenueType** — один из предопределенных типов мероприятия: *blues*, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer.
   * **$DemoScenario** = **1**. Установите значение **1** для *подготовки одного клиента*.

1. Добавьте точку останова, поместив курсор в любом месте строки 48, содержащей *New-Tenant `*, и нажмите клавишу **F9**.

   ![точка останова](media/sql-database-saas-tutorial-provision-and-catalog/breakpoint.png)

1. Нажмите клавишу **F5** для запуска сценария.

1. После остановки выполнения сценария в точке останова нажмите клавишу **F11**, чтобы пошагово выполнить код.

   ![точка останова](media/sql-database-saas-tutorial-provision-and-catalog/debug.png)



Отслеживайте выполнение сценария и используйте клавиши **F10** и **F11** (меню **Отладка**), чтобы обойти вызываемые функции или перейти в них по очереди. Дополнительные сведения об отладке сценариев PowerShell см. в разделе [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise).


Ниже приведены не конкретные действия, а описание рабочего процесса отладки сценария.

1. **Импорт модуля SubscriptionManagement.psm1**, который содержит функции для входа в Azure и выбора рабочей подписки Azure.
1. **Импорт модуля CatalogAndDatabaseManagement.psm1**, предоставляющего каталог и абстракцию на уровне клиента с помощью функций[управления сегментами](sql-database-elastic-scale-shard-map-management.md). Это важный модуль, который инкапсулирует большую часть шаблона каталога. Его следует изучить.
1. **Получение сведений о конфигурации.** Перейдите к Get-Configuration (нажав клавишу F11) и посмотрите, как указывается конфигурация приложения. Здесь определяются имена ресурсов и другие значения для конкретного приложения, но не изменяйте эти значения, пока вы не изучите скрипты.
1. **Получение объекта каталога.** Перейдите к функции Get-Catalog, которая составляет и возвращает объект каталога, используемый в скрипте более высокого уровня.  При этом используются функции управления сегментами, импортируемые из **AzureShardManagement.psm1**. Каталог состоит из следующих компонентов:
   * $catalogServerFullyQualifiedName создается с использованием стандартного корня, а также имени пользователя: _catalog-\<пользователь\>.database.windows.net_.
   * $catalogDatabaseName извлекается из файла конфигурации: *tenantcatalog*.
   * Объект $shardMapManager инициализируется из базы данных каталога.
   * Объект $shardMap инициализируется из карты сегментов *tenantcatalog* в базе данных каталога.
   Объект каталога формируется, возвращается и используется в скрипте более высокого уровня.
1. **Вычисление нового ключа клиента.** Для создания ключа клиента из имени клиента используется хэш-функция.
1. **Проверка наличия ключа клиента.** Каталог проверяется, чтобы убедиться, что ключ доступен.
1. **Подготовка базы данных клиента с помощью New-TenantDatabase.** Используйте клавишу **F11**, чтобы перейти к функции и узнать, как база данных подготавливается с помощью [шаблона Azure Resource Manager](../azure-resource-manager/resource-manager-template-walkthrough.md).

Имя базы данных создается на основе имени клиента, чтобы было ясно, какие сегменты принадлежит определенному клиенту. (Можно свободно использовать другие стратегии именования баз данных.)+ Шаблон Resource Manager применяется, чтобы создать базу данных клиента в ходе копирования окончательной базы данных (baseTenantDB) на сервер каталога. Альтернативный подход заключается в том, чтобы создать пустую базу данных, а затем инициализировать ее, импортировав BACPAC-файл, или выполнить скрипт инициализации из хорошо известного расположения.  

Шаблон Resource Manager находится в папке …\Learning Modules\Common\: *tenantdatabasecopytemplate.json*

Созданная база данных клиента **инициализируется с помощью имени мероприятия (клиента) и его типа**. Также здесь можно выполнить другие действия по инициализации.

**База данных клиента регистрируется в каталоге** с использованием функции *Add-TenantDatabaseToCatalog* и ключа клиента. Используйте клавишу **F11**, чтобы просмотреть подробные сведения:

* База данных каталога добавляется на карту сегментов (список известных баз данных).
* Создается сопоставление, которое связывает значение ключа с сегментом.
* В таблицу клиентов в каталоге добавляются дополнительные метаданные о клиенте (имя мероприятия).  Таблица клиентов не входит в схему ShardManagement и не устанавливается EDCL.  В этой таблице показано, как базу данных каталога можно расширить для поддержки дополнительных данных приложения.   


По завершении подготовки возобновляется выполнение исходного скрипта *Demo-ProvisionAndCatalog*, который открывает в браузере страницу **События** для нового клиента:

   ![events](media/sql-database-saas-tutorial-provision-and-catalog/new-tenant.png)


## <a name="provision-a-batch-of-tenants"></a>Подготовка пакета клиентов

В этом упражнении подготавливается пакет из 17 клиентов. Рекомендуется подготовить этот пакет клиентов перед выполнением задач других руководств по SaaS Wingtip, чтобы вы могли работать не только с небольшим количеством баз данных.

1. Откройте файл …\\Learning Modules\\ProvisionAndCatalog\\*Demo-ProvisionAndCatalog.ps1* в *интегрированной среде сценариев PowerShell* и задайте для параметра *$DemoScenario* значение 3.
   * **$DemoScenario** = **3**. Установите значение **3** для *подготовки пакета клиентов*.
1. Нажмите клавишу **F5** для запуска скрипта.

Скрипт подготовит пакет дополнительных клиентов. Он использует [шаблон Azure Resource Manager](../azure-resource-manager/resource-manager-template-walkthrough.md), который управляет пакетом, а затем подготавливает каждую базу данных в связанном шаблоне. При использовании шаблонов таким способом Azure Resource Manager выступает в качестве посредника в процессе подготовки скрипта. Шаблоны подготавливают базы данных в параллельном режиме, когда это возможно, и выполняют повторные попытки в случае необходимости, чтобы оптимизировать общий процесс. Сценарий является идемпотентным, поэтому, если при его выполнении произойдет сбой или по какой-либо причине он остановится, запустите его еще раз.

### <a name="verify-the-batch-of-tenants-successfully-deployed"></a>Проверка успешного развертывания пакета клиентов

* Откройте сервер *tenants1*, перейдя к списку серверов на [портале Azure](https://portal.azure.com), щелкните **Базы данных SQL** и проверьте пакет из 17 дополнительных баз данных в списке.

   ![список баз данных](media/sql-database-saas-tutorial-provision-and-catalog/database-list.png)



## <a name="other-provisioning-patterns"></a>Другие шаблоны подготовки

Далее представлены другие шаблоны подготовки, которые не рассматриваются в этом руководстве.

**Предварительная подготовка баз данных.** В шаблоне предварительной подготовки учитывается тот факт, что базы данных в эластичном пуле не создают дополнительных затрат. Счета выставляются за эластичный пул, а не за базы данных, и простаивающие базы данных не потребляют ресурсы. Предварительная подготовка баз данных в пуле и их выделение при необходимости может значительно сократить время адаптации клиента. Количество заранее подготовленных баз данных можно настраивать при необходимости, чтобы обеспечивать готовность буфера к предполагаемой скорости подготовки.

**Автоматическая подготовка.** В шаблоне автоматической подготовки используется выделенная служба для автоматической подготовки серверов, пулов и баз данных по мере необходимости, включая предварительную подготовку баз данных в эластичных пулах. При списании и удалении баз данных "пропуски" в эластичных пулах могут заполняться службой подготовки в случае необходимости. Такие службы могут быть простыми или сложными. Они могут, например, управлять подготовкой в нескольких географических регионах и автоматически настраивать георепликацию, если эта стратегия используется для аварийного восстановления. С помощью шаблона автоматической подготовки клиентское приложение или скрипт может отправить запрос на подготовку в очередь для обработки службой подготовки, а затем будет запрашивать службу, чтобы получить данные о завершении. Если используется предварительная подготовка, запросы будут обрабатываться быстро, если служба, управляющая подготовкой базы данных для замены, работает в фоновом режиме.



## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]

> * Подготовка нового клиента.
> * Подготовка пакета дополнительных клиентов.
> * Получение сведений о подготовке клиентов и их регистрация в каталоге.

Ознакомьтесь с [руководством по мониторингу производительности](sql-database-saas-tutorial-performance-monitoring.md).

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Руководства по SaaS WTP базы данных SQL](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)
* [Клиентская библиотека эластичной базы данных](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-database-client-library)
* [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise)

---
title: "Диагностика пропущенных уведомлений в Центрах уведомлений Azure"
description: "Узнайте, как определить распространенные проблемы с пропущенными уведомлениями в Центрах уведомлений Azure."
services: notification-hubs
documentationcenter: Mobile
author: jwhitedev
manager: kpiteira
editor: 
ms.assetid: b5c89a2a-63b8-46d2-bbed-924f5a4cce61
ms.service: notification-hubs
ms.workload: mobile
ms.tgt_pltfrm: NA
ms.devlang: multiple
ms.topic: article
ms.date: 12/22/2017
ms.author: jawh
ms.openlocfilehash: 3925208fe56bcd9513ec4c0f21aa1e2dd8fbf9c5
ms.sourcegitcommit: 48fce90a4ec357d2fb89183141610789003993d2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2018
---
# <a name="diagnose-dropped-notifications-in-notification-hubs"></a>Диагностика пропущенных уведомлений в Центрах уведомлений

Один из наиболее распространенных вопросов от клиентов Центров уведомлений Azure — как исправить проблему, когда уведомления, отправленные из приложения, не отображаются на клиентских устройствах. Они хотят знать, где и почему уведомления были удалены и как это исправить. В этой статье мы рассмотрим, почему уведомления удаляются и не доходят до устройств. Вы узнаете, как анализировать и определить первопричину. 

Для начала очень важно понять, как Центры уведомлений отправляют уведомления на устройство.

![Архитектура Центров уведомлений][0]

В типичном потоке отправки уведомлений сообщение отправляется из *серверной части приложения* в Центры уведомлений. Центры уведомлений обрабатывают все операции регистрации с учетом настроенных тегов и выражений тегов для определения "целей". Цели — это все операции регистрации, которые должны получить push-уведомление. Эти операции регистрации могут распространяться на любые из поддерживаемых нами платформ — iOS, Google, Windows, Windows Phone, Kindle и Baidu для China Android.

Определив цели, Центры уведомлений отправляют сообщения в *службу push-уведомлений* для платформы устройства. В качестве примера можно привести службу push-уведомлений Apple (APNs) для Apple и Firebase Cloud Messaging (FCM) для Google. Центры уведомлений отправляют сообщения, разделенные по нескольким пакетам регистраций. Они выполняют проверку подлинности в соответствующей службе push-уведомлений, исходя из учетных данных, установленных на портале Azure в разделе **настроек Центра уведомлений**. Затем служба push-уведомлений пересылает уведомления на соответствующие *клиентские устройства*. 

Обратите внимание, что последним звеном доставки уведомлений является доставка между службой push-уведомлений платформы и устройством. Любой из четырех основных компонентов в процессе отправки push-уведомления (клиент, серверная часть приложения, Центры уведомлений и служба push-уведомлений платформы) может привести к удалению уведомления. Дополнительные сведения об архитектуре Центров уведомлений см. в [этой статье].

Сбой доставки уведомлений может произойти во время начального этапа тестирования или работы в промежуточной среде, что может указывать на проблему конфигурации. Если сбой доставки уведомлений происходит во время работы в рабочей среде, все или некоторые уведомления могут быть удалены, что указывает на некоторые более серьезные проблемы с приложением или шаблоном обмена сообщениями. 

В следующем разделе рассматриваются сценарии удаления уведомлений, начиная с распространенных и заканчивая более редкими.

## <a name="notification-hubs-misconfiguration"></a>Неправильная настройка Центров уведомлений
Чтобы успешно отправлять уведомления в соответствующую службу push-уведомлений, Центры уведомлений Azure должны проходить проверку подлинности в контексте приложения разработчика. Для этого разработчик создает учетную запись разработчика для соответствующей платформы (Google, Apple, Windows и т. д.). Затем он регистрирует свое приложение в платформе и получает учетные данные. 

Учетные данные платформы необходимо добавить на портал Azure. Если уведомления не доходят до устройства, сначала следует убедиться, что в Центре уведомлений настроены правильные учетные данные. Они должны соответствовать данным приложения, созданного в учетной записи разработчика для конкретной платформы. 

Пошаговые инструкции для выполнения этого процесса см. в статье [Начало работы с Центрами уведомлений для приложений универсальной платформы Windows].

Ниже приведены некоторые распространенные сценарии неправильной настройки, которые следует проверить.

* **Общие сведения**
   
    * Убедитесь, что имя Центра уведомлений (без опечаток) одинаковое во всех следующих расположениях:

        * Где выполняется регистрация из клиента.
        * Где вы отправляете уведомления из серверной части.
        * Где вы настроили учетные данные службы push-уведомлений.
    
    * Убедитесь, что в клиенте и в серверной части приложения используются правильные строки конфигурации подписанного URL-адреса. Обычно необходимо использовать **DefaultListenSharedAccessSignature** на клиентском устройстве и **DefaultFullSharedAccessSignature** в серверной части приложения (что предоставляет разрешение для отправки уведомлений в Центры уведомлений).

* **Конфигурация APNs**
   
    Необходимо использовать два разных центра — один для рабочей среды и другой для тестирования. Это означает, что следует отправлять сертификат, который используется в изолированной среде, и сертификат, который будет использоваться в рабочей среде, в отдельные центры. Не отправляйте разные типы сертификатов в один и тот же центр. Это может вызвать сбои уведомления. 
    
    Если вы случайно отправили сертификаты разных типов в один и тот же центр, мы рекомендуем удалить центр и начать работу заново с новым центром. Если по какой-либо причине вам не удается удалить центр, по крайней мере, удалите из него все имеющиеся регистрации. 

* **Конфигурация FCM** 
   
    1. Убедитесь, что *ключ сервера*, полученный из Firebase, совпадает с ключом сервера, зарегистрированным на портале Azure.
   
    ![Ключ сервера Firebase][3]
   
    2. Убедитесь, что на клиенте настроен **идентификатор проекта**. Значение для **идентификатора проекта** можно получить на панели мониторинга Firebase.
   
    ![Идентификатор проекта Firebase][1]

## <a name="application-issues"></a>Проблемы с приложением
* **Теги и выражения тегов**

    При использовании тегов или их выражений для сегментирования аудитории возможна ситуация, когда при отправке уведомления не удается найти цель на основе тегов и выражений тегов, указанных в вызове отправки. 
    
    Просмотрите регистрации, чтобы убедиться в наличии совпадающих тегов при отправке уведомлений. Затем убедитесь, что уведомления отправляются только из клиентов с этими регистрациями. 
    
    Например, если все ваши регистрации в Центрах уведомлений выполнены с использованием тега "Политика" и вы отправляете уведомление с тегом "Спорт", оно не будет отправлено ни на одно устройство. В более сложном случае могут использоваться выражения тегов. Например, вы выполнили регистрацию, указав "Тег A" или "Тег Б", но во время отправки уведомлений используете "Тег А и тег Б". В разделе советов по самостоятельной диагностике далее в этой статье мы покажем, как просмотреть регистрации и использованные в них теги. 

* **Проблемы с шаблонами**

    Если используются шаблоны, убедитесь, что вы следуете рекомендациям, приведенным в статье [Шаблоны]. 

* **Недопустимые регистрации**

    Если Центр уведомлений настроен правильно и если теги и их выражения использовались правильно, будут обнаружены допустимые цели, которым необходимо отправить уведомления. Затем Центры уведомлений параллельно запускают несколько пакетов обработки. Каждый пакет отправляет сообщения набору регистраций. 

    > [!NOTE]
    > Так как обработка выполняется параллельно, порядок доставки уведомлений не гарантируется. 

    Центры уведомлений оптимизированы для модели доставки сообщений "не более одного". Мы пытаемся выполнить дедупликацию так, чтобы уведомления доставлялись на устройство по одному разу. Для этого, прежде чем отправить сообщение в службу push-уведомлений, мы проверяем регистрации, чтобы убедиться, что на каждый идентификатор устройства отправлено только одно сообщение. 

    Каждый пакет отправляется в службу push-уведомлений, которая, в свою очередь, принимает и проверяет регистрации. Эта служба может обнаружить ошибку одной или нескольких регистраций в пакете. В этом случае она возвращает ошибку в Центры уведомлений, и обработка прекращается. Служба push-уведомлений полностью удаляет такой пакет. Это касается в особенности службы APNS, которая использует протокол потока TCP. 

    Мы оптимизировали доставку с помощью модели "не более одного". Но в этом случае проблемная регистрация удаляется из базы данных. Затем мы повторяем попытку доставки уведомлений для остальных устройств в этом пакете.

    Чтобы получить дополнительные сведения о неудачной попытке доставки при регистрации, вы можете воспользоваться REST API Центров уведомлений Azure. Дополнительные сведения см. в статье [Per Message Telemetry: Get Notification Message Telemetry](https://msdn.microsoft.com/library/azure/mt608135.aspx) (Телеметрия в расчете на сообщение: получение телеметрии оповещения) и [PNS Feedback](https://msdn.microsoft.com/library/azure/mt705560.aspx) (Отзыв PNS). Пример кода приведен в [репозитории примеров для отправки с помощью REST](https://github.com/Azure/azure-notificationhubs-samples/tree/master/dotnet/SendRestExample).

## <a name="push-notification-service-issues"></a>Проблемы службы push-уведомлений
Когда служба push-уведомлений платформы получит сообщение с уведомлением, она должна доставить уведомление на устройство. На этом этапе от Центров уведомлений больше ничего не зависит, и они не могут контролировать время доставки и то, будет ли уведомление доставлено на устройство. 

Так как службы уведомлений платформы надежны, как правило, уведомления доходят из службы push-уведомлений до устройства за несколько секунд. Если служба push-уведомлений регулирует доставку, Центры уведомлений реализуют стратегию экспоненциальной отсрочки. Если служба push-уведомлений недоступна в течение 30 минут, применяется политика, управляющая истечением срока действия и окончательным удалением этих сообщений. 

Если служба push-уведомлений пытается доставить уведомление на устройство, находящееся в автономном режиме, она хранит уведомление ограниченный период времени. Уведомление доставляется на устройство, когда оно становится доступным. 

Для каждого приложения хранится только одно последнее уведомление. Если при пребывании устройства в автономном режиме отправляется несколько уведомлений, отправка каждого нового уведомления приводит к предварительному удалению предыдущего. Сохранение только последнего уведомления называется *объединением уведомлений* в APNs и *разъединением* в FCM (с использованием ключа разъединения). Если устройство находится в автономном режиме в течение длительного времени, уведомления, сохраненные для него, удаляются. Дополнительные сведения см. в статье с [обзором APNs] и [сведениями о сообщениях FCM].

С помощью Центров уведомлений Azure вы можете передать ключ объединения через заголовок HTTP, используя универсальный API SendNotification. Например, для пакета SDK для .NET можно использовать **SendNotificationAsync**. API SendNotification также принимает заголовки HTTP, которые передаются как есть в соответствующую службу push-уведомлений. 

## <a name="self-diagnosis-tips"></a>Советы по самостоятельной диагностике
Ниже приведены способы диагностики первопричины пропущенных уведомлений в Центрах уведомлений.

### <a name="verify-credentials"></a>Проверка учетных данных
* **Портал разработчика службы push-уведомлений**
   
    Проверьте учетные данные на соответствующем портале разработчика службы push-уведомлений (APNs, FCM, служба уведомлений Windows и т. д.). Дополнительные сведения см. в статье [Начало работы с Центрами уведомлений для приложений универсальной платформы Windows].

* **Портал Azure**
   
    Чтобы просмотреть и сопоставить учетные данные с данными, полученными на портале разработчика службы push-уведомлений, на портале Azure, перейдите на вкладку **Политики доступа**. 
   
    ![Вкладка "Политики доступа" на портале Azure][4]

### <a name="verify-registrations"></a>Проверка регистраций
* **Visual Studio**
   
    При использовании Visual Studio для разработки вы можете подключиться к Azure с помощью обозревателя сервера, чтобы просматривать множество служб Azure, включая Центры уведомлений, а также управлять ими. Это особенно удобно при работе в среде разработки или тестирования. 
   
    ![Обозреватель серверов в Visual Studio.][9]
   
    В центре можно просматривать все регистрации, а также управлять ими. Они классифицированы по таким категориям, как платформы, собственная или шаблонная регистрация, теги, идентификаторы службы push-уведомлений, идентификаторы регистрации и сроки действия. На этой странице можно также изменить регистрацию. Это особенно удобно для редактирования тегов. 
   
    ![Регистрация устройств в Visual Studio][8]
   
   > [!NOTE]
   > Visual Studio следует использовать только при разработке или тестировании для ограниченного числа регистраций. Если возникает необходимость массового редактирования регистраций, можно воспользоваться функцией экспорта и импорта регистраций, описанной в статье [Практическое руководство. Массовый экспорт и изменение регистраций](https://msdn.microsoft.com/library/dn790624.aspx).
   > 
   > 
* **Обозреватель служебной шины**
   
    Многие клиенты просматривают свои Центры уведомлений и управляют ими с помощью [обозревателя служебной шины], который представляет собой проект с открытым кодом. Примеры кода см. на [этой странице].

### <a name="verify-message-notifications"></a>Проверка уведомлений о сообщениях
* **Портал Azure**
   
    Чтобы отправить тестовые уведомления клиентам, не запуская серверную часть службы, в разделе **Поддержка и устранение неполадок** выберите **Тестовая отправка**. 
   
    ![Функциональные возможности тестовой отправки в Azure][7]
* **Visual Studio**
   
    Тестовые уведомления также можно отправлять с помощью Visual Studio.
   
    ![Функциональные возможности тестовой отправки в Visual Studio][10]
   
    Дополнительные сведения об использовании Центров уведомлений с помощью обозревателя серверов в Visual Studio см. в следующих статьях: 
   
   * [Просмотр регистраций устройства в центрах уведомлений]
   * [Подробный обзор релиз-кандидата Visual Studio 2013 с обновлением 2 и пакета Azure SDK 2.3]
   * [Объявление о выпуске Visual Studio 2013 с обновлением 3 и пакета Azure SDK 2.4]

### <a name="debug-failed-notifications-and-review-notification-outcome"></a>Уведомления о сбоях отладки и просмотр результатов уведомлений
**Свойство EnableTestSend**

При отправке уведомления через Центры уведомлений сначала оно ставится в очередь для обработки. Центры уведомлений определяют правильные цели, а затем отправляют уведомление в службу push-уведомлений. При использовании REST API или любого клиентского пакета SDK удачное возвращение вызова отправки означает только то, что Центры уведомлений успешно поставили сообщение в очередь. При этом информация о том, что происходит после отправки сообщения из Центров уведомлений в службу push-уведомлений, не предоставляется. 

Если уведомление не поступает на устройство клиента, возможно, во время попытки Центров уведомлений доставить сообщения в службу push-уведомлений произошла ошибка. Например, размер полезных данных может превышать максимально допустимый размер таких данных в службе push-уведомлений или настроенные в Центрах уведомлений учетные данные могут быть недоступными. 

Информацию об ошибках службы push-уведомлений можно получить с помощью свойства [EnableTestSend]. Оно автоматически включается при отправке тестового сообщения с портала или клиентского приложения Visual Studio и таким образом позволяет просматривать подробную отладочную информацию. Вы также можете использовать это свойство с помощью API. Сейчас его можно использовать в пакете SDK для .NET. В конечном счете оно будет добавлено ко всем клиентским пакетам SDK. 

Чтобы использовать свойство **EnableTestSend** с вызовом REST, добавьте параметр строки запроса с именем *test* в конце вызова отправки. Например: 

    https://mynamespace.servicebus.windows.net/mynotificationhub/messages?api-version=2013-10&test

**Пример (пакет SDK для .NET)**

Ниже приведен пример отправки собственного всплывающего уведомления при использовании пакета SDK для .NET:

```csharp
    NotificationHubClient hub = NotificationHubClient.CreateClientFromConnectionString(connString, hubName);
    var result = await hub.SendWindowsNativeNotificationAsync(toast);
    Console.WriteLine(result.State);
```

В конце выполнения для параметра **result.State** будет просто установлено значение **Enqueued** (Поставлено в очередь). В результатах не будет предоставлена информация о вашем push-уведомлении. 

Затем вы можете использовать логическое свойство **EnableTestSend**. С помощью свойства **EnableTestSend** во время инициализации **NotificationHubClient** можно получить подробные сведения об ошибках службы push-уведомлений, произошедших при отправке уведомления. Для возврата вызова отправки требуется дополнительное время, так как он выполняется только после доставки уведомления из Центров уведомлений в службу push-уведомлений, чтобы определить результат. 

```csharp
    bool enableTestSend = true;
    NotificationHubClient hub = NotificationHubClient.CreateClientFromConnectionString(connString, hubName, enableTestSend);

    var outcome = await hub.SendWindowsNativeNotificationAsync(toast);
    Console.WriteLine(outcome.State);

    foreach (RegistrationResult result in outcome.Results)
    {
        Console.WriteLine(result.ApplicationPlatform + "\n" + result.RegistrationId + "\n" + result.Outcome);
    }
```

**Пример выходных данных**

    DetailedStateAvailable
    windows
    7619785862101227384-7840974832647865618-3
    The Token obtained from the Token Provider is wrong

Это сообщение указывает на то, что в Центрах уведомлений настроены недопустимые учетные данные или возникла проблема с регистрацией. Мы рекомендуем удалить эту регистрацию и дать клиенту создать ее заново, прежде чем отправлять сообщение. 

> [!NOTE]
> Использование свойства **EnableTestSend** строго регулируется. Используйте его только в среде разработки и тестирования и с ограниченным набором регистраций. Мы отправляем уведомления об отладке только на 10 устройств. Кроме этого, у нас есть ограничения на количество обрабатываемых уведомлений об отладке — 10 в минуту. 
> 
> 

### <a name="review-telemetry"></a>Просмотр телеметрии
* **Использование портала Azure**
   
    На портале вы можете получить краткий обзор всех операций, выполняемых в Центре уведомлений. 
   
    1. На вкладке **Обзор** можно просмотреть объединенное представление регистраций, уведомлений и ошибок каждой платформы. 
   
        ![Панель мониторинга "Обзор" в Центре уведомлений][5]
   
    2. На вкладке **Монитор** можно добавить дополнительные метрики для конкретной платформы, чтобы получить подробные сведения о состоянии. Вы можете отдельно рассмотреть любые ошибки, связанные со службой push-уведомлений, возвращаемые, когда Центры уведомлений пытаются отправить в нее уведомление. 
   
        ![Журнал действий на портале Azure][6]
   
    3. Сначала просмотрите **входящие сообщения**, **операции регистрации** и **доставленные уведомления**. Затем перейдите на вкладку каждой платформы, чтобы просмотреть ошибки, связанные со службой push-уведомлений. 
   
    4. Если параметры проверки подлинности для Центра уведомлений неверные, будет получена ошибка **выполнения проверки подлинности PNS**. Это сигнализирует о том, что следует проверить учетные данные службы push-уведомлений. 

* **Программный доступ**

    Дополнительные сведения о программном доступе см. в следующих статьях: 

    * [Программный доступ]  
    * [Fetch Notification Hubs Telemetry Programmatically] (Получение данных телеметрии Центров уведомлений программным путем) 

    > [!NOTE]
    > Некоторые функции, связанные с телеметрией, например экспорт и импорт данных регистраций и доступ к телеметрии с помощью API, доступны только на уровне службы "Стандартный". При попытке использовать эти функции на уровне службы "Бесплатный" или "Базовый" вы получите сообщение об исключении, если используется пакет SDK, и ошибку HTTP 403 (запрещено), если вы используете функции непосредственно из REST API. 
    >
    >Чтобы использовать функции, связанные с телеметрией, сначала проверьте на портале Azure, что используется уровень службы "Стандартный".  
> 
> 

<!-- IMAGES -->
[0]: ./media/notification-hubs-diagnosing/Architecture.png
[1]: ./media/notification-hubs-diagnosing/FCMConfigure.png
[3]: ./media/notification-hubs-diagnosing/FCMServerKey.png
[4]: ../../includes/media/notification-hubs-portal-create-new-hub/notification-hubs-connection-strings-portal.png
[5]: ./media/notification-hubs-diagnosing/PortalDashboard.png
[6]: ./media/notification-hubs-diagnosing/PortalAnalytics.png
[7]: ./media/notification-hubs-ios-get-started/notification-hubs-test-send.png
[8]: ./media/notification-hubs-diagnosing/VSRegistrations.png
[9]: ./media/notification-hubs-diagnosing/VSServerExplorer.png
[10]: ./media/notification-hubs-diagnosing/VSTestNotification.png

<!-- LINKS -->
[этой статье]: notification-hubs-push-notification-overview.md
[Начало работы с Центрами уведомлений для приложений универсальной платформы Windows]: notification-hubs-windows-store-dotnet-get-started-wns-push-notification.md
[Шаблоны]: https://msdn.microsoft.com/library/dn530748.aspx 
[обзором APNs]: https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html
[сведениями о сообщениях FCM]: https://firebase.google.com/docs/cloud-messaging/concept-options
[Export and modify registrations in bulk]: http://msdn.microsoft.com/library/dn790624.aspx
[обозревателя служебной шины]: https://msdn.microsoft.com/library/dn530751.aspx#sb_explorer
[этой странице]: https://code.msdn.microsoft.com/windowsazure/Service-Bus-Explorer-f2abca5a
[Просмотр регистраций устройства в центрах уведомлений]: http://msdn.microsoft.com/library/windows/apps/xaml/dn792122.aspx 
[Подробный обзор релиз-кандидата Visual Studio 2013 с обновлением 2 и пакета Azure SDK 2.3]: http://azure.microsoft.com/blog/2014/04/09/deep-dive-visual-studio-2013-update-2-rc-and-azure-sdk-2-3/#NotificationHubs 
[Объявление о выпуске Visual Studio 2013 с обновлением 3 и пакета Azure SDK 2.4]: http://azure.microsoft.com/blog/2014/08/04/announcing-release-of-visual-studio-2013-update-3-and-azure-sdk-2-4/ 
[EnableTestSend]: https://docs.microsoft.com/dotnet/api/microsoft.azure.notificationhubs.notificationhubclient.enabletestsend?view=azure-dotnet
[Программный доступ]: http://msdn.microsoft.com/library/azure/dn458823.aspx
[Fetch Notification Hubs Telemetry Programmatically]: https://github.com/Azure/azure-notificationhubs-samples/tree/master/FetchNHTelemetryInExcel (Получение данных телеметрии Центров уведомлений программным путем)


---
title: "Политики индексирования Azure Cosmos DB | Документация Майкрософт"
description: "Сведения об осуществлении индексации в Azure Cosmos DB. Узнайте, как настроить и изменить политику индексирования для автоматического индексирования и повышения производительности."
keywords: "принцип работы индексирования, автоматическое индексирование, индексирование базы данных"
services: cosmos-db
documentationcenter: 
author: arramac
manager: jhubbard
editor: monicar
ms.assetid: d5e8f338-605d-4dff-8a61-7505d5fc46d7
ms.service: cosmos-db
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: data-services
ms.date: 08/17/2017
ms.author: arramac
ms.openlocfilehash: b09f5323f0378721412baade9be9926ebd0c171e
ms.sourcegitcommit: 9ea2edae5dbb4a104322135bef957ba6e9aeecde
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/03/2018
---
# <a name="how-does-azure-cosmos-db-index-data"></a>Как работает индексирование данных в Azure Cosmos DB?

По умолчанию все данные Azure Cosmos DB индексируются. Несмотря на то, что многие клиенты рады сообщить Azure DB Cosmos автоматически обрабатывать все аспекты индексирования, можно указать пользовательский *политика индексирования* для коллекций во время создания в базе данных Azure Cosmos. Политики индексирования в базе данных Azure Cosmos являются более гибкими и мощными, чем вторичные индексы, предоставляемых в других платформах базы данных. В базе данных Azure Cosmos можно разработать и настроить форму индекса без ущерба для гибкости схемы. 

Чтобы узнать, работает как индексирования в базе данных Azure Cosmos, важно понять, при управлении политика индексирования, которые можно сделать детально компромисс между затраты на хранение индекса, запись и запросов пропускной способности и согласованности запроса.  

В этой статье мы рассмотрим закрыть Azure Cosmos DB политики, как настраивать политики индексирования, а также быть компромиссы индексирования. 

Ознакомившись с данной статьей, вы сможете ответить на следующие вопросы.

* Как переопределить свойства, которые необходимо включить в индексацию или исключить из нее?
* Как настроить индекс для возможных обновлений?
* Как настроить индексирования для выполнения запросов ORDER BY или диапазон?
* Как внести изменения в политику индексирования коллекции?
* Как сравнить затраты на хранение и производительность различных политик индексирования?

## Настройки политики индексирования, коллекции<a id="CustomizingIndexingPolicy"></a>  
Компромисс между хранилищем, записи и производительность запросов и запросов согласованности можно настроить путем переопределения политики на Azure Cosmos DB коллекцию индексирования по умолчанию. Можно настроить следующие аспекты:

* **Включить или исключить документов и пути к и из индекса**. Можно исключить или включить конкретных документов в индекс, если вставка или замена документов в коллекции. Можно также включить или исключить определенных свойств JSON, также называемый *пути*, индексируемые для документов, которые включены в индекс. Пути включают шаблоны из подстановочных знаков.
* **Настройка различных типов индекса**. Для каждого пути, включены можно указать тип индекса, необходимые для пути для коллекции. Можно указать тип индекса, основанный на пути данных, ожидаемого запроса рабочей нагрузки и числовые или строку «точность».
* **Настройка режимов обновления индекса**. Azure Cosmos DB поддерживают три режима индексирования: согласованной, отложенной и нет. Режимы индексирования через политики индексирования можно настроить на Azure Cosmos DB коллекции. 

В следующем фрагменте кода Microsoft .NET показано, как задать пользовательскую политику индексации при создании коллекции. В этом примере мы задайте политику с индексом диапазона для строки и числа на максимальной точности. Эту политику можно использовать для выполнения запросов ORDER BY в строках.

    DocumentCollection collection = new DocumentCollection { Id = "myCollection" };

    collection.IndexingPolicy = new IndexingPolicy(new RangeIndex(DataType.String) { Precision = -1 });
    collection.IndexingPolicy.IndexingMode = IndexingMode.Consistent;

    await client.CreateDocumentCollectionAsync(UriFactory.CreateDatabaseUri("db"), collection);   


> [!NOTE]
> Схема JSON для политики индексирования изменено после выпуска версии 2015-06-03 API REST. С этим выпуском схему JSON для политика индексирования поддерживает индексы диапазона в строках. Новую схему политики поддерживают пакет .NET SDK 1.2.0 и Java, Python и пакеты Node.js SDK 1.1.0. Более ранних версиях пакета SDK, используйте API REST версии 2015-04-08. Они поддерживают более ранней схемы для индексирования политики.
> 
> По умолчанию Azure Cosmos DB индексирует все свойства строки в документах согласованно с хэш-индекс. Он постоянно индексирует все числовые свойства в документах с индексом диапазона.  
> 
> 

### <a name="customize-the-indexing-policy-in-the-portal"></a>Настройка политики индексирования на портале

Можно изменить политики индексирования коллекции на портале Azure: 

1. На портале перейти в учетную запись Azure Cosmos DB и затем выберите коллекцию. 
2. В левом меню навигации, выберите **параметры**, а затем выберите **политики индексирования**. 
3. В разделе **политики индексирования**, измените политику индексации, а затем выберите **ОК**. 

### Режимы индексирования базы данных<a id="indexing-modes"></a>  
Azure Cosmos DB поддерживают три режима индексирования, которые можно настроить через политике индексирования для коллекции Azure Cosmos DB: согласованной, отложенной и нет.

**Согласованное**: политика сбора Azure Cosmos DB — согласованный, запросы к определенной базе данных Azure Cosmos коллекции выполните уровень согласованности, указанным для чтения точки (надежный, ограниченных устаревание, сеанса, или окончательной). Индекс обновляется синхронно в рамках обновления документа (вставки, замены, update и delete документа в коллекции Azure Cosmos DB).

Согласованное индексирования поддерживает согласованное запросы за счет возможности сокращения пропускная способность при записи. Уменьшение является функцией уникальных путей, которые должны быть проиндексированы и «уровень согласованности». Режим согласованного индексирования предназначен для рабочих нагрузок типа "быстрая запись, немедленный запрос".

**Отложенная**: индекс обновляется асинхронно при коллекцию Azure Cosmos DB замораживания, то есть при коллекции пропускной способности не используются для обслуживания запросов пользователя полностью. Режим отложенной индексирования могут подходить для «приема. Теперь позже запроса» потребностью приема документа. Обратите внимание, что может возникнуть несогласованность результатов, так как полученный и индексации данных медленно. Это означает, что количество запросов или конкретного запроса, что результаты не могут быть согласованием или repeatable в любой момент времени. 

Индекс обычно используется в режиме наверстывания полученный данными. С Lazy индексирования срок жизни (TTL) изменяет результат в индекс удаляется и создается повторно. Это делает несогласованное число и результаты запроса в течение заданного времени. Таким образом большинство учетных записей Azure Cosmos DB следует использовать согласованный режим индексирования.

**Нет**: коллекции, которая содержит один режим индексирования не содержит индекс связанные с ним. Обычно это используется, если Azure Cosmos DB используется в качестве хранилища ключ значение и документов осуществляется только по их свойству идентификатора. 

> [!NOTE]
> Настройка политики индексирования с ни один имеет побочный эффект удаления любой существующий индекс. Применяется, если шаблонов доступа требуется только идентификатор или ссылкой.
> 
> 

В следующей таблице показана согласованность запросов на основе режима индексирования (Consistent и Lazy), настроенного для коллекции, и уровня согласованности, указанного для запроса. Это относится к запросам, выполненные с помощью любого интерфейса: API, пакеты SDK, REST или из хранимых процедур и триггеров. 

|Целостность|Режим индексирования: согласованное|Режим индексирования: отложенной|
|---|---|---|
|Уровень согласованности Strong (сильная)|Уровень согласованности Strong (сильная)|Уровень согласованности Eventual (в конечном счете)|
|Ограниченная с запаздыванием|Ограниченная с запаздыванием|Уровень согласованности Eventual (в конечном счете)|
|Сеанс|Сеанс|Уровень согласованности Eventual (в конечном счете)|
|Уровень согласованности Eventual (в конечном счете)|Уровень согласованности Eventual (в конечном счете)|Уровень согласованности Eventual (в конечном счете)|

Azure Cosmos DB возвращает ошибку для запросов, выполняемых в коллекциях, ни одного режим индексирования. Запросы по-прежнему могут быть выполнены как просмотров через явный **x-ms-documentdb-enable сканирования** заголовок в API-интерфейса REST или **EnableScanInQuery** запроса параметр с помощью пакета SDK для .NET. Некоторые функции запроса, например ORDER BY не поддерживаются как сканирование с **EnableScanInQuery**.

В следующей таблице показаны согласованности для запросов, основанных на режим индексирования (Consistent Lazy и None) при **EnableScanInQuery** указано.

|Целостность|Режим индексирования: согласованный|Режим индексирования: асинхронный|Режим индексирования: нет|
|---|---|---|---|
|Уровень согласованности Strong (сильная)|Уровень согласованности Strong (сильная)|Уровень согласованности Eventual (в конечном счете)|Уровень согласованности Strong (сильная)|
|Ограниченная с запаздыванием|Ограниченная с запаздыванием|Уровень согласованности Eventual (в конечном счете)|Ограниченная с запаздыванием|
|Сеанс|Сеанс|Уровень согласованности Eventual (в конечном счете)|Сеанс|
|Уровень согласованности Eventual (в конечном счете)|Уровень согласованности Eventual (в конечном счете)|Уровень согласованности Eventual (в конечном счете)|Уровень согласованности Eventual (в конечном счете)|

В следующем примере показано кода как создать коллекцию Azure Cosmos DB с помощью пакета SDK для .NET с согласованной индексирование на все операции вставки в документ.

     // Default collection creates a Hash index for all string fields and a Range index for all numeric    
     // fields. Hash indexes are compact and offer efficient performance for equality queries.

     var collection = new DocumentCollection { Id ="defaultCollection" };

     collection.IndexingPolicy.IndexingMode = IndexingMode.Consistent;

     collection = await client.CreateDocumentCollectionAsync(UriFactory.CreateDatabaseUri("mydb"), collection);


### <a name="index-paths"></a>Пути индекса
Azure Cosmos DB как деревья моделирует документов JSON и индекс. Вы можете настроить политики для путей в дереве. В документах вы можете пути, чтобы включить или исключить из индексирования. Это можно предлагать повысить производительность записи и уменьшить хранилище индексирования для сценариев, в которых шаблоны запросов известны заранее.

Пути индекса начинаются с корня (/) и, как правило, заканчиваются оператором подстановочного знака (?), оператор подстановочный знак. Эта ошибка означает, что существует несколько возможных значений для префикса. Например, чтобы обслуживать запрос SELECT * FROM Families F WHERE F.familyName = "Andersen", вам нужно включить путь индекса для /familyName/? в политику индекса коллекции.

В путях индекса можно также использовать оператор подстановочного знака \* для задания алгоритма пути рекурсивно по префиксу. Например, /payload/* можно использовать для исключения из индексации всего, что находится по свойству payload.

Вот распространенные шаблоны задания путей индекса:

| Путь                | Описание/вариант использования                                                                                                                                                                                                                                                                                         |
| ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| /                   | Путь коллекции по умолчанию. Рекурсивные и применяет к дереву весь документ.                                                                                                                                                                                                                                   |
| /prop/?             | Путь индексирования, необходимый для обслуживания запросов, подобных следующим (с типами Hash или Range, соответственно):<br><br>SELECT FROM collection c WHERE c.prop = "value"<br><br>SELECT FROM collection c WHERE c.prop > 5<br><br>SELECT FROM collection c ORDER BY c.prop                                                                       |
| /prop/*             | Путь индекса для всех путей по заданной метке. Работает со следующими запросами<br><br>SELECT FROM collection c WHERE c.prop = "value"<br><br>SELECT FROM collection c WHERE c.prop.subprop > 5<br><br>SELECT FROM collection c WHERE c.prop.subprop.nextprop = "value"<br><br>SELECT FROM collection c ORDER BY c.prop         |
| /props/[]/?         | Путь индекса, необходимый для обслуживания запросов с итерацией и соединения, отправляемых в массивы скалярных выражений, например, ["a", "b", "c"]:<br><br>SELECT tag FROM tag IN collection.props WHERE tag = "value"<br><br>SELECT tag FROM collection c JOIN tag IN c.props WHERE tag > 5                                                                         |
| /props/[]/subprop/? | Путь индекса, необходимый для обслуживания запросов с итерацией и соединения, отправляемых в массивы объектов, например, [{subprop: "a"}, {subprop: "b"}]:<br><br>SELECT tag FROM tag IN collection.props WHERE tag.subprop = "value"<br><br>SELECT tag FROM collection c JOIN tag IN c.props WHERE tag.subprop = "value"                                  |
| /prop/subprop/?     | Путь индексирования, необходимый для обслуживания запросов (с типами Hash или Range, соответственно):<br><br>SELECT FROM collection c WHERE c.prop.subprop = "value"<br><br>SELECT FROM collection c WHERE c.prop.subprop > 5                                                                                                                    |

> [!NOTE]
> При установке пути пользовательский индекс, вы должны указать правило индексирования по умолчанию для всего документа дерева, который обозначается специальный путь «/ *». 
> 
> 

В следующем примере настраивается определенный путь с индексом диапазона и точности пользовательских значение 20 байт:

    var collection = new DocumentCollection { Id = "rangeSinglePathCollection" };    

    collection.IndexingPolicy.IncludedPaths.Add(
        new IncludedPath { 
            Path = "/Title/?", 
            Indexes = new Collection<Index> { 
                new RangeIndex(DataType.String) { Precision = 20 } } 
            });

    // Default for everything else
    collection.IndexingPolicy.IncludedPaths.Add(
        new IncludedPath { 
            Path = "/*" ,
            Indexes = new Collection<Index> {
                new HashIndex(DataType.String) { Precision = 3 }, 
                new RangeIndex(DataType.Number) { Precision = -1 } 
            }
        });

    collection = await client.CreateDocumentCollectionAsync(UriFactory.CreateDatabaseUri("db"), pathRange);


### <a name="index-data-types-kinds-and-precisions"></a>Типы данных индекса и типы, а также точности
Имеется несколько способов настройки политики индексирования для пути. Можно указать одно или несколько определений индексирования для каждого пути.

* **Тип данных**: строку, число, точки, многоугольник или LineString (может содержать только одной записи для каждого типа данных на путь).
* **Тип индекса**: хэш (запросов равенства), диапазон (равенства, диапазон или запросов ORDER BY) или пространственный (пространственных запросов).
* **Точность**: для хэш-индекс, это зависит от 1 до 8 для строки и числа. Значение по умолчанию — 3. Индекс диапазона это значение может быть -1 (максимальная точность). Оно может отличаться от 1 до 100 (максимальная точность) строку или числовые значения.

#### <a name="index-kind"></a>Вид индекса
Azure Cosmos DB поддерживает хэш-индекс и типов индекса диапазона для каждого пути, который может быть настроен для типов данных, строка или число, или оба.

* **Хэш-индекс** поддерживает эффективные запросы равенства и запросы JOIN. В большинстве случаев использования хэш-индексов не требуется более высокой точностью, чем значение по умолчанию 3 байта. Тип данных может быть строка или число.
* **Диапазон** поддерживает эффективный равенства запросы, запросы в диапазоне (с помощью >, <>, =, < =,! =) и запросов ORDER BY. ORDER By запросов по умолчанию также требуется максимальный индекс точность (-1). Тип данных может быть строка или число.

Azure Cosmos DB также поддерживает тип пространственного индекса для каждого пути, который может быть задан для типов данных точки Polygon и LineString. Значение по указанному пути должно быть действительным фрагментом объекта GeoJSON, например `{"type": "Point", "coordinates": [0.0, 10.0]}`.

* **Пространственный** индекс обеспечивает эффективность выполнения пространственных запросов (запросов нахождения в пределах и расстояния). Тип данных может быть точка Polygon и LineString.

> [!NOTE]
> Azure Cosmos DB поддерживает автоматическое индексирование точки, Polygon и LineString типов данных.
> 
> 

Ниже приведены виды поддерживаемых индексов и примеры запросов, для обслуживания которых их можно использовать:

| Вид индекса | Описание/вариант использования                                                                                                                                                                                                                                                                                                                                                                                                              |
| ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Хэш       | Хэш-индекс по over/prop/? (или /) позволяет эффективно обрабатывать следующие запросы:<br><br>SELECT FROM collection c WHERE c.prop = "value"<br><br>Хэш-индекс по over /props/[]/? (или / или /props/) позволяет эффективно обрабатывать следующие запросы:<br><br>SELECT tag FROM collection c JOIN tag IN c.props WHERE tag = 5                                                                                                                       |
| Диапазонный индекс      | Диапазонный индекс по /prop/? (или /) позволяет эффективно обрабатывать следующие запросы:<br><br>SELECT FROM collection c WHERE c.prop = "value"<br><br>SELECT FROM collection c WHERE c.prop > 5<br><br>SELECT FROM collection c ORDER BY c.prop                                                                                                                                                                                                              |
| пространственный индекс     | Диапазонный индекс по /prop/? (или /) позволяет эффективно обрабатывать следующие запросы:<br><br>SELECT FROM collection c<br><br>WHERE ST_DISTANCE(c.prop, {"type": "Point", "coordinates": [0.0, 10.0]}) < 40<br><br>SELECT FROM collection c WHERE ST_WITHIN(c.prop, {"type": "Polygon", ... }) --с индексированием точек<br><br>SELECT FROM collection c WHERE ST_WITHIN({"type": "Point", ... }, c.prop) --с индексированием многоугольников              |

По умолчанию возвращается сообщение об ошибке для запросов с помощью диапазона операторы, такие как > =, если отсутствует индекс диапазона (из любой точность) для обозначения проверки может потребоваться использовать в запросе. Диапазон запросы могут выполняться без индекс диапазона с помощью **x-ms-documentdb-enable сканирования** заголовок в API-интерфейса REST или **EnableScanInQuery** запроса параметр с помощью пакета SDK для .NET. Если в запросе, Azure Cosmos DB можно использовать индекс для фильтрации для других фильтров, ошибка не возвращается.

Те же правила применяются для пространственных запросов. По умолчанию ошибка возвращается для пространственных запросов в случае отсутствия пространственного индекса и отсутствия фильтров, которые могут быть получены из индекса. Они могут выполняться как проверку с помощью **x-ms-documentdb-enable сканирования** или **EnableScanInQuery**.

#### <a name="index-precision"></a>Точность индекса
Точность индекса можно использовать для компромисса между хранения индекса издержек и производительности запросов. Для чисел рекомендуется использовать конфигурацию точность по умолчанию-1 (максимум). 8 байт в формате JSON, числа, это эквивалентно конфигурации размером 8 байт. Меньшее значение точности, например от 1 до 7, выбор означает, что сопоставления значений некоторых диапазонов в один и тот же элемент указателя. Таким образом уменьшить место хранения индекса, но выполнение запроса может потребоваться обрабатывать дополнительные документы. Следовательно он использует пропускной способности в единицах запроса.

Конфигурацию точности индекса практичнее использовать с диапазонами строки. Поскольку строки могут быть любой длины, выбор точность индекса может повлиять на производительность запросов в диапазоне строки. Он также может повлиять на объем пространства хранения индекса на диске. Строка значения индексов можно задать от 1 до 100 или значение -1 (максимум). Если требуется выполнение запросов ORDER BY к свойства строки, необходимо указать точность-1 для соответствующие пути.

Пространственные индексы всегда использовать индекс точность по умолчанию для всех типов (точка, LineString и Polygon). Индекс по умолчанию для точности для пространственных индексов не может быть переопределен. 

В следующем примере показано, как для повышения точности для диапазона индексов в коллекции с помощью пакета SDK для .NET. 

**Создание коллекции с пользовательской точностью индекса**

    var rangeDefault = new DocumentCollection { Id = "rangeCollection" };

    // Override the default policy for strings to Range indexing and "max" (-1) precision
    rangeDefault.IndexingPolicy = new IndexingPolicy(new RangeIndex(DataType.String) { Precision = -1 });

    await client.CreateDocumentCollectionAsync(UriFactory.CreateDatabaseUri("db"), rangeDefault);   


> [!NOTE]
> Azure Cosmos DB возвращает ошибку, если запрос использует ORDER BY, но не имеет индекс диапазона для запрашиваемого пути с наибольшей точностью. 
> 
> 

Аналогичным образом можно полностью исключить пути из индексирования. Следующий пример показано, как исключить весь раздел документов ( *поддерево*) из индексирования с помощью \* оператор подстановочный знак.

    var collection = new DocumentCollection { Id = "excludedPathCollection" };
    collection.IndexingPolicy.IncludedPaths.Add(new IncludedPath { Path = "/*" });
    collection.IndexingPolicy.ExcludedPaths.Add(new ExcludedPath { Path = "/nonIndexedContent/*" });

    collection = await client.CreateDocumentCollectionAsync(UriFactory.CreateDatabaseUri("db"), excluded);



## <a name="opt-in-and-opt-out-of-indexing"></a>Включить и отключить индексирование
Вы можете выбрать, хотите ли вы, чтобы коллекция автоматически индексировала все документы. По умолчанию все документы индексируются автоматически, но можно отключить автоматическое индексирование. При отключении индексирования документам может осуществляться только через их ссылки SELF-LINK или запросами с помощью его идентификатора.

При выключенном автоматическом индексировании вы все равно можете выборочно добавлять в индекс только некоторые документы. И наоборот можно оставить автоматическое индексирование и решили выборочно исключать определенные документы. Индексирование и отключение конфигурации полезны при наличии только подмножество документов, которые необходимо выполнить запрос.

Следующий пример показано, как явно включать документа с помощью [SQL API .NET SDK](https://docs.microsoft.com/azure/cosmos-db/sql-api-sdk-dotnet) и [RequestOptions.IndexingDirective](http://msdn.microsoft.com/library/microsoft.azure.documents.client.requestoptions.indexingdirective.aspx) свойство.

    // If you want to override the default collection behavior to either
    // exclude (or include) a document in indexing,
    // use the RequestOptions.IndexingDirective property.
    client.CreateDocumentAsync(UriFactory.CreateDocumentCollectionUri("db", "coll"),
        new { id = "AndersenFamily", isRegistered = true },
        new RequestOptions { IndexingDirective = IndexingDirective.Include });

## <a name="modify-the-indexing-policy-of-a-collection"></a>Изменение политики индексирования коллекции
В базе данных Azure Cosmos можно внести изменения в политике индексирования для коллекции на лету. Изменение в политике на Azure Cosmos DB коллекцию индексирования может привести к изменение в форме индекса. Это изменение затрагивает путей, которые могут быть проиндексированы, их точность и согласованность модели самого индекса. Изменение в политике индексирования эффективно требует преобразования старый индекс в новый индекс. 

**Преобразования индексами в сети**

![Как работает индексирование — преобразование индексов Azure Cosmos DB в сети](./media/indexing-policies/index-transformations.png)

Индекс преобразований сделанных через Интернет. Это означает, что документы, индексированные по старая политика эффективно преобразуются в новой политике *без влияния на доступность записи или подготовленная пропускная способность* коллекции. Согласованность операций чтения и записи, выполненные с помощью API-интерфейса REST, пакеты SDK, или с помощью хранимых процедур и триггеров не затрагивает преобразование индекса. Нет снижение производительности или простоя в приложения, при внесении изменений индексирования политики.

Тем не менее, во время преобразования индекса запросы являются в конечном счете согласованными вне зависимости от конфигурации режима индексирования (Consistent или Lazy). Это также относится к запросам от всех интерфейсов: REST API, пакеты SDK и из хранимых процедур и триггеров. Так же, как с Lazy индексирования, индекс преобразования выполняются асинхронно в фоновом режиме для реплики с помощью запасные ресурсы, доступные для конкретной реплики. 

Индекс преобразования также выполняются на месте. Azure Cosmos DB не поддерживает две копии индекса и замены, старый индекс на новую. Это означает, что отсутствует дополнительное дисковое пространство необходимые или потребляет в коллекции, пока выполняются преобразования индекса.

При изменении политики индексирования изменения применяются для перемещения из старого индекса в новую, в основе индексирования конфигураций в режиме. Индексирования конфигураций в режиме играют важную роль, чем другие значения, такие как включенные или исключенные пути, типов индекса и точности. 

Если старый и новый политик оба использовать согласованные индексирование, Azure Cosmos DB выполняется преобразование индексами в сети. Не удается применить другой индексирования изменение политики, имеющий согласованный режим индексирования преобразование во время выполнения. Тем не менее можно переместить в Lazy или None режим индексирования во время преобразования выполняется в данный момент: 

* При перемещении отложенное изменение политики индекс вступает в силу немедленно. Azure Cosmos DB начинает асинхронно повторного создания индекса. 
* При перемещении значение None, то индекс удаляется немедленно. Рекомендуется помещать значение None, если вы хотите отменить преобразование в процессе выполнения и начать заново, с другой политикой индексирования. 

В следующем фрагменте кода показано, как коллекция индексирования для изменения политики из согласованный режим индексирования отложенный режим индексирования. Если вы используете .NET SDK, может запускаться индексирования изменение политики с помощью нового **ReplaceDocumentCollectionAsync** метод.

**Изменение политики индексирования из Consistent Lazy**

    // Switch to Lazy indexing mode.
    Console.WriteLine("Changing from Default to Lazy IndexingMode.");

    collection.IndexingPolicy.IndexingMode = IndexingMode.Lazy;

    await client.ReplaceDocumentCollectionAsync(collection);

**Отслеживание хода выполнения преобразования «индекс»**

Может отслеживать ход процент преобразования индекс в согласованное индекс с помощью **IndexTransformationProgress** свойство ответа из **ReadDocumentCollectionAsync** вызова. Другие пакеты SDK и API-интерфейса REST поддерживают эквивалентные свойства и методы для внесения изменений в политике индексирования. Можно проверить ход выполнения преобразования индекс в согласованное индекс путем вызова **ReadDocumentCollectionAsync**: 

    long smallWaitTimeMilliseconds = 1000;
    long progress = 0;

    while (progress < 100)
    {
        ResourceResponse<DocumentCollection> collectionReadResponse = await client.ReadDocumentCollectionAsync(
            UriFactory.CreateDocumentCollectionUri("db", "coll"));

        progress = collectionReadResponse.IndexTransformationProgress;

        await Task.Delay(TimeSpan.FromMilliseconds(smallWaitTimeMilliseconds));
    }

> [!NOTE]
> * **IndexTransformationProgress** свойство применимо только в том случае, при преобразовании в согласованное индекса. Используйте **ResourceResponse.LazyIndexingProgress** свойства для отслеживания преобразований в отложенной индекса.
> * **IndexTransformationProgress** и **LazyIndexingProgress** свойства заполняются только для несекционированной коллекции, то есть коллекцию, созданная без ключа секции.
>

Можно удалить индекс для коллекции, перейдя в режим индексирования None. Если вы хотите отменить преобразование в процессе выполнения и немедленно начать новый, это может быть полезным инструментом рабочей.

**Удалить индекс для коллекции**

    // Switch to Lazy indexing mode.
    Console.WriteLine("Dropping index by changing to to the None IndexingMode.");

    collection.IndexingPolicy.IndexingMode = IndexingMode.None;

    await client.ReplaceDocumentCollectionAsync(collection);

Когда вы вносите изменения в политики индексирования для своих коллекций Azure Cosmos DB? Ниже перечислены наиболее распространенные случаи использования:

* Использовать согласованные результаты во время обычной работы, но откат отложенной режим индексирования во время массового импорта данных.
* Приступайте к работе с коллекциями текущей Azure Cosmos DB новые возможности индексирования. Например можно использовать запросы к геопространственных, требующий тип пространственного индекса или ORDER BY / строки запросов в диапазоне, которые требуют строка тип индекса диапазона.
* Рука выделите свойства для индексирования и со временем меняться.
* Настройте точность индексирования для повышения производительности запросов или для уменьшения занятого хранилища.

> [!NOTE]
> Изменение политики индексирования с помощью **ReplaceDocumentCollectionAsync**, необходимо использовать версию 1.3.0 или более поздней версии .NET SDK.
> 
> Для преобразования индекса для успешного выполнения убедитесь, что доступно достаточно свободного пространства для коллекции. Если коллекция достигнет квоты хранилища, преобразование «индекс» будет приостановлена. Преобразование индекса автоматически возобновляется после хранилища, доступно свободное место, например, если удалить некоторые документы.
> 
> 

## <a name="performance-tuning"></a>Настройка производительности
API-интерфейсы SQL предоставляют сведения о метрики производительности, такие как используемое хранилище индекса и стоимость пропускной способности (запроса ед.) для каждой операции. Эти сведения можно использовать для сравнения различные политики индексирования, а также для настройки производительности.

Чтобы проверить квота хранилища и использования коллекции, запустите **HEAD** или **получить** запрос к коллекции ресурсов. Затем проверьте **x-ms запрос квоты** и **x-ms запрос usage** заголовки. В пакете SDK для .NET свойства [DocumentSizeQuota](http://msdn.microsoft.com/library/dn850325.aspx) и [DocumentSizeUsage](http://msdn.microsoft.com/library/azure/dn850324.aspx) на вкладке [ResourceResponse<T\>](http://msdn.microsoft.com/library/dn799209.aspx) содержат соответствующие значения.

     // Measure the document size usage (which includes the index size) against   
     // different policies.
     ResourceResponse<DocumentCollection> collectionInfo = await client.ReadDocumentCollectionAsync(UriFactory.CreateDocumentCollectionUri("db", "coll"));  
     Console.WriteLine("Document size quota: {0}, usage: {1}", collectionInfo.DocumentQuota, collectionInfo.DocumentUsage);


Для измерения дополнительную нагрузку, связанную с индексированием по каждой операции записи (Создание, обновление или удаление), проверки **x-ms запрос платы** заголовок (или его эквивалент [RequestCharge](http://msdn.microsoft.com/library/dn799099.aspx) свойство в [ ResourceResponse < T\> ](http://msdn.microsoft.com/library/dn799209.aspx) в .NET SDK) для измерения числа единиц запросов, используемых для этих операций.

     // Measure the performance (request units) of writes.     
     ResourceResponse<Document> response = await client.CreateDocumentAsync(UriFactory.CreateDocumentCollectionUri("db", "coll"), myDocument);              
     Console.WriteLine("Insert of document consumed {0} request units", response.RequestCharge);

     // Measure the performance (request units) of queries.    
     IDocumentQuery<dynamic> queryable =  client.CreateDocumentQuery(UriFactory.CreateDocumentCollectionUri("db", "coll"), queryString).AsDocumentQuery();

     double totalRequestCharge = 0;
     while (queryable.HasMoreResults)
     {
        FeedResponse<dynamic> queryResponse = await queryable.ExecuteNextAsync<dynamic>(); 
        Console.WriteLine("Query batch consumed {0} request units",queryResponse.RequestCharge);
        totalRequestCharge += queryResponse.RequestCharge;
     }

     Console.WriteLine("Query consumed {0} request units in total", totalRequestCharge);

## <a name="changes-to-the-indexing-policy-specification"></a>Изменения в спецификации политики индексации
Изменения в схеме для политика индексирования появилась 7 июля 2015 г. с помощью API REST версии 2015-06-03. Представленные классы в версиях пакетов SDK имеют новые реализации, соответствующие схеме. 

В спецификации JSON были реализованы следующие изменения:

* Политика индексирования поддерживает индексы диапазона для строк.
* Каждый путь может содержать несколько определений индекса. Он может иметь одну для каждого типа данных.
* Точность индексирования поддерживает от 1 до 8 для чисел, от 1 до 100 строк и -1 (максимальная точность).
* Сегменты пути не требуют двойных кавычек для экранирования каждого пути. Например, можно добавить путь к   **/заголовок /?** вместо **/ «title» /?**.
* Корневой путь, представляющий «все пути к» может быть представлено как  **/ \***  (в дополнение к  **/** ).

Если у вас есть код, подготавливает коллекций с помощью настраиваемой политики индексирования, написанным с использованием пакета SDK для .NET версии 1.1.0 или более ранней версии, чтобы переместить пакет SDK версии 1.2.0, необходимо изменить код приложения для обработки этих изменений. Если у вас нет кода, предназначенный для настройки политики индексирования или если планируется продолжить использование более ранней версии пакета SDK, изменения не требуются.

Для практического сравнения здесь приведен пример настраиваемой политики индексирования, написанные с использованием API REST версия 2015-06-03 следуют та же политика индексирования, написанные с использованием более ранней версии 2015-04-08 API REST.

**Текущий индексирования политики JSON (REST API версии 2015-06-03)**

    {
       "automatic":true,
       "indexingMode":"Consistent",
       "includedPaths":[
          {
             "path":"/*",
             "indexes":[
                {
                   "kind":"Hash",
                   "dataType":"String",
                   "precision":3
                },
                {
                   "kind":"Hash",
                   "dataType":"Number",
                   "precision":7
                }
             ]
          }
       ],
       "ExcludedPaths":[
          {
             "path":"/nonIndexedContent/*"
          }
       ]
    }


**Политика JSON (REST API версии 2015-04-08) ранее индексирования**

    {
       "automatic":true,
       "indexingMode":"Consistent",
       "IncludedPaths":[
          {
             "IndexType":"Hash",
             "Path":"/",
             "NumericPrecision":7,
             "StringPrecision":3
          }
       ],
       "ExcludedPaths":[
          "/\"nonIndexedContent\"/*"
       ]
    }


## <a name="next-steps"></a>Дальнейшие действия
Примеры управления политики индекса и для получения дополнительных сведений о языке запросов Azure Cosmos DB см. по следующим ссылкам:

* [Примеры кода для управления индекс SQL API .NET](https://github.com/Azure/azure-documentdb-net/blob/master/samples/code-samples/IndexManagement/Program.cs)
* [Операции SQL API REST коллекции](https://msdn.microsoft.com/library/azure/dn782195.aspx)
* [SQL-запросы для API DocumentDB в Azure Cosmos DB](sql-api-sql-query.md)


---
title: "Метрики SQL-запросов для API DocumentDB в Azure Cosmos DB | Документация Майкрософт"
description: "Дополнительные сведения об инструментировании и отладке производительности SQL-запросов в базе данных Azure Cosmos DB."
keywords: "синтаксис SQL, запрос SQL, язык запросов JSON, понятия баз данных и запросы SQL, статистические функции"
services: cosmos-db
documentationcenter: 
author: arramac
manager: jhubbard
editor: monicar
ms.assetid: b2fa8e8f-7291-45a3-9bd1-7284ed9077f8
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/15/2017
ms.author: arramac
ms.openlocfilehash: d928113e809e5ad43901e79dc256a8a39c210181
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="tuning-query-performance-with-azure-cosmos-db"></a><span data-ttu-id="574d8-104">Настройка производительности запросов в Azure Cosmos DB</span><span class="sxs-lookup"><span data-stu-id="574d8-104">Tuning query performance with Azure Cosmos DB</span></span>
<span data-ttu-id="574d8-105">Azure Cosmos DB предоставляет [API SQL для запроса данных](documentdb-sql-query.md) без использования схемы или вторичных индексов.</span><span class="sxs-lookup"><span data-stu-id="574d8-105">Azure Cosmos DB provides a [SQL API for querying data](documentdb-sql-query.md), without requiring schema or secondary indexes.</span></span> <span data-ttu-id="574d8-106">В этой статье содержатся следующие сведения для разработчиков:</span><span class="sxs-lookup"><span data-stu-id="574d8-106">This article provides the following information for developers:</span></span>

* <span data-ttu-id="574d8-107">общие сведения о выполнении SQL-запросов в Azure Cosmos DB;</span><span class="sxs-lookup"><span data-stu-id="574d8-107">High-level details on how Azure Cosmos DB's SQL query execution works</span></span>
* <span data-ttu-id="574d8-108">сведения о заголовках запросов и ответов и параметры клиентского пакета SDK;</span><span class="sxs-lookup"><span data-stu-id="574d8-108">Details on query request and response headers, and client SDK options</span></span>
* <span data-ttu-id="574d8-109">советы и рекомендации по повышению производительности запросов.</span><span class="sxs-lookup"><span data-stu-id="574d8-109">Tips and best practices for query performance</span></span>
* <span data-ttu-id="574d8-110">Примеры того, как использовать статистику выполнения SQL для отладки производительности запросов</span><span class="sxs-lookup"><span data-stu-id="574d8-110">Examples of how to utilize SQL execution statistics to debug query performance</span></span>

## <a name="about-sql-query-execution"></a><span data-ttu-id="574d8-111">Сведения о выполнении SQL-запросов</span><span class="sxs-lookup"><span data-stu-id="574d8-111">About SQL query execution</span></span>

<span data-ttu-id="574d8-112">В Azure Cosmos DB данные хранятся в контейнерах, для которых можно увеличивать [пропускную способность запросов или размер хранилища](partition-data.md).</span><span class="sxs-lookup"><span data-stu-id="574d8-112">In Azure Cosmos DB, you store data in containers, which can grow to any [storage size or request throughput](partition-data.md).</span></span> <span data-ttu-id="574d8-113">Azure Cosmos DB эффективно масштабирует данные по физическим секциям, чтобы справляться с ростом объема данных или увеличивать пропускную способность.</span><span class="sxs-lookup"><span data-stu-id="574d8-113">Azure Cosmos DB seamlessly scales data across physical partitions under the covers to handle data growth or increase in provisioned throughput.</span></span> <span data-ttu-id="574d8-114">Можно выполнять SQL-запросы к любому контейнеру с помощью REST API или одного из поддерживаемых [пакетов SDK для DocumentDB](documentdb-sdk-dotnet.md).</span><span class="sxs-lookup"><span data-stu-id="574d8-114">You can issue SQL queries to any container using the REST API or one of the supported [DocumentDB SDKs](documentdb-sdk-dotnet.md).</span></span>

<span data-ttu-id="574d8-115">Рассмотрим пример секционирования. Вы определяете ключ секции, например city, который определяет, каким образом данные разделяются на физические секции.</span><span class="sxs-lookup"><span data-stu-id="574d8-115">A brief overview of partitioning: you define a partition key like "city", which determines how data is split across physical partitions.</span></span> <span data-ttu-id="574d8-116">Данные, относящиеся к одному ключу секции (например, "city" = "Seattle"), хранятся в физической секции, но обычно одна физическая секция содержит несколько ключей секций.</span><span class="sxs-lookup"><span data-stu-id="574d8-116">Data belonging to a single partition key (for example, "city" == "Seattle") is stored within a physical partition, but typically a single physical partition has multiple partition keys.</span></span> <span data-ttu-id="574d8-117">Когда секция достигает размера хранилища, служба просто разделяет ее на две новые секции и равномерно делит ключ между этими секциями.</span><span class="sxs-lookup"><span data-stu-id="574d8-117">When a partition reaches its storage size, the service seamlessly splits the partition into two new partitions, and divides the partition key evenly across these partitions.</span></span> <span data-ttu-id="574d8-118">Так как секции являются временными, API-интерфейсы используют абстракцию "диапазона ключей секций", который обозначает диапазон хэшей ключей секций.</span><span class="sxs-lookup"><span data-stu-id="574d8-118">Since partitions are transient, the APIs use an abstraction of a "partition key range", which denotes the ranges of partition key hashes.</span></span> 

<span data-ttu-id="574d8-119">При выполнении запроса к базе данных Azure Cosmos DB пакет SDK выполняет следующие логические действия.</span><span class="sxs-lookup"><span data-stu-id="574d8-119">When you issue a query to Azure Cosmos DB, the SDK performs these logical steps:</span></span>

* <span data-ttu-id="574d8-120">Анализ SQL-запроса для определения плана выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="574d8-120">Parse the SQL query to determine the query execution plan.</span></span> 
* <span data-ttu-id="574d8-121">Если запрос содержит фильтр в ключе секции, например `SELECT * FROM c WHERE c.city = "Seattle"`, он направляется в одну секцию.</span><span class="sxs-lookup"><span data-stu-id="574d8-121">If the query includes a filter against the partition key, like `SELECT * FROM c WHERE c.city = "Seattle"`, it is routed to a single partition.</span></span> <span data-ttu-id="574d8-122">Если запрос не имеет фильтра в ключе секции, то он выполняется во всех секциях, а затем результаты объединяются на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="574d8-122">If the query does not have a filter on partition key, then it is executed in all partitions, and results are merged client side.</span></span>
* <span data-ttu-id="574d8-123">Запрос выполняется в каждой секции последовательно или параллельно в зависимости от конфигурации клиента.</span><span class="sxs-lookup"><span data-stu-id="574d8-123">The query is executed within each partition in series or parallel, based on client configuration.</span></span> <span data-ttu-id="574d8-124">В каждой секции запрос может совершить один или несколько циклов приема-передачи в зависимости от сложности запроса, выбранного размера страницы и подготовленной пропускной способности коллекции.</span><span class="sxs-lookup"><span data-stu-id="574d8-124">Within each partition, the query might make one or more round trips depending on the query complexity, configured page size, and provisioned throughput of the collection.</span></span> <span data-ttu-id="574d8-125">Каждое выполнение возвращает число [единиц запроса](request-units.md), используемых выполнением запроса, и при необходимости статистику выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="574d8-125">Each execution returns the number of [request units](request-units.md) consumed by query execution, and optionally, query execution statistics.</span></span> 
* <span data-ttu-id="574d8-126">Пакет SDK выполняет суммирование результатов запросов в секциях.</span><span class="sxs-lookup"><span data-stu-id="574d8-126">The SDK performs a summarization of the query results across partitions.</span></span> <span data-ttu-id="574d8-127">Например, если запрос включает предложение ORDER BY в секциях, тогда результаты из отдельных секций сортируются слиянием для возвращения результатов в глобально отсортированном виде.</span><span class="sxs-lookup"><span data-stu-id="574d8-127">For example, if the query involves an ORDER BY across partitions, then results from individual partitions are merge-sorted to return results in globally sorted order.</span></span> <span data-ttu-id="574d8-128">Если запрос является агрегированием, например `COUNT`, счетчики отдельных секций суммируются в общий счетчик.</span><span class="sxs-lookup"><span data-stu-id="574d8-128">If the query is an aggregation like `COUNT`, the counts from individual partitions are summed to produce the overall count.</span></span>

<span data-ttu-id="574d8-129">Пакеты SDK предоставляют различные параметры выполнения запросов.</span><span class="sxs-lookup"><span data-stu-id="574d8-129">The SDKs provide various options for query execution.</span></span> <span data-ttu-id="574d8-130">Например, в .NET эти параметры доступны в классе `FeedOptions`.</span><span class="sxs-lookup"><span data-stu-id="574d8-130">For example, in .NET these options are available in the `FeedOptions` class.</span></span> <span data-ttu-id="574d8-131">В следующей таблице описаны эти параметры и их влияние на время выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="574d8-131">The following table describes these options and how they impact query execution time.</span></span> 

| <span data-ttu-id="574d8-132">Параметр</span><span class="sxs-lookup"><span data-stu-id="574d8-132">Option</span></span> | <span data-ttu-id="574d8-133">Описание</span><span class="sxs-lookup"><span data-stu-id="574d8-133">Description</span></span> |
| ------ | ----------- |
| `EnableCrossPartitionQuery` | <span data-ttu-id="574d8-134">Необходимо присвоить значение true для любого запроса, который требуется выполнить более чем в одной секции.</span><span class="sxs-lookup"><span data-stu-id="574d8-134">Must be set to true for any query that requires to be executed across more than one partition.</span></span> <span data-ttu-id="574d8-135">Это явный параметр, позволяющий сознательно понизить производительность во время разработки.</span><span class="sxs-lookup"><span data-stu-id="574d8-135">This is an explicit flag to enable you to make conscious performance tradeoffs during development time.</span></span> |
| `EnableScanInQuery` | <span data-ttu-id="574d8-136">Должно быть присвоено значение true, если вы отказались от индексирования, но все равно хотите выполнить запрос с помощью сканирования.</span><span class="sxs-lookup"><span data-stu-id="574d8-136">Must be set to true if you have opted out of indexing, but want to run the query via a scan anyway.</span></span> <span data-ttu-id="574d8-137">Применяется, только если индексирование для запрашиваемого пути фильтра отключено.</span><span class="sxs-lookup"><span data-stu-id="574d8-137">Only applicable if indexing for the requested filter path is disabled.</span></span> | 
| `MaxItemCount` | <span data-ttu-id="574d8-138">Максимальное количество элементов, возвращаемых на сервер за круговой путь.</span><span class="sxs-lookup"><span data-stu-id="574d8-138">The maximum number of items to return per round trip to the server.</span></span> <span data-ttu-id="574d8-139">Если установить значение "-1", можно позволить серверу управлять количеством элементов.</span><span class="sxs-lookup"><span data-stu-id="574d8-139">By setting to -1, you can let the server manage the number of items.</span></span> <span data-ttu-id="574d8-140">Также можно уменьшить это значение, чтобы извлечь только небольшое количество элементов за цикл обработки.</span><span class="sxs-lookup"><span data-stu-id="574d8-140">Or, you can lower this value to retrieve only a small number of items per round trip.</span></span> 
| `MaxBufferedItemCount` | <span data-ttu-id="574d8-141">Это клиентский параметр, который используется для ограничения потребления памяти при выполнении запроса ORDER BY между секциями.</span><span class="sxs-lookup"><span data-stu-id="574d8-141">This is a client-side option, and used to limit the memory consumption when performing cross-partition ORDER BY.</span></span> <span data-ttu-id="574d8-142">Более высокое значение помогает сократить задержку сортировки между секциями.</span><span class="sxs-lookup"><span data-stu-id="574d8-142">A higher value helps reduce the latency of cross-partition sorting.</span></span> |
| `MaxDegreeOfParallelism` | <span data-ttu-id="574d8-143">Возвращает или задает число параллельных операций, выполняемых на стороне клиента во время выполнения параллельных запросов в службу базы данных Azure DocumentDB.</span><span class="sxs-lookup"><span data-stu-id="574d8-143">Gets or sets the number of concurrent operations run client side during parallel query execution in the Azure DocumentDB database service.</span></span> <span data-ttu-id="574d8-144">Положительное значение свойства ограничивает число параллельных операций до заданного значения.</span><span class="sxs-lookup"><span data-stu-id="574d8-144">A positive property value limits the number of concurrent operations to the set value.</span></span> <span data-ttu-id="574d8-145">Если оно имеет значение меньше 0, система автоматически определяет число параллельных операций для выполнения.</span><span class="sxs-lookup"><span data-stu-id="574d8-145">If it is set to less than 0, the system automatically decides the number of concurrent operations to run.</span></span> |
| `PopulateQueryMetrics` | <span data-ttu-id="574d8-146">Дает возможность подробного ведения журнала статистики времени, затраченного на различных этапах выполнения запроса, например времени компиляции, цикла индекса и загрузки документа.</span><span class="sxs-lookup"><span data-stu-id="574d8-146">Enables detailed logging of statistics of time spent in various phases of query execution like compilation time, index loop time, and document load time.</span></span> <span data-ttu-id="574d8-147">Вы можете предоставить выходные данные статистики запросов в команду поддержки Azure для диагностики проблем с производительностью запросов.</span><span class="sxs-lookup"><span data-stu-id="574d8-147">You can share output from query statistics with Azure Support to diagnose query performance issues.</span></span> |
| `RequestContinuation` | <span data-ttu-id="574d8-148">Вы можете возобновить выполнение запроса путем передачи маркера непрозрачного продолжения, возвращаемого любым запросом.</span><span class="sxs-lookup"><span data-stu-id="574d8-148">You can resume query execution by passing in the opaque continuation token returned by any query.</span></span> <span data-ttu-id="574d8-149">Маркер продолжения инкапсулирует все состояния, необходимые для выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="574d8-149">The continuation token encapsulates all state required for query execution.</span></span> |
| `ResponseContinuationTokenLimitInKb` | <span data-ttu-id="574d8-150">Можно ограничить максимальный размер маркеров продолжения, возвращаемых сервером.</span><span class="sxs-lookup"><span data-stu-id="574d8-150">You can limit the maximum size of the continuation token returned by the server.</span></span> <span data-ttu-id="574d8-151">Может потребоваться установить этот параметр, если узел приложения имеет ограничения относительно размера заголовка ответа.</span><span class="sxs-lookup"><span data-stu-id="574d8-151">You might need to set this if your application host has limits on response header size.</span></span> <span data-ttu-id="574d8-152">Установка этого параметра может увеличить общую длительность и количество ЕЗ, используемых для запроса.</span><span class="sxs-lookup"><span data-stu-id="574d8-152">Setting this may increase the overall duration and RUs consumed for the query.</span></span>  |

<span data-ttu-id="574d8-153">Рассмотрим пример запроса ключа секции, отправленного к коллекции с использованием `/city` в качестве ключа секции и подготовленного с пропускной способностью 100 000 единиц запросов в секунду.</span><span class="sxs-lookup"><span data-stu-id="574d8-153">For example, let's take an example query on partition key requested on a collection with `/city` as the partition key and provisioned with 100,000 RU/s of throughput.</span></span> <span data-ttu-id="574d8-154">Выполните этот запрос с помощью `CreateDocumentQuery<T>` в .NET, как показано ниже:</span><span class="sxs-lookup"><span data-stu-id="574d8-154">You request this query using `CreateDocumentQuery<T>` in .NET like the following:</span></span>

```cs
IDocumentQuery<dynamic> query = client.CreateDocumentQuery(
    UriFactory.CreateDocumentCollectionUri(DatabaseName, CollectionName), 
    "SELECT * FROM c WHERE c.city = 'Seattle'", 
    new FeedOptions 
    { 
        PopulateQueryMetrics = true, 
        MaxItemCount = -1, 
        MaxDegreeOfParallelism = -1, 
        EnableCrossPartitionQuery = true 
    }).AsDocumentQuery();

FeedResponse<dynamic> result = await query.ExecuteNextAsync();
```

<span data-ttu-id="574d8-155">Фрагмент кода пакета SDK, показанного выше, соответствует следующему запросу REST API:</span><span class="sxs-lookup"><span data-stu-id="574d8-155">The SDK snippet shown above, corresponds to the following REST API request:</span></span>

```
POST https://arramacquerymetrics-westus.documents.azure.com/dbs/db/colls/sample/docs HTTP/1.1
x-ms-continuation: 
x-ms-documentdb-isquery: True
x-ms-max-item-count: -1
x-ms-documentdb-query-enablecrosspartition: True
x-ms-documentdb-query-parallelizecrosspartitionquery: True
x-ms-documentdb-query-iscontinuationexpected: True
x-ms-documentdb-populatequerymetrics: True
x-ms-date: Tue, 27 Jun 2017 21:52:18 GMT
authorization: type%3dmaster%26ver%3d1.0%26sig%3drp1Hi83Y8aVV5V6LzZ6xhtQVXRAMz0WNMnUuvriUv%2b4%3d
x-ms-session-token: 7:8,6:2008,5:8,4:2008,3:8,2:2008,1:8,0:8,9:8,8:4008
Cache-Control: no-cache
x-ms-consistency-level: Session
User-Agent: documentdb-dotnet-sdk/1.14.1 Host/32-bit MicrosoftWindowsNT/6.2.9200.0
x-ms-version: 2017-02-22
Accept: application/json
Content-Type: application/query+json
Host: arramacquerymetrics-westus.documents.azure.com
Content-Length: 52
Expect: 100-continue

{"query":"SELECT * FROM c WHERE c.city = 'Seattle'"}
```

<span data-ttu-id="574d8-156">Каждая страница выполнения запроса соответствует REST API `POST` с заголовком `Accept: application/query+json` и SQL-запросом в тексте.</span><span class="sxs-lookup"><span data-stu-id="574d8-156">Each query execution page corresponds to a REST API `POST` with the `Accept: application/query+json` header, and the SQL query in the body.</span></span> <span data-ttu-id="574d8-157">Каждый запрос совершает один или несколько циклов переходов к серверу с помощью маркера `x-ms-continuation`, который выводится между клиентом и сервером, чтобы возобновить выполнение.</span><span class="sxs-lookup"><span data-stu-id="574d8-157">Each query makes one or more round trips to the server with the `x-ms-continuation` token echoed between the client and server to resume execution.</span></span> <span data-ttu-id="574d8-158">Параметры конфигурации в FeedOptions передаются на сервер в виде заголовков запроса.</span><span class="sxs-lookup"><span data-stu-id="574d8-158">The configuration options in FeedOptions are passed to the server in the form of request headers.</span></span> <span data-ttu-id="574d8-159">Например, `MaxItemCount` соответствует `x-ms-max-item-count`.</span><span class="sxs-lookup"><span data-stu-id="574d8-159">For example, `MaxItemCount` corresponds to `x-ms-max-item-count`.</span></span> 

<span data-ttu-id="574d8-160">Запрос возвращает следующий ответ (усеченный для удобства чтения):</span><span class="sxs-lookup"><span data-stu-id="574d8-160">The request returns the following (truncated for readability) response:</span></span>

```
HTTP/1.1 200 Ok
Cache-Control: no-store, no-cache
Pragma: no-cache
Transfer-Encoding: chunked
Content-Type: application/json
Server: Microsoft-HTTPAPI/2.0
Strict-Transport-Security: max-age=31536000
x-ms-last-state-change-utc: Tue, 27 Jun 2017 21:01:57.561 GMT
x-ms-resource-quota: documentSize=10240;documentsSize=10485760;documentsCount=-1;collectionSize=10485760;
x-ms-resource-usage: documentSize=1;documentsSize=884;documentsCount=2000;collectionSize=1408;
x-ms-item-count: 2000
x-ms-schemaversion: 1.3
x-ms-alt-content-path: dbs/db/colls/sample
x-ms-content-path: +9kEANVq0wA=
x-ms-xp-role: 1
x-ms-documentdb-query-metrics: totalExecutionTimeInMs=33.67;queryCompileTimeInMs=0.06;queryLogicalPlanBuildTimeInMs=0.02;queryPhysicalPlanBuildTimeInMs=0.10;queryOptimizationTimeInMs=0.00;VMExecutionTimeInMs=32.56;indexLookupTimeInMs=0.36;documentLoadTimeInMs=9.58;systemFunctionExecuteTimeInMs=0.00;userFunctionExecuteTimeInMs=0.00;retrievedDocumentCount=2000;retrievedDocumentSize=1125600;outputDocumentCount=2000;writeOutputTimeInMs=18.10;indexUtilizationRatio=1.00
x-ms-request-charge: 604.42
x-ms-serviceversion: version=1.14.34.4
x-ms-activity-id: 0df8b5f6-83b9-4493-abda-cce6d0f91486
x-ms-session-token: 2:2008
x-ms-gatewayversion: version=1.14.33.2
Date: Tue, 27 Jun 2017 21:59:49 GMT
```

<span data-ttu-id="574d8-161">Из запроса возвращаются следующие заголовки ответа ключа:</span><span class="sxs-lookup"><span data-stu-id="574d8-161">The key response headers returned from the query include the following:</span></span>

| <span data-ttu-id="574d8-162">Параметр</span><span class="sxs-lookup"><span data-stu-id="574d8-162">Option</span></span> | <span data-ttu-id="574d8-163">Описание</span><span class="sxs-lookup"><span data-stu-id="574d8-163">Description</span></span> |
| ------ | ----------- |
| `x-ms-item-count` | <span data-ttu-id="574d8-164">Число элементов, возвращенных в ответе.</span><span class="sxs-lookup"><span data-stu-id="574d8-164">The number of items returned in the response.</span></span> <span data-ttu-id="574d8-165">Зависит от предоставленного значения `x-ms-max-item-count`, количества элементов, которое может уместиться, исходя из максимального размера полезных данных ответа, подготовленной пропускной способности и времени выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="574d8-165">This is dependent on the supplied `x-ms-max-item-count`, the number of items that can be fit within the maximum response payload size, the provisioned throughput, and query execution time.</span></span> |  
| `x-ms-continuation:` | <span data-ttu-id="574d8-166">Маркер продолжения для возобновления выполнения запроса, если доступны дополнительные результаты.</span><span class="sxs-lookup"><span data-stu-id="574d8-166">The continuation token to resume execution of the query, if additional results are available.</span></span> | 
| `x-ms-documentdb-query-metrics` | <span data-ttu-id="574d8-167">Статистика запросов для выполнения.</span><span class="sxs-lookup"><span data-stu-id="574d8-167">The query statistics for the execution.</span></span> <span data-ttu-id="574d8-168">Это строка с разделителями, содержащая статистику времени, затраченного на различных этапах выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="574d8-168">This is a delimited string containing statistics of time spent in the various phases of query execution.</span></span> <span data-ttu-id="574d8-169">Возвращается, если `x-ms-documentdb-populatequerymetrics` имеет значение `True`.</span><span class="sxs-lookup"><span data-stu-id="574d8-169">Returned if `x-ms-documentdb-populatequerymetrics` is set to `True`.</span></span> | 
| `x-ms-request-charge` | <span data-ttu-id="574d8-170">Число [единиц запросов](request-units.md), использованных запросом.</span><span class="sxs-lookup"><span data-stu-id="574d8-170">The number of [request units](request-units.md) consumed by the query.</span></span> | 

<span data-ttu-id="574d8-171">Сведения о заголовках запросов и параметрах интерфейса REST API см. в статье [Querying Azure Cosmos DB resources using the REST API](https://docs.microsoft.com/rest/api/documentdb/querying-documentdb-resources-using-the-rest-api) (Запрос ресурсов Azure Cosmos DB с помощью REST API).</span><span class="sxs-lookup"><span data-stu-id="574d8-171">For details on the REST API request headers and options, see [Querying resources using the DocumentDB REST API](https://docs.microsoft.com/rest/api/documentdb/querying-documentdb-resources-using-the-rest-api).</span></span>

## <a name="best-practices-for-query-performance"></a><span data-ttu-id="574d8-172">Рекомендации по повышению производительности запросов</span><span class="sxs-lookup"><span data-stu-id="574d8-172">Best practices for query performance</span></span>
<span data-ttu-id="574d8-173">Ниже приведены наиболее распространенные факторы, влияющие на производительность запросов в Azure Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="574d8-173">The following are the most common factors that impact Azure Cosmos DB query performance.</span></span> <span data-ttu-id="574d8-174">Мы подробно рассмотрим каждую из этих тем в этой статье.</span><span class="sxs-lookup"><span data-stu-id="574d8-174">We dig deeper into each of these topics in this article.</span></span>

| <span data-ttu-id="574d8-175">Коэффициент</span><span class="sxs-lookup"><span data-stu-id="574d8-175">Factor</span></span> | <span data-ttu-id="574d8-176">Подсказка</span><span class="sxs-lookup"><span data-stu-id="574d8-176">Tip</span></span> | 
| ------ | -----| 
| <span data-ttu-id="574d8-177">Подготовленная пропускная способность</span><span class="sxs-lookup"><span data-stu-id="574d8-177">Provisioned throughput</span></span> | <span data-ttu-id="574d8-178">Измерьте единицы запроса на запрос и убедитесь в наличии необходимой подготовленной пропускной способности для запросов.</span><span class="sxs-lookup"><span data-stu-id="574d8-178">Measure RU per query, and ensure that you have the required provisioned throughput for your queries.</span></span> | 
| <span data-ttu-id="574d8-179">Секционирование и ключи секций</span><span class="sxs-lookup"><span data-stu-id="574d8-179">Partitioning and partition keys</span></span> | <span data-ttu-id="574d8-180">Отдайте предпочтение запросам со значением ключа секции в предложении фильтра, чтобы обеспечить низкую задержку.</span><span class="sxs-lookup"><span data-stu-id="574d8-180">Favor queries with the partition key value in the filter clause for low latency.</span></span> |
| <span data-ttu-id="574d8-181">Параметры пакета SDK и запроса</span><span class="sxs-lookup"><span data-stu-id="574d8-181">SDK and query options</span></span> | <span data-ttu-id="574d8-182">Следуйте рекомендациям по работе с пакетами SDK, таким как прямое подключение, а также настройте параметры выполнения запросов на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="574d8-182">Follow SDK best practices like direct connectivity, and tune client-side query execution options.</span></span> |
| <span data-ttu-id="574d8-183">Задержки сети</span><span class="sxs-lookup"><span data-stu-id="574d8-183">Network latency</span></span> | <span data-ttu-id="574d8-184">Учтите в измерении нагрузку на сетевые ресурсы и используйте интерфейсы API множественной адресации для считывания из ближайшего региона.</span><span class="sxs-lookup"><span data-stu-id="574d8-184">Account for network overhead in measurement, and use multi-homing APIs to read from the nearest region.</span></span> |
| <span data-ttu-id="574d8-185">Политика индексации</span><span class="sxs-lookup"><span data-stu-id="574d8-185">Indexing Policy</span></span> | <span data-ttu-id="574d8-186">Проверьте наличие необходимых путей и политик индексирования запросов.</span><span class="sxs-lookup"><span data-stu-id="574d8-186">Ensure that you have the required indexing paths/policy for the query.</span></span> |
| <span data-ttu-id="574d8-187">Метрики выполнения запросов</span><span class="sxs-lookup"><span data-stu-id="574d8-187">Query execution metrics</span></span> | <span data-ttu-id="574d8-188">Проанализируйте метрики выполнения запросов, чтобы определить потенциальные перезаписи запросов и форм данных.</span><span class="sxs-lookup"><span data-stu-id="574d8-188">Analyze the query execution metrics to identify potential rewrites of query and data shapes.</span></span>  |

### <a name="provisioned-throughput"></a><span data-ttu-id="574d8-189">Подготовленная пропускная способность</span><span class="sxs-lookup"><span data-stu-id="574d8-189">Provisioned throughput</span></span>
<span data-ttu-id="574d8-190">В Cosmos DB контейнеры данных создаются c зарезервированной пропускной способностью, выраженной в единицах запроса (ЕЗ) в секунду.</span><span class="sxs-lookup"><span data-stu-id="574d8-190">In Cosmos DB, you create containers of data, each with reserved throughput expressed in request units (RU) per-second.</span></span> <span data-ttu-id="574d8-191">Считывание документа размером 1 КБ равняется 1 ЕЗ, а каждая операция (включая запросы) нормализуется до фиксированного количества ЕЗ в зависимости от сложности.</span><span class="sxs-lookup"><span data-stu-id="574d8-191">A read of a 1-KB document is 1 RU, and every operation (including queries) is normalized to a fixed number of RUs based on its complexity.</span></span> <span data-ttu-id="574d8-192">Например, при наличии 1000 ЕЗ в секунду, подготовленных для контейнера, и запроса, например `SELECT * FROM c WHERE c.city = 'Seattle'`, который использует 5 ЕЗ, можно выполнить 200 таких запросов в секунду ((1000 ЕЗ/с) / (5 ЕЗ/запрос) = 200 ЕЗ).</span><span class="sxs-lookup"><span data-stu-id="574d8-192">For example, if you have 1000 RU/s provisioned for your container, and you have a query like `SELECT * FROM c WHERE c.city = 'Seattle'` that consumes 5 RUs, then you can perform (1000 RU/s) / (5 RU/query) = 200 query/s such queries per second.</span></span> 

<span data-ttu-id="574d8-193">Если вы отправляете более 200 запросов в секунду, служба применяет ограничение скорости входящих запросов.</span><span class="sxs-lookup"><span data-stu-id="574d8-193">If you submit more than 200 queries/sec, the service starts rate-limiting incoming requests above 200/s.</span></span> <span data-ttu-id="574d8-194">Пакеты SDK автоматически выполняют задержки и повторы, чтобы вы могли заметить большее время задержки таких запросов.</span><span class="sxs-lookup"><span data-stu-id="574d8-194">The SDKs automatically handle this case by performing a backoff/retry, therefore you might notice a higher latency for these queries.</span></span> <span data-ttu-id="574d8-195">Увеличение подготовленной пропускной способности до требуемого значения улучшит задержку при обработке запросов и пропускную способность.</span><span class="sxs-lookup"><span data-stu-id="574d8-195">Increasing the provisioned throughput to the required value improves your query latency and throughput.</span></span> 

<span data-ttu-id="574d8-196">Дополнительные сведения о единицах запроса см. в статье [Единицы запросов в базе данных Azure Cosmos DB](request-units.md).</span><span class="sxs-lookup"><span data-stu-id="574d8-196">To learn more about request units, see [Request units](request-units.md).</span></span>

### <a name="partitioning-and-partition-keys"></a><span data-ttu-id="574d8-197">Секционирование и ключи секций</span><span class="sxs-lookup"><span data-stu-id="574d8-197">Partitioning and partition keys</span></span>
<span data-ttu-id="574d8-198">Обычно в Azure Cosmos DB запросы выполняются в следующем порядке, от самых быстрых или самых эффективных к медленным и менее эффективным:</span><span class="sxs-lookup"><span data-stu-id="574d8-198">With Azure Cosmos DB, typically queries perform in the following order from fastest/most efficient to slower/less efficient.</span></span> 

* <span data-ttu-id="574d8-199">запросы GET к одному ключу секции и ключу элемента;</span><span class="sxs-lookup"><span data-stu-id="574d8-199">GET on a single partition key and item key</span></span>
* <span data-ttu-id="574d8-200">запрос с предложением фильтра к одному ключу секции;</span><span class="sxs-lookup"><span data-stu-id="574d8-200">Query with a filter clause on a single partition key</span></span>
* <span data-ttu-id="574d8-201">запрос без равенства или предложения диапазона фильтра для любого свойства;</span><span class="sxs-lookup"><span data-stu-id="574d8-201">Query without an equality or range filter clause on any property</span></span>
* <span data-ttu-id="574d8-202">запрос без фильтров.</span><span class="sxs-lookup"><span data-stu-id="574d8-202">Query without filters</span></span>

<span data-ttu-id="574d8-203">Запросам, которым необходимо обратиться ко всем секциям, требуется большая задержка и они могут использовать больше ЕЗ.</span><span class="sxs-lookup"><span data-stu-id="574d8-203">Queries that need to consult all partitions need higher latency, and can consume higher RUs.</span></span> <span data-ttu-id="574d8-204">Так как каждая секция имеет автоматическое индексирование всех свойств, то запрос будет эффективно обрабатываться с помощью индекса.</span><span class="sxs-lookup"><span data-stu-id="574d8-204">Since each partition has automatic indexing against all properties, the query can be served efficiently from the index in this case.</span></span> <span data-ttu-id="574d8-205">Можно создать запросы, быстрее охватывающие секции, с помощью параметров параллелизма.</span><span class="sxs-lookup"><span data-stu-id="574d8-205">You can make queries that span partitions faster by using the parallelism options.</span></span>

<span data-ttu-id="574d8-206">Если вы хотите узнать больше о секционировании и ключах секций, ознакомьтесь со статьей [Секционирование и масштабирование в базе данных Azure Cosmos DB](partition-data.md).</span><span class="sxs-lookup"><span data-stu-id="574d8-206">To learn more about partitioning and partition keys, see [Partitioning in Azure Cosmos DB](partition-data.md).</span></span>

### <a name="sdk-and-query-options"></a><span data-ttu-id="574d8-207">Параметры пакета SDK и запроса</span><span class="sxs-lookup"><span data-stu-id="574d8-207">SDK and query options</span></span>
<span data-ttu-id="574d8-208">Чтобы узнать, как обеспечить оптимальную производительность на стороне клиента в Azure Cosmos DB, перейдите к статьям [Советы по повышению производительности для Azure Cosmos DB](performance-tips.md) и [Проверка производительности и масштабирования с помощью Azure Cosmos DB](performance-testing.md).</span><span class="sxs-lookup"><span data-stu-id="574d8-208">See [Performance Tips](performance-tips.md) and [Performance testing](performance-testing.md) for how to get the best client-side performance from Azure Cosmos DB.</span></span> <span data-ttu-id="574d8-209">Сюда входит использование последних пакетов SDK, настройка конфигурации для конкретной платформы, например количество подключений по умолчанию, частота сбора мусора и использование возможностей упрощенного подключения, например Direct и TCP.</span><span class="sxs-lookup"><span data-stu-id="574d8-209">This includes using the latest SDKs, configuring platform-specific configurations like default number of connections, frequency of garbage collection, and using lightweight connectivity options like Direct/TCP.</span></span> 


#### <a name="max-item-count"></a><span data-ttu-id="574d8-210">Максимальное количество элементов</span><span class="sxs-lookup"><span data-stu-id="574d8-210">Max Item Count</span></span>
<span data-ttu-id="574d8-211">Значение параметра `MaxItemCount` может оказать значительное влияние на полное время обработки запроса.</span><span class="sxs-lookup"><span data-stu-id="574d8-211">For queries, the value of `MaxItemCount` can have a significant impact on end-to-end query time.</span></span> <span data-ttu-id="574d8-212">Число элементов, возвращаемых за каждый круговой путь к серверу, не больше заданного для параметра `MaxItemCount` (по умолчанию 100 элементов).</span><span class="sxs-lookup"><span data-stu-id="574d8-212">Each round trip to the server will return no more than the number of items in `MaxItemCount` (Default of 100 items).</span></span> <span data-ttu-id="574d8-213">Если задать большее значение (максимальное и рекомендуемое: -1), общая длительность выполнения запроса увеличится, но ограничится количество круговых путей между сервером и клиентом, особенно для запросов с большими результирующими наборами.</span><span class="sxs-lookup"><span data-stu-id="574d8-213">Setting this to a higher value (-1 is maximum, and recommended) will improve your query duration overall by limiting the number of round trips between server and client, especially for queries with large result sets.</span></span>

```cs
IDocumentQuery<dynamic> query = client.CreateDocumentQuery(
    UriFactory.CreateDocumentCollectionUri(DatabaseName, CollectionName), 
    "SELECT * FROM c WHERE c.city = 'Seattle'", 
    new FeedOptions 
    { 
        MaxItemCount = -1, 
    }).AsDocumentQuery();
```

#### <a name="max-degree-of-parallelism"></a><span data-ttu-id="574d8-214">Максимальная степень параллелизма</span><span class="sxs-lookup"><span data-stu-id="574d8-214">Max Degree of Parallelism</span></span>
<span data-ttu-id="574d8-215">Настройте `MaxDegreeOfParallelism` для запросов, чтобы определить оптимальные конфигурации для приложения, особенно если выполняются запросы между секциями (без фильтра в значении ключа секции).</span><span class="sxs-lookup"><span data-stu-id="574d8-215">For queries, tune the `MaxDegreeOfParallelism` to identify the best configurations for your application, especially if you perform cross-partition queries (without a filter on the partition-key value).</span></span> <span data-ttu-id="574d8-216">Параметр `MaxDegreeOfParallelism` определяет максимальное число параллельных задач, т. е. максимальное количество секций, посещаемых одновременно.</span><span class="sxs-lookup"><span data-stu-id="574d8-216">`MaxDegreeOfParallelism`  controls the maximum number of parallel tasks, i.e., the maximum of partitions to be visited in parallel.</span></span> 

```cs
IDocumentQuery<dynamic> query = client.CreateDocumentQuery(
    UriFactory.CreateDocumentCollectionUri(DatabaseName, CollectionName), 
    "SELECT * FROM c WHERE c.city = 'Seattle'", 
    new FeedOptions 
    { 
        MaxDegreeOfParallelism = -1, 
        EnableCrossPartitionQuery = true 
    }).AsDocumentQuery();
```

<span data-ttu-id="574d8-217">Предположим следующее:</span><span class="sxs-lookup"><span data-stu-id="574d8-217">Let’s assume that</span></span>
* <span data-ttu-id="574d8-218">D — максимальное число параллельных задач, используемое по умолчанию (т. е. общее количество процессоров на компьютере клиента);</span><span class="sxs-lookup"><span data-stu-id="574d8-218">D = Default Maximum number of parallel tasks (= total number of processor in the client machine)</span></span>
* <span data-ttu-id="574d8-219">P — определенное пользователем максимальное число параллельных задач;</span><span class="sxs-lookup"><span data-stu-id="574d8-219">P = User-specified maximum number of parallel tasks</span></span>
* <span data-ttu-id="574d8-220">N — количество секций, которые необходимо посетить для получения ответов на запросы.</span><span class="sxs-lookup"><span data-stu-id="574d8-220">N = Number of partitions that needs  to be visited for answering a query</span></span>

<span data-ttu-id="574d8-221">Возможны следующие сценарии поведения параллельных запросов при различных значениях P:</span><span class="sxs-lookup"><span data-stu-id="574d8-221">Following are implications of how the parallel queries would behave for different values of P.</span></span>
* <span data-ttu-id="574d8-222">(P == 0) => последовательный режим;</span><span class="sxs-lookup"><span data-stu-id="574d8-222">(P == 0) => Serial Mode</span></span>
* <span data-ttu-id="574d8-223">(P == 1) => не более одной задачи;</span><span class="sxs-lookup"><span data-stu-id="574d8-223">(P == 1) => Maximum of one task</span></span>
* <span data-ttu-id="574d8-224">(P > 1) => минимум (P, N) параллельных задач;</span><span class="sxs-lookup"><span data-stu-id="574d8-224">(P > 1) => Min (P, N) parallel tasks</span></span> 
* <span data-ttu-id="574d8-225">(P < 1) => минимум (N, D) параллельных задач.</span><span class="sxs-lookup"><span data-stu-id="574d8-225">(P < 1) => Min (N, D) parallel tasks</span></span>

<span data-ttu-id="574d8-226">Заметки о выпуске пакета SDK и сведения о реализованных классах и методах см. в статье [Пакет SDK для DocumentDB .NET: скачивание и заметки о выпуске](documentdb-sdk-dotnet.md).</span><span class="sxs-lookup"><span data-stu-id="574d8-226">For SDK release notes, and details on implemented classes and methods see [DocumentDB SDKs](documentdb-sdk-dotnet.md)</span></span>

### <a name="network-latency"></a><span data-ttu-id="574d8-227">Задержки сети</span><span class="sxs-lookup"><span data-stu-id="574d8-227">Network latency</span></span>
<span data-ttu-id="574d8-228">Сведения о том, как настроить глобальное распространение и подключиться к ближайшему региону, см. в статье [Как настроить глобальное распределение Azure Cosmos DB с помощью API DocumentDB](tutorial-global-distribution-documentdb.md).</span><span class="sxs-lookup"><span data-stu-id="574d8-228">See [Azure Cosmos DB global distribution](tutorial-global-distribution-documentdb.md) for how to set up global distribution, and connect to the closest region.</span></span> <span data-ttu-id="574d8-229">Задержки сети оказывают значительное влияние на производительность запросов, если вам нужно сделать несколько циклов приема-передачи или получить большой результирующий набор в запросе.</span><span class="sxs-lookup"><span data-stu-id="574d8-229">Network latency has a significant impact on query performance when you need to make multiple round-trips or retrieve a large result set from the query.</span></span> 

<span data-ttu-id="574d8-230">Из раздела о метриках выполнения запросов вы узнаете, как получить информацию о времени выполнения запросов на сервере (`totalExecutionTimeInMs`). Это поможет различать время, затраченное на выполнение запроса и на передачу по сети.</span><span class="sxs-lookup"><span data-stu-id="574d8-230">The section on query execution metrics explains how to retrieve the server execution time of queries ( `totalExecutionTimeInMs`), so that you can differentiate between time spent in query execution and time spent in network transit.</span></span>

### <a name="indexing-policy"></a><span data-ttu-id="574d8-231">Политика индексации</span><span class="sxs-lookup"><span data-stu-id="574d8-231">Indexing policy</span></span>
<span data-ttu-id="574d8-232">Чтобы узнать о путях индексирования, типах, режимах и их влиянии на выполнение запроса, перейдите к статье [Как работает индексирование данных в Azure Cosmos DB?](indexing-policies.md).</span><span class="sxs-lookup"><span data-stu-id="574d8-232">See [Configuring indexing policy](indexing-policies.md) for indexing paths, kinds, and modes, and how they impact query execution.</span></span> <span data-ttu-id="574d8-233">По умолчанию политика индексирования использует хэш-индексирование строк, что эффективно для запросов равенства, но не для запросов в диапазоне и запросов Order By.</span><span class="sxs-lookup"><span data-stu-id="574d8-233">By default, the indexing policy uses Hash indexing for strings, which is effective for equality queries, but not for range queries/order by queries.</span></span> <span data-ttu-id="574d8-234">Если вам требуется выполнить запросы в диапазоне для строк, рекомендуется для всех строк указать тип индекса Range.</span><span class="sxs-lookup"><span data-stu-id="574d8-234">If you need range queries for strings, we recommend specifying the Range index type for all strings.</span></span> 

## <a name="query-execution-metrics"></a><span data-ttu-id="574d8-235">Метрики выполнения запросов</span><span class="sxs-lookup"><span data-stu-id="574d8-235">Query execution metrics</span></span>
<span data-ttu-id="574d8-236">Подробные метрики выполнения запроса можно получить, передав необязательный заголовок `x-ms-documentdb-populatequerymetrics` (`FeedOptions.PopulateQueryMetrics` в пакете SDK для .NET).</span><span class="sxs-lookup"><span data-stu-id="574d8-236">You can obtain detailed metrics on query execution by passing in the optional `x-ms-documentdb-populatequerymetrics` header (`FeedOptions.PopulateQueryMetrics` in the .NET SDK).</span></span> <span data-ttu-id="574d8-237">Значение, возвращаемое в `x-ms-documentdb-query-metrics`, имеет следующие пары "ключ — значение", предназначенные для дополнительной диагностики выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="574d8-237">The value returned in `x-ms-documentdb-query-metrics` has the following key-value pairs meant for advanced troubleshooting of query execution.</span></span> 

```cs
IDocumentQuery<dynamic> query = client.CreateDocumentQuery(
    UriFactory.CreateDocumentCollectionUri(DatabaseName, CollectionName), 
    "SELECT * FROM c WHERE c.city = 'Seattle'", 
    new FeedOptions 
    { 
        PopulateQueryMetrics = true, 
    }).AsDocumentQuery();

FeedResponse<dynamic> result = await query.ExecuteNextAsync();

// Returns metrics by partition key range Id
IReadOnlyDictionary<string, QueryMetrics> metrics = result.QueryMetrics;

```

| <span data-ttu-id="574d8-238">Метрика</span><span class="sxs-lookup"><span data-stu-id="574d8-238">Metric</span></span> | <span data-ttu-id="574d8-239">Единица измерения</span><span class="sxs-lookup"><span data-stu-id="574d8-239">Unit</span></span> | <span data-ttu-id="574d8-240">Описание</span><span class="sxs-lookup"><span data-stu-id="574d8-240">Description</span></span> | 
| ------ | -----| ----------- |
| `totalExecutionTimeInMs` | <span data-ttu-id="574d8-241">Миллисекунды</span><span class="sxs-lookup"><span data-stu-id="574d8-241">milliseconds</span></span> | <span data-ttu-id="574d8-242">Время выполнения запроса</span><span class="sxs-lookup"><span data-stu-id="574d8-242">Query execution time</span></span> | 
| `queryCompileTimeInMs` | <span data-ttu-id="574d8-243">Миллисекунды</span><span class="sxs-lookup"><span data-stu-id="574d8-243">milliseconds</span></span> | <span data-ttu-id="574d8-244">Время компиляции запроса</span><span class="sxs-lookup"><span data-stu-id="574d8-244">Query compile time</span></span>  | 
| `queryLogicalPlanBuildTimeInMs` | <span data-ttu-id="574d8-245">Миллисекунды</span><span class="sxs-lookup"><span data-stu-id="574d8-245">milliseconds</span></span> | <span data-ttu-id="574d8-246">Время на создание логического плана запроса</span><span class="sxs-lookup"><span data-stu-id="574d8-246">Time to build logical query plan</span></span> | 
| `queryPhysicalPlanBuildTimeInMs` | <span data-ttu-id="574d8-247">Миллисекунды</span><span class="sxs-lookup"><span data-stu-id="574d8-247">milliseconds</span></span> | <span data-ttu-id="574d8-248">Время на создание физического плана запроса</span><span class="sxs-lookup"><span data-stu-id="574d8-248">Time to build physical query plan</span></span> | 
| `queryOptimizationTimeInMs` | <span data-ttu-id="574d8-249">Миллисекунды</span><span class="sxs-lookup"><span data-stu-id="574d8-249">milliseconds</span></span> | <span data-ttu-id="574d8-250">Время, затраченное на оптимизацию запроса</span><span class="sxs-lookup"><span data-stu-id="574d8-250">Time spent in optimizing query</span></span> | 
| `VMExecutionTimeInMs` | <span data-ttu-id="574d8-251">Миллисекунды</span><span class="sxs-lookup"><span data-stu-id="574d8-251">milliseconds</span></span> | <span data-ttu-id="574d8-252">Время, затраченное в среде выполнения запроса</span><span class="sxs-lookup"><span data-stu-id="574d8-252">Time spent in query runtime</span></span> | 
| `indexLookupTimeInMs` | <span data-ttu-id="574d8-253">Миллисекунды</span><span class="sxs-lookup"><span data-stu-id="574d8-253">milliseconds</span></span> | <span data-ttu-id="574d8-254">Время, затраченное на физическом уровне индекса</span><span class="sxs-lookup"><span data-stu-id="574d8-254">Time spent in physical index layer</span></span> | 
| `documentLoadTimeInMs` | <span data-ttu-id="574d8-255">Миллисекунды</span><span class="sxs-lookup"><span data-stu-id="574d8-255">milliseconds</span></span> | <span data-ttu-id="574d8-256">Время, затраченное на загрузку документов</span><span class="sxs-lookup"><span data-stu-id="574d8-256">Time spent in loading documents</span></span>  | 
| `systemFunctionExecuteTimeInMs` | <span data-ttu-id="574d8-257">Миллисекунды</span><span class="sxs-lookup"><span data-stu-id="574d8-257">milliseconds</span></span> | <span data-ttu-id="574d8-258">Общее время, затраченное на выполнение (встроенных) функций системы (в миллисекундах)</span><span class="sxs-lookup"><span data-stu-id="574d8-258">Total time spent executing system (built-in) functions in milliseconds</span></span>  | 
| `userFunctionExecuteTimeInMs` | <span data-ttu-id="574d8-259">Миллисекунды</span><span class="sxs-lookup"><span data-stu-id="574d8-259">milliseconds</span></span> | <span data-ttu-id="574d8-260">Общее время, затраченное на выполнение определяемых пользователем функций (в миллисекундах)</span><span class="sxs-lookup"><span data-stu-id="574d8-260">Total time spent executing user-defined functions in milliseconds</span></span> | 
| `retrievedDocumentCount` | <span data-ttu-id="574d8-261">Миллисекунды</span><span class="sxs-lookup"><span data-stu-id="574d8-261">milliseconds</span></span> | <span data-ttu-id="574d8-262">Общее число полученных документов</span><span class="sxs-lookup"><span data-stu-id="574d8-262">Total number of retrieved documents</span></span>  | 
| `retrievedDocumentSize` | <span data-ttu-id="574d8-263">Байты</span><span class="sxs-lookup"><span data-stu-id="574d8-263">bytes</span></span> | <span data-ttu-id="574d8-264">Общий размер полученных документов в байтах</span><span class="sxs-lookup"><span data-stu-id="574d8-264">Total size of retrieved documents in bytes</span></span>  | 
| `outputDocumentCount` | <span data-ttu-id="574d8-265">count</span><span class="sxs-lookup"><span data-stu-id="574d8-265">count</span></span> | <span data-ttu-id="574d8-266">Количество выходных документов</span><span class="sxs-lookup"><span data-stu-id="574d8-266">Number of output documents</span></span> | 
| `writeOutputTimeInMs` | <span data-ttu-id="574d8-267">Миллисекунды</span><span class="sxs-lookup"><span data-stu-id="574d8-267">milliseconds</span></span> | <span data-ttu-id="574d8-268">Время выполнения запроса в миллисекундах</span><span class="sxs-lookup"><span data-stu-id="574d8-268">Query execution time in milliseconds</span></span> | 
| `indexUtilizationRatio` | <span data-ttu-id="574d8-269">Коэффициент (<=1)</span><span class="sxs-lookup"><span data-stu-id="574d8-269">ratio (<=1)</span></span> | <span data-ttu-id="574d8-270">Отношение числа документов, соответствующих фильтру, к количеству загруженных документов</span><span class="sxs-lookup"><span data-stu-id="574d8-270">Ratio of number of documents matched by the filter to the number of documents loaded</span></span>  | 

<span data-ttu-id="574d8-271">Клиентские пакеты SDK внутренне могут выполнять несколько операций запроса, чтобы обработать запрос в каждой секции.</span><span class="sxs-lookup"><span data-stu-id="574d8-271">The client SDKs may internally make multiple query operations to serve the query within each partition.</span></span> <span data-ttu-id="574d8-272">Клиент осуществляет более одного вызова в каждой секции, если общие результаты превышают `x-ms-max-item-count`, если запрос превышает подготовленную пропускную способность секции, если полезные данные запроса достигают максимального размера для страницы или если запрос достигает предела выделенного времени ожидания системы.</span><span class="sxs-lookup"><span data-stu-id="574d8-272">The client makes more than one call per-partition if the total results exceed `x-ms-max-item-count`, if the query exceeds the provisioned throughput for the partition, or if the query payload reaches the maximum size per page, or if the query reaches the system allocated timeout limit.</span></span> <span data-ttu-id="574d8-273">Каждое частичное выполнение запроса возвращает `x-ms-documentdb-query-metrics` такой страницы.</span><span class="sxs-lookup"><span data-stu-id="574d8-273">Each partial query execution returns a `x-ms-documentdb-query-metrics` for that page.</span></span> 

<span data-ttu-id="574d8-274">Ниже приведены некоторые примеры запросов и интерпретации некоторых метрик, возвращаемые из выполнения запроса.</span><span class="sxs-lookup"><span data-stu-id="574d8-274">Here are some sample queries, and how to interpret some of the metrics returned from query execution:</span></span> 

| <span data-ttu-id="574d8-275">Запрос</span><span class="sxs-lookup"><span data-stu-id="574d8-275">Query</span></span> | <span data-ttu-id="574d8-276">Образец метрики</span><span class="sxs-lookup"><span data-stu-id="574d8-276">Sample Metric</span></span> | <span data-ttu-id="574d8-277">Описание</span><span class="sxs-lookup"><span data-stu-id="574d8-277">Description</span></span> | 
| ------ | -----| ----------- |
| `SELECT TOP 100 * FROM c` | `"RetrievedDocumentCount": 101` | <span data-ttu-id="574d8-278">Количество полученных документов составляет 100+1 для соответствия предложению TOP.</span><span class="sxs-lookup"><span data-stu-id="574d8-278">The number of documents retrieved is 100+1 to match the TOP clause.</span></span> <span data-ttu-id="574d8-279">Время запроса главным образом тратится на `WriteOutputTime` и `DocumentLoadTime`, так как он выполняет сканирование.</span><span class="sxs-lookup"><span data-stu-id="574d8-279">Query time is mostly spent in `WriteOutputTime` and `DocumentLoadTime` since it is a scan.</span></span> | 
| `SELECT TOP 500 * FROM c` | `"RetrievedDocumentCount": 501` | <span data-ttu-id="574d8-280">RetrievedDocumentCount теперь выше (500+1 для соответствия предложению TOP).</span><span class="sxs-lookup"><span data-stu-id="574d8-280">RetrievedDocumentCount is now higher (500+1 to match the TOP clause).</span></span> | 
| `SELECT * FROM c WHERE c.N = 55` | `"IndexLookupTime": "00:00:00.0009500"` | <span data-ttu-id="574d8-281">Около 0,9 мс затрачивается IndexLookupTime на поиск ключа, так как это поиск по индексу `/N/?`.</span><span class="sxs-lookup"><span data-stu-id="574d8-281">About 0.9 ms is spent in IndexLookupTime for a key lookup, because it's an index lookup on `/N/?`.</span></span> | 
| `SELECT * FROM c WHERE c.N > 55` | `"IndexLookupTime": "00:00:00.0017700"` | <span data-ttu-id="574d8-282">Немного больше времени (1,7 мс) затрачивается IndexLookupTime на сканирование диапазона, так как это поиск по индексу `/N/?`.</span><span class="sxs-lookup"><span data-stu-id="574d8-282">Slightly more time (1.7 ms) spent in IndexLookupTime over a range scan, because it's an index lookup on `/N/?`.</span></span> | 
| `SELECT TOP 500 c.N FROM c` | `"IndexLookupTime": "00:00:00.0017700"` | <span data-ttu-id="574d8-283">На `DocumentLoadTime` затрачивается то же время, что и в предыдущих запросах, но с меньшим `WriteOutputTime`, так как мы отображаем только одно свойство.</span><span class="sxs-lookup"><span data-stu-id="574d8-283">Same time spent on `DocumentLoadTime` as previous queries, but lower `WriteOutputTime` because we're projecting only one property.</span></span> | 
| `SELECT TOP 500 udf.toPercent(c.N) FROM c` | `"UserDefinedFunctionExecutionTime": "00:00:00.2136500"` | <span data-ttu-id="574d8-284">Около 213 мс затрачивается `UserDefinedFunctionExecutionTime` на выполнение определяемой пользователем функции для каждого значения `c.N`.</span><span class="sxs-lookup"><span data-stu-id="574d8-284">About 213 ms is spent in `UserDefinedFunctionExecutionTime` executing the UDF on each value of `c.N`.</span></span> |
| `SELECT TOP 500 c.Name FROM c WHERE STARTSWITH(c.Name, 'Den')` | `"IndexLookupTime": "00:00:00.0006400", "SystemFunctionExecutionTime": "00:00:00.0074100"` | <span data-ttu-id="574d8-285">Около 0,6 мс затрачивается `IndexLookupTime` на `/Name/?`.</span><span class="sxs-lookup"><span data-stu-id="574d8-285">About 0.6 ms is spent in `IndexLookupTime` on `/Name/?`.</span></span> <span data-ttu-id="574d8-286">Большая часть времени выполнения запроса (~7 мс) затрачивается на `SystemFunctionExecutionTime`.</span><span class="sxs-lookup"><span data-stu-id="574d8-286">Most of the query execution time (~7 ms) in `SystemFunctionExecutionTime`.</span></span> |
| `SELECT TOP 500 c.Name FROM c WHERE STARTSWITH(LOWER(c.Name), 'den')` | `"IndexLookupTime": "00:00:00", "RetrievedDocumentCount": 2491,  "OutputDocumentCount": 500` | <span data-ttu-id="574d8-287">Запрос выполняется как операция сканирования, так как он использует `LOWER`, и 500 из 2491 полученных документов возвращаются.</span><span class="sxs-lookup"><span data-stu-id="574d8-287">Query is performed as a scan because it uses `LOWER`, and 500 out of 2491 retrieved documents are returned.</span></span> |


## <a name="next-steps"></a><span data-ttu-id="574d8-288">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="574d8-288">Next steps</span></span>
* <span data-ttu-id="574d8-289">Дополнительные сведения о поддерживаемых ключевых словах и операторах SQL-запросов см. в статье [SQL-запросы для API DocumentDB в Azure Cosmos DB](documentdb-sql-query.md).</span><span class="sxs-lookup"><span data-stu-id="574d8-289">To learn about the supported SQL query operators and keywords, see [SQL query](documentdb-sql-query.md).</span></span> 
* <span data-ttu-id="574d8-290">Дополнительные сведения о единицах запроса см. в статье [Единицы запросов в базе данных Azure Cosmos DB](request-units.md).</span><span class="sxs-lookup"><span data-stu-id="574d8-290">To learn about request units, see [request units](request-units.md).</span></span>
* <span data-ttu-id="574d8-291">Дополнительные сведения о политике индексирования см. в статье [Как работает индексирование данных в Azure Cosmos DB?](indexing-policies.md)</span><span class="sxs-lookup"><span data-stu-id="574d8-291">To learn about indexing policy, see [indexing policy](indexing-policies.md)</span></span> 



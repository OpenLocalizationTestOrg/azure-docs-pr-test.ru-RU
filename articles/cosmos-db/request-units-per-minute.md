---
title: "Единицы запросов в минуту в базе данных Azure Cosmos DB | Документация Майкрософт"
description: "Сведения о снижении затрат за счет использования единиц запросов в минуту."
services: cosmos-db
documentationcenter: 
author: mimig1
manager: jhubbard
editor: 
ms.assetid: 
ms.service: cosmos-db
ms.workload: 
ms.tgt_pltfrm: na
ms.devlang: dotnet
ms.topic: article
ms.date: 05/10/2017
ms.author: mimig
ms.openlocfilehash: 72d60d5656ad664e42a848fc9b372cb09e49b888
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="request-units-per-minute-in-azure-cosmos-db"></a>Единицы запросов в минуту в базе данных Azure Cosmos DB

База данных Azure Cosmos DB позволяет обеспечивать высокую и прогнозируемую производительность, а также легко масштабируется по мере расширения вашего приложения. В контейнере базы данных Cosmos DB пропускную способность можно подготавливать с ежесекундной или ежеминутной степенью детализации. Пропускная способность с ежеминутной степенью детализации помогает управлять пиковыми нагрузками, возникающими при ежесекундной степени детализации. 

В этой статье содержатся общие сведения о подготовке и принципах действия единиц запросов в минуту. Эти сведения помогут обеспечить прогнозируемую производительность в случае непредсказуемых событий (особенно если нужно выполнить анализ на основе операционных данных) и пиковых рабочих нагрузок. Нам нужно, чтобы наши клиенты использовали больший объем пропускной способности, нежели они подготавливают. Это позволит выполнять масштабирование быстро, не беспокоясь о последствиях.

После прочтения этой статьи вы сможете ответить на следующие вопросы:

* Как работают единицы запросов в минуту?
* В чем разница между единицами запросов с ежесекундной и ежеминутной степенью детализации?
* Как подготовить единицы запросов в минуту?
* В каких ситуациях следует подготавливать единицы запросов с ежеминутной степенью детализации?
* Как оптимизировать производительность и затраты, используя метрики портала?
* Какие типы запросов используют единицы запросов с ежеминутной степенью детализации?

## <a name="provisioning-request-units-per-minute-rum"></a>Подготовка единиц запросов в минуту

База данных Azure Cosmos DB со второй степенью детализации предоставляет гарантию выполнения запроса с небольшой задержкой, если в течение этой секунды пропускная способность не превысила указанную емкость. При ежеминутной степени детализации время выполнения запроса не должно превышать одну минуту. В системах с частыми скачками нагрузки это позволяет прогнозировать и планировать производительность.

Единицы запросов в минуту работают следующим образом:

* Плата за единицы запросов в минуту выставляется каждый час помимо платы за единицы запросов в секунду. Дополнительные сведения см. на [странице цен на базу данных Azure Cosmos DB](https://aka.ms/acdbpricing).
* Единицы запросов в минуту можно включить на уровне коллекции. Это можно сделать с помощью пакетов SDK (Node.js, Java или .NET) или на портале (также включает рабочие нагрузки API MongoDB).
* При подготовке 100 единиц запросов в секунду вы также получаете 1000 единиц запросов в минуту (соотношение составляет 1 к 10).
* Использование единиц запросов в минуту начинается только при превышении квоты на единицы запросов в секунду в течение заданной секунды.
* По завершении 60-секундного периода (время в формате UTC) количество единиц запросов в минуту восстанавливается.
* Единицы запросов в минуту можно использовать только в коллекциях с максимум 5000 единицами запросов в секунду на секцию. При масштабировании пропускной способности и достижении высокого уровня подготовки на секцию вы получите предупреждающее сообщение.

Ниже приведен конкретный пример, где пользователь может подготовить 10 000 единиц запросов в секунду и 100 000 единиц запросов в минуту, что позволяет сократить расходы на 73 %, не подготавливая дополнительные единицы запросов в секунду для пиковых нагрузок (около 50 000 единиц), которые могут произойти в коллекции с таким же числом единиц запросов в течение 90 секунд.

* 1 секунда. Резерв единиц запросов в минуту составляет 100 000.
* 3 секунда. В течение этой секунды было использовано 11 010 единиц запросов, на 1010 единиц больше установленного уровня подготовки в секунду. Таким образом, 1010 единиц запросов было вычтено из резерва единиц запросов в минуту. Для следующих 57 секунд доступно 98 990 единиц запросов, которые вычитаются из резерва единиц запросов в минуту.
* 29 секунда. В течение этой секунды произошел большой скачок нагрузки (в 4 раза больше подготовленного числа единиц запросов в секунду) и было использовано 46 920 единиц запросов. 36 920 единиц запросов были вычтены из резерва единиц запросов в минуту, число которых снизилось с 92 323 (28 секунда) до 55 403 единиц запросов (29 секунда).
* 61 секунда. Резерв единиц запросов в секунду снова составляет 100 000.
 
![График потребления и подготовки базы данных Azure Cosmos DB](./media/request-units-per-minute/azure-cosmos-db-request-units-per-minute.png)

## <a name="specifying-request-unit-capacity-with-rum"></a>Указание количества единиц запросов с учетом резерва единиц запросов в минуту

При создании коллекции базы данных Azure Cosmos DB необходимо указать количество единиц запросов в секунду, которое вы хотите зарезервировать. Вы также можете добавить единицы запросов в минуту. Это можно сделать на портале или с помощью пакета SDK. 

### <a name="through-the-portal"></a>Добавление единиц запросов на портале

Чтобы добавить единицы запросов в минуту, необходимо просто выбрать нужный параметр при подготовке коллекции. 

 ![Снимок экрана с параметром добавления единиц запросов в минуту на портале Azure](./media/request-units-per-minute/azure-cosmos-db-request-unit-per-minute-portal.png)

### <a name="through-the-sdk"></a>Добавление единиц запросов с помощью пакета SDK
Единицы запросов в минуту доступны только для следующих пакетов SDK:

* .NET 1.14.0;
* Java 1.11.0;
* Node.js 1.12.0;
* Python 2.2.0.

Ниже приведен фрагмент кода для создания коллекции с 3000 единиц запросов в секунду и 30 000 единиц запросов в минуту с помощью пакета SDK для .NET.

```csharp
// Create a collection with RU/m enabled
DocumentCollection myCollection = new DocumentCollection();
myCollection.Id = "coll";
myCollection.PartitionKey.Paths.Add("/deviceId");

// Set the throughput to 3,000 request units per second which will give you 30,000 request units per minute as the RU/m budget
await client.CreateDocumentCollectionAsync(
    UriFactory.CreateDatabaseUri("db"),
    myCollection,
    new RequestOptions { OfferThroughput = 3000, OfferEnableRUPerMinuteThroughput = true });
```

Ниже приведен фрагмент кода для изменения пропускной способности коллекции до 5000 единиц запросов в секунду без единиц запросов в минуту с помощью пакета SDK для .NET.

```csharp
// Get the current offer
Offer offer = client.CreateOfferQuery()
    .Where(r => r.ResourceLink == collection.SelfLink)    
    .AsEnumerable()
    .SingleOrDefault();

// Set the throughput to 5000 request units per second without RU/m enabled (the last parameter to OfferV2 constructor below)
OfferV2 offerV2 = new OfferV2(offer, 5000, false);

// Now persist these changes to the database by replacing the original resource
await client.ReplaceOfferAsync(offerV2);
```

## <a name="good-fit-scenarios"></a>Сценарии применения

В этом разделе рассматриваются сценарии, в которых мы советуем использовать единицы запросов в минуту.

**Среда разработки и тестирования.** Единицы запросов в минуту могут обеспечить гибкость на этапе разработки при тестировании приложения с использованием разных рабочих нагрузок. Для тестирования базы данных Azure Cosmos DB можно использовать бесплатный [эмулятор](local-emulator.md). Но если вы хотите начать работу в облачной среде, используйте единицы запросов в минуту, так как они обеспечивают исключительную гибкость и нужную производительность. Это позволит посвятить больше времени разработке, не заботясь о производительности. Мы советуем подготовить минимальное число единиц запросов в секунду и включить единицы запросов в минуту.

**Непредсказуемые события, пиковые нагрузки и потребность в ежеминутной степени детализации** (экономия расходов от 25 до 75 %). Мы рассмотрели разные сценарии, в которых единицы запросов в минуту принесли значительную пользу, и большинство рабочих сценариев входят в их число. Если имеется рабочая нагрузка Интернета вещей с несколькими пиковыми нагрузками в минуту и запросы выполняются в системе именно в это время, вам потребуется дополнительная емкость для обработки этих пиковых нагрузок. Мы советуем оптимизировать потребность в ресурсах, используя приведенный ниже подход.

 ![График выполнения запросов с пятиминутной степенью детализации](./media/request-units-per-minute/azure-cosmos-db-request-units-per-minute-consumption.png)
 
 *Рис. Результаты измерения производительности при использовании единиц запросов*

**Надежность** (экономия от 10 до 20 %). Иногда вы просто хотите быть уверенными и не беспокоиться о возможных пиковых нагрузках и регулировании. Этот вариант как раз для вас. В этом случае мы советуем включить единицы запросов в минуту и снизить число единиц запросов в секунду. Этот случай отличается от приведенного выше, так как вы не пытаетесь оптимизировать подготовку. Это подход, в большей степени ориентированный на устранение регулирования.

Критические операции с определенными потребностями. Иногда мы советуем использовать единицы запросов в минуту только при выполнении критических операций. За счет этого эти единицы запросов не будут использоваться в произвольных или менее важных операциях. В разделе ниже показано, как настроить параметры использования единиц запросов в минуту.

## <a name="using-the-portal-metrics-to-optimize-cost-and-performance"></a>Оптимизация производительности и затрат с использованием метрик, доступных на портале

**В ближайшие несколько недель мы предоставим сведения о мониторинге использования единиц запросов в минуту, что позволит оптимизировать регулирование.**

Используя метрики, доступные на портале, вы можете сравнить использование единиц запросов в секунду и единиц запросов в минуту. Мониторинг этих метрик позволяет оптимизировать подготовку. 

Мы советуем использовать пошаговый подход, который позволяет получить пользу от единиц запросов в минуту. При выполнении каждого шага необходимо просматривать сведения о потреблении единиц запросов, представляющие полный цикл рабочей нагрузки (часы, дни или даже недели), и анализировать использование подготавливаемых ресурсов.

Принцип, который лежит в основе этого подхода, заключается в том, чтобы подготовить пропускную способность как можно точнее к точке подготовки, которая соответствует критериям производительности ниже. 

![График выполнения запросов с пятиминутной степенью детализации](./media/request-units-per-minute/azure-cosmos-db-request-units-per-minute-adjust-provisioning.png)
 
Чтобы определить оптимальную точку подготовки для рабочей нагрузки, необходимо понять следующее:

* Шаблоны потребления. Определите частоту пиковых нагрузок (частые, нечастые, отсутствуют), а также их длительность, например краткосрочные (в 2 раза меньше средних), средние или долгосрочные (в 10 раз больше средних).
* Процент отрегулированных запросов. Определите, хотите ли вы выполнять регулирование, и если да, то как часто. 

Определив цели, вы сможете стать ближе к вычислению оптимального уровня подготовки.

Чтобы помочь вам, мы планируем предоставить руководство по оптимизации подготовки на основе использования единиц запросов в минуту. Это руководство не применяется ко всем типам рабочих нагрузок, но оно основано на данных закрытой предварительной версии. При более подробном изучении базовые показатели могут измениться.

|Использование единиц запросов в минуту (%)|Степень использования единиц запросов в минуту|Рекомендуемые действия для подготовки|
|---|---|---|
|0–1 %|Недоиспользование|Уменьшите число единиц запросов в секунду, чтобы использовать больше единиц запросов в минуту.|
|1–10 %|Использование в работоспособном состоянии|Используйте тот же уровень подготовки.|
|Выше 10 %|Чрезмерное использование|Увеличьте число единиц запросов в секунду, чтобы использовать меньше единиц запросов в минуту.|

## <a name="select-which-operations-can-consume-the-rum-budget"></a>Выбор операций, использующих единицы запросов в минуту

Единицы запросов в минуту можно также включить на уровне запроса. Это позволяет обрабатывать запросы независимо от типа операции. Если подготовленных единиц запросов в секунду не хватило и запрос не может использовать единицы запросов в минуту, выполняется регулировка запроса. По умолчанию запрос использует единицы запросов в секунду, даже если активированы единицы запроса в минуту. 

Ниже приведен фрагмент кода для отключения резерва единиц запросов в минуту с помощью API DocumentDB для CRUD и операций запросов.

```csharp
// In order to disable any CRUD request for RU/m, set DisableRUPerMinuteUsage to true in RequestOptions
await client.CreateDocumentAsync(
    UriFactory.CreateDocumentCollectionUri("db", "container"),
    new Document { Id = "Cosmos DB" },
    new RequestOptions { DisableRUPerMinuteUsage = true });
// In order to disable any query request for RU/m, set DisableRUPerMinuteOnRequest to true in RequestOptions
FeedOptions feedOptions = new FeedOptions();
feedOptions.DisableRUPerMinuteUsage = true;
var query = client.CreateDocumentQuery<Book>(
    UriFactory.CreateDocumentCollectionUri("db", "container"),
    "select * from c",feedOptions).AsDocumentQuery();
```

## <a name="next-steps"></a>Дальнейшие действия

В этой статье мы рассмотрели, как действует секционирование в базе данных Azure Cosmos DB, а также узнали, как создать секционированные коллекции и как выбрать подходящий ключ секции для приложения.

* Выполняйте проверку масштабирования и производительности с помощью базы данных Azure Cosmos DB. Пример см. в статье [Проверка производительности и масштабирования с помощью Azure DocumentDB](performance-testing.md).
* Приступите к созданию кода с помощью [пакетов SDK](documentdb-sdk-dotnet.md) или [REST API](/rest/api/documentdb/).
* Дополнительные сведения о подготовленной пропускной способности в базе данных Azure Cosmos DB см. в [этой статье](request-units.md). 


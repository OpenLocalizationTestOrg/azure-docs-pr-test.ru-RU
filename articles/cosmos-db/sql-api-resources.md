---
title: "Понятия и модель ресурсов в Azure Cosmos DB | Документация Майкрософт"
description: "Описание иерархической модели базы данных, коллекций, определяемых пользователем функций (UDF), документов, разрешений на управление ресурсами и т. д."
keywords: "Иерархическая модель, cosmosdb, azure, Microsoft Azure"
services: cosmos-db
documentationcenter: 
author: rafats
manager: jhubbard
ms.assetid: ef9d5c0c-0867-4317-bb1b-98e219799fd5
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/24/2017
ms.author: rafats
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: a88f17a658987e1ff3ae0e0f38d6551c3acee1da
ms.sourcegitcommit: 0e4491b7fdd9ca4408d5f2d41be42a09164db775
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2017
---
# <a name="azure-cosmos-db-hierarchical-resource-model-and-core-concepts"></a>Ключевые понятия и иерархическая модель ресурсов в Azure Cosmos DB

[!INCLUDE [cosmos-db-sql-api](../../includes/cosmos-db-sql-api.md)]

Сущности базы данных, которыми управляет Azure Cosmos DB, называются **ресурсами**. Каждый ресурс однозначно идентифицируется своими логическим URI. Вы можете взаимодействовать с ресурсами с помощью стандартных команд HTTP, заголовки запросов и ответов и коды состояния. 

В этой статье ответы на следующие вопросы:

* Что такое модель ресурсов Azure Cosmos DB?
* Каковы системы определены ресурсы, в отличие от определяемых пользователем ресурсов?
* Как получить доступ к ресурсу?
* Как работать с коллекциями?
* Как работать с хранимыми процедурами, триггерами и пользовательскими функциями?

## <a name="hierarchical-resource-model"></a>Иерархическая модель ресурсов
Как показано на следующей схеме, иерархическая **модель ресурсов** Azure Cosmos DB состоит из наборов ресурсов в учетной записи базы данных, каждый из которых имеет логический постоянный универсальный код ресурса (URI). Набор ресурсов, называются **канала** в этой статье. 

> [!NOTE]
> Azure Cosmos DB предлагает высокоэффективные протокол TCP также является категории RESTful в модели связи, доступные через [API клиента SQL .NET](sql-api-sdk-dotnet.md).
> 
> 

![Иерархическая модель ресурсов в Azure Cosmos DB][1]  
**Иерархическая модель ресурсов.**   

Чтобы приступить к работе с ресурсами, необходимо [создать учетную запись базы данных](create-sql-api-dotnet.md) с помощью подписки Azure. Учетная запись базы данных может состоять из набора **баз данных**, каждая из которых содержит несколько **коллекций**, каждый из который в свою очередь содержать ** хранимые процедуры, триггеры, определяемые пользователем функции, документы и связанные с  **вложения**. Базы данных также связанный **пользователей**, каждый из которых набор **разрешений** для доступа к коллекции, хранимые процедуры, триггеры, определяемые пользователем функции, документы или вложения. Хотя базы данных, пользователей, разрешения и коллекций, системных ресурсов с хорошо известных схем, документы и вложения содержать произвольный, определяемое пользователем содержимое JSON.  

| Ресурс | ОПИСАНИЕ |
| --- | --- |
| Учетная запись базы данных |Учетная запись базы данных связана с набором баз и определенным местом в хранилище больших двоичных объектов для хранения вложений. Вы можете создать одну или несколько учетных записей базы данных с помощью подписки Azure. Дополнительные сведения см. на сайте [странице цен](https://azure.microsoft.com/pricing/details/cosmos-db/). |
| База данных |База данных представляет собой логический контейнер для хранения документов, разделенных между коллекциями. Она также является контейнером для пользователей. |
| Пользователь |Логическое пространство имен для ограничений разрешений. |
| Разрешение |Маркер проверки подлинности, связанный с пользователем, предоставляет доступ к определенному ресурсу. |
| Коллекция |Коллекция представляет собой контейнер документов JSON и связанной логики приложения на JavaScript. Коллекция представляет собой тарифицируемый объект, и его [стоимость](performance-levels.md) определяется связанным с ним уровнем производительности. Коллекции могут охватывать один или несколько разделов либо серверов и масштабироваться до практически неограниченных объемов хранилища или пропускной способности. |
| Хранимая процедура |Логика приложения, написанная на языке JavaScript, который зарегистрирован в коллекции и выполнена транзакционно в ядре СУБД. |
| Триггер |Логика приложения, написанная на языке JavaScript, выполнения до или после любой операции вставки, замены или удаления. |
| Определяемая пользователем функция |Логика приложения на языке JavaScript. Определяемые пользователем функции позволяют моделировать оператор пользовательского запроса и тем самым расширить ядро языка запросов API-Интерфейсы SQL. |
| Документ |Пользовательский (произвольный) контент JSON. По умолчанию, нет необходимости определения схемы или предоставления вторичных индексов для всех документов, добавляемых в коллекцию. |
| Вложение |Вложение — это специальный документ, содержащий ссылки и связанные с ним метаданные ко внешним большим двоичным объектам и носителям. Разработчик может выбрать, управлять ли большим двоичным объектом с помощью Cosmos DB или хранить его с помощью внешних поставщиков службы BLOB-объектов, таких как OneDrive, Dropbox и т. д. |

## <a name="system-vs-user-defined-resources"></a>Системы и пользовательские ресурсы
Ресурсы (такие как учетные записи баз данных, базы данных, коллекции, пользователи, разрешения, хранимые процедуры, триггеры и определяемые пользователем функции) имеют статическую схему и называются системными ресурсами. Ресурсы, такие как документы и вложения, напротив, не имеют ограничений на схему и приведены примеры определяемых пользователем ресурсов. В Cosmos DB системы и пользовательские ресурсы представленному и управляемому как стандартных JSON. Все ресурсы, системы или определяемые пользователем, имеют следующие общие свойства.

> [!NOTE]
> Все свойства системное в ресурсе имеют префикс со знака подчеркивания (_) в JSON-представление.
> 
> 

<table>
    <tbody>
        <tr>
            <td valign="top"><p><strong>Свойство</strong></p></td>
            <td valign="top"><p><strong>Устанавливаемое пользователем или генерируемое системой?</strong></p></td>
            <td valign="top"><p><strong>Назначение</strong></p></td>
        </tr>
        <tr>
            <td valign="top"><p>_rid</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>Созданный системой уникальный и иерархические идентификатор ресурса</p></td>
        </tr>
        <tr>
            <td valign="top"><p>_etag</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>etag ресурса, необходимый для управления оптимистичным параллелизмом</p></td>
        </tr>
        <tr>
            <td valign="top"><p>_ts</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>Метка времени последнего обновления ресурса</p></td>
        </tr>
        <tr>
            <td valign="top"><p>_self</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>Уникальный адресуемый URI ресурса</p></td>
        </tr>
        <tr>
            <td valign="top"><p>id</p></td>
            <td valign="top"><p>Можно использовать</p></td>
            <td valign="top"><p>Определяемые пользователем уникальное имя ресурса (с тем же значением ключа секции). Если пользователь не указан идентификатор, идентификатор — созданный системой</p></td>
        </tr>
    </tbody>
</table>

### <a name="wire-representation-of-resources"></a>Сетевое представление ресурсов
Cosmos DB не требует никаких закрытых расширений для стандарта JSON или специальных кодировок. Служба работает со стандартными, совместимыми с JSON документами.  

### <a name="addressing-a-resource"></a>Адресация ресурса
Все ресурсы можно адресовать по URI. Значение свойства **_self** представляет относительный универсальный код ресурса (URI) ресурса. Формат универсального кода ресурса (URI) состоит из сегментов пути /\<веб-канал\>/{_rid}.  

| Значение свойства _self | ОПИСАНИЕ |
| --- | --- |
| /dbs |Канал баз данных под учетной записью базы данных |
| /dbs/{dbName} |Базы данных с идентификатором, соответствующим значению {dbName} |
| /dbs/{dbName}/colls/ |Канал коллекций в базе данных |
| /dbs/{dbName}/colls/{collName} |Коллекция с идентификатором, соответствующим значению {collName} |
| /dbs/{dbName}/colls/{collName}/docs |Канал документов в коллекции |
| /dbs/{dbName}/colls/{collName}/docs/{docId} |Документ с идентификатором, соответствующим значению {doc} |
| /dbs/{dbName}/users/ |Канал пользователей в базе данных |
| /dbs/{dbName}/users/{userId} |Пользователь с идентификатором, соответствующим значению {user} |
| /dbs/{dbName}/users/{userId}/permissions |Канал разрешений для пользователя |
| /dbs/{dbName}/users/{userId}/permissions/{permissionId} |Разрешение с идентификатором, соответствующим значению {permission} |

Каждый ресурс имеет уникальное имя определяемого пользователем, представляемый через свойство идентификатора. Примечание: для документов, если пользователь не указывает идентификатор, пакеты SDK автоматически создать уникальный идентификатор для документа. Идентификатор является определяемой пользователем строкой, до 256 символов, уникален в контексте определенного родительского ресурса. 

Каждый ресурс также имеет иерархический идентификатор ресурсов, генерируемый системой (также известный как RID), который доступен через свойство _rid. RID кодирует всю иерархию данного ресурса, и это удобное внутреннее представление, которое используется для обеспечения ссылочной целостности распределенным способом. RID является уникальным в пределах учетной записи базы данных и используется службой Cosmos DB для эффективной маршрутизации без перекрестного поиска по секциям. Значения свойств _self и _rid являются альтернативным и каноническим представлениями ресурса. 

Интерфейсы REST API поддерживают адресацию ресурсов и маршрутизацию запросов по свойствам id и _rid.

## <a name="database-accounts"></a>Учетные записи базы данных
Вы можете подготовить одну или несколько учетных записей базы данных Cosmos DB с помощью подписки Azure.

Можно создавать и управлять учетными записями базы данных Cosmos DB через портал Azure на [http://portal.azure.com/](https://portal.azure.com/). Создание и управление учетной записью базы данных требует наличия административного доступа и может быть выполнено только в рамках вашей подписки Azure. 

### <a name="database-account-properties"></a>Свойства учетной записи базы данных
В рамках подготовки учетной записи базы данных и управления ею можно настроить следующие свойства и ознакомиться с ними:  

<table border="0" cellspacing="0" cellpadding="0">
    <tbody>
        <tr>
            <td valign="top"><p><strong>Имя свойства</strong></p></td>
            <td valign="top"><p><strong>Описание</strong></p></td>
        </tr>
        <tr>
            <td valign="top"><p>Политика согласованности</p></td>
            <td valign="top"><p>Установите это свойство, чтобы настроить уровень согласованности по умолчанию для всех коллекций под вашей учетной записью базы данных. Вы можете переопределить уровень согласованности для каждого запроса, используя заголовок запроса x-ms-consistency-level. <p><p>Это свойство применяется только к <i>определяемых пользователем ресурсов</i>. Все определяемые системой ресурсы настроены для поддержки чтения и запросов с сильной согласованностью.</p></td>
        </tr>
        <tr>
            <td valign="top"><p>Ключи авторизации</p></td>
            <td valign="top"><p>Первичная и Вторичная master и readonly ключи, обеспечения административного доступа ко всем ресурсам под учетной записью базы данных.</p></td>
        </tr>
    </tbody>
</table>

Помимо инициализации, настройке и управлении вашей учетной записи базы данных на портале Azure можно также программно создать и управлять учетными записями Cosmos DB базы данных с помощью [API-интерфейсы DB Cosmos REST Azure](/rest/api/documentdb/) и [клиентских SDK](sql-api-sdk-dotnet.md).  

## <a name="databases"></a>Базы данных
База данных Cosmos DB является логическим контейнером из одного или нескольких коллекций и пользователей, как показано на следующей схеме. Вы можете создать любое количество баз данных в учетной записи базы данных Cosmos DB с учетом предложенных ограничений.  

![Учетная запись базы данных и иерархическая модель коллекций][2]  
**База данных представляет собой логический контейнер пользователей и коллекций**

База данных может содержать практически неограниченное хранилище документов, секционированное внутри коллекций.

### <a name="elastic-scale-of-an-azure-cosmos-db-database"></a>Эластичное масштабирование базы данных Azure Cosmos DB
База данных Cosmos DB по умолчанию является гибкой: ее размер варьируется от нескольких гигабайт до петабайт хранилищ документов на базе SSD и подготовленной пропускной способности. 

В отличие от традиционных реляционных СУБД базы данных в Cosmos DB не ограничены одним компьютером. Cosmos DB позволяет создавать больше коллекций и баз данных по мере увеличения масштаба вашего приложения. Действительно, различные собственные приложения в корпорации Майкрософт уже используют Azure Cosmos DB в потребительском масштабе, создавая чрезвычайно большие базы данных Azure Cosmos DB, каждая из которых содержит тысячи коллекций с терабайтами хранилищ документов. Вы можете увеличить или уменьшить базу данных, добавляя или удаляя коллекции для удовлетворения требований масштабности вашего приложения. 

Вы можете создать любое количество коллекций в пределах субъекта базы данных в рамках своего предложения. Для каждой коллекции выделяется хранилище на базе SSD-накопителей и пропускная способность с учетом выбранного уровня производительности.

База данных Azure Cosmos DB также выступает контейнером пользователей. Пользователь, в свою очередь, является логическим пространством имен для набора разрешений, обеспечивающее точное авторизации и доступ к коллекции, документы и вложения.  

Как с другими ресурсами в модели ресурсов Azure Cosmos DB баз данных можно создавать, заменен, удален, чтение или перечисление легко с помощью либо [API-интерфейс REST](/rest/api/documentdb/) или [клиентских SDK](sql-api-sdk-dotnet.md). Azure Cosmos DB гарантирует строгую согласованность для чтения или запроса метаданных ресурса базы данных. Удаление базы данных автоматически означает, что вы больше не сможете получить доступ к любой из коллекций или пользователям, содержащимся в ней.   

## <a name="collections"></a>Коллекции
Коллекция Cosmos DB — это контейнер для документов JSON. 

### <a name="elastic-ssd-backed-document-storage"></a>Гибкое хранилище документов на базе SSD
Коллекция является неразрывно гибкой, она автоматически увеличивается и уменьшается по мере добавления или удаления документов. Коллекции — это логические ресурсы, они могут включать в себя одну или несколько физических секций или серверов. Число секций в коллекции определяется Cosmos DB на основе размера хранилища и подготовленной пропускной способности коллекции. С каждой секцией в базе данных Azure Cosmos DB связано фиксированное количество хранилищ на основе SSD, которое реплицируется для обеспечения высокого уровня доступности. Управление секциями полностью осуществляется базой данных Azure Cosmos DB, и нет необходимости создавать сложный код или управлять секциями. Коллекции Cosmos DB **практически не ограничены** в объеме хранилища и пропускной способности. 

### <a name="automatic-indexing-of-collections"></a>Автоматическое индексирование коллекций
Azure Cosmos DB — это система баз данных без схемы. Она не подразумевает и не требует указания каких-либо схем для документов JSON. По мере добавления документов в коллекцию Azure Cosmos DB автоматически индексирует их, и они становятся доступны для выполнения запросов. Автоматическое индексирование документов без схемы или вторичные индексы — это ключевой компонент Azure Cosmos DB и включается с помощью методов обслуживания индекса, оптимизированными для записи, без блокировки и структуре журнала. Azure Cosmos DB поддерживает устойчивый объем чрезвычайно быстрых операций записи и в то же время обслуживает согласованные запросы. Хранилище и документов и индекса используется для расчета объема хранения, потребляемого каждой коллекцией. Вы можете управлять компромиссом между объемом хранения и производительностью, связанным с индексацией по настройке политики индексирования для коллекции. 

### <a name="configuring-the-indexing-policy-of-a-collection"></a>Настройка политики индексирования коллекции
Политика индексирования каждой коллекции позволяет настраивать соотношения производительности и объема, связанные с индексацией. Для конфигурации индексирования доступны следующие параметры:  

* Выберите, будет ли коллекция автоматически индексировать все документы или нет. По умолчанию все документы индексируются автоматически. Можно отключать автоматическое индексирование и добавлять только выбранные документы в индекс. И наоборот, вы можете выборочно указать, какие документы необходимо исключить из индексирования. Этого можно достичь, присвоив свойству автоматического быть true или false в indexingPolicy коллекции и с помощью заголовка запроса [x-ms-indexingdirective] во время вставки, замены или удаления документов.  
* Укажите, следует ли включить или исключить определенные пути или шаблоны в документах из индекса. Вы можете добиться этого путем установки includedPaths и excludedPaths на indexingPolicy коллекции соответственно. Вы также можете настроить соотношения объема и производительности для интервала и хэш-запросов для конкретных шаблонов пути. 
* Выбор между синхронными обновлениями (согласованные) и асинхронными обновлениями (отложенные) индекса. По умолчанию, индекс обновляется синхронно при каждой операции вставки, заменить или удаления документа в коллекции. Это позволяет выполнять запросы с уровнем согласованности, как и в документе. В то время как служба Azure Cosmos DB оптимизирована для операций записи и поддерживает устойчивые объемы операций записи, синхронное обслуживание индекса и обслуживание согласованных запросов, вы можете настроить определенные коллекции для отложенного обновления их ​​индексов. Отложенное индексирование еще больше повышает производительность операций записи и идеально подходит для сценариев пакетной вставки, прежде всего для чтения больших коллекций.

Вы можете изменить политику индексирования, выполнив запрос PUT для коллекции. Это можно сделать либо с помощью [пакет SDK для клиента](sql-api-sdk-dotnet.md), [портал Azure](https://portal.azure.com) или [API-интерфейс REST](/rest/api/documentdb/).

### <a name="querying-a-collection"></a>Запросы к коллекции
Документы в коллекции могут иметь произвольные схемы, и вы можете запрашивать их без предварительного предоставления любой схемы или вторичных индексов. Вы можете запрашивать коллекции с помощью [Справочник по синтаксису базы данных SQL Azure Cosmos](https://msdn.microsoft.com/library/azure/dn782250.aspx), который играет роль форматированного операторы иерархических реляционных и Пространственные через определяемые пользователем функции на основе JavaScript. Грамматика JSON позволяет моделировать документы JSON в форме деревьев с метками в качестве узлов. Это будет использован как автоматического индексирования методы SQL API, а также Azure Cosmos DB разновидности языка SQL. Язык запросов SQL состоит из трех основных этапов:   

1. Небольшой набор операций запросов, которые естественным образом отображаются в древовидной структуре в том числе иерархических запросов и проекций. 
2. Подмножество реляционных операций, включая композиции, фильтров, проекции, статистические выражения и самосоединения. 
3. Пользовательские функции на основе чистого JavaScript, которые работают с (1) и (2)  

Запрос модели Azure Cosmos DB предпринимает попытку соблюсти баланс между функциональные возможности, эффективность и простота. Ядро базы данных Azure Cosmos DB непосредственно компилирует и выполняет инструкции SQL-запросов. Вы можете запросить коллекцию с помощью [интерфейсов REST API](/rest/api/documentdb/) или любого из [клиентских пакетов SDK](sql-api-sdk-dotnet.md). В комплект пакета .NET SDK входит поставщик LINQ.

> [!TIP]
> Можно испытать API-Интерфейсы SQL и выполнение запросов SQL, используя наш набор данных в [площадку запросов](https://www.documentdb.com/sql/demo).
> 
> 

## <a name="multi-document-transactions"></a>Операции над несколькими документами
Транзакции в базах данных обеспечивают безопасную и предсказуемую модель программирования для работы с одновременными изменениями данных. В РСУБД традиционный способ создания бизнес-логики заключается в том, чтобы написать **хранимые процедуры** и (или) **триггеры** и передать их на сервер базы данных для выполнения в транзакциях. В РСУБД, прикладному программисту приходится иметь дело с двумя разнородными языками программирования: 

* Приложения (нетранзакционных), языке (например, JavaScript, Python, C#, Java, и т. д.)
* T-SQL, транзакций язык программирования, который выполняется непосредственно в базе данных

Так как служба является оптимизированной для JavaScript и JSON непосредственно в базе данных, Azure Cosmos DB обеспечивает интуитивную модель программирования для выполнения логики приложения на основе JavaScript непосредственно в коллекциях в виде хранимых процедур и триггеров. Это позволяет получить

* с одной стороны, эффективные механизмы восстановления, управления параллелизмом и автоматической индексации графов объектов JSON прямо в ядре СУБД;
* Естественно выражения потока управления, переменной области, назначения и интеграции примитивы с транзакциями баз данных непосредственно с точки зрения языка программирования JavaScript обработки исключений

Логика JavaScript, регистрируемая на уровне коллекции, может выполнять операции с базами данных на документах данной коллекции. Azure Cosmos DB неявно обертывает хранимые процедуры и триггеры на основе JavaScript в пределах транзакций ACID с изоляцией моментальных снимков документов в коллекции. В ходе его исполнения, если код JavaScript генерирует исключение, то вся транзакция прерывается. Полученная модель программирования является очень простой, но мощной. Разработчики JavaScript получают "надежную" модель программирования, при этом используя привычные языковые конструкции и библиотечные примитивы.   

Возможность выполнить JavaScript непосредственно в ядре базы данных в том же адресном пространстве, что буферный пул, позволяет производительное и транзакционное выполнение операций с базами данных над документами коллекции. Кроме того, ядро СУБД Cosmos DB оптимизировано для JSON и JavaScript, что устраняет несоответствия между системами типов приложения и базой данных.   

После создания коллекции, можно зарегистрировать хранимые процедуры, триггеры и определяемые пользователем функции коллекции с помощью [API-интерфейс REST](/rest/api/documentdb/) или [клиентских SDK](sql-api-sdk-dotnet.md). После регистрации вы можете использовать и выполнять их. Рассмотрим приведенный ниже код хранимой процедуры, написанный полностью на JavaScript. Процедура принимает два аргумента (имя книги и имя автора), создает новый документ, выполняет запрос документа и обновляет его. Все эти действия выполняются в ходе неявной транзакции ACID. Транзакция будет прервана в любой момент выполнения, если будет выдано исключение JavaScript.

    function businessLogic(name, author) {
        var context = getContext();
        var collectionManager = context.getCollection();        
        var collectionLink = collectionManager.getSelfLink()

        // create a new document.
        collectionManager.createDocument(collectionLink,
            {id: name, author: author},
            function(err, documentCreated) {
                if(err) throw new Error(err.message);

                // filter documents by author
                var filterQuery = "SELECT * from root r WHERE r.author = 'George R.'";
                collectionManager.queryDocuments(collectionLink,
                    filterQuery,
                    function(err, matchingDocuments) {
                        if(err) throw new Error(err.message);

                        context.getResponse().setBody(matchingDocuments.length);

                        // Replace the author name for all documents that satisfied the query.
                        for (var i = 0; i < matchingDocuments.length; i++) {
                            matchingDocuments[i].author = "George R. R. Martin";
                            // we don’t need to execute a callback because they are in parallel
                            collectionManager.replaceDocument(matchingDocuments[i]._self,
                                matchingDocuments[i]);   
                        }
                    })
            })
    };

Клиент может "грузить" вышеуказанную JavaScript логику в базу данных для транзакционного исполнения через HTTP POST. Дополнительные сведения об использовании методов HTTP см. в статье [Azure Cosmos DB: Azure Cosmos DB REST API](https://msdn.microsoft.com/library/azure/mt622086.aspx) (Azure Cosmos DB. REST API Azure Cosmos DB). 

    client.createStoredProcedureAsync(collection._self, {id: "CRUDProc", body: businessLogic})
       .then(function(createdStoredProcedure) {
            return client.executeStoredProcedureAsync(createdStoredProcedure.resource._self,
                "NoSQL Distilled",
                "Martin Fowler");
        })
        .then(function(result) {
            console.log(result);
        },
        function(error) {
            console.log(error);
        });


Обратите внимание, что, поскольку база данных изначально понимает JSON и JavaScript, нет проблемы несоответствия типов, нет "отображения ИЛИ" или генерации "магического" кода.   

Хранимые процедуры и триггеры взаимодействуют с коллекцией и документами в коллекции через четко определенную объектную модель, которая отражает текущий контекст коллекции.  

Коллекции в API-Интерфейсы SQL могут создаваться, удаленные, чтения или перечисляемый тип, легко с помощью [API-интерфейс REST](/rest/api/documentdb/) или [клиентских SDK](sql-api-sdk-dotnet.md). API-Интерфейсы SQL всегда предоставляет строгая согласованность для запроса метаданных коллекции или чтения. Удаление коллекции автоматически гарантирует, что вы не сможете получить доступ к любому из документов, вложений, хранимых процедур, триггеров и пользовательских функций, содержащихся в ней.   

## <a name="stored-procedures-triggers-and-user-defined-functions-udf"></a>Хранимые процедуры, триггеры и пользовательской функции (UDF)
Как описано в предыдущем разделе, вы можете реализовать логику приложения для непосредственного исполнения в рамках транзакции ядра СУБД. Логика приложения может быть написан полностью в JavaScript и могут задаваться в виде хранимой процедуры, триггера или определяемой пользователем функции. Код JavaScript в хранимой процедуре или триггере insert, замените, удалить, читать или запрос документов в коллекции. С другой стороны, код JavaScript в определяемой пользователем функции не может добавлять, заменять или удалять документы. Определяемые пользователем функции перечисляют документы из результата запроса и создают новый набор результатов. Мультитенантность Azure Cosmos DB обеспечивает управление strict ресурсов на основе резервирования. Каждый хранимой процедурой, триггером или определяемой пользователем функции возвращает такта основных ресурсов операционной системы для выполнения своей работы. Кроме того хранимые процедуры, триггеры или определяемые пользователем функции не удается создать связь от внешних библиотек JavaScript и черный, если они превышают бюджетов ресурсов, распределенных на них. Можно зарегистрировать, отмените регистрацию хранимые процедуры, триггеры или определяемые пользователем функции с коллекцией, с помощью API REST.  После регистрации хранимой процедуры, триггера или определяемой пользователем функции предварительно компилируется и хранится как байтовый код, который исполняется в более поздней версии. Следующие illustrateshow ssection, пакет SDK Azure Cosmos DB JavaScript можно использовать для регистрации, выполнения и отмены регистрации хранимой процедуры, триггера, определяемой пользователем функции. Пакет SDK JavaScript является простой программой-оболочкой [интерфейсов REST API](/rest/api/documentdb/). 

### <a name="registering-a-stored-procedure"></a>Регистрация хранимой процедуры
Регистрация хранимой процедуры — это создание нового ресурса хранимой процедуры ресурса в коллекции с помощью HTTP POST.  

    var storedProc = {
        id: "validateAndCreate",
        body: function (documentToCreate) {
            documentToCreate.id = documentToCreate.id.toUpperCase();

            var collectionManager = getContext().getCollection();
            collectionManager.createDocument(collectionManager.getSelfLink(),
                documentToCreate,
                function(err, documentCreated) {
                    if(err) throw new Error('Error while creating document: ' + err.message;
                    getContext().getResponse().setBody('success - created ' + 
                            documentCreated.name);
                });
        }
    };

    client.createStoredProcedureAsync(collection._self, storedProc)
        .then(function (createdStoredProcedure) {
            console.log("Successfully created stored procedure");
        }, function(error) {
            console.log("Error");
        });

### <a name="executing-a-stored-procedure"></a>Выполнение хранимой процедуры
Выполнение хранимой процедуры осуществляется с помощью команды HTTP POST, запускаемой для существующего ресурса хранимой процедуры, с передачей параметров в теле запроса.

    var inputDocument = {id : "document1", author: "G. G. Marquez"};
    client.executeStoredProcedureAsync(createdStoredProcedure.resource._self, inputDocument)
        .then(function(executionResult) {
            assert.equal(executionResult, "success - created DOCUMENT1");
        }, function(error) {
            console.log("Error");
        });

### <a name="unregistering-a-stored-procedure"></a>Отмена регистрации хранимой процедуры
Отменить регистрацию хранимой процедуры можно с помощью команды HTTP DELETE, выполняемой для существующего ресурса хранимой процедуры.   

    client.deleteStoredProcedureAsync(createdStoredProcedure.resource._self)
        .then(function (response) {
            return;
        }, function(error) {
            console.log("Error");
        });


### <a name="registering-a-pre-trigger"></a>Регистрация триггера со срабатыванием до наступления события
Регистрация триггера осуществляется путем создания ресурса триггера в коллекции с помощью команды HTTP POST. Можно указать, если триггер является предварительной или триггер post и тип операции, он может быть связан (например, Create, Replace, Delete или все).   

    var preTrigger = {
        id: "upperCaseId",
        body: function() {
                var item = getContext().getRequest().getBody();
                item.id = item.id.toUpperCase();
                getContext().getRequest().setBody(item);
        },
        triggerType: TriggerType.Pre,
        triggerOperation: TriggerOperation.All
    }

    client.createTriggerAsync(collection._self, preTrigger)
        .then(function (createdPreTrigger) {
            console.log("Successfully created trigger");
        }, function(error) {
            console.log("Error");
        });

### <a name="executing-a-pre-trigger"></a>Запуск триггера со срабатыванием до наступления события
Выполнение триггера производится путем указания в заголовке запроса имени существующего триггера в момент выдачи запроса POST/PUT/DELETE к ресурсу документа.  

    client.createDocumentAsync(collection._self, { id: "doc1", key: "Love in the Time of Cholera" }, { preTriggerInclude: "upperCaseId" })
        .then(function(createdDocument) {
            assert.equal(createdDocument.resource.id, "DOC1");
        }, function(error) {
            console.log("Error");
        });

### <a name="unregistering-a-pre-trigger"></a>Отмена регистрации триггера со срабатыванием до наступления события
Отменить регистрацию триггера можно с помощью команды HTTP DELETE, выполняемой для существующего ресурса триггера.  

    client.deleteTriggerAsync(createdPreTrigger._self);
        .then(function(response) {
            return;
        }, function(error) {
            console.log("Error");
        });

### <a name="registering-a-udf"></a>Регистрация определяемой пользователем функции
Регистрация определяемой пользователем функции осуществляется путем создания нового ресурса UDF в коллекции или через команду HTTP POST.  

    var udf = { 
        id: "mathSqrt",
        body: function(number) {
                return Math.sqrt(number);
        },
    };
    client.createUserDefinedFunctionAsync(collection._self, udf)
        .then(function (createdUdf) {
            console.log("Successfully created stored procedure");
        }, function(error) {
            console.log("Error");
        });

### <a name="executing-a-udf-as-part-of-the-query"></a>Выполнение определяемой пользователем функции как части запроса
Определяемая пользователем Функция может быть указан как часть запроса SQL и используется как способ расширения ядро [язык запросов SQL](sql-api-sql-query-reference.md).

    var filterQuery = "SELECT udf.mathSqrt(r.Age) AS sqrtAge FROM root r WHERE r.FirstName='John'";
    client.queryDocuments(collection._self, filterQuery).toArrayAsync();
        .then(function(queryResponse) {
            var queryResponseDocuments = queryResponse.feed;
        }, function(error) {
            console.log("Error");
        });

### <a name="unregistering-a-udf"></a>Отмена регистрации определяемой пользователем функции
Отменить регистрацию определяемой пользователем функции можно с помощью команды HTTP DELETE, выполняемой для существующего ресурса UDF.  

    client.deleteUserDefinedFunctionAsync(createdUdf._self)
        .then(function(response) {
            return;
        }, function(error) {
            console.log("Error");
        });

Несмотря на то, что фрагменты выше показал регистрации (POST), отмены регистрации (PUT), чтения или списка (GET) и выполнения (POST) через [JavaScript SDK](https://github.com/Azure/azure-documentdb-js), можно также использовать [API-интерфейс REST](/rest/api/documentdb/) или других [клиентских SDK](sql-api-sdk-dotnet.md). 

## <a name="documents"></a>Документы
Можно вставить, замените, удаление, чтение, перечисления и запрос произвольных документов JSON в коллекции. Azure Cosmos DB не требует указывать схему и создавать вторичные индексы для поддержки запросов к документам в коллекции. Максимальный размер документа составляет 2 МБ.   

Будучи полностью открыть базу данных службы, Azure Cosmos DB не придумать типы специальных данных (например, Дата и время) и кодирование для конкретных документов JSON. Azure Cosmos DB не требуются все специальные соглашения JSON пожалейте отношения между различных документов; синтаксис SQL Azure Cosmos DB предоставляет очень мощный иерархических и реляционных запросов операторов запроса и документы без специальных заметок и необходимость пожалейте связи между документами с помощью различающиеся свойства.  

Как и другими ресурсами, документы могут создаваться, заменен, удален, чтение, перечисления и запрашивать легко с помощью API-интерфейс REST или любого из [клиентских SDK](sql-api-sdk-dotnet.md). Удаление документа мгновенно освобождает квоту, соответствующую всем его вложениям. Уровень согласованности для чтения документов соответствует политике согласованности для учетной записи базы данных. Эта политика может быть переопределена для каждого запроса в зависимости от требований к согласованности данных для вашего приложения. При запросе документов согласованность чтения соответствует режиму индексирования, который задан в коллекции. Понятие "согласованность" следует политике согласованности для учетной записи базы данных. 

## <a name="attachments-and-media"></a>Вложения и мультимедиа
Azure Cosmos DB позволяет хранить большие двоичные объекты и мультимедийные файлы непосредственно в Azure Cosmos DB (не более 2 ГБ на одну учетную запись) или в удаленном хранилище файлов. Она также позволяет представлять метаданные медиафайлов в виде особого документа под названием "вложение". Вложение в Azure Cosmos DB — это специальный документ (JSON), который ссылается на медиафайлы или большие двоичные объекты, которые могут хранится где угодно. Вложение является просто специальные документ, который записывает метаданные носителей, хранящихся в удаленном носитель (например, расположение, автора и т.д.). 

Рассмотрим социальных чтения приложение, которое использует Azure Cosmos DB для хранения рукописные, а также метаданные, включая комментарии, закладки, оценки, отзывы и предложения, т. д., электронная книга определенного пользователя, связанный.   

* Содержание самой книги хранится в хранилище, доступном в виде части учетной записи базы данных Azure Cosmos DB или как удаленное хранилище. 
* Приложение может хранить метаданные для каждого пользователя, как документ distinct (например, метаданные Джо Книга1 хранится в документ, указанный /colls/joe/docs/book1). 
* Вложения, указывающий на содержимое страницы книги данного пользователя хранятся в соответствующий документ, /colls/joe/docs/book1/chapter1, /colls/joe/docs/book1/chapter2 и т. д. 

Приведенные выше примеры для передачи в иерархию ресурсов используйте понятное идентификаторы. Ресурсы доступны через API REST с помощью уникальных идентификаторов ресурсов. 

Для носителя, управляется Azure Cosmos DB свойство _media вложения ссылается мультимедиа по URI. Azure Cosmos DB запустит уборку мусора, когда все находящиеся в коллекции ссылки на медиафайл будут удалены. Azure Cosmos DB автоматически генерирует вложение, когда вы загружаете новые мультимедиа файлы, и заполняет свойство _media ссылками на вновь добавленные файлы. Если вы решите сохранить мультимедиа в хранилище BLOB-объектов, управляется вами (например, OneDrive, хранилище Azure, DropBox и т. д), вложения по-прежнему можно использовать для ссылки на носитель. В этом случае вам придется создавать вложение и заполнять его свойство _media самостоятельно.   

Как вложения могут создаваться с другими ресурсами, заменены, удален, чтение или перечисление легко с помощью API-интерфейс REST или любой клиент SDK. Как и для документов, уровень согласованности для чтения вложений соответствует политике согласованности для учетной записи базы данных. Эта политика может быть переопределена для каждого запроса в зависимости от требований к согласованности данных для вашего приложения. При запросе вложений согласованность чтения соответствует режиму индексирования, который задан в коллекции. Понятие "согласованность" следует политике согласованности для учетной записи базы данных. 
 

## <a name="users"></a>Пользователи
Пользователь в Azure Cosmos DB представляет собой логическое пространство имен для группировки разрешений. Пользователю в Azure Cosmos DB может соответствовать пользователь в системе управления удостоверениями или предопределенной роли приложения. В рамках Azure Cosmos DB пользователь представляет собой абстракцию для группировки набора разрешений в базе данных.   

Для реализации Многопользовательские приложения в приложении, можно создать пользователей в Azure Cosmos DB, который соответствует вашей фактических пользователей или клиентов приложения. Затем можно создать разрешения для данного пользователя, которые соответствуют уровням доступа к различным коллекциям, документам, приложениям и т. д.   

По мере расширения вашего приложения с ростом количества пользователей вы можете использовать различные способы для сегментирования данных. Вы можете смоделировать каждого из пользователей следующим образом:   

* каждый пользователь сопоставлен базе данных;
* каждый пользователь сопоставлен коллекции; 
* документы, соответствующие нескольким пользователям, отправляются в выделенную коллекцию; 
* документы, соответствующие нескольким пользователям, отправляются в набор коллекций.   

Независимо от конкретной стратегии сегментирования, вы можете моделировать реальных пользователей в качестве пользователей в базе данных Azure Cosmos DB и присваивать точные разрешения каждому.  

![Коллекции пользователей][3]  
**Стратегии сегментирования и моделирования пользователей**

Как и остальные ресурсы пользователей в базе данных Azure Cosmos могут быть созданы, заменены, удаленных, чтение или перечисление легко с помощью API-интерфейс REST или любой клиент SDK. Azure Cosmos DB всегда обеспечивает строгую согласованность для чтения или запроса метаданных ресурса пользователя. Стоит отметить, что при удалении пользователя гарантируется, что вы не сможете получить доступ к любому из разрешений, входящих в его состав. Удаленные разрешения станут доступны сразу же для повторного использования, несмотря на то что Azure Cosmos DB восстанавливает квоту разрешений удаленного пользователя в фоновом режиме.  

## <a name="permissions"></a>Разрешения
С точки зрения управления доступом, ресурсы, такие как учетные записи базы данных, базы данных, пользователей и разрешений, считаются *администратора* ресурсы, поскольку они требуются административные разрешения. С другой стороны, ресурсы, включая коллекции, документы, вложения, хранимые процедуры, триггеры и пользовательские функции, находятся в области видимости данной базы данных и рассматриваются как *ресурсы приложения*. В соответствии с двумя типами ресурсов и ролями, которые обращаются к ним (администратора и пользователей), модель авторизации определяет два типа *ключей доступа*: *главный ключ* и *ключ ресурса*. Мастер-ключ является частью учетной записи базы данных и предоставляется разработчику (или администратору), который подготавливает учетную запись базы данных. Этот мастер-ключ имеет семантику администратора, в том смысле, что он может быть использован для того, чтобы разрешить доступ как к административным, так и к прикладным ресурсам. В отличие от этого, ключ ресурса является разделенным ключом доступа, который позволяет получить доступ к *определенному* ресурсу приложения. Таким образом он получает связь между пользователем базы данных и разрешения, которые пользователь имеет для определенного ресурса (например, коллекции, документ, вложения, хранимой процедурой, триггером или определяемой пользователем функции).   

Единственным способом получить ключ ресурса является создание разрешения для ресурса под конкретного пользователя. Обратите внимание, что в для создания или получения разрешения, мастер-ключ должен быть представлен в заголовке авторизации. Ресурс разрешения связывает ресурс, доступ к нему и пользователя. После создания разрешения ресурса пользователю нужно только предоставить ключ, связанный с ресурсами, для того чтобы получить доступ к соответствующему ресурсу. Таким образом, ключ ресурса можно рассматривать как логическое и компактное представление разрешения ресурса.  

Как со всех других ресурсов, можно создать разрешения в базе данных Azure Cosmos, заменены, удален, чтение или перечисление легко с помощью API-интерфейс REST или любой клиент SDK. Azure Cosmos DB всегда обеспечивает предельную согласованность для чтения или запроса метаданных разрешения. 

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о работе с ресурсами с помощью команд HTTP см. в статье [Azure Cosmos DB: Azure Cosmos DB REST API](https://msdn.microsoft.com/library/azure/mt622086.aspx) (Azure Cosmos DB. REST API Azure Cosmos DB).

[1]: media/sql-api-resources/resources1.png
[2]: media/sql-api-resources/resources2.png
[3]: media/sql-api-resources/resources3.png


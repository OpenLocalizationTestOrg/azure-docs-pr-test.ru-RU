---
title: "Поддержка брандмауэра Azure Cosmos DB и контроль доступа по протоколу IP | Документация Майкрософт"
description: "Сведения о настройке поддержки брандмауэра в учетных записях базы данных Azure Cosmos DB с помощью политик контроля доступа на основе IP-адресов."
keywords: "Контроль доступа на основе IP-адресов, поддержка брандмауэра"
services: cosmos-db
author: shahankur11
manager: jhubbard
editor: 
tags: azure-resource-manager
documentationcenter: 
ms.assetid: c1b9ede0-ed93-411a-ac9a-62c113a8e887
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/22/2017
ms.author: ankshah
ms.openlocfilehash: e08c0ba9c1fc0bab72ae8c1158aafaad4f66920e
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="azure-cosmos-db-firewall-support"></a>Поддержка брандмауэра для Azure Cosmos DB
Для защиты данных, хранящихся в учетных записях базы данных Azure Cosmos DB, в Cosmos DB реализована поддержка [модели авторизации](https://msdn.microsoft.com/library/azure/dn783368.aspx) на основе секретов. Проверка целостности данных в этой модели осуществляется с помощью надежного кода проверки подлинности сообщений, использующего хэш-функции (HMAC). Теперь, помимо модели авторизации на основе секрета, для поддержки входящего трафика брандмауэра база данных Azure Cosmos DB использует политики контроля доступа на основе IP-адресов. Эта модель очень похожа на правила брандмауэра в традиционной системе базы данных и предоставляет дополнительный уровень безопасности для учетных записей базы данных Azure Cosmos DB. Кроме того, эта модель позволяет настроить доступ к учетной записи базы данных Azure Cosmos DB только из утвержденных компьютеров и (или) облачных служб. Для доступа к ресурсам Azure Cosmos DB из этих утвержденных компьютеров и служб пользователь (вызывающая сторона) по-прежнему должен предоставить допустимый маркер проверки подлинности.

## <a name="ip-access-control-overview"></a>Общие сведения о контроле доступа на основе IP-адресов
По умолчанию доступ к учетной записи базы данных Azure Cosmos DB можно получить через Интернет при условии, что запрос сопровождается допустимым маркером проверки подлинности. Чтобы настроить политики контроля доступа на основе IP-адресов, пользователь должен предоставить набор IP-адресов или их диапазонов в нотации CIDR, которые добавляются в список разрешенных клиентских IP-адресов для указанной учетной записи базы данных. После применения этой конфигурации сервер блокирует все запросы, полученные от компьютеров, IP-адреса которых не входят в список разрешенных.  На следующей схеме показан поток обработки подключения для контроля доступа на основе IP-адресов.

![Схема подключения для контроля доступа на основе IP-адресов](./media/firewall-support/firewall-support-flow.png)

## <a name="connections-from-cloud-services"></a>Подключения из облачных служб
В Azure облачные службы — это стандартный способ размещения логики службы среднего уровня с помощью Azure Cosmos DB. Чтобы разрешить доступ к учетной записи базы данных Azure Cosmos DB из облачной службы, общедоступный IP-адрес этой службы необходимо добавить в список разрешенных IP-адресов, связанных с учетной записью базы данных Azure Cosmos DB. Для этого следует [настроить политику контроля доступа на основе IP-адресов](#configure-ip-policy).  Это позволит обеспечить доступ к учетной записи базы данных Azure Cosmos DB для всех экземпляров ролей облачных служб. IP-адреса для ваших облачных служб можно получить на портале Azure, как показано на следующем снимке экрана.

![Снимок экрана с общедоступным IP-адресом для облачной службы на портале Azure](./media/firewall-support/public-ip-addresses.png)

При расширении своей облачной службы за счет добавления дополнительных экземпляров ролей эти новые экземпляры автоматически получают доступ к учетной записи базы данных Azure Cosmos DB, так как они входят в ту же самую облачную службу.

## <a name="connections-from-virtual-machines"></a>Подключения из виртуальных машин
[Виртуальные машины](https://azure.microsoft.com/services/virtual-machines/) или [масштабируемые наборы виртуальных машин](../virtual-machine-scale-sets/virtual-machine-scale-sets-overview.md) также можно использовать для размещения служб среднего уровня с помощью Azure Cosmos DB.  Чтобы настроить доступ к учетной записи базы данных Azure Cosmos DB из виртуальных машин, общедоступные IP-адреса виртуальной машины и (или) масштабируемого набора виртуальных машин необходимо добавить в список разрешенных IP-адресов для этой учетной записи. Для этого следует [настроить политику контроля доступа на основе IP-адресов](#configure-ip-policy). IP-адреса для виртуальных машин можно получить на портале Azure, как показано на следующем снимке экрана.

![Снимок экрана с общедоступным IP-адресом для виртуальной машины на портале Azure](./media/firewall-support/public-ip-addresses-dns.png)

При добавлении в группу дополнительных экземпляров виртуальных машин они автоматически получают доступ к вашей учетной записи базы данных Azure Cosmos DB.

## <a name="connections-from-the-internet"></a>Подключения через Интернет
При подключении к учетной записи базы данных Azure Cosmos DB с компьютера через Интернет IP-адрес или диапазон IP-адресов клиента необходимо добавить в список разрешенных IP-адресов для этой учетной записи. 

## <a id="configure-ip-policy"></a> Настройка политики контроля доступа на основе IP-адресов
Политику контроля доступа по протоколу IP можно задать на портале Azure или программно с помощью [интерфейса командной строки Azure (Azure CLI)](cli-samples.md), [Azure Powershell](powershell-samples.md) или [REST API](/rest/api/documentdb/), обновив свойство `ipRangeFilter`. IP-адреса и их диапазоны должны быть разделены запятой без пробелов. Пример: "13.91.6.132,13.91.6.1/24". При обновлении учетной записи базы данных с помощью этих методов обязательно заполните все свойства, чтобы предотвратить сброс до значений до умолчанию.

> [!NOTE]
> После включения политики контроля доступа на основе IP-адресов для учетной записи базы данных Azure Cosmos DB все подключения к этой учетной записи с компьютеров, диапазоны IP-адресов которых не входят в список разрешенных, блокируются. При использовании этой модели просмотр операций с плоскостью данных на портале также блокируется, чтобы обеспечить целостность контроля доступа.

Для упрощения разработки портал Azure помогает определить и добавить IP-адрес клиентского компьютера в список разрешенных адресов, чтобы приложения, работающие на вашем компьютере, могли получить доступ к учетной записи Azure Cosmos DB. Обратите внимание, что IP-адрес клиента определяется так, как он отображается на портале. Это может быть IP-адрес клиента вашего компьютера, а также IP-адрес вашего сетевого шлюза. Не забудьте удалить его до внесения изменений в рабочую среду.

Чтобы настроить политику контроля доступа на основе IP-адресов на портале Azure, перейдите к колонке учетной записи Azure Cosmos DB, в меню навигации щелкните **Брандмауэр**, а затем нажмите кнопку **ВКЛ.** 

![Снимок экрана, показывающий, как открыть колонку "Брандмауэр" на портале Azure](./media/firewall-support/azure-portal-firewall.png)

В новой области укажите, должен ли портал Azure иметь доступ к учетной записи, и настройте соответствующим образом другие адреса и диапазоны. Затем нажмите кнопку **Сохранить**.  

> [!NOTE]
> Чтобы обеспечить доступ к порталу Azure при включении политики контроля доступа на основе IP-адресов, необходимо добавить его IP-адрес. IP-адрес портала:
> |Регион|IP-адрес|
> |------|----------|
> |Все области, за исключением указанных ниже| 104.42.195.92|
> |Германия|51.4.229.218|
> |Китай|139.217.8.252|
> |Аризона (для обслуживания государственных организаций США)|52.244.48.71|
>

![Снимок экрана, показывающий, как настроить параметры брандмауэра на портале Azure](./media/firewall-support/azure-portal-firewall-configure.png)

## <a name="troubleshooting-the-ip-access-control-policy"></a>Устранение неполадок с политикой контроля доступа на основе IP-адресов
### <a name="portal-operations"></a>Операции на портале
После включения политики контроля доступа на основе IP-адресов для учетной записи базы данных Azure Cosmos DB все подключения к этой учетной записи с компьютеров, диапазоны IP-адресов которых не входят в список разрешенных, блокируются. Поэтому, чтобы разрешить на портале выполнение операций плоскости данных, таких как просмотр коллекций и запрос документов, необходимо явным образом разрешить доступ к порталу Azure с помощью колонки **Брандмауэр** на портале. 

![Снимок экрана, показывающий, как разрешить доступ к порталу Azure](./media/firewall-support/azure-portal-access-firewall.png)

### <a name="sdk--rest-api"></a>Пакет SDK и REST API
По соображениям безопасности при доступе с помощью пакета SDK и REST API с компьютеров, IP-адреса которых не входят в список разрешенных, вернется ответ с кодом 404 (объект не найден) без каких-либо дополнительных сведений. Проверьте список разрешенных IP-адресов и убедитесь, что политика имеет допустимую конфигурацию для учетной записи базы данных Azure Cosmos DB.

## <a name="next-steps"></a>Дальнейшие действия
Советы по улучшению производительности, связанные с сетью, см. в статье [Советы по улучшению производительности DocumentDB](performance-tips.md).


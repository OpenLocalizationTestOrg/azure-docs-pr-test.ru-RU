---
title: "Поддержка брандмауэра Azure Cosmos DB и контроль доступа по протоколу IP | Документация Майкрософт"
description: "Сведения о настройке поддержки брандмауэра в учетных записях базы данных Azure Cosmos DB с помощью политик контроля доступа на основе IP-адресов."
keywords: "Контроль доступа на основе IP-адресов, поддержка брандмауэра"
services: cosmos-db
author: shahankur11
manager: jhubbard
editor: 
tags: azure-resource-manager
documentationcenter: 
ms.assetid: c1b9ede0-ed93-411a-ac9a-62c113a8e887
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/22/2017
ms.author: ankshah
ms.openlocfilehash: e08c0ba9c1fc0bab72ae8c1158aafaad4f66920e
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="azure-cosmos-db-firewall-support"></a><span data-ttu-id="a2c0c-104">Поддержка брандмауэра для Azure Cosmos DB</span><span class="sxs-lookup"><span data-stu-id="a2c0c-104">Azure Cosmos DB firewall support</span></span>
<span data-ttu-id="a2c0c-105">Для защиты данных, хранящихся в учетных записях базы данных Azure Cosmos DB, в Cosmos DB реализована поддержка [модели авторизации](https://msdn.microsoft.com/library/azure/dn783368.aspx) на основе секретов. Проверка целостности данных в этой модели осуществляется с помощью надежного кода проверки подлинности сообщений, использующего хэш-функции (HMAC).</span><span class="sxs-lookup"><span data-stu-id="a2c0c-105">To secure data stored in an Azure Cosmos DB database account, Azure Cosmos DB has provided support for a secret based [authorization model](https://msdn.microsoft.com/library/azure/dn783368.aspx) that utilizes a strong Hash-based message authentication code (HMAC).</span></span> <span data-ttu-id="a2c0c-106">Теперь, помимо модели авторизации на основе секрета, для поддержки входящего трафика брандмауэра база данных Azure Cosmos DB использует политики контроля доступа на основе IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-106">Now, in addition to the secret based authorization model, Azure Cosmos DB supports policy driven IP-based access controls for inbound firewall support.</span></span> <span data-ttu-id="a2c0c-107">Эта модель очень похожа на правила брандмауэра в традиционной системе базы данных и предоставляет дополнительный уровень безопасности для учетных записей базы данных Azure Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-107">This model is very similar to the firewall rules of a traditional database system and provides an additional level of security to the Azure Cosmos DB database account.</span></span> <span data-ttu-id="a2c0c-108">Кроме того, эта модель позволяет настроить доступ к учетной записи базы данных Azure Cosmos DB только из утвержденных компьютеров и (или) облачных служб.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-108">With this model, you can now configure an Azure Cosmos DB database account to be accessible only from an approved set of machines and/or cloud services.</span></span> <span data-ttu-id="a2c0c-109">Для доступа к ресурсам Azure Cosmos DB из этих утвержденных компьютеров и служб пользователь (вызывающая сторона) по-прежнему должен предоставить допустимый маркер проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-109">Access to Azure Cosmos DB resources from these approved sets of machines and services still require the caller to present a valid authorization token.</span></span>

## <a name="ip-access-control-overview"></a><span data-ttu-id="a2c0c-110">Общие сведения о контроле доступа на основе IP-адресов</span><span class="sxs-lookup"><span data-stu-id="a2c0c-110">IP access control overview</span></span>
<span data-ttu-id="a2c0c-111">По умолчанию доступ к учетной записи базы данных Azure Cosmos DB можно получить через Интернет при условии, что запрос сопровождается допустимым маркером проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-111">By default, an Azure Cosmos DB database account is accessible from public internet as long as the request is accompanied by a valid authorization token.</span></span> <span data-ttu-id="a2c0c-112">Чтобы настроить политики контроля доступа на основе IP-адресов, пользователь должен предоставить набор IP-адресов или их диапазонов в нотации CIDR, которые добавляются в список разрешенных клиентских IP-адресов для указанной учетной записи базы данных.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-112">To configure IP policy-based access control, the user must provide the set of IP addresses or IP address ranges in CIDR form to be included as the allowed list of client IPs for a given database account.</span></span> <span data-ttu-id="a2c0c-113">После применения этой конфигурации сервер блокирует все запросы, полученные от компьютеров, IP-адреса которых не входят в список разрешенных.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-113">Once this configuration is applied, all requests originating from machines outside this allowed list will be blocked by the server.</span></span>  <span data-ttu-id="a2c0c-114">На следующей схеме показан поток обработки подключения для контроля доступа на основе IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-114">The connection processing flow for the IP-based access control is described in the following diagram.</span></span>

![Схема подключения для контроля доступа на основе IP-адресов](./media/firewall-support/firewall-support-flow.png)

## <a name="connections-from-cloud-services"></a><span data-ttu-id="a2c0c-116">Подключения из облачных служб</span><span class="sxs-lookup"><span data-stu-id="a2c0c-116">Connections from cloud services</span></span>
<span data-ttu-id="a2c0c-117">В Azure облачные службы — это стандартный способ размещения логики службы среднего уровня с помощью Azure Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-117">In Azure, cloud services are a very common way for hosting middle tier service logic using Azure Cosmos DB.</span></span> <span data-ttu-id="a2c0c-118">Чтобы разрешить доступ к учетной записи базы данных Azure Cosmos DB из облачной службы, общедоступный IP-адрес этой службы необходимо добавить в список разрешенных IP-адресов, связанных с учетной записью базы данных Azure Cosmos DB. Для этого следует [настроить политику контроля доступа на основе IP-адресов](#configure-ip-policy).</span><span class="sxs-lookup"><span data-stu-id="a2c0c-118">To enable access to an Azure Cosmos DB database account from a cloud service, the public IP address of the cloud service must be added to the allowed list of IP addresses associated with your Azure Cosmos DB database account by [configuring the IP access control policy](#configure-ip-policy).</span></span>  <span data-ttu-id="a2c0c-119">Это позволит обеспечить доступ к учетной записи базы данных Azure Cosmos DB для всех экземпляров ролей облачных служб.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-119">This ensures that all role instances of cloud services have access to your Azure Cosmos DB database account.</span></span> <span data-ttu-id="a2c0c-120">IP-адреса для ваших облачных служб можно получить на портале Azure, как показано на следующем снимке экрана.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-120">You can retrieve IP addresses for your cloud services in the Azure portal, as shown in the following screenshot.</span></span>

![Снимок экрана с общедоступным IP-адресом для облачной службы на портале Azure](./media/firewall-support/public-ip-addresses.png)

<span data-ttu-id="a2c0c-122">При расширении своей облачной службы за счет добавления дополнительных экземпляров ролей эти новые экземпляры автоматически получают доступ к учетной записи базы данных Azure Cosmos DB, так как они входят в ту же самую облачную службу.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-122">When you scale out your cloud service by adding additional role instance(s), those new instances will automatically have access to the Azure Cosmos DB database account since they are part of the same cloud service.</span></span>

## <a name="connections-from-virtual-machines"></a><span data-ttu-id="a2c0c-123">Подключения из виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="a2c0c-123">Connections from virtual machines</span></span>
<span data-ttu-id="a2c0c-124">[Виртуальные машины](https://azure.microsoft.com/services/virtual-machines/) или [масштабируемые наборы виртуальных машин](../virtual-machine-scale-sets/virtual-machine-scale-sets-overview.md) также можно использовать для размещения служб среднего уровня с помощью Azure Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-124">[Virtual machines](https://azure.microsoft.com/services/virtual-machines/) or [virtual machine scale sets](../virtual-machine-scale-sets/virtual-machine-scale-sets-overview.md) can also be used to host middle tier services using Azure Cosmos DB.</span></span>  <span data-ttu-id="a2c0c-125">Чтобы настроить доступ к учетной записи базы данных Azure Cosmos DB из виртуальных машин, общедоступные IP-адреса виртуальной машины и (или) масштабируемого набора виртуальных машин необходимо добавить в список разрешенных IP-адресов для этой учетной записи. Для этого следует [настроить политику контроля доступа на основе IP-адресов](#configure-ip-policy).</span><span class="sxs-lookup"><span data-stu-id="a2c0c-125">To configure the Azure Cosmos DB database account to allow access from virtual machines, public IP addresses of virtual machine and/or virtual machine scale set must be configured as one of the allowed IP addresses for your Azure Cosmos DB database account by [configuring the IP access control policy](#configure-ip-policy).</span></span> <span data-ttu-id="a2c0c-126">IP-адреса для виртуальных машин можно получить на портале Azure, как показано на следующем снимке экрана.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-126">You can retrieve IP addresses for virtual machines in the Azure portal, as shown in the following screenshot.</span></span>

![Снимок экрана с общедоступным IP-адресом для виртуальной машины на портале Azure](./media/firewall-support/public-ip-addresses-dns.png)

<span data-ttu-id="a2c0c-128">При добавлении в группу дополнительных экземпляров виртуальных машин они автоматически получают доступ к вашей учетной записи базы данных Azure Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-128">When you add additional virtual machine instances to the group, they are automatically provided access to your Azure Cosmos DB database account.</span></span>

## <a name="connections-from-the-internet"></a><span data-ttu-id="a2c0c-129">Подключения через Интернет</span><span class="sxs-lookup"><span data-stu-id="a2c0c-129">Connections from the internet</span></span>
<span data-ttu-id="a2c0c-130">При подключении к учетной записи базы данных Azure Cosmos DB с компьютера через Интернет IP-адрес или диапазон IP-адресов клиента необходимо добавить в список разрешенных IP-адресов для этой учетной записи.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-130">When you access an Azure Cosmos DB database account from a computer on the internet, the client IP address or IP address range of the machine must be added to the allowed list of IP address for the Azure Cosmos DB database account.</span></span> 

## <span data-ttu-id="a2c0c-131"><a id="configure-ip-policy"></a> Настройка политики контроля доступа на основе IP-адресов</span><span class="sxs-lookup"><span data-stu-id="a2c0c-131"><a id="configure-ip-policy"></a> Configuring the IP access control policy</span></span>
<span data-ttu-id="a2c0c-132">Политику контроля доступа по протоколу IP можно задать на портале Azure или программно с помощью [интерфейса командной строки Azure (Azure CLI)](cli-samples.md), [Azure Powershell](powershell-samples.md) или [REST API](/rest/api/documentdb/), обновив свойство `ipRangeFilter`.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-132">The IP access control policy can be set in the Azure portal, or programmatically through [Azure CLI](cli-samples.md), [Azure Powershell](powershell-samples.md), or the [REST API](/rest/api/documentdb/) by updating the `ipRangeFilter` property.</span></span> <span data-ttu-id="a2c0c-133">IP-адреса и их диапазоны должны быть разделены запятой без пробелов.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-133">IP addresses/ranges must be comma separated and must not contain any spaces.</span></span> <span data-ttu-id="a2c0c-134">Пример: "13.91.6.132,13.91.6.1/24".</span><span class="sxs-lookup"><span data-stu-id="a2c0c-134">Example: "13.91.6.132,13.91.6.1/24".</span></span> <span data-ttu-id="a2c0c-135">При обновлении учетной записи базы данных с помощью этих методов обязательно заполните все свойства, чтобы предотвратить сброс до значений до умолчанию.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-135">When updating your database account through these methods, be sure to populate all of the properties to prevent resetting to default settings.</span></span>

> [!NOTE]
> <span data-ttu-id="a2c0c-136">После включения политики контроля доступа на основе IP-адресов для учетной записи базы данных Azure Cosmos DB все подключения к этой учетной записи с компьютеров, диапазоны IP-адресов которых не входят в список разрешенных, блокируются.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-136">By enabling an IP access control policy for your Azure Cosmos DB database account, all access to your Azure Cosmos DB database account from machines outside the configured allowed list of IP address ranges are blocked.</span></span> <span data-ttu-id="a2c0c-137">При использовании этой модели просмотр операций с плоскостью данных на портале также блокируется, чтобы обеспечить целостность контроля доступа.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-137">By virtue of this model, browsing the data plane operation from the portal will also be blocked to ensure the integrity of access control.</span></span>

<span data-ttu-id="a2c0c-138">Для упрощения разработки портал Azure помогает определить и добавить IP-адрес клиентского компьютера в список разрешенных адресов, чтобы приложения, работающие на вашем компьютере, могли получить доступ к учетной записи Azure Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-138">To simplify development, the Azure portal helps you identify and add the IP of your client machine to the allowed list, so that apps running your machine can access the Azure Cosmos DB account.</span></span> <span data-ttu-id="a2c0c-139">Обратите внимание, что IP-адрес клиента определяется так, как он отображается на портале.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-139">Note that the client IP address here is detected as seen by the portal.</span></span> <span data-ttu-id="a2c0c-140">Это может быть IP-адрес клиента вашего компьютера, а также IP-адрес вашего сетевого шлюза.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-140">It may be the client IP address of your machine, but it could also be the IP address of your network gateway.</span></span> <span data-ttu-id="a2c0c-141">Не забудьте удалить его до внесения изменений в рабочую среду.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-141">Do not forget to remove it before going to production.</span></span>

<span data-ttu-id="a2c0c-142">Чтобы настроить политику контроля доступа на основе IP-адресов на портале Azure, перейдите к колонке учетной записи Azure Cosmos DB, в меню навигации щелкните **Брандмауэр**, а затем нажмите кнопку **ВКЛ.**</span><span class="sxs-lookup"><span data-stu-id="a2c0c-142">To set the IP access control policy in the Azure portal, navigate to the Azure Cosmos DB account blade, click **Firewall** in the navigation menu, then click **ON**</span></span> 

![Снимок экрана, показывающий, как открыть колонку "Брандмауэр" на портале Azure](./media/firewall-support/azure-portal-firewall.png)

<span data-ttu-id="a2c0c-144">В новой области укажите, должен ли портал Azure иметь доступ к учетной записи, и настройте соответствующим образом другие адреса и диапазоны. Затем нажмите кнопку **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-144">In the new pane, specify whether the Azure portal can access the account, and add other addresses and ranges as appropriate, then click **Save**.</span></span>  

> [!NOTE]
> <span data-ttu-id="a2c0c-145">Чтобы обеспечить доступ к порталу Azure при включении политики контроля доступа на основе IP-адресов, необходимо добавить его IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-145">When you enable an IP access control policy, you need to add the IP address for the Azure portal to maintain access.</span></span> <span data-ttu-id="a2c0c-146">IP-адрес портала:</span><span class="sxs-lookup"><span data-stu-id="a2c0c-146">The portal IP addresses are:</span></span>
> |<span data-ttu-id="a2c0c-147">Регион</span><span class="sxs-lookup"><span data-stu-id="a2c0c-147">Region</span></span>|<span data-ttu-id="a2c0c-148">IP-адрес</span><span class="sxs-lookup"><span data-stu-id="a2c0c-148">IP address</span></span>|
> |------|----------|
> |<span data-ttu-id="a2c0c-149">Все области, за исключением указанных ниже</span><span class="sxs-lookup"><span data-stu-id="a2c0c-149">All regions except those specified below</span></span>| <span data-ttu-id="a2c0c-150">104.42.195.92</span><span class="sxs-lookup"><span data-stu-id="a2c0c-150">104.42.195.92</span></span>|
> |<span data-ttu-id="a2c0c-151">Германия</span><span class="sxs-lookup"><span data-stu-id="a2c0c-151">Germany</span></span>|<span data-ttu-id="a2c0c-152">51.4.229.218</span><span class="sxs-lookup"><span data-stu-id="a2c0c-152">51.4.229.218</span></span>|
> |<span data-ttu-id="a2c0c-153">Китай</span><span class="sxs-lookup"><span data-stu-id="a2c0c-153">China</span></span>|<span data-ttu-id="a2c0c-154">139.217.8.252</span><span class="sxs-lookup"><span data-stu-id="a2c0c-154">139.217.8.252</span></span>|
> |<span data-ttu-id="a2c0c-155">Аризона (для обслуживания государственных организаций США)</span><span class="sxs-lookup"><span data-stu-id="a2c0c-155">US Gov Arizona</span></span>|<span data-ttu-id="a2c0c-156">52.244.48.71</span><span class="sxs-lookup"><span data-stu-id="a2c0c-156">52.244.48.71</span></span>|
>

![Снимок экрана, показывающий, как настроить параметры брандмауэра на портале Azure](./media/firewall-support/azure-portal-firewall-configure.png)

## <a name="troubleshooting-the-ip-access-control-policy"></a><span data-ttu-id="a2c0c-158">Устранение неполадок с политикой контроля доступа на основе IP-адресов</span><span class="sxs-lookup"><span data-stu-id="a2c0c-158">Troubleshooting the IP access control policy</span></span>
### <a name="portal-operations"></a><span data-ttu-id="a2c0c-159">Операции на портале</span><span class="sxs-lookup"><span data-stu-id="a2c0c-159">Portal operations</span></span>
<span data-ttu-id="a2c0c-160">После включения политики контроля доступа на основе IP-адресов для учетной записи базы данных Azure Cosmos DB все подключения к этой учетной записи с компьютеров, диапазоны IP-адресов которых не входят в список разрешенных, блокируются.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-160">By enabling an IP access control policy for your Azure Cosmos DB database account, all access to your Azure Cosmos DB database account from machines outside the configured allowed list of IP address ranges are blocked.</span></span> <span data-ttu-id="a2c0c-161">Поэтому, чтобы разрешить на портале выполнение операций плоскости данных, таких как просмотр коллекций и запрос документов, необходимо явным образом разрешить доступ к порталу Azure с помощью колонки **Брандмауэр** на портале.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-161">Therefore if you want to enable portal data plane operations like browsing collections and query documents, you need to explicitly allow Azure portal access using the **Firewall** blade in the portal.</span></span> 

![Снимок экрана, показывающий, как разрешить доступ к порталу Azure](./media/firewall-support/azure-portal-access-firewall.png)

### <a name="sdk--rest-api"></a><span data-ttu-id="a2c0c-163">Пакет SDK и REST API</span><span class="sxs-lookup"><span data-stu-id="a2c0c-163">SDK & Rest API</span></span>
<span data-ttu-id="a2c0c-164">По соображениям безопасности при доступе с помощью пакета SDK и REST API с компьютеров, IP-адреса которых не входят в список разрешенных, вернется ответ с кодом 404 (объект не найден) без каких-либо дополнительных сведений.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-164">For security reasons, access via SDK or REST API from machines not on the allowed list will return a generic 404 Not Found response with no additional details.</span></span> <span data-ttu-id="a2c0c-165">Проверьте список разрешенных IP-адресов и убедитесь, что политика имеет допустимую конфигурацию для учетной записи базы данных Azure Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="a2c0c-165">Please verify the IP allowed list configured for your Azure Cosmos DB database account to ensure the correct policy configuration is applied to your Azure Cosmos DB database account.</span></span>

## <a name="next-steps"></a><span data-ttu-id="a2c0c-166">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="a2c0c-166">Next steps</span></span>
<span data-ttu-id="a2c0c-167">Советы по улучшению производительности, связанные с сетью, см. в статье [Советы по улучшению производительности DocumentDB](performance-tips.md).</span><span class="sxs-lookup"><span data-stu-id="a2c0c-167">For information about network related performance tips, see [Performance tips](performance-tips.md).</span></span>


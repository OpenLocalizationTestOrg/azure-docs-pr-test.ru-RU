---
title: "Оперативные архивация и восстановление с помощью Azure Cosmos DB | Документация Майкрософт"
description: "Узнайте, как автоматически архивировать и восстанавливать базы данных с помощью Azure Cosmos DB."
keywords: "архивация и восстановление, оперативная архивация"
services: cosmos-db
documentationcenter: 
author: RahulPrasad16
manager: jhubbard
editor: monicar
ms.assetid: 98eade4a-7ef4-4667-b167-6603ecd80b79
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: multiple
ms.topic: article
ms.date: 09/18/2017
ms.author: raprasa
ms.openlocfilehash: 84b26c9ff354adef3f1bc1e61f235c520b63df13
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="automatic-online-backup-and-restore-with-azure-cosmos-db"></a>Автоматическая оперативная архивация и восстановление с помощью Azure Cosmos DB
Azure Cosmos DB автоматически выполняет архивацию всех ваших данных с регулярными интервалами. Автоматическая архивация не влияет на производительность или доступность операций баз данных. Для обеспечения устойчивости в случае региональной аварии все архивные копии хранятся отдельно в другой службе хранилища, а также глобально реплицируются. Автоматические резервные копии предназначены для решения аварийного восстановления или сценариев, при которых контейнер Cosmos DB случайно удаляется и затем требуется восстановление данных.  

В начале этой статьи приводится краткий обзор понятий избыточности и доступности данных в Cosmos DB, а затем рассматривается архивация. 

## <a name="high-availability-with-cosmos-db---a-recap"></a>Высокая доступность в Cosmos DB — обзор
Служба Cosmos DB создана по принципу [глобального распределения](distribute-data-globally.md). Она позволяет масштабировать пропускную способность между несколькими регионами Azure, выполнять отработку отказа на основе политик, а также предоставляет прозрачные API-интерфейсы с размещением в нескольких регионах. Так как система управления базами данных предлагает [соглашения об уровне обслуживания с показателем доступности 99,99 %](https://azure.microsoft.com/support/legal/sla/cosmos-db), все операции записи в Cosmos DB надежно фиксируются на локальных дисках с соблюдением кворума реплик в локальном центре обработки данных, прежде чем подтверждаются клиенту. Обратите внимание, что высокая доступность Cosmos DB основана на использовании локальных хранилищ и не зависит от технологий внешнего хранения. Кроме того, если ваша учетная запись базы данных связана с более чем одним регионом Azure, то ваши операции записи также реплицируются между другими регионами. Для масштабирования пропускной способности и доступа к данным с небольшой задержкой можно указать любое количество регионов чтения, связанных с учетной записью базы данных. В каждом регионе чтения (реплицированные) данные надежно хранятся в наборе реплик.  

Как показано на следующей схеме, отдельный контейнер Cosmos DB является [горизонтально секционированным](partition-data.md). "Секция" на этой схеме обозначается кружком, а высокая доступность каждой секции обеспечивается набором реплик. Это локальное распределение в одном регионе Azure (обозначается осью X). Затем каждая секция (с соответствующим набором реплик) глобально распределяется по нескольким регионам, связанным с учетной записью базы данных (например, на данном рисунке указаны три региона — восточная часть США, западная часть США и центральная Индия). Набор секций — это глобально распределенная сущность, состоящая из нескольких копий данных в каждом регионе (обозначается осью Y). Вы можете назначить приоритет регионам, связанным с вашей учетной записью базы данных, и в случае аварии Cosmos DB прозрачно выполнит отработку отказа в следующий регион. Также можно вручную смоделировать отработку отказа, чтобы протестировать комплексную доступность приложения.  

На следующем рисунке показана высокая степень избыточности, обеспечиваемая Cosmos DB.

![Высокая степень избыточности, обеспечиваемая Cosmos DB](./media/online-backup-and-restore/redundancy.png)

![Высокая степень избыточности, обеспечиваемая Cosmos DB](./media/online-backup-and-restore/global-distribution.png)

## <a name="full-automatic-online-backups"></a>Полная, автоматическая и оперативная архивация
Что, если вы удалили свой контейнер или базу данных? При использовании Cosmos DB не только ваши данные, но и архивные копии ваших данных остаются высоко избыточными и устойчивыми к региональным авариям. В настоящее время такая автоматическая архивация выполняется примерно каждые четыре часа, и последние 2 резервные копии всегда сохраняются. Если данные были случайно удалены или повреждены, [обратитесь в службу поддержки Azure](https://azure.microsoft.com/support/options/) в течение восьми часов. 

Архивация не влияет на производительность или доступность операций баз данных. Cosmos DB выполняет архивацию в фоновом режиме, не используя подготовленные ЕЗ, не снижая производительность и не влияя на доступность базы данных. 

В отличие от данных, сохраненных внутри Cosmos DB, автоматические архивные копии хранятся в службе хранилища BLOB-объектов Azure. Для обеспечения эффективной передачи данных с небольшой задержкой моментальный снимок архивной копии передается в экземпляр хранилища BLOB-объектов Azure в том же регионе, который является текущим регионом записи вашей учетной записи базы данных Cosmos DB. Для обеспечения устойчивости к региональным авариям каждый моментальный снимок данных архивной копии в хранилище BLOB-объектов Azure повторно реплицируется в другой регион с помощью геоизбыточного хранилища (GRS). На следующей схеме показано, как весь контейнер Cosmos DB (в данном примере — все три основные секции в западной части США) архивируется в удаленную учетную запись хранилища BLOB-объектов в западной части США, а затем реплицируется через GRS в восточную часть США. 

На следующем рисунке показана периодически выполняемая полная архивация всех сущностей Cosmos DB в геоизбыточное хранилище Azure.

![Периодически выполняемая полная архивация всех сущностей Cosmos DB в геоизбыточное хранилище Azure](./media/online-backup-and-restore/automatic-backup.png)

## <a name="backup-retention-period"></a>Срок хранения моментального снимка
Как описано выше, Azure Cosmos DB делает моментальные снимки данных каждые четыре часа на уровне разделов. В любое время сохраняются только два последних моментальных снимка. Однако если удаляется база данных или коллекция, моментальные снимки сохраняются для всех удаленных разделов этой коллекции или базы данных в течение 30 дней.

Если вы хотите использовать собственные моментальные снимки, вы можете использовать параметр экспорта в JSON в [инструменте переноса данных](import-data.md#export-to-json-file) в Azure Cosmos DB, чтобы запланировать дополнительные резервные копии.

## <a name="restoring-a-database-from-an-online-backup"></a>Восстановление базы данных из оперативного архива
Если вы случайно удалите данные или коллекцию, можете [обратиться с запросом в службу поддержки](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade) или [позвонить в службу поддержки Azure](https://azure.microsoft.com/support/options/), чтобы восстановить данные из последнего автоматически созданного архива. Если необходимо восстановить базу данных из-за повреждения данных (включая случаи удаления документов в коллекций), ознакомьтесь с разделом [Обработка поврежденных данных](#handling-data-corruption), так как необходимо выполнить дополнительные действия, чтобы предотвратить перезапись имеющихся резервных копий поврежденных данных. Чтобы восстановить определенный моментальный снимок архива, службе Cosmos DB требуется, чтобы данные были доступны в течение цикла архивации для данного снимка.

## <a name="handling-data-corruption"></a>Обработка поврежденных данных
Azure Cosmos DB сохраняет две последние резервные копии всех разделов в учетной записи базы данных. Эта модель хорошо работает при случайном удалении контейнера (коллекции документов, графа, таблицы) или базы данных, так как одну из последних версий можно восстановить. Однако в случае, когда пользователи могут повредить данные, Azure Cosmos DB может не знать об этом, и может произойти перезапись имеющихся резервных копий. Сразу после обнаружения повреждения пользователю следует удалить поврежденный контейнер (коллекцию, граф или таблицу), чтобы резервные копии не перезаписались поврежденными данными.

## <a name="next-steps"></a>Дальнейшие действия

Чтобы реплицировать базу данных в нескольких центрах обработки данных, ознакомьтесь со статьей [Как работает глобальное распределение данных в Azure Cosmos DB?](distribute-data-globally.md) 

Для обращения в службу поддержки Azure [отправьте запрос с портала Azure](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade).


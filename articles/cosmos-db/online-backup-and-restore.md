---
title: "Оперативные архивация и восстановление с помощью Azure Cosmos DB | Документация Майкрософт"
description: "Узнайте, как автоматически архивировать и восстанавливать базы данных с помощью Azure Cosmos DB."
keywords: "архивация и восстановление, оперативная архивация"
services: cosmos-db
documentationcenter: 
author: RahulPrasad16
manager: jhubbard
editor: monicar
ms.assetid: 98eade4a-7ef4-4667-b167-6603ecd80b79
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: multiple
ms.topic: article
ms.date: 08/11/2017
ms.author: raprasa
ms.openlocfilehash: 130f0eb259621737d6dbdb151e363915fb334ce1
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="automatic-online-backup-and-restore-with-azure-cosmos-db"></a><span data-ttu-id="02edd-104">Автоматическая оперативная архивация и восстановление с помощью Azure Cosmos DB</span><span class="sxs-lookup"><span data-stu-id="02edd-104">Automatic online backup and restore with Azure Cosmos DB</span></span>
<span data-ttu-id="02edd-105">Azure Cosmos DB автоматически выполняет архивацию всех ваших данных с регулярными интервалами.</span><span class="sxs-lookup"><span data-stu-id="02edd-105">Azure Cosmos DB automatically takes backups of all your data at regular intervals.</span></span> <span data-ttu-id="02edd-106">Автоматическая архивация не влияет на производительность или доступность операций баз данных.</span><span class="sxs-lookup"><span data-stu-id="02edd-106">The automatic backups are taken without affecting the performance or availability of your database operations.</span></span> <span data-ttu-id="02edd-107">Для обеспечения устойчивости в случае региональной аварии все архивные копии хранятся отдельно в другой службе хранилища, а также глобально реплицируются.</span><span class="sxs-lookup"><span data-stu-id="02edd-107">All your backups are stored separately in another storage service, and those backups are globally replicated for resiliency against regional disasters.</span></span> <span data-ttu-id="02edd-108">Автоматическая архивация предназначена для решения аварийного восстановления или сценариев, при которых контейнер Cosmos DB случайно удаляется и затем требуется восстановление данных.</span><span class="sxs-lookup"><span data-stu-id="02edd-108">The automatic backups are intended for scenarios when you accidentally delete your Comos DB container and later require data recovery or a disaster recovery solution.</span></span>  

<span data-ttu-id="02edd-109">В начале этой статьи приводится краткий обзор понятий избыточности и доступности данных в Cosmos DB, а затем рассматривается архивация.</span><span class="sxs-lookup"><span data-stu-id="02edd-109">This article starts with a quick recap of the data redundancy and availability in Cosmos DB, and then discusses backups.</span></span> 

## <a name="high-availability-with-cosmos-db---a-recap"></a><span data-ttu-id="02edd-110">Высокая доступность в Cosmos DB — обзор</span><span class="sxs-lookup"><span data-stu-id="02edd-110">High availability with Cosmos DB - a recap</span></span>
<span data-ttu-id="02edd-111">Служба Cosmos DB создана по принципу [глобального распределения](distribute-data-globally.md). Она позволяет масштабировать пропускную способность между несколькими регионами Azure, выполнять отработку отказа на основе политик, а также предоставляет прозрачные API-интерфейсы с размещением в нескольких регионах.</span><span class="sxs-lookup"><span data-stu-id="02edd-111">Cosmos DB is designed to be [globally distributed](distribute-data-globally.md) – it allows you to scale throughput across multiple Azure regions along with policy driven failover and transparent multi-homing APIs.</span></span> <span data-ttu-id="02edd-112">Так как система управления базами данных предлагает [соглашения об уровне обслуживания с показателем доступности 99,99 %](https://azure.microsoft.com/support/legal/sla/cosmos-db), все операции записи в Cosmos DB надежно фиксируются на локальных дисках с соблюдением кворума реплик в локальном центре обработки данных, прежде чем подтверждаются клиенту.</span><span class="sxs-lookup"><span data-stu-id="02edd-112">As a database system offering [99.99% availability SLAs](https://azure.microsoft.com/support/legal/sla/cosmos-db), all the writes in Cosmos DB are durably committed to local disks by a quorum of replicas within a local data center before acknowledging to the client.</span></span> <span data-ttu-id="02edd-113">Обратите внимание, что высокая доступность Cosmos DB основана на использовании локальных хранилищ и не зависит от технологий внешнего хранения.</span><span class="sxs-lookup"><span data-stu-id="02edd-113">Note that the high availability of Cosmos DB relies on local storage and does not depend on any external storage technologies.</span></span> <span data-ttu-id="02edd-114">Кроме того, если ваша учетная запись базы данных связана с более чем одним регионом Azure, то ваши операции записи также реплицируются между другими регионами.</span><span class="sxs-lookup"><span data-stu-id="02edd-114">Additionally, if your database account is associated with more than one Azure region, your writes are replicated across other regions as well.</span></span> <span data-ttu-id="02edd-115">Для масштабирования пропускной способности и доступа к данным с небольшой задержкой можно указать любое количество регионов чтения, связанных с учетной записью базы данных.</span><span class="sxs-lookup"><span data-stu-id="02edd-115">To scale your throughput and access data at low latencies, you can have as many read regions associated with your database account as you like.</span></span> <span data-ttu-id="02edd-116">В каждом регионе чтения (реплицированные) данные надежно хранятся в наборе реплик.</span><span class="sxs-lookup"><span data-stu-id="02edd-116">In each read region, the (replicated) data is durably persisted across a replica set.</span></span>  

<span data-ttu-id="02edd-117">Как показано на следующей схеме, отдельный контейнер Cosmos DB является [горизонтально секционированным](partition-data.md).</span><span class="sxs-lookup"><span data-stu-id="02edd-117">As illustrated in the following diagram, a single Cosmos DB container is [horizontally partitioned](partition-data.md).</span></span> <span data-ttu-id="02edd-118">"Секция" на этой схеме обозначается кружком, а высокая доступность каждой секции обеспечивается набором реплик.</span><span class="sxs-lookup"><span data-stu-id="02edd-118">A “partition” is denoted by a circle in the following diagram, and each partition is made highly available via a replica set.</span></span> <span data-ttu-id="02edd-119">Это локальное распределение в одном регионе Azure (обозначается осью X).</span><span class="sxs-lookup"><span data-stu-id="02edd-119">This is the local distribution within a single Azure region (denoted by the X axis).</span></span> <span data-ttu-id="02edd-120">Затем каждая секция (с соответствующим набором реплик) глобально распределяется по нескольким регионам, связанным с учетной записью базы данных (например, на данном рисунке указаны три региона — восточная часть США, западная часть США и центральная Индия).</span><span class="sxs-lookup"><span data-stu-id="02edd-120">Further, each partition (with its corresponding replica set) is then globally distributed across multiple regions associated with your database account (for example, in this illustration the three regions – East US, West US and Central India).</span></span> <span data-ttu-id="02edd-121">Набор секций — это глобально распределенная сущность, состоящая из нескольких копий данных в каждом регионе (обозначается осью Y).</span><span class="sxs-lookup"><span data-stu-id="02edd-121">The “partition set” is a globally distributed entity comprising of multiple copies of your data in each region (denoted by the Y axis).</span></span> <span data-ttu-id="02edd-122">Вы можете назначить приоритет регионам, связанным с вашей учетной записью базы данных, и в случае аварии Cosmos DB прозрачно выполнит отработку отказа в следующий регион.</span><span class="sxs-lookup"><span data-stu-id="02edd-122">You can assign priority to the regions associated with your database account and Cosmos DB will transparently failover to the next region in case of disaster.</span></span> <span data-ttu-id="02edd-123">Также можно вручную смоделировать отработку отказа, чтобы протестировать комплексную доступность приложения.</span><span class="sxs-lookup"><span data-stu-id="02edd-123">You can also manually simulate failover to test the end-to-end availability of your application.</span></span>  

<span data-ttu-id="02edd-124">На следующем рисунке показана высокая степень избыточности, обеспечиваемая Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="02edd-124">The following image illustrates the high degree of redundancy with Cosmos DB.</span></span>

![Высокая степень избыточности, обеспечиваемая Cosmos DB](./media/online-backup-and-restore/redundancy.png)

![Высокая степень избыточности, обеспечиваемая Cosmos DB](./media/online-backup-and-restore/global-distribution.png)

## <a name="full-automatic-online-backups"></a><span data-ttu-id="02edd-127">Полная, автоматическая и оперативная архивация</span><span class="sxs-lookup"><span data-stu-id="02edd-127">Full, automatic, online backups</span></span>
<span data-ttu-id="02edd-128">Что, если вы удалили свой контейнер или базу данных?</span><span class="sxs-lookup"><span data-stu-id="02edd-128">Oops, I deleted my container or database!</span></span> <span data-ttu-id="02edd-129">При использовании Cosmos DB не только ваши данные, но и архивные копии ваших данных остаются высоко избыточными и устойчивыми к региональным авариям.</span><span class="sxs-lookup"><span data-stu-id="02edd-129">With Cosmos DB, not only your data, but the backups of your data are also made highly redundant and resilient to regional disasters.</span></span> <span data-ttu-id="02edd-130">В настоящее время такая автоматическая архивация выполняется примерно каждые четыре часа, и последние 2 резервные копии всегда сохраняются.</span><span class="sxs-lookup"><span data-stu-id="02edd-130">These automated backups are currently taken approximately every four hours and latest 2 backups are stored at all times.</span></span> <span data-ttu-id="02edd-131">Если данные были случайно удалены или повреждены, то [обратитесь в службу поддержки Azure](https://azure.microsoft.com/support/options/) в течение 8 часов.</span><span class="sxs-lookup"><span data-stu-id="02edd-131">If the data is accidently dropped or corrupted, please [contact Azure support](https://azure.microsoft.com/support/options/) within 8 hours.</span></span> 

<span data-ttu-id="02edd-132">Архивация не влияет на производительность или доступность операций баз данных.</span><span class="sxs-lookup"><span data-stu-id="02edd-132">The backups are taken without affecting the performance or availability of your database operations.</span></span> <span data-ttu-id="02edd-133">Cosmos DB выполняет архивацию в фоновом режиме, не используя подготовленные ЕЗ, не снижая производительность и не влияя на доступность базы данных.</span><span class="sxs-lookup"><span data-stu-id="02edd-133">Cosmos DB takes the backup in the background without consuming your provisioned RUs or affecting the performance and without affecting the availability of your database.</span></span> 

<span data-ttu-id="02edd-134">В отличие от данных, сохраненных внутри Cosmos DB, автоматические архивные копии хранятся в службе хранилища BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="02edd-134">Unlike your data that is stored inside Cosmos DB, the automatic backups are stored in Azure Blob Storage service.</span></span> <span data-ttu-id="02edd-135">Для обеспечения эффективной передачи данных с небольшой задержкой моментальный снимок архивной копии передается в экземпляр хранилища BLOB-объектов Azure в том же регионе, который является текущим регионом записи вашей учетной записи базы данных Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="02edd-135">To guarantee the low latency/efficient upload, the snapshot of your backup is uploaded to an instance of Azure Blob storage in the same region as the current write region of your Cosmos DB database account.</span></span> <span data-ttu-id="02edd-136">Для обеспечения устойчивости к региональным авариям каждый моментальный снимок данных архивной копии в хранилище BLOB-объектов Azure повторно реплицируется в другой регион с помощью геоизбыточного хранилища (GRS).</span><span class="sxs-lookup"><span data-stu-id="02edd-136">For resiliency against regional disaster, each snapshot of your backup data in Azure Blob Storage is again replicated via geo-redundant storage (GRS) to another region.</span></span> <span data-ttu-id="02edd-137">На следующей схеме показано, как весь контейнер Cosmos DB (в данном примере — все три основные секции в западной части США) архивируется в удаленную учетную запись хранилища BLOB-объектов в западной части США, а затем реплицируется через GRS в восточную часть США.</span><span class="sxs-lookup"><span data-stu-id="02edd-137">The following diagram shows that the entire Cosmos DB container (with all three primary partitions in West US, in this example) is backed up in a remote Azure Blob Storage account in West US and then GRS replicated to East US.</span></span> 

<span data-ttu-id="02edd-138">На следующем рисунке показана периодически выполняемая полная архивация всех сущностей Cosmos DB в геоизбыточное хранилище Azure.</span><span class="sxs-lookup"><span data-stu-id="02edd-138">The following image illustrates periodic full backups of all Cosmos DB entities in GRS Azure Storage.</span></span>

![Периодически выполняемая полная архивация всех сущностей Cosmos DB в геоизбыточное хранилище Azure](./media/online-backup-and-restore/automatic-backup.png)

## <a name="backup-retention-period"></a><span data-ttu-id="02edd-140">Срок хранения моментального снимка</span><span class="sxs-lookup"><span data-stu-id="02edd-140">Backup retention period</span></span>
<span data-ttu-id="02edd-141">Как описано выше, Azure Cosmos DB делает моментальные снимки данных каждые четыре часа и хранит два последних моментальных снимка всех секций в течение 30 дней.</span><span class="sxs-lookup"><span data-stu-id="02edd-141">As described above, Azure Cosmos DB takes snapshots of your data every four hours and retains the last two snapshots of every partition for 30 days.</span></span> <span data-ttu-id="02edd-142">Согласно требованиям соответствия нормативам по истечении 90 дней моментальные снимки удаляются.</span><span class="sxs-lookup"><span data-stu-id="02edd-142">Per our compliance regulations, snapshots are purged after 90 days.</span></span>

<span data-ttu-id="02edd-143">Если вы хотите использовать собственные моментальные снимки, вы можете использовать параметр экспорта в JSON в [инструменте переноса данных](import-data.md#export-to-json-file) в Azure Cosmos DB, чтобы запланировать дополнительные резервные копии.</span><span class="sxs-lookup"><span data-stu-id="02edd-143">If you want to maintain your own snapshots, you can use the export to JSON option in the Azure Cosmos DB [Data Migration tool](import-data.md#export-to-json-file) to schedule additional backups.</span></span> 

## <a name="restoring-a-database-from-an-online-backup"></a><span data-ttu-id="02edd-144">Восстановление базы данных из оперативного архива</span><span class="sxs-lookup"><span data-stu-id="02edd-144">Restoring a database from an online backup</span></span>
<span data-ttu-id="02edd-145">Если вы случайно удалите данные или коллекцию, можете [обратиться с запросом в службу поддержки](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade) или [позвонить в службу поддержки Azure](https://azure.microsoft.com/support/options/), чтобы восстановить данные из последнего автоматически созданного архива.</span><span class="sxs-lookup"><span data-stu-id="02edd-145">If you accidentally delete your database or collection, you can [file a support ticket](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade) or [call Azure support](https://azure.microsoft.com/support/options/) to restore the data from the last automatic backup.</span></span> <span data-ttu-id="02edd-146">Если необходимо восстановить базу данных из-за повреждения данных, ознакомьтесь с разделом [Обработка поврежденных данных](#handling-data-corruption), так как необходимо выполнить дополнительные действия, чтобы поврежденные данные не попали в резервные копии.</span><span class="sxs-lookup"><span data-stu-id="02edd-146">If you need to restore your database because of data corruption issue, see [Handling data corruption](#handling-data-corruption) as you need to take additional steps to prevent the corrupted data from penetrating the backups.</span></span> <span data-ttu-id="02edd-147">Чтобы восстановить определенный моментальный снимок архива, службе Cosmos DB требуется, чтобы данные были доступны в течение цикла архивации для данного снимка.</span><span class="sxs-lookup"><span data-stu-id="02edd-147">For a specific snapshot of your backup to be restored, Cosmos DB requires that the data was available for the duration of the backup cycle for that snapshot.</span></span>

## <a name="handling-data-corruption"></a><span data-ttu-id="02edd-148">Обработка поврежденных данных</span><span class="sxs-lookup"><span data-stu-id="02edd-148">Handling data corruption</span></span>
<span data-ttu-id="02edd-149">Azure Cosmos DB сохраняет две последние резервные копии всех разделов в системе.</span><span class="sxs-lookup"><span data-stu-id="02edd-149">Azure Cosmos DB retains the last two backups of every partition in the system.</span></span> <span data-ttu-id="02edd-150">Эта модель очень хорошо работает при случайном удалении контейнера (коллекции, графа, таблицы) или базы данных, так как одну из последних версий можно восстановить.</span><span class="sxs-lookup"><span data-stu-id="02edd-150">This model works very well when a container (collection of documents, graph, table) or a database is accidentally deleted since one of the last versions can be restored.</span></span> <span data-ttu-id="02edd-151">Однако если пользователи могут повредить данные, Azure Cosmos DB может не знать об этом, и поврежденные данные могут попасть в резервные копии.</span><span class="sxs-lookup"><span data-stu-id="02edd-151">However, in the case when when users may introduce a data corruption issue, Azure Cosmos DB may be unaware of the data corruption, and it is possible that the corruption may have penetrated the backups.</span></span> <span data-ttu-id="02edd-152">Сразу после обнаружения повреждения следует удалить поврежденный контейнер (коллекцию, граф или таблицу), чтобы резервные копии не перезаписались поврежденными данными.</span><span class="sxs-lookup"><span data-stu-id="02edd-152">As soon as corruption is detected, you should delete the corrupted container (collection/graph/table) so that backups are protected from being overwritten with corrupted data.</span></span> <span data-ttu-id="02edd-153">Если с момента создания последней резервной копии прошло более четырех часов, перед удалением контейнера пользователь может внедрить [веб-канал изменений](change-feed.md), чтобы собрать и сохранить важные данные, созданные за последние 4 часа.</span><span class="sxs-lookup"><span data-stu-id="02edd-153">Since the last backup could be four hours old, the user can employ [change feed](change-feed.md) to capture and store the last four hours worth of data before deleting the container.</span></span>

## <a name="next-steps"></a><span data-ttu-id="02edd-154">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="02edd-154">Next steps</span></span>

<span data-ttu-id="02edd-155">Чтобы реплицировать базу данных в нескольких центрах обработки данных, ознакомьтесь со статьей [Как работает глобальное распределение данных в Azure Cosmos DB?](distribute-data-globally.md)</span><span class="sxs-lookup"><span data-stu-id="02edd-155">To replicate your database in multiple data centers, see [distribute your data globally with Cosmos DB](distribute-data-globally.md).</span></span> 

<span data-ttu-id="02edd-156">Для обращения в службу поддержки Azure [отправьте запрос с портала Azure](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade).</span><span class="sxs-lookup"><span data-stu-id="02edd-156">To file contact Azure Support, [file a ticket from the Azure portal](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade).</span></span>


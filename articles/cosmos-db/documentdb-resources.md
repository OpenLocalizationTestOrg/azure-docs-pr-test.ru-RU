---
title: "Понятия и модель ресурсов в Azure Cosmos DB | Документация Майкрософт"
description: "Описание иерархической модели базы данных, коллекций, определяемых пользователем функций (UDF), документов, разрешений на управление ресурсами и т. д."
keywords: "Иерархическая модель, cosmosdb, azure, Microsoft Azure"
services: cosmos-db
documentationcenter: 
author: AndrewHoh
manager: jhubbard
editor: monicar
ms.assetid: ef9d5c0c-0867-4317-bb1b-98e219799fd5
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/24/2017
ms.author: anhoh
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 8051742c7c368d1ed84bcd90ab75b20f62105e2f
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="azure-cosmos-db-hierarchical-resource-model-and-core-concepts"></a>Ключевые понятия и иерархическая модель ресурсов в Azure Cosmos DB
Сущности базы данных, которыми управляет Azure Cosmos DB, называются **ресурсами**. Каждый ресурс однозначно идентифицируется своими логическим URI. Разработчики могут взаимодействовать с ресурсами, используя стандартные команды HTTP, заголовки запросов/ответов и коды состояний. 

Прочитав данную статью, вы сможете ответить на следующие вопросы.

* Что такое модель ресурсов Cosmos DB?
* Чем ресурсы, определяемые системой, отличаются от ресурсов, определяемых пользователем?
* Как получить доступ к ресурсу?
* Как работать с коллекциями?
* Как работать с хранимыми процедурами, триггерами и пользовательскими функциями?

## <a name="hierarchical-resource-model"></a>Иерархическая модель ресурсов
Как показано на следующей схеме, иерархическая **модель ресурсов** Cosmos DB состоит из наборов ресурсов в учетной записи базы данных, каждый из которых имеет логический постоянный идентификатор URI. Набор ресурсов в этой статье называется **каналом** . 

> [!NOTE]
> Azure Cosmos DB предлагает весьма эффективный протокол TCP, который также является API-интерфейсом RESTful в своей коммуникационной модели, доступной с помощью [клиентского API для DocumentDB .NET](documentdb-sdk-dotnet.md).
> 
> 

![Иерархическая модель ресурсов в Azure Cosmos DB][1]  
**Иерархическая модель ресурсов.**   

Чтобы приступить к работе с ресурсами, необходимо [создать учетную запись базы данных](create-documentdb-dotnet.md) с помощью подписки Azure. Учетная запись базы данных может состоять из набора **баз данных**, каждая из которых содержит несколько **коллекций**, каждая из которых, в свою очередь, содержит **хранимые процедуры, триггеры, определяемые пользователем функции, документы** и соответствующие **вложения**. С базой данных также связаны **пользователи**, каждый из которых обладает набором **разрешений** для доступа к коллекциям, хранимым процедурам, триггерам, пользовательским функциям, документам или вложениям. В то время как базы данных, пользователи, разрешения и коллекции являются определяемыми системой ресурсами с известными схемами, документы и вложения содержат произвольный, определяемый пользователем контент в формате JSON.  

| Resource (Ресурс) | Описание |
| --- | --- |
| Учетная запись базы данных |Учетная запись базы данных связана с набором баз и определенным местом в хранилище больших двоичных объектов для хранения вложений. Вы можете создать одну или несколько учетных записей базы данных с помощью подписки Azure. Дополнительные сведения см. на нашей [странице цен](https://azure.microsoft.com/pricing/details/cosmos-db/). |
| База данных |База данных представляет собой логический контейнер для хранения документов, разделенных между коллекциями. Она также является контейнером для пользователей. |
| Пользователь |Логическое пространство имен для ограничений разрешений. |
| Разрешение |Маркер проверки подлинности, связанный с пользователем, предоставляет доступ к определенному ресурсу. |
| Коллекция |Коллекция представляет собой контейнер документов JSON и связанной логики приложения на JavaScript. Коллекция представляет собой тарифицируемый объект, и его [стоимость](performance-levels.md) определяется связанным с ним уровнем производительности. Коллекции могут охватывать один или несколько разделов либо серверов и масштабироваться до практически неограниченных объемов хранилища или пропускной способности. |
| Хранимая процедура |Логика приложения, написанная на JavaScript, которая зарегистрирована в коллекции и выполняется в транзакции в ядре базы данных. |
| Триггер |Логика приложения в виде кода JavaScript, автоматически исполняемого до или после операций вставки, замены и удаления. |
| Определяемая пользователем функция |Логика приложения на языке JavaScript. Определяемые пользователем функции (UDF) позволяют моделировать операторы пользовательских запросов и тем самым расширить базовый язык запросов API DocumentDB. |
| Документ |Пользовательский (произвольный) контент JSON. По умолчанию, нет необходимости определения схемы или предоставления вторичных индексов для всех документов, добавляемых в коллекцию. |
| Вложение |Вложение — это специальный документ, содержащий ссылки и связанные с ним метаданные ко внешним большим двоичным объектам и носителям. Разработчик может выбрать, управлять ли большим двоичным объектом с помощью Cosmos DB или хранить его с помощью внешних поставщиков службы BLOB-объектов, таких как OneDrive, Dropbox и т. д. |

## <a name="system-vs-user-defined-resources"></a>Системные и пользовательские ресурсы
Ресурсы (такие как учетные записи баз данных, базы данных, коллекции, пользователи, разрешения, хранимые процедуры, триггеры и определяемые пользователем функции) имеют статическую схему и называются системными ресурсами. В отличие от таких ресурсов, как документы и вложения, не имеющих ограничений по схеме, которые являются примерами пользовательских ресурсов. В службе Cosmos DB системные и определяемые пользователем ресурсы представляются и управляются как стандартные, совместимые с JSON объекты. Все ресурсы, системные и пользовательские, имеют перечисленные ниже общие свойства.

> [!NOTE]
> Обратите внимание, что все сгенерированные системой свойства в ресурсах начинаются с символа подчеркивания (_) в представлении JSON.
> 
> 

<table>
    <tbody>
        <tr>
            <td valign="top"><p><strong>Свойство</strong></p></td>
            <td valign="top"><p><strong>Устанавливаемое пользователем или генерируемое системой?</strong></p></td>
            <td valign="top"><p><strong>Назначение</strong></p></td>
        </tr>
        <tr>
            <td valign="top"><p>_rid</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>Генерируемый системой уникальный иерархический идентификатор ресурса</p></td>
        </tr>
        <tr>
            <td valign="top"><p>_etag</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>etag ресурса, необходимый для управления оптимистичным параллелизмом</p></td>
        </tr>
        <tr>
            <td valign="top"><p>_ts</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>Метка времени последнего обновления ресурса</p></td>
        </tr>
        <tr>
            <td valign="top"><p>_self</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>Уникальный адресуемый URI ресурса</p></td>
        </tr>
        <tr>
            <td valign="top"><p>id</p></td>
            <td valign="top"><p>Генерируемое системой</p></td>
            <td valign="top"><p>Определяемое пользователем уникальное имя ресурса (с тем же значением ключа секции). Если пользователь не укажет идентификатор, идентификатор будет создан системой.</p></td>
        </tr>
    </tbody>
</table>

### <a name="wire-representation-of-resources"></a>Сетевое представление ресурсов
Cosmos DB не требует никаких закрытых расширений для стандарта JSON или специальных кодировок. Служба работает со стандартными, совместимыми с JSON документами.  

### <a name="addressing-a-resource"></a>Адресация ресурса
Все ресурсы можно адресовать по URI. Значение свойства **_self** представляет относительный универсальный код ресурса (URI) ресурса. Формат универсального кода ресурса (URI) состоит из сегментов пути /\<веб-канал\>/{_rid}.  

| Значение свойства _self | Описание |
| --- | --- |
| /dbs |Канал баз данных под учетной записью базы данных |
| /dbs/{dbName} |Базы данных с идентификатором, соответствующим значению {dbName} |
| /dbs/{dbName}/colls/ |Канал коллекций в базе данных |
| /dbs/{dbName}/colls/{collName} |Коллекция с идентификатором, соответствующим значению {collName} |
| /dbs/{dbName}/colls/{collName}/docs |Канал документов в коллекции |
| /dbs/{dbName}/colls/{collName}/docs/{docId} |Документ с идентификатором, соответствующим значению {doc} |
| /dbs/{dbName}/users/ |Канал пользователей в базе данных |
| /dbs/{dbName}/users/{userId} |Пользователь с идентификатором, соответствующим значению {user} |
| /dbs/{dbName}/users/{userId}/permissions |Канал разрешений для пользователя |
| /dbs/{dbName}/users/{userId}/permissions/{permissionId} |Разрешение с идентификатором, соответствующим значению {permission} |

Каждый ресурс имеет уникальное имя, которое определяется пользователем и используется в качестве идентификатора ресурса. Примечание. Если пользователь не укажет идентификатор документа, то поддерживаемые пакеты SDK автоматически создадут для этого документа уникальный идентификатор. Идентификатор является определяемой пользователем строкой длиной до 256 символов, которая уникальна в контексте конкретного родительского ресурса. 

Каждый ресурс также имеет иерархический идентификатор ресурсов, генерируемый системой (также известный как RID), который доступен через свойство _rid. RID кодирует всю иерархию данного ресурса, и это удобное внутреннее представление, которое используется для обеспечения ссылочной целостности распределенным способом. RID является уникальным в пределах учетной записи базы данных и используется службой Cosmos DB для эффективной маршрутизации без перекрестного поиска по секциям. Значения свойств _self и _rid являются альтернативным и каноническим представлениями ресурса. 

Интерфейсы REST API поддерживают адресацию ресурсов и маршрутизацию запросов по свойствам id и _rid.

## <a name="database-accounts"></a>Учетные записи базы данных
Вы можете подготовить одну или несколько учетных записей базы данных Cosmos DB с помощью подписки Azure.

Вы можете создавать учетные записи базы данных Cosmos DB и управлять ими с помощью портала Azure на сайте [http://portal.azure.com/](https://portal.azure.com/). Создание и управление учетной записью базы данных требует наличия административного доступа и может быть выполнено только в рамках вашей подписки Azure. 

### <a name="database-account-properties"></a>Свойства учетной записи базы данных
В рамках подготовки учетной записи базы данных и управления ею можно настроить следующие свойства и ознакомиться с ними:  

<table border="0" cellspacing="0" cellpadding="0">
    <tbody>
        <tr>
            <td valign="top"><p><strong>Имя свойства</strong></p></td>
            <td valign="top"><p><strong>Описание</strong></p></td>
        </tr>
        <tr>
            <td valign="top"><p>Политика согласованности</p></td>
            <td valign="top"><p>Установите это свойство, чтобы настроить уровень согласованности по умолчанию для всех коллекций под вашей учетной записью базы данных. Вы можете переопределить уровень согласованности для каждого запроса, используя заголовок запроса x-ms-consistency-level. <p><p>Обратите внимание, что это свойство применяется только к <i>пользовательским ресурсам</i>. Все определяемые системой ресурсы настроены для поддержки чтения и запросов с сильной согласованностью.</p></td>
        </tr>
        <tr>
            <td valign="top"><p>Ключи авторизации</p></td>
            <td valign="top"><p>Существуют первичный и вторичный главные ключи, доступные только для чтения, которые обеспечивают административный доступ ко всем ресурсам учетной записи базы данных.</p></td>
        </tr>
    </tbody>
</table>

Обратите внимание, что наряду с подготовкой, настройкой учетной записи базы данных и управлением ею на портале Azure, вы также можете программно создавать учетные записи базы данных Cosmos DB и управлять ими через [интерфейсы REST API Azure Cosmos DB](/rest/api/documentdb/) или [клиентские пакеты SDK](documentdb-sdk-dotnet.md).  

## <a name="databases"></a>Базы данных
База данных Cosmos DB является логическим контейнером из одного или нескольких коллекций и пользователей, как показано на следующей схеме. Вы можете создать любое количество баз данных в учетной записи базы данных Cosmos DB с учетом предложенных ограничений.  

![Учетная запись базы данных и иерархическая модель коллекций][2]  
**База данных представляет собой логический контейнер пользователей и коллекций**

База данных может содержать практически неограниченное хранилище документов, секционированное внутри коллекций.

### <a name="elastic-scale-of-a-cosmos-db-database"></a>Гибкое масштабирование базы данных Cosmos DB
База данных Cosmos DB по умолчанию является гибкой: ее размер варьируется от нескольких гигабайт до петабайт хранилищ документов на базе SSD и подготовленной пропускной способности. 

В отличие от традиционных реляционных СУБД базы данных в Cosmos DB не ограничены одним компьютером. Cosmos DB позволяет создавать больше коллекций и баз данных по мере увеличения масштаба вашего приложения. Действительно, различные собственные приложения корпорации Майкрософт уже используют Cosmos DB в потребительском масштабе, создавая чрезвычайно большие базы данных Cosmos DB, каждая из которых содержит тысячи коллекций с терабайтами хранилищ документов. Вы можете увеличить или уменьшить базу данных, добавляя или удаляя коллекции для удовлетворения требований масштабности вашего приложения. 

Вы можете создать любое количество коллекций в пределах субъекта базы данных в рамках своего предложения. Для каждой коллекции выделяется хранилище на базе SSD-накопителей и пропускная способность с учетом выбранного уровня производительности.

Cosmos DB также является контейнером пользователей. Пользователь, в свою очередь, является логическим пространством имен для набора разрешений, что обеспечивает детальный уровень авторизации и доступа к коллекции, документам и вложениям.  

Как и другие ресурсы в модели ресурсов Cosmos DB, базы данных могут создаваться, заменяться, удаляться, считываться или перечисляться с помощью [интерфейсов REST API](/rest/api/documentdb/) или любого [клиентского пакета SDK](documentdb-sdk-dotnet.md). Cosmos DB гарантирует строгую согласованность для чтения или запроса метаданных ресурса базы данных. Удаление базы данных автоматически означает, что вы больше не сможете получить доступ к любой из коллекций или пользователям, содержащимся в ней.   

## <a name="collections"></a>Коллекции
Коллекция Cosmos DB — это контейнер для документов JSON. 

### <a name="elastic-ssd-backed-document-storage"></a>Гибкое хранилище документов на базе SSD
Коллекция является неразрывно гибкой, она автоматически увеличивается и уменьшается по мере добавления или удаления документов. Коллекции — это логические ресурсы, они могут включать в себя одну или несколько физических секций или серверов. Число секций в коллекции определяется Cosmos DB на основе размера хранилища и подготовленной пропускной способности коллекции. С каждой секцией в базе данных Azure Cosmos DB связано фиксированное количество хранилищ на основе SSD, которое реплицируется для обеспечения высокого уровня доступности. Управление секциями полностью осуществляется базой данных Azure Cosmos DB, и нет необходимости создавать сложный код или управлять секциями. Коллекции Cosmos DB **практически не ограничены** в объеме хранилища и пропускной способности. 

### <a name="automatic-indexing-of-collections"></a>Автоматическое индексирование коллекций
Cosmos DB — это система баз данных без схемы. Она не подразумевает и не требует указания каких-либо схем для документов JSON. По мере добавления документов в коллекцию Cosmos DB автоматически индексирует их, и они становятся доступны для выполнения запросов. Автоматическая индексация документов, не требующая указания схемы или вторичных индексов, является ключевой возможностью Cosmos DB и доступна благодаря оптимизированным для записи технологиям обслуживания индексов без блокировки, которые структурированы для журнала. Cosmos DB поддерживает устойчивый объем чрезвычайно быстрых операций записи и в то же время обслуживает согласованные запросы. Хранилище и документов и индекса используется для расчета объема хранения, потребляемого каждой коллекцией. Вы можете управлять компромиссом между объемом хранения и производительностью, связанным с индексацией по настройке политики индексирования для коллекции. 

### <a name="configuring-the-indexing-policy-of-a-collection"></a>Настройка политики индексирования коллекции
Политика индексирования каждой коллекции позволяет настраивать соотношения производительности и объема, связанные с индексацией. Для конфигурации индексирования доступны следующие параметры:  

* Выберите, будет ли коллекция автоматически индексировать все документы или нет. По умолчанию все документы индексируются автоматически. Можно отключать автоматическое индексирование и добавлять только выбранные документы в индекс. И наоборот, вы можете выборочно указать, какие документы необходимо исключить из индексирования. Вы можете добиться этого путем установки автоматического логического свойства indexingPolicyколлекции и с помощью заголовка запроса [x-ms-indexingdirective] при вставке, замене или удалении документа.  
* Укажите, следует ли включить или исключить определенные пути или шаблоны в документах из индекса. Вы можете добиться этого путем установки includedPaths и excludedPaths на indexingPolicy коллекции соответственно. Вы также можете настроить соотношения объема и производительности для интервала и хэш-запросов для конкретных шаблонов пути. 
* Выбор между синхронными обновлениями (согласованные) и асинхронными обновлениями (отложенные) индекса. По умолчанию, индекс обновляется синхронно при каждой операции вставки, заменить или удаления документа в коллекции. Это позволяет выполнять запросы с уровнем согласованности, как и в документе. В то время как Cosmos DB является системой, оптимизированной для операций записи и поддерживающей устойчивые объемы записей документов вместе с синхронным обслуживанием индекса и согласованных запросов, вы можете настроить определенные коллекции для отложенного обновления их ​​индексов. Отложенное индексирование еще больше повышает производительность операций записи и идеально подходит для сценариев пакетной вставки, прежде всего для чтения больших коллекций.

Вы можете изменить политику индексирования, выполнив запрос PUT для коллекции. Это можно сделать с помощью [клиентского пакета SDK](documentdb-sdk-dotnet.md), [портала Azure](https://portal.azure.com) или [интерфейсов REST API](/rest/api/documentdb/).

### <a name="querying-a-collection"></a>Запросы к коллекции
Документы в коллекции могут иметь произвольные схемы, и вы можете запрашивать их без предварительного предоставления любой схемы или вторичных индексов. Вы можете запрашивать коллекцию, используя [справочник по синтаксису SQL-запросов API DocumentDB в Azure Cosmos DB](https://msdn.microsoft.com/library/azure/dn782250.aspx). Он предоставляет богатый выбор иерархических, реляционных и пространственных операторов, а также возможность расширения с использованием определяемых пользователем функций на основе JavaScript. Грамматика JSON позволяет моделировать документы JSON в форме деревьев с метками в качестве узлов. Этот подход используется для автоматического индексирования API DocumentDB, а также лежит в основе диалекта SQL API DocumentDB. Язык запросов API DocumentDB построен на следующих трех основных принципах.   

1. Небольшой набор операций запросов, которые естественным образом отображаются в древовидной структуре в том числе иерархических запросов и проекций. 
2. Подмножество реляционных операций, включая композиции, фильтры, проекции, агрегатов и внутренние соединения. 
3. Пользовательские функции на основе чистого JavaScript, которые работают с (1) и (2)  

Модель запросов Cosmos DB пытается установить баланс между функциональностью, эффективностью и простотой. Ядро базы данных Cosmos DB непосредственно компилирует и выполняет инструкции SQL-запросов. Вы можете запросить коллекцию с помощью [интерфейсов REST API](/rest/api/documentdb/) или любого из [клиентских пакетов SDK](documentdb-sdk-dotnet.md). В комплект пакета .NET SDK входит поставщик LINQ.

> [!TIP]
> Вы можете испытать API DocumentDB в действии и выполнить запросы SQL набора данных в среде [Query Playground](https://www.documentdb.com/sql/demo).
> 
> 

## <a name="multi-document-transactions"></a>Операции над несколькими документами
Транзакции в базах данных обеспечивают безопасную и предсказуемую модель программирования для работы с одновременными изменениями данных. В РСУБД традиционный способ создания бизнес-логики заключается в том, чтобы написать **хранимые процедуры** и (или) **триггеры** и передать их на сервер базы данных для выполнения в транзакциях. В РСУБД, прикладному программисту приходится иметь дело с двумя разнородными языками программирования: 

* Нетранзакционный язык прикладного программирования (JavaScript, Python, C#, Java и др.).
* Транзакционный язык T-SQL, который является "родным" для базы данных.

Так как служба является оптимизированной для JavaScript и JSON непосредственно в базе данных, Cosmos DB обеспечивает интуитивную модель программирования для выполнения логики приложения на основе JavaScript непосредственно в коллекциях в виде хранимых процедур и триггеров. Это позволяет получить

* с одной стороны, эффективные механизмы восстановления, управления параллелизмом и автоматической индексации графов объектов JSON прямо в ядре СУБД;
* с другой стороны, естественное выражение потока управления, области видимости переменных, присвоения, а также интеграцию примитивов обработки исключений с транзакциями базы данных непосредственно на JavaScript.

Логика JavaScript, регистрируемая на уровне коллекции, может выполнять операции с базами данных на документах данной коллекции. Cosmos DB неявно обертывает хранимые процедуры и триггеры на основе JavaScript в пределах транзакций ACID с изоляцией моментальных снимков документов в коллекции. В ходе его исполнения, если код JavaScript генерирует исключение, то вся транзакция прерывается. Полученная модель программирования является очень простой, но мощной. Разработчики JavaScript получают "надежную" модель программирования, при этом используя привычные языковые конструкции и библиотечные примитивы.   

Возможность выполнить JavaScript непосредственно в ядре базы данных в том же адресном пространстве, что буферный пул, позволяет производительное и транзакционное выполнение операций с базами данных над документами коллекции. Кроме того, ядро СУБД Cosmos DB оптимизировано для JSON и JavaScript, что устраняет несоответствия между системами типов приложения и базой данных.   

После создания коллекции можно зарегистрировать хранимые процедуры, триггеры и определяемые пользователем функции с помощью [REST API](/rest/api/documentdb/) или любого [клиентского пакета SDK](documentdb-sdk-dotnet.md). После регистрации вы можете использовать и выполнять их. Рассмотрим приведенный ниже код хранимой процедуры, написанный полностью на JavaScript. Процедура принимает два аргумента (имя книги и имя автора), создает новый документ, выполняет запрос документа и обновляет его. Все эти действия выполняются в ходе неявной транзакции ACID. Транзакция будет прервана в любой момент выполнения, если будет выдано исключение JavaScript.

    function businessLogic(name, author) {
        var context = getContext();
        var collectionManager = context.getCollection();        
        var collectionLink = collectionManager.getSelfLink()

        // create a new document.
        collectionManager.createDocument(collectionLink,
            {id: name, author: author},
            function(err, documentCreated) {
                if(err) throw new Error(err.message);

                // filter documents by author
                var filterQuery = "SELECT * from root r WHERE r.author = 'George R.'";
                collectionManager.queryDocuments(collectionLink,
                    filterQuery,
                    function(err, matchingDocuments) {
                        if(err) throw new Error(err.message);

                        context.getResponse().setBody(matchingDocuments.length);

                        // Replace the author name for all documents that satisfied the query.
                        for (var i = 0; i < matchingDocuments.length; i++) {
                            matchingDocuments[i].author = "George R. R. Martin";
                            // we don’t need to execute a callback because they are in parallel
                            collectionManager.replaceDocument(matchingDocuments[i]._self,
                                matchingDocuments[i]);   
                        }
                    })
            })
    };

Клиент может "грузить" вышеуказанную JavaScript логику в базу данных для транзакционного исполнения через HTTP POST. Дополнительные сведения об использовании методов HTTP см. в статье [Azure Cosmos DB: Azure Cosmos DB REST API](https://msdn.microsoft.com/library/azure/mt622086.aspx) (Azure Cosmos DB. REST API Azure Cosmos DB). 

    client.createStoredProcedureAsync(collection._self, {id: "CRUDProc", body: businessLogic})
       .then(function(createdStoredProcedure) {
            return client.executeStoredProcedureAsync(createdStoredProcedure.resource._self,
                "NoSQL Distilled",
                "Martin Fowler");
        })
        .then(function(result) {
            console.log(result);
        },
        function(error) {
            console.log(error);
        });


Обратите внимание, что, поскольку база данных изначально понимает JSON и JavaScript, нет проблемы несоответствия типов, нет "отображения ИЛИ" или генерации "магического" кода.   

Хранимые процедуры и триггеры взаимодействуют с коллекцией и документами в коллекции через четко определенную объектную модель, которая отражает текущий контекст коллекции.  

Коллекции в API DocumentDB можно создавать, удалять, считывать и перечислять с помощью [интерфейсов REST API](/rest/api/documentdb/) или любого [клиентского пакета SDK](documentdb-sdk-dotnet.md). API DocumentDB всегда обеспечивает строгую согласованность для чтения или запроса метаданных коллекции. Удаление коллекции автоматически гарантирует, что вы не сможете получить доступ к любому из документов, вложений, хранимых процедур, триггеров и пользовательских функций, содержащихся в ней.   

## <a name="stored-procedures-triggers-and-user-defined-functions-udf"></a>Хранимые процедуры, триггеры и определяемые пользователями функции (UDF)
Как описано в предыдущем разделе, вы можете реализовать логику приложения для непосредственного исполнения в рамках транзакции ядра СУБД. Логика приложения может быть полностью написана на JavaScript и смоделирована в виде хранимой процедуры, триггера или определяемой пользователем функции. Код JavaScript в хранимой процедуре или триггере может вставлять, заменять, удалять, читать или формировать запросы к документам коллекции. С другой стороны, код JavaScript в определяемой пользователем функции не может добавлять, заменять или удалять документы. Определяемые пользователем функции перечисляют документы из результата запроса и создают новый набор результатов. Для мультитенантности Cosmos DB реализует управление ресурсами на основе строгого резервирования. Для каждой хранимой процедуры, триггера или пользовательской функции выделяется фиксированный квант ресурсов операционной системы, чтобы выполнить свою задачу. Кроме того, хранимые процедуры, триггеры и пользовательские функции не могут подключать внешние библиотеки JavaScript и попадают в черный список, если превышают установленные для них пределы ресурсов. Вы можете зарегистрировать или отменить регистрацию хранимых процедур, триггеров или пользовательских функций в коллекции через API REST.  После регистрации хранимая процедура, триггер или пользовательская функция предварительно компилируются и хранятся в виде байт-кода, который позже запускается на выполнение. В следующем разделе показано, как можно использовать пакет SDK JavaScript службы Cosmos DB для регистрации, выполнения и отмены регистрации хранимой процедуры, триггера и определяемой пользователем функции. Пакет SDK JavaScript является простой программой-оболочкой [интерфейсов REST API](/rest/api/documentdb/). 

### <a name="registering-a-stored-procedure"></a>Регистрация хранимой процедуры
Регистрация хранимой процедуры — это создание нового ресурса хранимой процедуры ресурса в коллекции с помощью HTTP POST.  

    var storedProc = {
        id: "validateAndCreate",
        body: function (documentToCreate) {
            documentToCreate.id = documentToCreate.id.toUpperCase();

            var collectionManager = getContext().getCollection();
            collectionManager.createDocument(collectionManager.getSelfLink(),
                documentToCreate,
                function(err, documentCreated) {
                    if(err) throw new Error('Error while creating document: ' + err.message;
                    getContext().getResponse().setBody('success - created ' + 
                            documentCreated.name);
                });
        }
    };

    client.createStoredProcedureAsync(collection._self, storedProc)
        .then(function (createdStoredProcedure) {
            console.log("Successfully created stored procedure");
        }, function(error) {
            console.log("Error");
        });

### <a name="executing-a-stored-procedure"></a>Выполнение хранимой процедуры
Выполнение хранимой процедуры осуществляется с помощью команды HTTP POST, запускаемой для существующего ресурса хранимой процедуры, с передачей параметров в теле запроса.

    var inputDocument = {id : "document1", author: "G. G. Marquez"};
    client.executeStoredProcedureAsync(createdStoredProcedure.resource._self, inputDocument)
        .then(function(executionResult) {
            assert.equal(executionResult, "success - created DOCUMENT1");
        }, function(error) {
            console.log("Error");
        });

### <a name="unregistering-a-stored-procedure"></a>Отмена регистрации хранимой процедуры
Отменить регистрацию хранимой процедуры можно с помощью команды HTTP DELETE, выполняемой для существующего ресурса хранимой процедуры.   

    client.deleteStoredProcedureAsync(createdStoredProcedure.resource._self)
        .then(function (response) {
            return;
        }, function(error) {
            console.log("Error");
        });


### <a name="registering-a-pre-trigger"></a>Регистрация триггера со срабатыванием до наступления события
Регистрация триггера осуществляется путем создания ресурса триггера в коллекции с помощью команды HTTP POST. Вы можете указать тип срабатывания триггера и тип операции, с которой он может быть связан (например, создание, замена, удаление или все типы).   

    var preTrigger = {
        id: "upperCaseId",
        body: function() {
                var item = getContext().getRequest().getBody();
                item.id = item.id.toUpperCase();
                getContext().getRequest().setBody(item);
        },
        triggerType: TriggerType.Pre,
        triggerOperation: TriggerOperation.All
    }

    client.createTriggerAsync(collection._self, preTrigger)
        .then(function (createdPreTrigger) {
            console.log("Successfully created trigger");
        }, function(error) {
            console.log("Error");
        });

### <a name="executing-a-pre-trigger"></a>Запуск триггера со срабатыванием до наступления события
Выполнение триггера производится путем указания в заголовке запроса имени существующего триггера в момент выдачи запроса POST/PUT/DELETE к ресурсу документа.  

    client.createDocumentAsync(collection._self, { id: "doc1", key: "Love in the Time of Cholera" }, { preTriggerInclude: "upperCaseId" })
        .then(function(createdDocument) {
            assert.equal(createdDocument.resource.id, "DOC1");
        }, function(error) {
            console.log("Error");
        });

### <a name="unregistering-a-pre-trigger"></a>Отмена регистрации триггера со срабатыванием до наступления события
Отменить регистрацию триггера можно с помощью команды HTTP DELETE, выполняемой для существующего ресурса триггера.  

    client.deleteTriggerAsync(createdPreTrigger._self);
        .then(function(response) {
            return;
        }, function(error) {
            console.log("Error");
        });

### <a name="registering-a-udf"></a>Регистрация определяемой пользователем функции
Регистрация определяемой пользователем функции осуществляется путем создания нового ресурса UDF в коллекции или через команду HTTP POST.  

    var udf = { 
        id: "mathSqrt",
        body: function(number) {
                return Math.sqrt(number);
        },
    };
    client.createUserDefinedFunctionAsync(collection._self, udf)
        .then(function (createdUdf) {
            console.log("Successfully created stored procedure");
        }, function(error) {
            console.log("Error");
        });

### <a name="executing-a-udf-as-part-of-the-query"></a>Выполнение определяемой пользователем функции как части запроса
Определяемая пользователем функция (UDF) указывается в SQL-запросах и позволяет расширить [язык запросов SQL API DocumentDB](https://msdn.microsoft.com/library/azure/dn782250.aspx).

    var filterQuery = "SELECT udf.mathSqrt(r.Age) AS sqrtAge FROM root r WHERE r.FirstName='John'";
    client.queryDocuments(collection._self, filterQuery).toArrayAsync();
        .then(function(queryResponse) {
            var queryResponseDocuments = queryResponse.feed;
        }, function(error) {
            console.log("Error");
        });

### <a name="unregistering-a-udf"></a>Отмена регистрации определяемой пользователем функции
Отменить регистрацию определяемой пользователем функции можно с помощью команды HTTP DELETE, выполняемой для существующего ресурса UDF.  

    client.deleteUserDefinedFunctionAsync(createdUdf._self)
        .then(function(response) {
            return;
        }, function(error) {
            console.log("Error");
        });

Хотя в примерах выше используются команды для регистрации (POST), отмены регистрации (PUT), чтения и получения списка (GET), а также выполнения (POST) с помощью [пакета SDK JavaScript](https://github.com/Azure/azure-documentdb-js), можно также использовать интерфейсы [REST API](/rest/api/documentdb/) или другие [клиентские пакеты SDK](documentdb-sdk-dotnet.md). 

## <a name="documents"></a>Документы
Вы можете вставлять, заменять, удалять, читать, перечислять и запрашивать произвольные документы JSON в коллекции. Cosmos DB не требует указывать схему и создавать вторичные индексы для поддержки запросов к документам в коллекции. Максимальный размер документа составляет 2 МБ.   

Являясь по-настоящему открытой службой базы данных, Cosmos DB не изобретает какие-то специализированные типы данных (например, date time) или конкретные кодировки для документов JSON. Обратите внимание, что Cosmos DB не требует никаких специальных соглашений JSON для обозначения связей между различными документами. Реализованный в Cosmos DB синтаксис SQL предоставляет мощные иерархические и реляционные операторы для создания запросов и документов проекта. При этом вам не требуется использовать специальные примечания или выражать взаимосвязи между документами с помощью отличительных свойств.  

Как и для всех других ресурсов, документы могут быть созданы, заменены, удалены, прочитаны, перечислены и запрошены с использованием API REST или любого [клиентского пакета SDK](documentdb-sdk-dotnet.md). Удаление документа мгновенно освобождает квоту, соответствующую всем его вложениям. Уровень согласованности для чтения документов соответствует политике согласованности для учетной записи базы данных. Эта политика может быть переопределена для каждого запроса в зависимости от требований к согласованности данных для вашего приложения. При запросе документов согласованность чтения соответствует режиму индексирования, который задан в коллекции. Понятие "согласованность" следует политике согласованности для учетной записи базы данных. 

## <a name="attachments-and-media"></a>Вложения и мультимедиа
Cosmos DB позволяет хранить большие двоичные объекты и мультимедийные файлы непосредственно в Cosmos DB (не более 2 ГБ на одну учетную запись) или в удаленном хранилище файлов. Она также позволяет представлять метаданные медиафайлов в виде особого документа под названием "вложение". Вложение в Cosmos DB — это специальный документ JSON, который ссылается на медиафайлы или большие двоичные объекты, хранящиеся где угодно. Вложение представляет собой специальный документ, который фиксирует метаданные (например, расположение, автора и т. д.) медиафайлов, хранящихся в удаленном хранилище. 

Рассмотрим социальное приложение для чтения, которое использует Cosmos DB для хранения заметок и метаданных, включая комментарии, выделения, закладки, рейтинги, пометки "нравится" или "не нравится" и т. д., связанные с электронной книгой данного пользователя.   

* Содержание самой книги хранится в файловом хранилище, доступном как часть учетной записи базы данных Cosmos DB или как удаленное хранилище файлов. 
* Приложение может хранить метаданные каждого пользователя в виде отдельного документа. Например, метаданные пользователя Джо для книги Book1 можно хранить в документе, имеющем ссылку /colls/joe/docs/book1. 
* Вложения, указывающие на страницы содержимого данной книги пользователя, хранятся в соответствующем документе, например, /colls/joe/docs/book1/chapter1, /colls/joe/docs/book1/chapter2 и т. д. 

Обратите внимание, что в приведенных выше примерах используются мнемонические идентификаторы для передачи иерархии ресурсов. Ресурсы доступны через API REST с помощью уникальных идентификаторов ресурсов. 

Для медиафайлов, которые управляются Cosmos DB, свойство вложения _media будет содержать ссылку на URI медиафайла. Cosmos DB запустит уборку мусора, когда все находящиеся в коллекции ссылки на медиафайл будут удалены. Cosmos DB автоматически генерирует вложение, когда вы загружаете новые медиафайлы, и заполняет свойство _media ссылками на вновь добавленные файлы. Если вы решите хранить медиафайлы в удаленном хранилище больших двоичных объектов, управляемом вами (например OneDrive, хранилище Azure, DropBox и т. д.), вы можете использовать вложения для хранения ссылок. В этом случае вам придется создавать вложение и заполнять его свойство _media самостоятельно.   

Как и все прочие ресурсы, вложения могут быть созданы, заменены, удалены, прочитаны или перечислены с помощью API REST либо любого клиентского пакета SDK. Как и для документов, уровень согласованности для чтения вложений соответствует политике согласованности для учетной записи базы данных. Эта политика может быть переопределена для каждого запроса в зависимости от требований к согласованности данных для вашего приложения. При запросе вложений согласованность чтения соответствует режиму индексирования, который задан в коллекции. Понятие "согласованность" следует политике согласованности для учетной записи базы данных. 
 

## <a name="users"></a>Пользователи
Пользователь в Cosmos DB представляет собой логическое пространство имен для группировки разрешений. Пользователю в Cosmos DB может соответствовать пользователь в системе управления удостоверениями или предопределенной роли приложения. В рамках Cosmos DB пользователь представляет собой абстракцию для группировки набора разрешений в базе данных.   

Чтобы реализовать для приложения многопользовательскую среду, вы можете создавать пользователей в Cosmos DB, которые будут соответствовать фактическим пользователям или клиентам приложения. Затем можно создать разрешения для данного пользователя, которые соответствуют уровням доступа к различным коллекциям, документам, приложениям и т. д.   

По мере расширения вашего приложения с ростом количества пользователей вы можете использовать различные способы для сегментирования данных. Вы можете смоделировать каждого из пользователей следующим образом:   

* каждый пользователь сопоставлен базе данных;
* каждый пользователь сопоставлен коллекции; 
* документы, соответствующие нескольким пользователям, отправляются в выделенную коллекцию; 
* документы, соответствующие нескольким пользователям, отправляются в набор коллекций.   

Независимо от конкретной стратегии сегментирования, вы можете моделировать реальных пользователей в качестве пользователей в базе данных Cosmos DB и присваивать точные разрешения каждому.  

![Коллекции пользователей][3]  
**Стратегии сегментирования и моделирования пользователей**

Как и все прочие ресурсы, пользователей в Cosmos DB можно создавать, заменять, удалять, считывать или перечислять с помощью интерфейсов REST API либо любого клиентского пакета SDK. Cosmos DB всегда обеспечивает строгую согласованность для чтения или запроса метаданных ресурса пользователя. Стоит отметить, что при удалении пользователя гарантируется, что вы не сможете получить доступ к любому из разрешений, входящих в его состав. Удаленные разрешения станут доступны сразу же для повторного использования, несмотря на то, что Cosmos DB восстанавливает квоту разрешений удаленного пользователя в фоновом режиме.  

## <a name="permissions"></a>Разрешения
В контексте контроля доступа такие ресурсы, как учетные записи баз данных, базы данных, пользователи и разрешения, считаются *административными* ресурсами, так как для обращения к ним требуются права администратора. С другой стороны, ресурсы, включая коллекции, документы, вложения, хранимые процедуры, триггеры и пользовательские функции, находятся в области видимости данной базы данных и рассматриваются как *ресурсы приложения*. В соответствии с двумя типами ресурсов и ролями, которые обращаются к ним (администратора и пользователей), модель авторизации определяет два типа *ключей доступа*: *главный ключ* и *ключ ресурса*. Мастер-ключ является частью учетной записи базы данных и предоставляется разработчику (или администратору), который подготавливает учетную запись базы данных. Этот мастер-ключ имеет семантику администратора, в том смысле, что он может быть использован для того, чтобы разрешить доступ как к административным, так и к прикладным ресурсам. В отличие от этого, ключ ресурса является разделенным ключом доступа, который позволяет получить доступ к *определенному* ресурсу приложения. Таким образом, он охватывает отношения между пользователем базы данных и разрешениями пользователя, которые он имеет для определенного ресурса (например, коллекции, документа, вложения, хранимой процедуры, триггера или пользовательской функции).   

Единственным способом получить ключ ресурса является создание разрешения для ресурса под конкретного пользователя. Обратите внимание, что в для создания или получения разрешения, мастер-ключ должен быть представлен в заголовке авторизации. Разрешение ресурса связывает ресурс, доступ к нему и пользователя. После создания разрешения ресурса пользователю нужно только предоставить ключ, связанный с ресурсами, для того чтобы получить доступ к соответствующему ресурсу. Таким образом, ключ ресурса можно рассматривать как логическое и компактное представление разрешения ресурса.  

Как и все прочие ресурсы, разрешения можно создать, заменить, удалить, считать или перечислить с помощью интерфейсов REST API или любого клиентского пакета SDK. Cosmos DB всегда обеспечивает предельную согласованность для чтения или запроса метаданных разрешения. 

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о работе с ресурсами с помощью команд HTTP см. в статье [Azure Cosmos DB: Azure Cosmos DB REST API](https://msdn.microsoft.com/library/azure/mt622086.aspx) (Azure Cosmos DB. REST API Azure Cosmos DB).

[1]: media/documentdb-resources/resources1.png
[2]: media/documentdb-resources/resources2.png
[3]: media/documentdb-resources/resources3.png


---
title: "Уровни согласованности в Azure Cosmos DB | Документация Майкрософт"
description: "В Azure Cosmos DB есть пять уровней согласованности, что позволяет сбалансировать компромиссы между согласованностью в конечном счете, доступностью и задержками."
keywords: "согласованность в конечном счете, azure cosmos db, azure, Microsoft Azure"
services: cosmos-db
author: mimig1
manager: jhubbard
editor: cgronlun
documentationcenter: 
ms.assetid: 3fe51cfa-a889-4a4a-b320-16bf871fe74c
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/16/2017
ms.author: mimig
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: a1ebec2285982c70aa9dc49950769fe18e2e2d0d
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="tunable-data-consistency-levels-in-azure-cosmos-db"></a>Настраиваемые уровни согласованности данных в Azure Cosmos DB
Служба Azure Cosmos DB была разработана "с нуля", при этом в ее основу заложены возможности глобального распространения данных для всех моделей данных. Она предлагает гарантии прогнозируемой низкой задержки, соглашение об уровне обслуживания, обеспечивающее 99,99 % доступности, и нескольких четко определенных моделей нестрогой согласованности. Сейчас Azure Cosmos DB поддерживает пять уровней согласованности: строгий, с ограниченным устареванием, уровня сеанса, согласованность префиксов и согласованный в конечном счете. 

Помимо **строгой** модели и модели **согласованности в конечном счете**, обычно предусмотренных в распределенных базах данных, Azure Cosmos DB предлагает три тщательно кодифицированные и реализованные практически модели согласованности, эффективность которых была подтверждена реальными случаями использования. Эти уровни называются **согласованностью с ограниченным устареванием**, **согласованностью уровня сеанса** и **согласованностью префиксов**. Все вместе эти пять уровней согласованности позволяют принимать обоснованные компромиссы между показателями согласованности, доступности и задержки. 

## <a name="distributed-databases-and-consistency"></a>Распределенные базы данных и согласованность
Коммерческие распределенные базы данных делятся на две категории: базы данных, которые вообще не предлагают точно определенные, проверяемые варианты согласованности, и базы данных, которые обеспечивают два радикальных варианта программирования (строгая и итоговая согласованность). 

Первый вариант обременяет разработчиков приложений деталями протоколов репликации и предполагает компромисс между согласованностью, доступностью, низкой задержкой и пропускной способностью. Второй заставляет выбирать одну из двух крайностей. Несмотря на множество исследований и более 50 предложенных моделей согласованности сообществу распределенных баз данных не удается вывести на рынок уровни согласованности, отличные от строгого и итогового. Cosmos DB позволяет разработчикам выбрать одну из пяти точно определенных моделей согласованности разного уровня. Вы можете выбрать строгую согласованность, согласованность с ограниченным устареванием, [согласованность уровня сеанса](http://dl.acm.org/citation.cfm?id=383631), согласованность префиксов и согласованность в конечном счете. 

![Несколько четко определенных моделей согласованности (нестрогой) Azure Cosmos DB на ваш выбор](./media/consistency-levels/five-consistency-levels.png)

В следующей таблице представлены конкретные гарантии, предоставляемые на каждом уровне согласованности.
 
**Уровни согласованности и гарантии**

| Уровень согласованности | Гарантии |
| --- | --- |
| Уровень согласованности Strong (сильная) | Линеаризация |
| Ограниченное устаревание | Согласованность префиксов. Операции чтения могут отставать от операций записи не более чем на K префиксов или на интервал времени t. |
| Сеанс   | Согласованность префиксов. Монотонные операции чтения и записи, чтение собственных операций записи, запись после чтения. |
| Согласованность префиксов | Обновления, которые возвращаются, содержат часть префиксов всех обновлений, без разрывов. |
| Уровень согласованности Eventual (в конечном счете)  | Неупорядоченное чтение |

Для учетной записи Cosmos DB можно настроить уровень согласованности по умолчанию (и позже переопределить согласованность для определенного запроса на чтение). На внутреннем уровне уровни согласованности по умолчанию применяются к данным в наборах секций, которые могут охватывать регионы. Около 73 % наших клиентов использует согласованность уровня сеанса, а 20 % предпочитают согласованность с ограниченным устареванием. Мы заметили, что примерно 3 % наших клиентов экспериментируют с различными уровнями согласованности, прежде чем устанавливать определенную согласованность для своего приложения. Мы также заметили, что всего 2 % наших клиентов переопределяет уровни согласованности для каждого запроса. 

В Cosmos DB операции чтения, выполняемые с согласованностью уровня сеанса, согласованностью префиксов и согласованностью в конечном счете в два раза дешевле, чем операции чтения, выполняемые со строгой согласованностью или согласованностью с ограниченным устареванием. Cosmos DB обеспечивает лучшие в отрасли соглашения об уровне обслуживания (SLA) с доступностью на уровне 99,99 %, включая гарантии согласованности и доступности, высокий показатель пропускной способности и низкий уровень задержки. Мы используем [проверку линеаризация](http://dl.acm.org/citation.cfm?id=1806634), которая постоянно анализирует телеметрию службы и открыто сообщает о любых нарушениях согласованности. При согласованности с ограниченным устареванием мы отслеживаем все нарушения ограничений k и t и сообщаем о них. Для всех пяти уровней нестрогой согласованности мы также сообщаем вам напрямую [метрику вероятностного ограниченного устаревания](http://dl.acm.org/citation.cfm?id=2212359).  

## <a name="scope-of-consistency"></a>Область действия согласованности
Степень детализации согласованности ограничивается запросом одного пользователя. Запрос записи может соответствовать транзакции Insert, Replace, Upsert или Delete. Как и запись, транзакция чтения или запроса также ограничена одним запросом пользователя. Пользователю может потребоваться разбить на страницы большой результирующий набор, охватывающий нескольких секций, но каждая транзакция чтения ограничена одной страницей и обслуживается в одной секции.

## <a name="consistency-levels"></a>Уровни согласованности
Вы можете настроить уровень согласованности по умолчанию для учетной записи базы данных, который будет распространяться на все коллекции (и базы данных) под вашей учетной записью Cosmos DB. По умолчанию все операции чтения и запросов к определенным пользователем ресурсам используют уровень согласованности по умолчанию, заданный в учетной записи базы данных. Можно снизить уровень согласованности конкретного запроса (на чтение или операцию) в каждом из поддерживаемых интерфейсов API. Существует пять типов уровней согласованности, поддерживаемых протоколом репликации Azure Cosmos DB, которые обеспечивают четкий компромисс между определенными гарантиями целостности и производительности, как описано в этом разделе.

**Уровень согласованности Strong (сильная)**: 

* Строгая согласованность предлагает гарантию [линеаризации](https://aphyr.com/posts/313-strong-consistency-models), обеспечивающую возвращение самой последней версии элемента операциями чтения. 
* Сильный уровень согласованности гарантирует, что операция записи отображается только после ее завершения большинством необходимого набора реплик. Операция записи либо синхронно фиксируется первичной репликой и кворумом вторичных реплик, либо прерывается. Операция чтения всегда признается большинством кворума чтения, клиент никогда не сможет увидеть незафиксированную или частичную запись и всегда гарантированно считает последние подтвержденные записанные данные. 
* Учетную запись Azure Cosmos DB, настроенную для использования строгой согласованности, нельзя связать более чем с одним регионом Azure. 
* Затраты на операцию чтения (в используемых [единицах запроса](request-units.md) ) при строгой согласованности выше, чем при согласованности уровня сеанса и согласованности в конечном счете, но не отличаются от затрат при согласованности с ограниченным устареванием.

**Ограниченное устаревание** 

* Согласованность с ограниченным устареванием гарантирует, что операции чтения могут отставать от записи не более чем на *K* версий или префиксов элемента или на интервал времени *t*. 
* Следовательно, при выборе ограниченного устаревания это самое "устаревание" можно настроить двумя способами: указать количество *K* версий элемента, на которое операции чтения могут отставать от операций записи, и интервал времени *t*. 
* Согласованность с ограниченным устареванием обеспечивает общий глобальный порядок в пределах "окна устаревания". Гарантии монотонных операций чтения в регионе существуют как в пределах "окна устаревания", так и вне его. 
* Модель ограниченного устаревания обеспечивает более надежную гарантию согласованности, чем согласованность уровня сеанса и согласованность в конечном счете. Для глобально распределенных приложений мы рекомендуем использовать ограниченное устаревание в ситуациях, где требуется строгая согласованность, но при этом необходима доступность порядка 99,99 % и низкая задержка. 
* С учетными записями Azure Cosmos DB, для которых настроена согласованность с ограниченным устареванием, можно связать любое количество регионов Azure. 
* Затраты на операцию чтения (в используемых единицах запроса) с ограниченным устареванием выше, чем при согласованности уровня сеанса и согласованности в конечном счете, но не отличаются от затрат при строгой согласованности.

**Уровень согласованности Session (сеанс)**: 

* В отличие от глобальных моделей согласованности, предлагаемых уровнями строгой согласованности и согласованности с ограниченным устареванием, согласованность уровня сеанса ограничена сеансом клиента. 
* Согласованность уровня сеанса идеально подходит для всех сценариев, включающих в себя сеанс устройства или пользователя, так как она гарантирует монотонное чтение и монотонную запись, а также гарантирует чтение собственных записей (RYW). 
* Согласованность уровня сеанса обеспечивает предсказуемую согласованность для сеанса и максимальную пропускную способность, предлагая самые низкие задержки при записи и чтении. 
* С учетными записями Azure Cosmos DB, для которых настроена согласованность уровня сеанса, можно связать любое количество регионов Azure. 
* Затраты на операцию чтения (в используемых единицах запроса) для модели согласованности уровня сеанса меньше, чем для строгой согласованности или согласованности с ограниченным устареванием, но больше, чем для согласованности в конечном счете.

<a id="consistent-prefix"></a>
**Согласованность префиксов**: 

* Согласованность префиксов гарантирует, что в отсутствие каких-либо последующих операций записи реплики в группе в конечном счете сходятся. 
* Согласованность префиксов гарантирует, что операции чтения никогда не столкнутся с неупорядоченными операциями записи. Если операции записи выполнялись в порядке `A, B, C`, то клиент видит `A`, `A,B` или `A,B,C`, но никогда не видит неупорядоченные операции `A,C` или `B,A,C`.
* С учетными записями Azure Cosmos DB, для которых настроена согласованность префиксов, можно связать любое количество регионов Azure. 

**Уровень согласованности Eventual (в конечном счете)**: 

* Согласованность в конечном счете гарантирует, что в отсутствие каких-либо последующих операций записи реплики в группе в конечном счете сходятся. 
* Согласованность в конечном счете является самой нестрогой формой согласованности, при которой клиент может получить значения, которые являются более старыми по отношению к полученным ранее.
* Согласованность «в конечном счете» оказывается самой слабо связанной согласованностью чтения, но предлагает наименьшую задержку как для чтения, так и для записи.
* С учетными записями Azure Cosmos DB, для которых настроена согласованность в конечном счете, можно связать любое количество регионов Azure. 
* Затраты на операцию чтения (в используемых единицах запроса) для уровня согласованности в конечном счете являются самыми низкими среди уровней согласованности Azure Cosmos DB.

## <a name="configuring-the-default-consistency-level"></a>Настройка уровня согласованности по умолчанию
1. На навигационной панели [портала Azure](https://portal.azure.com/) щелкните **Azure Cosmos DB**.
2. В колонке **Azure Cosmos DB** выберите учетную запись базы данных, которую нужно изменить.
3. В колонке учетной записи щелкните **Согласованность по умолчанию**.
4. В колонке **Согласованность по умолчанию** выберите новый уровень согласованности и щелкните **Сохранить**.
   
    ![Снимок экрана, на котором показан значок "Параметры" и запись "Согласованность по умолчанию"](./media/consistency-levels/database-consistency-level-1.png)

## <a name="consistency-levels-for-queries"></a>Уровни согласованности для запросов
По умолчанию для определенных пользователем ресурсов уровень согласованности запросов совпадает с уровнем согласованности операций чтения. По умолчанию, индекс обновляется синхронно при каждой операции вставки, замены или удаления элемента в контейнере Cosmos DB. Это позволяет выполнять запросы с уровнем согласованности, как и в операциях чтения. В то время как служба Azure Cosmos DB оптимизирована для операций записи и поддерживает устойчивые объемы операций записи, синхронное обслуживание индекса и обслуживание согласованных запросов, вы можете настроить определенные коллекции для отложенного обновления их ​​индексов. Отложенное индексирование еще больше повышает производительность операций записи и идеально подходит для сценариев пакетной вставки, прежде всего для чтения больших объемов данных.  

| Режим индексирования | Операции чтения | Запросы |
| --- | --- | --- |
| Режим согласованности (по умолчанию) |Можно выбрать строгую согласованность, согласованность с ограниченным устареванием, согласованность уровня сеанса, согласованность префиксов или согласованность в конечном счете. |Можно выбрать строгую согласованность, согласованность с ограниченным устареванием, согласованность уровня сеанса и согласованность в конечном счете. |
| Отложенная |Можно выбрать строгую согласованность, согласованность с ограниченным устареванием, согласованность уровня сеанса, согласованность префиксов или согласованность в конечном счете. |Уровень согласованности Eventual (в конечном счете) |
| None |Можно выбрать строгую согласованность, согласованность с ограниченным устареванием, согласованность уровня сеанса, согласованность префиксов или согласованность в конечном счете. |Не применяется |

Как и для запросов на чтение, можно снизить уровень согласованности конкретного запроса в каждом API.

## <a name="next-steps"></a>Дальнейшие действия
Если вы хотите получить дополнительные сведения об уровнях согласованности и компромиссах, рекомендуем ознакомиться со следующими ресурсами:

* Даг Терри. Объяснение согласованности при репликации данных на примере бейсбола (видео).   
  [https://www.youtube.com/watch?v=gluIh8zd26I](https://www.youtube.com/watch?v=gluIh8zd26I)
* Даг Терри. Объяснение согласованности при репликации данных на примере игры в бейсбол (Replicated Data Consistency explained through baseball).   
  [http://research.microsoft.com/pubs/157411/ConsistencyAndBaseballReport.pdf](http://research.microsoft.com/pubs/157411/ConsistencyAndBaseballReport.pdf)
* Даг Терри. Гарантии на уровне сеанса для репликации слабо согласованных данных.   
  [http://dl.acm.org/citation.cfm?id=383631](http://dl.acm.org/citation.cfm?id=383631)
* Дэниэл Абади. Компромиссы согласованности в современных распределенных системах проектирования баз данных: распределенных: ограничением является частью статьи: теорема CAP — это только начало...".   
  [http://computer.org/csdl/mags/co/2012/02/mco2012020037-abs.html](http://computer.org/csdl/mags/co/2012/02/mco2012020037-abs.html)
* Питер Бейлис, Шиварам Венкатараман, Майкл Дж. Франклин, Джозеф М. Хеллерштейн, Ион Стойка (Peter Bailis, Shivaram Venkataraman, Michael J. Franklin, Joseph M. Hellerstein, Ion Stoica). Вероятностное ограниченное запаздывание (PBS) для практических неполных кворумов.   
  [http://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf](http://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf)
* Вернер Вогелс. Возвращаясь к вопросу о согласованности в конечном счете.    
  [http://allthingsdistributed.com/2008/12/eventually_consistent.html](http://allthingsdistributed.com/2008/12/eventually_consistent.html)
* Мони Наор, Авишаи Вул (Moni Naor, Avishai Wool). Статья "The Load, Capacity, and Availability of Quorum Systems" (Нагрузка, емкость и доступность в кворумных системах) в журнале SIAM Journal on Computing, том 27, выпуск 2, стр. 423-447, апрель 1998 г.
  [http://epubs.siam.org/doi/abs/10.1137/S0097539795281232](http://epubs.siam.org/doi/abs/10.1137/S0097539795281232)
* Себастьян Буркхардт, Крис Дерн, Маканал Мусувати, Рой Тан (Sebastian Burckhardt, Chris Dern, Macanal Musuvathi, Roy Tan). "Line-up: a complete and automatic linearizability checker" (Line-up: полная автоматическая проверка линеаризации). Тезисы конференции 2010 ACM SIGPLAN по проектированию и реализации языков программирования, 5-10 июня 2010 г., г. Торонто, штат Онтарио, Канада [doi>10.1145/1806596.1806634] [http://dl.acm.org/citation.cfm?id=1806634](http://dl.acm.org/citation.cfm?id=1806634)
* Питер Бейлис, Шиварам Венкатараман, Майкл Дж. Франклин, Джозеф М. Хеллерштейн, Ион Стойка (Peter Bailis, Shivaram Venkataraman, Michael J. Franklin, Joseph M. Hellerstein, Ion Stoica). "Probabilistically bounded staleness for practical partial quorums" (Вероятностное ограниченное устаревание для практических неполных кворумов). Тезисы конференции VLDB Endowment, том 5, выпуск 8, стр. 776-787, апрель 2012 г. [http://dl.acm.org/citation.cfm?id=2212359](http://dl.acm.org/citation.cfm?id=2212359)

---
title: "Региональная отработка отказа в Azure Cosmos DB | Документы Майкрософт"
description: "Сведения о принципах ручной и автоматической отработки отказа в Azure Cosmos DB."
services: cosmos-db
documentationcenter: 
author: arramac
manager: jhubbard
editor: 
ms.assetid: 446e2580-ff49-4485-8e53-ae34e08d997f
ms.service: cosmos-db
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 05/24/2017
ms.author: arramac
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 3d8ba08bc9f99cb77c9f03949fc5db299eb222c8
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="automatic-regional-failover-for-business-continuity-in-azure-cosmos-db"></a>Автоматическая отработка отказа между регионами для обеспечения непрерывности бизнес-процессов в Azure Cosmos DB
Azure Cosmos DB упрощает глобальное распространение данных, предлагая полностью управляемые учетные [записи базы данных в нескольких регионах](distribute-data-globally.md), которые обеспечивают четкие компромиссы между согласованностью, доступностью и производительностью с соответствующими гарантиями. Учетные записи Cosmos DB обеспечивают высокий уровень доступности, задержки в единицы миллисекунд, [четко определенные уровни согласованности](consistency-levels.md), прозрачную региональную отработку отказа с API многосетевого подключения, а также возможность эластично масштабировать пропускную способность и хранилище по всему миру. 

Cosmos DB поддерживает явную отработку отказа и отработку отказа на основе политик, что позволяет управлять поведением комплексной системы в случае сбоев. В этой статье мы рассмотрим следующие вопросы:

* как работает ручная отработка отказа в Cosmos DB;
* как работает автоматическая отработка отказа в Cosmos DB и что происходит, когда в центре обработки данных возникает неполадка;
* как использовать ручную отработку отказа в архитектурах приложений.

Узнайте больше об отработке отказа между регионами в этом видео из цикла "Пятница с Azure" от Скотта Хенсельмана (Scott Hanselman) и главного технического руководителя Картика Рамана (Karthik Raman).

>[!VIDEO https://channel9.msdn.com/Shows/Azure-Friday/Planet-Scale-NoSQL-with-DocumentDB/player]  

## <a id="ConfigureMultiRegionApplications"></a>Настройка приложений в нескольких регионах
Прежде чем углубляться в режимы отработки отказа, рассмотрим, как настроить приложение, чтобы воспользоваться преимуществами доступности нескольких регионов и меньше зависеть от отработок отказа между регионами.

* Сначала разверните приложение в нескольких регионах.
* Чтобы обеспечить высокоскоростной доступ из каждого региона, где развернуто приложение, настройте соответствующий [список предпочтительных регионов](https://msdn.microsoft.com/library/microsoft.azure.documents.client.connectionpolicy.preferredlocations.aspx#P:Microsoft.Azure.Documents.Client.ConnectionPolicy.PreferredLocations) для каждого региона с помощью одного из поддерживаемых пакетов SDK.

В следующем фрагменте показано, как инициализировать приложение, работающее в нескольких регионах. В используемой учетной записи Azure Cosmos DB `contoso.documents.azure.com` настроены два региона: западная часть США и Северная Европа. 

* Приложение развертывается в западной части США (например, с помощью службы приложений Azure). 
* `West US` настроен как первый предпочтительный регион для операций чтения с низкой задержкой.
* `North Europe` настроен как второй предпочтительный регион (для обеспечения высокой доступности во время региональных сбоев).

В API DocumentDB эта конфигурация выглядит так:

```cs
ConnectionPolicy usConnectionPolicy = new ConnectionPolicy 
{ 
    ConnectionMode = ConnectionMode.Direct,
    ConnectionProtocol = Protocol.Tcp
};

usConnectionPolicy.PreferredLocations.Add(LocationNames.WestUS);
usConnectionPolicy.PreferredLocations.Add(LocationNames.NorthEurope);

DocumentClient usClient = new DocumentClient(
    new Uri("https://contosodb.documents.azure.com"),
    "memf7qfF89n6KL9vcb7rIQl6tfgZsRt5gY5dh3BIjesarJanYIcg2Edn9uPOUIVwgkAugOb2zUdCR2h0PTtMrA==",
    usConnectionPolicy);
```

Приложение также развертывается в Северной Европе с обратным порядком предпочтительных регионов. То есть Северная Европа указывается первой для операций чтения с низкой задержкой. Затем западная часть США указывается как второй предпочтительный регион для обеспечения высокой доступности во время региональных сбоев.

На следующей схеме архитектуры показано развертывание приложения в нескольких регионах, где Cosmos DB и приложение настроены таким образом, чтобы быть доступными в четырех географических регионах Azure.  

![Глобально распределенное развертывание приложений с помощью Azure Cosmos DB](./media/regional-failover/app-deployment.png)

Теперь давайте рассмотрим, как служба Cosmos DB обрабатывает региональные сбои путем автоматической отработки отказа. 

## <a id="AutomaticFailovers"></a>Автоматический переход на другой ресурс
В редких случаях регионального сбоя или сбоя в центре обработки данных Azure Cosmos DB автоматически инициирует отработку отказа для всех учетных записей Cosmos DB, находящихся в пострадавшем регионе. 

**Что произойдет, если произойдет сбой региона чтения?**

Учетные записи Cosmos DB с регионом чтения, находящимся в одном из пострадавших регионов, автоматически отключаются от своего региона записи и помечаются как отключенные. Пакеты SDK для Cosmos DB реализуют региональный протокол обнаружения, позволяющий автоматически определять, когда регион доступен, и перенаправлять вызовы чтения к следующему доступному региону в списке предпочтительных регионов. Если ни один из регионов в списке предпочтительных регионов недоступен, вызовы автоматически будут перенаправлены к текущему региону записи. Для обработки отказа между регионами изменения в коде приложения не требуются. Гарантии согласованности продолжают учитываться в Cosmos DB в течение всего процесса.

![Сбои региона чтения в Azure Cosmos DB](./media/regional-failover/read-region-failures.png)

После восстановления пострадавшего региона служба автоматически восстанавливает все пострадавшие учетные записи Cosmos DB в регионе. Учетные записи Cosmos DB, имеющие регион чтения в пострадавшем регионе, автоматически синхронизируются с текущим регионом записи и возвращаются в оперативный режим. Пакеты SDK для Cosmos DB обнаруживают доступность нового региона и оценивают, будет ли выбран регион в качестве текущего региона чтения на основе списка предпочтительных регионов, настроенного с помощью приложения. Последующие операции чтения перенаправляются в восстановленный регион без каких-либо изменений в коде приложения.

**Что произойдет в случае сбоя региона записи?**

Если пострадавший регион является текущим регионом записи для указанной учетной записи Cosmos DB, он автоматически помечается как отключенный. Затем альтернативный регион повышается до региона записи каждой учетной записи Cosmos DB. Вы можете полностью контролировать порядок выбора регионов для учетных записей Cosmos DB на портале Azure или [программным способом](https://docs.microsoft.com/rest/api/documentdbresourceprovider/databaseaccounts#DatabaseAccounts_FailoverPriorityChange). 

![Приоритеты при отработке отказа для Azure Cosmos DB](./media/regional-failover/failover-priorities.png)

Во время автоматической отработки отказа Cosmos DB автоматически выбирает следующий регион записи для указанной учетной записи Cosmos DB на основе указанного порядка приоритета. 

![Сбои региона записи в Azure Cosmos DB](./media/regional-failover/write-region-failures.png)

После восстановления пострадавшего региона служба автоматически восстанавливает все пострадавшие учетные записи Cosmos DB в регионе. 

* Учетные записи Cosmos DB вместе с предыдущим регионом записи, который находился в пострадавшем регионе, даже после восстановления региона остаются в автономном режиме с доступностью для чтения. 
* Можно запросить этот регион для вычисления нереплицированных записей во время сбоя путем сравнения с данными, доступными в текущем регионе записи. В зависимости от потребностей приложения можно выполнить слияние и (или) разрешение конфликтов и записать последний набор изменений обратно в текущий регион записи. 
* После завершения слияния изменений пострадавший регион можно вернуть обратно в оперативный режим, удалив и повторно добавив регион в учетную запись Cosmos DB. После того как регион будет добавлен обратно, можно снова настроить его в качестве региона записи путем выполнения ручного перехода на другой ресурс на портале Azure или [программно](https://docs.microsoft.com/rest/api/documentdbresourceprovider/databaseaccounts#DatabaseAccounts_CreateOrUpdate).

## <a id="ManualFailovers"></a>Ручной переход на другой ресурс

Помимо автоматической отработки отказа текущий регион записи данной учетной записи Cosmos DB можно динамически изменять вручную на один из имеющихся регионов чтения. Ручной переход на другой ресурс можно запустить на портале Azure или [программно](https://docs.microsoft.com/rest/api/documentdbresourceprovider/databaseaccounts#DatabaseAccounts_CreateOrUpdate). 

Ручная отработка отказа обеспечивает **нулевую потерю данных** и **нулевую потерю доступности**, корректно передавая состояние записи из старого региона записи в новый для указанной учетной записи Cosmos DB. Аналогично автоматической отработке отказа во время выполнения этого процесса вручную пакет SDK для Cosmos DB автоматически обрабатывает изменения региона записи и гарантирует, что вызовы автоматически перенаправляются в новый регион записи. Для управления переходом на другой ресурс изменения кода или конфигурации приложения не требуются. 

![Ручная отработка отказа в Azure Cosmos DB](./media/regional-failover/manual-failovers.png)

Ниже приведены некоторые из распространенных сценариев, где может быть полезен ручной переход на другой ресурс.

**Часовая модель.** Если приложения имеют прогнозируемые шаблоны трафика в разное время суток, можно периодически изменять состояние записи для самого активного географического региона в зависимости от времени суток.

**Служебное обновление.** Определенное глобально распределенное развертывание приложения может включать в себя перенаправление трафика в другой регион через диспетчер трафика во время планового служебного обновления. Для такого развертывания приложений теперь может использоваться ручной переход на другой ресурс, чтобы сохранить состояние записи для региона, где будет активный трафик во время периода служебного обновления.

**Отработки непрерывности бизнес-процессов и аварийного восстановления (BCDR) и высокого уровня доступности и аварийного восстановления (HADR).** Во время разработки и выпуска большинства корпоративных приложений выполняются тесты непрерывности бизнес-процессов. Тестирование BCDR и HADR часто является важным шагом для сертификации соответствия и обеспечения доступности службы в случае региональных сбоев. Чтобы проверить готовность BCDR приложений, использующих Cosmos DB для хранения, можно запустить ручную отработку отказа для своей учетной записи Cosmos DB и (или) динамически добавить и удалить регион.

В этой статье мы рассмотрели, как работает ручная и автоматическая отработка отказа в Cosmos DB и как можно сделать учетные записи Cosmos DB и приложения глобально доступными. С помощью поддержки глобальной репликации Cosmos DB можно сократить совокупную задержку и обеспечить высокую доступность даже в случае сбоев региона. 

## <a id="NextSteps"></a>Дальнейшие действия
* Дополнительные сведения о поддержке глобального распространения в Cosmos DB см. [здесь](distribute-data-globally.md).
* Дополнительные сведения о глобальной согласованности в Cosmos DB см. в [этой статье](consistency-levels.md).
* Сведения о разработке с использованием нескольких регионов см. в статье [Как настроить глобальное распределение Azure Cosmos DB с помощью API DocumentDB](../cosmos-db/tutorial-global-distribution-documentdb.md).
* Сведения о разработке [архитектуры записи в нескольких регионах](multi-region-writers.md) с помощью Azure DocumentDB


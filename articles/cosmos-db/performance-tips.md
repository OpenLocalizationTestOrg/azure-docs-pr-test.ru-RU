---
title: "Советы по aaaPerformance - Azure Cosmos DB NoSQL | Документы Microsoft"
description: "Узнать базу данных Azure Cosmos клиента конфигурации параметры tooimprove производительность базы данных"
keywords: "как tooimprove производительности базы данных"
services: cosmos-db
author: mimig1
manager: jhubbard
editor: 
documentationcenter: 
ms.assetid: 94ff155e-f9bc-488f-8c7a-5e7037091bb9
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/23/2017
ms.author: mimig
ms.openlocfilehash: 4f3e82ae5048e3dbc20b0fd891a2d3aa22adf3fc
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="performance-tips-for-azure-cosmos-db"></a>Советы по повышению производительности для Azure Cosmos DB
Azure Cosmos DB — быстрая и гибкая распределенная база данных, которая легко масштабируется с гарантированной задержкой и пропускной способностью. Не toomake архитектура основных изменений и не писать сложный код tooscale базы данных с помощью Cosmos DB. Для увеличения или уменьшения масштаба достаточно вызвать один метод интерфейса API или [пакета SDK](set-throughput.md#set-throughput-sdk). Однако Cosmos DB осуществляется через сетевые вызовы имеют оптимизации клиентские, можно сделать tooachieve максимальной производительности.

Чтобы оптимизировать производительность базы данных, Рассмотрим следующие варианты hello.

## <a name="networking"></a>Сеть
<a id="direct-connection"></a>

1. **Политика подключения: использование режима прямого подключения**

    Как клиент связывается tooCosmos DB имеет важные последствия на производительность, особенно в части наблюдаемых клиентские задержки. Существует два параметра конфигурации ключа, доступных для настройки клиента политики подключения — подключение hello *режим* и hello [подключения *протокола*](#connection-protocol).  доступны два режима доступны Hello.

   1. режим шлюза (по умолчанию);
   2. режим прямого подключения.

      Режим шлюз поддерживается на всех платформах SDK, hello настроен по умолчанию.  Если приложение работает в корпоративной сети с ограничениями strict брандмауэра, режим шлюза является наилучшим вариантом hello, поскольку он использует стандартный порт HTTPS hello и одну конечную точку. Здравствуйте выигрышем в производительности, то, что шлюз режим включает в себя дополнительный сетевой прыжок каждый раз при чтении или записи tooCosmos DB данных. По этой причине прямой режим обеспечивает лучшую производительность из-за toofewer сетевых переходов.
<a id="use-tcp"></a>
2. **Политика подключение: используется протокол TCP hello**

    Если вы используете режим прямого подключения, вам доступны два варианта протоколов:

   * TCP
   * HTTPS

     Cosmos DB предлагает простую и открытую модель программирования RESTful поверх HTTPS. Кроме того он предоставляет эффективный протокол TCP, который также категории RESTful в модели связи и доступен через пакет SDK для клиента .NET hello. Как Direct TCP, так и HTTPS используют SSL для первоначальной аутентификации и шифрования трафика. Для достижения оптимальной производительности используйте протокол TCP hello, когда это возможно.

     При использовании протокола TCP в режиме шлюза, порт TCP-порт 443 — hello порту Cosmos DB и 10255 — порт MongoDB API hello. При использовании протокола TCP в режиме прямого, добавление toohello шлюза порты, вам требуется порт hello tooensure диапазоне от 10000 до 20000 открыт, так как Cosmos DB использует динамические порты TCP. Если эти порты не открыты, и попытке toouse TCP, возникнет ошибка 503 Служба недоступна.

     Режим подключения Hello настраивается во время построения hello hello DocumentClient экземпляра с параметром ConnectionPolicy hello. При использовании режима прямого hello протокола можно также задать в параметр ConnectionPolicy hello.

    ```C#
    var serviceEndpoint = new Uri("https://contoso.documents.net");
    var authKey = new "your authKey from hello Azure portal";
    DocumentClient client = new DocumentClient(serviceEndpoint, authKey,
    new ConnectionPolicy
    {
        ConnectionMode = ConnectionMode.Direct,
        ConnectionProtocol = Protocol.Tcp
    });
    ```

    Так как TCP поддерживается только в режиме прямого, если используется режим шлюза, затем hello всегда равно протокола HTTPS используется toocommunicate с hello шлюза и hello значение протокола в hello ConnectionPolicy игнорируется.

    ![Иллюстрация hello политика подключения базы данных Azure Cosmos](./media/performance-tips/connection-policy.png)

3. **Вызовите OpenAsync tooavoid запуска задержка при первом запросе**

    По умолчанию hello первый запрос имеет Высокая задержка, так как она содержит таблицы маршрутизации адресов toofetch hello. Эта задержка запуска на hello tooavoid сначала запросить, OpenAsync() следующим следует вызывать один раз во время инициализации.

        await client.OpenAsync();
   <a id="same-region"></a>
4. **Оптимизация производительности за счет размещения клиентов в одном регионе Azure**

    Если возможно, все приложения, вызывающие Cosmos DB hello же регионе, что место hello Cosmos DB базы данных. Для сравнения, приблизительно, вызывает tooCosmos базы данных в пределах одного региона завершается в течение 1 2 мс, но hello задержка между Запад hello и восточном побережье из США — hello hello > 50 мс. Эта задержка скорее всего может изменяться от toorequest запроса в зависимости от маршрута hello запросом hello, передаваемых из hello клиента toohello центра обработки данных Azure границ. Hello минимально возможные задержки достигается за счет того, вызов hello приложения находится в пределах hello же регионе Azure, что hello подготовить Cosmos DB конечной точки. Список доступных регионов см. на странице [Регионы Azure](https://azure.microsoft.com/regions/#services).

    ![Иллюстрация hello политика подключения базы данных Azure Cosmos](./media/performance-tips/same-region.png)
   <a id="increase-threads"></a>
5. **Увеличение количества потоков или задач**

    Поскольку вызовы tooAzure Cosmos DB выполняются через сеть hello, может потребоваться toovary hello степень параллелизма запросов, чтобы клиентское приложение hello тратит немного времени ожидания между запросами. Например, если вы используете. NET [библиотека параллельных задач](https://msdn.microsoft.com//library/dd460717.aspx), создайте в порядке hello сотнях задач чтения или записи tooCosmos DB.

## <a name="sdk-usage"></a>Использование пакета SDK
1. **Установка hello последнего пакета SDK**

    Hello Cosmos DB SDK постоянно вносятся улучшенные tooprovide hello наилучшей производительности. В разделе hello [Cosmos DB SDK](documentdb-sdk-dotnet.md) toodetermine страниц hello последнего пакета SDK и просмотрите усовершенствования.
2. **Использовать одноэлементный Cosmos DB клиент для hello жизненный цикл приложения**

    Обратите внимание, что каждый экземпляр DocumentClient является потокобезопасным, а при использовании режима прямого подключения предоставляется возможность управления подключениями и кэширования адресов. tooallow эффективности соединения управления и повышения производительности путем DocumentClient, рекомендуется использовать toouse один экземпляр DocumentClient каждого домена приложения hello жизненного цикла приложения hello.

   <a id="max-connection"></a>
3. **Увеличение максимального количества подключений System.Net для каждого узла при использовании режима шлюза**

    Cosmos DB запросы выполняются через HTTPS REST при использовании режима шлюза и являются подвергается toohello ограничение соединения по умолчанию имя узла или IP-адрес. Tooset hello MaxConnections tooa высокое значение (100-1000) может потребоваться, чтобы hello клиентской библиотеки можно использовать несколько одновременных подключений tooCosmos DB. В .NET SDK 1.8.0 hello и выше, Здравствуйте, значение по умолчанию для [ServicePointManager.DefaultConnectionLimit](https://msdn.microsoft.com/library/system.net.servicepointmanager.defaultconnectionlimit.aspx) — 50 и toochange Здравствуйте значение, можно задать hello [Documents.Client.ConnectionPolicy.MaxConnectionLimit ](https://msdn.microsoft.com/library/azure/microsoft.azure.documents.client.connectionpolicy.maxconnectionlimit.aspx) tooa высокое значение.   
4. **Настройка параллельных запросов для секционированных коллекций**

     DocumentDB .NET SDK версии 1.9.0 и более поздних версиях поддержка параллельных запросов, позволяющих tooquery секционированную коллекцию параллельно (см. [работа с пакетами SDK hello](documentdb-partition-data.md#working-with-the-azure-cosmos-db-sdks) и связанные с hello [примеры кода](https://github.com/Azure/azure-documentdb-dotnet/blob/master/samples/code-samples/Queries/Program.cs) для Дополнительные сведения о). Параллельные запросы спроектированный tooimprove запроса задержка и пропускная способность превышают их последовательного аналога. Параллельные запросы предоставляют два параметра, пользователи могут настраивать toocustom размеру их требования, (a) MaxDegreeOfParallelism: toocontrol hello максимального количества секций, затем можно запросить в параллельном режиме и (б) MaxBufferedItemCount: toocontrol hello число предварительно выбранных результатов.

    (a) ***Настройка MaxDegreeOfParallelism\:***. При параллельном запросе одновременно запрашиваются несколько секций. Тем не менее данные из отдельных секционированных сбор выборка выполняется последовательно с учетом toohello запроса. Таким образом при задании hello MaxDegreeOfParallelism toohello номера секций должна hello Максимальная вероятность достижения Здравствуйте большинство высокопроизводительных запросов, предоставляемых условиями системы остаются hello таким же. Если вы не знаете hello число секций, можно задать большое число hello MaxDegreeOfParallelism tooa и hello система выбирает минимум hello (число секций, предоставленный пользователем), которые hello MaxDegreeOfParallelism.

    Это важные toonote, который параллельные преимущества наиболее hello создают запросы, если данные hello распределяется равномерно между все секции с учетом toohello запроса. Если hello секционированные коллекции секционируется так, что все или большинство hello данных, возвращаемых запросом является концентрируются в нескольких секциях (один раздел в худшем случае), а затем hello производительность запроса hello бы быть замедляется из-за этих секций.

    (б) ***СУБД MaxBufferedItemCount\: *** параллельного запроса является результаты спроектированный toopre-fetch во время обработки текущего пакета hello результатов клиентом hello. Здравствуйте, предварительное помогает в общую задержку улучшения запроса. MaxBufferedItemCount: hello параметр toolimit hello число предварительно выбранных результатов. Установка MaxBufferedItemCount toohello ожидается число возвращаемых результатов (или более высокий номер) позволяет hello запроса tooreceive максимальные преимущества от предварительной загрузки.

    Обратите внимание, что предварительно извлечение works hello таким же, каким образом независимо от hello MaxDegreeOfParallelism имеется один буфер для hello данных от всех разделов.  
5. **Включение сбора мусора на сервере**

    Уменьшение частоты сбора мусора hello может помочь в некоторых случаях. В .NET, задайте [gcServer](https://msdn.microsoft.com/library/ms229357.aspx) tootrue.
6. **Реализация интервала задержки для RetryAfter**

    Во время проверки производительности следует увеличивать нагрузку до тех пор, пока регулирование не будет выполняться при небольшой частоте запросов. Если регулирование, hello клиентское приложение должно задержки при регулировании для hello сервер указан интервал повтора. Этом соблюдаются отсрочки hello гарантирует затрачиваемое минимальный объем времени ожидания между повторными попытками. Поддержка политики повтора включено в версии 1.8.0 и выше для hello DocumentDB [.NET](documentdb-sdk-dotnet.md) и [Java](documentdb-sdk-java.md), версии 1.9.0 и выше для hello [Node.js](documentdb-sdk-node.md) и [ Python](documentdb-sdk-python.md), и для всех поддерживаемых версий hello [.NET Core](documentdb-sdk-dotnet-core.md) пакеты SDK. Дополнительные сведения см. в разделах [Превышение лимита зарезервированной пропускной способности](request-units.md#RequestRateTooLarge) и [RetryAfter](https://msdn.microsoft.com/library/microsoft.azure.documents.documentclientexception.retryafter.aspx).
7. **Развертывание рабочей нагрузки клиента**

    При тестировании на уровнях высокой пропускной способности (> 50 000 единиц Запросов в секунду), клиентское приложение hello могут стать узким местом hello из-за toohello машины ограниченного исходящий от загрузки ЦП или сети. При достижении этой точки можно продолжить toopush hello Cosmos DB учетной записи дальнейшей, горизонтальное масштабирование клиентские приложения по нескольким серверам.
8. **Кэширование URI документов для снижения задержки чтения**

    Кэшировать идентификаторы URI, по возможности для повышения производительности чтения hello документа.
   <a id="tune-page-size"></a>
9. **Настроить размер страницы приветствия для чтения запросы веб-каналов для повышения производительности**

    При выполнении массового чтения документов с помощью веб-канала (например, ReadDocumentFeedAsync) функциональные возможности чтения или при выдаче запроса DocumentDB SQL, hello результаты возвращаются в сегментированном режиме, при слишком большом hello результирующий набор. По умолчанию результаты возвращаются в пакетах (не более 100 элементов и не более 1 МБ в каждом пакете).

    tooreduce hello число сетевых циклов приема-передачи требуется tooretrieve все применимые результаты, можно увеличить размер страницы приветствия, с помощью too1000 tooup заголовок запроса x-ms-max-item-count. В случаях, когда необходимо toodisplay несколько результатов например, если пользовательского интерфейса или приложение API возвращает только 10 приводит время, также может сократиться hello страницы размер too10 tooreduce hello пропускной способности, использованных для операций чтения и запросы.

    Можно также задать размер страницы приветствия с помощью доступных пакетов SDK DB Cosmos "hello".  Например:

        IQueryable<dynamic> authorResults = client.CreateDocumentQuery(documentCollection.SelfLink, "SELECT p.Author FROM Pages p WHERE p.Title = 'About Seattle'", new FeedOptions { MaxItemCount = 1000 });
10. **Увеличение количества потоков или задач**

    В разделе [увеличить число потоков или задач](#increase-threads) в hello раздел «сеть».

11. **Использование 64-разрядных хост-процессов**

    Hello DocumentDB SDK работает в 32-разрядный процесс, при использовании DocumentDB .NET SDK версии 1.11.4 и выше. Но если вы используете запросы между секциями, то для повышения производительности мы рекомендуем использовать 64-разрядные хост-процессы. следующие типы приложений Hello иметь 32-разрядного сервера обработки по умолчанию hello, поэтому в порядке toochange, too64-разрядной, выполните следующие действия, на основе типа приложения hello:

    - Для исполняемых приложений, это можно сделать, сняв флажок hello **предпочитать 32-разрядных** параметр в hello **свойства проекта** в hello окна **построения** вкладки.

    - VSTest создана на основе тестовых проектов, это можно сделать, выбрав **тестирования**->**параметров тестирования**->**по умолчанию архитектуру процессора, как X64**, из hello **Visual Studio Test** пункт меню.

    - Для локально развернутых веб-приложений ASP.NET, это можно сделать, проверив hello **используйте hello 64-разрядной версии служб IIS Express для веб-сайтов и проектов**в разделе **средства** ->  **Параметры**->**проекты и решения**->**веб-проектов**.

    - Для веб-приложений ASP.NET развернутое в Azure, это можно сделать, выбрав hello **платформа как 64-разрядных** в hello **параметры приложения** на hello портал Azure.

## <a name="indexing-policy"></a>Политика индексации
1. **Использование отложенного индексирования для увеличения скорости приема документов во время пиковой нагрузки**

    Cosmos DB позволяет toospecify — на уровне коллекции hello — политика индексирования, благодаря чему можно toochoose, если нужно hello документы в коллекции toobe, автоматически индексируется или нет.  Кроме того, можно выбрать синхронное (согласованное) или асинхронное (отложенное) обновления индекса. По умолчанию hello индекс обновляется синхронно для каждой вставки, замены или удаления коллекции toohello документа. Синхронно toohonor запросы hello включает режим hello же [уровень согласованности](consistency-levels.md) , что и hello считывает документа без задержки для hello индекса слишком «Догнать».

    Отложенного индексирования может рассматриваться как для сценариев, в которых данные записываются в пакетами и требуется tooamortize hello работ tooindex содержимого через более длительный период времени. Отложенного индексирования можно также toouse вашей эффективно подготовить пропускной способности serve запросов и записи в часы пик с минимальной задержкой. Это важные toonote, однако, при включении отложенного индексирования результаты запроса, согласованным независимо от уровня достоверности hello, настроенных для учетной записи Cosmos DB hello.

    Таким образом, согласованный режим индексирования (IndexingPolicy.IndexingMode установлен tooConsistent) влечет за собой наибольшее издержки единицы запрос hello каждой операции записи во время индексирования (IndexingPolicy.IndexingMode установлен tooLazy) режиме и не индексирования Lazy (IndexingPolicy.Automatic установлен tooFalse) во время записи hello ноль индексирования стоимостью.
2. **Увеличение скорости выполнения операций записи посредством исключения неиспользуемых путей из индексирования**

    Политика индексирования Cosmos DB также позволяет toospecify документов tooinclude пути или исключить из индексирования за счет использования путей индексирования (IndexingPolicy.IncludedPaths и IndexingPolicy.ExcludedPaths). Используйте Hello путей индексирования можно повысить производительность записи и уменьшить хранилище индексирования для сценариев, в какой hello шаблоны запросов известны заранее, как индексирования затраты являются напрямую друг с другом toohello число уникальных пути, проиндексированные, предлагающие.  Hello после кода показано, как tooexclude целый раздел hello документы (так) поддерево) из индексирования с помощью hello «*» подстановочный знак.

    ```C#
    var collection = new DocumentCollection { Id = "excludedPathCollection" };
    collection.IndexingPolicy.IncludedPaths.Add(new IncludedPath { Path = "/*" });
    collection.IndexingPolicy.ExcludedPaths.Add(new ExcludedPath { Path = "/nonIndexedContent/*");
    collection = await client.CreateDocumentCollectionAsync(UriFactory.CreateDatabaseUri("db"), excluded);
    ```

    Дополнительные сведения см. в статье [Политики индексации DocumentDB](indexing-policies.md).

## <a name="throughput"></a>Пропускная способность
<a id="measure-rus"></a>

1. **Измерение и настройка расхода единиц запроса/повторного использования**

    Cosmos DB предлагает широкий набор операций базы данных, включая реляционные и иерархические запросы с определяемые пользователем функции, хранимые процедуры и триггеры — все работы в документах hello в пределах базы данных коллекции. Hello затрат, связанных с каждым из этих операций различается в зависимости от hello ЦП, ввода-ВЫВОДА и памяти, необходимый toocomplete hello операции. Вместо обдумывания и управление ресурсами оборудования можно считать запрос единицы (RU) одного измерения для tooperform необходимые ресурсы hello различные операции с базой данных и службы по запросу приложения.

    [Единиц запросов](request-units.md) подготавливаются для каждой учетной записи базы данных на основе количества единиц емкости, приобретаемых в hello. Удельный расход единиц запросов оценивается в расчете на одну секунду. Приложения, которые превышают единицы подготовленного запроса hello интенсивность для их учетных записей ограничено до частота hello падает ниже hello уровень зарезервированных для учетной записи hello. Если ваше приложение требует более высокого уровня пропускной способности, вы можете приобрести дополнительные единицы емкости.

    Hello сложность запроса влияет на количество единиц запроса используются для операции. Hello количество предикатов, характер hello предикаты, количество определяемых пользователем функций и hello размер набора данных источника hello, все влияют на стоимость hello операций запросов.

    издержки hello toomeasure любой операции (Создание, обновление или удаление), проверьте заголовок x-ms запрос платы hello (или hello эквивалентное свойство RequestCharge в ResourceResponse<T> или FeedResponse<T> в hello .NET SDK) toomeasure Hello количество единиц запроса, используемые в этих операций.

    ```C#
    // Measure hello performance (request units) of writes
    ResourceResponse<Document> response = await client.CreateDocumentAsync(collectionSelfLink, myDocument);
    Console.WriteLine("Insert of document consumed {0} request units", response.RequestCharge);
    // Measure hello performance (request units) of queries
    IDocumentQuery<dynamic> queryable = client.CreateDocumentQuery(collectionSelfLink, queryString).AsDocumentQuery();
    while (queryable.HasMoreResults)
         {
              FeedResponse<dynamic> queryResponse = await queryable.ExecuteNextAsync<dynamic>();
              Console.WriteLine("Query batch consumed {0} request units", queryResponse.RequestCharge);
         }
    ```             

    Hello запроса возвращается в этом заголовке взимается часть вашей пропускная способность (т. е. RUs 2000 / сек). Например если hello предыдущий запрос возвращает 1 КБ 1000-документы, стоимость hello hello операции — 1000. Таким образом в течение одной секунды, hello сервер принимает только два таких запросов до регулирования последующих запросов. Дополнительные сведения см. в разделе [единиц запросов](request-units.md) и hello [калькулятора единица запроса](https://www.documentdb.com/capacityplanner).
<a id="429"></a>
2. **Обработка ограничения скорости/ слишком высокая частота запросов**

    Когда клиент пытается tooexceed hello зарезервированную полосу пропускания для учетной записи, нет без снижения производительности на сервере hello и без использования пропускной способности за пределы уровня hello зарезервировано. Hello server предварительно завершается запрос hello с RequestRateTooLarge (код состояния HTTP 429) и возврата hello заголовок x-ms повтора после ms, указывающий, что время ожидания перед повторным выполнением запроса hello hello количество времени, в миллисекундах, которое hello пользователя.

        HTTP Status 429,
        Status Line: RequestRateTooLarge
        x-ms-retry-after-ms :100

    пакеты SDK Hello все неявно перехватывать этот ответ, учитывают hello сервер указан заголовок retry-after и повторить запрос hello. Если ваша учетная запись осуществляется параллельно несколькими клиентами, будет успешным hello следующей попытки.

    Если у вас есть несколько клиентов Суммарно постоянно превысила частота запросов hello, hello число повторов в настоящее время набор too9 внутренним образом hello клиента может оказаться недостаточно; в таком случае клиент hello создает DocumentClientException с приложением toohello 429 код состояния. можно изменить число повторных попыток по умолчанию Hello с hello параметр RetryOptions на экземпляре ConnectionPolicy hello. По умолчанию hello DocumentClientException с кодом состояния 429 возвращается после совокупное время ожидания 30 секунд, если запрос hello продолжается toooperate выше частота запросов hello. Это происходит, даже если текущее число попыток hello не меньше числа повторных попыток max hello, будь то по умолчанию hello 9 или пользовательские значения.

    Во время автоматической hello характер повторения tooimprove устойчивости и удобство использования для hello большинство приложений, которые могут быть в odds при выполнении тестов производительности, особенно если измерение задержки.  Hello клиента наблюдается задержка будет скачки, если эксперимента hello достигает сервера регулирования hello и вызывает клиент hello повтора toosilently SDK. Задержка tooavoid резко возрастает во время экспериментов с производительностью, издержки hello мер возвращаются при выполнении каждой операции и убедитесь, что запросы работают под зарезервированные частота hello. Дополнительные сведения см. в статье [Единицы запросов в DocumentDB](request-units.md).
3. **Использование меньших документов для более высокой пропускной способности**

    Hello запроса (т. е. стоимость обработки запросов) для данной операции взимается непосредственно связанной toohello размер документа hello. За операции с большими документами взимается больше единиц запроса, чем за операции с мелкими документами.

## <a name="next-steps"></a>Дальнейшие действия
Образец приложения, используемого tooevaluate Cosmos DB для сценариев высокой производительности на нескольких клиентских компьютерах, см. [производительность и масштабируемость, тестирование с помощью Cosmos DB](performance-testing.md).

Toolearn Дополнительные сведения о разработке приложений для обеспечения масштабирования и высокой производительности см. также [секционирование и масштабирование в базе данных Azure Cosmos](partition-data.md).

---
title: "Советы по повышению производительности. NoSQL в Azure Cosmos DB | Документация Майкрософт"
description: "Узнайте, как улучшить производительность базы данных Azure Cosmos DB с помощью параметров конфигурации клиента"
keywords: "как улучшить производительность базы данных"
services: cosmos-db
author: mimig1
manager: jhubbard
editor: 
documentationcenter: 
ms.assetid: 94ff155e-f9bc-488f-8c7a-5e7037091bb9
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/23/2017
ms.author: mimig
ms.openlocfilehash: a94cda90eca9dca2b93adb8f5091d829e7375aa5
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="performance-tips-for-azure-cosmos-db"></a><span data-ttu-id="4169a-104">Советы по повышению производительности для Azure Cosmos DB</span><span class="sxs-lookup"><span data-stu-id="4169a-104">Performance tips for Azure Cosmos DB</span></span>
<span data-ttu-id="4169a-105">Azure Cosmos DB — быстрая и гибкая распределенная база данных, которая легко масштабируется с гарантированной задержкой и пропускной способностью.</span><span class="sxs-lookup"><span data-stu-id="4169a-105">Azure Cosmos DB is a fast and flexible distributed database that scales seamlessly with guaranteed latency and throughput.</span></span> <span data-ttu-id="4169a-106">Для масштабирования базы данных с помощью Cosmos DB не нужно вносить существенных изменений в архитектуру или писать сложный код.</span><span class="sxs-lookup"><span data-stu-id="4169a-106">You do not have to make major architecture changes or write complex code to scale your database with Cosmos DB.</span></span> <span data-ttu-id="4169a-107">Для увеличения или уменьшения масштаба достаточно вызвать один метод интерфейса API или [пакета SDK](set-throughput.md#set-throughput-sdk).</span><span class="sxs-lookup"><span data-stu-id="4169a-107">Scaling up and down is as easy as making a single API call or [SDK method call](set-throughput.md#set-throughput-sdk).</span></span> <span data-ttu-id="4169a-108">Но так как для доступа к Cosmos DB выполняются сетевые вызовы, чтобы обеспечить максимальную производительность, можно выполнить некоторые оптимизации на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="4169a-108">However, because Cosmos DB is accessed via network calls there are client-side optimizations you can make to achieve peak performance.</span></span>

<span data-ttu-id="4169a-109">Чтобы оптимизировать производительность базы данных,</span><span class="sxs-lookup"><span data-stu-id="4169a-109">So if you're asking "How can I improve my database performance?"</span></span> <span data-ttu-id="4169a-110">рассмотрите следующие варианты.</span><span class="sxs-lookup"><span data-stu-id="4169a-110">consider the following options:</span></span>

## <a name="networking"></a><span data-ttu-id="4169a-111">Сеть</span><span class="sxs-lookup"><span data-stu-id="4169a-111">Networking</span></span>
<a id="direct-connection"></a>

1. <span data-ttu-id="4169a-112">**Политика подключения: использование режима прямого подключения**</span><span class="sxs-lookup"><span data-stu-id="4169a-112">**Connection policy: Use direct connection mode**</span></span>

    <span data-ttu-id="4169a-113">Режим подключения к Azure Cosmos DB оказывает серьезное влияние на производительность, в частности на задержку на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="4169a-113">How a client connects to Cosmos DB has important implications on performance, especially in terms of observed client-side latency.</span></span> <span data-ttu-id="4169a-114">Для настройки политики подключения для клиента используются два основных параметра конфигурации — *режим* и *протокол* [подключения](#connection-protocol).</span><span class="sxs-lookup"><span data-stu-id="4169a-114">There are two key configuration settings available for configuring client Connection Policy – the connection *mode* and the [connection *protocol*](#connection-protocol).</span></span>  <span data-ttu-id="4169a-115">DocumentDB предоставляет два режима подключения:</span><span class="sxs-lookup"><span data-stu-id="4169a-115">The two available modes are:</span></span>

   1. <span data-ttu-id="4169a-116">режим шлюза (по умолчанию);</span><span class="sxs-lookup"><span data-stu-id="4169a-116">Gateway Mode (default)</span></span>
   2. <span data-ttu-id="4169a-117">режим прямого подключения.</span><span class="sxs-lookup"><span data-stu-id="4169a-117">Direct Mode</span></span>

      <span data-ttu-id="4169a-118">Режим шлюза по умолчанию используется на всех платформах SDK.</span><span class="sxs-lookup"><span data-stu-id="4169a-118">Gateway Mode is supported on all SDK platforms and is the configured default.</span></span>  <span data-ttu-id="4169a-119">Так как в режиме шлюза используется стандартный порт HTTPS и одна конечная точка, его рекомендуется использовать для приложений, запущенных в корпоративных сетях со строгими ограничениями брандмауэра.</span><span class="sxs-lookup"><span data-stu-id="4169a-119">If your application runs within a corporate network with strict firewall restrictions, Gateway Mode is the best choice since it uses the standard HTTPS port and a single endpoint.</span></span> <span data-ttu-id="4169a-120">Недостаток режима шлюза в плане производительности заключается в том, что каждый раз во время выполнения операции чтения или записи данных в Cosmos DB добавляется дополнительный прыжок сети.</span><span class="sxs-lookup"><span data-stu-id="4169a-120">The performance tradeoff, however, is that Gateway Mode involves an additional network hop every time data is read or written to Cosmos DB.</span></span> <span data-ttu-id="4169a-121">Поэтому для обеспечения более высокой производительности рекомендуется использовать режим прямого подключения.</span><span class="sxs-lookup"><span data-stu-id="4169a-121">Because of this, Direct Mode offers better performance due to fewer network hops.</span></span>
<a id="use-tcp"></a>
2. <span data-ttu-id="4169a-122">**Политика подключения: использование протокола TCP**</span><span class="sxs-lookup"><span data-stu-id="4169a-122">**Connection policy: Use the TCP protocol**</span></span>

    <span data-ttu-id="4169a-123">Если вы используете режим прямого подключения, вам доступны два варианта протоколов:</span><span class="sxs-lookup"><span data-stu-id="4169a-123">When using Direct Mode, there are two protocol options available:</span></span>

   * <span data-ttu-id="4169a-124">TCP</span><span class="sxs-lookup"><span data-stu-id="4169a-124">TCP</span></span>
   * <span data-ttu-id="4169a-125">HTTPS</span><span class="sxs-lookup"><span data-stu-id="4169a-125">HTTPS</span></span>

     <span data-ttu-id="4169a-126">Cosmos DB предлагает простую и открытую модель программирования RESTful поверх HTTPS.</span><span class="sxs-lookup"><span data-stu-id="4169a-126">Cosmos DB offers a simple and open RESTful programming model over HTTPS.</span></span> <span data-ttu-id="4169a-127">Кроме того, предлагается эффективный протокол TCP, который также является RESTful в своей коммуникационной модели и доступен через клиентский пакет SDK для .NET.</span><span class="sxs-lookup"><span data-stu-id="4169a-127">Additionally, it offers an efficient TCP protocol, which is also RESTful in its communication model and is available through the .NET client SDK.</span></span> <span data-ttu-id="4169a-128">Как Direct TCP, так и HTTPS используют SSL для первоначальной аутентификации и шифрования трафика.</span><span class="sxs-lookup"><span data-stu-id="4169a-128">Both Direct TCP and HTTPS use SSL for initial authentication and encrypting traffic.</span></span> <span data-ttu-id="4169a-129">Чтобы добиться лучшей производительности, рекомендуется по возможности использовать протокол TCP.</span><span class="sxs-lookup"><span data-stu-id="4169a-129">For best performance, use the TCP protocol when possible.</span></span>

     <span data-ttu-id="4169a-130">При использовании протокола TCP в режиме шлюза TCP-порт 443 используется Cosmos DB, а TCP-порт 10255 — API MongoDB.</span><span class="sxs-lookup"><span data-stu-id="4169a-130">When using TCP in Gateway Mode, TCP Port 443 is the Cosmos DB port, and 10255 is the MongoDB API port.</span></span> <span data-ttu-id="4169a-131">Если вы используете протокол TCP в режиме прямого подключения, то в дополнение к портам шлюза необходимо открыть диапазон портов 10 000–20 000, так как Cosmos DB использует динамические TCP-порты.</span><span class="sxs-lookup"><span data-stu-id="4169a-131">When using TCP in Direct Mode, in addition to the Gateway ports, you need to ensure the port range between 10000 and 20000 is open because Cosmos DB uses dynamic TCP ports.</span></span> <span data-ttu-id="4169a-132">Используя протокол TCP при закрытых портах, вы получите ошибку 503 "Служба недоступна".</span><span class="sxs-lookup"><span data-stu-id="4169a-132">If these ports are not open and you attempt to use TCP, you receive a 503 Service Unavailable error.</span></span>

     <span data-ttu-id="4169a-133">Режим подключения настраивается с помощью параметра ConnectionPolicy во время создания экземпляра DocumentClient.</span><span class="sxs-lookup"><span data-stu-id="4169a-133">The Connectivity Mode is configured during the construction of the DocumentClient instance with the ConnectionPolicy parameter.</span></span> <span data-ttu-id="4169a-134">При использовании режима прямого подключения протокол также можно определить в параметре ConnectionPolicy.</span><span class="sxs-lookup"><span data-stu-id="4169a-134">If Direct Mode is used, the Protocol can also be set within the ConnectionPolicy parameter.</span></span>

    ```C#
    var serviceEndpoint = new Uri("https://contoso.documents.net");
    var authKey = new "your authKey from the Azure portal";
    DocumentClient client = new DocumentClient(serviceEndpoint, authKey,
    new ConnectionPolicy
    {
        ConnectionMode = ConnectionMode.Direct,
        ConnectionProtocol = Protocol.Tcp
    });
    ```

    <span data-ttu-id="4169a-135">Протокол TCP поддерживается только в режиме прямого подключения. Если используется режим шлюза, взаимодействие со шлюзом происходит по протоколу HTTPS, а значение, заданное в параметре ConnectionPolicy, игнорируется.</span><span class="sxs-lookup"><span data-stu-id="4169a-135">Because TCP is only supported in Direct Mode, if Gateway Mode is used, then the HTTPS protocol is always used to communicate with the Gateway and the Protocol value in the ConnectionPolicy is ignored.</span></span>

    ![Изображение: политика подключения Azure Cosmos DB](./media/performance-tips/connection-policy.png)

3. <span data-ttu-id="4169a-137">**Использование вызовов OpenAsync для избежания задержки при выполнении первого запроса**</span><span class="sxs-lookup"><span data-stu-id="4169a-137">**Call OpenAsync to avoid startup latency on first request**</span></span>

    <span data-ttu-id="4169a-138">По умолчанию первый запрос характеризуется более длительной задержкой, так как он должен получить таблицу маршрутизации сетевых адресов.</span><span class="sxs-lookup"><span data-stu-id="4169a-138">By default, the first request has a higher latency because it has to fetch the address routing table.</span></span> <span data-ttu-id="4169a-139">Чтобы избежать возникновения этой задержки, во время инициализации необходимо один раз вызвать OpenAsync(), как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="4169a-139">To avoid this startup latency on the first request, you should call OpenAsync() once during initialization as follows.</span></span>

        await client.OpenAsync();
   <a id="same-region"></a>
4. <span data-ttu-id="4169a-140">**Оптимизация производительности за счет размещения клиентов в одном регионе Azure**</span><span class="sxs-lookup"><span data-stu-id="4169a-140">**Collocate clients in same Azure region for performance**</span></span>

    <span data-ttu-id="4169a-141">По возможности разверните приложения, выполняющие вызовы к Cosmos DB, в том же регионе, в котором находится база данных Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="4169a-141">When possible, place any applications calling Cosmos DB in the same region as the Cosmos DB database.</span></span> <span data-ttu-id="4169a-142">Для приблизительного сравнения: вызовы к Cosmos DB в одном и том же регионе выполняются в течение 1–2 мс, но задержка между восточным и западным побережьем США превышает 50 мс.</span><span class="sxs-lookup"><span data-stu-id="4169a-142">For an approximate comparison, calls to Cosmos DB within the same region complete within 1-2 ms, but the latency between the West and East coast of the US is >50 ms.</span></span> <span data-ttu-id="4169a-143">Значение задержки может отличаться в зависимости от выбранного маршрута при передаче запроса от клиента к границе центра обработки данных Azure.</span><span class="sxs-lookup"><span data-stu-id="4169a-143">This latency can likely vary from request to request depending on the route taken by the request as it passes from the client to the Azure datacenter boundary.</span></span> <span data-ttu-id="4169a-144">Минимальная возможная задержка достигается за счет размещения приложения, выполняющего вызовы к Cosmos DB, в том же регионе Azure, в котором находится подготовленная конечная точка Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="4169a-144">The lowest possible latency is achieved by ensuring the calling application is located within the same Azure region as the provisioned Cosmos DB endpoint.</span></span> <span data-ttu-id="4169a-145">Список доступных регионов см. на странице [Регионы Azure](https://azure.microsoft.com/regions/#services).</span><span class="sxs-lookup"><span data-stu-id="4169a-145">For a list of available regions, see [Azure Regions](https://azure.microsoft.com/regions/#services).</span></span>

    <span data-ttu-id="4169a-146">![Изображение: политика подключения Azure Cosmos DB](./media/performance-tips/same-region.png)
   <a id="increase-threads"></a></span><span class="sxs-lookup"><span data-stu-id="4169a-146">![Illustration of the Azure Cosmos DB connection policy](./media/performance-tips/same-region.png)
<a id="increase-threads"></a></span></span>
5. <span data-ttu-id="4169a-147">**Увеличение количества потоков или задач**</span><span class="sxs-lookup"><span data-stu-id="4169a-147">**Increase number of threads/tasks**</span></span>

    <span data-ttu-id="4169a-148">Так как вызовы Cosmos DB выполняются по сети, может потребоваться изменить степень параллелизма запросов, чтобы клиентское приложение тратило минимальное количество времени на ожидание между запросами.</span><span class="sxs-lookup"><span data-stu-id="4169a-148">Since calls to Azure Cosmos DB are made over the network, you may need to vary the degree of parallelism of your requests so that the client application spends very little time waiting between requests.</span></span> <span data-ttu-id="4169a-149">Например, если вы используете [библиотеку параллельных задач .NET](https://msdn.microsoft.com//library/dd460717.aspx), создайте несколько сотен задач для чтения или записи в Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="4169a-149">For example, if you're using .NET's [Task Parallel Library](https://msdn.microsoft.com//library/dd460717.aspx), create in the order of 100s of Tasks reading or writing to Cosmos DB.</span></span>

## <a name="sdk-usage"></a><span data-ttu-id="4169a-150">Использование пакета SDK</span><span class="sxs-lookup"><span data-stu-id="4169a-150">SDK Usage</span></span>
1. <span data-ttu-id="4169a-151">**Установка последней версии пакета SDK**</span><span class="sxs-lookup"><span data-stu-id="4169a-151">**Install the most recent SDK**</span></span>

    <span data-ttu-id="4169a-152">Пакеты SDK для Cosmos DB постоянно улучшаются, чтобы обеспечивать самую высокую производительность.</span><span class="sxs-lookup"><span data-stu-id="4169a-152">The Cosmos DB SDKs are constantly being improved to provide the best performance.</span></span> <span data-ttu-id="4169a-153">Сведения о последней версии пакета SDK и улучшениях см. на страницах о [пакете SDK для Cosmos DB](documentdb-sdk-dotnet.md).</span><span class="sxs-lookup"><span data-stu-id="4169a-153">See the [Cosmos DB SDK](documentdb-sdk-dotnet.md) pages to determine the most recent SDK and review improvements.</span></span>
2. <span data-ttu-id="4169a-154">**Использование одного клиента Cosmos DB в течение жизненного цикла приложения**</span><span class="sxs-lookup"><span data-stu-id="4169a-154">**Use a singleton Cosmos DB client for the lifetime of your application**</span></span>

    <span data-ttu-id="4169a-155">Обратите внимание, что каждый экземпляр DocumentClient является потокобезопасным, а при использовании режима прямого подключения предоставляется возможность управления подключениями и кэширования адресов.</span><span class="sxs-lookup"><span data-stu-id="4169a-155">Note that each DocumentClient instance is thread-safe and performs efficient connection management and address caching when operating in Direct Mode.</span></span> <span data-ttu-id="4169a-156">Чтобы реализовать возможность управления подключениями и оптимизировать производительность, рекомендуется использовать один экземпляр DocumentClient для каждого домена в течение жизненного цикла приложения.</span><span class="sxs-lookup"><span data-stu-id="4169a-156">To allow efficient connection management and better performance by DocumentClient, it is recommended to use a single instance of DocumentClient per AppDomain for the lifetime of the application.</span></span>

   <a id="max-connection"></a>
3. <span data-ttu-id="4169a-157">**Увеличение максимального количества подключений System.Net для каждого узла при использовании режима шлюза**</span><span class="sxs-lookup"><span data-stu-id="4169a-157">**Increase System.Net MaxConnections per host when using Gateway mode**</span></span>

    <span data-ttu-id="4169a-158">При использовании режима шлюза запросы Cosmos DB выполняются через протоколы HTTPS или REST и на них распространяется ограничение на количество подключений по имени узла или по IP-адресу по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="4169a-158">Cosmos DB requests are made over HTTPS/REST when using Gateway mode, and are subjected to the default connection limit per hostname or IP address.</span></span> <span data-ttu-id="4169a-159">Может потребоваться увеличить это значение (до 100–1000), чтобы клиентская библиотека могла использовать несколько одновременных подключений к Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="4169a-159">You may need to set the MaxConnections to a higher value (100-1000) so that the client library can utilize multiple simultaneous connections to Cosmos DB.</span></span> <span data-ttu-id="4169a-160">В пакете SDK для .NET версии 1.8.0 и выше для параметра [ServicePointManager.DefaultConnectionLimit](https://msdn.microsoft.com/library/system.net.servicepointmanager.defaultconnectionlimit.aspx) по умолчанию задано значение 50. Чтобы изменить это значение, установите для параметра [Documents.Client.ConnectionPolicy.MaxConnectionLimit](https://msdn.microsoft.com/library/azure/microsoft.azure.documents.client.connectionpolicy.maxconnectionlimit.aspx) более высокое значение.</span><span class="sxs-lookup"><span data-stu-id="4169a-160">In the .NET SDK 1.8.0 and above, the default value for [ServicePointManager.DefaultConnectionLimit](https://msdn.microsoft.com/library/system.net.servicepointmanager.defaultconnectionlimit.aspx) is 50 and to change the value, you can set the [Documents.Client.ConnectionPolicy.MaxConnectionLimit](https://msdn.microsoft.com/library/azure/microsoft.azure.documents.client.connectionpolicy.maxconnectionlimit.aspx) to a higher value.</span></span>   
4. <span data-ttu-id="4169a-161">**Настройка параллельных запросов для секционированных коллекций**</span><span class="sxs-lookup"><span data-stu-id="4169a-161">**Tuning parallel queries for partitioned collections**</span></span>

     <span data-ttu-id="4169a-162">В пакете SDK для DocumentDB .NET версии 1.9.0 и выше поддерживаются параллельные запросы, позволяющие выполнять запросы к секционированным коллекциям в параллельном режиме (дополнительные сведения см. в разделе [Работа с пакетами SDK](documentdb-partition-data.md#working-with-the-azure-cosmos-db-sdks) и в сопутствующих [примерах кода](https://github.com/Azure/azure-documentdb-dotnet/blob/master/samples/code-samples/Queries/Program.cs)).</span><span class="sxs-lookup"><span data-stu-id="4169a-162">DocumentDB .NET SDK version 1.9.0 and above support parallel queries, which enable you to query a partitioned collection in parallel (see [Working with the SDKs](documentdb-partition-data.md#working-with-the-azure-cosmos-db-sdks) and the related [code samples](https://github.com/Azure/azure-documentdb-dotnet/blob/master/samples/code-samples/Queries/Program.cs) for more info).</span></span> <span data-ttu-id="4169a-163">Параллельные запросы предназначены для сокращения задержки при обработке запросов и улучшения пропускной способности посредством их последовательных аналогов.</span><span class="sxs-lookup"><span data-stu-id="4169a-163">Parallel queries are designed to improve query latency and throughput over their serial counterpart.</span></span> <span data-ttu-id="4169a-164">Параллельные запросы содержат два параметра, которые пользователи могут настроить в соответствии со своими требованиями: а) MaxDegreeOfParallelism устанавливает максимальное количество секций, которые можно запросить в параллельном режиме; б) MaxBufferedItemCount устанавливает количество предварительно выбираемых результатов.</span><span class="sxs-lookup"><span data-stu-id="4169a-164">Parallel queries provide two parameters that users can tune to custom-fit their requirements, (a) MaxDegreeOfParallelism: to control the maximum number of partitions then can be queried in parallel, and (b) MaxBufferedItemCount: to control the number of pre-fetched results.</span></span>

    <span data-ttu-id="4169a-165">(a) ***Настройка MaxDegreeOfParallelism\:***. При параллельном запросе одновременно запрашиваются несколько секций.</span><span class="sxs-lookup"><span data-stu-id="4169a-165">(a) ***Tuning MaxDegreeOfParallelism\:*** Parallel query works by querying multiple partitions in parallel.</span></span> <span data-ttu-id="4169a-166">Однако данные из отдельной секционированной коллекции извлекаются последовательно в соответствии с запросом.</span><span class="sxs-lookup"><span data-stu-id="4169a-166">However, data from an individual partitioned collect is fetched serially with respect to the query.</span></span> <span data-ttu-id="4169a-167">Таким образом, настройка количества секций для параметра MaxDegreeOfParallelism позволит достичь высокой производительности запроса, если все другие состояния системы остаются неизменными.</span><span class="sxs-lookup"><span data-stu-id="4169a-167">So, setting the MaxDegreeOfParallelism to the number of partitions has the maximum chance of achieving the most performant query, provided all other system conditions remain the same.</span></span> <span data-ttu-id="4169a-168">Если вы не знаете количество секций, для параметра MaxDegreeOfParallelism можно задать высокое значение. Система автоматически выберет минимальное из двух значений: число секций или количество, указанное пользователем.</span><span class="sxs-lookup"><span data-stu-id="4169a-168">If you don't know the number of partitions, you can set the MaxDegreeOfParallelism to a high number, and the system chooses the minimum (number of partitions, user provided input) as the MaxDegreeOfParallelism.</span></span>

    <span data-ttu-id="4169a-169">Следует отметить, что параллельные запросы обеспечивают больше преимуществ, если данные равномерно распределены во всех секциях по отношению к запросу.</span><span class="sxs-lookup"><span data-stu-id="4169a-169">It is important to note that parallel queries produce the best benefits if the data is evenly distributed across all partitions with respect to the query.</span></span> <span data-ttu-id="4169a-170">Если коллекция секционируется таким образом, что все или большинство данных, возвращаемых запросом, содержатся в нескольких секциях (в худшем случае в одной), это негативно скажется на производительности запроса.</span><span class="sxs-lookup"><span data-stu-id="4169a-170">If the partitioned collection is partitioned such a way that all or a majority of the data returned by a query is concentrated in a few partitions (one partition in worst case), then the performance of the query would be bottlenecked by those partitions.</span></span>

    <span data-ttu-id="4169a-171">(b) ***Настройка MaxBufferedItemCount\:***. Параллельный запрос предназначен для предварительного получения результатов, пока текущий пакет результатов обрабатывается клиентом.</span><span class="sxs-lookup"><span data-stu-id="4169a-171">(b) ***Tuning MaxBufferedItemCount\:*** Parallel query is designed to pre-fetch results while the current batch of results is being processed by the client.</span></span> <span data-ttu-id="4169a-172">Предварительная выборка способствует общему уменьшению задержки при обработке запроса.</span><span class="sxs-lookup"><span data-stu-id="4169a-172">The pre-fetching helps in overall latency improvement of a query.</span></span> <span data-ttu-id="4169a-173">Параметр MaxBufferedItemCount ограничивает количество предварительно выбираемых результатов.</span><span class="sxs-lookup"><span data-stu-id="4169a-173">MaxBufferedItemCount is the parameter to limit the number of pre-fetched results.</span></span> <span data-ttu-id="4169a-174">Если настроить для параметра MaxBufferedItemCount ожидаемое (или максимальное) количество возвращаемых результатов, запрос получит максимальную выгоду от предварительной выборки.</span><span class="sxs-lookup"><span data-stu-id="4169a-174">Setting MaxBufferedItemCount to the expected number of results returned (or a higher number) allows the query to receive maximum benefit from pre-fetching.</span></span>

    <span data-ttu-id="4169a-175">Обратите внимание, что предварительная выборка работает одинаково, независимо от значения параметра MaxDegreeOfParallelism. Для данных из всех секций применяется один буфер.</span><span class="sxs-lookup"><span data-stu-id="4169a-175">Note that pre-fetching works the same way irrespective of the MaxDegreeOfParallelism, and there is a single buffer for the data from all partitions.</span></span>  
5. <span data-ttu-id="4169a-176">**Включение сбора мусора на сервере**</span><span class="sxs-lookup"><span data-stu-id="4169a-176">**Turn on server-side GC**</span></span>

    <span data-ttu-id="4169a-177">В некоторых случаях для оптимизации производительности необходимо уменьшить частоту сбора мусора.</span><span class="sxs-lookup"><span data-stu-id="4169a-177">Reducing the frequency of garbage collection may help in some cases.</span></span> <span data-ttu-id="4169a-178">В .NET установите для параметра [gcServer](https://msdn.microsoft.com/library/ms229357.aspx) значение true.</span><span class="sxs-lookup"><span data-stu-id="4169a-178">In .NET, set [gcServer](https://msdn.microsoft.com/library/ms229357.aspx) to true.</span></span>
6. <span data-ttu-id="4169a-179">**Реализация интервала задержки для RetryAfter**</span><span class="sxs-lookup"><span data-stu-id="4169a-179">**Implement backoff at RetryAfter intervals**</span></span>

    <span data-ttu-id="4169a-180">Во время проверки производительности следует увеличивать нагрузку до тех пор, пока регулирование не будет выполняться при небольшой частоте запросов.</span><span class="sxs-lookup"><span data-stu-id="4169a-180">During performance testing, you should increase load until a small rate of requests get throttled.</span></span> <span data-ttu-id="4169a-181">При регулировании клиентское приложение должно реализовать интервал частоты повтора для частоты повтора сервера.</span><span class="sxs-lookup"><span data-stu-id="4169a-181">If throttled, the client application should backoff on throttle for the server-specified retry interval.</span></span> <span data-ttu-id="4169a-182">Это гарантирует, что время ожидания между повторными попытками будет минимальным.</span><span class="sxs-lookup"><span data-stu-id="4169a-182">Respecting the backoff ensures that you spend minimal amount of time waiting between retries.</span></span> <span data-ttu-id="4169a-183">В пакетах SDK для [.NET](documentdb-sdk-dotnet.md) и [Java](documentdb-sdk-java.md) версии 1.8.0 и выше, в пакетах SDK для [Node.js](documentdb-sdk-node.md) и [Python](documentdb-sdk-python.md) версии 1.9.0 и выше, а также во всех поддерживаемых пакетах SDK для [.NET Core](documentdb-sdk-dotnet-core.md) включена поддержка политики повтора.</span><span class="sxs-lookup"><span data-stu-id="4169a-183">Retry policy support is included in Version 1.8.0 and above of the DocumentDB [.NET](documentdb-sdk-dotnet.md) and [Java](documentdb-sdk-java.md), version 1.9.0 and above of the [Node.js](documentdb-sdk-node.md) and [Python](documentdb-sdk-python.md), and all supported versions of the [.NET Core](documentdb-sdk-dotnet-core.md) SDKs.</span></span> <span data-ttu-id="4169a-184">Дополнительные сведения см. в разделах [Превышение лимита зарезервированной пропускной способности](request-units.md#RequestRateTooLarge) и [RetryAfter](https://msdn.microsoft.com/library/microsoft.azure.documents.documentclientexception.retryafter.aspx).</span><span class="sxs-lookup"><span data-stu-id="4169a-184">For more information, see [Exceeding reserved throughput limits](request-units.md#RequestRateTooLarge) and [RetryAfter](https://msdn.microsoft.com/library/microsoft.azure.documents.documentclientexception.retryafter.aspx).</span></span>
7. <span data-ttu-id="4169a-185">**Развертывание рабочей нагрузки клиента**</span><span class="sxs-lookup"><span data-stu-id="4169a-185">**Scale out your client-workload**</span></span>

    <span data-ttu-id="4169a-186">При проверке с высокой пропускной способностью (более 50 000 единиц запроса в секунду) клиентское приложение может стать узким местом из-за того, что на компьютере будут достигнуты максимальные уровни использования ЦП и сети.</span><span class="sxs-lookup"><span data-stu-id="4169a-186">If you are testing at high throughput levels (>50,000 RU/s), the client application may become the bottleneck due to the machine capping out on CPU or Network utilization.</span></span> <span data-ttu-id="4169a-187">Если вы достигли этой точки, вы можете распространить учетную запись Cosmos DB на другие компьютеры, развернув свои клиентские приложения на нескольких серверах.</span><span class="sxs-lookup"><span data-stu-id="4169a-187">If you reach this point, you can continue to push the Cosmos DB account further by scaling out your client applications across multiple servers.</span></span>
8. <span data-ttu-id="4169a-188">**Кэширование URI документов для снижения задержки чтения**</span><span class="sxs-lookup"><span data-stu-id="4169a-188">**Cache document URIs for lower read latency**</span></span>

    <span data-ttu-id="4169a-189">Чтобы повысить производительность операций чтения, по возможности выполняйте кэширование URI документов.</span><span class="sxs-lookup"><span data-stu-id="4169a-189">Cache document URIs whenever possible for the best read performance.</span></span>
   <a id="tune-page-size"></a>
9. <span data-ttu-id="4169a-190">**Оптимизация производительности посредством настройки размера страницы для запросов и каналов чтения**</span><span class="sxs-lookup"><span data-stu-id="4169a-190">**Tune the page size for queries/read feeds for better performance**</span></span>

    <span data-ttu-id="4169a-191">Если при выполнении массового чтения документов с помощью функции для чтения канала (например, ReadDocumentFeedAsync) или отправке запроса DocumentDB SQL получен слишком большой набор результатов, результаты возвращаются частями.</span><span class="sxs-lookup"><span data-stu-id="4169a-191">When performing a bulk read of documents using read feed functionality (for example, ReadDocumentFeedAsync) or when issuing a DocumentDB SQL query, the results are returned in a segmented fashion if the result set is too large.</span></span> <span data-ttu-id="4169a-192">По умолчанию результаты возвращаются в пакетах (не более 100 элементов и не более 1 МБ в каждом пакете).</span><span class="sxs-lookup"><span data-stu-id="4169a-192">By default, results are returned in chunks of 100 items or 1 MB, whichever limit is hit first.</span></span>

    <span data-ttu-id="4169a-193">Чтобы снизить количество полных обходов сети, необходимых для получения всех соответствующих результатов, можно увеличить размер страницы до 1000 с помощью заголовка запроса x-ms-max-item-count.</span><span class="sxs-lookup"><span data-stu-id="4169a-193">To reduce the number of network round trips required to retrieve all applicable results, you can increase the page size using x-ms-max-item-count request header to up to 1000.</span></span> <span data-ttu-id="4169a-194">Чтобы отобразить только некоторые результаты, например, когда пользовательский интерфейс или приложение API возвращает только десять результатов за раз, размер страницы можно уменьшить до 10. Это позволит снизить пропускную способность, используемую на операции чтения и на выполнение запросов.</span><span class="sxs-lookup"><span data-stu-id="4169a-194">In cases where you need to display only a few results, for example, if your user interface or application API returns only 10 results a time, you can also decrease the page size to 10 to reduce the throughput consumed for reads and queries.</span></span>

    <span data-ttu-id="4169a-195">Размер страницы также можно изменить с помощью доступных пакетов SDK для Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="4169a-195">You may also set the page size using the available Cosmos DB SDKs.</span></span>  <span data-ttu-id="4169a-196">Например:</span><span class="sxs-lookup"><span data-stu-id="4169a-196">For example:</span></span>

        IQueryable<dynamic> authorResults = client.CreateDocumentQuery(documentCollection.SelfLink, "SELECT p.Author FROM Pages p WHERE p.Title = 'About Seattle'", new FeedOptions { MaxItemCount = 1000 });
10. <span data-ttu-id="4169a-197">**Увеличение количества потоков или задач**</span><span class="sxs-lookup"><span data-stu-id="4169a-197">**Increase number of threads/tasks**</span></span>

    <span data-ttu-id="4169a-198">См. подраздел [Увеличение количества потоков или задач](#increase-threads) раздела "Сеть".</span><span class="sxs-lookup"><span data-stu-id="4169a-198">See [Increase number of threads/tasks](#increase-threads) in the Networking section.</span></span>

11. <span data-ttu-id="4169a-199">**Использование 64-разрядных хост-процессов**</span><span class="sxs-lookup"><span data-stu-id="4169a-199">**Use 64-bit host processing**</span></span>

    <span data-ttu-id="4169a-200">Если вы используете пакет SDK .NET для DocumentDB версии 1.11.4 и выше, он работает в 32-разрядном хост-процессе.</span><span class="sxs-lookup"><span data-stu-id="4169a-200">The DocumentDB SDK works in a 32-bit host process when you are using DocumentDB .NET SDK version 1.11.4 and above.</span></span> <span data-ttu-id="4169a-201">Но если вы используете запросы между секциями, то для повышения производительности мы рекомендуем использовать 64-разрядные хост-процессы.</span><span class="sxs-lookup"><span data-stu-id="4169a-201">However, if you are using cross partition queries, 64-bit host processing is recommended for improved performance.</span></span> <span data-ttu-id="4169a-202">В следующих типах приложений по умолчанию используется 32-разрядный хост-процесс. Чтобы изменить его на 64-разрядный, выполните описанные ниже действия в зависимости от типа приложения.</span><span class="sxs-lookup"><span data-stu-id="4169a-202">The following types of applications have 32-bit host process as the default, so in order to change that to 64-bit, follow these steps based on the type of your application:</span></span>

    - <span data-ttu-id="4169a-203">Для исполняемых приложений это можно сделать, сняв флажок **Предпочтительно 32-разр.** в окне **Свойства проекта** на вкладке **Сборка**.</span><span class="sxs-lookup"><span data-stu-id="4169a-203">For Executable applications, this can be done by unchecking the **Prefer 32-bit** option in the **Project Properties** window, on the **Build** tab.</span></span>

    - <span data-ttu-id="4169a-204">Для тестовых проектов на основе VSTest это можно сделать, выбрав **Тест**->**Параметры тестирования**->**Default Processor Architecture as X64** (Архитектура процессора по умолчанию — X64) в пункте меню **Тест Visual Studio**.</span><span class="sxs-lookup"><span data-stu-id="4169a-204">For VSTest based test projects, this can be done by selecting **Test**->**Test Settings**->**Default Processor Architecture as X64**, from the **Visual Studio Test** menu option.</span></span>

    - <span data-ttu-id="4169a-205">Для локально развернутых веб-приложений ASP.NET это можно сделать, установив флажок **Использовать 64-разрядную версию IIS Express для веб-сайтов и проектов** в меню **Сервис**->**Параметры**->**Проекты и решения**->**Веб-проекты**.</span><span class="sxs-lookup"><span data-stu-id="4169a-205">For locally deployed ASP.NET Web applications, this can be done by checking the **Use the 64-bit version of IIS Express for web sites and projects**, under **Tools**->**Options**->**Projects and Solutions**->**Web Projects**.</span></span>

    - <span data-ttu-id="4169a-206">Для веб-приложений ASP.NET, развернутых в Azure, это можно сделать, выбрав **Platform as 64-bit** (Платформа — 64-разрядная) в меню **Параметры приложения** на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="4169a-206">For ASP.NET Web applications deployed on Azure, this can be done by choosing the **Platform as 64-bit** in the **Application Settings** on the Azure portal.</span></span>

## <a name="indexing-policy"></a><span data-ttu-id="4169a-207">Политика индексации</span><span class="sxs-lookup"><span data-stu-id="4169a-207">Indexing Policy</span></span>
1. <span data-ttu-id="4169a-208">**Использование отложенного индексирования для увеличения скорости приема документов во время пиковой нагрузки**</span><span class="sxs-lookup"><span data-stu-id="4169a-208">**Use lazy indexing for faster peak time ingestion rates**</span></span>

    <span data-ttu-id="4169a-209">Cosmos DB позволяет указать политику индексации (на уровне коллекции). При необходимости эта политика используется для включения автоматический индексации документов в коллекции.</span><span class="sxs-lookup"><span data-stu-id="4169a-209">Cosmos DB allows you to specify – at the collection level – an indexing policy, which enables you to choose if you want the documents in a collection to be automatically indexed or not.</span></span>  <span data-ttu-id="4169a-210">Кроме того, можно выбрать синхронное (согласованное) или асинхронное (отложенное) обновления индекса.</span><span class="sxs-lookup"><span data-stu-id="4169a-210">In addition, you may also choose between synchronous (Consistent) and asynchronous (Lazy) index updates.</span></span> <span data-ttu-id="4169a-211">По умолчанию индекс обновляется синхронно при каждой операции вставки, замены или удаления документа в коллекции.</span><span class="sxs-lookup"><span data-stu-id="4169a-211">By default, the index is updated synchronously on each insert, replace, or delete of a document to the collection.</span></span> <span data-ttu-id="4169a-212">Синхронный режим позволяет выполнять запросы, обеспечивая тот же [уровень согласованности](consistency-levels.md), что и при чтении документа, без каких-либо задержек, чтобы индекс оставался актуальным.</span><span class="sxs-lookup"><span data-stu-id="4169a-212">Synchronously mode enables the queries to honor the same [consistency level](consistency-levels.md) as that of the document reads without any delay for the index to “catch up".</span></span>

    <span data-ttu-id="4169a-213">Отложенное индексирование можно использовать для сценариев, при которых происходит запись данных пачками, а вы хотите уменьшить нагрузку при выполнении работы, необходимой для индексирования содержания в течение более длительного периода времени.</span><span class="sxs-lookup"><span data-stu-id="4169a-213">Lazy indexing may be considered for scenarios in which data is written in bursts, and you want to amortize the work required to index content over a longer period of time.</span></span> <span data-ttu-id="4169a-214">Это также позволяет эффективно использовать отведенную пропускную способность и обслуживать запросы на запись в часы пик с минимальной задержкой.</span><span class="sxs-lookup"><span data-stu-id="4169a-214">Lazy indexing also allows you to use your provisioned throughput effectively and serve write requests at peak times with minimal latency.</span></span> <span data-ttu-id="4169a-215">Важно отметить, что при включенном отложенном индексировании результаты запросов всегда являются согласованными в конечном счете, независимо от уровня согласованности, настроенного в учетной записи Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="4169a-215">It is important to note, however, that when lazy indexing is enabled, query results are eventually consistent regardless of the consistency level configured for the Cosmos DB account.</span></span>

    <span data-ttu-id="4169a-216">Таким образом, при использовании режима согласованного индексирования (для параметра IndexingPolicy.IndexingMode задано значение Consistent) расходуется максимальное количество единиц запроса на каждую операцию записи, в то время как при использовании отложенного индексирования (для параметра IndexingPolicy.IndexingMode задано значение Lazy) и при отключенном индексировании (для параметра IndexingPolicy.Automatic задано значение False) во время выполнения операции записи плата за индексирование не взимается.</span><span class="sxs-lookup"><span data-stu-id="4169a-216">Hence, Consistent indexing mode (IndexingPolicy.IndexingMode is set to Consistent) incurs the highest request unit charge per write, while Lazy indexing mode (IndexingPolicy.IndexingMode is set to Lazy) and no indexing (IndexingPolicy.Automatic is set to False) have zero indexing cost at the time of write.</span></span>
2. <span data-ttu-id="4169a-217">**Увеличение скорости выполнения операций записи посредством исключения неиспользуемых путей из индексирования**</span><span class="sxs-lookup"><span data-stu-id="4169a-217">**Exclude unused paths from indexing for faster writes**</span></span>

    <span data-ttu-id="4169a-218">Политика индексирования Cosmos DB также позволяет добавлять пути к документам или исключать их из индексирования. Для этого используется параметр Indexing Paths (IndexingPolicy.IncludedPaths и IndexingPolicy.ExcludedPaths).</span><span class="sxs-lookup"><span data-stu-id="4169a-218">Cosmos DB’s indexing policy also allows you to specify which document paths to include or exclude from indexing by leveraging Indexing Paths (IndexingPolicy.IncludedPaths and IndexingPolicy.ExcludedPaths).</span></span> <span data-ttu-id="4169a-219">Возможность управления путями индексирования позволяет оптимизировать производительность записи и снизить затраты на хранение индекса для сценариев с заранее определенными шаблонами запросов. Это связано с тем, что затраты на индексирование непосредственно зависят от количества уникальных путей индексирования.</span><span class="sxs-lookup"><span data-stu-id="4169a-219">The use of indexing paths can offer improved write performance and lower index storage for scenarios in which the query patterns are known beforehand, as indexing costs are directly correlated to the number of unique paths indexed.</span></span>  <span data-ttu-id="4169a-220">Например, в приведенном ниже коде показано, как исключить из индексации целый раздел документов (так называемое</span><span class="sxs-lookup"><span data-stu-id="4169a-220">For example, the following code shows how to exclude an entire section of the documents (a.k.a.</span></span> <span data-ttu-id="4169a-221">поддерево) с помощью подстановочного знака "*".</span><span class="sxs-lookup"><span data-stu-id="4169a-221">a subtree) from indexing using the "*" wildcard.</span></span>

    ```C#
    var collection = new DocumentCollection { Id = "excludedPathCollection" };
    collection.IndexingPolicy.IncludedPaths.Add(new IncludedPath { Path = "/*" });
    collection.IndexingPolicy.ExcludedPaths.Add(new ExcludedPath { Path = "/nonIndexedContent/*");
    collection = await client.CreateDocumentCollectionAsync(UriFactory.CreateDatabaseUri("db"), excluded);
    ```

    <span data-ttu-id="4169a-222">Дополнительные сведения см. в статье [Политики индексации DocumentDB](indexing-policies.md).</span><span class="sxs-lookup"><span data-stu-id="4169a-222">For more information, see [Azure Cosmos DB indexing policies](indexing-policies.md).</span></span>

## <a name="throughput"></a><span data-ttu-id="4169a-223">Пропускная способность</span><span class="sxs-lookup"><span data-stu-id="4169a-223">Throughput</span></span>
<a id="measure-rus"></a>

1. <span data-ttu-id="4169a-224">**Измерение и настройка расхода единиц запроса/повторного использования**</span><span class="sxs-lookup"><span data-stu-id="4169a-224">**Measure and tune for lower request units/second usage**</span></span>

    <span data-ttu-id="4169a-225">Cosmos DB предоставляет обширный набор операций базы данных, включая реляционные и иерархические запросы с использованием UDF, хранимых процедур и триггеров, для документов в коллекции базы данных.</span><span class="sxs-lookup"><span data-stu-id="4169a-225">Cosmos DB offers a rich set of database operations including relational and hierarchical queries with UDFs, stored procedures, and triggers – all operating on the documents within a database collection.</span></span> <span data-ttu-id="4169a-226">Затраты, связанные с каждой из этих операций, зависят от типа процессора, операций ввода-вывода и памяти, необходимой для завершения операции.</span><span class="sxs-lookup"><span data-stu-id="4169a-226">The cost associated with each of these operations varies based on the CPU, IO, and memory required to complete the operation.</span></span> <span data-ttu-id="4169a-227">Вместо того чтобы думать о закупке и управлении аппаратными ресурсами, вы можете думать о единице запроса (RU) как единой меры для ресурсов, необходимых для выполнения различных операций с базами данных и обслуживания запросов приложений.</span><span class="sxs-lookup"><span data-stu-id="4169a-227">Instead of thinking about and managing hardware resources, you can think of a request unit (RU) as a single measure for the resources required to perform various database operations and service an application request.</span></span>

    <span data-ttu-id="4169a-228">[Единицы запросов](request-units.md) предоставляются для каждой учетной записи базы данных в зависимости от количества приобретенных единиц емкости.</span><span class="sxs-lookup"><span data-stu-id="4169a-228">[Request units](request-units.md) are provisioned for each database account based on the number of capacity units that you purchase.</span></span> <span data-ttu-id="4169a-229">Удельный расход единиц запросов оценивается в расчете на одну секунду.</span><span class="sxs-lookup"><span data-stu-id="4169a-229">Request unit consumption is evaluated as a rate per second.</span></span> <span data-ttu-id="4169a-230">Частота запросов для приложений, у которых она превышает подготовленные единицы запросов для учетной записи, будет ограничена, пока она не упадет ниже зарезервированного для учетной записи уровня.</span><span class="sxs-lookup"><span data-stu-id="4169a-230">Applications that exceed the provisioned request unit rate for their account is limited until the rate drops below the reserved level for the account.</span></span> <span data-ttu-id="4169a-231">Если ваше приложение требует более высокого уровня пропускной способности, вы можете приобрести дополнительные единицы емкости.</span><span class="sxs-lookup"><span data-stu-id="4169a-231">If your application requires a higher level of throughput, you can purchase additional capacity units.</span></span>

    <span data-ttu-id="4169a-232">Сложность запроса влияет на количество потребляемых единиц запросов для операции.</span><span class="sxs-lookup"><span data-stu-id="4169a-232">The complexity of a query impacts how many Request Units are consumed for an operation.</span></span> <span data-ttu-id="4169a-233">Количество предикатов и их характер, количество определяемых пользователем функций и размер набора исходных данных — все это влияет на плату за операции запроса.</span><span class="sxs-lookup"><span data-stu-id="4169a-233">The number of predicates, nature of the predicates, number of UDFs, and the size of the source data set all influence the cost of query operations.</span></span>

    <span data-ttu-id="4169a-234">Для оценки расходов на каждую операцию (создание, обновление или удаление) выберите заголовок x-ms-request-charge (или эквивалентное свойство RequestCharge на вкладке ResourceResponse<T> или FeedResponse<T> в пакете SDK для .NET), чтобы измерить число единиц запроса, используемых такими операциями.</span><span class="sxs-lookup"><span data-stu-id="4169a-234">To measure the overhead of any operation (create, update, or delete), inspect the x-ms-request-charge header (or the equivalent RequestCharge property in ResourceResponse<T> or FeedResponse<T> in the .NET SDK) to measure the number of request units consumed by these operations.</span></span>

    ```C#
    // Measure the performance (request units) of writes
    ResourceResponse<Document> response = await client.CreateDocumentAsync(collectionSelfLink, myDocument);
    Console.WriteLine("Insert of document consumed {0} request units", response.RequestCharge);
    // Measure the performance (request units) of queries
    IDocumentQuery<dynamic> queryable = client.CreateDocumentQuery(collectionSelfLink, queryString).AsDocumentQuery();
    while (queryable.HasMoreResults)
         {
              FeedResponse<dynamic> queryResponse = await queryable.ExecuteNextAsync<dynamic>();
              Console.WriteLine("Query batch consumed {0} request units", queryResponse.RequestCharge);
         }
    ```             

    <span data-ttu-id="4169a-235">Затраты на запрос, возвращенные в этом заголовке, — это часть подготовленной пропускной способности (например, 2000 единиц запроса в секунду).</span><span class="sxs-lookup"><span data-stu-id="4169a-235">The request charge returned in this header is a fraction of your provisioned throughput (i.e., 2000 RUs / second).</span></span> <span data-ttu-id="4169a-236">Например, если приведенный выше запрос вернет 1000 документов размером по 1 КБ каждый, затраты на операцию составят 1000 единиц.</span><span class="sxs-lookup"><span data-stu-id="4169a-236">For example, if the preceding query returns 1000 1KB-documents, the cost of the operation is 1000.</span></span> <span data-ttu-id="4169a-237">Таким образом, перед регулированием последующих запросов сервер за одну секунду выполняет только два таких запроса.</span><span class="sxs-lookup"><span data-stu-id="4169a-237">As such, within one second, the server honors only two such requests before throttling subsequent requests.</span></span> <span data-ttu-id="4169a-238">Чтобы узнать больше, ознакомьтесь с [единицами запроса](request-units.md) и [калькулятором единиц запроса](https://www.documentdb.com/capacityplanner).</span><span class="sxs-lookup"><span data-stu-id="4169a-238">For more information, see [Request units](request-units.md) and the [request unit calculator](https://www.documentdb.com/capacityplanner).</span></span>
<a id="429"></a>
2. <span data-ttu-id="4169a-239">**Обработка ограничения скорости/ слишком высокая частота запросов**</span><span class="sxs-lookup"><span data-stu-id="4169a-239">**Handle rate limiting/request rate too large**</span></span>

    <span data-ttu-id="4169a-240">Выполнение запроса, который превышает лимит зарезервированной пропускной способности для учетной записи, не приводит к снижению производительности сервера, так как пользователь не сможет превысить это зарезервированное значение.</span><span class="sxs-lookup"><span data-stu-id="4169a-240">When a client attempts to exceed the reserved throughput for an account, there is no performance degradation at the server and no use of throughput capacity beyond the reserved level.</span></span> <span data-ttu-id="4169a-241">Сервер заблаговременно завершит запрос с ошибкой RequestRateTooLarge (код состояния HTTP: 429) и вернет заголовок x-x-ms-retry-after-ms, указывая время (в миллисекундах), спустя которое можно повторно выполнить запрос.</span><span class="sxs-lookup"><span data-stu-id="4169a-241">The server will preemptively end the request with RequestRateTooLarge (HTTP status code 429) and return the x-ms-retry-after-ms header indicating the amount of time, in milliseconds, that the user must wait before reattempting the request.</span></span>

        HTTP Status 429,
        Status Line: RequestRateTooLarge
        x-ms-retry-after-ms :100

    <span data-ttu-id="4169a-242">Пакеты SDK перехватят этот ответ, обработают заголовок retry-after, указанный сервером, и отправят запрос повторно.</span><span class="sxs-lookup"><span data-stu-id="4169a-242">The SDKs all implicitly catch this response, respect the server-specified retry-after header, and retry the request.</span></span> <span data-ttu-id="4169a-243">Если к вашей учетной записи параллельно имеет доступ только один клиент, следующая попытка будет успешной.</span><span class="sxs-lookup"><span data-stu-id="4169a-243">Unless your account is being accessed concurrently by multiple clients, the next retry will succeed.</span></span>

    <span data-ttu-id="4169a-244">По умолчанию количество повторных попыток отправки запроса составляет 9 (это значение задается клиентом). Если к вашей учетной записи имеют доступ несколько клиентов и они выполняют запросы одновременно, этого значения может быть недостаточно. В этом случае клиент выдаст для приложения исключение DocumentClientException с кодом состояния 429.</span><span class="sxs-lookup"><span data-stu-id="4169a-244">If you have more than one client cumulatively operating consistently above the request rate, the default retry count currently set to 9 internally by the client may not suffice; in this case, the client throws a DocumentClientException with status code 429 to the application.</span></span> <span data-ttu-id="4169a-245">Число повторных попыток по умолчанию можно переопределить в свойстве RetryOptions экземпляра ConnectionPolicy.</span><span class="sxs-lookup"><span data-stu-id="4169a-245">The default retry count can be changed by setting the RetryOptions on the ConnectionPolicy instance.</span></span> <span data-ttu-id="4169a-246">По умолчанию в случае превышения заданного счетчика повторов исключение DocumentClientException с кодом состояния 429 возвращается через 30 секунд (совокупное время ожидания).</span><span class="sxs-lookup"><span data-stu-id="4169a-246">By default, the DocumentClientException with status code 429 is returned after a cumulative wait time of 30 seconds if the request continues to operate above the request rate.</span></span> <span data-ttu-id="4169a-247">Это происходит, даже если текущее значение количества повторных попыток (по умолчанию (9) или определенное пользователем) меньше максимального значения.</span><span class="sxs-lookup"><span data-stu-id="4169a-247">This occurs even when the current retry count is less than the max retry count, be it the default of 9 or a user-defined value.</span></span>

    <span data-ttu-id="4169a-248">Хотя автоматическая процедура отправки повторного запроса позволяет улучшить устойчивость приложений и повысить удобство работы с ними, она может снизить производительность, что, в свою очередь, станет причиной появления более длительных задержек.</span><span class="sxs-lookup"><span data-stu-id="4169a-248">While the automated retry behavior helps to improve resiliency and usability for the most applications, it might come at odds when doing performance benchmarks, especially when measuring latency.</span></span>  <span data-ttu-id="4169a-249">Если настройка производительности повлияла на регулирование сервера и стала причиной автоматической отправки запросов пакетом SDK, это может стать причиной появления пиков задержек на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="4169a-249">The client-observed latency will spike if the experiment hits the server throttle and causes the client SDK to silently retry.</span></span> <span data-ttu-id="4169a-250">Чтобы избежать пиков задержек во время настройки производительности, проверьте расход ресурсов на каждую операцию и убедитесь, что значение частоты запросов не превышено.</span><span class="sxs-lookup"><span data-stu-id="4169a-250">To avoid latency spikes during performance experiments, measure the charge returned by each operation and ensure that requests are operating below the reserved request rate.</span></span> <span data-ttu-id="4169a-251">Дополнительные сведения см. в статье [Единицы запросов в DocumentDB](request-units.md).</span><span class="sxs-lookup"><span data-stu-id="4169a-251">For more information, see [Request units](request-units.md).</span></span>
3. <span data-ttu-id="4169a-252">**Использование меньших документов для более высокой пропускной способности**</span><span class="sxs-lookup"><span data-stu-id="4169a-252">**Design for smaller documents for higher throughput**</span></span>

    <span data-ttu-id="4169a-253">Плата за запрос (например, плата за обработку запроса) на выполнение определенной операции напрямую зависит от размера документа.</span><span class="sxs-lookup"><span data-stu-id="4169a-253">The request charge (i.e. request processing cost) of a given operation is directly correlated to the size of the document.</span></span> <span data-ttu-id="4169a-254">За операции с большими документами взимается больше единиц запроса, чем за операции с мелкими документами.</span><span class="sxs-lookup"><span data-stu-id="4169a-254">Operations on large documents cost more than operations for small documents.</span></span>

## <a name="next-steps"></a><span data-ttu-id="4169a-255">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="4169a-255">Next steps</span></span>
<span data-ttu-id="4169a-256">Пример приложения, используемого в сценариях оценки производительности Cosmos DB на нескольких клиентских компьютерах, см. в статье [Проверка производительности и масштабирования с помощью Azure Cosmos DB](performance-testing.md).</span><span class="sxs-lookup"><span data-stu-id="4169a-256">For a sample application used to evaluate Cosmos DB for high-performance scenarios on a few client machines, see [Performance and scale testing with Cosmos DB](performance-testing.md).</span></span>

<span data-ttu-id="4169a-257">Дополнительные сведения о создании собственного масштабируемого приложения с высокой производительностью см. в статье [Секционирование, ключи секции и масштабирование в DocumentDB](partition-data.md).</span><span class="sxs-lookup"><span data-stu-id="4169a-257">Also, to learn more about designing your application for scale and high performance, see [Partitioning and scaling in Azure Cosmos DB](partition-data.md).</span></span>

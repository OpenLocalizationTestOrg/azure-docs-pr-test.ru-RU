---
title: "Обновление масштабируемого набора виртуальных машин Azure | Документация Майкрософт"
description: "Обновление масштабируемого набора виртуальных машин Azure."
services: virtual-machine-scale-sets
documentationcenter: 
author: gatneil
manager: jeconnoc
editor: 
tags: azure-resource-manager
ms.assetid: e229664e-ee4e-4f12-9d2e-a4f456989e5d
ms.service: virtual-machine-scale-sets
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/30/2017
ms.author: gunegatybo
ms.openlocfilehash: fbdc9d40173a40f35eee60cadfdd258293509d53
ms.sourcegitcommit: f46cbcff710f590aebe437c6dd459452ddf0af09
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/20/2017
---
# <a name="upgrade-a-virtual-machine-scale-set"></a>Обновление набора масштабирования виртуальных машин
В этой статье объясняется, как без простоев развернуть обновление операционной системы в наборе масштабирования виртуальных машин Azure. Здесь рассматриваются такие обновления ОС, которые изменяют версию или SKU операционной системы, либо изменяют универсальный код ресурса (URI) пользовательского образа. Обновление без простоя означает обновление виртуальных машин по одной или группами (например, по одному домену сбоя), а не всех сразу. В этом случае виртуальные машины, которые не обновляются, могут продолжать работу.

Чтобы избежать путаницы, следует различать четыре типа возможных обновлений операционной системы.

* Изменение версии или SKU образа платформы. Например, изменение версии Ubuntu 14.04.2-LTS с 14.04.201506100 на 14.04.201507060 или изменение SKU с Ubuntu 15.10/(последний выпуск) на Ubuntu 16.04.0-LTS/(последний выпуск). Этот сценарий описан в данной статье.
* Изменение URI, указывающего на новую созданную версию пользовательского образа (**properties** > **virtualMachineProfile** > **storageProfile** > **osDisk** > **image** > **uri**). Этот сценарий описан в данной статье.
* Изменение ссылки на образ масштабируемого набора, созданного с помощью управляемых дисков Azure.
* Обновление операционной системы на виртуальной машине (например, установка исправления безопасности или запуск центра обновления Windows). Этот сценарий поддерживается, но не описан в данной статье.

В этой статье не рассматриваются наборы масштабирования виртуальных машин, которые развернуты как часть кластера [Azure Service Fabric](https://azure.microsoft.com/services/service-fabric/) . Дополнительные сведения о Service Fabric исправления см. в разделе [ОС Windows исправления кластера Service Fabric](https://docs.microsoft.com/azure/service-fabric/service-fabric-patch-orchestration-application)

Далее представлена базовая процедура при изменении версии или SKU операционной системы для стандартного образа или универсального кода ресурса (URI) для пользовательского образа.

1. Получите модель набора масштабирования виртуальных машин.
2. Измените в этой модели значение версии, SKU, ссылки на образ или универсальный код ресурса (URI).
3. Обновление модели.
4. Выполните вызов *manualUpgrade* для виртуальных машин в наборе масштабирования. Этот шаг применяется только в том случае, если свойству *upgradePolicy* для набора масштабирования присвоено значение **Manual** . Если он имеет значение **Automatic**, то все виртуальные машины обновляются одновременно, что приводит к простою.

С учетом этих сведений рассмотрим, как проходит обновление версии для масштабируемого набора с использованием PowerShell и REST API. В статье приведены примеры для образа платформы, но она содержит достаточно информации, чтобы адаптировать этот процесс для пользовательского образа.

## <a name="powershell"></a>PowerShell
В этом примере масштабируемый набор виртуальных машин Windows обновляется до новой версии 4.0.20160229. После обновления модели поочередно обновляются все экземпляры виртуальной машины.

```powershell
$rgname = "myrg"
$vmssname = "myvmss"
$newversion = "4.0.20160229"
$instanceid = "1"

# get the VMSS model
$vmss = Get-AzureRmVmss -ResourceGroupName $rgname -VMScaleSetName $vmssname

# set the new version in the model data
$vmss.virtualMachineProfile.storageProfile.imageReference.version = $newversion

# update the virtual machine scale set model
Update-AzureRmVmss -ResourceGroupName $rgname -Name $vmssname -VirtualMachineScaleSet $vmss

# now start updating instances
Update-AzureRmVmssInstance -ResourceGroupName $rgname -VMScaleSetName $vmssname -InstanceId $instanceId
```

При обновлении URI для пользовательского изображения вместо изменения указана версия образа платформы, замените строку «установить новую версию» команды, которая обновляет URI источника изображения. Например, если масштабируемый набор был создан без использования управляемых дисков Azure, обновление будет выглядеть следующим образом.

```powershell
# set the new version in the model data
$vmss.virtualMachineProfile.storageProfile.osDisk.image.uri= $newURI
```

Если набор пользовательских масштабирования на основе образа был создан с помощью управляемых дисков Azure, ссылку на изображение будет обновлено. Например: 

```powershell
# set the new version in the model data
$vmss.virtualMachineProfile.storageProfile.imageReference.id = $newImageReference
```

## <a name="the-rest-api"></a>Вызов REST API
Ниже приведена пара примеров на Python, использующих REST API Azure для развертывания обновления версии ОС. Оба сценария используют упрощенную библиотеку [azurerm](https://pypi.python.org/pypi/azurerm) функций-оболочек REST API Azure. Эта библиотека нужна для выполнения операции GET в модели набора масштабирования, а затем операции PUT в обновленной модели. Также эти сценарии ориентируются на представления экземпляров виртуальных машин, чтобы идентифицировать виртуальные машины по доменам обновления.

### <a name="vmssupgrade"></a>Vmssupgrade
 [Vmssupgrade](https://github.com/gbowerman/vmsstools) — это сценарий Python, предназначенный для развертывания обновления ОС в работающем наборе масштабирования виртуальных машин. При этом обновление осуществляется в доменах обновления поочередно.

![Сценарий Vmssupgrade для выбора виртуальных машин или домена обновления](./media/virtual-machine-scale-sets-upgrade-scale-set/vmssupgrade-screenshot.png)

Этот сценарий позволяет выбрать для обновления конкретные виртуальные машины или указать домен обновления. Он поддерживает изменение версии образа платформы и изменение URI пользовательского образа.

### <a name="vmsseditor"></a>Vmsseditor
[Vmsseditor](https://github.com/gbowerman/vmssdashboard) — это универсальный редактор наборов масштабирования виртуальных машин, отображающий состояние виртуальных машин в виде тепловой карты, в которой каждая строка представляет один домен обновления. Помимо прочего, здесь можно обновить модель для набора масштабирования, указав новую версию, SKU или универсальный код ресурса (URI) пользовательского образа, а затем выбрать домены сбоя для обновления. Все виртуальные машины в выбранном домене обновления будут обновлены до новой модели. Также можно выполнить последовательное обновление, установив произвольный размер пакета.  

На следующем снимке экрана представлена модель набора масштабирования для Ubuntu 14.04-2LTS версии 14.04.201507060. Обратите внимание, что с момента создания этого снимка уже добавлены многие другие параметры.

![Модель Vmsseditor для домена обновления с ОС Ubuntu 14.04-2LTS](./media/virtual-machine-scale-sets-upgrade-scale-set/vmssEditor1.png)

После нажатия кнопки **Обновить** и **Получить сведения** начинается обновление виртуальных машин в домене обновления UD 0.

![Отображение процесса обновления в Vmsseditor](./media/virtual-machine-scale-sets-upgrade-scale-set/vmssEditor2.png)


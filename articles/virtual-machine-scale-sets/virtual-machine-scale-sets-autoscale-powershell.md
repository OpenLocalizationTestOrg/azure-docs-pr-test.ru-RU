---
title: "Автомасштабирование масштабируемых наборов виртуальных машин с помощью Azure PowerShell | Документация Майкрософт"
description: "Узнайте, как создать правила автомасштабирования для масштабируемых наборов виртуальных машин с помощью Azure PowerShell"
services: virtual-machine-scale-sets
documentationcenter: 
author: iainfoulds
manager: jeconnoc
editor: 
tags: azure-resource-manager
ms.assetid: 88886cad-a2f0-46bc-8b58-32ac2189fc93
ms.service: virtual-machine-scale-sets
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/19/2017
ms.author: iainfou
ms.openlocfilehash: 8928e56f353858234db314714d411a9c2990eb4e
ms.sourcegitcommit: 901a3ad293669093e3964ed3e717227946f0af96
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/21/2017
---
# <a name="automatically-scale-a-virtual-machine-scale-set-with-azure-powershell"></a>Автоматическое масштабирование масштабируемых наборов виртуальных машин с помощью Azure PowerShell
При создании масштабируемого набора вы определяете количество экземпляров виртуальных машин для запуска. По мере изменения потребностей приложения можно автоматически увеличивать или уменьшать это количество. Возможность автоматического масштабирования позволяет удовлетворить пользовательский спрос или среагировать на изменения производительности приложения на протяжении его жизненного цикла.

В этой статье описывается, как создать правила автомасштабирования с помощью Azure PowerShell, которые отслеживают производительность экземпляров виртуальных машин в масштабируемом наборе. С помощью этих правил можно увеличить или уменьшить количество экземпляров виртуальных машин в ответ на метрики производительности. Эти действия можно также выполнить на [портале Azure](virtual-machine-scale-sets-autoscale-portal.md) или с помощью [Azure CLI 2.0](virtual-machine-scale-sets-autoscale-cli.md).


## <a name="prerequisites"></a>Технические условия
Чтобы создать правила автомасштабирования, вам понадобится имеющийся масштабируемый набор виртуальных машин. Вы можете создать его с помощью [портала Azure](virtual-machine-scale-sets-create-portal.md), [Azure PowerShell](virtual-machine-scale-sets-create-powershell.md) или [Azure CLI 2.0](virtual-machine-scale-sets-create-cli.md).

Чтобы упростить создание правил автомасштабирования, определите некоторые переменные для масштабируемого набора. В примере ниже определены переменные для масштабируемого набора *myScaleSet* в группе ресурсов с именем *myResourceGroup* в регионе *восточная часть США*. Идентификатор подписки можно получить с помощью командлета [Get-AzureRmSubscription](/powershell/module/azurerm.profile/get-azurermsubscription). Если с вашей учетной записью связано несколько подписок, вернется только первая подписка. Измените имена и идентификатор подписки, как показано ниже:

```powershell
$mySubscriptionId = (Get-AzureRmSubscription).Id
$myResourceGroup = "myResourceGroupScaleSet"
$myScaleSet = "myScaleSet"
$myLocation = "East US"
```


## <a name="create-a-rule-to-automatically-scale-out"></a>Создание правила для автоматического масштабирования
При увеличении потребностей приложения в масштабируемом наборе увеличивается нагрузка на экземпляры виртуальной машины. Если такая увеличенная нагрузка представляет собой не просто краткий спрос, а является согласованной, можно настроить правила автомасштабирования, чтобы увеличить число экземпляров виртуальной машины в масштабируемом наборе. После создания этих экземпляров виртуальных машин и развертывания приложений масштабируемые наборы запускают распределение трафика между ними через подсистему балансировки нагрузки. Вы можете контролировать, какие метрики отслеживать, например ЦП или диск, продолжительность соответствия нагрузки приложения заданному пороговому значению, а также количество экземпляров виртуальной машины для добавления в масштабируемый набор.

Используя командлет [New-AzureRmAutoscaleRule](/powershell/module/AzureRM.Insights/New-AzureRmAutoscaleRule), создадим правило, в соответствии с которым количество экземпляров виртуальной машины в масштабируемом наборе увеличивается, когда средняя загрузка ЦП превышает 70 % в течение 5 минут. При активации правила количество экземпляров виртуальной машины увеличивается на 20 %. В масштабируемых наборах с небольшим числом экземпляров виртуальных машин можно опустить `-ScaleActionScaleType` и указать только `-ScaleActionValue`, чтобы увеличить это значение на *1* или *2* экземпляра. В этих же наборах с большим числом экземпляров виртуальных машин более оптимальным является увеличение на 10 или 20 % экземпляров.

Ниже приведены параметры, используемые для этого правила.

| Параметр               | Пояснение                                                                                                         | Значение          |
|-------------------------|---------------------------------------------------------------------------------------------------------------------|----------------|
| *-MetricName*           | Метрика производительности для мониторинга и применения действий в масштабируемом наборе.                                                   | Percentage CPU |
| *-TimeGrain*            | Определяет, как часто собираются показатели для анализа.                                                                   | 1 минута       |
| *-MetricStatistic*      | Определяет способ вычисления собранных метрик для анализа.                                                | Средние        |
| *-TimeWindow*           | Количество времени, в течение которого выполняется отслеживание перед сравнением значений метрик и пороговых значений.                                   | 10 минут      |
| *-Operator*             | Оператор для сравнения данных метрики с пороговым значением.                                                     | Больше чем   |
| *-Threshold*            | Значение, при достижении которого правило автомасштабирования запускает действие.                                                      | 70 %            |
| *-ScaleActionDirection* | Определяет действие, применяемое к масштабируемому набору при выполнении условий правила: увеличение или уменьшение числа экземпляров.                                             | Увеличить       |
| *-ScaleActionScaleType* | Указывает, что количество экземпляров виртуальных машин необходимо изменить, использовав процентное соотношение.                                 | Процентное изменение |
| *-ScaleActionValue*     | При активации правила должен измениться процент экземпляров виртуальных машин.                                            | 20             |
| *-ScaleActionCooldown*  | Время ожидания перед повторным применением правила, чтобы обеспечить время для активации действий автомасштабирования. | 5 мин      |

В следующем примере создается объект с именем *myRuleScaleOut*, содержащий это правило увеличения масштаба. *-MetricResourceId* использует переменные, определенные ранее для идентификатора подписки, имени группы ресурсов и имени масштабируемого набора:

```powershell
$myRuleScaleOut = New-AzureRmAutoscaleRule `
  -MetricName "Percentage CPU" `
  -MetricResourceId /subscriptions/$mySubscriptionId/resourceGroups/$myResourceGroup/providers/Microsoft.Compute/virtualMachineScaleSets/$myScaleSet `
  -TimeGrain 00:01:00 `
  -MetricStatistic Average `
  -TimeWindow 00:10:00 `
  -Operator GreaterThan `
  -Threshold 70 `
  -ScaleActionDirection Increase `
  –ScaleActionScaleType PercentChangeCount `
  -ScaleActionValue 20 `
  -ScaleActionCooldown 00:05:00
```


## <a name="create-a-rule-to-automatically-scale-in"></a>Создание правила для автоматического уменьшения числа экземпляров
В вечерние часы или выходные дни потребность в приложении может снизиться. Если такая сниженная нагрузка является согласованной в течение некоторого периода времени, можно настроить правила автомасштабирования, чтобы уменьшить число экземпляров виртуальных машин в масштабируемом наборе. Это действие снижает стоимость запуска масштабируемого набора, так как вы запускаете только то количество экземпляров, которое необходимо для удовлетворения текущего спроса.

Создайте правило, используя командлет [New-AzureRmAutoscaleRule](/powershell/module/AzureRM.Insights/New-AzureRmAutoscaleRule), в соответствии с которым количество экземпляров виртуальной машины в масштабируемом наборе уменьшается, когда средняя загрузка ЦП не превышает 30 % в течение 10 минут. При активации правила количество экземпляров виртуальных машин уменьшается на 20 %. В следующем примере создается объект с именем *myRuleScaleDown*, содержащий это правило увеличения масштаба. *-MetricResourceId* использует переменные, определенные ранее для идентификатора подписки, имени группы ресурсов и имени масштабируемого набора:

```powershell
$myRuleScaleIn = New-AzureRmAutoscaleRule `
  -MetricName "Percentage CPU" `
  -MetricResourceId /subscriptions/$mySubscriptionId/resourceGroups/$myResourceGroup/providers/Microsoft.Compute/virtualMachineScaleSets/$myScaleSet `
  -Operator LessThan `
  -MetricStatistic Average `
  -Threshold 30 `
  -TimeGrain 00:01:00 `
  -TimeWindow 00:10:00 `
  -ScaleActionCooldown 00:05:00 `
  -ScaleActionDirection Decrease `
  –ScaleActionScaleType PercentChangeCount `
  -ScaleActionValue 20
```


## <a name="define-an-autoscale-profile"></a>Определение профиля автомасштабирования
Чтобы сопоставить правила автомасштабирования с масштабируемым набором, необходимо создать профиль. Профиль автомасштабирования определяет минимальную и максимальную емкость масштабируемого набора, а также емкость по умолчанию и сопоставляет правила автомасштабирования. Создайте профиль автомасштабирования с помощью командлета [New-AzureRmAutoscaleProfile](/powershell/module/AzureRM.Insights/New-AzureRmAutoscaleProfile). В примере ниже задаются минимальная и максимальная емкости (*2* и *10*), а также емкость по умолчанию экземпляров виртуальной машины. Затем применяются правила увеличения и уменьшения масштаба, созданные ранее.

```powershell
$myScaleProfile = New-AzureRmAutoscaleProfile `
  -DefaultCapacity 2  `
  -MaximumCapacity 10 `
  -MinimumCapacity 2 `
  -Rules $myRuleScaleOut,$myRuleScaleIn `
  -Name "autoprofile"
```


## <a name="apply-autoscale-rules-to-a-scale-set"></a>Применение правил автомасштабирования к масштабируемому набору
Остается применить профиль автомасштабирования к масштабируемому набору. Затем станет возможным автоматическое увеличение и уменьшение масштаба в зависимости от потребностей приложения. Примените профиль автомасштабирования с помощью командлета [Add-AzureRmAutoscaleSetting](/powershell/module/AzureRM.Insights/Add-AzureRmAutoscaleSetting), как показано ниже:

```powershell
Add-AzureRmAutoscaleSetting `
  -Location $myLocation `
  -Name "autosetting" `
  -ResourceGroup $myResourceGroup `
  -TargetResourceId /subscriptions/$mySubscriptionId/resourceGroups/$myResourceGroup/providers/Microsoft.Compute/virtualMachineScaleSets/$myScaleSet `
  -AutoscaleProfiles $myScaleProfile
```


## <a name="monitor-number-of-instances-in-a-scale-set"></a>Мониторинг количества экземпляров в масштабируемом наборе
Чтобы увидеть количество и состояние экземпляров виртуальных машин, просмотрите список экземпляров в масштабируемом наборе, используя командлет [Get-AzureRmVmssVM](/powershell/module/AzureRM.Compute/Get-AzureRmVmssVM). Состояние указывает на подготовку экземпляра виртуальной машины по мере автоматического увеличения масштаба масштабируемого набора или отзыв подготовки по мере автоматического уменьшения масштаба. В примере ниже приведено состояние экземпляра виртуальной машины для масштабируемого набора с именем *myScaleSet* в группе ресурсов с именем *myResourceGroup*:

```powershell
Get-AzureRmVmssVM -ResourceGroupName "myResourceGroup" -VMScaleSetName "myScaleSet"
```


## <a name="autoscale-based-on-a-schedule"></a>Автомасштабирование на основе расписания
В примерах выше мы рассмотрели автоматическое масштабирование масштабируемого набора на основе основных метрик узла, например использования ЦП. Можно также создать правила автомасштабирования на основе расписания. Эти правила на основе расписания позволяют автоматически увеличивать количество экземпляров виртуальных машин перед ожидаемым увеличением потребностей приложения, например основными рабочими часами, а затем автоматически уменьшить количество экземпляров, когда потребность в использовании приложения снижается, например на выходных.

Чтобы создать правила автомасштабирования на основе расписания, а не метрик узла, используйте портал Azure. На сегодняшний день правила на основе расписания невозможно создать с помощью Azure PowerShell.


## <a name="next-steps"></a>Дальнейшие действия
Из этой статьи вы узнали, как использовать правила автомасштабирования для горизонтального масштабирования, а также как увеличивать или уменьшать *число* экземпляров виртуальных машин в масштабируемом наборе. Чтобы увеличить или уменьшить *размер* экземпляров виртуальных машин, вы также можете выполнить вертикальное масштабирование. Дополнительные сведения см. в статье [Вертикальное автомасштабирование масштабируемых наборов виртуальных машин](virtual-machine-scale-sets-vertical-scale-reprovision.md).

Сведения об управлении экземплярами виртуальных машин см. в статье [Управление масштабируемым набором виртуальных машин с помощью Azure PowerShell](virtual-machine-scale-sets-windows-manage.md).

Сведения о том, как создать оповещения при активации правил автомасштабирования, см. в статье [Использование действий автомасштабирования для отправки электронной почты и уведомлений об оповещениях веб-перехватчика в Azure Monitor](../monitoring-and-diagnostics/insights-autoscale-to-webhook-email.md). Вы также можете [использовать журналы аудита для отправки электронной почты и уведомлений об оповещениях веб-перехватчика в Azure Monitor](../monitoring-and-diagnostics/insights-auditlog-to-webhook-email.md).

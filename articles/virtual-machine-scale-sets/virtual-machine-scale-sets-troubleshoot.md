---
title: "Устранение неполадок при автомасштабировании масштабируемых наборов виртуальных машин | Документация Майкрософт"
description: "Устранение неполадок при автомасштабировании масштабируемых наборов виртуальных машин. Описание типичных проблем и способов их устранения."
services: virtual-machine-scale-sets
documentationcenter: 
author: gatneil
manager: jeconnoc
editor: 
tags: azure-resource-manager
ms.assetid: c7d87b72-ee24-4e52-9377-a42f337f76fa
ms.service: virtual-machine-scale-sets
ms.workload: na
ms.tgt_pltfrm: windows
ms.devlang: na
ms.topic: article
ms.date: 11/16/2017
ms.author: negat
ms.openlocfilehash: 02a3acf818bfca31a56b364f7abab97551e0d3f0
ms.sourcegitcommit: f46cbcff710f590aebe437c6dd459452ddf0af09
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/20/2017
---
# <a name="troubleshooting-autoscale-with-virtual-machine-scale-sets"></a>Устранение неполадок при автомасштабировании масштабируемых наборов виртуальных машин
**Описание проблемы**. Вы создали в Azure Resource Manager инфраструктуру автомасштабирования с помощью масштабируемых наборов виртуальных машин (например, развернув шаблон, похожий на этот: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale) и установили определенные правила масштабирования. Все работает великолепно, но независимо от уровня нагрузки на виртуальные машины автомасштабирование не выполняется.

## <a name="troubleshooting-steps"></a>Действия по устранению неполадок
Вот некоторые моменты, которые следует проверить в такой ситуации.

* Сколько виртуальных ЦП у каждой виртуальной машины и все ли они загружены?
  В приведенном выше примере шаблона быстрой настройки Azure есть сценарий do_work.php, который загружает один виртуальный ЦП. Если вы используете более крупные виртуальные машины с несколькими виртуальными ЦП, например Standard_A1 и D1, такую загрузку следует запускать несколько раз. Узнать количество виртуальных ЦП в виртуальных машинах вам поможет статья [Размеры виртуальных машин Windows в Azure](../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).
* Сколько виртуальных машин в вашем масштабируемом наборе виртуальных машин и все ли они выполняют работу?
  
    Событие развертывания происходит только тогда, когда средняя загрузка ЦП для **всех** виртуальных машин в наборе масштабирования превышает пороговое значение в течение определенного интервала, который установлен в правилах автомасштабирования.
* Возможно, вы пропустили события масштабирования?
  
    Проверьте, нет ли записей о событиях масштабирования в журналах аудита на портале Azure. Возможно, вы пропустили произошедшее увеличение или уменьшение масштаба. Можно отфильтровать элементы по масштабу.
  
    ![Журналы аудита][audit]
* Отличаются ли пороговые значения для увеличения и уменьшения масштаба?
  
    Предположим, что вы установили такие правила: увеличивать масштаб, если средняя загрузка ЦП в течение 50 минут превышает 50 %; уменьшать масштаб, если средняя загрузка ЦП меньше 50 %. Такая конфигурация приводит к нестабильности. Когда загрузка ЦП приблизится к пороговому значению, действия по увеличению и уменьшению масштаба будут выполняться постоянно, непрерывно изменяя размер набора. Служба автомасштабирования пытается предотвратить эту проблему, и в результате масштабирование может не выполняться вовсе. Поэтому убедитесь, что пороговые значения для действий по увеличению и уменьшению масштаба ощутимо отличаются.
* Вы сами написали шаблон JSON?
  
    В нем легко допустить ошибку. Мы рекомендуем взять за основу уже готовый и проверенный шаблон (например, см. приведенный выше), а затем поэтапно вносить в него небольшие изменения. 
* Можете ли вы выполнить увеличение или уменьшение масштаба вручную?
  
    Попробуйте вручную изменить количество виртуальных машин в масштабируемом наборе виртуальных машин. Для этого повторно разверните ресурс набора, указав другое значение для параметра capacity. Здесь вы найдете пример шаблона: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-scale-existing. Если потребуется, измените этот шаблон, чтобы в нем был указан тот же размер виртуальных машин, который используется в вашем масштабируемом наборе. Если вам удается изменить количество виртуальных машин вручную, значит, проблема связана именно с автомасштабированием.
* Проверьте ресурсы Microsoft.Compute/virtualMachineScaleSet и Microsoft.Insights в [обозревателе ресурсов Azure](https://resources.azure.com/)
  
    Обозреватель ресурсов Azure — это незаменимый инструмент для устранения неполадок, в котором отображается состояние ресурсов Azure Resource Manager. Откройте свою подписку и обратите внимание на группу ресурсов, в которой вы устраняете неполадки. В разделе поставщика вычислительных ресурсов найдите созданный масштабируемый набор виртуальных машин и откройте для него представление экземпляра. Здесь вы увидите состояние развертывания набора. Также проверьте представление экземпляра для виртуальных машин, входящих в масштабируемый набор виртуальных машин. Затем перейдите к поставщику ресурса Microsoft.Insights и проверьте, правильно ли там указаны правила автомасштабирования.
* Работает ли расширение службы диагностики и отправляет ли оно данные о производительности?
  
    **Обновление**. Автомасштабирование Azure усовершенствовано для использования конвейера метрик на основе узла, для которого больше не требуется устанавливать расширение системы диагностики. Это значит, что при создании приложения для автомасштабирования с помощью нового конвейера следующие несколько разделов не пригодятся. Пример шаблонов Azure, которые были преобразованы для использования конвейера узла, доступны здесь: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale. 
  
    Для автомасштабирования рекомендуется использовать метрики на основе узла по следующим причинам.
  
  * Меньшее количество перемещаемых элементов, так как расширения диагностики устанавливать не нужно.
  * Простые шаблоны. Просто добавьте правила автомасштабирования аналитики в имеющийся шаблон масштабируемого набора.
  * Более надежная система отчетов и ускоренный запуск новых виртуальных машин.
    
    Вы можете продолжать использовать расширение системы диагностики, если вам требуются возможности составления отчетов и масштабирования диагностики памяти. Метрики на основе узла не позволяют формировать отчеты о памяти.
    
    Учитывая только что сказанное, следуйте указаниям в оставшейся части этой статьи, если вы все еще используете расширения системы диагностики для автомасштабирования.
    
    Автомасштабирование в Azure Resource Manager можно (но не нужно) выполнять с использованием расширения виртуальной машины, которое называется расширением системы диагностики. Это расширение передает данные о производительности в учетную запись хранения, которая указана в шаблоне. Затем служба Azure Monitor обрабатывает эти данные.
    
    Если службе Insights не удается считать данные из виртуальных машин, она должна отправить вам сообщение. Например, вы можете получить сообщение, если виртуальные машины не работают. Обязательно проверяйте сообщения в почтовом ящике, адрес которого вы указали при создании учетной записи Azure.
    
    Также вы можете самостоятельно проверить эти данные. Откройте учетную запись хранения Azure в Cloud Explorer. Например, с помощью [Visual Studio Cloud Explorer](https://visualstudiogallery.msdn.microsoft.com/aaef6e67-4d99-40bc-aacf-662237db85a2) войдите в систему и выберите подписку Azure, которую вы используете. Затем просмотрите имя учетной записи хранения системы диагностики, указанное в определении расширения системы диагностики в шаблоне развертывания.
    
    ![Cloud Explorer][explorer]
    
   Вы увидите множество таблиц, в которых хранятся данные, собранные из каждой виртуальной машины. Давайте для примера выберем виртуальную машину Linux и метрику загрузки процессора. Посмотрите на последние строки. Visual Studio Cloud Explorer поддерживает язык запросов, поэтому можно выполнить запрос. Например, можно выполнить запрос "Timestamp gt datetime’2016-02-02T21:20:00Z", чтобы получить самые последние события. Часовой пояс указывается в формате UTC. Соответствуют ли выбранным правилам масштабирования те данные, которые вы здесь видите? В приведенном ниже примере загрузка ЦП для виртуальной машины 20 за последние 5 минут поднялась до уровня 100 %.
    
    ![Таблицы хранилища][tables]
    
    Если данных здесь нет, это значит, что проблема связана с расширением системы диагностики, которое запущено на виртуальных машинах. Если данные есть, проблема вызвана ошибкой в правилах масштабирования или в службе аналитики. Проверьте [состояние Azure](https://azure.microsoft.com/status/).
    
    Если после выполнения этих действий по-прежнему возникают проблемы автомасштабирования, можно попробовать найти решение в следующих источниках: 
    * Ознакомьтесь с форумами на сайтах [MSDN](https://social.msdn.microsoft.com/forums/azure/home?category=windowsazureplatform%2Cazuremarketplace%2Cwindowsazureplatformctp) или [Stack Overflow](http://stackoverflow.com/questions/tagged/azure). 
    * Зарегистрируйте обращение в службу поддержки. Подготовьте шаблон и представление данных о производительности, чтобы предоставить их.

[audit]: ./media/virtual-machine-scale-sets-troubleshoot/image3.png
[explorer]: ./media/virtual-machine-scale-sets-troubleshoot/image1.png
[tables]: ./media/virtual-machine-scale-sets-troubleshoot/image4.png

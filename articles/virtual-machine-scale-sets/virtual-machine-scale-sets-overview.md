---
title: "Обзор масштабируемых наборов виртуальных машин Azure | Документация Майкрософт"
description: "Сведения о масштабируемых наборах виртуальных машин Azure."
services: virtual-machine-scale-sets
documentationcenter: 
author: gbowerman
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 76ac7fd7-2e05-4762-88ca-3b499e87906e
ms.service: virtual-machine-scale-sets
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 07/03/2017
ms.author: guybo
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 8b2fbc230faf01797109114d6ebdffe5ec50e48b
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="what-are-virtual-machine-scale-sets-in-azure"></a>Общие сведения о масштабируемых наборах виртуальных машин в Azure
Масштабируемые наборы виртуальных машин относятся к вычислительным ресурсам Azure. Их можно использовать для развертывания набора идентичных виртуальных машин и управления им. Так как все виртуальные машины настроены одинаково, масштабируемые наборы позволяют выполнять действительно автоматическое масштабирование, ведь предварительная подготовка виртуальных машин не требуется. Это упрощает создание крупномасштабных служб, предназначенных для больших вычислений, больших данных и контейнерных рабочих нагрузок.

Для приложений, которые нуждаются в масштабировании вычислительных ресурсов, операции масштабирования неявно распределяются между доменами сбоя и доменами обновления. Общие сведения о наборах масштабирования виртуальных машин см. в этом [объявлении в блоге Azure](https://azure.microsoft.com/blog/azure-virtual-machine-scale-sets-ga/).

Дополнительные сведения о масштабируемых наборах см. в этих видео:

* [Марк Руссинович (Mark Russinovich) рассказывает о масштабируемых наборах Azure.](https://channel9.msdn.com/Blogs/Regular-IT-Guy/Mark-Russinovich-Talks-Azure-Scale-Sets/)  
* [Масштабируемые наборы виртуальных машин с Гаем Бауэрманом (Guy Bowerman).](https://channel9.msdn.com/Shows/Cloud+Cover/Episode-191-Virtual-Machine-Scale-Sets-with-Guy-Bowerman)

## <a name="creating-and-managing-scale-sets"></a>Создание масштабируемых наборов и управление ими
Масштабируемый набор можно создать на [портале Azure](https://portal.azure.com), щелкнув **Создать** и введя в строке поиска слово **scale**. В результатах поиска отобразится **Набор масштабирования виртуальной машины**. Здесь вы можете заполнить обязательные поля для настройки и развертывания масштабируемого набора. На портале также можно настроить основные правила автомасштабирования на основе использования ЦП.

Масштабируемые наборы можно определять и развертывать с помощью шаблонов JSON и интерфейсов [REST API](https://msdn.microsoft.com/library/mt589023.aspx) так же, как и отдельные виртуальные машины Azure Resource Manager. Поэтому можно использовать любые стандартные методы развертывания Azure Resource Manager. Дополнительную информацию о шаблонах см. в статье [Создание шаблонов диспетчера ресурсов Azure](../azure-resource-manager/resource-group-authoring-templates.md).

Набор примеров шаблонов для масштабируемых наборов виртуальных машин можно найти в разделе о [шаблонах быстрого запуска Azure в репозитории GitHub](https://github.com/Azure/azure-quickstart-templates). (Ищите шаблоны со словом **vmss** в названии).

В примерах использования шаблонов быстрого запуска кнопка "Развернуть в Azure" в файле сведений для каждого шаблона связана с функцией развертывания портала. Чтобы развернуть масштабируемый набор, нажмите кнопку, а затем укажите на портале все необходимые параметры. 

## <a name="scaling-a-scale-set-out-and-in"></a>Уменьшение или увеличение масштаба масштабируемого набора
Чтобы изменить число виртуальных машин в масштабируемом наборе, в разделе **Параметры**  щелкните **Масштабирование**. 

Емкость масштабируемого набора можно также изменить в командной строке с помощью команды **scale** в [Azure CLI](https://github.com/Azure/azure-cli). Например, чтобы изменить размер масштабируемого набора до 10 виртуальных машин, выполните следующую команду:

```bash
az vmss scale -g resourcegroupname -n scalesetname --new-capacity 10 
```

Кроме того, количество виртуальных машин в масштабируемом наборе можно изменить с помощью команды PowerShell **Update-AzureRmVmss**:

```PowerShell
$vmss = Get-AzureRmVmss -ResourceGroupName resourcegroupname -VMScaleSetName scalesetname  
$vmss.Sku.Capacity = 10
Update-AzureRmVmss -ResourceGroupName resourcegroupname -Name scalesetname -VirtualMachineScaleSet $vmss
```

Чтобы увеличить или уменьшить число виртуальных машин в масштабируемом наборе с помощью шаблона Azure Resource Manager, измените свойство **capacity** и повторно разверните шаблон. Это упрощает интеграцию масштабируемых наборов с функцией автоматического масштабирования Azure, а также облегчает создание собственного пользовательского уровня масштабирования, если требуется задать события пользовательского масштабирования, не поддерживаемые упомянутой функцией. 

При повторном развертывании шаблона Azure Resource Manager для изменения емкости можно задать гораздо меньший шаблон, который будет включать только пакет свойств **SKU** и обновленную емкость. [Ниже приведен пример](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-scale-existing).

## <a name="autoscale"></a>Autoscale

При необходимости во время создания масштабируемого набора на портале Azure можно также настроить параметры автомасштабирования. Это позволяет увеличивать или уменьшать количество виртуальных машин на основе среднего показателя использования ЦП. 

Во многих из шаблонов масштабируемых наборов в коллекции [шаблонов быстрого запуска Azure](https://github.com/Azure/azure-quickstart-templates) определены параметры автомасштабирования. Параметры автомасштабирования можно также добавить в имеющийся масштабируемый набор. Например, следующий скрипт Azure PowerShell добавляет параметры автомасштабирования на основе показателей использования ЦП:

```PowerShell

$subid = "yoursubscriptionid"
$rgname = "yourresourcegroup"
$vmssname = "yourscalesetname"
$location = "yourlocation" # e.g. southcentralus

$rule1 = New-AzureRmAutoscaleRule -MetricName "Percentage CPU" -MetricResourceId /subscriptions/$subid/resourceGroups/$rgname/providers/Microsoft.Compute/virtualMachineScaleSets/$vmssname -Operator GreaterThan -MetricStatistic Average -Threshold 60 -TimeGrain 00:01:00 -TimeWindow 00:05:00 -ScaleActionCooldown 00:05:00 -ScaleActionDirection Increase -ScaleActionValue 1
$rule2 = New-AzureRmAutoscaleRule -MetricName "Percentage CPU" -MetricResourceId /subscriptions/$subid/resourceGroups/$rgname/providers/Microsoft.Compute/virtualMachineScaleSets/$vmssname -Operator LessThan -MetricStatistic Average -Threshold 30 -TimeGrain 00:01:00 -TimeWindow 00:05:00 -ScaleActionCooldown 00:05:00 -ScaleActionDirection Decrease -ScaleActionValue 1
$profile1 = New-AzureRmAutoscaleProfile -DefaultCapacity 2 -MaximumCapacity 10 -MinimumCapacity 2 -Rules $rule1,$rule2 -Name "autoprofile1"
Add-AzureRmAutoscaleSetting -Location $location -Name "autosetting1" -ResourceGroup $rgname -TargetResourceId /subscriptions/$subid/resourceGroups/$rgname/providers/Microsoft.Compute/virtualMachineScaleSets/$vmssname -AutoscaleProfiles $profile1
```

Список допустимых метрик масштабирования см. в статье [Метрики, поддерживаемые Azure Monitor](../monitoring-and-diagnostics/monitoring-supported-metrics.md) в разделе Microsoft.Compute/virtualMachineScaleSets. Кроме того, вы также можете настроить дополнительные параметры автомасштабирования, в том числе автомасштабирование на основе расписания, и выполнить интеграцию с системами оповещений, используя объекты webhook.

## <a name="monitoring-your-scale-set"></a>Мониторинг масштабируемого набора
На [портале Azure](https://portal.azure.com) перечислены масштабируемые наборы и показаны их свойства. Портал также поддерживает операции управления. Вы можете их выполнять и в масштабируемых наборах, и на отдельных виртуальных машинах в наборе. Кроме того, на портале также можно просмотреть настраиваемый график использования ресурсов. 

Чтобы просмотреть или изменить базовое определение JSON ресурса Azure, можно использовать [обозреватель ресурсов Azure](https://resources.azure.com). Масштабируемые наборы принадлежат к ресурсам Microsoft.Compute поставщика ресурсов Azure. Чтобы просмотреть их отсюда, выберите следующее:

**Подписки** > **ваша подписка** > **resourceGroups** > **поставщики** > **Microsoft.Compute** > **virtualMachineScaleSets** > **ваш масштабируемый набор** и т. д.

## <a name="scale-set-scenarios"></a>Сценарии масштабируемого набора
В этом разделе перечислены стандартные сценарии с участием масштабируемых наборов. Эти сценарии используются в некоторых службах Azure более высокого уровня (таких как пакетная служба, Service Fabric и Служба контейнеров).

* **Использование RDP или SSH для подключения к экземплярам масштабируемых наборов**. Масштабируемый набор создается внутри виртуальной сети. При этом отдельным виртуальным машинам в наборе не выделяются общедоступные IP-адреса по умолчанию. Эта политика позволяет избежать дополнительных затрат и расходов на управление выделением отдельных общедоступных IP-адресов для всех узлов в сетке вычислений. Если требуется направить внешние подключения к масштабируемому набору виртуальных машин, можно настроить, чтобы в масштабируемом наборе общедоступные IP-адреса автоматически назначались новым виртуальным машинам. Кроме того, к этим виртуальным машинам можно подключиться из других ресурсов с выделенными общедоступными IP-адресами в виртуальной сети, например из подсистем балансировки нагрузки и автономных виртуальных машин. 
* **Подключение к виртуальной машине с помощью правил преобразования сетевых адресов (NAT).** Вы можете создать общедоступный IP-адрес, назначить его балансировщику нагрузки и определить правила для входящих подключений пула NAT. Эти действия сопоставляют порт на IP-адресе с портом виртуальной машины из масштабируемого набора. Например:
  
  | Источник | Исходный порт | Место назначения | Конечный порт |
  | --- | --- | --- | --- |
  |  Общедоступный IP-адрес |Порт 50000 |vmss\_0 |Порт 22 |
  |  Общедоступный IP-адрес |Порт 50001 |vmss\_1 |Порт 22 |
  |  Общедоступный IP-адрес |Порт 50002 |vmss\_2 |Порт 22 |
  
   В [следующем примере](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-linux-nat) правила NAT разрешают SSH-подключения к каждой виртуальной машине в масштабируемом наборе с использованием одного общедоступного IP-адреса.
  
   [Этот пример](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-windows-nat) такой же схемы для RDP и Windows.
* **Подключение к виртуальной машине с помощью основной виртуальной машины.** Если в одной виртуальной сети создается масштабируемый набор и автономная виртуальная машина, эта машина и машины из набора могут подключаться друг к другу с помощью внутренних IP-адресов в соответствии с определением виртуальной сети или подсети. После создания и назначения общедоступного IP-адреса автономной виртуальной машине к ней можно будет подключиться по RDP или SSH. Затем из нее можно подключиться к экземплярам масштабируемого набора. На этом этапе вы могли заметить, что простой масштабируемый набор надежнее, чем автономная виртуальная машина с общедоступным IP-адресом, сконфигурированная по умолчанию.
  
   Например, [этот шаблон](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-linux-jumpbox) развертывает простой масштабируемый набор с использованием отдельной виртуальной машины. 
* **Балансировка нагрузки для экземпляров масштабируемого набора.** Чтобы передать работу вычислительному кластеру виртуальных машин с использованием метода циклического перебора, в Azure Load Balancer следует настроить соответствующие правила балансировки 4-го уровня. Вы можете настроить пробы, чтобы проверить работу приложения путем проверки связи с портами с помощью указанного протокола, интервала и пути запроса. [Шлюз приложений Azure](https://azure.microsoft.com/services/application-gateway/) также поддерживает наборы масштабирования, 7-й уровень и более сложные сценарии балансировки нагрузки.
  
   В [приведенном ниже примере](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-ubuntu-web-ssl) создается масштабируемый набор, выполняющий веб-серверы Apache. Кроме того, в нем используется балансировщик нагрузки для балансировки нагрузки, получаемой каждой виртуальной машиной. (Обратите внимание на тип ресурса Microsoft.Network/loadBalancers, а также на networkProfile и extensionProfile в virtualMachineScaleSet.)

   [В примере Linux](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-ubuntu-app-gateway) и [Windows](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-windows-app-gateway) используется шлюз приложений.  

* **Развертывание масштабируемого набора в качестве вычислительного кластера в диспетчере кластеров PaaS.** Иногда масштабируемые наборы называют рабочими ролями следующего поколения. Это вполне допустимое название, но вместе с тем существует риск перепутать функции масштабируемого набора с функциями облачных служб Azure. В этом смысле масштабируемые наборы предоставляют настоящую рабочую роль или рабочий ресурс. Они являются обобщенным вычислительным ресурсом, независимым от платформ и сред выполнения, который можно настроить и интегрировать с IaaS Azure Resource Manager.
  
   Рабочая роль облачных служб ограничена с точки зрения поддержки платформ и сред выполнения (только для образов платформы Windows). Но она также включает такие службы, как переключение виртуального IP-адреса, настраиваемые параметры обновления и определенные параметры развертывания для приложения или среды выполнения. Они либо *еще* недоступны в масштабируемых наборах, либо предоставляются другими службами PaaS более высокого уровня, например Azure Service Fabric. Масштабируемые наборы можно рассматривать как инфраструктуру, поддерживающую PaaS. Такие решения PaaS, как [Service Fabric](https://azure.microsoft.com/services/service-fabric/), созданы на основе этой инфраструктуры.
  
   В [примере использования](https://github.com/Azure/azure-quickstart-templates/tree/master/101-acs-dcos) с таким подходом [Служба контейнеров Azure](https://azure.microsoft.com/services/container-service/) развертывает кластер на основе масштабируемых наборов с оркестратором контейнеров.

## <a name="scale-set-performance-and-scale-guidance"></a>Рекомендации по производительности и масштабированию набора
* Масштабируемый набор поддерживает до 1000 виртуальных машин. При создании и отправке собственных пользовательских образов виртуальных машин ограничение составляет 100. Рекомендации по использованию больших масштабируемых наборов виртуальных машин см. в [этой статье](virtual-machine-scale-sets-placement-groups.md).
* Чтобы использовать масштабируемые наборы, вам не нужно заранее создавать учетные записи хранения Azure. Масштабируемые наборы поддерживают Управляемые диски Azure, что позволяет устранить проблемы с производительностью, связанные с количеством дисков на учетную запись хранения. Дополнительные сведения см. в статье [Масштабируемые наборы виртуальных машин Azure и управляемые диски](virtual-machine-scale-sets-managed-disks.md).
* Чтобы сократить время подготовки виртуальной машины, сделать этот процесс более прогнозируемым и улучшить производительность ввода-вывода, мы советуем использовать хранилище Azure класса Premium, а не службу хранилища Azure.
* Число создаваемых виртуальных машин ограничивается квотой ядер в регионе, в котором выполняется развертывание. Возможно, вам придется обратиться в службу поддержки, чтобы увеличить квоту на вычислительные ресурсы, даже если у вас установлен высокий предел ядер для использования с облачными службами Azure. Запрос на квоту можно отправить с помощью команды Azure CLI `azure vm list-usage` или команды PowerShell `Get-AzureRmVMUsage`.

## <a name="frequently-asked-questions-for-scale-sets"></a>Часто задаваемые вопросы о масштабируемых наборах
**Вопрос.** Сколько виртуальных машин может входить в масштабируемый набор?

**Ответ.** В масштабируемый набор может входить от 0 до 1000 виртуальных машин на основе образов платформ или от 0 до 100 виртуальных машин на основе пользовательских образов. 

**Вопрос.** Поддерживаются ли диски данных в масштабируемых наборах?

**Ответ.** Да. Масштабируемый набор может определять конфигурацию подключенных дисков с данными, применяемую ко всем виртуальным машинам в наборе. Дополнительные сведения см. в статье [Масштабируемые наборы ВМ Azure и подключенные диски данных](virtual-machine-scale-sets-attached-disks.md). Ниже перечислены другие варианты хранения данных.

* Файлы Azure (общие диски SMB).
* Диск операционной системы.
* временный диск (локальный, не поддерживаемый хранилищем Azure);
* Служба данных Azure (например, таблицы Azure, большие двоичные объекты Azure).
* внешняя служба данных (например, удаленная база данных).

**Вопрос.** Какие регионы Azure поддерживают масштабируемые наборы?

**Ответ.** Все регионы Azure поддерживают масштабируемые наборы.

**Вопрос.** Как создать масштабируемый набор с помощью пользовательского образа?

**Ответ.** Создайте управляемый диск на основе VHD-файла пользовательского образа и добавьте ссылку на него в шаблоне масштабируемого набора. [Ниже приведен пример](https://github.com/chagarw/MDPP/tree/master/101-vmss-custom-os).

**Вопрос.** Если уменьшить емкость масштабируемого набора с 20 до 15, какие виртуальные машины будут удалены?

**Ответ.** Для максимальной доступности виртуальные машины удаляются из масштабируемого набора в доменах обновления и доменах сбоя равномерно. Сначала удаляются виртуальные машины с самым высоким уровнем идентификатора.

**Вопрос.** Что будет, если затем увеличить емкость с 15 до 18?

**Ответ.** Если увеличить емкость до 18, то будут созданы 3 новые виртуальные машины. При этом идентификатор экземпляра виртуальной машины будет каждый раз увеличиваться, начиная с предыдущего наибольшего значения (например, 20, 21, 22). Виртуальные машины распределяются между доменами сбоя и обновления.

**Вопрос.** Можно ли указать последовательность выполнения при использовании нескольких расширений в масштабируемом наборе?

**Ответ.** Напрямую нет, но при использовании расширения customScript ваш скрипт может подождать, пока завершится выполнение другого расширения. Дополнительные рекомендации по виртуализации расширения см. в записи блога [Extension Sequencing in Azure VM Scale Sets](https://msftstack.wordpress.com/2016/05/12/extension-sequencing-in-azure-vm-scale-sets/) (Последовательность расширений в наборах масштабирования виртуальных машин Azure).

**Вопрос.** Работают ли масштабируемые наборы с группами доступности Azure?

**Ответ.** Да. Масштабируемый набор является неявной группой доступности с 5 доменами сбоя и 5 доменами обновления. Масштабируемые наборы с более 100 виртуальными машинами охватывают несколько *групп размещения*, которые эквивалентны нескольким наборам доступности. Дополнительные сведения о группах размещения см. в статье [Работа с крупными масштабируемыми наборами виртуальных машин](virtual-machine-scale-sets-placement-groups.md). Группа доступности виртуальных машин может находиться в той же виртуальной сети, что и набор масштабирования виртуальных машин. Типичная конфигурация — это такое размещение виртуальных машин узла управления, для которого часто требуется уникальная конфигурация в группе доступности и узлы данных в наборе масштабирования.

Дополнительные часто задаваемые вопросы о масштабируемых наборах виртуальных машин Azure см. в [этой статье](virtual-machine-scale-sets-faq.md).

---
title: "Маршрутизация aaaAsymmetric | Документы Microsoft"
description: "В этой статье рассматриваются hello проблем, которые могут появиться клиента с помощью асимметричного маршрутизации в сети, имеющей несколько назначения tooa ссылки."
documentationcenter: na
services: expressroute
author: osamazia
manager: carmonm
editor: 
ms.assetid: a754bff9-95c9-44b5-9796-377fc21e8322
ms.service: expressroute
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/10/2016
ms.author: osamam
ms.openlocfilehash: 01a16242437a3674dcfe27b074911a829a6c1abd
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="asymmetric-routing-with-multiple-network-paths"></a>Асимметричная маршрутизация с использованием нескольких сетевых путей
В этой статье объясняется, как прямой и обратный сетевой трафик может проходить по разным маршрутам, если между исходным и целевым сетевыми расположениями есть несколько путей.

Его важные toounderstand два понятия toounderstand асимметричного маршрутизации. Один является результатом hello нескольких сетевых путей. Hello других — как устройств, например межсетевой экран, сохранять состояние. Устройства такого типа называются устройствами с отслеживанием состояния. Сочетание этих двух факторов создает сценарии, в какой сетевой трафик удаляется с отслеживанием состояния устройства hello с отслеживанием состояния устройства не обнаруживают, что был начат трафика с само устройство hello.

## <a name="multiple-network-paths"></a>Несколько сетевых путей
Если в корпоративной сети имеет только один toohello связи, который проходит по Интернету через поставщика услуг Интернета, все tooand трафика из Интернета hello hello же путь. Часто компаниям покупок несколько каналов как избыточные пути tooimprove работы. В этом случае он возможно, что трафик, идущий за пределами сети hello, toohello Интернета, проходит через одну ссылку и hello возврата трафик проходит через различные ссылки. Это явление называется асимметричной маршрутизацией. В маршрутизации асимметричного обратного сетевого трафика принимает путь отличается от исходного потока hello.

![Сеть с несколькими путями](./media/expressroute-asymmetric-routing/AsymmetricRouting3.png)

Несмотря на то, что в первую очередь происходит на hello Интернета, асимметричные маршрутизации также применяется tooother сочетания нескольких путей. Он применяется, например, как tooan Интернета и частного пути, которые выходят toohello одним местом назначения и toomultiple частного пути, которые go toohello того же конечного расположения.

Каждый маршрутизатор вдоль способом hello из toodestination источника вычисляет лучший hello tooreach путь назначения. Hello маршрутизатора определение наиболее возможный путь зависит от двух основных факторов:

* Маршрутизация между внешними сетями реализуется с помощью протокола маршрутизации BGP. BGP принимает объявления из соседей и выполняет их через последовательность шагов toodetermine hello наиболее toohello предназначен конечный путь. Она хранит наилучший путь hello в свою таблицу маршрутизации.
* Длина маски подсети, связанные с маршрутом Hello влияет маршрутам. Если маршрутизатор получает несколько объявлений для hello же IP-адрес, но с разные маски подсети, маршрутизатор hello является предпочтительным для объявления hello и маску подсети больше времени, так как он считается более конкретный маршрут.

## <a name="stateful-devices"></a>Устройства с отслеживанием состояния
Маршрутизаторы просмотрите hello IP-заголовок пакета для целей маршрутизации. Некоторые устройства найдите глубоко внутри пакет приветствия. Как правило, эти устройства рассматривают заголовки на уровне 4 (протокол TCP либо UDP) или даже на уровне 7 (слой приложения). Это либо устройства для обеспечения безопасности, либо устройства для оптимизации пропускной способности. 

Распространенным примером устройства с отслеживанием состояния является брандмауэр. Брандмауэр разрешает или запрещает toopass пакетов через его интерфейсы на основе различных полей, таких как протокол, порт TCP/UDP и заголовки URL-адрес. Этот уровень проверки сетевых пакетов помещает интенсивную рабочую нагрузку на устройстве hello. производительность tooimprove hello брандмауэр проверяет hello первого пакета потока. Если он допускает tooproceed пакетов hello, здесь хранятся сведения потока hello в своей таблице состояний. Все последующие пакеты связанные toothis потока допускаются зависимости от определения начального приветствия. Пакет, который является частью существующего потока может начаться в брандмауэре hello. Если брандмауэр hello не содержит предыдущего состояния сведений о нем, брандмауэр hello удаляет пакет приветствия.

## <a name="asymmetric-routing-with-expressroute"></a>Асимметричная маршрутизация с помощью ExpressRoute
При подключении tooMicrosoft через Azure ExpressRoute изменения сети следующим образом:

* У вас есть несколько tooMicrosoft ссылки. Одна связь существующего подключения к Интернету, который hello других через ExpressRoute. Некоторые tooMicrosoft трафик может проходить через Интернет hello, но вернитесь через ExpressRoute, или наоборот.
* Вам присваиваются более конкретные IP-адреса через ExpressRoute. Таким образом для входящего трафика с tooMicrosoft вашей сети для служб, предложенных через ExpressRoute маршрутизаторы всегда рекомендуется использовать ExpressRoute.

эффект hello toounderstand имеет эти два изменения в сети, давайте рассмотрим некоторые сценарии. Например имеется только один канал toohello Интернета и использовать все службы Майкрософт через Интернет hello. Hello трафик от вашей сети tooMicrosoft и обратно перебирает hello же ссылку Интернет и проходит через брандмауэр hello. записи брандмауэра Hello hello потока, как она видит первого пакета hello и возвращать пакетов разрешены, так как существует hello потока из таблицы состояний hello.

![Асимметричная маршрутизация с помощью ExpressRoute](./media/expressroute-asymmetric-routing/AsymmetricRouting1.png)

Затем включите ExpressRoute для использования служб, предлагаемых корпорацией Майкрософт, через ExpressRoute. Все другие службы Майкрософт потребляются через Интернет hello. Развернуть отдельный брандмауэр границе, подключенных tooExpressRoute. Корпорация Майкрософт объявляет более конкретных сетевых префиксов tooyour через ExpressRoute для определенных служб. Инфраструктуру маршрутизации ExpressRoute выбирает в качестве предпочтительного пути hello для этих префиксов. Если не вы размещаете рекламу ваш открытый tooMicrosoft IP-адресов через ExpressRoute, Microsoft взаимодействует с вашей общих IP-адресов через Интернет hello. Перенаправлял трафик из вашей сети tooMicrosoft используется ExpressRoute, а обратный трафик от Microsoft hello Интернета. При hello брандмауэра на границе hello видит ответный пакет для потока, который не найден в таблице состояния hello, он сбрасывает hello ответного трафика.

При выборе hello toouse пул же преобразование сетевых адресов (NAT) для ExpressRoute и hello Интернета, вы увидите аналогичные проблемы с клиентами hello в сети на частных IP-адресов. Запросы для служб, таких как Центр обновления Windows перейти через Интернет hello, поскольку IP-адресов для этих служб не распространяются через ExpressRoute. Однако возвращаемый трафик hello возвращаются через ExpressRoute. Если корпорация Майкрософт получает IP-адрес с hello же маску подсети из Интернета hello и ExpressRoute, он предпочитает hello Интернет ExpressRoute. Если брандмауэр или другое устройство с отслеживанием состояния, в вашей сети и с выходом ExpressRoute нет предыдущих сведений о потоке hello, он удаляет приветственных пакетов, которые принадлежат toothat потока.

## <a name="asymmetric-routing-solutions"></a>Решения при асимметричной маршрутизации
У вас есть два основных варианта toosolve hello проблема асимметричного маршрутизации. Один — по маршрутизация, а hello другие — с помощью источника под управлением NAT (SNAT).

### <a name="routing"></a>Маршрутизация
Убедитесь, что открытый IP-адреса объявленной tooappropriate ссылкам глобальной сети (WAN). Например если требуется для проверки подлинности трафика и ExpressRoute toouse hello Internet mail трафика следует не объявляет общедоступные IP-адреса службы федерации Active Directory (AD FS) по ExpressRoute. Аналогичным образом, убедитесь, что не tooexpose значение локального адреса tooIP сервера AD FS, которые hello маршрутизатор получает по ExpressRoute. Маршрутов, полученных через ExpressRoute более различаются, поэтому они делают ExpressRoute hello предпочтительного пути для проверки подлинности трафика tooMicrosoft. Это приведет к асимметричной маршрутизации.

Следует toouse ExpressRoute для проверки подлинности, убедитесь, что вы размещаете рекламу общедоступные IP-адреса службы федерации Active Directory через ExpressRoute без NAT. Таким образом, трафик, исходит от корпорации Майкрософт и tooan выходит из локального сервера AD FS должен проходить через ExpressRoute. Возвращаемый трафик от клиента tooMicrosoft использует ExpressRoute, так как это предпочтительный маршрута hello через Интернет hello.

### <a name="source-based-nat"></a>NAT на основе источника
Еще один способ решения проблемы асимметричной маршрутизации — SNAT. Например вы не разгласили hello общедоступный IP-адрес локального сервера Simple Mail Transfer Protocol (SMTP) по ExpressRoute так, как планировалось hello toouse Интернета для этого типа обмена данными. Запрос, который поступил с корпорацией Майкрософт, а затем — tooyour в локальном hello Интернета, проходит через SMTP-сервер. Вы SNAT hello входящего запроса tooan внутренний IP-адрес. Обратный трафик с SMTP-сервера hello направляется toohello пограничным брандмауэром (который можно использовать преобразования сетевых адресов) вместо через ExpressRoute. Hello возвращаемого трафик направляется обратно через Интернет hello.

![Конфигурация сети во время SNAT](./media/expressroute-asymmetric-routing/AsymmetricRouting2.png)

## <a name="asymmetric-routing-detection"></a>Обнаружение асимметричной маршрутизации
Трассировка маршрута — hello лучшим способом toomake убедиться, что сетевым трафиком проходящий через hello Ожидался путь. Если ожидается трафика от вашей локальной SMTP сервера tooMicrosoft tootake hello Интернет-пути, hello ожидается, что трассировка маршрута из tooOffice сервера SMTP hello 365. результат Hello проверяет, что трафик на самом деле выходит из сети к Интернету hello, а не на ExpressRoute.


---
title: "Устранение неполадок производительности виртуальной сети Azure | Документы Microsoft"
description: "Эта страница предоставляет стандартный метод тестирования производительности ссылку сети Azure."
services: expressroute
documentationcenter: na
author: tracsman
manager: rossort
editor: 
ms.assetid: 
ms.service: expressroute
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 12/20/2017
ms.author: jonor
ms.openlocfilehash: 56f011632a2aa3ef0632efd5ace472c0fc79a329
ms.sourcegitcommit: a648f9d7a502bfbab4cd89c9e25aa03d1a0c412b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/22/2017
---
# <a name="troubleshooting-network-performance"></a>Устранение неполадок производительности сети
## <a name="overview"></a>Обзор
Azure предоставляет стабильный быстрые способы подключение из локальной сети в Azure. Методы, например через виртуальную Частную сеть для и ExpressRoute успешно используются клиентами больших и малых выполнения в Azure. Но что произойдет, если производительность не соответствует ожиданиях или опыте? В этом документе может помочь стандартный способ проверить и базовых конкретной среды.

В этом документе показано, легко и согласованное определение задержка сети и пропускную способность между двумя узлами. Этот документ также содержит некоторые рекомендации о способах рассмотрим сеть Azure, а также помогают изолировать проблемы точек. Сценарий PowerShell и средства, описанные требуют двух узлов сети (на любом конце тестируемой ссылки). Один узел должен быть Windows Server или рабочего стола, другой может быть Windows или Linux. 

>[!NOTE]
>Подход к устранению неполадок, средства и методы, используемые являются персональные настройки пользователя. Этот документ описывает подход часто занять и средства. Ваш подход, вероятно, будет отличаться, нет ничего плохого различные подходы к решению проблем. Тем не менее если у вас нет установленных подход, этот документ можно приступить к работе над путь построения методы, инструменты и параметры для устранения неполадок сети.
>
>

## <a name="network-components"></a>Сетевые компоненты
Прежде чем углубиться в устранении неполадок, давайте рассмотрим некоторые общие условия и компоненты. В этом описании гарантирует, что мы вы думаете о каждом из компонентов в цепочке начала до конца, который разрешает подключение в Azure.
[![1]][1]

На высоком уровне описывается три основных сетевой маршрутизации домена;

- сеть Azure (синий облако справа)
- Интернет или глобальной сети (зеленый облаком в центре)
- Корпоративной сети (персиковым облако в левой части экрана)

Глядя на диаграмме справа налево, давайте рассмотрим кратко каждого компонента:
 - **Виртуальные машины** - сервер может иметь несколько сетевых адаптеров, убедитесь, все статические маршруты, маршруты по умолчанию и отправляют параметры операционной системы и приема трафика способом, который вы считаете, что он является. Кроме того каждый SKU ВМ имеет ограничение пропускной способности. Если вы используете более мелкие SKU ВМ, трафика ограничен пропускную способность, доступную в сетевой адаптер. Обычно использовать DS5v2 для тестирования (и затем удаления, после этого с тестирование, чтобы сэкономить деньги), чтобы обеспечить необходимую пропускную способность в виртуальной Машине.
 - **Сетевой Адаптер** -убедитесь, вы знаете частных IP-адрес, назначенный сетевой Адаптер в вопросе.
 - **Сетевой Адаптер NSG** - возникли может быть конкретных Nsg, применяемый на уровне сетевого Адаптера, обеспечения NSG набор правил для трафика, который вы пытаетесь передать. Например, убедитесь порты 5201 для iPerf, 3389 для протокола удаленного рабочего СТОЛА, или 22 для SSH открыты, чтобы разрешить передачу трафика теста.
 - **Подсети виртуальной сети** -NIC назначены конкретной подсети, убедитесь, вы знаете, что один и правилами, связанными с данной подсетью.
 - **Подсети NSG** — так же, как сетевой Адаптер, Nsg можно применить также подсети. Убедитесь в наборе правил NSG подходит для трафика, который вы пытаетесь передать. (для трафика входящих подключений к сетевому Адаптеру, подсети, в которой сначала применяет NSG, а затем NSG сетевого Адаптера, и наоборот для трафика, исходящего из виртуальной Машины в Сетевых NSG применяется сначала затем NSG подсети вступает в действие).
 - **Подсети UDR** -определяемых пользователем маршрутов может направлять трафик к промежуточному узлу (например брандмауэра или подсистемы балансировки нагрузки). Убедитесь, что вы знаете, существует ли UDR трафика и если так адресаты и для трафика будет действия, следующего прыжка. (например, брандмауэр может передать некоторый трафик и запрещать другим трафик между двумя узлами, же).
 - **Подсеть шлюза / NSG / UDR** -так же, как подсети виртуальной Машины, может иметь подсеть шлюза, Nsg и UDRs. Убедитесь, что вы знаете, если они существуют, и последствия, которые они содержат для трафика.
 - **Шлюз виртуальной сети (ExpressRoute)** -после включения VPN или пиринга (ExpressRoute) не существует множество параметров, влияющих на как или, если трафик маршрутов. При наличии нескольких каналов ExpressRoute или VPN-туннели подключен с одним шлюзом виртуальной сети, вам следует иметь в виду вес параметров подключения от данного параметра влияет на подключения приоритета и влияет на путь, который принимает трафик.
 - **Направления фильтра** (не показано) - фильтр только применяется к Пиринга Майкрософт для ExpressRoute, но важно проверить, если вы не видите маршруты, предполагается, что на Пиринга Майкрософт. 

На этом этапе вы в глобальной сети часть ссылки. Этот домен маршрутизации может быть поставщиком услуг, глобальной корпоративной сети или в Интернете. Много прыжков, технологий и компаний, связанных с этими ссылками можно упростить сложно для устранения неполадок. Зачастую при работе с правило Azure и к корпоративным сетям сначала перед обращением к этой коллекции компаний и число прыжков.

На предыдущей схеме слева является вашей корпоративной сети. В зависимости от размера организации этот домен маршрутизации может быть несколько сетевых устройств, между пользователем и глобальной сети или несколько слоев устройств в группе соседних или корпоративной сети.

С учетом сложностей эти три различных высокого уровня сетевых средах, он часто является оптимальным решением будет запустить по краям и попытайтесь Показать, когда производительность является хорошим и где он приводит к снижению. Этот подход может помочь идентифицировать проблемы домен маршрутизации из трех и затем сосредоточить внимание на этой конкретной среды.

## <a name="tools"></a>Средства
Большинство проблем сети могут быть проанализированы и изолированных с помощью основные средства, такие как ping и Трассировка маршрута. Очень редко, будет необходимо выполнить как анализ пакетов, таких как Wireshark глубоко. Для устранения неполадок с средств подключения к Azure (AzureCT) был разработан для размещения некоторые из этих средств в простой пакет. Для тестирования производительности, я предпочитаю использовать iPerf и PSPing. iPerf часто используемые средства и работает в большинстве операционных систем. iPerf хорошо подходит для основных производительность тестов и довольно прост в использовании. PSPing — это средство ping, разработанный компанией SysInternals. PSPing является простой способ выполнения проверки связи ICMP и TCP в одной команде также прост в использовании. Оба эти средства являются упрощенными и «установлены» просто, скопировав файлы в каталог на узле.

Все эти средства и методы оболочку в модуль PowerShell (AzureCT), который можно установить и использовать.

### <a name="azurect---the-azure-connectivity-toolkit"></a>AzureCT - Toolkit подключения к Azure
Модуль AzureCT PowerShell состоит из двух компонентов [тестирования доступности] [ Availability Doc] и [тестирование производительности][Performance Doc]. В этом документе будут только при тестировании производительности, поэтому следует сосредоточиться на две команды производительности ссылки в этом модуле PowerShell.

Существует три основных шага, использовать этот набор средств для тестирования производительности. (1) установите модуль PowerShell, 2) установите вспомогательные iPerf приложений и PSPing 3) выполните тест производительности.

1. Установка модуля PowerShell

    ```powershell
    (new-object Net.WebClient).DownloadString("https://aka.ms/AzureCT") | Invoke-Expression
    
    ```

    Эта команда загружает модуль PowerShell и устанавливает его локально.

2. Установка поддержки приложений
    ```powershell
    Install-LinkPerformance
    ```
    Эта команда AzureCT устанавливает iPerf и PSPing в новый каталог «C:\ACTTools», он также открывает порты брандмауэра Windows, чтобы разрешить ICMP и порта 5201 трафика (iPerf).

3. Выполнение теста производительности

    Во-первых на удаленном узле, необходимо установить и запустить iPerf в режиме сервера. Обеспечьте наличие удаленного узла прослушивает либо 3389 (протокола удаленного рабочего СТОЛА для Windows) или 22 (SSH для Linux) и разрешение трафика на порт 5201 для iPerf. Если удаленному узлу windows, установите AzureCT и выполните команду LinkPerformance установки, чтобы настроить iPerf и правилами брандмауэра, необходимые для успешного запуска iPerf в режиме сервера. 
    
    После подготовки удаленного компьютера, откройте PowerShell на локальном компьютере и запуск теста:
    ```powershell
    Get-LinkPerformance -RemoteHost 10.0.0.1 -TestSeconds 10
    ```

    Эта команда выполняет серию параллельных нагрузочных тестов и тестов задержки, что позволяет оценить пропускная способность и задержки сети ссылки.

4. Просмотрите результаты тестов

    Формат вывода PowerShell выглядит примерно:

    [![4]][4]

    Сведения о результатах iPerf и PSPing тесты находятся в отдельных текстовых файлов в каталоге AzureCT средства «C:\ACTTools».

## <a name="troubleshooting"></a>Устранение неполадок
Если тест производительности не дает ожидаемых результатов, выяснить, почему следует прогрессивного пошаговый процесс. Учитывая количество компонентов в пути, систематический подход обычно обеспечивает быстрый путь разрешения, чем переходе вокруг и потенциально ненужной выполнении же тестирования несколько раз.

>[!NOTE]
>Данный сценарий является это проблемой производительности не разрыв подключения. Шаги будут отличаться, если вообще не было передачи трафика.
>
>

Во-первых запрос своих предположений. Целесообразно ваши ожидания? Для экземпляра при наличии канала ExpressRoute 1 Гбит/с и 100 мс задержки неразумно ожидать полного 1 Гбит/с трафика характеристиках производительности протокола TCP через сеть с высокой задержкой. В разделе [ссылается на раздел](#references) для дополнительные предположения по производительности.

Далее рекомендуем начать на границах доменов маршрутизации и попытайтесь изолировать эту проблему, в один основной домен маршрутизации. Корпоративной сети, глобальной сети или сети Azure. Пользователи часто обвиняйте «черного ящика» в пути, при blaming черный квадрат можно легко сделать, может значительно задерживать разрешение особенно в том случае, если фактически проблема заключается в области, что имеется возможность вносить изменения. Убедитесь, что сделать ваш комплексной экспертизы перед передачей поставщика услуг или поставщика услуг Интернета.

После определения основной домен маршрутизации, которая содержит проблему, следует создать диаграмму области в вопросе. На доске, «Блокнот» или Visio в виде схемы предоставляет конкретных «Битва карты» позволяет методический подход к дальнейшей изолировать проблемы. Планирование тестирования точек и обновить карту, как очистить областей или глубже в ходе выполнения тестирования.

Теперь, когда вы получите диаграмму, запустите разделите сеть на сегменты и сузить проблемы. Узнайте, где он работает и когда это не так. Двигаться точек тестирования, чтобы изолировать до компонент, вызвавший ошибку.

Кроме того не забудьте просмотреть другие слои модели OSI. Можно легко сосредоточиться на сеть и слои 1-3 (слои физических данных и сети), но проблемы также могут вверх в уровня 7 на уровне приложения. Сохранить Восприимчивость и проверьте предположения.

## <a name="advanced-expressroute-troubleshooting"></a>Расширенная Диагностика ExpressRoute
Если вы не уверены, где граница облако фактически является, изоляция компонентов Azure может быть достаточно сложным. При использовании ExpressRoute границей является сетевой компонент Microsoft Enterprise Edge (MSEE). **При использовании ExpressRoute**, MSEE является первой точки контакта в сети Майкрософт и последнего перехода, оставляя сети Майкрософт. При создании объекта соединения между шлюзом виртуальной сети и канал ExpressRoute реальных подключение к MSEE. Распознавание MSEE как первый или последний прыжка, (в зависимости от того, в каком направлении ты) крайне важна для изоляции проблем с сетью Azure либо доказать, что проблема заключается в Azure или более низком уровне, расположенным в глобальной сети или в корпоративной сети. 

[![2]][2]

>[!NOTE]
> Обратите внимание, что MSEE не находится в облаке Azure. На самом деле ExpressRoute на границе сети Майкрософт не были фактически в Azure. После установления соединения с ExpressRoute, чтобы MSEE вы подключены к сети корпорации Майкрософт, из него можно затем перейдите на любую из облачных служб, такие как Office 365 (с помощью Microsoft Пиринга) или Azure (с закрытого или Пиринга Майкрософт).
>
>

Если подключение двух виртуальных сетей (виртуальные сети A и B в схеме) **же** канал ExpressRoute можно выполнить ряд тестов, чтобы изолировать проблемы в Azure (или подтверждения, не находится в Azure)
 
### <a name="test-plan"></a>План тестирования
1. Запустите тест Get-LinkPerformance между VM1 и VM2. Этот тест предоставляет подробные сведения о, если проблема является локальным, или нет. Если этот тест создает допустимой задержки и пропускной способности результатов, можно пометить как хорошие локальной сети для виртуальной сети.
2. При условии, что в виртуальной локальной сети трафика является хорошим, выполнение теста Get-LinkPerformance между VM1 и VM3. Этот тест проверяет подключение через Microsoft network до MSEE и обратно в Azure. Если этот тест создает допустимой задержки и пропускной способности результатов, можно пометить как хорошие сети Azure.
3. Если исключить Azure, можно выполнить аналогичные последовательность тестов в корпоративной сети. Если, также проверяет также, пришло время для работы с поставщиком услуг или поставщика услуг Интернета, для диагностики подключения к глобальной сети. Пример: Выполнить этот тест, между двумя филиалов, или рабочего стола и сервере центра обработки данных. В зависимости от того, что вы тестируете, найти конечные точки (серверы, компьютеры, т. д.), можно использовать этот путь.

>[!IMPORTANT]
> Очень важно, что для каждого теста можно пометить время суток, при запуске теста и запишите результаты в общем расположении (мне нравится OneNote или Excel). Тестовые запуски должны иметь идентичные выходные данные, чтобы можно было сравнивать результирующие данные по тестовые запуски и имеет «дыры» в данных. Согласованность для нескольких тестов является основной причиной, что AzureCT использовать для устранения неполадок. Он не находится в сценарии точное загрузки, выполнении, а *магическое* является тот факт, что получено *согласованный результат теста и данных* из каждого теста. Записи времени и необходимости целостность данных при каждом один особенно полезно, если обнаружится, что проблема вызвана случайные. Требуют тщательного подхода с заранее сбора данных и позволяет избежать часов повторное тестирование сценариев (я узнал это сложный способ много лет назад).
>
>

## <a name="the-problem-is-isolated-now-what"></a>Данная проблема связана, что делать дальше?
Чем больше можно изолировать эту проблему проще решить, однако часто достижения точки, где с Устранение неполадок go глубину или дополнительные. Пример: перейдите по ссылке между поставщиком услуг перевода прыжков через Европы, но ожидаемый путь представляет все в Азии. Эта точка находится, когда следует обратиться за помощью. Кто попросить зависит от домена маршрутизации, обнаруженный проблему или даже лучше, если имеется возможность ограничить его вниз до указанного компонента.

Проблемы с корпоративной сетью вашей внутренней ИТ-отделом или поставщика услуг поддержки сети (который может быть изготовитель оборудования) можно для конфигурации устройства или восстановление оборудования.

Для глобальной сети результаты тестирования для управления доступом с поставщиком услуг или поставщика услуг Интернета может помочь получить их запуска и избежать охватываются же нуля, когда работа уже. Тем не менее не быть своим соображениям считают ненужными при необходимости проверьте результаты самостоятельно. «Доверия, но проверка» является хорошим принципом Устранение неполадок на основании других людей полученные результаты.

С помощью Azure после изолировать проблему на все подробности, вы можете, пришло время на ознакомление с [документации сети Azure] [ Network Docs] и затем, если по-прежнему требуется [в службу поддержки][Ticket Link].

## <a name="references"></a>Ссылки
### <a name="latencybandwidth-expectations"></a>Ожиданий задержки и пропускной способности
>[!TIP]
> Географические задержки (мили или километры) между конечными точками, которое вы тестируете является наибольшее компонента задержки. Хотя участвует задержки оборудования (физических и виртуальных компонентов, число прыжков, т. д.), geography показала компонент наибольшее Общая задержка при работе с подключениями к глобальной сети. Также важно отметить, что расстояние является расстояние волокна запуска не равномерной или расстояний для карты дорог. Это расстояние невероятно сложно получить с любой точностью. Поэтому обычно использовании калькулятора расстояние Город в Интернете и знать, что этот метод является мерой этот способ крайне неточной, но достаточно, чтобы задать общие предположения.
>
>

У меня при установке ExpressRoute в Сиэтле, штат Вашингтон в США. В следующей таблице показаны задержки и пропускной способности ли они тестирования в различных расположениях, в Azure. Предполагалось географической расстояние между завершения каждого теста.

Настройка теста:
 - Физический сервер под управлением Windows Server 2016 с 10 Гбит/с сетевого Адаптера, подключен к каналу ExpressRoute.
 - Цепь Premium ExpressRoute 10 Гбит/с в расположении, обозначена частного Пиринга включена.
 - Виртуальная сеть Azure со шлюзом UltraPerformance в указанном регионе.
 - Виртуальная машина DS5v2 под управлением Windows Server 2016 в виртуальной сети. ВМ был недоменных присоединен, построенная по умолчанию образ Azure (без оптимизации или настройки) с AzureCT установлен.
 - Тестирование было командой AzureCT Get-LinkPerformance с 5-минутного нагрузочного теста для каждого из шести тестовых запусков. Например: 

    ```powershell
    Get-LinkPerformance -RemoteHost 10.0.0.1 -TestSeconds 300
    ```
 - Поток данных для каждого теста было загрузки, поступающие от физического сервера в локальной среде (iPerf клиент в Сиэтле) до виртуальной Машины Azure (iPerf сервер в списке регион Azure).
 - Данные столбца «Задержка» — нет нагрузочного теста (TCP задержки теста без iPerf под управлением).
 - Данные столбца «Максимальная пропускная способность» — 16 TCP поток нагрузочного теста с размером 1 МБ.

[![3]][3]

### <a name="latencybandwidth-results"></a>Результаты задержки и пропускной способности
>[!IMPORTANT]
> Эти числа являются только общие ссылки. Влияют многие факторы, задержке и хотя эти значения, обычно согласованы со временем, условия в Azure или поставщиков услуг сети могут отправлять трафик через различные пути в любое время, таким образом можно затрагиваются задержка и пропускная способность. Как правило последствия этих изменений не позволяют существенные различия.
>
>

| | | | | | |
|-|-|-|-|-|-|
|ExpressRoute<br/>Расположение|Таблицы Azure<br/>Регион|Оценка<br/>Расстояние (км)|Latency|1 сеанса<br/>Пропускная способность|Максимальная<br/>Пропускная способность|
| Сиэтл; | Западный регион США 2        |    191 км |   5 мс | 262.0 Мбит/с |  3.74 Гбит/с | 21
| Сиэтл; | Запад США          |  1,094 км |  18 ms |  82.3 Мбит/с |  3.70 Гбит/с | 20
| Сиэтл; | Центральный регион США       |  2,357 км |  40 мс |  38.8 Мбит/с |  2,55 Гбит/с | 17
| Сиэтл; | Южно-центральный регион США |  2,877 км |  51 ms |  30.6 Мбит/с |  2.49 Гбит/с | 19
| Сиэтл; | Северо-центральный регион США |  2,792 км |  55 ms |  Более 27,7 Мбит/с |  2.19 Гбит/с | 18
| Сиэтл; | Восток США 2        |  3,769 км |  73 ms |  21.3 Мбит/с |  1,79 Гбит/с | 16
| Сиэтл; | Восток США          |  3,699 км |  74 ms |  21.1 Мбит/с |  1,78 Гбит/с | 15
| Сиэтл; | Восточная часть Японии       |  7,705 км | 106 ms |  14.6 Мбит/с |  1.22 Гбит/с | 28
| Сиэтл; | Южная часть Великобритании         |  7,708 км | 146 ms |  10.6 Мбит/с |   896 Мбит/с | 24
| Сиэтл; | Западная Европа      |  7,834 км | 153 ms |  10.2 Мбит/с |   761 Мбит/с | 23
| Сиэтл; | Восточная часть Австралии   | 12,484 км | 165 ms |   9.4 Мбит/с |   794 Мбит/с | 26
| Сиэтл; | Юго-Восточная Азия   | 12,989 км | 170 ms |   9.2 Мбит/с |   756 Мбит/с | 25
| Сиэтл; | Южная Бразилия *   | 10,930 км | 189 ms |   8.2 Мбит/с |   699 Мбит/с | 22
| Сиэтл; | Южная Индия      | 12,918 км | 202 ms |   7.7 Мбит/с |   634 Мбит/с | 27

\*Задержка для Бразилии представляет собой хороший пример, когда равномерной расстояние значительно отличается от волокон, запустите расстояние. Ожидается, что задержка бы окружения 160 мс, но фактически 189 корпорацией Майкрософт. Это отличие от Мои предположения может указывать на ошибку сети где-нибудь, но скорее всего, волокна выполнение не перейти к Бразилии, в виде прямой линии и имеет дополнительный 1000 км или это движения, чтобы получить Бразилия Сиэтла.

## <a name="next-steps"></a>Дальнейшие действия
1. Загрузить набор средств подключения к Azure из github на сайте [http://aka.ms/AzCT][ACT]
2. Следуйте инструкциям по [связать тестирования производительности][Performance Doc]

<!--Image References-->
[1]: ./media/expressroute-troubleshooting-network-performance/network-components.png "компоненты сети azure"
[2]: ./media/expressroute-troubleshooting-network-performance/expressroute-troubleshooting.png "по устранению проблем ExpressRoute"
[3]: ./media/expressroute-troubleshooting-network-performance/test-diagram.png "среда тестирования производительности"
[4]: ./media/expressroute-troubleshooting-network-performance/powershell-output.png "выходные данные PowerShell"

<!--Link References-->
[Performance Doc]: https://github.com/Azure/NetworkMonitoring/blob/master/AzureCT/PerformanceTesting.md
[Availability Doc]: https://github.com/Azure/NetworkMonitoring/blob/master/AzureCT/AvailabilityTesting.md
[Network Docs]: https://docs.microsoft.com/azure/index#pivot=services&panel=network
[Ticket Link]: https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview
[ACT]: http://aka.ms/AzCT












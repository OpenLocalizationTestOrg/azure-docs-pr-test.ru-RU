---
title: "Оптимизация маршрутизации ExpressRoute в Azure | Документация Майкрософт"
description: "В этой статье приведены сведения о том, как оптимизировать маршрутизацию при наличии нескольких каналов ExpressRoute, с помощью которых устанавливается подключение между сетью Майкрософт и корпоративной сетью."
documentationcenter: na
services: expressroute
author: charwen
manager: carmonm
editor: 
ms.assetid: fca53249-d9c3-4cff-8916-f8749386a4dd
ms.service: expressroute
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 04/06/2017
ms.author: charwen
ms.openlocfilehash: c3a85b9445d69330c3f6c7d298169efddb6ecca0
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="optimize-expressroute-routing"></a><span data-ttu-id="73172-103">Оптимизация маршрутизации ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="73172-103">Optimize ExpressRoute Routing</span></span>
<span data-ttu-id="73172-104">При наличии нескольких каналов ExpressRoute к сети Майкрософт можно подключиться по нескольким маршрутам.</span><span class="sxs-lookup"><span data-stu-id="73172-104">When you have multiple ExpressRoute circuits, you have more than one path to connect to Microsoft.</span></span> <span data-ttu-id="73172-105">Поэтому маршрутизация может быть неоптимальной, а это значит, что при передаче трафика из вашей сети в сеть Майкрософт и наоборот он будет проходить более длинный маршрут.</span><span class="sxs-lookup"><span data-stu-id="73172-105">As a result, suboptimal routing may happen - that is, your traffic may take a longer path to reach Microsoft, and Microsoft to your network.</span></span> <span data-ttu-id="73172-106">А это, в свою очередь, может стать причиной возникновения длительной задержки,</span><span class="sxs-lookup"><span data-stu-id="73172-106">The longer the network path, the higher the latency.</span></span> <span data-ttu-id="73172-107">которая прямо влияет на производительность приложения и работу пользователей.</span><span class="sxs-lookup"><span data-stu-id="73172-107">Latency has direct impact on application performance and user experience.</span></span> <span data-ttu-id="73172-108">В настоящей статье описана эта проблема и объясняется, как оптимизировать маршрутизацию с помощью стандартных технологий.</span><span class="sxs-lookup"><span data-stu-id="73172-108">This article will illustrate this problem and explain how to optimize routing using the standard routing technologies.</span></span>

## <a name="suboptimal-routing-from-customer-to-microsoft"></a><span data-ttu-id="73172-109">Неоптимальная маршрутизация от клиента к Майкрософт</span><span class="sxs-lookup"><span data-stu-id="73172-109">Suboptimal routing from customer to Microsoft</span></span>
<span data-ttu-id="73172-110">Рассмотрим проблему маршрутизации более детально на следующем примере.</span><span class="sxs-lookup"><span data-stu-id="73172-110">Let's take a close look at the routing problem by an example.</span></span> <span data-ttu-id="73172-111">Предположим, что есть два офиса, расположенных в США: один — в Лос-Анджелесе, а другой — в Нью-Йорке.</span><span class="sxs-lookup"><span data-stu-id="73172-111">Imagine you have two offices in the US, one in Los Angeles and one in New York.</span></span> <span data-ttu-id="73172-112">Эти офисы подключены к глобальной сети (WAN): либо к вашей собственной магистральной, либо к предоставленной поставщиком услуг VPN на базе IP-сети.</span><span class="sxs-lookup"><span data-stu-id="73172-112">Your offices are connected on a Wide Area Network (WAN), which can be either your own backbone network or your service provider's IP VPN.</span></span> <span data-ttu-id="73172-113">У вас есть два канала ExpressRoute: один — в западной части США, а другой — в восточной. Они также подключены к глобальной сети.</span><span class="sxs-lookup"><span data-stu-id="73172-113">You have two ExpressRoute circuits, one in US West and one in US East, that are also connected on the WAN.</span></span> <span data-ttu-id="73172-114">Очевидно, что подключение к сети Майкрософт можно установить по двум каналам.</span><span class="sxs-lookup"><span data-stu-id="73172-114">Obviously, you have two paths to connect to the Microsoft network.</span></span> <span data-ttu-id="73172-115">А теперь представьте, что и в западной, и в восточной части США расположены службы Azure (например, службы приложений Azure).</span><span class="sxs-lookup"><span data-stu-id="73172-115">Now imagine you have Azure deployment (for example, Azure App Service) in both US West and US East.</span></span> <span data-ttu-id="73172-116">Вы хотите подключить пользователей в Лос-Анджелесе к региону "Западная часть США", а пользователей в Нью-Йорке — к региону "Восточная часть США", так как администратор служб сообщил, что пользователи офисов используют ближайший регион Azure для оптимальной работы.</span><span class="sxs-lookup"><span data-stu-id="73172-116">Your intention is to connect your users in Los Angeles to Azure US West and your users in New York to Azure US East because your service admin advertises that users in each office access the nearby Azure services for optimal experiences.</span></span> <span data-ttu-id="73172-117">К сожалению, этот вариант оптимален только для пользователей восточного, но не западного побережья.</span><span class="sxs-lookup"><span data-stu-id="73172-117">Unfortunately, the plan works out well for the east coast users but not for the west coast users.</span></span> <span data-ttu-id="73172-118">Причина заключается в следующем.</span><span class="sxs-lookup"><span data-stu-id="73172-118">The cause of the problem is the following.</span></span> <span data-ttu-id="73172-119">Для каждого канала ExpressRoute объявляются префиксы: 23.100.0.0/16 — для канала в регионе "Восточная часть США" и 13.100.0.0/16 — для канала в регионе "Западная часть США" Azure.</span><span class="sxs-lookup"><span data-stu-id="73172-119">On each ExpressRoute circuit, we advertise to you both the prefix in Azure US East (23.100.0.0/16) and the prefix in Azure US West (13.100.0.0/16).</span></span> <span data-ttu-id="73172-120">Не зная, какой префикс относится к тому или иному региону, вы не сможете должным образом управлять маршрутизацией.</span><span class="sxs-lookup"><span data-stu-id="73172-120">If you don't know which prefix is from which region, you are not able to treat it differently.</span></span> <span data-ttu-id="73172-121">Глобальная сеть может распознать префиксы в качестве относящихся ближе к региону "Восточная часть США", чем к "Западная часть США" и направить трафик пользователей обоих офисов по каналу ExpressRoute в восточной части США.</span><span class="sxs-lookup"><span data-stu-id="73172-121">Your WAN network may think both of the prefixes are closer to US East than US West and therefore route both office users to the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="73172-122">В результате пользователи в Лос-Анджелесе будут недовольны качеством передачи данных.</span><span class="sxs-lookup"><span data-stu-id="73172-122">In the end, you will have many unhappy users in the Los Angeles office.</span></span>

![Проблема маршрутизации ExpressRoute 1. Неоптимальная маршрутизация от клиента к Майкрософт](./media/expressroute-optimize-routing/expressroute-case1-problem.png)

### <a name="solution-use-bgp-communities"></a><span data-ttu-id="73172-124">Решение. Использование сообщества BGP</span><span class="sxs-lookup"><span data-stu-id="73172-124">Solution: use BGP Communities</span></span>
<span data-ttu-id="73172-125">Чтобы оптимизировать маршрутизацию для обоих офисов, необходимо определить, какой префикс относится к региону Azure "Западная часть США", а какой — к региону "Восточная часть США".</span><span class="sxs-lookup"><span data-stu-id="73172-125">To optimize routing for both office users, you need to know which prefix is from Azure US West and which from Azure US East.</span></span> <span data-ttu-id="73172-126">Эти сведения кодируются с использованием [значений сообществ BGP](expressroute-routing.md).</span><span class="sxs-lookup"><span data-stu-id="73172-126">We encode this information by using [BGP Community values](expressroute-routing.md).</span></span> <span data-ttu-id="73172-127">Каждому региону Azure назначаются уникальные значения сообществ BGP, например 12076:51004 — восточной части США и 12076:51006 — западной.</span><span class="sxs-lookup"><span data-stu-id="73172-127">We've assigned a unique BGP Community value to each Azure region, e.g. "12076:51004" for US East, "12076:51006" for US West.</span></span> <span data-ttu-id="73172-128">Теперь, определив префикс для каждого региона Azure, можно настроить канал ExpressRoute, который необходимо использовать.</span><span class="sxs-lookup"><span data-stu-id="73172-128">Now that you know which prefix is from which Azure region, you can configure which ExpressRoute circuit should be preferred.</span></span> <span data-ttu-id="73172-129">Так как для обмена сведениями маршрутизации используется протокол BGP, маршрутизацией можно управлять, используя значения локального предпочтения BGP.</span><span class="sxs-lookup"><span data-stu-id="73172-129">Because we use the BGP to exchange routing info, you can use BGP's Local Preference to influence routing.</span></span> <span data-ttu-id="73172-130">В нашем примере для префикса 13.100.0.0/16 западной части США можно установить более высокое значение локального предпочтения, чем для префикса восточной части США, и точно так же можно установить более высокое значение локального предпочтения для префикса 23.100.0.0/16 восточной части США по сравнению с префиксом западной.</span><span class="sxs-lookup"><span data-stu-id="73172-130">In our example, you can assign a higher local preference value to 13.100.0.0/16 in US West than in US East, and similarly, a higher local preference value to 23.100.0.0/16 in US East than in US West.</span></span> <span data-ttu-id="73172-131">Эта конфигурация гарантирует, что когда доступно два маршрута к сети Майкрософт, для подключения к региону Azure "Западная часть США" пользователи в Лос-Анджелесе будут использовать канал ExpressRoute в западной части США, и аналогично для подключения к региону "Восточная часть США" пользователи в Нью-Йорке будут использовать канал ExpressRoute в восточной части США.</span><span class="sxs-lookup"><span data-stu-id="73172-131">This configuration will make sure that, when both paths to Microsoft are available, your users in Los Angeles will take the ExpressRoute circuit in US West to connect to Azure US West whereas your users in New York take the ExpressRoute in US East to Azure US East.</span></span> <span data-ttu-id="73172-132">Это обеспечивает оптимальную маршрутизацию на обоих сторонах.</span><span class="sxs-lookup"><span data-stu-id="73172-132">Routing is optimized on both sides.</span></span> 

![Решение проблемы маршрутизации ExpressRoute 1. Использование сообщества BGP](./media/expressroute-optimize-routing/expressroute-case1-solution.png)

> [!NOTE]
> <span data-ttu-id="73172-134">Локальное предпочтение также можно назначить для маршрутизации от клиента к виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="73172-134">The same technique, using Local Preference, can be applied to routing from customer to Azure Virtual Network.</span></span> <span data-ttu-id="73172-135">Мы не устанавливаем значение сообщества BGP для префиксов, объявленных в Azure для вашей сети.</span><span class="sxs-lookup"><span data-stu-id="73172-135">We don't tag BGP Community value to the prefixes advertised from Azure to your network.</span></span> <span data-ttu-id="73172-136">Тем не менее, так как известно, какое развертывание виртуальной сети ближе к каждому офису, можно настроить маршрутизаторы таким образом, чтобы они предпочитали один канал ExpressRoute другому.</span><span class="sxs-lookup"><span data-stu-id="73172-136">However, since you know which of your Virtual Network deployment is close to which of your office, you can configure your routers accordingly to prefer one ExpressRoute circuit to another.</span></span>
>
>

## <a name="suboptimal-routing-from-microsoft-to-customer"></a><span data-ttu-id="73172-137">Неоптимальная маршрутизация от Майкрософт к клиенту</span><span class="sxs-lookup"><span data-stu-id="73172-137">Suboptimal routing from Microsoft to customer</span></span>
<span data-ttu-id="73172-138">Рассмотрим еще один пример, когда подключения из сети Майкрософт проходят более длинный маршрут для подключения к вашей сети.</span><span class="sxs-lookup"><span data-stu-id="73172-138">Here is another example where connections from Microsoft take a longer path to reach your network.</span></span> <span data-ttu-id="73172-139">В этом случае используются Exchange Online и локальные серверы Exchange в [гибридной среде](https://technet.microsoft.com/library/jj200581%28v=exchg.150%29.aspx).</span><span class="sxs-lookup"><span data-stu-id="73172-139">In this case, you use on-premises Exchange servers and Exchange Online in a [hybrid environment](https://technet.microsoft.com/library/jj200581%28v=exchg.150%29.aspx).</span></span> <span data-ttu-id="73172-140">Офисы подключены к глобальной сети.</span><span class="sxs-lookup"><span data-stu-id="73172-140">Your offices are connected to a WAN.</span></span> <span data-ttu-id="73172-141">Для подключения к сети Майкрософт через каналы ExpressRoute объявлены префиксы локальных серверов обоих офисов.</span><span class="sxs-lookup"><span data-stu-id="73172-141">You advertise the prefixes of your on-premises servers in both of your offices to Microsoft through the two ExpressRoute circuits.</span></span> <span data-ttu-id="73172-142">При переносе почтовых ящиков Exchange Online будет инициировать подключения к локальным серверам.</span><span class="sxs-lookup"><span data-stu-id="73172-142">Exchange Online will initiate connections to the on-premises servers in cases such as mailbox migration.</span></span> <span data-ttu-id="73172-143">К сожалению, подключение к офису в Лос-Анджелесе перенаправляется на канал ExpressRoute в восточной части США, а затем весь трафик передается через весь континент обратно на западное побережье.</span><span class="sxs-lookup"><span data-stu-id="73172-143">Unfortunately, the connection to your Los Angeles office is routed to the ExpressRoute circuit in US East before traversing the entire continent back to the west coast.</span></span> <span data-ttu-id="73172-144">В этом случае причина та же, что и в первом примере.</span><span class="sxs-lookup"><span data-stu-id="73172-144">The cause of the problem is similar to the first one.</span></span> <span data-ttu-id="73172-145">Без соответствующих настроек сеть Майкрософт не распознает, какой префикс относится к восточной части США, а какой — к западной.</span><span class="sxs-lookup"><span data-stu-id="73172-145">Without any hint, the Microsoft network can't tell which customer prefix is close to US East and which one is close to US West.</span></span> <span data-ttu-id="73172-146">Возможно, что подключение к офису в Лос-Анджелесе будет установлено по неправильному каналу.</span><span class="sxs-lookup"><span data-stu-id="73172-146">It happens to pick the wrong path to your office in Los Angeles.</span></span>

![Проблема маршрутизации ExpressRoute 2. Неоптимальная маршрутизация от Майкрософт к клиенту](./media/expressroute-optimize-routing/expressroute-case2-problem.png)

### <a name="solution-use-as-path-prepending"></a><span data-ttu-id="73172-148">Решение. Использование атрибута AS PATH</span><span class="sxs-lookup"><span data-stu-id="73172-148">Solution: use AS PATH prepending</span></span>
<span data-ttu-id="73172-149">Эту проблему можно решить двумя способами.</span><span class="sxs-lookup"><span data-stu-id="73172-149">There are two solutions to the problem.</span></span> <span data-ttu-id="73172-150">Первый способ — это просто объявить локальный префикс канала в западной части США для офиса в Лос-Анджелесе (177.2.0.0/31) и в восточной части США для офиса в Нью-Йорке (177.2.0.2/31).</span><span class="sxs-lookup"><span data-stu-id="73172-150">The first one is that you simply advertise your on-premises prefix for your Los Angeles office, 177.2.0.0/31, on the ExpressRoute circuit in US West and your on-premises prefix for your New York office, 177.2.0.2/31, on the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="73172-151">В результате для подключения сети Майкрософт к каждому из офисов будет использоваться только один маршрут.</span><span class="sxs-lookup"><span data-stu-id="73172-151">As a result, there is only one path for Microsoft to connect to each of your offices.</span></span> <span data-ttu-id="73172-152">Это позволяет избежать возможной неоднозначности и оптимизировать маршрутизацию.</span><span class="sxs-lookup"><span data-stu-id="73172-152">There is no ambiguity and routing is optimized.</span></span> <span data-ttu-id="73172-153">В этом случае следует обдумать стратегию отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="73172-153">With this design, you need to think about your failover strategy.</span></span> <span data-ttu-id="73172-154">Если путь к сети Майкрософт через канал ExpressRoute по каким-либо причинам недоступен, необходимо убедиться, что Exchange Online может по-прежнему подключиться к вашим локальным серверам.</span><span class="sxs-lookup"><span data-stu-id="73172-154">In the event that the path to Microsoft via ExpressRoute is broken, you need to make sure that Exchange Online can still connect to your on-premises servers.</span></span> 

<span data-ttu-id="73172-155">Второе решение — вам также необходимо объявить префикс для обоих каналов ExpressRoute и, кроме того, предоставить сведения о том, какой префикс используется для каждого офиса.</span><span class="sxs-lookup"><span data-stu-id="73172-155">The second solution is that you continue to advertise both of the prefixes on both ExpressRoute circuits, and in addition you give us a hint of which prefix is close to which one of your offices.</span></span> <span data-ttu-id="73172-156">Так как Майкрософт поддерживает использование атрибута AS Path BGP, с его помощью можно управлять маршрутизацией.</span><span class="sxs-lookup"><span data-stu-id="73172-156">Because we support BGP AS Path prepending, you can configure the AS Path for your prefix to influence routing.</span></span> <span data-ttu-id="73172-157">В этом примере можно удлинить атрибут AS PATH для 172.2.0.0/31 в восточной части США, чтобы для передачи трафика, предназначенного для этого префикса, использовался канал ExpressRoute в западной части США (сеть Майкрософт будет определять маршрут к этому префиксу как более короткий в западной части.)</span><span class="sxs-lookup"><span data-stu-id="73172-157">In this example, you can lengthen the AS PATH for 172.2.0.0/31 in US East so that we will prefer the ExpressRoute circuit in US West for traffic destined for this prefix (as our network will think the path to this prefix is shorter in the west).</span></span> <span data-ttu-id="73172-158">Точно так же можно удлинить атрибут AS PATH для 172.2.0.2/31 в западной части США, чтобы использовать канал ExpressRoute в восточной части США.</span><span class="sxs-lookup"><span data-stu-id="73172-158">Similarly you can lengthen the AS PATH for 172.2.0.2/31 in US West so that we'll prefer the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="73172-159">Это позволит оптимизировать маршрутизацию для обоих офисов.</span><span class="sxs-lookup"><span data-stu-id="73172-159">Routing is optimized for both offices.</span></span> <span data-ttu-id="73172-160">Если один из каналов ExpressRoute недоступен, подключение Exchange Online к вашей сети будет установлено через другой канал ExpressRoute и вашу глобальную сеть.</span><span class="sxs-lookup"><span data-stu-id="73172-160">With this design, if one ExpressRoute circuit is broken, Exchange Online can still reach you via another ExpressRoute circuit and your WAN.</span></span> 

> [!IMPORTANT]
> <span data-ttu-id="73172-161">Для префиксов, полученных в пиринге Майкрософт, частные номера AS в атрибуте AS PATH удаляются.</span><span class="sxs-lookup"><span data-stu-id="73172-161">We remove private AS numbers in the AS PATH for the prefixes received on Microsoft Peering.</span></span> <span data-ttu-id="73172-162">Чтобы управлять маршрутизацией пиринга Майкрософт, в атрибут AS PATH необходимо добавить частные номера AS.</span><span class="sxs-lookup"><span data-stu-id="73172-162">You need to append public AS numbers in the AS PATH to influence routing for Microsoft Peering.</span></span>
> 
> 

![Решение проблемы маршрутизации ExpressRoute 2. Использование атрибута AS PATH](./media/expressroute-optimize-routing/expressroute-case2-solution.png)

> [!NOTE]
> <span data-ttu-id="73172-164">Хотя представленные здесь примеры предназначены для пиринга Майкрософт и общедоступного пиринга, их можно использовать и для частного пиринга.</span><span class="sxs-lookup"><span data-stu-id="73172-164">While the examples given here are for Microsoft and Public peerings, we do support the same capabilities for the Private peering.</span></span> <span data-ttu-id="73172-165">Кроме того, атрибут AS PATH можно использовать в отдельном канале ExpressRoute. Он влияет на выбор основного и дополнительного путей.</span><span class="sxs-lookup"><span data-stu-id="73172-165">Also, the AS Path prepending works within one single ExpressRoute circuit, to influence the selection of the primary and secondary paths.</span></span>
> 
> 

## <a name="suboptimal-routing-between-virtual-networks"></a><span data-ttu-id="73172-166">Неоптимальная маршрутизация виртуальных сетей</span><span class="sxs-lookup"><span data-stu-id="73172-166">Suboptimal routing between virtual networks</span></span>
<span data-ttu-id="73172-167">С помощью ExpressRoute вы можете обеспечить обмен данными между виртуальными сетями, связав их с каналом ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="73172-167">With ExpressRoute, you can enable Virtual Network to Virtual Network (which is also known as "VNet") communication by linking them to an ExpressRoute circuit.</span></span> <span data-ttu-id="73172-168">Если связать их с несколькими каналами ExpressRoute, это может вызвать неоптимальную маршрутизацию между виртуальными сетями.</span><span class="sxs-lookup"><span data-stu-id="73172-168">When you link them to multiple ExpressRoute circuits, suboptimal routing can happen between the VNets.</span></span> <span data-ttu-id="73172-169">Рассмотрим пример.</span><span class="sxs-lookup"><span data-stu-id="73172-169">Let's consider an example.</span></span> <span data-ttu-id="73172-170">У вас есть два канала ExpressRoute: один — в западной части США, а другой — в восточной.</span><span class="sxs-lookup"><span data-stu-id="73172-170">You have two ExpressRoute circuits, one in US West and one in US East.</span></span> <span data-ttu-id="73172-171">В каждом регионе имеется две виртуальные сети.</span><span class="sxs-lookup"><span data-stu-id="73172-171">In each region, you have two VNets.</span></span> <span data-ttu-id="73172-172">Веб-серверы развернуты в одной виртуальной сети, а серверы приложений — в другой.</span><span class="sxs-lookup"><span data-stu-id="73172-172">Your web servers are deployed in one VNet and application servers in the other.</span></span> <span data-ttu-id="73172-173">Чтобы обеспечить избыточность, вы связываете две виртуальные сети в каждом регионе с локальным каналом ExpressRoute и удаленным каналом ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="73172-173">For redundancy, you link the two VNets in each region to both the local ExpressRoute circuit and the remote ExpressRoute circuit.</span></span> <span data-ttu-id="73172-174">Как показано ниже, между виртуальными сетями существует по два пути.</span><span class="sxs-lookup"><span data-stu-id="73172-174">As can be seen below, from each VNet there are two paths to the other VNet.</span></span> <span data-ttu-id="73172-175">Виртуальным сетям неизвестно, какой канал ExpressRoute является локальным, а какой удаленным.</span><span class="sxs-lookup"><span data-stu-id="73172-175">The VNets don't know which ExpressRoute circuit is local and which one is remote.</span></span> <span data-ttu-id="73172-176">Так как для балансировки нагрузки трафика между сетями используется технология маршрутизации Equal-Cost-Multi-Path (ECMP), некоторые потоки трафика проходят более длинный маршрут и перенаправляются на удаленный канал ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="73172-176">Consequently as they do Equal-Cost-Multi-Path (ECMP) routing to load-balance inter-VNet traffic, some traffic flows will take the longer path and get routed at the remote ExpressRoute circuit.</span></span>

![Проблема маршрутизации ExpressRoute 3. Неоптимальная маршрутизация виртуальных сетей](./media/expressroute-optimize-routing/expressroute-case3-problem.png)

### <a name="solution-assign-a-high-weight-to-local-connection"></a><span data-ttu-id="73172-178">Решение. Назначение высокого веса для локального подключения</span><span class="sxs-lookup"><span data-stu-id="73172-178">Solution: assign a high weight to local connection</span></span>
<span data-ttu-id="73172-179">Решение простое.</span><span class="sxs-lookup"><span data-stu-id="73172-179">The solution is simple.</span></span> <span data-ttu-id="73172-180">Зная, где расположены виртуальные сети и каналы, вы можете определить, какой путь подходит для каждой виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="73172-180">Since you know where the VNets and the circuits are, you can tell us which path each VNet should prefer.</span></span> <span data-ttu-id="73172-181">В нашем примере для локального подключения нужно назначить более высокий вес, чем для удаленного (пример конфигурации см. [здесь](expressroute-howto-linkvnet-arm.md#modify-a-virtual-network-connection)).</span><span class="sxs-lookup"><span data-stu-id="73172-181">Specifically for this example, you assign a higher weight to the local connection than to the remote connection (see the configuration example [here](expressroute-howto-linkvnet-arm.md#modify-a-virtual-network-connection)).</span></span> <span data-ttu-id="73172-182">Когда виртуальная сеть получит префикс другой виртуальной сети из нескольких подключений, то для отправки трафика к префиксу будет использоваться подключение с более высоким весом.</span><span class="sxs-lookup"><span data-stu-id="73172-182">When a VNet receives the prefix of the other VNet on multiple connections it will prefer the connection with the highest weight to send traffic destined for that prefix.</span></span>

![Решение проблемы маршрутизации ExpressRoute 3. Назначение высокого веса для локального подключения](./media/expressroute-optimize-routing/expressroute-case3-solution.png)

> [!NOTE]
> <span data-ttu-id="73172-184">При использовании нескольких каналов ExpressRoute также можно управлять маршрутизацией от виртуальной сети к локальной. Вместо того чтобы использовать атрибут AS PATHS, описанный во втором сценарии, в этом случае необходимо назначить вес подключения.</span><span class="sxs-lookup"><span data-stu-id="73172-184">You can also influence routing from VNet to your on-premises network, if you have multiple ExpressRoute circuits, by configuring the weight of a connection instead of applying AS PATH prepending, a technique described in the second scenario above.</span></span> <span data-ttu-id="73172-185">При выборе способа отправки трафика для каждого префикса сначала просматривается вес подключения, а потом длина AS Path.</span><span class="sxs-lookup"><span data-stu-id="73172-185">For each prefix, we will always look at the connection weight before the AS Path length when deciding how to send traffic.</span></span>
>
>

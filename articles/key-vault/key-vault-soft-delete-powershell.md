---
ms.assetid: 
title: "Как использовать обратимое удаление в Azure Key Vault с помощью PowerShell"
description: "Примеры использования обратимого удаления с фрагментами кода для PowerShell."
services: key-vault
author: lleonard-msft
manager: mbaldwin
ms.service: key-vault
ms.topic: article
ms.workload: identity
ms.date: 08/21/2017
ms.author: alleonar
ms.openlocfilehash: 48569e31e6400e3ec8958e0bceda1fd3b72207ea
ms.sourcegitcommit: 2a70752d0987585d480f374c3e2dba0cd5097880
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/19/2018
---
# <a name="how-to-use-key-vault-soft-delete-with-powershell"></a>Как использовать обратимое удаление в Key Vault с помощью PowerShell

Функция обратимого удаления в Azure Key Vault позволяет восстанавливать удаленные хранилища и объекты хранилищ. В частности, обратимое удаление применяется в следующих сценариях:

- Поддержка восстанавливаемого удаления хранилища ключей
- Поддержка восстанавливаемого удаления объектов хранилища ключей (например, ключей, секретов и сертификатов).

## <a name="prerequisites"></a>предварительным требованиям

- Azure PowerShell 4.0.0 или более поздней версии. Если этот инструмент у вас не установлен, чтобы установить его и связать с подпиской Azure, прочитайте статью [Общие сведения об Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview). 

>[!NOTE]
> В вашу среду вместо правильной версии **может** загрузиться устаревшая версия хранилища ключей выходных данных файла форматирования PowerShell. Мы планируем обновить версию PowerShell і добавить в нее нужные исправления выходных данных файла форматирования. После этого мы обновим эту статью. Чтобы устранить эту проблему сейчас, сделайте следующее:
> - Если вы не видите, что свойство обратимого удаления (описанное в этом разделе) включено, используйте следующий запрос: `$vault = Get-AzureRmKeyVault -VaultName myvault; $vault.EnableSoftDelete`.


Дополнительные сведения о Key Vault для PowerShell см. в [справочнике по PowerShell для Azure Key Vault](https://docs.microsoft.com/powershell/module/azurerm.keyvault/?view=azurermps-4.2.0).

## <a name="required-permissions"></a>Необходимые разрешения

Операции Key Vault контролируются отдельно, посредством разрешений управления доступом на основе ролей (RBAC). Это осуществляется следующим образом.

| Операция | ОПИСАНИЕ | Разрешение пользователя |
|:--|:--|:--|
|список|Выводит список удаленных хранилищ ключей.|Microsoft.KeyVault/deletedVaults/read|
|Recover|Восстанавливает удаленное хранилище ключей.|Microsoft.KeyVault/vaults/write|
|Purge|Окончательно удаляет удаленное хранилище ключей и все его содержимое.|Microsoft.KeyVault/locations/deletedVaults/purge/action|

Дополнительные сведения о разрешениях и управлении доступом см. в разделе [Защита хранилища ключей](key-vault-secure-your-key-vault.md).

## <a name="enabling-soft-delete"></a>Включение обратимого удаления

Чтобы иметь возможность восстановить удаленное хранилище ключей или объекты, хранящиеся в хранилище ключей, для него необходимо сначала включить обратимое удаление.

### <a name="existing-key-vault"></a>Существующее хранилище ключей

Включите обратимое удаление для существующего хранилища ключей ContosoVault следующим образом. 

>[!NOTE]
>В настоящее время необходимо использовать операции с ресурсами Azure Resource Manager, чтобы записать свойство *enableSoftDelete* непосредственно в ресурс Key Vault.

```powershell
($resource = Get-AzureRmResource -ResourceId (Get-AzureRmKeyVault -VaultName "ContosoVault").ResourceId).Properties | Add-Member -MemberType "NoteProperty" -Name "enableSoftDelete" -Value "true"

Set-AzureRmResource -resourceid $resource.ResourceId -Properties $resource.Properties
```

### <a name="new-key-vault"></a>Новое хранилище ключей

Обратимое удаление для нового хранилища ключей включается во время создания путем добавления флага --enable-soft-delete в команду create.

```powershell
New-AzureRmKeyVault -VaultName "ContosoVault" -ResourceGroupName "ContosoRG" -Location "westus" -EnableSoftDelete
```

### <a name="verify-soft-delete-enablement"></a>Проверка включения обратимого удаления

Чтобы проверить, включено ли обратимое удаление в хранилище ключей, выполните команду *get* и в выходных данных найдите атрибут "Soft Delete Enabled?" и его значение (true или false).

```powershell
Get-AzureRmKeyVault -VaultName "ContosoVault"
```

## <a name="deleting-a-key-vault-protected-by-soft-delete"></a>Удаление хранилища ключей, защищенного с помощью обратимого удаления

Команда для удаления хранилища ключей остается прежней, но в зависимости от того, включено ли обратимое удаление, меняется ее поведение.

```powershell
Remove-AzureRmKeyVault -VaultName 'ContosoVault'
```

> [!IMPORTANT]
>Если выполнить предыдущую команду для хранилища ключей, в котором не включено обратимое удаление, оно и его содержимое будут окончательно удалены без возможности восстановления.

### <a name="how-soft-delete-protects-your-key-vaults"></a>Как обратимое удаление защищает хранилище ключей

Если обратимое удаление включено:

- При удалении хранилище ключей удаляется из соответствующей группы ресурсов и помещается в зарезервированное пространство имен, которое связано только с расположением, в котором было создано. 
- Объекты в удаленном хранилище ключей, такие как ключи, секреты и сертификаты, становятся недоступными и остаются таковыми, пока содержащее их хранилище ключей находится в удаленном состоянии. 
- DNS-имя хранилища ключей в удаленном состоянии остается зарезервированным, поэтому не удастся создать новое хранилище ключей с таким же именем.  

Чтобы просмотреть хранилища ключей в удаленном состоянии, связанные с вашей подпиской, можно выполнить следующую команду.

```powershell
PS C:\> Get-AzureRmKeyVault -InRemovedStateVault 

Name           : ContosoVault
Location             : westus
Id                   : /subscriptions/xxx/providers/Microsoft.KeyVault/locations/westus/deletedVaults/ContosoVault
Resource ID          : /subscriptions/xxx/resourceGroups/ContosoVault/providers/Microsoft.KeyVault/vaults/ContosoVault
Deletion Date        : 5/9/2017 12:14:14 AM
Scheduled Purge Date : 8/7/2017 12:14:14 AM
Tags                 :
```

*Идентификатор ресурса* в выходных данных — это исходный идентификатор ресурса данного хранилища. Так как это хранилище ключей теперь находится в удаленном состоянии, ресурс с таким идентификатором ресурса не существует. Поле *Id* (Идентификатор) поле может использоваться для определения ресурса при восстановлении или очистке. Поле *Scheduled Purge Date* (Запланированная дата очистки) указывает, когда хранилище будет окончательно удалено, если с ним не будет выполнено какое-либо действие. Срок хранения по умолчанию, используемый для вычисления *запланированной даты очистки*, составляет 90 дней.

## <a name="recovering-a-key-vault"></a>Восстановление хранилища ключей

Чтобы восстановить хранилище ключей, необходимо указать его имя, группу ресурсов и расположение. Запишите расположение и группу ресурсов удаленного хранилища ключей, так как их необходимо знать, чтобы осуществить восстановление.

```powershell
Undo-AzureRmKeyVaultRemoval -VaultName ContosoVault -ResourceGroupName ContosoRG -Location westus
```

После восстановления хранилища ключей вы получите новый ресурс с исходным идентификатором ресурса хранилища ключей. Если группа ресурсов, в которой находилось хранилище ключей, удалена, то перед восстановлением хранилища ключей нужно создать новую группу ресурсов с таким же именем.

## <a name="key-vault-objects-and-soft-delete"></a>Объекты хранилища ключей и обратимое удаление

Ниже описывается удаление ключа ContosoFirstKey в хранилище ключей ContosoVault, в котором включено обратимое удаление.

```powershell
Remove-AzureKeyVaultKey -VaultName ContosoVault -Name ContosoFirstKey
```

Если в хранилище ключей включено обратимое удаление, то удаленный ключ отображается как удаленный, за исключением случаев, когда вы явным образом выводите список удаленных ключей или извлекаете их. Большинство операций с ключом в удаленном состоянии завершится сбоем, кроме вывода списка удаленных ключей, восстановления этого ключа или его удаления. 

Например, чтобы запросить список удаленных ключей в хранилище ключей, используйте следующую команду.

```powershell
Get-AzureKeyVaultKey -VaultName ContosoVault -InRemovedState
```

### <a name="transition-state"></a>Переходное состояние 

Удаление ключа в хранилище ключей, в котором включено обратимое удаление, может занять несколько секунд. Во время этого переходного состояния может создаться впечатление, что ключ не находится ни в активном, ни в удаленном состоянии. Эта команда выведет список всех удаленных ключей в хранилище ключей ContosoVault.

```powershell
  Get-AzureKeyVaultKey -VaultName ContosoVault -InRemovedState
  Vault Name           : ContosoVault
  Name                 : ContosoFirstKey
  Id                   : https://ContosoVault.vault.azure.net:443/keys/ContosoFirstKey
  Deleted Date         : 2/14/2017 8:20:52 PM
  Scheduled Purge Date : 5/15/2017 8:20:52 PM
  Enabled              : True
  Expires              :
  Not Before           :
  Created              : 2/14/2017 8:16:07 PM
  Updated              : 2/14/2017 8:16:07 PM
  Tags                 :
```

### <a name="using-soft-delete-with-key-vault-objects"></a>Использование обратимого удаления с объектами хранилища ключей

Как и хранилища ключей, удаленный ключ, секрет или сертификат останется в удаленном состоянии в течение 90 дней, если его не восстановить или не очистить. 

#### <a name="keys"></a>ключей

Восстановление удаленного ключа.

```powershell
Undo-AzureKeyVaultKeyRemoval -VaultName ContosoVault -Name ContosoFirstKey
```

Окончательное удаление ключа.

```powershell
Remove-AzureKeyVaultKey -VaultName ContosoVault -Name ContosoFirstKey -InRemovedState
```

>[!NOTE]
>Очистка ключа приведет к его окончательному удалению, то есть восстановить его будет невозможно.

Для действий **восстановления** и **очистки** в политике доступа хранилища ключей заданы собственные разрешения. Чтобы пользователь или субъект-служба могли выполнить **восстановление** или **очистку**, они должны иметь соответствующее разрешение для этого объекта (ключа или секрета) в политике доступа хранилища ключей По умолчанию разрешение на **очистку** не добавляется в политику доступа хранилища ключей, если для предоставления всех разрешений пользователю используется параметр "Все". Необходимо явно предоставить разрешение на **очистку**. Например, приведенная ниже команда предоставляет разрешение user@contoso.com на выполнение нескольких операций с ключами в *ContosoVault*, включая **очистку**.

#### <a name="set-a-key-vault-access-policy"></a>Настройка политики доступа хранилища ключей

```powershell
Set-AzureRmKeyVaultAccessPolicy -VaultName ContosoVault -UserPrincipalName user@contoso.com -PermissionsToKeys get,create,delete,list,update,import,backup,restore,recover,purge
```

>[!NOTE] 
> Если у вас есть хранилище ключей, в котором только что было включено обратимое удаление, то у вас может не быть разрешений на **восстановление** и **очистку**.

#### <a name="secrets"></a>Секреты

Как и в случае ключей, для операций с секретами в хранилище ключей используются собственные команды. Ниже приведены команды для удаления, вывода списка, восстановления и очистки секретов.

- Удаление секрета SQLPassword. 
```powershell
Remove-AzureKeyVaultSecret -VaultName ContosoVault -name SQLPassword
```

- Вывод списка всех удаленных секретов в хранилище ключей. 
```powershell
Get-AzureKeyVaultSecret -VaultName ContosoVault -InRemovedState
```

- Восстановление секрета в удаленном состоянии. 
```powershell
Undo-AzureKeyVaultSecretRemoval -VaultName ContosoVault -Name SQLPAssword
```

- Очистка секрета в удаленном состоянии. 
```powershell
Remove-AzureKeyVaultSecret -VaultName ContosoVault -InRemovedState -name SQLPassword
```

>[!NOTE]
>Очистка секрета приведет к его окончательному удалению, то есть восстановить его будет невозможно.

## <a name="purging-and-key-vaults"></a>Очистка и хранилище ключей

### <a name="key-vault-objects"></a>Объекты хранилища ключей

Очистка ключа, секрета или сертификата приведет к его окончательному удалению, то есть восстановить его будет невозможно. Однако содержащее его хранилище ключей останется без изменений, как и другие объекты, хранящиеся в нем. 

### <a name="key-vaults-as-containers"></a>Хранилища ключей в роли контейнеров
При очистке хранилища ключей все его содержимое, включая ключи, секреты и сертификаты, удаляется без возможности восстановления. Чтобы очистить хранилище ключей, используйте команду `Remove-AzureRmKeyVault` с параметром `-InRemovedState`, указав расположение удаленного хранилища ключей в аргументе `-Location location`. Расположение удаленного хранилища можно найти с помощью команды `Get-AzureRmKeyVault -InRemovedState`.

```powershell
Remove-AzureRmKeyVault -VaultName ContosoVault -InRemovedState -Location westus
```

>[!NOTE]
>Очистка хранилища ключей приведет к его окончательному удалению, то есть восстановить его будет невозможно.

### <a name="purge-permissions-required"></a>Необходимые разрешения на очистку
- Чтобы очистить удаленное хранилище ключей, то есть окончательно удалить его вместе со всем содержимым, пользователю нужно разрешение RBAC на выполнение операции *Microsoft.KeyVault/locations/deletedVaults/purge/action*. 
- Чтобы вывести список удаленных хранилищ ключей, пользователю нужно разрешение RBAC на выполнение операции *Microsoft.KeyVault/deletedVaults/read*. 
- По умолчанию администратор подписки имеет эти разрешения. 

### <a name="scheduled-purge"></a>Очистка по расписанию

При выводе списка объектов удаленного хранилища ключей отображается запланированное время их очистки службой Key Vault. Поле *Scheduled Purge Date* (Запланированная дата очистки) указывает, когда объект хранилища ключей будет окончательно удален, если не предпринять какое-либо действие. По умолчанию срок хранения объекта удаленного хранилища ключей составляет 90 дней.

>[!NOTE]
>После очистки объекта хранилища, активированной значением его поля *Scheduled Purge Date* (Запланированная дата очистки), этот объект будет окончательно удален. Восстановить его будет невозможно.

## <a name="other-resources"></a>Другие ресурсы:

- Обзор функции обратимого удаления Key Vault см. в разделе [Общие сведения об обратимом удалении в Azure Key Vault](key-vault-ovw-soft-delete.md).
- Общие сведения об использовании Azure Key Vault см. в разделе [Приступая к работе с хранилищем ключей Azure](key-vault-get-started.md).


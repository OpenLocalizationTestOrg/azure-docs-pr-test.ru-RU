---
ms.assetid: 
title: "Хранилище ключей aaaAzure — как мягкий toouse удалить с CLI"
description: "Примеры использования обратимого удаления с фрагментами кода для интерфейса командной строки."
author: BrucePerlerMS
manager: mbaldwin
ms.service: key-vault
ms.topic: article
ms.workload: identity
ms.date: 08/04/2017
ms.author: bruceper
ms.openlocfilehash: 672f5210ab119c244ca712f0bb80b653b50ea79b
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="how-toouse-key-vault-soft-delete-with-cli"></a>Как toouse хранилище ключей soft-delete с CLI

Функция обратимого удаления в Azure Key Vault позволяет восстанавливать удаленные хранилища и объекты хранилищ. В частности адреса soft-delete hello следующие сценарии:

- Поддержка восстанавливаемого удаления хранилища ключей
- Поддержка восстанавливаемого удаления объектов хранилища ключей (например, ключей, секретов и сертификатов).

## <a name="prerequisites"></a>Предварительные требования

- Azure CLI 2.0. Если в вашей среде этот инструмент не установлен, ознакомьтесь с разделом [Управление Key Vault с помощью интерфейса командной строки 2.0](key-vault-manage-with-cli2.md).

Дополнительная информация об использовании интерфейса командной строки с Key Vault приведена в [справочнике по Azure CLI 2.0 для Key Vault](https://docs.microsoft.com/cli/azure/keyvault).

## <a name="required-permissions"></a>Необходимые разрешения

Операции Key Vault контролируются отдельно, посредством разрешений управления доступом на основе ролей (RBAC). Это осуществляется следующим образом.

| Операция | Описание | Разрешение пользователя |
|:--|:--|:--|
|список|Выводит список удаленных хранилищ ключей.|Microsoft.KeyVault/deletedVaults/read|
|Recover|Восстанавливает удаленное хранилище ключей.|Microsoft.KeyVault/vaults/write|
|Purge|Окончательно удаляет удаленное хранилище ключей и все его содержимое.|Microsoft.KeyVault/locations/deletedVaults/purge/action|

Дополнительные сведения о разрешениях и управлении доступом см. в разделе [Защита хранилища ключей](key-vault-secure-your-key-vault.md).

## <a name="enabling-soft-delete"></a>Включение обратимого удаления

возможности toorecover toobe удаленные хранилища ключей или объектов, хранящихся в ключе хранилище, необходимо сначала включить soft-delete для этого хранилища ключей.

### <a name="existing-key-vault"></a>Существующее хранилище ключей

Включите обратимое удаление для существующего хранилища ключей ContosoVault следующим образом. 

>[!NOTE]
>В настоящее время необходимые записи toouse диспетчера ресурсов Azure ресурсов обработки toodirectly hello *enableSoftDelete* toohello свойство ресурса хранилища ключей.

```azurecli
az resource update --id $(az keyvault show --name ContosoVault -o tsv | awk '{print $1}') --set properties.enableSoftDelete=true
```

### <a name="new-key-vault"></a>Новое хранилище ключей

Выполняется Включение soft-delete для нового хранилища ключей во время создания, добавив флаг enable soft-delete hello tooyour создать команду.

```azurecli
az keyvault create --name ContosoVault --resource-group ContosoRG --enable-soft-delete true --location westus
```

### <a name="verify-soft-delete-enablement"></a>Проверка включения обратимого удаления

tooverify с soft-delete включено, в хранилище ключей выполнения hello *Показать* команды и найдите hello, «Мягкое удалить включен?» и его значение (true или false).

```azurecli
az keyvault show --name ContosoVault
```

## <a name="deleting-a-key-vault-protected-by-soft-delete"></a>Удаление хранилища ключей, защищенного с помощью обратимого удаления

Hello команда toodelete (или удалить) хранилища ключей остается hello подобны, но изменения его поведения в зависимости от того, включена ли soft-delete или нет.

```azurecli
az keyvault delete --name ContosoVault
```

> [!IMPORTANT]
>При выполнении предыдущей команды hello для хранилища ключей, у которого нет soft-delete включено будут окончательно удалены этому хранилищу ключей и все ее содержимое без параметров для восстановления.

### <a name="how-soft-delete-protects-your-key-vaults"></a>Как обратимое удаление защищает хранилище ключей

Если обратимое удаление включено:

- При удалении хранилища ключей, удаляется из соответствующей группы ресурсов и поместить в зарезервированному пространству имен, которое можно только связанные с расположением hello, где он был создан. 
- Объекты в удаленный ключ хранилища, таких как ключи, секреты и сертификатов, недоступен и остаются, а их содержащего хранилища ключей находится в состоянии hello удален. 
- Hello DNS-имя для хранилища ключей в удаленном состоянии сохраняется, поэтому не удается создать новое хранилище ключей с таким же именем.  

Можно просмотреть хранилищ ключей удаленном состоянии, связанные с подпиской, с помощью hello следующую команду:

```azurecli
az keyvault list-deleted
```

Hello *идентификатор ресурса* в hello вывода относится toohello исходный идентификатор ресурса хранилища. Так как это хранилище ключей теперь находится в удаленном состоянии, ресурс с таким идентификатором ресурса не существует. Hello *идентификатор* поле может быть ресурсов hello tooidentify используется при восстановлении или удаления. Hello *запланированные даты очистки* поле указывает, когда хранилище hello будут окончательно удалены (удаление), если действие не выполняется для этого удаленного хранилища. hello toocalculate периода, который применяется для хранения по умолчанию Hello *запланированные даты очистки*, составляет 90 дней.

## <a name="recovering-a-key-vault"></a>Восстановление хранилища ключей

toorecover хранилища ключей, необходимо указать имя хранилища ключей toospecify hello, группу ресурсов и расположение. Примечание hello расположение и hello группа ресурсов hello удалить хранилище ключей, так как необходимые для процесса восстановления хранилища ключей.

```azurecli
az keyvault recover --location westus --name ContosoVault
```

При восстановлении хранилища ключей hello результатом является новый ресурс с идентификатором hello хранилища ключей исходного ресурса. При удалении группы ресурсов hello которых было hello хранилища ключей, перед восстановлением hello хранилища ключей должны создаваться новую группу ресурсов с таким же именем.

## <a name="key-vault-objects-and-soft-delete"></a>Объекты хранилища ключей и обратимое удаление

Ниже описывается удаление ключа ContosoFirstKey в хранилище ключей ContosoVault, в котором включено обратимое удаление.

```azurecli
az keyvault key delete --name ContosoFirstKey --vault-name ContosoVault
```

Если в хранилище ключей включено обратимое удаление, то удаленный ключ отображается как удаленный, за исключением случаев, когда вы явным образом выводите список удаленных ключей или извлекаете их. За исключением перечислении удаленный ключ, он или очистка его не удастся большинства операций по ключу в состоянии hello удален. 

Например toorequest toolist удалены ключей в хранилище ключей, используйте hello следующую команду:

```azurecli
az keyvault key list-deleted --vault-name ContosoVault
```

### <a name="transition-state"></a>Переходное состояние 

При удалении ключа в хранилище ключей с soft-delete включено займет несколько секунд, чтобы переход toocomplete hello. Во время это переходное состояние может показаться, что разделу hello не в состоянии active hello или удалить hello. Эта команда выведет список всех удаленных ключей в хранилище ключей ContosoVault.

```azurecli
az keyvault key list-deleted --vault-name ContosoVault
```

### <a name="using-soft-delete-with-key-vault-objects"></a>Использование обратимого удаления с объектами хранилища ключей

Точно так же, как и в хранилищах ключей, удаленный ключ, секрет или сертификат останется в состоянии удаления для копирования too90 дней, если не восстановить ее или очистить его. 

#### <a name="keys"></a>ключей

toorecover удаленный ключ:

```azurecli
az keyvault key recover --name ContosoFirstKey --vault-name ContosoVault
```

toopermanently удалить раздел:

```azurecli
az keyvault key purge --name ContosoFirstKey --vault-name ContosoVault
```

>[!NOTE]
>Очистка ключа приведет к его окончательному удалению, то есть восстановить его будет невозможно.

Hello **восстановить** и **очистки** действия имеют свои собственные разрешения, связанные политики доступа хранилища ключей. Для пользователя или службы основной toobe может tooexecute **восстановить** или **очистки** действия, они должны иметь hello соответствующие разрешения для этого объекта (ключа или секрета) в политике доступа hello хранилища ключей. По умолчанию hello **очистки** разрешение не добавляется в политику доступа tooa хранилища ключей при hello «all» ярлык — используется toogrant все tooa пользовательские разрешения. Необходимо явно предоставить разрешение на **очистку**. Здравствуйте, например, следующая команда предоставляет user@contoso.com tooperform разрешение несколько операции с ключами в *ContosoVault* включая **очистки**.

#### <a name="set-a-key-vault-access-policy"></a>Настройка политики доступа хранилища ключей

```azurecli
az keyvault set-policy --name ContosoVault --key-permissions get create delete list update import backup restore recover purge
```

>[!NOTE] 
> Если у вас есть хранилище ключей, в котором только что было включено обратимое удаление, то у вас может не быть разрешений на **восстановление** и **очистку**.

#### <a name="secrets"></a>Секреты

Как и в случае ключей, для операций с секретами в хранилище ключей используются собственные команды. Следующие, — это hello команды для удаления, список, восстановление и очистка секретные данные.

- Удаление секрета SQLPassword. 
```azurecli
az keyvault secret delete --vault-name ContosoVault -name SQLPassword
```

- Вывод списка всех удаленных секретов в хранилище ключей. 
```azurecli
az keyvault secret list-deleted --vault-name ContosoVault
```

- Восстановите секрет в состоянии hello удалены: 
```azurecli
az keyvault secret recover --name SQLPassword --vault-name ContosoVault
```

- Очистка секрета в удаленном состоянии. 
```azurecli
az keyvault secret purge --name SQLPAssword --vault-name ContosoVault
```

>[!NOTE]
>Очистка секрета приведет к его окончательному удалению, то есть восстановить его будет невозможно.

## <a name="purging-and-key-vaults"></a>Очистка и хранилище ключей

### <a name="key-vault-objects"></a>Объекты хранилища ключей

Очистка ключа, секрета или сертификата приведет к его окончательному удалению, то есть восстановить его будет невозможно. хранилище ключей Hello, содержит объект удален hello Однако останутся без изменений, как и другие объекты в хранилище ключей hello. 

### <a name="key-vaults-as-containers"></a>Хранилища ключей в роли контейнеров
При очистке хранилища ключей все его содержимое, включая ключи, секреты и сертификаты, удаляется без возможности восстановления. toopurge хранилища ключей, использовать hello `az keyvault purge` команды. Можно найти расположение hello ключа хранилища с удаленных вашей подписки с помощью команды hello `az keyvault list-deleted`.

```azurecli
az keyvault purge --location westus --name ContosoVault
```

>[!NOTE]
>Очистка хранилища ключей приведет к его окончательному удалению, то есть восстановить его будет невозможно.

### <a name="purge-permissions-required"></a>Необходимые разрешения на очистку
- toopurge удаленные хранилища ключей, таким образом, что хранилище hello и все ее содержимое, окончательно удаляются, hello пользователь должен tooperform разрешение RBAC *Microsoft.KeyVault/locations/deletedVaults/purge/action* операции. 
- ключ toolist hello удален, хранилище hello пользователь должен tooperform разрешение RBAC *Microsoft.KeyVault/deletedVaults/read* разрешение. 
- По умолчанию администратор подписки имеет эти разрешения. 

### <a name="scheduled-purge"></a>Очистка по расписанию

Перечисление объектов удаленного хранилища ключей показывает во время toobe schedled, удаленные с хранилищем ключей. Hello *запланированные даты очистки* поле указывает, когда объект хранилища ключей будут окончательно удалены, если никакие действия не выполняются. По умолчанию срок хранения hello объекта удаленного хранилища ключей составляет 90 дней.

>[!NOTE]
>После очистки объекта хранилища, активированной значением его поля *Scheduled Purge Date* (Запланированная дата очистки), этот объект будет окончательно удален. Восстановить его будет невозможно.

## <a name="other-resources"></a>Другие ресурсы:

- Обзор функции обратимого удаления Key Vault см. в разделе [Общие сведения об обратимом удалении в Azure Key Vault](key-vault-ovw-soft-delete.md).
- Общие сведения об использовании Azure Key Vault см. в разделе [Приступая к работе с хранилищем ключей Azure](key-vault-get-started.md).


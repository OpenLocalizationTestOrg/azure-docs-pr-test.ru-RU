---
title: "Управление Azure Key Vault с помощью интерфейса командной строки | Документы Майкрософт"
description: "Из этого учебника вы узнаете об автоматизации основных задач в хранилище ключей с использованием CLI"
services: key-vault
documentationcenter: 
author: barclayn
manager: mbaldwin
tags: azure-resource-manager
ms.assetid: 66be6e44-684a-411b-802e-884628458ae7
ms.service: key-vault
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 11/14/2017
ms.author: barclayn
ms.openlocfilehash: 94ea95e7f40c8d47dd18422a9c0795655dae365b
ms.sourcegitcommit: 7d107bb9768b7f32ec5d93ae6ede40899cbaa894
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/16/2017
---
# <a name="manage-key-vault-using-cli"></a>Управление хранилищем ключей с помощью CLI

Это руководство поможет вам начать работу с Azure Key Vault, чтобы создать контейнер (хранилище) с усиленной защитой в Azure. Azure Key Vault используется для хранения криптографических ключей и секретов, а также управления ими. В этой статье описывается процесс создания хранилища с помощью кроссплатформенного интерфейса командной строки Azure. После этого можно будет взаимодействовать с данным хранилищем для выполнения различных стандартных операций. 

Хранилище ключей Azure доступно в большинстве регионов. Дополнительные сведения см. на странице [цен на хранилище ключей](https://azure.microsoft.com/pricing/details/key-vault/).

**Предполагаемое время выполнения:** 20 минут

> [!NOTE]
> Это руководство не содержит инструкций по созданию приложения Azure, используемого на одном из шагов. Этот пример приложения используется, чтобы показать, как приложению можно разрешить использовать ключ или секрет, хранящийся в хранилище ключей.
> В этой статье основное внимание уделяется настройке Azure Key Vault с помощью кроссплатформенного интерфейса командной строки. Инструкции для Azure PowerShell приведены в [аналогичном руководстве](key-vault-get-started.md).

Общие сведения о хранилище ключей Azure см. в статье [Что такое хранилище ключей Azure?](key-vault-whatis.md)

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим учебником требуется:

* подписка на Microsoft Azure. Если у вас нет подписки, вы можете зарегистрироваться для использования [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial);
* Интерфейс командной строки версии 0.9.1 или более поздней. Сведения об установке последней версии и связывании ее с подпиской Azure можно найти в разделе [Установка и настройка межплатформенного интерфейса командной строки Azure](../cli-install-nodejs.md).
* приложение, для которого вы будете настраивать использование ключа или пароля, созданного по этому учебнику. Пример приложения доступен в [Центре загрузки Майкрософт](http://www.microsoft.com/download/details.aspx?id=45343). Указания см. в сопутствующем файле Readme.

## <a name="getting-help-with-azure-cross-platform-command-line-interface"></a>Справка по межплатформенному интерфейсу командной строки Azure

В этом учебнике предполагается, что вы знакомы с интерфейсом командной строки (Bash, терминал, командная строка)

Параметр --help или -h может использоваться для просмотра справки по определенным командам. Также для получения справки можно использовать команду azure help [команда] [параметры]. Например, все следующие команды возвращают одинаковые сведения:

    azure account set --help

    azure account set -h

    azure help account set

Если вы сомневаетесь в том, какие параметры необходимы команде, обратитесь к справке, используя ключ --help, -h или команду azure help [команда].

Чтобы узнать, как работать с моделью развертывания с помощью Azure Resource Manager в кроссплатформенном интерфейсе командной строки Azure, также прочитайте следующие руководства:

* [Установка и настройка межплатформенного интерфейса командной строки Azure](../cli-install-nodejs.md)
* [Использование межплатформенного интерфейса командной строки Azure совместно с диспетчером ресурсов](../xplat-cli-azure-resource-manager.md)

## <a name="connect-to-your-subscriptions"></a>Подключение к своим подпискам

Войдите в Azure, выполнив следующую команду.

```azurecli-interactive
azure login -u username -p password
```

Или, чтобы войти при помощи ввода данных в интерактивном режиме:

```azurecli-interactive
azure login
```

Если у вас есть несколько подписок и нужно указать лишь одну из них, которая будет использоваться для хранилища ключей Azure, введите следующую команду, чтобы увидеть подписки своей учетной записи:

```azurecli-interactive
azure account list
```

Далее, чтобы указать подписку, которую нужно использовать, введите:

```azurecli-interactive
azure account set <subscription name>
```

Дополнительные сведения о настройке межплатформенного интерфейса командной строки Azure можно найти в разделе [Установка и настройка межплатформенного интерфейса командной строки Azure](../cli-install-nodejs.md).

## <a name="switch-to-using-azure-resource-manager"></a>Переключение в режим использования диспетчера ресурсов Azure
Для хранилища ключей Azure требуется диспетчер ресурсов Azure, поэтому введите следующую команду, чтобы переключиться в режим этого диспетчера:

```azurecli-interactive
azure config mode arm
```

## <a name="create-a-new-resource-group"></a>Создание новой группы ресурсов
При использовании диспетчера ресурсов Azure все связанные ресурсы создаются внутри группы ресурсов. Для примера мы создадим новую группу ресурсов с именем ContosoResourceGroup:

```azurecli-interactive
azure group create 'ContosoResourceGroup' 'East Asia'
```

Первый параметр — имя группы ресурсов, а второй параметр — его расположение. Для параметра расположения используйте команду `azure location list` , чтобы указать альтернативное расположение группы. Если вам необходима дополнительная информация, введите `azure help location`

## <a name="register-the-key-vault-resource-provider"></a>Регистрация поставщика ресурсов хранилища ключей
Убедитесь, что поставщик ресурсов хранилища ключей зарегистрирован в вашей подписке:

```azurecli-interactive
azure provider register Microsoft.KeyVault
```

Данную операцию достаточно выполнить один раз для каждой подписки.

## <a name="create-a-key-vault"></a>Создайте хранилище ключей.

Для создания хранилища ключей используйте команду `azure keyvault create` . Этот сценарий предусматривает три обязательных параметра: имя группы ресурсов, имя хранилища ключей и географическое расположение.

Например:
- если имя хранилища — **ContosoKeyVault**,
- имя группы ресурсов — **ContosoResourceGroup**,
- а расположение — **Восточная Азия**.

```azurecli-interactive
azure keyvault create --vault-name 'ContosoKeyVault' --resource-group 'ContosoResourceGroup' --location 'East Asia'
```

В выходных данных команды будут показаны свойства хранилища ключей, которое вы только что создали. Среди всех свойств есть два самых важных:

* **Имя.** В этом примере — ContosoKeyVault. Вы будете использовать это имя для выполнения других командлетов хранилища ключей;
* **URI хранилища.** В нашем примере — это https://contosokeyvault.vault.azure.net. Необходимо, чтобы приложения, использующие ваше хранилище через REST API, использовали этот URI.

Теперь ваша учетная запись Azure авторизована, и вы можете выполнять любые операции в этом хранилище ключей. Пока что это недоступно для других учетных записей.

## <a name="add-a-key-or-secret-to-the-key-vault"></a>Добавьте ключ или секретный код в хранилище ключей.

Если вам необходимо создать ключ с программной защитой для собственного использования с помощью хранилища ключей Azure, используйте команду `azure key create` и введите следующее:

```azurecli-interactive
azure keyvault key create --vault-name 'ContosoKeyVault' --key-name 'ContosoFirstKey' --destination software
````

Однако если у вас уже есть ключ, сохраненный в виде локального PEM-файла с именем softkey.pem, который требуется загрузить в хранилище ключей Azure, воспользуйтесь следующей командой импорта ключа из PEM-файла, которая позволяет программным образом защитить ключ в службе хранилища ключей:

```azurecli-interactive
azure keyvault key import --vault-name 'ContosoKeyVault' --key-name 'ContosoFirstKey' --pem-file './softkey.pem' --password 'PaSSWORD' --destination software
```

Теперь для доступа к ключу, созданному или загруженному в хранилище ключей Azure, вы сможете использовать его URI. Используйте адрес **https://ContosoKeyVault.vault.azure.net/keys/ContosoFirstKey**, чтобы всегда получать текущую версию, и адрес **https://ContosoKeyVault.vault.azure.net/keys/ContosoFirstKey/cgacf4f763ar42ffb0a1gca546aygd87**, чтобы получить конкретную версию.

Чтобы добавить секрет в хранилище ключей Azure, который представляет собой пароль с именем SQLPassword и значением Pa$$w0rd, введите следующее:

```azurecli-interactive
azure keyvault secret set --vault-name 'ContosoKeyVault' --secret-name 'SQLPassword' --value 'Pa$$w0rd'
```

Теперь пароль, добавленный в хранилище ключей Azure, можно вызвать, используя его URI. Используйте адрес **https://ContosoVault.vault.azure.net/secrets/SQLPassword**, чтобы всегда получать текущую версию, и адрес **https://ContosoVault.vault.azure.net/secrets/SQLPassword/90018dbb96a84117a0d2847ef8e7189d**, чтобы получить конкретную версию.

Давайте просмотрим только что созданный ключ или секрет.

* Чтобы просмотреть свой ключ, введите `azure keyvault key list --vault-name 'ContosoKeyVault'`
* Чтобы просмотреть свой секрет, введите `azure keyvault secret list --vault-name 'ContosoKeyVault'`

## <a name="register-an-application-with-azure-active-directory"></a>Зарегистрируйте приложение с Azure Active Directory.

Обычно этот шаг выполняет разработчик на отдельном компьютере. Он не относится к хранилищу ключей Azure, но включен в этот учебник для полноты картины.

> [!IMPORTANT]
> Чтобы завершить изучение этого руководства, учетная запись, хранилище и приложение, которое вы будете регистрировать на этом шаге, должны находиться в одной службе Azure Active Directory.

Приложения, которые используют хранилища ключей, должны пройти аутентификацию с использованием токена Azure Active Directory. Для этого владельцу приложения необходимо сначала зарегистрировать приложение в Azure Active Directory. В конце регистрации владелец приложения получает следующие значения.

- **Идентификатор приложения**. 
- **Ключ проверки подлинности** (также известный как общий секрет). 

Для получения маркера приложение должно предоставить Azure Active Directory оба этих значения. Настроенный способ предоставления зависит от приложения. В [примере приложения, использующего Key Vault](https://www.microsoft.com/download/details.aspx?id=45343), владелец приложения задает эти значения в файле app.config.

Пошаговые инструкции по регистрации приложения с помощью Azure Active Directory см. в статье [Интеграция приложений с Azure Active Directory](../active-directory/develop/active-directory-integrating-applications.md) или [Создание приложения Azure Active Directory и субъекта-службы с доступом к ресурсам с помощью портала](../azure-resource-manager/resource-group-create-service-principal-portal.md). Чтобы зарегистрировать приложение в Azure Active Directory, сделайте следующее.

1. Выполните вход на [портал Azure](https://portal.azure.com).
2. Слева щелкните **Регистрация приложений**. Если зарегистрированные приложения не отображаются, щелкните **Больше служб** и найдите их там.  
    >[!NOTE]
    Вам необходимо выбрать каталог, содержащий подписку Azure, которую вы использовали для создания хранилища ключей. 
3. Щелкните **Регистрация нового приложения**.
4. В колонке **Создание** укажите имя своего приложения, а затем выберите **Веб-приложение и/или веб-API** (по умолчанию) и укажите **URL-адрес для входа** для веб-приложения. Если у вас пока нет этих сведений, вы можете указать фиктивное значение для использования на этом шаге (например, можно указать http://test1.contoso.com). Неважно, существуют ли эти сайты. 

   ![Регистрация нового приложения](./media/key-vault-manage-with-cli/new-application-registration.png)

5. Нажмите кнопку **Создать** .
6. Завершив регистрацию приложения, вы увидите список зарегистрированных приложений. Найдите только что зарегистрированное приложение и щелкните его имя.
7. Щелкните колонку **Зарегистрированное приложение** и скопируйте **идентификатор приложения**.
8. Выберите **Все параметры**.
9. В колонке **Параметры** щелкните **Ключи**.
10. Введите описание в поле **Описание ключа**, задайте срок действия и нажмите кнопку **Сохранить**. Страница обновится и отобразится значение ключа. 
11. **Идентификатор приложения** и сведения о **ключе** вам понадобятся на следующем шаге, чтобы задать разрешения в своем хранилище.

## <a name="authorize-the-application-to-use-the-key-or-secret"></a>Разрешите приложению использовать ключ или секретный код.
Чтобы авторизовать приложение для получения доступа к ключу или секрету в хранилище, используйте следующую команду.

```azurecli-interactive
azure keyvault set-policy
```

Например, если имя хранилища — ContosoKeyVault, а идентификатор клиента приложения — 8f8c4bbd-485b-45fd-98f7-ec6300b7b4ed, и нужно авторизовать это приложение для расшифровки и подписи с использованием ключей в вашем хранилище, выполните следующее:

```azurecli-interactive
azure keyvault set-policy --vault-name 'ContosoKeyVault' --spn 8f8c4bbd-485b-45fd-98f7-ec6300b7b4ed --perms-to-keys '[\"decrypt\",\"sign\"]'
```

> [!NOTE]
> При выполнении команды в командной строке Windows замените одинарные кавычки на двойные, а также экранируйте внутренние двойные кавычки. Например: "[\"decrypt\",\"sign\"]".
> 

Если этому же приложению необходимо разрешить читать секретные данные в хранилище, выполните следующую команду:

```azurecli-interactive
azure keyvault set-policy --vault-name 'ContosoKeyVault' --spn 8f8c4bbd-485b-45fd-98f7-ec6300b7b4ed --perms-to-secrets '[\"get\"]'
```

## <a name="if-you-want-to-use-a-hardware-security-module-hsm"></a>Использование аппаратного модуля безопасности
Чтобы обеспечить более высокий уровень защиты, можно импортировать ключи или создать их в аппаратных модулях безопасности (ключи никогда не покидают их пределов). В качестве аппаратных модулей безопасности используются модули FIPS 140-2 с проверкой уровня 2. Если это требование вас не касается, пропустите этот подраздел и перейдите к подразделу [Удаление хранилища ключей, а также связанных ключей и секретов](#delete-the-key-vault-and-associated-keys-and-secrets).

Чтобы создать ключи, защищенные аппаратным модулем безопасности, у вас должна быть подписка на хранилище, которая поддерживает ключи, защищенные аппаратным модулем безопасности.

При создании хранилища добавьте параметр sku:

```azurecli-interactive
azure azure keyvault create --vault-name 'ContosoKeyVaultHSM' --resource-group 'ContosoResourceGroup' --location 'East Asia' --sku 'Premium'
```

В это хранилище можно добавлять ключи с программной защитой (как показано выше) и ключи, защищенные аппаратным модулем безопасности. Чтобы создать ключ, защищенный аппаратным модулем безопасности, задайте значение HSM для параметра Destination:

```azurecli-interactive
azure keyvault key create --vault-name 'ContosoKeyVaultHSM' --key-name 'ContosoFirstHSMKey' --destination 'HSM'
```

Вы можете использовать следующую команду для импорта ключа из PEM-файла на своем компьютере. Эта команда импортирует ключ в аппаратные модули безопасности в службе хранилища ключей:

```azurecli-interactive
azure keyvault key import --vault-name 'ContosoKeyVaultHSM' --key-name 'ContosoFirstHSMKey' --pem-file '/.softkey.pem' --destination 'HSM' --password 'PaSSWORD'
```

Следующая команда импортирует пакет собственного ключа клиента (BYOK). Это дает возможность создать ключ в своем локальном аппаратном модуле безопасности и передать его в аппаратные модули безопасности в службе хранилища ключей так, чтобы ключ не покидал их пределы:

```azurecli-interactive
azure keyvault key import --vault-name 'ContosoKeyVaultHSM' --key-name 'ContosoFirstHSMKey' --byok-file './ITByok.byok' --destination 'HSM'
```

Более подробные инструкции по созданию пакета BYOK см. в статье [Создание ключей, защищенных аппаратным модулем безопасности, и их передача в хранилище ключей Azure](key-vault-hsm-protected-keys.md).

## <a name="delete-the-key-vault-and-associated-keys-and-secrets"></a>Удаление хранилища ключей, а также связанных ключей и секретов
Если больше нет необходимости в хранилище ключей и содержащемся в нем ключе или секрете, можно удалить его, используя команду azure keyvault delete:

```azurecli-interactive
azure keyvault delete --vault-name 'ContosoKeyVault'
```

Как вариант, можно удалить всю группу ресурсов Azure, которая включает в себя хранилище ключей и другие ресурсы, которые вы добавили в эту группу:

```azurecli-interactive
azure group delete --name 'ContosoResourceGroup'
```


## <a name="other-azure-cross-platform-command-line-interface-commands"></a>Другие команды в межплатформенном интерфейсе командной строки Azure
Вот другие команды, которые могут быть полезны при управлении хранилищем ключей Azure.

Эта команда перечисляет все ключи и выбранные свойства в виде таблицы:

```azurecli-interactive
azure keyvault key list --vault-name 'ContosoKeyVault'
```

Эта команда отображает полный список свойств для указанного ключа:

```azurecli-interactive
azure keyvault key show --vault-name 'ContosoKeyVault' --key-name 'ContosoFirstKey'
```

Эта команда перечисляет все имена секретов и выбранные свойства в виде таблицы:

```azurecli-interactive
azure keyvault secret list --vault-name 'ContosoKeyVault'
```

Пример удаления конкретного ключа:

```azurecli-interactive
azure keyvault key delete --vault-name 'ContosoKeyVault' --key-name 'ContosoFirstKey'
```

Пример удаления конкретного секрета:

```azurecli-interactive
azure keyvault secret delete --vault-name 'ContosoKeyVault' --secret-name 'SQLPassword'
```


## <a name="next-steps"></a>Дальнейшие действия
- Справочные материалы по программированию см. в статье [Руководство разработчика хранилища ключей Azure](key-vault-developers-guide.md).
- Общие сведения о хранилище ключей Azure см. в статье [Что такое хранилище ключей Azure?](key-vault-whatis.md)
- Сведения о том, как работать с Azure Key Vault с помощью PowerShell, см. в разделе [Приступая к работе с хранилищем ключей Azure](key-vault-get-started.md).



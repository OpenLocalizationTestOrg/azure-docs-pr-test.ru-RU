---
title: "Прогнозирование потребности в энергии с использованием временных рядов | Документация Майкрософт"
description: "Практическое руководство по применению алгоритмов машинного обучения для прогнозирования потребности в энергии с использованием временных рядов в Azure Machine Learning Workbench."
services: machine-learning
documentationcenter: 
author: anta
manager: ireiter
editor: anta
ms.assetid: 
ms.service: machine-learning
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 09/15/2017
ms.author: anta
ms.openlocfilehash: bd0ddfcffdb6f946f9a3786f3d0add1740be861b
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="energy-demand-time-series-forecasting"></a>Прогнозирование потребности в энергии с использованием временных рядов


Прогнозирование временных рядов предназначено для определения потенциальных значений на основе ряда наблюдений в хронологической последовательности. Это распространенная задача, которая применяется во многих отраслях. Например, компаниям розничной торговли требуется спрогнозировать продажи продуктов в будущем, чтобы эффективно организовать цепочки поставок для удовлетворения спроса. Аналогичным образом службам доставки требуется оценить спрос на их услуги, чтобы заблаговременно спланировать потребность в персонале и маршруты доставки. Зачастую неточные прогнозы могут стать причиной значительных финансовых рисков. Поэтому прогнозирование часто является критически важной задачей для бизнеса.

В этом примере показано, как можно выполнить прогнозирование временных рядов, применяя методы машинного обучения. Вы пройдете каждый этап процесса моделирования, включая:
- подготовку данных к очистке и форматированию;
- создание функций для моделей машинного обучения на основе необработанных данных временных рядов;
- обучение различных моделей машинного обучения;
- оценку моделей путем сравнения их эффективности на основе тестового набора контрольных данных;
- ввод в эксплуатацию наиболее подходящей модели в виде веб-службы для создания прогнозов по требованию.

Azure Machine Learning Workbench упрощает процесс моделирования на каждом этапе: 
- В примере показано, как среда записной книжки Jupyter, доступная непосредственно в Workbench, позволяет упростить разработку кода Python. Вы сможете более точно описать процесс разработки модели для других пользователей с помощью заметок и диаграмм Markdown. Эти записные книжки можно просматривать, изменять и выполнять непосредственно в Workbench.
- Обученные модели можно сохранить и отправить в хранилище BLOB-объектов. Благодаря этому специалист по анализу и обработке данных может отслеживать объекты обученной модели и обеспечить их хранение и извлечение при необходимости.
- Метрики могут регистрироваться при выполнении сценария Python, чтобы специалист по анализу и обработке данных мог отслеживать показатели эффективности для модели.
- Workbench предоставляет настраиваемые таблицы для зарегистрированных метрик, с помощью которых специалист по анализу и обработке данных может легко сравнивать показатели эффективности модели. Диаграммы отображаются автоматически, поэтому можно легко определить модель с наилучшими показателями эффективности.
- Наконец, в примере показано, как ввести обученную модель в эксплуатацию, развернув ее в виде веб-службы, работающей в реальном времени.

## <a name="link-to-the-gallery-github-repository"></a>Ссылка на репозиторий коллекции на GitHub
Общедоступный репозиторий GitHub содержит все материалы для этого реального сценария, в том числе примеры кода, которые потребуются в нашем примере.

[https://github.com/Azure/MachineLearningSamples-EnergyDemandTimeSeriesForecasting](https://github.com/Azure/MachineLearningSamples-EnergyDemandTimeSeriesForecasting)


## <a name="use-case-overview"></a>Обзор вариантов использования

В этом сценарии рассматривается прогнозирование потребности в энергии, с помощью которого следует определить нагрузку на энергосистему в будущем. Это критически важная бизнес-операция для компаний энергетического сектора, так как компании-операторы должны поддерживать точный баланс между электроэнергией, потребляемой из энергосистемы и поставляемой в нее. Если поставить в энергосистему слишком много энергии, это может привести к потере энергии или отказу техники. Если поставить слишком мало энергии, это может привести к перебоям с энергоснабжением, в результате чего клиенты останутся без энергии. Как правило, сетевые компании могут принимать краткосрочные решения по управлению поставками электроэнергии в энергосистему и поддержке баланса нагрузки. Таким образом, точный краткосрочный прогноз потребностей в энергии очень важен для компании-оператора для уверенного принятия таких решений.

В этом сценарии подробно объясняется, как создать решение для прогноза потребностей в энергии на основе методов машинного обучения. Решение обучается на основе общедоступного набора данных, предоставленного компанией [New York Independent System Operator (NYISO)](http://www3.dps.ny.gov/W/PSCWeb.nsf/All/298372E2CE4764E885257687006F39DF?OpenDocument), которая управляет энергосистемой в штате Нью-Йорк. Этот набор содержит данные о потреблении энергии по часам в городе Нью-Йорк за пять лет. Дополнительный набор данных, содержащий почасовые сведения о погодных условиях в Нью-Йорке за тот же период времени, взят с сайта [darksky.net](https://darksky.net).

## <a name="prerequisites"></a>Предварительные требования

- [Учетная запись Azure](https://azure.microsoft.com/free/) (доступны бесплатные пробные версии).
- Установленная копия [Azure Machine Learning Workbench](./overview-what-is-azure-ml.md). Чтобы установить эту программу и создать рабочую область, выполните инструкции из [краткого руководства по установке](./quickstart-installation.md).
- В этом примере предполагается, что Azure ML Workbench работает в Windows 10 с [подсистемой Docker](https://www.docker.com/), установленной на локальном компьютере. Если вы используете macOS, большинство инструкций будут аналогичными.
- Установленный компонент Azure Machine Learning Operationalization с настроенной средой для локального развертывания и созданной учетной записью управления моделями (см. это [руководство](https://github.com/Azure/Machine-Learning-Operationalization/blob/master/documentation/getting-started.md)).
- Для этого примера потребуется обновить Pandas до версии 0.20.3 или более поздней и установить библиотеку matplotlib. В Workbench в меню *File* (Файл) щелкните *Open Command Prompt* (Открыть командную строку) и выполните следующие команды, чтобы установить эти зависимости:

    ```
    conda install "pandas>=0.20.3"

    conda install matplotlib
    ```
    
## <a name="create-a-new-workbench-project"></a>Создание проекта в Workbench

Создайте проект, используя в качестве шаблона следующий пример:
1.  Откройте Azure Machine Learning Workbench.
2.  На странице **Projects** (Проекты) щелкните знак **+** и выберите **New Project** (Создать проект).
3.  В области **Create New Project** (Создание проекта) введите информацию о новом проекте.
4.  В поле поиска **Search Project Templates** (Поиск шаблонов проектов), введите Energy Demand Time Series Forecasting (Прогнозирование потребности в энергии с использованием временных рядов) и выберите шаблон.
5.  Нажмите кнопку **Создать**


## <a name="data-description"></a>Описание данных

В этом сценарии используется два набора данных: `nyc_demand.csv` и `nyc_weather.csv`.

Набор данных **nyc_demand.csv** содержит значения потребления энергии за каждый час в городе Нью-Йорк за период 2012–2017 гг. Данные имеют следующую простую структуру:

| timeStamp (метка времени) | demand (потребление) |
| --- | --- |
| 2012-01-01 00:00:00 | 4937,5 |
| 2012-01-01 01:00:00 | 4752,1 |
| 2012-01-01 02:00:00 | 4542,6 |
| 2012-01-01 03:00:00 | 4357,7 |

Значения потребления указаны в мегаватт-часах (МВт·ч). Ниже приведена диаграмма потребления энергии за 7 дней (июль 2017 г.).

![Потребление энергии](./media/scenario-time-series-forecasting/energy_demand.png  "Energy demand")

Набор данных **nyc_weather.csv** содержит значения погодных условий за каждый час в городе Нью-Йорк за период 2012–2017 гг.

| timeStamp (метка времени) | precip (осадки) | temp
| --- | --- | --- |
| 2012-01-01 00:00:00 | 0,0 | 46,13 |
| 2012-01-01 01:00:00 | 0,01 | 45,89 |
| 2012-01-01 02:00:00 | 0,05 | 45,04 |
| 2012-01-01 03:00:00 | 0,02 | 45,03 |

*precip* — это уровень осадков в процентах. Значения *temp* (температуры) повторно нормализованы, чтобы все они попали в диапазон [0, 100].

## <a name="scenario-structure"></a>Структура сценария

При первом открытии этого проекта в Azure Machine Learning Workbench перейдите в область *Files* (Файлы) слева. Для этого примера предоставляются следующие файлы с кодом:
- `1-data-preparation.ipynb` — записная книжка Jupyter для скачивания и обработки данных для их подготовки к моделированию. Это первая записная книжка, которую вы запустите.
- `2-linear-regression.ipynb` — записная книжка для обучения модели линейной регрессии на основе данных для обучения.
- `3-ridge.ipynb` — обучение модели гребневой регрессии.
- `4-ridge-poly2.ipynb` — обучение модели гребневой регрессии на основе полиномиальных функций второй степени.
- `5-mlp.ipynb` — обучение многослойной нейронной сети персептронного типа.
- `6-dtree.ipynb` — обучение модели дерева принятия решений.
- `7-gbm.ipynb` — обучение модели градиентного бустинга.
- `8-evaluate-model.py` — скрипт для загрузки обученной модели и создания с ее помощью прогнозов на основе тестового набора контрольных данных. Он предоставляет метрики оценки модели для сравнения эффективности разных моделей.
- `9-forecast-output-exploration.ipynb` — записная книжка для визуализации прогнозов, созданных с помощью моделей машинного обучения.
- `10-deploy-model.ipynb` — записная книжка, в которой показано, как реализовать обученную модель прогнозирования в виде веб-службы, работающей в реальном времени.
- `evaluate-all-models.py` — скрипт для оценки всех обученных моделей. Его можно использовать вместо скрипта `8-evaluate-model.py`, выполняемого отдельно для каждой обученной модели.

### <a name="1-data-preparation-and-cleaning"></a>1. Подготовка и очистка данных

Для выполнения примера сначала щелкните `1-data-preparation.ipynb`, чтобы открыть записную книжку в режиме предварительного просмотра. Щелкните ***Start Notebook Server*** (Запустить сервер записных книжек), чтобы запустить сервер записных книжек Jupyter и ядро Python на своем компьютере. Вы можете запустить записные книжки в Workbench или в браузере, перейдя по адресу [http://localhost:8888](http://localhost:8888). Обратите внимание, что необходимо изменить переменную ядра на локальную переменную *PROJECT_NAME*. Это можно сделать в записной книжке в меню *Kernel* (Ядро) раздела *Change kernel* (Изменение ядра). Нажмите клавиши ***SHIFT+ВВОД***, чтобы выполнить код в отдельных ячейках записной книжки, или щелкните *Run All* (Запустить все) в меню *Cell* (ячейка), чтобы выполнить всю записную книжку.

Сначала с помощью записной книжки будут скачаны данные из контейнера хранилища BLOB-объектов в Azure. В дальнейшем эти данные будут храниться на компьютере в расположении `AZUREML_NATIVE_SHARE_DIRECTORY`. Это расположение доступно из любой записной книжки или скрипта, выполняемых в Workbench, поэтому оно отлично подходит для хранения данных и обученных моделей.

После скачивания данных выполняется их очистка путем заполнения пропусков во временных рядах и отсутствующих значений с использованием метода интерполяции. Таким образом, очистка данных временных рядов увеличивает объем данных, доступных для обучения моделей.

На основе очищенных необработанных данных создается несколько функций модели. Эти функции можно разделить на две группы:

- **Временные функции**. Эти функции являются производными от переменной *timestamp*, например *month*, *dayofweek* и *hour*.
- **Функции запаздывания** — это значения фактической потребности со сдвигом во времени или значения температуры. Эти функции предназначены для выявления условных зависимостей между последовательными периодами времени в модели.

Итоговый набор данных функций можно использовать при разработке моделей прогнозирования.

### <a name="2-model-development"></a>2. Разработка модели

В качестве первого метода моделирования можно использовать простую модель линейной регрессии. В записной книжке `2-linear-regression.ipynb` показано, как обучить модель линейной регрессии для прогнозирования потребности в энергии в будущем. В частности, модель будет обучаться для прогнозирования потребности в энергии на один час вперед (*t+1*) от текущего периода времени (*t*). Тем не менее эту одноэтапную модель можно применять рекурсивно в ходе тестирования, чтобы создать прогнозы для последующих периодов времени *t+n*.

Для обучения модели создается прогнозирующей конвейер, который состоит из трех отдельных этапов:

- **Преобразование данных.** Необходимые форматы входных данных могут отличаться в зависимости от алгоритма машинного обучения. В нашем случае для модели линейной регрессии требуется, чтобы категориальные переменные были закодированны с помощью унитарной кодировки.
- **Процедура перекрестной проверки.** Как правило, в модели машинного обучения есть один или несколько гиперпараметров, которые необходимо настроить путем экспериментирования. Перекрестную проверку можно использовать для поиска оптимального набора значений параметров. Модель обучается и оценивается несколько раз с использованием разных сверток набора данных. Наиболее подходящими являются те параметры, при которых модель достигла наилучших показателей эффективности при усреднении с учетом всех сверток перекрестной проверки. Этот процесс более подробно описан в файле `2-linear-regression.ipynb`.
- **Обучение итоговой модели.** Модель обучается на основе всего набора данных с использованием оптимального набора гиперпараметров.

Мы добавили в записные книжки 2–7 набор из 6 разных моделей. Все записные книжки обучают разные модели, которые сохраняются в расположении `AZUREML_NATIVE_SHARE_DIRECTORY`. После обучения всех моделей, разработанных для этого сценария, мы сможем оценить и сравнить их, как описано в следующем разделе.

### <a name="3-model-evaluation-and-comparison"></a>3. Оценка и сравнение моделей

Чтобы сделать прогнозы на будущие периоды, мы можем использовать обученную модель. Для оценки моделей лучше всего использовать тестовый набор контрольных данных. Оценивая разные модели на основе одного неучитываемого набора данных, мы можем просто сравнить их эффективность и определить оптимальную модель. В этом сценарии мы рекурсивно применяем обученную модель для прогнозирования нескольких будущих периодов. В частности мы создаем прогнозы на шесть часов вперед (*t+6*) от текущего часа (*t*). Эти прогнозы оцениваются относительно фактического потребления, наблюдаемого для каждого периода времени.

Чтобы оценить модель, откройте скрипт `8-evaluate-model.py` в области *Files* (Файлы) в Workbench. Установите для параметра *Run Configuration* (Конфигурация запуска) значение **local** (Локальная) и введите имя модели в поле *Arguments* (Аргументы). Имя модели должно полностью совпадать со значением переменной *model_name*, заданным в начале записной книжки, с помощью которой обучалась модель. Например, введите linear_regression для оценки обученной модели линейной регрессии. Кроме того, после обучения всех моделей вы можете оценить их все с помощью одной команды, выполнив скрипт `evaluate-all-models.py`. Для запуска этого скрипта откройте командную строку в Workbench и выполните следующую команду.

```
python evaluate-all-models.py
```
С помощью скрипта `8-evaluate-model.py` выполняются следующие операции:

- загрузка конвейера обученной модели с диска;
- создание прогнозов на основе тестового набора данных;
- вычисление метрик эффективности модели и их регистрация;
- сохранение результатов прогнозов на основе тестовых наборов данных в расположение `AZUREML_NATIVE_SHARE_DIRECTORY` для последующей проверки и анализа;
- сохранение конвейера обученной модели в папку *outputs*.

> [!Note]
> Когда модель сохраняется в папку *outputs*, в учетную запись хранилища BLOB-объектов Azure, связанную с учетной записью службы "Экспериментирование", автоматически копируется объект модели. Это означает, что вы всегда сможете извлечь сохраненный объект модели из большого двоичного объекта даже на другом компьютере или в другом контексте вычислений.

Перейдите в область *Run History* (Журнал выполнения) и щелкните `8-evaluate-model.py`. Отобразятся диаграммы с несколькими метриками эффективности модели:

- **ME** — средняя погрешность прогноза. Этот показатель можно интерпретировать как среднее смещение прогноза.
- **MPE** — [средняя процентная погрешность](https://en.wikipedia.org/wiki/Mean_percentage_error) (показатель ME выражен в процентах от фактического потребления).
- **MSE** — [среднеквадратическая погрешность](https://en.wikipedia.org/wiki/Mean_squared_error).
- **RMSE** — средняя среднеквадратическая погрешность (квадратный корень из MSE).
- **MAPE** — [средняя абсолютная погрешность в процентах](https://en.wikipedia.org/wiki/Mean_absolute_percentage_error).
- **sMAPE** — [симметричная средняя абсолютная погрешность в процентах](https://en.wikipedia.org/wiki/Symmetric_mean_absolute_percentage_error).
- **MAPE_base** — MAPE базового прогноза, в котором спрогнозированное значение равно последнему известному значению потребности.
- **MdRAE** — медианная относительная абсолютная погрешность. Медианное соотношение погрешности прогноза к погрешности базового прогноза. Значение меньше 1 означает, что прогноз более эффективен, чем базовый.

Все метрики выше касаются прогноза *t+1*. Помимо этих метрик также отображается набор соответствующих метрик с суффиксом *_horizon*. Это усредненная метрика за все периоды в диапазоне прогноза: от периода *t+1* до *t+6*.

Если метрики не отображаются в области диаграммы, щелкните значок шестеренки в правом верхнем углу. Установите флажки для необходимых метрик эффективности модели. Метрики также будут отображаться в таблице под диаграммами. Напомним, что эту таблицу можно настроить. Для этого щелкните значок с шестеренкой. Отсортируйте данные таблицы по метрикам эффективности, чтобы определить оптимальную модель. Чтобы просмотреть, как варьируется эффективность прогноза от периода *t+1* до *t+6*, щелкните запись модели в таблице. Диаграммы с метриками MAPE, MPE и MdRAE за период прогноза показаны в разделе *Visualizations* (Визуализации).

При оценке моделей прогнозирования рекомендуется визуализировать выходные данные прогнозов. Это позволит специалисту по анализу и обработке данных определить, реалистичен ли выполненный прогноз. Кроме того, это поможет выявить проблемы в прогнозе, если, например, прогноз составлен неточно для определенных периодов времени. С помощью записной книжки `9-forecast-output-exploration.ipynb` выполняется визуализация прогнозов, созданных на основе тестового набора данных.

### <a name="4-deployment"></a>4. Развертывание

Наиболее подходящую модель можно ввести в эксплуатацию, развернув ее в качестве веб-службы, работающей в реальном времени. Затем эту веб-службу можно вызывать для создания прогнозов по требованию по мере появления новых данных. В этом сценарии новый прогноз должен создаваться каждый час, чтобы спрогнозировать потребность в энергии на следующий час. Для выполнения этой задачи можно развернуть веб-службу, которая принимает массив функций для заданного одночасового периода времени в качестве входных данных и возвращает прогнозируемое потребление в качестве выходных данных.

В этом примере веб-служба развертывается на компьютере под управлением Windows 10. Убедитесь, что вы выполнили все обязательные шаги для локального развертывания, приведенные в этом [руководстве по началу работы](https://github.com/Azure/Machine-Learning-Operationalization/blob/master/documentation/getting-started.md) для интерфейса командной строки Operationalization. После настройки локальной среды и учетной записи управления моделями запустите записную книжку `10-deploy-model.ipynb`, чтобы развернуть веб-службу.

## <a name="conclusion"></a>Заключение

В этом примере показано, как создать комплексное решение прогнозирования временных рядов для прогнозирования потребности в энергии. Многие из принципов, рассмотренных в этом примере, могут применяться в других сценариях прогнозирования и областях.

В этом сценарии показано, как Azure Machine Learning Workbench может помочь специалисту по анализу и обработке данных в разработке реальных решений с полезными функциями, такими как среда записной книжки Jupyter и ведение журнала с метриками. Кроме того, в примере приведены инструкции по реализации и развертыванию модели с помощью интерфейса командной строки Azure Machine Learning Operationalization. После развертывания веб-службы разработчики или инженеры данных могут с помощью API интегрировать модель прогнозирования в конвейер данных большего размера.

---
title: "Программное переобучение моделей машинного обучения | Документация Майкрософт"
description: "Узнайте о том, как осуществить программное переобучение модели и обновить веб-службу так, чтобы она использовала переобученную модель при задействовании функций машинного обучения Azure."
services: machine-learning
documentationcenter: 
author: raymondlaghaeian
manager: jhubbard
editor: cgronlun
ms.assetid: 7ae4f977-e6bf-4d04-9dde-28a66ce7b664
ms.service: machine-learning
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/19/2017
ms.author: raymondl;garye;v-donglo
ms.openlocfilehash: c56ce659766536772d203d0366ef6b53e544a82b
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="retrain-machine-learning-models-programmatically"></a>Программное переобучение моделей машинного обучения
В этом пошаговом руководстве вы узнаете, как выполнить программное переобучение веб-службы машинного обучения Azure с использованием C# и службы пакетного выполнения машинного обучения.

Следующие руководства содержат инструкции по обновлению модели в прогнозной веб-службе после переобучения модели.

* Если вы ранее развернули классическую веб-службу на портале веб-служб машинного обучения, изучите статью [Переобучение классической веб-службы](retrain-a-classic-web-service.md). 
* Если вы используете новую веб-службу, см. статью [Переобучение новой веб-службы с помощью командлетов управления PowerShell машинного обучения](retrain-new-web-service-using-powershell.md).

Сам процесс повторного обучения описан в статье [Retrain a Machine Learning Model](retrain-machine-learning-model.md) (Переобучение модели машинного обучения).

Если вы работаете с уже существующей веб-службой на основе Azure Resource Manager, см. статью [Retrain an existing Predictive Web service](retrain-existing-resource-manager-based-web-service.md) (Переобучение существующей прогнозной веб-службы).

## <a name="create-a-training-experiment"></a>Создание обучающего эксперимента
В этой статье используется пример "Sample 5: Train, Test, Evaluate for Binary Classification: Adult Dataset" (Образец 5. Обучение, тестирование, анализ для классификации бинарных файлов: набор данных с содержимым для взрослых) из каталога образцов Машинного обучения Microsoft Azure. 

Чтобы создать эксперимент:

1. Войдите в Студию машинного обучения Microsoft Azure. 
2. В нижнем правом углу панели мониторинга щелкните **Создать**.
3. В списке образцов Майкрософт выберите образец 5.
4. Чтобы переименовать эксперимент, в верхней части холста эксперимента выберите имя эксперимента "Sample 5: Train, Test, Evaluate for Binary Classification: Adult Dataset" (Образец 5. Обучение, тестирование, анализ для классификации бинарных файлов: набор данных с содержимым для взрослых).
5. Введите "Модель ценза".
6. В нижней части холста эксперимента нажмите кнопку **Run**(Выполнить).
7. Щелкните **Set Up Web Service** (Настроить веб-службу) и выберите **Retraining Web Service** (Переобучение веб-службы). 

Ниже приведен исходный эксперимент.
   
   ![Исходный эксперимент][2]


## <a name="create-a-predictive-experiment-and-publish-as-a-web-service"></a>Создание прогнозного эксперимента и его публикация в виде веб-службы
Теперь нужно создать прогнозный эксперимент.

1. В нижней части холста эксперимента щелкните **Set Up Web Service** (Настроить веб-службу) и выберите **Predictive Web Service** (Прогнозная веб-служба). При этом модель сохраняется в качестве обученной и добавляются модули входных и выходных данных веб-службы. 
2. Щелкните **Выполнить**. 
3. Когда эксперимент будет выполнен, щелкните **Deploy Web Service [Classic]** (Развернуть веб-службу [классическую]) или **Deploy Web Service [New]** (Развернуть веб-службу [новую]).

> [!NOTE] 
> Для развертывания новой веб-службы у вас должен быть достаточный уровень разрешений в подписке, в которую выполняется развертывание веб-службы. Дополнительные сведения см. в статье [Управление веб-службой с помощью портала веб-служб машинного обучения Azure](manage-new-webservice.md). 

## <a name="deploy-the-training-experiment-as-a-training-web-service"></a>Развертывание обучающего эксперимента в качестве обучающей веб-службы
Чтобы переобучить обученную модель, необходимо развернуть обучающий эксперимент, созданный в качестве веб-службы переобучения. Для создания обученных моделей этой веб-службе потребуется модуль *Web Service Output* (Выходные данные веб-службы), подключенный к модулю *[Обучение модели][train-model]*.

1. Чтобы вернуться в обучающий эксперимент, щелкните значок "Эксперименты" на левой панели, а затем выберите эксперимент "Модель ценза".  
2. В поле поиска "Search Experiment Items" (Поиск элементов эксперимента) введите "Web service". 
3. Перетащите модуль *входных данных веб-службы* на холст эксперимента и присоедините его вывод к модулю *Очистка недостающих данных*.  Это гарантирует, что данные для переобучения будут обработаны так же, как исходный набор обучающих данных.
4. Перетащите два модуля *Web service Output* (Выходные данные веб-службы) на холст эксперимента. Присоедините к одному из них вывод модуля *Обучение модели*, а к другому — вывод модуля *Анализ модели*. Выходные данные веб-службы для модуля **Train Model** (Обучение модели) позволяют создать обученную модель. Выходные данные, прикрепленные к модулю **Анализ модели**, возвращают результаты анализа, подготовленные модулем.
5. Щелкните **Выполнить**. 

Затем необходимо развернуть обучающий эксперимент в качестве веб-службы, которая создает обученную модель и результаты ее оценки. Для этого необходимо выполнить действия, которые зависят от того, как развернут эксперимент: как классическая веб-служба или как новая веб-служба.  

**Классическая веб-служба**

В нижней части холста эксперимента щелкните **Set Up Web Service** (Настроить веб-службу) и выберите **Deploy Web Service [Classic]** (Развернуть веб-службу [классическую]). **Панель мониторинга** веб-службы отображается с ключом API и страницей справки API для пакетного выполнения. Для создания обученных моделей может использоваться только метод пакетного выполнения.

**Новая веб-служба**

В нижней части холста эксперимента щелкните **Set Up Web Service** (Настроить веб-службу) и выберите **Deploy Web Service [New]** (Развернуть веб-службу [новую]). Портал веб-служб машинного обучения Azure откроется на странице "Deploy Web service" (Развертывание веб-службы). Введите имя веб-службы и выберите план платежей, а затем нажмите кнопку **Deploy**(Развернуть). Для создания обученных моделей может использоваться только метод пакетного выполнения.

В любом случае, после завершения эксперимента итоговый рабочий процесс должен выглядеть следующим образом:

![Итоговый рабочий процесс после выполнения][4]



## <a name="retrain-the-model-with-new-data-using-bes"></a>Переобучение модели с использованием новых данных и BES
В этом примере вы создадите приложение повторного обучения на языке C#. Также для этих целей можно использовать образцы кода на R или Python.

Чтобы вызвать интерфейсы API:

1. Создайте консольное приложение C# в Visual Studio (**Создать** > **Проект** > **Visual C#** > **Классический рабочий стол Windows** > **Консольное приложение (.NET Framework**).
2. Войдите на портал веб-служб Машинного обучения.
3. Если вы работаете с классической веб-службой, щелкните **Classic Web Services**(Классические веб-службы).
   1. Щелкните веб-службу, с которой вы работаете.
   2. Щелкните конечную точку по умолчанию.
   3. Щелкните **Consume**(Использование).
   4. В нижней части страницы **Consume** (Использование) в разделе **Sample Code** (Пример кода) щелкните **Batch** (Пакет).
   5. Перейдите к шагу 5 этой процедуры.
4. Если вы работаете с новой веб-службой, щелкните **Web Services**(Веб-службы).
   1. Щелкните веб-службу, с которой вы работаете.
   2. Щелкните **Consume**(Использование).
   3. В нижней части страницы использования в разделе **Sample Code** (Пример кода) щелкните **Batch** (Пакет).
5. Скопируйте пример кода на C# для пакетного выполнения и вставьте его в файл Program.cs, убедившись, что пространство имен остается в неизменном виде.

Добавьте пакет Nuget Microsoft.AspNet.WebApi.Client, как указано в комментариях. Чтобы добавить ссылку на файл Microsoft.WindowsAzure.Storage.dll, может потребоваться сначала установить клиентскую библиотеку для служб хранилища Microsoft Azure. Дополнительные сведения см. в документации о [Службе хранилища Windows Azure](https://www.nuget.org/packages/WindowsAzure.Storage).

### <a name="update-the-apikey-declaration"></a>Обновление объявления apiKey
Найдите объявление **apiKey** .

    const string apiKey = "abc123"; // Replace this with the API key for the web service

В разделе **Basic consumption info** (Основные сведения об использовании) на странице **Consume** (Использование) найдите первичный ключ и скопируйте его в объявление **apiKey**.

### <a name="update-the-azure-storage-information"></a>Обновление сведений о службе хранилища Azure
Пример кода BES отправляет файл из локального диска (например, C:\temp\CensusIpnput.csv) в службу хранилища Azure, обрабатывает его и записывает результаты обратно в службу хранилища Azure.  

Для этого нужно получить имя учетной записи хранения, ключ и сведения о контейнере для вашей учетной записи хранения на классическом портале Azure, а затем обновить соответствующие значения в коде. 

1. Войдите на классический портал Azure.
2. В левой области навигации щелкните **Хранилище**.
3. Выберите в списке учетную запись хранения, которая будет использоваться для хранения переобученной модели.
4. В нижней части страницы щелкните **Управление ключами доступа**.
5. Скопируйте и сохраните **Первичный ключ доступа** , а затем закройте диалоговое окно. 
6. В верхней части страницы щелкните **Контейнеры**.
7. Выберите существующий контейнер или создайте новый и сохраните его имя.

Найдите объявления *StorageAccountName*, *StorageAccountKey* и *StorageContainerName* и обновите их, используя значения, взятые с портала Azure.

    const string StorageAccountName = "mystorageacct"; // Replace this with your Azure Storage Account name
    const string StorageAccountKey = "a_storage_account_key"; // Replace this with your Azure Storage Key
    const string StorageContainerName = "mycontainer"; // Replace this with your Azure Storage Container name

Кроме этого, необходимо обеспечить доступность файла входных данных в расположении, указанном в коде. 

### <a name="specify-the-output-location"></a>Указание расположения выходных данных
В описании расположения выходных данных, указанном в полезных данных запроса, указанный в параметре *RelativeLocation* файл должен иметь расширение ilearner. 

Как в этом примере:

    Outputs = new Dictionary<string, AzureBlobDataReference>() {
        {
            "output1",
            new AzureBlobDataReference()
            {
                ConnectionString = storageConnectionString,
                RelativeLocation = string.Format("{0}/output1results.ilearner", StorageContainerName) /*Replace this with the location you would like to use for your output file, and valid file extension (usually .csv for scoring results, or .ilearner for trained models)*/
            }
        },

> [!NOTE]
> Имена расположений для выходных данных могут отличаться от указанных в этом пошаговом руководстве в зависимости от того, в каком порядке добавлены модули выходных данных веб-службы. Так как для этого обучающего эксперимента настроены два вывода, в результатах будет содержаться информация о расположении хранения для обоих выводов.  
> 
> 

![Выходные данные переобучения][6]

Схема 4. Выходные данные переобучения

## <a name="evaluate-the-retraining-results"></a>Анализ результатов переобучения
При выполнении приложения выходные данные содержат URL-адрес и маркер SAS, необходимые для доступа к результатам оценки.

Чтобы увидеть результаты работы переобученной модели, введите в адресную строку браузера полный URL-адрес, составленный из значений параметров *BaseLocation*, *RelativeLocaiton* и *SasBlobToken*, содержащихся в выходных данных *output2* (как показано на изображении выше).  

Проанализируйте результаты и определите, достаточно ли хорошо работает только что обученная модель, чтобы заменить имеющуюся.

В полученных выходных данных скопируйте значения параметров *BaseLocation*, *RelativeLocation* и *SasBlobToken*. Они вам потребуются в процессе переобучения.

## <a name="next-steps"></a>Дальнейшие действия
Если вы развернули прогнозную веб-службу с помощью команды **Deploy Web Service [Classic]** (Развернуть веб-службу [классическую]), см. статью [Переобучение классической веб-службы](retrain-a-classic-web-service.md).

Если вы развернули прогнозную веб-службу с помощью команды **Deploy Web Service [New]** (Развернуть веб-службу [новую]), см. статью [Переобучение новой веб-службы с помощью командлетов управления PowerShell машинного обучения](retrain-new-web-service-using-powershell.md).

<!-- Retrain a New web service using the Machine Learning Management REST API -->


[1]: ./media/retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE01.png
[2]: ./media/retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE02.png
[3]: ./media/retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE03.png
[4]: ./media/retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE04.png
[5]: ./media/retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE05.png
[6]: ./media/retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE06.png
[7]: ./media/retrain-models-programmatically/machine-learning-retrain-models-programmatically-IMAGE07.png


<!-- Module References -->
[train-model]: https://msdn.microsoft.com/library/azure/5cc7053e-aa30-450d-96c0-dae4be720977/

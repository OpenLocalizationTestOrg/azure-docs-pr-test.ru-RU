---
title: "Создание пользовательских R-модулей в Машинном обучении Azure | Документация Майкрософт"
description: "Краткое руководство по созданию пользовательских R-модулей в Машинном обучении Azure."
services: machine-learning
documentationcenter: 
author: bradsev
manager: cgronlun
editor: cgronlun
ms.assetid: 6cbc628a-7e60-42ce-9f90-20aaea7ba630
ms.service: machine-learning
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: tbd
ms.date: 11/29/2017
ms.author: bradsev;ankarlof;garye
ms.openlocfilehash: 16442a30f130e7cc9b60d2d9ae9c86d7282471ff
ms.sourcegitcommit: 9a8b9a24d67ba7b779fa34e67d7f2b45c941785e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2018
---
# <a name="author-custom-r-modules-in-azure-machine-learning"></a>Создание пользовательских R-модулей в Машинном обучении Azure
В этой статье описывается процедура создания и развертывания пользовательского R-модуля в Машинном обучении Azure. Здесь поясняется, что такое пользовательский R-модуль, и какие файлы используются для его создания. В этом разделе также описан способ создания файлов, определяющих модуль, и регистрации модуля для его развертывания в рабочей области Машинного обучения. Затем более подробно описываются элементы и атрибуты, используемые в определении пользовательского модуля. Кроме этого, здесь рассматриваются способы использования дополнительных функций, файлов и нескольких наборов выходных данных. 

[!INCLUDE [machine-learning-free-trial](../../../includes/machine-learning-free-trial.md)]

## <a name="what-is-a-custom-r-module"></a>Что такое пользовательский R-модуль?
**Пользовательский модуль** — это определяемый пользователем модуль, который можно передать в свою рабочую область и выполнить в рамках эксперимента Машинного обучения Azure. **Пользовательский R-модуль** представляет собой настраиваемый модуль, который выполняет определяемую пользователем R-функцию. **R** — это язык программирования, предназначенный для статистических вычислений и работы с графикой. Его широко используют специалисты по статистике, а также обработке и анализу данных для реализации алгоритмов. В настоящее время R — это единственный язык, поддерживаемый в пользовательских модулях, но в следующих выпусках планируется добавить поддержку и других языков.

Пользовательские модули принадлежат к **группе первоклассных модулей** в Машинном обучении Azure в том смысле, что их можно использовать наравне с любым другим модулем. Их можно выполнять с другими модулями, включенными в опубликованный эксперимент или визуализации. Вы можете управлять алгоритмом, реализуемым модулем, используемыми портами ввода и вывода, параметрами моделирования и другими параметрами, определяющими поведение во время выполнения. Эксперимент с пользовательскими модулями также можно опубликовать в коллекции решений ИИ Azure, чтобы упростить его совместное использование.

## <a name="files-in-a-custom-r-module"></a>Файлы в пользовательском R-модуле
Пользовательский R-модуль создается на основе ZIP-файла, содержащего как минимум два файла:

* **исходный файл** , который реализует R-функцию, предоставляемую модулем;
* **XML-файл определения** , описывающий интерфейс пользовательского модуля.

В ZIP-файл также можно включить дополнительные вспомогательные файлы, обеспечивающие функциональные возможности, доступ к которым можно получить из пользовательского модуля. Эта возможность описана в подразделе **Аргументы** в справочном разделе **Элементы в XML-файле определения** после примера быстрого запуска.

## <a name="quickstart-example-define-package-and-register-a-custom-r-module"></a>Пример быстрого запуска: определение, создание пакета и регистрация пользовательского R-модуля
В этом примере показано, как создать файлы, необходимые для пользовательского R-модуля, упаковать их в ZIP-файл и затем зарегистрировать модуль в рабочей области Машинного обучения. Пример ZIP-пакета и файлов можно скачать на странице [скачивания файла CustomAddRows.zip](http://go.microsoft.com/fwlink/?LinkID=524916&clcid=0x409).

## <a name="the-source-file"></a>Исходный файл
Рассмотрим пример модуля **Custom Add Rows** (Добавление пользовательских строк), который изменяет стандартную реализацию модуля **Add Rows** (Добавление строк), используемого для объединения строк (наблюдений) из двух наборов данных (кадров данных). Стандартный модуль **Add Rows** (Добавление строк) добавляет строки второго входного набора данных в конец первого входного набора данных, используя алгоритм `rbind`. Настраиваемая функция `CustomAddRows` подобным образом принимает в качестве входных данных два набора данных, а также дополнительный логический параметр переноса значений. Если для параметра переноса задано значение **FALSE**, она возвращает тот же набор данных, что и при стандартной реализации. Если же для параметра переноса задано значение **TRUE**, функция добавляет строки из первого входного набора данных в конец второго набора данных. Файл CustomAddRows.R, содержащий реализацию функции R `CustomAddRows` , предоставляемой модулем **Добавление пользовательских строк** , содержит следующий код на языке R.

    CustomAddRows <- function(dataset1, dataset2, swap=FALSE) 
    {
        if (swap)
        {
            return (rbind(dataset2, dataset1));
        }
        else
        {
            return (rbind(dataset1, dataset2));
        } 
    } 

### <a name="the-xml-definition-file"></a>XML-файл определения
Чтобы предоставить данную `CustomAddRows` функцию как модуль Машинного обучения Azure, необходимо создать XML-файл определения, чтобы задать вид и поведение модуля **Добавление пользовательских строк** . 

    <!-- Defined a module using an R Script -->
    <Module name="Custom Add Rows">
        <Owner>Microsoft Corporation</Owner>
        <Description>Appends one dataset to another. Dataset 2 is concatenated to Dataset 1 when Swap is FALSE, and vice versa when Swap is TRUE.</Description>

    <!-- Specify the base language, script file and R function to use for this module. -->        
        <Language name="R" 
         sourceFile="CustomAddRows.R" 
         entryPoint="CustomAddRows" />  

    <!-- Define module input and output ports -->
    <!-- Note: The values of the id attributes in the Input and Arg elements must match the parameter names in the R Function CustomAddRows defined in CustomAddRows.R. -->
        <Ports>
            <Input id="dataset1" name="Dataset 1" type="DataTable">
                <Description>First input dataset</Description>
            </Input>
            <Input id="dataset2" name="Dataset 2" type="DataTable">
                <Description>Second input dataset</Description>
            </Input>
            <Output id="dataset" name="Dataset" type="DataTable">
                <Description>The combined dataset</Description>
            </Output>
        </Ports>

    <!-- Define module parameters -->
        <Arguments>
            <Arg id="swap" name="Swap" type="bool" >
                <Description>Swap input datasets.</Description>
            </Arg>
        </Arguments>
    </Module>


Обратите внимание, что значение атрибутов **id** элементов **Input** и **Arg** в XML-файле должно ПОЛНОСТЬЮ совпадать с именами параметров функций кода R в файле CustomAddRows.R (в данном примере это *dataset1*, *dataset2* и *swap*). Аналогичным образом значение атрибута **entryPoint** элемента **Language** должно ПОЛНОСТЬЮ соответствовать имени функции в R-скрипте (в данном примере это *CustomAddRows*). 

И наоборот, атрибут **id** элемента **Output** не соответствует каким-либо переменным в R-скрипте. Если требуется несколько наборов выходных данных, следует просто вернуть список из функции R с результатами, размещенными *в том же порядке* , в котором **выходные данные** заявлены в XML-файле.

### <a name="package-and-register-the-module"></a>Создание пакета и регистрация модуля
Сохраните эти два файла как *CustomAddRows.R* и *CustomAddRows.xml*, а затем поместите их в архивный файл *CustomAddRows.zip*.

Чтобы зарегистрировать их в рабочей области машинного обучения, перейдите в свою рабочую область в Студии машинного обучения, нажмите кнопку **+Создать** в нижней части страницы и выберите **Модуль -> From zip package** (Из ZIP-пакета), чтобы передать новый пользовательский модуль **Custom Add Rows** (Добавление пользовательских строк).

![Передача ZIP-файла](./media/custom-r-modules/upload-from-zip-package.png)

Теперь модуль **Добавление пользовательских строк** доступен из экспериментов Машинного обучения.

## <a name="elements-in-the-xml-definition-file"></a>Элементы в XML-файле определения
### <a name="module-elements"></a>Элементы «Модуль»
Элемент **Модуль** используется для определения пользовательского модуля в XML-файле. С помощью нескольких элементов **модуль** в одном XML-файле можно определить несколько модулей. Каждый модуль в рабочей области должен иметь уникальное имя. Если зарегистрировать пользовательский модуль с таким же именем, как у имеющегося пользовательского модуля, существующий модуль заменится на новый. При этом пользовательский модуль можно зарегистрировать с таким же именем, как у имеющегося модуля машинного обучения Azure. Он появится в категории **пользовательских** на палитре модулей.

    <Module name="Custom Add Rows" isDeterministic="false"> 
        <Owner>Microsoft Corporation</Owner>
        <Description>Appends one dataset to another...</Description>/> 


В элементе **Module** можно указать два дополнительных необязательных элемента:

* элемент **Owner** , внедренный в модуль;  
* элемент **Description** , содержащий текст, отображающийся в экспресс-справке для модуля и при наведении на модуль в пользовательском интерфейсе машинного обучения.

Правила по ограничению количества символов в элементах Module:

* Значение атрибута **name** в элементе **Module** не должно превышать 64 символа. 
* Содержимое элемента **Описание** не должно превышать 128 символов.
* Содержимое элемента **Владелец** не должно превышать 32 символа.

Результаты модуля могут быть детерминированными или недетерминированными.** По умолчанию все модули считаются детерминированными. Другими словами, при прочих равных входных параметрах и данных модуль должен выдать одни и те же результаты при каждом выполнении. Это означает, что Студия машинного обучения Azure повторяет выполнение только модулей, помеченных как детерминированные, если параметр или входные данные были изменены. При возвращении кэшированных результатов эксперименты можно проводить гораздо быстрее.

Существуют недетерминированные функции, например RAND или функция, возвращающая текущую дату и время. Если в модуле используется недетерминированная функция, можно указать, что модуль является недетерминированным, установив для необязательного атрибута **isDeterministic** значение **false**. Таким образом модуль будет выполняться повторно при каждом выполнении эксперимента, даже если входные данные и параметры модуля не менялись. 

### <a name="language-definition"></a>Определение языка
Элемент **Language** в XML-файле определения используется для указания языка пользовательского модуля. В настоящее время R — единственный поддерживаемый язык. Значением атрибута **sourceFile** должно быть имя R-файла, который содержит функции вызова при выполнении модуля. Этот файл должен быть в составе ZIP-пакета. Значением атрибута **entryPoint** является имя вызываемой функции. Оно должно совпадать с допустимой функцией, определенной в исходном файле.

    <Language name="R" sourceFile="CustomAddRows.R" entryPoint="CustomAddRows" />


### <a name="ports"></a>порты;
Входные и выходные порты для пользовательского модуля указываются в дочерних элементах раздела **Порты** в XML-файле определения. От того, в каком порядке заданы эти элементы, зависит структура (UX), которая будет отображаться для пользователей. Первым дочерним **входом** или **выходом** в элементе **Ports** XML-файла будет крайний слева порт входа в интерфейсе машинного обучения.
Каждый порт входа и выхода может иметь необязательный дочерний элемент **Description** , задающий текст, отображаемый при наведении курсора мыши на порт в пользовательском интерфейсе машинного обучения.

**Правила портов**:

* Максимальное число **портов входа и выхода** — по 8 для каждого.

### <a name="input-elements"></a>Входные элементы
Порты входа позволяют передавать данные в функцию R и в рабочую область. Ниже приведены **типы данных** , которые поддерживаются для портов входа. 

**DataTable:** этот тип передается R-функции в формате data.frame. Фактически все типы (например, CSV-файлы или ARFF-файлы), которые поддерживаются машинным обучением и которые совместимы с **DataTable** , автоматически преобразуются в формат data.frame. 

        <Input id="dataset1" name="Input 1" type="DataTable" isOptional="false">
            <Description>Input Dataset 1</Description>
           </Input>

Атрибут **id**, привязанный к каждому порту входа **DataTable**, должен иметь уникальное значение, которое должно совпадать с соответствующим именем параметра в функции R.
Необязательные порты **DataTable**, которые не передаются в качестве входных в эксперименте, имеют значение **null**, передаваемое в функцию R, а необязательные ZIP-порты игнорируются, если вход не подключен. Атрибут **isOptional** необязательный для типов **DataTable** и **Zip**, и для него по умолчанию задано значение *false*.

**Zip** — пользовательские модули могут принимать в качестве входных данных ZIP-файл. Эти входные данные распаковываются в рабочий каталог функции.

        <Input id="zippedData" name="Zip Input" type="Zip" IsOptional="false">
            <Description>Zip files to be extracted to the R working directory.</Description>
           </Input>

Для пользовательских модулей R идентификатор ZIP-порта не должен соответствовать параметрам функции R. Это связано с тем, что ZIP-файл автоматически извлекается в рабочий каталог R.

**Правила входных данных:**

* Значением атрибута **id** элемента **Input** должно быть допустимое имя переменной R.
* Значение атрибута **id** элемента **Input** не должно превышать 64 символа.
* Значение атрибута **name** элемента **Input** не должно превышать 64 символа.
* Содержимое элемента **Описание** не должно превышать 128 символов.
* Значение атрибута **type** элемента **Input** должно быть *Zip* или *DataTable*.
* Значение атрибута **isOptional** элемента **Input** не является обязательным (по умолчанию *false*, если значение не указано). Если значение указано, оно должно быть *true* или *false*.

### <a name="output-elements"></a>Выходные элементы
**Стандартные выходные порты** сопоставляются со значениями, выдаваемыми функцией R, что потом может использоваться последующими модулями. *DataTable* — пока единственный поддерживаемый стандартный выходной порт. (Ожидается поддержка *Learners* и *Transforms*.) Выходной объект *DataTable* определяется следующим образом:

    <Output id="dataset" name="Dataset" type="DataTable">
        <Description>Combined dataset</Description>
    </Output>

Что касается выходов в пользовательских модулях R, значение атрибута **id** не обязательно должно соответствовать скрипту R, но оно должно быть уникальным. Что касается выхода одного модуля, значение, выдаваемое функцией R, должно быть *data.frame*. Для вывода нескольких объектов поддерживаемого типа данных необходимо указать соответствующие порты в XML-файле определения, а объекты необходимо возвратить в виде списка. Выходные объекты назначаются портам вывода слева направо, в том порядке, в котором объекты размещены в возвращенном списке.

Например, если требуется изменить модуль **Custom Add Rows** (Добавление пользовательских строк) для вывода двух оригинальных наборов данных *dataset1* и *dataset2* в дополнение к новым присоединенным наборам данных *dataset* (слева направо: *dataset*, *dataset1*, *dataset2*), то необходимо определить выходные порты в файле CustomAddRows.xml следующим образом:

    <Ports> 
        <Output id="dataset" name="Dataset Out" type="DataTable"> 
            <Description>New Dataset</Description> 
        </Output> 
        <Output id="dataset1_out" name="Dataset 1 Out" type="DataTable"> 
            <Description>First Dataset</Description> 
        </Output> 
        <Output id="dataset2_out" name="Dataset 2 Out" type="DataTable"> 
            <Description>Second Dataset</Description> 
        </Output> 
        <Input id="dataset1" name="Dataset 1" type="DataTable"> 
            <Description>First Input Table</Description>
        </Input> 
        <Input id="dataset2" name="Dataset 2" type="DataTable"> 
            <Description>Second Input Table</Description> 
        </Input> 
    </Ports> 


Затем возвратите список объектов в виде списка с правильным порядком в файле CustomAddRows.R:

    CustomAddRows <- function(dataset1, dataset2, swap=FALSE) { 
        if (swap) { dataset <- rbind(dataset2, dataset1)) } 
        else { dataset <- rbind(dataset1, dataset2)) 
        } 
    return (list(dataset, dataset1, dataset2)) 
    } 

**Выход визуализации.** Вы можете также указать выходной порт типа *Визуализация*, отображающий выходные данные от графического устройства и консоли выходных данных R. Этот порт не является частью выходных данных функции R и не влияет на порядок других типов выходных портов. Для добавления порта визуализации в пользовательские модули добавьте элемент **Output** со значением *Visualization* для его атрибута **type**:

    <Output id="deviceOutput" name="View Port" type="Visualization">
      <Description>View the R console graphics device output.</Description>
    </Output>

**Правила выходных данных:**

* Значением атрибута **id** элемента **Output** должно быть допустимое имя переменной R.
* Значение атрибута **id** элемента **Output** не должно превышать 32 символа.
* Значение атрибута **name** элемента **Output** не должно превышать 64 символа.
* Значением атрибута **type** элемента **Output** должно быть *Visualization*.

### <a name="arguments"></a>Аргументы
Дополнительные данные могут передаваться в функцию R через параметры модуля, которые определяются в элементе **Аргументы**. Эти параметры отображаются в правой части панели свойств в пользовательском интерфейсе машинного обучения при выборе модуля. Аргументы могут быть любого поддерживаемого типа. При необходимости можно создать пользовательскую нумерацию. Как и элементы **Ports**, элементы **Arguments** могут иметь необязательный элемент **Description**, который задает текст, отображаемый при наведении указателя мыши на имя параметра.
Дополнительные свойства для модуля, например defaultValue, minValue и maxValue, можно добавить к любому аргументу в виде атрибутов для элемента **Properties**. Допустимые свойства для элемента **Properties** зависят от типа аргумента. Они описаны в следующем разделе, где также приведены типы поддерживаемых аргументов. Пользователям не нужно вводить значения для аргументов, свойство **isOptional** которых имеет значение **true**. Если для аргумента значение не указано, он не передается в функцию точки входа. Аргументы функции точки входа, которые не являются обязательными, необходимо явным образом обрабатывать с помощью функции, например назначать значение по умолчанию null в определении функции точки входа. Необязательный аргумент будет обеспечивать применение других ограничений аргументов, например min или max, если это значение указано пользователем.
Как и в случае с портами ввода и вывода, крайне важно, чтобы с каждым параметром было связано уникальное значение идентификатора. В нашем примере быстрого запуска привязанным идентификатором или параметром был *swap*.

### <a name="arg-element"></a>Элемент Arg
Параметр модуля определяется с помощью дочернего элемента **Arg** в разделе **Arguments** XML-файла определения. Как и в случае с дочерними элементами в разделе **Ports**, от порядка параметров в разделе **Arguments** зависит схема размещения элементов в UX. Параметры отображаются сверху вниз в пользовательском интерфейсе в том же порядке, в котором они определены в XML-файле. Здесь перечислены типы, поддерживаемые для параметров в машинном обучении. 

**int** — параметр целочисленного типа (32-разрядная версия).

    <Arg id="intValue1" name="Int Param" type="int">
        <Properties min="0" max="100" default="0" />
        <Description>Integer Parameter</Description>
    </Arg>


* *Необязательные свойства*: **min**, **max**, **default** и **isOptional**.

**double** — параметр типа double.

    <Arg id="doubleValue1" name="Double Param" type="double">
        <Properties min="0.000" max="0.999" default="0.3" />
        <Description>Double Parameter</Description>
    </Arg>


* *Необязательные свойства*: **min**, **max**, **default** и **isOptional**.

**bool** — логический параметр, который представлен в UX в виде флажка.

    <Arg id="boolValue1" name="Boolean Param" type="bool">
        <Properties default="true" />
        <Description>Boolean Parameter</Description>
    </Arg>



* *Необязательные свойства*: **по умолчанию** — значение false (если не задано).

**string**— стандартная строка

    <Arg id="stringValue1" name="My string Param" type="string">
        <Properties isOptional="true" />
        <Description>String Parameter 1</Description>
    </Arg>    

* *Необязательные свойства*: **default** и **isOptional**.

**ColumnPicker** — параметр выбора столбца. Этот тип воспроизводится в UX в виде средства выбора столбца. Элемент **Property** используется для указания идентификатора порта, из которого будут выбираться столбцы. При этом тип порта назначения должен быть *DataTable*. Результат выбора столбца передается функции R в виде списка строк, содержащих имена выбранных столбцов. 

        <Arg id="colset" name="Column set" type="ColumnPicker">      
          <Properties portId="datasetIn1" allowedTypes="Numeric" default="NumericAll"/>
          <Description>Column set</Description>
        </Arg>


* *Необходимые свойства*: **portId** — совпадает с идентификатором элемента входных данных типа *DataTable*.
* *Необязательные свойства*:
  
  * **allowedTypes** фильтрует типы столбцов для выбора. Допустимые значения: 
    
    * Числовой
    * Логическое
    * категориальные;
    * Строка
    * Метка
    * Функция
    * Оценка
    * Все
  * **по умолчанию** — варианты выбора по умолчанию, допустимые для выбора столбца: 
    
    * Нет
    * NumericFeature
    * NumericLabel
    * NumericScore
    * NumericAll
    * BooleanFeature
    * BooleanLabel
    * BooleanScore
    * BooleanAll
    * CategoricalFeature
    * CategoricalLabel
    * CategoricalScore
    * CategoricalAll
    * StringFeature
    * StringLabel
    * StringScore
    * StringAll
    * AllLabel
    * AllFeature
    * AllScore
    * Все

**DropDown**— указанный пользователем пронумерованный (раскрывающийся) список. Раскрывающийся список элементов, заданных в элементе **Properties** с помощью элемента **Item**. Элемент **id** для каждого параметра **Item** должен быть уникальной и допустимой переменной R. Значение элемента **name** параметра **Item** выступает в качестве отображаемого текста и значения, передаваемого в функцию R.

    <Arg id="color" name="Color" type="DropDown">
      <Properties default="red">
        <Item id="red" name="Red Value"/>
        <Item id="green" name="Green Value"/>
        <Item id="blue" name="Blue Value"/>
      </Properties>
      <Description>Select a color.</Description>
    </Arg>    

* *Необязательные свойства*:
  * **default** — значение свойства по умолчанию должно соответствовать значению идентификатора от одного из элементов **Item**.

### <a name="auxiliary-files"></a>Вспомогательные файлы
Любой файл, помещенный в ZIP-файл пользовательского модуля, будет доступен для использования во время выполнения. Вся структура каталогов сохраняется. Это означает, что вызов файлов работает как локально, так и при выполнении в Машинном обучении Azure. 

> [!NOTE]
> Обратите внимание, что все файлы извлекаются в каталог src, поэтому все пути должны иметь префикс src/.
> 
> 

Предположим, например, что из набора данных необходимо удалить все повторяющиеся строки и строки, в которых частично отсутствуют данные, перед выводом в функцию CustomAddRows, и вы уже написали R-функцию, которая выполняет это действие в файле RemoveDupNARows.R:

    RemoveDupNARows <- function(dataFrame) {
        #Remove Duplicate Rows:
        dataFrame <- unique(dataFrame)
        #Remove Rows with NAs:
        finalDataFrame <- dataFrame[complete.cases(dataFrame),]
        return(finalDataFrame)
    }
Вы можете вызвать вспомогательный файл RemoveDupNARows.R из функции CustomAddRows:

    CustomAddRows <- function(dataset1, dataset2, swap=FALSE) {
        source("src/RemoveDupNARows.R")
            if (swap) { 
                dataset <- rbind(dataset2, dataset1))
             } else { 
                  dataset <- rbind(dataset1, dataset2)) 
             } 
        dataset <- removeDupNARows(dataset)
        return (dataset)
    }

Затем передать ZIP-файл, содержащий CustomAddRows.R, CustomAddRows.xml и RemoveDupNARows.R, в качестве пользовательского R-модуля.

## <a name="execution-environment"></a>Среда выполнения
В среде выполнения R-скрипта используется та же версия R, что и в модуле **Выполнение R-скрипта** , и могут использоваться те же пакеты по умолчанию. В пользовательский модуль также можно добавить дополнительные пакеты R, включая их в ZIP-пакет. Просто загрузите их в R-скрипт так же, как в среду R. 

**Ограничения среды выполнения** включают:

* Несохраняемая файловая система. Файлы, записанные при выполнении пользовательского модуля, не сохраняются между несколькими запусками одного и того же модуля.
* Нет доступа к сети


---
title: "Функции обработчика правил Azure CDN | Документация Майкрософт"
description: "Справочная документация по условиям соответствия и функциям обработчика правил Azure CDN."
services: cdn
documentationcenter: 
author: Lichard
manager: akucer
editor: 
ms.assetid: 669ef140-a6dd-4b62-9b9d-3f375a14215e
ms.service: cdn
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/23/2017
ms.author: rli
ms.openlocfilehash: 6703247aa8b4a6d53ff22ea2d4f22eb4a746e370
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="azure-cdn-rules-engine-features"></a>Функции обработчика правил Azure CDN
В этой статье приводятся подробные описания доступных функций для [обработчика правил](cdn-rules-engine.md) сети доставки содержимого (CDN) Azure.

Третья часть правила представляет собой функцию. Функция определяет тип действия, который будет применяться к типу запроса, определяемого набором условий соответствия.

## <a name="access"></a>Access

Эти функции предназначены для управления доступом к содержимому.


Имя | Назначение
-----|--------
Запрет доступа | Определяет, отклоняются ли все запросы с ответом 403 (запрещено).
Проверка подлинности на основе маркеров | Определяет, будет ли применена к запросу проверка подлинности на основе маркеров.
Код отказа при проверки подлинности на основе маркеров | Определяет тип ответа, возвращаемого пользователю при отказе запроса из-за проверки подлинности на основе маркеров.
Не учитывать регистр URL-адреса при проверке подлинности на основе маркеров | Определяет, будет ли учитываться регистр в сравнениях URL-адресов, выполненных с помощью проверки подлинности на основе маркеров.
Параметр маркера проверки подлинности | Определяет, должен ли быть переименован параметр строки запроса проверки подлинности на основе маркеров.

### <a name="deny-access"></a>Запрет доступа
**Назначение.** Определяет, отклоняются ли все запросы с ответом 403 (запрещено).

Значение | Результат
------|-------
Включено| Приводит к отклонению всех запросов, соответствующих критериям сопоставления, с ответом 403 (запрещено).
Отключено| Восстанавливает поведение по умолчанию. Поведение по умолчанию предполагает разрешение серверу-источнику определять тип возвращаемого ответа.

**Поведение по умолчанию.** Отключено.

> [!TIP]
   > Один из возможных способов использования этой функции — связать ее с условием соответствия заголовка запроса, чтобы заблокировать доступ к источникам ссылок HTTP, использующих встроенные ссылки на содержимое.

### <a name="token-auth"></a>Проверка подлинности на основе маркеров
**Назначение.** Определяет, будет ли применена к запросу проверка подлинности на основе маркеров.

Если проверка подлинности на основе маркеров включена, будут учитываться только те запросы, которые предоставляют зашифрованный маркер и соответствуют указанным в нем требованиям.

Ключ шифрования, который будет использоваться для шифрования и расшифровки значений маркера, определяется первичным ключом и параметрами ключа резервного копирования на странице проверки подлинности на основе маркеров. Имейте в виду, что ключи шифрования специфичны для конкретной платформы.

Значение | Результат
------|---------
Включено | Защищает запрошенное содержимое с помощью проверки подлинности на основе маркеров. Принимаются запросы только от тех клиентов, которые предоставляют допустимый маркер и соответствуют требованиям. На транзакции FTP проверка подлинности на основе маркеров не распространяется.
Отключено| Восстанавливает поведение по умолчанию. Поведение по умолчанию заключается в том, что конфигурация проверки подлинности на основе маркеров может определять, будет ли запрос защищен.

**Поведение по умолчанию.** Отключено.

###<a name="token-auth-denial-code"></a>Код отказа при проверки подлинности на основе маркеров
**Назначение.** Определяет тип ответа, возвращаемого пользователю при отклонении запроса в результате проверки подлинности на основе маркеров.

Ниже перечислены доступные коды ответов.

Код ответа|Имя ответа|Описание
----------------|-----------|--------
301|Перемещено навсегда|Этот код состояния перенаправляет неавторизованных пользователей на URL-адрес, указанный в заголовке Location.
302|Найдено|Этот код состояния перенаправляет неавторизованных пользователей на URL-адрес, указанный в заголовке Location. Этот код состояния является стандартным отраслевым методом выполнения перенаправления.
307|Временное перенаправление|Этот код состояния перенаправляет неавторизованных пользователей на URL-адрес, указанный в заголовке Location.
401|Не авторизовано|Объединение этого кода состояния с заголовком ответа WWW-Authenticate дает возможность выполнять запрос на проверку подлинности пользователя.
403|Запрещено|Это стандартное сообщение о состоянии 403 (запрещено), которое неавторизованный пользователь увидит при попытке доступа к защищенному содержимому.
404|Файл не найден|Этот код состояния указывает, что обмен данными между HTTP-клиентом и сервером состоялся, но запрошенное содержимое не найдено.

#### <a name="url-redirection"></a>Перенаправление URL-адреса

Эта функция поддерживает перенаправление URL-адреса на определяемый пользователем URL-адрес, если он настроен на возврат кода состояния 3xx. Этот определяемый пользователем URL-адрес можно указать, сделав следующее:

1. Выберите код ответа 3xx для компонента кода отказа при проверке подлинности на основе маркеров.
2. Выберите Location из параметра необязательного имени заголовка.
3. Задайте для параметра необязательного значения заголовка нужный URL-адрес.

Если URL-адрес не определен для кода состояния 3xx, пользователю будет возвращена стандартная страница ответа для кода состояния 3xx.

Перенаправление URL-адреса применимо только для кодов ответов 3xx.

Параметр Optional Header Value (Необязательное значение заголовка) поддерживает буквенно-цифровые символы, кавычки и пробелы.

#### <a name="authentication"></a>Аутентификация

Эта функция поддерживает возможность включения заголовка WWW-Authenticate при ответе на неавторизованный запрос на содержимое, защищенное с помощью проверки подлинности на основе маркеров. Если в вашей конфигурации заголовку WWW-Authenticate присвоено значение basic, неавторизованный пользователь получит запрос на ввод учетных данных учетной записи.

Чтобы задать приведенную выше конфигурацию, сделайте следующее:

1. Выберите 401 в качестве кода ответа для функции кода отказа при проверке подлинности на основе маркеров.
2. Выберите WWW-Authenticate из параметра Optional Header Name.
3. Задайте для параметра необязательного значения заголовка значение basic.

Заголовок WWW-Authenticate применим только для кодов ответов 401.

### <a name="token-auth-ignore-url-case"></a>Не учитывать регистр URL-адреса при проверке подлинности на основе маркеров
**Назначение.** Определяет, будет ли учитываться регистр в сравнениях URL-адресов, выполненных с помощью проверки подлинности на основе маркеров.

Ниже приведены параметры, на которые влияет эта функция.

- ec_url_allow
- ec_ref_allow
- ec_ref_deny

Допустимые значения:

Значение|Результат
---|----
Включено|Приводит к тому, что пограничный сервер не учитывает регистр при сравнении URL-адресов для параметров проверки подлинности на основе маркеров.
Отключено|Восстанавливает поведение по умолчанию. Поведение по умолчанию предполагает учет регистра при сравнении URL-адресов для проверки подлинности на основе маркеров.

**Поведение по умолчанию.** Отключено.
 
### <a name="token-auth-parameter"></a>Параметр маркера проверки подлинности
**Назначение.** Определяет, должен ли быть переименован параметр строки запроса проверки подлинности на основе маркеров.

Основные сведения

- Параметр Value определяет имя параметра строки запроса, через который можно указать маркер.
- Для параметра Value невозможно присвоить значение ec_token.
- Убедитесь, что в имени, определенном в параметре Value, 
- содержатся только допустимые символы URL-адреса.

Значение|Результат
----|----
Включено|Параметр Value определяет имя параметра строки запроса, через который следует определять маркеры.
Отключено|Маркер можно указать как неопределенный параметр строки запроса в URL-адресе запроса.

**Поведение по умолчанию.** Отключено. Маркер можно указать как неопределенный параметр строки запроса в URL-адресе запроса.

## <a name="caching"></a>Caching

Эти функции предназначены для настройки времени и способа кэширования содержимого.

Имя | Назначение
-----|--------
Параметры пропускной способности | Определяет, будут ли активны параметры регулирования пропускной способности (т. е. ec_rate и ec_prebuf).
Регулирование пропускной способности | Регулирует пропускную способность для ответов, предоставляемую пограничными серверами.
Отключение кэша | Определяет, может ли запрос использовать технологию кэширования.
Обработка заголовка Cache-Control | Контролирует создание заголовков Cache-Control пограничным сервером при включенной функции External Max-Age.
Строка запроса ключа кэша | Определяет, будет ли ключ кэша включать или исключать параметры строки запроса, связанные с запросом.
Перезапись ключа кэша | Перезаписывает ключ кэша, связанный с запросом.
Завершение заполнения кэша | Определяет, что происходит, когда результаты запроса в частичном кэше отсутствуют на пограничном сервере.
Сжатие типов файлов | Определяет форматы файлов, которые будут сжаты на сервере.
Внутренний максимальный срок по умолчанию | Определяет интервал максимального срока по умолчанию для повторной сверки пограничного сервера с сервером-источником.
Обработка заголовка Expires | Контролирует создание заголовков Expires пограничным сервером при включенной функции External Max-Age.
Внешний максимальный срок | Определяет интервал максимального срока для повторной сверки браузера с пограничным сервером.
Принудительное использование внутреннего максимального срока | Определяет интервал максимального срока для повторной сверки пограничного сервера с сервером-источником.
Поддержка H.264 (Прогрессивное скачивание через HTTP) | Определяет типы форматов файлов H.264, которые могут использоваться для потоковой передачи содержимого.
Учитывать запрос без кэша | Определяет, будут ли запросы без кэша HTTP-клиента перенаправляться на сервер-источник.
Не учитывать источник без кэша | Определяет, будет ли сеть CDN игнорировать некоторые директивы, полученные с сервера-источника.
Игнорировать неподходящие диапазоны | Определяет запрос, возвращаемый клиенту, если запрос формирует код состояния 416 (Запрошенный диапазон не удовлетворяет условиям).
Внутреннее максимальное значение устаревания | Контролирует, как долго после обычного истечения срока действия кэшированный ресурс может обслуживаться с пограничного сервера, если пограничному серверу не удалось выполнить повторную сверку кэшированного ресурса с сервером-источником.
Совместное использование частичного кэширования | Определяет, может ли запрос создавать частично кэшированное содержимое.
Предварительная проверка кэшированного содержимого | Определяет, подойдет ли кэшированное содержимое для ранней повторной сверки до истечения его срока действия.
Обновление файлов кэша нулевой длины | Определяет способ обработки запроса HTTP-клиента к ресурсу кэша нулевой длины пограничными серверами.
Набор кодов состояния кэшированного содержимого | Определяет набор кодов состояния, которые могут привести к кэшированному содержимому.
Доставка устаревшего содержимого при ошибке | Определяет, будет ли доставлено содержимое с истекшим сроком при возникновении ошибки во время повторной сверки кэша или при получении запрошенного содержимого с сервера-источника клиента.
Устаревший клиент при повторной сверке | Повышает производительность, позволяя пограничным серверам обслуживать устаревший клиент для запрашивающей стороны во время повторной сверки.
Комментарий | Функция "Комментарий" позволяет добавлять примечания в правила.

###<a name="bandwidth-parameters"></a>Параметры пропускной способности
**Назначение.** Определяет, будут ли активны параметры регулирования пропускной способности (т. е. ec_rate и ec_prebuf).

Параметры регулирования пропускной способности определяют, будет ли скорость передачи данных для запроса клиента ограничена до уровня пользовательской скорости.

Значение|Результат
--|--
Включено|Позволяет пограничным серверам удовлетворять запросы на регулирование пропускной способности.
Отключено|Приводит к игнорированию параметров регулирования пропускной способности пограничными серверами. Запрашиваемое содержимое будет предоставляться обычным способом (т. е. без регулирования пропускной способности).

**Поведение по умолчанию.** Включено.

###<a name="bandwidth-throttling"></a>Регулирование пропускной способности
**Назначение.** Регулирует пропускную способность для ответа, предоставляемого пограничными серверами.

Чтобы надлежащим образом настроить регулирование пропускной способности, необходимо определить следующие параметры.

Параметр|Описание
--|--
Кбайт запросов в секунду|Присвойте этому параметру значение максимальной пропускной способности (в килобайтах в секунду), которое можно использовать для предоставления ответа.
Секунды Prebuf|Задайте для этого параметра количество секунд, в течение которых наши пограничные серверы будут ожидать регулирования пропускной способности. Этот период времени неограниченной пропускной способности предназначен для предотвращения возникновения перебоев в работе или проблем буферизации из-за регулирования пропускной способности в проигрывателе мультимедиа.

**Поведение по умолчанию.** Отключено.

###<a name="bypass-cache"></a>Отключение кэша
**Назначение.** Определяет, может ли запрос использовать технологию кэширования.

Значение|Результат
--|--
Включено|Приводит к тому, что все запросы переходят на сервер-источник, даже если содержимое ранее было кэшировано на пограничных серверах.
Отключено|Приводит к тому, что пограничные серверы кэшируют ресурсы в соответствии с политикой кэширования, определенной в заголовках ответов.

**Поведение по умолчанию:**

- **Большой HTTP-объект.** Отключено.

<!---
- **ADN:** Enabled
--->

###<a name="cache-control-header-treatment"></a>Обработка заголовка управления кэшем
**Назначение.** Контролирует создание заголовков Cache-Control пограничным сервером при включенной функции External Max-Age.

Самый простой способ настроить этот тип конфигурации — поместить функции External Max-Age и обработки заголовка Cache-Control в одну инструкцию.

Значение|Результат
--|--
Перезаписать|Обеспечивает выполнение следующих действий:<br/> — перезаписывает заголовок Cache-Control, созданный на сервере-источнике; <br/>— добавляет заголовок Cache-Control, созданный функцией External Max-Age, в ответ.
Пропустить|Предотвращает добавление заголовка Cache-Control, созданного функцией External Max-Age, в ответ. <br/> Если сервер-источник создает заголовок Cache-Control, он будет передаваться конечному пользователю. <br/> Если сервер-источник не создает заголовок Cache-Control, из-за этого параметра заголовок ответа может не содержать заголовок Cache-Control.
Добавить при отсутствии|Если заголовок Cache-Control не был получен с сервера-источника, этот параметр добавляет заголовок Cache-Control, созданный функцией External Max-Age. Этот параметр полезен для обеспечения назначения заголовка Cache-Control всем ресурсам.
Удалить| Этот параметр гарантирует, что заголовок Cache-Control не будет включен в заголовок ответа. Если заголовок Cache-Control уже присвоен, он будет удален из заголовка ответа.

**Поведение по умолчанию.** Перезаписать.

###<a name="cache-key-query-string"></a>Строка запроса ключа кэша
**Назначение.** Определяет, будет ли ключ кэша включать или исключать параметры строки запроса, связанные с запросом.

Основные сведения

- Укажите одно или несколько имен параметров строки запроса. Все имена параметров должны быть разделены одним пробелом.
- Эта функция определяет, будут ли параметры строки запроса включены в ключ кэша или исключены из него. Ниже приведены дополнительные сведения о каждом параметре.

Тип|Описание
--|--
 Включить|  Указывает, что каждый указанный параметр должен быть включен в ключ кэша. Для каждого запроса, содержащего уникальное значение для параметра строки запроса, определенного в этой функции, будет создан уникальный ключ кэша. 
 Включить все  |Указывает, что для каждого запроса на ресурс, который включает уникальную строку запроса, будет создан уникальный ключ кэша. Этот тип конфигурации обычно не рекомендуется, так как он может привести к возникновению небольшого процента попаданий в кэш. Это влечет увеличение нагрузки на сервер-источник, так как он будет обслуживать большее количество запросов. Эта конфигурация дублирует поведение кэширования, известное как уникальный кэш, на странице Query-String Caching (Кэширование строк запроса). 
 Исключить | Указывает, что из ключа кэша будут исключены только указанные параметры. Остальные параметры строки запроса будут включены в ключ кэша. 
 Исключить все  |Указывает, что из ключа кэша будут исключены все параметры строки запроса. Эта конфигурация дублирует поведение кэширования по умолчанию, известное как стандартный кэш, на странице Query-String Caching (Кэширование строк запроса). 

Возможности обработчика правил HTTP позволяют настраивать способ реализации кэширования строк запроса. Например, можно указать, что кэширование строк запроса будет выполняться только в определенных расположениях или типах файлов.

Если вы хотите дублировать поведение кэширования строк запроса, известное как "без кэша" на странице Query-String Caching (Кэширование строк запроса), необходимо создать правило, содержащее условие соответствия шаблона запроса URL-адреса и функцию отключения кэша. Для условия соответствия шаблона запроса URL-адреса следует указать звездочку (*).

#### <a name="sample-scenarios"></a>Примеры сценариев

В этом разделе содержатся примеры использования этой функции. Ниже приведены пример запроса и ключ кэша по умолчанию.

- **Пример запроса:** http://wpc.0001.&lt;Домен&gt;/800001/Origin/folder/asset.htm?sessionid=1234&language=EN&userid=01
- **Ключ кэша по умолчанию:** /800001/Origin/folder/asset.htm

##### <a name="include"></a>Включить

Образец конфигурации:

- **Тип:** включить.
- **Параметры:** язык.

Этот тип конфигурации создаст следующий ключ кэша параметра строки запроса:

    /800001/Origin/folder/asset.htm?language=EN

##### <a name="include-all"></a>Включить все

Образец конфигурации:

- **Тип:** включить все.

Этот тип конфигурации создаст следующий ключ кэша параметра строки запроса:

    /800001/Origin/folder/asset.htm?sessionid=1234&language=EN&userid=01

##### <a name="exclude"></a>Исключить

Образец конфигурации:

- **Тип:** исключить.
- **Параметры:** sessionid userid.

Этот тип конфигурации создаст следующий ключ кэша параметра строки запроса:

    /800001/Origin/folder/asset.htm?language=EN

##### <a name="exclude-all"></a>Исключить все

Образец конфигурации:

- **Тип:** исключить все.

Этот тип конфигурации создаст следующий ключ кэша параметра строки запроса:

    /800001/Origin/folder/asset.htm

###<a name="cache-key-rewrite"></a>Перезапись ключа кэша
**Назначение.** Перезаписывает ключ кэша, связанный с запросом.

Ключ кэша — это относительный путь, определяющий ресурс для целей кэширования. Иными словами, наши серверы будут проверять наличие кэшированной версии ресурса по его пути, как определено в ключе кэша.

Настройте эту функцию, определив оба следующих параметра.

Параметр|Описание
--|--
Исходный путь| Определяет относительный путь к типам запросов, ключ кэша которых будет перезаписан. Относительный путь можно задать, выбрав базовый исходный путь, а затем определив шаблон регулярного выражения.
Новый путь|Определяет относительный путь для нового ключа кэша. Относительный путь можно задать, выбрав базовый исходный путь, а затем определив шаблон регулярного выражения. Этот относительный путь можно создать динамически с использованием переменных HTTP.
**Поведение по умолчанию.** Ключ кэша запроса определяется универсальным кодом ресурса (URI) запроса.

###<a name="complete-cache-fill"></a>Завершение заполнения кэша
**Назначение.** Определяет, что происходит, когда запрос завершается частичным промахом кэша на пограничном сервере.

Частичный промах кэша описывает состояние кэша для ресурса, который был не полностью скачан на пограничный сервер. Если ресурс лишь частично кэширован на пограничном сервере, следующий запрос для этого ресурса будет снова перенаправлен на сервер-источник.
<!---
This feature is not available for the ADN platform. The typical traffic on this platform consists of relatively small assets. The size of the assets served through these platforms helps mitigate the effects of partial cache misses, since the next request will typically result in the asset being cached on that POP.
--->
Частичный промах кэша обычно возникает после того, как пользователь прерывает процесс скачивания, или в ресурсах, которые запрашиваются только с помощью запросов в диапазоне HTTP. Эта функция полезна для больших ресурсов, когда пользователи, как правило, не скачивают их от начала до конца (например, видео). В результате на большой HTTP-платформе эта функция включена по умолчанию. На всех остальных платформах она отключена.

Для большой HTTP-платформы мы рекомендуем оставить конфигурацию по умолчанию, так как это уменьшит нагрузку на сервер-источник клиента и увеличит скорость, с которой ваши клиенты скачивают содержимое.

Из-за способа отслеживания параметров кэша эту функцию невозможно связать со следующими условиями соответствия: граничная запись Cname, литерал заголовка запроса, шаблон заголовка запроса, литерал запроса URL-адреса и шаблон запроса URL-адреса.

Значение|Результат
--|--
Включено|Восстанавливает поведение по умолчанию. Поведение по умолчанию — принудительно инициировать получение фоновых данных ресурса с сервера-источника на пограничном сервере. После этого ресурс будет находиться в локальном кэше пограничного сервера.
Отключено|Предотвращает получение фоновых данных для ресурса на пограничном сервере. Это означает, что при выполнении следующего запроса на этот ресурс из этого региона пограничный сервер будет запрашивать его с сервера-источника клиента.

**Поведение по умолчанию.** Включено.

###<a name="compress-file-types"></a>Сжатие типов файлов
**Назначение.** Определяет форматы файлов, которые будут сжаты на сервере.

Формат файла можно указать с помощью его типа мультимедиа для Интернета (т. е. тип содержимого). Тип мультимедиа для Интернета — это метаданные, не зависящие от платформы, по которым наши серверы могут определить формат файла определенного ресурса. Ниже приведен список распространенных типов мультимедиа для Интернета.

Тип мультимедиа для Интернета|Описание
--|--
text/plain|Обычные текстовые файлы
text/html| HTML-файлы
text/css|Каскадные таблицы стилей (CSS)
application/x-javascript|JavaScript
application/javascript|JavaScript
Основные сведения

- Указывайте несколько типов мультимедиа для Интернета, разделяя их одним пробелом. 
- Эта функция будет сжимать только те ресурсы, размер которых меньше 1 МБ. Наши серверы не будут сжимать ресурсы большего размера.
- Некоторые типы содержимого, такие как мультимедийные файлы изображений, видео и аудио (например, JPG, MP3, MP4 и т. д.), уже сжаты. Дополнительное сжатие этих типов ресурсов не приведет к значительному уменьшению размера файла. Поэтому мы рекомендуем не включать сжатие для этих типов ресурсов.
- Подстановочные знаки, например звездочки, не поддерживаются.
- Прежде чем добавить эту функцию в правило, задайте параметр Compression Disabled (Сжатие отключено) на странице "Сжатие" для платформы, к которой это правило будет применяться.

###<a name="default-internal-max-age"></a>Внутренний максимальный срок по умолчанию
**Назначение.** Определяет интервал максимального срока по умолчанию для повторной сверки пограничного сервера с сервером-источником. Другими словами, это количество времени, которое пройдет, прежде чем пограничный сервер проверит, соответствует ли кэшированный ресурс ресурсу, хранящемуся на сервере-источнике.

Основные сведения

- Это действие выполняется только для ответов с сервера-источника, который не присвоил указание максимального срока в заголовке Cache-Control и Expires.
- Это действие не будет выполняться для ресурсов, которые невозможно кэшировать.
- Это действие не влияет на повторные сверки браузера с пограничным сервером. Эти типы повторных сверок определены в заголовках Cache-Control и Expires, отправляемых в браузер, которые можно настроить с помощью функции External Max-Age.
- Результаты этого действия не оказывают значительное влияние на заголовки ответа и содержимое, возвращаемое с пограничных серверов для вашего содержимого, но они могут повлиять на объем трафика повторных сверок, отправляемых с пограничных серверов на сервер-источник.
- Настройте эту функцию, сделав следующее:
    - Выберите код состояния, к которому можно применить внутренний максимальный срок по умолчанию.
    - Укажите целое значение, а затем выберите нужную единицу времени (секунды, минуты, часы и т. д.). Это значение определяет интервал внутреннего максимального срока по умолчанию.

- Если для единицы времени задать значение "Выкл.", интервал внутреннего максимального срока по умолчанию будет иметь значение 7 дней для запросов, заголовкам Cache-Control или Expires которых не было назначено указание максимального срока.
- Из-за способа отслеживания параметров кэша эту функцию невозможно связать со следующими условиями соответствия: 
    - граничная запись; 
    - Cname;
    - Литерал заголовка запроса
    - Шаблон заголовка запроса
    - Метод запроса
    - Литерал запроса URL-адреса
    - Шаблон запроса URL-адреса

**Значение по умолчанию:** 7 дней

###<a name="expires-header-treatment"></a>Обработка заголовка Expires
**Назначение.** Контролирует создание заголовков Expires пограничным сервером при включенной функции External Max-Age.

Самый простой способ настроить этот тип конфигурации — поместить функции External Max-Age и Expires Header Treatment в одну инструкцию.

Значение|Результат
--|--
Перезаписать|Обеспечивает выполнение следующих действий:<br/>— перезаписывает заголовок Expires, созданный на сервере-источнике;<br/>— добавляет заголовок Expires, созданный функцией External Max-Age, в ответ.
Пропустить|Предотвращает добавление заголовка Expires, созданного функцией External Max-Age, в ответ. <br/> Если сервер-источник создает заголовок Expires, он будет передаваться конечному пользователю. <br/>Если сервер-источник не создает заголовок Expires, из-за этого параметра заголовок ответа может не содержать заголовок Expires.
Добавить при отсутствии| Если заголовок Expires не был получен с сервера-источника, этот параметр добавляет заголовок Expires, созданный функцией External Max-Age. Этот параметр полезен для обеспечения назначения заголовка Expires всем ресурсам.
Удалить| Гарантирует, что заголовок Expires не будет включен в заголовок ответа. Если заголовок Expires уже присвоен, он будет удален из заголовка ответа.

**Поведение по умолчанию.** Перезаписать.

###<a name="external-max-age"></a>Внешний максимальный срок
**Назначение.** Определяет интервал максимального срока для повторной сверки браузера с пограничным сервером. Другими словами, это количество времени, которое пройдет, прежде чем браузер сможет проверить наличие новой версии ресурса с пограничного сервера.

Если включить эту функцию, на наших пограничных серверах будут созданы заголовки Cache-Control:max-age и Expires и отправлены в HTTP-клиент. По умолчанию эти заголовки перезапишут заголовки, созданные на сервере-источнике. Тем не менее это поведение можно изменить с помощью функции обработки заголовка Cache-Control и Expires.

Основные сведения

- Это действие не влияет на повторные сверки пограничного сервера с сервером-источником. Эти типы сверок определены в заголовках Cache-Control/Expires, полученных с сервера-источника, и их можно настроить с помощью функций Default Internal Max-Age и Force Internal Max-Age.
- Настройте эту функцию, указав целое значение и выбрав нужную единицу времени (секунды, минуты, часы и т. д.).
- Если задать для этой функции отрицательное значение, наши пограничные серверы будут отправлять значение времени Cache-Control:no-cache и Expires, заданное в прошлом, с каждым ответом в браузер. Несмотря на то что HTTP-клиент не будет кэшировать ответ, этот параметр не повлияет на способность наших пограничных серверов кэшировать ответ с сервера-источника.
- Если задать для единицы времени значение "Выкл.", эта функция будет отключена. Заголовки Cache-Control/Expires, кэшированные с помощью ответа с сервера-источника, будут переданы в браузер.

**Поведение по умолчанию.** Выключено.

###<a name="force-internal-max-age"></a>Принудительное использование внутреннего максимального срока
**Назначение.** Определяет интервал максимального срока для повторной сверки пограничного сервера с сервером-источником. Другими словами, это количество времени, которое пройдет, прежде чем пограничный сервер сможет проверить, соответствует ли кэшированный ресурс ресурсу, хранящемуся на сервере-источнике.

Основные сведения

- Эта функция переопределяет интервал максимального срока, определенного в заголовках Cache-Control и Expires, созданных на сервере-источнике.
- Эта функция не влияет на повторные сверки браузера с пограничным сервером. Эти типы повторных сверок определены в заголовках Cache-Control и Expires, отправляемых в браузер.
- Эта функция не оказывает значительное влияние на ответ, который пограничный сервер предоставляет инициатору запроса. Тем не менее он может повлиять на объем трафика повторной сверки, отправляемого с наших пограничных серверов на сервер-источник.
- Настройте эту функцию, сделав следующее:
    - Выберите код состояния, к которому будет применен внутренний максимальный срок.
    - Укажите целое значение и выберите нужную единицу времени (секунды, минуты, часы и т. д.). Это значение определяет интервал максимального срока запроса.

- Если задать для единицы времени значение "Выкл.", эта функция будет отключена. Интервал внутреннего максимального срока не будет назначен запрошенным ресурсам. Если исходный заголовок не содержит инструкции для кэширования, ресурс будет кэшироваться в соответствии с активным параметром в функции Default Internal Max-Age.
- Из-за способа отслеживания параметров кэша эту функцию невозможно связать со следующими условиями соответствия: 
    - граничная запись; 
    - Cname;
    - Литерал заголовка запроса
    - Шаблон заголовка запроса
    - Метод запроса
    - Литерал запроса URL-адреса
    - Шаблон запроса URL-адреса

**Поведение по умолчанию.** Выключено.

###<a name="h264-support-http-progressive-download"></a>Поддержка H.264 (Прогрессивное скачивание через HTTP)
**Назначение.** Определяет типы форматов файлов H.264, которые можно использовать для потоковой передачи содержимого.

Основные сведения

- Определите ряд разделенных пробелом допустимых расширений имен файлов H.264 в параметре "Расширения файлов". Параметр "Расширения файлов" переопределяет поведение по умолчанию. Настраивая этот параметр, включите эти расширения имен файлов, чтобы обеспечить поддержку MP4 и F4V. 
- Добавляйте точку при указании каждого расширения имени файла (например, .f4v, .mp4).

**Поведение по умолчанию.** Поэтапная загрузка HTTP поддерживает мультимедиа в формате MP4 и F4V по умолчанию.

###<a name="honor-no-cache-request"></a>Учитывать запрос без кэша
**Назначение.** Определяет, будут ли запросы без кэша HTTP-клиента перенаправляться на сервер-источник.

Запрос без кэша происходит, когда HTTP-клиент отправляет заголовок Cache-Control:no-cache и (или) Pragma:no-cache в HTTP-запросе.

Значение|Результат
--|--
Включено|Позволяет перенаправлять запросы без кэша HTTP-клиента на сервер-источник, который будет возвращать заголовки ответов и текст через пограничный сервер обратно в HTTP-клиент.
Отключено|Восстанавливает поведение по умолчанию. Поведение по умолчанию — предотвратить перенаправление запросов без кэша на сервер-источник.

Для всего рабочего трафика мы настоятельно рекомендуем оставить эту функцию в отключенном состоянии по умолчанию. В противном случае серверы-источники не будут изолированы от конечных пользователей, которые могут случайно инициировать множество запросов без кэша при обновлении веб-страниц, или от многих популярных медиапроигрывателей, запрограммированных на отправку заголовка без кэша при каждом запросе видео. Тем не менее эту функцию полезно применять в определенных непроизводственных промежуточных или тестовых каталогах, чтобы извлекать новое содержимое по запросу с сервера-источника.

Состояние кэша, передаваемое для запроса, который можно переслать на сервер-источник в результате применения этой функции, — TCP_Client_Refresh_Miss. Отчет о попаданиях в кэш, который доступен в основном модуле создания отчетов, предоставляет статистические данные по состоянию кэша. Это позволяет отслеживать количество и процент запросов, перенаправляемых на сервер-источник при применении этой функции.

**Поведение по умолчанию.** Отключено.

###<a name="ignore-origin-no-cache"></a>Не учитывать источник без кэша
**Назначение.** Определяет, будет ли сеть CDN игнорировать следующие директивы, полученные с сервера-источника:

- Cache-Control: private;
- Cache-Control: no-store;
- Cache-Control: no-cache;
- Pragma: no-cache.

Основные сведения

- Настройте эту функцию, определив список разделенных пробелом кодов состояния, для которых приведенные выше директивы будут игнорироваться.
- Набор допустимых кодов состояния для этой функции: 200, 203, 300, 301, 302, 305, 307, 400, 401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417, 500, 501, 502, 503, 504 и 505.
- Отключите эту функцию, присвоив ей пустое значение.
- Из-за способа отслеживания параметров кэша эту функцию невозможно связать со следующими условиями соответствия: 
    - граничная запись; 
    - Cname;
    - Литерал заголовка запроса
    - Шаблон заголовка запроса
    - Метод запроса
    - Литерал запроса URL-адреса
    - Шаблон запроса URL-адреса

**Поведение по умолчанию.** Учитывать приведенные выше директивы.

###<a name="ignore-unsatisfiable-ranges"></a>Игнорировать неподходящие диапазоны 
**Назначение.** Определяет ответ, возвращаемый клиенту, если запрос формирует код состояния 416 (Запрошенный диапазон невыполним).

По умолчанию этот код состояния возвращается, когда пограничный сервер не может удовлетворить указанный запрос диапазонов байтов и если поле заголовка запроса If-Range не указано.

Значение|Результат
-|-
Включено|Предотвращает ответ на недопустимый запрос диапазона байтов с кодом состояния 416 (Запрошенный диапазон невыполним) с наших пограничных серверов. Вместо этого наши серверы предоставят запрошенный ресурс и возвратят ответ 200 ОК клиенту.
Отключено|Восстанавливает поведение по умолчанию. Поведение по умолчанию — учитывать код состояния 416 (Запрошенный диапазон невыполним).

**Поведение по умолчанию.** Отключено.

###<a name="internal-max-stale"></a>Внутреннее максимальное значение устаревания
**Назначение.** Контролирует, как долго после обычного истечения срока действия кэшированный ресурс может обслуживаться с пограничного сервера, если пограничному серверу не удалось выполнить повторную сверку кэшированного ресурса с сервером-источником.

Как правило, по истечении времени максимального срока ресурса пограничный сервер отправит на сервер-источник запрос на повторную сверку. Сервер-источник затем отправит ответ 304 (не изменено), чтобы предоставить пограничному серверу новую аренду для кэшированного ресурса, либо ответ 200 ОК, чтобы предоставить пограничному серверу обновленную версию кэшированного ресурса.

Если при попытке выполнения этой повторной сверки пограничный сервер не может установить соединение с сервером-источником, эта функция Internal Max-Stale определяет способность и длительность обслуживания пограничным сервером уже устаревших ресурсов.

Обратите внимание, что этот интервал времени начинается по истечении максимального срока ресурса, а не при неудачной повторной проверке. Таким образом, максимальный период, в течение которого ресурс может обрабатываться без успешной повторной проверки, — промежуток времени, представляющий сочетание значения максимального срока и максимального значения устаревания. Например, если ресурс был кэширован в 9:00 с максимальным сроком 30 минут и максимальным значением устаревания 15 минут, неудачная попытка повторной проверки в 9:44 приведет к тому, что конечный пользователь получит устаревший кэшированный ресурс, а неудачная повторная попытка проверки в 9:46 приведет к тому, что конечный пользователь получит ответ 504 (Истекло время ожидания шлюза).

Любое значение, настроенное для этой функции, заменяется заголовками Cache-Control:must-revalidate или Cache-Control:proxy-revalidate, полученными с сервера-источника. Если один из этих заголовков получен с сервера-источника при изначальном кэшировании ресурса, пограничный сервер не будет обрабатывать устаревший кэшированный ресурс. В этом случае, если пограничный сервер не сможет выполнить повторную сверку с источником по истечении интервала максимального срока ресурса, то будет возвращен ответ 504 (Истекло время ожидания шлюза).

Основные сведения

- Настройте эту функцию, сделав следующее:
    - Выберите код состояния, к которому будет применено максимальное значение устаревания.
    - Укажите целое значение, а затем выберите нужную единицу времени (секунды, минуты, часы и т. д.). Это значение определяет внутреннее максимальное значение устаревания, которое будет применено.

- Если задать для единицы времени значение "Выкл.", эта функция будет отключена. Кэшированный ресурс не будет обслуживаться по истечении обычного срока действия.
- Из-за способа отслеживания параметров кэша эту функцию невозможно связать со следующими условиями соответствия: 
    - граничная запись; 
    - Cname;
    - Литерал заголовка запроса
    - Шаблон заголовка запроса
    - Метод запроса
    - Литерал запроса URL-адреса
    - Шаблон запроса URL-адреса

**Поведение по умолчанию.** 2 минуты.

###<a name="partial-cache-sharing"></a>Совместное использование частичного кэширования
**Назначение.** Определяет, может ли запрос создавать частично кэшированное содержимое.

Этот частичный кэш затем будет использоваться для удовлетворения новых запросов на это содержимое, пока запрошенное содержимое не будет полностью кэшировано.

Значение|Результат
-|-
Включено|Запросы могут создавать частично кэшированное содержимое.
Отключено|Запросы могут создавать только полностью кэшированную версию запрошенного содержимого.

**Поведение по умолчанию.** Отключено.

###<a name="prevalidate-cached-content"></a>Предварительная проверка кэшированного содержимого
**Назначение.** Определяет, подойдет ли кэшированное содержимое для ранней повторной сверки до истечения его срока действия.

Определите период времени до истечения срока жизни запрошенного содержимого, в течение которого для него можно будет выполнить раннюю повторную сверку.

Основные сведения

- Если задать значение "Выкл." в качестве единицы измерения времени, после истечения срока жизни кэшированного содержимого потребуется повторная проверка. Не указывайте время, и это будет проигнорировано.

**Поведение по умолчанию.** Выключено. Повторную проверку можно провести только после истечения срока жизни кэшированного содержимого.

###<a name="refresh-zero-byte-cache-files"></a>Обновление файлов кэша нулевой длины
**Назначение.** Определяет способ обработки запроса HTTP-клиента к ресурсу кэша нулевой длины пограничными серверами.

Допустимые значения:

Значение|Результат
--|--
Включено|Приводит к повторному получению ресурса с сервера-источника нашим пограничным сервером.
Отключено|Восстанавливает поведение по умолчанию. Поведение по умолчанию — обслуживать допустимые ресурсы кэша по запросу.
Эта функция не является обязательной для надлежащего кэширования и доставки содержимого, но может использоваться в качестве обходного решения. Например, генераторы динамического содержимого на серверах-источниках могут случайным образом привести к получению ответов нулевой длины, отправляемых на пограничные серверы. Эти типы ответов, как правило, кэшируются нашими пограничными серверами. Если вам известно, что ответ нулевой длины является недопустимым ответом 

для такого содержимого, эта функция может препятствовать обслуживанию этих типов ресурсов в ваших клиентах.

**Поведение по умолчанию.** Отключено.

###<a name="set-cacheable-status-codes"></a>Набор кодов состояния кэшированного содержимого
**Назначение.** Определяет набор кодов состояния, которые могут привести к кэшированному содержимому.

По умолчанию кэширование включено только для ответов 200 ОК.

Укажите ряд необходимых кодов состояния, разделенных пробелами.

Основные сведения

- Включите также функцию Ignore Origin No-Cache. Если эта функция не включена, ответы 200 ОК не будут кэшироваться.
- Набор допустимых кодов состояния для этой функции: 203, 300, 301, 302, 305, 307, 400, 401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417, 500, 501, 502, 503, 504 и 505.
- Эту функцию невозможно использовать, чтобы отключить кэширование для ответов, создающих код состояния 200 ОК.

**Поведение по умолчанию.** Кэширование включено только для ответов, создающих код состояния 200 ОК.
###<a name="stale-content-delivery-on-error"></a>Доставка устаревшего содержимого при ошибке
**Назначение.** 

Определяет, будет ли доставлено содержимое с истекшим сроком при возникновении ошибки во время повторной сверки кэша или при получении запрошенного содержимого с сервера-источника клиента.

Значение|Результат
-|-
Включено|При возникновении ошибки во время подключения к серверу-источнику инициатору запроса будет передаваться устаревшее содержимое.
Отключено|Ошибка сервера-источника будет перенаправлена инициатору запроса.

**Поведение по умолчанию.** Отключено.

###<a name="stale-while-revalidate"></a>Устаревший клиент при повторной сверке
**Назначение.** Повышает производительность, позволяя пограничным серверам во время повторной сверки предоставлять инициатору запроса устаревшее содержимое.

Основные сведения

- Поведение этой функции зависит от выбранной единицы времени.
    - **Единица времени.** Укажите интервал времени и выберите единицу времени (например, секунды, минуты, часы и т. д.), чтобы разрешить доставку устаревшего содержимого. Этот тип установки позволяет CDN увеличивать интервал времени, в течение которого он может предоставлять содержимое перед проверкой по следующей формуле: **TTL** + **Stale While Revalidate Time**. 
    - **Выкл.** Выберите значение "Выкл.", чтобы перед обработкой запроса на устаревшее содержимое проводить повторную сверку.
        - Не указывайте промежуток времени, так как он неприменим и будет игнорироваться.

**Поведение по умолчанию.** Выключено. Повторная сверка должна проводиться перед обслуживанием запрошенного содержимого.

###<a name="comment"></a>Комментарий
**Назначение.** Позволяет добавлять примечания в правила.

Эта функция используется для предоставления дополнительных сведений об общем назначении правила или причине добавления определенного условия соответствия или функции в правило.

Основные сведения

- Можно указать до 150 символов.
- Используйте только буквенно-цифровые символы.
- Эта функция не влияет на поведение правила. Она только предоставляет область, в которой можно указать сведения для дальнейшего использования, или может помочь при устранении неполадок правила.
 
## <a name="headers"></a>Заголовки

Эти функции предназначены для добавления, изменения или удаления заголовков из запроса или ответа.

Имя | Назначение
-----|--------
Заголовок ответа Age | Определяет, будет ли заголовок ответа Age включен в ответ, отправляемый запрашивающей стороне.
Заголовки ответа Debug Cache | Определяет, может ли ответ включать заголовок ответа X-EC-Debug, предоставляющий сведения о политике кэширования для запрошенного ресурса.
Заголовок запроса Modify Client | Перезаписывает, добавляет или удаляет заголовок из запроса.
Заголовок ответа Modify Client | Перезаписывает, добавляет или удаляет заголовок из ответа.
Настраиваемый заголовок Set Client IP | Позволяет добавлять IP-адрес запрашивающего клиента в запрос в качестве настраиваемого заголовка запроса.

###<a name="age-response-header"></a>Заголовок ответа Age
**Назначение.** Определяет, будет ли заголовок ответа Age включен в ответ, отправляемый инициатору запроса.
Значение|Результат
--|--
Включено | Заголовок ответа Age будет включен в ответ, отправляемый инициатору запроса.
Отключено | Заголовок ответа Age будет исключен из ответа, отправляемого инициатору запроса.

**Поведение по умолчанию.** Отключено.

###<a name="debug-cache-response-headers"></a>Заголовки ответа Debug Cache
**Назначение.** Определяет, может ли ответ включать заголовок ответа X-EC-Debug, предоставляющий сведения о политике кэширования для запрошенного ресурса.

Заголовки ответа Debug Cache будут включены в ответ, если выполнены следующие условия:

- в необходимом запросе включена функция заголовков ответа Debug Cache;
- в приведенном выше запросе определен набор заголовков ответа Debug Cache, которые будут включены в ответ.

Заголовки ответа Debug Cache можно запрашивать, добавив в запрос следующий заголовок и необходимые директивы:

X-EC-Debug: _Directive1_,_Directive2_,_DirectiveN_

**Пример**

X-EC-Debug: x-ec-cache,x-ec-check-cacheable,x-ec-cache-key,x-ec-cache-state

Значение|Результат
-|-
Включено|Запросы для заголовков ответа Debug Cache возвратят ответ, который включает заголовок X-EC-Debug.
Отключено|Заголовок ответа X-EC-Debug будет исключен из ответа.

**Поведение по умолчанию.** Отключено.

###<a name="modify-client-response-header"></a>Заголовок ответа Modify Client
**Назначение.** Каждый запрос содержит набор [заголовков запроса](), описывающих его. Эта функция может выполнять одно из следующих действий:

- Добавить или заменить значение, назначенное в заголовке запроса. Если указанный заголовок запроса не существует, эта функция добавит его в запрос.
- Удалить заголовок из запроса.

В запросах, перенаправляемых на сервер-источник, будут отражены изменения, внесенные этой функцией.

В заголовке запроса можно выполнить одно из приведенных ниже действий.

Параметр|Описание|Пример
-|-|-
Добавить|Указанное значение будет добавлено в конец имеющегося значения заголовка запроса.|**Значение заголовка запроса (клиент):** значение1. <br/> **Значение заголовка запроса (обработчик правил HTTP):** значение2. <br/>**Новое значение заголовка запроса:** значение1значение2.
Перезаписать|Для значения заголовка запроса будет присвоено указанное значение.|**Значение заголовка запроса (клиент):** значение1. <br/>**Значение заголовка запроса (обработчик правил HTTP):** значение2. <br/>**Новое значение заголовка запроса:** значение2. <br/>
Delete|Удаляет указанный заголовок запроса.|**Значение заголовка запроса (клиент):** значение1. <br/> **Конфигурация заголовка запроса Modify Client.** Удаление заголовка запроса в вопросе. <br/>**Результат.** Указанный заголовок запроса не будет перенаправляться на сервер-источник.

Основные сведения

- Значение, указанное в параметре Name, должно точно совпадать с заголовком запроса.
- В целях определения заголовка регистр не учитывается. Например, для определения могут использоваться все следующие варианты имени заголовка Cache-Control:
    - cache-control;
    - CACHE-CONTROL;
    - cachE-Control.
- При указании имени заголовка используйте только буквенно-цифровые символы, тире и символы подчеркивания.
- Если удалить заголовок, наши пограничные серверы не будут перенаправлять его на сервер-источник.
- Следующие заголовки защищены и не могут быть изменены этой функцией:
    - forwarded;
    - host
    - via;
    - Предупреждение
    - x-forwarded-for.
    - Все имена заголовков, начинающиеся с "x-ec", защищены.

###<a name="modify-client-response-header"></a>Заголовок ответа Modify Client
Каждый ответ содержит набор [заголовков ответа](), описывающих его. Эта функция может выполнять одно из следующих действий:

- Добавить или заменить значение, назначенное в заголовке ответа. Если указанный заголовок запроса не существует, эта функция добавит его в ответ.
- Удалить заголовок из ответа.

По умолчанию значения заголовков ответа определяются сервером-источником и нашими пограничными серверами.

В заголовке ответа можно выполнить одно из приведенных ниже действий.

Параметр|Описание|Пример
-|-|-
Добавить|Указанное значение будет добавлено в конец имеющегося значения заголовка запроса.|**Значение заголовка ответа (клиент):** значение1. <br/> **Значение заголовка ответа (обработчик правил HTTP):** значение2. <br/>**Новое значение заголовка ответа:** значение1значение2.
Перезаписать|Для значения заголовка запроса будет присвоено указанное значение.|**Значение заголовка ответа (клиент):** значение1. <br/>**Значение заголовка ответа (обработчик правил HTTP):** значение2. <br/>**Новое значение заголовка ответа:** значение2. <br/>
Delete|Удаляет указанный заголовок запроса.|**Значение заголовка запроса (клиент):** значение1. <br/> **Конфигурация заголовка запроса Modify Client.** Удаление заголовка ответа в вопросе. <br/>**Результат.** Указанный заголовок ответа не будет перенаправляться инициатору запроса.

Основные сведения

- Значение, указанное в параметре Name, должно точно совпадать с заголовком ответа. 
- В целях определения заголовка регистр не учитывается. Например, для определения могут использоваться все следующие варианты имени заголовка Cache-Control:
    - cache-control;
    - CACHE-CONTROL;
    - cachE-Control.
- Если удалить заголовок, он не будет перенаправляться инициатору запроса.
- Следующие заголовки защищены и не могут быть изменены этой функцией:
    - accept-encoding;
    - age;
    - connection;
    - content-encoding
    - content-length;
    - content-range;
    - дата
    - имя сервера
    - trailer;
    - transfer-encoding;
    - upgrade
    - vary;
    - via;
    - Предупреждение
    - Все имена заголовков, начинающиеся с "x-ec", защищены.

###<a name="set-client-ip-custom-header"></a>Настраиваемый заголовок Set Client IP
**Назначение.** Добавляет пользовательский заголовок, который определяет запрашивающего клиента по IP-адресу, в запрос.

Параметр Header name определяет имя пользовательского заголовка запроса, где будет храниться IP-адрес клиента.

Эта функция позволяет серверу-источнику клиента узнать IP-адреса клиента с помощью пользовательского заголовка запроса. Если запрос обрабатывается из кэша, сервер-источник не получит IP-адрес клиента. Таким образом, мы рекомендуем использовать эту функцию с ADN или ресурсами, которые не будут кэшироваться.

Указанное имя заголовка не должно совпадать с перечисленными ниже именами.

- Стандартные имена заголовков запросов. Список стандартных имен заголовков можно найти в статье о [RFC 2616](http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html).
- Имена защищенных заголовков:
    - forwarded-for;
    - host
    - vary;
    - via;
    - Предупреждение
    - x-forwarded-for.
    - Все имена заголовков, начинающиеся с "x-ec", защищены.
 
## <a name="logs"></a>Журналы

Эти функции предназначены для настройки данных, хранящихся в необработанных файлах журнала.

Имя | Назначение
-----|--------
Поле 1 пользовательского журнала | Определяет формат и содержимое, которое будет присвоено полю пользовательского журнала в необработанном файле журнала.
Регистрация строки запроса | Определяет, будет ли строка запроса сохранена вместе с URL-адресом в журналах доступа.

###<a name="custom-log-field-1"></a>Поле 1 пользовательского журнала
**Назначение.** Определяет формат и содержимое, которое будет присвоено полю пользовательского журнала в необработанном файле журнала.

Это поле позволяет определить, какие значения заголовка запроса и ответа будут храниться в ваших файлах журнала.

По умолчанию поле пользовательского журнала называется x-ec_custom-1. Тем не менее имя этого поля можно настроить на [странице параметров необработанного журнала]().

Ниже указано форматирование, которое следует использовать для указания заголовков запроса и ответа.

Тип заголовка|Формат|Примеры
-|-|-
Заголовок запроса|%{[RequestHeader]()}[i]() | %{Accept-Encoding}i <br/> {Referer}i <br/> %{Authorization}i
Заголовок ответа|%{[ResponseHeader]()}[o]()| %{Age}o <br/> %{Content-Type}o <br/> %{Cookie}o

Основные сведения

- Поле пользовательского журнала может содержать любое сочетание полей заголовка и обычного текста.
- К допустимым символам для этого поля относятся буквенно-цифровые (т. е. 0–9, a–z и A–Z), тире, двоеточия, точки с запятой, апострофы, запятые, точки, символы подчеркивания, знаки равенства, круглые скобки, квадратные скобки и пробелы. Символ процента и фигурные скобки можно использовать только для указания поля заголовка.
- Написание каждого указанного заголовка поля должно совпадать с именем необходимого заголовка запроса или ответа.
- Если вы хотите указать несколько заголовков, мы рекомендуем использовать между ними разделитель. Например, можно использовать сокращение для каждого заголовка. Пример синтаксиса приведен ниже.
    - AE: %{Accept-Encoding}i A: %{Authorization}i CT: %{Content-Type}o 

**Значение по умолчанию:** -

###<a name="log-query-string"></a>Регистрация строки запроса
**Назначение.** Определяет, будет ли строка запроса сохранена вместе с URL-адресом в журналах доступа.

Значение|Результат
-|-
Включено|Позволяет хранить строки запроса во время записи URL-адресов в журнале доступа. Если URL-адрес не содержит строку запроса, этот параметр не будет иметь влияния.
Отключено|Восстанавливает поведение по умолчанию. Поведение по умолчанию — игнорировать строки запроса во время записи URL-адресов в журнал доступа.

**Поведение по умолчанию.** Отключено.

<!---
## Optimize

These features determine whether a request will undergo the optimizations provided by Edge Optimizer.

Name | Purpose
-----|--------
Edge Optimizer | Determines whether Edge Optimizer can be applied to a request.
Edge Optimizer – Instantiate Configuration | Instantiates or activates the Edge Optimizer configuration associated with a site.

###Edge Optimizer
**Purpose:** Determines whether Edge Optimizer can be applied to a request.

If this feature has been enabled, then the following criteria must also be met before the request will be processed by Edge Optimizer:

- The requested content must use an edge CNAME URL.
- The edge CNAME referenced in the URL must correspond to a site whose configuration has been activated in a rule.

This feature requires the ADN platform and the Edge Optimizer feature.

Value|Result
-|-
Enabled|Indicates that the request is eligible for Edge Optimizer processing.
Disabled|Restores the default behavior. The default behavior is to deliver content over the ADN platform without any additional processing.

**Default Behavior:** Disabled
 

###Edge Optimizer - Instantiate Configuration
**Purpose:** Instantiates or activates the Edge Optimizer configuration associated with a site.

This feature requires the ADN platform and the Edge Optimizer feature.

Key information:

- Instantiation of a site configuration is required before requests to the corresponding edge CNAME can be processed by Edge Optimizer.
- This instantiation only needs to be performed a single time per site configuration. A site configuration that has been instantiated will remain in that state until the Edge Optimizer – Instantiate Configuration feature that references it is removed from the rule.
- The instantiation of a site configuration does not mean that all requests to the corresponding edge CNAME will automatically be processed by Edge Optimizer. The Edge Optimizer feature determines whether an individual request will be processed.

If the desired site does not appear in the list, then you should edit its configuration and verify that the Active option has been marked.

**Default Behavior:** Site configurations are inactive by default.
--->

## <a name="origin"></a>Исходный домен

Эти функции предназначены для управления способом взаимодействия CDN с сервером-источником.

Имя | Назначение
-----|--------
Максимальное количество запросов для проверки активности | Определяет максимальное количество запросов для проверки активности подключения до его закрытия.
Специальные заголовки прокси-сервера | Определяет набор заголовков запросов, относящихся к CDN, которые будут перенаправляться с пограничного сервера на сервер-источник.


###<a name="maximum-keep-alive-requests"></a>Максимальное количество запросов для проверки активности
**Назначение.** Определяет максимальное количество запросов для проверки активности подключения до его закрытия.

Мы настоятельно рекомендуем не задавать низкое значение для максимального числа запросов, так как это может привести к снижению производительности.

Основные сведения

- Укажите в качестве значения целое число.
- Не добавляйте запятые или точки в указанное значение.

**Значение по умолчанию:** 10 000 запросов.

###<a name="proxy-special-headers"></a>Специальные заголовки прокси-сервера
**Назначение.** Определяет набор [заголовков запросов, относящихся к CDN](), которые будут перенаправляться с пограничного сервера на сервер-источник.

Основные сведения

- Каждый заголовок запроса, относящийся к CDN и определенный в этой функции, перенаправляется на сервер-источник.
- Удалите из этого списка заголовок запроса, относящийся к CDN, чтобы он не перенаправлялся на сервер-источник.

**Поведение по умолчанию.** Все [заголовки запросов, относящиеся к CDN](), пересылаются на сервер-источник.

## <a name="specialty"></a>Специальные

Эти функции обеспечивают дополнительные функциональные возможности, которые следует использовать только опытным пользователям.

Имя | Назначение
-----|--------
Кэшируемые методы HTTP | Определяет набор дополнительных методов HTTP, которые могут быть кэшированы в сети.
Размер текста кэшируемого запроса | Определяет пороговое значение для определения возможности кэширования ответа POST.

###<a name="cacheable-http-methods"></a>Кэшируемые методы HTTP
**Назначение.** Определяет набор дополнительных методов HTTP, которые могут быть кэшированы в сети.

Основные сведения

- Эта функция предполагает, что все ответы GET всегда кэшируются. В результате метод GET HTTP не следует включать при задании этой функции.
- Эта функция поддерживает только метод POST HTTP. Включите кэширование ответов POST, задав для этой функции значение: POST. 
- По умолчанию будут кэшироваться только запросы, размер которых меньше 14 КБ. Используйте функцию размера текста кэшируемого запроса, чтобы задать максимальный размер текста запроса.

**Поведение по умолчанию.** Будут кэшироваться только ответы GET.

###<a name="cacheable-request-body-size"></a>Размер текста кэшируемого запроса

**Назначение.** Определяет пороговое значение для определения возможности кэширования ответа POST.

Чтобы определить это пороговое значение, укажите максимальный размер текста запроса. Запросы, содержащие текст запроса большего размера, не будут кэшироваться.

Основные сведения

- Эта функция применяется, только если ответы POST будут пригодны для кэширования. Используйте функцию кэшируемых методов HTTP, чтобы включить кэширование запроса POST.
- Текст запроса принимается во внимание для следующих значений:
    - значения x-www-form-urlencode;
    - обеспечение уникального ключа кэша.
- Задание большого максимального размера текста запроса может повлиять на производительность доставки данных.
    - **Рекомендуемое значение:** 14 КБ.
    - **Минимальное значение:** 1 КБ.

**По умолчанию:** 14 КБ.
 
## <a name="url"></a>URL-адрес

Эти функции позволяют перенаправлять или перезаписывать запрос на другой URL-адрес.

Имя | Назначение
-----|--------
Поддержка перенаправлений | Определяет, можно ли перенаправлять запросы к имени узла, определенном в заголовке Location, возвращенным сервером-источником клиента.
URL Redirect | Перенаправляет запросы через заголовок Location.
Переопределение URL-адреса  | Перезаписывает URL-адрес запроса.

###<a name="follow-redirects"></a>Поддержка перенаправлений
**Назначение.** Определяет, можно ли перенаправлять запросы к имени узла, определенном в заголовке Location, возвращенным сервером-источником клиента.

Основные сведения

- Запросы можно перенаправлять только к граничным записям CNAME, которые соответствуют одной и той же платформе.

Значение|Результат
-|-
Включено|Запросы можно перенаправлять.
Отключено|Запросы не будут перенаправляться.

**Поведение по умолчанию.** Отключено.
###<a name="url-redirect"></a>URL Redirect
**Назначение.** Перенаправляет запросы через заголовок Location.

Для конфигурации этой функции требуется задать следующие параметры.

Параметр|Описание
-|-
Код|Выбор кода ответа, который возвращается инициатору запроса.
Источник и шаблон| Эти параметры определяют шаблон универсального кода ресурса (URI) запроса, обозначающий тип запросов, которые можно перенаправлять. Будут перенаправляться только те запросы, URL-адреса которых соответствуют следующим условиям. <br/> <br/> **Источник** (или точка доступа к содержимому): выберите относительный путь, который определяет сервер-источник. Это раздел "/XXXX/" и имя конечной точки. <br/> **Источник (шаблон):** необходимо указать шаблон, который определяет запросы по относительному пути. Этот шаблон регулярного выражения должен определять путь, который начинается непосредственно после выбранной ранее точки доступа к содержимому (см. выше). <br/> — Убедитесь, что критерии URI запроса (т. е. источника и шаблона), определенные выше, не конфликтуют с каким-либо условием соответствия, заданным для этой функции. <br/> — Укажите шаблон. Если использовать пустое значение в качестве шаблона, будут сопоставляться только запросы в корневую папку выбранного сервера-источника (например, http://cdn.mydomain.com/).
Место назначения| Определите URL-адрес, на который будут перенаправляться указанные выше запросы. <br/> Создайте этот URL-адрес динамически с помощью следующих компонентов: <br/> — шаблон регулярного выражения; <br/>— переменные HTTP. <br/> Заменить значения, записанные в шаблоне источника в целевой шаблон, с помощью $ _n_  где  _n_  определяет значение в порядке, в котором он был записан. Например, $1 представляет собой первое значение, записанное из исходного шаблона, а $2 — второе значение. <br/> 
Мы настоятельно рекомендуем использовать абсолютный URL-адрес. Использование относительного URL-адреса может привести к перенаправлению URL-адресов CDN по недопустимому пути.

**Пример сценария**

В этом примере показано, как перенаправлять URL-адрес граничной записи CNAME, который разрешается в этот базовый URL-адрес CDN: http://marketing.azureedge.net/brochures.

Отвечающие требованиям запросы будут перенаправляться на этот базовый URL-адрес граничной записи CNAME: http://cdn.mydomain.com/resources.

URL-адрес перенаправления можно получить с помощью следующей конфигурации: ![](./media/cdn-rules-engine-reference/cdn-rules-engine-redirect.png).

**Основные моменты:**

- Функция перенаправления URL-адреса определяет URL-адреса запроса, которые будут перенаправляться. В результате дополнительные условия соответствия не являются обязательными. Несмотря на то что условие соответствия было определено как Always, будут перенаправляться только те запросы, которые указывают на папку brochures в источнике клиента marketing. 
- Все соответствующие запросы будут перенаправляться на URL-адрес граничной записи CNAME, определенный в параметре Destination. 
    - Пример сценария №1: 
        - Пример запроса (URL-адрес CDN): http://marketing.azureedge.net/brochures/widgets.pdf. 
        - URL-адрес запроса (после перенаправления): http://cdn.mydomain.com/resources/widgets.pdf.  
    - Пример сценария №2: 
        - Пример запроса (URL-адрес граничной записи): http://marketing.mydomain.com/brochures/widgets.pdf. 
        - URL-адрес запроса (после перенаправления): http://cdn.mydomain.com/resources/widgets.pdf. Пример сценария
    - Пример сценария №3: 
        - Пример запроса (URL-адрес граничной записи CNAME): http://brochures.mydomain.com/campaignA/final/productC.ppt. 
        - URL-адрес запроса (после перенаправления): http://cdn.mydomain.com/resources/campaignA/final/productC.ppt.  
- В параметре Destination была использована переменная схемы запроса (%{scheme}). Это гарантирует, что схема запроса останется неизменной после перенаправления.
- Сегменты URL-адреса, полученные из запроса, добавляются к новому URL-адресу с помощью $1.
 
###<a name="url-rewrite"></a>Переопределение URL-адреса
**Назначение.** Перезаписывает URL-адрес запроса.

Основные сведения

- Для конфигурации этой функции требуется задать следующие параметры.

Параметр|Описание
-|-
 Источник и шаблон | Эти параметры определяют шаблон универсального кода ресурса (URI) запроса, определяющий тип запросов, которые можно перезаписать. Будут перезаписываться только те запросы, URL-адреса которых соответствуют следующим условиям: <br/>     - **Источник (или точка доступа к содержимому):** выберите относительный путь, который определяет сервер-источник. Это раздел "/XXXX/" и имя конечной точки. <br/> - **Источник (шаблон):** необходимо указать шаблон, который определяет запросы по относительному пути. Этот шаблон регулярного выражения должен определять путь, который начинается непосредственно после выбранной ранее точки доступа к содержимому (см. выше). <br/> — Убедитесь, что критерии URI запроса (т. е. источника и шаблона), определенные выше, не конфликтуют с каким-либо условием соответствия, заданным для этой функции. — Укажите шаблон. Если использовать пустое значение в качестве шаблона, будут сопоставляться только запросы в корневую папку выбранного сервера-источника (например, http://cdn.mydomain.com/). 
 Место назначения  |Определите относительный URL-адрес, на который будут перезаписываться указанные выше запросы. <br/>    1. Выбор точки доступа к содержимому, определяющей сервер-источник. <br/>    2) Определение относительного пути с помощью следующих компонентов: <br/>        — шаблон регулярного выражения; <br/>        — переменные HTTP. <br/> <br/> Заменить значения, записанные в шаблоне источника в целевой шаблон, с помощью $ _n_  где  _n_  определяет значение в порядке, в котором он был записан. Например, $1 представляет собой первое значение, записанное из исходного шаблона, а $2 — второе значение. 
 Эта функция позволяет нашим пограничным серверам переписывать URL-адрес, не выполняя традиционное перенаправление. Это означает, что инициатор запроса получит один и тот же код ответа так, как если бы был запрошен перезаписанный URL-адрес.

**Пример сценария 1**

В этом примере показано, как перенаправлять URL-адрес граничной записи CNAME, который разрешается в этот базовый URL-адрес CDN: http://marketing.azureedge.net/brochures.

Отвечающие требованиям запросы будут перенаправляться на этот базовый URL-адрес граничной записи CNAME: http://MyOrigin.azureedge.net/resources.

URL-адрес перенаправления можно получить с помощью следующей конфигурации: ![](./media/cdn-rules-engine-reference/cdn-rules-engine-rewrite.png).

**Пример сценария 2**

В этом примере показано, как перенаправлять URL-адрес граничной записи CNAME из верхнего регистра в нижний с помощью регулярных выражений.

URL-адрес перенаправления можно получить с помощью следующей конфигурации: ![](./media/cdn-rules-engine-reference/cdn-rules-engine-to-lowercase.png).


**Основные моменты:**

- Функция перезаписи URL-адреса определяет URL-адреса запроса, которые будут перезаписаны. В результате дополнительные условия соответствия не являются обязательными. Несмотря на то что условие соответствия было определено как Always, будут перезаписаны только те запросы, которые указывают на папку brochures в источнике клиента marketing.

- Сегменты URL-адреса, полученные из запроса, добавляются к новому URL-адресу с помощью $1.



###<a name="compatibility"></a>Совместимость

Эта функция включает критерии соответствия, которые необходимо выполнить, прежде чем ее можно будет применить к запросу. В целях предотвращения установки конфликтующих критериев соответствия эта функция несовместима со следующими условиями соответствия:

- Номер AS
- Источник CDN
- IP-адрес клиента
- Источник клиента
- Схема запроса
- Каталог URL-пути
- Расширение URL-пути
- Имя файла URL-пути
- Литерал URL-пути
- Регулярное выражение URL-пути
- Шаблон URL-пути
- Литерал запроса URL-адреса
- Параметр запроса URL-адреса
- Регулярное выражение запроса URL-адреса
- Шаблон запроса URL-адреса


## <a name="next-steps"></a>Дальнейшие действия
* [Azure Content Delivery Network Rules Engine](cdn-rules-engine-reference.md) (Обработчик правил сети доставки содержимого Azure)
* [Conditional Expressions for Azure Content Delivery Network (CDN) Rules Engine](cdn-rules-engine-reference-conditional-expressions.md) (Условные выражения для обработчика правил сети доставки содержимого (CDN) Azure)
* [Match Conditions for Azure Content Delivery Network (CDN) Rules Engine](cdn-rules-engine-reference-match-conditions.md) (Условия соответствия для обработчика правил сети доставки содержимого (CDN) Azure)
* [Переопределение стандартного поведения через HTTP с помощью обработчика правил](cdn-rules-engine.md)
* [Обзор Azure CDN](cdn-overview.md)

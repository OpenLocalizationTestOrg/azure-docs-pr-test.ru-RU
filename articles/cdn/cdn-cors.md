---
title: "Использование Azure CDN с CORS | Документация Майкрософт"
description: "Сведения об использовании сети доставки содержимого (CDN) Azure с общим доступом к ресурсам независимо от источника (CORS)."
services: cdn
documentationcenter: 
author: zhangmanling
manager: erikre
editor: 
ms.assetid: 86740a96-4269-4060-aba3-a69f00e6f14e
ms.service: cdn
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/23/2017
ms.author: mazha
ms.openlocfilehash: 7070397f6e69b21add75bad8220f0b8ebe36d266
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="using-azure-cdn-with-cors"></a>Использование Azure CDN с CORS
## <a name="what-is-cors"></a>Что такое CORS?
CORS (общий доступ к ресурсам независимо от источника) — функция HTTP, которая позволяет веб-приложению, работающему в одном домене, обращаться к ресурсам другого домена. Чтобы снизить вероятность атак с использованием межузловых сценариев, все современные веб-браузеры реализуют ограничение безопасности, известное как [политика одного источника](http://www.w3.org/Security/wiki/Same_Origin_Policy).  Это ограничение не позволяет веб-страницы вызывать интерфейсы API в другом домене.  CORS позволяет одному источнику (исходному домену) безопасно вызывать интерфейсы API в другом источнике.

## <a name="how-it-works"></a>Принцип работы
Существует два типа запросов CORS, *простые запросы* и *сложные запросы*.

### <a name="for-simple-requests"></a>Простые запросы

1. Браузер отправляет запрос CORS с дополнительным заголовком HTTP-запроса **Origin**. Значение этого заголовка является источником, обслужившим родительскую страницу, который определяется как сочетание *протокола*, *домена* и *порта*.  Когда страница сайта https://www.contoso.com попытается получить доступ к данным пользователя в источнике fabrikam.com, на fabrikam.com отправится запрос со следующим заголовком.

   `Origin: https://www.contoso.com`

2. Сервер может отправить в ответ следующее:

   * Ответ с заголовком **Access-Control-Allow-Origin**, который указывает, какие исходные сайты разрешены. Например:

     `Access-Control-Allow-Origin: https://www.contoso.com`

   * Код ошибки HTTP (например, 403), если сервер запрещает запрос независимо от источника после проверки заголовка Origin.

   * Заголовок **Access-Control-Allow-Origin** с подстановочным знаком, который разрешает все источники:

     `Access-Control-Allow-Origin: *`

### <a name="for-complex-requests"></a>Сложные запросы

Сложный запрос — это запрос CORS, для выполнения которого браузер должен отправить *предварительный запрос* (т. е. предварительную пробу) перед отправкой самого запроса CORS. Предварительный запрос запрашивает у сервера разрешения на выполнение исходного запроса CORS. Он представляет собой запрос `OPTIONS` к тому же URL-адресу.

> [!TIP]
> Дополнительные сведения о процедурах CORS и типичных проблемах доступны в [руководстве по CORS для REST API](https://www.moesif.com/blog/technical/cors/Authoritative-Guide-to-CORS-Cross-Origin-Resource-Sharing-for-REST-APIs/).
>
>

## <a name="wildcard-or-single-origin-scenarios"></a>Подстановочный знак или сценарии с одним источником
CORS в Azure CDN будет работать автоматически без дополнительной настройки, если в заголовке **Access-Control-Allow-Origin** указан подстановочный знак (*) или один источник.  В этом случае CDN кэширует первый ответ, и в последующих запросах будет использоваться тот же заголовок.

Если запросы в CDN были отправлены до настройки CORS на вашем источнике, потребуется очистить содержимое конечной точки, чтобы обновить содержимое с заголовком **Access-Control-Allow-Origin** .

## <a name="multiple-origin-scenarios"></a>Сценарии с несколькими источниками
Если необходимо разрешить для CORS определенный набор источников, задача несколько усложняется. Проблема возникает, когда CDN кэширует заголовок **Access-Control-Allow-Origin** для первого источника CORS.  При последующем запросе от другого источника CORS сеть CDN отправит кэшированный заголовок **Access-Control-Allow-Origin**, который не будет соответствовать заголовку другого источника.  Исправить это можно несколькими способами.

### <a name="azure-cdn-premium-from-verizon"></a>Azure CDN уровня "Премиум" от Verizon
Удобнее всего воспользоваться **Azure CDN уровня "Премиум" от Verizon**с некоторыми дополнительными функциями. 

Вам потребуется [создать правило](cdn-rules-engine.md) для проверки заголовка запроса **Origin** .  Если это допустимый источник, то ваше правило установит заголовок **Access-Control-Allow-Origin** в соответствии с источником, указанным в запросе.  Если источник, указанный в заголовке **Origin**, не является допустимым, то ваше правило должно опустить заголовок **Access-Control-Allow-Origin**, что заставит браузер отклонить запрос. 

С помощью обработчика правил это можно сделать двумя способами.  В обоих случаях заголовок **Access-Control-Allow-Origin** из файла сервера-источника полностью игнорируется, и разрешенными источниками CORS управляет только обработчик правил CDN.

#### <a name="one-regular-expression-with-all-valid-origins"></a>Одно регулярное выражение со всеми допустимыми источниками
В этом случае создается регулярное выражение, которое включает все источники, которые вы хотите разрешить: 

    https?:\/\/(www\.contoso\.com|contoso\.com|www\.microsoft\.com|microsoft.com\.com)$

> [!TIP]
> В **Azure CDN от Verizon** в качестве основного механизма регулярных выражений используются [совместимые с Perl регулярные выражения](http://pcre.org/).  Для проверки регулярного выражения можно использовать такие ресурсы, как [Regular Expressions 101](https://regex101.com/).  Обратите внимание, что символ "/" в регулярных выражениях является допустимым и экранировать его необязательно. Однако его все же рекомендуется экранировать, и некоторые средства проверки регулярных выражений ожидают, что он будет экранирован.
> 
> 

Если регулярное выражение соответствует запросу, то правило заменит заголовок **Access-Control-Allow-Origin** источника (если он есть) на источник, который отправил запрос.  Также можно добавить дополнительные заголовки CORS, например **Access-Control-Allow-Methods**.

![Пример правил с регулярным выражением](./media/cdn-cors/cdn-cors-regex.png)

#### <a name="request-header-rule-for-each-origin"></a>Правило заголовка запроса для каждого источника.
Вместо регулярных выражений можно создать отдельное правило для каждого источника, который вы хотите разрешить, с помощью **условия соответствия** [подстановочного знака в заголовке запроса](https://msdn.microsoft.com/library/mt757336.aspx#Anchor_1). Как и регулярное выражение, заголовки CORS задаются только обработчиком правил. 

![Пример правил без регулярного выражения](./media/cdn-cors/cdn-cors-no-regex.png)

> [!TIP]
> В примере выше подстановочный знак * означает, что обработчик правил будет проверять на соответствие как HTTP-, так и HTTPS-запросы.
> 
> 

### <a name="azure-cdn-standard"></a>Azure CDN уровня "Стандартный"
Единственный механизм, который разрешает наличие нескольких источников без использования источника с подстановочным знаком в профилях Azure CDN уровня "Стандартный" — это [кэширование строки запроса](cdn-query-string.md).  Вам необходимо включить параметр строки запроса для конечной точки CDN, а затем использовать уникальную строку запроса для запросов от каждого разрешенного домена. Это приведет к тому, что CDN будет кэшировать отдельный объект для каждой уникальной строки запроса. Однако этот подход не является идеальным, так как он приведет к появлению нескольких копий одного файла в кэше CDN.  


---
title: "Оптимизация скачивания больших файлов через сеть доставки содержимого Azure"
description: "Подробное объяснение оптимизации скачивания больших файлов"
services: cdn
documentationcenter: 
author: smcevoy
manager: erikre
editor: 
ms.assetid: 
ms.service: cdn
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/16/2017
ms.author: v-semcev
ms.openlocfilehash: 7a5d5d1d0de24ebb0a5115ede1e572f38454bd78
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="large-file-download-optimization-via-the-azure-content-delivery-network"></a>Оптимизация скачивания больших файлов через сеть доставки содержимого Azure

Размеры файлов, передаваемых через Интернет, продолжают расти в результате расширения функциональности, улучшения графики и расширенного мультимедийного содержимого. На этот рост влияют множество факторов: распространение высокоскоростного доступа к Интернету, устройства хранения большего размера по меньшей цене, широкое распространение видео с высоким разрешением и устройства, подключенные к Интернету (IoT). Чтобы обеспечить комфорт пользователей, крайне важно обеспечить быстрый и эффективный механизм доставки для файлов большого размера.

С доставкой больших файлов связано несколько трудностей. Во-первых, среднее время скачивания большого файла может оказаться довольно большим, так как приложения могут не скачивать все данные последовательно. В некоторых случаях приложение может скачать последнюю часть файла, а затем — первую. Если запрашивается небольшая часть файла или пользователь приостанавливает скачивание, скачивание может завершиться сбоем. Скачивание также может быть отложено до тех пор, пока сеть доставки содержимого не загрузит весь файл с сервера-источника. 

Во-вторых, задержка между компьютером пользователя и файлом определяет скорость, с которой пользователь может просматривать содержимое. Кроме того, на пропускную способность также могут повлиять перегрузка сети и проблемы, связанные с емкостью сети. Из-за увеличения расстояния между серверами и пользователями появляются дополнительные шансы потери пакетов, что снижает качество передачи. Снижение качества, вызванное ограниченной пропускной способностью и увеличенной частотой потери пакетов, может увеличить время скачивания файла. 

В-третьих, многие файлы большого размера не доставляются полностью. Пользователи могут отменить загрузку в середине или просмотреть только первые несколько минут длинного видео MP4. Поэтому многим организациям и многим программам необходимо доставлять только ту часть файла, которая была запрошена пользователем. Эффективное распределение запрошенных частей файла снижает исходящий трафик с сервера-источника. Эффективное распределение также снижает нагрузку на оперативную память и операции ввода/вывода на сервере-источнике. 

Сеть доставки содержимого Azure от Akamai теперь предоставляет возможность эффективной доставки больших файлов для пользователей по всему миру. Эта функция сокращает задержки, так как снижает нагрузку на серверы-источники. Эта функция доступна в ценовой категории Akamai уровня "Стандартный".

## <a name="configure-a-cdn-endpoint-to-optimize-delivery-of-large-files"></a>Настройка конечной точки сети доставки содержимого для оптимизации доставки больших файлов

Вы можете настроить конечную точку сети доставки содержимого для оптимизации доставки больших файлов с помощью портала Azure. Для этого можно также использовать наши интерфейсы REST API или любые клиентские пакеты SDK. Для настройки конечной точки на портале Azure выполните следующие действия.

1. Чтобы добавить новую конечную точку, на странице **Профиль сети доставки содержимого** выберите **Конечная точка**.

    ![Новая конечная точка](./media/cdn-large-file-optimization/01_Adding.png)  
 
2. В раскрывающемся списке **Оптимизировано для** выберите **Скачивание больших файлов**.

    ![Выбрана оптимизация скачивания больших файлов](./media/cdn-large-file-optimization/02_Creating.png)


После создания конечной точки сети доставки содержимого будет применена оптимизация скачивания больших файлов для всех файлов, соответствующих определенным условиям. Этот процесс описан в следующем разделе.

## <a name="optimize-for-delivery-of-large-files-with-the-azure-content-delivery-network-from-akamai"></a>Оптимизация доставки больших файлов в сети доставки содержимого Azure от Akamai

При оптимизации доставки больших файлов включаются средства оптимизации сети и конфигурации, благодаря которым доставка больших файлов осуществляется быстрее и надежнее. Общая веб-доставка для Akamai кэширует только файлы размером менее 1,8 ГБ и может туннелировать (не кэшировать) файлы размером до 150 ГБ. При оптимизации больших файлов кэшируются файлы размером до 150 ГБ.

Для эффективной оптимизации больших файлов необходимо соблюдение определенных условий. К этим условиям относятся способ работы сервера-источника и размеры и типы запрашиваемых файлов. Перед тем как углубиться в эти вопросы, расскажем о том, как работает оптимизация. 

### <a name="object-chunking"></a>Фрагментирование объекта 

В сети доставки содержимого Azure от Akamai используется метод оптимизации, называемый фрагментированием объекта. При запросе большого файла сеть доставки содержимого получает небольшие фрагменты файла с сервера-источника. После того как пограничный сервер или POP-сервер сети доставки содержимого получает запрос на полный файл или запрос на диапазон байт файла, этот сервер проверяет, поддерживается ли оптимизация для этого типа файлов. Сервер также проверяет, соответствует ли размер файла указанным требованиям к размерам файлов. Если размер файла превышает 10 МБ, пограничный сервер сети доставки содержимого запрашивает файл с сервера-источника фрагментами по 2 МБ. 

После того как фрагмент поступает на пограничный сервер сети доставки содержимого, он кэшируется и немедленно отправляется пользователю. В это же время сеть доставки содержимого загружает следующий фрагмент. Эта предварительная загрузка гарантирует, что всегда будет загружен следующий фрагмент содержимого (по сравнению с тем фрагментом, который просматривает пользователь), что позволяет снизить задержку. Этот процесс продолжается до тех пор, пока не будет скачан весь файл (если он запрашивался), пока не будут скачаны все запрошенные диапазоны байт (если они запрашивались) или пока клиент не завершит соединение. 

Дополнительные сведения о запросе диапазона байт см. в разделе [RFC 7233](https://tools.ietf.org/html/rfc7233).

Сеть доставки содержимого кэширует все фрагменты по мере их получения. Весь файл не кэшируется в кэше сети доставки содержимого. Последующие запросы файла или диапазонов байт обслуживаются из кэша сети доставки содержимого. Если в сети доставки содержимого отсутствуют некоторые фрагменты файла, запрошенные недостающие фрагменты предварительно загружаются с сервера-источника. В основе этой оптимизации лежит поддержка запросов диапазонов байт сервером-источником. _Если сервер-источник не поддерживает запросы диапазонов байт, эта оптимизация будет неэффективной._ 

### <a name="caching"></a>Caching
При оптимизации скачивания больших файлов используется другое время истечения срока действия кэша по умолчанию по сравнению с общей веб-доставкой. Существует разница между положительным и отрицательным кэшированием на основе кодов ответов HTTP. Если сервер-источник задает время окончания срока действия в ответе с помощью заголовка Cache-Control или Expires, сеть доставки содержимого учитывает это значение. Если же источник не указывает время, а файл соответствует условиям для типа и размера файла, которые применяются для данного типа оптимизации, то сеть доставки содержимого использует значения по умолчанию для оптимизации больших файлов. В противном случае сеть доставки содержимого использует значения по умолчанию для оптимизации общей веб-доставки.


|    | Общая веб-доставка | Оптимизация больших файлов 
--- | --- | --- 
Кэширование: положительное <br> HTTP 200, 203, 300, <br> 301, 302 и 410 | 7 дней |1 день  
Кэширование: отрицательное <br> HTTP 204, 305, 404 <br> и 405 | None | 1 с 

### <a name="deal-with-origin-failure"></a>Устранение сбоев источника

Время ожидания чтения источника увеличивается с двух секунд для оптимизации общей веб-доставки до двух минут для оптимизации больших файлов. Это увеличение учитывается для файлов большого размера, чтобы избежать преждевременного разрыва соединения из-за истечения времени ожидания.

После истечения времени ожидания подключения сеть доставки содержимого повторит попытку подключения несколько раз, после чего клиенту будет отправлена ошибка 504 ("Время ожидания шлюза истекло"). 

### <a name="conditions-for-large-file-optimization"></a>Условия для оптимизации больших файлов

В следующей таблице перечислен набор критериев, которые необходимо удовлетворить для этой оптимизации:

Условие | Значения 
--- | --- 
Поддерживаемые типы файлов | 3g2, 3gp, asf, avi, bz2, dmg, exe, f4v, flv, <br> gz, hdp, iso, jxr, m4v, mkv, mov, mp4, <br> mpeg, mpg, mts, pkg, qt, rm, swf, tar, <br> tgz, wdp, webm, webp, wma, wmv, zip  
Минимальный размер файла | 10 МБ 
Максимальный размер файла | 150 ГБ 
Характеристики сервера-источника | Должен поддерживать запросы диапазонов байт 

## <a name="optimize-for-delivery-of-large-files-with-the-azure-content-delivery-network-from-verizon"></a>Оптимизация доставки больших файлов в сети доставки содержимого Azure от Verizon

Сеть доставки содержимого Azure от Verizon выполняет доставку больших файлов без ограничения на размер файла. По умолчанию включены дополнительные функции, чтобы ускорить доставку больших файлов.

### <a name="complete-cache-fill"></a>Завершение заполнения кэша

Функция завершения заполнения кэша по умолчанию позволяет сети доставки содержимого загрузить файл в кэш, когда начальный запрос прерван или утерян. 

Функция завершения заполнения кэша особенно полезна для больших ресурсов. Как правило, пользователи не скачивают их от начала до конца. Они используют поэтапную загрузку. Поведение по умолчанию заключается в том, чтобы заставить пограничный сервер начать получение фоновых данных ресурса с сервера-источника. После этого ресурс будет находиться в локальном кэше пограничного сервера. Когда полный объект находится в кэше, пограничный сервер выполняет запросы диапазонов байт к сети доставки содержимого для кэшированного объекта.

Поведение по умолчанию можно отключить с помощью обработчика правил для Verizon уровня "Премиум".

### <a name="peer-cache-fill-hot-filing"></a>Заполнение однорангового кэша "горячими" данными

Функция заполнения однорангового кэша "горячими" данными по умолчанию использует сложный проприетарный алгоритм. Она использует дополнительные пограничные серверы в зависимости от пропускной способности и статистических метрик запросов для выполнения запросов клиентов для больших объектов, обращение к которым производится очень часто. Эта функция необходима, чтобы предотвратить отправку большого количества дополнительных запросов на сервер-источник пользователя. 

### <a name="conditions-for-large-file-optimization"></a>Условия для оптимизации больших файлов

Функции оптимизации для Verizon включены по умолчанию. Ограничения на максимальный размер файла отсутствуют. 

## <a name="additional-considerations"></a>Дополнительные замечания

Рассмотрите следующие дополнительные аспекты для этого типа оптимизации.
 
### <a name="azure-content-delivery-network-from-akamai"></a>Сеть доставки содержимого Azure от Akamai

- Процесс фрагментации создает дополнительные запросы к серверу-источнику. Однако общий объем данных, доставляемых от сервера-источника, намного меньше. Фрагментация приводит к улучшению характеристик кэширования в сети доставки содержимого.

- Нагрузка на оперативную память и операции ввода/вывода в источнике снижаются, так как передаются более мелкие фрагменты файлов.

- Для фрагментов, кэшированных в сети доставки содержимого, дополнительные запросы к источнику будут отсутствовать до тех пор, пока срок действия содержимого не истечет или пока содержимое не будет извлечено из кэша.

- Пользователи могут выполнять запросы диапазонов к сети доставки содержимого, и они обрабатываются так же, как и для обычных файлов. Оптимизация применяется только в том случае, если файл имеет допустимый тип и если диапазон байт находится между 10 МБ и 150 ГБ. Если средний размер запрошенного файла меньше 10 МБ, рекомендуется использовать оптимизацию для общей веб-доставки.

### <a name="azure-content-delivery-network-from-verizon"></a>Сеть доставки содержимого Azure от Verizon

Оптимизацию общей веб-доставки можно использовать для доставки больших файлов.

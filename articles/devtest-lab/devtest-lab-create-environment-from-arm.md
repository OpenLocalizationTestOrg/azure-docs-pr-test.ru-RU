---
title: "Создание сред со множеством виртуальных машин и ресурсов PaaS с помощью шаблонов Azure Resource Manager | Документация Майкрософт"
description: "Узнайте, как в Azure DevTest Labs создавать среды со множеством виртуальных машин и ресурсов PaaS, используя шаблон Azure Resource Manager."
services: devtest-lab,virtual-machines,visual-studio-online
documentationcenter: na
author: craigcaseyMSFT
manager: douge
editor: 
ms.assetid: 
ms.service: devtest-lab
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/31/2017
ms.author: v-craic
ms.openlocfilehash: 55a6c5cd5a0544b297bb68841c5ff0314f48dcc9
ms.sourcegitcommit: 562a537ed9b96c9116c504738414e5d8c0fd53b1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2018
---
# <a name="create-multi-vm-environments-and-paas-resources-with-azure-resource-manager-templates"></a>Создание сред со множеством виртуальных машин и ресурсов PaaS с помощью шаблонов Azure Resource Manager

[Портал Azure](http://go.microsoft.com/fwlink/p/?LinkID=525040) позволяет с легкостью [создать и добавить виртуальную машину в лабораторию](https://docs.microsoft.com/azure/devtest-lab/devtest-lab-add-vm). Этот вариант хорошо подходит, если одновременно создается только одна виртуальная машина. Но если среда содержит несколько виртуальных машин, каждую из них необходимо создавать отдельно. Для сценариев, где задействовано многоуровневое веб-приложение или ферма SharePoint, требуется механизм создания множества виртуальных машин одним действием. С помощью шаблонов Azure Resource Manager теперь можно определить инфраструктуру и конфигурацию решения Azure и многократно развернуть множество виртуальных машин в согласованном состоянии. Эта функция обеспечивает следующие преимущества:

- Шаблоны Azure Resource Manager загружаются непосредственно из репозитория системы управления версиями (GitHub или Team Services Git).
- После настройки пользователи могут создать среду, выбрав шаблон Azure Resource Manager на портале Azure, как это делается для других типов [баз виртуальных машин](./devtest-lab-comparing-vm-base-image-types.md).
- На основе шаблона Azure Resource Manager в среде можно подготовить ресурсы Azure PaaS, в дополнение к виртуальным машинам IaaS.
- В лаборатории можно отслеживать стоимость сред, а также отдельных виртуальных машин, созданных другими типами баз.
- Ресурсы PaaS создаются и будут отображаться в отслеживании расходов. Однако автоматическое завершение работы виртуальной машины не применяется к ресурсам PaaS.
- У пользователей есть такое же средство управления политиками виртуальных машин для сред, как и для виртуальных машин отдельной лаборатории.

Узнайте обо всех [преимуществах использования шаблонов Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview#the-benefits-of-using-resource-manager) для развертывания, обновления или удаления всех лабораторных ресурсов за одну операцию.

> [!NOTE]
> Если вы используете шаблон Resource Manager в качестве основы для создания дополнительных лабораторных виртуальных машин, то следует помнить, что существуют некоторые различия при создании нескольких виртуальных машин и одной виртуальной машины. В руководстве по [использованию шаблона Azure Resource Manager для виртуальной машины](devtest-lab-use-resource-manager-template.md) эти различия описываются более подробно.
>
>

## <a name="configure-azure-resource-manager-template-repositories"></a>Настройка репозиториев шаблонов Azure Resource Manager

При использования подходов "инфраструктура как код" и "конфигурация как код" управлять шаблонами среды рекомендуется в системе управления версиями. Служба Azure DevTest Labs следует этой рекомендации и загружает все шаблоны Azure Resource Manager непосредственно из репозиториев GitHub или VSTS Git. В результате шаблоны Resource Manager можно использовать в ходе всего цикла выпуска — от тестовой до рабочей среды.

Существует несколько правил, которым необходимо следовать при упорядочивании шаблонов Azure Resource Manager в репозитории:

- Имя файла основного шаблона должно быть `azuredeploy.json`. 

    ![Основные файлы шаблонов Azure Resource Manager](./media/devtest-lab-create-environment-from-arm/master-template.png)

- Чтобы использовать значения параметров, определенные в файле параметров, имя этого файла должно быть `azuredeploy.parameters.json`.
- Для создания значения URI parametersLink можно использовать параметры `_artifactsLocation` и `_artifactsLocationSasToken`, чтобы служба DevTest Labs автоматически управляла вложенными шаблонами. Дополнительные сведения см. в статье [Как служба Azure DevTest Labs упрощает развертывание вложенных шаблонов Resource Manager в тестовых средах](https://blogs.msdn.microsoft.com/devtestlab/2017/05/23/how-azure-devtest-labs-makes-nested-arm-template-deployments-easier-for-testing-environments/).
- Можно определить метаданные, чтобы указать отображаемое имя и описание шаблона. Эти метаданные должны находиться в файле с именем `metadata.json`. В следующем примере файла метаданных показано, как указать отображаемое имя и описание: 

```json
{
 
"itemDisplayName": "<your template name>",
 
"description": "<description of the template>"
 
}
```

Ниже описаны шаги, которые помогут вам добавить в лабораторию репозиторий, используя портал Azure. 

1. Войдите на [портале Azure](http://go.microsoft.com/fwlink/p/?LinkID=525040).
1. Щелкните **Больше служб**, а затем выберите в списке **DevTest Labs**.
1. Из списка лабораторий выберите нужную лабораторию.   
1. В области **Обзор** лаборатории выберите **Конфигурация и политики**.

    ![Configuration and Policies (Конфигурация и политики)](./media/devtest-lab-create-environment-from-arm/configuration-and-policies-menu.png)

1. В списке параметров **Configuration and Policies** (Конфигурация и политики) выберите пункт **Репозитории**. В области **Репозитории** перечислены репозитории, которые добавлены в лабораторию. Репозиторий с именем `Public Repo` автоматически создается для всех лабораторий и подключается к [репозиторию DevTest Labs на сайте GitHub](https://github.com/Azure/azure-devtestlab), который содержит несколько артефактов виртуальной машины.

    ![Общедоступный репозиторий](./media/devtest-lab-create-environment-from-arm/public-repo.png)

1. Щелкните **+Добавить**, чтобы добавить репозиторий шаблонов Azure Resource Manager.
1. Когда откроется вторая область **Репозитории**, введите необходимые сведения, как описано ниже.
    - **Имя**: введите имя репозитория, которое используется в лаборатории.
    - **URL-адрес клона Git**: введите URL-адрес клона HTTPS Git из GitHub или Visual Studio Team Services.  
    - **Ветвь**: введите имя ветви для доступа к определениям шаблонов Azure Resource Manager. 
    - **Личный маркер доступа**: используется для безопасного доступа к репозиторию. Для получения маркера в Visual Studio Team Services выберите **&lt;Ваше_имя> > Мой профиль > Безопасность > Public access token** (Общедоступный маркер доступа). Для получения маркера в GitHub выберите свой аватар, а затем щелкните **Параметры > Public access token** (Общедоступный маркер доступа). 
    - **Folder paths** (Пути к папке): с помощью одного из двух полей ввода введите путь к папке, который начинается с косой черты (/) и относится к URI клона Git, ведущему к определениях артефактов (первое поле ввода) или определениям шаблонов Azure Resource Manager.   
    
        ![Общедоступный репозиторий](./media/devtest-lab-create-environment-from-arm/repo-values.png)


1. Когда все обязательные поля заполнены и данные проверены, нажмите кнопку **Сохранить**.

В следующем разделе описывается процесс создания сред на основе шаблона Azure Resource Manager.

## <a name="create-an-environment-from-a-resource-manager-template-using-the-azure-portal"></a>Создание среды на основе шаблона Resource Manager с помощью портала Azure

После настройки в лаборатории репозитория шаблонов Azure Resource Manager пользователи лаборатории могут создать среду, выполнив следующие действия на портале Azure:

1. Войдите на [портале Azure](http://go.microsoft.com/fwlink/p/?LinkID=525040).
1. Щелкните **Больше служб**, а затем выберите в списке **DevTest Labs**.
1. Из списка лабораторий выберите нужную лабораторию.   
1. В области лаборатории щелкните **Добавить+**.
1. В области **Выбор базы** в начале списка отображаются базовые образы, которые можно использовать с шаблонами Azure Resource Manager. Выберите нужный шаблон Azure Resource Manager.

    ![Выбор основы](./media/devtest-lab-create-environment-from-arm/choose-a-base.png)
  
1. В области **Добавить** введите значение параметра **Имя среды**. Имя среды будет отображаться для пользователей вашей лаборатории. Остальные поля ввода определяются в шаблоне Azure Resource Manager. Если в шаблоне определены значения по умолчанию или есть файл `azuredeploy.parameter.json`, то значения по умолчанию отобразятся в этих полях ввода. Для параметров типа *защищенной строки* можно использовать секреты, хранящиеся в [личном хранилище секретов](https://azure.microsoft.com/en-us/updates/azure-devtest-labs-keep-your-secrets-safe-and-easy-to-use-with-the-new-personal-secret-store) лаборатории.

    ![Добавление области](./media/devtest-lab-create-environment-from-arm/add.png)

    > [!NOTE]
    > Существует несколько значений параметров, которые, даже если они указаны, отображаются как пустые значения. Таким образом, если пользователи назначат эти значения параметрам в шаблоне Azure Resource Manager, эти значения не отобразятся в DevTest Labs. Вместо этого будут показаны пустые поля ввода, где пользователи лаборатории должны ввести значение при создании среды.
    > 
    > - GEN-UNIQUE
    > - GEN-UNIQUE-[N]
    > - GEN-SSH-PUB-KEY
    > - GEN-PASSWORD 
 
1. Нажмите кнопку **Добавить**, чтобы создать среду. Сразу начнется процесс подготовки среды. В списке **My virtual machines** (Мои виртуальные машины) будет отображаться состояние процесса. Лаборатория автоматически создает группу ресурсов, чтобы подготовить все ресурсы, определенные в шаблоне Azure Resource Manager.
1. Выберите созданную среду в списке **Мои виртуальные машины**, чтобы открыть область группы ресурсов и просмотреть все ресурсы, подготовленные в этой среде.
    
    ![Список "My virtual machines" (Мои виртуальные машины)](./media/devtest-lab-create-environment-from-arm/all-environment-resources.png)
   
   Вы также можете развернуть среду, чтобы просто просмотреть список виртуальных машин, которые подготовлены к работе в этой среде.
    
    ![Список "My virtual machines" (Мои виртуальные машины)](./media/devtest-lab-create-environment-from-arm/my-vm-list.png)

1. Щелкните любую из сред, чтобы просмотреть доступные действия, такие как применение артефактов, присоединение дисков данных, изменение времени автоматического завершения работы и другие.

    ![Действия среды](./media/devtest-lab-create-environment-from-arm/environment-actions.png)

## <a name="deploy-a-resource-manager-template-to-create-a-vm"></a>Развертывание шаблона Resource Manager для создания виртуальной машины
После сохранения и настройки шаблона Resource Manager в соответствии с вашими потребностями его можно использовать для автоматизации создания виртуальной машины. 
- Сведения об использовании Azure PowerShell с шаблонами Resource Manager для развертывания ресурсов в Azure см. в [этой статье](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-template-deploy). 
- Сведения об использовании Azure CLI с шаблонами Resource Manager для развертывания ресурсов в Azure см. в [этой статье](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-template-deploy-cli).

> [!NOTE]
> Только пользователь с правами владельца лаборатории может создать виртуальные машины из шаблона Resource Manager с помощью Azure PowerShell. Если необходимо автоматизировать создание виртуальной машины с помощью шаблона Resource Manager и у вас есть только разрешения пользователя, воспользуйтесь [командой CLI](https://docs.microsoft.com/cli/azure/lab/vm#az_lab_vm_create)**az lab vm create**.

### <a name="general-limitations"></a>Общие ограничения 

Учитывайте следующие ограничения при использовании шаблона Resource Manager в DevTest Labs.

- Любой создаваемый вами шаблон Resource Manager не может ссылаться на существующие ресурсы. Он может ссылаться только на новые ресурсы. Кроме того, если у вас есть существующий шаблон Resource Manager, который обычно развертывается за пределами DevTest Labs и содержит ссылки на существующие ресурсы, его нельзя использовать в лаборатории.

   Единственное исключение — вы **можете** ссылаться на существующую виртуальную сеть. 

- Формулы нельзя создавать на основе виртуальных машин лаборатории, которые были созданы из шаблона Resource Manager. 

- Пользовательские образы нельзя создавать на основе виртуальных машин лаборатории, которые были созданы из шаблона Resource Manager. 

- Большинство политик не обрабатываются при развертывании шаблонов Resource Manager.

   Например, может быть установлена политика лаборатории, указывающая, что пользователь может создать только пять виртуальных машин. Тем не менее, если пользователь развернет шаблон Resource Manager, который создает десятки виртуальных машин, это будет разрешено. К политикам, которые не обрабатываются, относятся следующие:

   - число виртуальных машин на пользователя;
   - число виртуальных машин уровня Premium на пользователя лаборатории;
   - число дисков уровня Premium на пользователя лаборатории.


### <a name="configure-environment-resource-group-access-rights-for-lab-users"></a>Настройка прав доступа к группе ресурсов среды для пользователей лаборатории

Пользователи лаборатории могут развернуть шаблон Resource Manager. Но по умолчанию у них есть только права доступа на чтение. Это означает, что они не могут изменять ресурсы в группе ресурсов среды. Например, они не могут останавливать или запускать свои ресурсы.

Выполните следующие действия, чтобы предоставить пользователям лаборатории права доступа для участников. После этого при развертывании шаблона Resource Manager они смогут редактировать ресурсы в соответствующей среде. 


1. В области лаборатории **Обзор** выберите **Конфигурация и политики**.
1. Выберите **Параметры лаборатории**.
1. В области "Параметры лаборатории" выберите **Участник**, чтобы предоставить пользователям лаборатории разрешения на запись.

    ![Настройка прав доступа пользователей лаборатории](./media/devtest-lab-create-environment-from-arm/configure-access-rights.png)

1. Щелкните **Сохранить**.

## <a name="next-steps"></a>Дополнительная информация
* К созданной виртуальной машине можно подключиться, щелкнув **Подключиться** в области управления виртуальной машиной.
* Для просмотра и администрирования ресурсов в среде выберите среду в списке **Мои виртуальные машины** в вашей лаборатории. 
* Вы можете ознакомиться с [шаблонами Azure Resource Manager из коллекции шаблонов быстрого запуска Azure](https://github.com/Azure/azure-quickstart-templates).

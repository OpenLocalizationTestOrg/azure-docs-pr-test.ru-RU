---
title: "Создание сред со множеством виртуальных машин и ресурсов PaaS с помощью шаблонов Azure Resource Manager | Документация Майкрософт"
description: "Узнайте, как в Azure DevTest Labs создавать среды со множеством виртуальных машин и ресурсов PaaS, используя шаблон Azure Resource Manager."
services: devtest-lab,virtual-machines,visual-studio-online
documentationcenter: na
author: tomarcher
manager: douge
editor: 
ms.assetid: 
ms.service: devtest-lab
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/31/2017
ms.author: tarcher
ms.openlocfilehash: 4e1aae6c041e4572e7e2281203f969e7649e1480
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="create-multi-vm-environments-and-paas-resources-with-azure-resource-manager-templates"></a>Создание сред со множеством виртуальных машин и ресурсов PaaS с помощью шаблонов Azure Resource Manager

[Портал Azure](http://go.microsoft.com/fwlink/p/?LinkID=525040) позволяет с легкостью [создать и добавить виртуальную машину в лабораторию](https://docs.microsoft.com/en-us/azure/devtest-lab/devtest-lab-add-vm). Этот вариант хорошо подходит, если одновременно создается только одна виртуальная машина. Но если среда содержит несколько виртуальных машин, то каждую из них необходимо создавать отдельно. Для сценариев, где задействовано многоуровневое веб-приложение или ферма SharePoint, требуется механизм создания множества виртуальных машин одним действием. С помощью шаблонов Azure Resource Manager теперь можно определить инфраструктуру и конфигурацию решения Azure и многократно развернуть множество виртуальных машин в согласованном состоянии. Эта функция обеспечивает следующие преимущества:

- Шаблоны Azure Resource Manager загружаются непосредственно из репозитория системы управления версиями (GitHub или Team Services Git).
- После настройки пользователи могут создать среду, выбрав шаблон Azure Resource Manager на портале Azure, как они делают с другими типами [баз виртуальных машин](./devtest-lab-comparing-vm-base-image-types.md).
- На основе шаблона Azure Resource Manager в среде можно подготовить ресурсы Azure PaaS, в дополнение к виртуальным машинам IaaS.
- В лаборатории можно отслеживать стоимость сред, а также отдельных виртуальных машин, созданных другими типами баз.
- Ресурсы PaaS создаются и будут отображаться в отслеживании расходов. Однако автоматическое завершение работы виртуальной машины не применяется к ресурсам PaaS.
- У пользователей есть такое же средство управления политиками виртуальных машин для сред, как и для виртуальных машин отдельной лаборатории.

Узнайте обо всех [преимуществах использования шаблонов Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview#the-benefits-of-using-resource-manager) для развертывания, обновления или удаления всех лабораторных ресурсов за одну операцию.

> [!NOTE]
> Если вы используете шаблон Resource Manager в качестве основы для создания дополнительных лабораторных виртуальных машин, то следует помнить, что существуют некоторые различия при создании нескольких виртуальных машин и одной виртуальной машины. При использовании шаблона Azure Resource Manager для виртуальной машины эти различия описываются более подробно.
>
>

## <a name="configure-azure-resource-manager-template-repositories"></a>Настройка репозиториев шаблонов Azure Resource Manager

При использования подходов "инфраструктура как код" и "конфигурация как код" управлять шаблонами среды рекомендуется в системе управления версиями. Служба Azure DevTest Labs следует этой рекомендации и загружает все шаблоны Azure Resource Manager непосредственно из репозиториев GitHub или VSTS Git. В результате шаблоны Resource Manager можно использовать в ходе всего цикла выпуска — от тестовой до рабочей среды.

Существует несколько правил, которым необходимо следовать при упорядочивании шаблонов Azure Resource Manager в репозитории:

- Имя файла основного шаблона должно быть `azuredeploy.json`. 

    ![Основные файлы шаблонов Azure Resource Manager](./media/devtest-lab-create-environment-from-arm/master-template.png)

- Чтобы использовать значения параметров, определенные в файле параметров, имя этого файла должно быть `azuredeploy.parameters.json`.
- Для создания значения URI parametersLink можно использовать параметры `_artifactsLocation` и `_artifactsLocationSasToken`, чтобы служба DevTest Labs автоматически управляла вложенными шаблонами. Дополнительные сведения см. в статье [Как служба Azure DevTest Labs упрощает развертывание вложенных шаблонов Resource Manager в тестовых средах](https://blogs.msdn.microsoft.com/devtestlab/2017/05/23/how-azure-devtest-labs-makes-nested-arm-template-deployments-easier-for-testing-environments/).
- Можно определить метаданные, чтобы указать отображаемое имя и описание шаблона. Эти метаданные должны находиться в файле с именем `metadata.json`. В следующем примере файла метаданных показано, как указать отображаемое имя и описание: 

```json
{
 
"itemDisplayName": "<your template name>",
 
"description": "<description of the template>"
 
}
```

Ниже описаны шаги, которые помогут вам добавить в лабораторию репозиторий, используя портал Azure. 

1. Войдите на [портал Azure](http://go.microsoft.com/fwlink/p/?LinkID=525040).
1. Щелкните **Больше служб**, а затем выберите в списке **DevTest Labs**.
1. Из списка лабораторий выберите нужную лабораторию.   
1. В колонке лаборатории выберите **Configuration and Policies** (Конфигурация и политики).

    ![Configuration and Policies (Конфигурация и политики)](./media/devtest-lab-create-environment-from-arm/configuration-and-policies-menu.png)

1. В списке параметров **Configuration and Policies** (Конфигурация и политики) выберите пункт **Репозитории**. В колонке **Репозитории** перечислены репозитории, которые были добавлены в лабораторию. Репозиторий с именем `Public Repo` автоматически создается для всех лабораторий и подключается к [репозиторию DevTest Labs на сайте GitHub](https://github.com/Azure/azure-devtestlab), который содержит несколько артефактов виртуальной машины.

    ![Общедоступный репозиторий](./media/devtest-lab-create-environment-from-arm/public-repo.png)

1. Щелкните **+Добавить**, чтобы добавить репозиторий шаблонов Azure Resource Manager.
1. Когда откроется вторая колонка **Репозитории**, введите необходимые сведения, как описано ниже.
    - **Имя**: введите имя репозитория, которое используется в лаборатории.
    - **URL-адрес клона Git**: введите URL-адрес клона HTTPS Git из GitHub или Visual Studio Team Services.  
    - **Ветвь**: введите имя ветви для доступа к определениям шаблонов Azure Resource Manager. 
    - **Личный маркер доступа**: используется для безопасного доступа к репозиторию. Для получения маркера в Visual Studio Team Services выберите **&lt;Ваше_имя> > Мой профиль > Безопасность > Public access token** (Общедоступный маркер доступа). Для получения маркера в GitHub выберите свой аватар, а затем щелкните **Параметры > Public access token** (Общедоступный маркер доступа). 
    - **Folder paths** (Пути к папке): с помощью одного из двух полей ввода введите путь к папке, который начинается с косой черты (/) и относится к URI клона Git, ведущему к определениях артефактов (первое поле ввода) или определениям шаблонов Azure Resource Manager.   
    
        ![Общедоступный репозиторий](./media/devtest-lab-create-environment-from-arm/repo-values.png)

1. Когда все обязательные поля заполнены и данные проверены, нажмите кнопку **Сохранить**.

В следующем разделе описывается процесс создания сред на основе шаблона Azure Resource Manager.

## <a name="create-an-environment-from-an-azure-resource-manager-template"></a>Создание среды на основе шаблона Azure Resource Manager

После настройки в лаборатории репозитория шаблонов Azure Resource Manager пользователи лаборатории могут создать среду, выполнив следующие действия на портале Azure:

1. Войдите на [портал Azure](http://go.microsoft.com/fwlink/p/?LinkID=525040).
1. Щелкните **Больше служб**, а затем выберите в списке **DevTest Labs**.
1. Из списка лабораторий выберите нужную лабораторию.   
1. В колонке лаборатории щелкните **+Добавить**.
1. В колонке **Выбор основы** отображаются базовые образы, которые можно использовать с шаблонами Azure Resource Manager вначале списка. Выберите нужный шаблон Azure Resource Manager.

    ![Выбор основы](./media/devtest-lab-create-environment-from-arm/choose-a-base.png)
  
1. В колонке **Добавить** введите значение **имени среды**. Имя среды будет отображаться для пользователей вашей лаборатории. Остальные поля ввода определяются в шаблоне Azure Resource Manager. Если в шаблоне определены значения по умолчанию или есть файл `azuredeploy.parameter.json`, то значения по умолчанию отобразятся в этих полях ввода. Для параметров типа *защищенной строки* можно использовать секреты, хранящиеся в [личном хранилище секретов](https://azure.microsoft.com/en-us/updates/azure-devtest-labs-keep-your-secrets-safe-and-easy-to-use-with-the-new-personal-secret-store) лаборатории.

    ![Колонка "Добавить"](./media/devtest-lab-create-environment-from-arm/add.png)

    > [!NOTE]
    > Существует несколько значений параметров, которые, даже если они указаны, отображаются как пустые значения. Поэтому, если пользователи присваивают эти значения параметрам в шаблоне Azure Resource Manager, то они не отображаются в DevTest Labs. Вместо значений отображаются пустые поля ввода, в которые пользователям лаборатории требуется ввести значения при создании среды.
    > 
    > - GEN-UNIQUE
    > - GEN-UNIQUE-[N]
    > - GEN-SSH-PUB-KEY
    > - GEN-PASSWORD 
 
1. Нажмите кнопку **Добавить**, чтобы создать среду. Сразу начнется процесс подготовки среды. В списке **My virtual machines** (Мои виртуальные машины) будет отображаться состояние процесса. Лаборатория автоматически создает группу ресурсов, чтобы подготовить все ресурсы, определенные в шаблоне Azure Resource Manager.
1. После того как среда будет создана, выберите ее в списке **Мои виртуальные машины**, чтобы открыть колонку группы ресурсов и просмотреть все ресурсы, подготовленные в этой среде.
    
    ![Список "My virtual machines" (Мои виртуальные машины)](./media/devtest-lab-create-environment-from-arm/all-environment-resources.png)
   
   Вы также можете развернуть среду, чтобы просто просмотреть список виртуальных машин, которые подготовлены к работе в этой среде.
    
    ![Список "My virtual machines" (Мои виртуальные машины)](./media/devtest-lab-create-environment-from-arm/my-vm-list.png)

1. Щелкните любую из сред, чтобы просмотреть доступные действия, такие как применение артефактов, присоединение дисков данных, изменение времени автоматического завершения работы и другие.

    ![Действия среды](./media/devtest-lab-create-environment-from-arm/environment-actions.png)

## <a name="next-steps"></a>Дальнейшие действия
* После создания виртуальной машины к ней можно подключиться, щелкнув **Подключиться** в колонке виртуальной машины.
* Для просмотра и администрирования ресурсов в среде выберите среду в списке **Мои виртуальные машины** в вашей лаборатории. 
* Ознакомьтесь с [шаблонами Azure Resource Manager из коллекции шаблонов быстрого запуска Azure](https://github.com/Azure/azure-quickstart-templates).

---
title: "Поддержка мультитенантности для репликации виртуальных машин VMware в Azure (программа CSP) | Документация Майкрософт"
description: "Сведения о развертывании службы Azure Site Recovery в среде с несколькими клиентами для управления репликацией, отработкой отказа и восстановлением локальных виртуальных машин VMware в Azure с помощью программы CSP на портале Azure."
services: site-recovery
documentationcenter: 
author: mayanknayar
manager: rochakm
editor: 
ms.assetid: 
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/14/2017
ms.author: manayar
ms.openlocfilehash: 273efe0bdef421d753ea51e01060d48351cbe6fc
ms.sourcegitcommit: 3fca41d1c978d4b9165666bb2a9a1fe2a13aabb6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/15/2017
---
# <a name="multi-tenant-support-in-azure-site-recovery-for-replicating-vmware-virtual-machines-to-azure-through-csp"></a>Поддержка нескольких клиентов в Azure Site Recovery для репликации виртуальных машин VMware в Azure с помощью CSP

В службе Azure Site Recovery реализована поддержка сред с несколькими клиентами (мультитенантность) для подписок клиентов. Такие среды также поддерживаются для подписок клиентов, созданных и управляемых с помощью программы поставщика облачных решений Майкрософт (CSP). В этой статье приведены рекомендации по реализации сценариев репликации виртуальных машин VMware в Azure с поддержкой нескольких сред и управлению ими. Дополнительные сведения о создании и управлении подписками клиента см. [управление многопользовательский режим с CSP](site-recovery-manage-multi-tenancy-with-csp.md) .

В этом руководстве широко используются сведения из других материалов по репликации виртуальных машин VMware в Azure. Дополнительные сведения см. в статье [Репликация виртуальных машин VMware в Azure с помощью Site Recovery](site-recovery-vmware-to-azure.md).

## <a name="multi-tenant-environments"></a>Среды с несколькими клиентами
Доступны три основные мультитенантные модели.

* **Размещение служб поставщика (HSP) совместно**: из сторон выступала физической инфраструктуры, и использует общие ресурсы (vCenter, центры обработки данных, физическое хранилище и так далее) для размещения виртуальных машин нескольких клиентов в одной инфраструктуре. Для управления аварийным восстановлением можно использовать управляемую службу, предоставленную партнером, или принадлежащее клиенту решение с самообслуживанием.

* **Выделенный поставщик услуг размещения служб**: участник владеет физической инфраструктуры, но использует выделенные ресурсы (несколько v-Center, физического хранилища данных и т. д.) для размещения виртуальных машин каждого клиента в отдельную инфраструктуру. Для управления аварийным восстановлением можно использовать управляемую службу, предоставленную партнером, или принадлежащее клиенту решение с самообслуживанием.

* **Поставщик управляемых служб.** В этом случае физическая инфраструктура, в которой размещены виртуальные машины, принадлежит заказчику, а партнеры предоставляют поддержку аварийного восстановления и средства управления им.

## <a name="shared-hosting-multi-tenant-guidance"></a>Руководство по совместному размещению нескольких клиентов
В этом разделе подробно рассматривается сценарий совместного размещения. Кроме того, здесь описываются еще два сценария, которые являются разновидностями сценария совместного размещения и используют те же принципы. Разница между ними описана в конце этого раздела.

Основное требование в сценариях с несколькими клиентами заключается в изоляции разных клиентов. На одном клиенте нельзя просматривать ресурсы, размещенные на другом. В управляемой партнером среде это не так важно. Однако в среде с самостоятельным обслуживанием это может играть решающую роль. В рамках этого руководства изоляция клиента обязательна.

Такая архитектура показана на схеме ниже.

![Поставщик общих услуг размещения с одним сервером vCenter](./media/site-recovery-multi-tenant-support-vmware-using-csp/shared-hosting-scenario.png)  
**Сценарий совместного размещения с одним сервером vCenter**

Как показано на предыдущей схеме, каждый клиент будет иметь отдельный сервер управления. Такая конфигурация ограничивает доступ клиента к виртуальным машинам определенного клиента и позволяет изолировать клиент. В сценарии репликации виртуальных машин VMware используется сервер конфигурации. Он обеспечивает управление учетными записями для обнаружения виртуальных машин и установки агентов. Те же принципы применяются к средам несколькими клиентами, с добавлением ограничения обнаружения виртуальной Машины через vCenter контроль доступа.

Требования к изоляции данных требуются, что все инфраструктуры конфиденциальных сведений (например, учетные данные для доступа) остается скрытым для клиентов. По этой причине мы советуем, чтобы все компоненты сервера управления находились полностью под управлением партнера. Ниже приведены компоненты сервера управления.
* Сервер конфигурации
* Сервер обработки
* Главный целевой сервер

Сервер обработки масштабирования также должен управляться партнером.

### <a name="every-cs-in-the-multi-tenant-scenario-uses-two-accounts"></a>Каждый сервер конфигурации в рамках этого сценария использует две учетные записи:

- **Учетная запись для доступа к vCenter.** Эта учетная запись используется для обнаружения виртуальных машин клиента. Ей назначены права доступа к vCenter (см. следующий раздел). Мы советуем, чтобы партнер самостоятельно вводил эти учетные данные в средстве настройки во избежание случайных утечек данных при доступе.

- **Учетная запись для доступа к виртуальной машине.** Эта учетная запись используется для принудительной установки агента мобильности на виртуальных машинах клиента. Обычно является учетной записью домена, который клиент предоставляет к партнеру или, участник может управлять напрямую. Если клиент не хочет поделиться сведениями с партнером напрямую, они могут разрешено введите учетные данные через доступ ограничено по времени в CS или с помощью партнера установите агенты mobility вручную.

### <a name="requirements-for-a-vcenter-access-account"></a>Требования к учетной записи для доступа к vCenter

Как описано в предыдущем разделе, для настройки сервера конфигурации используется учетная запись, которой назначена определенная роль. Эту роль следует назначить учетной записи, используемой для доступа к vCenter, для каждого объекта vCenter. Она не должна распространяться на дочерние объекты. Такая конфигурация обеспечивает изоляцию клиента, так как при синхронизации доступа можно получить доступ к другим объектам.

![Параметр распространения на дочерние объекты](./media/site-recovery-multi-tenant-support-vmware-using-csp/assign-permissions-without-propagation.png)

Кроме того, вы можете назначить учетную запись и роль в объекте центра обработки данных и распространить ее на дочерние объекты. Затем назначьте этой учетной записи роль *Без доступа* для каждого объекта (например, для виртуальных машин других клиентов), к которому должен быть ограничен доступ от определенного клиента. Такая конфигурация весьма сложная. Она не обеспечивает полный контроль доступа, так как каждый дочерний объект автоматически наследует права доступа родительского объекта. Поэтому рекомендуется использовать первый подход.

Процедура предоставления доступа к учетной записи vCenter состоит из следующих этапов:

1. Создайте роль путем клонирования предварительно определенной роли с доступом *Только для чтения* и назначьте ей удобное имя (Azure_Site_Recovery в этом примере).

2. Назначьте этой роли следующие разрешения:

    * **Хранилище данных**: выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины.

    * **Сеть**: назначение сети.

    * **Ресурс**: назначение виртуальной машины в пул ресурсов, миграция отключенной виртуальной машины, миграция включенной виртуальной машины.

    * **Задачи**: создание задач, обновление задач.

    * **Виртуальная машина**:
        * настройка > все;
        * взаимодействие > ответ на вопрос, подключение устройства, настройка компакт-диска носителя, настройка дискеты носителя, отключение, включение, установка средств VMware;
        * инвентаризация > создание на основе существующего, создание, регистрация, отмена регистрации;
        * подготовка > разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины;
        * управление моментальными снимками > удаление моментальных снимков.

    ![Диалоговое окно "Изменение ролей"](./media/site-recovery-multi-tenant-support-vmware-using-csp/edit-role-permissions.png)

3. Назначьте уровень доступа к учетной записи vCenter (используемой на сервере конфигурации клиента) для различных объектов, как описано в таблице ниже.

>| Объект. | Роль | Примечания |
>| --- | --- | --- |
>| vCenter | Только для чтения | Эта роль используется, только чтобы предоставить vCenter доступ для управления разными объектами. Если эту учетную запись не планируют предоставлять клиенту или использовать для любых операций управления на сервере vCenter, это разрешение можно удалить. |
>| Центр обработки данных | Azure_Site_Recovery |  |
>| Узел и кластер узлов | Azure_Site_Recovery | Предоставляет доступ на уровне объектов, чтобы перед отработкой отказа и после восстановления размещения виртуальные машины клиента имели доступ только к этим узлам. |
>| Хранилище данных и кластер хранилища данных | Azure_Site_Recovery | То же, что и выше. |
>| Сеть | Azure_Site_Recovery |  |
>| Сервер управления | Azure_Site_Recovery | Включает доступ для всех компонентов (CS, PS и MT) за пределами машины CS. |
>| Виртуальные машины клиента | Azure_Site_Recovery | Предоставляет эти разрешения на доступ всем новым виртуальным машинам определенного клиента. В противном случае их нельзя будет обнаружить с помощью портала Azure. |

Теперь настройка доступа для учетной записи vCenter завершена. Это минимальное требование для выполнения операций восстановления размещения. Эти разрешения на доступ также можно использовать с имеющимися политиками. Просто измените свои разрешения, добавив к ним разрешения роли из шага 2, описанного выше.

Чтобы ограничить операции аварийного восстановления до выполнения отработки отказа (т. е отключить возможности восстановления размещения), выполните описанные выше действия, но вместо роли *Azure_Site_Recovery* назначьте учетной записи, используемой для доступа к vCenter, роль *Только для чтения*. Этот набор разрешений позволяет выполнить репликацию и отработку отказа виртуальных машин, но не допускает восстановление размещения. Все остальное в описанном ранее процессе остается без изменений. Чтобы изолировать клиент и ограничить обнаружение виртуальных машин, каждое разрешение должно по-прежнему быть назначено только на уровне объектов и не распространяться на дочерние объекты.

## <a name="other-multi-tenant-environments"></a>Другие среды с несколькими клиентами

В разделе выше подробно описан процесс настройки среды с несколькими клиентами для решения совместного размещения. Два оставшихся решения — это решения для выделенного размещения и управляемой службы. В следующих разделах описывается архитектура этих решений.

### <a name="dedicated-hosting-solution"></a>Решение для выделенного размещения

Как показано на следующей схеме, разница в архитектуре решения для выделенного размещения заключается в том, что инфраструктура клиента подготавливается только для этого клиента. Поставщик услуг размещения по-прежнему должен выполнить действия, приведенные для совместного размещения с помощью программы CSP, но он не должен беспокоиться об изоляции клиентов, так как они изолированы благодаря отдельным серверам vCenter. Настройка программы CSP остается без изменений.

![architecture-shared-hsp](./media/site-recovery-multi-tenant-support-vmware-using-csp/dedicated-hosting-scenario.png)  
**Сценарий выделенного размещения с несколькими серверами vCenter**

### <a name="managed-service-solution"></a>Решение для управляемой службы

Как показано на следующей схеме, разница в архитектуре решения для управляемой службы заключается в том, что инфраструктура каждого клиента также физически отделена от других клиентов. Этот сценарий обычно возникает, когда клиент владеет инфраструктурой и ему нужен поставщик решений только для управления аварийным восстановлением. Так как клиенты физически изолированы благодаря разным инфраструктурам, партнер по-прежнему должен выполнить действия, приведенные для совместного размещения с помощью программы CSP, но он не должен беспокоиться об изоляции клиентов. Подготовка программы CSP остается без изменений.

![architecture-shared-hsp](./media/site-recovery-multi-tenant-support-vmware-using-csp/managed-service-scenario.png)  
**Сценарий для управляемой службы с несколькими серверами vCenter**

## <a name="next-steps"></a>Дальнейшие действия
[Дополнительные](site-recovery-role-based-linked-access-control.md) об управлении доступом на основе ролей для управления развертываниями Azure Site Recovery.

[Управление Многопользовательские приложения с помощью поставщика служб Шифрования](site-recovery-manage-multi-tenancy-with-csp.md)

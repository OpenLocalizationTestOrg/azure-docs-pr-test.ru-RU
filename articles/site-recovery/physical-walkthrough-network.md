---
title: "Планирование сетей для репликации физического сервера в Azure | Документация Майкрософт"
description: "В этой статье рассматривается планирование сетей, необходимое при репликации физических серверов в Azure."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 71db2435-b5ce-4263-83f6-093d10d1d4e1
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 06/27/2017
ms.author: raynew
ms.openlocfilehash: f8a20b45b50f71631122e574b634818c1912f12e
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="step-4-plan-networking-for-physical-server-replication-to-azure"></a><span data-ttu-id="f3076-103">Шаг 4. Планирование сетей для репликации физического сервера в Azure</span><span class="sxs-lookup"><span data-stu-id="f3076-103">Step 4: Plan networking for physical server replication to Azure</span></span>

<span data-ttu-id="f3076-104">В этой статье собраны рекомендации по планированию сетей при репликации локальных физических серверов в Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).</span><span class="sxs-lookup"><span data-stu-id="f3076-104">This article summarizes network planning considerations when replicating on-premises physical servers to Azure using the [Azure Site Recovery](site-recovery-overview.md) service.</span></span>

<span data-ttu-id="f3076-105">Все комментарии можно добавить в конце этой статьи. Вопросы можно задать на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span><span class="sxs-lookup"><span data-stu-id="f3076-105">Post any comments at the bottom of this article, or ask questions in the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>


## <a name="connect-to-replica-azure-vms"></a><span data-ttu-id="f3076-106">Подключение виртуальных машин реплик Azure</span><span class="sxs-lookup"><span data-stu-id="f3076-106">Connect to replica Azure VMs</span></span>

<span data-ttu-id="f3076-107">При планировании стратегии репликации и отработки отказа одним из ключевых вопросов является способ подключения к виртуальной машине Azure после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="f3076-107">When planning your replication and failover strategy, one of the key questions is how to connect to the Azure VM after failover.</span></span> <span data-ttu-id="f3076-108">При разработке сетевой стратегии для виртуальных машин реплик Azure существует несколько вариантов:</span><span class="sxs-lookup"><span data-stu-id="f3076-108">There are a couple of choices when designing your network strategy for replica Azure VMs:</span></span>

- <span data-ttu-id="f3076-109">**Использование другого IP-адреса.** Для сети реплицируемых виртуальных машин Azure можно выбрать другой диапазон IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="f3076-109">**Use a different IP address**: You can select to use a different IP address range for the replicated Azure VM network.</span></span> <span data-ttu-id="f3076-110">В этом сценарии после отработки отказа виртуальная машина получает новый IP-адрес, а также требуется обновление DNS.</span><span class="sxs-lookup"><span data-stu-id="f3076-110">In this scenario, the machine gets a new IP address after failover, and a DNS update is required.</span></span>
- <span data-ttu-id="f3076-111">**Использование того же IP-адреса.** После отработки отказа для сети Azure можно оставить тот же диапазон IP-адресов, который использовался на основном локальном сайте.</span><span class="sxs-lookup"><span data-stu-id="f3076-111">**Use the same IP address**: You might want to use the same IP address range as that in your primary on-premises site, for the Azure network after failover.</span></span> <span data-ttu-id="f3076-112">Использование тех же IP-адресов упрощает процесс восстановления, уменьшая количество проблем с сетью после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="f3076-112">Keeping the same IP addresses simplifies the recovery by reducing network related issues after failover.</span></span> <span data-ttu-id="f3076-113">Тем не менее, при выполнении репликации в Azure потребуется обновить маршруты, чтобы указать новое расположение IP-адресов после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="f3076-113">However, when you're replicating to Azure, you will need to update routes with the new location of the IP addresses after failover.</span></span>

## <a name="retain-ip-addresses"></a><span data-ttu-id="f3076-114">Использование тех же IP-адресов</span><span class="sxs-lookup"><span data-stu-id="f3076-114">Retain IP addresses</span></span>

<span data-ttu-id="f3076-115">При отработке отказа в Azure служба Site Recovery предоставляет возможность сохранить фиксированные IP-адреса, используя отработку отказа в подсети.</span><span class="sxs-lookup"><span data-stu-id="f3076-115">Site Recovery provides the capability to retain fixed IP addresses when failing over to Azure, with a subnet failover.</span></span>
<span data-ttu-id="f3076-116">При отработке отказа в подсети отдельно взятая подсеть присутствует на сайте 1 или 2, но никогда на обоих сайтах одновременно.</span><span class="sxs-lookup"><span data-stu-id="f3076-116">With subnet failover, a specific subnet is present at Site 1 or Site 2, but never at both sites simultaneously.</span></span> <span data-ttu-id="f3076-117">Чтобы сохранить пространство IP-адресов в случае отработки отказа, программными средствами можно сделать так, чтобы инфраструктура маршрутизаторов перемещала подсети с одного сайта на другой.</span><span class="sxs-lookup"><span data-stu-id="f3076-117">In order to maintain the IP address space in the event of a failover, you programmatically arrange for the router infrastructure to move the subnets from one site to another.</span></span> <span data-ttu-id="f3076-118">При отработке отказа подсети перемещаются вместе со связанными с ними защищенными виртуальными машинами.</span><span class="sxs-lookup"><span data-stu-id="f3076-118">During failover, the subnets move with the associated protected VMs.</span></span> <span data-ttu-id="f3076-119">Основным недостатком является то, что в случае сбоя необходимо переместить всю подсеть.</span><span class="sxs-lookup"><span data-stu-id="f3076-119">The main drawback is that in the event of a failure, you have to move the whole subnet.</span></span>

### <a name="failover-example"></a><span data-ttu-id="f3076-120">Пример отработки отказа</span><span class="sxs-lookup"><span data-stu-id="f3076-120">Failover example</span></span>

<span data-ttu-id="f3076-121">Рассмотрим пример отработки отказа в Azure.</span><span class="sxs-lookup"><span data-stu-id="f3076-121">Let's look at an example for failover to Azure.</span></span>

- <span data-ttu-id="f3076-122">Вымышленная компания, банк Woodgrove, имеет локальную инфраструктуру, в которой размещены ее бизнес-приложения.</span><span class="sxs-lookup"><span data-stu-id="f3076-122">A ficticious company, Woodgrove Bank, has an on-premises infrastructure hosting their business apps.</span></span> <span data-ttu-id="f3076-123">Ее мобильные приложения размещены в Azure.</span><span class="sxs-lookup"><span data-stu-id="f3076-123">Their mobile applications are hosted on Azure.</span></span>
- <span data-ttu-id="f3076-124">Подключение между виртуальными машинами банка Woodgrove в Azure и локальными серверами обеспечивается через VPN-подключение типа "сеть — сеть" между локальной сетью периметра и виртуальной сетью Azure.</span><span class="sxs-lookup"><span data-stu-id="f3076-124">Connectivity between Woodgrove Bank VMs in Azure and on-premises servers is provided by a site-to-site (VPN) connection between the on-premises edge network and the Azure virtual network.</span></span>
- <span data-ttu-id="f3076-125">VPN означает, что виртуальная сеть компании в Azure является расширением ее локальной сети.</span><span class="sxs-lookup"><span data-stu-id="f3076-125">This VPN means that the company's virtual network in Azure appears as an extension of their on-premises network.</span></span>
- <span data-ttu-id="f3076-126">Банк Woodgrove хочет использовать Site Recovery для репликации локальных рабочих нагрузок в Azure.</span><span class="sxs-lookup"><span data-stu-id="f3076-126">Woodgrove wants to use Site Recovery to replicate on-premises workloads to Azure.</span></span>
 - <span data-ttu-id="f3076-127">В банке Woodgrove используются приложения и конфигурации, зависящие от жестко заданных IP-адресов, поэтому необходимо сохранить IP-адреса для приложений после отработки отказа в Azure.</span><span class="sxs-lookup"><span data-stu-id="f3076-127">Woodgrove has to deal with applications and configurations which depend on hard-coded IP addresses, and thus need to retain IP addresses for their applications after failover to Azure.</span></span>
 - <span data-ttu-id="f3076-128">Банк Woodgrove назначил своим ресурсам в Azure IP-адреса из диапазона 172.16.1.0/24, 172.16.2.0/24.</span><span class="sxs-lookup"><span data-stu-id="f3076-128">Woodgrove has assigned IP addresses from range 172.16.1.0/24, 172.16.2.0/24 to its resources running in Azure.</span></span>


<span data-ttu-id="f3076-129">Чтобы компания Woodgrove могла реплицировать свои серверы в Azure, сохранив IP-адреса, она должна выполнить следующие действия:</span><span class="sxs-lookup"><span data-stu-id="f3076-129">For Woodgrove to be able to replicate its servers to Azure while retaining the IP addresses, here's what the company needs to do:</span></span>

1. <span data-ttu-id="f3076-130">Создайте виртуальную сеть Azure.</span><span class="sxs-lookup"><span data-stu-id="f3076-130">Create an Azure virtual network.</span></span> <span data-ttu-id="f3076-131">Она должна быть расширением локальной сети, чтобы приложения могли с легкостью выполнить отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="f3076-131">It should be an extension of the on-premises network, so that applications can fail over seamlessly.</span></span>
2. <span data-ttu-id="f3076-132">Azure позволяет добавлять в виртуальные сети, созданные в Azure, VPN-подключения типа "сеть — сеть" в дополнение к подключениям типа "точка — сеть".</span><span class="sxs-lookup"><span data-stu-id="f3076-132">Azure allows you to add site-to-site VPN connectivity, in addition to point-to-site connectivity to the virtual networks created in Azure.</span></span>
3. <span data-ttu-id="f3076-133">При настройке подключения типа "сеть — сеть" в сети Azure можно направить трафик в локальное расположение (локальную сеть) только в том случае, если диапазон IP-адресов отличается от диапазона IP-адресов локальной сети.</span><span class="sxs-lookup"><span data-stu-id="f3076-133">When setting up the site-to-site connection, in the Azure network, you can route traffic to the on-premises location (local-network) only if the IP address range is different from the on-premises IP address range.</span></span>
    - <span data-ttu-id="f3076-134">Это связано с тем, что Azure не поддерживает растянутые подсети.</span><span class="sxs-lookup"><span data-stu-id="f3076-134">This is because Azure doesn’t support stretched subnets.</span></span> <span data-ttu-id="f3076-135">Поэтому при наличии локальной подсети 192.168.1.0/24 невозможно добавить локальную сеть 192.168.1.0/24 в сеть Azure.</span><span class="sxs-lookup"><span data-stu-id="f3076-135">So if you have subnet 192.168.1.0/24 on-premises, you can’t add a local-network 192.168.1.0/24 in the Azure network.</span></span>
    - <span data-ttu-id="f3076-136">Это происходит, так как Azure не знает, что в подсети нет активных виртуальных машин и что подсеть создается только в целях аварийного восстановления данных.</span><span class="sxs-lookup"><span data-stu-id="f3076-136">This is expected because Azure doesn’t know that there are no active machines in the subnet, and that the subnet is being created for disaster recovery only.</span></span>
    - <span data-ttu-id="f3076-137">Чтобы иметь возможность правильно направлять сетевой трафик из сети Azure, подсети в локальной сети и сети не должны конфликтовать.</span><span class="sxs-lookup"><span data-stu-id="f3076-137">To be able to correctly route network traffic out of an Azure network the subnets in the network and the local-network mustn't conflict.</span></span>

![Перед выполнением отработки отказа подсети](./media/physical-walkthrough-network/network-design7.png)

#### <a name="before-failover"></a><span data-ttu-id="f3076-139">Перед выполнением отработки отказа</span><span class="sxs-lookup"><span data-stu-id="f3076-139">Before failover</span></span>

1. <span data-ttu-id="f3076-140">Создайте дополнительную сеть (например, сеть восстановления).</span><span class="sxs-lookup"><span data-stu-id="f3076-140">Create an additional network (for example Recovery Network).</span></span> <span data-ttu-id="f3076-141">Это сеть, в которой создаются виртуальные машины, выполнившие отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="f3076-141">This is the network in which failed over VMs are created.</span></span>
2. <span data-ttu-id="f3076-142">Чтобы убедиться, что IP-адрес для виртуальной машины сохраняется после отработки отказа, откройте вкладку **Настройка** в разделе свойств виртуальной машины, укажите тот же IP-адрес, который использовался на виртуальной машине в локальной сети, и нажмите кнопку **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="f3076-142">To ensure that the IP address for a machine is retained after a failover, in the machine properties > **Configure**, specify the same IP address that the server has on-premises, and click **Save**.</span></span>
3. <span data-ttu-id="f3076-143">При отработке отказа виртуальной машины служба Azure Site Recovery назначит ей указанный IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="f3076-143">When the machine is failed over, Azure Site Recovery will assign the provided IP address to it.</span></span>
4. <span data-ttu-id="f3076-144">После запуска отработки отказа и создания в Azure виртуальных машин с необходимыми IP-адресами для подключения к сети можно использовать [подключение типа "виртуальная сеть — виртуальная сеть"](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md).</span><span class="sxs-lookup"><span data-stu-id="f3076-144">After failover is trigger is triggered, and the VMs are created in Azure with the required IP address, you can connect to the network using a [Vnet to Vnet connection](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md).</span></span> <span data-ttu-id="f3076-145">Это действие можно выполнить с помощью сценария.</span><span class="sxs-lookup"><span data-stu-id="f3076-145">This action can be scripted.</span></span>
5. <span data-ttu-id="f3076-146">Маршруты необходимо соответствующим образом изменить, чтобы отразить тот факт, что подсеть 192.168.1.0/24 теперь перемещена в Azure.</span><span class="sxs-lookup"><span data-stu-id="f3076-146">Routes need to be appropriately modified, to reflect that 192.168.1.0/24 has now moved to Azure.</span></span>

    ![После выполнения отработки отказа подсети](./media/physical-walkthrough-network/network-design9.png)

#### <a name="after-failover"></a><span data-ttu-id="f3076-148">После выполнения отработки отказа</span><span class="sxs-lookup"><span data-stu-id="f3076-148">After failover</span></span>

<span data-ttu-id="f3076-149">Если у вас нет сети Azure, как показано на рисунке выше, то после отработки отказа можно создать VPN-подключение типа "сайт — сайт" между основным сайтом и сетью Azure.</span><span class="sxs-lookup"><span data-stu-id="f3076-149">If you don't have an Azure network as illustrated above, you can create a site-to-site VPN connection between your primary site and Azure, after failover.</span></span>

## <a name="change-ip-addresses"></a><span data-ttu-id="f3076-150">Изменение IP-адресов</span><span class="sxs-lookup"><span data-stu-id="f3076-150">Change IP addresses</span></span>

<span data-ttu-id="f3076-151">В этой [записи блога](http://azure.microsoft.com/blog/2014/09/04/networking-infrastructure-setup-for-microsoft-azure-as-a-disaster-recovery-site/) описывается, как настроить сетевую инфраструктуру Azure, если нет необходимости сохранять IP-адреса после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="f3076-151">This [blog post](http://azure.microsoft.com/blog/2014/09/04/networking-infrastructure-setup-for-microsoft-azure-as-a-disaster-recovery-site/) explains how to set up the Azure networking infrastructure when you don't need to retain IP addresses after failover.</span></span> <span data-ttu-id="f3076-152">Она начинается с описания приложения, затем рассматривается настройка сети в локальной среде и среде Azure, а в конце приводятся сведения о выполнении отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="f3076-152">It starts with an application description, looks at how to set up networking on-premises and in Azure, and concludes with information about running failovers.</span></span>  

## <a name="next-steps"></a><span data-ttu-id="f3076-153">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="f3076-153">Next steps</span></span>

<span data-ttu-id="f3076-154">Перейдите к статье [Шаг 5. Подготовка ресурсов Azure для репликации Hyper-V в Azure](physical-walkthrough-prepare-azure.md).</span><span class="sxs-lookup"><span data-stu-id="f3076-154">Go to [Step 5: Prepare Azure](physical-walkthrough-prepare-azure.md)</span></span>

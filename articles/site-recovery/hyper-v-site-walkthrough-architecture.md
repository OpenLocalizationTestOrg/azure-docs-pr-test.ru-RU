---
title: "Просмотр архитектуры для репликации Hyper-V (без System Center VMM) в Azure с использованием Azure Site Recovery | Документация Майкрософт"
description: "В этой статье представлен обзор компонентов и архитектуры, используемых при репликации виртуальных машин Hyper-V (без VMM) из локальной среды в Azure с помощью службы Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: c413efcd-d750-4b22-b34b-15bcaa03934a
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 06/22/2017
ms.author: raynew
ms.openlocfilehash: d57cbc5b205cfb020070d567097f3bb648ce5300
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="step-1-review-the-architecture-for-hyper-v-replication-to-azure"></a>Шаг 1. Обзор архитектуры для репликации Hyper-V в Azure


В этой статье описываются компоненты и процессы, задействованные при репликации виртуальных машин Hyper-V (которые не управляются System Center VMM) из локальной среды в Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).

Комментарии можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).



## <a name="architectural-components"></a>Компоненты архитектуры

В репликации виртуальных машин Hyper-V в Azure без VMM задействовано несколько компонентов.

**Компонент** | **Расположение** | **Дополнительные сведения**
--- | --- | ---
**Таблицы Azure** | В Azure вам требуется учетная запись Microsoft Azure, учетная запись хранения Azure и сеть Azure. | Реплицированные данные хранятся в учетной записи хранения, а виртуальные машины Azure создаются с использованием реплицированных данных при отработке отказа с локального сайта.<br/><br/> При создании виртуальные машины Azure подключаются к виртуальной сети Azure.
**Hyper-V** | Узлы Hyper-V и кластеры группируются в узлы Hyper-V. Поставщик Azure Site Recovery и агент служб восстановления устанавливаются на каждом узле Hyper-V. | Поставщик оркестрирует репликацию через Интернет с помощью службы Site Recovery. Агент служб восстановления обрабатывает репликацию данных.<br/><br/> Обмен данными между поставщиком и агентом осуществляется по защищенным и зашифрованным каналам. Реплицированные данные в службе хранилища Azure также шифруются.
**Виртуальные машины Hyper-V** | На сервере узла Hyper-V должна быть запущена хотя бы одна виртуальная машина. | На виртуальных машинах не нужно ничего устанавливать явным образом.

Дополнительные сведения о необходимых компонентах развертывания и требованиях к каждому компоненту см. в [таблице поддержки](site-recovery-support-matrix-to-azure.md).

**Рис. 1. Репликация с сайта Hyper-V в Azure**

![Компоненты](./media/hyper-v-site-walkthrough-architecture/arch-onprem-azure-hypervsite.png)


## <a name="replication-process"></a>Процесс репликации

**Рис. 2. Репликация и восстановление в ходе репликации Hyper-V в Azure**

![рабочий процесс](./media/hyper-v-site-walkthrough-architecture/arch-hyperv-azure-workflow.png)

### <a name="enable-protection"></a>Включить защиту

1. После включения защиты для виртуальных машин Hyper-V на портале Azure или локально запустится рабочий процесс **Включение защиты**.
2. Это задание проверяет, соответствует ли компьютер необходимым требованиям перед вызовом метода [CreateReplicationRelationship](https://msdn.microsoft.com/library/hh850036.aspx), который настраивает репликацию, используя определенные вами параметры.
3. Задание запускает начальную репликацию, вызывая метод [StartReplication](https://msdn.microsoft.com/library/hh850303.aspx), чтобы инициализировать полную репликацию виртуальной машины и отправить ее виртуальные диски в Azure.
4. На вкладке **Задания** можно отслеживать ход выполнения задания.
 
### <a name="replicate-the-initial-data"></a>Репликация исходных данных

1. При запуске начальной репликации создается [моментальный снимок виртуальной машины Hyper-V](https://technet.microsoft.com/library/dd560637.aspx).
2. Виртуальные жесткие диски реплицируются по одному, пока все они не будут скопированы в Azure. В зависимости от размера виртуальной машины и пропускной способности сети это может занять некоторое время. Инструкции по оптимизации использования сети см. в статье [Как уменьшить нагрузку на сеть при защите между локальной средой и Azure](https://support.microsoft.com/kb/3056159).
3. В случае возникновения изменений на диске при выполнении начальной репликации модуль отслеживания репликации реплики Hyper-V регистрирует их в журналах репликации Hyper-V (HRL), которые находятся в папке с дисками. С каждым диском связан HRL-файл, который отправляется в дополнительное хранилище.
4. При начальной репликации файлы моментальных снимков и журналов потребляют ресурсы диска.
5. После завершения начальной репликации моментальный снимок виртуальной машины удаляется. Разностные изменения на диске в журнале синхронизируются и объединяются в родительском диске.


### <a name="finalize-protection"></a>Завершение подготовки защиты

1. После завершения начальной репликации задание **Завершить подготовку защиты на виртуальной машине** настраивает сеть и другие параметры для защиты виртуальной машины.
2. При репликации в Azure может потребоваться настроить параметры виртуальной машины для обеспечения готовности к отработке отказа. На этом этапе можно выполнить тестовую отработку отказа, чтобы убедиться, что все работает правильно.

### <a name="replicate-the-delta"></a>Репликация изменений

1. После начальной репликации начинается синхронизация изменений в соответствии с параметрами репликации.
2. Модуль отслеживания репликации реплики Hyper-V отслеживает изменения и передает их виртуальному жесткому диску в качестве HRL-файлов. Для каждого диска, предназначенного для репликации, создается связанный HRL-файл. Эти журналы передаются в пользовательскую учетную запись хранения после завершения начальной репликации. При передаче журнала в Azure изменения на основном диске фиксируются в дополнительном журнале, который размещается в том же каталоге.
3. Во время начальной и разностной репликаций вы можете отслеживать состояние виртуальной машины в ее представлении. [Подробнее](site-recovery-monitoring-and-troubleshooting.md#monitor-replication-health-for-virtual-machines).  

### <a name="synchronize-replication"></a>Синхронизация репликации

1. Если происходит сбой дельта-репликации и для полной репликации необходима высокая пропускная способность или требуется много времени, тогда виртуальная машина помечается для повторной синхронизации. Например, когда HRL-файлы заполняют до 50 % объема диска, виртуальная машина отмечается для повторной синхронизации.
2.  Повторная синхронизация минимизирует объем передаваемых данных. Для этого вычисляются контрольные суммы исходной и целевой виртуальной машины, а затем отправляются только отличающиеся данные. Повторная синхронизация использует алгоритм фрагментации, то есть разбивает исходный и целевой файлы на блоки фиксированного размера. Для каждого фрагмента данных создаются контрольные суммы, сравнение которых позволяет определить, какие из блоков нужно передать от источника к целевому объекту.
3. После завершения повторной синхронизации возобновляется обычная разностная репликация данных. По умолчанию повторная синхронизация автоматически выполняется в нерабочее время. Повторную синхронизацию виртуальной машины можно выполнить вручную. Например, в случае сбоя сети или другого сбоя повторную синхронизацию можно возобновить. Чтобы сделать это, выберите виртуальную машину на портале и щелкните **Повторная синхронизация**.

    ![Повторная синхронизация вручную](./media/hyper-v-site-walkthrough-architecture/image4.png)


### <a name="retry-logic"></a>Логика повторных попыток

При ошибке репликации используется встроенный механизм повторных попыток. Этот алгоритм предполагает работу с двумя представленными ниже категориями ошибок.

**Категория** | **Дополнительные сведения**
--- | ---
**Неустранимые ошибки** | Без повторных попыток. Состояние виртуальной машины отображается как **Критическое**, что требует вмешательства администратора. Это может быть обусловлено неисправной цепочкой виртуальных жестких дисков, недопустимым состоянием реплики виртуальной машины, ошибками аутентификации сети (ошибками авторизации), ошибками "Не найдено" для виртуальной машины (для отдельных серверов Hyper-V).
**Устранимые ошибки** | Повторные попытки выполняются в рамках каждого интервала репликации с использованием экспоненциального алгоритма отсрочки, то есть каждая следующая попытка выполняется с большей задержкой (1, 2, 4, 8 и 10 минут). Если проблема не устранена, повторные попытки выполняются каждые 30 минут. Примеры таких ошибок: сетевые ошибки, дефицит места на диске, нехватка памяти. |



## <a name="failover-and-failback-process"></a>Процесс отработки отказа и восстановления размещения

1. Вы можете запустить плановую или внеплановую [отработку отказа](site-recovery-failover.md) с локальных виртуальных машин Hyper-V в Azure. Чтобы не допустить потери данных при выполнении плановой отработки отказа, выключите исходные виртуальные машины.
2. Вы можете выполнить отработку отказа одного компьютера или создать [планы восстановления](site-recovery-create-recovery-plans.md) для координации отработки отказа нескольких компьютеров.
4. После запуска отработки отказа в Azure должны отобразиться созданные виртуальные машины реплик. При необходимости виртуальной машине можно назначить общедоступный IP-адрес.
5. Затем необходимо зафиксировать отработку отказа для получения доступа к рабочей нагрузке из виртуальной машины реплики Azure.
6. Когда основной локальный сайт снова станет доступным, вы сможете выполнить [восстановление размещения](site-recovery-failback-from-azure-to-hyper-v.md). Запустите плановую отработку отказа из Azure на основной сайт. Для плановой отработки отказа можно выбрать восстановление размещения на ту же самую виртуальную машину или в другое расположение и синхронизировать изменения между Azure и локальным расположением, чтобы предотвратить потерю данных. Если виртуальные машины создаются локально, необходимо зафиксировать отработку отказа.




## <a name="next-steps"></a>Дальнейшие действия

См. [Шаг 2. Обзор необходимых компонентов для развертывания](hyper-v-site-walkthrough-prerequisites.md)

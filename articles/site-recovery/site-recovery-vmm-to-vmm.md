---
title: "Репликация виртуальных машин Hyper-V на дополнительный сайт с помощью Azure Site Recovery | Документация Майкрософт"
description: "Описание репликации виртуальных машин Hyper-V из облаков VMM на дополнительный сайт VMM с помощью портала Azure."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: b33a1922-aed6-4916-9209-0e257620fded
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/14/2017
ms.author: raynew
ms.openlocfilehash: 777bddea6b1cb325a6f8ede00196b18e1746d80c
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="replicate-hyper-v-virtual-machines-in-vmm-clouds-to-a-secondary-vmm-site-using-the-azure-portal"></a>Репликация виртуальных машин Hyper-V из облаков VMM на вторичный сайт VMM | Microsoft Azure
> [!div class="op_single_selector"]
> * [Портал Azure](site-recovery-vmm-to-vmm.md)
> * [Классический портал.](site-recovery-vmm-to-vmm-classic.md)
> * [PowerShell — Resource Manager](site-recovery-vmm-to-vmm-powershell-resource-manager.md)
>
>

В этой статье описывается, как с помощью [Azure Site Recovery](site-recovery-overview.md) на портале Azure выполнить репликацию локальных виртуальных машин Hyper-V, управление которыми осуществляется в облаках System Center Virtual Machine Manager (VMM), на дополнительный сайт. Дополнительные сведения об архитектуре этого сценария см. [здесь](site-recovery-components.md).

Любые комментарии, которые возникнут после прочтения этой статьи, можно добавить в конце этой страницы или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## <a name="prerequisites"></a>Предварительные требования

**Предварительные требования** | **Дополнительные сведения**
--- | ---
**Таблицы Azure** | Вам потребуется учетная запись [Microsoft Azure](http://azure.microsoft.com/) . Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/). [дополнительными сведениями](https://azure.microsoft.com/pricing/details/site-recovery/) о ценах на использование Site Recovery.
**Локальный сервер VMM** | Мы рекомендуем использовать два сервера VMM — один на основном сайте и один на дополнительном.<br/><br/> Вы можете выполнять репликацию между облаками на одном сервере VMM.<br/><br/> На серверах VMM должен выполняться как минимум System Center 2012 с пакетом обновления 1 (SP1) с последними обновлениями.<br/><br/> Серверам VMM нужен доступ к Интернету.
**Облака VMM** | Для каждого сервера VMM должно быть настроено одно или несколько облаков, и для каждого облака должен быть задан профиль емкости Hyper-V. <br/><br/>Облака должны содержать одну или несколько групп узлов VMM.<br/><br/> Если у вас только один сервер VMM, к нему должны быть подключены по меньшей мере два облака, которые будут выполнять роль основного и дополнительного сайтов.
**Hyper-V** | Серверы Hyper-V должны работать под управлением Windows Server 2012 (или более поздних версий), на них должна быть настроена роль Hyper-V и установлены все последние обновления.<br/><br/> Сервер Hyper-V должен содержать одну или несколько виртуальных машин.<br/><br/>  Серверы узлов Hyper-V должны быть размещены в первичном и вторичном облаках VMM.<br/><br/> Если Hyper-V выполняется в кластере на платформе Windows Server 2012 R2, установите [обновление 2961977](https://support.microsoft.com/kb/2961977).<br/><br/> Если Hyper-V выполняется в кластере на платформе Windows Server 2012, учтите, что брокер кластера не создается автоматически при использовании кластера на основе статических IP-адресов. Брокер кластера необходимо настроить вручную. [Подробная информация](http://social.technet.microsoft.com/wiki/contents/articles/18792.configure-replica-broker-role-cluster-to-cluster-replication.aspx).<br/><br/> Серверам Hyper-V необходим доступ к Интернету.
**URL-адреса** | Серверы VMM и узлы Hyper-V должны иметь доступ к следующим URL-адресам:<br/><br/> [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]

## <a name="deployment-steps"></a>Шаги по развертыванию

Сделать нужно следующее.

1. Проверьте предварительные требования.
2. Подготовьте сервер VMM и узлы Hyper-V.
3. Создайте хранилище служб восстановления. которое содержит параметры конфигурации и управляет репликацией.
4. Укажите источник, целевой объект и параметры репликации.
5. Разверните службу мобильности на виртуальных машинах, которые необходимо реплицировать.
6. Подготовьте виртуальные машины Hyper-V к репликации и включите для них репликацию.
7. Запустите тестовую отработку отказа, чтобы убедиться в надлежащей работе всех компонентов.

## <a name="prepare-vmm-servers-and-hyper-v-hosts"></a>Подготовка серверов VMM и узлов Hyper-V

Для подготовки к развертыванию сделайте следующее.

1. Убедитесь, что сервер VMM и узлы Hyper-V соответствуют всем описанным выше предварительным требованиям и могут обращаться к требуемым URL-адресам.
2. Настройте сети VMM, чтобы можно было настроить [сетевое сопоставление](#network-mapping-overview).

    - Виртуальные машины на сервере узла Hyper-V должны быть подключены к сети виртуальных машин VMM. Эта сеть должна быть подключена к логической сети, которая связана с облаком.
    Проверьте, настроена соответствующая сеть виртуальной машины для вторичного облака, которое предназначено для восстановления. Эта сеть виртуальной машины должна быть связана с логической сетью, которая связана с вторичным облаком.

3. Подготовьте [развертывание с одним сервером](#single-vmm-server-deployment), если вы планируете выполнять репликацию виртуальных машин между облаками на одном сервере VMM.

## <a name="create-a-recovery-services-vault"></a>Создание хранилища служб восстановления
1. Войдите на [портал Azure](https://portal.azure.com).
2. Щелкните **Создать** > **Управление** > **Службы восстановления**.
3. В поле **Имя**укажите понятное имя для идентификации хранилища. Если у вас имеется несколько подписок, выберите одну из них.
4. [Создайте новую группу ресурсов](../azure-resource-manager/resource-group-template-deploy-portal.md) или выберите существующую. Укажите регион Azure. В него будут реплицированы виртуальные машины. Сведения о поддерживаемых регионах см. в разделе "Географическая доступность" на странице [Расценки на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).
5. Если вам нужно быстро получить доступ к хранилищу на панели мониторинга, щелкните **Закрепить на панели мониторинга** > **Создать хранилище**.

    ![Новое хранилище](./media/site-recovery-vmm-to-vmm/new-vault-settings.png)

Новое хранилище появится в колонке **Панель мониторинга** > **Все ресурсы** и в основной колонке **Хранилища служб восстановления**.


## <a name="choose-a-protection-goal"></a>Выбор цели защиты

Выберите целевые объекты и место для репликации.

2. Щелкните **Site Recovery** > **Шаг 1. Подготовка инфраструктуры** > **Цель защиты**.
3. Выберите **Для сайта восстановления** и **Yes, with Hyper-V** (Да, с использованием Hyper-V).
4. Выберите **Да**, чтобы указать управление узлами Hyper-V с помощью VMM.
5. Выберите **Да**, если используется дополнительный сервер VMM. Если вы развертываете репликацию между облаками, развернутыми на одном сервере VMM, щелкните **Нет**. Нажмите кнопку **ОК**.

    ![Выбор цели](./media/site-recovery-vmm-to-vmm/choose-goals.png)

## <a name="set-up-the-source-environment"></a>Настройка исходной среды

Установите поставщик Azure Site Recovery на серверах VMM, выполните для серверов обнаружение и регистрацию в хранилище.

1. Щелкните **Шаг 1. Подготовка инфраструктуры** > **Источник**.

    ![Настройка источника](./media/site-recovery-vmm-to-vmm/goals-source.png)
2. В поле **Подготовка источника** щелкните **+ VMM**, чтобы добавить сервер VMM.

    ![Настройка источника](./media/site-recovery-vmm-to-vmm/set-source1.png)
3. В колонке **Добавление сервера** проверьте, появился ли **сервер System Center VMM** в разделе **Тип сервера** и соответствует ли он [предварительным требованиям](#prerequisites).
4. Скачайте файл установки поставщика Azure Site Recovery.
5. Скачайте ключ регистрации. Он потребуется при запуске программы установки. Ключ действителен в течение пяти дней после создания.

    ![Настройка источника](./media/site-recovery-vmm-to-vmm/set-source3.png)
6. Установите поставщик Azure Site Recovery на сервере VMM. Не нужно ничего явно устанавливать на серверах узла Hyper-V.


### <a name="install-the-azure-site-recovery-provider"></a>Установка поставщика Azure Site Recovery

1. Запустите файл установки поставщика на каждом сервере VMM. Если VMM развертывается в кластере, при первой установке выполните следующие действия.
    -  Установите поставщик на активном узле и завершите установку, чтобы зарегистрировать этот сервер VMM в хранилище.
    - Затем установите поставщик на других узлах. Узлы кластера должны использовать одинаковую версию поставщика.
2. Программа установки выполняет несколько проверок соответствия предварительным требованиям и запрашивает разрешение на остановку службы VMM. Служба VMM автоматически перезапустится после завершения установки. Если установка выполняется в кластере VMM, вы увидите запрос на остановку роли Cluster.
3. Если вы подтвердите согласие на странице **Центра обновления Майкрософт**, будут устанавливаться обновления поставщика в соответствии с политикой, настроенной для Центра обновления Майкрософт.
4. На странице **Установка** примите или измените расположение установки по умолчанию и нажмите кнопку **Установить**.

    ![Расположение установки](./media/site-recovery-vmm-to-vmm/provider-location.png)
5. После завершения установки нажмите кнопку **Зарегистрировать**, чтобы зарегистрировать сервер в хранилище.

    ![Расположение установки](./media/site-recovery-vmm-to-vmm/provider-register.png)
6. В поле **Имя хранилища**проверьте имя хранилища, в котором будет зарегистрирован сервер. Нажмите кнопку *Далее*.

    ![Регистрация сервера](./media/site-recovery-vmm-to-vmm-classic/vaultcred.PNG)
7. На странице **Подключение к Интернету** укажите, как поставщик, запущенный на сервере VMM, подключается к Azure.

    ![Параметры Интернета](./media/site-recovery-vmm-to-vmm-classic/proxydetails.PNG)

   - Можно выбрать подключение к Интернету напрямую или через прокси-сервер.
   - При необходимости задайте параметры прокси-сервера.
   - Если вы используете прокси-сервер, на сервере VMM автоматически создается учетная запись запуска от имени (DRAProxyAccount) с учетными данными, указанными для прокси-сервера. Настройте прокси-сервер так, чтобы эта учетная запись могла успешно проходить проверку подлинности. Параметры учетной записи запуска от имени можно изменить в консоли VMM (**Параметры** > **Безопасность** > **Учетные записи запуска от имени**). Перезапустите службу VMM, чтобы изменения вступили в силу.
8. В поле **Регистрационный ключ**введите ключ, который вы скачали из Azure Site Recovery и скопировали на сервер VMM.
9. Параметр шифрования используется только при репликации виртуальных машин Hyper-V в облаках VMM в Azure. При репликации на дополнительный сайт он не используется.
10. В поле **Имя сервера**укажите понятное имя, описывающее сервер VMM в хранилище. В конфигурации кластера укажите имя роли кластера VMM.
11. В поле **Синхронизация метаданных в облаке** укажите, нужно ли синхронизировать с хранилищем метаданные для всех облаков на сервере VMM. На каждом сервере это действие требуется выполнять только один раз. Если не требуется синхронизировать все облака, можно оставить этот флажок снятым и настраивать синхронизацию для каждого облака отдельно в свойствах облака в консоли VMM.
12. Для завершения процесса нажмите кнопку **Далее** . После регистрации метаданные с сервера VMM извлекаются службой Azure Site Recovery. Сервер отображается на вкладке **Серверы VMM** на странице **Серверы** в хранилище.

    ![сервер;](./media/site-recovery-vmm-to-vmm-classic/provider13.PNG)
13. После появления сервера в консоли Site Recovery на странице **Источник** > **Подготовка источника** выберите сервер VMM и облако, в котором расположен узел Hyper-V. Нажмите кнопку **ОК**.

Также поставщик можно установить из командной строки:

[!INCLUDE [site-recovery-rw-provider-command-line](../../includes/site-recovery-rw-provider-command-line.md)]


## <a name="set-up-the-target-environment"></a>Настройка целевой среды

Выберите целевой сервер VMM и облако.

1. Щелкните **Подготовка инфраструктуры** > **Цель** и выберите требуемый целевой сервер VMM.
2. Отобразятся облака на сервере, которые синхронизируются с использованием Site Recovery. Выберите целевое облако.

   ![Цель](./media/site-recovery-vmm-to-vmm/target-vmm.png)

## <a name="set-up-replication-settings"></a>Настройка параметров репликации

- Все узлы, к которым вы применяете новую политику репликации, должны иметь одинаковую операционную систему. Облака VMM могут содержать узлы Hyper-V под управлением разных версий Windows Server, но в этом случае потребуется несколько политик репликации.
- Первоначальную репликацию можно выполнить автономно. [Дополнительные сведения](#prepare-for-initial-offline-replication)

1. Чтобы создать политику репликации, последовательно выберите **Подготовка инфраструктуры** > **Параметры репликации** > **Создать и настроить привязку**.

    ![Сеть](./media/site-recovery-vmm-to-vmm/gs-replication.png)
2. На странице **Создать и связать политику**укажите имя политики. Исходным и целевым типами должен быть **Hyper-V**.
3. В раскрывающемся списке **Версия узла Hyper-V** выберите, какая операционная система выполняется на узле.
4. В раскрывающихся списках **Тип проверки подлинности** и **Порт для проверки подлинности** укажите, как выполняется проверка подлинности для трафика между первичными узлами и узлами восстановления Hyper-V. Выберите **Сертификат** , если только не используете рабочую среду Kerberos. Azure Site Recovery автоматически настроит сертификаты для аутентификации HTTPS. Не нужно ничего делать вручную. По умолчанию порт 8083 и 8084 (для сертификатов) будет открыт в брандмауэре Windows на серверах узлов Hyper-V. В случае выбора **Kerberos**для взаимной аутентификации серверов узлов будет использоваться билет Kerberos. Обратите внимание, что этот параметр используется только при запуске серверов узлов Hyper-V в Windows Server 2012 R2.
5. В раскрывающемся списке **Частота копирования**выберите периодичность репликации изменений данных после начальной репликации (каждые 30 секунд, 5 или 15 минут).
6. В поле **Хранение точки восстановления**укажите продолжительность периода хранения для каждой точки восстановления (в часах). Защищенные компьютеры будут восстанавливаться до любой точки в пределах этого периода.
7. В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, как часто (от 1-12 до часов) нужно создавать точки восстановления, содержащие согласованные на уровне приложений моментальные снимки. Hyper-V использует два типа резервного копирования: стандартное резервное копирование, обеспечивающее создание добавочных резервных копий всей виртуальной машины, и соответствующие приложению моментальные снимки, обеспечивающие создание моментального снимка данных приложений в виртуальной машине на момент времени. Функция моментальных снимков, соответствующих приложению, использует службу теневого копирования томов (VSS), чтобы гарантировать согласованное состояние приложений на момент создания снимка. Использование моментальных снимков, согласованных на уровне приложений, влияет на производительность приложений, выполняющихся на исходных виртуальных машинах. Заданное значение должно быть меньше числа настроенных дополнительных точек восстановления.
8. В поле **Сжатие данных при передаче**укажите, требуется ли сжимать передаваемые реплицированные данные.
9. Если выбрать параметр **Удалить виртуальную машину реплики** то виртуальная машина реплики будет удалена при отключении защиты для исходной виртуальной машины. Если включить этот параметр, то при отключении защиты для исходной виртуальной машины она удаляется из консоли Site Recovery, параметры Site Recovery для VMM удаляются из консоли VMM, также удаляется реплика.
10. Если репликация выполняется по сети, то в параметре **Метод начальной репликации**, укажите, следует ли запустить начальную репликацию сразу или запланировать ее на более позднее время. Чтобы снизить нагрузку на сеть, вы можете запланировать репликацию вне периодов максимальной нагрузки. Нажмите кнопку **ОК**.

     ![Политика репликации](./media/site-recovery-vmm-to-vmm/gs-replication2.png)
11. При создании политики она автоматически сопоставляется с облаком VMM. В поле **Политика репликации** щелкните **ОК**. С этой политикой репликации можно сопоставить дополнительные облака VMM (и виртуальные машины, содержащиеся в них). Для этого выберите **Репликация** > имя политики > **Associate VMM Cloud** (Сопоставить облако VMM).

     ![Политика репликации](./media/site-recovery-vmm-to-vmm/policy-associate.png)


### <a name="configure-network-mapping"></a>Настройка сетевого сопоставления

- Прежде чем начинать работу, изучите сведения о [сетевом сопоставлении](#prepare-for-network-mapping).
- Проверьте, подключены ли виртуальные машины на серверах VMM к сети виртуальной машины.


1. Выберите **Site Recovery Infrastructure** (Инфраструктура Site Recovery) > **Сетевое сопоставление** > **Сетевые сопоставления** и щелкните **+ Сетевое сопоставление**.

    ![Сетевое сопоставление](./media/site-recovery-vmm-to-azure/network-mapping1.png)
2. На вкладке **Добавление сетевого сопоставления** выберите исходный и целевой серверы VMM. Будут получены сети виртуальных машин, связанные с серверами VMM.
3. В разделе **Исходная сеть**из списка сетей виртуальных машин, связанных с сервером-источником VMM, выберите нужную сеть.
4. В разделе **Целевая сеть** выберите сеть, которую вы хотите использовать для сервера-получателя VMM. Нажмите кнопку **ОК**.

    ![Сетевое сопоставление](./media/site-recovery-vmm-to-vmm/network-mapping2.png)

Когда начинается сопоставление сетей, происходит следующее:

* Все существующие виртуальные машины реплик, соответствующие исходной сети виртуальной машины, будут подключены к целевой сети виртуальной машины.
* Новые виртуальные машины, подключенные к исходной сети виртуальной машины, будут подключены к целевой сопоставленной сети после репликации.
* Если изменить существующее сопоставление, указав новую сеть, реплики виртуальных машин будут подключаться с новыми параметрами.
* Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то реплика виртуальной машины будет подключена к этой целевой подсети после отработки отказа. Если нет подсетей с таким же именем, виртуальная машина будет подключена к первой подсети в сети.

### <a name="configure-storage-mapping"></a>Настройте сопоставление хранилищ.

[Сопоставление хранилищ](#prepare-for-storage-mapping) не поддерживается на новом портале Azure. Но вы можете включить его с помощью PowerShell. [Подробнее](site-recovery-vmm-to-vmm-powershell-resource-manager.md#step-7-configure-storage-mapping).

## <a name="step-5-capacity-planning"></a>Шаг 5. Планирование ресурсов

Теперь после настройки базовой инфраструктуры можно начать планирование ресурсов и выяснить, нужны ли дополнительные ресурсы.

- Загрузите и запустите [планировщик ресурсов Azure Site Recovery](site-recovery-capacity-planner.md) для сбора информации о среде репликации, включая сведения о виртуальных машинах, подключенных к ним дискам и их объеме.
- Собрав актуальную информацию о репликации, вы можете настроить для виртуальных машин политику NetQos для управления пропускной способностью, используемой для репликации. Информацию о [регулировании трафика реплик Hyper-V](http://www.thomasmaurer.ch/2013/12/throttling-hyper-v-replica-traffic/) см. в блоге Томаса Маурера (Thomas Maurer). Изучите дополнительные сведения о [командлете New-NetQosPolicy](https://technet.microsoft.com/library/hh967468.aspx.).

## <a name="enable-replication"></a>Включение репликации

1. Последовательно выберите **Шаг 2. Репликация приложения** > **Источник**. Включив репликацию впервые, щелкните **+Replicate** (+ Реплицировать) в хранилище, чтобы включить репликацию для дополнительных компьютеров.

    ![Включение репликации](./media/site-recovery-vmm-to-vmm/enable-replication1.png)
2. В колонке **Источник** выберите сервер VMM и облако, в котором размещены узлы Hyper-V, которые вы хотите реплицировать. Нажмите кнопку **ОК**.

    ![Включение репликации](./media/site-recovery-vmm-to-vmm/enable-replication2.png)
3. В колонке **Цель** проверьте сервер-получатель VMM и вторичное облако.
4. На странице **Виртуальные машины** из списка выберите виртуальные машины, которые необходимо защитить.

    ![Включение защиты виртуальной машины](./media/site-recovery-vmm-to-vmm/enable-replication5.png)

Ход выполнения действия **включения защиты** можно отслеживать, выбрав **Задания** > **Задания Azure Site Recovery**. Когда завершится задание **Завершить подготовку защиты**, виртуальная машина будет готова к отработке отказа.

Обратите внимание на следующее.

- Защиту для виртуальных машин также можно включить в консоли VMM. На панели инструментов на вкладке **Azure Site Recovery** в свойствах виртуальной машины щелкните **Включить защиту**.
- После включения репликации можно просмотреть свойства виртуальной машины, щелкнув **Реплицированные элементы**. На панели мониторинга **Основное** можно просмотреть информацию о политике репликации для виртуальной машины и состояние репликации. Щелкните **Свойства** для получения дополнительных сведений.

### <a name="onboard-existing-virtual-machines"></a>Размещение существующих виртуальных машин
Если в VMM есть виртуальные машины, которые реплицируются с помощью реплики Hyper-V, их можно включить в репликацию Azure Site Recovery следующим образом.

1. Убедитесь, что сервер Hyper-V, на котором размещаются существующие виртуальные машины, расположен в первичном облаке, а сервер Hyper-V, на котором размещается виртуальная машина реплики, расположен во вторичном облаке.
2. Убедитесь, что для первичного облака VMM настроена политика репликации.
3. Включите защиту для первичной виртуальной машины. Azure Site Recovery и VMM обеспечат обнаружение узла и виртуальной машины одной и той же реплики, а Azure Site Recovery повторно использует и установит репликацию, используя указанные параметры.

## <a name="test-your-deployment"></a>Выполните тестирование развертывания

Чтобы протестировать развертывание, можно выполнить [тестовую отработку отказа](site-recovery-test-failover-vmm-to-vmm.md) для одной виртуальной машины или [создать план восстановления](site-recovery-create-recovery-plans.md) для одной или нескольких виртуальных машин.



## <a name="prepare-for-offline-initial-replication"></a>Подготовка к начальной репликации в автономном режиме

Можно выполнить репликацию в автономном режиме для начальной копии данных. К ней можно подготовиться следующим образом.

* На исходном сервере нужно задать расположение пути, из которого будет выполняться экспорт данных. Предоставьте разрешения "Полный доступ" службе NTFS и разрешения "Общий доступ" службе VMM для пути экспорта. На исходном сервере задайте расположение пути, по которому будет выполняться импорт данных. Назначьте те же разрешения для этого пути импорта.
* Если путь импорта или экспорта используется совместно, назначьте учетной записи службы VMM на удаленном компьютере с общей папкой членство в группах "Администратор", "Опытный пользователь", "Оператор печати" или "Оператор сервера".
* Если для добавления узлов вы используете любые учетные записи запуска от имени, назначьте для этих учетных записей в VMM разрешения на чтение и запись для путей импорта и экспорта.
* Общие папки импорта и экспорта нельзя размещать на компьютерах, используемых в качестве серверов узлов Hyper-V, так как конфигурация замыкания на себя не поддерживается Hyper-V.
* В Active Directory для каждого сервера узла Hyper-V, содержащего защищаемые виртуальные машины, включите и настройте ограниченное делегирование для настройки отношений доверия с удаленными компьютерами, на которых размещаются пути экспорта и импорта, следующим образом.
  1. На контроллере домена откройте средство **Пользователи и компьютеры Active Directory**.
  2. В дереве консоли щелкните **Имя_домена** > **Компьютеры**.
  3. Щелкните имя сервера узла Hyper-V правой кнопкой мыши и выберите пункт **Свойства**.
  4. На вкладке **Делегирование** установите флажок **Доверять компьютеру делегирование указанных служб**.
  5. Установите флажок **Использовать любой протокол проверки подлинности**.
  6. Последовательно выберите **Добавить** > **Пользователи и компьютеры**.
  7. Введите имя компьютера, на котором размещается путь импорта и щелкните **OK**. Удерживайте нажатой клавишу CTRL и щелкните в списке доступных услуг элемент **cifs** > **ОК**. Повторите процедуру для имени компьютера, на котором размещается путь импорта. При необходимости повторите процедуру для дополнительных серверов узлов Hyper-V.



## <a name="prepare-for-network-mapping"></a>Подготовка к сопоставлению сетей
При сетевом сопоставлении сопоставляются сети виртуальных машин VMM первичного и вторичного серверов VMM. Вот для чего это делается:

* Оптимальное размещение виртуальных машин реплик на вторичных узлах Hyper-V после отработки отказа.
* После отработки отказа подключите реплики виртуальных машин к соответствующим сетям виртуальных машин.

Обратите внимание на следующее.
- Сетевое сопоставление можно настроить между сетями виртуальных машин на двух серверах VMM или на одном сервере VMM, если два сайта управляются одним сервером.
- Если сопоставление настроено правильно, а репликация включена, виртуальная машина из основного расположения будет подключена к сети, а ее реплика из целевого расположения будет подключена к сопоставленной с ней сети.
- Если сети правильно настроены в VMM, то при выборе целевой сети виртуальных машин во время сетевого сопоставления отображаются исходные облака VMM, использующие исходную сеть виртуальных машин, а также доступные целевые сети виртуальных машин в целевых облаках, которые используются для защиты.
- Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то после отработки отказа реплика виртуальной машины будет подключена к этой целевой подсети. Если нет подсетей с таким же именем, виртуальная машина будет подключена к первой подсети в сети.


Следующий пример иллюстрирует этот механизм. Рассмотрим организацию с двумя филиалами в Нью-Йорке и Чикаго.

| **Расположение** | **Сервер VMM** | **Сети виртуальных машин** | **Сопоставление** |
| --- | --- | --- | --- |
| Нью-Йорк |VMM-NewYork |VMNetwork1-NewYork |Сопоставляется с VMNetwork1-Chicago |
| VMNetwork2-NewYork |Не сопоставлена | | |
| Чикаго |VMM-Chicago |VMNetwork1-Chicago |Сопоставляется с VMNetwork1-NewYork |
| VMNetwork2-Chicago |Не сопоставлена | | |

В этом примере:

* При создании реплики виртуальной машины для любой виртуальной машины, подключенной к VMNetwork1-NewYork, она будет подключена к VMNetwork1-Chicago.
* Когда создается реплика виртуальной машины для VMNetwork2-NewYork или VMNetwork2-Chicago, она не будет подключена ни к какой сети.

Ниже показано, как настраиваются облака VMM в нашем примере, а также представлены логические сети, связанные с облаками.

### <a name="cloud-protection-settings"></a>Параметры защиты облаков
| **Защищенное облако** | **Защита облака** | **Логическая сеть (Нью-Йорк)** |
| --- | --- | --- |
| GoldCloud1 |GoldCloud2 | |
| SilverCloud1 |SilverCloud2 | |
| GoldCloud2 |<p>Нет данных</p><p></p> |<p>LogicalNetwork1-NewYork</p><p>LogicalNetwork1-Chicago</p> |
| SilverCloud2 |<p>Нет данных</p><p></p> |<p>LogicalNetwork1-NewYork</p><p>LogicalNetwork1-Chicago</p> |

### <a name="logical-and-vm-network-settings"></a>Параметры логической сети и сети виртуальных машин
| **Расположение** | **Логические сети** | **Связанная сеть виртуальных машин** |
| --- | --- | --- |
| Нью-Йорк |LogicalNetwork1-NewYork |VMNetwork1-NewYork |
| Чикаго |LogicalNetwork1-Chicago |VMNetwork1-Chicago |
| LogicalNetwork2Chicago |VMNetwork2-Chicago | |

### <a name="target-networks"></a>Целевые сети
В следующей таблице показаны варианты, доступные при выборе целевой сети виртуальных машин, для этих параметров.

| **Выбор** | **Защищенное облако** | **Защита облака** | **Доступная целевая сеть** |
| --- | --- | --- | --- |
| VMNetwork1-Chicago |SilverCloud1 |SilverCloud2 |Доступна |
| GoldCloud1 |GoldCloud2 |Доступна | |
| VMNetwork2-Chicago |SilverCloud1 |SilverCloud2 |Недоступно |
| GoldCloud1 |GoldCloud2 |Доступна | |


### <a name="failback"></a>Восстановление размещения
Чтобы увидеть, что происходит в случае отработки отказа (обратной репликации), предположим, что VMNetwork1-NewYork сопоставляется с VMNetwork1-Chicago со следующими параметрами.

| **Виртуальная машина** | **Подключенная сеть виртуальных машин** |
| --- | --- |
| VM1 |VMNetwork1-Network |
| VM2 (реплика VM1) |VMNetwork1-Chicago |

Приняв эти параметры, рассмотрим, что происходит в нескольких возможных сценариях.

| **Сценарий** | **Результат** |
| --- | --- |
| Сетевые свойства VM-2 не изменяются после отработки отказа. |VM-1 остается подключенной к исходной сети. |
| Сетевые свойства VM-2 изменяются после отработки отказа, и она отключается. |VM-1 отключается. |
| Сетевые свойства VM-2 изменяются после отработки отказа, и она подключается к VMNetwork2-Chicago. |Если VMNetwork2-Chicago не сопоставлена, VM-1 будет отключена. |
| Сетевое сопоставление VMNetwork1-Chicago изменяется. |VM-1 будет подключена к сети, сопоставленной с VMNetwork1-Chicago. |


## <a name="prepare-for-single-server-deployment"></a>Подготовка к развертыванию одного сервера


Если у вас только один сервер VMM, виртуальные машины на узлах Hyper-V в облаке VMM можно реплицировать в [Azure](site-recovery-vmm-to-azure.md) или во вторичное облако VMM. Мы рекомендуем использовать первый вариант, так как репликация между облаками не всегда проходит гладко. Если вы твердо намерены выполнять репликацию между облаками, для нее можно использовать один автономный сервер VMM или отдельный сервер VMM, развернутый в растянутом кластере Windows.

### <a name="standalone-vmm-server"></a>Автономный сервер VMM

В этом сценарии вы развертываете обособленный сервер VMM в качестве виртуальной машины на основном сайте и реплицируете эту виртуальную машину на дополнительный сайт с помощью Site Recovery и реплики Hyper-V.

1. **Настройте VMM на виртуальной машине Hyper-V**. Мы рекомендуем разместить экземпляр SQL Server, используемый VMM, на той же виртуальной машине. Это экономит время, так как требуется создать только одну виртуальную машину. Если вы хотите использовать удаленный экземпляр SQL Server, то в случае сбоя вам потребуется восстановить этот экземпляр перед восстановлением VMM.
2. **На каждом сервере VMM должно быть настроено по крайней мере два облака**. Одно облако будет содержать виртуальные машины, которые требуется реплицировать, а другое облако будет использоваться в качестве дополнительного расположения. Облако, содержащее виртуальные машины, которые необходимо защитить, должно соответствовать [предварительным требованиям](#prerequisites).
3. Настройте Site Recovery, как описано в этой статье. Создайте и зарегистрируйте сервер VMM в хранилище, настройте политику репликации и включите репликацию. Имена исходной и целевой службы VMM будут совпадать. Укажите, что начальная репликация осуществляется по сети.
4. После настройки сетевого сопоставления будет сопоставлена сеть виртуальной машины для первичного облака и сеть виртуальной машины для вторичного облака.
5. В консоли диспетчера Hyper-V включите реплику Hyper-V на узле Hyper-V, содержащем виртуальную машину VMM, и включите репликацию для этой виртуальной машины. Убедитесь, что виртуальная машина VMM не добавляется в облака, которые защищены с помощью Site Recovery, чтобы избежать переопределения параметров реплики Hyper-V компонентом Site Recovery.
6. В случае создания планов восстановления для отработки отказа укажите один и тот же сервер VMM в качестве исходного и целевого.
7. Отработка отказа и восстановление при полном сбое выполняются следующим образом.

   1. В консоли диспетчера Hyper-V на дополнительном сайте выполните внеплановую отработку отказа, чтобы перенести основную виртуальную машину VMM на дополнительный сайт.
   2. Убедитесь, что виртуальная машина VMM работает, и выполните в хранилище внеплановую отработку отказа, чтобы перенести виртуальные машины из основного облака в дополнительное. Примените отработку отказа и выберите альтернативную точку восстановления, если необходимо.
   3. После завершения незапланированной отработки все ресурсы снова будут доступны на основном сайте.
   4. Когда основной сайт снова станет доступен, в консоли диспетчера Hyper-V на дополнительном сайте включите обратную репликацию для виртуальной машины VMM. Это запустит репликацию виртуальной машины с дополнительного сайта на основной.
   5. В консоли диспетчера Hyper-V на дополнительном сайте выполните плановую отработку отказа, чтобы перенести виртуальную машину VMM обратно на основной сайт. Примените отработку отказа. После этого включите обратную репликацию, чтобы виртуальная машина VMM снова реплицировалась с основного сайта на дополнительный.
   6. В хранилище служб восстановления включите обратную репликацию виртуальных машин рабочих нагрузок, чтобы начать их репликацию со вторичного сайта на первичный.
   7. В хранилище служб восстановления выполните плановую отработку отказа, чтобы восстановить виртуальные машины рабочих нагрузок на первичном сайте. Примените отработку отказа, чтобы завершить ее. Затем включите обратную репликацию, чтобы начать репликацию виртуальных машин рабочих нагрузок с первичного сайта на вторичный.

### <a name="stretched-vmm-cluster"></a>Растянутый кластер VMM

Вместо развертывания изолированного сервера VMM в качестве виртуальной машины, которая реплицируется на вторичный сайт, можно сделать сервер VMM высокодоступным, развернув его в качестве виртуальной машины в отказоустойчивом кластере Windows. Это позволяет обеспечить устойчивость рабочих нагрузок и защиту от сбоев оборудования. Для развертывания с Site Recovery виртуальная машина VMM должна быть развернута в кластере, растянутом по географически разделенным сайтам. Для этого:

1. Установите VMM на виртуальной машине в отказоустойчивом кластере Windows и укажите, что во время установки сервер должен быть высокодоступным.
2. Экземпляр SQL Server, используемый VMM, должен реплицироваться с помощью групп доступности SQL Server AlwaysOn, чтобы на дополнительном сайте присутствовала реплика базы данных.
3. Следуйте инструкциям, приведенным в этой статье, чтобы создать хранилище, зарегистрировать сервер и настроить защиту. Необходимо зарегистрировать каждый сервер VMM в кластере в хранилище служб восстановления. Для этого установите поставщик на активном узле и зарегистрируйте сервер VMM. Затем установите поставщик на других узлах.
4. При возникновении сбоя сервер VMM и его соответствующая база данных SQL Server переносятся на вторичный сайт, где они становятся доступными.



## <a name="prepare-for-storage-mapping"></a>Подготовка к сопоставлению хранилища


Сопоставление хранилищ настраивается путем сопоставления классификаций хранилищ на исходном и целевом серверах VMM, и позволяет решать следующие задачи.

  * **Определение целевого хранилища для реплик виртуальных машин**. Жесткий диск исходной виртуальной машины будет реплицироваться в хранилище, которое вы указали в целевом расположении (общий ресурс SMB или общие тома кластера (CSV)).
  * **Размещение виртуальных машин реплики.** Сопоставление хранилищ используется для оптимального размещения виртуальных машин реплики на серверах узлов Hyper-V. Виртуальные машины реплики будут размещены на узлах, которые имеют доступ к сопоставленной классификации хранилища.
  * **Без сопоставления хранилищ.** Если сопоставление хранилищ не настроено, виртуальные машины будут реплицироваться в хранилище по умолчанию, которое указано на сервере узла Hyper-V, связанного с репликой виртуальной машины.

Обратите внимание на следующее.
- Сопоставление можно настроить между двумя облаками VMM на одном сервере.
- Классификации хранилищ должны быть доступны группам узлов, расположенным в исходном и целевом облаках.
- Классификации не обязательно должны иметь одинаковый тип хранилища. Например, можно сопоставить исходную классификацию, содержащую общие папки SMB, с целевой классификацией, которая содержит CSV-файлы.

### <a name="example"></a>Пример
Если классификации правильно настроены в VMM, то при выборе исходного и целевого сервера VMM во время сопоставления хранилищ отображаются исходные и целевые классификации. Ниже приведен пример общих файловых ресурсов хранилища и классификаций для организации с местами хранения в Нью-Йорке и Чикаго.

| **Расположение** | **Сервер VMM** | **Общая папка (исходная)** | **Классификация (исходная)** | **Сопоставление** | **Общая папка (целевая)** |
| --- | --- | --- | --- | --- | --- |
| Нью-Йорк |VMM_Source |SourceShare1 |GOLD |GOLD_TARGET |TargetShare1 |
| SourceShare2 |SILVER |SILVER_TARGET |TargetShare2 | | |
| SourceShare3 |BRONZE |BRONZE_TARGET |TargetShare3 | | |
| Чикаго |VMM_Target | |GOLD_TARGET |Не сопоставлена | |
|  |SILVER_TARGET |Не сопоставлена | | | |
|  |BRONZE_TARGET |Не сопоставлена | | | |

В этом примере:

* Если для любой виртуальной машины создается реплика виртуальной машины в хранилище GOLD (SourceShare1), репликация будет выполняться в хранилище GOLD_TARGET (TargetShare1).
* Если виртуальная машина реплики создается для всех виртуальных машин в хранилище SILVER (SourceShare2), она будет реплицирована в хранилище SILVER_TARGET (TargetShare2) и т. д.

### <a name="multiple-storage-locations"></a>Несколько мест хранения
Если целевая классификация назначена нескольким общим ресурсам SMB или CSV-файлам, оптимальное место хранения будет выбрано автоматически при защите виртуальной машины. Если нет подходящего целевого хранилища с указанной классификацией, для размещения виртуальных жестких дисков реплики используется место хранения по умолчанию, указанное на узле Hyper-V.

В таблице ниже показано, как в нашем примере настраиваются классификация хранилища и общие тома кластера.

| **Расположение** | **Классификация** | **Связанное хранилище** |
| --- | --- | --- |
| Нью-Йорк |GOLD |<p>C:\ClusterStorage\SourceVolume1</p><p>\\FileServer\SourceShare1</p> |
| SILVER |<p>C:\ClusterStorage\SourceVolume2</p><p>\\FileServer\SourceShare2</p> | |
| Чикаго |GOLD_TARGET |<p>C:\ClusterStorage\TargetVolume1</p><p>\\FileServer\TargetShare1</p> |
| SILVER_TARGET |<p>C:\ClusterStorage\TargetVolume2</p><p>\\FileServer\TargetShare2</p> | |

В следующей таблице указывается поведение при включении защиты для виртуальных машин (VM1–VM5) в этом примере среде.

| **Виртуальная машина** | **Исходное хранилище** | **Исходная классификация** | **Сопоставленное целевое хранилище** |
| --- | --- | --- | --- |
| VM1 |C:\ClusterStorage\SourceVolume1 |GOLD |<p>C:\ClusterStorage\SourceVolume1</p><p>\\\FileServer\SourceShare1</p><p>Оба GOLD_TARGET</p> |
| VM2 |\\FileServer\SourceShare1 |GOLD |<p>C:\ClusterStorage\SourceVolume1</p><p>\\FileServer\SourceShare1</p> <p>Оба GOLD_TARGET</p> |
| VM3 |C:\ClusterStorage\SourceVolume2 |SILVER |<p>C:\ClusterStorage\SourceVolume2</p><p>\FileServer\SourceShare2</p> |
| VM4 |\FileServer\SourceShare2 |SILVER |<p>C:\ClusterStorage\SourceVolume2</p><p>\\FileServer\SourceShare2</p><p>Оба SILVER_TARGET</p> |
| VM5 |C:\ClusterStorage\SourceVolume3 |Недоступно |Без сопоставления, поэтому используется место хранения узла Hyper-V по умолчанию. |



### <a name="data-privacy-overview"></a>Обзор конфиденциальности данных

В следующей таблице приведена сводка по хранению данных в этом сценарии.

- - -
| Действие | **Дополнительные сведения** | **Собранные данные** | **Использование** | **Обязательный** |
| --- | --- | --- | --- | --- |
| **Регистрация** | Вы регистрируете сервер VMM в хранилище служб восстановления. Если позже вы захотите отменить регистрацию сервера, это можно будет сделать, удалив сведения о сервере с портала Azure. | После регистрации сервера VMM служба Site Recovery собирает, обрабатывает и передает метаданные о сервере VMM и имена облаков VMM, обнаруженные службой Site Recovery. | Эти данные используются для идентификации соответствующего сервера VMM и обмена данными с ним, а также для настройки параметров соответствующих облаков VMM. | Это обязательная функция. Если вы не хотите отправлять эти сведения в службу Site Recovery, не следует ее использовать. |
| **Включение репликации** | Поставщик Azure Site Recovery, установленный на сервере VMM, является каналом для взаимодействия со службой Site Recovery. Поставщик представляет собой библиотеку DLL, размещаемую в процессе VMM. После установки поставщика в консоли администратора VMM включается функция "Datacenter Recovery". Новые и существующие виртуальные машины могут включить эту функцию, чтобы задействовать защитить себя. |Если это свойство задано, поставщик отправляет имя и идентификатор виртуальной машины в службу Site Recovery.  Репликация обеспечивается репликой Hyper-V Windows Server 2012 или Windows Server 2012 R2. Данные виртуальной машины реплицируются с одного узла Hyper-V на другой (как правило, он находится в другом центре обработки данных "восстановления"). |Служба Site Recovery использует метаданные для заполнения сведений о виртуальной машине на портале Azure. | Это важная функция службы, и ее нельзя отключить. Если вы не хотите отправлять эти сведения, не включайте защиту Site Recovery для виртуальных машин. Имейте ввиду, что все данные, отправляемые поставщиком в службу Site Recovery, передаются по протоколу HTTPS. |
| **План восстановления** | Планы восстановления помогают создать план оркестрации для центра обработки данных восстановления. Можно определить порядок запуска виртуальных машин или группы виртуальных машин на сайте восстановления. Кроме того, можно указать выполняемые автоматизированные сценарии или ручные действия во время восстановления для каждой виртуальной машины. Отработка отказа обычно активируется на уровне плана восстановления, чтобы восстановление было координированным. | Служба Site Recovery собирает, обрабатывает и передает метаданные плана восстановления, включая метаданные виртуальных машин, метаданные всех автоматизированных сценариев и заметки о выполняемых вручную действиях. |Эти метаданные используется для создания плана восстановления на портале Azure. |Это важная функция службы, и ее нельзя отключить. Если вы не хотите отправлять эти сведения в службу Site Recovery, не создавайте планы восстановления. |
| **Сетевое сопоставление** | Эта функция позволяет сопоставить сведения о сети между первичным центром обработки данных и центром обработки данных восстановления. При восстановлении виртуальных машин на сайте восстановления сетевое сопоставление помогает установить сетевое подключение. |Служба Site Recovery собирает, обрабатывает и передает метаданные логических сетей для каждого сайта (первичного и центра обработки данных). |Эти метаданные используется для задания параметров сети, чтобы можно было сопоставить сведения о сети. | Это важная функция службы, и ее нельзя отключить. Если вы не хотите отправлять эти сведения в службу Site Recovery, не используйте сетевое сопоставление. |
| **Отработка отказа (запланированная, незапланированная и тестовая)** | При отработке отказа виртуальные машины переходят из одного центра обработки данных в другой. Действие отработки отказа активируется вручную на портале Azure. |Поставщик на сервере VMM получает уведомление о событии отработки отказа от службы Site Recovery и выполняет действие отработки отказа на узле Hyper-V с помощью интерфейсов VMM. Фактически выполняется отработка отказа виртуальной машины с одного узла Hyper-V на другой. Для ее обработки используется реплика Hyper-V Windows Server 2012 или Windows Server 2012 R2. На основании отправленной информации служба Site Recovery заполняет информацию о состоянии для действия отработки отказа на портале Azure. | Это важная функция службы, и ее нельзя отключить. Если вы не хотите отправлять эти сведения в службу Site Recovery, не используйте отработку отказа. |

## <a name="next-steps"></a>Дальнейшие действия

После проверки развертывания изучите другие типы [отработки отказа](site-recovery-failover.md).

---
title: "Как в Site Recovery работает репликация Hyper-V в Azure? | Документация Майкрософт"
description: "В этой статье описывается выполнение репликации Hyper-V с помощью службы Azure Site Recovery"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: c413efcd-d750-4b22-b34b-15bcaa03934a
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 06/14/2017
ms.author: raynew
ROBOTS: NOINDEX, NOFOLLOW
redirect_url: site-recovery-architecture-hyper-v-to-azure
ms.openlocfilehash: 6fa952af93033f82effdef418903fc93d94dd05c
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="how-does-hyper-v-replication-to-azure-work"></a>Как работает репликация Hyper-V в Azure?

Данная статья помогает понять архитектуру и рабочие процессы репликации Hyper-V в Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).

Комментарии можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

В Azure вы можете реплицировать следующее:
- **Hyper-V с VMM.** Виртуальные машины, расположенные на локальных узлах Hyper-V, управляемых в облаках System Center Virtual Machine Manager (VMM). Узлы могут работать под управлением любой [поддерживаемой операционной системы](site-recovery-support-matrix-to-azure.md#support-for-datacenter-management-servers). Вы можете реплицировать виртуальные машины Hyper-V, запущенные в любой операционной системе на виртуальной машине, [поддерживаемой Hyper-V и Azure](https://technet.microsoft.com/en-us/windows-server-docs/compute/hyper-v/supported-windows-guest-operating-systems-for-hyper-v-on-windows).
- **Hyper-V без VMM.** Локальные виртуальные машины, расположенные на узлах Hyper-V, которые не управляются в облаках VMM. Узлы могут работать под управлением любой из [поддерживаемых операционных систем](site-recovery-support-matrix-to-azure.md#support-for-replicated-machine-os-versions). Вы можете реплицировать виртуальные машины Hyper-V, запущенные в любой операционной системе на виртуальной машине, [поддерживаемой Hyper-V и Azure](https://technet.microsoft.com/en-us/windows-server-docs/compute/hyper-v/supported-windows-guest-operating-systems-for-hyper-v-on-windows).


## <a name="architectural-components"></a>Компоненты архитектуры

**Область** | **Компонент** | **Дополнительные сведения**
--- | --- | ---
**Таблицы Azure** | В Azure вам требуется учетная запись Microsoft Azure, учетная запись хранения Azure и сеть Azure. | Учетные записи хранения и сети могут быть учетными записями Resource Manager или классическими.<br/><br/> Реплицированные данные хранятся в учетной записи хранения, а виртуальные машины Azure создаются с использованием реплицированных данных при отработке отказа с локального сайта.<br/><br/> При создании виртуальные машины Azure подключаются к виртуальной сети Azure.
**Сервер VMM** | Узлы Hyper-V, расположенные в облаках VMM | Если управление узлами Hyper-V осуществляется в облаках VMM, сервер VMM необходимо зарегистрировать в хранилище служб восстановления.<br/><br/> Установите поставщик Site Recovery на сервере VMM, чтобы управлять репликацией с помощью Azure.<br/><br/> Необходимо настроить логические сети и сети виртуальных машин для настройки сетевого сопоставления. Сеть виртуальных машин должна быть связана с логической сетью, которая сопоставлена с облаком.
**Узел Hyper-V** | Серверы Hyper-V можно развернуть с помощью сервера VMM или без него. | Если сервера VMM нет, поставщик Site Recovery устанавливается на узле, чтобы управлять репликацией с помощью Site Recovery через Интернет. При наличии сервера VMM поставщик устанавливается не на узле, а на нем.<br/><br/> Агент служб восстановления устанавливается на узле для выполнения репликации данных.<br/><br/> Обмен данными между поставщиком и агентом осуществляется по защищенным и зашифрованным каналам. Реплицированные данные в службе хранилища Azure также шифруются.
**Виртуальные машины Hyper-V** | На сервере узла Hyper-V должна быть установлена как минимум одна виртуальная машина. | На виртуальных машинах не нужно ничего устанавливать явным образом.

## <a name="deployment-steps"></a>Шаги по развертыванию

1. **Azure.** Вам необходимо настроить компоненты Azure. Перед развертыванием Site Recovery мы рекомендуем настроить учетные записи хранения и сети.
2. **Хранилище.** Необходимо создать хранилище служб восстановления для Site Recovery и настроить параметры хранилища, в том числе параметры исходной и целевой среды, а также настроить политику репликации и включить репликацию.
3. **Исходная и целевая среда.**
    - **Узлы Hyper-V в облаках VMM.** В рамках указания параметров исходной среды вам необходимо скачать и установить поставщик Azure Site Recovery на сервере VMM и агент служб восстановления Azure на каждом узле Hyper-V. Источником будет сервер VMM, а целевым объектом — Azure.
    - Узлы Hyper-V без VMM. При определении параметров исходной среды вам необходимо скачать и установить поставщик и агент на каждом узле Hyper-V. В процессе развертывания вам необходимо объединить все узлы в сайт Hyper-V, а затем указать этот сайт в качестве источника. а целевым объектом — Azure.

    ![Репликация Hyper-V или VMM в Azure](./media/site-recovery-components/arch-onprem-onprem-azure-vmm.png) ![репликации узла Hyper-V в Azure](./media/site-recovery-components/arch-onprem-azure-hypervsite.png)


4. **Политика репликации.** Создайте политику репликации для сайта Hyper-V или облака VMM. Политика применяется ко всем виртуальным машинам, расположенным на узлах на сайте или в облаке.
5. **Включение репликации.** Включите репликацию для виртуальных машин Hyper-V. Начальная репликация выполняется в соответствии с параметрами политики репликации. Отслеживаются изменения данных. Репликация разностных изменений в Azure начинается после завершения начальной репликации. Отслеживаемые изменения для элемента хранятся в HRL-файле.
6. **Тестовая отработка отказа.** Выполните тестовую отработку отказа, чтобы убедиться в надлежащей работе всех компонентов.

Дополнительные сведения о развертывании см. в статьях, представленных ниже.
- [Репликация виртуальных машин Hyper-V из облаков VMM в Azure с помощью Site Recovery на портале Azure](site-recovery-vmm-to-azure.md)
- [Репликация виртуальных машин Hyper-V (без VMM) в облако Azure с помощью службы Azure Site Recovery и портала Azure](site-recovery-hyper-v-site-to-azure.md)

## <a name="hyper-v-replication-workflow"></a>Рабочий процесс репликации Hyper-V

### <a name="enable-protection"></a>Включить защиту

1. После включения защиты для виртуальных машин Hyper-V на портале Azure или локально запустится рабочий процесс **Включение защиты**.
2. Это задание проверяет, соответствует ли компьютер необходимым требованиям перед вызовом метода [CreateReplicationRelationship](https://msdn.microsoft.com/library/hh850036.aspx), который настраивает репликацию, используя определенные вами параметры.
3. Задание запускает начальную репликацию, вызывая метод [StartReplication](https://msdn.microsoft.com/library/hh850303.aspx), чтобы инициализировать полную репликацию виртуальной машины и отправить ее виртуальные диски в Azure.
4. На вкладке **Задания** можно отслеживать ход выполнения задания.
        ![Список заданий](media/site-recovery-hyper-v-azure-architecture/image1.png)![Подробные сведения о включении защиты](media/site-recovery-hyper-v-azure-architecture/image2.png)

### <a name="initial-replication"></a>Начальная репликация

1. При запуске начальной репликации создается [моментальный снимок виртуальной машины Hyper-V](https://technet.microsoft.com/library/dd560637.aspx).
2. Виртуальные жесткие диски реплицируются по одному, пока все они не будут скопированы в Azure. В зависимости от размера виртуальной машины и пропускной способности сети это может занять некоторое время. Инструкции по оптимизации использования сети см. в статье [Как уменьшить нагрузку на сеть при защите между локальной средой и Azure](https://support.microsoft.com/kb/3056159).
3. В случае возникновения изменений на диске при выполнении начальной репликации модуль отслеживания репликации реплики Hyper-V регистрирует их в журналах репликации Hyper-V (HRL), которые находятся в папке с дисками. С каждым диском связан HRL-файл, который отправляется в дополнительное хранилище.
4. При начальной репликации файлы моментальных снимков и журналов потребляют ресурсы диска.
5. После завершения начальной репликации моментальный снимок виртуальной машины удаляется. Разностные изменения на диске в журнале синхронизируются и объединяются в родительском диске.


### <a name="finalize-protection"></a>Завершение подготовки защиты

1. После завершения начальной репликации задание **Завершить подготовку защиты на виртуальной машине** настраивает сеть и другие параметры для защиты виртуальной машины.
    ![Задание завершения подготовки защиты](media/site-recovery-hyper-v-azure-architecture/image3.png)
2. При репликации в Azure может потребоваться настроить параметры виртуальной машины для обеспечения готовности к отработке отказа. На этом этапе можно выполнить тестовую отработку отказа, чтобы убедиться, что все работает правильно.

### <a name="delta-replication"></a>Разностная репликация данных

1. После начальной репликации начинается синхронизация изменений в соответствии с параметрами репликации.
2. Модуль отслеживания репликации реплики Hyper-V отслеживает изменения и передает их виртуальному жесткому диску в качестве HRL-файлов. Для каждого диска, предназначенного для репликации, создается связанный HRL-файл. Эти журналы передаются в пользовательскую учетную запись хранения после завершения начальной репликации. При передаче журнала в Azure изменения на основном диске фиксируются в дополнительном журнале, который размещается в том же каталоге.
3. Во время начальной и разностной репликаций вы можете отслеживать состояние виртуальной машины в ее представлении. [Подробнее](site-recovery-monitoring-and-troubleshooting.md#monitor-replication-health-for-virtual-machines).  

### <a name="replication-synchronization"></a>Синхронизация репликации

1. Если происходит сбой дельта-репликации и для полной репликации необходима высокая пропускная способность или требуется много времени, тогда виртуальная машина помечается для повторной синхронизации. Например, когда HRL-файлы заполняют до 50 % объема диска, виртуальная машина отмечается для повторной синхронизации.
2.  Повторная синхронизация минимизирует объем передаваемых данных. Для этого вычисляются контрольные суммы исходной и целевой виртуальной машины, а затем отправляются только отличающиеся данные. Повторная синхронизация использует алгоритм фрагментации, то есть разбивает исходный и целевой файлы на блоки фиксированного размера. Для каждого фрагмента данных создаются контрольные суммы, сравнение которых позволяет определить, какие из блоков нужно передать от источника к целевому объекту.
3. После завершения повторной синхронизации возобновляется обычная разностная репликация данных. По умолчанию повторная синхронизация автоматически выполняется в нерабочее время. Повторную синхронизацию виртуальной машины можно выполнить вручную. Например, в случае сбоя сети или другого сбоя повторную синхронизацию можно возобновить. Чтобы сделать это, выберите виртуальную машину на портале и щелкните **Повторная синхронизация**.

    ![Повторная синхронизация вручную](media/site-recovery-hyper-v-azure-architecture/image4.png)


### <a name="retries"></a>Повторы

При ошибке репликации используется встроенный механизм повторных попыток. Этот алгоритм предполагает работу с двумя представленными ниже категориями ошибок.

**Категория** | **Дополнительные сведения**
--- | ---
**Неустранимые ошибки** | Без повторных попыток. Состояние виртуальной машины отображается как **Критическое**, что требует вмешательства администратора. Это может быть обусловлено неисправной цепочкой виртуальных жестких дисков, недопустимым состоянием реплики виртуальной машины, ошибками аутентификации сети (ошибками авторизации), ошибками "Не найдено" для виртуальной машины (для отдельных серверов Hyper-V).
**Устранимые ошибки** | Повторные попытки выполняются в рамках каждого интервала репликации с использованием экспоненциального алгоритма отсрочки, то есть каждая следующая попытка выполняется с большей задержкой (1, 2, 4, 8 и 10 минут). Если проблема не устранена, повторные попытки выполняются каждые 30 минут. Примеры таких ошибок: сетевые ошибки, дефицит места на диске, нехватка памяти. |

## <a name="protection-and-recovery-lifecycle"></a>Жизненный цикл защиты и восстановления

![рабочий процесс](./media/site-recovery-components/arch-hyperv-azure-workflow.png)

## <a name="next-steps"></a>Дальнейшие действия

- [Проверка предварительных условий для развертывания](site-recovery-prereq.md)
- Устранение неполадок:
    - [Разделы о мониторинге и устранении неполадок защиты](site-recovery-monitoring-and-troubleshooting.md)
    - [Служба технической поддержки Майкрософт](site-recovery-monitoring-and-troubleshooting.md#reach-out-for-microsoft-support)
    - [Распространенные ошибки ASR и способы их устранения](site-recovery-monitoring-and-troubleshooting.md#common-azure-site-recovery-errors-and-their-resolutions)

---
title: "aaaHow работает Hyper-V репликации tooAzure в Site Recovery? | Документация Майкрософт"
description: "В этой статье описывается выполнение репликации Hyper-V с помощью службы Azure Site Recovery"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: c413efcd-d750-4b22-b34b-15bcaa03934a
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 06/14/2017
ms.author: raynew
ROBOTS: NOINDEX, NOFOLLOW
redirect_url: site-recovery-architecture-hyper-v-to-azure
ms.openlocfilehash: e982806b4d6cdec2f71f82d8c73c17cc50ad3c33
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="how-does-hyper-v-replication-tooazure-work"></a>Как работает tooAzure репликации Hyper-V?

Чтение этой статьи toounderstand hello архитектуры и рабочие процессы для tooAzure репликации Hyper-V с помощью hello [Azure Site Recovery](site-recovery-overview.md) службы.

Отправлять все комментарии hello нижней части этой статьи, или в hello [форум по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

Можно реплицировать hello следующие tooAzure:
- **Hyper-V с VMM.** Виртуальные машины, расположенные на локальных узлах Hyper-V, управляемых в облаках System Center Virtual Machine Manager (VMM). Узлы могут работать под управлением любой [поддерживаемой операционной системы](site-recovery-support-matrix-to-azure.md#support-for-datacenter-management-servers). Вы можете реплицировать виртуальные машины Hyper-V, запущенные в любой операционной системе на виртуальной машине, [поддерживаемой Hyper-V и Azure](https://technet.microsoft.com/en-us/windows-server-docs/compute/hyper-v/supported-windows-guest-operating-systems-for-hyper-v-on-windows).
- **Hyper-V без VMM.** Локальные виртуальные машины, расположенные на узлах Hyper-V, которые не управляются в облаках VMM. Узлы могут использовать любую из hello [поддерживаемые операционные системы](site-recovery-support-matrix-to-azure.md#support-for-replicated-machine-os-versions). Вы можете реплицировать виртуальные машины Hyper-V, запущенные в любой операционной системе на виртуальной машине, [поддерживаемой Hyper-V и Azure](https://technet.microsoft.com/en-us/windows-server-docs/compute/hyper-v/supported-windows-guest-operating-systems-for-hyper-v-on-windows).


## <a name="architectural-components"></a>Компоненты архитектуры

**Область** | **Компонент** | **Дополнительные сведения**
--- | --- | ---
**Таблицы Azure** | В Azure вам требуется учетная запись Microsoft Azure, учетная запись хранения Azure и сеть Azure. | Учетные записи хранения и сети могут быть учетными записями Resource Manager или классическими.<br/><br/> Реплицированные данные хранятся в учетной записи хранения hello и виртуальных машинах Azure создаются с hello реплицированных данных, когда происходит переход на другой ресурс с веб-узла в локальной среде.<br/><br/> Hello виртуальных машинах Azure подключиться toohello виртуальной сети Azure, когда они создаются.
**Сервер VMM** | Узлы Hyper-V, расположенные в облаках VMM | Если узлы Hyper-V управляются в облаках VMM, регистрации сервера VMM hello в hello в хранилище служб восстановления.<br/><br/> На сервере VMM hello hello поставщика Site Recovery tooorchestrate репликации устанавливается с помощью Azure.<br/><br/> Потребуется логических и tooconfigure сетевое сопоставление настроить сети виртуальных Машин. Сеть виртуальной Машины должно быть связанного tooa логической сети, связанной с облаком hello.
**Узел Hyper-V** | Серверы Hyper-V можно развернуть с помощью сервера VMM или без него. | Если нет ни одного сервера VMM, hello поставщика Site Recovery на которых установлен hello узла tooorchestrate репликации с Site Recovery через hello Интернета. Если сервер VMM, hello поставщик установлен, а не на узле hello.<br/><br/> агент служб восстановления Hello устанавливается на репликацию данных toohandle hello узла.<br/><br/> Обмен данными между hello поставщика и агента hello защищен и зашифрован. Реплицированные данные в службе хранилища Azure также шифруются.
**Виртуальные машины Hyper-V** | Требуется один или несколько виртуальных машин на сервере узла Hyper-V hello. | Ничего не требуется tooexplicitly, установленных на виртуальных машинах

## <a name="deployment-steps"></a>Шаги по развертыванию

1. **Azure**: настройки hello компонентов Azure. Перед развертыванием Site Recovery мы рекомендуем настроить учетные записи хранения и сети.
2. **Хранилище.** Необходимо создать хранилище служб восстановления для Site Recovery и настроить параметры хранилища, в том числе параметры исходной и целевой среды, а также настроить политику репликации и включить репликацию.
3. **Исходная и целевая среда.**
    - **Узлы Hyper-V в облаках VMM**: В процессе определения параметров источника, загрузить и установить hello поставщика Azure Site Recovery на сервере VMM hello и hello агента служб восстановления Azure на каждом узле Hyper-V. Источник Hello будет hello сервера VMM. целевой объект Hello является Azure.
    - Узлы Hyper-V без VMM: при указании параметров источника загрузки и установки hello поставщика и агента на каждом узле Hyper-V. При развертывании сбора hello узлы в узле Hyper-V и указать этот сайт в качестве источника hello. целевой объект Hello является Azure.

    ![Репликация Hyper-V или VMM tooAzure](./media/site-recovery-components/arch-onprem-onprem-azure-vmm.png) ![tooAzure репликации узла Hyper-V](./media/site-recovery-components/arch-onprem-azure-hypervsite.png)


4. **Политика репликации**: создайте политику репликации для сайта hello Hyper-V или облака VMM. политика Hello — примененных tooall виртуальными машинами, размещенными на узлах, на сайте hello или в облаке.
5. **Включение репликации.** Включите репликацию для виртуальных машин Hyper-V. Начальная репликация выполняется в соответствии с параметрами политики репликации hello. Отслеживаются изменения данных и репликация tooAzure разностных изменений начинается после завершения первоначальной репликации hello. Отслеживаемые изменения для элемента хранятся в HRL-файле.
6. **Тестовая отработка отказа**: запустить тест отработки отказа toomake, убедиться, что все работает должным образом.

Дополнительные сведения о развертывании см. в статьях, представленных ниже.
- [Приступая к работе с tooAzure репликации виртуальных Машин Hyper-V - с помощью VMM](site-recovery-vmm-to-azure.md)
- [Приступая к работе с tooAzure репликации виртуальных Машин Hyper-V - без VMM](site-recovery-hyper-v-site-to-azure.md)

## <a name="hyper-v-replication-workflow"></a>Рабочий процесс репликации Hyper-V

### <a name="enable-protection"></a>Включить защиту

1. После включения защиты для виртуальной Машины Hyper-V в hello портала Azure или локально, hello **включить защиту** запускает.
2. Hello задания проверяет, что компьютер, hello соответствует необходимым требованиям, перед вызовом hello [CreateReplicationRelationship](https://msdn.microsoft.com/library/hh850036.aspx), tooset репликации заданы параметры hello.
3. Hello задание запускается начальная репликация с помощью вызова hello [StartReplication](https://msdn.microsoft.com/library/hh850303.aspx) метод tooinitialize полной репликации виртуальной Машины и tooAzure виртуальные диски send hello Виртуальной машины.
4. Вы можете отслеживать задания hello в hello **заданий** вкладки.      ![Список заданий](media/site-recovery-hyper-v-azure-architecture/image1.png)![Подробные сведения о включении защиты](media/site-recovery-hyper-v-azure-architecture/image2.png)

### <a name="initial-replication"></a>Начальная репликация

1. При запуске начальной репликации создается [моментальный снимок виртуальной машины Hyper-V](https://technet.microsoft.com/library/dd560637.aspx).
2. Виртуальные жесткие диски, реплицируемых по одному до они все скопированные tooAzure. Он может занять некоторое время, в зависимости от hello размер виртуальной Машины и пропускной способности сети. toooptimize использование вашей сети, в разделе [как toomanage локальной пропускной способности сети защиты tooAzure](https://support.microsoft.com/kb/3056159).
3. В случае изменения диска во время начальной репликации hello отслеживания репликации реплика Hyper-V отслеживает эти изменения как журналы репликации Hyper-V (.hrl). Эти файлы расположены в hello же папке, что диски hello. Каждый диск имеет связанный .hrl файл, будут отправляться toosecondary хранилища.
4. файлы моментальных снимков и журналов Hello потребляют ресурсы диска, во время начальной репликации.
5. После завершения начальной репликации hello, удаление снимка виртуальной Машины hello. Диск изменений в журнале hello, синхронизированным и объединенные toohello родительского диска.


### <a name="finalize-protection"></a>Завершение подготовки защиты

1. По завершении начальной репликации hello hello **завершить подготовку защиты на виртуальной машине hello** задания настроить сеть и другие параметры после репликации таким образом, чтобы hello виртуальная машина защищена.
    ![Задание завершения подготовки защиты](media/site-recovery-hyper-v-azure-architecture/image3.png)
2. Если выполняется репликация tooAzure, может потребоваться tootweak hello параметры для hello виртуальной машины, чтобы она готова для отработки отказа. На этом этапе можно запустить toocheck отработки отказа теста, который все работает, как ожидалось.

### <a name="delta-replication"></a>Разностная репликация данных

1. После начальной репликации hello начинает разностной синхронизации, в соответствии с параметрами репликации.
2. Hello отслеживания репликации реплика Hyper-V отслеживает файлы .hrl hello изменения tooa виртуального жесткого диска. Для каждого диска, предназначенного для репликации, создается связанный HRL-файл. Этот журнал отправляется toohello пользовательской учетной записи хранения, после завершения начальной репликации. Если журнал транспорте tooAzure, в другой файл журнала, в hello отслеживаются изменения hello основной диск hello один каталог.
3. Во время начального и разностных репликации можно отслеживать hello виртуальной Машины в hello представление виртуальной Машины. [Подробнее](site-recovery-monitoring-and-troubleshooting.md#monitor-replication-health-for-virtual-machines).  

### <a name="replication-synchronization"></a>Синхронизация репликации

1. Если происходит сбой дельта-репликации и для полной репликации необходима высокая пропускная способность или требуется много времени, тогда виртуальная машина помечается для повторной синхронизации. Например если файлы .hrl hello достигают 50% от размера диска hello, затем hello ВМ помечается для повторной синхронизации.
2.  Повторная синхронизация сводит к минимуму hello объем данных, посланных расчет контрольных сумм hello исходных и целевых виртуальных машин и отправка только hello дельта-данные. Повторная синхронизация использует алгоритм фрагментации, то есть разбивает исходный и целевой файлы на блоки фиксированного размера. Контрольные суммы для каждого фрагмента данных создаются и затем сравнивается toodetermine, который блокирует hello источника необходимость toobe примененных toohello цели.
3. После завершения повторной синхронизации возобновляется обычная разностная репликация данных. По умолчанию повторная синхронизация является запланированных toorun автоматически вне времени office, но можно синхронизировать виртуальную машину вручную. Например, в случае сбоя сети или другого сбоя повторную синхронизацию можно возобновить. toodo это, выберите hello ВМ на портале hello > **повторной синхронизации**.

    ![Повторная синхронизация вручную](media/site-recovery-hyper-v-azure-architecture/image4.png)


### <a name="retries"></a>Повторы

При ошибке репликации используется встроенный механизм повторных попыток. Этот алгоритм предполагает работу с двумя представленными ниже категориями ошибок.

**Категория** | **Дополнительные сведения**
--- | ---
**Неустранимые ошибки** | Без повторных попыток. Состояние виртуальной машины отображается как **Критическое**, что требует вмешательства администратора. Примеры этих ошибок: разрыв цепочки виртуальных жестких ДИСКОВ; Недопустимое состояние для hello реплики виртуальной Машины; Сетевые ошибки проверки подлинности: ошибки авторизации; Виртуальная машина не обнаружены ошибки (для изолированных серверов Hyper-V)
**Устранимые ошибки** | Повторы выполняются каждый интервал репликации, с помощью экспоненциальной отсрочки, увеличивает интервал повтора hello от начала hello hello первой попытки, 1, 2, 4, 8 и 10 минут. Если проблема не устранена, повторные попытки выполняются каждые 30 минут. Примеры таких ошибок: сетевые ошибки, дефицит места на диске, нехватка памяти. |

## <a name="protection-and-recovery-lifecycle"></a>Жизненный цикл защиты и восстановления

![рабочий процесс](./media/site-recovery-components/arch-hyperv-azure-workflow.png)

## <a name="next-steps"></a>Дальнейшие действия

- [Проверка предварительных условий для развертывания](site-recovery-prereq.md)
- Устранение неполадок:
    - [Разделы о мониторинге и устранении неполадок защиты](site-recovery-monitoring-and-troubleshooting.md)
    - [Служба технической поддержки Майкрософт](site-recovery-monitoring-and-troubleshooting.md#reach-out-for-microsoft-support)
    - [Распространенные ошибки ASR и способы их устранения](site-recovery-monitoring-and-troubleshooting.md#common-azure-site-recovery-errors-and-their-resolutions)

---
title: "Настройка аварийного восстановления для локальных виртуальных машин Hyper-V в Azure с помощью Azure Site Recovery | Документация Майкрософт"
description: "Узнайте, как настраивать аварийное восстановление в Azure для локальных виртуальных машин Hyper-V с помощью службы Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 45e9b4dc-20ca-4c14-bee3-cadb8d9b8b24
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 09/18/2017
ms.author: raynew
ms.openlocfilehash: 96e5027adfb443aba18895213e8d83894e3f060a
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="set-up-disaster-recovery-of-on-premises-hyper-v-vms-to-azure"></a>Настройка аварийного восстановления локальных виртуальных машин Hyper-V в Azure

Служба [Azure Site Recovery](site-recovery-overview.md) помогает реализовать стратегию аварийного восстановления за счет управления процессами репликации, отработки отказа и восстановления локальных компьютеров и виртуальных машин Azure.

В этом руководстве показано, как настроить аварийное восстановление локальных виртуальных машин Hyper-V в Azure. Оно предназначено для виртуальных машин Hyper-V, управление которыми осуществляется в облаках System Center Virtual Machine Manager (VMM), а также для других виртуальных машин. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Настройка Azure и предварительных требований для локальной среды.
> * Создание хранилища служб восстановления для Site Recovery. 
> * Настройка исходной и целевой сред для репликации. 
> * Настройка сетевого сопоставления (если Hyper-V находится под управлением System Center VMM).
> * Создание политики репликации
> * Включение репликации для виртуальных машин.


## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством:

- Вам должны быть понятны [архитектура и компоненты сценария](concepts-hyper-v-to-azure-architecture.md).
- [Ознакомьтесь](site-recovery-support-matrix-to-azure.md) с требованиями поддержки для всех компонентов.
- Убедитесь, что виртуальные машины, которые необходимо реплицировать, соответствуют требованиям [виртуальных машин Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).
- Ознакомьтесь с планированием ресурсов:
    - Определите частоту с помощью [планировщика ресурсов Hyper-V](http://aka.ms/asr-capacity-planner-excel).
    - Проанализируйте исходную среду, оценочную пропускную способность и требования целевой среды с помощью [планировщика ресурсов Site Recovery](http://aka.ms/asr-capacity-planner-excel).
- Подготовьте Azure. Требуется подписка Azure, виртуальная сеть Azure и учетная запись хранения.
- Подготовьте локальные узлы Hyper-V и серверы VMM (при необходимости).





### <a name="set-up-an-azure-account"></a>Настройка учетной записи Azure

Получите [учетную запись Microsoft Azure](http://azure.microsoft.com/).

- Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/).
- Ознакомьтесь с расходами [при использования Site Recovery](site-recovery-faq.md#pricing) и [сведениями о ценах](https://azure.microsoft.com/pricing/details/site-recovery/).
- Узнайте, [какие регионы поддерживаются для Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).

### <a name="verify-azure-account-permissions"></a>Проверка разрешений учетной записи Azure

Убедитесь, что учетная запись Azure имеет разрешения, нужные для репликации виртуальных машин.

- Проверьте [разрешения](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines), которые необходимы для репликации компьютеров в Azure.
- Проверьте и измените разрешения [доступа на основе ролей](../active-directory/role-based-access-control-configure.md). 


### <a name="set-up-an-azure-network"></a>Настроить сеть Azure

Настройте [сеть Azure](../virtual-network/virtual-network-get-started-vnet-subnet.md).

- Виртуальные машины Azure будут размещаться в этой сети при создании после отработки отказа.
- Сеть должна располагаться в том же регионе, что и хранилище служб восстановления.


### <a name="set-up-an-azure-storage-account"></a>Настроить учетную запись хранения Azure

Настройте [учетную запись хранения Azure](../storage/common/storage-create-storage-account.md#create-a-storage-account).

- Служба Site Recovery реплицирует локальные машины в службе хранилища Azure. Виртуальные машины Azure создаются из хранилища после отработки отказа.
- Учетная запись хранения должна быть создана в том же регионе, что и хранилище служб восстановления.
- Учетная запись хранения может быть уровня "Стандартный" или [Премиум](../storage/common/storage-premium-storage.md).
- Если вы настроите учетную запись уровня "Премиум", вам также понадобится дополнительная учетная запись уровня "Стандартный" для данных журнала.

### <a name="prepare-hyper-v-hosts"></a>Подготовка узлов Hyper-V

1. Убедитесь, что узлы Hyper-V [соответствуют требованиям](site-recovery-support-matrix-to-azure.md#support-for-datacenter-management-servers).
2. Убедитесь, что узлы могут получить доступ к этим URL-адресам:

    [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]
    
    - При использовании правил брандмауэра на основе IP-адресов убедитесь, что эти правила разрешают обмен данными с Azure.
    - Разрешите доступ для [диапазонов IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и использование порта HTTPS (443).
    - Необходимо разрешить доступ для диапазонов IP-адресов региона Azure, в котором располагается ваша подписка, и региона "Западная часть США" (используется для контроля доступа и управления удостоверениями).

### <a name="prepare-vmm-servers"></a>Подготовка серверов VMM

Если узлами Hyper-V управляет VMM, необходимо подготовить локальный сервер VMM. 

- Убедитесь, что сервер VMM соответствует [требованиям поддержки](site-recovery-support-matrix-to-azure.md#support-for-datacenter-management-servers).
- Убедитесь, что для сервера VMM настроено как минимум одно облако с одной или несколькими группами узлов. Узел Hyper-V, на котором запущены виртуальные машины, должен находиться в облаке.
- Серверу VMM требуется доступ к Интернету с доступом к следующим URL-адресам:

    [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]
    
    - При использовании правил брандмауэра на основе IP-адресов убедитесь, что эти правила разрешают обмен данными с Azure.
    - Разрешите доступ для [диапазонов IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и использование порта HTTPS (443).
    - Необходимо разрешить доступ для диапазонов IP-адресов региона Azure, в котором располагается ваша подписка, и региона "Западная часть США" (используется для контроля доступа и управления удостоверениями).
- Подготовьте сервер VMM к сопоставлению сетей.


#### <a name="prepare-vmm-for-network-mapping"></a>Подготовка VMM к сопоставлению сети

Если вы используете VMM, при [сетевом сопоставлении](site-recovery-network-mapping.md) локальные сети виртуальной машины VMM сопоставляются с виртуальными сетями Azure. При сопоставлении во время создания после отработки отказа виртуальные машины Azure будут подключены к правильной сети.

Подготовьте VMM к сопоставлению сетей следующим образом:

1. Подготовьте [логическую сеть VMM](https://docs.microsoft.com/system-center/vmm/network-logical), связанную с облаком, в котором находятся узлы Hyper-V.
2. Убедитесь в наличии [сети виртуальной машины](https://docs.microsoft.com/system-center/vmm/network-virtual), связанной с логической сетью.
3. Подключите виртуальные машины к сети виртуальной машины.

## <a name="create-a-recovery-services-vault"></a>Создание хранилища служб восстановления

[!INCLUDE [site-recovery-create-vault](../../includes/site-recovery-create-vault.md)]


## <a name="select-a-protection-goal"></a>Выбор целевого объекта защиты

Выберите реплицируемые компоненты и место назначения.

1. В хранилище щелкните **Site Recovery** > **Prepare Infrastructure** (Подготовка инфраструктуры) > **Protection goal** (Цель защиты).
2. На странице **Protection goal** (Цель защиты) выберите **To Azure** (В Azure)> **Yes, with Hyper-V** (Да, с помощью Hyper-V). 
    - Если узлами Hyper-V не управляет VMM, выберите значение **Нет**, чтобы подтвердить, что VMM не используется.
    - Если управление узлами осуществляется в облаках VMM, выберите значение **Да**.

## <a name="set-up-the-source-environment"></a>Настройка исходной среды

При настройке исходной среды следует установить поставщик Azure Site Recovery и агент служб восстановления Azure, а также зарегистрировать локальные серверы в хранилище. 

1. В разделе **Подготовка инфраструктуры** щелкните **Источник**. 
    - Если вы не используете VMM, щелкните **+Hyper-V Site** (+Сайт Hyper-V) и укажите имя сайта. Затем щелкните **+Hyper-V Server** (+Сервер Hyper-V) и добавьте на сайт узел или кластер.
    - Если вы используете VMM, в разделе **Prepare source** (Подготовка источника) щелкните **+ VMM**, чтобы добавить сервер VMM. В колонке **Добавление сервера** в поле **Тип сервера** должно быть указано **System Center VMM server** (Сервер System Center VMM).
2. Загрузите компоненты поставщика и агента (в зависимости от среды).
    - Загрузите файл установки поставщика (только для Hyper-V). Запустите файл на каждом узле Hyper-V для установки поставщика и агента.
        
        ![Поставщик без VMM](./media/tutorial-hyper-v-to-azure/download-no-vmm.png)
    
    - Для Hyper-V с VMM загрузите поставщик и агент отдельно. Запустите установку поставщика на сервере VMM. Запустите установку агента на каждом узле Hyper-V.
    
        ![Поставщик и агент с VMM](./media/tutorial-hyper-v-to-azure/download-vmm.png)
    
3. Скачайте ключ регистрации хранилища. Он понадобится при запуске программы установки поставщика. Ключ действителен в течение пяти дней после создания.

### <a name="install-components"></a>Установка компонентов

Установите компоненты, указанные в таблице. 

**Компонент** | **Дополнительные сведения** | **Только Hyper-V** | **Hyper-V с VMM**
--- | --- | --- | ---
**Поставщик Azure Site Recovery** | Оркестрация репликации в Azure | Установите на каждом узле Hyper-V | Установите на сервере VMM
**Агент служб восстановления** | Репликация данных | Установите на каждом узле Hyper-V | Установите на узле Hyper-V


#### <a name="install-the-provider-on-hyper-v-without-vmm"></a>Установка поставщика на узле Hyper-V без VMM

Установите поставщик на каждом узле Hyper-V, добавленном на сайт Hyper-V. Если установка выполняется в кластер Hyper-V, программу установки необходимо запустить на каждом узле кластера. Установка и регистрация всех узлов кластера Hyper-V гарантирует, что виртуальные машины будут защищены даже при переносе между узлами.

1. Обновления можно включить на странице **Центр обновления Майкрософт**. Это позволит устанавливать обновления поставщика в соответствии с политикой Центра обновления Майкрософт.
2. На странице **Установка** примите или измените расположение установки поставщика по умолчанию и нажмите кнопку **Установить**.
4. На странице **Параметры хранилища** нажмите кнопку **Обзор**, чтобы выбрать скачанный файл ключа хранилища. Укажите подписку Azure Site Recovery, имя хранилища и узла Hyper-V, к которому относится сервер Hyper-V.
5. В окне **Параметры Интернета** укажите параметры для подключения поставщика, который будет выполняться на сервере VMM или на узлах Hyper-V, к Site Recovery через Интернет.
    * Для прямого подключения выберите **Connect directly to Azure Site Recovery without a proxy** (Подключиться к Azure Site Recovery напрямую без прокси-сервера).
    * Для прокси-сервера выберите **Подключиться к Azure Site Recovery с использованием прокси-сервера**. Укажите адрес прокси-сервера, порт и учетные данные (при необходимости).
6. После регистрации сервера в хранилище нажмите кнопку **Готово**.

Azure Site Recovery извлечет метаданные с сервера Hyper-V, а сам сервер отобразится в колонке **Site Recovery Infrastructure** (Инфраструктура Site Recovery) > **Hyper-V Hosts** (Узлы Hyper-V).


#### <a name="install-the-recovery-services-agent-on-hyper-v-host-without-vmm"></a>Установка агента служб восстановления на узле Hyper-V без VMM

Если вы используете VMM в развертывании, запустите программу установки агента служб восстановления на каждом узле Hyper-V.

1. В мастере настройки выберите **Проверка предварительных требований** и нажмите кнопку **Далее**. Все отсутствующие предварительные требования будут установлены автоматически.

    ![Предварительные требования для агента служб восстановления](./media/tutorial-hyper-v-to-azure/hyperv-agent-prerequisites.png)
3. В разделе **Параметры установки** примите или измените место установки и расположение кэша. Диску кэша требуется по крайней мере 5 ГБ места для хранения. Мы рекомендуем диск с 600 ГБ свободного места (минимум). Нажмите **Install**(Установить).
4. На странице **Установка** после завершения установки нажмите кнопку **Закрыть** для завершения работы мастера.

##### <a name="set-up-internet-access-via-a-proxy"></a>Настройка доступа к Интернету через прокси-сервер

Агенту служб восстановления на узлах Hyper-V требуется доступ к Azure через Интернет для репликации виртуальных машин. Если доступ к Интернету осуществляется через прокси-сервер, настройте его так:

1. Откройте на узле Hyper-V оснастку MMC в службе архивации Microsoft Azure. По умолчанию ярлык для службы Microsoft Azure Backup расположен на рабочем столе или в папке C:\Program Files\Microsoft Azure Recovery Services Agent\bin\wabadmin.
2. В оснастке щелкните **Изменить свойства**.
3. На вкладке **Конфигурация прокси-сервера** укажите сведения о прокси-сервере.

    ![Регистрация агента служб восстановления Microsoft Azure](./media/tutorial-hyper-v-to-azure/mars-proxy.png)
4. Убедитесь, что агент может получить доступ к [требуемым URL-адресам](#prepare-hyper-v-hosts).

#### <a name="install-the-provider-on-the-vmm-server-hyper-v-with-vmm"></a>Установка поставщика на сервере VMM (Hyper-V с VMM)

1. Обновления можно включить на странице **Центр обновления Майкрософт**. Это позволит устанавливать обновления поставщика в соответствии с политикой Центра обновления Майкрософт.
2. На странице **Установка** примите или измените расположение установки поставщика по умолчанию и нажмите кнопку **Установить**. 
3. Зарегистрируйте сервер VMM в хранилище. На странице **Параметры хранилища** нажмите кнопку **Обзор**, чтобы выбрать скачанный файл ключа хранилища. Укажите подписку Azure Site Recovery и имя хранилища.

    ![Регистрация сервера](./media/tutorial-hyper-v-to-azure/provider-vault-settings.png)

4. В окне **Параметры Интернета** укажите параметры для подключения поставщика, который будет выполняться на сервере VMM или на узлах Hyper-V, к Site Recovery через Интернет.

    * Для прямого подключения выберите **Connect directly to Azure Site Recovery without a proxy** (Подключиться к Azure Site Recovery напрямую без прокси-сервера).
    * Для прокси-сервера выберите **Подключиться к Azure Site Recovery с использованием прокси-сервера**. Укажите адрес прокси-сервера, порт и учетные данные (при необходимости).
    - На сервере VMM автоматически создается учетная запись запуска от имени (DRAProxyAccount) с учетными данными, указанными для прокси-сервера. Настройте прокси-сервер так, чтобы эта учетная запись могла успешно проходить проверку подлинности. Параметры учетной записи запуска от имени можно изменить в консоли VMM (**Параметры** > **Безопасность** > **Учетные записи запуска от имени**). Перезапустите службу VMM, чтобы изменения вступили в силу.
5. В разделе **Шифрование данных** укажите, следует ли шифровать все данные, отправляемые в Azure. При выборе этого параметра Site Recovery выдает сертификат. Вам потребуется этот сертификат для расшифровки данных позже.
6. В поле **Сервер VMM** укажите понятное имя, описывающее сервер VMM в хранилище. В конфигурации кластера укажите имя роли кластера VMM. В поле **Synchronize cloud metadata with the vault** (Синхронизация метаданных в облаке с хранилищем) укажите, нужно ли синхронизировать с хранилищем метаданные для всех облаков на сервере VMM. На каждом сервере это действие требуется выполнять только один раз. Если не требуется синхронизировать все облака, можно оставить этот флажок снятым и настраивать синхронизацию для каждого облака отдельно в свойствах облака в консоли VMM.

Когда регистрация завершится, Azure Site Recovery извлечет метаданные с сервера, а сервер VMM отобразится в колонке **Инфраструктура Site Recovery**.






## <a name="set-up-the-target-environment"></a>Настройка целевой среды

Выберите и проверьте целевые ресурсы. 

1. Выберите **Подготовка инфраструктуры** > **Цель**.
2. Выберите подписку и группу ресурсов, в которых будут создаваться виртуальные машины Azure после отработки отказа. Выберите модель развертывания, которая будет использоваться в Azure для виртуальных машин.

3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

## <a name="configure-network-mapping-with-vmm"></a>Настройка сетевого сопоставления (с VMM)

Если вы используете VMM, настройте сетевое сопоставление.

1. Выберите **Site Recovery Infrastructure** (Инфраструктура Site Recovery) > **Сетевые сопоставления** > **Сетевое сопоставление** и щелкните значок **+Network Mapping** (+Сетевое сопоставление).
2. В разделе **Add network mapping** (Добавить сетевое сопоставление) выберите исходный сервер VMM. Выберите **Azure** в качестве целевой среды.
3. Проверьте подписку и модель развертывания после отработки отказа.
4. В поле **Исходная сеть** выберите исходную локальную сеть виртуальной машины.
5. На странице **Целевая сеть** выберите сеть Azure, в которой будут размещены реплицированные виртуальные машины Azure. Нажмите кнопку **ОК**.

    ![Сетевое сопоставление](./media/tutorial-hyper-v-to-azure/network-mapping-vmm.png)

## <a name="create-a-replication-policy"></a>Создание политики репликации

1. Щелкните **Prepare infrastructure** (Подготовка инфраструктуры) > **Параметры репликации** > **+Create and associate** (+Создание и связывание)
2. На странице **Создать и связать политику**укажите имя политики.
3. В раскрывающемся списке **Частота копирования**выберите периодичность репликации изменений данных после начальной репликации (каждые 30 секунд, 5 или 15 минут).

    > [!NOTE]
    >  Частота 30 секунд не поддерживается при репликации в хранилище класса Premium. Это ограничение связано с ограничением в 100 моментальных снимков на большой двоичный объект, которые можно сохранить в хранилище класса Premium. [Подробнее](../storage/common/storage-premium-storage.md#snapshots-and-copy-blob).

4. В поле **Хранение точки восстановления** укажите продолжительность периода хранения для каждой точки восстановления (в часах). Защищенные компьютеры будут восстанавливаться до любой точки в пределах этого периода.
5. В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, как часто (от 1 до 12 часов) будут создаваться точки восстановления, содержащие согласованные с приложениями моментальные снимки. Hyper-V использует два типа моментальных снимков:
    - **Стандартный моментальный снимок.** Создание добавочного моментального снимка всей виртуальной машины.
    - **Моментальный снимок с согласованием приложений.** Создание снимка данных приложения в виртуальной машине на определенный момент времени. Служба теневого копирования томов (VSS) обеспечивает согласованное состояние приложений при создании моментального снимка. Включение моментальных снимков с согласованием приложений влияет на производительность приложений на исходных виртуальных машинах. Задаваемое значение должно быть меньше количества дополнительных точек восстановления, которое было настроено.
6. Укажите необходимые данные в поле **Время запуска начальной репликации**. При репликации используется полоса пропускания Интернета, поэтому проведение репликации нужно запланировать на свободное от работы время.
7. В области **Шифровать данные, хранящиеся в Azure**нажмите соответствующую кнопку. Нажмите кнопку **ОК**.

    ![Политика репликации](./media/tutorial-hyper-v-to-azure/replication-policy.png)


При создании политика автоматически сопоставляется с облаком VMM или с сайтом Hyper-V.

## <a name="enable-replication"></a>Включение репликации


1. Выберите **Репликация приложения** > **Источник**. 
2. В разделе **Источник** выберите сайт Hyper-V, сервер или облако VMM. Нажмите кнопку **ОК**.
3. В разделе **Цель** убедитесь, что в качестве целевой среды выбрано Azure, а также проверьте подписку хранилища и модель, которую необходимо использовать в Azure после отработки отказа.
4. Выберите учетную запись хранения для реплицируемых данных и сеть Azure, в которой будут находиться виртуальные машины Azure после отработки отказа.
5. В разделе **Виртуальные машины** > **Выбрать** выберите виртуальные машины, которые необходимо реплицировать. Нажмите кнопку **ОК**.

 Ход выполнения действия **включения защиты** можно отслеживать, выбрав **Задания** > **Задания Azure Site Recovery**. После завершения задания **Завершение подготовки защиты** начальная репликация завершается, а виртуальная машина готова к отработке отказа.

## <a name="next-steps"></a>Дальнейшие действия
[Run a disaster recovery drill to Azure](tutorial-dr-drill-azure.md) (Выполнение отработки аварийного восстановления в Azure)

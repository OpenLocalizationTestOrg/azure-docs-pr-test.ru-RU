---
title: "Тестовая отработка отказа в Azure в Site Recovery | Документация Майкрософт"
description: "Сведения о запуске тестовой отработки отказа с переносом из локальной среды в Azure"
services: site-recovery
documentationcenter: 
author: prateek9us
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 07/04/2017
ms.author: pratshar
ms.openlocfilehash: 54f62af6abcdd38254fd5379b95baa05656dc90b
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="test--failover-to-azure-in-site-recovery"></a>Тестовая отработка отказа в Azure в Site Recovery



В данной статье содержатся сведения и инструкции по тестовой отработке отказа или тренировке аварийного восстановления виртуальных машин и физических серверов, защищенных с помощью Site Recovery, с использованием Azure в качестве сайта восстановления.

Комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

Тестовая отработка отказа выполняется для проверки стратегии репликации или анализа работы системы аварийного восстановления без потери данных или простоя. Выполнение тестовой отработки отказа никак не влияет на текущую репликацию или рабочую среду. Тестовую отработку отказа можно выполнить на виртуальной машине или в [плане восстановления](site-recovery-create-recovery-plans.md). При запуске тестовой отработки отказа необходимо указать сеть, к которой будут подключаться виртуальные машины. После запуска ход выполнения тестовой отработки отказа можно отслеживать на вкладке **Задания**.  


## <a name="supported-scenarios"></a>Поддерживаемые сценарии использования.
Тестовая отработка отказа поддерживается во всех сценариях развертывания, кроме развертывания [из устаревшего сайта VMware в Azure](site-recovery-vmware-to-azure-classic-legacy.md). Тестовая отработка отказа также не поддерживается, если на виртуальной машине проводилась отработка отказа в Azure.  


## <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа
В этой процедуре описывается, как запустить тестовую отработку отказа для плана восстановления. Также можно выполнить тестовую отработку отказа для одной машины, используя на ней соответствующий вариант отработки.

![Тестирование отработки отказа](./media/site-recovery-test-failover-to-azure/TestFailover.png)


1. Выберите **Планы восстановления** > *имя_плана_восстановления*. Щелкните **Тестовая отработка отказа**.
1. Выберите **точку восстановления**, в которую будет выполнена отработка отказа. Можно выбрать один из следующих вариантов:
    1.  **Latest processed** (Последняя обработанная). В этом варианте отработка отказа всех виртуальных машин плана восстановления выполняется до последней точки восстановления из числа уже обработанных службой Site Recovery. При выполнении тестовой отработки отказа виртуальной машины также отображается метка времени последней обработанной точки восстановления. Если отработка отказа выполняется по плану восстановления, вы можете перейти к отдельной виртуальной машине и просмотреть плитку **Последняя точка восстановления** для получения этих сведений. Так как на обработку необработанных данных время не тратится, то этот вариант обеспечивает низкий показатель RTO (целевое время восстановления).
    1.  **Latest app-consistent** (Последняя с согласованием приложений). При этом варианте отработка отказа всех виртуальных машин плана восстановления выполняется до последней точки восстановления с согласованием приложений, которая уже была обработана службой Site Recovery. При выполнении тестовой отработки отказа виртуальной машины также отображается метка времени последней обработанной точки восстановления с согласованием приложений. Если отработка отказа выполняется по плану восстановления, вы можете перейти к отдельной виртуальной машине и просмотреть плитку **Последняя точка восстановления** для получения этих сведений.
    1.  **Latest** (Последняя). При этом варианте сначала обрабатываются все данные, отправленные в службу Site Recovery, чтобы создать точку восстановления для каждой виртуальной машины, прежде чем выполнять в нее отработку отказа. Этот вариант обеспечивает самый низкий показатель RPO (целевая точка восстановления), так как виртуальная машина, созданная после отработки отказа, будет иметь все данные, реплицированные в службу Site Recovery при активации отработки отказа.
    1.  **Последняя обработанная точка нескольких виртуальных машин**. Этот параметр доступен только для планов восстановления, которые содержат по крайней мере одну виртуальную машину с поддержкой согласованности нескольких виртуальных машин. Виртуальные машины, которые являются частью группы репликации, выполняют отработку отказа до последней согласованной точки восстановления, общей для нескольких виртуальных машин. Остальные виртуальные машины выполняют отработку отказа до последней обработанной точки восстановления.  
    1.  **Последняя согласованная с приложением точка нескольких виртуальных машин**. Этот параметр доступен только для планов восстановления, которые содержат по крайней мере одну виртуальную машину с поддержкой согласованности нескольких виртуальных машин. Виртуальные машины, которые являются частью группы репликации, выполняют отработку отказа до последней согласованной с приложением точки восстановления, общей для нескольких виртуальных машин. Остальные виртуальные машины выполняют отработку отказа до последней точки восстановления, согласованной с приложением. 
    1.  **Custom** (Настраиваемая). Если вы выполняете тестовую отработку отказа виртуальной машины, можете использовать этот вариант для отработки отказа в определенную точку восстановления.
1. Выберите **виртуальную сеть Azure**: укажите виртуальную сеть Azure, в которой будут созданы тестовые виртуальные машины. Служба Site Recovery попытается создать тестовые виртуальные машины в подсети с таким же именем, используя тот же IP-адрес, который был указан в разделе параметров **Вычисления и сеть** виртуальной машины. Если подсеть с таким же именем недоступна в виртуальной сети Azure, предоставленной для тестовой отработки отказа, тестовая виртуальная машина создается в первой по алфавиту подсети. Если тот же IP-адрес в подсети недоступен, виртуальная машина получит другой IP-адрес, доступный в подсети. Дополнительные сведения см. в [этом разделе](#creating-a-network-for-test-failover).
1. Если при отработке отказа с выполнением переноса в Azure включена функция шифрования данных, то в разделе **Ключ шифрования** выберите сертификат, который был выпущен, когда во время установки поставщика вы включили функцию шифрования данных. Этот шаг можно пропустить, если вы не включали функцию шифрования на виртуальной машине.
1. Ход выполнения отработки отказа можно отслеживать на вкладке **Задания** . Кроме того, вы можете просмотреть тестовую реплицированную машину на портале Azure.
1. Чтобы инициировать на виртуальной машине подключение по протоколу RDP, необходимо [добавить общедоступный IP-адрес](site-recovery-monitoring-and-troubleshooting.md#adding-a-public-ip-on-a-resource-manager-virtual-machine) в сетевом интерфейсе виртуальной машины, для которой выполнена отработка отказа. Если отработка отказа выполняется на классическую виртуальную машину, на порте 3389 необходимо [добавить конечную точку](../virtual-machines/windows/classic/setup-endpoints.md).
1. Когда все будет готово, нажмите кнопку **Cleanup test failover** (Очистить тестовую отработку отказа) в плане восстановления. При необходимости в разделе **примечаний** можно записать и сохранить ваши наблюдения касательно тестовой отработки отказа. Это приведет к удалению виртуальных машин, созданных во время тестовой отработки отказа.


> [!TIP]
> Служба Site Recovery попытается создать тестовые виртуальные машины в подсети с таким же именем, используя тот же IP-адрес, который был указан в разделе параметров **Вычисления и сеть** виртуальной машины. Если подсеть с таким же именем недоступна в виртуальной сети Azure, предоставленной для тестовой отработки отказа, тестовая виртуальная машина создается в первой по алфавиту подсети. Если целевой IP-адрес является частью выбранной подсети, Site Recovery попытается создать виртуальную машину для тестовой отработки отказа с его использованием. В противном случае виртуальная машина для тестовой отработки отказа создается с использованием любого доступного IP-адреса в выбранной подсети.
>
>

## <a name="test-failover-job"></a>Задание тестовой отработки отказа

![Тестирование отработки отказа](./media/site-recovery-test-failover-to-azure/TestFailoverJob.png)

Активация тестовой отработки отказа включает следующие этапы.

1. Проверка необходимых компонентов. На этом этапе вы проверяете, соблюдены ли все условия, необходимые для отработки отказа.
1. Отработка отказа. На этом этапе данные обрабатываются и подготавливаются для создания виртуальной машины Azure. Если вы выбрали **последнюю** точку восстановления, на этом этапе создается точка восстановления на основе данных, отправленных в службу.
1. Запуск. Теперь создается виртуальная машина Azure с использованием данных, обработанных на предыдущем этапе.

## <a name="time-taken-for-failover"></a>Время, необходимое для отработки отказа

В некоторых случаях для отработки отказа виртуальных машин требуется дополнительный промежуточный шаг, который обычно длится 8–10 минут. Эти случаи перечислены ниже:

* виртуальные машины VMware, использующие службу Mobility Service версии ниже 9.8;
* физические серверы;
* виртуальные машины VMware на платформе Linux;
* виртуальные машины Hyper-V, защищенные как физические серверы;
* виртуальные машины VMware, на которых отсутствуют следующие драйверы в качестве драйверов загрузки:
    * storvsc;
    * vmbus;
    * storflt;
    * intelide;
    * atapi;
* виртуальные машины VMware, на которых не включена служба DHCP, вне зависимости от того, используется протокол DHCP или статические IP-адреса.

Во всех остальных случаях этот промежуточный шаг не обязателен, а время, необходимое для отработки отказа, значительно ниже.


## <a name="creating-a-network-for-test-failover"></a>Создание сети для тестовой отработки отказа
При выполнении тестовой отработки отказа рекомендуется выбрать сеть, которая изолирована от рабочей сети сайта восстановления, указанной в разделе параметров **Вычисления и сеть** виртуальной машины. При создании виртуальной сети Azure она по умолчанию изолируется от других сетей. Эта сеть должна имитировать рабочую сеть:

1. Тестовая сеть должна иметь то же число подсетей, что и рабочая сеть. Имена подсетей должны совпадать с аналогичными именами в рабочей сети.
1. В тестовой сети должен использоваться такой же диапазон IP-адресов, как и в рабочей сети.
1. Обновите службу DNS тестовой сети, используя IP-адрес, который был указан в качестве целевого IP-адреса для виртуальной машины DNS в разделе параметров **Вычисления и сеть**. Дополнительные сведения см. в разделе [Рекомендации по тестированию отработки отказа для Active Directory](site-recovery-active-directory.md#test-failover-considerations).


## <a name="test-failover-to-a-production-network-on-recovery-site"></a>Тестовая отработка отказа в рабочую сеть на сайте восстановления
При выполнении тестовой отработки отказа рекомендуется выбрать сеть, которая отличается от рабочей сети сайта восстановления, указанной в разделе параметров **Вычисления и сеть** виртуальной машины. Но если вы действительно хотите проверить сквозное сетевое подключение на виртуальной машине, для которой выполнена отработка отказа, обратите внимание на следующие факторы.

1. При выполнении тестовой отработки отказа убедитесь, что работа основной виртуальной машины была завершена. Если этого не сделать, в одной сети будут одновременно работать две виртуальные машины с одинаковыми идентификаторами, а это может привести к нежелательным последствиям.
1. Любые изменения, внесенные на виртуальных машинах тестовой отработки отказа, будут потеряны при выполнении очистки этих машин. Эти изменения не будут реплицироваться обратно на основную виртуальную машину.
1. Такой способ тестирования приводит к простою рабочего приложения. Попросите пользователей не использовать приложение во время тестирования аварийного восстановления.  



## <a name="prepare-active-directory-and-dns"></a>Подготовка Active Directory и DNS
Чтобы выполнить тестовую отработку отказа для тестирования приложения, потребуется копия рабочей среды Active Directory в тестовой среде. Дополнительные сведения см. в разделе [Рекомендации по тестированию отработки отказа для Active Directory](site-recovery-active-directory.md#test-failover-considerations).

## <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

Если после отработки отказа нужно подключиться к виртуальным машинам Azure по протоколу удаленного рабочего стола, выполните действия, которые перечислены в таблице.

**Тип отработки отказа** | **Расположение** | **Действия**
--- | --- | ---
**Виртуальная машина Azure под управлением Windows** | На локальном компьютере до отработки отказа | Чтобы получить доступ к виртуальной машине Azure через Интернет, включите протокол RDP. Проверьте, добавлены ли правила TCP и UDP в разделе **Общее** и разрешен ли протокол RDP в разделе **Брандмауэр Windows** > **Разрешенные программы** для всех профилей.<br/><br/> Чтобы получить доступ через подключение типа "сеть — сеть", включите протокол RDP на компьютере. Проверьте, разрешен ли протокол RDP в разделе **Брандмауэр Windows** -> **Разрешенные программы и компоненты** для **сетей домена и частных сетей**.<br/><br/>  Задайте для политики сети SAN операционной системы значение **OnlineAll**. [Подробнее](https://support.microsoft.com/kb/3031135).<br/><br/> Прежде чем активировать отработку отказа, убедитесь, что на виртуальной машине нет ожидающих установки обновлений Windows. Когда вы начнете отработку отказа, может начаться обновление Windows. В этом случае вы не сможете войти на виртуальную машину до завершения обновления. <br/><br/>
**Виртуальная машина Azure под управлением Windows** | На виртуальной машине Azure после отработки отказа | На классической виртуальной машине [добавьте общедоступную конечную точку](../virtual-machines/windows/classic/setup-endpoints.md) для протокола RDP (порт 3389).<br/><br/>  На виртуальной машине, развернутой с помощью Resource Manager, [добавьте общедоступный IP-адрес](site-recovery-monitoring-and-troubleshooting.md#adding-a-public-ip-on-a-resource-manager-virtual-machine).<br/><br/> Правила группы безопасности сети на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту RDP.<br/><br/> На виртуальной машине, развернутой с помощью Resource Manager, вы можете увидеть снимок экрана виртуальной машины в **диагностике загрузки**.<br/><br/> Если вы не можете подключиться к виртуальной машине, убедитесь, что она запущена. См. также [рекомендации по устранению неполадок](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).<br/><br/>
**Виртуальная машина Azure под управлением Linux** | На локальном компьютере до отработки отказа | Настройте автоматический запуск службы SSH на виртуальной машине Azure при загрузке системы (если он еще не настроен).<br/><br/> Убедитесь, что правила брандмауэра разрешают SSH-подключение к виртуальной машине.
**Виртуальная машина Azure под управлением Linux** | Виртуальная машина Azure после отработки отказа | Правила группы безопасности сети на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту SSH.<br/><br/> Чтобы разрешить входящие подключения на порт SSH (TCP-порт 22 по умолчанию) на классической виртуальной машине, [создайте общедоступную конечную точку](../virtual-machines/windows/classic/setup-endpoints.md).<br/><br/> На виртуальной машине, развернутой с помощью Resource Manager, [добавьте общедоступный IP-адрес](site-recovery-monitoring-and-troubleshooting.md#adding-a-public-ip-on-a-resource-manager-virtual-machine).<br/><br/> На виртуальной машине, развернутой с помощью Resource Manager, вы можете увидеть снимок экрана виртуальной машины в **диагностике загрузки**.<br/><br/>



## <a name="next-steps"></a>Дальнейшие действия
После успешной тестовой отработки отказа можно попробовать выполнить [отработку отказа](site-recovery-failover.md).

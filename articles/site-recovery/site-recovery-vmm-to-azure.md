---
title: "Репликация виртуальных машин Hyper-V из облаков VMM в Azure | Документация Майкрософт"
description: "В статье описывается управление репликацией, отработкой отказа и восстановлением виртуальных машин Hyper-V, управляемых в облаках System Center VMM, в Azure."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: tysonn
ms.assetid: 8e7d868e-00f3-4e8b-9a9e-f23365abf6ac
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: hero-article
ms.date: 06/14/2017
ms.author: raynew
ms.openlocfilehash: 958b61f5de732a882e0a2682b8dd4e18504a6ae7
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="replicate-hyper-v-virtual-machines-in-vmm-clouds-to-azure-using-site-recovery-in-the-azure-portal"></a><span data-ttu-id="b3d29-103">Репликация виртуальных машин Hyper-V из облаков VMM в Azure с помощью Site Recovery на портале Azure</span><span class="sxs-lookup"><span data-stu-id="b3d29-103">Replicate Hyper-V virtual machines in VMM clouds to Azure using Site Recovery in the Azure portal</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="b3d29-104">Портал Azure</span><span class="sxs-lookup"><span data-stu-id="b3d29-104">Azure portal</span></span>](site-recovery-vmm-to-azure.md)
> * [<span data-ttu-id="b3d29-105">Классическая модель Azure</span><span class="sxs-lookup"><span data-stu-id="b3d29-105">Azure classic</span></span>](site-recovery-vmm-to-azure-classic.md)
> * [<span data-ttu-id="b3d29-106">PowerShell — Resource Manager</span><span class="sxs-lookup"><span data-stu-id="b3d29-106">PowerShell Resource Manager</span></span>](site-recovery-vmm-to-azure-powershell-resource-manager.md)
> * [<span data-ttu-id="b3d29-107">PowerShell — классическая модель</span><span class="sxs-lookup"><span data-stu-id="b3d29-107">PowerShell classic</span></span>](site-recovery-deploy-with-powershell.md)


<span data-ttu-id="b3d29-108">В этой статье описано, как выполнить репликацию локальных виртуальных машин Hyper-V, управление которыми осуществляется в облаках System Center VMM, в Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md) на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-108">This article describes how to replicate on-premises Hyper-V virtual machines managed in System Center VMM clouds to Azure, using the [Azure Site Recovery](site-recovery-overview.md) service in the Azure portal.</span></span>

<span data-ttu-id="b3d29-109">Любые комментарии, которые возникнут после прочтения этой статьи, можно добавить в конце этой страницы или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span><span class="sxs-lookup"><span data-stu-id="b3d29-109">After reading this article, post any comments at the bottom, or on the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>

<span data-ttu-id="b3d29-110">Если вы хотите перенести виртуальные машины в Azure (без восстановления размещения), воспользуйтесь рекомендациями из [этой статьи](site-recovery-migrate-to-azure.md).</span><span class="sxs-lookup"><span data-stu-id="b3d29-110">If you want to migrate machines to Azure (without failback), learn more in [this article](site-recovery-migrate-to-azure.md).</span></span>


## <a name="deployment-steps"></a><span data-ttu-id="b3d29-111">Шаги по развертыванию</span><span class="sxs-lookup"><span data-stu-id="b3d29-111">Deployment steps</span></span>

<span data-ttu-id="b3d29-112">Выполните шаги по развертыванию, следуя инструкциям в статье.</span><span class="sxs-lookup"><span data-stu-id="b3d29-112">Follow the article to complete these deployment steps:</span></span>


1. <span data-ttu-id="b3d29-113">[Узнайте больше](site-recovery-components.md) об архитектуре этого развертывания.</span><span class="sxs-lookup"><span data-stu-id="b3d29-113">[Learn more](site-recovery-components.md) about the architecture for this deployment.</span></span> <span data-ttu-id="b3d29-114">Кроме того, [получите дополнительные сведения](site-recovery-hyper-v-azure-architecture.md) о выполнении репликации Hyper-V в Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="b3d29-114">In addition, [learn about](site-recovery-hyper-v-azure-architecture.md) how Hyper-V replication works in Site Recovery.</span></span>
2. <span data-ttu-id="b3d29-115">Выполните предварительные требования и ознакомьтесь с ограничениями.</span><span class="sxs-lookup"><span data-stu-id="b3d29-115">Verify prerequisites and limitations.</span></span>
3. <span data-ttu-id="b3d29-116">Настройте сеть и учетные записи хранения Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-116">Set up Azure network and storage accounts.</span></span>
4. <span data-ttu-id="b3d29-117">Подготовьте локальный сервер VMM и узлы Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="b3d29-117">Prepare the on-premises VMM server and Hyper-V hosts.</span></span>
5. <span data-ttu-id="b3d29-118">Создайте хранилище служб восстановления,</span><span class="sxs-lookup"><span data-stu-id="b3d29-118">Create a Recovery Services vault.</span></span> <span data-ttu-id="b3d29-119">которое содержит параметры конфигурации и управляет репликацией.</span><span class="sxs-lookup"><span data-stu-id="b3d29-119">The vault contains configuration settings, and orchestrates replication.</span></span>
6. <span data-ttu-id="b3d29-120">Укажите параметры источника.</span><span class="sxs-lookup"><span data-stu-id="b3d29-120">Specify source settings.</span></span> <span data-ttu-id="b3d29-121">Зарегистрируйте сервер VMM в хранилище.</span><span class="sxs-lookup"><span data-stu-id="b3d29-121">Register the VMM server in the vault.</span></span> <span data-ttu-id="b3d29-122">Установите поставщик Azure Site Recovery на сервере VMM, а также установите агент служб восстановления Майкрософт на узлах Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="b3d29-122">Install the Azure Site Recovery Provider on the VMM server Install the Microsoft Recovery Services agent on Hyper-V hosts.</span></span>
7. <span data-ttu-id="b3d29-123">Настройте параметры целевого объекта и репликации.</span><span class="sxs-lookup"><span data-stu-id="b3d29-123">Set up target and replication settings.</span></span>
8. <span data-ttu-id="b3d29-124">Включите репликацию для виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="b3d29-124">Enable replication for the VMs.</span></span>
9. <span data-ttu-id="b3d29-125">Запустите тестовую отработку отказа, чтобы убедиться в надлежащей работе всех компонентов.</span><span class="sxs-lookup"><span data-stu-id="b3d29-125">Run a test failover to make sure everything's working as expected.</span></span>



## <a name="prerequisites"></a><span data-ttu-id="b3d29-126">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="b3d29-126">Prerequisites</span></span>


<span data-ttu-id="b3d29-127">**Необходимая поддержка**</span><span class="sxs-lookup"><span data-stu-id="b3d29-127">**Support requirement**</span></span> | <span data-ttu-id="b3d29-128">**Дополнительные сведения**</span><span class="sxs-lookup"><span data-stu-id="b3d29-128">**Details**</span></span>
--- | ---
<span data-ttu-id="b3d29-129">**Таблицы Azure**</span><span class="sxs-lookup"><span data-stu-id="b3d29-129">**Azure**</span></span> | <span data-ttu-id="b3d29-130">Ознакомьтесь с [требованиями Azure](site-recovery-prereq.md#azure-requirements).</span><span class="sxs-lookup"><span data-stu-id="b3d29-130">Learn about [Azure requirements](site-recovery-prereq.md#azure-requirements).</span></span>
<span data-ttu-id="b3d29-131">**Локальные серверы**</span><span class="sxs-lookup"><span data-stu-id="b3d29-131">**On-premises servers**</span></span> | <span data-ttu-id="b3d29-132">[Ознакомьтесь](site-recovery-prereq.md#disaster-recovery-of-hyper-v-vms-in-vmm-clouds-to-azure) с требованиями к локальным серверам VMM и узлам Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="b3d29-132">[Learn more](site-recovery-prereq.md#disaster-recovery-of-hyper-v-vms-in-vmm-clouds-to-azure) about requirements for the on-premises VMM server and Hyper-V hosts.</span></span>
<span data-ttu-id="b3d29-133">**Локальные виртуальные машины Hyper-V**</span><span class="sxs-lookup"><span data-stu-id="b3d29-133">**On-premises Hyper-V VMs**</span></span> | <span data-ttu-id="b3d29-134">Виртуальные машины, которые необходимо реплицировать, должны работать под управлением [поддерживаемой операционной системы](site-recovery-support-matrix-to-azure.md#support-for-replicated-machine-os-versions) и соответствовать [предварительным требованиям Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).</span><span class="sxs-lookup"><span data-stu-id="b3d29-134">VMs you want to replicate should be running a [supported operating system](site-recovery-support-matrix-to-azure.md#support-for-replicated-machine-os-versions), and conform with [Azure prerequisites](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).</span></span>
<span data-ttu-id="b3d29-135">**URL-адреса Azure**</span><span class="sxs-lookup"><span data-stu-id="b3d29-135">**Azure URLs**</span></span> | <span data-ttu-id="b3d29-136">Сервер должен иметь доступ к этим URL-адресам:</span><span class="sxs-lookup"><span data-stu-id="b3d29-136">The VMM server needs access to these URLs:</span></span><br/><br/> [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]<br/><br/> <span data-ttu-id="b3d29-137">При использовании правил брандмауэра на основе IP-адресов убедитесь, что эти правила разрешают обмен данными с Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-137">If you have IP address-based firewall rules, ensure they allow communication to Azure.</span></span><br/></br> <span data-ttu-id="b3d29-138">Разрешите доступ для [диапазонов IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и использование порта HTTPS (443).</span><span class="sxs-lookup"><span data-stu-id="b3d29-138">Allow the [Azure Datacenter IP Ranges](https://www.microsoft.com/download/confirmation.aspx?id=41653), and the HTTPS (443) port.</span></span><br/></br> <span data-ttu-id="b3d29-139">Необходимо разрешить доступ для диапазонов IP-адресов региона Azure, в котором располагается ваша подписка, и региона "Западная часть США" (используется для контроля доступа и управления удостоверениями).</span><span class="sxs-lookup"><span data-stu-id="b3d29-139">Allow IP address ranges for the Azure region of your subscription, and for West US (used for Access Control and Identity Management).</span></span>


## <a name="prepare-for-deployment"></a><span data-ttu-id="b3d29-140">Подготовка к развертыванию</span><span class="sxs-lookup"><span data-stu-id="b3d29-140">Prepare for deployment</span></span>
<span data-ttu-id="b3d29-141">Чтобы подготовиться к развертыванию, необходимо сделать следующее:</span><span class="sxs-lookup"><span data-stu-id="b3d29-141">To prepare for deployment, you need to:</span></span>

1. <span data-ttu-id="b3d29-142">[Настроить сеть Azure](#set-up-an-azure-network) , в которой будут размещаться виртуальные машины Azure после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-142">[Set up an Azure network](#set-up-an-azure-network) in which Azure VMs will be located after failover.</span></span>
2. <span data-ttu-id="b3d29-143">[Настроить учетную запись хранения Azure](#set-up-an-azure-storage-account) для реплицированных данных.</span><span class="sxs-lookup"><span data-stu-id="b3d29-143">[Set up an Azure storage account](#set-up-an-azure-storage-account) for replicated data.</span></span>
3. <span data-ttu-id="b3d29-144">[Подготовить сервер VMM](#prepare-the-vmm-server) к развертыванию Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="b3d29-144">[Prepare the VMM server](#prepare-the-vmm-server) for Site Recovery deployment.</span></span>
4. <span data-ttu-id="b3d29-145">Подготовьтесь к сопоставлению сетей.</span><span class="sxs-lookup"><span data-stu-id="b3d29-145">Prepare for network mapping.</span></span> <span data-ttu-id="b3d29-146">Настройте сети, чтобы сопоставление сетей можно было настроить во время развертывания Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="b3d29-146">Set up networks so that you can configure network mapping during Site Recovery deployment.</span></span>

### <a name="set-up-an-azure-network"></a><span data-ttu-id="b3d29-147">Настроить сеть Azure</span><span class="sxs-lookup"><span data-stu-id="b3d29-147">Set up an Azure network</span></span>
<span data-ttu-id="b3d29-148">Вам потребуется сеть Azure, к которой будут подключаться виртуальные машины Azure, созданные после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-148">You need an Azure network to which Azure VMs created after failover will connect.</span></span>

* <span data-ttu-id="b3d29-149">Сеть должна располагаться в том же регионе, что и хранилище служб восстановления.</span><span class="sxs-lookup"><span data-stu-id="b3d29-149">The network should be in the same region as the Recovery Services vault.</span></span>
* <span data-ttu-id="b3d29-150">В зависимости от модели ресурсов, которую нужно использовать для виртуальных машин Azure после отработки отказа, для сети Azure необходимо настроить [режим Resource Manager](../virtual-network/virtual-networks-create-vnet-arm-pportal.md) или [классический режим](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).</span><span class="sxs-lookup"><span data-stu-id="b3d29-150">Depending on the resource model you want to use for failed over Azure VMs, you set up the Azure network in [Resource Manager mode](../virtual-network/virtual-networks-create-vnet-arm-pportal.md) or [classic mode](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).</span></span>
* <span data-ttu-id="b3d29-151">Рекомендуется настроить сеть перед началом работы.</span><span class="sxs-lookup"><span data-stu-id="b3d29-151">We recommend you set up a network before you begin.</span></span> <span data-ttu-id="b3d29-152">В противном случае это нужно будет сделать во время развертывания службы Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="b3d29-152">If you don't, you need to do it during Site Recovery deployment.</span></span>
<span data-ttu-id="b3d29-153">Сети Azure, используемые для Site Recovery, нельзя [перемещать](../azure-resource-manager/resource-group-move-resources.md) в одной подписке или между разными подписками.</span><span class="sxs-lookup"><span data-stu-id="b3d29-153">Azure networks used by Site Recovery can't be [moved](../azure-resource-manager/resource-group-move-resources.md) within the same, or across different, subscriptions.</span></span>

### <a name="set-up-an-azure-storage-account"></a><span data-ttu-id="b3d29-154">Настроить учетную запись хранения Azure</span><span class="sxs-lookup"><span data-stu-id="b3d29-154">Set up an Azure storage account</span></span>
* <span data-ttu-id="b3d29-155">Вам потребуется учетная запись хранения Azure уровня "Стандартный" или "Премиум", в которой будут сохраняться реплицированные в Azure данные. Для виртуальных машин, которым требуется постоянная высокая производительность ввода-вывода и малая задержка для размещения интенсивных рабочих нагрузок ввода-вывода, мы рекомендуем использовать [хранилище уровня "Премиум"](../storage/common/storage-premium-storage.md).</span><span class="sxs-lookup"><span data-stu-id="b3d29-155">You need a standard/premium Azure storage account to hold data replicated to Azure.[Premium storage](../storage/common/storage-premium-storage.md) is  used for virtual machines that need a consistently high IO performance, and low latency to host IO intensive workloads.</span></span> <span data-ttu-id="b3d29-156">Если для хранения реплицированных данных вы будете использовать учетную запись хранения класса Premium, потребуется дополнительная учетная запись хранения класса Standard для хранения журналов репликации, в которые записываются текущие изменения локальных данных.</span><span class="sxs-lookup"><span data-stu-id="b3d29-156">If you want to use a premium account to store replicated data, you also need a standard storage account to store replication logs that capture ongoing changes to on-premises data.</span></span> <span data-ttu-id="b3d29-157">Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления.</span><span class="sxs-lookup"><span data-stu-id="b3d29-157">The account must be in the same region as the Recovery Services vault.</span></span>
* <span data-ttu-id="b3d29-158">В зависимости от модели ресурсов, которую нужно использовать для виртуальных машин Azure после отработки отказа, для учетной записи необходимо настроить [режим Resource Manager](../storage/common/storage-create-storage-account.md) или [классический режим](../storage/common/storage-create-storage-account.md).</span><span class="sxs-lookup"><span data-stu-id="b3d29-158">Depending on the resource model you want to use for failed over Azure VMs, you set up an account in [Resource Manager mode](../storage/common/storage-create-storage-account.md) or [classic mode](../storage/common/storage-create-storage-account.md).</span></span>
* <span data-ttu-id="b3d29-159">Рекомендуется настроить учетную запись до начала работы.</span><span class="sxs-lookup"><span data-stu-id="b3d29-159">We recommend that you set up an account before you begin.</span></span> <span data-ttu-id="b3d29-160">В противном случае это нужно будет сделать во время развертывания службы Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="b3d29-160">If you don't, you need to do it during Site Recovery deployment.</span></span>
- <span data-ttu-id="b3d29-161">Обратите внимание, учетные записи хранения, используемые для Site Recovery, нельзя [перемещать](../azure-resource-manager/resource-group-move-resources.md) в одной подписке или между разными подписками.</span><span class="sxs-lookup"><span data-stu-id="b3d29-161">Note that storage accounts used by Site Recovery can't be [moved](../azure-resource-manager/resource-group-move-resources.md) within the same, or across different, subscriptions.</span></span>

### <a name="prepare-the-vmm-server"></a><span data-ttu-id="b3d29-162">Подготовить сервер VMM</span><span class="sxs-lookup"><span data-stu-id="b3d29-162">Prepare the VMM server</span></span>
* <span data-ttu-id="b3d29-163">Убедитесь, что сервер VMM соответствует [предварительным требованиям](#prerequisites).</span><span class="sxs-lookup"><span data-stu-id="b3d29-163">Make sure that the VMM server complies with the [prerequisites](#prerequisites).</span></span>
* <span data-ttu-id="b3d29-164">Во время развертывания службы Site Recovery можно указать, что все облака на сервере VMM должны быть доступны на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-164">During Site Recovery deployment, you can specify that all clouds on a VMM server should be available in the Azure portal.</span></span> <span data-ttu-id="b3d29-165">Если нужно, чтобы на портале отображались только определенные облака, соответствующий параметр можно включить в консоли администратора VMM.</span><span class="sxs-lookup"><span data-stu-id="b3d29-165">If you only want specific clouds to appear in the portal, you can enable that setting on the cloud in the VMM admin console.</span></span>

### <a name="prepare-for-network-mapping"></a><span data-ttu-id="b3d29-166">Подготовка к сопоставлению сетей</span><span class="sxs-lookup"><span data-stu-id="b3d29-166">Prepare for network mapping</span></span>
<span data-ttu-id="b3d29-167">Во время развертывания службы Site Recovery необходимо настроить сопоставление сетей.</span><span class="sxs-lookup"><span data-stu-id="b3d29-167">You must set up network mapping during Site Recovery deployment.</span></span> <span data-ttu-id="b3d29-168">Это позволит сопоставить исходные сети виртуальных машин VMM и целевые сети Azure, что предоставляет следующие возможности:</span><span class="sxs-lookup"><span data-stu-id="b3d29-168">Network mapping maps between source VMM VM networks and target Azure networks, to enable the following:</span></span>

* <span data-ttu-id="b3d29-169">Компьютеры, для которых отработка отказа выполняется в одной сети, могут подключаться друг к другу, даже если отработка отказа выполнялась по-разному или в рамках разных планов восстановления.</span><span class="sxs-lookup"><span data-stu-id="b3d29-169">Machines that fail over on the same network can connect to each other, even if they're not failed over in the same way or in the same recovery plan.</span></span>
* <span data-ttu-id="b3d29-170">При наличии сетевого шлюза в целевой сети Azure виртуальные машины могут подключиться к локальным виртуальным машинам.</span><span class="sxs-lookup"><span data-stu-id="b3d29-170">If a network gateway is set up on the target Azure network, Azure virtual machines can connect to on-premises virtual machines.</span></span>
* <span data-ttu-id="b3d29-171">Чтобы настроить сопоставление сетей, необходимо следующее.</span><span class="sxs-lookup"><span data-stu-id="b3d29-171">To set up network mapping, here's what you need:</span></span>

  * <span data-ttu-id="b3d29-172">Виртуальные машины на сервере узла Hyper-V должны быть подключены к сети виртуальных машин VMM.</span><span class="sxs-lookup"><span data-stu-id="b3d29-172">Make sure that VMs on the source Hyper-V host server are connected to a VMM VM network.</span></span> <span data-ttu-id="b3d29-173">Эта сеть должна быть подключена к логической сети, которая связана с облаком.</span><span class="sxs-lookup"><span data-stu-id="b3d29-173">That network should be linked to a logical network that is associated with the cloud.</span></span>
  * <span data-ttu-id="b3d29-174">Сеть Azure, как описано [выше](#set-up-an-azure-network)</span><span class="sxs-lookup"><span data-stu-id="b3d29-174">An Azure network as described [above](#set-up-an-azure-network)</span></span>

## <a name="create-a-recovery-services-vault"></a><span data-ttu-id="b3d29-175">Создание хранилища служб восстановления</span><span class="sxs-lookup"><span data-stu-id="b3d29-175">Create a Recovery Services vault</span></span>
1. <span data-ttu-id="b3d29-176">Войдите на [портал Azure](https://portal.azure.com).</span><span class="sxs-lookup"><span data-stu-id="b3d29-176">Sign in to the [Azure portal](https://portal.azure.com).</span></span>
2. <span data-ttu-id="b3d29-177">Щелкните **Создать** > **Мониторинг и управление** > **Резервное копирование и восстановление сайта**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-177">Click **New** > **Monitoring + Management** > **Backup and Site Recovery (OMS)**.</span></span>

    ![Новое хранилище](./media/site-recovery-vmm-to-azure/new-vault3.png)
3. <span data-ttu-id="b3d29-179">В поле **Имя**укажите понятное имя для идентификации хранилища.</span><span class="sxs-lookup"><span data-stu-id="b3d29-179">In **Name**, specify a friendly name to identify the vault.</span></span> <span data-ttu-id="b3d29-180">Если у вас имеется несколько подписок, выберите одну из них.</span><span class="sxs-lookup"><span data-stu-id="b3d29-180">If you have more than one subscription, select one of them.</span></span>
4. <span data-ttu-id="b3d29-181">[Создайте новую группу ресурсов](../azure-resource-manager/resource-group-template-deploy-portal.md) или выберите существующую.</span><span class="sxs-lookup"><span data-stu-id="b3d29-181">[Create a resource group](../azure-resource-manager/resource-group-template-deploy-portal.md), or select an existing one.</span></span> <span data-ttu-id="b3d29-182">Укажите регион Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-182">Specify an Azure region.</span></span> <span data-ttu-id="b3d29-183">В него будут реплицированы данные компьютеров.</span><span class="sxs-lookup"><span data-stu-id="b3d29-183">Machines will be replicated to this region.</span></span> <span data-ttu-id="b3d29-184">Сведения о поддерживаемых регионах см. в разделе "Географическая доступность" на странице [Расценки на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).</span><span class="sxs-lookup"><span data-stu-id="b3d29-184">To check supported regions see Geographic Availability in [Azure Site Recovery Pricing Details](https://azure.microsoft.com/pricing/details/site-recovery/)</span></span>
5. <span data-ttu-id="b3d29-185">Если вам нужно быстро получить доступ к хранилищу на панели мониторинга, щелкните **Закрепить на панели мониторинга** > **Создать хранилище**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-185">If you want to quickly access the vault from the Dashboard, click **Pin to dashboard** > **Create vault**.</span></span>

    ![Новое хранилище](./media/site-recovery-vmm-to-azure/new-vault.png)

<span data-ttu-id="b3d29-187">Новое хранилище появится в колонке **Панель мониторинга** > **Все ресурсы** и в основной колонке **Хранилища служб восстановления**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-187">The new vault appears on the **Dashboard** > **All resources**, and on the main **Recovery Services vaults** blade.</span></span>


## <a name="select-the-protection-goal"></a><span data-ttu-id="b3d29-188">Выбор целевого объекта защиты</span><span class="sxs-lookup"><span data-stu-id="b3d29-188">Select the protection goal</span></span>

<span data-ttu-id="b3d29-189">Выберите целевые объекты и место для репликации.</span><span class="sxs-lookup"><span data-stu-id="b3d29-189">Select what you want to replicate, and where you want to replicate to.</span></span>

1. <span data-ttu-id="b3d29-190">В колонке **Хранилища служб восстановления** выберите хранилище.</span><span class="sxs-lookup"><span data-stu-id="b3d29-190">In **Recovery Services vaults**, select the vault.</span></span>
2. <span data-ttu-id="b3d29-191">В области **Приступая к работе** щелкните **Site Recovery** > **Подготовка инфраструктуры** > **Цель защиты**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-191">In **Getting Started**, click **Site Recovery** > **Prepare Infrastructure** > **Protection goal**.</span></span>

    ![Выбор цели](./media/site-recovery-vmm-to-azure/choose-goals.png)
3. <span data-ttu-id="b3d29-193">На странице **Цель защиты** выберите **В Azure** и затем выберите **Да, с помощью Hyper-V**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-193">In **Protection goal** select **To Azure**, and select **Yes, with Hyper-V**.</span></span> <span data-ttu-id="b3d29-194">Выберите **Да** , чтобы подтвердить, что для управления узлами Hyper-V и сайтом восстановления используется VMM.</span><span class="sxs-lookup"><span data-stu-id="b3d29-194">Select **Yes** to confirm you're using VMM to manage Hyper-V hosts and the recovery site.</span></span> <span data-ttu-id="b3d29-195">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-195">Then click **OK**.</span></span>

## <a name="set-up-the-source-environment"></a><span data-ttu-id="b3d29-196">Настройка исходной среды</span><span class="sxs-lookup"><span data-stu-id="b3d29-196">Set up the source environment</span></span>

<span data-ttu-id="b3d29-197">Установите поставщик Azure Site Recovery на сервере VMM и зарегистрируйте сервер в хранилище.</span><span class="sxs-lookup"><span data-stu-id="b3d29-197">Install the Azure Site Recovery Provider on the VMM server, and register the server in the vault.</span></span> <span data-ttu-id="b3d29-198">Установите агент служб восстановления Azure на узлах Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="b3d29-198">Install the Azure Recovery Services agent on Hyper-V hosts.</span></span>

1. <span data-ttu-id="b3d29-199">Выберите **Подготовка инфраструктуры** > **Источник**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-199">Click **Prepare Infrastructure** > **Source**.</span></span>

    ![Настройка источника](./media/site-recovery-vmm-to-azure/set-source1.png)

2. <span data-ttu-id="b3d29-201">В поле **Подготовка источника** щелкните **+ VMM**, чтобы добавить сервер VMM.</span><span class="sxs-lookup"><span data-stu-id="b3d29-201">In **Prepare source**, click **+ VMM** to add a VMM server.</span></span>

    ![Настройка источника](./media/site-recovery-vmm-to-azure/set-source2.png)

3. <span data-ttu-id="b3d29-203">В колонке **Добавление сервера** убедитесь, что **сервер System Center VMM** появился в разделе **Тип сервера** и что он соответствует [предварительным требованиям и требованиям к URL-адресам](#prerequisites).</span><span class="sxs-lookup"><span data-stu-id="b3d29-203">In **Add Server**, check that **System Center VMM server** appears in **Server type** and that the VMM server meets the [prerequisites and URL requirements](#prerequisites).</span></span>
4. <span data-ttu-id="b3d29-204">Скачайте файл установки поставщика Azure Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="b3d29-204">Download the Azure Site Recovery Provider installation file.</span></span>
5. <span data-ttu-id="b3d29-205">Скачайте ключ регистрации.</span><span class="sxs-lookup"><span data-stu-id="b3d29-205">Download the registration key.</span></span> <span data-ttu-id="b3d29-206">Он потребуется при запуске программы установки.</span><span class="sxs-lookup"><span data-stu-id="b3d29-206">You need this when you run setup.</span></span> <span data-ttu-id="b3d29-207">Ключ действителен в течение пяти дней после создания.</span><span class="sxs-lookup"><span data-stu-id="b3d29-207">The key is valid for five days after you generate it.</span></span>

    ![Настройка источника](./media/site-recovery-vmm-to-azure/set-source3.png)


## <a name="install-the-provider-on-the-vmm-server"></a><span data-ttu-id="b3d29-209">Установка поставщика на сервер VMM</span><span class="sxs-lookup"><span data-stu-id="b3d29-209">Install the Provider on the VMM server</span></span>

1. <span data-ttu-id="b3d29-210">Запустите файл установки поставщика на сервере VMM.</span><span class="sxs-lookup"><span data-stu-id="b3d29-210">Run the Provider setup file on the VMM server.</span></span>
2. <span data-ttu-id="b3d29-211">Обновления можно включить на странице **Центр обновления Майкрософт**. Это позволит устанавливать обновления поставщика в соответствии с политикой Центра обновления Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="b3d29-211">In **Microsoft Update**, you can opt in for updates so that Provider updates are installed in accordance with your Microsoft Update policy.</span></span>
3. <span data-ttu-id="b3d29-212">На странице **Установка** примите или измените расположение установки поставщика по умолчанию и нажмите кнопку **Установить**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-212">In **Installation**, accept or modify the default Provider installation location and click **Install**.</span></span>

    ![Расположение установки](./media/site-recovery-vmm-to-azure/provider2.png)
4. <span data-ttu-id="b3d29-214">После установки щелкните **Зарегистрировать**, чтобы зарегистрировать сервер VMM в хранилище.</span><span class="sxs-lookup"><span data-stu-id="b3d29-214">When installation finishes, click **Register** to register the VMM server in the vault.</span></span>
5. <span data-ttu-id="b3d29-215">На странице **Параметры хранилища** нажмите кнопку **Обзор**, чтобы выбрать файл ключа хранилища.</span><span class="sxs-lookup"><span data-stu-id="b3d29-215">In the **Vault Settings** page, click **Browse** to select the vault key file.</span></span> <span data-ttu-id="b3d29-216">Укажите подписку Azure Site Recovery и имя хранилища.</span><span class="sxs-lookup"><span data-stu-id="b3d29-216">Specify the Azure Site Recovery subscription and the vault name.</span></span>

    ![Регистрация сервера](./media/site-recovery-vmm-to-azure/provider10.PNG)
6. <span data-ttu-id="b3d29-218">На странице **Подключение к Интернету**укажите, как запущенный на сервере VMM поставщик будет подключаться к Site Recovery через Интернет.</span><span class="sxs-lookup"><span data-stu-id="b3d29-218">In **Internet Connection**, specify how the Provider running on the VMM server will connect to Site Recovery over the internet.</span></span>

   * <span data-ttu-id="b3d29-219">Чтобы поставщик подключался напрямую, выберите **Подключиться к Azure Site Recovery напрямую без прокси-сервера**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-219">If you want the Provider to connect directly, select **Connect directly to Azure Site Recovery without a proxy**.</span></span>
   * <span data-ttu-id="b3d29-220">Если для имеющегося прокси-сервера требуется проверка подлинности или нужно использовать пользовательский прокси-сервер, выберите **Подключиться к Azure Site Recovery с использованием прокси-сервера**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-220">If your existing proxy requires authentication, or you want to use a custom proxy, select **Connect to Azure Site Recovery using a proxy server**.</span></span>
   * <span data-ttu-id="b3d29-221">При использовании пользовательского прокси-сервера необходимо указать адрес, порт и учетные данные.</span><span class="sxs-lookup"><span data-stu-id="b3d29-221">If you use a custom proxy, specify the address, port, and credentials.</span></span>
   * <span data-ttu-id="b3d29-222">Если прокси-сервер используется, скорее всего, вы уже разрешили использовать URL-адреса, описанные в разделе о [предварительных требованиях](#on-premises-prerequisites).</span><span class="sxs-lookup"><span data-stu-id="b3d29-222">If you're using a proxy, you should have already allowed the URLs described in [prerequisites](#on-premises-prerequisites).</span></span>
   * <span data-ttu-id="b3d29-223">При использовании настраиваемого прокси-сервера автоматически создается учетная запись запуска от имени VMM (DRAProxyAccount), использующая указанные учетные данные прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="b3d29-223">If you use a custom proxy, a VMM RunAs account (DRAProxyAccount) will be created automatically using the specified proxy credentials.</span></span> <span data-ttu-id="b3d29-224">Настройте прокси-сервер так, чтобы эта учетная запись могла успешно проходить проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="b3d29-224">Configure the proxy server so that this account can authenticate successfully.</span></span> <span data-ttu-id="b3d29-225">Параметры учетной записи запуска от имени VMM можно изменить в консоли VMM.</span><span class="sxs-lookup"><span data-stu-id="b3d29-225">The VMM RunAs account settings can be modified in the VMM console.</span></span> <span data-ttu-id="b3d29-226">В области **Параметры** разверните **Безопасность** > **Учетные записи запуска от имени**, а затем измените пароль для учетной записи DRAProxyAccount.</span><span class="sxs-lookup"><span data-stu-id="b3d29-226">In **Settings**, expand **Security** > **Run As Accounts**, and then modify the password for DRAProxyAccount.</span></span> <span data-ttu-id="b3d29-227">Чтобы параметры вступили в силу, потребуется перезапустить службу VMM.</span><span class="sxs-lookup"><span data-stu-id="b3d29-227">You’ll need to restart the VMM service so that this setting takes effect.</span></span>

     ![Интернет](./media/site-recovery-vmm-to-azure/provider13.PNG)
7. <span data-ttu-id="b3d29-229">Примите или измените расположение сертификата SSL, который создается автоматически для шифрования данных.</span><span class="sxs-lookup"><span data-stu-id="b3d29-229">Accept or modify the location of an SSL certificate that’s automatically generated for data encryption.</span></span> <span data-ttu-id="b3d29-230">Этот сертификат используется при включении шифрования данных для облачных сред, защищенных Azure, на портале Azure Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="b3d29-230">This certificate is used if you enable data encryption for a cloud protected by Azure in the Azure Site Recovery portal.</span></span> <span data-ttu-id="b3d29-231">Сертификат следует хранить в безопасном месте.</span><span class="sxs-lookup"><span data-stu-id="b3d29-231">Keep this certificate safe.</span></span> <span data-ttu-id="b3d29-232">При отработке отказа в Azure он понадобится для расшифровки, если включено шифрование данных.</span><span class="sxs-lookup"><span data-stu-id="b3d29-232">When you run a failover to Azure you’ll need it to decrypt, if data encryption is enabled.</span></span>

    > [!NOTE]
    > <span data-ttu-id="b3d29-233">Рекомендуется использовать функцию шифрования, предоставляемую Azure, для шифрования неактивных данных, а не функцию шифрования данных, предоставляемую Azure Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="b3d29-233">It is recommended to use the encryption capability provided by Azure for encrypting data at rest, instead of using the data encryption option provided by Azure Site Recovery.</span></span> <span data-ttu-id="b3d29-234">Предоставляемую Azure функцию шифрования можно включить для учетной записи хранения. Это поможет вам повысить производительность при операциях шифрования и расшифровки, обрабатываемых хранилищем Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-234">The encryption capability provided by Azure can be turned on for a storage      > account and helps achieve better performance as the encryption/decryption is handled by Azure storage.</span></span>
    > <span data-ttu-id="b3d29-235">См. дополнительные сведения о [шифровании службы хранилища в Azure](https://docs.microsoft.com/en-us/azure/storage/storage-service-encryption).</span><span class="sxs-lookup"><span data-stu-id="b3d29-235">[Learn more about Storage service encryption from Azure](https://docs.microsoft.com/en-us/azure/storage/storage-service-encryption).</span></span>
    
8. <span data-ttu-id="b3d29-236">В поле **Имя сервера**укажите понятное имя, описывающее сервер VMM в хранилище.</span><span class="sxs-lookup"><span data-stu-id="b3d29-236">In **Server name**, specify a friendly name to identify the VMM server in the vault.</span></span> <span data-ttu-id="b3d29-237">В конфигурации кластера укажите имя роли кластера VMM.</span><span class="sxs-lookup"><span data-stu-id="b3d29-237">In a cluster configuration, specify the VMM cluster role name.</span></span>
9. <span data-ttu-id="b3d29-238">Включите **синхронизацию метаданных в облаке**, если нужно синхронизировать метаданные для всех облаков сервера VMM в хранилище.</span><span class="sxs-lookup"><span data-stu-id="b3d29-238">Enable **Sync cloud metadata**, if you want to synchronize metadata for all clouds on the VMM server with the vault.</span></span> <span data-ttu-id="b3d29-239">На каждом сервере это действие требуется выполнять только один раз.</span><span class="sxs-lookup"><span data-stu-id="b3d29-239">This action only needs to happen once on each server.</span></span> <span data-ttu-id="b3d29-240">Если не требуется синхронизировать все облака, можно оставить этот флажок снятым и синхронизировать каждое облако индивидуально в свойствах облака в консоли VMM.</span><span class="sxs-lookup"><span data-stu-id="b3d29-240">If you don't want to synchronize all clouds, you can leave this setting unchecked and synchronize each cloud individually in the cloud properties in the VMM console.</span></span> <span data-ttu-id="b3d29-241">Для завершения процесса нажмите кнопку **Зарегистрировать** .</span><span class="sxs-lookup"><span data-stu-id="b3d29-241">Click **Register** to complete the process.</span></span>

    ![Регистрация сервера](./media/site-recovery-vmm-to-azure/provider16.PNG)
10. <span data-ttu-id="b3d29-243">Начнется процедура регистрации.</span><span class="sxs-lookup"><span data-stu-id="b3d29-243">Registration starts.</span></span> <span data-ttu-id="b3d29-244">После завершения регистрации сервер появится на вкладке **Site Recovery Infrastructure** (Инфраструктура Site Recovery) > **Серверы VMM**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-244">After registration finishes, the server is displayed in **Site Recovery Infrastructure** > **VMM Servers**.</span></span>


## <a name="install-the-azure-recovery-services-agent-on-hyper-v-hosts"></a><span data-ttu-id="b3d29-245">Установка агента служб восстановления Azure на узлах Hyper-V</span><span class="sxs-lookup"><span data-stu-id="b3d29-245">Install the Azure Recovery Services agent on Hyper-V hosts</span></span>

1. <span data-ttu-id="b3d29-246">После настройки поставщика нужно скачать файл установки для агента служб восстановления Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-246">After you've set up the Provider, you need to download the installation file for the Azure Recovery Services agent.</span></span> <span data-ttu-id="b3d29-247">Запустите программу установки на каждом сервере Hyper-V в облаке VMM.</span><span class="sxs-lookup"><span data-stu-id="b3d29-247">Run setup on each Hyper-V server in the VMM cloud.</span></span>

    ![Сайты Hyper-V](./media/site-recovery-vmm-to-azure/hyperv-agent1.png)
2. <span data-ttu-id="b3d29-249">В разделе **Проверка предварительных требований** нажмите кнопку **Далее**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-249">In **Prerequisites Check**, click **Next**.</span></span> <span data-ttu-id="b3d29-250">Все отсутствующие предварительные требования будут установлены автоматически.</span><span class="sxs-lookup"><span data-stu-id="b3d29-250">Any missing prerequisites will be automatically installed.</span></span>

    ![Предварительные требования для агента служб восстановления](./media/site-recovery-vmm-to-azure/hyperv-agent2.png)
3. <span data-ttu-id="b3d29-252">В разделе **Параметры установки** примите или измените место установки и расположение кэша.</span><span class="sxs-lookup"><span data-stu-id="b3d29-252">In **Installation Settings**, accept or modify the installation location, and the cache location.</span></span> <span data-ttu-id="b3d29-253">Можно настроить кэш на диске объемом от 5 ГБ. Однако рекомендуемый объем — не менее 600 ГБ.</span><span class="sxs-lookup"><span data-stu-id="b3d29-253">You can configure the cache on a drive that has at least 5 GB of storage available but we recommend a cache drive with 600 GB or more of free space.</span></span> <span data-ttu-id="b3d29-254">Нажмите **Install**(Установить).</span><span class="sxs-lookup"><span data-stu-id="b3d29-254">Then click **Install**.</span></span>
4. <span data-ttu-id="b3d29-255">После завершения установки нажмите кнопку **Закрыть** .</span><span class="sxs-lookup"><span data-stu-id="b3d29-255">After installation is complete, click **Close** to finish.</span></span>

    ![Регистрация агента служб восстановления Microsoft Azure](./media/site-recovery-vmm-to-azure/hyperv-agent3.png)

### <a name="command-line-installation"></a><span data-ttu-id="b3d29-257">Установка из командной строки</span><span class="sxs-lookup"><span data-stu-id="b3d29-257">Command line installation</span></span>
<span data-ttu-id="b3d29-258">Агент служб восстановления Microsoft Azure можно установить из командной строки, используя следующую команду:</span><span class="sxs-lookup"><span data-stu-id="b3d29-258">You can install the Microsoft Azure Recovery Services Agent from command line using the following command:</span></span>

     marsagentinstaller.exe /q /nu

### <a name="set-up-internet-proxy-access-to-site-recovery-from-hyper-v-hosts"></a><span data-ttu-id="b3d29-259">Настройка доступа прокси-сервера к Site Recovery через Интернет для узлов Hyper-V</span><span class="sxs-lookup"><span data-stu-id="b3d29-259">Set up internet proxy access to Site Recovery from Hyper-V hosts</span></span>

<span data-ttu-id="b3d29-260">Агенту служб восстановления на узлах Hyper-V требуется доступ к Azure через Интернет для репликации виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="b3d29-260">The Recovery Services agent running on Hyper-V hosts needs internet access to Azure for VM replication.</span></span> <span data-ttu-id="b3d29-261">Если доступ к Интернету осуществляется через прокси-сервер, настройте его так:</span><span class="sxs-lookup"><span data-stu-id="b3d29-261">If you're accessing the internet through a proxy, set it up as follows:</span></span>

1. <span data-ttu-id="b3d29-262">Откройте на узле Hyper-V оснастку MMC в службе архивации Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-262">Open the Microsoft Azure Backup MMC snap-in on the Hyper-V host.</span></span> <span data-ttu-id="b3d29-263">По умолчанию ярлык для службы архивации Microsoft Azure расположен на рабочем столе или в папке C:\Program Files\Microsoft Azure Recovery Services Agent\bin\wabadmin.</span><span class="sxs-lookup"><span data-stu-id="b3d29-263">By default, a shortcut for Microsoft Azure Backup is available on the desktop or in C:\Program Files\Microsoft Azure Recovery Services Agent\bin\wabadmin.</span></span>
2. <span data-ttu-id="b3d29-264">В оснастке щелкните **Изменить свойства**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-264">In the snap-in, click **Change Properties**.</span></span>
3. <span data-ttu-id="b3d29-265">На вкладке **Конфигурация прокси-сервера** укажите сведения о прокси-сервере.</span><span class="sxs-lookup"><span data-stu-id="b3d29-265">On the **Proxy Configuration** tab, specify proxy server information.</span></span>

    ![Регистрация агента служб восстановления Microsoft Azure](./media/site-recovery-vmm-to-azure/mars-proxy.png)
4. <span data-ttu-id="b3d29-267">Проверьте, может ли агент связаться с URL-адресами, описанными в разделе с [предварительными требованиями](#on-premises-prerequisites).</span><span class="sxs-lookup"><span data-stu-id="b3d29-267">Check that the agent can reach the URLs described in the [prerequisites](#on-premises-prerequisites).</span></span>

## <a name="set-up-the-target-environment"></a><span data-ttu-id="b3d29-268">Настройка целевой среды</span><span class="sxs-lookup"><span data-stu-id="b3d29-268">Set up the target environment</span></span>
<span data-ttu-id="b3d29-269">Укажите учетную запись хранения Azure для репликации и сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-269">Specify the Azure storage account to be used for replication, and the Azure network to which Azure VMs will connect after failover.</span></span>

1. <span data-ttu-id="b3d29-270">Щелкните **Подготовка инфраструктуры** > **Цель**, выберите подписку и группу ресурсов, в которых вы хотите создавать виртуальные машины при отработке отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-270">Click **Prepare infrastructure** > **Target**, select the subscription and the resource group where you want to create the failed over virtual machines.</span></span> <span data-ttu-id="b3d29-271">Выберите модель развертывания, которая будет использоваться в Azure (классическая или Resource Manager) для виртуальных машин после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-271">Choose the deployment model that you want to use in Azure (classic or resource management) for the failed over virtual machines.</span></span>

    ![Хранилище](./media/site-recovery-vmm-to-azure/enablerep3.png)

2. <span data-ttu-id="b3d29-273">Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-273">Site Recovery checks that you have one or more compatible Azure storage accounts and networks.</span></span>

    ![Хранилище](./media/site-recovery-vmm-to-azure/compatible-storage.png)

3. <span data-ttu-id="b3d29-275">Если учетная запись хранения еще не создана и ее нужно создать с помощью Resource Manager, щелкните **+Storage account** (+ Учетная запись хранения).</span><span class="sxs-lookup"><span data-stu-id="b3d29-275">If you haven't created a storage account, and you want to create one using Resource Manager, click **+Storage account** to do that inline.</span></span>  <span data-ttu-id="b3d29-276">В колонке **Создание учетной записи хранения** укажите имя, тип, подписку и расположение учетной записи.</span><span class="sxs-lookup"><span data-stu-id="b3d29-276">On the **Create storage account** blade specify an account name, type, subscription, and location.</span></span> <span data-ttu-id="b3d29-277">Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления.</span><span class="sxs-lookup"><span data-stu-id="b3d29-277">The account should be in the same location as the Recovery Services vault.</span></span>

   ![Хранилище](./media/site-recovery-vmm-to-azure/gs-createstorage.png)


   * <span data-ttu-id="b3d29-279">Если нужно создать учетную запись хранения, используя классическую модель, это можно сделать на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-279">If you want to create a storage account using the classic model, do that in the Azure portal.</span></span> [<span data-ttu-id="b3d29-280">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="b3d29-280">Learn more</span></span>](../storage/common/storage-create-storage-account.md)
   * <span data-ttu-id="b3d29-281">Если для реплицированных данных используется учетная запись хранения класса "Премиум", потребуется настроить дополнительную учетную запись хранения класса "Стандартный" для хранения журналов репликации, в которых фиксируются текущие изменения локальных данных.</span><span class="sxs-lookup"><span data-stu-id="b3d29-281">If you’re using a premium storage account for replicated data, set up an additional standard storage account, to store replication logs that capture ongoing changes to on-premises data.</span></span>
5. <span data-ttu-id="b3d29-282">Если сеть Azure еще не создана и ее нужно создать с помощью Resource Manager, щелкните **+Network** (+ Сеть), чтобы сделать это в процессе настройки.</span><span class="sxs-lookup"><span data-stu-id="b3d29-282">If you haven't created an Azure network, and you want to create one using Resource Manager, click **+Network** to do that inline.</span></span> <span data-ttu-id="b3d29-283">В колонке **Создание виртуальной сети** укажите имя, диапазон адресов, сведения о подсетях, подписку и расположение сети.</span><span class="sxs-lookup"><span data-stu-id="b3d29-283">On the **Create virtual network** blade specify a network name, address range, subnet details, subscription, and location.</span></span> <span data-ttu-id="b3d29-284">Сеть должна располагаться в том же регионе, что и хранилище служб восстановления.</span><span class="sxs-lookup"><span data-stu-id="b3d29-284">The network should be in the same location as the Recovery Services vault.</span></span>

   ![Сеть](./media/site-recovery-vmm-to-azure/gs-createnetwork.png)

   <span data-ttu-id="b3d29-286">Если нужно создать сеть, используя классическую модель, это можно сделать на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-286">If you want to create a network using the classic model, do that in the Azure portal.</span></span> <span data-ttu-id="b3d29-287">[Подробнее](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).</span><span class="sxs-lookup"><span data-stu-id="b3d29-287">[Learn more](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).</span></span>

### <a name="configure-network-mapping"></a><span data-ttu-id="b3d29-288">Настройка сетевого сопоставления</span><span class="sxs-lookup"><span data-stu-id="b3d29-288">Configure network mapping</span></span>

* <span data-ttu-id="b3d29-289">[Прочтите](#prepare-for-network-mapping) краткий обзор сопоставления сетей.</span><span class="sxs-lookup"><span data-stu-id="b3d29-289">[Read](#prepare-for-network-mapping) a quick overview of what network mapping does.</span></span>
* <span data-ttu-id="b3d29-290">Проверьте, подключены ли виртуальные машины на сервере VMM к сети виртуальной машины и создана ли по крайней мере одна виртуальная сеть Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-290">Verify that virtual machines on the VMM server are connected to a VM network, and that you've created at least one Azure virtual network.</span></span> <span data-ttu-id="b3d29-291">Несколько сетей виртуальных машин можно сопоставить с одной сетью Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-291">Multiple VM networks can be mapped to a single Azure network.</span></span>

<span data-ttu-id="b3d29-292">Настройте сопоставление следующим образом:</span><span class="sxs-lookup"><span data-stu-id="b3d29-292">Configure mapping as follows:</span></span>

1. <span data-ttu-id="b3d29-293">Выберите **Site Recovery Infrastructure** (Инфраструктура Site Recovery) > **Сетевые сопоставления** > **Сетевое сопоставление** и щелкните значок **+Network Mapping** (+Сетевое сопоставление).</span><span class="sxs-lookup"><span data-stu-id="b3d29-293">In **Site Recovery Infrastructure** > **Network mappings** > **Network Mapping**, click the **+Network Mapping** icon.</span></span>

    ![Сетевое сопоставление](./media/site-recovery-vmm-to-azure/network-mapping1.png)
2. <span data-ttu-id="b3d29-295">В разделе **Добавление сетевого сопоставления** выберите исходный сервер VMM, а в качестве целевого сервера — **Azure**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-295">In **Add network mapping**, select the source VMM server, and **Azure** as the target.</span></span>
3. <span data-ttu-id="b3d29-296">Проверьте подписку и модель развертывания после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-296">Verify the subscription and the deployment model after failover.</span></span>
4. <span data-ttu-id="b3d29-297">На странице **Исходная сеть**в списке, связанном с сервером VMM, выберите исходную сеть локальной виртуальной машины, которую нужно сопоставить.</span><span class="sxs-lookup"><span data-stu-id="b3d29-297">In **Source network**, select the source on-premises VM network you want to map from the list associated with the VMM server.</span></span>
5. <span data-ttu-id="b3d29-298">На странице **Целевая сеть**выберите сеть Azure, в которой будут размещены реплицированные виртуальные машины Azure после создания.</span><span class="sxs-lookup"><span data-stu-id="b3d29-298">In **Target network**, select the Azure network in which replica Azure VMs will be located when they're created.</span></span> <span data-ttu-id="b3d29-299">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-299">Then click **OK**.</span></span>

    ![Сетевое сопоставление](./media/site-recovery-vmm-to-azure/network-mapping2.png)

<span data-ttu-id="b3d29-301">Когда начинается сопоставление сетей, происходит следующее:</span><span class="sxs-lookup"><span data-stu-id="b3d29-301">Here's what happens when network mapping begins:</span></span>

* <span data-ttu-id="b3d29-302">При запуске сопоставления существующие виртуальные машины в исходной сети виртуальных машин подключаются к целевой сети.</span><span class="sxs-lookup"><span data-stu-id="b3d29-302">Existing VMs on the source VM network are connected to the target network when mapping begins.</span></span> <span data-ttu-id="b3d29-303">Новые виртуальные машины, подключенные к исходной сети виртуальных машин, будут подключены к сопоставленной сети Azure после репликации.</span><span class="sxs-lookup"><span data-stu-id="b3d29-303">New VMs connected to the source VM network are connected to the mapped Azure network when replication occurs.</span></span>
* <span data-ttu-id="b3d29-304">Если изменить имеющееся сопоставление сетей, реплики виртуальных машин подключаются с новыми параметрами.</span><span class="sxs-lookup"><span data-stu-id="b3d29-304">If you modify an existing network mapping, replica virtual machines connect using the new settings.</span></span>
* <span data-ttu-id="b3d29-305">Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то реплика виртуальной машины подключается к этой целевой подсети после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-305">If the target network has multiple subnets, and one of those subnets has the same name as subnet on which the source virtual machine is located, then the replica virtual machine connects to that target subnet after failover.</span></span>
* <span data-ttu-id="b3d29-306">Если подсети с таким же именем отсутствуют, виртуальная машина подключается к первой подсети в сети.</span><span class="sxs-lookup"><span data-stu-id="b3d29-306">If there’s no target subnet with a matching name, the virtual machine connects to the first subnet in the network.</span></span>

## <a name="configure-replication-settings"></a><span data-ttu-id="b3d29-307">Настройка параметров репликации</span><span class="sxs-lookup"><span data-stu-id="b3d29-307">Configure replication settings</span></span>
1. <span data-ttu-id="b3d29-308">Чтобы создать политику репликации, выберите **Подготовка инфраструктуры** > **Параметры репликации** > **Создание и связывание**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-308">To create a new replication policy, click **Prepare infrastructure** > **Replication Settings** > **+Create and associate**.</span></span>

    ![Сеть](./media/site-recovery-vmm-to-azure/gs-replication.png)
2. <span data-ttu-id="b3d29-310">На странице **Создать и связать политику**укажите имя политики.</span><span class="sxs-lookup"><span data-stu-id="b3d29-310">In **Create and associate policy**, specify a policy name.</span></span>
3. <span data-ttu-id="b3d29-311">В раскрывающемся списке **Частота копирования**выберите периодичность репликации изменений данных после начальной репликации (каждые 30 секунд, 5 или 15 минут).</span><span class="sxs-lookup"><span data-stu-id="b3d29-311">In **Copy frequency**, specify how often you want to replicate delta data after the initial replication (every 30 seconds, 5 or 15 minutes).</span></span>

    > [!NOTE]
    >  <span data-ttu-id="b3d29-312">Частота 30 секунд не поддерживается при репликации в хранилище класса Premium.</span><span class="sxs-lookup"><span data-stu-id="b3d29-312">A 30 second frequency isn't supported when replicating to premium storage.</span></span> <span data-ttu-id="b3d29-313">Это связано с ограничением в 100 моментальных снимков на большой двоичный объект, которые можно сохранить в хранилище уровня "Премиум".</span><span class="sxs-lookup"><span data-stu-id="b3d29-313">The limitation is determined by the number of snapshots per blob (100) supported by premium storage.</span></span> [<span data-ttu-id="b3d29-314">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="b3d29-314">Learn more</span></span>](../storage/common/storage-premium-storage.md#snapshots-and-copy-blob)

4. <span data-ttu-id="b3d29-315">В поле **Хранение точки восстановления**укажите продолжительность периода хранения для каждой точки восстановления (в часах).</span><span class="sxs-lookup"><span data-stu-id="b3d29-315">In **Recovery point retention**, specify in hours how long the retention window will be for each recovery point.</span></span> <span data-ttu-id="b3d29-316">Защищенные компьютеры будут восстанавливаться до любой точки в пределах этого периода.</span><span class="sxs-lookup"><span data-stu-id="b3d29-316">Protected machines can be recovered to any point within a window.</span></span>
5. <span data-ttu-id="b3d29-317">В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, как часто (от 1 до 12 часов) будут создаваться точки восстановления, содержащие согласованные с приложениями моментальные снимки.</span><span class="sxs-lookup"><span data-stu-id="b3d29-317">In **App-consistent snapshot frequency**, specify how frequently (1-12 hours) recovery points containing application-consistent snapshots will be created.</span></span> <span data-ttu-id="b3d29-318">Hyper-V использует два типа резервного копирования: стандартное резервное копирование, обеспечивающее создание добавочных резервных копий всей виртуальной машины, и соответствующие приложению моментальные снимки, обеспечивающие создание моментального снимка данных приложений в виртуальной машине на момент времени.</span><span class="sxs-lookup"><span data-stu-id="b3d29-318">Hyper-V uses two types of snapshots — a standard snapshot that provides an incremental snapshot of the entire virtual machine, and an application-consistent snapshot that takes a point-in-time snapshot of the application data inside the virtual machine.</span></span> <span data-ttu-id="b3d29-319">Функция моментальных снимков, соответствующих приложению, использует службу теневого копирования томов (VSS), чтобы гарантировать согласованное состояние приложений на момент создания снимка.</span><span class="sxs-lookup"><span data-stu-id="b3d29-319">Application-consistent snapshots use Volume Shadow Copy Service (VSS) to ensure that applications are in a consistent state when the snapshot is taken.</span></span> <span data-ttu-id="b3d29-320">Примечание. Включение моментальных снимков, соответствующих приложению, влияет на производительность приложений, выполняющихся на исходных виртуальных машинах.</span><span class="sxs-lookup"><span data-stu-id="b3d29-320">Note that if you enable application-consistent snapshots, it will affect the performance of applications running on source virtual machines.</span></span> <span data-ttu-id="b3d29-321">Заданное значение должно быть меньше числа настроенных дополнительных точек восстановления.</span><span class="sxs-lookup"><span data-stu-id="b3d29-321">Ensure that the value you set is less than the number of additional recovery points you configure.</span></span>
6. <span data-ttu-id="b3d29-322">Укажите необходимые данные в поле **Время запуска начальной репликации**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-322">In **Initial replication start time**, indicate when to start the initial replication.</span></span> <span data-ttu-id="b3d29-323">При репликации используется полоса пропускания Интернета. Поэтому проведение репликации нужно запланировать на свободное от работы время.</span><span class="sxs-lookup"><span data-stu-id="b3d29-323">The replication occurs over your internet bandwidth so you might want to schedule it outside your busy hours.</span></span>
7. <span data-ttu-id="b3d29-324">В области **Шифровать данные, хранящиеся в Azure**нажмите соответствующую кнопку.</span><span class="sxs-lookup"><span data-stu-id="b3d29-324">In **Encrypt data stored on Azure**, specify whether to encrypt at rest data in Azure storage.</span></span> <span data-ttu-id="b3d29-325">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-325">Then click **OK**.</span></span>

    ![Политика репликации](./media/site-recovery-vmm-to-azure/gs-replication2.png)
8. <span data-ttu-id="b3d29-327">При создании политики она автоматически сопоставляется с облаком VMM.</span><span class="sxs-lookup"><span data-stu-id="b3d29-327">When you create a new policy it's automatically associated with the VMM cloud.</span></span> <span data-ttu-id="b3d29-328">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-328">Click **OK**.</span></span> <span data-ttu-id="b3d29-329">С этой политикой репликации можно сопоставить дополнительные облака VMM (и виртуальные машины, содержащиеся в них). Для этого выберите **Репликация** > имя политики > **Associate VMM Cloud** (Сопоставить облако VMM).</span><span class="sxs-lookup"><span data-stu-id="b3d29-329">You can associate additional VMM clouds (and the VMs in them) with this replication policy in **Replication** > policy name > **Associate VMM Cloud**.</span></span>

    ![Политика репликации](./media/site-recovery-vmm-to-azure/policy-associate.png)

## <a name="capacity-planning"></a><span data-ttu-id="b3d29-331">Планирование загрузки</span><span class="sxs-lookup"><span data-stu-id="b3d29-331">Capacity planning</span></span>

<span data-ttu-id="b3d29-332">Теперь после настройки базовой инфраструктуры можно начать планирование ресурсов и выяснить, нужны ли дополнительные ресурсы.</span><span class="sxs-lookup"><span data-stu-id="b3d29-332">Now that you have your basic infrastructure set up, think about capacity planning, and figure out whether you need additional resources.</span></span>

<span data-ttu-id="b3d29-333">Планировщик ресурсов Site Recovery позволяет выделить нужные ресурсы для исходной среды, компонентов Site Recovery, сети и хранилища с помощью планировщика ресурсов.</span><span class="sxs-lookup"><span data-stu-id="b3d29-333">Site Recovery provides a capacity planner to help you allocate the right resources for your source environment, Site Recovery components, networking, and storage.</span></span> <span data-ttu-id="b3d29-334">Планировщик можно запустить в быстром режиме, чтобы получить оценку на основе среднего числа виртуальных машин и дисков, а также среднего объема хранилища, или в подробном режиме, в котором необходимо вводить показатели на уровне рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="b3d29-334">You can run the planner in quick mode for estimations based on an average number of VMs, disks, and storage, or in detailed mode in which you input figures at the workload level.</span></span> <span data-ttu-id="b3d29-335">Перед началом работы:</span><span class="sxs-lookup"><span data-stu-id="b3d29-335">Before you start:</span></span>

* <span data-ttu-id="b3d29-336">Соберите сведения о среде репликации, включая информацию о виртуальных машинах, количестве дисков на виртуальную машину и объеме хранилища на диск.</span><span class="sxs-lookup"><span data-stu-id="b3d29-336">Gather information about your replication environment, including VMs, disks per VMs, and storage per disk.</span></span>
* <span data-ttu-id="b3d29-337">Определите частоту ежедневных изменений (обновлений) реплицированных данных.</span><span class="sxs-lookup"><span data-stu-id="b3d29-337">Estimate the daily change (churn) rate you’ll have for replicated data.</span></span> <span data-ttu-id="b3d29-338">Для этого можно воспользоваться [планировщиком ресурсов для реплики Hyper-V](https://www.microsoft.com/download/details.aspx?id=39057) .</span><span class="sxs-lookup"><span data-stu-id="b3d29-338">You can use the [Capacity planner for Hyper-V Replica](https://www.microsoft.com/download/details.aspx?id=39057) to help you do this.</span></span>

1. <span data-ttu-id="b3d29-339">Щелкните **Скачать**, чтобы скачать этот инструмент, и запустите его.</span><span class="sxs-lookup"><span data-stu-id="b3d29-339">Click **Download**, to download the tool and then run it.</span></span> <span data-ttu-id="b3d29-340">Сведения об этом инструменте см. в [этой статье](site-recovery-capacity-planner.md).</span><span class="sxs-lookup"><span data-stu-id="b3d29-340">[Read the article](site-recovery-capacity-planner.md) that accompanies the tool.</span></span>
2. <span data-ttu-id="b3d29-341">После этого в поле **Have you run the Capacity Planner?** (Вы запустили планировщик ресурсов?) выберите **Да**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-341">When you’re done, select **Yes** in **Have you run the Capacity Planner**?</span></span>

   ![Планирование загрузки](./media/site-recovery-vmm-to-azure/gs-capacity-planning.png)

   <span data-ttu-id="b3d29-343">См. дополнительные сведения об [управлении пропускной способностью сети](#network-bandwidth-considerations).</span><span class="sxs-lookup"><span data-stu-id="b3d29-343">Learn more about [controlling network bandwidth](#network-bandwidth-considerations)</span></span>




## <a name="enable-replication"></a><span data-ttu-id="b3d29-344">Включение репликации</span><span class="sxs-lookup"><span data-stu-id="b3d29-344">Enable replication</span></span>

<span data-ttu-id="b3d29-345">Прежде чем начать, убедитесь, что учетная запись пользователя Azure содержит [разрешения](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines), необходимые для включения репликации новой виртуальной машины в Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-345">Before you start, ensure that your Azure user account has the required  [permissions](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines) to enable replication of a new virtual machine to Azure.</span></span>

<span data-ttu-id="b3d29-346">Включите репликацию следующим образом:</span><span class="sxs-lookup"><span data-stu-id="b3d29-346">Now enable replication as follows:</span></span>

1. <span data-ttu-id="b3d29-347">Последовательно выберите **Шаг 2. Репликация приложения** > **Источник**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-347">Click **Step 2: Replicate application** > **Source**.</span></span> <span data-ttu-id="b3d29-348">Включив репликацию впервые, щелкните **+Replicate** (+ Реплицировать) в хранилище, чтобы включить репликацию для дополнительных машин.</span><span class="sxs-lookup"><span data-stu-id="b3d29-348">After you've enabled replication for the first time, click **+Replicate** in the vault to enable replication for additional machines.</span></span>

    ![Включение репликации](./media/site-recovery-vmm-to-azure/enable-replication1.png)
2. <span data-ttu-id="b3d29-350">В колонке **Источник** выберите сервер VMM и облако, в котором находятся узлы Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="b3d29-350">In the **Source** blade, select the VMM server, and the cloud in which the Hyper-V hosts are located.</span></span> <span data-ttu-id="b3d29-351">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-351">Then click **OK**.</span></span>

    ![Включение репликации](./media/site-recovery-vmm-to-azure/enable-replication-source.png)
3. <span data-ttu-id="b3d29-353">В колонке **Цель** выберите подписку, модель развертывания после отработки отказа и учетную запись хранения, используемую для реплицируемых данных.</span><span class="sxs-lookup"><span data-stu-id="b3d29-353">In **Target**, select the subscription, post-failover deployment model, and the storage account you're using for replicated data.</span></span>

    ![Включение репликации](./media/site-recovery-vmm-to-azure/enable-replication-target.png)
4. <span data-ttu-id="b3d29-355">Выберите учетную запись хранения, которую нужно использовать.</span><span class="sxs-lookup"><span data-stu-id="b3d29-355">Select the storage account you want to use.</span></span> <span data-ttu-id="b3d29-356">Если вам нужна другая учетная запись хранения, [создайте ее](#set-up-an-azure-storage-account).</span><span class="sxs-lookup"><span data-stu-id="b3d29-356">If you want to use a different storage account than those you have, you can [create one](#set-up-an-azure-storage-account).</span></span> <span data-ttu-id="b3d29-357">Если для реплицированных данных используется учетная запись хранения "Премиум", потребуется настроить дополнительную учетную запись хранения уровня "Стандартный" для хранения журналов репликации, в которых фиксируются текущие изменения локальных данных. Чтобы создать учетную запись хранения с помощью модели Resource Manager, щелкните **Создать**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-357">If you’re using a premium storage account for replicated data, you need to select  an additional standard storage account to store replication logs that capture ongoing changes to on-premises data.To create a storage account using the Resource Manager model click **Create new**.</span></span> <span data-ttu-id="b3d29-358">Если нужно создать учетную запись хранения, используя классическую модель, это можно сделать на [портале Azure](../storage/common/storage-create-storage-account.md).</span><span class="sxs-lookup"><span data-stu-id="b3d29-358">If you want to create a storage account using the classic model, do that [in the Azure portal](../storage/common/storage-create-storage-account.md).</span></span> <span data-ttu-id="b3d29-359">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-359">Then click **OK**.</span></span>
5. <span data-ttu-id="b3d29-360">Выберите сеть и подсеть Azure, к которой будут подключаться виртуальные машины Azure, созданные после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-360">Select the Azure network and subnet to which Azure VMs will connect, when they're created after failover.</span></span> <span data-ttu-id="b3d29-361">Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым машинам.</span><span class="sxs-lookup"><span data-stu-id="b3d29-361">Select **Configure now for selected machines**, to apply the network setting to all machines you select for protection.</span></span> <span data-ttu-id="b3d29-362">Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждой машины.</span><span class="sxs-lookup"><span data-stu-id="b3d29-362">Select **Configure later**, to select the Azure network per machine.</span></span> <span data-ttu-id="b3d29-363">Если нужна другая сеть, [создайте ее](#set-up-an-azure-network).</span><span class="sxs-lookup"><span data-stu-id="b3d29-363">If you want to use a different network from those you have, you can [create one](#set-up-an-azure-network).</span></span> <span data-ttu-id="b3d29-364">Чтобы создать сеть с использованием модели Resource Manager, щелкните **Создать**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-364">To create a network using the Resource Manager model click **Create new**.</span></span> <span data-ttu-id="b3d29-365">Если нужно создать сеть, используя классическую модель, это можно сделать [на портале Azure](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).</span><span class="sxs-lookup"><span data-stu-id="b3d29-365">If you want to create a network using the classic model, do that [in the Azure portal](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).</span></span> <span data-ttu-id="b3d29-366">Выберите подсеть (если это применимо).</span><span class="sxs-lookup"><span data-stu-id="b3d29-366">Select a subnet if applicable.</span></span> <span data-ttu-id="b3d29-367">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-367">Then click **OK**.</span></span>
6. <span data-ttu-id="b3d29-368">В разделе **Виртуальные машины** > **Выбор виртуальных машин**, выберите каждую машину, которую нужно реплицировать.</span><span class="sxs-lookup"><span data-stu-id="b3d29-368">In **Virtual Machines** > **Select virtual machines**, click and select each machine you want to replicate.</span></span> <span data-ttu-id="b3d29-369">Можно выбрать только те компьютеры, для которых можно включить репликацию.</span><span class="sxs-lookup"><span data-stu-id="b3d29-369">You can only select machines for which replication can be enabled.</span></span> <span data-ttu-id="b3d29-370">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-370">Then click **OK**.</span></span>

    ![Включение репликации](./media/site-recovery-vmm-to-azure/enable-replication5.png)

7. <span data-ttu-id="b3d29-372">В поле **Свойства** > **Настройка свойств**, выберите операционную систему для выбранных виртуальных машин и диск операционной системы.</span><span class="sxs-lookup"><span data-stu-id="b3d29-372">In **Properties** > **Configure properties**, select the operating system for the selected VMs, and the OS disk.</span></span>

    - <span data-ttu-id="b3d29-373">Убедитесь, что имя виртуальной машины Azure (имя целевого объекта) соответствует [требованиям к виртуальным машинам Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).</span><span class="sxs-lookup"><span data-stu-id="b3d29-373">Verify that the Azure VM name (target name) complies with [Azure virtual machine requirements](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).</span></span>   
    - <span data-ttu-id="b3d29-374">По умолчанию для репликации выбраны все диски виртуальной машины, но вы можете исключить отдельные диски, сняв с них выделение.</span><span class="sxs-lookup"><span data-stu-id="b3d29-374">By default all the disks of the VM are selected for replication, but you can clear disks to exclude them.</span></span>

        - <span data-ttu-id="b3d29-375">Исключение некоторых дисков позволит снизить связанную с репликацией нагрузку на сеть.</span><span class="sxs-lookup"><span data-stu-id="b3d29-375">You might want to exclude disks to reduce replication bandwidth.</span></span> <span data-ttu-id="b3d29-376">Например, репликация может не требоваться для дисков с временными данными или данными, которые обновляются при каждом перезапуске виртуальной машины или приложения (например, для файлов pagefile.sys или базы данных tempdb Microsoft SQL Server).</span><span class="sxs-lookup"><span data-stu-id="b3d29-376">For example, you might not want to replicate disks with temporary data, or data that's refreshed each time a machine or apps restarts (such as pagefile.sys or Microsoft SQL Server tempdb).</span></span> <span data-ttu-id="b3d29-377">Чтобы исключить диск из репликации, достаточно отменить его выбор.</span><span class="sxs-lookup"><span data-stu-id="b3d29-377">You can exclude the disk from replication by unselecting the disk.</span></span>
        - <span data-ttu-id="b3d29-378">Исключать можно только базовые диски.</span><span class="sxs-lookup"><span data-stu-id="b3d29-378">Only basic disks can be exclude.</span></span> <span data-ttu-id="b3d29-379">Нельзя исключить диски операционной системы.</span><span class="sxs-lookup"><span data-stu-id="b3d29-379">You can't exclude OS disks.</span></span>
        - <span data-ttu-id="b3d29-380">Мы не рекомендуем исключать динамические диски.</span><span class="sxs-lookup"><span data-stu-id="b3d29-380">We recommend that you don't exclude dynamic disks.</span></span> <span data-ttu-id="b3d29-381">Site Recovery не может определить тип виртуального жесткого диска (базовый или динамический) в гостевой виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="b3d29-381">Site Recovery can't identify whether a virtual hard disk inside a guest VM is basic or dynamic.</span></span> <span data-ttu-id="b3d29-382">Если все зависимые динамические диски не исключены, то при отработке отказа виртуальной машины защищенный динамический диск будет считаться неисправным и данные на нем будут недоступны.</span><span class="sxs-lookup"><span data-stu-id="b3d29-382">If all dependent dynamic volume disks aren't excluded, the protected dynamic disk will show as a failed disk when the VM fails over, and the data on that disk won't be accessible.</span></span>
        - <span data-ttu-id="b3d29-383">После включения репликации добавить или удалить диски для репликации нельзя.</span><span class="sxs-lookup"><span data-stu-id="b3d29-383">After replication is enabled, you can't add or remove disks for replication.</span></span> <span data-ttu-id="b3d29-384">Если вы хотите добавить или исключить диск, перед внесением изменений отключите защиту виртуальной машины, а затем включите ее повторно.</span><span class="sxs-lookup"><span data-stu-id="b3d29-384">If you want to add or exclude a disk, you need to disable protection for the VM, and then re-enable it.</span></span>
        - <span data-ttu-id="b3d29-385">Диски, созданные в Azure вручную, не будут восстановлены в исходном расположении.</span><span class="sxs-lookup"><span data-stu-id="b3d29-385">Disks you create manually in Azure aren't failed back.</span></span> <span data-ttu-id="b3d29-386">Например, если вы выполните отработку отказа трех дисков и создадите два диска непосредственно на виртуальной машине Azure, восстановление размещения из Azure в Hyper-V будет выполнено только для трех дисков, задействованных при отработке отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-386">For example, if you fail over three disks, and create two directly in Azure VM, only the three disks which were failed over will be failed back from Azure to Hyper-V.</span></span> <span data-ttu-id="b3d29-387">Восстановление размещения после сбоя и обратная репликация из Hyper-V в Azure недоступны для дисков, созданных вручную.</span><span class="sxs-lookup"><span data-stu-id="b3d29-387">You can't include disks created manually in failback, or in reverse replication from Hyper-V to Azure.</span></span>
        - <span data-ttu-id="b3d29-388">Если вы исключили диск, необходимый для работы приложения, для выполнения реплицируемого приложения после отработки отказа в Azure вам необходимо будет создать его в Azure вручную.</span><span class="sxs-lookup"><span data-stu-id="b3d29-388">If you exclude a disk that's needed for an application to operate, after failover to Azure you need to create it manually in Azure, so that the replicated application can run.</span></span> <span data-ttu-id="b3d29-389">Также вы можете интегрировать службу автоматизации Azure в план восстановления, чтобы диск создавался автоматически во время отработки отказа виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="b3d29-389">Alternatively, you could integrate Azure automation into a recovery plan, to create the disk during failover of the machine.</span></span>

    <span data-ttu-id="b3d29-390">Нажмите кнопку **OK**, чтобы сохранить изменения.</span><span class="sxs-lookup"><span data-stu-id="b3d29-390">Click **OK** to save changes.</span></span> <span data-ttu-id="b3d29-391">Позже можно задать дополнительные свойства.</span><span class="sxs-lookup"><span data-stu-id="b3d29-391">You can set additional properties later.</span></span>

    ![Включение репликации](./media/site-recovery-vmm-to-azure/enable-replication6-with-exclude-disk.png)

8. <span data-ttu-id="b3d29-393">Щелкнув **Параметры репликации** > **Настройка параметров репликации**, выберите политику репликации, которую необходимо применить к защищенным виртуальным машинам.</span><span class="sxs-lookup"><span data-stu-id="b3d29-393">In **Replication settings** > **Configure replication settings**, select the replication policy you want to apply for the protected VMs.</span></span> <span data-ttu-id="b3d29-394">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-394">Then click **OK**.</span></span> <span data-ttu-id="b3d29-395">Политику репликации можно изменить, последовательно выбрав **Политики репликации** > имя политики > **Изменить параметры**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-395">You can modify the replication policy in **Replication policies** > policy name > **Edit Settings**.</span></span> <span data-ttu-id="b3d29-396">Изменения будут применены как к ВМ, для которых уже выполняется репликация, так и к новым ВМ.</span><span class="sxs-lookup"><span data-stu-id="b3d29-396">Changes you apply are used for machines that are already replicating, and new machines.</span></span>

   ![Включение репликации](./media/site-recovery-vmm-to-azure/enable-replication7.png)

<span data-ttu-id="b3d29-398">Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Задания** > **Задания Azure Site Recovery**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-398">You can track progress of the **Enable Protection** job in **Jobs** > **Site Recovery jobs**.</span></span> <span data-ttu-id="b3d29-399">После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-399">After the **Finalize Protection** job runs, the machine is ready for failover.</span></span>

### <a name="view-and-manage-vm-properties"></a><span data-ttu-id="b3d29-400">Просмотр свойств виртуальной машины и управление ими</span><span class="sxs-lookup"><span data-stu-id="b3d29-400">View and manage VM properties</span></span>

<span data-ttu-id="b3d29-401">Рекомендуется проверить свойства исходного компьютера.</span><span class="sxs-lookup"><span data-stu-id="b3d29-401">We recommend that you verify the properties of the source machine.</span></span> <span data-ttu-id="b3d29-402">Помните, что имя виртуальной машины Azure должно соответствовать [требованиям к виртуальным машинам Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).</span><span class="sxs-lookup"><span data-stu-id="b3d29-402">Remember that the Azure VM name should conform with [Azure virtual machine requirements](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).</span></span>

1. <span data-ttu-id="b3d29-403">В разделе **Защищенные элементы** щелкните **Реплицированные элементы** и выберите виртуальную машину, чтобы просмотреть сведения о ней.</span><span class="sxs-lookup"><span data-stu-id="b3d29-403">In **Protected Items**, click **Replicated Items**, and select the machine to see its details.</span></span>

    ![Включение репликации](./media/site-recovery-vmm-to-azure/vm-essentials.png)
2. <span data-ttu-id="b3d29-405">На разделе **Свойства** можно просмотреть сведения о репликации и отработке отказа для виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="b3d29-405">In **Properties**, you can view replication and failover information for the VM.</span></span>

    ![Включение репликации](./media/site-recovery-vmm-to-azure/test-failover2.png)
3. <span data-ttu-id="b3d29-407">В разделе **Вычисления и сеть** > **Свойства вычислений** можно указать имя и целевой размер виртуальной машины Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-407">In **Compute and Network** > **Compute properties**, you can specify the Azure VM name and target size.</span></span> <span data-ttu-id="b3d29-408">При необходимости измените имя в соответствии с [требованиями Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements) .</span><span class="sxs-lookup"><span data-stu-id="b3d29-408">Modify the name to comply with [Azure requirements](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements) if you need to.</span></span> <span data-ttu-id="b3d29-409">Кроме того, можно просмотреть и изменить сведения о целевой сети, подсети и IP-адресе, назначенном виртуальной машине Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-409">You can also view and modify information about the target network, subnet, and the IP address that's assigned to the Azure VM.</span></span>
<span data-ttu-id="b3d29-410">Обратите внимание на следующее.</span><span class="sxs-lookup"><span data-stu-id="b3d29-410">Note that:</span></span>

   * <span data-ttu-id="b3d29-411">Вы можете задать целевой IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="b3d29-411">You can set the target IP address.</span></span> <span data-ttu-id="b3d29-412">Если не указать его, компьютер, для которого выполнена отработка отказа, будет использовать DHCP.</span><span class="sxs-lookup"><span data-stu-id="b3d29-412">If you don't provide an address, the failed over machine will use DHCP.</span></span> <span data-ttu-id="b3d29-413">Если задать адрес, недоступный при отработке отказа, произойдет сбой.</span><span class="sxs-lookup"><span data-stu-id="b3d29-413">If you set an address that isn't available at failover, the failover will fail.</span></span> <span data-ttu-id="b3d29-414">Этот же целевой IP-адрес можно использовать для тестовой отработки отказа, если он доступен в сети тестовой отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-414">The same target IP address can be used for test failover if the address is available in the test failover network.</span></span>
   * <span data-ttu-id="b3d29-415">Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины:</span><span class="sxs-lookup"><span data-stu-id="b3d29-415">The number of network adapters is dictated by the size you specify for the target virtual machine, as follows:</span></span>

     * <span data-ttu-id="b3d29-416">Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.</span><span class="sxs-lookup"><span data-stu-id="b3d29-416">If the number of network adapters on the source machine is less than or equal to the number of adapters allowed for the target machine size, then the target will have the same number of adapters as the source.</span></span>
     * <span data-ttu-id="b3d29-417">Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, используется максимальный размер целевой машины.</span><span class="sxs-lookup"><span data-stu-id="b3d29-417">If the number of adapters for the source virtual machine exceeds the number allowed for the target size, then the target size maximum is used.</span></span>
     * <span data-ttu-id="b3d29-418">Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, то на целевой машине будет два адаптера.</span><span class="sxs-lookup"><span data-stu-id="b3d29-418">For example if a source machine has two network adapters and the target machine size supports four, the target machine will have two adapters.</span></span> <span data-ttu-id="b3d29-419">Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер.</span><span class="sxs-lookup"><span data-stu-id="b3d29-419">If the source machine has two adapters but the supported target size only supports one, then the target machine will have only one adapter.</span></span>     
     * <span data-ttu-id="b3d29-420">Если для виртуальной машины настроено несколько сетевых адаптеров, они будут подключены к одной сети.</span><span class="sxs-lookup"><span data-stu-id="b3d29-420">If the VM has multiple network adapters, they will all connect to the same network.</span></span>

     ![Включение репликации](./media/site-recovery-vmm-to-azure/test-failover4.png)

4. <span data-ttu-id="b3d29-422">На странице **Диски** отображаются сведения о дисках ОС и дисках данных на виртуальной машине, для которой будет выполняться репликация.</span><span class="sxs-lookup"><span data-stu-id="b3d29-422">In **Disks** you can see the operating system and data disks on the VM that will be replicated.</span></span>

#### <a name="managed-disks"></a><span data-ttu-id="b3d29-423">Управляемые диски</span><span class="sxs-lookup"><span data-stu-id="b3d29-423">Managed disks</span></span>

<span data-ttu-id="b3d29-424">В разделе **Compute and Network** > **Compute properties** (Вычисления и сеть > Свойства вычислений) задайте для свойства "Использование управляемых дисков" значение "Да", если вы хотите подключить управляемые диски к виртуальной машине для миграции в Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-424">In **Compute and Network** > **Compute properties**, you can set "Use managed disks" setting to "Yes" for the VM if you want to attach managed disks to your machine on migration to Azure.</span></span> <span data-ttu-id="b3d29-425">Управляемые диски упрощают управление дисками виртуальных машин Azure IaaS. Они управляют учетными записями хранения, связанными с этими дисками.</span><span class="sxs-lookup"><span data-stu-id="b3d29-425">Managed disks simplifies disk management for Azure IaaS VMs by managing the storage accounts associated with the VM disks.</span></span> <span data-ttu-id="b3d29-426">[Узнайте больше об управляемых дисках](https://docs.microsoft.com/en-us/azure/storage/storage-managed-disks-overview).</span><span class="sxs-lookup"><span data-stu-id="b3d29-426">[Learn More about managed disks](https://docs.microsoft.com/en-us/azure/storage/storage-managed-disks-overview).</span></span>

   - <span data-ttu-id="b3d29-427">Управляемые диски создаются и подключаются к виртуальной машине только при отработке отказа в Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-427">Managed disks are created and attached to the virtual machine only on a failover to Azure.</span></span> <span data-ttu-id="b3d29-428">После включения защиты данные из локальных компьютеров будут продолжать выполнять репликацию в учетные записи хранения.</span><span class="sxs-lookup"><span data-stu-id="b3d29-428">On enabling protection, data from on-premises machines will continue to replicate to storage accounts.</span></span>
   <span data-ttu-id="b3d29-429">Управляемые диски можно создавать только для виртуальных машин, развернутых с помощью модели развертывания Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="b3d29-429">Managed disks can be created only for virtual machines deployed using the Resource manager deployment model.</span></span>  

  > [!NOTE]
  > <span data-ttu-id="b3d29-430">Сейчас восстановление размещения из Azure в локальную среду Hyper-V не поддерживается для виртуальных машин с управляемыми дисками.</span><span class="sxs-lookup"><span data-stu-id="b3d29-430">Failback from Azure to on-premises Hyper-V environment is not currently supported for machines with managed disks.</span></span> <span data-ttu-id="b3d29-431">Задайте для свойства "Использование управляемых дисков" значение "Да", только если вы планируете перенести эту машину в Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-431">Set "Use managed disks" to "Yes" only if you intend to migrate this machine to Azure.</span></span>

   - <span data-ttu-id="b3d29-432">Если для свойства "Использование управляемых дисков" задано значение "Да", для выбора будут доступны только группы доступности с заданным свойством в группе ресурсов.</span><span class="sxs-lookup"><span data-stu-id="b3d29-432">When you set "Use managed disks" to "Yes", only availability sets in the resource group with "Use managed disks" set to "Yes" would be available for selection.</span></span> <span data-ttu-id="b3d29-433">Это связано с тем, что виртуальные машины с управляемыми дисками могут быть частью только групп доступности с заданным для свойства "Использование управляемых дисков" значением "Да".</span><span class="sxs-lookup"><span data-stu-id="b3d29-433">This is because virtual machines with managed disks can only be part of availability sets with "Use managed disks" property set to "Yes".</span></span> <span data-ttu-id="b3d29-434">Убедитесь, что вы создали группы доступности с заданным свойством "Использование управляемых дисков" на основании намерения использовать управляемые диски при отработке отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-434">Make sure that you create availability sets with "Use managed disks" property set based on your intent to use managed disks on failover.</span></span>  <span data-ttu-id="b3d29-435">Точно так же, если для свойства "Использование управляемых дисков" задано значение "Нет", только группы доступности с заданным свойством в группе ресурсов будут доступны для выбора.</span><span class="sxs-lookup"><span data-stu-id="b3d29-435">Likewise, when you set "Use managed disks" to "No", only availability sets in the resource group with "Use managed disks" property set to "No" would be available for selection.</span></span> <span data-ttu-id="b3d29-436">[Узнайте больше об управляемых дисках и группах доступности](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/manage-availability#use-managed-disks-for-vms-in-an-availability-set).</span><span class="sxs-lookup"><span data-stu-id="b3d29-436">[Learn more about managed disks and availability sets](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/manage-availability#use-managed-disks-for-vms-in-an-availability-set).</span></span>

  > [!NOTE]
  > <span data-ttu-id="b3d29-437">Если учетная запись хранения, используемая для репликации, была зашифрована с помощью шифрования службы хранилища по состоянию на любой момент времени, создание управляемых дисков во время отработки отказа завершится ошибкой.</span><span class="sxs-lookup"><span data-stu-id="b3d29-437">If the storage account used for replication was encrypted with Storage Service Encryption at any point in time, creation of managed disks during failover will fail.</span></span> <span data-ttu-id="b3d29-438">Вы можете присвоить свойству "Использование управляемых дисков" значение "Нет" либо повторить отработку отказа или отключить защиту виртуальной машины и защитить ее с помощью учетной записи хранения, для которой не включено шифрование службы хранилища по состоянию на любой момент времени.</span><span class="sxs-lookup"><span data-stu-id="b3d29-438">You can either set "Use managed disks" to "No" and retry failover or disable protection for the virtual machine and protect it to a storage account which did not have Storage service encryption enabled at any point in time.</span></span>
  > <span data-ttu-id="b3d29-439">[Узнайте больше о шифровании службы хранилища и управляемых дисках](https://docs.microsoft.com/en-us/azure/storage/storage-managed-disks-overview#managed-disks-and-encryption).</span><span class="sxs-lookup"><span data-stu-id="b3d29-439">[Learn more about Storage service encryption and managed disks](https://docs.microsoft.com/en-us/azure/storage/storage-managed-disks-overview#managed-disks-and-encryption).</span></span>


## <a name="test-the-deployment"></a><span data-ttu-id="b3d29-440">тестирование развертывания</span><span class="sxs-lookup"><span data-stu-id="b3d29-440">Test the deployment</span></span>

<span data-ttu-id="b3d29-441">Чтобы протестировать развертывание, можно запустить тестовую отработку отказа для отдельной виртуальной машины или создать план восстановления для одной или нескольких виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="b3d29-441">To test the deployment you can run a test failover for a single virtual machine or a recovery plan that contains one or more virtual machines.</span></span>

### <a name="before-you-start"></a><span data-ttu-id="b3d29-442">Перед началом работы</span><span class="sxs-lookup"><span data-stu-id="b3d29-442">Before you start</span></span>

 - <span data-ttu-id="b3d29-443">Если вам нужно, чтобы после отработки отказа к виртуальным машинам Azure можно было подключиться по протоколу RDP, см. эти [рекомендации](site-recovery-test-failover-to-azure.md#prepare-to-connect-to-azure-vms-after-failover).</span><span class="sxs-lookup"><span data-stu-id="b3d29-443">If you want to connect to Azure VMs using RDP after failover, learn about [preparing to connect](site-recovery-test-failover-to-azure.md#prepare-to-connect-to-azure-vms-after-failover).</span></span>
 - <span data-ttu-id="b3d29-444">Чтобы полностью проверить систему, скопируйте Active Directory и DNS в тестовую среду.</span><span class="sxs-lookup"><span data-stu-id="b3d29-444">To fully test you need to copy of Active Directory and DNS in your test environment.</span></span> <span data-ttu-id="b3d29-445">[Подробнее](site-recovery-active-directory.md#test-failover-considerations).</span><span class="sxs-lookup"><span data-stu-id="b3d29-445">[Learn more](site-recovery-active-directory.md#test-failover-considerations).</span></span>

### <a name="run-a-test-failover"></a><span data-ttu-id="b3d29-446">Запуск тестовой отработки отказа</span><span class="sxs-lookup"><span data-stu-id="b3d29-446">Run a test failover</span></span>

1. <span data-ttu-id="b3d29-447">Чтобы выполнить отработку отказа для одной виртуальной машины, в разделе **Реплицированные элементы** щелкните виртуальную машину и **+Test Failover** (+Тестовая отработка отказа).</span><span class="sxs-lookup"><span data-stu-id="b3d29-447">To fail over a single VM, in **Replicated Items**, click the VM > **+Test Failover**.</span></span>
2. <span data-ttu-id="b3d29-448">Чтобы выполнить отработку отказа по плану восстановления, в разделе **Планы восстановления** щелкните план правой кнопкой мыши и выберите **Тестовая отработка отказа**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-448">To fail over a recovery plan, in **Recovery Plans**, right-click the plan > **Test Failover**.</span></span> <span data-ttu-id="b3d29-449">Чтобы создать план восстановления, [выполните эти инструкции](site-recovery-create-recovery-plans.md).</span><span class="sxs-lookup"><span data-stu-id="b3d29-449">To create a recovery plan, [follow these instructions](site-recovery-create-recovery-plans.md).</span></span>
3. <span data-ttu-id="b3d29-450">В разделе **Тестовая отработка отказа** выберите сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-450">In **Test Failover**, select the Azure network to which Azure VMs connect after failover occurs.</span></span>
4. <span data-ttu-id="b3d29-451">Нажмите кнопку **ОК** , чтобы запустить отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-451">Click **OK** to begin the failover.</span></span> <span data-ttu-id="b3d29-452">За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину, или в задании **тестовой отработки отказа** в разделе **Задания Site Recovery**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-452">You can track progress by clicking on the VM to open its properties, or on the **Test Failover** job in **Site Recovery jobs**.</span></span>
5. <span data-ttu-id="b3d29-453">После завершения отработки отказа реплика виртуальной машины Azure появится на портале Azure в разделе **Виртуальные машины**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-453">After the failover completes, you should also be able to see the replica Azure machine appear in the Azure portal > **Virtual Machines**.</span></span> <span data-ttu-id="b3d29-454">Проверьте, имеет ли виртуальная машина соответствующий размер, подключена ли к соответствующей сети и работает ли она.</span><span class="sxs-lookup"><span data-stu-id="b3d29-454">You should make sure that the VM is the appropriate size, that it's connected to the appropriate network, and is running.</span></span>
6. <span data-ttu-id="b3d29-455">Если вы заранее подготовились к подключению после отработки отказа, то сможете подключиться к виртуальной машине Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-455">If you prepared for connections after failover, you should be able to connect to the Azure VM.</span></span>
7. <span data-ttu-id="b3d29-456">Когда все будет готово, нажмите кнопку **Очистить тестовую отработку отказа** в плане восстановления.</span><span class="sxs-lookup"><span data-stu-id="b3d29-456">Once you're done, click on **Cleanup test failover** on the recovery plan.</span></span> <span data-ttu-id="b3d29-457">При необходимости в разделе **примечаний** можно записать и сохранить ваши наблюдения касательно тестовой отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-457">In **Notes** record and save any observations associated with the test failover.</span></span> <span data-ttu-id="b3d29-458">Это приведет к удалению виртуальных машин, созданных при тестовой отработке отказа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-458">This will delete the virtual machines that were created during test failover.</span></span>

<span data-ttu-id="b3d29-459">Ознакомьтесь с дополнительными сведениями о [тестовой отработке отказа в Azure](site-recovery-test-failover-to-azure.md).</span><span class="sxs-lookup"><span data-stu-id="b3d29-459">For more details, read the [Test failover to Azure](site-recovery-test-failover-to-azure.md) article.</span></span>

## <a name="monitor-the-deployment"></a><span data-ttu-id="b3d29-460">Мониторинг развертывания</span><span class="sxs-lookup"><span data-stu-id="b3d29-460">Monitor the deployment</span></span>

<span data-ttu-id="b3d29-461">Ниже описывается, как можно отслеживать параметры конфигурации, состояние и работоспособность развертывания Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="b3d29-461">Here's how you can monitor configuration settings, status, and health for the Site Recovery deployment:</span></span>

1. <span data-ttu-id="b3d29-462">Щелкните имя хранилища, чтобы открыть панель мониторинга **Основные компоненты** .</span><span class="sxs-lookup"><span data-stu-id="b3d29-462">Click on the vault name to access the **Essentials** dashboard.</span></span> <span data-ttu-id="b3d29-463">На этой панели мониторинга можно просмотреть сведения о заданиях Site Recovery, состоянии репликации, планах восстановления, работоспособности сервера и событиях.</span><span class="sxs-lookup"><span data-stu-id="b3d29-463">In this dashboard you can Site Recovery jobs, replication status, recovery plans, server health, and events.</span></span>  <span data-ttu-id="b3d29-464">Панель **Основные компоненты** можно настроить таким образом, чтобы на ней отображались самые необходимые элементы и макеты, а также сведения о состоянии других хранилищ Site Recovery и службы архивации.</span><span class="sxs-lookup"><span data-stu-id="b3d29-464">You can customize **Essentials** to show the tiles and layouts that are most useful to you, including the status of other Site Recovery and Backup vaults.</span></span>

    ![Основные компоненты](./media/site-recovery-vmm-to-azure/essentials.png)
2. <span data-ttu-id="b3d29-466">Элемент **Работоспособность** позволяет выявлять проблемы в работе локальных серверов (серверов VMM или серверов конфигурации), а также наблюдать за событиями, о которых сообщила служба Site Recovery за последние 24 часа.</span><span class="sxs-lookup"><span data-stu-id="b3d29-466">In **Health**, you can monitor issues on on-premises servers (VMM or configuration servers), and the events raised by Site Recovery in the last 24 hours.</span></span>
3. <span data-ttu-id="b3d29-467">Мониторинг репликации и управление ею осуществляется с помощью элементов **Реплицированные элементы**, **Планы восстановления** и **Site Recovery Jobs** (Задания Site Recovery).</span><span class="sxs-lookup"><span data-stu-id="b3d29-467">In the **Replicated Items**, **Recovery Plans**, and **Site Recovery Jobs** tiles you can manage and monitor replication.</span></span> <span data-ttu-id="b3d29-468">Чтобы получить подробные сведения о заданиях, выберите **Задания** > **Задания Site Recovery**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-468">You can drill into jobs in **Jobs** > **Site Recovery Jobs**.</span></span>

## <a name="command-line-installation-for-the-azure-site-recovery-provider"></a><span data-ttu-id="b3d29-469">Установка поставщика Azure Site Recovery в командной строке</span><span class="sxs-lookup"><span data-stu-id="b3d29-469">Command-line installation for the Azure Site Recovery Provider</span></span>

<span data-ttu-id="b3d29-470">Поставщик Azure Site Recovery можно установить с помощью командной строки.</span><span class="sxs-lookup"><span data-stu-id="b3d29-470">The Azure Site Recovery Provider can be installed from the command-line.</span></span> <span data-ttu-id="b3d29-471">Этот метод можно использовать для установки поставщика на основные серверные компоненты Windows Server 2012 R2.</span><span class="sxs-lookup"><span data-stu-id="b3d29-471">This method can be used to install the Provider on Server Core for Windows Server 2012 R2.</span></span>

1. <span data-ttu-id="b3d29-472">Скачайте файл установки поставщика и ключ регистрации в папку.</span><span class="sxs-lookup"><span data-stu-id="b3d29-472">Download the Provider installation file and registration key to a folder.</span></span> <span data-ttu-id="b3d29-473">Например, C:\ASR.</span><span class="sxs-lookup"><span data-stu-id="b3d29-473">For example, C:\ASR.</span></span>
2. <span data-ttu-id="b3d29-474">В командной строке с повышенными правами запустите следующие команды, чтобы извлечь установщик поставщика:</span><span class="sxs-lookup"><span data-stu-id="b3d29-474">From an elevated command prompt, run these commands to extract the Provider installer:</span></span>

            C:\Windows\System32> CD C:\ASR
            C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q
3. <span data-ttu-id="b3d29-475">Выполните следующую команду для установки компонентов:</span><span class="sxs-lookup"><span data-stu-id="b3d29-475">Run this command to install the components:</span></span>

            C:\ASR> setupdr.exe /i
4. <span data-ttu-id="b3d29-476">Затем выполните следующие команды для регистрации сервера в хранилище.</span><span class="sxs-lookup"><span data-stu-id="b3d29-476">Then run these commands, to register the server in the vault:</span></span>

        CD C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin
        C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin\> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file> /EncryptionEnabled <full file name to save the encryption certificate>       

<span data-ttu-id="b3d29-477">Описание</span><span class="sxs-lookup"><span data-stu-id="b3d29-477">Where:</span></span>

* <span data-ttu-id="b3d29-478">**/Credentials**— обязательный параметр, который определяет расположение ключа регистрации.</span><span class="sxs-lookup"><span data-stu-id="b3d29-478">**/Credentials**: Mandatory parameter that specifies where the registration key file is located.</span></span>  
* <span data-ttu-id="b3d29-479">**/FriendlyName**— обязательный параметр для имени сервера узла Hyper-V, который отображается на портале Azure Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="b3d29-479">**/FriendlyName**: Mandatory parameter for the name of the Hyper-V host server that appears in the Azure Site Recovery portal.</span></span>
* * <span data-ttu-id="b3d29-480">**/EncryptionEnabled**— необязательный параметр, используемый при репликации виртуальных машин Hyper-V из облаков VMM в Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-480">**/EncryptionEnabled**: Optional parameter when you're replicating Hyper-V VMs in VMM clouds to Azure.</span></span> <span data-ttu-id="b3d29-481">Укажите, следует ли шифровать виртуальные машины в Azure (шифрование неактивных данных).</span><span class="sxs-lookup"><span data-stu-id="b3d29-481">Specify if you want to encrypt virtual machines in Azure (at rest encryption).</span></span> <span data-ttu-id="b3d29-482">Имя файла должно иметь расширение **PFX** .</span><span class="sxs-lookup"><span data-stu-id="b3d29-482">Ensure that the name of the file has a **.pfx** extension.</span></span> <span data-ttu-id="b3d29-483">По умолчанию шифрование отключено.</span><span class="sxs-lookup"><span data-stu-id="b3d29-483">Encryption is off by default.</span></span>

    > [!NOTE]
    > <span data-ttu-id="b3d29-484">Рекомендуется использовать функцию шифрования, предоставляемую Azure, для шифрования неактивных данных, а не функцию шифрования (EncryptionEnabled), предоставляемую Azure Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="b3d29-484">It is recommended to use the encryption capability provided by Azure for encrypting data at rest, instead of using the encryption option (EncryptionEnabled option) provided by Azure Site Recovery.</span></span> <span data-ttu-id="b3d29-485">Предоставляемую Azure функцию шифрования можно включить для учетной записи хранения. Это поможет повысить производительность при операциях шифрования и расшифровки,</span><span class="sxs-lookup"><span data-stu-id="b3d29-485">The encryption capability provided by Azure can be turned on for a storage account and helps achieve better performance as the encryption/decryption is done by Azure</span></span>  
    > <span data-ttu-id="b3d29-486">выполняемых хранилищем Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-486">storage.</span></span>
    > <span data-ttu-id="b3d29-487">См. дополнительные сведения о [шифровании службы хранилища в Azure](https://docs.microsoft.com/en-us/azure/storage/storage-service-encryption).</span><span class="sxs-lookup"><span data-stu-id="b3d29-487">[Learn more about Storage service encryption in Azure](https://docs.microsoft.com/en-us/azure/storage/storage-service-encryption).</span></span>
    
* <span data-ttu-id="b3d29-488">**/proxyAddress**— необязательный параметр, определяющий адрес прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="b3d29-488">**/proxyAddress**: Optional parameter that specifies the address of the proxy server.</span></span>
* <span data-ttu-id="b3d29-489">**/proxyport**— необязательный параметр, определяющий порт прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="b3d29-489">**/proxyport**: Optional parameter that specifies the port of the proxy server.</span></span>
* <span data-ttu-id="b3d29-490">**/proxyUsername**— необязательный параметр, определяющий имя пользователя прокси-сервера (если прокси-сервер требует проверки подлинности).</span><span class="sxs-lookup"><span data-stu-id="b3d29-490">**/proxyUsername**: Optional parameter that specifies the proxy user name (if proxy requires authentication).</span></span>
* <span data-ttu-id="b3d29-491">**/proxyPassword**— необязательный параметр, определяющий пароль для проверки подлинности на прокси-сервере (если прокси-сервер требует проверки подлинности).</span><span class="sxs-lookup"><span data-stu-id="b3d29-491">**/proxyPassword**: Optional parameter that specifies the password to authenticate with proxy server (if the proxy requires authentication).</span></span>


### <a name="network-bandwidth-considerations"></a><span data-ttu-id="b3d29-492">Рекомендации по пропускной способности сети</span><span class="sxs-lookup"><span data-stu-id="b3d29-492">Network bandwidth considerations</span></span>
<span data-ttu-id="b3d29-493">С помощью планировщика ресурсов можно рассчитать пропускную способность, необходимую для репликации (начальная и разностная репликации данных).</span><span class="sxs-lookup"><span data-stu-id="b3d29-493">You can use the capacity planner tool to calculate the bandwidth you need for replication (initial replication and then delta).</span></span> <span data-ttu-id="b3d29-494">Управлять объемом пропускной способности, используемой для репликации, можно несколькими способами:</span><span class="sxs-lookup"><span data-stu-id="b3d29-494">To control the amount of bandwidth use for replication, you have a few options:</span></span>

* <span data-ttu-id="b3d29-495">**Регулирование пропускной способности.** Трафик Hyper-V, который реплицируется на дополнительный сайт, проходит через определенный узел Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="b3d29-495">**Throttle bandwidth**: Hyper-V traffic that replicates to a secondary site goes through a specific Hyper-V host.</span></span> <span data-ttu-id="b3d29-496">Пропускную способность можно регулировать на сервере этого узла.</span><span class="sxs-lookup"><span data-stu-id="b3d29-496">You can throttle bandwidth on the host server.</span></span>
* <span data-ttu-id="b3d29-497">**Настройка пропускной способности**. Пропускную способность, используемую для репликации, можно изменить с помощью нескольких разделов реестра.</span><span class="sxs-lookup"><span data-stu-id="b3d29-497">**Tweak bandwidth**: You can influence the bandwidth used for replication using a couple of registry keys.</span></span>

#### <a name="throttle-bandwidth"></a><span data-ttu-id="b3d29-498">Регулирование пропускной способности</span><span class="sxs-lookup"><span data-stu-id="b3d29-498">Throttle bandwidth</span></span>
1. <span data-ttu-id="b3d29-499">Откройте на сервере узла Hyper-V оснастку MMC в службе архивации Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-499">Open the Microsoft Azure Backup MMC snap-in on the Hyper-V host server.</span></span> <span data-ttu-id="b3d29-500">По умолчанию ярлык для службы архивации Microsoft Azure расположен на рабочем столе или в папке C:\Program Files\Microsoft Azure Recovery Services Agent\bin\wabadmin.</span><span class="sxs-lookup"><span data-stu-id="b3d29-500">By default, a shortcut for Microsoft Azure Backup is available on the desktop or in C:\Program Files\Microsoft Azure Recovery Services Agent\bin\wabadmin.</span></span>
2. <span data-ttu-id="b3d29-501">В оснастке щелкните **Изменить свойства**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-501">In the snap-in, click **Change Properties**.</span></span>
3. <span data-ttu-id="b3d29-502">На вкладке **Регулирование** установите флажок **Разрешить регулирование уровня использования пропускной способности интернет-канала для операций архивации** и задайте ограничения для рабочего и нерабочего времени.</span><span class="sxs-lookup"><span data-stu-id="b3d29-502">On the **Throttling** tab, select **Enable internet bandwidth usage throttling for backup operations**, and set the limits for work and non-work hours.</span></span> <span data-ttu-id="b3d29-503">Допустимы значения в диапазоне от 512 Кбит/с до 102 Мбит/с.</span><span class="sxs-lookup"><span data-stu-id="b3d29-503">Valid ranges are from 512 Kbps to 102 Mbps per second.</span></span>

    ![Регулирование пропускной способности](./media/site-recovery-vmm-to-azure/throttle2.png)

<span data-ttu-id="b3d29-505">Чтобы настроить регулирование, можно также использовать командлет [Set-OBMachineSetting](https://technet.microsoft.com/library/hh770409.aspx) .</span><span class="sxs-lookup"><span data-stu-id="b3d29-505">You can also use the [Set-OBMachineSetting](https://technet.microsoft.com/library/hh770409.aspx) cmdlet to set throttling.</span></span> <span data-ttu-id="b3d29-506">Рассмотрим пример:</span><span class="sxs-lookup"><span data-stu-id="b3d29-506">Here's a sample:</span></span>

    $mon = [System.DayOfWeek]::Monday
    $tue = [System.DayOfWeek]::Tuesday
    Set-OBMachineSetting -WorkDay $mon, $tue -StartWorkHour "9:00:00" -EndWorkHour "18:00:00" -WorkHourBandwidth  (512*1024) -NonWorkHourBandwidth (2048*1024)

<span data-ttu-id="b3d29-507">**Set-OBMachineSetting -NoThrottle** указывает, что регулирование не требуется.</span><span class="sxs-lookup"><span data-stu-id="b3d29-507">**Set-OBMachineSetting -NoThrottle** indicates that no throttling is required.</span></span>

#### <a name="influence-network-bandwidth"></a><span data-ttu-id="b3d29-508">Изменение пропускной способности сети</span><span class="sxs-lookup"><span data-stu-id="b3d29-508">Influence network bandwidth</span></span>
<span data-ttu-id="b3d29-509">Значение реестра **UploadThreadsPerVM** управляет количеством потоков, используемых для передачи данных диска (начальная или разностная репликация данных).</span><span class="sxs-lookup"><span data-stu-id="b3d29-509">The **UploadThreadsPerVM** registry value controls the number of threads that are used for data transfer (initial or delta replication) of a disk.</span></span> <span data-ttu-id="b3d29-510">Если задать высокое значение, пропускная способность сети, используемая для репликации, увеличивается.</span><span class="sxs-lookup"><span data-stu-id="b3d29-510">A higher value increases the network bandwidth used for replication.</span></span> <span data-ttu-id="b3d29-511">Значение реестра **DownloadThreadsPerVM** указывает количество потоков, используемых для передачи данных при восстановлении размещения.</span><span class="sxs-lookup"><span data-stu-id="b3d29-511">The **DownloadThreadsPerVM** registry value specifies the number of threads used for data transfer during failback.</span></span>

1. <span data-ttu-id="b3d29-512">В реестре перейдите в раздел **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication**.</span><span class="sxs-lookup"><span data-stu-id="b3d29-512">In the registry, navigate to **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication**.</span></span>

   * <span data-ttu-id="b3d29-513">Измените значение **UploadThreadsPerVM** (или создайте раздел, если он не существует), чтобы управлять потоками, используемыми для репликации дисков.</span><span class="sxs-lookup"><span data-stu-id="b3d29-513">Modify the value **UploadThreadsPerVM** (or create the key if it doesn't exist) to control threads used for disk replication.</span></span>
   * <span data-ttu-id="b3d29-514">Измените значение **DownloadThreadsPerVM** (или создайте раздел, если он не существует), чтобы управлять потоками, используемыми для трафика восстановления размещения в Azure.</span><span class="sxs-lookup"><span data-stu-id="b3d29-514">Modify the value **DownloadThreadsPerVM** (or create the key if it doesn't exist) to control threads used for failback traffic from Azure.</span></span>
2. <span data-ttu-id="b3d29-515">Значение по умолчанию — 4.</span><span class="sxs-lookup"><span data-stu-id="b3d29-515">The default value is 4.</span></span> <span data-ttu-id="b3d29-516">В сети со значительным избыточным резервом для этих разделов реестра необходимо изменить значения по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="b3d29-516">In an “overprovisioned” network, these registry keys should be changed from the default values.</span></span> <span data-ttu-id="b3d29-517">Максимальное значение — 32.</span><span class="sxs-lookup"><span data-stu-id="b3d29-517">The maximum is 32.</span></span> <span data-ttu-id="b3d29-518">Следите за трафиком для оптимизации значения.</span><span class="sxs-lookup"><span data-stu-id="b3d29-518">Monitor traffic to optimize the value.</span></span>

## <a name="next-steps"></a><span data-ttu-id="b3d29-519">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="b3d29-519">Next steps</span></span>

<span data-ttu-id="b3d29-520">Когда начальная репликация завершится и вы проверите работу развертывания, отработку отказа можно будет использовать в любой момент, как только возникнет необходимость.</span><span class="sxs-lookup"><span data-stu-id="b3d29-520">After initial replication is complete, and you've tested the deployment, you can invoke failovers as the need arises.</span></span> <span data-ttu-id="b3d29-521">[Узнайте больше](site-recovery-failover.md) о разных типах отработки отказа и способах их выполнения.</span><span class="sxs-lookup"><span data-stu-id="b3d29-521">[Learn more](site-recovery-failover.md) about different types of failovers and how to run them.</span></span>

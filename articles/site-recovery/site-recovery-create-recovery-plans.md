---
title: "Создание планов восстановления для отработки отказа и восстановления в Azure Site Recovery | Документация Майкрософт"
description: "В этой статье описывается создание и настройка планов восстановления в Azure Site Recovery для отработки отказа и восстановления виртуальных машин и физических серверов."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 72408c62-fcb6-4ee2-8ff5-cab1218773f2
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 09/25/2017
ms.author: raynew
ms.openlocfilehash: 202e0ac8be36e9156ec16fadc1b722f4eb3d1432
ms.sourcegitcommit: b723436807176e17e54f226fe00e7e977aba36d5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/19/2017
---
# <a name="create-recovery-plans"></a>Создание планов восстановления


В этой статье содержится информация о создании и настройке планов восстановления в [Azure Site Recovery](site-recovery-overview.md).

Комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

 Созданные планы восстановления делают следующее:

* Определяют группы компьютеров, для которых отработка отказа и запуск выполняются одновременно.
* Моделируют зависимости между компьютерами, объединяя их в группы плана восстановления. Например, если отработка отказа и восстановление выполняются для конкретного приложения, все виртуальные машины этого приложения следует объединить в одну группу плана восстановления.
* Выполняют отработку отказа. Вы можете запустить тестовую, плановую или внеплановую отработку отказа в плане восстановления.


## <a name="create-a-recovery-plan"></a>Создайте план восстановления

1. Щелкните **Планы восстановления** > **Создать план восстановления**.
   Укажите имя плана восстановления, а также исходный и целевой серверы. Исходное расположение должно содержать виртуальные машины, на которых настроены отработка отказа и восстановление.

    - Для репликации между серверами VMM выберите **Тип источника** > **VMM**, а также укажите исходный и целевой серверы VMM. Щелкните **Hyper-V**, чтобы просмотреть защищенные облака.
    - Для репликации из VMM в Azure выберите **Тип источника** > **VMM**.  Затем выберите исходный сервер VMM, а в качестве целевого сервера — **Azure**.
    - Для репликации Hyper-V в Azure (без использования VMM), выберите **Тип источника** > **Узел Hyper-V**. Выберите нужный сайт в качестве источника, а в качестве целевого сервера — **Azure**.
    - Для репликации виртуальной машины VMware или локального физического сервера в Azure выберите в качестве источника сервер конфигурации, а в качестве целевого сервера — **Azure**.
    - Для плана восстановления из Azure в Azure выберите регион Azure, который является источником, и вторичный регион Azure, который является целевым. Ко вторичным регионам Azure относятся только регионы, в которых защищены виртуальные машины.
2. В окне **Выбор виртуальных машин** укажите виртуальные машины (или группу репликации), которые хотите добавить в группу по умолчанию (Group 1) в плане восстановления.

## <a name="customize-and-extend-recovery-plans"></a>Настройка и расширение планов восстановления

Вы можете настраивать и расширять планы восстановления.

- **Добавление новых групп**. Кроме группы по умолчанию, в план восстановления можно добавить до семи дополнительных групп, а затем добавлять в них виртуальные машины или группы репликации. Новые группы нумеруются в порядке добавления. Каждую виртуальную машину или группу репликации можно включить только в одну группу плана восстановления.
- **Добавление ручного действия**. Вы можете добавить ручные действия, выполняемые до или после группы плана восстановления. При выполнении план восстановления он останавливается в той точке, куда вы добавили выполняемое вручную действие. При этом появляется диалоговое окно с предложением подтвердить, что это действие выполнено вручную.
- **Добавление скрипта**. Вы можете добавить скрипты, выполняемые до или после группы плана восстановления. Каждый новый скрипт добавляет к группе новый набор действий. Например, для группы с именем "Group 1" создается набор предварительных действий с именем "Group 1: Pre-steps". Все предварительные действия будут перечислены в этом наборе. Чтобы добавить скрипт, на основном сайте должен быть развернут сервер VMM.
- **Добавление модулей Runbook Azure**.Чтобы расширить план восстановления, вы можете применить модули Runbook Azure. Они позволяют автоматизировать задачи или выполнять пошаговое восстановление. [Подробнее](site-recovery-runbook-automation.md).

## <a name="add-scripts"></a>Добавление скриптов

В планах восстановления можно использовать скрипты PowerShell.

 - Для аккуратной обработки исключений сценарии должны включать блоки try-catch.
    - Если в скрипте возникает исключение, выполнение скрипта останавливается и задача помечается как невыполненная.
    - При возникновении ошибки оставшаяся часть скрипта не выполняется.
    - Если ошибка происходит при выполнении внеплановой отработки отказа, выполнение плана восстановления продолжается.
    - Если ошибка происходит при выполнении плановой отработки отказа, выполнение плана восстановления останавливается. В этом случае исправьте скрипт, убедитесь, что он выполняется должным образом, и повторно запустите план восстановления.
- Команда Write-Host не работает в сценарии плана восстановления, и сценарий завершится с ошибкой. Для создания выходного файла создайте скрипт прокси, который выполняется в основном скрипте. Убедитесь, что все выходные данные перенаправляются с помощью команды ">>".
  * Если скрипт не завершается в течение 600 секунд, он будет остановлен.
  * Если от скрипта поступят любые данные в вывод STDERR, он будет считаться завершившимся с ошибкой. Эти сведения отображаются в данных о выполнении скрипта.

Если в вашем развертывании есть VMM, учтите следующее.

* Сценарии в плане восстановления выполняются в контексте учетной записи службы VMM. Эта учетная запись должна иметь разрешения на чтение для удаленной общей папки, в которой расположен скрипт. Скрипт должен успешно выполняться на уровне привилегий учетной записи службы VMM.
* Командлеты VMM предоставляются в модуле Windows PowerShell. Этот модуль устанавливается одновременно с консолью VMM. Его можно загрузить в скрипт, используя следующую команду:
   - Import-Module -Name virtualmachinemanager. [Подробнее](https://technet.microsoft.com/library/hh875013.aspx).
* Убедитесь в наличии хотя бы одного сервера библиотеки в вашем развертывании VMM. По умолчанию общая папка библиотеки для сервера VMM размещается на сервере VMM в локальной папке с именем MSCVMMLibrary.
    * Если ваша общая папка библиотеки находится на удаленном сервере (или расположена локально, но не совпадает с папкой MSCVMMLibrary), настройте общую папку, как описано ниже (\\\libserver2.contoso.com\share\ используется в качестве примера).
      * Откройте редактор реестра и найдите запись **HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\Azure Site Recovery\Registration**.
      * Для параметра **ScriptLibraryPath** укажите значение \\\libserver2.contoso.com\share\.. Укажите полное доменное имя. Предоставьте разрешения для расположения общей папки. Обратите внимание, что корневой узел общего ресурса. **Чтобы проверить это, откройте библиотеку на уровне корневого узла в VMM. Открывшийся путь и будет корневым путем, который необходимо использовать в переменной**.
      * Для тестирования скрипта используйте учетную запись с теми же разрешениями, которые есть у учетной записи службы VMM. Это позволит гарантировать, что локально скрипт выполняется в тех же условиях, что и в планах восстановления. На сервере VMM установите обход политики выполнения следующих образом:
        * Откройте консоль **PowerShell 64-разрядной версии Windows** с более высоким уровнем привилегий.
        * Введите: **Set-executionpolicy bypass**. [Подробнее](https://technet.microsoft.com/library/ee176961.aspx).

> [!IMPORTANT]
> Необходимо задать политику выполнения "Обход" только для 64-разрядной версии PowerShell. Если вы задали ее для 32-разрядной версии PowerShell, сценарии не будут выполняться.

## <a name="add-a-script-or-manual-action-to-a-plan"></a>Добавление в план скрипта или ручного действия

Когда вы создадите план восстановления и добавите в группу по умолчанию виртуальные машины или группы репликации, в эту группу можно добавить скрипт.

1. Откройте план восстановления.
2. Щелкните любой элемент в списке **Step** (Шаг), затем выберите **Script** (Скрипт) или **Manual Action** (Ручное действие).
3. Укажите, следует ли добавить сценарий или действие до или после выбранного элемента. Используя кнопки управления **Move Up** (Переместить выше) и **Move Down** (Переместить ниже), можно изменить положение скрипта.
4. Если вы добавляете скрипт VMM, выберите **Failover to VMM script** (Отработка отказа в скрипт VMM). Для параметра **Script Path** (Путь к скрипту) укажите относительный путь к общей папке. В следующем примере для VMM это будет путь **\RPScripts\RPScript.PS1**.
5. Если вы добавляете модуль Runbook службы автоматизации Azure, укажите учетную запись службы автоматизации Azure, в которой расположен этот модуль Runbook, а затем выберите нужный скрипт модуля Runbook Azure.
6. Выполните отработку отказа по плану восстановления, чтобы убедиться в правильности работы скрипта.


### <a name="add-a-vmm-script"></a>Добавление скрипта VMM

Если используется исходный сайт VMM, вы можете создать скрипт на сервере VMM и включить его в план восстановления.

1. Создайте новую папку в общей папке библиотеки. Например \<VMMServerName>\MSSCVMMLibrary\RPScripts. Разместите ее на исходном и целевом серверах VMM.
2. Создайте сценарий (например, RPScript) и убедитесь, что он работает должным образом
3. Поместите скрипт в папку \<VMMServerName>\MSSCVMMLibrary на исходном и целевом серверах VMM.


## <a name="next-steps"></a>Дальнейшие действия

[Дополнительные сведения](site-recovery-failover.md) о выполнении отработки отказа.

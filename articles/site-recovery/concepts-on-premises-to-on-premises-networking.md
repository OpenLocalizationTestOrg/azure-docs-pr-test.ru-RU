---
title: "Настройка назначения IP-адресов для подключения после отработки отказа на дополнительный сайт с помощью Azure Site Recovery | Документация Майкрософт"
description: "В этой статье объясняется, как настроить назначения IP-адресов для подключения к виртуальным машинам после отработки отказа на дополнительный сайт с помощью Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: prateek9us
editor: 
ms.assetid: 67d73590-185c-49b2-a097-597bf54747a9
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 11/14/2017
ms.author: pratshar
ms.openlocfilehash: 6baeda08b1c41cc024a02f51ca27be2829c46962
ms.sourcegitcommit: 9a61faf3463003375a53279e3adce241b5700879
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/15/2017
---
# <a name="set-up-ip-addressing-to-connect-after-failover-to-a-secondary-site"></a>Настройка назначения IP-адресов для подключения после отработки отказа на дополнительный сайт

После просмотра необходимых условий для развертывания ознакомьтесь с этой статьей для планирования сетей при репликации виртуальных машин Hyper-V, управляемых в облаках System Center Virtual Machine Manager (VMM) на дополнительный сайт с помощью [Azure Site Recovery](site-recovery-overview.md) на портале Azure. 

Любые комментарии, которые возникнут после прочтения этой статьи, можно добавить в конце этой страницы или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## <a name="overview"></a>Обзор

При планировании стратегии репликации и отработки отказа одним из ключевых вопросов является способ подключения к реплике после отработки отказа. Существует несколько вариантов: 

- **Использование другого IP-адреса.** Для реплицируемых виртуальных машин можно выбрать другой IP-адрес. В этом сценарии после отработки отказа виртуальная машина получает новый IP-адрес, а также требуется обновление DNS.
- **Сохранение того же IP-адреса.** Вы можете использовать тот же IP-адрес для виртуальной машины реплики. Использование тех же IP-адресов упрощает процесс восстановления, уменьшая количество проблем с сетью после отработки отказа. 

## <a name="retaining-ip-addresses"></a>Сохранение IP-адресов

Если вы хотите сохранить IP-адреса с основного сайта после отработки отказа на дополнительный сайт, выполните полную отработку отказа подсети и обновите маршруты, чтобы указать новое расположение IP-адресов, или разверните растянутую подсеть между основным и дополнительным сайтами.

### <a name="stretched-subnet"></a>Растянутая подсеть

Растянутая подсеть доступна одновременно для основного и дополнительного сайта. Вы можете переместить сервер и его IP-конфигурацию (уровень 3) на дополнительный сайт, а сеть направит трафик в новое местоположение автоматически. 

С точки зрения уровня 2 (уровень связи данных) требуется сетевое оборудование, с помощью которого можно управлять растянутой виртуальной локальной сетью. Кроме того, при растягивании виртуальной локальной сети потенциальная возможность домена сбоя будет затрагивать оба объекта, которые, по сути, становятся единой точкой отказа. Хотя это маловероятно, может произойти сетевая буря, которую не получится изолировать. 


### <a name="subnet-failover"></a>Отработка отказа подсети

Вы можете выполнить отработку отказа в подсети, чтобы воспользоваться преимуществами растянутой подсети без фактического растягивания. В этом решении подсеть будет доступна на исходном или целевом сайте, но не на обоих одновременно. Чтобы сохранить пространство IP-адресов в случае отработки отказа, программными средствами можно сделать так, чтобы инфраструктура маршрутизаторов перемещала подсети с одного сайта на другой. После отработки отказа подсети переместятся со связанными виртуальными машинами. Основным недостатком является то, что в случае сбоя необходимо переместить всю подсеть.

### <a name="example"></a>Пример

Ниже приведен пример полной отработки отказа подсети. На основном объекте приложения работают в подсети 192.168.1.0/24. После отработки отказа все виртуальные машины в этой подсети переносятся на дополнительный сайт с сохранением IP-адресов. Маршруты необходимо изменить, чтобы указать, что все виртуальные машины, принадлежащих подсети 192.168.1.0/24, теперь перемещены на дополнительный сайт.

На следующем рисунке показаны подсети до и после отработки отказа:

- Перед отработкой отказа подсеть 192.168.0.1/24 активна на исходном сайте, а после него становится активной на дополнительном.
- Маршруты между основным сайтом и сайтом восстановления, третьим сайтом и основным сайтом, а также третьим сайтом и сайтом восстановления необходимо изменить соответствующим образом.

**Перед выполнением отработки отказа**

![Перед выполнением отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design2.png)

**После выполнения отработки отказа**

![После выполнения отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design3.png)

После отработки отказа происходит следующее:

- Site Recovery выделяет IP-адреса для каждого сетевого интерфейса на виртуальной машине из пула статических IP-адресов в соответствующей сети для каждого экземпляра VMM.
- Если пул IP-адресов на дополнительном сайте совпадает с пулом на исходном, Site Recovery выделяет виртуальной машине реплики одинаковые IP-адреса (исходной виртуальной машины). IP-адрес резервируется в VMM, но он не задан как IP-адрес для отработки отказа на узле Hyper-V. IP-адрес отработки отказа задается на узле Hyper-V непосредственно перед отработкой отказа.
- Если же IP-адрес недоступен, Site Recovery выделяет другой доступный адрес из пула.
- Если виртуальные машины используют DHCP, Site Recovery не управляет IP-адресами. Убедитесь, что DHCP-сервер на дополнительном сайте может выделить адрес из того же диапазона, как и на исходном сайте.

### <a name="validate-the-ip-address"></a>Проверка IP-адреса

После включения защиты для виртуальной машины воспользуйтесь следующим примером сценария, чтобы проверить назначенный ей адрес. Тот же IP-адрес будет задан в качестве IP-адреса отработки отказа и назначен виртуальной машине во время отработки отказа:

    ```
    $vm = Get-SCVirtualMachine -Name <VM_NAME>
    $na = $vm[0].VirtualNetworkAdapters>
    $ip = Get-SCIPAddress -GrantToObjectID $na[0].id
    $ip.address 
    ```

## <a name="changing-ip-addresses"></a>Изменение IP-адресов

В этом сценарии IP-адреса виртуальных машин, для которых выполняется отработка отказа, изменяются. Недостаток этого решения — необходимость в обслуживании. Как правило, DNS обновляется после запуска виртуальных машин реплики. Вам может потребоваться изменить DNS в сети и обновить кэшированные записи. Это может привести к возникновению простоя. Простой можно устранить следующим образом:

- Используйте низкие значения срока жизни для приложений интрасети.
- Используйте следующий сценарий в плане восстановления Site Recovery, чтобы обновить DNS-сервер и гарантировать своевременное обновление. Сценарий не требуется, если используется динамическая регистрация DNS.

    ```
    param(
    string]$Zone,
    [string]$name,
    [string]$IP
    )
    $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
    $newrecord = $record.clone()
    $newrecord.RecordData[0].IPv4Address  =  $IP
    Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord
    ```
    
### <a name="example"></a>Пример 

Рассмотрим сценарий, в котором планируется использовать разные IP-адреса на основном сайте и сайтах восстановления. В этом примере у нас есть разные IP-адреса на основных и дополнительных сайтах, а также имеется третий сайт, с которого можно получить доступ к приложениям, размещенным на основном сайте или сайте восстановления.

- Перед отработкой отказа приложения размещены в подсети 192.168.1.0/24 на основном сайте, а после него переходят в подсеть 172.16.1.0/24 на дополнительном сайте.
- VPN-подключения/сетевые маршруты были настроены так, чтобы все три объекта могли иметь доступ друг к другу.
- После отработки отказа приложения будут восстановлены в подсети восстановления. В этом сценарии не нужно выполнять отработку отказа всей подсети, а также вносить изменения для перенастройки VPN или сетевых маршрутов. Отработка отказа и некоторые обновления DNS обеспечивают доступность приложений.
- Если DNS настроен для разрешения динамических обновлений, после запуска по завершении отработки отказа виртуальные машины зарегистрируются, используя новый IP-адрес.

**Перед выполнением отработки отказа**

![Другой IP-адрес — до отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design10.png)

**После выполнения отработки отказа**

![Другой IP-адрес — после отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design11.png)





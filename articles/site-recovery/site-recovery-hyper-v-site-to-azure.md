---
title: "Репликация виртуальных машин Hyper-V в Azure | Документация Майкрософт"
description: "В этот статье описано, как управлять репликацией, отработкой отказа и восстановлением локальных виртуальных машин Hyper-V в Azure"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: 1777e0eb-accb-42b5-a747-11272e131a52
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 04/05/2017
ms.author: raynew
ROBOTS: NOINDEX, NOFOLLOW
redirect_url: hyper-v-site-walkthrough-overview
ms.openlocfilehash: 8a2ea92759a777b1178fbfe8084a97eec931f709
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="replicate-hyper-v-virtual-machines-without-vmm-to-azure-using-azure-site-recovery-with-the-azure-portal"></a>Репликация виртуальных машин Hyper-V (без VMM) в облако Azure с помощью службы Azure Site Recovery и портала Azure

> [!div class="op_single_selector"]
> * [Портал Azure](site-recovery-hyper-v-site-to-azure.md)
> * [Классическая модель Azure](site-recovery-hyper-v-site-to-azure-classic.md)
> * [PowerShell — Resource Manager](site-recovery-deploy-with-powershell-resource-manager.md)
>
>

В этой статье описано, как выполнить репликацию локальных виртуальных машин Hyper-V в Azure с помощью [Azure Site Recovery](site-recovery-overview.md) на портале Azure. В этом развертывании Hyper-V виртуальные машины не передаются под управление System Center Virtual Machine Manager (VMM).

Комментарии или вопросы технического характера можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

Если вы хотите перенести виртуальные машины в Azure (без восстановления размещения), воспользуйтесь рекомендациями из [этой статьи](site-recovery-migrate-to-azure.md).



## <a name="deployment-steps"></a>Шаги по развертыванию

Выполните шаги по развертыванию, следуя инструкциям в статье.

1. [Узнайте больше](site-recovery-components.md#hyper-v-to-azure) об архитектуре этого развертывания. Кроме того, [получите дополнительные сведения](site-recovery-hyper-v-azure-architecture.md) о выполнении репликации Hyper-V в Site Recovery.
2. Выполните предварительные требования и ознакомьтесь с ограничениями.
3. Настройте сеть и учетные записи хранения Azure.
4. Подготовьте узлы Hyper-V.
5. Создайте хранилище служб восстановления. которое содержит параметры конфигурации и управляет репликацией.
6. Укажите параметры источника. Создайте сайт Hyper-V, содержащий узлы Hyper-V, и зарегистрируйте этот сайт в хранилище. Установите на узлах Hyper-V поставщик Azure Site Recovery, а также агент служб восстановления Майкрософт.
7. Настройте параметры целевого объекта и репликации.
8. Включите репликацию для виртуальных машин.
9. Запустите тестовую отработку отказа, чтобы убедиться в надлежащей работе всех компонентов.



## <a name="prerequisites"></a>Предварительные требования


**Требование** | **Дополнительные сведения** |
--- | --- |
**Таблицы Azure** | Ознакомьтесь с [требованиями Azure](site-recovery-prereq.md#azure-requirements).
**Локальные серверы** | [Ознакомьтесь](site-recovery-prereq.md#disaster-recovery-of-hyper-v-virtual-machines-to-azure-no-virtual-machine-manager) с требованиями к локальным узлам Hyper-V.
**Локальные виртуальные машины Hyper-V** | Виртуальные машины, которые необходимо реплицировать, должны работать под управлением [поддерживаемой операционной системы](site-recovery-support-matrix-to-azure.md#support-for-replicated-machine-os-versions) и соответствовать [предварительным требованиям Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).
**URL-адреса Azure** | Узлы Hyper-V должны иметь доступ к следующим URL-адресам:<br/><br/> [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]<br/><br/> При использовании правил брандмауэра на основе IP-адресов убедитесь, что эти правила разрешают обмен данными с Azure.<br/></br> Разрешите доступ для [диапазонов IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и использование порта HTTPS (443).<br/></br> Необходимо разрешить доступ для диапазонов IP-адресов региона Azure, в котором располагается ваша подписка, и региона "Западная часть США" (используется для контроля доступа и управления удостоверениями).



## <a name="prepare-for-deployment"></a>Подготовка к развертыванию

Чтобы подготовиться к развертыванию, потребуется следующее:

1. [Настроить сеть](#set-up-an-azure-network) , в которой будут размещаться виртуальные машины Azure, созданные в результате отработки отказа.
2. [Настроить учетную запись хранения Azure](#set-up-an-azure-storage-account) для реплицированных данных.
3. [Подготовить узлы Hyper-V](#prepare-the-hyper-v-hosts) , чтобы они могли обращаться к необходимым URL-адресам.

### <a name="set-up-an-azure-network"></a>Настроить сеть

Настройка сети Azure. К этой сети должны будут подключиться виртуальные машины Azure, созданные после отработки отказа.

* Сеть должна располагаться в том же регионе, что и хранилище служб восстановления.
* В зависимости от модели ресурсов, которую будут использовать виртуальные машины Azure после отработки отказа, для сети Azure необходимо настроить [режим Resource Manager](../virtual-network/virtual-networks-create-vnet-arm-pportal.md) или [классический режим](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).
* Рекомендуется настроить сеть перед началом работы. В противном случае это нужно будет сделать во время развертывания службы Site Recovery.
- Учетные записи хранения, используемые для Site Recovery, нельзя [перемещать](../azure-resource-manager/resource-group-move-resources.md) как в пределах одной подписки, так и между разными подписками.


### <a name="set-up-an-azure-storage-account"></a>Настроить учетную запись хранения Azure

- Вам потребуется учетная запись хранения Azure класса Standard или Premium, в которой будут сохраняться реплицированные в Azure данные. Для виртуальных машин, которым требуется постоянная высокая производительность ввода-вывода и малая задержка для размещения интенсивных рабочих нагрузок ввода-вывода, мы рекомендуем использовать [хранилище класса Premium](../storage/storage-premium-storage.md).
- Если для хранения реплицированных данных вы будете использовать учетную запись хранения класса Premium, потребуется дополнительная учетная запись хранения класса Standard для хранения журналов репликации, в которые записываются текущие изменения локальных данных.
- В зависимости от модели ресурсов, которую будут использовать виртуальные машины Azure после отработки отказа, для учетной записи необходимо настроить [режим Resource Manager](../storage/storage-create-storage-account.md) или [классический режим](../storage/storage-create-storage-account-classic-portal.md).
- Рекомендуется настроить учетную запись хранения до начала работы. В противном случае это нужно будет сделать во время развертывания службы Site Recovery. Учетные записи должны находиться в том же регионе, что и хранилище служб восстановления.
- Учетные записи хранения, используемые для Site Recovery, нельзя перемещать между группами в одной подписке или между разными подписками.


### <a name="prepare-the-hyper-v-hosts"></a>Подготовить узлы Hyper-V

* Убедитесь, что узлы Hyper-V соответствуют [предварительным требованиям](site-recovery-prereq.md#disaster-recovery-of-hyper-v-virtual-machines-to-azure-no-virtual-machine-manager).
- Убедитесь, что узлы имеют доступ к нужным URL-адресам.


## <a name="create-a-recovery-services-vault"></a>Создание хранилища служб восстановления
1. Войдите на [портал Azure](https://portal.azure.com).
2. Щелкните **Создать** > **Мониторинг и управление** > **Резервное копирование и восстановление сайта**.  

    ![Новое хранилище](./media/site-recovery-hyper-v-site-to-azure/new-vault.png)

3. В поле **Имя**укажите понятное имя для идентификации хранилища. Если у вас имеется несколько подписок, выберите одну из них.

4. [Создайте группу ресурсов](../azure-resource-manager/resource-group-template-deploy-portal.md) или выберите уже имеющуюся и укажите регион Azure. В него будут реплицированы данные компьютеров. Сведения о поддерживаемых регионах см. в разделе "Географическая доступность" на странице [Расценки на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).

5. Если вам нужна возможность быстрого доступа к хранилищу из панели мониторинга, щелкните **Закрепить на панели мониторинга**, а затем — **Создать**.

    ![Новое хранилище](./media/site-recovery-hyper-v-site-to-azure/new-vault-settings.png)

Новое хранилище появится списке колонки **Панель мониторинга** > **Все ресурсы** и в основной колонке **Хранилища служб восстановления**.



## <a name="select-the-protection-goal"></a>Выбор целевого объекта защиты

Выберите целевые объекты и место для репликации.

1. В колонке **Хранилища служб восстановления** выберите хранилище.
2. В области **Приступая к работе** щелкните **Site Recovery** > **Подготовка инфраструктуры** > **Цель защиты**.

    ![Выбор цели](./media/site-recovery-hyper-v-site-to-azure/choose-goals.png)
3. На странице **Цель защиты** выберите **В Azure** и затем выберите **Да, с помощью Hyper-V**. Выберите **Нет** , чтобы подтвердить, что VMM не используется. Нажмите кнопку **ОК**.

    ![Выбор цели](./media/site-recovery-hyper-v-site-to-azure/choose-goals2.png)

## <a name="set-up-the-source-environment"></a>Настройка исходной среды

Настройте узел Hyper-V, установите поставщика Azure Site Recovery и агента служб восстановления Azure на узлах Hyper-V, затем зарегистрируйте сайт в хранилище.

1. В разделе **Подготовка инфраструктуры** щелкните **Источник**. Чтобы добавить новый узел Hyper-V в качестве контейнера для узлов или кластеров Hyper-V, щелкните **+Hyper-V Site**(+ Сайт Hyper-V).

    ![Настройка источника](./media/site-recovery-hyper-v-site-to-azure/set-source1.png)
2. В колонке **Создание сайта Hyper-V** укажите имя для сайта. Нажмите кнопку **ОК**. Теперь выберите созданный сайт и щелкните действие **Добавить сервер Hyper-V**, чтобы добавить сервер на сайт.

    ![Настройка источника](./media/site-recovery-hyper-v-site-to-azure/set-source2.png)

3. Убедитесь, что **сервер Hyper-V** отображается в разделе **Добавить сервер** > **Тип сервера**.

    - Убедитесь, что сервер Hyper-V Server, который вы хотите добавить, соответствует [предварительным требованиям](#on-premises-prerequisites) и имеет доступ к указанным URL-адресам.
    - Скачайте файл установки поставщика Azure Site Recovery. Запустите этот файл, чтобы установить поставщик и агент служб восстановления на каждый узел Hyper-V.

    ![Настройка источника](./media/site-recovery-hyper-v-site-to-azure/set-source3.png)


## <a name="install-the-provider-and-agent"></a>Установка поставщика и агента

1. Запустите файл установки поставщика на каждом узле, добавленном в узел Hyper-V. Если установка выполняется в кластер Hyper-V, программу установки необходимо запустить на каждом узле кластера. Установка и регистрация всех узлов кластера Hyper-V гарантирует, что виртуальные машины будут защищены даже при переносе между узлами.
2. Обновления можно включить на странице **Центр обновления Майкрософт**. Это позволит устанавливать обновления поставщика в соответствии с политикой Центра обновления Майкрософт.
3. На странице **Установка** примите или измените расположение установки поставщика по умолчанию и нажмите кнопку **Установить**.
4. На странице **Параметры хранилища** нажмите кнопку **Обзор**, чтобы выбрать скачанный файл ключа хранилища. Укажите подписку Azure Site Recovery, имя хранилища и узла Hyper-V, к которому относится сервер Hyper-V.

    ![Регистрация сервера](./media/site-recovery-hyper-v-site-to-azure/provider3.png)

5. В окне **Параметры Интернета** укажите параметры для подключения поставщика, который будет выполняться на узлах Hyper-V, к Azure Site Recovery через Интернет.

    * Чтобы поставщик подключался напрямую, установите переключатель **Подключиться к Azure Site Recovery напрямую без прокси-сервера**.
    * Если для имеющегося прокси-сервера требуется проверка подлинности или для подключения к провайдеру нужно использовать пользовательский прокси-сервер, выберите **Подключиться к Azure Site Recovery с использованием прокси-сервера**.
    * При использовании прокси-сервера:
        - укажите адрес, порт и учетные данные;
        - убедитесь, что он не блокирует URL-адреса, описанные в [предварительных требованиях](#prerequisites).

    ![Интернет](./media/site-recovery-hyper-v-site-to-azure/provider7.PNG)

6. После завершения установки нажмите кнопку **Зарегистрировать**, чтобы зарегистрировать сервер в хранилище.

    ![Расположение установки](./media/site-recovery-hyper-v-site-to-azure/provider2.png)

7. Когда регистрация завершится, Azure Site Recovery извлечет метаданные с сервера Hyper-V, а сам сервер отобразится в колонке **Инфраструктура Site Recovery**  > **Узлы Hyper-V**.


## <a name="set-up-the-target-environment"></a>Настройка целевой среды

Укажите учетную запись хранения Azure для репликации и сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.

1. Выберите **Подготовка инфраструктуры** > **Цель**.
2. Выберите подписку и группу ресурсов, в которых вы хотите создавать виртуальные машины Azure после отработки отказа. Выберите модель развертывания, которая будет использоваться в Azure (классическая или Resource Manager) для этих виртуальных машин.

3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

    - Если у вас нет учетной записи хранения, нажмите кнопку **+Хранилище**, чтобы прямо сейчас создать учетную запись на основе модели Resource Manager. Изучите [требования к хранилищу](site-recovery-prereq.md#azure-requirements).
    - Если у вас нет учетной сети Azure, нажмите кнопку **+Сеть**, чтобы прямо сейчас создать сеть на основе модели Resource Manager.

    ![Хранилище](./media/site-recovery-vmware-to-azure/enable-rep3.png)




## <a name="configure-replication-settings"></a>Настройка параметров репликации

1. Чтобы создать политику репликации, выберите **Подготовка инфраструктуры** > **Параметры репликации** > **Создание и связывание**.

    ![Сеть](./media/site-recovery-hyper-v-site-to-azure/gs-replication.png)
2. На странице **Создать и связать политику**укажите имя политики.
3. В раскрывающемся списке **Частота копирования**выберите периодичность репликации изменений данных после начальной репликации (каждые 30 секунд, 5 или 15 минут).

    > [!NOTE]
    > Частота 30 секунд не поддерживается при репликации в хранилище класса Premium. Это ограничение связано с ограничением в 100 моментальных снимков на большой двоичный объект, которые можно сохранить в хранилище класса Premium. [Подробнее](../storage/storage-premium-storage.md#snapshots-and-copy-blob).

4. В поле **Хранение точки восстановления** укажите продолжительность периода хранения для каждой точки восстановления (в часах). Виртуальные машины можно будет восстановить до любой точки в пределах этого периода.
5. В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, как часто (от 1-12 до часов) нужно создавать точки восстановления, содержащие согласованные на уровне приложений моментальные снимки.

    - Hyper-V использует два типа резервного копирования: стандартное резервное копирование, обеспечивающее создание добавочных резервных копий всей виртуальной машины, и соответствующие приложению моментальные снимки, обеспечивающие создание моментального снимка данных приложений в виртуальной машине на момент времени.
    - Функция моментальных снимков, соответствующих приложению, использует службу теневого копирования томов (VSS), чтобы гарантировать согласованное состояние приложений на момент создания снимка.
    - Использование моментальных снимков, согласованных на уровне приложений, влияет на производительность приложений, выполняющихся на исходных виртуальных машинах. Заданное значение должно быть меньше числа настроенных дополнительных точек восстановления.

6. В поле **Время запуска начальной репликации** укажите, когда должна запускаться начальная репликация. При репликации используется полоса пропускания Интернета. Поэтому проведение репликации нужно запланировать на свободное от работы время. Нажмите кнопку **ОК**.

    ![Политика репликации](./media/site-recovery-hyper-v-site-to-azure/gs-replication2.png)

При создании политики она автоматически сопоставляется с сайтом Hyper-V. Сайт Hyper-V (и входящие в него виртуальные машины) можно связать с несколькими политиками репликации, последовательно выбрав **Репликация** > имя_политики > **Связать сайт Hyper-V**.

## <a name="capacity-planning"></a>Планирование загрузки

Завершив настройку базовой инфраструктуры, вы можете перейти к планированию ресурсов, чтобы выяснить, нужны ли дополнительные ресурсы.

Планировщик ресурсов Site Recovery позволяет выделить требуемые ресурсы для вычислений, сети и хранилища. Вы можете запустить планировщик в быстром режиме, чтобы получить оценку на основе среднего числа виртуальных машин и дисков, а также среднего объема хранилища. В расширенном режиме оценка учитывает определенные показатели на уровне рабочей нагрузки. Прежде всего необходимо сделать следующее:

* Соберите сведения о среде репликации, включая информацию о виртуальных машинах, количестве дисков на виртуальную машину и объеме хранилища на диск.
* Определите объем ежедневных изменений (обновлений) для реплицируемых данных. Для этого можно воспользоваться [планировщиком ресурсов для реплики Hyper-V](https://www.microsoft.com/download/details.aspx?id=39057) .

1. Щелкните **Скачать**, чтобы скачать этот инструмент, и запустите его. Сведения об этом инструменте см. в [этой статье](site-recovery-capacity-planner.md).
2. После этого в поле **Have you run the Capacity Planner?** (Вы запустили планировщик ресурсов?) выберите **Да**.

   ![Планирование загрузки](./media/site-recovery-hyper-v-site-to-azure/gs-capacity-planning.png)

См. дополнительные сведения об [управлении пропускной способностью сети](#network-bandwidth-considerations).



## <a name="enable-replication"></a>Включение репликации

Прежде чем начать, убедитесь, что учетная запись пользователя Azure содержит [разрешения](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines), необходимые для включения репликации новой виртуальной машины в Azure.

Включите репликацию для виртуальных машин, сделав следующее.          

1. Выберите **Репликация приложения** > **Источник**. Когда вы закончите настройку репликации, щелкните **+Реплицировать**, чтобы включить репликацию для дополнительных виртуальных машин.

    ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication.png)
2. В колонке **Источник** выберите сайт Hyper-V. Нажмите кнопку **ОК**.
3. В поле **Целевой объект** выберите подписку хранилища и модель отработки отказа (классическую или на основе Resource Manager), которую следует использовать в Azure после отработки отказа.
4. Выберите учетную запись хранения, которую нужно использовать. Если у вас нет учетной записи, которую можно использовать, [создайте ее](#set-up-an-azure-storage-account). Нажмите кнопку **ОК**.
5. Выберите сеть и подсеть Azure, к которой будут подключаться виртуальные машины Azure, созданные после отработки отказа.

    - Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым виртуальным машинам.
    - Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера.
    - Если у вас нет сети, которую можно использовать, [создайте ее](#set-up-an-azure-network). Выберите подсеть (если это применимо). Нажмите кнопку **ОК**.

   ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication11.png)

6. В разделе **Виртуальные машины** > **Выбор виртуальных машин**, выберите каждую машину, которую нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**.

    ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication5-for-exclude-disk.png)

7. В поле **Свойства** > **Настройка свойств**, выберите операционную систему для выбранных виртуальных машин и диск операционной системы.
8. Убедитесь, что имя виртуальной машины Azure (имя целевого объекта) соответствует [требованиям к виртуальным машинам Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).
9. По умолчанию для репликации выбраны все диски виртуальной машины, но вы можете исключить отдельные диски, сняв с них выделение.
    - Исключение некоторых дисков позволит снизить связанную с репликацией нагрузку на сеть. Например, репликация может не требоваться для дисков с временными данными или данными, которые обновляются при каждом перезапуске виртуальной машины или приложения (например, для файлов pagefile.sys или базы данных tempdb Microsoft SQL Server). Чтобы исключить диск из репликации, достаточно отменить его выбор.
    - Исключать можно только базовые диски. Нельзя исключить диски операционной системы.
    - Мы не рекомендуем исключать динамические диски. Site Recovery не может определить тип виртуального жесткого диска (базовый или динамический) в гостевой виртуальной машине. Если все зависимые динамические диски не исключены, то при отработке отказа виртуальной машины защищенный динамический диск будет считаться неисправным и данные на нем будут недоступны.
        - После включения репликации добавить или удалить диски для репликации нельзя. Если вы хотите добавить или исключить диск, перед внесением изменений отключите защиту виртуальной машины, а затем включите ее повторно.
        - Диски, созданные в Azure вручную, не будут восстановлены в исходном расположении. Например, если вы выполните отработку отказа трех дисков и создадите два диска непосредственно на виртуальной машине Azure, восстановление размещения из Azure в Hyper-V будет выполнено только для трех дисков, задействованных при отработке отказа. Восстановление размещения после сбоя и обратная репликация из Hyper-V в Azure недоступны для дисков, созданных вручную.
        - Если вы исключили диск, необходимый для работы приложения, для выполнения реплицируемого приложения после отработки отказа в Azure вам необходимо будет создать его в Azure вручную. Также вы можете интегрировать службу автоматизации Azure в план восстановления, чтобы диск создавался автоматически во время отработки отказа виртуальной машины.

10. Нажмите кнопку **OK**, чтобы сохранить изменения. Позже можно задать дополнительные свойства.

    ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication6-with-exclude-disk.png)

11. Щелкнув **Параметры репликации** > **Настройка параметров репликации**, выберите политику репликации, которую необходимо применить к защищенным виртуальным машинам. Нажмите кнопку **ОК**. Политику репликации можно изменить, последовательно выбрав **Политики репликации** > имя_политики > **Изменить параметры**. Изменения будут применяться к компьютерам, для которых уже выполняется репликация, и к новым компьютерам.


   ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/enable-replication7.png)

Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Задания** > **Задания Azure Site Recovery**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.

### <a name="view-and-manage-vm-properties"></a>Просмотр свойств виртуальной машины и управление ими

Рекомендуется проверить свойства исходного компьютера.

1. В разделе **Защищенные элементы** щелкните **Реплицированные элементы** и выберите виртуальную машину.

    ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/test-failover1.png)
2. На разделе **Свойства** можно просмотреть сведения о репликации и отработке отказа для виртуальной машины.

    ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/test-failover2.png)
3. В разделе **Вычисления и сеть** > **Свойства вычислений** можно указать имя и целевой размер виртуальной машины Azure. При необходимости измените имя в соответствии с требованиями Azure. Кроме того, можно просмотреть и изменить сведения о целевой сети, подсети и целевом IP-адресе, который будет назначен виртуальной машине Azure. Обратите внимание на следующее.

   * Вы можете задать целевой IP-адрес. Если не указать его, компьютер, для которого выполнена отработка отказа, будет использовать DHCP. Если задать адрес, недоступный при отработке отказа, произойдет сбой. Этот же целевой IP-адрес можно использовать для тестовой отработки отказа, если он доступен в сети тестовой отработки отказа.
   * Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины:

     * Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.
     * Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, то будет использовать максимальный размер целевой машины.
     * Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, то на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер.     
     * Если для виртуальной машины настроено несколько сетевых адаптеров, они будут подключены к одной сети.
     * Если виртуальная машина имеет несколько сетевых адаптеров, сетевым адаптером *по умолчанию* для этой виртуальной машины Azure станет тот из них, который расположен в списке первым.

     ![Включение репликации](./media/site-recovery-hyper-v-site-to-azure/test-failover4.png)

4. На странице **Диски** отображаются сведения о дисках операционной системы и дисках данных на виртуальной машине, для которой будет выполняться репликация.

#### <a name="managed-disks"></a>Управляемые диски

В разделе **Compute and Network** > **Compute properties** (Вычисления и сеть > Свойства вычислений) задайте для свойства "Использование управляемых дисков" значение "Да", если вы хотите подключить управляемые диски к виртуальной машине для миграции в Azure. Управляемые диски упрощают управление дисками виртуальных машин Azure IaaS. Они управляют учетными записями хранения, связанными с этими дисками. [Узнайте больше об управляемых дисках](https://docs.microsoft.com/en-us/azure/storage/storage-managed-disks-overview).

   - Управляемые диски создаются и подключаются к виртуальной машине только при отработке отказа в Azure. После включения защиты данные из локальных компьютеров будут продолжать выполнять репликацию в учетные записи хранения.
   Управляемые диски можно создавать только для виртуальных машин, развернутых с помощью модели развертывания Resource Manager.

  > [!NOTE]
  > Сейчас восстановление размещения из Azure в локальную среду Hyper-V не поддерживается для виртуальных машин с управляемыми дисками. Задайте для свойства "Использование управляемых дисков" значение "Да", только если вы планируете перенести эту машину в Azure.

   - Если для свойства "Использование управляемых дисков" задано значение "Да", для выбора будут доступны только группы доступности с заданным свойством в группе ресурсов. Это связано с тем, что виртуальные машины с управляемыми дисками могут быть частью только групп доступности с заданным для свойства "Использование управляемых дисков" значением "Да". Убедитесь, что вы создали группы доступности с заданным свойством "Использование управляемых дисков" на основании намерения использовать управляемые диски при отработке отказа. Точно так же, если для свойства "Использование управляемых дисков" задано значение "Нет", только группы доступности с заданным свойством в группе ресурсов будут доступны для выбора. [Узнайте больше об управляемых дисках и группах доступности](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/manage-availability#use-managed-disks-for-vms-in-an-availability-set).

  > [!NOTE]
  > Если учетная запись хранения, используемая для репликации, была зашифрована с помощью шифрования службы хранилища по состоянию на любой момент времени, создание управляемых дисков во время отработки отказа завершится ошибкой. Вы можете присвоить свойству "Использование управляемых дисков" значение "Нет" либо повторить отработку отказа или отключить защиту виртуальной машины и защитить ее с помощью учетной записи хранения, для которой не включено шифрование службы хранилища по состоянию на любой момент времени.
  > [Узнайте больше о шифровании службы хранилища и управляемых дисках](https://docs.microsoft.com/en-us/azure/storage/storage-managed-disks-overview#managed-disks-and-encryption).


## <a name="test-the-deployment"></a>тестирование развертывания

Чтобы протестировать развертывание, можно запустить тестовую отработку отказа для отдельной виртуальной машины или создать план восстановления для одной или нескольких виртуальных машин.

### <a name="before-you-start"></a>Перед началом работы

 - Если вам нужно, чтобы после отработки отказа к виртуальным машинам Azure можно было подключиться по протоколу RDP, см. эти [рекомендации](site-recovery-test-failover-to-azure.md#prepare-to-connect-to-azure-vms-after-failover).
 - Чтобы полностью проверить систему, скопируйте Active Directory и DNS в тестовую среду. [Подробнее](site-recovery-active-directory.md#test-failover-considerations).

### <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

1. Чтобы выполнить отработку отказа для одного компьютера, в разделе **Реплицированные элементы** щелкните виртуальную машину, а затем — значок **Тестовая отработка отказа**.
2. Чтобы выполнить отработку отказа по плану восстановления, в разделе **Планы восстановления** щелкните план правой кнопкой мыши и выберите **Тестовая отработка отказа**. Чтобы создать план восстановления, [выполните эти инструкции](site-recovery-create-recovery-plans.md).
3. На странице **Тестовая отработка отказа** выберите сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.
4. Нажмите кнопку **ОК** , чтобы запустить отработку отказа. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину, или в задании **тестовой отработки отказа**, выбрав имя хранилища > **Задания** > **Задания Azure Site Recovery**.
5. После завершения отработки отказа реплика виртуальной машины Azure появится на портале Azure в разделе **Виртуальные машины**. Следует убедиться, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает.
6. Если вы заранее подготовились к подключению после отработки отказа, вы сможете подключиться к виртуальной машине Azure.
7. Когда все будет готово, нажмите кнопку **Очистить тестовую отработку отказа** в плане восстановления. При необходимости в разделе **примечаний** можно записать и сохранить ваши наблюдения касательно тестовой отработки отказа. Это приведет к удалению виртуальных машин, созданных при тестовой отработке отказа.

Ознакомьтесь с дополнительными сведениями о [тестовой отработке отказа в Azure](site-recovery-test-failover-to-azure.md).



## <a name="monitor-the-deployment"></a>Мониторинг развертывания

Описанные ниже действия позволят отслеживать параметры конфигурации, состояние и работоспособность развертывания Site Recovery.

1. Щелкните имя хранилища, чтобы открыть панель мониторинга **Основные компоненты** . На этой панели мониторинга можно просмотреть сведения о заданиях Site Recovery, состоянии репликации, планах восстановления, работоспособности сервера и событиях.  

    ![Основные компоненты](./media/site-recovery-hyper-v-site-to-azure/essentials.png)
2. В элементе **Работоспособность** можно следить за серверами сайта, в которых возникают ошибки, а также за событиями, которые произошли в Site Recovery за последние 24 часа. Эту панель можно настроить таким образом, чтобы на ней отображались самые необходимые элементы и макеты, а также сведения о состоянии других хранилищ Site Recovery и службы архивации.
3. Мониторинг репликации и управление ею можно осуществлять в элементах **Реплицированные элементы**, **Планы восстановления** и **Задания Site Recovery**. Чтобы получить подробные сведения о заданиях, выберите **Задания** > **Задания Azure Site Recovery**.

## <a name="command-line-provider-and-agent-installation"></a>Установки поставщика и агента из командной строки

Поставщик и агент Azure Site Recovery также можно установить с помощью приведенной ниже командной строки. Этот метод можно использовать для установки поставщика на основные серверные компоненты Windows Server 2012 R2.

1. Скачайте файл установки поставщика и ключ регистрации в папку. Например, C:\ASR.
2. В командной строке с повышенными правами запустите следующие команды, чтобы извлечь установщик поставщика:

            C:\Windows\System32> CD C:\ASR
            C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q
3. Выполните следующую команду для установки компонентов:

            C:\ASR> setupdr.exe /i
4. Затем выполните следующие команды для регистрации сервера в хранилище:

            CD C:\Program Files\Microsoft Azure Site Recovery Provider\
            C:\Program Files\Microsoft Azure Site Recovery Provider\> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file>

<br/>
Описание

* **/Credentials**: обязательный параметр, который задает расположение ключа регистрации.  
* **/FriendlyName**— обязательный параметр для имени сервера узла Hyper-V, который отображается на портале Azure Site Recovery.
* **/proxyAddress**— необязательный параметр, определяющий адрес прокси-сервера.
* **/proxyport** : необязательный параметр, указывающий порт прокси-сервера.
* **/proxyUsername**— необязательный параметр, определяющий имя пользователя прокси-сервера (если прокси-сервер требует аутентификацию).
* **/proxypassword**— необязательный параметр, который указывает пароль для аутентификации на прокси-сервере (если прокси-сервер требует аутентификацию).


## <a name="network-bandwidth-considerations"></a>Рекомендации по пропускной способности сети
С помощью [планировщика ресурсов Hyper-V](site-recovery-capacity-planner.md) можно рассчитать пропускную способность, необходимую для репликации (начальная и разностная репликации данных). Существует несколько вариантов управления объемом пропускной способности, используемой для репликации:

* **Регулирование пропускной способности.** Трафик Hyper-V, который реплицируется в Azure, проходит через определенный узел Hyper-V. Пропускную способность можно регулировать на сервере этого узла.
* **Настройка пропускной способности**. Пропускную способность, используемую для репликации, можно изменить с помощью нескольких разделов реестра.

### <a name="throttle-bandwidth"></a>Регулирование пропускной способности
1. Откройте на сервере узла Hyper-V оснастку MMC в службе архивации Microsoft Azure. По умолчанию ярлык для службы архивации Microsoft Azure доступен на рабочем столе или в папке C:\Program Files\Microsoft Azure Recovery Services Agent\bin\wabadmin.
2. В оснастке щелкните **Изменить свойства**.
3. На вкладке **Регулирование** установите флажок **Разрешить регулирование пропускной способности интернет-канала для операций архивации** и задайте ограничения для рабочего и нерабочего времени. Допустимы значения в диапазоне от 512 Кбит/с до 102 Мбит/с.

    ![Регулирование пропускной способности](./media/site-recovery-hyper-v-site-to-azure/throttle2.png)

Чтобы настроить регулирование, можно также использовать командлет [Set-OBMachineSetting](https://technet.microsoft.com/library/hh770409.aspx) . Рассмотрим пример:

    $mon = [System.DayOfWeek]::Monday
    $tue = [System.DayOfWeek]::Tuesday
    Set-OBMachineSetting -WorkDay $mon, $tue -StartWorkHour "9:00:00" -EndWorkHour "18:00:00" -WorkHourBandwidth  (512*1024) -NonWorkHourBandwidth (2048*1024)

**Set-OBMachineSetting -NoThrottle** указывает, что регулирование не требуется.

### <a name="influence-network-bandwidth"></a>Изменение пропускной способности сети
1. В реестре перейдите в раздел **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication**.
   * Чтобы изменить скорость передачи данных при репликации диска, задайте новое значение для раздела **UploadThreadsPerVM**или создайте его, если он еще не существует.
   * Чтобы изменить скорость передачи данных при восстановлении размещения из Azure, задайте новое значение для раздела **DownloadThreadsPerVM**.
2. Значение по умолчанию — 4. В сети со значительным избыточным резервом для этих разделов реестра необходимо изменить значения по умолчанию. Максимальное значение — 32. Следите за трафиком для оптимизации значения.

## <a name="next-steps"></a>Дальнейшие действия

Когда начальная репликация завершится и вы проверите работу развертывания, отработку отказа можно будет использовать в любой момент, как только возникнет необходимость. [Узнайте больше](site-recovery-failover.md) о разных типах отработки отказа и способах их выполнения.

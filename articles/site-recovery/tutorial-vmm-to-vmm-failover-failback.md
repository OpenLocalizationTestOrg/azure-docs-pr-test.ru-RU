---
title: "Отработка отказа и восстановление размещения виртуальных машин Hyper-V, реплицированных в дополнительный центр обработки данных, с помощью Site Recovery | Документация Майкрософт"
description: "Узнайте, как выполнять отработку отказа виртуальных машин Hyper-V в дополнительный центр обработки данных и восстанавливать размещение на основном сайте с помощью Azure Site Recovery"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 44a662fa-2e7a-4996-86df-fdd6d6f5dedf
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 09/16/2017
ms.author: raynew
ms.openlocfilehash: 8f139070de99c4249207d048d445e86dd41e9060
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="fail-over-and-fail-back-hyper-v-vms-replicated-to-your-secondary-on-premises-site"></a>Отработка отказа и восстановление размещения виртуальных машин Hyper-V, реплицированных на дополнительный локальный сайт

Служба [Azure Site Recovery](site-recovery-overview.md) управляет репликацией, отработкой отказа и восстановлением размещения локальных компьютеров и виртуальных машин Azure.

В этом руководстве описано, как выполнять отработку отказа виртуальной машины Hyper-V, управляемой в облаке System Center Virtual Machine Manager, на дополнительный сайт VMM. Восстановление размещения на локальном сайте после отработки отказа происходит в тех ситуациях, когда это возможно. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Отработка отказа виртуальной машины Hyper-V из основного облака VMM в дополнительное.
> * Повторное включение защиты с дополнительного сайта на основной и выполнение восстановления размещения.
> * Репликация с основного сайта на дополнительный (при необходимости).

## <a name="overview"></a>Обзор

Отработка отказа и восстановление размещения происходит в три этапа:

1. **Отработка отказа с переходом на дополнительный сайт.** Отработка отказа компьютера с основного сайта на дополнительный.
2. **Восстановление размещения с дополнительного сайта.** Репликация виртуальных машин с дополнительного сайта на основной и запуск запланированной отработки отказа для восстановления размещения.
3. После плановой отработки отказа при необходимости можно начать репликацию с основного сайта на дополнительный еще раз.


## <a name="fail-over-to-a-secondary-site"></a>Отработка отказа на дополнительный сайт

### <a name="failover-prerequisites"></a>Необходимые условия для отработки отказа

Убедитесь, что [отработка аварийного восстановления](tutorial-dr-drill-secondary.md) выполнена, чтобы быть уверенным в надлежащей работе всех компонентов.


### <a name="run-a-failover-from-primary-to-secondary"></a>Выполнение отработки отказа с основного сайта на дополнительный

Для виртуальных машин Hyper-V можно выполнить обычную или плановую отработку отказа.

- Обычная отработка отказа используется при непредвиденных сбоях. При запуске этой отработки отказа Site Recovery создает виртуальную машину на дополнительном сайте и запускает ее. Выполняется отработка отказа определенной точки восстановления. В зависимости от используемой точки восстановления может произойти потеря данных.
- Плановую отработку отказа можно использовать при обслуживании и во время тестового сбоя. Этот вариант обеспечивает сохранение всех данных. После запуска плановой отработки отказа исходные виртуальные машины завершают работу. Несинхронизированные данные синхронизируются, и запускается отработка отказа. 
- 
Далее описано, как выполнять обычную отработку отказа.


1. В разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину и щелкните **Отработка отказа**.
2. В разделе **Отработка отказа** выберите **точку восстановления**, в которую будет выполнена отработка отказа. Можно выбрать один из следующих вариантов:
    - **Последние** (по умолчанию). В этом случае сначала обрабатываются все данные, отправляемые в Site Recovery. Этот вариант обеспечивает самое низкое значение RPO (целевая точка восстановления), так как реплицируемая виртуальная машина, созданная после отработки отказа, будет иметь все данные, реплицированные в службу Site Recovery до момента активации отработки отказа.
    - **Последняя обработанная.** Отработка отказа выполняется до последней точки восстановления виртуальной машины, которая была обработана Site Recovery. Этот вариант обеспечивает низкий показатель целевого времени восстановления, так как не требует времени на обработку данных.
    - **Latest app-consistent** (Последняя точка во времени согласованности приложений). Отработка отказа виртуальной машины выполняется до последней точки восстановления с согласованным состоянием приложений, которая была обработана Site Recovery. 
3. Ключ шифрования не подходит для данного сценария.
4. Выберите **Shut down machine before beginning failover** (Завершение работы виртуальной машины перед началом отработки отказа), чтобы служба Site Recovery попыталась выключить исходные виртуальные машины, прежде чем запускать отработку отказа. Site Recovery также предпримет попытку синхронизировать локальные данные, которые еще не были отправлены на дополнительный сайт, перед запуском отработки отказа. Обратите внимание, что отработка отказа продолжится, даже если при отключении произойдет сбой. На странице **Задания** можно следить за ходом выполнения отработки отказа.
5. Теперь виртуальная машина отобразится в дополнительном облаке VMM.
6. После проверки виртуальной машины **зафиксируйте** отработку отказа. При этом будут удалены все доступные точки восстановления.

> [!WARNING]
> **Не отменяйте выполняющуюся отработку отказа**. Перед запуском отработки отказа останавливается репликация виртуальной машины. Если отменить выполняющуюся отработку отказа, она остановится, но виртуальная машина не будет реплицирована повторно.  


## <a name="reprotect-and-fail-back-from-secondary-to-primary"></a>Повторное включение защиты и восстановление размещения на основной сайт

### <a name="prerequisites-for-failback"></a>Необходимые условия для восстановления размещения

Чтобы выполнить восстановление размещения, убедитесь, что основной и дополнительный серверы VMM подключены к Site Recovery.


### <a name="reprotect-and-fail-back"></a>Повторное включение защиты и восстановление размещения

Запустите репликацию с дополнительного сайта на основной и выполните восстановление размещения на основной сайт. После запуска виртуальных машин на основном сайте их можно реплицировать на дополнительный сайт еще раз.  

1. В разделе **Параметры** > **Реплицированные элементы** щелкните виртуальную машину и щелкните **Обратная репликация**. Виртуальная машина начнет реплицироваться обратно на основной сайт.
2. Щелкните виртуальную машину и выберите **Плановая отработка отказа**.
3. В разделе **Подтвердить плановую отработку отказа** проверьте направление отработки отказа (из дополнительного облака VMM) и выберите исходное и целевое расположение. 
4. В разделе **Синхронизация данных** укажите способ синхронизации:
    - **Синхронизация данных до отработки отказа (синхронизация только изменений).** Этот параметр сводит к минимуму время простоя виртуальных машин, так как синхронизация выполняется без завершения их работы. Выполняются следующие операции:
        - Создается моментальный снимок реплики виртуальной машины и копируется в основной узел Hyper-V. Реплицируемая виртуальная машина продолжает работу.
        - Завершает работу реплика виртуальной машины, поэтому никаких новых изменений не происходит. Окончательный набор разностных изменений переносится на основной сайт, а виртуальная машина на основном сайте запускается.
    - **Синхронизация данных только во время отработки отказа (полное скачивание).** Укажите этот параметр, если дополнительный сайт использовался в течение длительного времени. Это более быстрый вариант, так как ожидается несколько изменений на диске и не тратится время на подсчеты контрольных сумм. При использовании этого варианта скачивается диск. Он также полезен, если основная виртуальная машина была удалена.
5. Ключ шифрования не подходит для данного сценария.
6. Запустите отработку отказа. На вкладке **Задания** можно следить за ходом выполнения отработки отказа.
7. Если синхронизация данных выполняется перед отработкой отказа, то когда вы будете готовы завершить работу реплики виртуальной машины на дополнительном сайте после изначальной синхронизации данных, выберите **Задания**, имя задания плановой отработки отказа и **Завершение отработки отказа**. При этом завершается работа дополнительной виртуальной машины, передаются последние изменения на основной сайт и запускается основная виртуальная машина.
8. Проверьте, доступна ли виртуальная машина в основном облаке VMM.
9. Основная виртуальная машина теперь находится в состоянии ожидания фиксации. Для фиксации отработки отказа выберите команду **Зафиксировать**.
10. Если вам нужно запустить репликацию основной виртуальной машины на дополнительный сайт еще раз, включите **обратную репликацию**.


> [!NOTE]
> При этом реплицируются только изменения с момента выключения реплики виртуальной машины и отправляются только разностные изменения.


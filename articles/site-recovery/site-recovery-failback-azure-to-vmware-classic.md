---
title: "aaaFail обратно виртуальных машин VMware из Azure в классическом портале hello | Документы Microsoft"
description: "Дополнительные сведения о неудачных toohello назад на локальный сайт после отработки отказа виртуальных машин VMware и физических серверов tooAzure."
services: site-recovery
documentationcenter: 
author: ruturaj
manager: mkjain
editor: 
ms.assetid: 7ca86e21-7a5d-45ab-8f4b-e42da90f199a
ms.service: site-recovery
ms.devlang: na
ms.tgt_pltfrm: na
ms.topic: article
ms.workload: storage-backup-recovery
ms.date: 06/05/2017
ms.author: ruturajd
ms.openlocfilehash: 80bc3ab2708a5df953c6532b353da19a4c44ac34
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="fail-back-vmware-virtual-machines-and-physical-servers-toohello-on-premises-site-classic-portal"></a>Сбой обратной виртуальных машин VMware и физических серверов toohello локального сайта (классический портал)
> [!div class="op_single_selector"]
> * [Портал Azure](site-recovery-failback-azure-to-vmware.md)
> * [Классический портал Azure](site-recovery-failback-azure-to-vmware-classic.md)
> * [Классический портал Azure (прежняя версия)](site-recovery-failback-azure-to-vmware-classic-legacy.md)
>
>

Статьях описывается, как toofail обратно виртуальных машин Azure из Azure toohello на локальном сайте. Выполните инструкции hello в этой статье, когда вы будете готовы toofail резервное виртуальные машины VMware или физических серверов Windows и Linux после отказа от hello локального сайта tooAzure с помощью этого [учебника](site-recovery-vmware-to-azure-classic.md).

## <a name="overview"></a>Обзор
На этой диаграмме показана архитектура восстановления размещения hello для этого сценария.

При использовании этой архитектуры при hello сервера обработки — в локальной среде и использовании ExpressRoute.

![](./media/site-recovery-failback-azure-to-vmware-classic/architecture.png)

При использовании этой архитектуры при сервера обработки hello — в Azure и виртуальную частную сеть или подключение ExpressRoute.

![](./media/site-recovery-failback-azure-to-vmware-classic/architecture2.png)

Полный список toosee hello портов и архитектура схемы hello восстановления размещения см. ниже рисунке toohello

![](./media/site-recovery-failback-azure-to-vmware-classic/Failover-Failback.png)

Ниже приведены этапы восстановления размещения.

* После отказа tooAzure, вы завершаться обратной tooyour локального сайта в несколько этапов:
  * **Этап 1**: Защитите hello виртуальных машинах Azure, чтобы они запустить репликацию задней tooVMware виртуальных машин, работающих на узле локально. Включение повторно перемещает hello виртуальной Машины в группу защиты восстановления размещения, которая была автоматически создана при первоначальном создании группы защиты hello отработки отказа. При добавлении плана восстановления отработка отказа защиты группы tooa группы защиты восстановления размещения hello также автоматически добавлен toohello плана.  Во время повторной защиты можно указать, как резервного tooplan toofail.
  * **Этап 2**: после виртуальных машин Azure, реплицируются на локальном сайте tooyour, выполнении сбой через toofail из Azure.
  * **Этап 3**: после данных произошел сбой обратно, Защитите hello локальных виртуальных машин, которые разработчик не передаются, чтобы они запустить репликацию tooAzure.


  [!VIDEO https://channel9.msdn.com/Blogs/Azure/Enhanced-VMware-to-Azure-Failback/player]

### <a name="failback-toohello-original-or-alternate-location"></a>Восстановление после сбоя toohello исходное или другое расположение
Если отработка отказа виртуальной Машины VMware может завершиться ошибкой задней toohello таким же источника виртуальной Машины, если он по-прежнему существует в локальной среде. В этом сценарии только незначительные изменения hello не будет выполнен обратно. Обратите внимание на следующее.

* Если отработка отказа физических серверов, а затем восстановления размещения всегда является tooa новой виртуальной Машины VMware.
  * Перед восстановлением размещения на физический компьютер обратите внимание, что
  * Физической машины, защищенной перейдет в качестве виртуальной машины при переключении обратно из Azure tooVMware
  * Убедитесь, что вы обнаружите, по меньшей мере один главный целевой сервер вместе с hello при необходимости toowhich узлах ESX/ESXi необходимо toofailback.
* Если снова не требуется toohello исходной виртуальной Машины hello следующее:

  * Если hello виртуальной Машины находится под управлением vCenter server hello главного целевого узла ESX должен иметь доступ toohello виртуальных машин, хранилища данных.
  * Если hello виртуальной Машины на узле ESX, но не находится под управлением vCenter hello hello жесткий диск виртуальной Машины необходимо в хранилище данных доступны hello MT на узле.
  * Если виртуальную Машину на узле ESX и не использует vCenter следует выполнить обнаружение узел ESX hello hello MT перед вы повторно включите защиту. Это применимо, если выполняется восстановление размещения и для физических серверов.
  * Другим вариантом (если hello локальной виртуальной Машины существует) является toodelete его, прежде чем выполнять восстановление размещения. Затем восстановления размещения автоматически создаст новую виртуальную Машину на hello же разместить в качестве узла ESX hello главного целевого сервера.
* Когда ваши данные hello альтернативное расположение для восстановления размещения tooan будут восстановленные toohello же хранилище данных и hello того же узла ESX, который использовался hello локальный главный целевой сервер.

## <a name="prerequisites"></a>Предварительные требования
* Вам потребуется среде VMware в порядке toofail назад виртуальных машин VMware и физических серверов. Сбой обратной tooa физического сервера не поддерживается.
* В порядке toofail обратно следовало сетью Azure при первоначальной настройке защиты. Соединение VPN или ExpressRoute от hello Azure требуется восстановление после сбоя сети, в котором hello виртуальных машинах Azure, toohello находится на локальном сайте.
* Если виртуальные машины hello tooare toofail назад, управляемых сервером vCenter server необходимо toomake у hello необходимых разрешений для обнаружения виртуальных машин на серверах vCenter. [Подробная информация](site-recovery-vmware-to-azure-classic.md).
* Если на виртуальной машине есть моментальные снимки, произойдет сбой повторного включения защиты. Можно удалить моментальные снимки hello или диски hello.
* Прежде чем возобновить обратно вам потребуется toocreate ряд компонентов.
  * **Создайте сервер обработки в Azure**. Это потребуется toocreate и продолжать работать во время восстановления размещения виртуальной Машины Azure. Можно удалить машину hello, после завершения восстановления размещения.
  * **Создание главного целевого сервера**: hello главный целевой сервер отправляет и получает данные восстановления размещения. сервер управления Hello, созданного локально имеет главный целевой сервер, устанавливается по умолчанию. Тем не менее в зависимости от hello объем невыполненных назад трафика может потребоваться toocreate отдельный главный целевой сервер для восстановления размещения.
  * Если требуется toocreate дополнительных главный целевой сервер под управлением Linux, необходимо tooset копирование hello виртуальных Машин Linux перед установкой hello главного целевого сервера, как описано ниже.
* При восстановлении размещения сервер конфигурации должен быть в локальной среде. При отработке отказа hello виртуальной машины должен существовать в hello сервера базы данных конфигурации, сбой какой восстановления размещения не было успешным. Таким образом, необходимо обеспечить регулярное плановое резервное копирование сервера. В случае аварии, вам потребуется toorestore с hello же IP-адресов, чтобы работали восстановления размещения.

## <a name="set-up-hello-process-server-in-azure"></a>Настройка сервера обработки hello в Azure
Необходимо tooinstall сервера обработки в Azure виртуальные машины Azure hello может отправлять hello данных назад tooon локальный главный целевой сервер.

1. На портале Site Recovery hello > **серверы конфигурации** выберите tooadd нового сервера обработки.

   ![](./media/site-recovery-failback-azure-to-vmware-classic/ps1.png)
2. Укажите имя сервера обработки и введите имя и пароль используемой tooconnect toohello ВМ Azure с правами администратора. В **сервер конфигурации** выберите сервер управления локальной hello и укажите hello Azure сети, в которой hello следует развернуть сервер обработки. Это должна быть hello сети, в котором находятся виртуальные машины Azure hello. Укажите уникальный IP-адрес из подсети выберите hello и начать развертывание.

   ![](./media/site-recovery-failback-azure-to-vmware-classic/ps2.png)

   Сервер обработки hello toodeploy задание будет запущено

   ![](./media/site-recovery-failback-azure-to-vmware-classic/ps3.png)

   После hello в Azure, можно войти в него с использованием учетных данных hello указанного развертывания сервера обработки. Hello при первом входе в диалоговом окне приветствия процесса сервера будет выполняться. Тип hello hello IP-адрес локального сервера управления и его парольную фразу. Оставьте порт 443 по умолчанию hello. Также можно оставить hello 9443 порт по умолчанию для репликации данных, если только специально изменить этот параметр при настройке сервера управления локальными hello.

   > [!NOTE]
   > Hello сервера не будут отображаться в списке **свойства виртуальной Машины**. Отображается только в списке hello **серверы** toowhich сервера управления hello, она зарегистрирована на вкладке. О может занять 10 – 15 минут для сервера tooappear hello процесса.
   >
   >

## <a name="set-up-hello-master-target-server-on-premises"></a>Настройка hello главный целевой сервер локально
Hello главный целевой сервер получает данные hello восстановления размещения. Главный целевой сервер автоматически устанавливается на сервере управления локальной hello, но если сбоя большого объема данных может потребоваться tooset дополнительных главного целевого сервера. Это можно сделать указанным ниже образом.

> [!NOTE]
> Если вы хотите tooinstall главный целевой сервер в Linux, следуйте инструкциям hello в следующей процедуре hello.
>
>

1. Если вы устанавливаете hello главного целевого сервера в Windows, откройте страницу быстрого запуска hello от hello виртуальной Машины, на котором выполняется установка hello главный целевой сервер и загрузите файл установки приветствия для мастера hello единой Установка Azure Site Recovery.
2. Запустите программу установки и в **перед началом** выберите **Добавление дополнительных процессов tooscale серверы out развертывания**.
3. Мастер завершения hello в hello так же, как если вы [Настройка сервера управления hello](site-recovery-vmware-to-azure-classic.md). На hello **сведения о сервере конфигурации** укажите hello IP-адрес этого главного целевого сервера и парольная фраза tooaccess hello виртуальной Машины.

### <a name="set-up-a-linux-vm-as-hello-master-target-server"></a>Настроить виртуальную Машину Linux как hello главного целевого сервера
tooset сервера управления hello под hello главного целевого сервера Linux виртуальных Машин, вам потребуется hello tooinstall процентов) S 6.6 Минимальная операционная система, получить идентификаторы hello SCSI для каждого жесткого диска SCSI, установку некоторых дополнительных пакетов и применить некоторые пользовательские изменения.

#### <a name="install-centos-66"></a>Установка CentOS 6.6
1. Установите hello CentOS 6.6 Минимальная версия операционной системы на сервере управления hello виртуальной Машины. Сохраните hello ISO в системе hello диска и загрузочного DVD-диска. Пропустить hello Выбор носителя-тестирования, английского языка в языке hello, установите флажок **базовых устройств хранения**, убедитесь, что hello жесткий диск не содержит важных данных, а затем нажмите кнопку **Да**, уничтожить все данные. Введите имя узла сервера управления hello hello и выберите сетевой адаптер сервера hello.  В hello **редактирование системы** диалогового окна выберите ** автоматическое подключение ** и добавить статический IP-адрес, сети и параметры DNS. Укажите часовой пояс и tooaccess пароль корневого hello сервера управления.
2. При задаваемые hello типа установки следует выбрать **создать пользовательский макет** как раздел hello. Нажав кнопку **Далее** select **Бесплатный** и щелкните "Создать". Создайте разделы **/**, **/var/crash** и **/home** с **типом файловой системы** **ext4**. Создание hello переключения секционирования как **тип FS: swap**.
3. При наличии существующих устройств появится предупреждающее сообщение. Нажмите кнопку **формат** tooformat hello диск с hello параметров раздела. Нажмите кнопку **записи изменить toodisk** tooapply изменения секций hello.
4. Выберите **установки начальной загрузки** > **Далее** tooinstall hello загрузчик hello корневого раздела.
5. По завершении установки нажмите кнопку **Перезагрузить**.

#### <a name="retrieve-hello-scsi-ids"></a>Получить идентификаторы SCSI hello
1. После установки получить идентификаторы hello SCSI для каждого жесткого диска SCSI в hello виртуальной Машины. toodo это завершение работы сервера управления hello виртуальной Машины, в hello ВМ свойства в VMware, щелкните правой кнопкой мыши запись виртуальной Машины hello > **изменение параметров** > **параметры**.
2. Выберите **Дополнительно** > **Общий элемент** и щелкните **Параметры конфигурации**. Этот параметр будет de-active при запуске компьютера hello. toomake ИТ active hello машина должна быть завершена.
3. Если hello строк **диска. EnableUUID** существует убедитесь, что hello значение слишком**True** (с учетом регистра). Если это уже можно отменить и тестирования команду SCSI hello внутри гостевой операционной системы, после его загрузки.
4. Если строка hello не так, щелкните существующий **добавить строку** — и добавить их с hello **True** значение. Не используйте двойные кавычки.

#### <a name="install-additional-packages"></a>Установка дополнительных пакетов
Вам требуется toodownload и установку некоторых дополнительных пакетов.

1. Убедитесь, что главный целевой сервер hello подключенных toohello Интернета.
2. Запустите этот toodownload команды и установки 15 пакетов из репозитория CentOS hello: **# yum установить – y xfsprogs perl lsscsi rsync wget kexec средства**.
3. Если hello исходных компьютеров, которые вы защищаете работают под управлением Linux wit Reiser XFS файловой системы для корня hello или загрузочных устройств, то следует загрузить и установить дополнительные пакеты следующим образом:

   * # <a name="cd-usrlocal"></a>cd /usr/local;
   * # <a name="wget-httpelrepoorglinuxelrepoel6x8664rpmskmod-reiserfs-00-1el6elrepox8664rpmhttpelrepoorglinuxelrepoel6x8664rpmskmod-reiserfs-00-1el6elrepox8664rpm"></a>wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm)
   * # <a name="wget-httpelrepoorglinuxelrepoel6x8664rpmsreiserfs-utils-3621-1el6elrepox8664rpmhttpelrepoorglinuxelrepoel6x8664rpmsreiserfs-utils-3621-1el6elrepox8664rpm"></a>wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm)
   * # <a name="rpm-ivh-kmod-reiserfs-00-1el6elrepox8664rpm-reiserfs-utils-3621-1el6elrepox8664rpm"></a>rpm –ivh kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm;
   * # <a name="wget-httpmirrorcentosorgcentos66osx8664packagesxfsprogs-311-16el6x8665rpmhttpmirrorcentosorgcentos66osx8664packagesxfsprogs-311-16el6x8665rpm"></a>wget [http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm](http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm)
   * # <a name="rpm-ivh-xfsprogs-311-16el6x8664rpm"></a>rpm –ivh xfsprogs-3.1.1-16.el6.x86_64.rpm.

#### <a name="apply-custom-changes"></a>Применение пользовательских изменений
Выполните следующие tooapply пользовательские изменения после завершения hello действий после установки и hello установленных пакетов hello.

1. Скопируйте двоичные toohello hello RHEL 6-64 единой агента виртуальной Машины. Запустите этот двоичный команда hello toountar: **tar – zxvf<file name>**
2. Запустите toogive этой команды разрешения: **./ApplyCustomChanges.sh chmod &#755;**
3. Запустите сценарий hello: **#./ApplyCustomChanges.sh**. Следует только один раз запустить скрипт hello. Перезагрузите сервер hello, после успешного выполнения сценария hello.

## <a name="run-hello-failback"></a>Выполнить восстановление размещения hello
### <a name="reprotect-hello-azure-vms"></a>Затем включите защиту виртуальных машин Azure hello
1. На портале Site Recovery hello > **машины** установите hello виртуальной Машине, которая переводится ресурс и нажмите кнопку **повторно защитить**.
2. В **главный целевой сервер** и **сервера обработки** выберите hello локальный главный целевой сервер и сервер обработки hello виртуальной Машине Azure.
3. Выберите учетную запись hello, для которой настроена для соединения toohello виртуальной Машины.
4. Выберите версию восстановления размещения hello hello группы защиты. Например, если затем потребуется установить tooselect PG1_Failback hello ВМ защищается PG1.
5. Toorecover tooan альтернативное расположение, выберите диск для сохранения hello и хранилище данных, настроенных для hello главного целевого сервера. Если не проходят задней toohello локального сайта hello виртуальных машин VMware в плане защиты восстановления размещения hello будет использовать hello же хранилище данных как hello главного целевого сервера. Если требуется toorecover hello реплики виртуальной Машины Azure toohello же локальном ВМ то hello в локальном виртуальная машина уже должен быть в hello же хранилище данных как hello главного целевого сервера. Если нет локальных виртуальных машин, во время повторного включения защиты создается новая локальная виртуальная машина.

   ![](./media/site-recovery-failback-azure-to-vmware-classic/failback1.png)
6. После нажатия кнопки **ОК** toobegin повторное включение защиты задание начинает tooreplicate hello ВМ из Azure toohello на локальном сайте. Можно отслеживать ход выполнения hello hello **заданий** вкладки.

   ![](./media/site-recovery-failback-azure-to-vmware-classic/failback2.png)

### <a name="run-a-failover-toohello-on-premises-site"></a>Запуска локального узла toohello отработки отказа
После hello повторную защиту виртуальной Машины версии перемещенный toohello восстановление после сбоя группы защиты и автоматически добавляется toohello план восстановления, который вы использовали для tooAzure hello перехода на другой ресурс, если таковой имеется.

1. В hello **планы восстановления** план восстановления выберите hello страницы, содержащий группы восстановления размещения hello и нажмите **перехода на другой ресурс** > **внеплановой отработки отказа**.
2. В **подтверждение отработки отказа** проверьте направление отработки отказа hello (tooAzure) и выберите hello точку восстановления toouse hello перехода на другой ресурс (последняя версия). Если вы включили **нескольких виртуальных Машин** при настройке свойств репликации можно восстановить последнюю версию приложения toohello или точку восстановления на момент аварийного завершения. Щелкните toostart hello hello флажок перехода на другой ресурс.
3. Во время отработки отказа Site Recovery будет завершать работу hello виртуальных машинах Azure. После проверки, что этот восстановление размещения завершено должным образом, вы может можно проверить, приветствия виртуальных машинах Azure была завершена должным образом.

### <a name="reprotect-hello--on-premises-site"></a>Затем включите защиту на локальном сайте hello
После завершения восстановления размещения данных обратно на локальный сайт hello, но не будут защищены. toostart репликации tooAzure снова hello следующие:

1. На портале Site Recovery hello > **машины** вкладке выберите hello виртуальных машин, которые завершились сбоем обратно и нажмите кнопку **повторно защитить**.
2. Убедившись, что tooAzure, репликация работает должным образом, в Azure можно удалить hello виртуальных машинах Azure (в настоящее время не выполняется), не прошли обратно.

### <a name="common-issues-in-failback"></a>Распространенные проблемы при восстановлении размещения
1. Если выполнить обнаружение vCenter в режиме пользователя только для чтения и защитить виртуальные машины, операция завершится успешно и отработка отказа сработает. Во время повторной защиты hello операция завершится сбоем, так как не удается обнаружить hello хранилища данных. В качестве признака вы увидите не перечисляются во время повторного защиты хранилища данных hello. tooresolve это, можно обновить учетные данные vCenter hello с соответствующей учетной записи с разрешениями и повторите задание hello. [Дополнительные сведения](site-recovery-vmware-to-azure-classic.md)
2. Когда вы восстановления размещения виртуальной Машины Linux и запустите его в локальной среде, вы увидите этот пакет диспетчера сети hello удаляются с компьютера hello. Это потому, что после восстановления hello ВМ в Azure пакет диспетчера сети hello удаляется.
3. Если выполняется отработка отказа tooAzure виртуальной Машины настроен статический IP-адрес, hello IP-адрес можно получить через DHCP. В случае отказа задней tooOn локальной hello ВМ продолжает toouse DHCP tooacquire hello IP-адрес. Вам потребуется toomanually входа в машину hello и резервного адреса tooStatic при необходимости задать hello IP-адрес.
4. Если вы используете бесплатный выпуск ESXi версии 5.5 или низкоуровневой оболочки vSphere версии 6, отработка отказа будет выполнена успешно, но восстановление размещения после сбоя выполнено не будет. Будет подключен tooupgrade tooeither оценочной лицензии tooenable восстановление после сбоя.

## <a name="failing-back-with-expressroute"></a>Восстановление размещения с использованием ExpressRoute
Восстановление размещения можно выполнить через подключение VPN или Azure ExpressRoute. Если нужно toouse ExpressRoute Примечание hello следующее:

* ExpressRoute должна настраиваться hello виртуальной сети Azure toowhich исходной машины неудачных через и в виртуальных машинах Azure расположенные после hello переход на другой ресурс.
* Данные являются tooan реплицированных учетная запись хранения Azure на общедоступную конечную точку. Необходимо настроить открытый пиринг в ExpressRoute с hello целевой центр обработки данных для восстановления сайта репликации toouse ExpressRoute.

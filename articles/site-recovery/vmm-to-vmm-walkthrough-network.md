---
title: "Планирование сетей для репликации Hyper-V на дополнительный сайт с использованием Azure Site Recovery | Документация Майкрософт"
description: "В этой статье рассматриваются планирование сетей при репликации виртуальных машин Hyper-V на дополнительный сайт System Center VMM с помощью Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 095f2d73-994e-4fc0-96f2-e03a7d72e492
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/27/2017
ms.author: raynew
ms.openlocfilehash: a1f3f6e6cba074647195e2b0cbcdc7b4f3dec475
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="step-3-plan-networking-for-hyper-v-vm-replication-to-a-secondary-vmm-site"></a>Шаг 3. Планирование сетей для репликации виртуальных машин Hyper-V на дополнительный сайт VMM

После просмотра необходимых условий для развертывания ознакомьтесь с этой статьей для планирования сетей при репликации виртуальных машин Hyper-V, управляемых в облаках System Center Virtual Machine Manager (VMM) на дополнительный сайт с помощью [Azure Site Recovery](site-recovery-overview.md) на портале Azure. 

Любые комментарии, которые возникнут после прочтения этой статьи, можно добавить в конце этой страницы или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## <a name="network-mapping-overview"></a>Общие сведения о сетевом сопоставлении

Сетевое сопоставление используется при репликации виртуальных машин Hyper-V (управляемых в VMM) в дополнительный центр обработки данных. При сетевом сопоставлении сопоставляются сети виртуальных машин, на исходном сервере VMM, и сети виртуальных машин целевого сервера VMM. Это предоставляет следующие возможности:

- **Сетевое подключение.** Подключает виртуальные машине к соответствующей сети после отработки отказа. Реплика виртуальной машины будет подключена к целевой сети, которая сопоставлена с исходной сетью.
- **Оптимальное размещение.** Оптимально размещает реплику виртуальной машины на серверах узлов Hyper-V. Реплики виртуальных машин будут размещены на узлах, которые имеют доступ к сопоставленным сетям виртуальных машин.
- **Без сетевого сопоставления.** Если не настроить сетевое сопоставление, реплики виртуальных машин не будут подключаться к сетям виртуальных машин после отработки отказа.


### <a name="example"></a>Пример

Следующий пример иллюстрирует этот механизм. Рассмотрим организацию с двумя филиалами в Нью-Йорке и Чикаго.

**Расположение** | **Сервер VMM** | **Сети виртуальных машин** | **Сопоставление**
---|---|---|---
Нью-Йорк | VMM-NewYork| VMNetwork1-NewYork | Сопоставляется с VMNetwork1-Chicago
 |  | VMNetwork2-NewYork | Не сопоставлена
Чикаго | VMM-Chicago| VMNetwork1-Chicago | Сопоставляется с VMNetwork1-NewYork
 | | VMNetwork1-Chicago | Не сопоставлена

В данном примере:

- При создании реплики виртуальной машины для любой виртуальной машины, подключенной к VMNetwork1-NewYork, она будет подключена к VMNetwork1-Chicago.
- Когда создается реплика виртуальной машины для VMNetwork2-NewYork или VMNetwork2-Chicago, она не будет подключена ни к какой сети.

Ниже показано, как настраиваются облака VMM в нашем примере, а также представлены логические сети, связанные с облаками.

#### <a name="cloud-protection-settings"></a>Параметры защиты облаков

**Защищенное облако** | **Защита облака** | **Логическая сеть (Нью-Йорк)**  
---|---|---
GoldCloud1 | GoldCloud2 |
SilverCloud1| SilverCloud2 |
GoldCloud2 | <p>Нет данных</p><p></p> | <p>LogicalNetwork1-NewYork</p><p>LogicalNetwork1-Chicago</p>
SilverCloud2 | <p>Нет данных</p><p></p> | <p>LogicalNetwork1-NewYork</p><p>LogicalNetwork1-Chicago</p>

#### <a name="logical-and-vm-network-settings"></a>Параметры логической сети и сети виртуальных машин

**Расположение** | **Логические сети** | **Связанная сеть виртуальных машин**
---|---|---
Нью-Йорк | LogicalNetwork1-NewYork | VMNetwork1-NewYork
Чикаго | LogicalNetwork1-Chicago | VMNetwork1-Chicago
 | LogicalNetwork2Chicago | VMNetwork2-Chicago

#### <a name="target-network-settings"></a>Параметры целевой сети

В следующей таблице показаны варианты, доступные при выборе целевой сети виртуальных машин, для этих параметров.

**Выбор** | **Защищенное облако** | **Защита облака** | **Доступная целевая сеть**
---|---|---|---
VMNetwork1-Chicago | SilverCloud1 | SilverCloud2 | Доступна
 | GoldCloud1 | GoldCloud2 | Доступна
VMNetwork2-Chicago | SilverCloud1 | SilverCloud2 | Недоступно
 | GoldCloud1 | GoldCloud2 | Доступна


Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то после отработки отказа реплика виртуальной машины будет подключена к этой целевой подсети. Если нет подсетей с таким же именем, виртуальная машина будет подключена к первой подсети в сети.


#### <a name="failback-behavior"></a>Поведение восстановления размещения

Чтобы увидеть, что происходит в случае отработки отказа (обратной репликации), предположим, что VMNetwork1-NewYork сопоставляется с VMNetwork1-Chicago со следующими параметрами.


**Виртуальная машина** | **Подключенная сеть виртуальных машин**
---|---
VM1 | VMNetwork1-Network
VM2 (реплика VM1) | VMNetwork1-Chicago

Приняв эти параметры, рассмотрим, что происходит в нескольких возможных сценариях.

**Сценарий** | **Результат**
---|---
Сетевые свойства VM-2 не изменяются после отработки отказа. | VM-1 остается подключенной к исходной сети.
Сетевые свойства VM-2 изменяются после отработки отказа, и она отключается. | VM-1 отключается.
Сетевые свойства VM-2 изменяются после отработки отказа, и она подключается к VMNetwork2-Chicago. | Если VMNetwork2-Chicago не сопоставлена, VM-1 будет отключена.
Сетевое сопоставление VMNetwork1-Chicago изменяется. | VM-1 будет подключена к сети, сопоставленной с VMNetwork1-Chicago.



## <a name="prepare-for-network-mapping"></a>Подготовка к сопоставлению сетей

1. На исходном и целевом серверах VMM должна находится логическая сеть, связанная с исходным и целевым облаком. 
2. На исходном и целевом серверах должна находится сеть виртуальной машины, связанная с логической сетью.
3. Виртуальные машины на узлах Hyper-V в исходном расположении должны быть связаны с сетью исходной виртуальной машины. Если вы используете один сервер VMM, можно настроить сопоставление сетей виртуальных машин на одном сервере.

Вот что происходит при настройке сетевого сопоставления во время развертывания Site Recovery:

- При настройки сетевого сопоставления и выборе сети целевой виртуальной машины отобразятся исходные облака VMM, использующие сеть исходной виртуальной машины, а также доступные сети целевой виртуальной машины в целевых облаках.
- - Если сопоставление настроено правильно, а репликация включена, исходная виртуальная машина будет подключена к своей сети, а ее реплика из целевого расположения будет подключена к сопоставленной с ней сети.
- Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то после отработки отказа реплика виртуальной машины будет подключена к этой целевой подсети. Если нет подсетей с таким же именем, виртуальная машина будет подключена к первой подсети в сети.

## <a name="connect-to-vms-after-failover"></a>Подключение к виртуальным машинам после отработки отказа

При планировании стратегии репликации и отработки отказа одним из ключевых вопросов является способ подключения к реплике после отработки отказа. Существует несколько вариантов: 

- **Использование другого IP-адреса.** Для реплицируемых виртуальных машин можно выбрать другой IP-адрес. В этом сценарии после отработки отказа виртуальная машина получает новый IP-адрес, а также требуется обновление DNS.
- **Сохранение того же IP-адреса.** Вы можете использовать тот же IP-адрес для виртуальной машины реплики. Использование тех же IP-адресов упрощает процесс восстановления, уменьшая количество проблем с сетью после отработки отказа. 

## <a name="retain-ip-addresses"></a>Использование тех же IP-адресов

Если вы хотите сохранить IP-адреса с основного сайта после отработки отказа на дополнительный сайт, выполните полную отработку отказа подсети и обновите маршруты, чтобы указать новое расположение IP-адресов, или разверните растянутую подсеть между основным и дополнительным сайтами.

### <a name="stretched-subnet"></a>Растянутая подсеть

Растянутая подсеть доступна одновременно для основного и дополнительного сайта. Вы можете переместить сервер и его IP-конфигурацию (уровень 3) на дополнительный сайт, а сеть направит трафик в новое местоположение автоматически. 

С точки зрения уровня 2 (уровень связи данных) требуется сетевое оборудование, с помощью которого можно управлять растянутой виртуальной локальной сетью. Кроме того, при растягивании виртуальной локальной сети потенциальная возможность домена сбоя будет затрагивать оба объекта, которые, по сути, становятся единой точкой отказа. Хотя это маловероятно, может произойти сетевая буря, которую не получится изолировать. 


### <a name="subnet-failover"></a>Отработка отказа подсети

Вы можете выполнить отработку отказа в подсети, чтобы воспользоваться преимуществами растянутой подсети без фактического растягивания. В этом решении подсеть будет доступна на исходном или целевом сайте, но не на обоих одновременно. Чтобы сохранить пространство IP-адресов в случае отработки отказа, программными средствами можно сделать так, чтобы инфраструктура маршрутизаторов перемещала подсети с одного сайта на другой. После отработки отказа подсети переместятся со связанными виртуальными машинами. Основным недостатком является то, что в случае сбоя необходимо переместить всю подсеть.

### <a name="example"></a>Пример

Ниже приведен пример полной отработки отказа подсети. На основном объекте приложения работают в подсети 192.168.1.0/24. После отработки отказа все виртуальные машины в этой подсети переносятся на дополнительный сайт с сохранением IP-адресов. Маршруты необходимо изменить, чтобы указать, что все виртуальные машины, принадлежащих подсети 192.168.1.0/24, теперь перемещены на дополнительный сайт.

На следующем рисунке показаны подсети до и после отработки отказа:

- Перед отработкой отказа подсеть 192.168.0.1/24 активна на исходном сайте, а после него становится активной на дополнительном.
- Маршруты между основным сайтом и сайтом восстановления, третьим сайтом и основным сайтом, а также третьим сайтом и сайтом восстановления необходимо изменить соответствующим образом.

**Перед выполнением отработки отказа**

![Перед выполнением отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design2.png)

**После выполнения отработки отказа**

![После выполнения отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design3.png)

После отработки отказа происходит следующее:

- Site Recovery выделяет IP-адреса для каждого сетевого интерфейса на виртуальной машине из пула статических IP-адресов в соответствующей сети для каждого экземпляра VMM.
- Если пул IP-адресов на дополнительном сайте совпадает с пулом на исходном, Site Recovery выделяет виртуальной машине реплики одинаковые IP-адреса (исходной виртуальной машины). IP-адрес резервируется в VMM, но он не задан как IP-адрес для отработки отказа на узле Hyper-V. IP-адрес отработки отказа задается на узле Hyper-V непосредственно перед отработкой отказа.
- Если же IP-адрес недоступен, Site Recovery выделяет другой доступный адрес из пула.
- Если виртуальные машины используют DHCP, Site Recovery не управляет IP-адресами. Убедитесь, что DHCP-сервер на дополнительном сайте может выделить адрес из того же диапазона, как и на исходном сайте.

### <a name="validate-the-ip-address"></a>Проверка IP-адреса

После включения защиты для виртуальной машины воспользуйтесь следующим примером сценария, чтобы проверить назначенный ей адрес. Тот же IP-адрес будет задан в качестве IP-адреса отработки отказа и назначен виртуальной машине во время отработки отказа:

    ```
    $vm = Get-SCVirtualMachine -Name <VM_NAME>
    $na = $vm[0].VirtualNetworkAdapters>
    $ip = Get-SCIPAddress -GrantToObjectID $na[0].id
    $ip.address 
    ```

## <a name="changing-ip-addresses"></a>Изменение IP-адресов

В этом сценарии IP-адреса виртуальных машин, для которых выполняется отработка отказа, изменяются. Недостаток этого решения — необходимость в обслуживании. Как правило, DNS обновляется после запуска виртуальных машин реплики. Вам может потребоваться изменить DNS в сети и обновить кэшированные записи. Это может привести к возникновению простоя. Простой можно устранить следующим образом:

- Используйте низкие значения срока жизни для приложений интрасети.
- Используйте следующий сценарий в плане восстановления Site Recovery, чтобы обновить DNS-сервер и гарантировать своевременное обновление. Сценарий не требуется, если используется динамическая регистрация DNS.

    ```
    param(
    string]$Zone,
    [string]$name,
    [string]$IP
    )
    $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
    $newrecord = $record.clone()
    $newrecord.RecordData[0].IPv4Address  =  $IP
    Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord
    ```
    
### <a name="example"></a>Пример 

Рассмотрим сценарий, в котором планируется использовать разные IP-адреса на основном сайте и сайтах восстановления. В этом примере у нас есть разные IP-адреса на основных и дополнительных сайтах, а также имеется третий сайт, с которого можно получить доступ к приложениям, размещенным на основном сайте или сайте восстановления.

- Перед отработкой отказа приложения размещены в подсети 192.168.1.0/24 на основном сайте, а после него переходят в подсеть 172.16.1.0/24 на дополнительном сайте.
- VPN-подключения/сетевые маршруты были настроены так, чтобы все три объекта могли иметь доступ друг к другу.
- После отработки отказа приложения будут восстановлены в подсети восстановления. В этом сценарии не нужно выполнять отработку отказа всей подсети, а также вносить изменения для перенастройки VPN или сетевых маршрутов. Отработка отказа и некоторые обновления DNS обеспечивают доступность приложений.
- Если DNS настроен для разрешения динамических обновлений, после запуска по завершении отработки отказа виртуальные машины зарегистрируются, используя новый IP-адрес.

**Перед выполнением отработки отказа**

![Другой IP-адрес — до отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design10.png)

**После выполнения отработки отказа**

![Другой IP-адрес — после отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design11.png)



## <a name="next-steps"></a>Дальнейшие действия

Перейдите к статье [Шаг 4. Настройка VMM и Hyper-V для репликации виртуальной машины Hyper-V на дополнительный сайт](vmm-to-vmm-walkthrough-vmm-hyper-v.md).



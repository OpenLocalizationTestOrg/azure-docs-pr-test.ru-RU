---
title: "Работа по сети для Hyper-V репликации tooa вторичный сайт VMM с помощью Azure Site Recovery aaaPlan | Документы Microsoft"
description: "В этой статье рассматриваются сети планирования при репликации виртуальных машин Hyper-V tooa вторичного System Center VMM сайта с помощью Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 095f2d73-994e-4fc0-96f2-e03a7d72e492
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/27/2017
ms.author: raynew
ms.openlocfilehash: 5934db4a661a2c697a1a799c3848852250ddb451
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="step-3-plan-networking-for-hyper-v-vm-replication-tooa-secondary-vmm-site"></a>Шаг 3: Планирование сети для виртуальных Машин Hyper-V репликации tooa вторичного сайта, VMM

После просмотра необходимые условия для развертывания, чтение этой статье tooplan, при репликации Hyper-V виртуальных машин (ВМ), управляемых в облаках диспетчера виртуальных машин System Center (VMM) к сети с помощью вторичного сайта tooa [Azure Site Recovery](site-recovery-overview.md) в hello портал Azure. 

После считывания в этой статье, отправлять любые комментарии, внизу hello, или на hello [форум по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## <a name="network-mapping-overview"></a>Общие сведения о сетевом сопоставлении

Сетевое сопоставление используется при репликации виртуальных машин Hyper-V (управляемый код в VMM), дополнительного tooa центра обработки данных. При сетевом сопоставлении сопоставляются сети виртуальных машин, на исходном сервере VMM, и сети виртуальных машин целевого сервера VMM. Сопоставление hello следующие:

- **Сетевое подключение**— сетей tooappropriate подключается виртуальных машин после отработки отказа. подключенный toohello целевую сеть, сопоставленные toohello Исходная сеть будет Hello реплика виртуальной Машины.
- **Оптимального размещения**— оптимально местах hello виртуальных машин реплики на несущих серверах Hyper-V. Виртуальные машины реплики размещается на узле, что можно hello доступа к сопоставленным сетям виртуальных Машин.
- **Отсутствует сопоставление сети**— реплик виртуальных машин, если не настроить сетевое сопоставление, не будет tooany подключенной сети виртуальных Машин после отработки отказа.


### <a name="example"></a>Пример

Ниже приведен пример tooillustrate этот механизм. Рассмотрим организацию с двумя филиалами в Нью-Йорке и Чикаго.

**Расположение** | **Сервер VMM** | **Сети виртуальных машин** | **Сопоставление**
---|---|---|---
Нью-Йорк | VMM-NewYork| VMNetwork1-NewYork | Сопоставленные tooVMNetwork1-Chicago
 |  | VMNetwork2-NewYork | Не сопоставлена
Чикаго | VMM-Chicago| VMNetwork1-Chicago | Сопоставленные tooVMNetwork1-NewYork
 | | VMNetwork1-Chicago | Не сопоставлена

В данном примере:

- Когда виртуальная машина реплики создается для всех виртуальных машин, подключенных tooVMNetwork1-NewYork, будет подключенных tooVMNetwork1-Chicago.
- Когда виртуальная машина реплики создается для VMNetwork2-NewYork или VMNetwork2-Chicago, он не будет tooany подключенной сети.

Вот, как облака VMM настроить в нашем примере организации и hello логических сетей, связанных с облаками hello.

#### <a name="cloud-protection-settings"></a>Параметры защиты облаков

**Защищенное облако** | **Защита облака** | **Логическая сеть (Нью-Йорк)**  
---|---|---
GoldCloud1 | GoldCloud2 |
SilverCloud1| SilverCloud2 |
GoldCloud2 | <p>Нет данных</p><p></p> | <p>LogicalNetwork1-NewYork</p><p>LogicalNetwork1-Chicago</p>
SilverCloud2 | <p>Нет данных</p><p></p> | <p>LogicalNetwork1-NewYork</p><p>LogicalNetwork1-Chicago</p>

#### <a name="logical-and-vm-network-settings"></a>Параметры логической сети и сети виртуальных машин

**Расположение** | **Логические сети** | **Связанная сеть виртуальных машин**
---|---|---
Нью-Йорк | LogicalNetwork1-NewYork | VMNetwork1-NewYork
Чикаго | LogicalNetwork1-Chicago | VMNetwork1-Chicago
 | LogicalNetwork2Chicago | VMNetwork2-Chicago

#### <a name="target-network-settings"></a>Параметры целевой сети

На основе этих параметров, при выборе целевой сети ВМ hello, hello в следующей таблице показаны hello вариантов, которые будут доступны.

**Выбор** | **Защищенное облако** | **Защита облака** | **Доступная целевая сеть**
---|---|---|---
VMNetwork1-Chicago | SilverCloud1 | SilverCloud2 | Доступна
 | GoldCloud1 | GoldCloud2 | Доступна
VMNetwork2-Chicago | SilverCloud1 | SilverCloud2 | Недоступно
 | GoldCloud1 | GoldCloud2 | Доступна


Если hello целевая сеть содержит несколько подсетей, и один из этих подсетей имеет hello таким же именем как hello подсети, на какие hello находится исходная виртуальная машина, затем hello виртуальной машины реплики будет подключенных toothat целевой подсети после отработки отказа. Если никакой целевой подсети с совпадающим именем, hello виртуальная машина будет подключенных toohello первой подсети в сети hello.


#### <a name="failback-behavior"></a>Поведение восстановления размещения

toosee, что происходит в случае, когда hello восстановления размещения (обратной репликации), давайте предположим, что VMNetwork1-NewYork сопоставленных tooVMNetwork1-Chicago, с hello следующие параметры.


**Виртуальная машина** | **TooVM подключенной сети**
---|---
VM1 | VMNetwork1-Network
VM2 (реплика VM1) | VMNetwork1-Chicago

Приняв эти параметры, рассмотрим, что происходит в нескольких возможных сценариях.

**Сценарий** | **Результат**
---|---
Без изменений в свойствах сети hello VM-2 после отработки отказа. | VM-1 остается подключенной toohello исходную сеть.
Сетевые свойства VM-2 изменяются после отработки отказа, и она отключается. | VM-1 отключается.
Свойства сети VM-2 изменяются после отработки отказа и является подключенных tooVMNetwork2-Chicago. | Если VMNetwork2-Chicago не сопоставлена, VM-1 будет отключена.
Сетевое сопоставление VMNetwork1-Chicago изменяется. | VM-1 будет toohello подключенной сети, сопоставленной теперь tooVMNetwork1-Chicago.



## <a name="prepare-for-network-mapping"></a>Подготовка к сопоставлению сетей

1. На hello исходный и целевой серверы VMM должен иметь логической сетью, связанной с hello исходном и целевом облаках. 
2. В исходном и целевом серверах hello должен быть логическую сеть связанных toohello сети виртуальной Машины.
3. Виртуальные машины на узлах Hyper-V в исходное расположение hello должно быть toohello связанные исходной сетью виртуальной Машины. Если вы используете только один сервер VMM, можно настроить сопоставление между сетями виртуальных Машин на hello же сервера.

Вот что происходит при настройке сетевого сопоставления во время развертывания Site Recovery:

- Если настроить сетевое сопоставление и выберите целевую сеть виртуальной Машины, исходных облаках VMM hello, использующие исходную сеть виртуальных Машин hello будет отображаться, вместе с hello доступные целевые сети ВМ hello целевых облаков.
- - Если сопоставление настроено правильно и репликация включена, исходной виртуальной Машины будет подключенных tooits исходную сеть виртуальных Машин и его репликой hello целевого расположения будет подключена tooits сопоставлены сети виртуальной Машины.
- Если hello целевая сеть содержит несколько подсетей, и один из этих подсетей имеет hello таким же именем как hello подсети, на какие hello находится исходная виртуальная машина, затем hello виртуальной машины реплики будет подключенных toothat целевой подсети после отработки отказа. Если никакой целевой подсети с совпадающим именем, hello виртуальной Машины будет подключенных toohello первой подсети в сети hello.

## <a name="connect-toovms-after-failover"></a>Подключение tooVMs после отработки отказа

При планировании репликации и стратегия отработки отказа, является одним из ключевых вопроса hello как tooconnect toohello реплики после отработки отказа. Существует несколько вариантов: 

- **Использовать другой IP-адрес**: можно выбрать toouse другой IP-адрес для hello реплицированных виртуальных Машин. В этот сценарий hello виртуальная машина получит новый IP-адрес после отработки отказа и требуется обновление DNS.
- **Сохранить hello же IP-адрес**: может потребоваться toouse hello же IP-адрес для hello реплики виртуальной Машины. Сохранение hello одинаковые IP-адреса упрощает hello восстановления за счет уменьшения проблемы, связанные с сети после отработки отказа. 

## <a name="retain-ip-addresses"></a>Использование тех же IP-адресов

Если требуется tooretain hello IP-адресов hello основного сайта после отработки отказа toohello вторичного сайта, можно провести полное подсети отработки отказа, а также обновить маршруты tooindicate hello новое расположение hello IP-адресов, или вариант развертывания растяжением подсети между hello основной и hello восстановления сайтов.

### <a name="stretched-subnet"></a>Растянутая подсеть

В расширенной подсети подсети hello доступен одновременно в hello первичного и вторичного сайта. При перемещении сервера и его конфигурации IP (уровень 3) toohello вторичного сайта, сети hello автоматически направит hello трафика toohello новое расположение. 

С точки зрения уровня 2 (уровень связи данных) требуется сетевое оборудование, с помощью которого можно управлять растянутой виртуальной локальной сетью. Кроме того растяжения hello виртуальной локальной сети, потенциальные домен сбоя hello располагается по tooboth узлов, по сути становится единая точка отказа. Хотя это маловероятно, может произойти сетевая буря, которую не получится изолировать. 


### <a name="subnet-failover"></a>Отработка отказа подсети

Преимущества подсети hello растягивается hello tooobtain отработки отказа подсети могут выполняться без фактически растягивая его. В этом решении подсети будут доступны в hello исходный или конечный сайт, но не на оба одновременно. toomaintain hello пространство IP-адресов в событии hello перехода на другой ресурс, можно программным образом упорядочить для hello маршрутизатора инфраструктуры toomove из одного узла tooanother hello подсетей. После переносились в случае отработки отказа подсетей с hello связанные виртуальные машины. Основным недостатком Hello: в случае сбоя hello иметь toomove hello всей подсети.

### <a name="example"></a>Пример

Ниже приведен пример полной отработки отказа подсети. Hello основной сайт имеет приложений, работающих в подсети 192.168.1.0/24. После перехода на другой ресурс hello все виртуальные машины в этой подсети отработку отказа toohello вторичного сайта и сохраняют свои IP-адреса. Маршруты toobe необходимость изменить фактов hello tooreflect все hello виртуальной Машины виртуальных машин, принадлежащих toosubnet 192.168.1.0/24 теперь перемещен toohello вторичного сайта.

Hello следующем рисунке показан подсетей hello до и после отработки отказа:

- Перед выполнением отработки отказа 192.168.0.1/24 подсети активен на исходном сайте hello, становятся активными на вторичном сайте hello после отработки отказа.
- Hello направляет между первичным сайтом и сайтом восстановления, третий узел и первичного сайта, а третий сайтом и сайтом восстановления будет иметь toobe соответствующим образом изменены.

**Перед выполнением отработки отказа**

![Перед выполнением отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design2.png)

**После выполнения отработки отказа**

![После выполнения отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design3.png)

После отработки отказа происходит следующее:

- Site Recovery выделяет IP-адреса для каждого сетевого интерфейса на ВМ, hello hello статических IP-адресов в сети hello применимо, для каждого экземпляра VMM.
- Если пул IP-адресов hello вторичном сайте hello hello же, как на исходном сайте hello, Site Recovery выделяет hello же IP адрес (hello исходной виртуальной Машины) toohello виртуальную Машину реплики. Hello IP-адрес зарезервирован в VMM, но не устанавливается как hello отработки отказа IP-адрес на узле Hyper-V hello. Hello отработки отказа IP-адрес на узле Hyper-v задается непосредственно перед hello перехода на другой ресурс.
- Если hello же IP-адрес недоступен, Site Recovery выделяет другой доступный IP-адрес из пула hello.
- Если виртуальные машины используют DHCP, Site Recovery не управлять hello IP-адресов. Требуется toocheck, hello DHCP server на вторичном сайте hello можно выделить адрес из hello же диапазон как hello исходного сайта.

### <a name="validate-hello-ip-address"></a>Проверка hello IP-адрес

После включения защиты для виртуальной Машины, можно использовать следующий образец скрипта tooverify hello toohello адрес, назначенный виртуальной Машины. Hello же IP-адрес будет устанавливаться как hello отработки отказа IP-адрес и назначенный toohello виртуальной Машины во время отработки отказа hello:

    ```
    $vm = Get-SCVirtualMachine -Name <VM_NAME>
    $na = $vm[0].VirtualNetworkAdapters>
    $ip = Get-SCIPAddress -GrantToObjectID $na[0].id
    $ip.address 
    ```

## <a name="changing-ip-addresses"></a>Изменение IP-адресов

В этом случае изменения hello IP-адреса виртуальных машин, которые выполняют отработку отказа. Hello недостатком этого решения является hello затрат на сопровождение. Как правило, DNS обновляется после запуска виртуальных машин реплики. Записи DNS может потребоваться изменить toobe или fluster в сети и обновления кэшированных записей. Это может привести к возникновению простоя. Простой можно устранить следующим образом:

- Используйте низкие значения срока жизни для приложений интрасети.
- Используйте следующий скрипт в план восстановления Site Recovery tooupdate hello DNS server tooensure своевременное обновление hello. Если использовать динамическую регистрацию DNS hello скрипт не требуется.

    ```
    param(
    string]$Zone,
    [string]$name,
    [string]$IP
    )
    $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
    $newrecord = $record.clone()
    $newrecord.RecordData[0].IPv4Address  =  $IP
    Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord
    ```
    
### <a name="example"></a>Пример 

Рассмотрим сценарий, в котором вы планируете toouse разные IP-адреса через основной hello и hello восстановления сайтов. В этом примере у нас есть разные IP-адреса на первичных и вторичных сайтах и существует; получить доступ к сайту s третий из какие приложения, размещенного на сайте hello основного сервера или восстановления.

- Перед выполнением отработки отказа приложения, 192.168.1.0/24 размещенного подсети на первичном сайте hello и являются настроенные toobe в подсети 172.16.1.0/24 на вторичном сайте hello после отработки отказа.
- VPN-подключения/сетевые маршруты были настроены так, чтобы все три объекта могли иметь доступ друг к другу.
- После отработки отказа будет восстановлена в подсети hello восстановления приложений. В этом сценарии имеется без необходимости toofail по всей подсети hello и необходимые tooreconfigure VPN или сетевых маршрутов не вносить изменения. Hello перехода на другой ресурс, а некоторые DNS обеспечить сохранение доступных приложений.
- Если настроенные tooallow динамические обновления DNS, затем hello виртуальные машины будут регистрироваться с помощью hello новый IP-адрес, когда они запускают после отработки отказа.

**Перед выполнением отработки отказа**

![Другой IP-адрес — до отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design10.png)

**После выполнения отработки отказа**

![Другой IP-адрес — после отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design11.png)



## <a name="next-steps"></a>Дальнейшие действия

Go слишком[шаг 4: Подготовка VMM и Hyper-V](vmm-to-vmm-walkthrough-vmm-hyper-v.md).



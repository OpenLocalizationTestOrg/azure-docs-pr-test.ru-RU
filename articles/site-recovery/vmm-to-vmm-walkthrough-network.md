---
title: "Планирование сетей для репликации Hyper-V на дополнительный сайт с использованием Azure Site Recovery | Документация Майкрософт"
description: "В этой статье рассматриваются планирование сетей при репликации виртуальных машин Hyper-V на дополнительный сайт System Center VMM с помощью Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 095f2d73-994e-4fc0-96f2-e03a7d72e492
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/27/2017
ms.author: raynew
ms.openlocfilehash: a1f3f6e6cba074647195e2b0cbcdc7b4f3dec475
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="step-3-plan-networking-for-hyper-v-vm-replication-to-a-secondary-vmm-site"></a><span data-ttu-id="90032-103">Шаг 3. Планирование сетей для репликации виртуальных машин Hyper-V на дополнительный сайт VMM</span><span class="sxs-lookup"><span data-stu-id="90032-103">Step 3: Plan networking for Hyper-V VM replication to a secondary VMM site</span></span>

<span data-ttu-id="90032-104">После просмотра необходимых условий для развертывания ознакомьтесь с этой статьей для планирования сетей при репликации виртуальных машин Hyper-V, управляемых в облаках System Center Virtual Machine Manager (VMM) на дополнительный сайт с помощью [Azure Site Recovery](site-recovery-overview.md) на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="90032-104">After reviewing deployment prerequisites, read this article to plan networking when replicating Hyper-V virtual machines (VMs) managed in System Center Virtual Machine Manager (VMM) clouds, to a secondary site using [Azure Site Recovery](site-recovery-overview.md) in the Azure portal.</span></span> 

<span data-ttu-id="90032-105">Любые комментарии, которые возникнут после прочтения этой статьи, можно добавить в конце этой страницы или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span><span class="sxs-lookup"><span data-stu-id="90032-105">After reading this article, post any comments at the bottom, or on the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>

## <a name="network-mapping-overview"></a><span data-ttu-id="90032-106">Общие сведения о сетевом сопоставлении</span><span class="sxs-lookup"><span data-stu-id="90032-106">Network mapping overview</span></span>

<span data-ttu-id="90032-107">Сетевое сопоставление используется при репликации виртуальных машин Hyper-V (управляемых в VMM) в дополнительный центр обработки данных.</span><span class="sxs-lookup"><span data-stu-id="90032-107">Network mapping is used when replicating Hyper-V VMs (managed in VMM) to a secondary datacenter.</span></span> <span data-ttu-id="90032-108">При сетевом сопоставлении сопоставляются сети виртуальных машин, на исходном сервере VMM, и сети виртуальных машин целевого сервера VMM.</span><span class="sxs-lookup"><span data-stu-id="90032-108">Network mapping maps between VM networks on a source VMM server, and VM networks on a target VMM server.</span></span> <span data-ttu-id="90032-109">Это предоставляет следующие возможности:</span><span class="sxs-lookup"><span data-stu-id="90032-109">Mapping does the following:</span></span>

- <span data-ttu-id="90032-110">**Сетевое подключение.** Подключает виртуальные машине к соответствующей сети после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="90032-110">**Network connection**—Connects VMs to appropriate networks after failover.</span></span> <span data-ttu-id="90032-111">Реплика виртуальной машины будет подключена к целевой сети, которая сопоставлена с исходной сетью.</span><span class="sxs-lookup"><span data-stu-id="90032-111">The replica VM will be connected to the target network that's mapped to the source network.</span></span>
- <span data-ttu-id="90032-112">**Оптимальное размещение.** Оптимально размещает реплику виртуальной машины на серверах узлов Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="90032-112">**Optimal placement**—Optimally places the replica VMs on Hyper-V host servers.</span></span> <span data-ttu-id="90032-113">Реплики виртуальных машин будут размещены на узлах, которые имеют доступ к сопоставленным сетям виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="90032-113">Replica VMs are placed on hosts that can access the mapped VM networks.</span></span>
- <span data-ttu-id="90032-114">**Без сетевого сопоставления.** Если не настроить сетевое сопоставление, реплики виртуальных машин не будут подключаться к сетям виртуальных машин после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="90032-114">**No network mapping**—If you don’t configure network mapping, replica VMs won’t be connected to any VM networks after failover.</span></span>


### <a name="example"></a><span data-ttu-id="90032-115">Пример</span><span class="sxs-lookup"><span data-stu-id="90032-115">Example</span></span>

<span data-ttu-id="90032-116">Следующий пример иллюстрирует этот механизм.</span><span class="sxs-lookup"><span data-stu-id="90032-116">Here’s an example to illustrate this mechanism.</span></span> <span data-ttu-id="90032-117">Рассмотрим организацию с двумя филиалами в Нью-Йорке и Чикаго.</span><span class="sxs-lookup"><span data-stu-id="90032-117">Let’s take an organization with two locations in New York and Chicago.</span></span>

<span data-ttu-id="90032-118">**Расположение**</span><span class="sxs-lookup"><span data-stu-id="90032-118">**Location**</span></span> | <span data-ttu-id="90032-119">**Сервер VMM**</span><span class="sxs-lookup"><span data-stu-id="90032-119">**VMM server**</span></span> | <span data-ttu-id="90032-120">**Сети виртуальных машин**</span><span class="sxs-lookup"><span data-stu-id="90032-120">**VM networks**</span></span> | <span data-ttu-id="90032-121">**Сопоставление**</span><span class="sxs-lookup"><span data-stu-id="90032-121">**Mapped to**</span></span>
---|---|---|---
<span data-ttu-id="90032-122">Нью-Йорк</span><span class="sxs-lookup"><span data-stu-id="90032-122">New York</span></span> | <span data-ttu-id="90032-123">VMM-NewYork</span><span class="sxs-lookup"><span data-stu-id="90032-123">VMM-NewYork</span></span>| <span data-ttu-id="90032-124">VMNetwork1-NewYork</span><span class="sxs-lookup"><span data-stu-id="90032-124">VMNetwork1-NewYork</span></span> | <span data-ttu-id="90032-125">Сопоставляется с VMNetwork1-Chicago</span><span class="sxs-lookup"><span data-stu-id="90032-125">Mapped to VMNetwork1-Chicago</span></span>
 |  | <span data-ttu-id="90032-126">VMNetwork2-NewYork</span><span class="sxs-lookup"><span data-stu-id="90032-126">VMNetwork2-NewYork</span></span> | <span data-ttu-id="90032-127">Не сопоставлена</span><span class="sxs-lookup"><span data-stu-id="90032-127">Not mapped</span></span>
<span data-ttu-id="90032-128">Чикаго</span><span class="sxs-lookup"><span data-stu-id="90032-128">Chicago</span></span> | <span data-ttu-id="90032-129">VMM-Chicago</span><span class="sxs-lookup"><span data-stu-id="90032-129">VMM-Chicago</span></span>| <span data-ttu-id="90032-130">VMNetwork1-Chicago</span><span class="sxs-lookup"><span data-stu-id="90032-130">VMNetwork1-Chicago</span></span> | <span data-ttu-id="90032-131">Сопоставляется с VMNetwork1-NewYork</span><span class="sxs-lookup"><span data-stu-id="90032-131">Mapped to VMNetwork1-NewYork</span></span>
 | | <span data-ttu-id="90032-132">VMNetwork1-Chicago</span><span class="sxs-lookup"><span data-stu-id="90032-132">VMNetwork1-Chicago</span></span> | <span data-ttu-id="90032-133">Не сопоставлена</span><span class="sxs-lookup"><span data-stu-id="90032-133">Not mapped</span></span>

<span data-ttu-id="90032-134">В данном примере:</span><span class="sxs-lookup"><span data-stu-id="90032-134">In this example:</span></span>

- <span data-ttu-id="90032-135">При создании реплики виртуальной машины для любой виртуальной машины, подключенной к VMNetwork1-NewYork, она будет подключена к VMNetwork1-Chicago.</span><span class="sxs-lookup"><span data-stu-id="90032-135">When a replica virtual machine is created for any virtual machine that is connected to VMNetwork1-NewYork, it will be connected to VMNetwork1-Chicago.</span></span>
- <span data-ttu-id="90032-136">Когда создается реплика виртуальной машины для VMNetwork2-NewYork или VMNetwork2-Chicago, она не будет подключена ни к какой сети.</span><span class="sxs-lookup"><span data-stu-id="90032-136">When a replica virtual machine is created for VMNetwork2-NewYork or VMNetwork2-Chicago, it will not be connected to any network.</span></span>

<span data-ttu-id="90032-137">Ниже показано, как настраиваются облака VMM в нашем примере, а также представлены логические сети, связанные с облаками.</span><span class="sxs-lookup"><span data-stu-id="90032-137">Here's how VMM clouds are set up in our example organization, and the logical networks associated with the clouds.</span></span>

#### <a name="cloud-protection-settings"></a><span data-ttu-id="90032-138">Параметры защиты облаков</span><span class="sxs-lookup"><span data-stu-id="90032-138">Cloud protection settings</span></span>

<span data-ttu-id="90032-139">**Защищенное облако**</span><span class="sxs-lookup"><span data-stu-id="90032-139">**Protected cloud**</span></span> | <span data-ttu-id="90032-140">**Защита облака**</span><span class="sxs-lookup"><span data-stu-id="90032-140">**Protecting cloud**</span></span> | <span data-ttu-id="90032-141">**Логическая сеть (Нью-Йорк)**</span><span class="sxs-lookup"><span data-stu-id="90032-141">**Logical network (New York)**</span></span>  
---|---|---
<span data-ttu-id="90032-142">GoldCloud1</span><span class="sxs-lookup"><span data-stu-id="90032-142">GoldCloud1</span></span> | <span data-ttu-id="90032-143">GoldCloud2</span><span class="sxs-lookup"><span data-stu-id="90032-143">GoldCloud2</span></span> |
<span data-ttu-id="90032-144">SilverCloud1</span><span class="sxs-lookup"><span data-stu-id="90032-144">SilverCloud1</span></span>| <span data-ttu-id="90032-145">SilverCloud2</span><span class="sxs-lookup"><span data-stu-id="90032-145">SilverCloud2</span></span> |
<span data-ttu-id="90032-146">GoldCloud2</span><span class="sxs-lookup"><span data-stu-id="90032-146">GoldCloud2</span></span> | <p><span data-ttu-id="90032-147">Нет данных</span><span class="sxs-lookup"><span data-stu-id="90032-147">NA</span></span></p><p></p> | <p><span data-ttu-id="90032-148">LogicalNetwork1-NewYork</span><span class="sxs-lookup"><span data-stu-id="90032-148">LogicalNetwork1-NewYork</span></span></p><p><span data-ttu-id="90032-149">LogicalNetwork1-Chicago</span><span class="sxs-lookup"><span data-stu-id="90032-149">LogicalNetwork1-Chicago</span></span></p>
<span data-ttu-id="90032-150">SilverCloud2</span><span class="sxs-lookup"><span data-stu-id="90032-150">SilverCloud2</span></span> | <p><span data-ttu-id="90032-151">Нет данных</span><span class="sxs-lookup"><span data-stu-id="90032-151">NA</span></span></p><p></p> | <p><span data-ttu-id="90032-152">LogicalNetwork1-NewYork</span><span class="sxs-lookup"><span data-stu-id="90032-152">LogicalNetwork1-NewYork</span></span></p><p><span data-ttu-id="90032-153">LogicalNetwork1-Chicago</span><span class="sxs-lookup"><span data-stu-id="90032-153">LogicalNetwork1-Chicago</span></span></p>

#### <a name="logical-and-vm-network-settings"></a><span data-ttu-id="90032-154">Параметры логической сети и сети виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="90032-154">Logical and VM network settings</span></span>

<span data-ttu-id="90032-155">**Расположение**</span><span class="sxs-lookup"><span data-stu-id="90032-155">**Location**</span></span> | <span data-ttu-id="90032-156">**Логические сети**</span><span class="sxs-lookup"><span data-stu-id="90032-156">**Logical network**</span></span> | <span data-ttu-id="90032-157">**Связанная сеть виртуальных машин**</span><span class="sxs-lookup"><span data-stu-id="90032-157">**Associated VM network**</span></span>
---|---|---
<span data-ttu-id="90032-158">Нью-Йорк</span><span class="sxs-lookup"><span data-stu-id="90032-158">New York</span></span> | <span data-ttu-id="90032-159">LogicalNetwork1-NewYork</span><span class="sxs-lookup"><span data-stu-id="90032-159">LogicalNetwork1-NewYork</span></span> | <span data-ttu-id="90032-160">VMNetwork1-NewYork</span><span class="sxs-lookup"><span data-stu-id="90032-160">VMNetwork1-NewYork</span></span>
<span data-ttu-id="90032-161">Чикаго</span><span class="sxs-lookup"><span data-stu-id="90032-161">Chicago</span></span> | <span data-ttu-id="90032-162">LogicalNetwork1-Chicago</span><span class="sxs-lookup"><span data-stu-id="90032-162">LogicalNetwork1-Chicago</span></span> | <span data-ttu-id="90032-163">VMNetwork1-Chicago</span><span class="sxs-lookup"><span data-stu-id="90032-163">VMNetwork1-Chicago</span></span>
 | <span data-ttu-id="90032-164">LogicalNetwork2Chicago</span><span class="sxs-lookup"><span data-stu-id="90032-164">LogicalNetwork2Chicago</span></span> | <span data-ttu-id="90032-165">VMNetwork2-Chicago</span><span class="sxs-lookup"><span data-stu-id="90032-165">VMNetwork2-Chicago</span></span>

#### <a name="target-network-settings"></a><span data-ttu-id="90032-166">Параметры целевой сети</span><span class="sxs-lookup"><span data-stu-id="90032-166">Target network settings</span></span>

<span data-ttu-id="90032-167">В следующей таблице показаны варианты, доступные при выборе целевой сети виртуальных машин, для этих параметров.</span><span class="sxs-lookup"><span data-stu-id="90032-167">Based on these settings, when you select the target VM network, the following table shows the choices that will be available.</span></span>

<span data-ttu-id="90032-168">**Выбор**</span><span class="sxs-lookup"><span data-stu-id="90032-168">**Select**</span></span> | <span data-ttu-id="90032-169">**Защищенное облако**</span><span class="sxs-lookup"><span data-stu-id="90032-169">**Protected cloud**</span></span> | <span data-ttu-id="90032-170">**Защита облака**</span><span class="sxs-lookup"><span data-stu-id="90032-170">**Protecting cloud**</span></span> | <span data-ttu-id="90032-171">**Доступная целевая сеть**</span><span class="sxs-lookup"><span data-stu-id="90032-171">**Target network available**</span></span>
---|---|---|---
<span data-ttu-id="90032-172">VMNetwork1-Chicago</span><span class="sxs-lookup"><span data-stu-id="90032-172">VMNetwork1-Chicago</span></span> | <span data-ttu-id="90032-173">SilverCloud1</span><span class="sxs-lookup"><span data-stu-id="90032-173">SilverCloud1</span></span> | <span data-ttu-id="90032-174">SilverCloud2</span><span class="sxs-lookup"><span data-stu-id="90032-174">SilverCloud2</span></span> | <span data-ttu-id="90032-175">Доступна</span><span class="sxs-lookup"><span data-stu-id="90032-175">Available</span></span>
 | <span data-ttu-id="90032-176">GoldCloud1</span><span class="sxs-lookup"><span data-stu-id="90032-176">GoldCloud1</span></span> | <span data-ttu-id="90032-177">GoldCloud2</span><span class="sxs-lookup"><span data-stu-id="90032-177">GoldCloud2</span></span> | <span data-ttu-id="90032-178">Доступна</span><span class="sxs-lookup"><span data-stu-id="90032-178">Available</span></span>
<span data-ttu-id="90032-179">VMNetwork2-Chicago</span><span class="sxs-lookup"><span data-stu-id="90032-179">VMNetwork2-Chicago</span></span> | <span data-ttu-id="90032-180">SilverCloud1</span><span class="sxs-lookup"><span data-stu-id="90032-180">SilverCloud1</span></span> | <span data-ttu-id="90032-181">SilverCloud2</span><span class="sxs-lookup"><span data-stu-id="90032-181">SilverCloud2</span></span> | <span data-ttu-id="90032-182">Недоступно</span><span class="sxs-lookup"><span data-stu-id="90032-182">Not available</span></span>
 | <span data-ttu-id="90032-183">GoldCloud1</span><span class="sxs-lookup"><span data-stu-id="90032-183">GoldCloud1</span></span> | <span data-ttu-id="90032-184">GoldCloud2</span><span class="sxs-lookup"><span data-stu-id="90032-184">GoldCloud2</span></span> | <span data-ttu-id="90032-185">Доступна</span><span class="sxs-lookup"><span data-stu-id="90032-185">Available</span></span>


<span data-ttu-id="90032-186">Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то после отработки отказа реплика виртуальной машины будет подключена к этой целевой подсети.</span><span class="sxs-lookup"><span data-stu-id="90032-186">If the target network has multiple subnets and one of those subnets has the same name as the subnet on which the source virtual machine is located, then the replica virtual machine will be connected to that target subnet after failover.</span></span> <span data-ttu-id="90032-187">Если нет подсетей с таким же именем, виртуальная машина будет подключена к первой подсети в сети.</span><span class="sxs-lookup"><span data-stu-id="90032-187">If there’s no target subnet with a matching name, the virtual machine will be connected to the first subnet in the network.</span></span>


#### <a name="failback-behavior"></a><span data-ttu-id="90032-188">Поведение восстановления размещения</span><span class="sxs-lookup"><span data-stu-id="90032-188">Failback behavior</span></span>

<span data-ttu-id="90032-189">Чтобы увидеть, что происходит в случае отработки отказа (обратной репликации), предположим, что VMNetwork1-NewYork сопоставляется с VMNetwork1-Chicago со следующими параметрами.</span><span class="sxs-lookup"><span data-stu-id="90032-189">To see what happens in the case of failback (reverse replication), let’s assume that VMNetwork1-NewYork is mapped to VMNetwork1-Chicago, with the following settings.</span></span>


<span data-ttu-id="90032-190">**Виртуальная машина**</span><span class="sxs-lookup"><span data-stu-id="90032-190">**Virtual machine**</span></span> | <span data-ttu-id="90032-191">**Подключенная сеть виртуальных машин**</span><span class="sxs-lookup"><span data-stu-id="90032-191">**Connected to VM network**</span></span>
---|---
<span data-ttu-id="90032-192">VM1</span><span class="sxs-lookup"><span data-stu-id="90032-192">VM1</span></span> | <span data-ttu-id="90032-193">VMNetwork1-Network</span><span class="sxs-lookup"><span data-stu-id="90032-193">VMNetwork1-Network</span></span>
<span data-ttu-id="90032-194">VM2 (реплика VM1)</span><span class="sxs-lookup"><span data-stu-id="90032-194">VM2 (replica of VM1)</span></span> | <span data-ttu-id="90032-195">VMNetwork1-Chicago</span><span class="sxs-lookup"><span data-stu-id="90032-195">VMNetwork1-Chicago</span></span>

<span data-ttu-id="90032-196">Приняв эти параметры, рассмотрим, что происходит в нескольких возможных сценариях.</span><span class="sxs-lookup"><span data-stu-id="90032-196">With these settings, let's review what happens in a couple of possible scenarios.</span></span>

<span data-ttu-id="90032-197">**Сценарий**</span><span class="sxs-lookup"><span data-stu-id="90032-197">**Scenario**</span></span> | <span data-ttu-id="90032-198">**Результат**</span><span class="sxs-lookup"><span data-stu-id="90032-198">**Outcome**</span></span>
---|---
<span data-ttu-id="90032-199">Сетевые свойства VM-2 не изменяются после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="90032-199">No change in the network properties of VM-2 after failover.</span></span> | <span data-ttu-id="90032-200">VM-1 остается подключенной к исходной сети.</span><span class="sxs-lookup"><span data-stu-id="90032-200">VM-1 remains connected to the source network.</span></span>
<span data-ttu-id="90032-201">Сетевые свойства VM-2 изменяются после отработки отказа, и она отключается.</span><span class="sxs-lookup"><span data-stu-id="90032-201">Network properties of VM-2 are changed after failover and is disconnected.</span></span> | <span data-ttu-id="90032-202">VM-1 отключается.</span><span class="sxs-lookup"><span data-stu-id="90032-202">VM-1 is disconnected.</span></span>
<span data-ttu-id="90032-203">Сетевые свойства VM-2 изменяются после отработки отказа, и она подключается к VMNetwork2-Chicago.</span><span class="sxs-lookup"><span data-stu-id="90032-203">Network properties of VM-2 are changed after failover and is connected to VMNetwork2-Chicago.</span></span> | <span data-ttu-id="90032-204">Если VMNetwork2-Chicago не сопоставлена, VM-1 будет отключена.</span><span class="sxs-lookup"><span data-stu-id="90032-204">If VMNetwork2-Chicago isn’t mapped, VM-1 will be disconnected.</span></span>
<span data-ttu-id="90032-205">Сетевое сопоставление VMNetwork1-Chicago изменяется.</span><span class="sxs-lookup"><span data-stu-id="90032-205">Network mapping of VMNetwork1-Chicago is changed.</span></span> | <span data-ttu-id="90032-206">VM-1 будет подключена к сети, сопоставленной с VMNetwork1-Chicago.</span><span class="sxs-lookup"><span data-stu-id="90032-206">VM-1 will be connected to the network now mapped to VMNetwork1-Chicago.</span></span>



## <a name="prepare-for-network-mapping"></a><span data-ttu-id="90032-207">Подготовка к сопоставлению сетей</span><span class="sxs-lookup"><span data-stu-id="90032-207">Prepare for network mapping</span></span>

1. <span data-ttu-id="90032-208">На исходном и целевом серверах VMM должна находится логическая сеть, связанная с исходным и целевым облаком.</span><span class="sxs-lookup"><span data-stu-id="90032-208">On the source and target VMM servers, you should have a logical network associated with the source and target clouds.</span></span> 
2. <span data-ttu-id="90032-209">На исходном и целевом серверах должна находится сеть виртуальной машины, связанная с логической сетью.</span><span class="sxs-lookup"><span data-stu-id="90032-209">In the source and target servers, you should have a VM network linked to the logical network.</span></span>
3. <span data-ttu-id="90032-210">Виртуальные машины на узлах Hyper-V в исходном расположении должны быть связаны с сетью исходной виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="90032-210">VMs on Hyper-V hosts in the source location should be linked to the source VM network.</span></span> <span data-ttu-id="90032-211">Если вы используете один сервер VMM, можно настроить сопоставление сетей виртуальных машин на одном сервере.</span><span class="sxs-lookup"><span data-stu-id="90032-211">If you're only using a single VMM server, you can configure mapping between VM networks on the same server.</span></span>

<span data-ttu-id="90032-212">Вот что происходит при настройке сетевого сопоставления во время развертывания Site Recovery:</span><span class="sxs-lookup"><span data-stu-id="90032-212">Here's what happens when you set up network mapping during Site Recovery deployment:</span></span>

- <span data-ttu-id="90032-213">При настройки сетевого сопоставления и выборе сети целевой виртуальной машины отобразятся исходные облака VMM, использующие сеть исходной виртуальной машины, а также доступные сети целевой виртуальной машины в целевых облаках.</span><span class="sxs-lookup"><span data-stu-id="90032-213">When you set up network mapping and select a target VM network, the VMM source clouds that use the source VM network will be displayed, along with the available target VM networks on the target clouds.</span></span>
- - <span data-ttu-id="90032-214">Если сопоставление настроено правильно, а репликация включена, исходная виртуальная машина будет подключена к своей сети, а ее реплика из целевого расположения будет подключена к сопоставленной с ней сети.</span><span class="sxs-lookup"><span data-stu-id="90032-214">When mapping is configured correctly and replication is enabled, a source VM will be connected to its source VM network, and its replica at the target location will be connected to its mapped VM network.</span></span>
- <span data-ttu-id="90032-215">Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то после отработки отказа реплика виртуальной машины будет подключена к этой целевой подсети.</span><span class="sxs-lookup"><span data-stu-id="90032-215">If the target network has multiple subnets, and one of those subnets has the same name as the subnet on which the source virtual machine is located, then the replica virtual machine will be connected to that target subnet after failover.</span></span> <span data-ttu-id="90032-216">Если нет подсетей с таким же именем, виртуальная машина будет подключена к первой подсети в сети.</span><span class="sxs-lookup"><span data-stu-id="90032-216">If there’s no target subnet with a matching name, the VM will be connected to the first subnet in the network.</span></span>

## <a name="connect-to-vms-after-failover"></a><span data-ttu-id="90032-217">Подключение к виртуальным машинам после отработки отказа</span><span class="sxs-lookup"><span data-stu-id="90032-217">Connect to VMs after failover</span></span>

<span data-ttu-id="90032-218">При планировании стратегии репликации и отработки отказа одним из ключевых вопросов является способ подключения к реплике после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="90032-218">When planning your replication and failover strategy, one of the key questions is how to connect to the replica after failover.</span></span> <span data-ttu-id="90032-219">Существует несколько вариантов:</span><span class="sxs-lookup"><span data-stu-id="90032-219">There are a couple of choices:</span></span> 

- <span data-ttu-id="90032-220">**Использование другого IP-адреса.** Для реплицируемых виртуальных машин можно выбрать другой IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="90032-220">**Use a different IP address**: You can select to use a different IP address for the replicated VM.</span></span> <span data-ttu-id="90032-221">В этом сценарии после отработки отказа виртуальная машина получает новый IP-адрес, а также требуется обновление DNS.</span><span class="sxs-lookup"><span data-stu-id="90032-221">In this scenario the VM gets a new IP address after failover, and a DNS update is required.</span></span>
- <span data-ttu-id="90032-222">**Сохранение того же IP-адреса.** Вы можете использовать тот же IP-адрес для виртуальной машины реплики.</span><span class="sxs-lookup"><span data-stu-id="90032-222">**Retain the same IP address**: You might want to use the same IP address for the replica VM.</span></span> <span data-ttu-id="90032-223">Использование тех же IP-адресов упрощает процесс восстановления, уменьшая количество проблем с сетью после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="90032-223">Keeping the same IP addresses simplifies the recovery by reducing network related issues after failover.</span></span> 

## <a name="retain-ip-addresses"></a><span data-ttu-id="90032-224">Использование тех же IP-адресов</span><span class="sxs-lookup"><span data-stu-id="90032-224">Retain IP addresses</span></span>

<span data-ttu-id="90032-225">Если вы хотите сохранить IP-адреса с основного сайта после отработки отказа на дополнительный сайт, выполните полную отработку отказа подсети и обновите маршруты, чтобы указать новое расположение IP-адресов, или разверните растянутую подсеть между основным и дополнительным сайтами.</span><span class="sxs-lookup"><span data-stu-id="90032-225">If you want to retain the IP addresses from the primary site after failover to the secondary site, you can do a full subnet failover, and update routes to indicate the new location of the IP addresses, or alternative deploy a stretched subnet between the primary and the recovery sites.</span></span>

### <a name="stretched-subnet"></a><span data-ttu-id="90032-226">Растянутая подсеть</span><span class="sxs-lookup"><span data-stu-id="90032-226">Stretched subnet</span></span>

<span data-ttu-id="90032-227">Растянутая подсеть доступна одновременно для основного и дополнительного сайта.</span><span class="sxs-lookup"><span data-stu-id="90032-227">In a stretched subnet, the subnet is available simultaneously in both the primary and secondary site.</span></span> <span data-ttu-id="90032-228">Вы можете переместить сервер и его IP-конфигурацию (уровень 3) на дополнительный сайт, а сеть направит трафик в новое местоположение автоматически.</span><span class="sxs-lookup"><span data-stu-id="90032-228">If you move a server and its IP (Layer 3) configuration to the secondary site, the network will route the traffic to the new location automatically.</span></span> 

<span data-ttu-id="90032-229">С точки зрения уровня 2 (уровень связи данных) требуется сетевое оборудование, с помощью которого можно управлять растянутой виртуальной локальной сетью.</span><span class="sxs-lookup"><span data-stu-id="90032-229">From a Layer 2 (data link layer) perspective, you need networking equipment that can manage a stretched VLAN.</span></span> <span data-ttu-id="90032-230">Кроме того, при растягивании виртуальной локальной сети потенциальная возможность домена сбоя будет затрагивать оба объекта, которые, по сути, становятся единой точкой отказа.</span><span class="sxs-lookup"><span data-stu-id="90032-230">In addition, by stretching the VLAN, the potential fault domain extends to both sites, essentially becoming a single point of failure.</span></span> <span data-ttu-id="90032-231">Хотя это маловероятно, может произойти сетевая буря, которую не получится изолировать.</span><span class="sxs-lookup"><span data-stu-id="90032-231">While this is an unlikely, it could happen that a broadcast storm started and cannot be isolated.</span></span> 


### <a name="subnet-failover"></a><span data-ttu-id="90032-232">Отработка отказа подсети</span><span class="sxs-lookup"><span data-stu-id="90032-232">Subnet failover</span></span>

<span data-ttu-id="90032-233">Вы можете выполнить отработку отказа в подсети, чтобы воспользоваться преимуществами растянутой подсети без фактического растягивания.</span><span class="sxs-lookup"><span data-stu-id="90032-233">You can run a subnet failover to obtain the benefits of the stretched subnet, without actually stretching it.</span></span> <span data-ttu-id="90032-234">В этом решении подсеть будет доступна на исходном или целевом сайте, но не на обоих одновременно.</span><span class="sxs-lookup"><span data-stu-id="90032-234">In this solution, a subnet will be available in the source or target site, but not at both simultaneously.</span></span> <span data-ttu-id="90032-235">Чтобы сохранить пространство IP-адресов в случае отработки отказа, программными средствами можно сделать так, чтобы инфраструктура маршрутизаторов перемещала подсети с одного сайта на другой.</span><span class="sxs-lookup"><span data-stu-id="90032-235">To maintain the IP address space in the event of a failover, you can programmatically arrange for the router infrastructure to move the subnets from one site to another.</span></span> <span data-ttu-id="90032-236">После отработки отказа подсети переместятся со связанными виртуальными машинами.</span><span class="sxs-lookup"><span data-stu-id="90032-236">After when failover occurs, subnets would move with the associated VMs.</span></span> <span data-ttu-id="90032-237">Основным недостатком является то, что в случае сбоя необходимо переместить всю подсеть.</span><span class="sxs-lookup"><span data-stu-id="90032-237">The main drawback is that in the event of a failure, you have to move the whole subnet.</span></span>

### <a name="example"></a><span data-ttu-id="90032-238">Пример</span><span class="sxs-lookup"><span data-stu-id="90032-238">Example</span></span>

<span data-ttu-id="90032-239">Ниже приведен пример полной отработки отказа подсети.</span><span class="sxs-lookup"><span data-stu-id="90032-239">Here's an example of complete subnet failover.</span></span> <span data-ttu-id="90032-240">На основном объекте приложения работают в подсети 192.168.1.0/24.</span><span class="sxs-lookup"><span data-stu-id="90032-240">The primary site has applications running in subnet 192.168.1.0/24.</span></span> <span data-ttu-id="90032-241">После отработки отказа все виртуальные машины в этой подсети переносятся на дополнительный сайт с сохранением IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="90032-241">At failover, all the VMs in this subnet are failed over to the secondary site, and retain their IP addresses.</span></span> <span data-ttu-id="90032-242">Маршруты необходимо изменить, чтобы указать, что все виртуальные машины, принадлежащих подсети 192.168.1.0/24, теперь перемещены на дополнительный сайт.</span><span class="sxs-lookup"><span data-stu-id="90032-242">Routes need to be modified to reflect the fact that all the VM virtual machines belonging to subnet 192.168.1.0/24 have now moved to the secondary site.</span></span>

<span data-ttu-id="90032-243">На следующем рисунке показаны подсети до и после отработки отказа:</span><span class="sxs-lookup"><span data-stu-id="90032-243">The following graphics show the subnets before and after failover:</span></span>

- <span data-ttu-id="90032-244">Перед отработкой отказа подсеть 192.168.0.1/24 активна на исходном сайте, а после него становится активной на дополнительном.</span><span class="sxs-lookup"><span data-stu-id="90032-244">Before failover, subnet 192.168.0.1/24 is active on the source site, become active on the secondary site after failover.</span></span>
- <span data-ttu-id="90032-245">Маршруты между основным сайтом и сайтом восстановления, третьим сайтом и основным сайтом, а также третьим сайтом и сайтом восстановления необходимо изменить соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="90032-245">The routes between primary site and recovery site, third site and primary site, and third site and recovery site will have to be appropriately modified.</span></span>

<span data-ttu-id="90032-246">**Перед выполнением отработки отказа**</span><span class="sxs-lookup"><span data-stu-id="90032-246">**Before failover**</span></span>

![Перед выполнением отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design2.png)

<span data-ttu-id="90032-248">**После выполнения отработки отказа**</span><span class="sxs-lookup"><span data-stu-id="90032-248">**After failover**</span></span>

![После выполнения отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design3.png)

<span data-ttu-id="90032-250">После отработки отказа происходит следующее:</span><span class="sxs-lookup"><span data-stu-id="90032-250">After failover, here's what happens:</span></span>

- <span data-ttu-id="90032-251">Site Recovery выделяет IP-адреса для каждого сетевого интерфейса на виртуальной машине из пула статических IP-адресов в соответствующей сети для каждого экземпляра VMM.</span><span class="sxs-lookup"><span data-stu-id="90032-251">Site Recovery allocates an IP address for each network interface on the VM, from the static IP address pool in the relevant network, for each VMM instance.</span></span>
- <span data-ttu-id="90032-252">Если пул IP-адресов на дополнительном сайте совпадает с пулом на исходном, Site Recovery выделяет виртуальной машине реплики одинаковые IP-адреса (исходной виртуальной машины).</span><span class="sxs-lookup"><span data-stu-id="90032-252">If the IP address pool in the secondary site is the same as that on the source site, Site Recovery allocates the same IP address (of the source VM) to the replica VM.</span></span> <span data-ttu-id="90032-253">IP-адрес резервируется в VMM, но он не задан как IP-адрес для отработки отказа на узле Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="90032-253">The IP address is reserved in VMM, but it isn't set as the failover IP address on the Hyper-V host.</span></span> <span data-ttu-id="90032-254">IP-адрес отработки отказа задается на узле Hyper-V непосредственно перед отработкой отказа.</span><span class="sxs-lookup"><span data-stu-id="90032-254">The failover IP address on a Hyper-v host is set just before the failover.</span></span>
- <span data-ttu-id="90032-255">Если же IP-адрес недоступен, Site Recovery выделяет другой доступный адрес из пула.</span><span class="sxs-lookup"><span data-stu-id="90032-255">If the same IP address isn't available, Site Recovery allocates another available IP address from the pool.</span></span>
- <span data-ttu-id="90032-256">Если виртуальные машины используют DHCP, Site Recovery не управляет IP-адресами.</span><span class="sxs-lookup"><span data-stu-id="90032-256">If VMs use DHCP, Site Recovery doesn't manage the IP addresses.</span></span> <span data-ttu-id="90032-257">Убедитесь, что DHCP-сервер на дополнительном сайте может выделить адрес из того же диапазона, как и на исходном сайте.</span><span class="sxs-lookup"><span data-stu-id="90032-257">You need to check that the DHCP server on the secondary site can allocate address from the same range as the source site.</span></span>

### <a name="validate-the-ip-address"></a><span data-ttu-id="90032-258">Проверка IP-адреса</span><span class="sxs-lookup"><span data-stu-id="90032-258">Validate the IP address</span></span>

<span data-ttu-id="90032-259">После включения защиты для виртуальной машины воспользуйтесь следующим примером сценария, чтобы проверить назначенный ей адрес.</span><span class="sxs-lookup"><span data-stu-id="90032-259">After you enable protection for a VM, you can use following sample script to verify the address assigned to the VM.</span></span> <span data-ttu-id="90032-260">Тот же IP-адрес будет задан в качестве IP-адреса отработки отказа и назначен виртуальной машине во время отработки отказа:</span><span class="sxs-lookup"><span data-stu-id="90032-260">The same IP address will be set as the failover IP address, and assigned to the VM at the time of failover:</span></span>

    ```
    $vm = Get-SCVirtualMachine -Name <VM_NAME>
    $na = $vm[0].VirtualNetworkAdapters>
    $ip = Get-SCIPAddress -GrantToObjectID $na[0].id
    $ip.address 
    ```

## <a name="changing-ip-addresses"></a><span data-ttu-id="90032-261">Изменение IP-адресов</span><span class="sxs-lookup"><span data-stu-id="90032-261">Changing IP addresses</span></span>

<span data-ttu-id="90032-262">В этом сценарии IP-адреса виртуальных машин, для которых выполняется отработка отказа, изменяются.</span><span class="sxs-lookup"><span data-stu-id="90032-262">In this scenario, the IP addresses of VMs that fail over are changed.</span></span> <span data-ttu-id="90032-263">Недостаток этого решения — необходимость в обслуживании.</span><span class="sxs-lookup"><span data-stu-id="90032-263">The drawback of this solution is the maintenance required.</span></span> <span data-ttu-id="90032-264">Как правило, DNS обновляется после запуска виртуальных машин реплики.</span><span class="sxs-lookup"><span data-stu-id="90032-264">Typically, DNS will be updated after replica VMs start.</span></span> <span data-ttu-id="90032-265">Вам может потребоваться изменить DNS в сети и обновить кэшированные записи.</span><span class="sxs-lookup"><span data-stu-id="90032-265">DNS entries might need to be changed or fluster in thenetwork, and cached entries updated.</span></span> <span data-ttu-id="90032-266">Это может привести к возникновению простоя.</span><span class="sxs-lookup"><span data-stu-id="90032-266">This can result in downtime.</span></span> <span data-ttu-id="90032-267">Простой можно устранить следующим образом:</span><span class="sxs-lookup"><span data-stu-id="90032-267">Downtime can be mitigated as follows:</span></span>

- <span data-ttu-id="90032-268">Используйте низкие значения срока жизни для приложений интрасети.</span><span class="sxs-lookup"><span data-stu-id="90032-268">Use low TTL values for intranet applications.</span></span>
- <span data-ttu-id="90032-269">Используйте следующий сценарий в плане восстановления Site Recovery, чтобы обновить DNS-сервер и гарантировать своевременное обновление.</span><span class="sxs-lookup"><span data-stu-id="90032-269">Use the following script in a Site Recovery recovery plan, to update the DNS server to ensure a timely update.</span></span> <span data-ttu-id="90032-270">Сценарий не требуется, если используется динамическая регистрация DNS.</span><span class="sxs-lookup"><span data-stu-id="90032-270">You don't need the script if you use dynamic DNS registration.</span></span>

    ```
    param(
    string]$Zone,
    [string]$name,
    [string]$IP
    )
    $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
    $newrecord = $record.clone()
    $newrecord.RecordData[0].IPv4Address  =  $IP
    Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord
    ```
    
### <a name="example"></a><span data-ttu-id="90032-271">Пример</span><span class="sxs-lookup"><span data-stu-id="90032-271">Example</span></span> 

<span data-ttu-id="90032-272">Рассмотрим сценарий, в котором планируется использовать разные IP-адреса на основном сайте и сайтах восстановления. В этом примере у нас есть разные IP-адреса на основных и дополнительных сайтах, а также имеется третий сайт, с которого можно получить доступ к приложениям, размещенным на основном сайте или сайте восстановления.</span><span class="sxs-lookup"><span data-stu-id="90032-272">Let's look at a scenario in which you're planning to use different IP addresses across the primary and the recovery sites.In this example we have different IP addresses across primary and secondary sites, and there;s a third site from which applications hosted on the primary or recovery site can be accessed.</span></span>

- <span data-ttu-id="90032-273">Перед отработкой отказа приложения размещены в подсети 192.168.1.0/24 на основном сайте, а после него переходят в подсеть 172.16.1.0/24 на дополнительном сайте.</span><span class="sxs-lookup"><span data-stu-id="90032-273">Before failover, apps are hosted subnet 192.168.1.0/24 on the primary site, and are configured to be in subnet 172.16.1.0/24 on the secondary site after a failover.</span></span>
- <span data-ttu-id="90032-274">VPN-подключения/сетевые маршруты были настроены так, чтобы все три объекта могли иметь доступ друг к другу.</span><span class="sxs-lookup"><span data-stu-id="90032-274">VPN connections/network routes have been configured appropriately so that all three sites can access each other.</span></span>
- <span data-ttu-id="90032-275">После отработки отказа приложения будут восстановлены в подсети восстановления.</span><span class="sxs-lookup"><span data-stu-id="90032-275">After failover, apps will be restored in the recovery subnet.</span></span> <span data-ttu-id="90032-276">В этом сценарии не нужно выполнять отработку отказа всей подсети, а также вносить изменения для перенастройки VPN или сетевых маршрутов.</span><span class="sxs-lookup"><span data-stu-id="90032-276">In this scenario there's no need to fail over the entire subnet, and no changes are needed to reconfigure VPN or network routes.</span></span> <span data-ttu-id="90032-277">Отработка отказа и некоторые обновления DNS обеспечивают доступность приложений.</span><span class="sxs-lookup"><span data-stu-id="90032-277">The failover, and some DNS updates, ensure that applications remain accessible.</span></span>
- <span data-ttu-id="90032-278">Если DNS настроен для разрешения динамических обновлений, после запуска по завершении отработки отказа виртуальные машины зарегистрируются, используя новый IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="90032-278">If DNS is configured to allow dynamic updates, then the VMs will register themselves using the new IP address, when they start after failover.</span></span>

<span data-ttu-id="90032-279">**Перед выполнением отработки отказа**</span><span class="sxs-lookup"><span data-stu-id="90032-279">**Before failover**</span></span>

![Другой IP-адрес — до отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design10.png)

<span data-ttu-id="90032-281">**После выполнения отработки отказа**</span><span class="sxs-lookup"><span data-stu-id="90032-281">**After failover**</span></span>

![Другой IP-адрес — после отработки отказа](./media/vmm-to-vmm-walkthrough-network/network-design11.png)



## <a name="next-steps"></a><span data-ttu-id="90032-283">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="90032-283">Next steps</span></span>

<span data-ttu-id="90032-284">Перейдите к статье [Шаг 4. Настройка VMM и Hyper-V для репликации виртуальной машины Hyper-V на дополнительный сайт](vmm-to-vmm-walkthrough-vmm-hyper-v.md).</span><span class="sxs-lookup"><span data-stu-id="90032-284">Go to [Step 4: Prepare VMM and Hyper-V](vmm-to-vmm-walkthrough-vmm-hyper-v.md).</span></span>



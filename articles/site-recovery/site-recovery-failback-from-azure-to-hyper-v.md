---
title: "Восстановление размещения в Azure Site Recovery для виртуальных машин Hyper-V| Документация Майкрософт"
description: "Azure Site Recovery координирует репликацию, отработку отказа и восстановление виртуальных машин и физических серверов. Сведения о восстановлении размещения из Azure в локальный центр данных."
services: site-recovery
documentationcenter: 
author: ruturaj
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 08/11/2017
ms.author: ruturajd
ms.openlocfilehash: 719fe167c1298d8a48f5906c4e29e5f5825e5aef
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="failback-in-site-recovery-for-hyper-v-virtual-machines"></a><span data-ttu-id="78cba-104">Восстановление размещения в Site Recovery для виртуальных машин Hyper-V</span><span class="sxs-lookup"><span data-stu-id="78cba-104">Failback in Site Recovery for Hyper-V virtual machines</span></span>

<span data-ttu-id="78cba-105">В этой статье описывается восстановление размещения виртуальных машин, защищенных службой Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="78cba-105">This article describes how to failback virtual machines protected by Site Recovery.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="78cba-106">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="78cba-106">Prerequisites</span></span>
1. <span data-ttu-id="78cba-107">Убедитесь, что сервер первичного сайта VMM или Hyper-V подключен.</span><span class="sxs-lookup"><span data-stu-id="78cba-107">Ensure that the primary site VMM server/Hyper-V server is connected.</span></span>
2. <span data-ttu-id="78cba-108">На виртуальной машине выполните **фиксацию**.</span><span class="sxs-lookup"><span data-stu-id="78cba-108">You should have performed **Commit** on the virtual machine.</span></span>

## <a name="why-is-there-no-button-called-failback"></a><span data-ttu-id="78cba-109">Почему нет кнопки, которая называется "Восстановить размещение"?</span><span class="sxs-lookup"><span data-stu-id="78cba-109">Why is there no button called failback?</span></span>
<span data-ttu-id="78cba-110">На портале нет явной команды, которая называется "восстановить размещение".</span><span class="sxs-lookup"><span data-stu-id="78cba-110">On the portal, there is no explicit gesture called failback.</span></span> <span data-ttu-id="78cba-111">Восстановление размещения — это этап, на котором вы можете вернуться на первичный сайт.</span><span class="sxs-lookup"><span data-stu-id="78cba-111">Failback is a step where you come back to the primary site.</span></span> <span data-ttu-id="78cba-112">По определению отработка отказа виртуальных машин выполняется с первичного (локального) сайта на сайт восстановления (Azure). Восстановление размещения — это отработка отказа виртуальных машин с сайта восстановления обратно на первичный сайт.</span><span class="sxs-lookup"><span data-stu-id="78cba-112">By definition, failover is when you failover the virtual machines from primary(on-premises) site to recovery (Azure), and failback is when you failover the virtual machines from recovery back to primary.</span></span>

<span data-ttu-id="78cba-113">При запуске отработки отказа в колонке появляется сообщение о направлении задания.</span><span class="sxs-lookup"><span data-stu-id="78cba-113">When you initiate a failover, the blade informs you about the direction of the job.</span></span> <span data-ttu-id="78cba-114">Если задание направлено "из Azure в локальную среду", это восстановление размещения.</span><span class="sxs-lookup"><span data-stu-id="78cba-114">If the direction is from Azure to On-premises, it is a failback.</span></span>

## <a name="why-is-there-only-a-planned-failover-gesture-to-failback"></a><span data-ttu-id="78cba-115">Почему существует только плановая команда для восстановления размещения?</span><span class="sxs-lookup"><span data-stu-id="78cba-115">Why is there only a planned failover gesture to failback?</span></span>
<span data-ttu-id="78cba-116">Azure — это среда с высокой доступностью, в которой ваши виртуальные машины всегда доступны.</span><span class="sxs-lookup"><span data-stu-id="78cba-116">Azure is a highly available environment and your virtual machines will be always available.</span></span> <span data-ttu-id="78cba-117">Восстановление размещения является планируемой операцией, для выполнения которой образуется небольшой простой, чтобы рабочие нагрузки снова можно было запустить локально.</span><span class="sxs-lookup"><span data-stu-id="78cba-117">Failback is a planned activity where you decide to take a small downtime so that the workloads can start running on-premises again.</span></span> <span data-ttu-id="78cba-118">Эта операция выполняется без потери данных.</span><span class="sxs-lookup"><span data-stu-id="78cba-118">This expects no data loss.</span></span> <span data-ttu-id="78cba-119">Поэтому доступна только плановая команда для восстановления размещения, которая выключает виртуальные машины в Azure, загружает последние изменения и гарантирует сохранность данных.</span><span class="sxs-lookup"><span data-stu-id="78cba-119">Hence only a planned failover gesture is available, that will turn off the VMs in Azure, download the latest changes and ensure there is no data loss.</span></span>

## <a name="initiate-failback"></a><span data-ttu-id="78cba-120">Запуск восстановления размещения</span><span class="sxs-lookup"><span data-stu-id="78cba-120">Initiate failback</span></span>
<span data-ttu-id="78cba-121">После отработки отказа из основного расположения в дополнительное реплицированные виртуальные машины не будут защищены службой Site Recovery, а дополнительное расположение станет активным.</span><span class="sxs-lookup"><span data-stu-id="78cba-121">After failover from the primary to secondary location, replicated virtual machines aren't protected by Site Recovery, and the secondary location is now acting as the active location.</span></span> <span data-ttu-id="78cba-122">Выполните указанные ниже процедуры, чтобы восстановить размещение на исходном основном сайте.</span><span class="sxs-lookup"><span data-stu-id="78cba-122">Follow these procedures to fail back to the original primary site.</span></span> <span data-ttu-id="78cba-123">В этой процедуре рассказывается, как запустить плановую тестовую отработку отказа для плана восстановления.</span><span class="sxs-lookup"><span data-stu-id="78cba-123">This procedure describes how to run a planned failover for a recovery plan.</span></span> <span data-ttu-id="78cba-124">В качестве альтернативы на вкладке **Виртуальные машины** можно запустить отработку отказа для одной виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="78cba-124">Alternatively you can run the failover for a single virtual machine on the **Virtual Machines** tab.</span></span>

1. <span data-ttu-id="78cba-125">Выберите **Планы восстановления** > *имя_плана_восстановления*.</span><span class="sxs-lookup"><span data-stu-id="78cba-125">Select **Recovery Plans** > *recoveryplan_name*.</span></span> <span data-ttu-id="78cba-126">Последовательно выберите пункты **Тип отработки отказа** > **Planned Тип отработки отказа**.</span><span class="sxs-lookup"><span data-stu-id="78cba-126">Click **Failover** > **Planned Failover**.</span></span>
2. <span data-ttu-id="78cba-127">На странице **Подтвердить плановую отработку отказа** выберите исходное и целевое расположения.</span><span class="sxs-lookup"><span data-stu-id="78cba-127">On the **Confirm Planned Failover **page, choose the source and target locations.</span></span> <span data-ttu-id="78cba-128">Запомните направление отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="78cba-128">Note the failover direction.</span></span> <span data-ttu-id="78cba-129">Если отработка отказа с переносом из основного расположения выполнена правильно и все виртуальные машины находятся в дополнительном расположении, то эти данные будут носить исключительно информационный характер.</span><span class="sxs-lookup"><span data-stu-id="78cba-129">If the failover from primary worked as expect and all virtual machines are in the secondary location this is for information only.</span></span>
3. <span data-ttu-id="78cba-130">Если вы восстанавливаете размещение, выполняя перенос из Azure, выберите необходимые параметры в разделе **Синхронизация данных**.</span><span class="sxs-lookup"><span data-stu-id="78cba-130">If you're failing back from Azure select settings in **Data Synchronization**:</span></span>

   * <span data-ttu-id="78cba-131">**Синхронизация данных до отработки отказа (синхронизация только разностных изменений)**. Этот параметр сводит к минимуму время простоя виртуальных машин, так как синхронизация выполняется без завершения их работы.</span><span class="sxs-lookup"><span data-stu-id="78cba-131">**Synchronize data before failover(Synchronize delta changes only)**—This option minimizes downtime for virtual machines as it synchronizes without shutting them down.</span></span> <span data-ttu-id="78cba-132">Он выполняет следующие действия:</span><span class="sxs-lookup"><span data-stu-id="78cba-132">It does the following:</span></span>
     * <span data-ttu-id="78cba-133">Этап 1. Создание снимка виртуальной машины в Azure и копирование его на локальный узел Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="78cba-133">Phase 1: Takes snapshot of the virtual machine in Azure and copies it to the on-premises Hyper-V host.</span></span> <span data-ttu-id="78cba-134">Машина продолжит работать в Azure.</span><span class="sxs-lookup"><span data-stu-id="78cba-134">The machine continues running in Azure.</span></span>
     * <span data-ttu-id="78cba-135">Этап 2. Завершение работы виртуальной машины в Azure, чтобы в ней больше не происходило изменений.</span><span class="sxs-lookup"><span data-stu-id="78cba-135">Phase 2: Shuts down the virtual machine in Azure so that no new changes occur there.</span></span> <span data-ttu-id="78cba-136">Последний набор разностных изменений передается на локальный сервер, после чего запускается локальная виртуальная машина.</span><span class="sxs-lookup"><span data-stu-id="78cba-136">The final set of delta changes are transferred to the on-premises server and the on-premises virtual machine is started up.</span></span>

    - <span data-ttu-id="78cba-137">**Синхронизация данных только во время отработки отказа (полное скачивание)**. Укажите этот параметр, если использовали Azure в течение длительного времени.</span><span class="sxs-lookup"><span data-stu-id="78cba-137">**Synchronize data during failover only(full download)**—Use this option if you've been running on Azure for a long time.</span></span> <span data-ttu-id="78cba-138">Этот параметр обеспечивает более быстрое выполнение, так как предполагает изменение большей части диска и исключает затраты времени на вычисление контрольной суммы.</span><span class="sxs-lookup"><span data-stu-id="78cba-138">This option is faster because we expect that most of the disk has changed and we don't want to spend time in checksum calculation.</span></span> <span data-ttu-id="78cba-139">Выполняется скачивание диска.</span><span class="sxs-lookup"><span data-stu-id="78cba-139">It performs a download of the disk.</span></span> <span data-ttu-id="78cba-140">Это также удобно, если локальная виртуальная машина была удалена.</span><span class="sxs-lookup"><span data-stu-id="78cba-140">It is also useful when the on-prem virtual machine has been deleted.</span></span>

    >[!NOTE]
    ><span data-ttu-id="78cba-141">Рекомендуется использовать этот параметр, если вы использовали Azure какое-то время (месяц или дольше) или локальная виртуальная машина была удалена. Этот параметр не задает вычисление контрольных сумм.</span><span class="sxs-lookup"><span data-stu-id="78cba-141">We recommend you use this option if you've been running Azure for a while (a month or more) or the on-prem virtual machine has been deleted.This option doesn't perform any checksum calculations.</span></span>
    >
    >




4. <span data-ttu-id="78cba-142">Если включена функция шифрования данных для облака, в разделе **Ключ шифрования** выберите сертификат, который был выпущен, когда во время установки поставщика на VMM-сервер вы включили функцию шифрования данных.</span><span class="sxs-lookup"><span data-stu-id="78cba-142">If data encryption is enabled for the cloud, in **Encryption Key** select the certificate that was issued when you enabled data encryption during Provider installation on the VMM server.</span></span>
5. <span data-ttu-id="78cba-143">Запустите отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="78cba-143">Initiate the failover.</span></span> <span data-ttu-id="78cba-144">На вкладке **Задания** можно следить за ходом выполнения отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="78cba-144">You can follow the failover progress on the **Jobs** tab.</span></span>
6. <span data-ttu-id="78cba-145">Если вы выбрали параметр, при котором синхронизация данных выполняется до отработки отказа, то когда завершится начальная синхронизация данных и вы будете готовы завершить работу виртуальных машин в Azure, выберите **Задания** > <имя_задания_плановой_отработки_отказа> > **Выполнить отработку отказа**.</span><span class="sxs-lookup"><span data-stu-id="78cba-145">If you selected the option to synchronize the data before the failover, once the initial data synchronization is complete and you're ready to shut down the virtual machines in Azure, click **Jobs** planned failover job name **Complete Failover**.</span></span> <span data-ttu-id="78cba-146">Эта команда завершит работу машины Azure, передаст последние изменения на локальную виртуальную машину и запустит ее.</span><span class="sxs-lookup"><span data-stu-id="78cba-146">This shuts down the Azure machine, transfers the latest changes to the on-premises virtual machine, and starts the VM on-premises.</span></span>
7. <span data-ttu-id="78cba-147">После этого вы сможете выполнить вход в виртуальную машину, чтобы проверить ее доступность.</span><span class="sxs-lookup"><span data-stu-id="78cba-147">You can now log onto the virtual machine to validate it's available as expected.</span></span>
8. <span data-ttu-id="78cba-148">Виртуальная машина будет находиться в состоянии ожидания фиксации.</span><span class="sxs-lookup"><span data-stu-id="78cba-148">The virtual machine is in a commit pending state.</span></span> <span data-ttu-id="78cba-149">Для фиксации отработки отказа выберите команду **Зафиксировать** .</span><span class="sxs-lookup"><span data-stu-id="78cba-149">Click **Commit** to commit the failover.</span></span>
9. <span data-ttu-id="78cba-150">Теперь для восстановления размещения выберите пункт **Обратная репликация** , чтобы включить защиту виртуальной машины на основном сайте.</span><span class="sxs-lookup"><span data-stu-id="78cba-150">Now in order to complete the failback click **Reverse Replicate** to start protecting the virtual machine in the primary site.</span></span>

## <a name="failback-to-an-alternate-location"></a><span data-ttu-id="78cba-151">Восстановление расположения в альтернативном расположении</span><span class="sxs-lookup"><span data-stu-id="78cba-151">Failback to an alternate location</span></span>
<span data-ttu-id="78cba-152">Если вы развернули защиту между [сайтом Hyper-V и Azure](site-recovery-hyper-v-site-to-azure.md) , то можно восстановить размещение, выполнив перенос из Azure в альтернативное локальное расположение.</span><span class="sxs-lookup"><span data-stu-id="78cba-152">If you've deployed protection between a [Hyper-V site and Azure](site-recovery-hyper-v-site-to-azure.md) you have to ability to failback from Azure to an alternate on-premises location.</span></span> <span data-ttu-id="78cba-153">Это удобно, если необходимо настроить новое оборудование в локальной системе.</span><span class="sxs-lookup"><span data-stu-id="78cba-153">This is useful if you need to set up new on-premises hardware.</span></span> <span data-ttu-id="78cba-154">Вот как это сделать.</span><span class="sxs-lookup"><span data-stu-id="78cba-154">Here's how you do it.</span></span>

1. <span data-ttu-id="78cba-155">При настройке нового оборудования установите на сервере Windows Server 2012 R2 и роль Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="78cba-155">If you're setting up new hardware install Windows Server 2012 R2 and the Hyper-V role on the server.</span></span>
2. <span data-ttu-id="78cba-156">Создайте коммутатор виртуальной сети с тем же именем, что и на исходном сервере.</span><span class="sxs-lookup"><span data-stu-id="78cba-156">Create a virtual network switch with the same name that you had on the original server.</span></span>
3. <span data-ttu-id="78cba-157">Выберите группу **Защищенные элементы** -> **Группа защиты** -> <ProtectionGroupName> -> <VirtualMachineName>, для которой необходимо выполнить восстановление размещения, а затем выберите пункт **Плановая отработка отказа**.</span><span class="sxs-lookup"><span data-stu-id="78cba-157">Select **Protected Items** -> **Protection Group** -> <ProtectionGroupName> -> <VirtualMachineName> you want to fail back, and select **Planned Failover**.</span></span>
4. <span data-ttu-id="78cba-158">При необходимости в разделе **Подтвердить плановую отработку отказа** select **Создать локальную виртуальную машину, если ее не существует**.</span><span class="sxs-lookup"><span data-stu-id="78cba-158">In **Confirm Planned Failover** select **Create on-premises virtual machine if it does not exist**.</span></span>
5. <span data-ttu-id="78cba-159">В разделе **Имя узла** выберите новый сервер узла Hyper-V, на котором требуется разместить виртуальную машину.</span><span class="sxs-lookup"><span data-stu-id="78cba-159">In **Host Name** select the new Hyper-V host server on which you want to place the virtual machine.</span></span>
6. <span data-ttu-id="78cba-160">В разделе "Синхронизация данных" рекомендуется выбрать параметр **Синхронизировать данные до отработки отказа**.</span><span class="sxs-lookup"><span data-stu-id="78cba-160">In Data Synchronization we recommend you select  the option **Synchronize the data before the failover**.</span></span> <span data-ttu-id="78cba-161">Это сведет к минимуму простой виртуальных машин, так как синхронизация будет выполнена без завершения их работы.</span><span class="sxs-lookup"><span data-stu-id="78cba-161">This minimizes downtime for virtual machines as it synchronizes without shutting them down.</span></span> <span data-ttu-id="78cba-162">Он выполняет следующие действия:</span><span class="sxs-lookup"><span data-stu-id="78cba-162">It does the following:</span></span>

   * <span data-ttu-id="78cba-163">Этап 1. Создание снимка виртуальной машины в Azure и копирование его на локальный узел Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="78cba-163">Phase 1: Takes snapshot of the virtual machine in Azure and copies it to the on-premises Hyper-V host.</span></span> <span data-ttu-id="78cba-164">Машина продолжит работать в Azure.</span><span class="sxs-lookup"><span data-stu-id="78cba-164">The machine continues running in Azure.</span></span>
   * <span data-ttu-id="78cba-165">Этап 2. Завершение работы виртуальной машины в Azure, чтобы в ней больше не происходило изменений.</span><span class="sxs-lookup"><span data-stu-id="78cba-165">Phase 2: Shuts down the virtual machine in Azure so that no new changes occur there.</span></span> <span data-ttu-id="78cba-166">Последний набор изменений передается на локальный сервер, после чего запускается локальная виртуальная машина.</span><span class="sxs-lookup"><span data-stu-id="78cba-166">The final set of changes are transferred to the on-premises server and the on-premises virtual machine is started up.</span></span>
7. <span data-ttu-id="78cba-167">Установите этот флажок, чтобы начать отработку отказа (восстановление размещения).</span><span class="sxs-lookup"><span data-stu-id="78cba-167">Click the checkmark to begin the failover (failback).</span></span>
8. <span data-ttu-id="78cba-168">Когда завершится начальная синхронизация и вы будете готовы завершить работу виртуальной машины в Azure, выберите **Задания** > <planned failover job> > **Полная отработка отказа**.</span><span class="sxs-lookup"><span data-stu-id="78cba-168">After the initial synchronization finishes and you're ready to shut down the virtual machine in Azure, click **Jobs** > <planned failover job> > **Complete Failover**.</span></span> <span data-ttu-id="78cba-169">Эта команда завершит работу машины Azure и передаст последние изменения на локальную виртуальную машину, которая после этого будет запущена.</span><span class="sxs-lookup"><span data-stu-id="78cba-169">This shuts down the Azure machine, transfers the latest changes to the on-premises virtual machine and starts it.</span></span>
9. <span data-ttu-id="78cba-170">Вы можете выполнить вход в локальную виртуальную машину, чтобы проверить, что все работает правильно.</span><span class="sxs-lookup"><span data-stu-id="78cba-170">You can log onto the on-premises virtual machine to verify everything is working as expected.</span></span> <span data-ttu-id="78cba-171">Затем нажмите кнопку **Зафиксировать** , чтобы завершить отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="78cba-171">Then click **Commit** to finish the failover.</span></span>
10. <span data-ttu-id="78cba-172">Выберите пункт **Обратная репликация** , чтобы включить защиту локальной виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="78cba-172">Click **Reverse Replicate** to start protecting the on-premises virtual machine.</span></span>

    > [!NOTE]
    > <span data-ttu-id="78cba-173">Если отменить задание восстановления размещения на этапе синхронизации данных, локальная виртуальная машина будет в поврежденном состоянии.</span><span class="sxs-lookup"><span data-stu-id="78cba-173">If you cancel the failback job while it is in Data Synchronization step, the on-premises VM will be in a corrupted state.</span></span> <span data-ttu-id="78cba-174">Это связано с тем, что при синхронизации данных последние данные с дисков виртуальной машины Azure копируются на локальные диски данных, и пока синхронизация не завершится, диски данных могут находиться в несогласованном состоянии.</span><span class="sxs-lookup"><span data-stu-id="78cba-174">This is because Data Synchronization copies the latest data from Azure VM disks to the on-prem data disks, and until the synchronization completes, the disk data may not be in a consistent state.</span></span> <span data-ttu-id="78cba-175">Если отменить синхронизацию данных и попытаться загрузить локальную виртуальную машину, она может не загрузиться.</span><span class="sxs-lookup"><span data-stu-id="78cba-175">If the On-prem VM is booted after Data Synchronization is canceled, it may not boot.</span></span> <span data-ttu-id="78cba-176">Повторно активируйте отработку отказа, чтобы завершить синхронизацию данных.</span><span class="sxs-lookup"><span data-stu-id="78cba-176">Re-trigger failover to complete the Data Synchronization.</span></span>
    >
    >



## <a name="next-steps"></a><span data-ttu-id="78cba-177">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="78cba-177">Next Steps</span></span>

<span data-ttu-id="78cba-178">После завершения задания восстановления размещения **зафиксируйте** виртуальную машину.</span><span class="sxs-lookup"><span data-stu-id="78cba-178">Once you have completed the failback job, **Commit** the virtual machine.</span></span> <span data-ttu-id="78cba-179">Фиксация удаляет виртуальную машину Azure и ее диски и подготавливает виртуальную машину к защите.</span><span class="sxs-lookup"><span data-stu-id="78cba-179">Commit deletes the Azure virtual machine and its disks and prepares the VM to be protected again.</span></span>

<span data-ttu-id="78cba-180">После **фиксации** можно запустить *обратную репликацию*.</span><span class="sxs-lookup"><span data-stu-id="78cba-180">After **Commit**, you can initiate the *Reverse Replicate*.</span></span> <span data-ttu-id="78cba-181">Будет запущена репликация виртуальной машины из локальной среды обратно в Azure.</span><span class="sxs-lookup"><span data-stu-id="78cba-181">This will start protecting the virtual machine from on-premises back to Azure.</span></span> <span data-ttu-id="78cba-182">Обратите внимание, эта операция реплицирует изменения только с момента выключения виртуальной машины в Azure и отправляет только разностные изменения.</span><span class="sxs-lookup"><span data-stu-id="78cba-182">Note that this will only replicate the changes since the VM has been turned off in Azure and hence sends differential changes only.</span></span>

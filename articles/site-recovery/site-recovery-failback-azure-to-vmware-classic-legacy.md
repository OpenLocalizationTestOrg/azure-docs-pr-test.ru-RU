---
title: "Восстановление размещения виртуальных машин VMware из Azure на устаревшем классическом портале | Документация Майкрософт"
description: "В этой статье описывается восстановление размещения виртуальной машины VMware, реплицированной в Azure, с помощью службы Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: ruturaj
manager: mkjain
editor: 
ms.assetid: a63524bf-990c-42ee-8554-e017e6e67e68
ms.service: site-recovery
ms.devlang: na
ms.tgt_pltfrm: na
ms.topic: article
ms.workload: storage-backup-recovery
ms.date: 06/05/2017
ms.author: ruturajd@microsoft.com
ms.openlocfilehash: 3053fc622c6343898e2007b8aaafbe1fa8e6934e
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="fail-back-vmware-virtual-machines-and-physical-servers-from-azure-to-vmware-with-azure-site-recovery-legacy"></a>Восстановление размещения виртуальных машин и физических серверов VMware с переносом из Azure в VMware с помощью службы Azure Site Recovery (устарело)
> [!div class="op_single_selector"]
> * [Портал Azure](site-recovery-failback-azure-to-vmware.md)
> * [Классический портал Azure](site-recovery-failback-azure-to-vmware-classic.md)
> * [Классический портал Azure (прежняя версия)](site-recovery-failback-azure-to-vmware-classic-legacy.md)
>
>

В этой статье описывается, как восстановить размещение виртуальных машин VMware и физических серверов под управлением Windows или Linux из Azure на локальном сайте после репликации с локального сайта в Azure с помощью [Azure Site Recovery](site-recovery-overview.md).

В этой статье описывается старая конфигурация, и она не должна использоваться для новых хранилищ.

## <a name="architecture"></a>Архитектура
На этой схеме представлены сценарии отработки отказа и восстановления размещения. Синие линии — это подключения, используемые в процессе отработки отказа. Красные линии — это подключения, используемые в процессе восстановления размещения. Линии со стрелками — это подключения к Интернету.

![](./media/site-recovery-failback-azure-to-vmware/vconports.png)

## <a name="before-you-start"></a>Перед началом работы
* Ваши виртуальные машины VMware или физические серверы вышли из строя, и они запущены в Azure.
* Необходимо отметить, что восстановить размещение виртуальных машин VMware и физических серверов под управлением ОС Windows и Linux и перенести их из Azure в виртуальные машины VMware можно только на локальном основном сайте.  При восстановлении размещения физического компьютера отработка отказа с выполнением переноса в Azure позволит преобразовать его в виртуальную машину Azure, а восстановление размещения в VMware — в виртуальную машину VMware.

Вот как настроить восстановление после сбоя:

1. **Настройка компонентов для восстановления после сбоя**: необходимо установить сервер vContinuum в локальной среде и настроить его для виртуальной машины сервера конфигурации в Azure. Также будет необходимо настроить сервер обработки в виде виртуальной машины Azure. Этот сервер будет отправлять данные обратно на локальный главный целевой сервер. Регистрация сервера обработки выполняется на сервере конфигурации, который выполнил отработку отказа. Вы устанавливаете локальный главный целевой сервер. Если вам необходим главный целевой сервер под управлением Windows, он настраивается автоматически при установке vContinuum. Если вам требуется сервер под управлением Linux, необходимо установить его вручную на отдельном сервере.
2. **Включение защиты и восстановления размещения**: после настройки компонентов необходимо включить защиту для виртуальных машин Azure при сбое в vContinuum. Нужно запустить проверку готовности на виртуальных машинах и запустить отработку отказа из Azure на локальный сайт. После завершения восстановления можно повторно включить защиту локальных компьютеров, чтобы они начали репликацию в Azure.

## <a name="step-1-install-vcontinuum-on-premises"></a>Шаг 1. Локальная установка vContinuum
Необходимо установить сервер vContinuum в локальной среде и настроить его для сервера конфигурации.

1. [Скачайте vContinuum](http://go.microsoft.com/fwlink/?linkid=526305).
2. После этого скачайте [обновление версии vContinuum](http://go.microsoft.com/fwlink/?LinkID=533813) .
3. Установите последнюю версию vContinuum. На **странице приветствия** нажмите кнопку **Далее**.
    ![](./media/site-recovery-failback-azure-to-vmware/image2.png)
4. На первой странице мастера укажите IP-адрес и порт сервера CX. Установите флажок **Использовать HTTPS**.

   ![](./media/site-recovery-failback-azure-to-vmware/image3.png)
5. На вкладке **Панель мониторинга** виртуальной машины сервера конфигурации в Azure найдите IP-адрес сервера конфигурации.
   ![](./media/site-recovery-failback-azure-to-vmware/image4.png)
6. На вкладке **Конечные точки** виртуальной машины сервера конфигурации в Azure найдите общий порт HTTPS сервера конфигурации.

   ![](./media/site-recovery-failback-azure-to-vmware/image5.png)
7. На странице **Сведения о парольной фразе сервера конфигурации** укажите парольную фразу, записанную при регистрации сервера конфигурации. Если вы забыли ее, ее можно найти в папке **C:\\Program Files (x86)\\InMage Systems\\private\\connection.passphrase** на виртуальной машине сервера конфигурации.

    ![](./media/site-recovery-failback-azure-to-vmware/image6.png)
8. На странице **Выбор целевого расположения** укажите место установки сервера vContinuum и нажмите кнопку **Установить**.

   ![](./media/site-recovery-failback-azure-to-vmware/image7.png)
9. После завершения установки можно запустить vContinuum.
    ![](./media/site-recovery-failback-azure-to-vmware/image8.png)

## <a name="step-2-install-a-process-server-in-azure"></a>Шаг 2. Установка сервера обработки в Azure
Чтобы виртуальные машины в Azure могли отправлять данные локальному главному целевому серверу, в Azure необходимо установить сервер обработки.

1. На странице **Серверы конфигурации** в Azure выберите команду добавления нового сервера обработки.

   ![](./media/site-recovery-failback-azure-to-vmware/image9.png)
2. Укажите имя сервера обработки, а также имя и пароль для подключения к виртуальной машине от имени администратора. Выберите сервер конфигурации, на котором необходимо зарегистрировать сервер обработки. Это должен быть тот же сервер, который используется для защиты и отработки отказа на виртуальных машинах.
3. Укажите сеть Azure, в которой должен быть развернут сервер обработки. Это должна быть та же сеть, которая используется для сервера конфигурации. Укажите уникальный IP-адрес из выбранной подсети и начните развертывание.

   ![](./media/site-recovery-failback-azure-to-vmware/image10.png)
4. Будет запущено задание развертывания сервера обработки.

   ![](./media/site-recovery-failback-azure-to-vmware/image11.png)
5. По завершении развертывания сервера обработки в Azure можно войти в его систему, используя указанные учетные данные. Зарегистрируйте сервер обработки так же, как и локальный сервер обработки.

   ![](./media/site-recovery-failback-azure-to-vmware/image12.png)

> [!NOTE]
> Серверы, зарегистрированные в процессе восстановления размещения, не отображаются в разделе свойств виртуальной машины в службе Site Recovery. Они отображаются только на вкладке **Серверы** в разделе сервера конфигурации, на котором они зарегистрированы. Cервер обработки появится на вкладке через 10–15 минут.
>
>

## <a name="step-3-install-a-master-target-server-on-premises"></a>Шаг 3. Локальная установка главного целевого сервера
Вам понадобится установить в локальной системе главный целевой сервер под управлением ОС Linux или Windows. Выбор ОС зависит от того, какие ОС использовались на исходных виртуальных машинах.

### <a name="deploy-a-windows-master-target-server"></a>Развертывание главного целевого сервера под управлением ОС Windows
Главный целевой сервер под управлением Windows уже включен в комплект программы установки vContinuum. При установке vContinuum на том же компьютере будет развернут главный целевой сервер. Кроме того, он будет зарегистрирован на сервере конфигурации.

1. Чтобы начать развертывание, создайте локальную пустую машину на узле ESX, на который необходимо восстановить виртуальные машины из Azure.
2. Убедитесь, что к виртуальной машине подключено не менее двух дисков: один — для операционной системы, а другой — для диска хранения.
3. Установите операционную систему.
4. Установите vContinuum на сервере. Таким образом также завершается установка главного целевого сервера.

### <a name="deploy-a-linux-master-target-server"></a>Развертывание главного целевого сервера под управлением ОС Linux
1. Чтобы начать развертывание, создайте локальную пустую машину на узле ESX, на который необходимо восстановить виртуальные машины из Azure.
2. Убедитесь, что к виртуальной машине подключено не менее двух дисков: один — для операционной системы, а другой — для диска хранения.
3. Установите операционную систему Linux. В системе главного целевого сервера под управлением ОС Linux не следует использовать LVM для корня файловой системы или дисковых пространств для хранения. По умолчанию главный целевой сервер под управлением ОС Linux настроен так, чтобы не обнаруживать разделы и диски LVM.
4. Ниже перечислены разделы, которые можно создать.

   ![](./media/site-recovery-failback-azure-to-vmware/image13.png)
5. После установки операционной системы выполните указанные ниже действия. Их необходимо выполнять до установки главного целевого сервера.

#### <a name="post-os-installation-steps"></a>Действия, которые необходимо выполнить после установки ОС
Чтобы получить идентификаторы SCSI для всех жестких дисков SCSI в виртуальной машине под управлением ОС Linux, необходимо присвоить параметру disk.EnableUUID значение TRUE следующим образом:

1. Завершите работу виртуальной машины.
2. Щелкните правой кнопкой мыши запись виртуальной машины на левой панели и выберите пункт **Изменить параметры**.
3. Откройте вкладку **Параметры** . Выберите **Дополнительно\>Общий элемент** > **Параметры конфигурации**. Кнопка **Параметры конфигурации** доступна только если компьютер выключен.

    ![](./media/site-recovery-failback-azure-to-vmware/image14.png)
4. Нажав эту кнопку, можно проверить, есть ли строка с параметром **disk.EnableUUID** . Если она существует и для параметра задано значение **False**, установите для него значение **True** (без учета регистра). Если строка существует и для параметра задано значение True, нажмите кнопку **Отмена** и после загрузки операционной системы на виртуальной машине проверьте в ней команду SCSI. Если такой строки нет, нажмите кнопку **Добавить строку**.
5. В столбце **Имя** добавьте параметр disk.EnableUUID. Присвойте этому параметру значение TRUE. Не заключайте указанные выше значения в двойные кавычки.

    ![](./media/site-recovery-failback-azure-to-vmware/image15.png)

#### <a name="download-and-install-the-additional-packages"></a>Скачивание и установка дополнительных пакетов
ПРИМЕЧАНИЕ. Прежде чем приступить к скачиванию и установке дополнительных пакетов, убедитесь, что система подключена к Интернету.

\# yum install -y xfsprogs perl lsscsi rsync wget kexec-tools

Эта команда скачивает эти 15 пакетов из репозитория CentOS 6.6 и устанавливает их:

bc-1.06.95-1.el6.x86\_64.rpm

busybox-1.15.1-20.el6.x86\_64.rpm

elfutils-libs-0.158-3.2.el6.x86\_64.rpm

kexec-tools-2.0.0-280.el6.x86\_64.rpm

lsscsi-0.23-2.el6.x86\_64.rpm

lzo-2.03-3.1.el6\_5.1.x86\_64.rpm

perl-5.10.1-136.el6\_6.1.x86\_64.rpm

perl-Module-Pluggable-3.90-136.el6\_6.1.x86\_64.rpm

perl-Pod-Escapes-1.04-136.el6\_6.1.x86\_64.rpm

perl-Pod-Simple-3.13-136.el6\_6.1.x86\_64.rpm

perl-libs-5.10.1-136.el6\_6.1.x86\_64.rpm

perl-version-0.77-136.el6\_6.1.x86\_64.rpm

rsync-3.0.6-12.el6.x86\_64.rpm

snappy-1.1.0-1.el6.x86\_64.rpm

wget-1.12-5.el6\_6.1.x86\_64.rpm

Если в исходном компьютере для корневого устройства или устройства загрузки используется файловая система Reiser или XFS, то до начала действий по защите необходимо скачать указанные ниже пакеты и установить их на главный целевой сервер под управлением Linux.

\# cd /usr/local

\# wget <http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm>

\# wget <http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm>

\# rpm -ivh kmod-reiserfs-0.0-1.el6.elrepo.x86\_64.rpm reiserfs-utils-3.6.21-1.el6.elrepo.x86\_64.rpm

\# wget <http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_64.rpm>

\# rpm -ivh xfsprogs-3.1.1-16.el6.x86\_64.rpm

#### <a name="apply-custom-configuration-changes"></a>Применение изменений настраиваемой конфигурации
Перед применением этих изменений убедитесь, что выполнены действия предыдущего раздела, а затем выполните следующие шаги:

1. Скопируйте двоичный файл унифицированного агента RHEL 6-64 в установленную операционную систему.
2. Выполните следующую команду, чтобы распаковать двоичный файл: **tar -zxvf \<имя_файла\>**
3. Выполните следующую команду, чтобы предоставить разрешения: \# **chmod 755 ./ApplyCustomChanges.sh**
4. Запустите скрипт **\#./ApplyCustomChanges.sh**. Этот сценарий необходимо выполнить на сервере только один раз. После выполнения сценария перезагрузите сервер.

### <a name="install-the-linux-server"></a>Установка сервера под управлением ОС Linux
1. [Скачайте](http://go.microsoft.com/fwlink/?LinkID=529757) файл установки.
2. С помощью любой служебной программы SFTP-клиента скопируйте файл на виртуальную машину главного целевого сервера под управлением ОС Linux. Помимо этого, можно войти в виртуальную машину главного целевого сервера под управлением ОС Linux и с помощью команды wget скачать пакет установки по указанной ссылке.
3. С помощью любой служебной программы SSH-клиента войдите в виртуальную машину главного целевого сервера под управлением ОС Linux.
4. Если вы подключены к сети Azure, в которой развернут главный целевой сервер под управлением ОС Linux, через VPN-подключение, то для подключения к этому серверу по протоколу SSH используйте внутренний IP-адрес сервера, отображаемый на вкладке **Панель мониторинга** виртуальной машины, и порт 22.
5. Если вы подключаетесь к главному целевому серверу под управлением ОС Linux через общедоступное подключение к Интернету, используйте общедоступный виртуальный IP-адрес этого сервера (отображаемый на вкладке **Панель мониторинга** виртуальных машин) и общедоступную конечную точку, созданную для входа на сервер под управлением ОС Linux с использованием протокола SSH.
6. Извлеките файлы из сжатого программой GZIP установщика главного целевого сервера под управлением Linux из TAR-архива. Для этого выполните команду *tar –xvzf Microsoft-ASR\_UA\_8.2.0.0\_RHEL6-64\* в каталоге, который содержит файл установщика.

    ![](./media/site-recovery-failback-azure-to-vmware/image16.png)
7. Если вы извлекли файлы установщика в другой каталог, то перейдите в него. В этом каталоге выполните команду sudo ./install.sh.

    ![](./media/site-recovery-failback-azure-to-vmware/image17.png)
8. Когда будет предложено выбрать основную роль, выберите вариант **2 (главный целевой сервер)**. Для всех остальных параметров интерактивной установки оставьте значения по умолчанию.
9. Дождитесь продолжения процесса установки и отображения интерфейса настройки узла. Для настройки главного целевого сервера под управлением ОС Linux используется служебная программа настройки узла, работающая в командной строке. Не изменяйте размер окна служебной программы SSH-клиента. С помощью клавиш со стрелками выберите параметр **Глобальные** и нажмите клавишу ВВОД на клавиатуре.

    ![](./media/site-recovery-failback-azure-to-vmware/image18.png)

    ![](./media/site-recovery-failback-azure-to-vmware/image19.png)
10. В поле **IP-адрес** введите внутренний IP-адрес сервера конфигурации (он отображается на вкладке **Панель мониторинга** виртуальной машины сервера конфигурации) и нажмите клавишу ВВОД. В поле **Порт** введите значение **22** и нажмите клавишу ВВОД.
11. Для параметра **Использовать HTTPS** оставьте значение **Да** и нажмите клавишу ВВОД.
12. Введите парольную фразу, созданную на сервере конфигурации. Если на компьютере под управлением ОС Windows для подключения к виртуальной машине под управлением ОС Linux с помощью протокола SSH используется клиент PUTTY, то для вставки содержимого буфера обмена можно использовать клавиши SHIFT+INSERT. Нажмите клавиши CTRL+C, чтобы скопировать парольную фразу в локальный буфер обмена, а затем вставьте ее с помощью клавиш SHIFT+INSERT. Нажмите клавишу ВВОД.
13. С помощью клавиш со стрелками выберите пункт «Выход» и нажмите клавишу ВВОД. Дождитесь завершения процесса установки.

    ![](./media/site-recovery-failback-azure-to-vmware/image20.png)

Если по какой-либо причине не удалось зарегистрировать главный целевой сервер под управлением ОС Linux на сервере конфигурации, можно повторить попытку, запустив служебную программу настройки узла в каталоге /usr/local/ASR/Vx/bin/hostconfigcli (перед этим потребуется настроить разрешения на доступ к этому каталогу, выполнив команду chmod от имени суперпользователя).

#### <a name="validate-master-target-registration"></a>Проверка регистрации главного целевого сервера
Чтобы проверить, успешно ли зарегистрирован главный целевой сервер на сервере конфигурации, перейдите на страницу **Сервер конфигурации** > **Сведения о серверах** в хранилище Azure Site Recovery.

> [!NOTE]
> После регистрации главного целевого сервера могут появляться ошибки конфигурации о возможном удалении виртуальной машины из Azure или неправильной настройке конечных точек. Хотя конечные точки Azure обнаруживают конфигурацию главного целевого сервера при его развертывании в Azure, этого не происходит при локальном развертывании главного целевого сервера. Эти ошибки не влияют на восстановление размещения и их можно игнорировать.
>
>

## <a name="step-4-protect-the-virtual-machines-to-the-on-premises-site"></a>Шаг 4. Защита виртуальных машин на локальном сайте
Прежде чем приступить к восстановлению размещения, необходимо защитить виртуальные машины на локальном сайте.

### <a name="before-you-begin"></a>Перед началом работы
При отработке отказа виртуальной машины с выполнением переноса в Azure добавляется дополнительный временный диск для файла подкачки. Этот диск обычно не требуется для виртуальной машины, для которой выполняется отработка отказа, так как в ней уже может быть диск, предназначенный для файла подкачки. Перед началом процесса обратной защиты виртуальных машин убедитесь, что этот диск переведен в автономный режим и не будет защищен. Это можно сделать указанным ниже образом.

1. Откройте раздел управления компьютером и выберите пункт «Управление службой хранилища», чтобы отобразить работающие и подключенные к машине диски.
2. Выберите временный диск, подключенный к машине, и выберите команду перевода его в автономный режим.

### <a name="protect-the-vms"></a>Защита виртуальных машин
1. На портале Azure просмотрите состояния виртуальных машин и убедитесь, что для них выполнена отработка отказа.

    ![](./media/site-recovery-failback-azure-to-vmware/image21.png)
2. Запустите vContinuum на компьютере.

    ![](./media/site-recovery-failback-azure-to-vmware/image8.png)
3. Установите переключатель **New Protection** (Создать защиту) и выберите тип операционной системы.
4. В открывшемся окне выберите элементы **OS type (Тип ОС)** > **Get Details (Получить сведения)** для виртуальных машин, для которых нужно выполнить восстановление размещения. В разделе **Primary server details**(Сведения об основном сервере) определите и выберите виртуальные машины, которые необходимо защитить. В списке имен узлов vCenter отображаются виртуальные машины, которые были там до отработки отказа.
5. При выборе виртуальной машины, которую необходимо защитить (и для которой выполнена отработка отказа с переносом в Azure), отобразится всплывающее окно с двумя записями для этой виртуальной машины. Это происходит из-за того, что сервер конфигурации обнаруживает два экземпляра зарегистрированных на нем виртуальных машин. Необходимо удалить запись локальной виртуальной машины, чтобы защитить правильную виртуальную машину. Чтобы определить правильную запись виртуальной машины Azure, войдите в виртуальную машину Azure и перейдите в папку C:\Program Files (x86)\Microsoft Azure Site Recovery\Application Data\etc. В файле drscout.conf найдите идентификатор узла. В диалоговом окне vContinuum сохраните запись, для которой в виртуальной машине найден идентификатор узла. Удалите все другие записи. Чтобы выбрать нужную виртуальную машину, можно указать ее IP-адрес. Диапазон IP-адресов локальной сети будет диапазоном локальной виртуальной машины.

   ![](./media/site-recovery-failback-azure-to-vmware/image22.png)

   ![](./media/site-recovery-failback-azure-to-vmware/image23.png)
6. Остановите работу виртуальной машины на сервере vCenter. Можно также удалить виртуальные машины локально.
7. Далее укажите локальный главный целевой сервер, на который необходимо перенести виртуальные машины для их защиты. Для этого подключитесь к серверу vCenter, на который необходимо выполнить восстановление размещения.

    ![](./media/site-recovery-failback-azure-to-vmware/image24.png)
8. Выберите главный целевой сервер на основе узла, на который необходимо восстановить виртуальную машину.

    ![](./media/site-recovery-failback-azure-to-vmware/image24.png)
9. Укажите параметры репликации для каждой виртуальной машины. Для этого необходимо выбрать хранилище данных на стороне восстановления, в которое будут восстановлены виртуальные машины. В таблице перечислены различные параметры, которые необходимо указать для каждой виртуальной машины.

    ![](./media/site-recovery-failback-azure-to-vmware/image25.png)

   | **Параметр** | **Рекомендуемое значение параметра** |
   | --- | --- |
   |  IP-адрес сервера обработки |Выберите сервер обработки, развернутый в Azure. |
   |  Размер хранения в мегабайтах | |
   |  Значение хранения |1 |
   |  Дни или часы |Дни |
   |  Интервал согласованности |1 |
   |  Выберите целевое хранилище данных |Хранилище данных, доступное на стороне восстановления. В хранилище должно быть достаточно места. Оно должно быть доступно для узла ESX, на котором необходимо восстановить виртуальную машину. |
10. Настройте свойства, которые получит виртуальная машина после отработки отказа с выполнением переноса на локальный сайт. Ниже представлена таблица, в которой указаны эти свойства.

    ![](./media/site-recovery-failback-azure-to-vmware/image26.png)

    | **Свойство** | **Дополнительные сведения** |
    | --- | --- |
    | Конфигурация сети |Выберите каждый обнаруженный сетевой адаптер и щелкните **Change** (Изменить), чтобы настроить IP-адрес для восстановления размещения для виртуальной машины. |
    | Конфигурация оборудования |Укажите ЦП и память для виртуальной машины. Параметры можно применить ко всем виртуальным машинам, которые необходимо защитить. Чтобы определить правильные значения для ЦП и памяти, можно отобразить размеры ролей виртуальных машин IaaS и посмотреть количество назначенных ядер и объем назначенной памяти. |
    | Отображаемое имя |После восстановления размещения в локальную среду можно переименовать виртуальные машины, которые появятся в списке vCenter. По умолчанию здесь отображается имя узла компьютера виртуальной машины. Чтобы определить имя виртуальной машины, посмотрите список виртуальных машин в группе "Protection" (Защита). |
    | Конфигурация преобразования сетевых адресов (NAT) |Порядок настройки подробно рассмотрен ниже |

    ![](./media/site-recovery-failback-azure-to-vmware/image27.png)

#### <a name="configure-nat-settings"></a>Настройка параметров преобразования сетевых адресов (NAT)
1. Чтобы включить защиту виртуальных машин, необходимо создать два канала связи. Первый канал соединяет виртуальную машину и сервер обработки. Он служит для сбора данных с виртуальной машины и их отправки на сервер обработки, который затем отправляет их на главный целевой сервер. Если сервер обработки и виртуальная машина, которую необходимо защитить, находятся в одной и той же виртуальной сети Azure, то не нужно использовать параметры преобразования сетевых адресов (NAT). В противном случае укажите их. Просмотрите общедоступный IP-адрес сервера обработки в Azure.

    ![](./media/site-recovery-failback-azure-to-vmware/image28.png)
2. Второй канал соединяет сервер обработки и главный целевой сервер. Необходимость преобразования сетевых адресов (NAT) зависит от того, используете ли вы подключение на основе VPN или передаете данные через Интернет. Не выбирайте преобразования сетевых адресов (NAT), если вы используете VPN-подключение, а только если используется подключение к Интернету.

    ![](./media/site-recovery-failback-azure-to-vmware/image29.png)

    ![](./media/site-recovery-failback-azure-to-vmware/image30.png)
3. Если локальные виртуальные машины не удалены как указано, а также если в хранилище данных, используемом для восстановления размещения, по-прежнему находятся старые VMDK, то необходимо убедиться, что при восстановлении размещения виртуальные машины создаются в новом месте. Для этого откройте **дополнительные параметры** и в разделе **Параметры имени папки** укажите другую папку для восстановления. Для других параметров оставьте значения по умолчанию. Примените параметры имени папки ко всем серверам.

    ![](./media/site-recovery-failback-azure-to-vmware/image31.png)
4. Выполните проверку готовности, чтобы убедиться, что виртуальные машины подготовлены к процедурам защиты при переносе обратно в локальную среду.

    ![](./media/site-recovery-failback-azure-to-vmware/image32.png)
5. Дождитесь завершения проверки. Если она прошла успешно на всех виртуальных машинах, можно указать имя плана защиты. Щелкните **Protect** (Защита), чтобы начать.

    ![](./media/site-recovery-failback-azure-to-vmware/image33.png)
6. Ход выполнения можно отслеживать в vContinuum.

    ![](./media/site-recovery-failback-azure-to-vmware/image34.png)
7. После завершения этапа **активации плана защиты** можно отслеживать состояние защиты виртуальной машины на портале службы Site Recovery.

    ![](./media/site-recovery-failback-azure-to-vmware/image35.png)
8. Если щелкнуть имя виртуальной машины, вы сможете увидеть точное состояние и наблюдать за ходом ее выполнения.

    ![](./media/site-recovery-failback-azure-to-vmware/image36.png)

## <a name="prepare-the-failback-plan"></a>Подготовка плана восстановления размещения
С помощью vContinuum можно подготовить план восстановления размещения. Это позволит в любое время перенести приложение обратно в локальную среду в случае восстановления размещения. Эти планы восстановления очень похожи на планы восстановления службы Site Recovery.

1. Запустите vContinuum и установите переключатели **Управление планами** > **Восстановление**. Появится список всех планов, использованных для отработки отказа на виртуальных машинах. Эти же планы можно использовать для восстановления.

   ![](./media/site-recovery-failback-azure-to-vmware/image37.png)
2. Выберите необходимый план защиты и все виртуальные машины, которые требуется восстановить в рамках этого плана. При выборе каждой виртуальной машины можно увидеть дополнительные сведения, включая целевой сервер ESX и исходный диск виртуальной машины. Нажмите кнопку **Next** (Далее), чтобы запустить мастер восстановления и выберите виртуальные машины, которые необходимо восстановить.

    ![](./media/site-recovery-failback-azure-to-vmware/image38.png)
3. Виртуальные машины можно восстановить, используя несколько параметров, но мы советуем установить переключатель **Последний тег**. Кроме того, установите флажок **Применить ко всем виртуальным машинам**, чтобы использовались последние данные из виртуальной машины.
4. Запустите проверку готовности (кнопка **Run Readiness Check**). Проверка покажет, правильно ли настроены параметры для восстановления виртуальной машины. Если все проверки выполнены успешно, нажмите кнопку **Далее**. В противном случае просмотрите журнал и устраните причины ошибок.

    ![](./media/site-recovery-failback-azure-to-vmware/image39.png)
5. На этапе **настройки виртуальной машины** проверьте, правильно ли заданы параметры восстановления. При необходимости можно изменить параметры виртуальной машины.

   ![](./media/site-recovery-failback-azure-to-vmware/image40.png)
6. Просмотрите список виртуальных машин, которые будут восстановлены, и укажите последовательность их восстановления. Обратите внимание, что виртуальные машины отображаются в списке имен узлов компьютеров. Может быть сложно сопоставить имена узлов компьютеров с виртуальными машинами.
   Для этого перейдите на **панель мониторинга** виртуальных машин в Azure и проверьте имя узла виртуальной машины.

    ![](./media/site-recovery-failback-azure-to-vmware/image41.png)
7. Укажите имя плана и установите переключатель **Recover later**(Восстановить позже). Мы советуем выполнить восстановление позже, так как начальная защита может быть не выполнена.
8. Нажмите кнопку **Recover** (Восстановить), чтобы сохранить план, или запустите процесс восстановления, если выбрано восстановление сейчас, а не позже. Можно просмотреть состояние восстановления, чтобы проверить, сохранился ли план.

   ![](./media/site-recovery-failback-azure-to-vmware/image42.png)

   ![](./media/site-recovery-failback-azure-to-vmware/image43.png)

## <a name="recover-virtual-machines"></a>Восстановление виртуальных машин
После создания плана можно восстановить виртуальные машины. Но перед этим следует обязательно убедиться, что для виртуальных машин выполнена синхронизация. Если для состояния репликации отображается значение «ОК», это означает, что защита выполнена и достигнут порог целевой точки восстановления. Работоспособность можно проверить в свойствах виртуальной машины.

![](./media/site-recovery-failback-azure-to-vmware/image44.png)

Прежде чем запустить процесс восстановления, выключите виртуальные машины Azure. Благодаря этому не произойдет разделения вычислительных мощностей и пользователи получат доступ только к одной копии приложения.

1. Запустите сохраненный план. На сервере vContinuum выберите команду **Monitor** (Отслеживание) для планов. Появится список всех запущенных планов.

   ![](./media/site-recovery-failback-azure-to-vmware/image45.png)
2. Выберите план в узле **Восстановление** и нажмите кнопку **Запустить**. Можно отслеживать ход выполнения восстановления. После включения к виртуальным машинам можно подключиться в vCenter.

   ![](./media/site-recovery-failback-azure-to-vmware/image46.png)

## <a name="protect-to-azure-again-after-failback"></a>Повторное обеспечение защиты в Azure после восстановления размещения
После завершения восстановления размещения можно обеспечить защиту виртуальных машин еще раз. Это можно сделать указанным ниже образом.

1. Убедитесь, что локальные виртуальные машины работают и к приложениям можно получить доступ.
2. На портале Azure Site Recovery выберите виртуальные машины и удалите их. Выключите защиту виртуальных машин. После этого виртуальные машины больше не будут защищены.
3. В Azure удалите виртуальные машины Azure, для которых выполнена отработка отказа.
4. Удалите старые виртуальные машины в vSphere. Это виртуальные машины, для которых ранее выполнена отработка отказа с переносом в Azure.
5. На портале Site Recovery включите параметр защиты виртуальных машин, для которых недавно выполнена отработка отказа. После этого их можно добавить в план восстановления.

## <a name="next-steps"></a>Дальнейшие действия
* [Прочтите статью](site-recovery-vmware-to-azure-classic.md) о репликации виртуальных машин VMware и физических серверов в Azure с помощью расширенного развертывания.

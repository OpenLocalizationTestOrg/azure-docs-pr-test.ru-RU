---
title: "aaaReplicate Hyper-V виртуальных машин в VMM облаков tooAzure | Документы Microsoft"
description: "В этой статье описывается, как tooreplicate виртуальных машин Hyper-V на узлах Hyper-V, расположенных в облаках tooAzure System Center VMM."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: 9d526a1f-0d8e-46ec-83eb-7ea762271db5
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: hero-article
ms.date: 06/23/2017
ms.author: raynew
ms.openlocfilehash: 136f68585534c17b615ecc4e82c0133bf813503f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="replicate-hyper-v-virtual-machines-in-vmm-clouds-tooazure"></a>Реплицировать виртуальные машины Hyper-V в tooAzure облаков VMM
> [!div class="op_single_selector"]
> * [Портал Azure](site-recovery-vmm-to-azure.md)
> * [PowerShell — Resource Manager](site-recovery-vmm-to-azure-powershell-resource-manager.md)
> * [Классический портал.](site-recovery-vmm-to-azure-classic.md)
> * [PowerShell — классическая модель](site-recovery-deploy-with-powershell.md)
>
>

вносит свой вклад Hello службы Azure Site Recovery, tooyour бесперебойной работе и стратегии аварийного восстановления (BCDR), управляя операциями репликации, отработки отказа и восстановления виртуальных машин и физических серверов. Машины могут быть реплицированной tooAzure или tooa получателя на локальном центре обработки данных. Краткий обзор см. в статье [Что такое Azure Site Recovery?](site-recovery-overview.md)

## <a name="overview"></a>Обзор
В этой статье описывается, как toodeploy Site Recovery tooreplicate Hyper-V виртуальные машины в Hyper-V узла серверов, расположенных в tooAzure частных облаков VMM.

статья Hello включает предварительные условия для сценария hello и показывает hello установлена на исходном сервере VMM hello, поставщик Azure Site Recovery, как получить tooset копирование в хранилище Site Recovery, регистрации сервера hello в хранилище hello, добавьте учетную запись хранилища Azure, установите hello Агент служб восстановления Azure на серверах узлов Hyper-V, настройте параметры защиты для облаков VMM, будет применен tooall защищенные виртуальные машины, а затем включите защиту для этих виртуальных машин. После этого тестирования toomake отработки отказа hello, убедиться, что все работает должным образом.

Отправьте все комментарии или вопросы hello нижней части этой статьи, или на hello [форум по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## <a name="architecture"></a>Архитектура
![Архитектура](./media/site-recovery-vmm-to-azure-classic/topology.png)

* Hello поставщика Azure Site Recovery установлен на hello VMM во время развертывания службы восстановления сайтов и hello сервер VMM зарегистрирован в хранилище Site Recovery hello. Hello Поставщик обменивается данными с orchestration репликации toohandle Site Recovery.
* агент служб восстановления Azure Hello устанавливается на серверах узлов Hyper-V во время развертывания службы восстановления сайтов. Он обрабатывает tooAzure хранилища данных репликации.

## <a name="azure-prerequisites"></a>Предварительные требования Azure
Вам потребуется следующее (среда Azure).

| **Предварительные требования** | **Дополнительные сведения** |
| --- | --- |
| **Учетная запись Azure** |Вам потребуется учетная запись [Microsoft Azure](https://azure.microsoft.com/) . Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/). [дополнительными сведениями](https://azure.microsoft.com/pricing/details/site-recovery/) о ценах на использование Site Recovery. |
| **Служба хранилища Azure** |Вам потребуется данные реплицируются toostore учетной записи хранилища Azure. Реплицированные данные хранятся в службе хранилища Azure, а виртуальные машины Azure развертываются при отработке отказа. <br/><br/>Необходима [учетная запись хранения для геоизбыточного хранилища уровня "Стандартный"](../storage/common/storage-redundancy.md#geo-redundant-storage). Hello учетная запись должна быть в hello же регионе, что служба восстановления сайтов hello и связанные с hello одной подписке. Обратите внимание, что учетные записи хранения toopremium репликации в настоящее время не поддерживается и не должны использоваться.<br/><br/>[Прочтите статью](../storage/common/storage-introduction.md) о службе хранилища Azure. |
| **Сеть Azure** |Вам потребуется виртуальной сети Azure, которому будут подключаться виртуальные машины Azure toowhen переход на другой ресурс. Hello Azure виртуальная сеть должна быть в hello же регионе, что хранилище Site Recovery hello. |

## <a name="on-premises-prerequisites"></a>Предварительные требования для локальной среды
Вам потребуется следующее (локальная среда).

| **Предварительные требования** | **Дополнительные сведения** |
| --- | --- |
| **VMM** |Вам понадобится по крайней мере один сервер VMM, развернутый как отдельный физический или виртуальный сервер либо как виртуальный кластер. <br/><br/>System Center 2012 R2 должна быть запущена с hello последними накопительными пакетами обновления сервера VMM Hello.<br/><br/>Необходимо по крайней мере одно облако, на сервере VMM hello.<br/><br/>Hello исходное облако, которое следует tooprotect должно содержать один или несколько групп узлов VMM.<br/><br/>Дополнительные сведения о настройке облаков VMM см. в записи блога Кита Майера (Keith Mayer) [Walkthrough: Creating private clouds with System Center 2012 SP1 VMM](http://blogs.technet.com/b/keithmayer/archive/2013/04/18/walkthrough-creating-private-clouds-with-system-center-2012-sp1-virtual-machine-manager-build-your-private-cloud-in-a-month.aspx) (Пошаговое руководство. Создание частных облаков с помощью VMM в System Center 2012 с пакетом обновления 1). |
| **Hyper-V** |Вам потребуется один или несколько серверов узлов Hyper-V или кластеров в облаке VMM hello. сервер узла Hello должен иметь и один или несколько виртуальных машин. <br/><br/>Hello Hyper-V server на должна быть запущена хотя бы **Windows Server 2012 R2** с ролью Hyper-V hello или **Microsoft Hyper-V Server 2012 R2** и иметь hello установлены последние обновления.<br/><br/>Любой сервер Hyper-V, содержащий виртуальные машины, необходимо вернуть tooprotect должен быть расположен в облаке VMM.<br/><br/>Если Hyper-V выполняется в кластере, учтите, что брокер кластера не создается автоматически при использовании кластера на основе статических IP-адресов. Брокер кластера hello tooconfigure вам потребуется вручную. См. [дополнительные сведения](https://www.petri.com/use-hyper-v-replica-broker-prepare-host-clusters) в записи блога Эйдана Финна (Aidan Finn). |
| **Защищенные компьютеры** | Виртуальные машины, нужно tooprotect должны соответствовать [требования Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements). |

## <a name="network-mapping-prerequisites"></a>Предварительные требования сетевого сопоставления
При защите виртуальных машин в Azure сетевое сопоставление сопоставление между сетями VM на исходном сервере VMM hello и целевой сетях Azure tooenable hello следующее:

* Все машины, отработка отказа на hello же может подключиться tooeach других, независимо от используемого плана восстановления, находящиеся в сеть.
* Если настроить сетевой шлюз hello целевой сети Azure виртуальные машины могут подключаться tooother локальных виртуальных машин.
* Если не настроить сети сопоставление только виртуальные машины, которые выполняют отработку отказа в hello же плана восстановления будут другие возможности tooconnect tooeach после tooAzure перехода на другой ресурс.

Если требуется, чтобы toodeploy сетевого сопоставления необходимо иметь hello следующее:

* виртуальные машины Hello требуется tooprotect на исходном сервере VMM hello должно быть tooa подключенной сети виртуальной Машины. Сеть должна быть связанной tooa логической сети, связанной с облаком hello.
* Сеть Azure toowhich реплицировать виртуальные машины могут подключаться после отработки отказа. Будет предложено выбрать этой сети во время hello перехода на другой ресурс. сеть Hello должны находиться в hello же регионе, что подписки Azure Site Recovery.


Подготовьте сети в VMM:

   * [Настройте логические сети](https://technet.microsoft.com/library/jj721568.aspx).
   * [Настройте сети виртуальных машин](https://technet.microsoft.com/library/jj721575.aspx).


## <a name="step-1-create-a-site-recovery-vault"></a>Шаг 1. Создание хранилища Site Recovery
1. Войдите в toohello [портала управления](https://portal.azure.com) с сервера VMM hello требуется tooregister.
2. Щелкните **Службы данных** > **Службы восстановления** > **Хранилище Site Recovery**.
3. Щелкните **Создать** > **Быстрое создание**.
4. В **имя**, введите понятное имя tooidentify hello хранилище.
5. В **область**, выберите hello географического региона для hello хранилища. toocheck поддерживаемых регионов см географическая доступность в [сведения о ценах Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).
6. Щелкните элемент **Создать хранилище**.

    ![Новое хранилище](./media/site-recovery-vmm-to-azure-classic/create-vault.png)

Проверка состояния hello панели tooconfirm, hello хранилища успешно создан. Hello хранилище будет указано как **Active** на главной странице служб восстановления hello.

## <a name="step-2-generate-a-vault-registration-key"></a>Шаг 2. Создание ключа регистрации хранилища
Создайте ключ регистрации в хранилище hello. После загрузки hello поставщика Azure Site Recovery и установите его на сервере VMM hello, используемой этим сервером VMM hello tooregister ключа в хранилище hello.

1. В hello **службы восстановления** щелкните страницу быстрого запуска hello хранилище tooopen hello. Краткое руководство также можно открыть в любое время с помощью значка hello.

    ![Значок быстрого запуска](./media/site-recovery-vmm-to-azure-classic/qs-icon.png)
2. В раскрывающемся списке «hello» выберите **между локальным сайтом VMM и Microsoft Azure**.
3. В разделе **Подготовка серверов VMM** выберите пункт **Generate registration key** (Создать регистрационный ключ). Hello файл ключа создается автоматически и действителен в течение 5 дней после его создания. Если вы не используете hello портал Azure с сервера VMM hello потребуется toocopy toohello этого файлового сервера.

    ![Регистрационный ключ](./media/site-recovery-vmm-to-azure-classic/register-key.png)

## <a name="step-3-install-hello-azure-site-recovery-provider"></a>Шаг 3: Установка поставщика Azure Site Recovery hello
1. В **быстрый запуск** > **серверов VMM, подготовьте**, нажмите кнопку **загрузка поставщика Azure Site Recovery для установки на серверах VMM** tooobtain hello последнюю версию файла установки поставщика hello.
2. Запустите этот файл на исходном сервере VMM hello.

   > [!NOTE]
   > Если VMM развертывается в кластере и установке hello поставщика для hello первый раз установить его на активном узле и Готово сервера hello установки tooregister hello VMM в хранилище hello. Затем установите hello поставщика на hello другие узлы. Обратите внимание, что при обновлении hello поставщика, потребуется tooupgrade на всех узлах, так как они должны быть запущена hello одна версия поставщика.
   >
   >
3. Hello установщика выполняет проверку предварительных требований и запрашивает разрешение toostop hello VMM toobegin Установка service Provider. Hello службы VMM будет автоматически перезапущена после завершения программы установки. При установке на кластере VMM будет приглашение toostop hello кластерной роли.
4. В **Центре обновления Майкрософт** вы можете настроить обновления. Этот параметр включен поставщик обновления будут установлены в соответствии с политикой центра обновления Майкрософт tooyour.

    ![Центр обновления Майкрософт](./media/site-recovery-vmm-to-azure-classic/updates.png)
5. Здравствуйте, место установки для поставщика установлено слишком hello**<SystemDrive>\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin**. Щелкните **Install**(Установить).

   ![InstallLocation](./media/site-recovery-vmm-to-azure-classic/install-location.png)
6. После установки поставщика hello щелкните **зарегистрировать** tooregister hello сервера в хранилище hello.

    ![InstallComplete](./media/site-recovery-vmm-to-azure-classic/install-complete.png)
7. В **имя хранилища**, проверьте имя hello hello хранилища, в которых hello будет зарегистрирован сервер. Щелкните *Далее*.

    ![Регистрация сервера](./media/site-recovery-vmm-to-azure-classic/vaultcred.PNG)
8. В **подключение к Интернету** укажите как hello поставщик, запущенный на hello VMM сервер подключается toohello Интернета. Выберите **подключение с использованием существующих настроек прокси-сервера** toouse hello по умолчанию параметры подключения к Интернету на сервере hello.

    ![Параметры Интернета](./media/site-recovery-vmm-to-azure-classic/proxydetails.PNG)

   * Если требуется, чтобы toouse настраиваемого прокси-сервера вы должны настроить его перед установкой hello поставщика. При настройке параметров настраиваемого прокси-сервера тест будет выполняться toocheck hello прокси-подключения.
   * Если вы используете пользовательский прокси-сервер или прокси-сервера по умолчанию требует проверки подлинности необходимо tooenter hello сведения о прокси, включая hello адрес прокси-сервера и порт.
   * Следующие URL-адреса должны быть доступны через hello сервера VMM и узлы Hyper-v hello
     * *.hypervrecoverymanager.windowsazure.com
     * *.accesscontrol.windows.net
     * *.backup.windowsazure.com
     * *.blob.core.windows.net
     * *.store.core.windows.net
   * Разрешить IP-адреса hello в [диапазоны IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и протокол HTTPS (443). Будет иметь список toowhite диапазоном IP-адресов hello регион Azure, планировании toouse и, Запад США.
   * Если использовать настраиваемый прокси учетная запись VMM RunAs (DRAProxyAccount) будет создана автоматически с помощью указанного hello учетные данные прокси-сервера. Настройте hello прокси-сервера таким образом, чтобы эта учетная запись успешно проходят проверку подлинности. можно изменить параметры учетной записи запуска от имени VMM Hello в консоли VMM hello. toodo это, откройте hello **параметры** рабочей области, разверните **безопасности**, нажмите кнопку **учетные записи запуска от**, а затем измените hello пароль для DRAProxyAccount. Служба VMM hello toorestart потребуется, чтобы этот параметр вступает в силу.
9. В **регистрационный ключ**выберите ключ hello, загружаются из Azure Site Recovery и копируются toohello сервера VMM.
10. параметр шифрования Hello используется только при репликации виртуальных машин Hyper-V в облаках tooAzure VMM. Если выполняется репликация tooa вторичного сайта она не используется.
11. В **имя сервера**, укажите сервер VMM hello tooidentify понятное имя в хранилище hello. В конфигурации кластера укажите имя роли кластера VMM hello.
12. В **синхронизация метаданных облака** выбрать toosynchronize метаданные для всех облаков на сервере VMM hello hello хранилище. Это действие нужно только toohappen один раз на каждом сервере. Если вы не хотите toosynchronize все облака, можно не устанавливать флажок и синхронизировать каждое облако отдельно в свойствах облака hello в консоли VMM hello.
13. Нажмите кнопку **Далее** toocomplete hello процесса. После регистрации службой Azure Site Recovery извлекает метаданные с сервера VMM hello. сервер Hello отображается на hello **серверов VMM** вкладку на hello **серверы** страницы в хранилище hello.

    ![Последняя страница](./media/site-recovery-vmm-to-azure-classic/provider13.PNG)

После регистрации службой Azure Site Recovery извлекает метаданные с сервера VMM hello. сервер Hello отображается на hello **серверов VMM** на hello вкладке **серверы** страницы в хранилище hello.

### <a name="command-line-installation"></a>Установка из командной строки
также можно установить Hello поставщика Azure Site Recovery с помощью следующей командной строкой hello. Этот метод можно использовать tooinstall hello поставщика на Server Core для Windows Server 2012 R2.

1. Загрузите hello поставщика файла и регистрация ключа tooa папку установки. Например, C:\ASR.
2. Остановить службу System Center Virtual Machine Manager hello
3. Из командной строки с повышенными привилегиями Извлеките установщик поставщика hello с помощью следующих команд:

        C:\Windows\System32> CD C:\ASR
        C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q
4. Установите поставщик hello следующим образом:

        C:\ASR> setupdr.exe /i
5. Зарегистрируйте поставщик hello следующим образом:

        CD C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin
        C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin\> DRConfigurator.exe /r  /Friendlyname <friendly name of hello server> /Credentials <path of hello credentials file> /EncryptionEnabled <full file name toosave hello encryption certificate>       

Используйте следующие параметры.

* **Или учетные данные** : обязательный параметр, указывающий расположение hello, в которой hello находится файл ключа регистрации  
* **/ FriendlyName** : hello имя сервера узла hello Hyper-V, который отображается на портале Azure Site Recovery hello обязательный параметр.
* **/ EncryptionEnabled** : toospecify необязательный параметр, если требуется tooencryption виртуальных машин в Azure (на шифрование rest). Имя файла Hello должно иметь **.pfx** расширения.
* **/ ProxyAddress** : необязательный параметр, задающий адрес hello hello прокси-сервера.
* **/ proxyport** : необязательный параметр, задающий порт hello hello прокси-сервера.
* **/ proxyusername** : необязательный параметр, который указывает имя пользователя прокси-сервера hello.
* **/ proxypassword** : необязательный параметр, задающий hello пароль прокси-сервера.  

## <a name="step-4-create-an-azure-storage-account"></a>Шаг 4. Создание учетной записи хранения Azure
1. Если у вас нет учетной записи хранилища Azure щелкните **добавьте учетную запись хранилища Azure** toocreate учетную запись.
2. Создайте учетную запись со включенной георепликацией. Оно должно в hello же регионе, что hello службы Azure Site Recovery и быть связан с hello одной подписке.

    ![Учетная запись хранения](./media/site-recovery-vmm-to-azure-classic/storage.png)

> [!NOTE]
> [Миграция учетных записей хранения](../azure-resource-manager/resource-group-move-resources.md) через ресурсов группы внутри hello одной подписке или между подписками не поддерживается для учетных записей хранилища для развертывания Site Recovery.
>
>

## <a name="step-5-install-hello-azure-recovery-services-agent"></a>Шаг 5: Установка hello агента служб восстановления Azure
Установка агента служб восстановления Azure hello на каждом сервере узла Hyper-V в облаке VMM hello.

1. Нажмите кнопку **быстрый запуск** > **скачать агент служб восстановления Azure сайта и установить его на узлах** tooobtain hello последнюю версию файла установки агента hello.

    ![Установка агента служб восстановления Azure](./media/site-recovery-vmm-to-azure-classic/install-agent.png)
2. Запустите файл установки hello на каждом сервере узла Hyper-V.
3. На hello **проверка предварительных требований** щелкните **Далее**. Все отсутствующие предварительные требования будут установлены автоматически.

    ![Предварительные требования для агента служб восстановления](./media/site-recovery-vmm-to-azure-classic/agent-prereqs.png)
4. На hello **параметры установки** укажите место tooinstall hello агента и выберите hello расположение кэша, в котором будут установлены метаданные резервного копирования. Нажмите **Install**(Установить).
5. После завершения установки нажмите кнопку **закрыть** toocomplete приветствия мастера.

    ![Регистрация агента служб восстановления Microsoft Azure](./media/site-recovery-vmm-to-azure-classic/agent-register.png)

### <a name="command-line-installation"></a>Установка из командной строки
Hello агента служб восстановления Microsoft Azure также можно установить из командной строки hello, с помощью этой команды:

    marsagentinstaller.exe /q /nu

## <a name="step-6-configure-cloud-protection-settings"></a>Шаг 6. Настройка параметров защиты облачных систем
После регистрации сервера VMM hello, можно настроить параметры защиты облака. Вы включили параметр hello **синхронизировать облачные данные с хранилищем hello** при установке поставщика hello того, чтобы отображались все облака на сервере VMM hello hello <b>защищенные элементы</b> вкладку в хранилище hello.

![Опубликованное облако](./media/site-recovery-vmm-to-azure-classic/clouds-list.png)

1. На странице быстрого запуска приветствия щелкните **Настройка защиты для облаков VMM**.
2. На hello **защищенные элементы** щелкните в облаке hello требуется tooconfigure и перейти toohello **конфигурации** вкладки.
3. В поле **целевых** select **Azure**.
4. В **учетной записи хранилища** выберите учетную запись хранилища Azure hello, использовать для репликации.
5. Задать **шифрование хранимых данных** слишком**Off**. Этот параметр указывает, шифрование данных во время репликации данных между локальным сайтом hello и Azure.
6. В **частота копирования** оставьте параметр по умолчанию hello. Это значение указывает, как часто следует синхронизировать данные между исходным и конечным расположениями.
7. В **сохранить точки восстановления для**, оставьте параметр по умолчанию hello. Значение по умолчанию равно нулю только hello последней точки восстановления для основной виртуальной машины хранится на сервере узла реплики.
8. В **частоту моментальные снимки приложений**, оставьте параметр по умолчанию hello. Это значение указывает, как часто toocreate моментальные снимки. Моментальные снимки используют tooensure службы теневого копирования томов (VSS), приложения находятся в согласованном состоянии при hello моментального снимка.  Если значение задано, убедитесь, что оно меньше, чем количество дополнительных точек восстановления, настроенные в hello.
9. В **время начала репликации**, укажите начала начальной репликации данных tooAzure. будет использоваться Hello часовой пояс на сервере узла Hyper-V hello. Рекомендуется запланировать hello начальной репликации часы наименьшей нагрузки.

    ![Параметры репликации облака](./media/site-recovery-vmm-to-azure-classic/cloud-settings.png)

После сохранения параметров hello задания будет создан и может отслеживаться на hello **заданий** вкладки. Все серверы узла Hyper-V в исходном облаке VMM hello будут настроены для репликации.

После сохранения можно изменить параметры облака на hello **Настройка** вкладку toomodify hello целевой и расположение учетной записи хранения вы требуется tooremove hello облачные конфигурации, а также повторно настроить облако hello. Обратите внимание, что при изменении изменения hello учетной записи хранилища hello применяется только для виртуальных машин, включенные для защиты, после изменения учетной записи хранилища hello. Существующие виртуальные машины, не переносятся toohello новой учетной записи хранения.

## <a name="step-7-configure-network-mapping"></a>Шаг 7. Настройка сетевого сопоставления
Перед началом сопоставления сетей убедитесь, что виртуальные машины на исходном сервере VMM hello tooa подключенной сети виртуальной Машины. Кроме того, создайте одну или несколько виртуальных сетей Azure. Обратите внимание, что несколько сетей виртуальной Машины может быть сопоставленных tooa одной сетью Azure.

1. На странице быстрого запуска приветствия щелкните **сопоставление сетей**.
2. На hello **сетей** вкладке **исходное местоположение**выберите hello исходном сервере VMM. В поле **Целевое расположение** выберите Azure.
3. В **источника** отображаются список сетей виртуальных Машин, связанных с сервером VMM hello сети. В **целевой** сетей hello Azure отображаются сети, связанные с подпиской hello.
4. Выберите исходную сеть виртуальных Машин hello и нажмите кнопку **карты**.
5. На hello **выбрать целевую сеть** страницы приветствия выберите целевую сеть Azure, требуется toouse.
6. Щелкните флажок toocomplete hello hello в процессе сопоставления.

    ![Параметры репликации облака](./media/site-recovery-vmm-to-azure-classic/map-networks.png)

После сохранения параметров hello ход сопоставления hello tootrack начала задания и его можно отслеживать на вкладке "задания" hello. Все существующие реплики виртуальных машин, соответствующих toohello исходную сеть виртуальных Машин будет подключенных toohello целевыми сетями Azure. Новые виртуальные машины, подключенной toohello исходную сеть виртуальных Машин будет подключенных toohello сопоставленной сети Azure после репликации. При изменении существующего сопоставления с новой сети, виртуальные машины реплики будут подключены с использованием новых параметров hello.

Обратите внимание, что если hello целевая сеть содержит несколько подсетей, и одна из этих подсетей имеет hello находится совпадает с именем подсети, на какие hello исходной виртуальной машины, то hello реплики виртуальной машины после отработки отказа будет подключенных toothat целевой подсети. Если никакой целевой подсети с совпадающим именем, hello виртуальная машина будет подключенных toohello первой подсети в сети hello.

> [!NOTE]
> [Миграция сетей](../azure-resource-manager/resource-group-move-resources.md) через ресурсов группы внутри hello одной подписке или между подписками не поддерживается для сети, используемые для развертывания Site Recovery.
>
>

## <a name="step-8-enable-protection-for-virtual-machines"></a>Шаг 8. Включение защиты для виртуальных машин
После надлежащей настройки серверов, облаков и сетей, можно включить защиту для виртуальных машин в облаке hello. Обратите внимание hello следующие:

* Виртуальные машины должны отвечать соответствующим [требованиям Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).
* tooenable защиты hello операционной системы и свойства диска операционной системы необходимо задать для виртуальной машины hello. При создании виртуальной машины в VMM с помощью шаблона виртуальной машины можно задать свойство hello. Можно также задать эти свойства для существующих виртуальных машин на hello **Общие** и **конфигурация оборудования** вкладки свойств виртуальной машины hello. Если не установить эти свойства в VMM вы будете может tooconfigure их на портале Azure Site Recovery hello.

    ![Создание виртуальной машины](./media/site-recovery-vmm-to-azure-classic/enable-new.png)

    ![Изменение свойств виртуальной машины](./media/site-recovery-vmm-to-azure-classic/enable-existing.png)

1. tooenable защиты hello **виртуальные машины** в облаке hello, в которой hello является виртуальная машина, щелкните **включить защиту** > **добавить виртуальные машины**.
2. Выберите из списка hello виртуальных машин в облаке hello hello один требуется tooprotect.

    ![Включение защиты виртуальной машины](./media/site-recovery-vmm-to-azure-classic/select-vm.png)

    Отслеживать ход выполнения hello **включить защиту** действия в hello **заданий** вкладке, включая hello начальной репликации. После hello **окончательной установки защиты** задание запускается hello виртуальная машина будет готова для отработки отказа. После включения защиты и виртуальные машины реплицированы, вы будете иметь доступ tooview их в Azure.

    ![Задание защиты виртуальной машины](./media/site-recovery-vmm-to-azure-classic/vm-jobs.png)

1. Проверьте свойства виртуальной машины hello и измените при необходимости.

    ![Проверка виртуальных машин](./media/site-recovery-vmm-to-azure-classic/vm-properties.png)
2. На hello **Настройка** вкладку свойств виртуальной машины hello следующие свойства сети могут быть изменены.

* **Количество сетевых адаптеров на виртуальной машине hello целевой** -hello число сетевых адаптеров, зависит от размера hello, укажите для hello целевой виртуальной машины. Проверьте [спецификаций размер виртуальной машины](../virtual-machines/linux/sizes.md) hello число адаптеров, поддерживаемых hello размер виртуальной машины. При изменения размера hello для виртуальной машины и сохранить параметры hello hello число сетевых адаптеров изменится hello при очередном открытии hello **Настройка** страницы. Hello число сетевых адаптеров виртуальных машин целевой — hello минимальное число сетевых адаптеров в исходной виртуальной машины и hello максимальное число сетевых адаптеров, поддерживаемых hello размера виртуальной машины hello, выбора следующим образом:

  * Если hello количество сетевых адаптеров на исходном компьютере hello меньше или равно toohello число адаптеров разрешено hello целевой машине размером, а затем целевой hello будут иметь одинаковое число адаптеров как источник hello hello.
  * Если hello число адаптеров для hello исходной виртуальной машины превышает допустимое hello для hello целевого размера, а затем максимальный размер целевой hello будет использоваться.
  * Например если исходная машина имеет два сетевых адаптера, hello целевой машине размер поддерживает четыре hello целевой компьютер будет иметь два адаптера. Если hello исходный компьютер имеет два адаптера, но hello поддерживаемые целевой размер поддерживает только один hello целевой компьютер будет только один адаптер.     
* **Сети виртуальной машины hello** -hello сети toowhich hello виртуальной машины подключается toois определяется сетевое сопоставление сети hello исходной виртуальной машине. Если hello исходная виртуальная машина имеет более одного сетевого адаптера и источник сети — это сопоставленные toodifferent сети на целевом сервере, затем потребуется установить toochoose между hello целевых сетей.
* **Подсети каждого сетевого адаптера** — для каждого сетевого адаптера, можно выбрать hello подсети toowhich hello отработку отказа виртуальной машины будет подключаться к.
* **Целевой IP-адрес** — Если сетевой адаптер hello исходной виртуальной машине является настроенным toouse статических IP-адресов, то можно указать hello IP-адрес для hello целевой виртуальной машины. Эта функция сохраняет hello IP-адрес из исходной виртуальной машины после отработки отказа. Если указан IP-адрес любой доступный IP-адрес указывается toohello сетевого адаптера в hello время отработки отказа. Если указан hello конечный IP-адрес, но уже используется другой виртуальной машины, работающие в Azure отработки отказа завершится ошибкой.  

    ![Изменение свойств сети](./media/site-recovery-vmm-to-azure-classic/multi-nic.png)

> [!NOTE]
> Виртуальные машины Linux со статическим IP-адресом не поддерживаются.
>
>

## <a name="test-hello-deployment"></a>Тестирование развертывания hello
Планирование развертывания можно запустить тестовую отработку отказа для одной виртуальной машины или создайте план восстановления, состоящий из нескольких виртуальных машин и запустите тестовую отработку отказа для hello tootest.  

Тестовая обработка отказа имитирует механизм отработки отказа и восстановления в изолированной сети. Обратите внимание на следующее.

* Tooconnect toohello виртуальной машины в Azure с помощью удаленного рабочего стола, после отработки отказа hello, включите подключение к удаленному рабочему столу на виртуальной машине hello перед запуском тестовой отработки отказа hello.
* После отработки отказа используйте открытые tooconnect toohello IP адрес виртуальной Машины Azure с помощью удаленного рабочего стола. Если требуется toodo это, убедитесь, что нет политик домена, запретить подключения tooa виртуальной машины, с помощью общедоступного адреса.

> [!NOTE]
> tooget hello наилучшей производительности при переключении между tooAzure, убедитесь, вы установили hello Azure агент на hello виртуальной Машины. Это ускоряет загрузку и помогает устранять неполадки. Загрузите hello [агент Linux](https://github.com/Azure/WALinuxAgent), или hello [агент Windows](http://go.microsoft.com/fwlink/?LinkID=394789).
>
>

### <a name="create-a-recovery-plan"></a>Создайте план восстановления
1. На hello **планы восстановления** добавьте новый план. Укажите имя, **VMM** в **тип источника**и исходный сервер VMM hello в **источника**. целевым объектом Hello будет Azure.

    ![Создать план восстановления](./media/site-recovery-vmm-to-azure-classic/recovery-plan1.png)
2. В hello **выберите виртуальные машины** страницы, план восстановления toohello tooadd выберите виртуальные машины. Эти виртуальные машины добавляются в группу по умолчанию для плана восстановления toohello — группу 1. Проводилось тестирование сценария с максимум 100 виртуальными машинами в одном плане восстановления.

* Свойства виртуальной машины hello tooverify до их добавления toohello плана, нажмите кнопку hello виртуальной машины на странице свойств hello hello облака, в котором она расположена. Также можно настроить свойства виртуальной машины hello в консоли VMM hello.
* Все виртуальные машины hello, отображаемых включена для защиты. Список Hello содержит обе виртуальные машины, включенные для защиты и начальная репликация была завершена, а те, которые включены для защиты с помощью начальная репликация ожидается. Отработка отказа в рамках плана восстановления может выполняться только для виртуальных машин с выполненной начальной репликацией.

    ![Создать план восстановления](./media/site-recovery-vmm-to-azure-classic/select-rp.png)

Созданный план восстановления он отображается в hello **планы восстановления** вкладки. Можно также добавить [модулей Azure automation Runbook](site-recovery-runbook-automation.md) toohello действия tooautomate плана восстановления при отработке отказа.

### <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа
Существует два способа toorun tooAzure теста отработки отказа.

* **Тестовое аварийное переключение без сети Azure**— это тип тестового аварийного переключения проверяет, что hello виртуальная машина корректно появляется в Azure. Hello виртуальной машины не будут tooany подключенной сети Azure после отработки отказа.
* **Тестовое аварийное переключение с сетью Azure**— этот тип аварийного переключения проверяет, hello вся среда репликации имеет корректный и отработку отказа hello виртуальные машины будут подключенных toohello указанной целевой сети Azure. Для обработки подсетей для тестовой отработки отказа подсети hello hello тестовой виртуальной машины будет определяться на основании подсети hello hello реплики виртуальной машины. Это разные tooregular репликации hello подсети виртуальной машины реплики на основании подсети hello hello исходной виртуальной машине.

Если требуется toorun тестовую отработку отказа для виртуальной машины включена для защиты tooAzure без указания целевой сети Azure не требуется tooprepare ничего. toorun тестовой отработки отказа с целевой сетью Azure, вам потребуется toocreate новую сеть Azure, изолированную от сети Azure производства (поведение по умолчанию при создании новой сети в Azure). Рассмотрим, как слишком[выполнить тестовую отработку отказа](site-recovery-failover.md) для получения дополнительных сведений.

Кроме того, потребуется tooset hello инфраструктуры для hello репликации виртуальной машины toowork должным образом. Например, виртуальная машина с контроллером домена и DNS может быть реплицированной tooAzure, с помощью Azure Site Recovery; могут создаваться в hello тестовой сети с помощью тестовой отработки отказа Дополнительные сведения см. в статье [Защита Active Directory и DNS с Azure Site Recovery](site-recovery-active-directory.md#test-failover-considerations).

toorun тестовой отработки отказа hello следующие:

1. На hello **планы восстановления** выберите hello план и щелкните **тестовой отработки отказа**.
2. На hello **подтверждение тестового аварийного переключения** выберите **нет** или определенной сети Azure.  Обратите внимание, что при выборе None hello тестовой отработки отказа будет hello виртуальной машины Проверьте правильность репликации tooAzure не проверяет конфигурацию сети репликации.

    ![Нет сети](./media/site-recovery-vmm-to-azure-classic/test-no-network.png)
3. Включено ли шифрование данных для облака hello в **ключ шифрования** hello выберите сертификат, выданный во время установки hello поставщика на сервере VMM hello, при включении шифрования hello параметр tooenable данных для облака .
4. На hello **заданий** можно отслеживать ход аварийного переключения. Также следует тестовая реплика виртуальной машины может toosee hello в hello портал Azure. Если у вас установлен до tooaccess виртуальных машин из локальной сети может инициировать виртуальной машины toohello подключения удаленного рабочего стола.
5. После отработки отказа hello достигнет hello **выполнить тестирование** этап, нажмите кнопку **выполнения теста** toofinish его. Можно выполнить детализацию toohello **задания** вкладке tootrack ход аварийного переключения и состояние, tooperform любые необходимые действия.
6. После отработки отказа вы увидите hello тестовая реплика виртуальной машины в hello портал Azure. Если у вас установлен до tooaccess виртуальных машин из локальной сети может инициировать виртуальной машины toohello подключения удаленного рабочего стола. Здравствуйте, следующие:

   1. Убедитесь, что hello виртуальные машины запускаются успешно.
   2. Tooconnect toohello виртуальной машины в Azure с помощью удаленного рабочего стола, после отработки отказа hello, включите подключение к удаленному рабочему столу на виртуальной машине hello перед запуском тестовой отработки отказа hello. Необходимо также tooadd конечной точки протокола удаленного рабочего СТОЛА на виртуальной машине hello. Можно использовать [Runbook автоматизации Azure](site-recovery-runbook-automation.md) toodo.
   3. После отработки отказа Если вы используете открытый IP адрес tooconnect toohello виртуальной машины в Azure с помощью удаленного рабочего стола, убедитесь, что нет политик домена, предотвратить подключение tooa виртуальной машины с помощью общедоступного адреса.
7. После завершения тестирования hello hello следующие:

   * Нажмите кнопку **hello тестовая отработка отказа выполнена**. Очистка hello тестирования среды tooautomatically power off и удалите hello тестовые виртуальные машины.
   * Нажмите кнопку **заметки** toorecord и сохранить все наблюдения, связанные с тестовой отработки отказа hello.


## <a name="next-steps"></a>Дальнейшие действия
См. дополнительные сведения о [настройке планов восстановления](site-recovery-create-recovery-plans.md) и [отработке отказа](site-recovery-failover.md).

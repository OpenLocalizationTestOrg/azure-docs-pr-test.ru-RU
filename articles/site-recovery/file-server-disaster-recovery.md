---
title: "Защита файлового сервера с помощью Azure Site Recovery"
description: "В этой статье описывается защита файлового сервера с помощью Azure Site Recovery."
services: site-recovery
author: rajani-janaki-ram
manager: gauravd
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/23/2017
ms.author: rajanaki
ms.custom: mvc
ms.openlocfilehash: ac734ffc6cb57188b7b0959cbe7655949b2853de
ms.sourcegitcommit: b07d06ea51a20e32fdc61980667e801cb5db7333
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/08/2017
---
# <a name="protect-a-file-server-using-azure-site-recovery"></a>Защита файлового сервера с помощью Azure Site Recovery 

Служба [Azure Site Recovery](site-recovery-overview.md) помогает реализовать стратегию непрерывности бизнес-процессов и аварийного восстановления (BCDR), обеспечивая работоспособность и доступность бизнес-приложений во время запланированных и незапланированных простоев. Site Recovery управляет аварийным восстановлением локальных компьютеров и виртуальных машин Azure, включая операции репликации, отработки отказа и восстановления различных рабочих нагрузок.

Эта статья содержит сведения о защите файлового сервера с помощью Azure Site Recovery, а также другие рекомендации в соответствии с различными средами.     

- [Рекомендации по аварийному восстановлению для виртуальных машин IaaS Azure](#disaster-recovery-recommendation-for-azure-iaas-virtual-machines)
- [Репликация локального файлового сервера с помощью Azure Site Recovery](#replicate-an-onpremises-file-server-using-azure-site-recovery).

## <a name="file-server-architecture"></a>Архитектура файлового сервера
Открытая распределенная система для совместной работы с файлами предоставляет среду, в которой группа географически распределенных пользователей может взаимодействовать для эффективной работы с файлами, а также обеспечивает целостность этих данных. Стандартная локальная экосистема файлового сервера, которая поддерживает большое число одновременных пользователей и элементов, использует репликацию распределенной файловой системы (DFSR) для планирования репликации и регулирования пропускной способности. DFSR применяет алгоритм сжатия (известный как удаленное разностное сжатие (RDC)), с помощью которого можно эффективно обновлять файлы в сети с ограниченной пропускной способностью. Он обнаруживает операции вставки, удаления и перераспределения данных в файлах, позволяя DFSR реплицировать только измененные блоки файлов при обновлении файлов. Существуют также среды файловых серверов, где ежедневные резервные копии создаются в периоды низкой нагрузки и используются для аварийных потребностей. Реализация DFSR отсутствует.

Следующая топология иллюстрирует среду файлового сервера с реализованным DFSR.
                
![Архитектура DFSR](media/site-recovery-file-server/dfsr-architecture.JPG)

На приведенной выше схеме несколько файловых серверов, которые рассматриваются как участники, активно участвуют в репликации файлов в группе репликации. Содержимое в реплицированной папке будет доступно всем клиентам, отправляющим запросы любому участнику, даже если один из них вне сети.

## <a name="disaster-recovery-recommendation-for-file-servers"></a>Рекомендации по аварийному восстановлению для файловых серверов

1.  Реплицируйте файловый сервер с помощью Azure Site Recovery: файловый сервер можно реплицировать в Azure с помощью Azure Site Recovery. Если один или несколько локальных файловых серверов недоступны, в Azure можно запустить виртуальные машины восстановления. Они могут локально обрабатывать запросы от клиентов при условии, что имеется VPN-подключение "сеть — сеть" и в Azure настроена служба Active Directory. Это можно сделать при наличии настроенной среды DFSR или простой среды файлового сервера без DFSR. 

2.  Распространите DFSR на виртуальных машинах IaaS Azure: в кластеризованной среде файлового сервера с реализованной репликацией DFSR рекомендуется распространить локальную DFSR в Azure. Затем виртуальные машины Azure могут выполнять роль файлового сервера. 

    Если зависимости VPN-подключения "сеть — сеть" и Active Directory настроены, а репликация DFSR реализована, то когда один или несколько локальных файловых серверов недоступны, клиенты смогут по-прежнему подключаться к виртуальной машине Azure, которая будет обрабатывать запросы.

    Мы рекомендуем использовать этот подход, если виртуальная машина имеет настройки, которые не поддерживаются Azure Site Recovery. Например, общий диск кластера, который иногда часто используется в средах файлового сервера.  DFSR также хорошо работает в средах с низкой пропускной способностью и средней скоростью изменения данных. Дополнительные затраты на виртуальную машину, которая будет работать все время, также должны быть учтены.  

3.  Используйте службу синхронизации файлов Azure для репликации файлов: если вы готовитесь к переходу в облако или уже используете виртуальную машину Azure, мы рекомендуем использовать эту службу, которая синхронизирует полностью управляемые файловые ресурсы в облаке. Доступ к этим ресурсам можно получить по стандартному отраслевому протоколу [SMB](https://msdn.microsoft.com/library/windows/desktop/aa365233.aspx). Общие ресурсы службы файлов Azure можно затем одновременно подключить к облачным или локальным развертываниям Windows, Linux и macOS. 

Ниже представлена схема, которая упрощает выбор стратегии для использования в среде файлового сервера.

![decisiontree](media/site-recovery-file-server/decisiontree.png)


### <a name="factors-to-consider-while-making-decision-of-disaster-recovery-to-azure"></a>Факторы, на которые стоит обратить внимание при выборе решения для аварийного восстановления в Azure

|Среда  |Рекомендации  |Что необходимо учесть |
|---------|---------|---------|
|Среда файлового сервера с или без DFSR|   [Для репликации используйте Azure Site Recovery](#replicate-an-onpremises-file-servers-using-azure-site-recovery)   |    Site Recovery не поддерживает кластер общих дисков (запоминающее устройство, подключаемое к сети). Если в вашей среде используется любая из этих конфигураций, при необходимости используйте любой из других подходов. <br> Azure Site Recovery не поддерживает SMB 3.0. Это значит, что реплицируемая виртуальная машина внедрит изменения, только когда внесенные в файлы изменения будут обновлены в исходном расположении файла.
|Среда файлового сервера с DFSR     |  [Распространите DFSR на виртуальную машину IaaS Azure](#extend-dfsr-to-an-azure-iaas-virtual-machine)  |     DFSR хорошо работает в средах с очень сжатой пропускной способностью. Однако этот подход требует наличия виртуальной машины Azure, которая все время запущена. Необходимо учитывать стоимость виртуальной машины при планировании.         |
|Виртуальная машина IaaS Azure     |     [Служба синхронизации файлов Azure](#use-azure-file-sync-service-to-replicate-your-files)   |     В сценарии аварийного восстановления при использовании службы синхронизации файлов Azure во время отработки отказа необходимо выполнить действия вручную, чтобы убедиться, что общие файловые ресурсы доступны на клиентском компьютере прозрачным образом. Для службы синхронизации файлов необходимо открыть порт 445 с клиентского компьютера.     |


### <a name="site-recovery-support"></a>Поддержка Site Recovery
Так как репликация Site Recovery не зависит от приложения, описанные здесь рекомендации подходят для сценариев, представленных ниже.
| Источник    |На дополнительный сайт    |В Azure
|---------|---------|---------|
|Таблицы Azure| -|Yes|
|Hyper-V.|   Yes |Yes
|VMware |Yes|   Yes
|Физический сервер|   Yes |Yes
 

> [!IMPORTANT]
> Прежде чем приступить к работе с одним из указанных ниже подходов, убедитесь, что выполнены следующие зависимости.

**Подключение "сеть — сеть".** Необходимо установить прямое соединение между локальным сайтом и сетью Azure, чтобы разрешить обмен данными между серверами.  Это можно обеспечить за счет защищенного подключения "сеть — сеть" к виртуальной сети Microsoft Azure, которая будет использоваться как сайт аварийного восстановления.  
Ознакомьтесь со статьей [Создание подключения типа "сеть — сеть" на портале Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal).

**Active Directory.** DFSR зависит от Active Directory.  Это означает, что лес Active Directory с локальными контроллерами домена распространяется на сайт аварийного восстановления в Azure. Даже если вы не используете DFSR, а предполагаемым пользователям необходимо предоставить или проверить доступ (как в большинстве организаций), необходимо выполнить эти действия.
Ознакомьтесь со статьей [Защита Active Directory и DNS с Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-active-directory).

## <a name="disaster-recovery-recommendation-for-azure-iaas-virtual-machines"></a>Рекомендации по аварийному восстановлению для виртуальных машин IaaS Azure

Если вы настраиваете аварийное восстановление файловых серверов, размещенных на виртуальных машинах IaaS Azure, и управляете им, можно выбрать один из двух вариантов, в зависимости от того, хотите ли вы использовать [службу файлов Azure](https://docs.microsoft.com/azure/storage/files/storage-files-introduction).

1. [Использование службы синхронизации файлов Azure](#use-azure-file-sync-service-to-replicate-files-hosted-on-iaas-virtual-machine).
2. [Использование Azure Site Recovery](#replicate-an-iaas-file-server-virtual-machine-using-azure-site-recovery)

## <a name="use-azure-file-sync-service-to-replicate-files-hosted-on-iaas-virtual-machine"></a>Использование службы синхронизации файлов Azure для репликации файлов, размещенных на виртуальной машине IaaS

**Службу файлов Azure** можно использовать для полной замены или дополнения традиционных локальных файловых серверов или устройств NAS. Общие ресурсы службы файлов Azure также можно реплицировать с помощью службы синхронизации файлов Azure на локальные или облачные серверы Windows Server для высокопроизводительного и распределенного кэширования данных в месте их использования. В указанных ниже действиях подробно описаны рекомендации по аварийному восстановлению для виртуальных машин Azure, которые позволяют реализовать те же возможности, что и обычные файловые серверы.
1.  Включите защиту компьютеров с помощью Azure Site Recovery, выполнив действия, указанные в статье [Репликация виртуальной машины Azure в другой регион Azure (предварительная версия)](azure-to-azure-quickstart.md).
2.  Используйте службу синхронизации файлов Azure для репликации файлов из виртуальной машины, выполняющей функции файлового сервера, в облако.
3.  Используйте [функцию плана](site-recovery-create-recovery-plans.md) восстановления Azure Site Recovery, чтобы [добавить скрипты для подключения общей папки Azure](https://docs.microsoft.com/azure/storage/files/storage-how-to-use-files-windows) и получить доступ к этой папке на виртуальной машине.

Указанные ниже действия содержат краткие сведения об использовании службы синхронизации файлов.

1. [Создайте учетную запись хранения в Azure](https://docs.microsoft.com/azure/storage/common/storage-create-storage-account?toc=%2fazure%2fstorage%2ffiles%2ftoc.json). Если вы выбрали геоизбыточное хранилище с доступом для чтения (RA-GRS) для учетных записей хранения, то в случае сбоя у вас будет доступ только для чтения к своим данным из дополнительного региона. Дополнительные сведения см. в статье [Что делать в случае простоя службы хранилища Azure](https://docs.microsoft.com/azure/storage/common/storage-disaster-recovery-guidance?toc=%2fazure%2fstorage%2ffiles%2ftoc.json).
2. [Создайте файловый ресурс](https://docs.microsoft.com/azure/storage/files/storage-how-to-create-file-share).
3. [Разверните службу синхронизации файлов Azure](https://docs.microsoft.com/azure/storage/files/storage-sync-files-deployment-guide) на файловом сервере Azure.
4. Создайте группу синхронизации: конечные точки в группе синхронизации будут синхронизированы друг с другом. Группа синхронизации должна содержать по крайней мере одну облачную конечную точку, которая представляет общий файловый ресурс Azure, и одну серверную конечную точку, которая представляет собой путь в Windows Server.
5.  Теперь ваши файлы будут синхронизироваться между общими файловыми ресурсами Azure и локальным сервером.
6.  В случае аварии в локальной среде выполните отработку отказа, используя [план восстановления](site-recovery-create-recovery-plans.md), и добавьте сценарий, чтобы [подключить общий файловый ресурс Azure](https://docs.microsoft.com/azure/storage/files/storage-how-to-use-files-windows) и получить доступ к нему на виртуальной машине.

### <a name="replicate-an-iaas-file-server-virtual-machine-using-azure-site-recovery"></a>Репликация виртуальной машины файлового сервера IaaS с помощью Azure Site Recovery

При наличии локальных клиентов, обращающихся к виртуальным машинам файлового сервера IaaS, не забудьте выполнить первые 2 шага. В противном случае перейдите к шагу 3.

1. Установите VPN-подключение "сеть — сеть" между локальным сайтом и сетью Azure.
1. Распространите локальную службу Active Directory.
1. [Настройте аварийное восстановление](azure-to-azure-tutorial-enable-replication.md) компьютера файлового сервера IaaS в дополнительный регион.


Дополнительные сведения об аварийном восстановлении в дополнительном регионе см. [здесь](concepts-azure-to-azure-architecture.md).


## <a name="replicate-an-on-premises-file-server-using-azure-site-recovery"></a>Репликация локального файлового сервера с помощью Azure Site Recovery

Указанные ниже действия детально описывают репликацию виртуальной машины VMware. Репликацию виртуальной машины Hyper-V см. [здесь](tutorial-hyper-v-to-azure.md).

1.  [Подготовьте ресурсы Azure](tutorial-prepare-azure.md) для репликации локальных компьютеров.
2.  Установите VPN-подключение "сеть — сеть" между локальным сайтом и сетью Azure.  
3. Распространите локальную службу Active Directory.
4.  [Подготовьте локальные серверы VMware](tutorial-prepare-on-premises-vmware.md).
5.  [Настройте аварийное восстановление](tutorial-vmware-to-azure.md) в Azure для локальных виртуальных машин.

## <a name="extend-dfsr-to-an-azure-iaas-virtual-machine"></a>Распространение DFSR на виртуальную машину IaaS Azure

1.  Установите VPN-подключение "сеть — сеть" между локальным сайтом и сетью Azure. 
2.  Распространите локальную службу Active Directory.
3.  [Создайте и подготовьте виртуальную машину файлового севера](https://docs.microsoft.com/azure/virtual-machines/windows/quick-create-portal?toc=%2Fazure%2Fvirtual-machines%2Fwindows%2Ftoc.json) в виртуальной сети Windows Azure.
Убедитесь, что виртуальная машина добавлена в ту же виртуальную сеть Windows Azure, которая имеет перекрестное соединение с локальной средой. 
4.  Установите и [настройте репликацию DFS](https://blogs.technet.microsoft.com/b/filecab/archive/2013/08/21/dfs-replication-initial-sync-in-windows-server-2012-r2-attack-of-the-clones.aspx) в Windows Server.
5.  [Реализуйте пространство имен DFS](https://docs.microsoft.com/windows-server/storage/dfs-namespaces/deploying-dfs-namespaces).
6.  Если реализовано пространство имен DFS, отработку отказа общих папок из рабочей среды на сайты аварийного восстановления можно выполнить, обновив целевые объекты папки пространства имен DFS.  После репликации изменений пространства имен DFS через Active Directory пользователи будут прозрачно подключены к соответствующим целевым объектам папки.

## <a name="use-azure-file-sync-service-to-replicate-your-on-premises-files"></a>Использование службы синхронизации файлов Azure для репликации локальных файлов
С помощью службы синхронизации файлов Azure можно реплицировать нужные файлы в облако. В случае сбоя и недоступности локального файлового сервера вы можете подключить нужное расположение файлов из облака и продолжить обрабатывать запросы с клиентских компьютеров.
Для интеграции службы синхронизации файлов Azure с Azure Site Recovery мы рекомендуем использовать указанные ниже подходы.
1.  Включите защиту компьютеров файлового сервера с помощью Azure Site Recovery, выполнив указанные [здесь](tutorial-vmware-to-azure.md) действия.
2.  Используйте службу синхронизации файлов Azure для репликации файлов с компьютеров, выполняющих функции файлового сервера, в облако.
3.  Используйте функцию плана восстановления Azure Site Recovery, чтобы добавить скрипты для подключения общей папки Azure на виртуальной машине файлового сервера, для которой выполнена отработка отказа, в Azure.

Указанные ниже действия описывают, как использовать службу синхронизации файлов Azure.

1. [Создайте учетную запись хранения в Azure](https://docs.microsoft.com/azure/storage/common/storage-create-storage-account?toc=%2fazure%2fstorage%2ffiles%2ftoc.json). Если вы выбрали геоизбыточное хранилище с доступом для чтения (RA-GRS) (рекомендуется) для учетных записей хранения, то у вас будет доступ только для чтения к своим данным из дополнительного региона в случае сбоя. Дополнительные сведения см. в статье [Что делать в случае простоя службы хранилища Azure](https://docs.microsoft.com/azure/storage/common/storage-disaster-recovery-guidance?toc=%2fazure%2fstorage%2ffiles%2ftoc.json).
2. [Создайте файловый ресурс](https://docs.microsoft.com/azure/storage/files/storage-how-to-create-file-share).
3. [Разверните службу синхронизации файлов Azure](https://docs.microsoft.com/azure/storage/files/storage-sync-files-deployment-guide) на локальном файловом сервере.
4. Создайте группу синхронизации: конечные точки в группе синхронизации будут синхронизированы друг с другом. Группа синхронизации должна содержать по крайней мере одну облачную конечную точку, которая представляет общий файловый ресурс Azure, и одну серверную конечную точку, которая представляет собой путь на локальном Windows Server.
1. Теперь ваши файлы будут синхронизироваться между общими файловыми ресурсами Azure и локальным сервером.
6.  В случае аварии в локальной среде выполните отработку отказа, используя [план восстановления](site-recovery-create-recovery-plans.md), и добавьте сценарий, чтобы подключить общий файловый ресурс Azure и получить доступ к нему на виртуальной машине.

> [!NOTE]
> Откройте порт 445: служба файлов Azure использует протокол SMB. Взаимодействие SMB выполняется через TCP-порт 445. Проверьте, чтобы брандмауэр не блокировал TCP-порты 445 с клиентского компьютера.


## <a name="doing-a-test-failover"></a>Тестовая отработка отказа

1.  Перейдите на портал Azure и выберите хранилище служб восстановления.
2.  Щелкните план восстановления, созданный для среды файлового сервера.
3.  Щелкните "Тестовая отработка отказа".
4.  Выберите точку восстановления и виртуальную сеть Azure, чтобы запустить тестовую отработку отказа.
5.  Как только будет запущена вторичная среда, вы сможете выполнить проверку.
6.  После завершения проверки можно нажать кнопку "Очистить тестовую отработку отказа" в плане восстановления. Тестовая среда отработки отказа будет очищена.

Дополнительные сведения о выполнении тестовой отработки отказа см. [здесь](site-recovery-test-failover-to-azure.md).

Инструкции по выполнению тестовой отработки отказа для AD и DNS см. в статье [Защита Active Directory и DNS с Azure Site Recovery](site-recovery-active-directory.md).

## <a name="doing-a-failover"></a>Отработка отказа

1.  Перейдите на портал Azure и выберите хранилище служб восстановления.
2.  Щелкните план восстановления, созданный для среды файлового сервера.
3.  Щелкните "Отработка отказа".
4.  Выберите точку восстановления, чтобы запустить отработку отказа.

Дополнительные сведения о выполнении тестовой отработки отказа см. в статье [Отработка отказа в Site Recovery](site-recovery-failover.md).

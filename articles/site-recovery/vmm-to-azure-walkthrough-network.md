---
title: "Планирование сетей для Hyper-V (с использованием System Center VMM) для репликации в Azure с помощью Azure Site Recovery | Документация Майкрософт"
description: "В этой статье рассматривается планирование сетей, необходимое при репликации виртуальных машин Hyper-V (с использованием VMM) в Azure."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 41c3c83e-6b1a-496a-8179-498c552ef0c7
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 07/23/2017
ms.author: raynew
ms.openlocfilehash: ef87cd82b021e40f0da05142878daff245cd9c62
ms.sourcegitcommit: 422efcbac5b6b68295064bd545132fcc98349d01
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/29/2017
---
# <a name="step-4-plan-networking-for-hyper-v-with-vmm-to-azure-replication"></a><span data-ttu-id="59f26-103">Шаг 4. Планирование сетей для репликации из Hyper-V (с VMM) в Azure</span><span class="sxs-lookup"><span data-stu-id="59f26-103">Step 4: Plan networking for Hyper-V (with VMM) to Azure replication</span></span>

<span data-ttu-id="59f26-104">После [планирования ресурсов](vmm-to-azure-walkthrough-capacity.md) (при полном развертывании) ознакомьтесь с этой статьей. Здесь содержатся рекомендации по планированию сети при репликации локальных виртуальных машин Hyper-V в облаках System Center Virtual Machine Manager (VMM) в Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).</span><span class="sxs-lookup"><span data-stu-id="59f26-104">After performing [capacity planning](vmm-to-azure-walkthrough-capacity.md) (if you're doing a full deployment), read this article to learn about network planning considerations when replicating on-premises Hyper-V VMs in System Center Virtual Machine Manager (VMM) clouds to Azure, using the [Azure Site Recovery](site-recovery-overview.md) service.</span></span>

<span data-ttu-id="59f26-105">Все комментарии можно добавить в конце этой статьи. Вопросы можно задать на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span><span class="sxs-lookup"><span data-stu-id="59f26-105">Post any comments at the bottom of this article, or ask questions in the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>


## <a name="network-mapping-for-replication-to-azure"></a><span data-ttu-id="59f26-106">Сопоставления сетей для репликации в Azure</span><span class="sxs-lookup"><span data-stu-id="59f26-106">Network mapping for replication to Azure</span></span>

<span data-ttu-id="59f26-107">Сетевое сопоставление используется при репликации виртуальных машин Hyper-V (управляемых в VMM) в Azure.</span><span class="sxs-lookup"><span data-stu-id="59f26-107">Network mapping is used when replicating Hyper-V VMs (managed in VMM) to Azure.</span></span> <span data-ttu-id="59f26-108">При сетевом сопоставлении сопоставляются сети виртуальных машин, на исходном сервере VMM, и целевые сети Azure.</span><span class="sxs-lookup"><span data-stu-id="59f26-108">Network mapping maps between VM networks on a source VMM server, and target Azure networks.</span></span> <span data-ttu-id="59f26-109">Это предоставляет следующие возможности:</span><span class="sxs-lookup"><span data-stu-id="59f26-109">Mapping does the following:</span></span>

- <span data-ttu-id="59f26-110">**Сетевое подключение.** После отработки отказа все реплицированные виртуальные машины Azure подключаются к сопоставленной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="59f26-110">**Network connection**—After failover, all replicated Azure VMs are connected to the mapped Azure network.</span></span> <span data-ttu-id="59f26-111">Все компьютеры, перешедшие в состояние отказа в одной и той же сети, могут подключиться друг к другу, даже если отработка отказа в рамках разных планов восстановления.</span><span class="sxs-lookup"><span data-stu-id="59f26-111">All machines which fail over on the same network can connect to each other, even if they failed over in different recovery plans.</span></span>
- <span data-ttu-id="59f26-112">**Сетевой шлюз.** Если в целевой сети Azure настроен сетевой шлюз, виртуальные машины смогут подключаться к другим локальным виртуальным машинам в сопоставленной локальной сети.</span><span class="sxs-lookup"><span data-stu-id="59f26-112">**Network gateway**—If a network gateway is set up on the target Azure network, VMs can connect to other on-premises virtual machines in the mapped on-premised network.</span></span>

### <a name="prepare-vmm-for-network-mapping"></a><span data-ttu-id="59f26-113">Подготовка VMM к сопоставлению сети</span><span class="sxs-lookup"><span data-stu-id="59f26-113">Prepare VMM for network mapping</span></span>

<span data-ttu-id="59f26-114">Подготовьте VMM к сопоставлению сетей следующим образом:</span><span class="sxs-lookup"><span data-stu-id="59f26-114">Prepare VMM for network mapping as follows:</span></span>

1. <span data-ttu-id="59f26-115">Подготовьте [логическую сеть VMM](https://docs.microsoft.com/system-center/vmm/network-logical) (при ее отсутствии), связанную с облаком, в котором находятся узлы Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="59f26-115">If you don't have one, prepare a [VMM logical network](https://docs.microsoft.com/system-center/vmm/network-logical) that's associated with the cloud in which the Hyper-V hosts are located.</span></span>
2. <span data-ttu-id="59f26-116">Создайте [сеть виртуальной машины](https://docs.microsoft.com/system-center/vmm/network-virtual) (если ее нет), связанную с логической сетью, подготовленной ранее.</span><span class="sxs-lookup"><span data-stu-id="59f26-116">If you don't have one, created a [VM network](https://docs.microsoft.com/system-center/vmm/network-virtual) linked to the logical network you prepared above.</span></span>
3. <span data-ttu-id="59f26-117">Подключите виртуальные машины на сервере или кластере узлов Hyper-V в облаке VMM к сети виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="59f26-117">Connect VMs on the Hyper-V host server/cluster in the VMM cloud, to the VM network.</span></span>

 
<span data-ttu-id="59f26-118">Обратите внимание на следующее.</span><span class="sxs-lookup"><span data-stu-id="59f26-118">Note that:</span></span> 
- <span data-ttu-id="59f26-119">Новые виртуальные машины, добавленные к исходной сети виртуальных машин, будут подключены к сопоставленной сети Azure после репликации.</span><span class="sxs-lookup"><span data-stu-id="59f26-119">New VMs are added to the source VM network are connected to the mapped Azure network when replication occurs.</span></span>
- <span data-ttu-id="59f26-120">Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то реплика виртуальной машины подключается к этой целевой подсети после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="59f26-120">If the target network has multiple subnets, and one of those subnets has the same name as subnet on which the source virtual machine is located, then the replica virtual machine connects to that target subnet after failover.</span></span>
- <span data-ttu-id="59f26-121">Если подсети с таким же именем отсутствуют, виртуальная машина подключается к первой подсети в сети.</span><span class="sxs-lookup"><span data-stu-id="59f26-121">If there’s no target subnet with a matching name, the virtual machine connects to the first subnet in the network.</span></span>
- <span data-ttu-id="59f26-122">Подготовка сети Azure и настройка сопоставления сетей осуществляется при развертывании сценария.</span><span class="sxs-lookup"><span data-stu-id="59f26-122">You prepare an Azure network, and set up network mappings, as you deploy the scenario.</span></span>

## <a name="connecting-to-azure-vms-after-failover"></a><span data-ttu-id="59f26-123">Подключение к виртуальным машинам Azure после отработки отказа</span><span class="sxs-lookup"><span data-stu-id="59f26-123">Connecting to Azure VMs after failover</span></span>

<span data-ttu-id="59f26-124">При планировании стратегии репликации и отработки отказа одним из ключевых вопросов является способ подключения к виртуальной машине Azure после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="59f26-124">When planning your replication and failover strategy, one of the key questions is how to connect to the Azure VM after failover.</span></span> <span data-ttu-id="59f26-125">При разработке сетевой стратегии для виртуальных машин реплик Azure существует несколько вариантов:</span><span class="sxs-lookup"><span data-stu-id="59f26-125">There are a couple of choices when designing your network strategy for replica Azure VMs:</span></span>

- <span data-ttu-id="59f26-126">**Использование другого IP-адреса.** Для сети реплицируемых виртуальных машин Azure можно выбрать другой диапазон IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="59f26-126">**Use a different IP address**: You can select to use a different IP address range for the replicated Azure VM network.</span></span> <span data-ttu-id="59f26-127">В этом сценарии после отработки отказа виртуальная машина получает новый IP-адрес, а также требуется обновление DNS.</span><span class="sxs-lookup"><span data-stu-id="59f26-127">In this scenario the VM gets a new IP address after failover, and a DNS update is required.</span></span>
- <span data-ttu-id="59f26-128">**Использование того же IP-адреса.** После отработки отказа для сети Azure можно оставить тот же диапазон IP-адресов, который использовался d основной локальной сети.</span><span class="sxs-lookup"><span data-stu-id="59f26-128">**Retain the same IP address**: You might want to use the same IP address range as that in your primary on-premises network, for the Azure network after failover.</span></span>  <span data-ttu-id="59f26-129">Использование тех же IP-адресов упрощает процесс восстановления, уменьшая количество проблем с сетью после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="59f26-129">Keeping the same IP addresses simplifies the recovery by reducing network related issues after failover.</span></span> <span data-ttu-id="59f26-130">Тем не менее, при выполнении репликации в Azure потребуется обновить маршруты, чтобы указать новое расположение IP-адресов после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="59f26-130">However, when you're replicating to Azure, you will need to update routes with the new location of the IP addresses after failover.</span></span>


## <a name="retain-ip-addresses"></a><span data-ttu-id="59f26-131">Использование тех же IP-адресов</span><span class="sxs-lookup"><span data-stu-id="59f26-131">Retain IP addresses</span></span>

<span data-ttu-id="59f26-132">При отработке отказа в Azure служба Site Recovery предоставляет возможность сохранить фиксированные IP-адреса, используя отработку отказа в подсети.</span><span class="sxs-lookup"><span data-stu-id="59f26-132">Site Recovery provides the capability to retain fixed IP addresses when failing over to Azure, with a subnet failover.</span></span>

<span data-ttu-id="59f26-133">При отработке отказа в подсети отдельно взятая подсеть присутствует на сайте 1 или 2, но никогда на обоих сайтах одновременно.</span><span class="sxs-lookup"><span data-stu-id="59f26-133">With subnet failover, a specific subnet is present at Site 1 or Site 2, but never at both sites simultaneously.</span></span> <span data-ttu-id="59f26-134">Чтобы сохранить пространство IP-адресов в случае отработки отказа, программными средствами можно сделать так, чтобы инфраструктура маршрутизаторов перемещала подсети с одного сайта на другой.</span><span class="sxs-lookup"><span data-stu-id="59f26-134">In order to maintain the IP address space in the event of a failover, you programmatically arrange for the router infrastructure to move the subnets from one site to another.</span></span> <span data-ttu-id="59f26-135">При отработке отказа подсети перемещаются вместе со связанными с ними защищенными виртуальными машинами.</span><span class="sxs-lookup"><span data-stu-id="59f26-135">During failover, the subnets move with the associated protected VMs.</span></span> <span data-ttu-id="59f26-136">Основным недостатком является то, что в случае сбоя необходимо переместить всю подсеть.</span><span class="sxs-lookup"><span data-stu-id="59f26-136">The main drawback is that in the event of a failure, you have to move the whole subnet.</span></span>



### <a name="failover-example"></a><span data-ttu-id="59f26-137">Пример отработки отказа</span><span class="sxs-lookup"><span data-stu-id="59f26-137">Failover example</span></span>

<span data-ttu-id="59f26-138">Рассмотрим пример отработки отказа в Azure.</span><span class="sxs-lookup"><span data-stu-id="59f26-138">Let's look at an example for failover to Azure.</span></span>

- <span data-ttu-id="59f26-139">Вымышленная компания, банк Woodgrove, имеет локальную инфраструктуру, в которой размещены ее бизнес-приложения.</span><span class="sxs-lookup"><span data-stu-id="59f26-139">A ficticious company, Woodgrove Bank, has an on-premises infrastructure hosting their business apps.</span></span> <span data-ttu-id="59f26-140">Ее мобильные приложения размещены в Azure.</span><span class="sxs-lookup"><span data-stu-id="59f26-140">Their mobile applications are hosted on Azure.</span></span>
- <span data-ttu-id="59f26-141">Подключение между виртуальными машинами банка Woodgrove в Azure и локальными серверами обеспечивается через VPN-подключение типа "сеть — сеть" между локальной сетью периметра и виртуальной сетью Azure.</span><span class="sxs-lookup"><span data-stu-id="59f26-141">Connectivity between Woodgrove Bank VMs in Azure and on-premises servers is provided by a site-to-site (VPN) connection between the on-premises edge network and the Azure virtual network.</span></span>
- <span data-ttu-id="59f26-142">VPN означает, что виртуальная сеть компании в Azure является расширением ее локальной сети.</span><span class="sxs-lookup"><span data-stu-id="59f26-142">This VPN means that the company's virtual network in Azure appears as an extension of their on-premises network.</span></span>
- <span data-ttu-id="59f26-143">Банк Woodgrove хочет использовать Site Recovery для репликации локальных рабочих нагрузок в Azure.</span><span class="sxs-lookup"><span data-stu-id="59f26-143">Woodgrove wants to use Site Recovery to replicate on-premises workloads to Azure.</span></span>
 - <span data-ttu-id="59f26-144">В банке Woodgrove используются приложения и конфигурации, зависящие от жестко заданных IP-адресов, поэтому необходимо сохранить IP-адреса для приложений после отработки отказа в Azure.</span><span class="sxs-lookup"><span data-stu-id="59f26-144">Woodgrove has to deal with applications and configurations which depend on hard-coded IP addresses, and thus need to retain IP addresses for their applications after failover to Azure.</span></span>
 - <span data-ttu-id="59f26-145">Банк Woodgrove назначил своим ресурсам в Azure IP-адреса из диапазона 172.16.1.0/24, 172.16.2.0/24.</span><span class="sxs-lookup"><span data-stu-id="59f26-145">Woodgrove has assigned IP addresses from range 172.16.1.0/24, 172.16.2.0/24 to its resources running in Azure.</span></span>


<span data-ttu-id="59f26-146">Чтобы компания Woodgrove могла реплицировать свои виртуальные машины в Azure, сохранив IP-адреса, необходимо сделать следующее:</span><span class="sxs-lookup"><span data-stu-id="59f26-146">For Woodgrove to be able to replicate its VMs to Azure while retaining the IP addresses, here's what the company needs to do:</span></span>

1. <span data-ttu-id="59f26-147">Создайте виртуальную сеть Azure.</span><span class="sxs-lookup"><span data-stu-id="59f26-147">Create an Azure virtual network.</span></span> <span data-ttu-id="59f26-148">Она должна быть расширением локальной сети, чтобы приложения могли с легкостью выполнить отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="59f26-148">It should be an extension of the on-premises network, so that applications can fail over seamlessly.</span></span>
2. <span data-ttu-id="59f26-149">Azure позволяет добавлять в виртуальные сети, созданные в Azure, VPN-подключения типа "сеть — сеть" в дополнение к подключениям типа "точка — сеть".</span><span class="sxs-lookup"><span data-stu-id="59f26-149">Azure allows you to add site-to-site VPN connectivity, in addition to point-to-site connectivity to the virtual networks created in Azure.</span></span>
3. <span data-ttu-id="59f26-150">При настройке подключения типа "сеть — сеть" в сети Azure можно направить трафик в локальное расположение (локальную сеть) только в том случае, если диапазон IP-адресов отличается от диапазона IP-адресов локальной сети.</span><span class="sxs-lookup"><span data-stu-id="59f26-150">When setting up the site-to-site connection, in the Azure network, you can route traffic to the on-premises location (local-network) only if the IP address range is different from the on-premises IP address range.</span></span>
    - <span data-ttu-id="59f26-151">Это связано с тем, что Azure не поддерживает растянутые подсети.</span><span class="sxs-lookup"><span data-stu-id="59f26-151">This is because Azure doesn’t support stretched subnets.</span></span> <span data-ttu-id="59f26-152">Поэтому при наличии локальной подсети 192.168.1.0/24 невозможно добавить локальную сеть 192.168.1.0/24 в сеть Azure.</span><span class="sxs-lookup"><span data-stu-id="59f26-152">So if you have subnet 192.168.1.0/24 on-premises, you can’t add a local-network 192.168.1.0/24 in the Azure network.</span></span>
    - <span data-ttu-id="59f26-153">Это происходит, так как Azure не знает, что в подсети нет активных виртуальных машин и что подсеть создается только в целях аварийного восстановления данных.</span><span class="sxs-lookup"><span data-stu-id="59f26-153">This is expected because Azure doesn’t know that there are no active VMs in the subnet, and that the subnet is being created for disaster recovery only.</span></span>
    - <span data-ttu-id="59f26-154">Чтобы иметь возможность правильно направлять сетевой трафик из сети Azure, подсети в локальной сети и сети не должны конфликтовать.</span><span class="sxs-lookup"><span data-stu-id="59f26-154">To be able to correctly route network traffic out of an Azure network the subnets in the network and the local-network mustn't conflict.</span></span>

![Перед выполнением отработки отказа подсети](./media/vmm-to-azure-walkthrough-network/network-design7.png)

### <a name="before-failover"></a><span data-ttu-id="59f26-156">Перед выполнением отработки отказа</span><span class="sxs-lookup"><span data-stu-id="59f26-156">Before failover</span></span>

1. <span data-ttu-id="59f26-157">Создайте дополнительную сеть (например, сеть восстановления).</span><span class="sxs-lookup"><span data-stu-id="59f26-157">Create an additional network (for example Recovery Network).</span></span> <span data-ttu-id="59f26-158">Это сеть, в которой создаются виртуальные машины, выполнившие отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="59f26-158">This is the network in which failed over VMs are created.</span></span>
2. <span data-ttu-id="59f26-159">Чтобы убедиться, что IP-адрес для виртуальной машины сохраняется после отработки отказа, откройте вкладку **Настройка** в разделе свойств виртуальной машины, укажите тот же IP-адрес, который использовался на виртуальной машине в локальной сети, и нажмите кнопку **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="59f26-159">To ensure that the IP address for a VM is retained after a failover, in the VM properties > **Configure**, specify the same IP address that the VM has on-premises, and click **Save**.</span></span>
3. <span data-ttu-id="59f26-160">При отработке отказа виртуальной машины служба Azure Site Recovery назначит ей указанный IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="59f26-160">When the VM is failed over, Azure Site Recovery will assign the provided IP address to it.</span></span>

    ![Свойства сети](./media/vmm-to-azure-walkthrough-network/network-design8.png)

4. <span data-ttu-id="59f26-162">После запуска отработки отказа и создания в Azure виртуальных машин с необходимыми IP-адресами для подключения к сети можно использовать [подключение типа "виртуальная сеть — виртуальная сеть"](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md).</span><span class="sxs-lookup"><span data-stu-id="59f26-162">After failover is trigger is triggered, and the VMs are created in Azure with the required IP address, you can connect to the network using a [Vnet to Vnet vonnection](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md).</span></span> <span data-ttu-id="59f26-163">Это действие можно выполнить с помощью сценария.</span><span class="sxs-lookup"><span data-stu-id="59f26-163">This action can be scripted.</span></span>
5. <span data-ttu-id="59f26-164">Маршруты необходимо соответствующим образом изменить, чтобы отразить тот факт, что подсеть 192.168.1.0/24 теперь перемещена в Azure.</span><span class="sxs-lookup"><span data-stu-id="59f26-164">Routes need to be appropriately modified, to reflect that 192.168.1.0/24 has now moved to Azure.</span></span>

    ![После выполнения отработки отказа подсети](./media/vmm-to-azure-walkthrough-network/network-design9.png)

### <a name="after-failover"></a><span data-ttu-id="59f26-166">После выполнения отработки отказа</span><span class="sxs-lookup"><span data-stu-id="59f26-166">After failover</span></span>

<span data-ttu-id="59f26-167">Если у вас нет сети Azure, как показано на рисунке выше, то после отработки отказа можно создать VPN-подключение типа "сеть — сеть" между основным сайтом и Azure.</span><span class="sxs-lookup"><span data-stu-id="59f26-167">If you don't have an Azure network as illustrated above, you can create a site-to-site VPN connection between your primary site and Azure, after failvoer.</span></span>

## <a name="change-ip-addresses"></a><span data-ttu-id="59f26-168">Изменение IP-адресов</span><span class="sxs-lookup"><span data-stu-id="59f26-168">Change IP addresses</span></span>

<span data-ttu-id="59f26-169">В этой [записи блога](http://azure.microsoft.com/blog/2014/09/04/networking-infrastructure-setup-for-microsoft-azure-as-a-disaster-recovery-site/) описывается, как настроить сетевую инфраструктуру Azure, если нет необходимости сохранять IP-адреса после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="59f26-169">This [blog post](http://azure.microsoft.com/blog/2014/09/04/networking-infrastructure-setup-for-microsoft-azure-as-a-disaster-recovery-site/) explains how to set up the Azure networking infrastructure when you don't need to retain IP addresses after failover.</span></span> <span data-ttu-id="59f26-170">Она начинается с описания приложения, затем рассматривается настройка сети в локальной среде и среде Azure, а в конце приводятся сведения о выполнении отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="59f26-170">It starts with an application description, looks at how to set up networking on-premises and in Azure, and concludes with information about running failovers.</span></span>  

## <a name="next-steps"></a><span data-ttu-id="59f26-171">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="59f26-171">Next steps</span></span>

<span data-ttu-id="59f26-172">Перейдите к статье [Шаг 5. Подготовка ресурсов Azure для репликации Hyper-V в Azure](vmm-to-azure-walkthrough-prepare-azure.md).</span><span class="sxs-lookup"><span data-stu-id="59f26-172">Go to [Step 5: Prepare Azure](vmm-to-azure-walkthrough-prepare-azure.md)</span></span>

---
title: "Отработка отказа в Site Recovery | Документация Майкрософт"
description: "Azure Site Recovery координирует репликацию, отработку отказа и восстановление виртуальных машин и физических серверов. Узнайте о функции отработки отказа с выполнением переноса в Azure или в дополнительный центр обработки данных."
services: site-recovery
documentationcenter: 
author: prateek9us
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 07/04/2017
ms.author: pratshar
ms.openlocfilehash: ef586191f0b89dca89810644d45503fe42538635
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="failover-in-site-recovery"></a>Отработка отказа в Site Recovery
В этой статье описывается отработка отказа для виртуальных машин и физических серверов, защищаемых службой Site Recovery.

## <a name="prerequisites"></a>Предварительные требования
1. Перед выполнением отработки отказа выполните [тестовую отработку отказа](site-recovery-test-failover-to-azure.md) и убедитесь, что все работает правильно.
1. [Подготовьте сеть](site-recovery-network-design.md) в конечном расположении перед отработкой отказа.  


## <a name="run-a-failover"></a>Запуск отработки отказа
В этой процедуре описывается, как запустить отработку отказа для [плана восстановления](site-recovery-create-recovery-plans.md). В качестве альтернативы можно запустить отработку отказа для одной виртуальной машины или физического сервера на странице **Реплицированные элементы**.


![Отработка отказа](./media/site-recovery-failover/Failover.png)

1. Выберите **Планы восстановления** > *имя_плана_восстановления*. Щелкните **Отработка отказа**.
2. На странице **Отработка отказа** выберите **точку восстановления**, в которую будет выполнена отработка отказа. Можно выбрать один из следующих вариантов:
    1.  **Latest** (Последняя) — используется по умолчанию. В этом варианте сначала обрабатываются все данные, отправленные в службу Site Recovery, чтобы создать точку восстановления для каждой виртуальной машины, в которую затем выполняется отработка отказа. Этот вариант обеспечивает самое низкое значение RPO (целевая точка восстановления), так как виртуальная машина, созданная после отработки отказа, будет иметь все данные, реплицированные в службу Site Recovery до момента активации отработки отказа.
    1.  **Latest processed** (Последняя обработанная). В этом варианте отработка отказа всех виртуальных машин плана восстановления выполняется до последней точки восстановления из числа уже обработанных службой Site Recovery. При выполнении тестовой отработки отказа виртуальной машины также отображается метка времени последней обработанной точки восстановления. Если отработка отказа выполняется по плану восстановления, вы можете перейти к отдельной виртуальной машине и просмотреть плитку **Последняя точка восстановления** для получения этих сведений. Так как на обработку необработанных данных время не тратится, то этот вариант обеспечивает низкий показатель RTO (целевое время восстановления).
    1.  **Latest app-consistent** (Последняя с согласованием приложений). При этом варианте отработка отказа всех виртуальных машин плана восстановления выполняется до последней точки восстановления с согласованием приложений, которая уже была обработана службой Site Recovery. При выполнении тестовой отработки отказа виртуальной машины также отображается метка времени последней обработанной точки восстановления с согласованием приложений. Если отработка отказа выполняется по плану восстановления, вы можете перейти к отдельной виртуальной машине и просмотреть плитку **Последняя точка восстановления** для получения этих сведений.
    1.  **Последняя обработанная точка нескольких виртуальных машин**. Этот параметр доступен только для планов восстановления, которые содержат по крайней мере одну виртуальную машину с поддержкой согласованности нескольких виртуальных машин. Виртуальные машины, которые являются частью группы репликации, выполняют отработку отказа до последней согласованной точки восстановления, общей для нескольких виртуальных машин. Остальные виртуальные машины выполняют отработку отказа до последней обработанной точки восстановления.  
    1.  **Последняя согласованная с приложением точка нескольких виртуальных машин**. Этот параметр доступен только для планов восстановления, которые содержат по крайней мере одну виртуальную машину с поддержкой согласованности нескольких виртуальных машин. Виртуальные машины, которые являются частью группы репликации, выполняют отработку отказа до последней согласованной с приложением точки восстановления, общей для нескольких виртуальных машин. Остальные виртуальные машины выполняют отработку отказа до последней точки восстановления, согласованной с приложением.
    1.  **Custom** (Настраиваемая). Если вы выполняете тестовую отработку отказа виртуальной машины, можете использовать этот вариант для отработки отказа в определенную точку восстановления.

    > [!NOTE]
    > Выбор точки восстановления доступен только в том случае, если отработка отказа выполняется в Azure.
    >
    >


1. Если для некоторых виртуальных машин из плана восстановления отработка отказа уже была выполнена во время предыдущего запуска и теперь они активны и в исходном, и в целевом расположениях, примените вариант **Change direction** (Изменить направление). Он позволяет выбрать, в каком направлении выполняется отработка отказа.
1. Если при отработке отказа с переносом в Azure включена функция шифрования данных для облака (это применимо только для защиты виртуальных машин Hyper-V, размещенных на сервере VMM), в разделе **Ключ шифрования** выберите сертификат, который был выдан при включении шифрования данных во время настройки VMM-сервера.
1. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**, чтобы служба Site Recovery попыталась выключить исходные виртуальные машины, прежде чем запускать отработку отказа. Отработка отказа продолжится, даже если их не удастся отключить.  

    > [!NOTE]
    > Если этот параметр указан для виртуальных машин Hyper-V, то перед отработкой отказа будет также выполнена попытка синхронизировать локальные данные, которые еще не были отправлены в службу.
    >
    >

1. На странице **Задания** можно следить за ходом выполнения отработки отказа. Даже если во время незапланированной отработки отказа возникнут ошибки, план восстановления будет продолжать выполняться до полного завершения.
1. После отработки отказа войдите на виртуальную машину, чтобы проверить ее работу. Если вы хотите использовать для виртуальной машины другую точку восстановления, выберите команду **Изменить точку восстановления**.
1. Когда вы убедитесь, что после отработки отказа виртуальная машина работает правильно, **зафиксируйте** отработку отказа. Этот процесс удаляет все точки восстановления, доступные в службе, и вариант **Изменить точку восстановления** становится недоступен.

## <a name="planned-failover"></a>Плановая отработка отказа
Помимо отработки отказа, для виртуальных машин Hyper-V, защищенных с помощью Site Recovery, доступен вариант **Плановая отработка отказа**. В этом варианте потеря данных исключается. Когда выполняется плановая отработка отказа, сначала завершается работа исходных виртуальных машин, затем синхронизируются данные, которые еще не синхронизированы, и лишь затем запускается отработка отказа.

> [!NOTE]
> Если вы выполнили отработку отказа виртуальных машин Hyper-V с одного локального сайта на другой локальный сайт, то для возвращения на первичный сайт сначала следует выполнить **обратную репликацию** виртуальной машины на первичный сайт, а затем запустить отработку отказа. Если первичная виртуальная машина недоступна, то перед запуском **обратной репликации** необходимо восстановить виртуальную машину из резервной копии.   
>
>

## <a name="failover-job"></a>Задание отработки отказа

![Отработка отказа](./media/site-recovery-failover/FailoverJob.png)

Выполнение отработки отказа включает следующие этапы.

1. Проверка необходимых компонентов. На этом этапе вы проверяете, соблюдены ли все условия, необходимые для отработки отказа.
1. Отработка отказа. На этом этапе данные обрабатываются и подготавливаются для создания виртуальной машины Azure. Если вы выбрали **последнюю** точку восстановления, на этом этапе создается точка восстановления на основе данных, отправленных в службу.
1. Запуск. Теперь создается виртуальная машина Azure с использованием данных, обработанных на предыдущем этапе.

> [!WARNING]
> **Не отменяйте уже начатую отработку отказа.** Перед началом отработки отказа останавливается репликация виртуальной машины. Если вы **отмените** выполняемое задание, отработка отказа остановится, но репликация виртуальной машины не возобновится. Репликацию невозможно запустить повторно.
>
>

## <a name="time-taken-for-failover-to-azure"></a>Время, необходимое для отработки отказа в Azure

В некоторых случаях для отработки отказа виртуальных машин требуется дополнительный промежуточный шаг, который обычно длится 8–10 минут. Эти случаи перечислены ниже:

* виртуальные машины VMware, использующие службу Mobility Service версии ниже 9.8;
* физические серверы; 
* виртуальные машины VMware на платформе Linux;
* виртуальные машины Hyper-V, защищенные как физические серверы;
* виртуальные машины VMware, на которых отсутствуют следующие драйверы в качестве драйверов загрузки: 
    * storvsc; 
    * vmbus; 
    * storflt; 
    * intelide; 
    * atapi;
* виртуальные машины VMware, на которых не включена служба DHCP, вне зависимости от того, используется протокол DHCP или статические IP-адреса.

Во всех остальных случаях этот промежуточный шаг не обязателен, а время, необходимое для отработки отказа, значительно ниже. 





## <a name="using-scripts-in-failover"></a>Использование скриптов при отработке отказа
Вы можете автоматизировать некоторые действия, выполняемые при отработке отказа. Для этого можно включить в [планы восстановления](site-recovery-create-recovery-plans.md) скрипты или [модули Runbook службы автоматизации Azure](site-recovery-runbook-automation.md).

## <a name="other-considerations"></a>Дополнительные рекомендации
* **Буква диска.** Чтобы сохранить буквы дисков на виртуальных машинах после отработки отказа, укажите значение **OnlineAll** в **политике SAN** для виртуальной машины. [Подробная информация](https://support.microsoft.com/en-us/help/3031135/how-to-preserve-the-drive-letter-for-protected-virtual-machines-that-are-failed-over-or-migrated-to-azure).



## <a name="next-steps"></a>Дальнейшие действия
Когда завершится отработка отказа виртуальных машин и локальный центр обработки данных снова станет доступен, примените [**повторную защиту**](site-recovery-how-to-reprotect.md) виртуальных машин VMware в локальном центре обработки данных.

Затем используйте вариант [**Плановая отработка отказа**](site-recovery-failback-from-azure-to-hyper-v.md), чтобы **восстановить размещение** виртуальных машин Hyper-V из Azure обратно в локальную среду.

Если отработка отказа для виртуальной машины Hyper-V была выполнена в другой локальный центр обработки данных под управлением сервера VMM, то после возобновления работы основного центра обработки данных можно применить вариант **Обратная репликация**, чтобы начать репликацию в основной центр обработки данных.

---
title: "Восстановление размещения виртуальных машин VMware из Azure в локальную среду | Документация Майкрософт"
description: "Сведения о восстановлении размещения на локальном сайте после отработки отказа виртуальных машин VMware и физических серверов с переносом в Azure."
services: site-recovery
documentationcenter: 
author: ruturaj
manager: mkjain
editor: 
ms.assetid: 5a47337f-89a9-43e8-8fdc-7da373c0fb0f
ms.service: site-recovery
ms.devlang: na
ms.tgt_pltfrm: na
ms.topic: article
ms.workload: storage-backup-recovery
ms.date: 03/27/2017
ms.author: ruturajd
ms.openlocfilehash: dde0bb6b4f6bc10afdd7d40adc6689d42b37de81
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="fail-back-vmware-virtual-machines-and-physical-servers-to-the-on-premises-site"></a><span data-ttu-id="2bccd-103">Восстановление размещения виртуальных машин VMware и физических серверов на локальном сайте</span><span class="sxs-lookup"><span data-stu-id="2bccd-103">Fail back VMware virtual machines and physical servers to the on-premises site</span></span>


<span data-ttu-id="2bccd-104">В этой статье описывается, как восстановить размещение виртуальных машин Azure из Azure на локальный сайт.</span><span class="sxs-lookup"><span data-stu-id="2bccd-104">This article describes how to failback Azure virtual machines from Azure to the on-premises site.</span></span> <span data-ttu-id="2bccd-105">Когда вы будете готовы к восстановлению размещения виртуальных машин VMware или физических серверов Windows либо Linux после того, как вы восстановили их защиту, следуя инструкциям в этом [руководстве](site-recovery-how-to-reprotect.md), выполните инструкции в этой статье.</span><span class="sxs-lookup"><span data-stu-id="2bccd-105">Follow the instructions here when you're ready to fail back your VMware virtual machines or Windows or Linux physical servers after you have re-protected your machines using this [reference](site-recovery-how-to-reprotect.md).</span></span>

>[!NOTE]
><span data-ttu-id="2bccd-106">Если вы используете классический портал Azure, ознакомьтесь с приведенными [здесь](site-recovery-failback-azure-to-vmware-classic.md) инструкциями для расширенной архитектуры восстановления размещения VMware из Azure и с [этими](site-recovery-failback-azure-to-vmware-classic-legacy.md) инструкциями для устаревшей архитектуры.</span><span class="sxs-lookup"><span data-stu-id="2bccd-106">If you are using the classic Azure portal, please refer to instructions mentioned [here](site-recovery-failback-azure-to-vmware-classic.md) for enhanced VMware to Azure architecture and [here](site-recovery-failback-azure-to-vmware-classic-legacy.md) for the legacy architecture</span></span>

## <a name="overview"></a><span data-ttu-id="2bccd-107">Обзор</span><span class="sxs-lookup"><span data-stu-id="2bccd-107">Overview</span></span>
<span data-ttu-id="2bccd-108">На схеме в этом разделе показана архитектура восстановления размещения для этого сценария.</span><span class="sxs-lookup"><span data-stu-id="2bccd-108">The diagrams in this section show the failback architecture for this scenario.</span></span>

<span data-ttu-id="2bccd-109">Используйте эту архитектуру, когда сервер обработки является локальным и вы используете подключение Azure ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="2bccd-109">When the Process Server is on-premises and you are using an Azure ExpressRoute connection, use this architecture:</span></span>

![Схема архитектуры для ExpressRoute](./media/site-recovery-failback-azure-to-vmware-classic/architecture.png)

<span data-ttu-id="2bccd-111">Используйте эту архитектуру, когда сервер обработки находится в Azure и используется подключение VPN или ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="2bccd-111">When the Process Server is on Azure and you have either a VPN or an ExpressRoute connection, use this architecture:</span></span>

![Схема архитектуры для VPN](./media/site-recovery-failback-azure-to-vmware-classic/architecture2.png)

<span data-ttu-id="2bccd-113">С полным списком портов и схемой архитектуры восстановления размещения можно ознакомиться на рисунке ниже.</span><span class="sxs-lookup"><span data-stu-id="2bccd-113">For a complete list of ports and the failback architecture diagram, refer to the following image:</span></span>

![Список всех портов для отработки отказа и восстановления размещения](./media/site-recovery-failback-azure-to-vmware-classic/Failover-Failback.png)

<span data-ttu-id="2bccd-115">Восстановление размещения на локальном сайте после отработки отказа в Azure происходит в три этапа.</span><span class="sxs-lookup"><span data-stu-id="2bccd-115">After you’ve failed over to Azure, you fail back to your on-premises site in three stages:</span></span>

* <span data-ttu-id="2bccd-116">**Этап 1**. Повторно включите защиту виртуальных машин Azure, чтобы они начали реплицироваться обратно в виртуальные машины VMware, запущенные на локальном сайте.</span><span class="sxs-lookup"><span data-stu-id="2bccd-116">**Stage 1**: You reprotect the Azure VMs so that they start replicating back to the VMware VMs that are running on your on-premises site.</span></span>
* <span data-ttu-id="2bccd-117">**Этап 2**. После репликации виртуальных машин Azure на локальный сайт выполните отработку отказа, чтобы восстановить размещение из Azure.</span><span class="sxs-lookup"><span data-stu-id="2bccd-117">**Stage 2**: After your Azure VMs are replicated to your on-premises site, you run a failover to fail back from Azure.</span></span>
* <span data-ttu-id="2bccd-118">**Этап 3**. После восстановления размещения данных повторно включите защиту локальных виртуальных машин, на которые выполнено восстановление размещения, чтобы они начали реплицироваться в Azure.</span><span class="sxs-lookup"><span data-stu-id="2bccd-118">**Stage 3**: After your data has failed back, you reprotect the on-premises VMs that you failed back to, so that they start replicating to Azure.</span></span>

### <a name="fail-back-to-the-original-location-or-an-alternate-location"></a><span data-ttu-id="2bccd-119">Восстановление размещения в исходном или альтернативном расположении</span><span class="sxs-lookup"><span data-stu-id="2bccd-119">Fail back to the original location or an alternate location</span></span>
<span data-ttu-id="2bccd-120">После отработки отказа виртуальной машины VMware восстановление размещения можно выполнить на той же исходной виртуальной машине, если она по-прежнему существует в локальной среде.</span><span class="sxs-lookup"><span data-stu-id="2bccd-120">After you fail over a VMware VM, you can fail back to the same source VM if it still exists on-premises.</span></span> <span data-ttu-id="2bccd-121">В этом случае будет выполнено восстановление размещения только изменившихся данных.</span><span class="sxs-lookup"><span data-stu-id="2bccd-121">In this scenario, only the deltas are failed back.</span></span>

<span data-ttu-id="2bccd-122">При отработке отказа физических серверов восстановление размещения всегда выполняется на новой виртуальной машине VMware.</span><span class="sxs-lookup"><span data-stu-id="2bccd-122">If you failed over physical servers, failback is always to a new VMware VM.</span></span> <span data-ttu-id="2bccd-123">Перед восстановлением размещения на физический компьютер обратите внимание на следующее.</span><span class="sxs-lookup"><span data-stu-id="2bccd-123">Before failing back a physical machine, note that:</span></span>
* <span data-ttu-id="2bccd-124">Защищенный физический компьютер будет восстановлен как виртуальная машина при восстановлении размещения из Azure в VMware.</span><span class="sxs-lookup"><span data-stu-id="2bccd-124">A protected physical machine will come back as a virtual machine when it is failed over back from Azure to VMware.</span></span> <span data-ttu-id="2bccd-125">Если защищенный физический компьютер под управлением Windows Server 2008 R2 с пакетом обновления 1 (SP1) выполнил отработку отказа в Azure, то он не будет восстановлен в исходном расположении.</span><span class="sxs-lookup"><span data-stu-id="2bccd-125">A Windows Server 2008 R2 SP1 physical machine, if it is protected and failed over to Azure, cannot be failed back.</span></span> <span data-ttu-id="2bccd-126">Возможно восстановление размещения компьютера Windows Server 2008 R2 с пакетом обновления 1 (SP1), запущенного как локальная виртуальная машина.</span><span class="sxs-lookup"><span data-stu-id="2bccd-126">A Windows Server 2008 R2 SP1 machine that started as a virtual machine on-premises will be able to fail back.</span></span>
* <span data-ttu-id="2bccd-127">Убедитесь, что у вас есть хотя бы один главный целевой сервер и необходимые узлы ESX/ESXi, на которых необходимо восстановить размещение.</span><span class="sxs-lookup"><span data-stu-id="2bccd-127">Ensure that you discover at least one master target server along with the necessary ESX/ESXi hosts that you need to fail back to.</span></span>

<span data-ttu-id="2bccd-128">Для восстановления размещения на исходной виртуальной машине должны быть выполнены следующие условия.</span><span class="sxs-lookup"><span data-stu-id="2bccd-128">If you fail back to the original VM, the following are required:</span></span>

* <span data-ttu-id="2bccd-129">Если виртуальной машиной управляет сервер vCenter, то узел ESX главного целевого сервера должен иметь доступ к хранилищу данных виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="2bccd-129">If the VM is managed by a vCenter server, the master target's ESX host should have access to the VMs datastore.</span></span>
* <span data-ttu-id="2bccd-130">Если виртуальная машина находится на узле ESX, но не управляется с помощью vCenter, жесткий диск виртуальной машины должен находиться в хранилище данных, доступном узлу главного целевого сервера.</span><span class="sxs-lookup"><span data-stu-id="2bccd-130">If the VM is on an ESX host but isn’t managed by vCenter, the hard disk of the VM must be in a datastore that's accessible by the MT's host.</span></span>
* <span data-ttu-id="2bccd-131">Если виртуальная машина находится на узле ESX и не использует vCenter, прежде чем повторно включить защиту, следует выполнить обнаружение узла ESX главного целевого сервера.</span><span class="sxs-lookup"><span data-stu-id="2bccd-131">If your VM is on an ESX host and doesn't use vCenter, you should complete discovery of the ESX host of the MT before you reprotect.</span></span> <span data-ttu-id="2bccd-132">Это применимо, если выполняется восстановление размещения и для физических серверов.</span><span class="sxs-lookup"><span data-stu-id="2bccd-132">This applies if you're failing back physical servers too.</span></span>
* <span data-ttu-id="2bccd-133">Второй вариант — при наличии локальной виртуальной машины удалите ее, прежде чем выполнить восстановление размещения.</span><span class="sxs-lookup"><span data-stu-id="2bccd-133">Another option (if the on-premises VM exists) is to delete it before you do a failback.</span></span> <span data-ttu-id="2bccd-134">Затем служба восстановления размещения создаст новую виртуальную машину на том же узле, где находится главный целевой узел ESX.</span><span class="sxs-lookup"><span data-stu-id="2bccd-134">Failback then creates a new VM on the same host as the master target ESX host.</span></span>

<span data-ttu-id="2bccd-135">Если восстановление размещения выполняется в альтернативном расположении, данные будут восстановлены в то же хранилище данных и тот же узел ESX, которые использует локальный главный целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="2bccd-135">When you fail back to an alternate location, the data is recovered to the same datastore and the same ESX host as that used by the on-premises master target server.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="2bccd-136">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="2bccd-136">Prerequisites</span></span>
* <span data-ttu-id="2bccd-137">Для восстановления размещения виртуальных машин VMware и физических серверов требуется среда VMware.</span><span class="sxs-lookup"><span data-stu-id="2bccd-137">To fail back VMware VMs and physical servers, you need a VMware environment.</span></span> <span data-ttu-id="2bccd-138">Восстановление размещения на физическом сервере не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="2bccd-138">Failing back to a physical server isn’t supported.</span></span>
* <span data-ttu-id="2bccd-139">Для восстановления размещения при первоначальной настройке защиты необходимо создать сеть Azure.</span><span class="sxs-lookup"><span data-stu-id="2bccd-139">To fail back, you must have created an Azure network when you initially set up protection.</span></span> <span data-ttu-id="2bccd-140">Восстановление размещения требует подключения VPN или ExpressRoute к локальному сайту через сеть Azure, в которой расположены виртуальные машины Azure.</span><span class="sxs-lookup"><span data-stu-id="2bccd-140">Failback needs a VPN or ExpressRoute connection from the Azure network in which the Azure VMs are located to the on-premises site.</span></span>
* <span data-ttu-id="2bccd-141">Если виртуальные машины, для которых необходимо выполнить восстановление размещения, управляются с помощью сервера vCenter, убедитесь в наличии требуемых разрешений для обнаружения виртуальных машин на серверах vCenter.</span><span class="sxs-lookup"><span data-stu-id="2bccd-141">If the VMs that you want to fail back to are managed by a vCenter server, make sure that you have the required permissions for discovery of VMs on vCenter servers.</span></span> <span data-ttu-id="2bccd-142">Дополнительные сведения см. в разделе [Репликация виртуальных машин VMware и физических серверов в Azure с помощью службы Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="2bccd-142">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span></span>
* <span data-ttu-id="2bccd-143">Если на виртуальной машине есть моментальные снимки, произойдет сбой повторного включения защиты.</span><span class="sxs-lookup"><span data-stu-id="2bccd-143">If snapshots are present on a VM, reprotection fails.</span></span> <span data-ttu-id="2bccd-144">Моментальные снимки или диски можно удалить.</span><span class="sxs-lookup"><span data-stu-id="2bccd-144">You can delete the snapshots or the disks.</span></span>
* <span data-ttu-id="2bccd-145">Прежде чем выполнять восстановление размещения, создайте следующие компоненты.</span><span class="sxs-lookup"><span data-stu-id="2bccd-145">Before you fail back, create these components:</span></span>
  * <span data-ttu-id="2bccd-146">**Создайте сервер обработки в Azure**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-146">**Create a Process Server in Azure**.</span></span> <span data-ttu-id="2bccd-147">Это виртуальная машина Azure, которую необходимо создать и запустить во время восстановления размещения.</span><span class="sxs-lookup"><span data-stu-id="2bccd-147">This component is an Azure VM that you create and keep running during failback.</span></span> <span data-ttu-id="2bccd-148">После завершения восстановления размещения ее можно удалить.</span><span class="sxs-lookup"><span data-stu-id="2bccd-148">You can delete the VM after failback is complete.</span></span>
  * <span data-ttu-id="2bccd-149">**Создайте главный целевой сервер**. Этот сервер отправляет и получает данные восстановления размещения.</span><span class="sxs-lookup"><span data-stu-id="2bccd-149">**Create a master target server**: The master target server sends and receives failback data.</span></span> <span data-ttu-id="2bccd-150">На сервере управления, созданном локально, главный целевой сервер установлен по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="2bccd-150">The management server that you created on-premises has a master target server that's installed by default.</span></span> <span data-ttu-id="2bccd-151">Но в зависимости от объема трафика восстановления размещения для него может потребоваться создать отдельный главный целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="2bccd-151">However, depending on the volume of failed-back traffic, you might need to create a separate master target server for failback.</span></span>
  * <span data-ttu-id="2bccd-152">Чтобы создать дополнительный главный целевой сервер под управлением Linux, прежде чем установить главный целевой сервер, настройте виртуальную машину Linux, как описано ниже.</span><span class="sxs-lookup"><span data-stu-id="2bccd-152">To create an additional master target server that runs on Linux, set up the Linux VM before you install the master target server, as described later.</span></span>
* <span data-ttu-id="2bccd-153">При восстановлении размещения в локальной среде должен быть сервер конфигурации.</span><span class="sxs-lookup"><span data-stu-id="2bccd-153">A configuration server is required on-premises when you do a failback.</span></span> <span data-ttu-id="2bccd-154">Во время восстановления размещения виртуальная машина должна существовать в базе данных сервера конфигурации.</span><span class="sxs-lookup"><span data-stu-id="2bccd-154">During failback, the virtual machine must exist in the configuration server database.</span></span> <span data-ttu-id="2bccd-155">Если база данных сервера конфигурации не содержит виртуальную машину, то выполнить восстановление размещения не удастся.</span><span class="sxs-lookup"><span data-stu-id="2bccd-155">If the configuration server database contains no VM, failback cannot succeed.</span></span> <span data-ttu-id="2bccd-156">Следовательно, необходимо обеспечить регулярную плановую архивацию сервера.</span><span class="sxs-lookup"><span data-stu-id="2bccd-156">Therefore, ensure that you make regular scheduled backups of your server.</span></span> <span data-ttu-id="2bccd-157">В случае аварии потребуется восстановить сервер с тем же IP-адресом, чтобы обеспечить возможность восстановление размещения.</span><span class="sxs-lookup"><span data-stu-id="2bccd-157">In a disaster, you need to restore it with the same IP address so that failback works.</span></span>
* <span data-ttu-id="2bccd-158">В разделе **Параметры конфигурации** главной целевой виртуальной машины в VMware установите для параметра disk.enableUUID значение true.</span><span class="sxs-lookup"><span data-stu-id="2bccd-158">Set the disk.enableUUID=true setting in **Configuration Parameters** of the master target VM in VMware.</span></span> <span data-ttu-id="2bccd-159">Если этого параметра нет, добавьте его.</span><span class="sxs-lookup"><span data-stu-id="2bccd-159">If this row does not exist, add it.</span></span> <span data-ttu-id="2bccd-160">Этот параметр необходим, чтобы предоставить согласованный универсальный уникальный идентификатор (UUID) для файла диска виртуальной машины (VMDK-файл). Он обеспечит его правильное подключение.</span><span class="sxs-lookup"><span data-stu-id="2bccd-160">This setting is required to provide a consistent universally unique identifier (UUID) to the virtual machine disk (VMDK) file so that it is mounted correctly.</span></span>
* <span data-ttu-id="2bccd-161">Помните об условии "Главный целевой сервер невозможно перенести в хранилище с помощью vMotion", что может привести к сбою восстановления размещения.</span><span class="sxs-lookup"><span data-stu-id="2bccd-161">Be aware of a "Master target server cannot be storage vMotioned" condition, which can cause the failback to fail.</span></span> <span data-ttu-id="2bccd-162">Виртуальная машина не появится, так как у нее нет дисков.</span><span class="sxs-lookup"><span data-stu-id="2bccd-162">The VM cannot come up because the disks aren't made available to it.</span></span>
* <span data-ttu-id="2bccd-163">Добавьте на главный целевой сервер диск хранения.</span><span class="sxs-lookup"><span data-stu-id="2bccd-163">Add a drive, called a retention drive, onto the master target server.</span></span> <span data-ttu-id="2bccd-164">Добавив этот диск, отформатируйте его.</span><span class="sxs-lookup"><span data-stu-id="2bccd-164">Add a disk, and format the drive.</span></span>

## <a name="failback-policy"></a><span data-ttu-id="2bccd-165">Политика восстановления размещения</span><span class="sxs-lookup"><span data-stu-id="2bccd-165">Failback policy</span></span>
<span data-ttu-id="2bccd-166">Для репликации данных обратно в локальную среду требуется политика восстановления размещения.</span><span class="sxs-lookup"><span data-stu-id="2bccd-166">To replicate back to on-premises, you need a failback policy.</span></span> <span data-ttu-id="2bccd-167">Эта политика создается автоматически при создании политики направления переадресации и связывается с сервером конфигурации.</span><span class="sxs-lookup"><span data-stu-id="2bccd-167">The policy is automatically created when you create a forward direction policy, and it is automatically associated with the configuration server.</span></span> <span data-ttu-id="2bccd-168">Она не подлежит редактированию.</span><span class="sxs-lookup"><span data-stu-id="2bccd-168">It is not editable.</span></span> <span data-ttu-id="2bccd-169">Политика содержит приведенные ниже параметры репликации.</span><span class="sxs-lookup"><span data-stu-id="2bccd-169">The policy has the following replication settings:</span></span>

* <span data-ttu-id="2bccd-170">Пороговое значение RPO: 15 минут.</span><span class="sxs-lookup"><span data-stu-id="2bccd-170">RPO threshold = 15 minutes</span></span>
* <span data-ttu-id="2bccd-171">Хранение точки восстановления: 24 часа.</span><span class="sxs-lookup"><span data-stu-id="2bccd-171">Recovery point retention = 24 hours</span></span>
* <span data-ttu-id="2bccd-172">Периодичность создания моментальных снимков с согласованием приложений: 60 минут.</span><span class="sxs-lookup"><span data-stu-id="2bccd-172">App consistent snapshot frequency = 60 minutes</span></span>

 ![Параметры репликации политики восстановления размещения](./media/site-recovery-failback-azure-to-vmware-new/failback-policy.png)

## <a name="set-up-a-process-server-in-azure"></a><span data-ttu-id="2bccd-174">Настройка сервера обработки в Azure</span><span class="sxs-lookup"><span data-stu-id="2bccd-174">Set up a Process Server in Azure</span></span>
<span data-ttu-id="2bccd-175">Чтобы виртуальные машины Azure могли отправлять данные на локальный главный целевой сервер, в Azure необходимо установить сервер обработки.</span><span class="sxs-lookup"><span data-stu-id="2bccd-175">Install a Process Server in Azure so that the Azure VMs can send the data back to the on-premises master target server.</span></span>

<span data-ttu-id="2bccd-176">Если вы защитили свои виртуальные машины как классические ресурсы (т. е. виртуальная машина, восстановленная в Azure, использует классическую модель развертывания), то вам требуется сервер обработки в Azure.</span><span class="sxs-lookup"><span data-stu-id="2bccd-176">If you have protected your virtual machines as classic resources (that is, the VM recovered in Azure is a VM that was created by using the classic deployment model), you need a Process Server in Azure.</span></span> <span data-ttu-id="2bccd-177">Если для восстановления виртуальных машин используется развертывание с помощью Azure Resource Manager, то этот же тип развертывания должен использовать и сервер обработки.</span><span class="sxs-lookup"><span data-stu-id="2bccd-177">If you have recovered the VMs with Azure Resource Manager as the deployment type, the Process Server must have Resource Manager as the deployment type.</span></span> <span data-ttu-id="2bccd-178">Выбор типа развертывания зависит от того, в какой виртуальной сети Azure развертывается сервер обработки.</span><span class="sxs-lookup"><span data-stu-id="2bccd-178">The deployment type is selected by the Azure virtual network that you deploy the Process Server to.</span></span>

1. <span data-ttu-id="2bccd-179">Выберите **Хранилище** > **Параметры** > **Site Recovery Infrastructure** (Инфраструктура Site Recovery) (в разделе **Управление**) и щелкните **Серверы конфигурации** (в разделе **For VMware and Physical Machines** (Для виртуальных машин VMware и физических компьютеров)), затем выберите сервер конфигурации.</span><span class="sxs-lookup"><span data-stu-id="2bccd-179">In **Vault** > **Settings** > **Site Recovery Infrastructure** (under **Manage**) > **Configuration Servers** (under **For VMware and Physical Machines**), select the configuration server.</span></span>
2. <span data-ttu-id="2bccd-180">Щелкните **Сервер обработки**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-180">Click **Process Server**.</span></span>

  ![Кнопка "Сервер обработки"](./media/site-recovery-failback-azure-to-vmware-classic/add-processserver.png)
3. <span data-ttu-id="2bccd-182">Выберите для развертывания сервера обработки параметр **Deploy a failback process server in Azure** (Развернуть сервер обработки для восстановления размещения в Azure).</span><span class="sxs-lookup"><span data-stu-id="2bccd-182">Choose to deploy the Process Server as **Deploy a failback Process Server in Azure**.</span></span>
4. <span data-ttu-id="2bccd-183">Выберите подписку, в которую вы восстановили виртуальные машины.</span><span class="sxs-lookup"><span data-stu-id="2bccd-183">Select the subscription that you have recovered the VMs to.</span></span>
5. <span data-ttu-id="2bccd-184">Выберите сеть Azure, в которую вы восстановили виртуальные машины.</span><span class="sxs-lookup"><span data-stu-id="2bccd-184">Select the Azure network that you have recovered the VMs to.</span></span> <span data-ttu-id="2bccd-185">Сервер обработки должен находиться в той же сети, чтобы восстановленные виртуальные машины и сервер обработки могли обмениваться данными.</span><span class="sxs-lookup"><span data-stu-id="2bccd-185">The Process Server needs to be in the same network so that the recovered VMs and the Process Server can communicate.</span></span>
6. <span data-ttu-id="2bccd-186">Если вы выбрали сеть с *классической моделью развертывания*, создайте виртуальную машину с помощью Azure Marketplace, а затем установите на нее сервер обработки.</span><span class="sxs-lookup"><span data-stu-id="2bccd-186">If you selected a *classic deployment model* network, create a VM via the Azure Marketplace, and then install the Process Server in it.</span></span>

 ![Окно "Добавление сервера обработки"](./media/site-recovery-failback-azure-to-vmware-classic/add-classic.png)

 <span data-ttu-id="2bccd-188">При создании сервера обработки обратите внимание на следующее.</span><span class="sxs-lookup"><span data-stu-id="2bccd-188">As you're creating the Process Server, pay attention to the following:</span></span>
 * <span data-ttu-id="2bccd-189">Имя нужного вам образа — *Microsoft Azure Site Recovery Process Server V2*.</span><span class="sxs-lookup"><span data-stu-id="2bccd-189">The name of the image is *Microsoft Azure Site Recovery Process Server V2*.</span></span> <span data-ttu-id="2bccd-190">Выберите **классическую** модель развертывания.</span><span class="sxs-lookup"><span data-stu-id="2bccd-190">Select **Classic** as the deployment model.</span></span>

       ![Select "Classic" as the Process Server deployment model](./media/site-recovery-failback-azure-to-vmware-classic/templatename.png)
 * <span data-ttu-id="2bccd-191">Установите сервер обработки согласно инструкциям в разделе [Репликация виртуальных машин VMware и физических серверов в Azure с помощью службы Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="2bccd-191">Install the Process Server according to the instructions in [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span></span>
7. <span data-ttu-id="2bccd-192">Если вы выбрали сеть Azure на основе *Resource Manager*, то для развертывания сервера обработки укажите приведенную ниже информацию:</span><span class="sxs-lookup"><span data-stu-id="2bccd-192">If you select the *Resource Manager* Azure network, deploy the Process Server by providing the following information:</span></span>

  * <span data-ttu-id="2bccd-193">имя группы ресурсов для развертывания сервера;</span><span class="sxs-lookup"><span data-stu-id="2bccd-193">The name of the resource group that you want to deploy the server to</span></span>
  * <span data-ttu-id="2bccd-194">имя сервера;</span><span class="sxs-lookup"><span data-stu-id="2bccd-194">The name of the server</span></span>
  * <span data-ttu-id="2bccd-195">имя пользователя и пароль для входа на сервер;</span><span class="sxs-lookup"><span data-stu-id="2bccd-195">A username and password for signing in to the server</span></span>
  * <span data-ttu-id="2bccd-196">учетная запись хранения, в которой нужно развернуть сервер;</span><span class="sxs-lookup"><span data-stu-id="2bccd-196">The storage account that you want to deploy the server to</span></span>
  * <span data-ttu-id="2bccd-197">подсеть и сетевая карта для подключения к ней.</span><span class="sxs-lookup"><span data-stu-id="2bccd-197">The subnet and the network interface that you want to connect to it</span></span>
   >[!NOTE]
   ><span data-ttu-id="2bccd-198">Вам потребуется создать свой собственный [сетевой интерфейс](../virtual-network/virtual-networks-multiple-nics.md) (сетевую карту) и выбрать его в процессе развертывания сервера обработки.</span><span class="sxs-lookup"><span data-stu-id="2bccd-198">You must create your own [network interface](../virtual-network/virtual-networks-multiple-nics.md) (NIC) and select it while you are deploying the Process Server.</span></span>

    ![Ввод сведений в диалоговом окне "Добавление сервера обработки"](./media/site-recovery-failback-azure-to-vmware-classic/psinputsadd.png)

8. <span data-ttu-id="2bccd-200">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-200">Click **OK**.</span></span> <span data-ttu-id="2bccd-201">Она активирует задание, которое создаст виртуальную машину Resource Manager во время настройки сервера обработки.</span><span class="sxs-lookup"><span data-stu-id="2bccd-201">This action triggers a job that creates a Resource Manager deployment type virtual machine during the Process Server setup.</span></span> <span data-ttu-id="2bccd-202">Чтобы зарегистрировать сервер на сервере конфигурации, выполните настройку в виртуальной машине, как описано в разделе [Репликация виртуальных машин VMware и физических серверов в Azure с помощью службы Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="2bccd-202">To register the server to the configuration server, run the setup inside the VM by following the instructions in [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span></span> <span data-ttu-id="2bccd-203">После этого также будет активировано задание для развертывания сервера обработки.</span><span class="sxs-lookup"><span data-stu-id="2bccd-203">A job to deploy the Process Server is also triggered.</span></span>

  <span data-ttu-id="2bccd-204">Сервер обработки указан на вкладке, которую можно просмотреть, выбрав **Серверы конфигурации** > **Связанные серверы** > **Серверы обработки**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-204">The Process Server is listed on the **Configuration servers** > **Associated servers** > **Process Servers** tab.</span></span>

    ![](./media/site-recovery-failback-azure-to-vmware-new/pslistingincs.png)

    > [!NOTE]
    > <span data-ttu-id="2bccd-205">Сервер обработки не отображается в **свойствах виртуальной машины**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-205">The Process Server isn't visible under **VM properties**.</span></span> <span data-ttu-id="2bccd-206">Он отображается только на вкладке **Серверы** для сервера управления, на котором он зарегистрирован.</span><span class="sxs-lookup"><span data-stu-id="2bccd-206">It's visible only on the **Servers** tab in the management server that it's registered to.</span></span> <span data-ttu-id="2bccd-207">Сервер обработки отобразится примерно через 10–15 минут.</span><span class="sxs-lookup"><span data-stu-id="2bccd-207">It can take 10 to 15 minutes for the Process Server to appear.</span></span>


## <a name="set-up-the-master-target-server-on-premises"></a><span data-ttu-id="2bccd-208">Локальная установка главного целевого сервера</span><span class="sxs-lookup"><span data-stu-id="2bccd-208">Set up the master target server on-premises</span></span>
<span data-ttu-id="2bccd-209">Главный целевой сервер принимает данные восстановления размещения.</span><span class="sxs-lookup"><span data-stu-id="2bccd-209">The master target server receives the failback data.</span></span> <span data-ttu-id="2bccd-210">Он автоматически устанавливается на локальном сервере управления, но при восстановлении размещения слишком большого объема данных может потребоваться настроить дополнительный главный целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="2bccd-210">The server is automatically installed on the on-premises management server, but if you're failing back too much data, you might need to set up an additional master target server.</span></span> <span data-ttu-id="2bccd-211">Чтобы настроить главный целевой сервер в локальной среде, сделайте следующее.</span><span class="sxs-lookup"><span data-stu-id="2bccd-211">To set up a master target server on-premises, do the following:</span></span>

> [!NOTE]
> <span data-ttu-id="2bccd-212">Чтобы настроить главный целевой сервер в Linux, перейдите к следующей процедуре.</span><span class="sxs-lookup"><span data-stu-id="2bccd-212">To set up a master target server on Linux, skip to the next procedure.</span></span> <span data-ttu-id="2bccd-213">В качестве операционной системы главного целевого сервера используйте только CentOS 6.6 с минимальным набором возможностей.</span><span class="sxs-lookup"><span data-stu-id="2bccd-213">Use only CentOS 6.6 minimal operating system as the master target OS.</span></span>

1. <span data-ttu-id="2bccd-214">Если вы настраиваете главный целевой сервер в Windows, откройте страницу быстрого запуска на виртуальной машине, на которую устанавливается главный целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="2bccd-214">If you're setting up the master target server on Windows, open the quick-start page from the VM that you're installing the master target server on.</span></span>
2. <span data-ttu-id="2bccd-215">Скачайте файл установки мастера единой установки Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="2bccd-215">Download the installation file for the Azure Site Recovery Unified Setup wizard.</span></span>
3. <span data-ttu-id="2bccd-216">Запустите программу установки и в окне **Перед началом работы** выберите **Add additional Process Servers to scale out deployment** (Добавить дополнительные серверы обработки для масштабирования развертывания).</span><span class="sxs-lookup"><span data-stu-id="2bccd-216">Run the setup and, in **Before you begin**, select **Add additional Process Servers to scale out deployment**.</span></span>
4. <span data-ttu-id="2bccd-217">Завершите работу мастера так же, как и при [настройке сервера управления](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="2bccd-217">Complete the wizard in the same way you did when you [set up the management server](site-recovery-vmware-to-azure-classic.md).</span></span> <span data-ttu-id="2bccd-218">На странице **Configuration Server Details** (Сведения о сервере конфигурации) укажите IP-адрес главного целевого сервера и парольную фразу для доступа к виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="2bccd-218">On the **Configuration Server Details** page, specify the IP address of the master target server, and enter a passphrase to access the VM.</span></span>

### <a name="set-up-a-linux-vm-as-the-master-target-server"></a><span data-ttu-id="2bccd-219">Настройка виртуальной машины Linux в качестве главного целевого сервера</span><span class="sxs-lookup"><span data-stu-id="2bccd-219">Set up a Linux VM as the master target server</span></span>
<span data-ttu-id="2bccd-220">Чтобы настроить сервер управления для главного целевого сервера в качестве виртуальной машины Linux, установите операционную систему CentOS 6.6 с минимальным набором возможностей.</span><span class="sxs-lookup"><span data-stu-id="2bccd-220">To set up the management server running the master target server as a Linux VM, install the CentOS 6.6 minimal operating system.</span></span> <span data-ttu-id="2bccd-221">Затем получите идентификаторы SCSI для каждого жесткого диска SCSI, установите необходимые дополнительные пакеты и примените пользовательские изменения.</span><span class="sxs-lookup"><span data-stu-id="2bccd-221">Next, retrieve the SCSI IDs for each SCSI hard disk, install some additional packages, and apply some custom changes.</span></span>

#### <a name="install-centos-66"></a><span data-ttu-id="2bccd-222">Установка CentOS 6.6</span><span class="sxs-lookup"><span data-stu-id="2bccd-222">Install CentOS 6.6</span></span>

1. <span data-ttu-id="2bccd-223">Установите операционную систему CentOS 6.6 с минимальным набором возможностей на виртуальной машине сервера управления.</span><span class="sxs-lookup"><span data-stu-id="2bccd-223">Install the CentOS 6.6 minimal operating system on the management server VM.</span></span> <span data-ttu-id="2bccd-224">Оставьте диск с ISO-файлом в DVD-дисководе и перезапустите систему.</span><span class="sxs-lookup"><span data-stu-id="2bccd-224">Keep the ISO on a DVD drive, and boot the system.</span></span> <span data-ttu-id="2bccd-225">Пропустите тестирование носителя.</span><span class="sxs-lookup"><span data-stu-id="2bccd-225">Skip the media testing.</span></span> <span data-ttu-id="2bccd-226">Выберите язык **US English** (Английский (США)), щелкните **Basic Storage Devices** (Основные устройства хранилища), убедитесь, что на жестком диске не содержатся важные данные, и нажмите кнопку **Yes** "Да", чтобы удалить все данные.</span><span class="sxs-lookup"><span data-stu-id="2bccd-226">Select **US English** as the language, select **Basic Storage Devices**, check that the hard drive doesn’t have any important data, click **Yes**, and discard any data.</span></span> <span data-ttu-id="2bccd-227">Введите имя узла сервера управления и выберите сетевой адаптер сервера.</span><span class="sxs-lookup"><span data-stu-id="2bccd-227">Enter the host name of the management server, and select the server network adapter.</span></span>  <span data-ttu-id="2bccd-228">В диалоговом окне **Editing System** (Изменение системы) выберите **Connect automatically** (Подключаться автоматически) и укажите статический IP-адрес, параметры сети и параметры DNS.</span><span class="sxs-lookup"><span data-stu-id="2bccd-228">In the **Editing System** dialog box, select **Connect automatically**, and then add a static IP address, network, and DNS settings.</span></span> <span data-ttu-id="2bccd-229">Укажите часовой пояс.</span><span class="sxs-lookup"><span data-stu-id="2bccd-229">Specify a time zone.</span></span> <span data-ttu-id="2bccd-230">Введите пароль привилегированного пользователя для доступа к серверу управления.</span><span class="sxs-lookup"><span data-stu-id="2bccd-230">To access the management server, enter the root password.</span></span>
2. <span data-ttu-id="2bccd-231">При выборе типа установки для раздела следует выбрать **Create Custom Layout** (Создать пользовательский макет).</span><span class="sxs-lookup"><span data-stu-id="2bccd-231">When you're asked what type of installation you want, select **Create Custom Layout** as the partition.</span></span> <span data-ttu-id="2bccd-232">Щелкните **Далее**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-232">Click **Next**.</span></span> <span data-ttu-id="2bccd-233">Выберите **Free** (Бесплатный) и нажмите кнопку **Create** (Создать).</span><span class="sxs-lookup"><span data-stu-id="2bccd-233">Select **Free**, and then click **Create**.</span></span> <span data-ttu-id="2bccd-234">Создайте разделы **/**, **/var/crash** и **/home** с **типом файловой системы** **ext4**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-234">Create **/**,  **/var/crash**, and **/home partitions** with **FS Type:** **ext4**.</span></span> <span data-ttu-id="2bccd-235">Создайте секцию подкачки с типом файловой системы **swap**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-235">Create the swap partition as **FS Type: swap**.</span></span>
3. <span data-ttu-id="2bccd-236">При наличии существующих устройств появится предупреждающее сообщение.</span><span class="sxs-lookup"><span data-stu-id="2bccd-236">If pre-existing devices are found, a warning message appears.</span></span> <span data-ttu-id="2bccd-237">Щелкните **Форматировать** , чтобы отформатировать диск с заданными параметрами разделов.</span><span class="sxs-lookup"><span data-stu-id="2bccd-237">Click **Format** to format the drive with the partition settings.</span></span> <span data-ttu-id="2bccd-238">Щелкните **Write change to disk** (Записать изменения на диск), чтобы применить изменения разделов.</span><span class="sxs-lookup"><span data-stu-id="2bccd-238">Click **Write change to disk** to apply the partition changes.</span></span>
4. <span data-ttu-id="2bccd-239">Выберите **Установить загрузчик** > **Далее**, чтобы установить загрузчик в корневой раздел.</span><span class="sxs-lookup"><span data-stu-id="2bccd-239">Select **Install boot loader** > **Next** to install the boot loader on the root partition.</span></span>
5. <span data-ttu-id="2bccd-240">По завершении установки нажмите кнопку **Reboot** (Перезагрузить).</span><span class="sxs-lookup"><span data-stu-id="2bccd-240">When the installation is complete, click **Reboot**.</span></span>

#### <a name="retrieve-the-scsi-ids"></a><span data-ttu-id="2bccd-241">Получение идентификаторов SCSI</span><span class="sxs-lookup"><span data-stu-id="2bccd-241">Retrieve the SCSI IDs</span></span>

1. <span data-ttu-id="2bccd-242">После установки получите идентификаторы SCSI для каждого жесткого диска SCSI на виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="2bccd-242">After the installation, retrieve the SCSI IDs for each SCSI hard disk in the VM.</span></span> <span data-ttu-id="2bccd-243">Для этого завершите работу виртуальной машины сервера управления.</span><span class="sxs-lookup"><span data-stu-id="2bccd-243">To do so, shut down the management server VM.</span></span> <span data-ttu-id="2bccd-244">Затем в свойствах виртуальной машины в VMware щелкните виртуальную машину правой кнопкой мыши и выберите **Edit Settings** (Изменить параметры) >  **Options** (Параметры).</span><span class="sxs-lookup"><span data-stu-id="2bccd-244">In the VM properties in VMware, right-click the VM entry > **Edit Settings** > **Options**.</span></span>
2. <span data-ttu-id="2bccd-245">Выберите **Advanced** (Дополнительно) >  **General item** (Общий элемент) и щелкните **Configuration Parameters** (Параметры конфигурации).</span><span class="sxs-lookup"><span data-stu-id="2bccd-245">Select **Advanced** > **General item**, and then click **Configuration Parameters**.</span></span> <span data-ttu-id="2bccd-246">Если виртуальная машина работает, этот параметр будет недоступен.</span><span class="sxs-lookup"><span data-stu-id="2bccd-246">This option is unavailable when the machine is running.</span></span> <span data-ttu-id="2bccd-247">Чтобы он стал доступен, необходимо завершить работу виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="2bccd-247">For the option to be available, the machine must be shut down.</span></span>
3. <span data-ttu-id="2bccd-248">Выполните одно из приведенных ниже действий.</span><span class="sxs-lookup"><span data-stu-id="2bccd-248">Do either of the following:</span></span>
 * <span data-ttu-id="2bccd-249">При наличии строки **disk.EnableUUID** задайте для нее значение **True** (с учетом регистра).</span><span class="sxs-lookup"><span data-stu-id="2bccd-249">If the row **disk.EnableUUID** exists, make sure that the value is set to **True** (case sensitive).</span></span> <span data-ttu-id="2bccd-250">Если это уже сделано, можно нажать кнопку "Сancel" (Отмена) и после загрузки гостевой операционной системы проверить в ней команду SCSI.</span><span class="sxs-lookup"><span data-stu-id="2bccd-250">If the value is already set to True, you can cancel and test the SCSI command inside a guest operating system after it’s booted.</span></span>
 * <span data-ttu-id="2bccd-251">Если строки **disk.EnableUUID** нет, щелкните **Add Row** (Добавить строку) и добавьте ее со значением **True**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-251">If the row **disk.EnableUUID** doesn’t exist, click **Add Row**, and then add it with the **True** value.</span></span> <span data-ttu-id="2bccd-252">Не используйте двойные кавычки.</span><span class="sxs-lookup"><span data-stu-id="2bccd-252">Don’t use double quotation marks.</span></span>

#### <a name="install-additional-packages"></a><span data-ttu-id="2bccd-253">Установка дополнительных пакетов</span><span class="sxs-lookup"><span data-stu-id="2bccd-253">Install additional packages</span></span>
<span data-ttu-id="2bccd-254">Скачайте и установите дополнительные пакеты.</span><span class="sxs-lookup"><span data-stu-id="2bccd-254">Download and install additional packages.</span></span>

1. <span data-ttu-id="2bccd-255">Убедитесь, что главный целевой сервер подключен к Интернету.</span><span class="sxs-lookup"><span data-stu-id="2bccd-255">Make sure the master target server is connected to the Internet.</span></span>
2. <span data-ttu-id="2bccd-256">Чтобы скачать и установить 15 пакетов из репозитория CentOS, выполните следующую команду: `# yum install –y xfsprogs perl lsscsi rsync wget kexec-tools`.</span><span class="sxs-lookup"><span data-stu-id="2bccd-256">To download and install 15 packages from the CentOS repository, run this command: `# yum install –y xfsprogs perl lsscsi rsync wget kexec-tools`.</span></span>
3. <span data-ttu-id="2bccd-257">Если в защищаемых исходных компьютерах Linux для корневого устройства или устройства загрузки используется файловая система Reiser или XFS, следует скачать и установить приведенные ниже дополнительные пакеты.</span><span class="sxs-lookup"><span data-stu-id="2bccd-257">If the source machines you’re protecting are running Linux with a Reiser or XFS file system for the root or boot device, download and install additional packages as follows:</span></span>

   * <span data-ttu-id="2bccd-258">\# cd /usr/local</span><span class="sxs-lookup"><span data-stu-id="2bccd-258">\# cd /usr/local</span></span>
   * <span data-ttu-id="2bccd-259">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm)</span><span class="sxs-lookup"><span data-stu-id="2bccd-259">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm)</span></span>
   * <span data-ttu-id="2bccd-260">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm)</span><span class="sxs-lookup"><span data-stu-id="2bccd-260">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm)</span></span>
   * <span data-ttu-id="2bccd-261">\# rpm –ivh kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm</span><span class="sxs-lookup"><span data-stu-id="2bccd-261">\# rpm –ivh kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm</span></span>
   * <span data-ttu-id="2bccd-262">\# wget [http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm](http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm)</span><span class="sxs-lookup"><span data-stu-id="2bccd-262">\# wget [http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm](http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm)</span></span>
   * <span data-ttu-id="2bccd-263">\# rpm –ivh xfsprogs-3.1.1-16.el6.x86_64.rpm</span><span class="sxs-lookup"><span data-stu-id="2bccd-263">\# rpm –ivh xfsprogs-3.1.1-16.el6.x86_64.rpm</span></span>
   * <span data-ttu-id="2bccd-264">\# yum install device-mapper-multipath (Требуется для добавления пакетов Multipath на главный целевой сервер.)</span><span class="sxs-lookup"><span data-stu-id="2bccd-264">\# yum install device-mapper-multipath (required to enable multipath packages on the master target server)</span></span>

#### <a name="apply-custom-changes"></a><span data-ttu-id="2bccd-265">Применение пользовательских изменений</span><span class="sxs-lookup"><span data-stu-id="2bccd-265">Apply custom changes</span></span>
<span data-ttu-id="2bccd-266">Выполнив послеустановочные действия и установив пакеты, для применения пользовательских изменений сделайте следующее.</span><span class="sxs-lookup"><span data-stu-id="2bccd-266">After you’ve completed the post-installation steps and installed the packages, apply custom changes by doing the following:</span></span>

1. <span data-ttu-id="2bccd-267">Скопируйте двоичный файл единого агента RHEL 6-64 в виртуальную машину.</span><span class="sxs-lookup"><span data-stu-id="2bccd-267">Copy the RHEL 6-64 Unified Agent binary to the VM.</span></span> <span data-ttu-id="2bccd-268">Выполните следующую команду, чтобы распаковать двоичный TAR-файл: `tar –zxvf <file name>`.</span><span class="sxs-lookup"><span data-stu-id="2bccd-268">To untar the binary, run this command: `tar –zxvf <file name>`.</span></span>
2. <span data-ttu-id="2bccd-269">Чтобы предоставить разрешения, выполните следующую команду: `# chmod 755 ./ApplyCustomChanges.sh`.</span><span class="sxs-lookup"><span data-stu-id="2bccd-269">To give permissions, run this command: `# chmod 755 ./ApplyCustomChanges.sh`.</span></span>
3. <span data-ttu-id="2bccd-270">Выполните следующий сценарий: `# ./ApplyCustomChanges.sh`.</span><span class="sxs-lookup"><span data-stu-id="2bccd-270">Run the following script: `# ./ApplyCustomChanges.sh`.</span></span> <span data-ttu-id="2bccd-271">Это следует сделать только один раз.</span><span class="sxs-lookup"><span data-stu-id="2bccd-271">Run it only once.</span></span> <span data-ttu-id="2bccd-272">После успешного выполнения сценария перезапустите сервер.</span><span class="sxs-lookup"><span data-stu-id="2bccd-272">After it runs successfully, reboot the server.</span></span>

## <a name="run-the-failback"></a><span data-ttu-id="2bccd-273">Выполнение восстановления размещения</span><span class="sxs-lookup"><span data-stu-id="2bccd-273">Run the failback</span></span>
### <a name="reprotect-the-azure-vms"></a><span data-ttu-id="2bccd-274">Повторное включение защиты виртуальных машин Azure</span><span class="sxs-lookup"><span data-stu-id="2bccd-274">Reprotect the Azure VMs</span></span>
1. <span data-ttu-id="2bccd-275">В разделе **Хранилище** > **Реплицированные элементы** выберите виртуальную машину, для которой проводилась отработка отказа, и щелкните **Защитить повторно**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-275">In **Vault**, in **Replicated items**, right-click the VM that has been failed over, and then select **Re-Protect**.</span></span>
2. <span data-ttu-id="2bccd-276">В колонке будет уже выбрано направление защиты **Из Azure на локальный компьютер**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-276">On the blade, you can see that the direction of protection **Azure to On-premises** is already selected.</span></span>
3. <span data-ttu-id="2bccd-277">В полях **Главный целевой сервер** и **Сервер обработки** выберите локальный главный целевой сервер и сервер обработки виртуальной машины Azure.</span><span class="sxs-lookup"><span data-stu-id="2bccd-277">In **Master Target Server** and **Process Server**, select the on-premises master target server and the Azure VM Process Server.</span></span>
4. <span data-ttu-id="2bccd-278">Выберите хранилище данных, в котором нужно локально восстановить диски.</span><span class="sxs-lookup"><span data-stu-id="2bccd-278">Select the datastore that you want to recover the disks on-premises to.</span></span> <span data-ttu-id="2bccd-279">Используйте этот параметр, если локальная виртуальная машина была удалена и вам нужно создать новые диски.</span><span class="sxs-lookup"><span data-stu-id="2bccd-279">Use this option when the on-premises VM is deleted and you need to create new disks.</span></span> <span data-ttu-id="2bccd-280">Пропустите этот параметр, если диски уже существуют, но значение все равно необходимо указать.</span><span class="sxs-lookup"><span data-stu-id="2bccd-280">Ignore the option if the disks already exist, but you still need to specify a value.</span></span>
5. <span data-ttu-id="2bccd-281">Используйте диск хранения для остановки точек во времени при репликации виртуальной машины обратно в локальную среду.</span><span class="sxs-lookup"><span data-stu-id="2bccd-281">Use a retention drive to stop the points in time when the VM is replicated back to on-premises.</span></span> <span data-ttu-id="2bccd-282">Ниже перечислены некоторые критерии для диска хранения.</span><span class="sxs-lookup"><span data-stu-id="2bccd-282">Some criteria of a retention drive are listed here.</span></span> <span data-ttu-id="2bccd-283">Если они не выполнены, то диск не появится на главном целевом сервере.</span><span class="sxs-lookup"><span data-stu-id="2bccd-283">Without these criteria, the drive is not listed for the master target server.</span></span>

  * <span data-ttu-id="2bccd-284">Том не должен использоваться ни для какой иной цели (как назначение репликации и т. д.).</span><span class="sxs-lookup"><span data-stu-id="2bccd-284">Volume shouldn't be in use for any other purpose (target of replication, and so forth).</span></span>
  * <span data-ttu-id="2bccd-285">Том не должен быть заблокирован.</span><span class="sxs-lookup"><span data-stu-id="2bccd-285">Volume shouldn't be in lock mode.</span></span>
  * <span data-ttu-id="2bccd-286">Том не должен быть томом кэша.</span><span class="sxs-lookup"><span data-stu-id="2bccd-286">Volume shouldn't be cache volume.</span></span> <span data-ttu-id="2bccd-287">(На томе не должен присутствовать установленный экземпляр главного целевого сервера.</span><span class="sxs-lookup"><span data-stu-id="2bccd-287">(The master target installation shouldn't exist on that volume.</span></span> <span data-ttu-id="2bccd-288">Том настраиваемой установки сервера обработки и главного целевого сервера не может использоваться как том хранения.</span><span class="sxs-lookup"><span data-stu-id="2bccd-288">The Process Server plus master target custom installation volume is not eligible for retention volume.</span></span> <span data-ttu-id="2bccd-289">В нашем случае для настраиваемой установки сервера обработки и главного целевого сервера используется том кэша главного целевого сервера.)</span><span class="sxs-lookup"><span data-stu-id="2bccd-289">Here, the installed Process Server plus master target volume is the cache volume of the master target.)</span></span>
  * <span data-ttu-id="2bccd-290">Том не должен иметь тип файловой системы FAT или FAT32.</span><span class="sxs-lookup"><span data-stu-id="2bccd-290">The volume file system type shouldn't be FAT and FAT32.</span></span>
  * <span data-ttu-id="2bccd-291">Емкость тома не должна быть нулевой.</span><span class="sxs-lookup"><span data-stu-id="2bccd-291">The volume capacity should be non-zero.</span></span>
  * <span data-ttu-id="2bccd-292">Том хранения по умолчанию для Windows — это том R.</span><span class="sxs-lookup"><span data-stu-id="2bccd-292">The default retention volume for Windows is R volume.</span></span>
  * <span data-ttu-id="2bccd-293">Том хранения по умолчанию для Linux — /mnt/retention.</span><span class="sxs-lookup"><span data-stu-id="2bccd-293">The default retention volume for Linux is /mnt/retention.</span></span>

6. <span data-ttu-id="2bccd-294">Политика восстановления размещения выбирается автоматически.</span><span class="sxs-lookup"><span data-stu-id="2bccd-294">The failback policy is automatically selected.</span></span>
7. <span data-ttu-id="2bccd-295">После нажатия кнопки **ОК** для повторного включения защиты задание начинает репликацию виртуальной машины из Azure на локальный сайт.</span><span class="sxs-lookup"><span data-stu-id="2bccd-295">After you click **OK** to begin reprotection, a job begins to replicate the VM from Azure to the on-premises site.</span></span> <span data-ttu-id="2bccd-296">Ход выполнения операции можно отслеживать на вкладке **Задания** .</span><span class="sxs-lookup"><span data-stu-id="2bccd-296">You can track the progress on the **Jobs** tab.</span></span>

<span data-ttu-id="2bccd-297">Если необходимо выполнить восстановление в альтернативном расположении, выберите диск хранения и хранилище данных, настроенные для главного целевого сервера.</span><span class="sxs-lookup"><span data-stu-id="2bccd-297">If you want to recover to an alternate location, select the retention drive and datastore that are configured for the master target server.</span></span> <span data-ttu-id="2bccd-298">При восстановлении размещения на локальном сайте виртуальные машины VMware, указанные в плане защиты восстановления размещения, будут использовать то же хранилище данных, что и главный целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="2bccd-298">When you fail back to the on-premises site, the VMware VMs in the failback protection plan use the same datastore as the master target server.</span></span> <span data-ttu-id="2bccd-299">Если необходимо восстановить виртуальную машину Azure реплики на той же локальной виртуальной машине, она уже должна находиться в том же хранилище данных, что и главный целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="2bccd-299">If you want to recover the replica Azure VM to the same on-premises VM, the on-premises VM should already be in the same datastore as the master target server.</span></span> <span data-ttu-id="2bccd-300">Если локальные виртуальные машины отсутствуют, то во время повторного включения защиты создается новая локальная виртуальная машина.</span><span class="sxs-lookup"><span data-stu-id="2bccd-300">If there's no VM on-premises, a new one is created during reprotection.</span></span>

![Выбор пункта "Из Azure на локальный компьютер" из раскрывающегося меню](./media/site-recovery-failback-azure-to-vmware-new/reprotectinputs.png)

<span data-ttu-id="2bccd-302">Защиту можно также включить повторно на уровне плана восстановления.</span><span class="sxs-lookup"><span data-stu-id="2bccd-302">You can also reprotect at a recovery plan level.</span></span> <span data-ttu-id="2bccd-303">Если у вас есть группа репликации, ее можно повторно защитить только с помощью плана восстановления.</span><span class="sxs-lookup"><span data-stu-id="2bccd-303">If you have a replication group, you can reprotect it only by using a recovery plan.</span></span> <span data-ttu-id="2bccd-304">При повторном включении защиты с помощью плана восстановления используйте предыдущие значения для каждого защищенного компьютера.</span><span class="sxs-lookup"><span data-stu-id="2bccd-304">When you reprotect by using a recovery plan, use the previous values for every protected machine.</span></span>

> [!NOTE]
> <span data-ttu-id="2bccd-305">Защита группы репликации должна быть восстановлена с использованием того же главного целевого сервера.</span><span class="sxs-lookup"><span data-stu-id="2bccd-305">Replication groups should be protected back with the same master target.</span></span> <span data-ttu-id="2bccd-306">При выборе других главных целевых серверов для них нельзя будет выбрать другую общую точку во времени.</span><span class="sxs-lookup"><span data-stu-id="2bccd-306">If they are protected back with different master target servers, a common point in time cannot be determined for them.</span></span>

### <a name="run-a-failover-to-the-on-premises-site"></a><span data-ttu-id="2bccd-307">Запуск отработки отказа на локальном сайте</span><span class="sxs-lookup"><span data-stu-id="2bccd-307">Run a failover to the on-premises site</span></span>
<span data-ttu-id="2bccd-308">После повторного включения защиты виртуальной машины вы можете запустить отработку отказа из Azure в локальную среду.</span><span class="sxs-lookup"><span data-stu-id="2bccd-308">After you reprotect the VM, you can initiate a failover from Azure to on-premises.</span></span>

1. <span data-ttu-id="2bccd-309">На странице реплицированных элементов щелкните правой кнопкой мыши виртуальную машину и выберите **Внеплановая отработка отказа**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-309">On the replicated items page, right-click the virtual machine, and then select **Unplanned Failover**.</span></span>
2. <span data-ttu-id="2bccd-310">На странице **Подтверждение отработки отказа** проверьте направление отработки отказа (из Azure) и выберите точку восстановления для отработки отказа (последняя точка восстановления или последняя точка восстановления с согласованием приложений).</span><span class="sxs-lookup"><span data-stu-id="2bccd-310">In **Confirm Failover**, verify the failover direction (from Azure), and then select the recovery point that you want to use for the failover (the latest, or the latest app-consistent recovery point).</span></span> <span data-ttu-id="2bccd-311">Точка восстановления с согласованием приложений предшествует самой последней точке во времени, что приведет к потере некоторых данных.</span><span class="sxs-lookup"><span data-stu-id="2bccd-311">An app-consistent recovery point occurs before the most recent point in time, and it will cause some data loss.</span></span>
3. <span data-ttu-id="2bccd-312">Во время отработки отказа Site Recovery завершает работу виртуальных машин Azure.</span><span class="sxs-lookup"><span data-stu-id="2bccd-312">During failover, Site Recovery shuts down the Azure VMs.</span></span> <span data-ttu-id="2bccd-313">Если восстановление размещения выполнено правильно, вы можете убедиться, что работа виртуальных машин Azure завершена должным образом.</span><span class="sxs-lookup"><span data-stu-id="2bccd-313">After you check that failback has been completed as expected, you can check to ensure that the Azure VMs have been shut down as expected.</span></span>

### <a name="reprotect-the-on-premises-site"></a><span data-ttu-id="2bccd-314">Повторное включение защиты локального сайта</span><span class="sxs-lookup"><span data-stu-id="2bccd-314">Reprotect the on-premises site</span></span>
<span data-ttu-id="2bccd-315">Когда восстановление размещения будет завершено, вам нужно будет зафиксировать виртуальную машину, чтобы обеспечить удаление виртуальных машин, восстановленных в Azure.</span><span class="sxs-lookup"><span data-stu-id="2bccd-315">After failback has been completed, commit the virtual machine to ensure that the VMs recovered in Azure are deleted.</span></span> <span data-ttu-id="2bccd-316">Для этого щелкните защищенный элемент правой кнопкой мыши и выберите **Применить**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-316">To do so, right-click the protected item, and then click **Commit**.</span></span> <span data-ttu-id="2bccd-317">Будет запущено задание, которое удаляет из Azure восстановленные ранее виртуальные машины.</span><span class="sxs-lookup"><span data-stu-id="2bccd-317">This action triggers a job that removes the former recovered virtual machines in Azure.</span></span>

<span data-ttu-id="2bccd-318">После завершения фиксации данные будут возвращены на локальный сайт, но не будут защищены.</span><span class="sxs-lookup"><span data-stu-id="2bccd-318">After the commit is completed, your data should be back on the on-premises site, but it won’t be protected.</span></span> <span data-ttu-id="2bccd-319">Чтобы снова начать репликацию в Azure, сделайте следующее.</span><span class="sxs-lookup"><span data-stu-id="2bccd-319">To start replicating to Azure again, do the following:</span></span>

1. <span data-ttu-id="2bccd-320">В разделе **Хранилище** выберите **Настройка** > **Реплицированные элементы**, затем выберите виртуальные машины, для которых выполнено восстановление размещения, и щелкните **Защитить повторно**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-320">In **Vault**, in **Setting** > **Replicated items**, select the VMs that have failed back, and then click **Re-Protect**.</span></span>
2. <span data-ttu-id="2bccd-321">Укажите сервер обработки, который необходимо использовать для отправки данных обратно в Azure.</span><span class="sxs-lookup"><span data-stu-id="2bccd-321">Give the value of the Process Server that needs to be used to send data back to Azure.</span></span>
3. <span data-ttu-id="2bccd-322">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-322">Click **OK**.</span></span>

<span data-ttu-id="2bccd-323">После повторного включения защиты виртуальная машина будет реплицироваться в Azure, и вы сможете выполнять отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="2bccd-323">After the reprotection is complete, the VM replicates back to Azure and you can do a failover.</span></span>

### <a name="resolve-common-failback-issues"></a><span data-ttu-id="2bccd-324">Устранение распространенных проблем восстановления размещения</span><span class="sxs-lookup"><span data-stu-id="2bccd-324">Resolve common failback issues</span></span>
* <span data-ttu-id="2bccd-325">Если выполнить обнаружение vCenter в режиме пользователя только для чтения и защитить виртуальные машины, операция завершится успешно и отработка отказа будет работать.</span><span class="sxs-lookup"><span data-stu-id="2bccd-325">If you perform a read-only user vCenter discovery and protect virtual machines, it succeeds and failover works.</span></span> <span data-ttu-id="2bccd-326">Во время повторного включения защиты происходит сбой отработки отказа, так как невозможно обнаружить хранилища данных.</span><span class="sxs-lookup"><span data-stu-id="2bccd-326">During reprotection, failover fails because the datastores cannot be discovered.</span></span> <span data-ttu-id="2bccd-327">Признаком этой ситуации является отсутствие списка хранилищ данных при повторном включении защиты.</span><span class="sxs-lookup"><span data-stu-id="2bccd-327">As a symptom, you will not see the datastores listed during reprotection.</span></span> <span data-ttu-id="2bccd-328">Для устранения этой проблемы можно обновить учетные данные vCenter, указав учетную запись с соответствующими разрешениями, и повторить задание.</span><span class="sxs-lookup"><span data-stu-id="2bccd-328">To resolve this issue, you can update the vCenter credential with an appropriate account that has permissions and retry the job.</span></span> <span data-ttu-id="2bccd-329">Дополнительные сведения см. в разделе [Репликация виртуальных машин VMware и физических серверов в Azure с помощью службы Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="2bccd-329">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md)</span></span>
* <span data-ttu-id="2bccd-330">При восстановлении размещения виртуальной машины Linux и ее последующем запуске в локальной среде вы видите, что с этой виртуальной машины удален пакет диспетчера сети.</span><span class="sxs-lookup"><span data-stu-id="2bccd-330">When you fail back a Linux VM and run it on-premises, you can see that the Network Manager package has been uninstalled from the machine.</span></span> <span data-ttu-id="2bccd-331">Это вызвано тем, что при восстановлении виртуальной машины в Azure пакет диспетчера сети удаляется.</span><span class="sxs-lookup"><span data-stu-id="2bccd-331">This uninstallation happens because the Network Manager package is removed when the VM is recovered in Azure.</span></span>
* <span data-ttu-id="2bccd-332">Если для виртуальной машины со статическим IP-адресом выполняется отработка отказа в Azure, то IP-адрес предоставляется посредством DHCP.</span><span class="sxs-lookup"><span data-stu-id="2bccd-332">When a VM is configured with a static IP address and is failed over to Azure, the IP address is acquired via DHCP.</span></span> <span data-ttu-id="2bccd-333">При восстановлении размещения в локальной среде виртуальная машина также будет получать IP-адрес с помощью DHCP.</span><span class="sxs-lookup"><span data-stu-id="2bccd-333">When you fail over back to on-premises, the VM continues to use DHCP to acquire the IP address.</span></span> <span data-ttu-id="2bccd-334">Вручную войдите на виртуальную машину и снова настройте статический IP-адрес, если это необходимо.</span><span class="sxs-lookup"><span data-stu-id="2bccd-334">Manually sign in to the machine and set the IP address back to a static address if necessary.</span></span>
* <span data-ttu-id="2bccd-335">Если вы используете бесплатный выпуск ESXi версии 5.5 или низкоуровневой оболочки vSphere версии 6, то отработка отказа будет выполнена успешно, но восстановление размещения после сбоя выполнено не будет.</span><span class="sxs-lookup"><span data-stu-id="2bccd-335">If you are using either ESXi 5.5 free edition or vSphere 6 Hypervisor free edition, failover would succeed, but failback would not succeed.</span></span> <span data-ttu-id="2bccd-336">Чтобы включить восстановления размещения, необходимо выполнить обновление до любой из версий с ознакомительной лицензией.</span><span class="sxs-lookup"><span data-stu-id="2bccd-336">To enable failback, upgrade to either program's evaluation license.</span></span>
* <span data-ttu-id="2bccd-337">Если сервер конфигурации недоступен с сервера обработки, проверьте подключение к серверу конфигурации по протоколу Telnet через порт 443.</span><span class="sxs-lookup"><span data-stu-id="2bccd-337">If you cannot reach the configuration server from the Process Server, check connectivity to the configuration server by Telnet to the configuration server machine on port 443.</span></span> <span data-ttu-id="2bccd-338">Можно также проверить связь между сервером конфигурации и виртуальной машиной сервера обработки.</span><span class="sxs-lookup"><span data-stu-id="2bccd-338">You can also try to ping the configuration server from the Process Server machine.</span></span> <span data-ttu-id="2bccd-339">Сервер обработки должен также отвечать на пульс, когда он подключен к серверу конфигурации.</span><span class="sxs-lookup"><span data-stu-id="2bccd-339">A Process Server should also have a heartbeat when it is connected to the configuration server.</span></span>
* <span data-ttu-id="2bccd-340">Если вы пытаетесь восстановить размещения на альтернативный сервер vCenter, убедитесь, что новый сервер vCenter обнаружен, как и главный целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="2bccd-340">If you are trying to fail back to an alternate vCenter, make sure that your new vCenter is discovered and that the master target server is also discovered.</span></span> <span data-ttu-id="2bccd-341">Характерный симптом: хранилища недоступны и отсутствуют в диалоговом окне **Повторная защита**.</span><span class="sxs-lookup"><span data-stu-id="2bccd-341">A typical symptom is that the datastores are not accessible or visible in the **Reprotect** dialog box.</span></span>
* <span data-ttu-id="2bccd-342">Размещение компьютера Windows Server 2008 R2 SP1, который защищен как физический локальный компьютер, не может быть восстановлено из Azure в локальную среду.</span><span class="sxs-lookup"><span data-stu-id="2bccd-342">A WS2008R2SP1 machine that is protected as a physical on-premises machine cannot be failed back from Azure to on-premises.</span></span>

## <a name="fail-back-with-expressroute"></a><span data-ttu-id="2bccd-343">Восстановление размещения с использованием ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="2bccd-343">Fail back with ExpressRoute</span></span>
<span data-ttu-id="2bccd-344">Восстановление размещения можно выполнить через подключение VPN или ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="2bccd-344">You can fail back over a VPN connection or by using an ExpressRoute connection.</span></span> <span data-ttu-id="2bccd-345">Если вы хотите использовать подключение ExpressRoute, обратите внимание на следующее.</span><span class="sxs-lookup"><span data-stu-id="2bccd-345">If you want to use an ExpressRoute connection, note the following:</span></span>

* <span data-ttu-id="2bccd-346">Подключение ExpressRoute необходимо настроить в виртуальной сети Azure, в которую будет выполняться отработка отказа исходных виртуальных машин и в которой будут размещены виртуальные машины Azure после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="2bccd-346">The ExpressRoute connection should be set up on the Azure virtual network that the source machines fail over to and where the Azure VMs are located after the failover occurs.</span></span>
* <span data-ttu-id="2bccd-347">Данные реплицируются в учетную запись хранения Azure в общедоступной конечной точке.</span><span class="sxs-lookup"><span data-stu-id="2bccd-347">Data is replicated to an Azure storage account on a public endpoint.</span></span> <span data-ttu-id="2bccd-348">Чтобы настроить подключение ExpressRoute, следует настроить в ExpressRoute общедоступный пиринг с целевым центром обработки данных для репликации Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="2bccd-348">To use an ExpressRoute connection, set up public peering in ExpressRoute with the target data center for Site Recovery replication.</span></span>

---
title: "Как в Azure Site Recovery работает репликация VMware в Azure? | Документация Майкрософт"
description: "В этой статье представлен обзор компонентов и архитектуры, используемых при репликации виртуальных машин VMware и физических серверов из локальной среды в Azure с помощью службы Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: c413efcd-d750-4b22-b34b-15bcaa03934a
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 05/29/2017
ms.author: raynew
ROBOTS: NOINDEX, NOFOLLOW
redirect_url: vmware-walkthrough-architecture
ms.openlocfilehash: 81f02c1277ae8a2c377ca0d6db67ec4211e9aa5e
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="how-does-vmware-replication-to-azure-work-in-site-recovery"></a>Как в Site Recovery работает репликация из VMware в Azure?

В этой статье описываются компоненты и процессы, задействованные при репликации виртуальных машин VMware и физических серверов Windows или Linux из локальной среды в Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).

При репликации физических серверов из локальной среды в Azure используются те же компоненты и процессы, что и при репликации виртуальных машин VMware. Но обратите внимание на следующие отличия:

- вместо виртуальной машины VMware для сервера конфигурации можно использовать физический сервер;
- для восстановления размещения требуется локальная инфраструктура VMware. Восстанавливать размещение на физический сервер невозможно.

Все комментарии можно добавить в конце этой статьи. Вопросы можно задать на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## <a name="architectural-components"></a>Компоненты архитектуры

В репликации виртуальных машин VMware и физических серверов в Azure задействованы несколько компонентов.

**Компонент** | **Расположение** | **Дополнительные сведения**
--- | --- | ---
**Таблицы Azure** | В Azure требуется учетная запись Azure, учетная запись хранения Azure и сеть Azure. | Реплицированные данные хранятся в учетной записи хранения, а виртуальные машины Azure создаются с использованием реплицированных данных при отработке отказа с локального сайта. При создании виртуальные машины Azure подключаются к виртуальной сети Azure.
**Сервер конфигурации** | Обособленный локальный сервер управления (виртуальная машина VMWare), на котором работают все необходимые для развертывания локальные компоненты, включая сервер конфигурации, сервер обработки и главный целевой сервер. | Компонент сервера конфигурации используется для координации обмена данными между локальным источником и Azure, а также для управления репликацией данных.
 **Сервер обработки**  | По умолчанию устанавливается на сервере конфигурации. | Выступает в качестве шлюза репликации. Получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure.<br/><br/> Сервер обработки также обеспечивает принудительную установку службы Mobility Service на защищенные компьютеры и выполняет автоматическое обнаружение виртуальных машин VMware.<br/><br/> По мере увеличения масштаба развертывания вы можете добавлять дополнительные выделенные серверы для обработки растущего объема данных репликации.
 **Главный целевой сервер** | По умолчанию устанавливается на локальном сервере конфигурации. | Обрабатывает данные репликации при восстановлении размещения с переносом из Azure.<br/><br/> Если объемы трафика восстановления размещения высоки, можно развернуть отдельный главный целевой сервер.
**Серверы VMware** | Виртуальные машины VMware размещаются на серверах vSphere ESXi. Мы рекомендуем управлять узлами с помощью сервера vCenter. | Добавьте серверы VMware в хранилище служб восстановления.
**Реплицируемые компьютеры** | Служба Mobility Service будет установлена на каждой виртуальной машине VMware, которую нужно реплицировать. Ее можно установить вручную или с помощью принудительной установки с сервера обработки.

Дополнительные сведения о необходимых компонентах развертывания и требованиях к каждому компоненту см. в [таблице поддержки](site-recovery-support-matrix-to-azure.md).

**Рис. 1. Компоненты VMware, реплицируемые в Azure**

![Компоненты](./media/site-recovery-components/arch-enhanced.png)

## <a name="replication-process"></a>Процесс репликации

1. Необходимо настроить развертывание, включая компоненты Azure, и хранилище служб восстановления. В хранилище необходимо указать источник и целевой объект репликации, настроить сервер конфигурации, добавить серверы VMware, создать политику репликации, развернуть службу Mobility Service, включить репликацию и запустить тестовую отработку отказа.
2.  Компьютеры начинают репликацию в соответствии с политикой репликации, а репликация первоначальной копии данных выполняется в службу хранилища Azure.
4. Репликация разностных изменений в Azure начинается после завершения начальной репликации. Отслеживаемые изменения для компьютера хранятся в HRL-файле.
    - Реплицируемые компьютеры обмениваются данными с сервером конфигурации через порт HTTPS 443 для входящих подключений для управления репликацией.
    - Реплицируемые компьютеры отправляют данные репликации на сервер обработки через порт HTTPS 9443 для входящих подключений (можно настроить).
    - Сервер конфигурации выполняет оркестрацию управления репликацией с Azure через порт HTTPS 443 для исходящих подключений.
    - Сервер обработки получает данные с исходных компьютеров, оптимизирует и зашифровывает их, а затем отправляет их в службу хранилища Azure через порт 443 для исходящих подключений.
    - Если включить согласованность между виртуальными машинами, компьютеры в группе репликации будут обмениваться данными друг с другом через порт 20004. Эту функция используется, если вы объединяете несколько компьютеров в группы репликации, и они совместно используют отказоустойчивые и согласованные точки восстановления после отработки отказа. Это полезно, если на компьютерах выполняется одна и та же рабочая нагрузка и они должны быть согласованы.
5. Трафик реплицируется в общедоступные конечные точки службы хранилища Azure через Интернет. Кроме того, можно использовать [общедоступный пиринг](../expressroute/expressroute-circuit-peerings.md#public-peering) Azure ExpressRoute. Репликация трафика через VPN типа "сеть — сеть" с локального сайта в Azure не поддерживается.

**Рис. 2. Репликация VMware в Azure**

![Расширенная архитектура](./media/site-recovery-components/v2a-architecture-henry.png)

## <a name="failover-and-failback-process"></a>Процесс отработки отказа и восстановления размещения

1. Убедившись, что тестовая отработка отказа работает правильно, при необходимости выполните незапланированную отработку отказа в Azure. Плановая отработка отказа не поддерживается.
2. Вы можете выполнить отработку отказа одного компьютера или создать [планы восстановления](site-recovery-create-recovery-plans.md), чтобы выполнить отработку отказа нескольких виртуальных машин.
3. При отработке отказа в Azure создаются виртуальные машины реплик. Фиксация отработки отказа выполняется для получения доступа к рабочей нагрузке из виртуальной машины реплики Azure.
4. Когда основной локальный сайт снова станет доступным, вы сможете выполнить восстановление размещения. Вы настраиваете инфраструктуру восстановления размещения, запускаете репликацию компьютера с дополнительного сайта на основной и выполняете внеплановую отработку отказа с дополнительного сайта. После того, как это восстановление размещения будет зафиксировано, данные переместятся обратно в локальное расположение, и вам понадобится включить репликацию в Azure снова. [Дополнительные сведения](site-recovery-failback-azure-to-vmware.md)

Есть ряд требований к восстановлению размещения.


- **Временный сервер обработки в Azure.** Если вы хотите восстановить размещение из Azure после отработки отказа, необходимо настроить виртуальную машину Azure в качестве сервера обработки, который будет обрабатывать репликацию из Azure. После восстановления размещения эту виртуальную машину можно удалить.
- **VPN-подключение.** Для восстановления размещения вам потребуется настроить VPN-подключение (или Azure ExpressRoute) между сетью Azure и локальным сайтом.
- **Отдельный локальный главный целевой сервер.** Локальный главный целевой сервер обрабатывает восстановление размещения. Главный целевой сервер устанавливается по умолчанию на сервер управления, но если восстанавливается размещение больших объемов трафика, настройте для этой цели отдельный локальный главный целевой сервер.
- **Политика восстановления размещения.** Для репликации обратно на локальный сайт необходима политика восстановления размещения. Она создается автоматически во время создания политики репликации.
- **Инфраструктура VMware.** Размещение необходимо восстанавливать на локальную виртуальную машину VMware. Это означает, что даже при репликации локальных физических серверов в Azure требуется локальная инфраструктура VMware.

**Рис. 3. Восстановление размещения виртуальных машин или физических компьютеров VMware**

![Восстановление размещения](./media/site-recovery-components/enhanced-failback.png)


## <a name="next-steps"></a>Дальнейшие действия

См. [таблицу поддержки](site-recovery-support-matrix-to-azure.md)

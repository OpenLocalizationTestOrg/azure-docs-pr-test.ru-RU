---
title: "Как в Azure Site Recovery работает репликация VMware в Azure? | Документация Майкрософт"
description: "В этой статье представлен обзор компонентов и архитектуры, используемых при репликации виртуальных машин VMware и физических серверов из локальной среды в Azure с помощью службы Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: c413efcd-d750-4b22-b34b-15bcaa03934a
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 05/29/2017
ms.author: raynew
ROBOTS: NOINDEX, NOFOLLOW
redirect_url: vmware-walkthrough-architecture
ms.openlocfilehash: 81f02c1277ae8a2c377ca0d6db67ec4211e9aa5e
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="how-does-vmware-replication-to-azure-work-in-site-recovery"></a><span data-ttu-id="ec39f-104">Как в Site Recovery работает репликация из VMware в Azure?</span><span class="sxs-lookup"><span data-stu-id="ec39f-104">How does VMware replication to Azure work in Site Recovery?</span></span>

<span data-ttu-id="ec39f-105">В этой статье описываются компоненты и процессы, задействованные при репликации виртуальных машин VMware и физических серверов Windows или Linux из локальной среды в Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).</span><span class="sxs-lookup"><span data-stu-id="ec39f-105">This article describes the components and processes involved when replicating on-premises VMware virtual machines, and Windows/Linux physical servers, to Azure using the [Azure Site Recovery](site-recovery-overview.md) service.</span></span>

<span data-ttu-id="ec39f-106">При репликации физических серверов из локальной среды в Azure используются те же компоненты и процессы, что и при репликации виртуальных машин VMware. Но обратите внимание на следующие отличия:</span><span class="sxs-lookup"><span data-stu-id="ec39f-106">When you replicate physical on-premises servers to Azure, replication uses also the same components and processes as VMware VM replication, with these differences:</span></span>

- <span data-ttu-id="ec39f-107">вместо виртуальной машины VMware для сервера конфигурации можно использовать физический сервер;</span><span class="sxs-lookup"><span data-stu-id="ec39f-107">You can use a physical server for the configuration server, instead of a VMware VM.</span></span>
- <span data-ttu-id="ec39f-108">для восстановления размещения требуется локальная инфраструктура VMware.</span><span class="sxs-lookup"><span data-stu-id="ec39f-108">You will need an on-premises VMware infrastructure for failback.</span></span> <span data-ttu-id="ec39f-109">Восстанавливать размещение на физический сервер невозможно.</span><span class="sxs-lookup"><span data-stu-id="ec39f-109">You can't fail back to a physical machine.</span></span>

<span data-ttu-id="ec39f-110">Все комментарии можно добавить в конце этой статьи. Вопросы можно задать на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span><span class="sxs-lookup"><span data-stu-id="ec39f-110">Post any comments at the bottom of this article, or ask questions in the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>


## <a name="architectural-components"></a><span data-ttu-id="ec39f-111">Компоненты архитектуры</span><span class="sxs-lookup"><span data-stu-id="ec39f-111">Architectural components</span></span>

<span data-ttu-id="ec39f-112">В репликации виртуальных машин VMware и физических серверов в Azure задействованы несколько компонентов.</span><span class="sxs-lookup"><span data-stu-id="ec39f-112">There are a number of components involved when replicating VMware VMs and physical servers to Azure.</span></span>

<span data-ttu-id="ec39f-113">**Компонент**</span><span class="sxs-lookup"><span data-stu-id="ec39f-113">**Component**</span></span> | <span data-ttu-id="ec39f-114">**Расположение**</span><span class="sxs-lookup"><span data-stu-id="ec39f-114">**Location**</span></span> | <span data-ttu-id="ec39f-115">**Дополнительные сведения**</span><span class="sxs-lookup"><span data-stu-id="ec39f-115">**Details**</span></span>
--- | --- | ---
<span data-ttu-id="ec39f-116">**Таблицы Azure**</span><span class="sxs-lookup"><span data-stu-id="ec39f-116">**Azure**</span></span> | <span data-ttu-id="ec39f-117">В Azure требуется учетная запись Azure, учетная запись хранения Azure и сеть Azure.</span><span class="sxs-lookup"><span data-stu-id="ec39f-117">In Azure you need an Azure account, an Azure storage account, and an Azure network.</span></span> | <span data-ttu-id="ec39f-118">Реплицированные данные хранятся в учетной записи хранения, а виртуальные машины Azure создаются с использованием реплицированных данных при отработке отказа с локального сайта.</span><span class="sxs-lookup"><span data-stu-id="ec39f-118">Replicated data is stored in the storage account, and Azure VMs are created with the replicated data when failover from your on-premises site occurs.</span></span> <span data-ttu-id="ec39f-119">При создании виртуальные машины Azure подключаются к виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="ec39f-119">The Azure VMs connect to the Azure virtual network when they're created.</span></span>
<span data-ttu-id="ec39f-120">**Сервер конфигурации**</span><span class="sxs-lookup"><span data-stu-id="ec39f-120">**Configuration server**</span></span> | <span data-ttu-id="ec39f-121">Обособленный локальный сервер управления (виртуальная машина VMWare), на котором работают все необходимые для развертывания локальные компоненты, включая сервер конфигурации, сервер обработки и главный целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="ec39f-121">A single on-premises management server (VMWare VM) that runs all the on-premises components that are needed for the deployment, including the configuration server, process server, master target server</span></span> | <span data-ttu-id="ec39f-122">Компонент сервера конфигурации используется для координации обмена данными между локальным источником и Azure, а также для управления репликацией данных.</span><span class="sxs-lookup"><span data-stu-id="ec39f-122">The configuration server component coordinates communications between on-premises and Azure, and manages data replication.</span></span>
 <span data-ttu-id="ec39f-123">**Сервер обработки**</span><span class="sxs-lookup"><span data-stu-id="ec39f-123">**Process server**:</span></span>  | <span data-ttu-id="ec39f-124">По умолчанию устанавливается на сервере конфигурации.</span><span class="sxs-lookup"><span data-stu-id="ec39f-124">Installed by default on the configuration server.</span></span> | <span data-ttu-id="ec39f-125">Выступает в качестве шлюза репликации.</span><span class="sxs-lookup"><span data-stu-id="ec39f-125">Acts as a replication gateway.</span></span> <span data-ttu-id="ec39f-126">Получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure.</span><span class="sxs-lookup"><span data-stu-id="ec39f-126">Receives replication data, optimizes it with caching, compression, and encryption, and sends it to Azure storage.</span></span><br/><br/> <span data-ttu-id="ec39f-127">Сервер обработки также обеспечивает принудительную установку службы Mobility Service на защищенные компьютеры и выполняет автоматическое обнаружение виртуальных машин VMware.</span><span class="sxs-lookup"><span data-stu-id="ec39f-127">The process server also handles push installation of the Mobility service to protected machines, and performs automatic discovery of VMware VMs.</span></span><br/><br/> <span data-ttu-id="ec39f-128">По мере увеличения масштаба развертывания вы можете добавлять дополнительные выделенные серверы для обработки растущего объема данных репликации.</span><span class="sxs-lookup"><span data-stu-id="ec39f-128">As your deployment grows you can add additional separate dedicated process servers to handle increasing volumes of replication traffic.</span></span>
 <span data-ttu-id="ec39f-129">**Главный целевой сервер**</span><span class="sxs-lookup"><span data-stu-id="ec39f-129">**Master target server**</span></span> | <span data-ttu-id="ec39f-130">По умолчанию устанавливается на локальном сервере конфигурации.</span><span class="sxs-lookup"><span data-stu-id="ec39f-130">Installed by default on the on-premises configuration server.</span></span> | <span data-ttu-id="ec39f-131">Обрабатывает данные репликации при восстановлении размещения с переносом из Azure.</span><span class="sxs-lookup"><span data-stu-id="ec39f-131">Handles replication data during failback from Azure.</span></span><br/><br/> <span data-ttu-id="ec39f-132">Если объемы трафика восстановления размещения высоки, можно развернуть отдельный главный целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="ec39f-132">If volumes of failback traffic are high, you can deploy a separate master target server for failback.</span></span>
<span data-ttu-id="ec39f-133">**Серверы VMware**</span><span class="sxs-lookup"><span data-stu-id="ec39f-133">**VMware servers**</span></span> | <span data-ttu-id="ec39f-134">Виртуальные машины VMware размещаются на серверах vSphere ESXi. Мы рекомендуем управлять узлами с помощью сервера vCenter.</span><span class="sxs-lookup"><span data-stu-id="ec39f-134">VMware VMs are hosted on vSphere ESXi servers, and we recommend a vCenter server to manage the hosts.</span></span> | <span data-ttu-id="ec39f-135">Добавьте серверы VMware в хранилище служб восстановления.</span><span class="sxs-lookup"><span data-stu-id="ec39f-135">You add VMware servers to your Recovery Services vault.</span></span>
<span data-ttu-id="ec39f-136">**Реплицируемые компьютеры**</span><span class="sxs-lookup"><span data-stu-id="ec39f-136">**Replicated machines**</span></span> | <span data-ttu-id="ec39f-137">Служба Mobility Service будет установлена на каждой виртуальной машине VMware, которую нужно реплицировать.</span><span class="sxs-lookup"><span data-stu-id="ec39f-137">The Mobility service will be installed on each VMware VM you want to replicate.</span></span> <span data-ttu-id="ec39f-138">Ее можно установить вручную или с помощью принудительной установки с сервера обработки.</span><span class="sxs-lookup"><span data-stu-id="ec39f-138">It can be installed manually on each machine, or with a push installation from the process server.</span></span>

<span data-ttu-id="ec39f-139">Дополнительные сведения о необходимых компонентах развертывания и требованиях к каждому компоненту см. в [таблице поддержки](site-recovery-support-matrix-to-azure.md).</span><span class="sxs-lookup"><span data-stu-id="ec39f-139">Learn about the deployment prerequisites and requirements for each of these components in the [support matrix](site-recovery-support-matrix-to-azure.md).</span></span>

<span data-ttu-id="ec39f-140">**Рис. 1. Компоненты VMware, реплицируемые в Azure**</span><span class="sxs-lookup"><span data-stu-id="ec39f-140">**Figure 1: VMware to Azure components**</span></span>

![Компоненты](./media/site-recovery-components/arch-enhanced.png)

## <a name="replication-process"></a><span data-ttu-id="ec39f-142">Процесс репликации</span><span class="sxs-lookup"><span data-stu-id="ec39f-142">Replication process</span></span>

1. <span data-ttu-id="ec39f-143">Необходимо настроить развертывание, включая компоненты Azure, и хранилище служб восстановления.</span><span class="sxs-lookup"><span data-stu-id="ec39f-143">You set up the deployment, including Azure components, and a Recovery Services vault.</span></span> <span data-ttu-id="ec39f-144">В хранилище необходимо указать источник и целевой объект репликации, настроить сервер конфигурации, добавить серверы VMware, создать политику репликации, развернуть службу Mobility Service, включить репликацию и запустить тестовую отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="ec39f-144">In the vault you specify the replication source and target, set up the configuration server, add VMware servers, create a replication policy, deploy the Mobility service, enable replication, and run a test failover.</span></span>
2.  <span data-ttu-id="ec39f-145">Компьютеры начинают репликацию в соответствии с политикой репликации, а репликация первоначальной копии данных выполняется в службу хранилища Azure.</span><span class="sxs-lookup"><span data-stu-id="ec39f-145">Machines start replicating in accordance with the replication policy, and an initial copy of the data is replicated to Azure storage.</span></span>
4. <span data-ttu-id="ec39f-146">Репликация разностных изменений в Azure начинается после завершения начальной репликации.</span><span class="sxs-lookup"><span data-stu-id="ec39f-146">Replication of delta changes to Azure begins after the initial replication finishes.</span></span> <span data-ttu-id="ec39f-147">Отслеживаемые изменения для компьютера хранятся в HRL-файле.</span><span class="sxs-lookup"><span data-stu-id="ec39f-147">Tracked changes for a machine are held in a .hrl file.</span></span>
    - <span data-ttu-id="ec39f-148">Реплицируемые компьютеры обмениваются данными с сервером конфигурации через порт HTTPS 443 для входящих подключений для управления репликацией.</span><span class="sxs-lookup"><span data-stu-id="ec39f-148">Replicating machines communicate with the configuration server on port HTTPS 443 inbound, for replication management.</span></span>
    - <span data-ttu-id="ec39f-149">Реплицируемые компьютеры отправляют данные репликации на сервер обработки через порт HTTPS 9443 для входящих подключений (можно настроить).</span><span class="sxs-lookup"><span data-stu-id="ec39f-149">Replicating machines send replication data to the process server on port HTTPS 9443 inbound (can be configured).</span></span>
    - <span data-ttu-id="ec39f-150">Сервер конфигурации выполняет оркестрацию управления репликацией с Azure через порт HTTPS 443 для исходящих подключений.</span><span class="sxs-lookup"><span data-stu-id="ec39f-150">The configuration server orchestrates replication management with Azure over port HTTPS 443 outbound.</span></span>
    - <span data-ttu-id="ec39f-151">Сервер обработки получает данные с исходных компьютеров, оптимизирует и зашифровывает их, а затем отправляет их в службу хранилища Azure через порт 443 для исходящих подключений.</span><span class="sxs-lookup"><span data-stu-id="ec39f-151">The process server receives data from source machines, optimizes and encrypts it, and sends it to Azure storage over port 443 outbound.</span></span>
    - <span data-ttu-id="ec39f-152">Если включить согласованность между виртуальными машинами, компьютеры в группе репликации будут обмениваться данными друг с другом через порт 20004.</span><span class="sxs-lookup"><span data-stu-id="ec39f-152">If you enable multi-VM consistency, then machines in the replication group communicate with each other over port 20004.</span></span> <span data-ttu-id="ec39f-153">Эту функция используется, если вы объединяете несколько компьютеров в группы репликации, и они совместно используют отказоустойчивые и согласованные точки восстановления после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="ec39f-153">Multi-VM is used if you group multiple machines into replication groups that share crash-consistent and app-consistent recovery points when they fail over.</span></span> <span data-ttu-id="ec39f-154">Это полезно, если на компьютерах выполняется одна и та же рабочая нагрузка и они должны быть согласованы.</span><span class="sxs-lookup"><span data-stu-id="ec39f-154">This is useful if machines are running the same workload and need to be consistent.</span></span>
5. <span data-ttu-id="ec39f-155">Трафик реплицируется в общедоступные конечные точки службы хранилища Azure через Интернет.</span><span class="sxs-lookup"><span data-stu-id="ec39f-155">Traffic is replicated to Azure storage public endpoints, over the internet.</span></span> <span data-ttu-id="ec39f-156">Кроме того, можно использовать [общедоступный пиринг](../expressroute/expressroute-circuit-peerings.md#public-peering) Azure ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="ec39f-156">Alternately, you can use Azure ExpressRoute [public peering](../expressroute/expressroute-circuit-peerings.md#public-peering).</span></span> <span data-ttu-id="ec39f-157">Репликация трафика через VPN типа "сеть — сеть" с локального сайта в Azure не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="ec39f-157">Replicating traffic over a site-to-site VPN from an on-premises site to Azure isn't supported.</span></span>

<span data-ttu-id="ec39f-158">**Рис. 2. Репликация VMware в Azure**</span><span class="sxs-lookup"><span data-stu-id="ec39f-158">**Figure 2: VMware to Azure replication**</span></span>

![Расширенная архитектура](./media/site-recovery-components/v2a-architecture-henry.png)

## <a name="failover-and-failback-process"></a><span data-ttu-id="ec39f-160">Процесс отработки отказа и восстановления размещения</span><span class="sxs-lookup"><span data-stu-id="ec39f-160">Failover and failback process</span></span>

1. <span data-ttu-id="ec39f-161">Убедившись, что тестовая отработка отказа работает правильно, при необходимости выполните незапланированную отработку отказа в Azure.</span><span class="sxs-lookup"><span data-stu-id="ec39f-161">After you verify that test failover is working as expected, you can run unplanned failovers to Azure as required.</span></span> <span data-ttu-id="ec39f-162">Плановая отработка отказа не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="ec39f-162">Planned failover isn't supported.</span></span>
2. <span data-ttu-id="ec39f-163">Вы можете выполнить отработку отказа одного компьютера или создать [планы восстановления](site-recovery-create-recovery-plans.md), чтобы выполнить отработку отказа нескольких виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="ec39f-163">You can fail over a single machine, or create [recovery plans](site-recovery-create-recovery-plans.md), to fail over multiple VMs.</span></span>
3. <span data-ttu-id="ec39f-164">При отработке отказа в Azure создаются виртуальные машины реплик.</span><span class="sxs-lookup"><span data-stu-id="ec39f-164">When you run a failover, replica VMs are created in Azure.</span></span> <span data-ttu-id="ec39f-165">Фиксация отработки отказа выполняется для получения доступа к рабочей нагрузке из виртуальной машины реплики Azure.</span><span class="sxs-lookup"><span data-stu-id="ec39f-165">You commit a failover to start accessing the workload from the replica Azure VM.</span></span>
4. <span data-ttu-id="ec39f-166">Когда основной локальный сайт снова станет доступным, вы сможете выполнить восстановление размещения.</span><span class="sxs-lookup"><span data-stu-id="ec39f-166">When your primary on-premises site is available again, you can fail back.</span></span> <span data-ttu-id="ec39f-167">Вы настраиваете инфраструктуру восстановления размещения, запускаете репликацию компьютера с дополнительного сайта на основной и выполняете внеплановую отработку отказа с дополнительного сайта.</span><span class="sxs-lookup"><span data-stu-id="ec39f-167">You set up a failback infrastructure, start replicating the machine from the secondary site to the primary, and run an unplanned failover from the secondary site.</span></span> <span data-ttu-id="ec39f-168">После того, как это восстановление размещения будет зафиксировано, данные переместятся обратно в локальное расположение, и вам понадобится включить репликацию в Azure снова.</span><span class="sxs-lookup"><span data-stu-id="ec39f-168">After you commit this failover, data will be back on-premises, and you need to enable replication to Azure again.</span></span> [<span data-ttu-id="ec39f-169">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="ec39f-169">Learn more</span></span>](site-recovery-failback-azure-to-vmware.md)

<span data-ttu-id="ec39f-170">Есть ряд требований к восстановлению размещения.</span><span class="sxs-lookup"><span data-stu-id="ec39f-170">There are a few failback requirements:</span></span>


- <span data-ttu-id="ec39f-171">**Временный сервер обработки в Azure.** Если вы хотите восстановить размещение из Azure после отработки отказа, необходимо настроить виртуальную машину Azure в качестве сервера обработки, который будет обрабатывать репликацию из Azure.</span><span class="sxs-lookup"><span data-stu-id="ec39f-171">**Temporary process server in Azure**: If you want to fail back from Azure after failover you'll need to set up an Azure VM configured as a process server, to handle replication from Azure.</span></span> <span data-ttu-id="ec39f-172">После восстановления размещения эту виртуальную машину можно удалить.</span><span class="sxs-lookup"><span data-stu-id="ec39f-172">You can delete this VM after failback finishes.</span></span>
- <span data-ttu-id="ec39f-173">**VPN-подключение.** Для восстановления размещения вам потребуется настроить VPN-подключение (или Azure ExpressRoute) между сетью Azure и локальным сайтом.</span><span class="sxs-lookup"><span data-stu-id="ec39f-173">**VPN connection**: For failback you'll need a VPN connection (or Azure ExpressRoute) set up from the Azure network to the on-premises site.</span></span>
- <span data-ttu-id="ec39f-174">**Отдельный локальный главный целевой сервер.** Локальный главный целевой сервер обрабатывает восстановление размещения.</span><span class="sxs-lookup"><span data-stu-id="ec39f-174">**Separate on-premises master target server**: The on-premises master target server handles failback.</span></span> <span data-ttu-id="ec39f-175">Главный целевой сервер устанавливается по умолчанию на сервер управления, но если восстанавливается размещение больших объемов трафика, настройте для этой цели отдельный локальный главный целевой сервер.</span><span class="sxs-lookup"><span data-stu-id="ec39f-175">The master target server is installed by default on the management server, but if you're failing back larger volumes of traffic you should set up a separate on-premises master target server for this purpose.</span></span>
- <span data-ttu-id="ec39f-176">**Политика восстановления размещения.** Для репликации обратно на локальный сайт необходима политика восстановления размещения.</span><span class="sxs-lookup"><span data-stu-id="ec39f-176">**Failback policy**: To replicate back to your on-premises site, you need a failback policy.</span></span> <span data-ttu-id="ec39f-177">Она создается автоматически во время создания политики репликации.</span><span class="sxs-lookup"><span data-stu-id="ec39f-177">This is automatically created when you created your replication policy.</span></span>
- <span data-ttu-id="ec39f-178">**Инфраструктура VMware.** Размещение необходимо восстанавливать на локальную виртуальную машину VMware.</span><span class="sxs-lookup"><span data-stu-id="ec39f-178">**VMware infrastructure**: You must fail back to an on-premises VMware VM.</span></span> <span data-ttu-id="ec39f-179">Это означает, что даже при репликации локальных физических серверов в Azure требуется локальная инфраструктура VMware.</span><span class="sxs-lookup"><span data-stu-id="ec39f-179">This means you need an on-premises VMware infrastructure, even if you're replicating on-premises physical servers to Azure.</span></span>

<span data-ttu-id="ec39f-180">**Рис. 3. Восстановление размещения виртуальных машин или физических компьютеров VMware**</span><span class="sxs-lookup"><span data-stu-id="ec39f-180">**Figure 3: VMware/physical failback**</span></span>

![Восстановление размещения](./media/site-recovery-components/enhanced-failback.png)


## <a name="next-steps"></a><span data-ttu-id="ec39f-182">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="ec39f-182">Next steps</span></span>

<span data-ttu-id="ec39f-183">См. [таблицу поддержки](site-recovery-support-matrix-to-azure.md)</span><span class="sxs-lookup"><span data-stu-id="ec39f-183">Review the [support matrix](site-recovery-support-matrix-to-azure.md)</span></span>

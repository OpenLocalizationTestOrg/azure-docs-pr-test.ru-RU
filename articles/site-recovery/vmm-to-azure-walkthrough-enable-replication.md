---
title: "Включение репликации в Azure для виртуальных машин Hyper-V в облаках VMM с помощью Azure Site Recovery | Документация Майкрософт"
description: "Здесь описано, как включить репликацию в Azure для виртуальных машин Hyper-V в облаках VMM с помощью службы Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 89a2c4fc-7e03-4a86-a2c0-52831ccebc1a
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/23/2017
ms.author: raynew
ms.openlocfilehash: 96a817e43a830e836f2faa4603fc88ed9c0b1828
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="step-11-enable-replication-to-azure-for-hyper-v-vms-in-vmm-clouds"></a><span data-ttu-id="5fffa-103">Шаг 11. Включение репликации в Azure для виртуальных машин Hyper-V в облаках VMM</span><span class="sxs-lookup"><span data-stu-id="5fffa-103">Step 11: Enable replication to Azure for Hyper-V VMs in VMM clouds</span></span>

<span data-ttu-id="5fffa-104">После настройки политики репликации воспользуйтесь сведениями в этой статье, чтобы включить репликацию локальных виртуальных машин Hyper-V, управляемых в облаках System Center Virtual Machine Manager (VMM), в Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md) на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="5fffa-104">After you've set up a replication policy, use this article to enable replication for on-premises Hyper-V virtual machines (VMs) managed in System Center Virtual Machine Manager (VMM) clouds), to Azure, using the [Azure Site Recovery](site-recovery-overview.md) service in the Azure portal.</span></span>

<span data-ttu-id="5fffa-105">Комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span><span class="sxs-lookup"><span data-stu-id="5fffa-105">Post comments and questions at the bottom of this article, or on the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>


## <a name="before-you-start"></a><span data-ttu-id="5fffa-106">Перед началом работы</span><span class="sxs-lookup"><span data-stu-id="5fffa-106">Before you start</span></span>

<span data-ttu-id="5fffa-107">Убедитесь, что учетная запись Azure имеет правильные [разрешения](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines) для создания виртуальных машин Azure.</span><span class="sxs-lookup"><span data-stu-id="5fffa-107">Make sure your Azure account has the correct [permissions](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines)to create Azure VMs.</span></span> <span data-ttu-id="5fffa-108">[Узнайте больше](../active-directory/role-based-access-built-in-roles.md) об управлении доступом на основе ролей в Azure.</span><span class="sxs-lookup"><span data-stu-id="5fffa-108">[Learn more](../active-directory/role-based-access-built-in-roles.md) about Azure role-based access control.</span></span>

## <a name="exclude-disks-from-replication"></a><span data-ttu-id="5fffa-109">Исключение дисков из репликации</span><span class="sxs-lookup"><span data-stu-id="5fffa-109">Exclude disks from replication</span></span>

<span data-ttu-id="5fffa-110">По умолчанию реплицируются все диски на виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="5fffa-110">By default all disks on a machine are replicated.</span></span> <span data-ttu-id="5fffa-111">Диски можно исключить из репликации.</span><span class="sxs-lookup"><span data-stu-id="5fffa-111">You can exclude disks from replication.</span></span> <span data-ttu-id="5fffa-112">Например, репликация может не требоваться для дисков с временными данными или данными, которые обновляются при каждом перезапуске компьютера или приложения (например, pagefile.sys или базы данных tempdb SQL Server).</span><span class="sxs-lookup"><span data-stu-id="5fffa-112">For example you might not want to replicate disks with temporary data, or data that's refreshed each time a machine or application restarts (for example pagefile.sys or SQL Server tempdb).</span></span> [<span data-ttu-id="5fffa-113">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="5fffa-113">Learn more</span></span>](site-recovery-exclude-disk.md)

## <a name="replicate-vms"></a><span data-ttu-id="5fffa-114">Репликация виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="5fffa-114">Replicate VMs</span></span>

<span data-ttu-id="5fffa-115">Включите репликацию для виртуальных машин, сделав следующее.</span><span class="sxs-lookup"><span data-stu-id="5fffa-115">Enable replication for VMs as follows:</span></span>  

1. <span data-ttu-id="5fffa-116">Последовательно выберите **Шаг 2. Репликация приложения** > **Источник**.</span><span class="sxs-lookup"><span data-stu-id="5fffa-116">Click **Step 2: Replicate application** > **Source**.</span></span> <span data-ttu-id="5fffa-117">Включив репликацию впервые, щелкните **+Replicate** (+ Реплицировать) в хранилище, чтобы включить репликацию для дополнительных машин.</span><span class="sxs-lookup"><span data-stu-id="5fffa-117">After you've enabled replication for the first time, click **+Replicate** in the vault to enable replication for additional machines.</span></span>

    ![Включение репликации](./media/vmm-to-azure-walkthrough-enable-replication/enable-replication1.png)
2. <span data-ttu-id="5fffa-119">В колонке **Источник** выберите сервер VMM и облако, в котором находятся узлы Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="5fffa-119">In the **Source** blade, select the VMM server, and the cloud in which the Hyper-V hosts are located.</span></span> <span data-ttu-id="5fffa-120">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="5fffa-120">Then click **OK**.</span></span>

    ![Включение репликации](./media/vmm-to-azure-walkthrough-enable-replication/enable-replication-source.png)
3. <span data-ttu-id="5fffa-122">В колонке **Цель** выберите подписку, модель развертывания после отработки отказа и учетную запись хранения, используемую для реплицируемых данных.</span><span class="sxs-lookup"><span data-stu-id="5fffa-122">In **Target**, select the subscription, post-failover deployment model, and the storage account you're using for replicated data.</span></span>

    ![Включение репликации](./media/vmm-to-azure-walkthrough-enable-replication/enable-replication-target.png)
4. <span data-ttu-id="5fffa-124">Выберите учетную запись хранения, которую нужно использовать.</span><span class="sxs-lookup"><span data-stu-id="5fffa-124">Select the storage account you want to use.</span></span> <span data-ttu-id="5fffa-125">Если вам нужна другая учетная запись хранения, [создайте ее](#set-up-an-azure-storage-account).</span><span class="sxs-lookup"><span data-stu-id="5fffa-125">If you want to use a different storage account than those you have, you can [create one](#set-up-an-azure-storage-account).</span></span> <span data-ttu-id="5fffa-126">Если для реплицированных данных используется учетная запись хранения "Премиум", потребуется настроить дополнительную учетную запись хранения уровня "Стандартный" для хранения журналов репликации, в которых фиксируются текущие изменения локальных данных. Чтобы создать учетную запись хранения с помощью модели Resource Manager, щелкните **Создать**.</span><span class="sxs-lookup"><span data-stu-id="5fffa-126">If you’re using a premium storage account for replicated data, you need to select  an additional standard storage account to store replication logs that capture ongoing changes to on-premises data.To create a storage account using the Resource Manager model click **Create new**.</span></span> <span data-ttu-id="5fffa-127">Если нужно создать учетную запись хранения, используя классическую модель, это можно сделать на [портале Azure](../storage/common/storage-create-storage-account.md).</span><span class="sxs-lookup"><span data-stu-id="5fffa-127">If you want to create a storage account using the classic model, do that [in the Azure portal](../storage/common/storage-create-storage-account.md).</span></span> <span data-ttu-id="5fffa-128">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="5fffa-128">Then click **OK**.</span></span>
5. <span data-ttu-id="5fffa-129">Выберите сеть и подсеть Azure, к которой будут подключаться виртуальные машины Azure, созданные после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="5fffa-129">Select the Azure network and subnet to which Azure VMs will connect, when they're created after failover.</span></span> <span data-ttu-id="5fffa-130">Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым машинам.</span><span class="sxs-lookup"><span data-stu-id="5fffa-130">Select **Configure now for selected machines**, to apply the network setting to all machines you select for protection.</span></span> <span data-ttu-id="5fffa-131">Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждой машины.</span><span class="sxs-lookup"><span data-stu-id="5fffa-131">Select **Configure later**, to select the Azure network per machine.</span></span> <span data-ttu-id="5fffa-132">Если нужна другая сеть, [создайте ее](#set-up-an-azure-network).</span><span class="sxs-lookup"><span data-stu-id="5fffa-132">If you want to use a different network from those you have, you can [create one](#set-up-an-azure-network).</span></span> <span data-ttu-id="5fffa-133">Чтобы создать сеть с использованием модели Resource Manager, щелкните **Создать**.</span><span class="sxs-lookup"><span data-stu-id="5fffa-133">To create a network using the Resource Manager model click **Create new**.</span></span> <span data-ttu-id="5fffa-134">Если нужно создать сеть, используя классическую модель, это можно сделать [на портале Azure](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).</span><span class="sxs-lookup"><span data-stu-id="5fffa-134">If you want to create a network using the classic model, do that [in the Azure portal](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).</span></span> <span data-ttu-id="5fffa-135">Выберите подсеть (если это применимо).</span><span class="sxs-lookup"><span data-stu-id="5fffa-135">Select a subnet if applicable.</span></span> <span data-ttu-id="5fffa-136">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="5fffa-136">Then click **OK**.</span></span>
6. <span data-ttu-id="5fffa-137">В разделе **Виртуальные машины** > **Выбор виртуальных машин**, выберите каждую машину, которую нужно реплицировать.</span><span class="sxs-lookup"><span data-stu-id="5fffa-137">In **Virtual Machines** > **Select virtual machines**, click and select each machine you want to replicate.</span></span> <span data-ttu-id="5fffa-138">Можно выбрать только те компьютеры, для которых можно включить репликацию.</span><span class="sxs-lookup"><span data-stu-id="5fffa-138">You can only select machines for which replication can be enabled.</span></span> <span data-ttu-id="5fffa-139">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="5fffa-139">Then click **OK**.</span></span>

    ![Включение репликации](./media/vmm-to-azure-walkthrough-enable-replication/enable-replication5.png)

7. <span data-ttu-id="5fffa-141">В поле **Свойства** > **Настройка свойств**, выберите операционную систему для выбранных виртуальных машин и диск операционной системы.</span><span class="sxs-lookup"><span data-stu-id="5fffa-141">In **Properties** > **Configure properties**, select the operating system for the selected VMs, and the OS disk.</span></span>

    - <span data-ttu-id="5fffa-142">Убедитесь, что имя виртуальной машины Azure (имя целевого объекта) соответствует [требованиям к виртуальным машинам Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).</span><span class="sxs-lookup"><span data-stu-id="5fffa-142">Verify that the Azure VM name (target name) complies with [Azure virtual machine requirements](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).</span></span>   
    - <span data-ttu-id="5fffa-143">По умолчанию для репликации выбраны все диски виртуальной машины, но вы можете исключить отдельные диски, сняв с них выделение.</span><span class="sxs-lookup"><span data-stu-id="5fffa-143">By default all the disks of the VM are selected for replication, but you can clear disks to exclude them.</span></span>

        - <span data-ttu-id="5fffa-144">Исключение некоторых дисков позволит снизить связанную с репликацией нагрузку на сеть.</span><span class="sxs-lookup"><span data-stu-id="5fffa-144">You might want to exclude disks to reduce replication bandwidth.</span></span> <span data-ttu-id="5fffa-145">Например, репликация может не требоваться для дисков с временными данными или данными, которые обновляются при каждом перезапуске виртуальной машины или приложения (например, для файлов pagefile.sys или базы данных tempdb Microsoft SQL Server).</span><span class="sxs-lookup"><span data-stu-id="5fffa-145">For example, you might not want to replicate disks with temporary data, or data that's refreshed each time a machine or apps restarts (such as pagefile.sys or Microsoft SQL Server tempdb).</span></span> <span data-ttu-id="5fffa-146">Чтобы исключить диск из репликации, достаточно отменить его выбор.</span><span class="sxs-lookup"><span data-stu-id="5fffa-146">You can exclude the disk from replication by unselecting the disk.</span></span>
        - <span data-ttu-id="5fffa-147">Исключать можно только базовые диски.</span><span class="sxs-lookup"><span data-stu-id="5fffa-147">Only basic disks can be exclude.</span></span> <span data-ttu-id="5fffa-148">Нельзя исключить диски операционной системы.</span><span class="sxs-lookup"><span data-stu-id="5fffa-148">You can't exclude OS disks.</span></span>
        - <span data-ttu-id="5fffa-149">Мы не рекомендуем исключать динамические диски.</span><span class="sxs-lookup"><span data-stu-id="5fffa-149">We recommend that you don't exclude dynamic disks.</span></span> <span data-ttu-id="5fffa-150">Site Recovery не может определить тип виртуального жесткого диска (базовый или динамический) в гостевой виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="5fffa-150">Site Recovery can't identify whether a virtual hard disk inside a guest VM is basic or dynamic.</span></span> <span data-ttu-id="5fffa-151">Если все зависимые динамические диски не исключены, то при отработке отказа виртуальной машины защищенный динамический диск будет считаться неисправным и данные на нем будут недоступны.</span><span class="sxs-lookup"><span data-stu-id="5fffa-151">If all dependent dynamic volume disks aren't excluded, the protected dynamic disk will show as a failed disk when the VM fails over, and the data on that disk won't be accessible.</span></span>
        - <span data-ttu-id="5fffa-152">После включения репликации добавить или удалить диски для репликации нельзя.</span><span class="sxs-lookup"><span data-stu-id="5fffa-152">After replication is enabled, you can't add or remove disks for replication.</span></span> <span data-ttu-id="5fffa-153">Если вы хотите добавить или исключить диск, перед внесением изменений отключите защиту виртуальной машины, а затем включите ее повторно.</span><span class="sxs-lookup"><span data-stu-id="5fffa-153">If you want to add or exclude a disk, you need to disable protection for the VM, and then re-enable it.</span></span>
        - <span data-ttu-id="5fffa-154">Диски, созданные в Azure вручную, не будут восстановлены в исходном расположении.</span><span class="sxs-lookup"><span data-stu-id="5fffa-154">Disks you create manually in Azure aren't failed back.</span></span> <span data-ttu-id="5fffa-155">Например, если вы выполните отработку отказа трех дисков и создадите два диска непосредственно на виртуальной машине Azure, восстановление размещения из Azure в Hyper-V будет выполнено только для трех дисков, задействованных при отработке отказа.</span><span class="sxs-lookup"><span data-stu-id="5fffa-155">For example, if you fail over three disks, and create two directly in Azure VM, only the three disks which were failed over will be failed back from Azure to Hyper-V.</span></span> <span data-ttu-id="5fffa-156">Восстановление размещения после сбоя и обратная репликация из Hyper-V в Azure недоступны для дисков, созданных вручную.</span><span class="sxs-lookup"><span data-stu-id="5fffa-156">You can't include disks created manually in failback, or in reverse replication from Hyper-V to Azure.</span></span>
        - <span data-ttu-id="5fffa-157">Если вы исключили диск, необходимый для работы приложения, для выполнения реплицируемого приложения после отработки отказа в Azure вам необходимо будет создать его в Azure вручную.</span><span class="sxs-lookup"><span data-stu-id="5fffa-157">If you exclude a disk that's needed for an application to operate, after failover to Azure you need to create it manually in Azure, so that the replicated application can run.</span></span> <span data-ttu-id="5fffa-158">Также вы можете интегрировать службу автоматизации Azure в план восстановления, чтобы диск создавался автоматически во время отработки отказа виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="5fffa-158">Alternatively, you could integrate Azure automation into a recovery plan, to create the disk during failover of the machine.</span></span>

    <span data-ttu-id="5fffa-159">Нажмите кнопку **OK**, чтобы сохранить изменения.</span><span class="sxs-lookup"><span data-stu-id="5fffa-159">Click **OK** to save changes.</span></span> <span data-ttu-id="5fffa-160">Позже можно задать дополнительные свойства.</span><span class="sxs-lookup"><span data-stu-id="5fffa-160">You can set additional properties later.</span></span>

    ![Включение репликации](./media/vmm-to-azure-walkthrough-enable-replication/enable-replication6-with-exclude-disk.png)

8. <span data-ttu-id="5fffa-162">Щелкнув **Параметры репликации** > **Настройка параметров репликации**, выберите политику репликации, которую необходимо применить к защищенным виртуальным машинам.</span><span class="sxs-lookup"><span data-stu-id="5fffa-162">In **Replication settings** > **Configure replication settings**, select the replication policy you want to apply for the protected VMs.</span></span> <span data-ttu-id="5fffa-163">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="5fffa-163">Then click **OK**.</span></span> <span data-ttu-id="5fffa-164">Политику репликации можно изменить, последовательно выбрав **Политики репликации** > имя политики > **Изменить параметры**.</span><span class="sxs-lookup"><span data-stu-id="5fffa-164">You can modify the replication policy in **Replication policies** > policy name > **Edit Settings**.</span></span> <span data-ttu-id="5fffa-165">Изменения будут применены как к ВМ, для которых уже выполняется репликация, так и к новым ВМ.</span><span class="sxs-lookup"><span data-stu-id="5fffa-165">Changes you apply are used for machines that are already replicating, and new machines.</span></span>

   ![Включение репликации](./media/vmm-to-azure-walkthrough-enable-replication/enable-replication7.png)

<span data-ttu-id="5fffa-167">Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Задания** > **Задания Azure Site Recovery**.</span><span class="sxs-lookup"><span data-stu-id="5fffa-167">You can track progress of the **Enable Protection** job in **Jobs** > **Site Recovery jobs**.</span></span> <span data-ttu-id="5fffa-168">После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.</span><span class="sxs-lookup"><span data-stu-id="5fffa-168">After the **Finalize Protection** job runs, the machine is ready for failover.</span></span>



## <a name="next-steps"></a><span data-ttu-id="5fffa-169">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="5fffa-169">Next steps</span></span>

<span data-ttu-id="5fffa-170">Перейдите к разделу [Шаг 12. Запуск тестовой отработки отказа](vmm-to-azure-walkthrough-test-failover.md).</span><span class="sxs-lookup"><span data-stu-id="5fffa-170">Go to [Step 12: Run a test failover](vmm-to-azure-walkthrough-test-failover.md)</span></span>

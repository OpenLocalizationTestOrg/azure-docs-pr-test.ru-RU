---
title: "Планирование ресурсов и масштабирования для репликации физического сервера в Azure с помощью Azure Site Recovery | Документация Майкрософт"
description: "В этой статье приведены сведения о планировании ресурсов и масштабировании при репликации физических серверов Windows или Linux в Azure с помощью Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 554f59ee-0b49-4779-9737-90cb601ef6fe
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 06/27/2017
ms.author: rayne
ms.openlocfilehash: 971ad6dd39f94aa7944f6ed3b31bc3acc605d9a7
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="step-3-plan-capacity-and-scaling-for-physical-server-to-azure-replication"></a>Шаг 3. Планирование ресурсов и масштабирования для репликации физического сервера в Azure

В этой статье приведены сведения о планировании ресурсов и масштабировании при репликации локальных физических серверов Windows или Linux в Azure с помощью [Azure Site Recovery](site-recovery-overview.md).

Комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## <a name="plan-deployment-capacity"></a>Планирование емкости развертывания

1. Дополнительные сведения о требованиях к репликации и рекомендации по масштабированию компонентов Site Recovery см. в [этой статье](site-recovery-plan-capacity-vmware.md).
2. Сведения о масштабировании серверов компонентов и управлении пропускной способностью реплицированного компьютера см. в разделах ниже.

## <a name="replication-considerations"></a>Рекомендации относительно репликации

Ниже приведены требования к реплицированному серверу.

**Компонент** | **Дополнительные сведения** 
--- | --- 
**Репликация** | **Максимальный объем ежедневно изменяемых данных.** Защищенный компьютер может использовать только один сервер обработки, а объем ежедневно изменяемых данных на одном сервере обработки может составлять не более 2 ТБ. В связи с этим 2 ТБ — максимальный объем ежедневно изменяемых данных, поддерживаемый защищенным компьютером.<br/><br/> **Максимальная пропускная способность.** Реплицированный компьютер может принадлежать одной учетной записи хранения в Azure. Стандартная учетная запись хранения может обрабатывать не более 20 000 запросов в секунду. Мы рекомендуем не превышать количество в 20 000 операций ввода-вывода в секунду на исходном компьютере. Например, если есть исходный компьютер с 5 дисками, на каждом из которых выполняется по 120 операций ввода-вывода в секунду (размером в 8 КБ), то этот показатель не будет превышать ограничение в 500 операций ввода-вывода в секунду на диск в Azure. Число необходимых учетных записей хранения определяется путем деления общего числа операций ввода-вывода для исходного компьютера на 20 000.

## <a name="configuration-server-capacity"></a>Емкость сервера конфигурации

Сервер конфигурации должен поддерживать суммарный объем ежедневно изменяемых данных для всех рабочих нагрузок, которые выполняются на защищенных компьютерах. Кроме того, он должен обладать достаточной пропускной способностью для непрерывной репликации данных в службу хранилища Azure.

Мы рекомендуем разместить сервер конфигурации в той же сети и в том же сегменте локальной сети, что и компьютеры, которые необходимо защитить. Его можно разместить и в другой сети при наличии у компьютеров, которые нужно защитить, доступа к этой сети третьего уровня.

## <a name="sizing-recommendations"></a>Рекомендации относительно размеров

В следующей таблице приводятся рекомендации относительно размеров, исходя из мощности ЦП.

**ЦП** | **Память** | **Размер диска кэша** | **Частота изменения данных** | **Защищенные компьютеры**
--- | --- | --- | --- | ---
8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц) | 16 ГБ | 300 ГБ | 500 ГБ или менее | Репликация не более 100 компьютеров
12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц) | 18 ГБ | 600 ГБ | От 500 ГБ до 1 ТБ | Репликация от 100 до 150 компьютеров
16 виртуальных ЦП (2 сокета * 8 ядер с частотой 2,5 ГГц) | 32 ГБ | 1 TБ | От 1 ТБ до 2 ТБ | Репликация от 150 до 200 компьютеров
Разверните другой сервер обработки | | | Более 2 ТБ | Разверните дополнительные серверы обработки при репликации более 200 компьютеров или объеме ежедневно изменяемых данных более 2 ТБ.

Описание

* Для каждого исходного компьютера настраивается 3 диска объемом по 100 ГБ каждый.
* Чтобы измерить показатели диска кэша, мы использовали хранилище для тестирования производительности с 8 дисками SAS с частотой вращения шпинделя 10 000 об/мин в конфигурации RAID 10.

## <a name="process-server-capacity"></a>Емкость сервера обработки


Сервер обработки получает данные репликации с защищенных компьютеров и оптимизирует их путем кэширования, сжатия и шифрования, а затем отправляет их в Azure.

- Сервер обработки должен располагать достаточными ресурсами для выполнения этих задач.
- Первый сервер обработки по умолчанию устанавливается на сервере конфигурации. Для масштабирования среды можно развернуть дополнительные серверы обработки.
- Сервер обработки использует дисковый кэш. Чтобы обеспечить обработку хранящихся изменений данных в случае возникновения узкого места в сети или сбоя, установите отдельный диск кэша объемом 600 ГБ и более.
- Если необходимо защитить более 200 компьютеров или объем ежедневно изменяемых данных составляет более 2 ТБ, для обработки такой нагрузки репликации можно добавить серверы обработки. Для развертывания можно выполнить следующее.
    - Увеличить количество серверов конфигурации. Например, с помощью двух серверов конфигурации можно защитить до 400 компьютеров.
    - Добавить дополнительные серверы обработки и использовать их для обработки трафика вместо сервера конфигурации (или вместе с ним).


### <a name="example-process-server-scaling"></a>Пример масштабирования серверов обработки

В таблице ниже описан следующий сценарий.

* Вы не планируете использовать сервер конфигурации в качестве сервера обработки.
* Вы настроили дополнительный сервер обработки.
* Вы настроили для защищенных виртуальных машин дополнительный сервер обработки.
* Для каждого защищенного исходного компьютера настраивается три диска объемом 100 ГБ каждый.

**Сервер конфигурации** | **Дополнительный сервер обработки** | **Размер диска кэша** | **Частота изменения данных** | **Защищенные компьютеры**
--- | --- | --- | --- | ---
8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц), 16 ГБ памяти | 4 виртуальных ЦП (2 сокета * 2 ядра с частотой 2,5 ГГц), 8 ГБ памяти | 300 ГБ | 250 ГБ или менее | Вы можете реплицировать до 85 компьютеров.
8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц), 16 ГБ памяти | 8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц), 12 ГБ памяти | 600 ГБ | От 250 ГБ до 1 ТБ | Репликация от 85 до 150 компьютеров
12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц), 18 ГБ памяти | 12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц), 24 ГБ памяти | 1 TБ | От 1 ТБ до 2 ТБ | Репликация от 150 до 225 компьютеров

Способ масштабирования серверов будет зависеть от выбора модели увеличения масштаба и развертывания.  Вы можете увеличить масштаб, развернув несколько современных серверов конфигурации и обработки, или выполнить развертывание, развернув несколько серверов с меньшим объемом ресурсов. Например, чтобы защитить 220 компьютеров, можно применить одну из следующих рекомендаций.

* Настроить сервер конфигурации с 12 виртуальными ЦП и памятью объемом 18 ГБ, дополнительный сервер обработки с 12 виртуальными ЦП и памятью объемом 24 ГБ, а также защищенные компьютеры для использования только дополнительного сервера обработки.
* Настроить два сервера конфигурации (8 виртуальных ЦП и 16 ГБ ОЗУ в каждом), два дополнительных сервера обработки (8 виртуальных ЦП в одном и 4 виртуальных ЦП, что позволит обрабатывать 220 (135 + 85) компьютеров) и указать, что защищенные компьютеры должны использовать только дополнительные серверы обработки.

## <a name="deploy-additional-process-servers"></a>Развертывание дополнительных серверов обработки

1. Чтобы настроить дополнительный сервер обработки, [выполните эти инструкции](site-recovery-vmware-setup-azure-ps-resource-manager.md).
2. Если у вас нет парольной фразы, выполните на сервере конфигурации команду **<папка_установки_Site_Recovery>\home\sysystems\bin\genpassphrase.exe –n**, чтобы получить ее.
3. После настройки сервера обработки необходимо перевести исходные компьютеры на его использование.

    1. Выберите **Параметры** > **Site Recovery servers** (Серверы Site Recovery), выберите сервер конфигурации и щелкните **Серверы обработки**.
    2. Щелкните используемый сервер обработки правой кнопкой мыши и выберите **Переключить**.
    3. В поле **Выбор целевого сервера обработки** выберите сервер обработки, который нужно использовать, и укажите виртуальные машины, с которыми он будет работать.
    4. Щелкните значок сведений. Чтобы помочь принять решение о скачивании, отображается средний объем свободного места, требуемый для репликации каждой выбранной виртуальной машины на новом сервере обработки.
    5. Щелкните флажок, чтобы начать репликацию на новом сервере обработки.

## <a name="control-network-bandwidth"></a>Управление пропускной способностью сети

После того, как [инструмент Deployment Planner](site-recovery-deployment-planner.md) рассчитает пропускную способность, необходимую для репликации (начальной и разностной), вы можете управлять объемом пропускной способности, используемой для репликации. Для этого существует несколько способов:

* **Регулирование пропускной способности**. Трафик VMware, который реплицируется в Azure, проходит через определенный сервер обработки. Пропускную способность можно регулировать на компьютерах, которые служат серверами обработки.
* **Изменение пропускной способности.** Пропускную способность, используемую для репликации, можно изменить с помощью нескольких разделов реестра:
  * Значение реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\UploadThreadsPerVM** задает количество потоков, используемых для передачи данных диска (для начальной или разностной репликации данных). Если задать высокое значение, пропускная способность сети, используемая для репликации, увеличивается.
  * Значение **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\DownloadThreadsPerVM** задает количество потоков, используемых для передачи данных при восстановлении размещения.

### <a name="throttle-bandwidth"></a>Регулирование пропускной способности

1. Откройте оснастку MMC в службе архивации Azure на компьютере, который выступает в качестве сервера обработки. По умолчанию ярлык для службы архивации расположен на рабочем столе или в папке C:\Program Files\Microsoft Azure Recovery Services Agent\bin\wabadmin.
2. В оснастке щелкните **Изменить свойства**.
3. На вкладке **Регулирование** установите флажок **Разрешить регулирование уровня использования пропускной способности канала для операций резервного копирования**.
4. Задайте ограничения для рабочего и нерабочего времени. Допустимы значения в диапазоне от 512 Кбит/с до 102 Мбит/с.

    ![Регулирование](./media/physical-walkthrough-capacity/throttle2.png)

Чтобы настроить регулирование, можно также использовать командлет [Set-OBMachineSetting](https://technet.microsoft.com/library/hh770409.aspx) . Рассмотрим пример:

    $mon = [System.DayOfWeek]::Monday
    $tue = [System.DayOfWeek]::Tuesday
    Set-OBMachineSetting -WorkDay $mon, $tue -StartWorkHour "9:00:00" -EndWorkHour "18:00:00" -WorkHourBandwidth  (512*1024) -NonWorkHourBandwidth (2048*1024)

**Set-OBMachineSetting -NoThrottle** указывает, что регулирование не требуется.

### <a name="influence-network-bandwidth-for-a-vm"></a>Изменение пропускной способности сети для виртуальной машины

1. В реестре виртуальной машины перейдите в раздел **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication**.
   * Чтобы изменить скорость передачи данных при репликации диска, задайте новое значение для раздела **UploadThreadsPerVM** или создайте его, если он еще не существует.
   * Чтобы изменить скорость передачи данных при восстановлении размещения из Azure, задайте новое значение для раздела **DownloadThreadsPerVM**.
2. Значение по умолчанию — 4. В сети со значительным избыточным резервом эти разделы реестра необходимо изменить. Максимальное значение — 32. Следите за трафиком для оптимизации значения.




## <a name="next-steps"></a>Дальнейшие действия

Перейдите к статье [Шаг 4. Планирование сетей для репликации физического сервера в Azure](physical-walkthrough-network.md).

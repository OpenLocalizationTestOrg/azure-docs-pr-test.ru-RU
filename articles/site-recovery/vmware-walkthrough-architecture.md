---
title: "Общие сведения об архитектуре для репликации из VMware в Azure | Документация Майкрософт"
description: "В этой статье представлен обзор компонентов и архитектуры, используемых при репликации виртуальных машин VMware из локальной среды в Azure с помощью службы Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: c413efcd-d750-4b22-b34b-15bcaa03934a
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/27.017
ms.author: raynew
ms.openlocfilehash: 2bbab5f1ac0efe9632ad6c818504584e2503cf15
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="step-1-review-the-architecture-for-vmware-replication-to-azure"></a>Шаг 1. Общие сведения об архитектуре для репликации из VMware в Azure

В этой статье описываются компоненты и процессы, используемые при репликации виртуальных машин VMware из локальной среды в Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).

Все комментарии можно добавить в конце этой статьи. Вопросы можно задать на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## <a name="architectural-components"></a>Компоненты архитектуры

В этой таблице приведены необходимые компоненты.

**Компонент** | **Требование** | **Дополнительные сведения**
--- | --- | ---
**Таблицы Azure** | Требуется подписка Azure, учетная запись хранения Azure и сеть Azure. | Реплицированные данные хранятся в учетной записи хранения. Виртуальные машины Azure создаются с использованием реплицированных данных при отработке отказа с локального сайта. При создании виртуальные машины Azure подключаются к виртуальной сети Azure.
**Сервер конфигурации** | Обособленный локальный сервер управления (виртуальная машина VMware), на котором работают все необходимые для развертывания локальные компоненты. К ним относятся сервер конфигурации, сервер обработки и главный целевой сервер. | Компонент сервера конфигурации используется для координации обмена данными между локальным источником и Azure, а также для управления репликацией данных.
 **Сервер обработки**  | По умолчанию устанавливается на сервере конфигурации. | Выступает в качестве шлюза репликации. Получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure.<br/><br/> Сервер обработки также обеспечивает принудительную установку службы Mobility Service на защищенные компьютеры и выполняет автоматическое обнаружение виртуальных машин VMware.<br/><br/> По мере увеличения масштаба развертывания вы можете добавлять дополнительные выделенные серверы для обработки растущего объема данных репликации.
 **Главный целевой сервер** | По умолчанию устанавливается на локальном сервере конфигурации. | Обрабатывает данные репликации при восстановлении размещения с переносом из Azure.<br/><br/> Если объемы трафика восстановления размещения высоки, можно развернуть отдельный главный целевой сервер.
**Серверы VMware** | Виртуальные машины VMware размещаются на серверах vSphere ESXi. Мы рекомендуем управлять узлами с помощью сервера vCenter. | Добавьте серверы VMware в хранилище служб восстановления.
**Реплицируемые компьютеры** | Служба Mobility Service будет установлена на каждой реплицируемой виртуальной машине VMware. Ее можно установить вручную или с помощью принудительной установки с сервера обработки.

**Рис. 1. Компоненты VMware, реплицируемые в Azure**

![Компоненты](./media/vmware-walkthrough-architecture/arch-enhanced.png)

## <a name="replication-process"></a>Процесс репликации

1. Необходимо настроить развертывание, в том числе локальные компоненты и компоненты Azure. В хранилище служб восстановления необходимо указать источник и целевой объект репликации, настроить сервер конфигурации, создать политику репликации, развернуть службу Mobility Service, включить репликацию и запустить тестовую отработку отказа.
2. Компьютеры выполняют репликацию в соответствии с политикой репликации, а репликация начальной копии данных выполняется в службу хранилища Azure.
3. После завершения начальной репликации начинается репликация разностных изменений в Azure. Отслеживаемые изменения для компьютера хранятся в HRL-файле.
    - Реплицируемые компьютеры обмениваются данными с сервером конфигурации через порт HTTPS 443 для входящих подключений для управления репликацией.
    - Реплицируемые компьютеры отправляют данные репликации на сервер обработки через порт HTTPS 9443 для входящих подключений (можно изменить).
    - Сервер конфигурации выполняет оркестрацию управления репликацией с Azure через порт HTTPS 443 для исходящих подключений.
    - Сервер обработки получает данные с исходных компьютеров, оптимизирует и зашифровывает их, а затем отправляет их в службу хранилища Azure через порт 443 для исходящих подключений.
    - Если включить согласованность между виртуальными машинами, компьютеры в группе репликации будут обмениваться данными друг с другом через порт 20004. Эту функция используется, если вы объединяете несколько компьютеров в группы репликации, и они совместно используют отказоустойчивые и согласованные точки восстановления после отработки отказа. Это полезно, если на компьютерах выполняется одна и та же рабочая нагрузка и они должны быть согласованы.
4. Трафик реплицируется в общедоступные конечные точки службы хранилища Azure через Интернет. Кроме того, можно использовать [общедоступный пиринг](../expressroute/expressroute-circuit-peerings.md#azure-public-peering) Azure ExpressRoute. Репликация трафика через VPN типа "сеть — сеть" с локального сайта в Azure не поддерживается.


**Рис. 2. Репликация VMware в Azure**

![Расширенная архитектура](./media/vmware-walkthrough-architecture/v2a-architecture-henry.png)

## <a name="failover-and-failback-process"></a>Процесс отработки отказа и восстановления размещения

1. Убедившись, что тестовая отработка отказа работает правильно, при необходимости выполните незапланированную отработку отказа в Azure. Плановая отработка отказа не поддерживается.
2. Вы можете выполнить отработку отказа одного компьютера или создать [планы восстановления](site-recovery-create-recovery-plans.md), чтобы выполнить отработку отказа нескольких виртуальных машин.
3. При отработке отказа в Azure создаются виртуальные машины реплик. Фиксация отработки отказа выполняется для получения доступа к рабочей нагрузке из виртуальной машины реплики Azure.
4. Когда основной локальный сайт снова станет доступным, вы сможете выполнить восстановление размещения. Вы настраиваете инфраструктуру восстановления размещения, запускаете репликацию компьютера с дополнительного сайта на основной и выполняете внеплановую отработку отказа с дополнительного сайта. После того, как это восстановление размещения будет зафиксировано, данные переместятся обратно в локальное расположение, и вам понадобится включить репликацию в Azure снова. [Дополнительные сведения](site-recovery-failback-azure-to-vmware.md)

Есть ряд требований к восстановлению размещения.


- **Временный сервер обработки в Azure.** Если вы хотите восстановить размещение из Azure после отработки отказа, необходимо настроить виртуальную машину Azure в качестве сервера обработки, который будет обрабатывать репликацию из Azure. После восстановления размещения эту виртуальную машину можно удалить.
- **VPN-подключение.** Для восстановления размещения вам потребуется настроить VPN-подключение (или Azure ExpressRoute) между сетью Azure и локальным сайтом.
- **Отдельный локальный главный целевой сервер.** Локальный главный целевой сервер обрабатывает восстановление размещения. Главный целевой сервер устанавливается по умолчанию на сервер управления, но если восстанавливается размещение больших объемов трафика, настройте для этой цели отдельный локальный главный целевой сервер.
- **Политика восстановления размещения.** Для репликации обратно на локальный сайт необходима политика восстановления размещения. Она создается автоматически во время создания политики репликации.
- **Инфраструктура VMware.** Размещение необходимо восстанавливать на локальную виртуальную машину VMware. Это означает, что даже при репликации локальных физических серверов в Azure требуется локальная инфраструктура VMware.

**Рис. 3. Восстановление размещения виртуальных машин или физических компьютеров VMware**

![Восстановление размещения](./media/vmware-walkthrough-architecture/enhanced-failback.png)


## <a name="next-steps"></a>Дальнейшие действия

Перейдите к разделу [Шаг 2. Проверка предварительных требований для репликации из VMware в Azure](vmware-walkthrough-prerequisites.md).

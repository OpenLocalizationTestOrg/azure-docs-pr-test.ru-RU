---
title: "Отработка отказа и восстановление размещения виртуальных машин VMware и физических серверов, реплицированных в Azure, с помощью Site Recovery | Документы Майкрософт"
description: "Сведения об отработке отказа виртуальных машин VMware и физических серверов в Azure и восстановление размещения на локальном сайте с помощью Azure Site Recovery"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 11/01/2017
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 28a14a9b28dfe9c2014add9b9f691bce6ba91a4c
ms.sourcegitcommit: e462e5cca2424ce36423f9eff3a0cf250ac146ad
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/01/2017
---
# <a name="fail-over-and-fail-back-vmware-vms-and-physical-servers-replicated-to-azure"></a>Отработка отказа и восстановление размещения виртуальных машин VMware и физических серверов, реплицированных в Azure

В этом учебнике содержатся сведения об отработке отказа виртуальных машин VMware в Azure. Восстановление размещения на локальном сайте после отработки отказа происходит в тех ситуациях, когда это возможно. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Проверка соответствия свойств виртуальной машины VMware требованиям Azure
> * Выполнение отработки отказа в Azure
> * Создание сервера обработки и главного целевого сервера для восстановления размещения
> * Повторное включение защиты виртуальных машин Azure на локальном сайте
> * Отработка отказа из Azure в локальную среду
> * Повторное включение защиты локальных виртуальных машин для запуска повторной репликации в Azure

Это пятый учебник в серии. В этом учебнике предполагается, что вы уже выполнили задачи в предыдущих учебниках.

1. [Подготовка Azure](tutorial-prepare-azure.md)
2. [Подготовка локальной среды VMware](tutorial-prepare-on-premises-vmware.md)
3. [Настройка аварийного восстановления](tutorial-vmware-to-azure.md)
4. [Выполнение отработки аварийного восстановления](tutorial-dr-drill-azure.md)

## <a name="preparing-for-failover-and-failback"></a>Подготовка к отработке отказа и восстановлению размещения

Убедитесь, что на виртуальной машине нет моментальных снимков. Во время повторного включения защиты локальная виртуальная машина отключается.
Это позволяет обеспечить согласованность данных во время репликации. Не включайте виртуальную машину после завершения повторного включения защиты. Для повторной защиты группы репликации используйте тот же главный целевой сервер. При выборе другого главного целевого сервера он не сможет предоставить общую точку во времени.

Отработка отказа и восстановление размещения происходит в четыре этапа.

1. **Переход на другой ресурс в Azure**. Перенос машин с локального сайта в Azure.
2. **Повторное включение защиты виртуальных машин Azure**. Повторное включение защиты виртуальных машин, чтобы начать их репликацию в виртуальные машины VMware, запущенные на локальном сайте.
3. **Переход на другой ресурс в локальной среде**. Выполнение отработки отказа для восстановления размещения из Azure.
4. **Повторное включение защиты локальных виртуальных машин**. После восстановления размещения данных следует повторно включить защиту локальных виртуальных машин, на которые выполнено восстановление размещения, чтобы начать их репликацию в Azure.

## <a name="verify-vm-properties"></a>Проверка свойств виртуальной машины

Проверьте свойства виртуальной машины и убедитесь, что виртуальная машина соответствует [требованиям Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).

1. В разделе **Защищенные элементы** щелкните **Реплицированные элементы** и выберите виртуальную машину.

2. В области **Реплицированный элемент** находятся сводные данные о виртуальной машине, включая состояние работоспособности и последние доступные точки восстановления. Щелкните **Свойства**, чтобы просмотреть дополнительные сведения.

3. В области **Вычисления и сеть** можно изменить имя Azure, группу ресурсов, целевой размер, [группу доступности](../virtual-machines/windows/tutorial-availability-sets.md) и [параметры управляемого диска](#managed-disk-considerations).

4. Можно просмотреть или изменить параметры сети, включая сеть (или подсеть), в которой будет размещаться виртуальная машина Azure после отработки отказа, и IP-адрес, который будет ей назначен.

5. В разделе **Диски** отображаются сведения о дисках операционной системы и дисках данных на виртуальной машине.

## <a name="run-a-failover-to-azure"></a>Выполнение отработки отказа в Azure

1. В разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину и щелкните **Отработка отказа**.

2. В разделе **Отработка отказа** выберите **точку восстановления**, в которую будет выполнена отработка отказа. Можно выбрать один из следующих вариантов:
   - **Последние** (по умолчанию). В этом случае сначала обрабатываются все данные, отправляемые в Site Recovery. Этот вариант обеспечивает самое низкое значение RPO (целевая точка восстановления), так как виртуальная машина Azure, созданная после отработки отказа, будет иметь все данные, реплицированные в службу Site Recovery до момента активации отработки отказа.
   - **Последняя обработанная.** Отработка отказа выполняется до последней точки восстановления виртуальной машины, которая была обработана Site Recovery. Этот вариант обеспечивает низкий показатель целевого времени восстановления, так как не требует времени на обработку данных.
   - **Latest app-consistent** (Последняя точка во времени согласованности приложений). Отработка отказа виртуальной машины выполняется до последней точки восстановления с согласованным состоянием приложений, которая была обработана Site Recovery.
   - **Настраиваемая**. Следует указать точку восстановления.

3. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**, чтобы попытаться выключить исходные виртуальные машины, прежде чем запускать отработку отказа. Отработка отказа продолжится, даже если их не удастся отключить. На странице **Задания** можно следить за ходом выполнения отработки отказа.

4. Если вы готовы подключиться к виртуальной машине Azure, сделайте это, чтобы проверить ее после отработки отказа.

5. После проверки **зафиксируйте** отработку отказа. При этом будут удалены все доступные точки восстановления.

> [!WARNING]
> **Не отменяйте выполняющуюся отработку отказа**. Перед запуском отработки отказа останавливается репликация виртуальной машины.
> Если отменить выполняющуюся отработку отказа, она остановится, но виртуальная машина не будет реплицирована повторно.

В некоторых сценариях требуется дополнительная обработка отработки отказа, которая длится около 8–10 минут. Тестовая отработка отказа для физических серверов, компьютеров Linux VMware, виртуальных машин VMware без включенной службы DHCP и виртуальных машин VMware без загрузочных драйверов storvsc, vmbus, storflt, intelide, atapi может занимать больше времени.

## <a name="create-a-process-server-in-azure"></a>Создание сервера обработки в Azure

Сервер обработки получает данные из виртуальных машин в Azure и отправляет их на локальный сайт. Между сервером обработки и защищенной виртуальной машиной должна быть настроена сеть с низкой задержкой.

- При наличии подключения к Azure ExpressRoute для целей тестирования можно использовать локальный сервер обработки, который автоматически устанавливается на сервере конфигурации.
- Если имеется VPN-подключение или восстановление размещения выполняется в рабочей среде, необходимо настроить виртуальную машину Azure как сервер обработки на основе Azure.
- Чтобы настроить сервер обработки в Azure, следуйте инструкциям в [этой статье](site-recovery-vmware-setup-azure-ps-resource-manager.md).

## <a name="configure-the-master-target-server"></a>Настройка главного целевого сервера

По умолчанию главный целевой сервер работает на локальном сервере конфигурации. В рамках этого руководства используется главный сервер по умолчанию. Главный целевой сервер принимает данные восстановления размещения.

Если виртуальная машина находится на узле ESXi под управлением сервера vCenter, целевой главный сервер должен иметь доступ к хранилищу данных виртуальной машины (VMDK), чтобы записывать реплицированные данные на диски виртуальной машины. Убедитесь, что хранилище данных виртуальной машины подключено к узлу главного целевого сервера с доступом на чтение и запись.

Если виртуальная машина находится на узле ESXi, который не управляется сервером vCenter, служба Site Recovery создаст виртуальную машину во время повторного включения защиты. Виртуальная машина создается на узле ESX, на котором создан главный целевой сервер.
Жесткий диск виртуальной машины должен находиться в хранилище данных, доступном для узла, на котором работает главный целевой сервер.

Если виртуальная машина не использует vCenter, перед повторным включением защиты машины следует выполнить обнаружение узла, на котором работает главный целевой сервер. Это применимо, если выполняется восстановление размещения и для физических серверов. Второй вариант: при наличии локальной виртуальной машины удалите ее, прежде чем выполнить восстановление размещения. Затем служба восстановления размещения создаст новую виртуальную машину на том же узле, где находится главный целевой узел ESX. Если восстановление размещения выполняется в альтернативном расположении, данные будут восстановлены в то же хранилище данных и тот же узел ESX, которые использует локальный главный целевой сервер.

Вы не можете использовать технологию Storage vMotion на главном целевом сервере. В противном случае восстановление размещения не будет работать, поскольку отсутствуют доступные диски. Исключите главные целевые серверы из списка vMotion.

## <a name="reprotect-azure-vms"></a>Повторное включение защиты виртуальных машин Azure

Эта процедура предполагает, что локальная виртуальная машина недоступна и повторное включение защиты выполняется в альтернативное расположение.

1. В разделе **Параметры** > **Реплицированные элементы** щелкните правой кнопкой мыши виртуальную машину, для которой была выполнена отработка отказа, и выберите **Защитить повторно**.
2. В окне **Повторная защита** выберите **Из Azure в локальную среду**.
3. Укажите локальный главный целевой сервер и сервер обработки.

4. В поле **Хранилище данных** выберите главное целевое хранилище данных, для которого нужно восстановить диски локальной среды. Используйте этот параметр, если локальная виртуальная машина была удалена и вам нужно создать новые диски. Хотя этот параметр не учитывается, если диски уже существуют, его значение необходимо указать.
5. Выберите главный целевой диск для хранения. Политика восстановления размещения выбирается автоматически.
6. Нажмите кнопку **ОК**, чтобы начать процесс повторной защиты. Задание начнет реплицировать виртуальную машину из Azure на локальный сайт. Ход выполнения операции можно отслеживать на вкладке **Задания** .

> [!NOTE]
> Если вы хотите восстановить виртуальную машину Azure в существующую локальную виртуальную машину, подключите ее хранилище данных локальной виртуальной машины с доступом на чтение и запись к узлу ESXi главного целевого сервера.


## <a name="run-a-failover-from-azure-to-on-premises"></a>Выполнение отработки отказа из Azure в локальную среду

Для репликации данных обратно в локальную среду используется политика восстановления размещения. Эта политика автоматически создается при создании политики репликации для репликации в Azure.

- Политика автоматически сопоставляется с сервером конфигурации.
- Политику невозможно изменить.
- Политика имеет следующие значения:
    - Пороговое значение RPO: 15 минут.
    - Хранение точки восстановления: 24 часа.
    - Периодичность создания моментальных снимков с согласованием приложений: 60 минут.

Выполните отработку отказа следующим образом:

1. На странице **Реплицированные элементы** щелкните правой кнопкой мыши виртуальную машину и выберите пункт **Внеплановая отработка отказа**.
2. На странице **Подтверждение отработки отказа** должно быть указано направление отработки отказа "Из Azure".

3. Выберите точку восстановления, которую вы хотите использовать для отработки отказа. Точка восстановления с согласованием приложений предшествует самой последней точке во времени, что приведет к потере некоторых данных. При отработке отказа служба Site Recovery отключает виртуальные машины Azure и загружает локальную виртуальную машину. Чтобы исключить время простоя, выберите подходящий момент.
4. Щелкните машину правой кнопкой мыши, а затем выберите пункт **Зафиксировать**. Будет запущено задание по удалению виртуальных машин Azure.
5. Убедитесь, что работа виртуальной машины Azure была завершена должным образом.


## <a name="reprotect-on-premises-machines-to-azure"></a>Повторное включение защиты локальных машин в Azure

Теперь данные будут снова находиться на локальном сайте, но они не реплицируются в Azure. Чтобы еще раз выполнить репликацию в Azure, сделайте следующее.

1. В разделе "Хранилище" > **Параметры** >**Реплицированные элементы** выберите виртуальные машины, для которых выполнено восстановление размещения, и щелкните **Защитить повторно**.
2. Выберите сервер обработки, который используется для отправки реплицированных данных в Azure, и нажмите кнопку **ОК**.

После завершения повторного включения защиты виртуальная машина будет снова реплицироваться в Azure, и вы сможете выполнять отработку отказа.

---
title: "Защита Active Directory и DNS с помощью Azure Site Recovery | Документация Майкрософт"
description: "В этой статье описывается, как реализовать решение аварийного восстановления для Active Directory с помощью Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: prateek9us
manager: gauravd
editor: 
ms.assetid: af1d9b26-1956-46ef-bd05-c545980b72dc
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 7/20/2017
ms.author: pratshar
ms.openlocfilehash: 197441fc24c178695d4eada6db59f503b21672ad
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="protect-active-directory-and-dns-with-azure-site-recovery"></a>Защита Active Directory и DNS с Azure Site Recovery
Правильная работа корпоративных приложений, таких как SharePoint, Dynamics AX и SAP, зависит от Active Directory и инфраструктуры DNS. При создании решения аварийного восстановления для приложений важно помнить, что необходимо защищать и восстанавливать работу Active Directory и DNS раньше других компонентов приложения, чтобы гарантировать сохранение работоспособности при возникновении аварии.

Site Recovery — это служба Azure, которая обеспечивает аварийное восстановление, управляя процессами репликации, отработки отказа и восстановления виртуальных машин. Site Recovery поддерживает ряд сценариев репликации для надежной защиты и плавной отработки отказа виртуальных машин и приложений в общедоступные и закрытые облака, а также в облака хостера.

С помощью Site Recovery можно создать полностью автоматизированный план аварийного восстановления для Active Directory. При прерывании работы отработку отказа можно запустить из любого места в течение нескольких секунд и таким образом восстановить работоспособность Active Directory за считанные минуты. Если на основном сайте вы развернули Active Directory для нескольких приложений (таких как SharePoint и SAP) и хотите, чтобы отработка отказа включала весь сайт, вы можете сначала выполнить отработку отказа Active Directory с помощью Site Recovery, а затем отработку отказа других приложений с помощью связанных с приложениями планов восстановления.

В этой статье описано создание решения аварийного восстановления для Active Directory и выполнение плановых, внеплановых и тестовых отработок отказов с помощью быстрого плана восстановления, а также указаны поддерживаемые конфигурации и предварительные требования.  Перед началом работы необходимо ознакомиться с Active Directory и Azure Site Recovery.

## <a name="replicating-domain-controller"></a>Репликация контроллера домена

По крайней мере на одной виртуальной машине с контроллером домена и DNS необходимо настроить [репликацию Site Recovery](#enable-protection-using-site-recovery). Если в вашей среде [несколько контроллеров доменов](#environment-with-multiple-domain-controllers), то в дополнение к репликации виртуальной машины с контроллером домена с помощью Site Recovery также рекомендуется настроить [дополнительный контроллер домена](#protect-active-directory-with-active-directory-replication) на целевом сайте (сайте Azure или дополнительном локальном центре обработки данных). 

### <a name="single-domain-controller-environment"></a>Среда с одним контроллером домена
Если в вашей среде несколько приложений и только один контроллер домена и при этом необходимо выполнить отработку отказа всего сайта, рекомендуется использовать Site Recovery для репликации контроллера домена на вторичный сайт (независимо от того, выполняется ли отработка отказа в Azure или на вторичный сайт). Эту же реплицированную виртуальную машину с контроллером домена или DNS можно использовать для [тестовой отработки отказа](#test-failover-considerations).

### <a name="environment-with-multiple-domain-controllers"></a>Среда с несколькими контроллерами доменов
Если в вашей среде много приложений и несколько контроллеров доменов, и при этом вы планируете выполнять отработку отказа для нескольких приложений одновременно, рекомендуется в дополнение к репликации виртуальной машины с контроллером домена с помощью Site Recovery также настроить [дополнительный контроллер домена](#protect-active-directory-with-active-directory-replication) на целевом сайте (сайте Azure или дополнительном локальном центре обработки данных). Для [тестовой отработки отказа](#test-failover-considerations) используйте контроллер домена, реплицированный с помощью Site Recovery. А для реальной отработки отказа используйте дополнительный контроллер домена на конечном сайте. 


В следующих разделах объясняется, как включить защиту для контроллера домена в Site Recovery и настроить контроллер домена в Azure.

## <a name="prerequisites"></a>Предварительные требования
* Локально развернутые Active Directory и DNS-сервер.
* Хранилище служб Azure Site Recovery в подписке Microsoft Azure.
* При репликации в Azure запустите средство оценки готовности виртуальных машин Azure на виртуальных машинах, чтобы убедиться в их совместимости с виртуальными машинами Azure и службами Azure Site Recovery.

## <a name="enable-protection-using-site-recovery"></a>Включение защиты с помощью Site Recovery
### <a name="protect-the-virtual-machine"></a>Защита виртуальной машины
Включите защиту виртуальной машины с контроллером домена или DNS в Site Recovery. Настройте параметры Site Recovery на основе типа виртуальной машины (Hyper-V или VMware). Контроллер домена, реплицированный с помощью Site Recovery, используется для [тестовой отработки отказа](#test-failover-considerations). Убедитесь, что он соответствует следующим требованиям.

1. Контроллер домена должен быть сервером глобального каталога.
2. Контроллер домена должен быть владельцем роли FSMO для ролей, которые потребуются для тестовой отработки отказа (или эти роли должны быть [заняты](http://aka.ms/ad_seize_fsmo) после отработки отказа).

### <a name="configure-virtual-machine-network-settings"></a>Настройка сетевых параметров виртуальной машины
Для виртуальной машины с контроллером домена или DNS настройте сетевые параметры в Site Recovery так, чтобы после отработки отказа виртуальная машина подключалась к правильной сети. 

![Параметры сети виртуальных машин](./media/site-recovery-active-directory/DNS-Target-IP.png)

## <a name="protect-active-directory-with-active-directory-replication"></a>Защита Active Directory с помощью репликации Active Directory
### <a name="site-to-site-protection"></a>Защита "сайт-сайт"
Создайте контроллер домена на дополнительном сайте. При повышении роли сервера до роли контроллера домена укажите имя домена, которое используется на основном сайте. Чтобы настроить параметры объекта связывания сайтов, в который добавляются сайты, можно использовать оснастку **Active Directory — сайты и службы**. Настраивая параметры связи между сайтами, можно указать время и периодичность репликации между двумя или несколькими сайтами. Дополнительные сведения см. в статье [Расписание репликации между сайтами](https://technet.microsoft.com/library/cc731862.aspx).

### <a name="site-to-azure-protection"></a>Защита "сайт-Azure"
Выполните инструкции по [созданию контроллера домена в виртуальной сети Azure](../active-directory/active-directory-install-replica-active-directory-domain-controller.md). При повышении роли сервера до роли контроллера домена укажите имя домена, которое используется на основном сайте.

Затем [измените конфигурацию DNS-сервера для виртуальной сети](../active-directory/active-directory-install-replica-active-directory-domain-controller.md#reconfigure-dns-server-for-the-virtual-network), так чтобы использовался сервер DNS в Azure.

![Сеть Azure](./media/site-recovery-active-directory/azure-network.png)

**DNS в рабочей сети Azure**

## <a name="test-failover-considerations"></a>Рекомендации по тестированию отработки отказа
Тестовая отработка отказа проводится в сети, изолированной от рабочей сети, чтобы не мешать выполнению рабочих нагрузок.

Для работы большинства приложений требуется также контроллер домена и DNS-сервер. Таким образом, прежде чем выполнять отработку отказа для приложения, необходимо создать в изолированной сети контроллер домена, который будет использоваться при отработке отказа. Это проще всего сделать, реплицировав с помощью Site Recovery виртуальную машину с контроллером домена и (или) DNS. Запустите тестовую отработку отказа виртуальной машины с контроллером домена, прежде чем запускать тестовую отработку отказа плана восстановления для приложения. Вот как это сделать:

1. [Реплицируйте](site-recovery-replicate-vmware-to-azure.md) виртуальную машину с контроллером домена и (или) DNS с помощью Site Recovery.
1. Создайте изолированную сеть. Любая виртуальная сеть, созданная в Azure, по умолчанию изолируется от другой сети. Рекомендуем использовать для этой сети такой же диапазон IP-адресов, как у вашей рабочей сети. Не включайте для этой сети подключение между сайтами.
1. В качестве IP-адреса DNS в созданной сети укажите IP-адрес, который должна получить виртуальная машина с DNS. При репликации в Azure в разделе **Вычисления и сеть** в поле **Целевой IP-адрес** укажите IP-адрес виртуальной машины, которая будет использоваться для отработки отказа. 

    ![Целевой IP-адрес](./media/site-recovery-active-directory/DNS-Target-IP.png) **Целевой IP-адрес**

    ![Тестовая сеть Azure](./media/site-recovery-active-directory/azure-test-network.png)

    **DNS в тестовой сети Azure**

> [!TIP]
> Служба Site Recovery попытается создать тестовые виртуальные машины в подсети с таким же именем, используя тот же IP-адрес, который был указан в разделе параметров **Вычисления и сеть** виртуальной машины. Если подсеть с таким же именем недоступна в виртуальной сети Azure, предоставленной для тестовой отработки отказа, тестовая виртуальная машина создается в первой по алфавиту подсети. Если целевой IP-адрес является частью выбранной подсети, Site Recovery попытается создать виртуальную машину для тестовой обработки отказа с его использованием. Иначе виртуальная машина для тестовой обработки отказа будет создана с использованием любого доступного IP-адреса в выбранной подсети. 
>
>


1. Если выполняется репликация на другой локальный сайт и вы используете DHCP, следуйте инструкциям по [настройке DNS и DHCP для тестовой отработки отказа](site-recovery-test-failover-vmm-to-vmm.md#prepare-dhcp).
1. Не выполняйте тестовую отработку отказа на виртуальной машине с контроллером домена в изолированной сети. Для выполнения тестовой отработки отказа используйте последнюю точку восстановления виртуальной машины контроллера домена, **согласованную с приложениями**. 
1. Запустите тестовую отработку отказа для плана восстановления, который содержит виртуальные машины приложения. 
1. После завершения тестирования **очистите тестовую отработку отказа** на виртуальной машине с контроллером домена. Этот шаг удаляет контроллер домена, который был создан для тестовой отработки отказа.


### <a name="removing-reference-to-other-domain-controllers"></a>Удаление ссылки на другие контроллеры домена
При выполнении тестовой отработки отказа не нужно переносить все контроллеры домена в тестовую сеть. Чтобы удалить ссылку на другие контроллеры домена, которые существуют в рабочей среде, необходимо [занять роли FSMO Active Directory](http://aka.ms/ad_seize_fsmo) и [очистить метаданные](https://technet.microsoft.com/library/cc816907.aspx) для отсутствующих контроллеров домена. 



> [!IMPORTANT]
> Некоторые конфигурации, описанные в следующем разделе, не являются стандартными для контроллера домена. Если вы не хотите вносить эти изменения в рабочий контроллер домена, вы можете создать отдельный контроллер домена для тестовой отработки отказа Site Recovery и внести эти изменения в него.  
>
>

### <a name="issues-because-of-virtualization-safeguards"></a>Вопросы, связанные с мерами по обеспечению безопасности виртуализации 

Начиная с Windows Server 2012 в [Active Directory Domain Services предусмотрены дополнительные меры безопасности](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100). Эти меры безопасности помогают защитить виртуализированные контроллеры домена от откатов USN при условии, что базовая платформа низкоуровневой оболочки поддерживает VM-GenerationID. Azure поддерживает VM-GenerationID, а это значит, что контроллеры доменов, которые работают под управлением Windows Server 2012 или более поздних версий на виртуальных машинах Azure, будут защищены дополнительными мерами безопасности. 


При сбросе VM-GenerationID также сбрасывается invocationID базы данных AD DS, удаляется пул RID, а SYSVOL помечается как не заслуживающий доверия. Дополнительные сведения см. в документах, посвященных [знакомству с виртуализацией доменных служб Active Directory](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100) и [безопасной виртуализации DFSR](https://blogs.technet.microsoft.com/filecab/2013/04/05/safely-virtualizing-dfsr/).

Отработка отказа в Azure может вызвать сброс VM-GenerationID и включение дополнительных мер безопасности при запуске в Azure виртуальной машины с контроллером домена. Это может привести к **значительной задержке** при входе пользователя на виртуальную машину с контроллером домена. Так как этот контроллер домена будет использоваться только для тестовой отработки отказа, меры безопасности виртуализации не обязательны. Чтобы идентификатор VM-GenerationID виртуальной машины с контроллером домена не изменялся, присвойте следующему параметру DWORD на локальном контроллере домена значение 4.

        
        HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\gencounter\Start
 

#### <a name="symptoms-of-virtualization-safeguards"></a>Признаки применения мер по обеспечению безопасности виртуализации
 
Если меры безопасности виртуализации применены после тестовой отработки отказа, вы увидите один или несколько следующих признаков.  

Изменение идентификатора создания

![Изменение идентификатора создания](./media/site-recovery-active-directory/Event2170.png)

Изменение идентификатора вызова

![Изменение идентификатора вызова](./media/site-recovery-active-directory/Event1109.png)

Общие папки Sysvol и Netlogon не доступны

![Общая папка Sysvol](./media/site-recovery-active-directory/sysvolshare.png)

![Ntfrs Sysvol](./media/site-recovery-active-directory/Event13565.png)

Удалена база данных DFSR

![Удаление базы данных DFSR](./media/site-recovery-active-directory/Event2208.png)


> [!IMPORTANT]
> Некоторые конфигурации, описанные в следующем разделе, не являются стандартными для контроллера домена. Если вы не хотите вносить эти изменения в рабочий контроллер домена, вы можете создать отдельный контроллер домена для тестовой отработки отказа Site Recovery и внести эти изменения в него.  
>
>


### <a name="troubleshooting-domain-controller-issues-during-test-failover"></a>Устранение неполадок контроллера домена при тестовой отработке отказа


В командной строке выполните следующую команду, чтобы проверить, являются ли папки SYSVOL и NETLOGON общими:

    NET SHARE

В командной строке выполните следующую команду, чтобы убедиться, что контроллер домена работает правильно:

    dcdiag /v > dcdiag.txt

В выходном журнале найдите следующий текст, который подтверждает, что контроллер домена работает нормально: 

* "passed test Connectivity"
* "passed test Advertising"
* "passed test MachineAccount"

Если эти условия выполняются, скорее всего контроллер домена будет работать правильно. Если нет, попробуйте сделать следующее.


* Выполните заслуживающее доверия восстановление контроллера домена.
    * Хотя [использовать службу репликации файлов (FRS) не рекомендуется](https://blogs.technet.microsoft.com/filecab/2014/06/25/the-end-is-nigh-for-frs/), если вы все же ее используете, следуйте приведенным [здесь](https://support.microsoft.com/kb/290762) инструкциям, чтобы выполнить надежное восстановление. Дополнительные сведения о параметре Burflags, упомянутом в предыдущей ссылке, см. в [этой записи блога](https://blogs.technet.microsoft.com/janelewis/2006/09/18/d2-and-d4-what-is-it-for/).
    * Если вы используете репликацию DFSR, следуйте приведенным [здесь](https://support.microsoft.com/kb/2218556) инструкциям, чтобы выполнить надежное восстановление. Для этой цели также можно использовать функции Powershell, доступные по этой [ссылке](https://blogs.technet.microsoft.com/thbouche/2013/08/28/dfsr-sysvol-authoritative-non-authoritative-restore-powershell-functions/). 
    
* Пропустите начальную синхронизацию, задав следующему разделу реестра значение 0 на локальном контроллере домена. Если параметр DWORD не существует, его можно создать в узле Parameters. Подробнее об этом можно прочитать [здесь](https://support.microsoft.com/kb/2001093).

        HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters\Repl Perform Initial Synchronizations

* Отключите требование, чтобы сервер глобального каталога был доступен для проверки входа пользователя, задав следующему разделу реестра значение 1 на локальном контроллере домена. Если параметр DWORD не существует, его можно создать на узле Lsa. Подробнее об этом можно прочитать [здесь](http://support.microsoft.com/kb/241789).

        HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\IgnoreGCFailures



### <a name="dns-and-domain-controller-on-different-machines"></a>Контроллер домена и DNS на разных компьютерах
Если DNS находится не на той же виртуальной машине, что и контроллер домена, необходимо создать виртуальную машину DNS для тестовой отработки отказа. Если они находятся на одной виртуальной машине, то этот раздел можно пропустить.

Можно использовать новый DNS-сервер и создать все необходимые зоны. Например, если используется домен Active Directory contoso.com, можно создать зону DNS с именем contoso.com. Записи DNS, соответствующие Active Directory, необходимо обновить следующим образом:

1. До включения любой другой виртуальной машины в план восстановления убедитесь, что настроены указанные ниже параметры:
   
   * Необходимо назвать зону именем корня леса.
   * Зона должна предусматривать файловую поддержку.
   * Для зоны должна быть включена возможность установки безопасных и небезопасных обновлений.
   * Сопоставитель виртуальной машины контроллера домена должен указывать на IP-адрес виртуальной машины DNS.
2. Выполните в виртуальной машине контроллера домена следующую команду:
   
    `nltest /dsregdns`
3. Добавьте зону на DNS-сервер, разрешите небезопасные обновления и добавьте запись для этой зоны в DNS:
   
        dnscmd /zoneadd contoso.com  /Primary
        dnscmd /recordadd contoso.com  contoso.com. SOA %computername%.contoso.com. hostmaster. 1 15 10 1 1
        dnscmd /recordadd contoso.com %computername%  A <IP_OF_DNS_VM>
        dnscmd /config contoso.com /allowupdate 1

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о защите корпоративных приложений с помощью Azure Site Recovery см. в статье [Какие рабочие нагрузки можно защитить с помощью службы Azure Site Recovery?](site-recovery-workload.md)


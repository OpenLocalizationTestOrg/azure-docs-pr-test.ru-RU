---
title: "Защита Active Directory и DNS с помощью Azure Site Recovery | Документация Майкрософт"
description: "В этой статье описывается, как реализовать решение аварийного восстановления для Active Directory с помощью Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: prateek9us
manager: gauravd
editor: 
ms.assetid: af1d9b26-1956-46ef-bd05-c545980b72dc
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 7/20/2017
ms.author: pratshar
ms.openlocfilehash: 197441fc24c178695d4eada6db59f503b21672ad
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="protect-active-directory-and-dns-with-azure-site-recovery"></a><span data-ttu-id="1adb0-103">Защита Active Directory и DNS с Azure Site Recovery</span><span class="sxs-lookup"><span data-stu-id="1adb0-103">Protect Active Directory and DNS with Azure Site Recovery</span></span>
<span data-ttu-id="1adb0-104">Правильная работа корпоративных приложений, таких как SharePoint, Dynamics AX и SAP, зависит от Active Directory и инфраструктуры DNS.</span><span class="sxs-lookup"><span data-stu-id="1adb0-104">Enterprise applications such as SharePoint, Dynamics AX, and SAP depend on Active Directory and a DNS infrastructure to function correctly.</span></span> <span data-ttu-id="1adb0-105">При создании решения аварийного восстановления для приложений важно помнить, что необходимо защищать и восстанавливать работу Active Directory и DNS раньше других компонентов приложения, чтобы гарантировать сохранение работоспособности при возникновении аварии.</span><span class="sxs-lookup"><span data-stu-id="1adb0-105">When you create a disaster recovery solution for applications, it's important to remember that you need to protect and recover Active Directory and DNS before the other application components, to ensure that things function correctly when disaster occurs.</span></span>

<span data-ttu-id="1adb0-106">Site Recovery — это служба Azure, которая обеспечивает аварийное восстановление, управляя процессами репликации, отработки отказа и восстановления виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="1adb0-106">Site Recovery is an Azure service that provides disaster recovery by orchestrating replication, failover, and recovery of virtual machines.</span></span> <span data-ttu-id="1adb0-107">Site Recovery поддерживает ряд сценариев репликации для надежной защиты и плавной отработки отказа виртуальных машин и приложений в общедоступные и закрытые облака, а также в облака хостера.</span><span class="sxs-lookup"><span data-stu-id="1adb0-107">Site Recovery supports a number of replication scenarios to consistently protect, and seamlessly failover virtual machines and applications to private, public, or hoster clouds.</span></span>

<span data-ttu-id="1adb0-108">С помощью Site Recovery можно создать полностью автоматизированный план аварийного восстановления для Active Directory.</span><span class="sxs-lookup"><span data-stu-id="1adb0-108">Using Site Recovery, you can create a complete automated disaster recovery plan for Active Directory.</span></span> <span data-ttu-id="1adb0-109">При прерывании работы отработку отказа можно запустить из любого места в течение нескольких секунд и таким образом восстановить работоспособность Active Directory за считанные минуты.</span><span class="sxs-lookup"><span data-stu-id="1adb0-109">When disruptions occur, you can initiate a failover within seconds from anywhere and get Active Directory up and running in a few minutes.</span></span> <span data-ttu-id="1adb0-110">Если на основном сайте вы развернули Active Directory для нескольких приложений (таких как SharePoint и SAP) и хотите, чтобы отработка отказа включала весь сайт, вы можете сначала выполнить отработку отказа Active Directory с помощью Site Recovery, а затем отработку отказа других приложений с помощью связанных с приложениями планов восстановления.</span><span class="sxs-lookup"><span data-stu-id="1adb0-110">If you've deployed Active Directory for multiple applications such as SharePoint and SAP in your primary site, and you want to fail over the complete site, you can fail over Active Directory first using Site Recovery, and then fail over the other applications using application-specific recovery plans.</span></span>

<span data-ttu-id="1adb0-111">В этой статье описано создание решения аварийного восстановления для Active Directory и выполнение плановых, внеплановых и тестовых отработок отказов с помощью быстрого плана восстановления, а также указаны поддерживаемые конфигурации и предварительные требования.</span><span class="sxs-lookup"><span data-stu-id="1adb0-111">This article explains how to create a disaster recovery solution for Active Directory, how to perform planned, unplanned, and test failovers using a one-click recovery plan, the supported configurations, and prerequisites.</span></span>  <span data-ttu-id="1adb0-112">Перед началом работы необходимо ознакомиться с Active Directory и Azure Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="1adb0-112">You should be familiar with Active Directory and Azure Site Recovery before you start.</span></span>

## <a name="replicating-domain-controller"></a><span data-ttu-id="1adb0-113">Репликация контроллера домена</span><span class="sxs-lookup"><span data-stu-id="1adb0-113">Replicating Domain Controller</span></span>

<span data-ttu-id="1adb0-114">По крайней мере на одной виртуальной машине с контроллером домена и DNS необходимо настроить [репликацию Site Recovery](#enable-protection-using-site-recovery).</span><span class="sxs-lookup"><span data-stu-id="1adb0-114">You need to setup [Site Recovery replication](#enable-protection-using-site-recovery) on at least one virtual machine hosting Domain Controller and DNS.</span></span> <span data-ttu-id="1adb0-115">Если в вашей среде [несколько контроллеров доменов](#environment-with-multiple-domain-controllers), то в дополнение к репликации виртуальной машины с контроллером домена с помощью Site Recovery также рекомендуется настроить [дополнительный контроллер домена](#protect-active-directory-with-active-directory-replication) на целевом сайте (сайте Azure или дополнительном локальном центре обработки данных).</span><span class="sxs-lookup"><span data-stu-id="1adb0-115">If you have [multiple domain controllers](#environment-with-multiple-domain-controllers) in your environment, in addition to replicating the domain controller virtual machine with Site Recovery you would also have to set up an [additional domain controller](#protect-active-directory-with-active-directory-replication) on the target site (Azure or a secondary on-premises datacenter).</span></span> 

### <a name="single-domain-controller-environment"></a><span data-ttu-id="1adb0-116">Среда с одним контроллером домена</span><span class="sxs-lookup"><span data-stu-id="1adb0-116">Single domain controller environment</span></span>
<span data-ttu-id="1adb0-117">Если в вашей среде несколько приложений и только один контроллер домена и при этом необходимо выполнить отработку отказа всего сайта, рекомендуется использовать Site Recovery для репликации контроллера домена на вторичный сайт (независимо от того, выполняется ли отработка отказа в Azure или на вторичный сайт).</span><span class="sxs-lookup"><span data-stu-id="1adb0-117">If you have a few applications and only a single domain controller, and you want to fail over the entire site together, then we recommend using Site Recovery to replicate the domain controller to the secondary site (whether you're failing over to Azure or to a secondary site).</span></span> <span data-ttu-id="1adb0-118">Эту же реплицированную виртуальную машину с контроллером домена или DNS можно использовать для [тестовой отработки отказа](#test-failover-considerations).</span><span class="sxs-lookup"><span data-stu-id="1adb0-118">The same replicated domain controller/DNS virtual machine can be used for [test failover](#test-failover-considerations) as well.</span></span>

### <a name="environment-with-multiple-domain-controllers"></a><span data-ttu-id="1adb0-119">Среда с несколькими контроллерами доменов</span><span class="sxs-lookup"><span data-stu-id="1adb0-119">Environment with multiple domain controllers</span></span>
<span data-ttu-id="1adb0-120">Если в вашей среде много приложений и несколько контроллеров доменов, и при этом вы планируете выполнять отработку отказа для нескольких приложений одновременно, рекомендуется в дополнение к репликации виртуальной машины с контроллером домена с помощью Site Recovery также настроить [дополнительный контроллер домена](#protect-active-directory-with-active-directory-replication) на целевом сайте (сайте Azure или дополнительном локальном центре обработки данных).</span><span class="sxs-lookup"><span data-stu-id="1adb0-120">If you have many applications and there's more than one domain controller in the environment, or if you plan to fail over a few applications at a time, we recommend that in addition to replicating the domain controller virtual machine with Site Recovery you also set up an [additional domain controller](#protect-active-directory-with-active-directory-replication) on the target site (Azure or a secondary on-premises datacenter).</span></span> <span data-ttu-id="1adb0-121">Для [тестовой отработки отказа](#test-failover-considerations) используйте контроллер домена, реплицированный с помощью Site Recovery. А для реальной отработки отказа используйте дополнительный контроллер домена на конечном сайте.</span><span class="sxs-lookup"><span data-stu-id="1adb0-121">For [test failover](#test-failover-considerations), you use domain controller replicated by Site Recovery and for failover, the additional domain controller on the target site.</span></span> 


<span data-ttu-id="1adb0-122">В следующих разделах объясняется, как включить защиту для контроллера домена в Site Recovery и настроить контроллер домена в Azure.</span><span class="sxs-lookup"><span data-stu-id="1adb0-122">The following sections explain how to enable protection for a domain controller in Site Recovery, and how to set up a domain controller in Azure.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="1adb0-123">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="1adb0-123">Prerequisites</span></span>
* <span data-ttu-id="1adb0-124">Локально развернутые Active Directory и DNS-сервер.</span><span class="sxs-lookup"><span data-stu-id="1adb0-124">An on-premises deployment of Active Directory and DNS server.</span></span>
* <span data-ttu-id="1adb0-125">Хранилище служб Azure Site Recovery в подписке Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="1adb0-125">An Azure Site Recovery Services vault in a Microsoft Azure subscription.</span></span>
* <span data-ttu-id="1adb0-126">При репликации в Azure запустите средство оценки готовности виртуальных машин Azure на виртуальных машинах, чтобы убедиться в их совместимости с виртуальными машинами Azure и службами Azure Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="1adb0-126">If you're replicating to Azure, run the Azure Virtual Machine Readiness Assessment tool on VMs to ensure they're compatible with Azure VMs and Azure Site Recovery Services.</span></span>

## <a name="enable-protection-using-site-recovery"></a><span data-ttu-id="1adb0-127">Включение защиты с помощью Site Recovery</span><span class="sxs-lookup"><span data-stu-id="1adb0-127">Enable protection using Site Recovery</span></span>
### <a name="protect-the-virtual-machine"></a><span data-ttu-id="1adb0-128">Защита виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="1adb0-128">Protect the virtual machine</span></span>
<span data-ttu-id="1adb0-129">Включите защиту виртуальной машины с контроллером домена или DNS в Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="1adb0-129">Enable protection of the domain controller/DNS virtual machine in Site Recovery.</span></span> <span data-ttu-id="1adb0-130">Настройте параметры Site Recovery на основе типа виртуальной машины (Hyper-V или VMware).</span><span class="sxs-lookup"><span data-stu-id="1adb0-130">Configure Site Recovery settings based on the virtual machine type (Hyper-V or VMware).</span></span> <span data-ttu-id="1adb0-131">Контроллер домена, реплицированный с помощью Site Recovery, используется для [тестовой отработки отказа](#test-failover-considerations).</span><span class="sxs-lookup"><span data-stu-id="1adb0-131">The domain controller replicated using Site Recovery is used for [test failover](#test-failover-considerations).</span></span> <span data-ttu-id="1adb0-132">Убедитесь, что он соответствует следующим требованиям.</span><span class="sxs-lookup"><span data-stu-id="1adb0-132">Make sure it meets the following requirements:</span></span>

1. <span data-ttu-id="1adb0-133">Контроллер домена должен быть сервером глобального каталога.</span><span class="sxs-lookup"><span data-stu-id="1adb0-133">The domain controller is a global catalog server</span></span>
2. <span data-ttu-id="1adb0-134">Контроллер домена должен быть владельцем роли FSMO для ролей, которые потребуются для тестовой отработки отказа (или эти роли должны быть [заняты](http://aka.ms/ad_seize_fsmo) после отработки отказа).</span><span class="sxs-lookup"><span data-stu-id="1adb0-134">The domain controller should be the FSMO role owner for roles that will be needed during a test failover (else these roles will need to be [seized](http://aka.ms/ad_seize_fsmo) after the failover)</span></span>

### <a name="configure-virtual-machine-network-settings"></a><span data-ttu-id="1adb0-135">Настройка сетевых параметров виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="1adb0-135">Configure virtual machine network settings</span></span>
<span data-ttu-id="1adb0-136">Для виртуальной машины с контроллером домена или DNS настройте сетевые параметры в Site Recovery так, чтобы после отработки отказа виртуальная машина подключалась к правильной сети.</span><span class="sxs-lookup"><span data-stu-id="1adb0-136">For the domain controller/DNS virtual machine, configure network settings in Site Recovery so that the virtual machine will be attached to the right network after failover.</span></span> 

![Параметры сети виртуальных машин](./media/site-recovery-active-directory/DNS-Target-IP.png)

## <a name="protect-active-directory-with-active-directory-replication"></a><span data-ttu-id="1adb0-138">Защита Active Directory с помощью репликации Active Directory</span><span class="sxs-lookup"><span data-stu-id="1adb0-138">Protect Active Directory with Active Directory replication</span></span>
### <a name="site-to-site-protection"></a><span data-ttu-id="1adb0-139">Защита "сайт-сайт"</span><span class="sxs-lookup"><span data-stu-id="1adb0-139">Site-to-site protection</span></span>
<span data-ttu-id="1adb0-140">Создайте контроллер домена на дополнительном сайте.</span><span class="sxs-lookup"><span data-stu-id="1adb0-140">Create a domain controller on the secondary site.</span></span> <span data-ttu-id="1adb0-141">При повышении роли сервера до роли контроллера домена укажите имя домена, которое используется на основном сайте.</span><span class="sxs-lookup"><span data-stu-id="1adb0-141">When you promote the server to a domain controller role, specify the name of the same domain that is being used on the primary site.</span></span> <span data-ttu-id="1adb0-142">Чтобы настроить параметры объекта связывания сайтов, в который добавляются сайты, можно использовать оснастку **Active Directory — сайты и службы**.</span><span class="sxs-lookup"><span data-stu-id="1adb0-142">You can use the **Active Directory Sites and Services** snap-in to configure settings on the site link object to which the sites are added.</span></span> <span data-ttu-id="1adb0-143">Настраивая параметры связи между сайтами, можно указать время и периодичность репликации между двумя или несколькими сайтами.</span><span class="sxs-lookup"><span data-stu-id="1adb0-143">By configuring settings on a site link, you can control when replication occurs between two or more sites, and how often.</span></span> <span data-ttu-id="1adb0-144">Дополнительные сведения см. в статье [Расписание репликации между сайтами](https://technet.microsoft.com/library/cc731862.aspx).</span><span class="sxs-lookup"><span data-stu-id="1adb0-144">For more information, see [Scheduling Replication Between Sites](https://technet.microsoft.com/library/cc731862.aspx).</span></span>

### <a name="site-to-azure-protection"></a><span data-ttu-id="1adb0-145">Защита "сайт-Azure"</span><span class="sxs-lookup"><span data-stu-id="1adb0-145">Site-to-Azure protection</span></span>
<span data-ttu-id="1adb0-146">Выполните инструкции по [созданию контроллера домена в виртуальной сети Azure](../active-directory/active-directory-install-replica-active-directory-domain-controller.md).</span><span class="sxs-lookup"><span data-stu-id="1adb0-146">Follow the instructions to [create a domain controller in an Azure virtual network](../active-directory/active-directory-install-replica-active-directory-domain-controller.md).</span></span> <span data-ttu-id="1adb0-147">При повышении роли сервера до роли контроллера домена укажите имя домена, которое используется на основном сайте.</span><span class="sxs-lookup"><span data-stu-id="1adb0-147">When you promote the server to a domain controller role, specify the same domain name that's used on the primary site.</span></span>

<span data-ttu-id="1adb0-148">Затем [измените конфигурацию DNS-сервера для виртуальной сети](../active-directory/active-directory-install-replica-active-directory-domain-controller.md#reconfigure-dns-server-for-the-virtual-network), так чтобы использовался сервер DNS в Azure.</span><span class="sxs-lookup"><span data-stu-id="1adb0-148">Then [reconfigure the DNS server for the virtual network](../active-directory/active-directory-install-replica-active-directory-domain-controller.md#reconfigure-dns-server-for-the-virtual-network), to use the DNS server in Azure.</span></span>

![Сеть Azure](./media/site-recovery-active-directory/azure-network.png)

<span data-ttu-id="1adb0-150">**DNS в рабочей сети Azure**</span><span class="sxs-lookup"><span data-stu-id="1adb0-150">**DNS in Azure Production Network**</span></span>

## <a name="test-failover-considerations"></a><span data-ttu-id="1adb0-151">Рекомендации по тестированию отработки отказа</span><span class="sxs-lookup"><span data-stu-id="1adb0-151">Test failover considerations</span></span>
<span data-ttu-id="1adb0-152">Тестовая отработка отказа проводится в сети, изолированной от рабочей сети, чтобы не мешать выполнению рабочих нагрузок.</span><span class="sxs-lookup"><span data-stu-id="1adb0-152">Test failover occurs in a network that's isolated from production network so that there's no impact on production workloads.</span></span>

<span data-ttu-id="1adb0-153">Для работы большинства приложений требуется также контроллер домена и DNS-сервер.</span><span class="sxs-lookup"><span data-stu-id="1adb0-153">Most applications also require the presence of a domain controller and a DNS server to function.</span></span> <span data-ttu-id="1adb0-154">Таким образом, прежде чем выполнять отработку отказа для приложения, необходимо создать в изолированной сети контроллер домена, который будет использоваться при отработке отказа.</span><span class="sxs-lookup"><span data-stu-id="1adb0-154">Therefore, before the application is failed over, a domain controller needs to be created in the isolated network to be used for test failover.</span></span> <span data-ttu-id="1adb0-155">Это проще всего сделать, реплицировав с помощью Site Recovery виртуальную машину с контроллером домена и (или) DNS.</span><span class="sxs-lookup"><span data-stu-id="1adb0-155">The easiest way to do this is to replicate a domain controller/DNS virtual machine with Site Recovery.</span></span> <span data-ttu-id="1adb0-156">Запустите тестовую отработку отказа виртуальной машины с контроллером домена, прежде чем запускать тестовую отработку отказа плана восстановления для приложения.</span><span class="sxs-lookup"><span data-stu-id="1adb0-156">Then run a test failover of the domain controller virtual machine before running a test failover of the recovery plan for the application.</span></span> <span data-ttu-id="1adb0-157">Вот как это сделать:</span><span class="sxs-lookup"><span data-stu-id="1adb0-157">Here's how you do that:</span></span>

1. <span data-ttu-id="1adb0-158">[Реплицируйте](site-recovery-replicate-vmware-to-azure.md) виртуальную машину с контроллером домена и (или) DNS с помощью Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="1adb0-158">[Replicate](site-recovery-replicate-vmware-to-azure.md) the domain controller/DNS virtual machine using Site Recovery.</span></span>
1. <span data-ttu-id="1adb0-159">Создайте изолированную сеть.</span><span class="sxs-lookup"><span data-stu-id="1adb0-159">Create an isolated network.</span></span> <span data-ttu-id="1adb0-160">Любая виртуальная сеть, созданная в Azure, по умолчанию изолируется от другой сети.</span><span class="sxs-lookup"><span data-stu-id="1adb0-160">Any virtual network created in Azure by default is isolated from other networks.</span></span> <span data-ttu-id="1adb0-161">Рекомендуем использовать для этой сети такой же диапазон IP-адресов, как у вашей рабочей сети.</span><span class="sxs-lookup"><span data-stu-id="1adb0-161">We recommend that the IP address range for this network is same as that of your production network.</span></span> <span data-ttu-id="1adb0-162">Не включайте для этой сети подключение между сайтами.</span><span class="sxs-lookup"><span data-stu-id="1adb0-162">Don't enable site-to-site connectivity on this network.</span></span>
1. <span data-ttu-id="1adb0-163">В качестве IP-адреса DNS в созданной сети укажите IP-адрес, который должна получить виртуальная машина с DNS.</span><span class="sxs-lookup"><span data-stu-id="1adb0-163">Provide a DNS IP address in the network created, as the IP address that you expect the DNS virtual machine to get.</span></span> <span data-ttu-id="1adb0-164">При репликации в Azure в разделе **Вычисления и сеть** в поле **Целевой IP-адрес** укажите IP-адрес виртуальной машины, которая будет использоваться для отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="1adb0-164">If you're replicating to Azure, then provide the IP address for the VM that is used on failover in **Target IP** setting in **Compute and Network** settings.</span></span> 

    <span data-ttu-id="1adb0-165">![Целевой IP-адрес](./media/site-recovery-active-directory/DNS-Target-IP.png) **Целевой IP-адрес**</span><span class="sxs-lookup"><span data-stu-id="1adb0-165">![Target IP](./media/site-recovery-active-directory/DNS-Target-IP.png) **Target IP**</span></span>

    ![Тестовая сеть Azure](./media/site-recovery-active-directory/azure-test-network.png)

    <span data-ttu-id="1adb0-167">**DNS в тестовой сети Azure**</span><span class="sxs-lookup"><span data-stu-id="1adb0-167">**DNS in Azure Test Network**</span></span>

> [!TIP]
> <span data-ttu-id="1adb0-168">Служба Site Recovery попытается создать тестовые виртуальные машины в подсети с таким же именем, используя тот же IP-адрес, который был указан в разделе параметров **Вычисления и сеть** виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="1adb0-168">Site Recovery attempts to create test virtual machines in a subnet of same name and using the same IP as that provided in **Compute and Network** settings of the virtual machine.</span></span> <span data-ttu-id="1adb0-169">Если подсеть с таким же именем недоступна в виртуальной сети Azure, предоставленной для тестовой отработки отказа, тестовая виртуальная машина создается в первой по алфавиту подсети.</span><span class="sxs-lookup"><span data-stu-id="1adb0-169">If subnet of same name is not available in the Azure virtual network provided for test failover, then test virtual machine is created in the first subnet alphabetically.</span></span> <span data-ttu-id="1adb0-170">Если целевой IP-адрес является частью выбранной подсети, Site Recovery попытается создать виртуальную машину для тестовой обработки отказа с его использованием.</span><span class="sxs-lookup"><span data-stu-id="1adb0-170">If the target IP is part of the chosen subnet, then Site Recovery tries to create the test failover virtual machine using the target IP.</span></span> <span data-ttu-id="1adb0-171">Иначе виртуальная машина для тестовой обработки отказа будет создана с использованием любого доступного IP-адреса в выбранной подсети.</span><span class="sxs-lookup"><span data-stu-id="1adb0-171">If the target IP is not part of the chosen subnet, then test failover virtual machine gets created using any available IP in the chosen subnet.</span></span> 
>
>


1. <span data-ttu-id="1adb0-172">Если выполняется репликация на другой локальный сайт и вы используете DHCP, следуйте инструкциям по [настройке DNS и DHCP для тестовой отработки отказа](site-recovery-test-failover-vmm-to-vmm.md#prepare-dhcp).</span><span class="sxs-lookup"><span data-stu-id="1adb0-172">If you're replicating to another on-premises site and you're using DHCP, follow the instructions to [setup DNS and DHCP for test failover](site-recovery-test-failover-vmm-to-vmm.md#prepare-dhcp)</span></span>
1. <span data-ttu-id="1adb0-173">Не выполняйте тестовую отработку отказа на виртуальной машине с контроллером домена в изолированной сети.</span><span class="sxs-lookup"><span data-stu-id="1adb0-173">Do a test failover of the domain controller virtual machine run in the isolated network.</span></span> <span data-ttu-id="1adb0-174">Для выполнения тестовой отработки отказа используйте последнюю точку восстановления виртуальной машины контроллера домена, **согласованную с приложениями**.</span><span class="sxs-lookup"><span data-stu-id="1adb0-174">Use latest available **application consistent** recovery point of the domain controller virtual machine to do the test failover.</span></span> 
1. <span data-ttu-id="1adb0-175">Запустите тестовую отработку отказа для плана восстановления, который содержит виртуальные машины приложения.</span><span class="sxs-lookup"><span data-stu-id="1adb0-175">Run a test failover for the recovery plan that contains virtual machines of the application.</span></span> 
1. <span data-ttu-id="1adb0-176">После завершения тестирования **очистите тестовую отработку отказа** на виртуальной машине с контроллером домена.</span><span class="sxs-lookup"><span data-stu-id="1adb0-176">After testing is complete, **Cleanup test failover** on the domain controller virtual machine.</span></span> <span data-ttu-id="1adb0-177">Этот шаг удаляет контроллер домена, который был создан для тестовой отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="1adb0-177">This step deletes the domain controller that was created for test failover.</span></span>


### <a name="removing-reference-to-other-domain-controllers"></a><span data-ttu-id="1adb0-178">Удаление ссылки на другие контроллеры домена</span><span class="sxs-lookup"><span data-stu-id="1adb0-178">Removing reference to other domain controllers</span></span>
<span data-ttu-id="1adb0-179">При выполнении тестовой отработки отказа не нужно переносить все контроллеры домена в тестовую сеть.</span><span class="sxs-lookup"><span data-stu-id="1adb0-179">When you are doing a test failover, you don't bring all the domain controllers in the test network.</span></span> <span data-ttu-id="1adb0-180">Чтобы удалить ссылку на другие контроллеры домена, которые существуют в рабочей среде, необходимо [занять роли FSMO Active Directory](http://aka.ms/ad_seize_fsmo) и [очистить метаданные](https://technet.microsoft.com/library/cc816907.aspx) для отсутствующих контроллеров домена.</span><span class="sxs-lookup"><span data-stu-id="1adb0-180">To remove the reference of other domain controllers that exist in your production environment, you might need to [seize FSMO Active Directory roles](http://aka.ms/ad_seize_fsmo) and do [metadata cleanup](https://technet.microsoft.com/library/cc816907.aspx) for missing domain controllers.</span></span> 



> [!IMPORTANT]
> <span data-ttu-id="1adb0-181">Некоторые конфигурации, описанные в следующем разделе, не являются стандартными для контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="1adb0-181">Some of the configurations described in the following section are not the standard/default domain controller configurations.</span></span> <span data-ttu-id="1adb0-182">Если вы не хотите вносить эти изменения в рабочий контроллер домена, вы можете создать отдельный контроллер домена для тестовой отработки отказа Site Recovery и внести эти изменения в него.</span><span class="sxs-lookup"><span data-stu-id="1adb0-182">If you don't want to make these changes to a production domain controller, then you can create a domain controller dedicated to be used for Site Recovery test failover and make these changes to that.</span></span>  
>
>

### <a name="issues-because-of-virtualization-safeguards"></a><span data-ttu-id="1adb0-183">Вопросы, связанные с мерами по обеспечению безопасности виртуализации</span><span class="sxs-lookup"><span data-stu-id="1adb0-183">Issues because of virtualization safeguards</span></span> 

<span data-ttu-id="1adb0-184">Начиная с Windows Server 2012 в [Active Directory Domain Services предусмотрены дополнительные меры безопасности](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100).</span><span class="sxs-lookup"><span data-stu-id="1adb0-184">Beginning with Windows Server 2012, [additional safeguards have been built into Active Directory Domain Services](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100).</span></span> <span data-ttu-id="1adb0-185">Эти меры безопасности помогают защитить виртуализированные контроллеры домена от откатов USN при условии, что базовая платформа низкоуровневой оболочки поддерживает VM-GenerationID.</span><span class="sxs-lookup"><span data-stu-id="1adb0-185">These safeguards help protect virtualized domain controllers against USN Rollbacks, as long as the underlying hypervisor platform supports VM-GenerationID.</span></span> <span data-ttu-id="1adb0-186">Azure поддерживает VM-GenerationID, а это значит, что контроллеры доменов, которые работают под управлением Windows Server 2012 или более поздних версий на виртуальных машинах Azure, будут защищены дополнительными мерами безопасности.</span><span class="sxs-lookup"><span data-stu-id="1adb0-186">Azure supports VM-GenerationID, which means that domain controllers that run Windows Server 2012 or later on Azure virtual machines have the additional safeguards.</span></span> 


<span data-ttu-id="1adb0-187">При сбросе VM-GenerationID также сбрасывается invocationID базы данных AD DS, удаляется пул RID, а SYSVOL помечается как не заслуживающий доверия.</span><span class="sxs-lookup"><span data-stu-id="1adb0-187">When the VM-GenerationID is reset, the invocationID of the AD DS database is also reset, the RID pool is discarded, and SYSVOL is marked as non-authoritative.</span></span> <span data-ttu-id="1adb0-188">Дополнительные сведения см. в документах, посвященных [знакомству с виртуализацией доменных служб Active Directory](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100) и [безопасной виртуализации DFSR](https://blogs.technet.microsoft.com/filecab/2013/04/05/safely-virtualizing-dfsr/).</span><span class="sxs-lookup"><span data-stu-id="1adb0-188">For more information, see [Introduction to Active Directory Domain Services Virtualization](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100) and [Safely Virtualizing DFSR](https://blogs.technet.microsoft.com/filecab/2013/04/05/safely-virtualizing-dfsr/)</span></span>

<span data-ttu-id="1adb0-189">Отработка отказа в Azure может вызвать сброс VM-GenerationID и включение дополнительных мер безопасности при запуске в Azure виртуальной машины с контроллером домена.</span><span class="sxs-lookup"><span data-stu-id="1adb0-189">Failing over to Azure may cause resetting of VM-GenerationID and that kicks in the additional safeguards when the domain controller virtual machine starts in Azure.</span></span> <span data-ttu-id="1adb0-190">Это может привести к **значительной задержке** при входе пользователя на виртуальную машину с контроллером домена.</span><span class="sxs-lookup"><span data-stu-id="1adb0-190">This may result in a **significant delay** in user being able to login to the domain controller virtual machine.</span></span> <span data-ttu-id="1adb0-191">Так как этот контроллер домена будет использоваться только для тестовой отработки отказа, меры безопасности виртуализации не обязательны.</span><span class="sxs-lookup"><span data-stu-id="1adb0-191">Since this domain controller would be used only in a test failover, virtualization safeguards are not necessary.</span></span> <span data-ttu-id="1adb0-192">Чтобы идентификатор VM-GenerationID виртуальной машины с контроллером домена не изменялся, присвойте следующему параметру DWORD на локальном контроллере домена значение 4.</span><span class="sxs-lookup"><span data-stu-id="1adb0-192">To ensure that VM-GenerationID for the domain controller virtual machine doesn't change, then you can change the value of following DWORD to 4 in the on-premises domain controller.</span></span>

        
        HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\gencounter\Start
 

#### <a name="symptoms-of-virtualization-safeguards"></a><span data-ttu-id="1adb0-193">Признаки применения мер по обеспечению безопасности виртуализации</span><span class="sxs-lookup"><span data-stu-id="1adb0-193">Symptoms of virtualization safeguards</span></span>
 
<span data-ttu-id="1adb0-194">Если меры безопасности виртуализации применены после тестовой отработки отказа, вы увидите один или несколько следующих признаков.</span><span class="sxs-lookup"><span data-stu-id="1adb0-194">If virtualization safeguards have kicked in after a test failover, you may see one or more of following symptoms:</span></span>  

<span data-ttu-id="1adb0-195">Изменение идентификатора создания</span><span class="sxs-lookup"><span data-stu-id="1adb0-195">Generation ID change</span></span>

![Изменение идентификатора создания](./media/site-recovery-active-directory/Event2170.png)

<span data-ttu-id="1adb0-197">Изменение идентификатора вызова</span><span class="sxs-lookup"><span data-stu-id="1adb0-197">Invocation ID change</span></span>

![Изменение идентификатора вызова](./media/site-recovery-active-directory/Event1109.png)

<span data-ttu-id="1adb0-199">Общие папки Sysvol и Netlogon не доступны</span><span class="sxs-lookup"><span data-stu-id="1adb0-199">Sysvol and Netlogon shares are not available</span></span>

![Общая папка Sysvol](./media/site-recovery-active-directory/sysvolshare.png)

![Ntfrs Sysvol](./media/site-recovery-active-directory/Event13565.png)

<span data-ttu-id="1adb0-202">Удалена база данных DFSR</span><span class="sxs-lookup"><span data-stu-id="1adb0-202">Any DFSR databases are deleted</span></span>

![Удаление базы данных DFSR](./media/site-recovery-active-directory/Event2208.png)


> [!IMPORTANT]
> <span data-ttu-id="1adb0-204">Некоторые конфигурации, описанные в следующем разделе, не являются стандартными для контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="1adb0-204">Some of the configurations described in the following section are not the standard/default domain controller configurations.</span></span> <span data-ttu-id="1adb0-205">Если вы не хотите вносить эти изменения в рабочий контроллер домена, вы можете создать отдельный контроллер домена для тестовой отработки отказа Site Recovery и внести эти изменения в него.</span><span class="sxs-lookup"><span data-stu-id="1adb0-205">If you don't want to make these changes to a production domain controller, then you can create a domain controller dedicated to be used for Site Recovery test failover and make these changes to that.</span></span>  
>
>


### <a name="troubleshooting-domain-controller-issues-during-test-failover"></a><span data-ttu-id="1adb0-206">Устранение неполадок контроллера домена при тестовой отработке отказа</span><span class="sxs-lookup"><span data-stu-id="1adb0-206">Troubleshooting domain controller issues during test failover</span></span>


<span data-ttu-id="1adb0-207">В командной строке выполните следующую команду, чтобы проверить, являются ли папки SYSVOL и NETLOGON общими:</span><span class="sxs-lookup"><span data-stu-id="1adb0-207">On a command prompt, run the following command to check whether SYSVOL and NETLOGON folders are shared:</span></span>

    NET SHARE

<span data-ttu-id="1adb0-208">В командной строке выполните следующую команду, чтобы убедиться, что контроллер домена работает правильно:</span><span class="sxs-lookup"><span data-stu-id="1adb0-208">On the command prompt, run the following command to ensure that the domain controller is functioning properly.</span></span>

    dcdiag /v > dcdiag.txt

<span data-ttu-id="1adb0-209">В выходном журнале найдите следующий текст, который подтверждает, что контроллер домена работает нормально:</span><span class="sxs-lookup"><span data-stu-id="1adb0-209">In the output log, look for following text to confirm that the domain controller is functioning well.</span></span> 

* <span data-ttu-id="1adb0-210">"passed test Connectivity"</span><span class="sxs-lookup"><span data-stu-id="1adb0-210">"passed test Connectivity"</span></span>
* <span data-ttu-id="1adb0-211">"passed test Advertising"</span><span class="sxs-lookup"><span data-stu-id="1adb0-211">"passed test Advertising"</span></span>
* <span data-ttu-id="1adb0-212">"passed test MachineAccount"</span><span class="sxs-lookup"><span data-stu-id="1adb0-212">"passed test MachineAccount"</span></span>

<span data-ttu-id="1adb0-213">Если эти условия выполняются, скорее всего контроллер домена будет работать правильно.</span><span class="sxs-lookup"><span data-stu-id="1adb0-213">If the preceding conditions are satisfied, it is likely that the domain controller is functioning well.</span></span> <span data-ttu-id="1adb0-214">Если нет, попробуйте сделать следующее.</span><span class="sxs-lookup"><span data-stu-id="1adb0-214">If not, try following steps.</span></span>


* <span data-ttu-id="1adb0-215">Выполните заслуживающее доверия восстановление контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="1adb0-215">Do an authoritative restore of the domain controller.</span></span>
    * <span data-ttu-id="1adb0-216">Хотя [использовать службу репликации файлов (FRS) не рекомендуется](https://blogs.technet.microsoft.com/filecab/2014/06/25/the-end-is-nigh-for-frs/), если вы все же ее используете, следуйте приведенным [здесь](https://support.microsoft.com/kb/290762) инструкциям, чтобы выполнить надежное восстановление.</span><span class="sxs-lookup"><span data-stu-id="1adb0-216">Although it is [not recommended to use FRS replication](https://blogs.technet.microsoft.com/filecab/2014/06/25/the-end-is-nigh-for-frs/), but if you are still using it then follow the steps provided [here](https://support.microsoft.com/kb/290762) to do an authoritative restore.</span></span> <span data-ttu-id="1adb0-217">Дополнительные сведения о параметре Burflags, упомянутом в предыдущей ссылке, см. в [этой записи блога](https://blogs.technet.microsoft.com/janelewis/2006/09/18/d2-and-d4-what-is-it-for/).</span><span class="sxs-lookup"><span data-stu-id="1adb0-217">You can read more about Burflags talked about in the previous link [here](https://blogs.technet.microsoft.com/janelewis/2006/09/18/d2-and-d4-what-is-it-for/).</span></span>
    * <span data-ttu-id="1adb0-218">Если вы используете репликацию DFSR, следуйте приведенным [здесь](https://support.microsoft.com/kb/2218556) инструкциям, чтобы выполнить надежное восстановление.</span><span class="sxs-lookup"><span data-stu-id="1adb0-218">If you are using DFSR replication, then follow the steps available [here](https://support.microsoft.com/kb/2218556) to do an authoritative restore.</span></span> <span data-ttu-id="1adb0-219">Для этой цели также можно использовать функции Powershell, доступные по этой [ссылке](https://blogs.technet.microsoft.com/thbouche/2013/08/28/dfsr-sysvol-authoritative-non-authoritative-restore-powershell-functions/).</span><span class="sxs-lookup"><span data-stu-id="1adb0-219">You can also use Powershell functions available on this [link](https://blogs.technet.microsoft.com/thbouche/2013/08/28/dfsr-sysvol-authoritative-non-authoritative-restore-powershell-functions/) for this purpose.</span></span> 
    
* <span data-ttu-id="1adb0-220">Пропустите начальную синхронизацию, задав следующему разделу реестра значение 0 на локальном контроллере домена.</span><span class="sxs-lookup"><span data-stu-id="1adb0-220">Bypass initial synchronization requirement by setting following registry key to 0 in the on-premises domain controller.</span></span> <span data-ttu-id="1adb0-221">Если параметр DWORD не существует, его можно создать в узле Parameters.</span><span class="sxs-lookup"><span data-stu-id="1adb0-221">If this DWORD doesn't exist, then you can create it under node 'Parameters'.</span></span> <span data-ttu-id="1adb0-222">Подробнее об этом можно прочитать [здесь](https://support.microsoft.com/kb/2001093).</span><span class="sxs-lookup"><span data-stu-id="1adb0-222">You can read more about it [here](https://support.microsoft.com/kb/2001093)</span></span>

        HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters\Repl Perform Initial Synchronizations

* <span data-ttu-id="1adb0-223">Отключите требование, чтобы сервер глобального каталога был доступен для проверки входа пользователя, задав следующему разделу реестра значение 1 на локальном контроллере домена.</span><span class="sxs-lookup"><span data-stu-id="1adb0-223">Disable the requirement that a global catalog server is available to validate user logon by setting following registry key to 1 in the on-premises domain controller.</span></span> <span data-ttu-id="1adb0-224">Если параметр DWORD не существует, его можно создать на узле Lsa.</span><span class="sxs-lookup"><span data-stu-id="1adb0-224">If this DWORD doesn't exist, then you can create it under node 'Lsa'.</span></span> <span data-ttu-id="1adb0-225">Подробнее об этом можно прочитать [здесь](http://support.microsoft.com/kb/241789).</span><span class="sxs-lookup"><span data-stu-id="1adb0-225">You can read more about it [here](http://support.microsoft.com/kb/241789)</span></span>

        HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\IgnoreGCFailures



### <a name="dns-and-domain-controller-on-different-machines"></a><span data-ttu-id="1adb0-226">Контроллер домена и DNS на разных компьютерах</span><span class="sxs-lookup"><span data-stu-id="1adb0-226">DNS and domain controller on different machines</span></span>
<span data-ttu-id="1adb0-227">Если DNS находится не на той же виртуальной машине, что и контроллер домена, необходимо создать виртуальную машину DNS для тестовой отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="1adb0-227">If DNS isn't on the same virtual machine as the domain controller, you need to create a DNS VM for the test failover.</span></span> <span data-ttu-id="1adb0-228">Если они находятся на одной виртуальной машине, то этот раздел можно пропустить.</span><span class="sxs-lookup"><span data-stu-id="1adb0-228">If they're on the same VM, you can skip this section.</span></span>

<span data-ttu-id="1adb0-229">Можно использовать новый DNS-сервер и создать все необходимые зоны.</span><span class="sxs-lookup"><span data-stu-id="1adb0-229">You can use a fresh DNS server and create all the required zones.</span></span> <span data-ttu-id="1adb0-230">Например, если используется домен Active Directory contoso.com, можно создать зону DNS с именем contoso.com.</span><span class="sxs-lookup"><span data-stu-id="1adb0-230">For example, if your Active Directory domain is contoso.com, you can create a DNS zone with the name contoso.com.</span></span> <span data-ttu-id="1adb0-231">Записи DNS, соответствующие Active Directory, необходимо обновить следующим образом:</span><span class="sxs-lookup"><span data-stu-id="1adb0-231">The entries corresponding to Active Directory must be updated in DNS, as follows:</span></span>

1. <span data-ttu-id="1adb0-232">До включения любой другой виртуальной машины в план восстановления убедитесь, что настроены указанные ниже параметры:</span><span class="sxs-lookup"><span data-stu-id="1adb0-232">Ensure these settings are in place before any other virtual machine in the recovery plan comes up:</span></span>
   
   * <span data-ttu-id="1adb0-233">Необходимо назвать зону именем корня леса.</span><span class="sxs-lookup"><span data-stu-id="1adb0-233">The zone must be named after the forest root name.</span></span>
   * <span data-ttu-id="1adb0-234">Зона должна предусматривать файловую поддержку.</span><span class="sxs-lookup"><span data-stu-id="1adb0-234">The zone must be file-backed.</span></span>
   * <span data-ttu-id="1adb0-235">Для зоны должна быть включена возможность установки безопасных и небезопасных обновлений.</span><span class="sxs-lookup"><span data-stu-id="1adb0-235">The zone must be enabled for secure and non-secure updates.</span></span>
   * <span data-ttu-id="1adb0-236">Сопоставитель виртуальной машины контроллера домена должен указывать на IP-адрес виртуальной машины DNS.</span><span class="sxs-lookup"><span data-stu-id="1adb0-236">The resolver of the domain controller virtual machine should point to the IP address of the DNS virtual machine.</span></span>
2. <span data-ttu-id="1adb0-237">Выполните в виртуальной машине контроллера домена следующую команду:</span><span class="sxs-lookup"><span data-stu-id="1adb0-237">Run the following command on domain controller virtual machine:</span></span>
   
    `nltest /dsregdns`
3. <span data-ttu-id="1adb0-238">Добавьте зону на DNS-сервер, разрешите небезопасные обновления и добавьте запись для этой зоны в DNS:</span><span class="sxs-lookup"><span data-stu-id="1adb0-238">Add a zone on the DNS server, allow non-secure updates, and add an entry for it to DNS:</span></span>
   
        dnscmd /zoneadd contoso.com  /Primary
        dnscmd /recordadd contoso.com  contoso.com. SOA %computername%.contoso.com. hostmaster. 1 15 10 1 1
        dnscmd /recordadd contoso.com %computername%  A <IP_OF_DNS_VM>
        dnscmd /config contoso.com /allowupdate 1

## <a name="next-steps"></a><span data-ttu-id="1adb0-239">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="1adb0-239">Next steps</span></span>
<span data-ttu-id="1adb0-240">Дополнительные сведения о защите корпоративных приложений с помощью Azure Site Recovery см. в статье [Какие рабочие нагрузки можно защитить с помощью службы Azure Site Recovery?](site-recovery-workload.md)</span><span class="sxs-lookup"><span data-stu-id="1adb0-240">Read [What workloads can I protect?](site-recovery-workload.md) to learn more about protecting enterprise workloads with Azure Site Recovery.</span></span>


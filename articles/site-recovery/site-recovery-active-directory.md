---
title: "aaaProtect Active Directory и DNS с помощью Azure Site Recovery | Документы Microsoft"
description: "В этой статье описывается как tooimplement решение аварийного восстановления для Active Directory с помощью Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: prateek9us
manager: gauravd
editor: 
ms.assetid: af1d9b26-1956-46ef-bd05-c545980b72dc
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 7/20/2017
ms.author: pratshar
ms.openlocfilehash: 49903e54f6d6e1839b0571b7a852c6d7517f0aa1
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="protect-active-directory-and-dns-with-azure-site-recovery"></a><span data-ttu-id="d0122-103">Защита Active Directory и DNS с Azure Site Recovery</span><span class="sxs-lookup"><span data-stu-id="d0122-103">Protect Active Directory and DNS with Azure Site Recovery</span></span>
<span data-ttu-id="d0122-104">Корпоративных приложений, таких как SharePoint, Dynamics AX и SAP зависят от Active Directory и инфраструктуры DNS toofunction правильно.</span><span class="sxs-lookup"><span data-stu-id="d0122-104">Enterprise applications such as SharePoint, Dynamics AX, and SAP depend on Active Directory and a DNS infrastructure toofunction correctly.</span></span> <span data-ttu-id="d0122-105">При создании решения аварийного восстановления для приложений является важным tooremember требуется tooprotect и восстановления Active Directory и DNS до hello другие компоненты приложения, tooensure, вещей правильной после аварии.</span><span class="sxs-lookup"><span data-stu-id="d0122-105">When you create a disaster recovery solution for applications, it's important tooremember that you need tooprotect and recover Active Directory and DNS before hello other application components, tooensure that things function correctly when disaster occurs.</span></span>

<span data-ttu-id="d0122-106">Site Recovery — это служба Azure, которая обеспечивает аварийное восстановление, управляя процессами репликации, отработки отказа и восстановления виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="d0122-106">Site Recovery is an Azure service that provides disaster recovery by orchestrating replication, failover, and recovery of virtual machines.</span></span> <span data-ttu-id="d0122-107">Site Recovery поддерживает ряд tooconsistently защита сценариев репликации и без проблем отработки отказа виртуальных машин и приложений tooprivate, public или поставщика услуг размещения облака.</span><span class="sxs-lookup"><span data-stu-id="d0122-107">Site Recovery supports a number of replication scenarios tooconsistently protect, and seamlessly failover virtual machines and applications tooprivate, public, or hoster clouds.</span></span>

<span data-ttu-id="d0122-108">С помощью Site Recovery можно создать полностью автоматизированный план аварийного восстановления для Active Directory.</span><span class="sxs-lookup"><span data-stu-id="d0122-108">Using Site Recovery, you can create a complete automated disaster recovery plan for Active Directory.</span></span> <span data-ttu-id="d0122-109">При прерывании работы отработку отказа можно запустить из любого места в течение нескольких секунд и таким образом восстановить работоспособность Active Directory за считанные минуты.</span><span class="sxs-lookup"><span data-stu-id="d0122-109">When disruptions occur, you can initiate a failover within seconds from anywhere and get Active Directory up and running in a few minutes.</span></span> <span data-ttu-id="d0122-110">Если вы развернули Active Directory для нескольких приложений, таких как SharePoint и SAP на основном сайте, и хотите toofail узла, а полный hello, можно выполнить переход первой с помощью Active Directory Site Recovery, а затем переход hello других приложений с помощью планов восстановления конкретного приложения.</span><span class="sxs-lookup"><span data-stu-id="d0122-110">If you've deployed Active Directory for multiple applications such as SharePoint and SAP in your primary site, and you want toofail over hello complete site, you can fail over Active Directory first using Site Recovery, and then fail over hello other applications using application-specific recovery plans.</span></span>

<span data-ttu-id="d0122-111">В этой статье объясняется, как toocreate решение аварийного восстановления для Active Directory, как tooperform плановой, незапланированной и тестовой отработки отказа плана восстановления одним щелчком с помощью hello поддерживаемые конфигурации и необходимые компоненты.</span><span class="sxs-lookup"><span data-stu-id="d0122-111">This article explains how toocreate a disaster recovery solution for Active Directory, how tooperform planned, unplanned, and test failovers using a one-click recovery plan, hello supported configurations, and prerequisites.</span></span>  <span data-ttu-id="d0122-112">Перед началом работы необходимо ознакомиться с Active Directory и Azure Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="d0122-112">You should be familiar with Active Directory and Azure Site Recovery before you start.</span></span>

## <a name="replicating-domain-controller"></a><span data-ttu-id="d0122-113">Репликация контроллера домена</span><span class="sxs-lookup"><span data-stu-id="d0122-113">Replicating Domain Controller</span></span>

<span data-ttu-id="d0122-114">Требуется toosetup [Site Recovery репликации](#enable-protection-using-site-recovery) на по крайней мере одну виртуальную машину, размещение контроллера домена и DNS.</span><span class="sxs-lookup"><span data-stu-id="d0122-114">You need toosetup [Site Recovery replication](#enable-protection-using-site-recovery) on at least one virtual machine hosting Domain Controller and DNS.</span></span> <span data-ttu-id="d0122-115">Если у вас есть [нескольких контроллеров домена](#environment-with-multiple-domain-controllers) в вашей среде, кроме tooreplicating hello виртуальную машину контроллера домена с Site Recovery, также необходимо будет tooset копирование [дополнительного контроллера домена](#protect-active-directory-with-active-directory-replication) на целевом сайте hello (Azure или в дополнительный локальный центр обработки данных).</span><span class="sxs-lookup"><span data-stu-id="d0122-115">If you have [multiple domain controllers](#environment-with-multiple-domain-controllers) in your environment, in addition tooreplicating hello domain controller virtual machine with Site Recovery you would also have tooset up an [additional domain controller](#protect-active-directory-with-active-directory-replication) on hello target site (Azure or a secondary on-premises datacenter).</span></span> 

### <a name="single-domain-controller-environment"></a><span data-ttu-id="d0122-116">Среда с одним контроллером домена</span><span class="sxs-lookup"><span data-stu-id="d0122-116">Single domain controller environment</span></span>
<span data-ttu-id="d0122-117">Если у вас есть несколько приложений и только один контроллер домена и требуется toofail всего узла hello вместе, то рекомендуется использовать контроллер домена hello tooreplicate Site Recovery toohello вторичного сайта (ли отработка отказа tooAzure или tooa вторичного сайта).</span><span class="sxs-lookup"><span data-stu-id="d0122-117">If you have a few applications and only a single domain controller, and you want toofail over hello entire site together, then we recommend using Site Recovery tooreplicate hello domain controller toohello secondary site (whether you're failing over tooAzure or tooa secondary site).</span></span> <span data-ttu-id="d0122-118">Hello же реплицированных домена, контроллера или DNS виртуальной машины можно использовать для [тестовая отработка отказа](#test-failover-considerations) также.</span><span class="sxs-lookup"><span data-stu-id="d0122-118">hello same replicated domain controller/DNS virtual machine can be used for [test failover](#test-failover-considerations) as well.</span></span>

### <a name="environment-with-multiple-domain-controllers"></a><span data-ttu-id="d0122-119">Среда с несколькими контроллерами доменов</span><span class="sxs-lookup"><span data-stu-id="d0122-119">Environment with multiple domain controllers</span></span>
<span data-ttu-id="d0122-120">Если у вас есть множество приложений и имеется более одного контроллера домена в среде hello или если планируется toofail через несколько приложений одновременно, рекомендуется, кроме виртуального контроллера домена hello tooreplicating машины с Site Recovery можно также Настройка [дополнительного контроллера домена](#protect-active-directory-with-active-directory-replication) на целевом сайте hello (Azure или в дополнительный локальный центр обработки данных).</span><span class="sxs-lookup"><span data-stu-id="d0122-120">If you have many applications and there's more than one domain controller in hello environment, or if you plan toofail over a few applications at a time, we recommend that in addition tooreplicating hello domain controller virtual machine with Site Recovery you also set up an [additional domain controller](#protect-active-directory-with-active-directory-replication) on hello target site (Azure or a secondary on-premises datacenter).</span></span> <span data-ttu-id="d0122-121">Для [тестовая отработка отказа](#test-failover-considerations), используется контроллер домена реплицирован с Site Recovery и перехода на другой ресурс, hello дополнительного контроллера домена на целевом сайте hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-121">For [test failover](#test-failover-considerations), you use domain controller replicated by Site Recovery and for failover, hello additional domain controller on hello target site.</span></span> 


<span data-ttu-id="d0122-122">Hello следующих разделах объясняется, как tooenable защиты для контроллера домена в Site Recovery и как tooset контроллера домена в Azure.</span><span class="sxs-lookup"><span data-stu-id="d0122-122">hello following sections explain how tooenable protection for a domain controller in Site Recovery, and how tooset up a domain controller in Azure.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="d0122-123">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="d0122-123">Prerequisites</span></span>
* <span data-ttu-id="d0122-124">Локально развернутые Active Directory и DNS-сервер.</span><span class="sxs-lookup"><span data-stu-id="d0122-124">An on-premises deployment of Active Directory and DNS server.</span></span>
* <span data-ttu-id="d0122-125">Хранилище служб Azure Site Recovery в подписке Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="d0122-125">An Azure Site Recovery Services vault in a Microsoft Azure subscription.</span></span>
* <span data-ttu-id="d0122-126">Если выполняется репликация tooAzure, запустите средство оценки готовности виртуальной машины Azure hello на виртуальные машины tooensure они совместимы с виртуальными машинами Azure и служб Azure Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="d0122-126">If you're replicating tooAzure, run hello Azure Virtual Machine Readiness Assessment tool on VMs tooensure they're compatible with Azure VMs and Azure Site Recovery Services.</span></span>

## <a name="enable-protection-using-site-recovery"></a><span data-ttu-id="d0122-127">Включение защиты с помощью Site Recovery</span><span class="sxs-lookup"><span data-stu-id="d0122-127">Enable protection using Site Recovery</span></span>
### <a name="protect-hello-virtual-machine"></a><span data-ttu-id="d0122-128">Защита виртуальной машины hello</span><span class="sxs-lookup"><span data-stu-id="d0122-128">Protect hello virtual machine</span></span>
<span data-ttu-id="d0122-129">Включите защиту виртуальной машины контроллера или DNS-hello домена в Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="d0122-129">Enable protection of hello domain controller/DNS virtual machine in Site Recovery.</span></span> <span data-ttu-id="d0122-130">Настройте параметры Site Recovery, на основе типа виртуальной машины hello (Hyper-V или VMware).</span><span class="sxs-lookup"><span data-stu-id="d0122-130">Configure Site Recovery settings based on hello virtual machine type (Hyper-V or VMware).</span></span> <span data-ttu-id="d0122-131">контроллер домена Hello, реплицируемые с помощью восстановления сайта используется для [тестовая отработка отказа](#test-failover-considerations).</span><span class="sxs-lookup"><span data-stu-id="d0122-131">hello domain controller replicated using Site Recovery is used for [test failover](#test-failover-considerations).</span></span> <span data-ttu-id="d0122-132">Убедитесь, что она соответствует hello следующие требования:</span><span class="sxs-lookup"><span data-stu-id="d0122-132">Make sure it meets hello following requirements:</span></span>

1. <span data-ttu-id="d0122-133">Hello контроллер домена является сервером глобального каталога</span><span class="sxs-lookup"><span data-stu-id="d0122-133">hello domain controller is a global catalog server</span></span>
2. <span data-ttu-id="d0122-134">Hello контроллер домена должен быть владельцем роли FSMO hello для роли, которые потребуются во время тестовой отработки отказа (в противном случае эти роли потребуется toobe [захвачен](http://aka.ms/ad_seize_fsmo) после отработки отказа hello)</span><span class="sxs-lookup"><span data-stu-id="d0122-134">hello domain controller should be hello FSMO role owner for roles that will be needed during a test failover (else these roles will need toobe [seized](http://aka.ms/ad_seize_fsmo) after hello failover)</span></span>

### <a name="configure-virtual-machine-network-settings"></a><span data-ttu-id="d0122-135">Настройка сетевых параметров виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="d0122-135">Configure virtual machine network settings</span></span>
<span data-ttu-id="d0122-136">Для виртуальной машины контроллера или DNS-домена hello Настройка параметров сети в Site Recovery, чтобы hello виртуальная машина будет вложенного toohello правильной сети после отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="d0122-136">For hello domain controller/DNS virtual machine, configure network settings in Site Recovery so that hello virtual machine will be attached toohello right network after failover.</span></span> 

![Параметры сети виртуальных машин](./media/site-recovery-active-directory/DNS-Target-IP.png)

## <a name="protect-active-directory-with-active-directory-replication"></a><span data-ttu-id="d0122-138">Защита Active Directory с помощью репликации Active Directory</span><span class="sxs-lookup"><span data-stu-id="d0122-138">Protect Active Directory with Active Directory replication</span></span>
### <a name="site-to-site-protection"></a><span data-ttu-id="d0122-139">Защита "сайт-сайт"</span><span class="sxs-lookup"><span data-stu-id="d0122-139">Site-to-site protection</span></span>
<span data-ttu-id="d0122-140">Создание контроллера домена на вторичном сайте hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-140">Create a domain controller on hello secondary site.</span></span> <span data-ttu-id="d0122-141">После повышения роли контроллера домена tooa сервера hello, укажите имя hello Привет одному домену, который используется на первичном сайте hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-141">When you promote hello server tooa domain controller role, specify hello name of hello same domain that is being used on hello primary site.</span></span> <span data-ttu-id="d0122-142">Можно использовать hello **Active Directory — сайты и службы** оснастки параметры tooconfigure на связь сайтов hello объекта добавляются сайты toowhich hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-142">You can use hello **Active Directory Sites and Services** snap-in tooconfigure settings on hello site link object toowhich hello sites are added.</span></span> <span data-ttu-id="d0122-143">Настраивая параметры связи между сайтами, можно указать время и периодичность репликации между двумя или несколькими сайтами.</span><span class="sxs-lookup"><span data-stu-id="d0122-143">By configuring settings on a site link, you can control when replication occurs between two or more sites, and how often.</span></span> <span data-ttu-id="d0122-144">Дополнительные сведения см. в статье [Расписание репликации между сайтами](https://technet.microsoft.com/library/cc731862.aspx).</span><span class="sxs-lookup"><span data-stu-id="d0122-144">For more information, see [Scheduling Replication Between Sites](https://technet.microsoft.com/library/cc731862.aspx).</span></span>

### <a name="site-to-azure-protection"></a><span data-ttu-id="d0122-145">Защита "сайт-Azure"</span><span class="sxs-lookup"><span data-stu-id="d0122-145">Site-to-Azure protection</span></span>
<span data-ttu-id="d0122-146">Следуйте инструкциям hello слишком[создания контроллера домена в виртуальной сети Azure](../active-directory/active-directory-install-replica-active-directory-domain-controller.md).</span><span class="sxs-lookup"><span data-stu-id="d0122-146">Follow hello instructions too[create a domain controller in an Azure virtual network](../active-directory/active-directory-install-replica-active-directory-domain-controller.md).</span></span> <span data-ttu-id="d0122-147">После повышения роли контроллера домена tooa сервера hello укажите hello таким же именем домена, используемый на первичном сайте hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-147">When you promote hello server tooa domain controller role, specify hello same domain name that's used on hello primary site.</span></span>

<span data-ttu-id="d0122-148">Затем [перенастроить hello DNS-сервера для виртуальной сети hello](../active-directory/active-directory-install-replica-active-directory-domain-controller.md#reconfigure-dns-server-for-the-virtual-network), toouse hello DNS-сервер в Azure.</span><span class="sxs-lookup"><span data-stu-id="d0122-148">Then [reconfigure hello DNS server for hello virtual network](../active-directory/active-directory-install-replica-active-directory-domain-controller.md#reconfigure-dns-server-for-the-virtual-network), toouse hello DNS server in Azure.</span></span>

![Сеть Azure](./media/site-recovery-active-directory/azure-network.png)

<span data-ttu-id="d0122-150">**DNS в рабочей сети Azure**</span><span class="sxs-lookup"><span data-stu-id="d0122-150">**DNS in Azure Production Network**</span></span>

## <a name="test-failover-considerations"></a><span data-ttu-id="d0122-151">Рекомендации по тестированию отработки отказа</span><span class="sxs-lookup"><span data-stu-id="d0122-151">Test failover considerations</span></span>
<span data-ttu-id="d0122-152">Тестовая отработка отказа проводится в сети, изолированной от рабочей сети, чтобы не мешать выполнению рабочих нагрузок.</span><span class="sxs-lookup"><span data-stu-id="d0122-152">Test failover occurs in a network that's isolated from production network so that there's no impact on production workloads.</span></span>

<span data-ttu-id="d0122-153">В большинстве приложений также требуется наличие hello контроллера домена и toofunction сервера DNS.</span><span class="sxs-lookup"><span data-stu-id="d0122-153">Most applications also require hello presence of a domain controller and a DNS server toofunction.</span></span> <span data-ttu-id="d0122-154">Таким образом до отказа приложения hello, контроллер домена должен toobe, созданные в toobe hello изолированной сети, для тестовой отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="d0122-154">Therefore, before hello application is failed over, a domain controller needs toobe created in hello isolated network toobe used for test failover.</span></span> <span data-ttu-id="d0122-155">Здравствуйте, наиболее простым способом toodo это tooreplicate с Site Recovery виртуальную машину контроллера или DNS-домена.</span><span class="sxs-lookup"><span data-stu-id="d0122-155">hello easiest way toodo this is tooreplicate a domain controller/DNS virtual machine with Site Recovery.</span></span> <span data-ttu-id="d0122-156">Запустите тестовую отработку отказа виртуальной машины контроллера домена hello перед запуском тестовой отработки отказа плана восстановления hello для приложения hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-156">Then run a test failover of hello domain controller virtual machine before running a test failover of hello recovery plan for hello application.</span></span> <span data-ttu-id="d0122-157">Вот как это сделать:</span><span class="sxs-lookup"><span data-stu-id="d0122-157">Here's how you do that:</span></span>

1. <span data-ttu-id="d0122-158">[Реплицировать](site-recovery-replicate-vmware-to-azure.md) hello виртуальную машину контроллера или DNS-домена с помощью Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="d0122-158">[Replicate](site-recovery-replicate-vmware-to-azure.md) hello domain controller/DNS virtual machine using Site Recovery.</span></span>
1. <span data-ttu-id="d0122-159">Создайте изолированную сеть.</span><span class="sxs-lookup"><span data-stu-id="d0122-159">Create an isolated network.</span></span> <span data-ttu-id="d0122-160">Любая виртуальная сеть, созданная в Azure, по умолчанию изолируется от другой сети.</span><span class="sxs-lookup"><span data-stu-id="d0122-160">Any virtual network created in Azure by default is isolated from other networks.</span></span> <span data-ttu-id="d0122-161">Рекомендуется, hello диапазон IP-адресов для этой сети совпадает с таковой рабочей сети.</span><span class="sxs-lookup"><span data-stu-id="d0122-161">We recommend that hello IP address range for this network is same as that of your production network.</span></span> <span data-ttu-id="d0122-162">Не включайте для этой сети подключение между сайтами.</span><span class="sxs-lookup"><span data-stu-id="d0122-162">Don't enable site-to-site connectivity on this network.</span></span>
1. <span data-ttu-id="d0122-163">Укажите IP-адрес DNS в сети hello создан в качестве hello IP-адрес, что предполагается tooget виртуальной машины DNS hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-163">Provide a DNS IP address in hello network created, as hello IP address that you expect hello DNS virtual machine tooget.</span></span> <span data-ttu-id="d0122-164">При реплицировании tooAzure, затем укажите hello IP-адрес для виртуальной Машины, который используется при отработке отказа в hello **целевой IP-адрес** в **вычисления и сеть** параметры.</span><span class="sxs-lookup"><span data-stu-id="d0122-164">If you're replicating tooAzure, then provide hello IP address for hello VM that is used on failover in **Target IP** setting in **Compute and Network** settings.</span></span> 

    <span data-ttu-id="d0122-165">![Целевой IP-адрес](./media/site-recovery-active-directory/DNS-Target-IP.png) **Целевой IP-адрес**</span><span class="sxs-lookup"><span data-stu-id="d0122-165">![Target IP](./media/site-recovery-active-directory/DNS-Target-IP.png) **Target IP**</span></span>

    ![Тестовая сеть Azure](./media/site-recovery-active-directory/azure-test-network.png)

    <span data-ttu-id="d0122-167">**DNS в тестовой сети Azure**</span><span class="sxs-lookup"><span data-stu-id="d0122-167">**DNS in Azure Test Network**</span></span>

> [!TIP]
> <span data-ttu-id="d0122-168">Site Recovery пытается toocreate тестовые виртуальные машины в подсети тем же именем и с помощью hello IP-адрес, предоставленный в качестве **вычисления и сеть** параметры hello виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="d0122-168">Site Recovery attempts toocreate test virtual machines in a subnet of same name and using hello same IP as that provided in **Compute and Network** settings of hello virtual machine.</span></span> <span data-ttu-id="d0122-169">Если подсеть с таким же именем в hello виртуальной сети Azure, предоставленный для теста отработки отказа, недоступен, то тестовая виртуальная машина создается в первом подсети hello в алфавитном порядке.</span><span class="sxs-lookup"><span data-stu-id="d0122-169">If subnet of same name is not available in hello Azure virtual network provided for test failover, then test virtual machine is created in hello first subnet alphabetically.</span></span> <span data-ttu-id="d0122-170">Если hello целевой IP-адрес является частью выбранной подсети hello, Site Recovery попытается toocreate hello теста отработки отказа виртуальной машины с помощью hello целевой IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="d0122-170">If hello target IP is part of hello chosen subnet, then Site Recovery tries toocreate hello test failover virtual machine using hello target IP.</span></span> <span data-ttu-id="d0122-171">Если hello целевой IP-адрес не является частью выбранной подсети hello, затем тестовой отработки отказа виртуальной машины создается с помощью любой доступный IP-адрес в hello выбранной подсети.</span><span class="sxs-lookup"><span data-stu-id="d0122-171">If hello target IP is not part of hello chosen subnet, then test failover virtual machine gets created using any available IP in hello chosen subnet.</span></span> 
>
>


1. <span data-ttu-id="d0122-172">Если выполняется репликация на локальном сайте tooanother и вы используете DHCP, следуйте инструкциям hello слишком[Установка DNS и DHCP для тестовой отработки отказа](site-recovery-test-failover-vmm-to-vmm.md#prepare-dhcp)</span><span class="sxs-lookup"><span data-stu-id="d0122-172">If you're replicating tooanother on-premises site and you're using DHCP, follow hello instructions too[setup DNS and DHCP for test failover](site-recovery-test-failover-vmm-to-vmm.md#prepare-dhcp)</span></span>
1. <span data-ttu-id="d0122-173">Выполните тестовую отработку отказа hello виртуальную машину контроллера домена в изолированной сети hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-173">Do a test failover of hello domain controller virtual machine run in hello isolated network.</span></span> <span data-ttu-id="d0122-174">Используйте последние доступные **согласованием приложений** точки восстановления hello домена контроллера toodo hello теста отработки отказа виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="d0122-174">Use latest available **application consistent** recovery point of hello domain controller virtual machine toodo hello test failover.</span></span> 
1. <span data-ttu-id="d0122-175">Запустите тестовую отработку отказа для плана восстановления hello, содержащем виртуальные машины приложения hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-175">Run a test failover for hello recovery plan that contains virtual machines of hello application.</span></span> 
1. <span data-ttu-id="d0122-176">После завершения тестирования **очистку тестовой отработки отказа** на виртуальной машине контроллера домена hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-176">After testing is complete, **Cleanup test failover** on hello domain controller virtual machine.</span></span> <span data-ttu-id="d0122-177">Этот шаг удаляет hello контроллера домена, который был создан для тестовой отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="d0122-177">This step deletes hello domain controller that was created for test failover.</span></span>


### <a name="removing-reference-tooother-domain-controllers"></a><span data-ttu-id="d0122-178">Удаление контроллеры домена tooother ссылки</span><span class="sxs-lookup"><span data-stu-id="d0122-178">Removing reference tooother domain controllers</span></span>
<span data-ttu-id="d0122-179">При выполнении тестовой отработки отказа не перевести все контроллеры домена hello в тестовой сети hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-179">When you are doing a test failover, you don't bring all hello domain controllers in hello test network.</span></span> <span data-ttu-id="d0122-180">Справочник по tooremove hello других контроллеров домена, которые существуют в вашей рабочей среде, может потребоваться слишком[изменения размера ролей FSMO Active Directory](http://aka.ms/ad_seize_fsmo) и выполните [очистку метаданных](https://technet.microsoft.com/library/cc816907.aspx) для домена отсутствует контроллеры.</span><span class="sxs-lookup"><span data-stu-id="d0122-180">tooremove hello reference of other domain controllers that exist in your production environment, you might need too[seize FSMO Active Directory roles](http://aka.ms/ad_seize_fsmo) and do [metadata cleanup](https://technet.microsoft.com/library/cc816907.aspx) for missing domain controllers.</span></span> 



> [!IMPORTANT]
> <span data-ttu-id="d0122-181">Некоторые конфигурации hello, описанные в следующем разделе hello не конфигураций контроллеров домена по умолчанию standard hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-181">Some of hello configurations described in hello following section are not hello standard/default domain controller configurations.</span></span> <span data-ttu-id="d0122-182">Если вы не хотите toomake контроллера домена рабочей среде эти изменения tooa, то можно создать toobe выделенной контроллера домена, используется для восстановления сайта тестовой отработки отказа и внести эти изменения toothat.</span><span class="sxs-lookup"><span data-stu-id="d0122-182">If you don't want toomake these changes tooa production domain controller, then you can create a domain controller dedicated toobe used for Site Recovery test failover and make these changes toothat.</span></span>  
>
>

### <a name="issues-because-of-virtualization-safeguards"></a><span data-ttu-id="d0122-183">Вопросы, связанные с мерами по обеспечению безопасности виртуализации</span><span class="sxs-lookup"><span data-stu-id="d0122-183">Issues because of virtualization safeguards</span></span> 

<span data-ttu-id="d0122-184">Начиная с Windows Server 2012 в [Active Directory Domain Services предусмотрены дополнительные меры безопасности](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100).</span><span class="sxs-lookup"><span data-stu-id="d0122-184">Beginning with Windows Server 2012, [additional safeguards have been built into Active Directory Domain Services](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100).</span></span> <span data-ttu-id="d0122-185">Эти меры безопасности помогают защитить виртуализированные контроллеры домена от отката USN, при условии, что базовая платформа низкоуровневой оболочки hello поддерживает ИД создания Виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="d0122-185">These safeguards help protect virtualized domain controllers against USN Rollbacks, as long as hello underlying hypervisor platform supports VM-GenerationID.</span></span> <span data-ttu-id="d0122-186">Azure поддерживает VM-GenerationID, это означает, что контроллеры домена под управлением Windows Server 2012 или более поздней версии на виртуальных машинах Azure hello дополнительные меры безопасности.</span><span class="sxs-lookup"><span data-stu-id="d0122-186">Azure supports VM-GenerationID, which means that domain controllers that run Windows Server 2012 or later on Azure virtual machines have hello additional safeguards.</span></span> 


<span data-ttu-id="d0122-187">При сбросе hello Виртуальной машины также сбрасывается invocationID hello базы данных hello AD DS, удаляется пул RID hello и SYSVOL помечается как не заслуживающий доверия.</span><span class="sxs-lookup"><span data-stu-id="d0122-187">When hello VM-GenerationID is reset, hello invocationID of hello AD DS database is also reset, hello RID pool is discarded, and SYSVOL is marked as non-authoritative.</span></span> <span data-ttu-id="d0122-188">Дополнительные сведения см. в разделе [tooActive введение виртуализация](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100) и [безопасная виртуализация DFSR](https://blogs.technet.microsoft.com/filecab/2013/04/05/safely-virtualizing-dfsr/)</span><span class="sxs-lookup"><span data-stu-id="d0122-188">For more information, see [Introduction tooActive Directory Domain Services Virtualization](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100) and [Safely Virtualizing DFSR](https://blogs.technet.microsoft.com/filecab/2013/04/05/safely-virtualizing-dfsr/)</span></span>

<span data-ttu-id="d0122-189">Переход tooAzure может привести сброса Виртуальной машины и, будет запущено hello дополнительные меры безопасности при запуске виртуальной машины контроллера домена hello в Azure.</span><span class="sxs-lookup"><span data-stu-id="d0122-189">Failing over tooAzure may cause resetting of VM-GenerationID and that kicks in hello additional safeguards when hello domain controller virtual machine starts in Azure.</span></span> <span data-ttu-id="d0122-190">Это может привести к **значительной задержкой** в виртуальную машину контроллера домена может toologin toohello пользователя.</span><span class="sxs-lookup"><span data-stu-id="d0122-190">This may result in a **significant delay** in user being able toologin toohello domain controller virtual machine.</span></span> <span data-ttu-id="d0122-191">Так как этот контроллер домена будет использоваться только для тестовой отработки отказа, меры безопасности виртуализации не обязательны.</span><span class="sxs-lookup"><span data-stu-id="d0122-191">Since this domain controller would be used only in a test failover, virtualization safeguards are not necessary.</span></span> <span data-ttu-id="d0122-192">tooensure, ИД создания Виртуальной машины для виртуальной машины контроллера домена hello не меняется, то можно изменить значение hello следующие too4 DWORD в hello на локальном контроллере домена.</span><span class="sxs-lookup"><span data-stu-id="d0122-192">tooensure that VM-GenerationID for hello domain controller virtual machine doesn't change, then you can change hello value of following DWORD too4 in hello on-premises domain controller.</span></span>

        
        HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\gencounter\Start
 

#### <a name="symptoms-of-virtualization-safeguards"></a><span data-ttu-id="d0122-193">Признаки применения мер по обеспечению безопасности виртуализации</span><span class="sxs-lookup"><span data-stu-id="d0122-193">Symptoms of virtualization safeguards</span></span>
 
<span data-ttu-id="d0122-194">Если меры безопасности виртуализации применены после тестовой отработки отказа, вы увидите один или несколько следующих признаков.</span><span class="sxs-lookup"><span data-stu-id="d0122-194">If virtualization safeguards have kicked in after a test failover, you may see one or more of following symptoms:</span></span>  

<span data-ttu-id="d0122-195">Изменение идентификатора создания</span><span class="sxs-lookup"><span data-stu-id="d0122-195">Generation ID change</span></span>

![Изменение идентификатора создания](./media/site-recovery-active-directory/Event2170.png)

<span data-ttu-id="d0122-197">Изменение идентификатора вызова</span><span class="sxs-lookup"><span data-stu-id="d0122-197">Invocation ID change</span></span>

![Изменение идентификатора вызова](./media/site-recovery-active-directory/Event1109.png)

<span data-ttu-id="d0122-199">Общие папки Sysvol и Netlogon не доступны</span><span class="sxs-lookup"><span data-stu-id="d0122-199">Sysvol and Netlogon shares are not available</span></span>

![Общая папка Sysvol](./media/site-recovery-active-directory/sysvolshare.png)

![Ntfrs Sysvol](./media/site-recovery-active-directory/Event13565.png)

<span data-ttu-id="d0122-202">Удалена база данных DFSR</span><span class="sxs-lookup"><span data-stu-id="d0122-202">Any DFSR databases are deleted</span></span>

![Удаление базы данных DFSR](./media/site-recovery-active-directory/Event2208.png)


> [!IMPORTANT]
> <span data-ttu-id="d0122-204">Некоторые конфигурации hello, описанные в следующем разделе hello не конфигураций контроллеров домена по умолчанию standard hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-204">Some of hello configurations described in hello following section are not hello standard/default domain controller configurations.</span></span> <span data-ttu-id="d0122-205">Если вы не хотите toomake контроллера домена рабочей среде эти изменения tooa, то можно создать toobe выделенной контроллера домена, используется для восстановления сайта тестовой отработки отказа и внести эти изменения toothat.</span><span class="sxs-lookup"><span data-stu-id="d0122-205">If you don't want toomake these changes tooa production domain controller, then you can create a domain controller dedicated toobe used for Site Recovery test failover and make these changes toothat.</span></span>  
>
>


### <a name="troubleshooting-domain-controller-issues-during-test-failover"></a><span data-ttu-id="d0122-206">Устранение неполадок контроллера домена при тестовой отработке отказа</span><span class="sxs-lookup"><span data-stu-id="d0122-206">Troubleshooting domain controller issues during test failover</span></span>


<span data-ttu-id="d0122-207">Запустите командную строку hello, следующая команда toocheck ли папки SYSVOL и NETLOGON являются общими:</span><span class="sxs-lookup"><span data-stu-id="d0122-207">On a command prompt, run hello following command toocheck whether SYSVOL and NETLOGON folders are shared:</span></span>

    NET SHARE

<span data-ttu-id="d0122-208">На hello командной строки выполните следующую команду, что tooensure, hello контроллер домена работает правильно hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-208">On hello command prompt, run hello following command tooensure that hello domain controller is functioning properly.</span></span>

    dcdiag /v > dcdiag.txt

<span data-ttu-id="d0122-209">В журнал выходные данные hello найдите следующий текст tooconfirm, hello контроллер домена работает нормально.</span><span class="sxs-lookup"><span data-stu-id="d0122-209">In hello output log, look for following text tooconfirm that hello domain controller is functioning well.</span></span> 

* <span data-ttu-id="d0122-210">"passed test Connectivity"</span><span class="sxs-lookup"><span data-stu-id="d0122-210">"passed test Connectivity"</span></span>
* <span data-ttu-id="d0122-211">"passed test Advertising"</span><span class="sxs-lookup"><span data-stu-id="d0122-211">"passed test Advertising"</span></span>
* <span data-ttu-id="d0122-212">"passed test MachineAccount"</span><span class="sxs-lookup"><span data-stu-id="d0122-212">"passed test MachineAccount"</span></span>

<span data-ttu-id="d0122-213">Если hello выше условия выполнены, весьма вероятно, этот контроллер домена hello работает нормально.</span><span class="sxs-lookup"><span data-stu-id="d0122-213">If hello preceding conditions are satisfied, it is likely that hello domain controller is functioning well.</span></span> <span data-ttu-id="d0122-214">Если нет, попробуйте сделать следующее.</span><span class="sxs-lookup"><span data-stu-id="d0122-214">If not, try following steps.</span></span>


* <span data-ttu-id="d0122-215">Выполните принудительное восстановление контроллера домена hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-215">Do an authoritative restore of hello domain controller.</span></span>
    * <span data-ttu-id="d0122-216">Несмотря на то, что он является [не рекомендуется репликации toouse FRS](https://blogs.technet.microsoft.com/filecab/2014/06/25/the-end-is-nigh-for-frs/), но если по-прежнему используют ее, а затем выполните инструкции hello [здесь](https://support.microsoft.com/kb/290762) toodo принудительное восстановление.</span><span class="sxs-lookup"><span data-stu-id="d0122-216">Although it is [not recommended toouse FRS replication](https://blogs.technet.microsoft.com/filecab/2014/06/25/the-end-is-nigh-for-frs/), but if you are still using it then follow hello steps provided [here](https://support.microsoft.com/kb/290762) toodo an authoritative restore.</span></span> <span data-ttu-id="d0122-217">Можно прочитать дополнительные сведения о Burflags говорили о ссылке на предыдущую hello [здесь](https://blogs.technet.microsoft.com/janelewis/2006/09/18/d2-and-d4-what-is-it-for/).</span><span class="sxs-lookup"><span data-stu-id="d0122-217">You can read more about Burflags talked about in hello previous link [here](https://blogs.technet.microsoft.com/janelewis/2006/09/18/d2-and-d4-what-is-it-for/).</span></span>
    * <span data-ttu-id="d0122-218">При использовании DFSR репликации выполните hello действия доступны [здесь](https://support.microsoft.com/kb/2218556) toodo принудительное восстановление.</span><span class="sxs-lookup"><span data-stu-id="d0122-218">If you are using DFSR replication, then follow hello steps available [here](https://support.microsoft.com/kb/2218556) toodo an authoritative restore.</span></span> <span data-ttu-id="d0122-219">Для этой цели также можно использовать функции Powershell, доступные по этой [ссылке](https://blogs.technet.microsoft.com/thbouche/2013/08/28/dfsr-sysvol-authoritative-non-authoritative-restore-powershell-functions/).</span><span class="sxs-lookup"><span data-stu-id="d0122-219">You can also use Powershell functions available on this [link](https://blogs.technet.microsoft.com/thbouche/2013/08/28/dfsr-sysvol-authoritative-non-authoritative-restore-powershell-functions/) for this purpose.</span></span> 
    
* <span data-ttu-id="d0122-220">Обойдите требование начальной синхронизации, задав следующие too0 ключа реестра в hello на локальном контроллере домена.</span><span class="sxs-lookup"><span data-stu-id="d0122-220">Bypass initial synchronization requirement by setting following registry key too0 in hello on-premises domain controller.</span></span> <span data-ttu-id="d0122-221">Если параметр DWORD не существует, его можно создать в узле Parameters.</span><span class="sxs-lookup"><span data-stu-id="d0122-221">If this DWORD doesn't exist, then you can create it under node 'Parameters'.</span></span> <span data-ttu-id="d0122-222">Подробнее об этом можно прочитать [здесь](https://support.microsoft.com/kb/2001093).</span><span class="sxs-lookup"><span data-stu-id="d0122-222">You can read more about it [here](https://support.microsoft.com/kb/2001093)</span></span>

        HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters\Repl Perform Initial Synchronizations

* <span data-ttu-id="d0122-223">Отключите требование hello, что сервер глобального каталога является доступных toovalidate входа пользователя, задав следующие too1 ключа реестра в hello на локальном контроллере домена.</span><span class="sxs-lookup"><span data-stu-id="d0122-223">Disable hello requirement that a global catalog server is available toovalidate user logon by setting following registry key too1 in hello on-premises domain controller.</span></span> <span data-ttu-id="d0122-224">Если параметр DWORD не существует, его можно создать на узле Lsa.</span><span class="sxs-lookup"><span data-stu-id="d0122-224">If this DWORD doesn't exist, then you can create it under node 'Lsa'.</span></span> <span data-ttu-id="d0122-225">Подробнее об этом можно прочитать [здесь](http://support.microsoft.com/kb/241789).</span><span class="sxs-lookup"><span data-stu-id="d0122-225">You can read more about it [here](http://support.microsoft.com/kb/241789)</span></span>

        HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\IgnoreGCFailures



### <a name="dns-and-domain-controller-on-different-machines"></a><span data-ttu-id="d0122-226">Контроллер домена и DNS на разных компьютерах</span><span class="sxs-lookup"><span data-stu-id="d0122-226">DNS and domain controller on different machines</span></span>
<span data-ttu-id="d0122-227">Если DNS не включена в hello одну виртуальную машину контроллера домена hello, должен иметь toocreate DNS виртуальной Машины для тестовой отработки отказа hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-227">If DNS isn't on hello same virtual machine as hello domain controller, you need toocreate a DNS VM for hello test failover.</span></span> <span data-ttu-id="d0122-228">Если они Здравствуйте одной виртуальной Машины, этот раздел можно пропустить.</span><span class="sxs-lookup"><span data-stu-id="d0122-228">If they're on hello same VM, you can skip this section.</span></span>

<span data-ttu-id="d0122-229">Можно использовать новый DNS-сервер и создать все необходимые hello зоны.</span><span class="sxs-lookup"><span data-stu-id="d0122-229">You can use a fresh DNS server and create all hello required zones.</span></span> <span data-ttu-id="d0122-230">Например если вашим доменом Active Directory — contoso.com, можно создать зону DNS с именем contoso.com hello. Hello записи, соответствующие tooActive каталога необходимо обновить в DNS, следующим образом:</span><span class="sxs-lookup"><span data-stu-id="d0122-230">For example, if your Active Directory domain is contoso.com, you can create a DNS zone with hello name contoso.com. hello entries corresponding tooActive Directory must be updated in DNS, as follows:</span></span>

1. <span data-ttu-id="d0122-231">Убедитесь, что эти параметры действуют до появится другой виртуальной машине в плане восстановления hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-231">Ensure these settings are in place before any other virtual machine in hello recovery plan comes up:</span></span>
   
   * <span data-ttu-id="d0122-232">Hello зона должна быть названа корневое имя леса hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-232">hello zone must be named after hello forest root name.</span></span>
   * <span data-ttu-id="d0122-233">Hello зону должно быть резервного файла.</span><span class="sxs-lookup"><span data-stu-id="d0122-233">hello zone must be file-backed.</span></span>
   * <span data-ttu-id="d0122-234">зоне Hello, должны быть включены безопасные и небезопасные обновления.</span><span class="sxs-lookup"><span data-stu-id="d0122-234">hello zone must be enabled for secure and non-secure updates.</span></span>
   * <span data-ttu-id="d0122-235">разрешения Hello виртуальную машину контроллера домена hello должна указывать IP-адрес toohello hello DNS виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="d0122-235">hello resolver of hello domain controller virtual machine should point toohello IP address of hello DNS virtual machine.</span></span>
2. <span data-ttu-id="d0122-236">Выполните следующую команду на виртуальной машине контроллера домена hello.</span><span class="sxs-lookup"><span data-stu-id="d0122-236">Run hello following command on domain controller virtual machine:</span></span>
   
    `nltest /dsregdns`
3. <span data-ttu-id="d0122-237">Добавление зоны на DNS-сервере hello, разрешить небезопасные обновления и добавить запись для него tooDNS:</span><span class="sxs-lookup"><span data-stu-id="d0122-237">Add a zone on hello DNS server, allow non-secure updates, and add an entry for it tooDNS:</span></span>
   
        dnscmd /zoneadd contoso.com  /Primary
        dnscmd /recordadd contoso.com  contoso.com. SOA %computername%.contoso.com. hostmaster. 1 15 10 1 1
        dnscmd /recordadd contoso.com %computername%  A <IP_OF_DNS_VM>
        dnscmd /config contoso.com /allowupdate 1

## <a name="next-steps"></a><span data-ttu-id="d0122-238">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="d0122-238">Next steps</span></span>
<span data-ttu-id="d0122-239">Чтение [какие рабочие нагрузки защитить?](site-recovery-workload.md) toolearn Дополнительные сведения о защите рабочих нагрузок предприятия с помощью Azure Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="d0122-239">Read [What workloads can I protect?](site-recovery-workload.md) toolearn more about protecting enterprise workloads with Azure Site Recovery.</span></span>


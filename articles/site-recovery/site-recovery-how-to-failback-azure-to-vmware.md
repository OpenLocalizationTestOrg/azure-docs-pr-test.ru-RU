---
title: "Восстановление размещения из Azure в VMware | Документация Майкрософт"
description: "После отработки отказа виртуальных машин в Azure можно инициировать восстановление размещения, чтобы вернуть их в локальную среду. Узнайте, как выполнить восстановление размещения."
services: site-recovery
documentationcenter: 
author: ruturaj
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 06/05/2017
ms.author: ruturajd
ms.openlocfilehash: 1ca34b262a51b694cb9541750588bbea139eeae1
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="fail-back-from-azure-to-an-on-premises-site"></a>Восстановление размещения из Azure на локальный сайт

В этой статье описывается, как восстановить размещение виртуальных машин из Azure на локальный сайт. Для восстановления размещения виртуальных машин VMware или физических серверов Windows или Linux, для которых была выполнена отработка отказа с локального сайта в Azure с использованием [репликации виртуальных машин VMware и физических серверов в Azure с помощью службы Azure Site Recovery](site-recovery-vmware-to-azure-classic.md), следуйте инструкциям, изложенным в этой статье.

> [!WARNING]
> Если вы [выполнили миграцию](site-recovery-migrate-to-azure.md#what-do-we-mean-by-migration), переместили виртуальную машину в другую группу ресурсов или удалили виртуальную машину Azure, то после этого невозможно будет выполнить восстановление размещения. Если вы отключили защиту виртуальной машины, то вы не можете восстановить размещение.

> [!NOTE]
> Если вы выполнили отработку отказа виртуальных машин VMware, то будет невозможно восстановить размещение на узле Hyper-V.

## <a name="overview-of-failback"></a>Общие сведения о восстановлении размещения
Вот как работает восстановление размещения. Восстановление размещения на локальном сайте после отработки отказа в Azure происходит в несколько этапов.

1. [Включите повторную защиту](site-recovery-how-to-reprotect.md) виртуальных машин в Azure, чтобы начать репликацию виртуальных машин VMware на локальный сайт. В рамках этого процесса также потребуется сделать следующее:
    1. Настроить локальный главный целевой сервер — главный целевой сервер под управлением Windows для виртуальных машин Windows и [главный целевой сервер под управлением Linux](site-recovery-how-to-install-linux-master-target.md) для виртуальных машин Linux.
    2. Настроить [сервер обработки](site-recovery-vmware-setup-azure-ps-resource-manager.md).
    3. [Повторно включить защиту](site-recovery-how-to-reprotect.md). Локальная виртуальная машина будет отключена, а данные виртуальной машины Azure — синхронизированы с локальными дисками.
5. После репликации виртуальных машин из Azure на локальный сайт выполните отработку отказа из Azure на локальный сайт.

После восстановления размещения данных повторно включите защиту локальных виртуальных машин, на которые выполнено восстановление размещения, чтобы начать их репликацию в Azure.

Просмотрите видео ниже, чтобы получить общее представление о том, как выполнить отработку отказа из Azure на локальный сайт.
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]

### <a name="fail-back-to-the-original-or-alternate-location"></a>Восстановление размещения в исходное или альтернативное расположение

При отработке отказа виртуальной машины VMware восстановление размещения можно выполнить на той же исходной локальной виртуальной машине, если она по-прежнему доступна. В нашем случае будет выполнена репликация только изменившихся данных. Этот сценарий называется восстановлением в исходном расположении. Если локальная виртуальная машина не существует, восстановление выполняется в альтернативное расположение.

> [!NOTE]
> Вы можете восстановить размещение только на исходные сервер vCenter и сервер конфигурации. Невозможно развернуть новый сервер конфигурации и восстановить размещение с его помощью. Кроме того, невозможно добавить новый сервер vCenter на существующий сервер конфигурации и восстановить размещение на этот сервер vCenter.

#### <a name="original-location-recovery"></a>Восстановление в исходное расположение

Для восстановления размещения на исходной виртуальной машине должны быть выполнены следующие условия:
* Если виртуальной машиной управляет сервер vCenter, то узел ESX главного целевого сервера должен иметь доступ к хранилищу данных виртуальной машины.
* Если виртуальная машина находится на узле ESX, но ею управляет не сервер vCenter, жесткий диск виртуальной машины должен находиться в хранилище данных, к которому имеет доступ узел главного целевого сервера.
* Если виртуальная машина находится на узле ESX и не использует vCenter, прежде чем повторно включить защиту, следует выполнить обнаружение узла ESX главного целевого сервера. Это применимо, если выполняется восстановление размещения и для физических серверов.
* Восстанавливать размещение можно в виртуальную сеть хранения данных (vSAN) или на диски RDM, если эти диски уже существуют и подключены к локальной виртуальной машине.

#### <a name="alternate-location-recovery"></a>Восстановление в другое расположение
Сценарий, в котором локальная виртуальная машина не существует перед повторным включением защиты виртуальной машины, называется восстановлением в альтернативное расположение. В этом случае рабочий процесс повторной защиты создает локальную виртуальную машину еще раз. Это также приведет к скачиванию всех данных.

* Если восстановление размещения выполняется в альтернативное расположение, то виртуальная машина будет восстановлена на том же узле ESX, на котором развернут главный целевой сервер. Для создания диска будет использовано хранилище данных, выбранное при повторном включении защиты виртуальной машины.
* Восстановление размещения можно выполнить только в хранилище данных файловой системы виртуальной машины (VMFS) или хранилище данных vSAN. При наличии RDM повторно включить защиту и восстановить размещение не удастся.
* При повторном включении защиты выполняется одна первоначальная передача большого объема данных, за которой следует передача изменившихся данных. Этот процесс обусловлен тем, что виртуальная машина не существует в локальной среде. При этом должна быть выполнена репликация полного набора данных. Такое повторное включение защиты занимает больше времени, чем восстановление в исходном расположении.
* Восстановление размещения невозможно выполнить на диски RDM. В хранилище данных VMFS или vSAN можно создавать только новые диски виртуальной машины (VMDK-файлы).

Если выполнена отработка отказа физического компьютера в Azure, то восстановить его размещение можно только в качестве виртуальной машины VMware (т. н. рабочий процесс P2A2V). Эта последовательность относится к восстановлению в альтернативном расположении.

* Если защищенный физический сервер под управлением Windows Server 2008 R2 с пакетом обновления 1 (SP1) выполнил отработку отказа в Azure, то он не будет восстановлен в исходном расположении.
* Убедитесь, что у вас есть хотя бы один главный целевой сервер и необходимые узлы ESX (ESXi), на которых необходимо восстановить размещение.

## <a name="have-you-completed-reprotection"></a>Вы включили повторно защиту?
Прежде чем продолжить, включите повторно защиту, чтобы запустить репликацию виртуальных машин и иметь возможность инициировать отработку отказа обратно на локальный сайт. Дополнительные сведения см. в статье [Повторное включение защиты: Azure — локальная среда](site-recovery-how-to-reprotect.md).

## <a name="prerequisites"></a>Предварительные требования

> [!IMPORTANT]
> Во время отработки отказа в Azure локальный сайт может стать недоступным, поэтому сервер конфигурации может быть недоступен или отключен. Во время повторной защиты и восстановления размещения локальный сервер конфигурации должен быть запущен и корректно подключен.

* При восстановлении размещения локальная среда должна содержать сервер конфигурации. Сервер должен быть запущен и подключен к службе, то есть он должен находиться в работоспособном состоянии. Во время восстановления размещения виртуальная машина должна существовать в базе данных сервера конфигурации, иначе восстановление не будет успешным. Поэтому необходимо обеспечить регулярное плановое резервное копирование сервера. В случае аварии вам потребуется восстановить сервер с тем же IP-адресом, чтобы обеспечить восстановление размещения.
* На главном целевом сервере не должно быть моментальных снимков перед активацией повторной защиты или восстановления размещения.

## <a name="steps-to-fail-back"></a>Инструкции по восстановлению размещения

> [!IMPORTANT]
> Прежде чем начать восстановление размещения, убедитесь, что вы повторно включили защиту виртуальных машин. Виртуальные машины должны быть защищенными и находиться в **рабочем** состоянии. Сведения о повторной защите виртуальных машин см. в статье [Повторное включение защиты: Azure — локальная среда](site-recovery-how-to-reprotect.md).

1. На странице реплицированных элементов выберите виртуальную машину, щелкните ее правой кнопкой мыши и выберите пункт **Внеплановая отработка отказа**.
2. На странице **Подтверждение отработки отказа** проверьте направление отработки отказа (из Azure), а затем выберите точку восстановления (последнюю или последнюю, согласованную с приложением), до которой будет выполняться отработка отказа. Точка, согласованная с приложением, следует за последней точкой во времени, что приведет к потере некоторых данных.
3. Во время отработки отказа служба Site Recovery завершает работу виртуальных машин в Azure. Если восстановление размещения выполнено правильно, вы можете убедиться, что работа виртуальных машин в Azure завершена.

### <a name="to-what-recovery-point-can-i-fail-back-the-virtual-machines"></a>До какой точки можно восстановить размещение виртуальных машин?

Вы можете выполнить восстановление размещения виртуальной машины (план восстановления) двумя способами.

Если выбрать последнюю обработанную точку во времени, для всех виртуальных машин будет выполнена отработка отказа до их последней доступной точки во времени. Если в плане восстановления есть группа репликации, для каждой виртуальной машины в группе репликации будет выполнена отработка отказа до ее собственной последней точки во времени.

Нельзя восстановить размещение виртуальной машины, если у нее нет ни одной точки восстановления. Нельзя восстановить размещение плана восстановления, если каждая из его виртуальных машин не содержит хотя бы одну точку восстановления.

> [!NOTE]
> Последняя точка восстановления является согласованной точкой восстановления после сбоя.

Если выбрать согласованную точку восстановления приложения, восстановление размещения одной виртуальной машины будет выполнено до последней доступной согласованной точки в приложении. Если выполняется план восстановления для группы репликации, восстановление будет выполнено до общей доступной точки восстановления.
Обратите внимание, что согласованные с приложением точки восстановления могут быть позднее по времени. Из-за этого может произойти потеря данных.

### <a name="what-happens-to-vmware-tools-post-failback"></a>Что происходит со средствами VMware после восстановления размещения?

Во время отработки отказа в Azure средства VMware не могут выполняться на виртуальной машине Azure. При использовании виртуальной машины Windows ASR отключает средства VMware во время отработки отказа. При использовании виртуальной машины Linux ASR удаляет средства VMware во время отработки отказа.

При восстановлении размещения виртуальной машины Windows средства VMware снова включаются. Аналогично для виртуальной машины Linux — средства VMware переустанавливаются на компьютере во время восстановления размещения.

## <a name="next-steps"></a>Дальнейшие действия

Когда завершится восстановление размещения, зафиксируйте виртуальную машину, чтобы убедиться, что восстановленные виртуальные машины удалены из Azure.

### <a name="commit"></a>Фиксация
Чтобы удалить из Azure виртуальную машину, для которой выполнена отработка отказа, необходимо выполнить фиксацию.
Щелкните защищенный элемент правой кнопкой мыши и выберите **Применить**. Задание удалит из Azure виртуальные машины, для которых была выполнена отработка отказа.

### <a name="reprotect-from-on-premises-to-azure"></a>Повторное включение защиты из локальной среды в Azure

После завершения фиксации виртуальная машина снова окажется на локальном сайте, но не будет защищена. Чтобы снова начать репликацию в Azure, сделайте следующее.

1. Щелкните **Хранилище** > **Настройка** > **Реплицированные элементы**, а затем выберите виртуальные машины, для которых выполнено восстановление размещения, и нажмите кнопку **Защитить повторно**.
2. Укажите сервер обработки, который необходимо использовать для отправки данных в Azure.
3. Нажмите кнопку **ОК**, чтобы запустить задание повторной защиты.

> [!NOTE]
> После загрузки виртуальной машины в локальной среде потребуется некоторое время для повторной регистрации агента на сервере конфигурации (не более 15 минут). Если включить повторную защиту в течение этого времени, произойдет сбой, и на экране отобразится сообщение о том, что агент не установлен. Подождите несколько минут, а затем включите повторную защиту еще раз.

Когда задание повторной защиты завершится, возобновится репликация виртуальной машины в Azure, и вы сможете выполнить отработку отказа.

## <a name="common-issues"></a>Распространенные проблемы
Перед восстановлением размещения убедитесь, что сервер vCenter подключен. В противном случае отключение дисков и их присоединение к виртуальной машине будет завершаться сбоем.

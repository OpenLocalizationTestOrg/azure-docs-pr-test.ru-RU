---
title: "Репликация многоуровневого развертывания Citrix XenDesktop и XenApp с помощью Azure Site Recovery | Документация Майкрософт"
description: "В этой статье описывается защита и восстановление развертывания Citrix XenDesktop и XenApp с помощью Azure Site Recovery."
services: site-recovery
documentationcenter: 
author: ponatara
manager: abhemraj
editor: 
ms.assetid: 9126f5e8-e9ed-4c31-b6b4-bf969c12c184
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/18/2017
ms.author: ponatara
ms.openlocfilehash: dc064352b1841ff346b705dc63186b12d79350b3
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="replicate-a-multi-tier-citrix-xenapp-and-xendesktop-deployment-using-azure-site-recovery"></a>Репликация многоуровневого развертывания Citrix XenApp и XenApp с помощью Azure Site Recovery

## <a name="overview"></a>Обзор

Citrix XenDesktop — это решение для виртуализации рабочих столов, предоставляющее рабочие столы и приложения как службы по требованию для любого пользователя в любом месте. С помощью технологии доставки FlexCast XenDesktop может быстро и безопасно предоставить приложения и рабочие столы пользователям.
Сейчас Citrix XenApp не предоставляет возможности аварийного восстановления.

Хорошее решение по аварийному восстановлению должно позволять моделировать планы восстановления для сложной архитектуры приложений, а также добавлять настраиваемые действия для обработки сопоставлений приложения между различными уровнями. Таким образом, в случае аварии точное решение в один щелчок приведет к меньшему целевому времени восстановления (RTO).

Этот документ содержит пошаговое руководство для создания решения аварийного восстановления для локальных развертываний Citrix XenApp на платформах Hyper-V и VMware vSphere. Он также содержит сведения о том, как выполнить тестовую отработку отказа (отработка аварийного восстановления) и незапланированную отработку отказа в Azure с помощью планов восстановления, поддерживаемых конфигураций и необходимых компонентов.


## <a name="prerequisites"></a>Предварительные требования

Прежде чем продолжить, ознакомьтесь со следующими статьями:

1. [Репликация виртуальных машин VMware в Azure с помощью Site Recovery](site-recovery-vmware-to-azure.md)
1. [Проектирование сети для аварийного восстановления](site-recovery-network-design.md)
1. [Тестовая отработка отказа в Azure в Site Recovery](site-recovery-test-failover-to-azure.md)
1. [Отработка отказа в Site Recovery](site-recovery-failover.md)
1. [Защита Active Directory и DNS с Azure Site Recovery](site-recovery-active-directory.md)
1. [Защита SQL Server с помощью аварийного восстановления SQL Server и Azure Site Recovery](site-recovery-sql.md)

## <a name="deployment-patterns"></a>Модели развертывания

Фермы Citrix XenApp и XenDesktop обычно имеют указанную ниже модель развертывания.

**Модель развертывания**

Развертывание Citrix XenApp и XenDesktop с помощью DNS-сервера AD, сервера базы данных SQL, контролера доставки Citrix, сервера StoreFront, XenApp Master (VDA), сервера лицензирования Citrix XenApp

![Модель развертывания 1](./media/site-recovery-citrix-xenapp-and-xendesktop/citrix-deployment.png)


## <a name="site-recovery-support"></a>Поддержка Site Recovery

В целях этой статьи развертывания Citrix на виртуальных машинах VMware под управлением vSphere 6.0 или System Center VMM 2012 R2, использовались для настройки аварийного восстановления.

### <a name="source-and-target"></a>Исходный и целевой объект

**Сценарий** | **На дополнительный сайт** | **В Azure**
--- | --- | ---
**Hyper-V** | За пределами области | Да
**VMware** | За пределами области | Да
**Физический сервер** | За пределами области | Да

### <a name="versions"></a>Версии
Клиенты могут развертывать компоненты XenApp в качестве физических серверов или виртуальных машин под управлением Hyper-V или VMware. Azure Site Recovery позволяет защитить физические и виртуальные развертывания в Azure.
Так как XenApp 7.7 или более поздние версии поддерживаются в Azure, отработку отказа с переносом в Azure для аварийного восстановления и миграции можно выполнить только для развертываний, выполненных с помощью этих версий.

### <a name="things-to-keep-in-mind"></a>Важные аспекты

1. Поддерживается защита и восстановление локальных развертываний, использующих компьютеры под управлением серверной ОС для предоставления опубликованных приложений XenApp и опубликованных рабочих столов XenApp.

2. Защита и восстановление локальных развертываний, использующих ОС настольных компьютеров для предоставления VDI рабочего стола для виртуальных рабочих столов клиента, включая Windows 10, не поддерживается. Причина в том, что ASR не поддерживает восстановление машин с помощью ОС рабочего стола.  Кроме того, лицензирование некоторых особенностей виртуального рабочего стола клиента (например, Windows 7) еще не поддерживается в Azure. Дополнительные сведения о лицензировании рабочих столов клиента и сервера в Azure см. [здесь](https://azure.microsoft.com/pricing/licensing-faq/).

3.  С помощью Azure Site Recovery нельзя выполнить репликацию и защиту имеющихся локальных клонов MCS или PVS.
Необходимо повторно выполнить создание клонов с помощью Azure RM, подготовленного из контролера доставки.

4. NetScaler невозможно защитить с помощью Azure Site Recovery, так как NetScaler, основана на FreeBSD и Azure Site Recovery, не поддерживает защиту ОС FreeBSD. Необходимо развернуть и настроить новое устройство NetScaler из Azure Marketplace после отработки отказа в Azure.


## <a name="replicating-virtual-machines"></a>Репликация виртуальных машин

Чтобы можно было включить репликацию и восстановление, должны быть защищены следующие компоненты развертывания Citrix XenApp:

* DNS-сервер AD;
* сервер базы данных SQL;
* контроллер доставки Citrix;
* защита сервера StoreFront;
* защита XenApp Master (VDA);
* защита сервера лицензирования Citrix XenApp.


**Репликация DNS-сервера AD**

Сведения о репликации и настройке контроллера домена в Azure см. в статье [Защита Active Directory и DNS с Azure Site Recovery](site-recovery-active-directory.md).

**Репликация сервера базы данных SQL**

Подробные технические рекомендации по выбору варианта защиты серверов SQL см. в статье [Защита SQL Server с помощью аварийного восстановления SQL Server и Azure Site Recovery](site-recovery-sql.md).

В [этом руководстве](site-recovery-vmware-to-azure.md) приводится процедура первой репликации других компонентов виртуальных машин в Azure.

![Защита компонентов XenApp](./media/site-recovery-citrix-xenapp-and-xendesktop/citrix-enablereplication.png)

**Параметры вычислений и сети**

После того, как компьютеры будут защищены (в разделе "Реплицированные элементы" должно отобразится состояние "Защищено"), необходимо настроить параметры вычислений и сети.
В разделе Compute and Network (Вычисления и сеть) > Compute properties (Свойства вычислений) можно указать имя и целевой размер виртуальной машины Azure.
При необходимости измените имя в соответствии с требованиями Azure. Кроме того, можно просмотреть и добавить сведения о целевой сети, подсети и целевом IP-адресе, который будет назначен виртуальной машине Azure.

Обратите внимание на следующее.

* Вы можете задать целевой IP-адрес. Если не указать его, компьютер, для которого выполнена отработка отказа, будет использовать DHCP. Если задать адрес, недоступный при отработке отказа, произойдет сбой. Этот же целевой IP-адрес можно использовать для тестовой отработки отказа, если он доступен в сети тестовой отработки отказа.

* AD или DNS-сервер, который хранит локальный адрес, позволяет указать тот же адрес, что используется в DNS-сервере, для виртуальной сети Azure.

Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины:

*   Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.
*   Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, то будет использовать максимальный размер целевой машины.
* Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер.
*   Если для виртуальной машины настроено несколько сетевых адаптеров, все они будут подключены к одной сети.
*   Если виртуальная машина имеет несколько сетевых адаптеров, сетевым адаптером по умолчанию для этой виртуальной машины Azure станет тот из них, который расположен в списке первым.


## <a name="creating-a-recovery-plan"></a>Создание плана восстановления

После включения репликации для виртуальных машин компонента XenApp необходимо создать план восстановления.
Группы плана восстановления объединяют виртуальные машины с аналогичными требованиями для выполнения отработки отказа и восстановления.  

**Шаги по созданию плана восстановления**

1. Добавьте виртуальные машины компонента XenApp в план восстановления.
2. Выберите "Планы восстановления" > + Recovery Plan (Добавить план восстановления). Укажите интуитивно понятное имя для плана восстановления.
3. Для виртуальных машин VMware в качестве источника выберите сервер обработки VMware, в качестве целевого объекта — Microsoft Azure, а в качестве модели развертывания — диспетчер ресурсов и щелкните "Выбор элементов".
4. Для виртуальных машин Hyper-V в качестве источника выберите сервер VMM, в качестве целевого объекта — Microsoft Azure, а в качестве модели развертывания — диспетчер ресурсов. Щелкните "Выбор элементов" и выберите развертывание виртуальных машин компонента XenApp.

### <a name="adding-virtual-machines-to-failover-groups"></a>Добавление виртуальных машин в группы отработки отказа

Планы восстановления можно настроить для добавления групп отработки отказа для запуска в определенном порядке, скриптов или ручных действий. Следующие группы необходимо добавить в план восстановления.

1. 1 группа отработки отказа: DNS-сервер AD.
2. 2 группа отработки отказа: виртуальные машины SQL Server.
2. 3 группа отработки отказа: виртуальная машина с образом VDA Master.
3. 4 группа отработки отказа: контроллер доставки и виртуальные машины сервера StoreFront.


### <a name="adding-scripts-to-the-recovery-plan"></a>Добавление скриптов в план восстановления

Скрипты могут выполняться до или после определенной группы в плане восстановления. Выполняемые вручную действия могут быть также включены и выполняться во время отработки отказа.

Настроенный план восстановления выглядит следующим образом:

1. 1 группа отработки отказа: DNS-сервер AD.
2. 2 группа отработки отказа: виртуальные машины SQL Server.
3. 3 группа отработки отказа: виртуальная машина с образом VDA Master.

   >[!NOTE]     
   >Шаги 4, 6 и 7, содержащие ручные действия или действия скриптов, применимы только к локальной XenApp и среде с каталогами MCS или PVS.

4. Группа 3. Действие вручную или действие скрипта. Завершает работу основной виртуальной машины VDA, которая при отработке отказа в Azure будет находится в состоянии выполнения. Чтобы создать каталоги MCS с помощью размещения Azure ARM, основная виртуальная машина VDA должна находится в остановленном (не распределенном) состоянии. Завершите работу виртуальной машины на портале Azure.

5. 4 группа отработки отказа: контроллер доставки и виртуальные машины сервера StoreFront.
6. Группа 3. Действие вручную или действие скрипта. Вариант 1:

    ***Добавление подключения к узлу Azure RM***

    Создайте подключение к узлу Azure ARM на компьютере контроллера доставки для подготовки новых каталогов MCS в Azure. Выполните действия, описанные в этой [статье](https://www.citrix.com/blogs/2016/07/21/connecting-to-azure-resource-manager-in-xenapp-xendesktop/).

7. Группа 3. Действие вручную или действие скрипта. Вариант 2:

    ***Повторное создание каталогов MCS в Azure***

    Имеющиеся клоны MCS или PVS на первичном сайте не будут реплицированы в Azure. Необходимо повторно создать клоны с помощью основной реплицируемой VDA и Azure ARM, подготовленной из контролера доставки. Выполните действия, описанные в этой [статье](https://www.citrix.com/blogs/2016/09/12/using-xenapp-xendesktop-in-azure-resource-manager/), чтобы создать каталоги MCS в Azure.

![План восстановления для компонентов XenApp](./media/site-recovery-citrix-xenapp-and-xendesktop/citrix-recoveryplan.png)


   >[!NOTE]
   >Если необходимо, вы можете использовать скрипты, которые находятся в [этом расположении](https://github.com/Azure/azure-quickstart-templates/blob/>master/asr-automation-recovery/scripts), чтобы обновить DNS, используя новый IP-адрес виртуальных машин, для которых была выполнена отработка отказа, или для подключения подсистемы балансировки нагрузки на виртуальных машинах, для которых была выполнена отработка отказа.


## <a name="doing-a-test-failover"></a>Тестовая отработка отказа

Чтобы выполнить тестовую отработку отказа, используйте [это руководство](site-recovery-test-failover-to-azure.md).

![План восстановления](./media/site-recovery-citrix-xenapp-and-xendesktop/citrix-tfo.png)


## <a name="doing-a-failover"></a>Отработка отказа

При выполнении отработки отказа используйте [это руководство](site-recovery-failover.md).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о репликации развертываний Citrix XenApp и XenDesktop см. в [этом техническом документе](https://aka.ms/citrix-xenapp-xendesktop-with-asr). Сведения о репликации других приложений с помощью Site Recovery см. в [этом руководстве](site-recovery-workload.md).

---
title: "Настройка VMM и Hyper-V для репликации на дополнительный сайт с использованием Azure Site Recovery | Документация Майкрософт"
description: "Здесь описывается, как настраивать серверы System Center VMM и узлы Hyper-V для репликации на дополнительный сайт VMM."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: d0389e3b-3737-496c-bda6-77152264dd98
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/30/2017
ms.author: raynew
ms.openlocfilehash: 73bd1790c56ac52166f638de2e80c2a2cfb87e53
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="step-4-set-up-vmm-and-hyper-v-for-hyper-v-vm-replication-to-a-secondary-site"></a><span data-ttu-id="71393-103">Шаг 4. Настройка VMM и Hyper-V для репликации виртуальной машины Hyper-V на дополнительный сайт</span><span class="sxs-lookup"><span data-stu-id="71393-103">Step 4: Set up VMM and Hyper-V for Hyper-V VM replication to a secondary site</span></span> 

<span data-ttu-id="71393-104">Подготовив сети, настройте серверы System Center Virtual Machine Manager (VMM) и узлы Hyper-V для репликации виртуальной машины Hyper-V на дополнительный сайт с помощью [Azure Site Recovery](site-recovery-overview.md) на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="71393-104">After you've prepared for networking, set up System Center Virtual Machine Manager (VMM) servers and Hyper-V hosts for Hyper-V virtual machine (VM) replication to a secondary site, using [Azure Site Recovery](site-recovery-overview.md) in the Azure portal.</span></span> 

<span data-ttu-id="71393-105">Любые комментарии, которые возникнут после прочтения этой статьи, можно добавить в конце этой страницы или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span><span class="sxs-lookup"><span data-stu-id="71393-105">After reading this article, post any comments at the bottom, or on the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>



## <a name="prepare-vmm-servers"></a><span data-ttu-id="71393-106">Подготовка серверов VMM</span><span class="sxs-lookup"><span data-stu-id="71393-106">Prepare VMM servers</span></span> 

<span data-ttu-id="71393-107">Для подготовки к развертыванию сделайте следующее.</span><span class="sxs-lookup"><span data-stu-id="71393-107">To prepare for deployment:</span></span>


1. <span data-ttu-id="71393-108">Убедитесь, что серверы VMM соответствуют [требованиям к поддержке](site-recovery-support-matrix-to-sec-site.md#on-premises-servers) и [предварительным требованиям для развертывания](vmm-to-vmm-walkthrough-prerequisites.md).</span><span class="sxs-lookup"><span data-stu-id="71393-108">Make sure VMM servers comply with the [support requirements](site-recovery-support-matrix-to-sec-site.md#on-premises-servers), and [deployment prerequisites](vmm-to-vmm-walkthrough-prerequisites.md).</span></span>
2. <span data-ttu-id="71393-109">Убедитесь, что серверы VMM подключены к Интернету и имеют доступ к этим URL-адресам.</span><span class="sxs-lookup"><span data-stu-id="71393-109">Make sure VMM servers are connected to the internet and have access to these URLs.</span></span>
    
    [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]
    
    - <span data-ttu-id="71393-110">При использовании правил брандмауэра на основе IP-адресов убедитесь, что эти правила разрешают обмен данными с Azure.</span><span class="sxs-lookup"><span data-stu-id="71393-110">If you have IP address-based firewall rules, ensure they allow communication to Azure.</span></span>
    - <span data-ttu-id="71393-111">Разрешите доступ для [диапазонов IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и использование порта HTTPS (443).</span><span class="sxs-lookup"><span data-stu-id="71393-111">Allow the [Azure Datacenter IP Ranges](https://www.microsoft.com/download/confirmation.aspx?id=41653), and the HTTPS (443) port.</span></span>
    - <span data-ttu-id="71393-112">Необходимо разрешить доступ для диапазонов IP-адресов региона Azure, в котором располагается ваша подписка, и региона "Западная часть США" (используется для контроля доступа и управления удостоверениями).</span><span class="sxs-lookup"><span data-stu-id="71393-112">Allow IP address ranges for the Azure region of your subscription, and for West US (used for Access Control and Identity Management).</span></span>
3. <span data-ttu-id="71393-113">Убедитесь, что серверы VMM [подготовлены к сетевому сопоставлению](vmm-to-vmm-walkthrough-network.md#prepare-for-network-mapping).</span><span class="sxs-lookup"><span data-stu-id="71393-113">Make sure the VMM server is [prepared for network mapping](vmm-to-vmm-walkthrough-network.md#prepare-for-network-mapping)</span></span>


## <a name="prepare-hyper-v-hostsclusters"></a><span data-ttu-id="71393-114">Подготовка узлов и кластеров Hyper-V</span><span class="sxs-lookup"><span data-stu-id="71393-114">Prepare Hyper-V hosts/clusters</span></span>

1. <span data-ttu-id="71393-115">Убедитесь, что узлы и кластеры Hyper-V соответствуют [требованиям](site-recovery-support-matrix-to-sec-site.md#on-premises-servers) и [предварительным требованиям для развертывания](vmm-to-vmm-walkthrough-prerequisites.md).</span><span class="sxs-lookup"><span data-stu-id="71393-115">Make sure Hyper-V hosts/clusters comply with the [support requirements](site-recovery-support-matrix-to-sec-site.md#on-premises-servers), and [deployment prerequisites](vmm-to-vmm-walkthrough-prerequisites.md).</span></span>
2. <span data-ttu-id="71393-116">Проверьте требования к [виртуальным машинам Hyper-V](site-recovery-support-matrix-to-sec-site.md#support-for-replicated-machine-os-versions).</span><span class="sxs-lookup"><span data-stu-id="71393-116">Verify the requirements for [Hyper-V VMs](site-recovery-support-matrix-to-sec-site.md#support-for-replicated-machine-os-versions)</span></span>
3. <span data-ttu-id="71393-117">Проверьте требования к [сети](site-recovery-support-matrix-to-sec-site.md#network-configuration) и [хранилищу](site-recovery-support-matrix-to-sec-site.md#storage).</span><span class="sxs-lookup"><span data-stu-id="71393-117">Verify [network](site-recovery-support-matrix-to-sec-site.md#network-configuration) and [storage](site-recovery-support-matrix-to-sec-site.md#storage) requirements.</span></span>
4. <span data-ttu-id="71393-118">Убедитесь, что узлы Hyper-V подключены к Интернету и имеют доступ к этим URL-адресам.</span><span class="sxs-lookup"><span data-stu-id="71393-118">Make sure Hyper-V hosts are connected to the internet and have access to these URLs.</span></span>
    
    [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]
    
    - <span data-ttu-id="71393-119">При использовании правил брандмауэра на основе IP-адресов убедитесь, что эти правила разрешают обмен данными с Azure.</span><span class="sxs-lookup"><span data-stu-id="71393-119">If you have IP address-based firewall rules, ensure they allow communication to Azure.</span></span>
    - <span data-ttu-id="71393-120">Разрешите доступ для [диапазонов IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и использование порта HTTPS (443).</span><span class="sxs-lookup"><span data-stu-id="71393-120">Allow the [Azure Datacenter IP Ranges](https://www.microsoft.com/download/confirmation.aspx?id=41653), and the HTTPS (443) port.</span></span>
    - <span data-ttu-id="71393-121">Необходимо разрешить доступ для диапазонов IP-адресов региона Azure, в котором располагается ваша подписка, и региона "Западная часть США" (используется для контроля доступа и управления удостоверениями).</span><span class="sxs-lookup"><span data-stu-id="71393-121">Allow IP address ranges for the Azure region of your subscription, and for West US (used for Access Control and Identity Management).</span></span>

## <a name="prepare-for-single-server-deployment"></a><span data-ttu-id="71393-122">Подготовка к развертыванию одного сервера</span><span class="sxs-lookup"><span data-stu-id="71393-122">Prepare for single server deployment</span></span>


<span data-ttu-id="71393-123">Если у вас только один сервер VMM, виртуальные машины на узлах Hyper-V в облаке VMM можно реплицировать в [Azure](hyper-v-site-walkthrough-overview.md) или во вторичное облако VMM, как описано в этом документе.</span><span class="sxs-lookup"><span data-stu-id="71393-123">If you only have a single VMM server, you can replicate VMs in Hyper-V hosts in the VMM cloud to [Azure](hyper-v-site-walkthrough-overview.md) or to a secondary VMM cloud, as described in this document.</span></span> <span data-ttu-id="71393-124">Мы рекомендуем использовать первый вариант, так как репликация между облаками не всегда проходит гладко.</span><span class="sxs-lookup"><span data-stu-id="71393-124">We recommend the first option because replicating between clouds isn't seamless.</span></span>

<span data-ttu-id="71393-125">Если вы твердо намерены выполнять репликацию между облаками, для нее можно использовать один автономный сервер VMM или отдельный сервер VMM, развернутый в растянутом кластере Windows.</span><span class="sxs-lookup"><span data-stu-id="71393-125">If you do want to replicate between clouds, you can replicate with a single standalone VMM server, or with a single VMM server deployed in a stretched Windows cluster</span></span>

### <a name="replicate-with-a-standalone-vmm-server"></a><span data-ttu-id="71393-126">Репликация с использованием изолированного сервера VMM</span><span class="sxs-lookup"><span data-stu-id="71393-126">Replicate with a standalone VMM server</span></span>

<span data-ttu-id="71393-127">В этом сценарии вы развертываете обособленный сервер VMM в качестве виртуальной машины на основном сайте и реплицируете эту виртуальную машину на дополнительный сайт с помощью Site Recovery и реплики Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="71393-127">In this scenario, you deploy the single VMM server as a virtual machine in the primary site, and replicate this VM to a secondary site using Site Recovery and Hyper-V Replica.</span></span>

1. <span data-ttu-id="71393-128">**Настройте VMM на виртуальной машине Hyper-V**.</span><span class="sxs-lookup"><span data-stu-id="71393-128">**Set up VMM on a Hyper-V VM**.</span></span> <span data-ttu-id="71393-129">Мы рекомендуем разместить экземпляр SQL Server, используемый VMM, на той же виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="71393-129">We suggest that you colocate the SQL Server instance used by VMM on the same VM.</span></span> <span data-ttu-id="71393-130">Это экономит время, так как требуется создать только одну виртуальную машину.</span><span class="sxs-lookup"><span data-stu-id="71393-130">This saves time as only one VM has to be created.</span></span> <span data-ttu-id="71393-131">Если вы хотите использовать удаленный экземпляр SQL Server, то в случае сбоя вам потребуется восстановить этот экземпляр перед восстановлением VMM.</span><span class="sxs-lookup"><span data-stu-id="71393-131">If you want to use remote instance of SQL Server and an outage occurs, you need to recover that instance before you can recover VMM.</span></span>
2. <span data-ttu-id="71393-132">**На каждом сервере VMM должно быть настроено по крайней мере два облака**.</span><span class="sxs-lookup"><span data-stu-id="71393-132">**Ensure the VMM server has at least two clouds configured**.</span></span> <span data-ttu-id="71393-133">Одно облако будет содержать виртуальные машины, которые требуется реплицировать, а другое облако будет использоваться в качестве дополнительного расположения.</span><span class="sxs-lookup"><span data-stu-id="71393-133">One cloud will contain the VMs you want to replicate and the other cloud will serve as the secondary location.</span></span> <span data-ttu-id="71393-134">Облако, содержащее виртуальные машины, которые необходимо защитить, должно соответствовать [предварительным требованиям](#prerequisites).</span><span class="sxs-lookup"><span data-stu-id="71393-134">The cloud that contains the VMs you want to protect should comply with [prerequisites](#prerequisites).</span></span>
3. <span data-ttu-id="71393-135">Настройте Site Recovery, как описано в этой статье.</span><span class="sxs-lookup"><span data-stu-id="71393-135">Set up Site Recovery as described in this article.</span></span> <span data-ttu-id="71393-136">Создайте и зарегистрируйте сервер VMM в хранилище, настройте политику репликации и включите репликацию.</span><span class="sxs-lookup"><span data-stu-id="71393-136">Create and register the VMM server in a vault, set up a replication policy, and enable replication.</span></span> <span data-ttu-id="71393-137">Имена исходной и целевой службы VMM будут совпадать.</span><span class="sxs-lookup"><span data-stu-id="71393-137">The source and target VMM names will be the same.</span></span> <span data-ttu-id="71393-138">Укажите, что начальная репликация осуществляется по сети.</span><span class="sxs-lookup"><span data-stu-id="71393-138">Specify that initial replication takes place over the network.</span></span>
4. <span data-ttu-id="71393-139">После настройки сетевого сопоставления будет сопоставлена сеть виртуальной машины для первичного облака и сеть виртуальной машины для вторичного облака.</span><span class="sxs-lookup"><span data-stu-id="71393-139">When you set up network mapping you map the VM network for the primary cloud to the VM network for the secondary cloud.</span></span>
5. <span data-ttu-id="71393-140">В консоли диспетчера Hyper-V включите реплику Hyper-V на узле Hyper-V, содержащем виртуальную машину VMM, и включите репликацию для этой виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="71393-140">In the Hyper-V Manager console, enable Hyper-V Replica on the Hyper-V host that contains the VMM VM, and enable replication on the VM.</span></span> <span data-ttu-id="71393-141">Убедитесь, что виртуальная машина VMM не добавляется в облака, которые защищены с помощью Site Recovery, чтобы избежать переопределения параметров реплики Hyper-V компонентом Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="71393-141">Make sure you don't add the VMM virtual machine to clouds that are protected by Site Recovery, to ensure that Hyper-V Replica settings aren't overridden by Site Recovery.</span></span>
6. <span data-ttu-id="71393-142">В случае создания планов восстановления для отработки отказа укажите один и тот же сервер VMM в качестве исходного и целевого.</span><span class="sxs-lookup"><span data-stu-id="71393-142">If you create recovery plans for failover you use the same VMM server for source and target.</span></span>
7. <span data-ttu-id="71393-143">Отработка отказа и восстановление при полном сбое выполняются следующим образом.</span><span class="sxs-lookup"><span data-stu-id="71393-143">In a complete outage, you fail over and recover as follows:</span></span>

   1. <span data-ttu-id="71393-144">В консоли диспетчера Hyper-V на дополнительном сайте выполните внеплановую отработку отказа, чтобы перенести основную виртуальную машину VMM на дополнительный сайт.</span><span class="sxs-lookup"><span data-stu-id="71393-144">Run an unplanned failover in the Hyper-V Manager console in the secondary site, to fail over the primary VMM VM to the secondary site.</span></span>
   2. <span data-ttu-id="71393-145">Убедитесь, что виртуальная машина VMM работает, и выполните в хранилище внеплановую отработку отказа, чтобы перенести виртуальные машины из основного облака в дополнительное.</span><span class="sxs-lookup"><span data-stu-id="71393-145">Verify that the VMM VM is up and running, and in the vault, run an unplanned failover to fail over the VMs from primary to secondary clouds.</span></span> <span data-ttu-id="71393-146">Примените отработку отказа и выберите альтернативную точку восстановления, если необходимо.</span><span class="sxs-lookup"><span data-stu-id="71393-146">Commit the failover, and select an alternate recovery point if required.</span></span>
   3. <span data-ttu-id="71393-147">После завершения незапланированной отработки все ресурсы снова будут доступны на основном сайте.</span><span class="sxs-lookup"><span data-stu-id="71393-147">After the unplanned failover is complete, all resources can be accessed from the primary site again.</span></span>
   4. <span data-ttu-id="71393-148">Когда основной сайт снова станет доступен, в консоли диспетчера Hyper-V на дополнительном сайте включите обратную репликацию для виртуальной машины VMM.</span><span class="sxs-lookup"><span data-stu-id="71393-148">When the primary site is available again, in the Hyper-V Manager console in the secondary site, enable reverse replication for the VMM VM.</span></span> <span data-ttu-id="71393-149">Это запустит репликацию виртуальной машины с дополнительного сайта на основной.</span><span class="sxs-lookup"><span data-stu-id="71393-149">This starts replication for the VM from secondary to primary.</span></span>
   5. <span data-ttu-id="71393-150">В консоли диспетчера Hyper-V на дополнительном сайте выполните плановую отработку отказа, чтобы перенести виртуальную машину VMM обратно на основной сайт.</span><span class="sxs-lookup"><span data-stu-id="71393-150">Run a planned failover in the Hyper-V Manager console in the secondary site, to fail over the VMM VM to the primary site.</span></span> <span data-ttu-id="71393-151">Примените отработку отказа.</span><span class="sxs-lookup"><span data-stu-id="71393-151">Commit the failover.</span></span> <span data-ttu-id="71393-152">После этого включите обратную репликацию, чтобы виртуальная машина VMM снова реплицировалась с основного сайта на дополнительный.</span><span class="sxs-lookup"><span data-stu-id="71393-152">Then enable reverse replication, so that the VMM VM is again replicating from primary to secondary.</span></span>
   6. <span data-ttu-id="71393-153">В хранилище служб восстановления включите обратную репликацию виртуальных машин рабочих нагрузок, чтобы начать их репликацию со вторичного сайта на первичный.</span><span class="sxs-lookup"><span data-stu-id="71393-153">In the Recovery Services vault, enable reverse replication for the workload VMs, to start replicating them from secondary to primary.</span></span>
   7. <span data-ttu-id="71393-154">В хранилище служб восстановления выполните плановую отработку отказа, чтобы восстановить виртуальные машины рабочих нагрузок на первичном сайте.</span><span class="sxs-lookup"><span data-stu-id="71393-154">In the Recovery Services vault, run a planned failover to fail back the workload VMs to the primary site.</span></span> <span data-ttu-id="71393-155">Примените отработку отказа, чтобы завершить ее.</span><span class="sxs-lookup"><span data-stu-id="71393-155">Commit the failover to complete it.</span></span> <span data-ttu-id="71393-156">Затем включите обратную репликацию, чтобы начать репликацию виртуальных машин рабочих нагрузок с первичного сайта на вторичный.</span><span class="sxs-lookup"><span data-stu-id="71393-156">Then enable reverse replication to start replicating the workload VMs from primary to secondary.</span></span>

### <a name="replicate-with-a-stretched-vmm-cluster"></a><span data-ttu-id="71393-157">Репликация с использованием растянутого кластера VMM</span><span class="sxs-lookup"><span data-stu-id="71393-157">Replicate with a stretched VMM cluster</span></span>

<span data-ttu-id="71393-158">Вместо развертывания изолированного сервера VMM в качестве виртуальной машины, которая реплицируется на вторичный сайт, можно сделать сервер VMM высокодоступным, развернув его в качестве виртуальной машины в отказоустойчивом кластере Windows.</span><span class="sxs-lookup"><span data-stu-id="71393-158">Instead of deploying a standalone VMM server as a VM that replicates to a secondary site, you can make VMM highly available by deploying it as a VM in a Windows failover cluster.</span></span> <span data-ttu-id="71393-159">Это позволяет обеспечить устойчивость рабочих нагрузок и защиту от сбоев оборудования.</span><span class="sxs-lookup"><span data-stu-id="71393-159">This provides workload resilience and protection against hardware failure.</span></span> <span data-ttu-id="71393-160">Для развертывания с Site Recovery виртуальная машина VMM должна быть развернута в кластере, растянутом по географически разделенным сайтам.</span><span class="sxs-lookup"><span data-stu-id="71393-160">To deploy with Site Recovery the VMM VM should be deployed in a stretch cluster across geographically separate sites.</span></span> <span data-ttu-id="71393-161">Для этого:</span><span class="sxs-lookup"><span data-stu-id="71393-161">To do this:</span></span>

1. <span data-ttu-id="71393-162">Установите VMM на виртуальной машине в отказоустойчивом кластере Windows и укажите, что во время установки сервер должен быть высокодоступным.</span><span class="sxs-lookup"><span data-stu-id="71393-162">Install VMM on a virtual machine in a Windows failover cluster, and select the option to run the server as highly available during setup.</span></span>
2. <span data-ttu-id="71393-163">Экземпляр SQL Server, используемый VMM, должен реплицироваться с помощью групп доступности SQL Server AlwaysOn, чтобы на дополнительном сайте присутствовала реплика базы данных.</span><span class="sxs-lookup"><span data-stu-id="71393-163">The SQL Server instance that's used by VMM should be replicated with SQL Server AlwaysOn availability groups, so that there's a replica of the database in the secondary site.</span></span>
3. <span data-ttu-id="71393-164">Следуйте инструкциям, приведенным в этой статье, чтобы создать хранилище, зарегистрировать сервер и настроить защиту.</span><span class="sxs-lookup"><span data-stu-id="71393-164">Follow the instructions in this article to create a vault, register the server, and set up protection.</span></span> <span data-ttu-id="71393-165">Необходимо зарегистрировать каждый сервер VMM в кластере в хранилище служб восстановления.</span><span class="sxs-lookup"><span data-stu-id="71393-165">You need to register each VMM server in the cluster in the Recovery Services vault.</span></span> <span data-ttu-id="71393-166">Для этого установите поставщик на активном узле и зарегистрируйте сервер VMM.</span><span class="sxs-lookup"><span data-stu-id="71393-166">To do this, you install the Provider on an active node, and register the VMM server.</span></span> <span data-ttu-id="71393-167">Затем установите поставщик на других узлах.</span><span class="sxs-lookup"><span data-stu-id="71393-167">Then you install the Provider on other nodes.</span></span>
4. <span data-ttu-id="71393-168">При возникновении сбоя сервер VMM и его соответствующая база данных SQL Server переносятся на вторичный сайт, где они становятся доступными.</span><span class="sxs-lookup"><span data-stu-id="71393-168">When an outage occurs, the VMM server and its corresponding SQL Server database are failed over, and accessed from the secondary site.</span></span>



## <a name="next-steps"></a><span data-ttu-id="71393-169">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="71393-169">Next steps</span></span>

<span data-ttu-id="71393-170">Перейдите к статье [Шаг 5. Создание хранилища для репликации Hyper-V на дополнительный сайт](vmm-to-vmm-walkthrough-create-vault.md).</span><span class="sxs-lookup"><span data-stu-id="71393-170">Go to [Step 5: Set up a vault](vmm-to-vmm-walkthrough-create-vault.md).</span></span>
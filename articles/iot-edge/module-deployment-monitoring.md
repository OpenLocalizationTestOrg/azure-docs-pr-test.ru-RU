---
title: "Развертывание модулей для Azure IoT Edge | Документация Майкрософт"
description: "Сведения о развертывании модулей на пограничных устройствах."
services: iot-edge
keywords: 
author: kgremban
manager: timlt
ms.author: kgremban
ms.date: 10/05/2017
ms.topic: article
ms.service: iot-edge
ms.openlocfilehash: 0fb8c55937c1f4c29c542204673a2f41e3ae29db
ms.sourcegitcommit: 48fce90a4ec357d2fb89183141610789003993d2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2018
---
# <a name="understand-iot-edge-deployments-for-single-devices-or-at-scale---preview"></a>Основные сведения о развертываниях IoT Edge для отдельных устройств или в требуемом масштабе (предварительная версия)

Устройства Azure IoT имеют [жизненный цикл устройств][lnk-lifecycle], аналогичный другим типам устройств Интернета вещей:

1. Устройства IoT Edge подготовлены, что включает в себя развертывание образа с операционной системой и установку [среды выполнения IoT Edge][lnk-runtime].
1. Устройства настроены для выполнения [модулей IoT Edge][lnk-modules], а затем выполнен мониторинг их работоспособности. 
1. Наконец, устройства могут быть изъяты из эксплуатации, когда они устареют или будет выполняться замена.  

Azure IoT Edge предоставляет два способа настройки модулей для выполнения на устройствах IoT Edge: один для разработки и быстрых итераций на отдельном устройстве (которое вы использовали в руководствах Azure IoT Edge), а другой для управления большим количеством устройств IoT Edge. Оба этих подхода можно выполнить на портале Azure и программным способом.

В этой статье мы рассмотрим этапы настройки и мониторинга для большого количества устройств, которые совокупно называются развертываниями IoT Edge. Ниже приведены общие шаги по развертыванию.   

1. Оператор определяет развертывание, которое описывает набор модулей, а также целевые устройства. Каждое развертывание имеет манифест развертывания, который отражает эти сведения. 
1. Служба Центра Интернета вещей взаимодействует со всеми целевыми устройствами, чтобы настроить их для нужных модулей. 
1. Служба Центра Интернета вещей извлекает состояние из устройств IoT Edge и предоставляет их для мониторинга оператором.  Например, оператор может видеть, что настройка пограничного устройства не прошла успешно или во время выполнения произошел сбой модуля. 
1. Новые устройства IoT Edge, соответствующие условиям назначения, в любое время можно настроить для развертывания. Например, развертывание, предназначенное для всех устройств IoT Edge штата Вашингтон, автоматически настраивает новое устройств IoT Edge после того, как оно будет подготовлено и добавлено в группу устройств штата Вашингтон. 
 
В этой статье рассматривается каждый компонент, связанный с настройкой и мониторингом развертывания. Пошаговое руководство по созданию и обновлению модулей см. в статье [Развертывание и мониторинг модулей IoT Edge в нужном масштабе (предварительная версия)][lnk-howto].

## <a name="deployment"></a>Развертывание

Развертывание назначает образы модуля IoT Edge для выполнения в качестве экземпляров в целевом наборе устройств IoT Edge. Он настраивает манифест развертывания IoT Edge для включения списка модулей с соответствующими параметрами инициализации. Развертывание можно назначить одному устройству (обычно на основе идентификатора устройства) или группе устройств (на основе тегов). Когда устройство IoT Edge получает манифест развертывания, оно скачивает и устанавливает образы контейнера модулей из соответствующих репозиториев контейнера и настраивает их соответствующим образом. После создания развертывания оператор может выполнять мониторинг состояния развертывания, чтобы отслеживать, правильно ли настроены целевые устройства.   

Чтобы настроить устройства с помощью развертывания, они должны быть подготовлены в качестве устройств IoT Edge. Ниже перечислены необходимые условия, которые не включены в развертывание.
* базовая операционная система;
* Docker 
* подготовка среды выполнения IoT Edge. 

### <a name="deployment-manifest"></a>Манифест развертывания

Манифест развертывания — это документ JSON, описывающий модули, которые нужно настроить на целевых устройствах IoT Edge. Он содержит метаданные конфигурации для всех модулей, включая необходимые системные модули (в частности, агент IoT Edge и концентратор IoT Edge).  

Метаданные конфигурации для каждого модуля содержат: 
* Version (версия) 
* type 
* состояние (например, "Работает" или "Остановлено"); 
* политику перезагрузки; 
* репозиторий образа и контейнера; 
* маршруты для входных и выходных данных. 

### <a name="target-condition"></a>Условие назначения

Условие назначения непрерывно оценивается, чтобы включать новые устройства, отвечающие требованиям, или удалять устройства, которые им больше не отвечают, в течение всего времени существования развертывания. Развертывание будет повторно активировано, если служба обнаруживает любое изменение целевого условия. Например, есть развертывание A с целевым условием tags.environment = 'prod'. Когда вы выполняете развертывание, оно содержит 10 рабочих устройств. Модули успешно устанавливаются на эти 10 устройств. Состояние агента IoT Edge отображается так: всего 10 устройств, 10 успешных ответов, 0 ответов с ошибками и 0 ответов в ожидании. Теперь добавьте еще 5 устройств с целевым условием tags.environment = 'prod'. Служба обнаружит изменение, и состояние агента IoT Edge изменится, когда служба попробует развернуть пять новых устройств. Состояние будет таким: всего 15 устройств, 10 успешных ответов, 0 ответов с ошибками и 5 ответов в ожидании.

Используйте любое логическое условие в тегах двойника устройства или deviceId для выбора целевых устройств. Если вы хотите использовать условие с тегами, необходимо добавить раздел "tags":{} на двойник устройства на том же уровне, что и свойства. [См. дополнительные сведения о тегах в двойнике устройства](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-device-twins).

Примеры целевых условий:
* deviceId ='linuxprod1'
* tags.environment ='prod'
* tags.environment = 'prod' AND tags.location = 'westus'
* tags.environment = 'prod' OR tags.location = 'westus'
* tags.operator = 'John' AND tags.environment = 'prod' NOT deviceId = 'linuxprod1'

Ниже приведены некоторые ограничения, которые нужно учитывать при создании целевого условия:

* На двойнике устройства можно создавать целевое условие, только используя теги и идентификатор устройства.
* В целевом условии не разрешается использовать двойные кавычки. Используйте одинарные кавычки.
* Одинарные кавычки представляют значения целевого условия. Поэтому необходимо экранировать одинарные кавычки с помощью других одинарных кавычек, если они являются частью имени устройства. Например, целевое условие для operator'sDevice необходимо записать как deviceId='operator''sDevice'.
* Для значений целевого условия можно использовать следующие символы: -:.+%_#*? (),=@;$

### <a name="priority"></a>Приоритет

Приоритет определяет, следует ли применять развертывание для целевого устройства по отношению к другим развертываниям. Приоритет развертывания — это положительное целое число. Большие числа обозначают более высокий приоритет. Если для устройства IoT Edge предназначено несколько развертываний, применяется развертывание с самым высоким приоритетом.  Развертывания с низким приоритетом не применяются, а также не объединяются.  Если для устройства предназначено два или больше развертываний с одинаковым приоритетом, будет применяться самое последнее созданное развертывание (определяется меткой времени создания).

### <a name="labels"></a>Метки 

Метки — это пары строк "ключ — значение", которые можно использовать для фильтрации и группирования развертываний. Развертывание может иметь несколько меток. Метки необязательны и не влияют на итоговую конфигурацию устройств IoT Edge. 

### <a name="deployment-status"></a>Состояния развертывания

Вы можете выполнять мониторинг развертывания, чтобы определить, успешно ли оно применено для любого целевого устройства IoT Edge.  Целевое пограничное устройство будет отображаться в одной или нескольких категориях состояния: 
* **Цель.** Отображает устройства IoT Edge, которые соответствуют условиям назначения развертывания.
* **Фактически.** Отображает целевые устройства IoT Edge, которые не используются другими развертываниями с высшим приоритетом.
* **Работоспособный.** Отображает устройства IoT Edge, которые передали в службу сведения об успешном развертывании модулей. 
* **Неработоспособный.** Отображает устройства IoT Edge, которые передали в службу сведения, что при развертывании одного или нескольких модулей произошел сбой. Для дальнейшего изучения ошибки удаленно подключитесь к этим устройствам и просмотрите файлы журнала.
* **Неизвестно.** Отображает устройства IoT Edge, которые не сообщают ни о каких состояниях, относящихся к этому развертыванию. Для дальнейшего изучения просмотрите информацию о службе и файлы журнала.

## <a name="phased-rollout"></a>Поэтапное развертывание 

Поэтапное развертывание — это общий процесс, с помощью которого оператор развертывает изменения в расширенном наборе устройств IoT Edge. Цель этого развертывания — постепенно вносить изменения, чтобы уменьшить риск глобальных критических изменений.  

Поэтапное развертывание выполняется в несколько этапов и шагов: 
1. Определите тестовую среду устройств IoT Edge, подготовив их и задав тег двойника устройства следующим образом: `tag.environment='test'`. Тестовая среда должна отражать рабочую среду, для которой в итоге будет применено развертывание. 
1. Создайте развертывание, включающее необходимые модули и конфигурации. Условие назначения должно быть нацелено на тестовую среду устройства IoT Edge.   
1. Проверьте новую конфигурацию модуля в тестовой среде.
1. Обновите развертывание, чтобы включить подмножество рабочих устройств IoT Edge, добавив новый тег в условие назначения. Кроме того, убедитесь, что приоритет для развертывания выше, чем для других развертываний, которые сейчас предназначены для устройств. 
1. Убедитесь, что развертывание успешно выполнено на целевых устройствах Интернета вещей, просмотрев его состояние.
1. Обновите развертывание для использования всех оставшихся рабочих устройств IoT Edge.

## <a name="rollback"></a>Откат

Вы можете выполнить откат развертываний, если произошли ошибки или в случае неправильной конфигурации.  Так как развертывание определяет абсолютную конфигурацию модуля для устройства IoT Edge, дополнительное развертывание должно также предназначаться для того же устройства с низким приоритетом, даже если необходимо удалить все модули.  

Выполните откаты в следующей последовательности: 
1. Подтвердите, что второе развертывание также предназначено для того же набора устройств. Если целью отката является удалить все модули, второе развертывание не должно содержать никаких модулей. 
1. Измените или удалите выражение условия назначения развертывания, которое вы хотите откатить, чтобы устройство больше не соответствовало условиям назначения.
1. Убедитесь, что откат выполнен успешно, просмотрев состояние развертывания.
   * Развертывание, откат которого выполнен, не должно отображать состояние для устройств, откат которых был выполнен.
   * Второе развертывание теперь должно включать состояние развертывания для устройств, откат которых был выполнен.


## <a name="next-steps"></a>Дополнительная информация

* Ознакомьтесь со статьей [Развертывание и мониторинг модулей IoT Edge в нужном масштабе (предварительная версия)][lnk-howto], чтобы узнать, как создавать, обновлять или удалять развертывание.
* Узнайте больше об основных понятиях IoT Edge, таких как [среда выполнения IoT Edge][lnk-runtime] и [модули IoT Edge][lnk-modules].

<!-- Links -->
[lnk-lifecycle]: ../iot-hub/iot-hub-device-management-overview.md
[lnk-runtime]: iot-edge-runtime.md
[lnk-modules]: iot-edge-modules.md
[lnk-howto]: how-to-deploy-monitor.md
---
title: "Настройка принудительного туннелирования в среде службы приложений Azure"
description: "Настройте среду службы приложений для работы с принудительным туннелированием исходящего трафика"
services: app-service
documentationcenter: na
author: ccompy
manager: stefsch
ms.assetid: 384cf393-5c63-4ffb-9eb2-bfd990bc7af1
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: quickstart
ms.date: 11/10/2017
ms.author: ccompy
ms.custom: mvc
ms.openlocfilehash: 4caaf0df3f1dd4b2cb9b76283a6beed897531c1c
ms.sourcegitcommit: b854df4fc66c73ba1dd141740a2b348de3e1e028
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/04/2017
---
# <a name="configure-your-app-service-environment-with-forced-tunneling"></a>Настройка принудительного туннелирования в среде службы приложений

Среда службы приложений — это развернутая служба приложений Azure в экземпляре виртуальной сети Azure клиента. Многие клиенты настраивают свои виртуальные сети на расширение своих локальных сетей с помощью подключений VPN или соединений Azure ExpressRoute. Из-за корпоративной политики или других ограничений безопасности они настраивают маршруты для отправки всего исходящего трафика в локальную среду, прежде чем он попадет в Интернет. Изменение маршрутизации виртуальной сети таким образом, чтобы исходящий трафик из нее проходил через подключение VPN или ExpressRoute в локальную среду, называется принудительным туннелированием. 

Принудительное туннелирование может вызвать проблемы для среды службы приложений. Среда службы приложений имеет ряд внешних зависимостей, которые перечислены в статье [Рекомендации по работе с сетями в среде службы приложений][network]. Среда службы приложений по умолчанию требует, чтобы весь исходящий трафик проходил через виртуальный IP-адрес, выделенный средой службы приложений.

Маршруты — это важный аспект того, что такое принудительное туннелирование и как с ним работать. В виртуальной сети Azure маршрутизация выполняется на основе совпадения самого длинного префикса (LPM). При наличии нескольких маршрутов с одинаковыми совпадениями LPM маршрут выбирается по источнику в следующем порядке:

* определяемый пользователем маршрут;
* маршрут BGP (если используется ExpressRoute);
* Системные маршруты

Дополнительные сведения о маршрутизации трафика в виртуальной сети см. в [этой статье][routes]. 

Если требуется, чтобы среда службы приложений работала в виртуальной сети с принудительным туннелированием, имеется два варианта:

* Настроить среду службы приложений для прямого доступа к Интернету.
* Изменить конечную точку исходящего трафика для среды службы приложений.

## <a name="enable-your-app-service-environment-to-have-direct-internet-access"></a>Включение среды службы приложений для прямого доступа к Интернету

Для работы вашей среды службы приложений во время настройки виртуальной сети с подключением ExpressRoute можно сделать следующее:

* Настройте ExpressRoute для объявления маршрута 0.0.0.0/0. Это по умолчанию приведет к принудительному туннелированию всего исходящего трафика в локальную среду.
* Создайте определяемый пользователем маршрут. Примените его к подсети со средой службы приложений, добавив к адресу префикс 0.0.0.0/0 и указав для следующего перехода тип Интернет.

После этих двух изменений исходящий трафик из подсети среды службы приложений не будет принудительно направляться по маршруту ExpressRoute, а среда службы приложений возобновит работу.

> [!IMPORTANT]
> Определяемые пользователем маршруты должны быть достаточно конкретными, чтобы иметь приоритет над всеми маршрутами, объявленными в конфигурации ExpressRoute. В приведенном выше примере используется широкий диапазон адресов 0.0.0.0/0. Он может быть случайно заменен объявлениями маршрутов с более узкими диапазонами адресов.
>
> Среды служб приложений с конфигурациями ExpressRoute, осуществляющие перекрестное объявление маршрутов из пути общедоступного пиринга в путь частного пиринга, не поддерживаются. Конфигурации ExpressRoute с настроенным общедоступным пирингом получают объявления маршрутов от корпорации Майкрософт. Эти объявления содержат большой набор диапазонов IP-адресов Microsoft Azure. Если диапазоны адресов перекрестно объявляются по пути частного пиринга, то все исходящие сетевые пакеты из подсети среды службы приложений принудительно туннелируются в локальную сетевую инфраструктуру клиента. В настоящее время этот сетевой поток по умолчанию не поддерживается в среде службы приложений. Чтобы решить эту проблему, необходимо остановить перекрестное объявление маршрутов между путями общедоступного и частного пиринга. Другим решением является настройка среды службы приложений для работы в конфигурации с принудительным туннелированием.

## <a name="change-the-egress-endpoint-for-your-app-service-environment"></a>Изменение конечной точки исходящего трафика для среды службы приложений ##

В этом разделе описывается, как настроить среду службы приложений для работы в конфигурации с принудительным туннелированием путем изменения конечной точки исходящего трафика, используемой среды службы приложений. Если исходящий трафик из среды службы приложений принудительно туннелируется в локальную сеть, вам необходимо разрешить передачу этого трафика с IP-адресов, отличных от виртуального IP-адреса среды службы приложений.

Среда службы приложений не только имеет внешние зависимости, но также должна ожидать передачи данных входящего трафика и реагировать на такой трафик. Ответы нельзя отправлять с другого адреса, так как при этом прерывается TCP-подключение. Для изменения конечной точки исходящего трафика среды службы приложений требуется три шага.

1. Настройте таблицу маршрутизации, чтобы гарантировать, что входящий трафик управления может вернуться с одного и того же IP-адреса.

2. Добавьте IP-адреса, которые будут использоваться для исходящего трафика на брандмауэр среды службы приложений.

3. Установите маршруты для туннелирования исходящего трафика из среды службы приложений.

   ![Сетевой поток с принудительным туннелированием][1]

Для среды службы приложений можно настроить разные исходящие адреса после ее настройки или во время ее развертывания.

### <a name="change-the-egress-address-after-the-app-service-environment-is-operational"></a>Изменение исходящего адреса в работающей среде службы приложений ###
1. Получите IP-адреса, которые вы хотите использовать в качестве IP-адресов исходящего трафика среды службы приложений. Если вы выполняете принудительное туннелирование, эти адреса можно получить с помощью NAT или IP-адресов шлюза. Если вы хотите перенаправить исходящий трафик среды службы приложений через виртуальный сетевой модуль, то адресом исходящего трафика будет общедоступный IP-адрес виртуального сетевого модуля.

2. Настройте адреса исходящего трафика в сведениях о конфигурации среды службы приложений. Войдите на сайт resource.azure.com и перейдите в раздел Subscription/<subscription id>/resourceGroups/<ase resource group>/providers/Microsoft.Web/hostingEnvironments/<ase name>. Затем вы сможете просмотреть код JSON, в котором описана ваша среда службы приложений. Убедитесь, что вверху отображается строка **read/write**. Выберите **Изменить** Прокрутите вниз и измените значение **userWhitelistedIpRanges** с **null** на строку, приведенную ниже. Используйте адреса, которые нужно задать в качестве диапазона адресов исходящего трафика. 

        "userWhitelistedIpRanges": ["11.22.33.44/32", "55.66.77.0/24"] 

   Щелкните **PUT** в верху. Этот параметр запускает операцию масштабирования в среде службы приложений и настраивает брандмауэр.
 
3. Создайте или измените таблицу маршрутов и заполните правила, чтобы разрешить доступ к/из адресов управления, которые соответствуют местоположению вашей среды службы приложений. Сведения о поиске адресов управления см. в статье [Адреса управления среды службы приложений][management].

4. Отрегулируйте маршруты, применяемые к подсети среды службы приложений, с помощью таблицы маршрутов или маршрутов BGP. 

Если среда службы приложений не отвечает на портале, то имеется проблема с вашими изменениями. Проблема может заключаться в том, что ваш список адресов для исходящего трафика был неполным, трафик был потерян или заблокирован. 

### <a name="create-a-new-app-service-environment-with-a-different-egress-address"></a>Создание среды службы приложений с другим адресом исходящего трафика ###

Если в виртуальной сети уже настроено принудительное туннелирование всего трафика, вам нужно предпринять дополнительные шаги для создания работоспособной среды службы приложений. Вам необходимо настроить использование другой конечной точки исходящего трафика во время создания среды службы приложений. Для этого вам нужно создать среду службы приложений с помощью шаблона, который указывает разрешенные адреса исходящего трафика.

1. Получите IP-адреса для использования в качестве адресов исходящего трафика для среды службы приложений.

2. Предварительно создайте подсеть, которая будет использоваться средой службы приложений. Это необходимо, чтобы вы могли устанавливать маршруты, а также потому что этого требует шаблон.

3. Создайте таблицу маршрутов с IP-адресами управления, которые соответствуют местоположению среды службы приложений. Назначьте ее для своей среды службы приложений.

4. Следуйте указаниям, приведенным в статье [Создание среды ASE с помощью шаблона Azure Resource Manager][template]. Извлеките соответствующий шаблон.

5. Отредактируйте раздел resources файла azuredeploy.json. Включите строку для **userWhitelistedIpRanges** со своими значениями, как в следующем примере:

       "userWhitelistedIpRanges":  ["11.22.33.44/32", "55.66.77.0/30"]

Если этот раздел настроен правильно, то среда службы приложений должна запускаться без проблем. 


<!--IMAGES-->
[1]: ./media/forced-tunnel-support/forced-tunnel-flow.png

<!--Links-->
[management]: ./management-addresses.md
[network]: ./network-info.md
[routes]: ../../virtual-network/virtual-networks-udr-overview.md
[template]: ./create-from-template.md

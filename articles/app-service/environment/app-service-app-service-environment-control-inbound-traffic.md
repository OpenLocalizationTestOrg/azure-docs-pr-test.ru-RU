---
title: "Как управлять входящим трафиком в среде службы приложений"
description: "Дополнительные сведения о настройке правил сетевой безопасности для управления входящим трафиком в среде службы приложений."
services: app-service
documentationcenter: 
author: ccompy
manager: erikre
editor: 
ms.assetid: 4cc82439-8791-48a4-9485-de6d8e1d1a08
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/11/2017
ms.author: stefsch
ms.openlocfilehash: ed72bf3202d6cb2d2161bc0df693d3e6a1fc58ef
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="how-to-control-inbound-traffic-to-an-app-service-environment"></a>Как управлять входящим трафиком в среде службы приложений
## <a name="overview"></a>Обзор
Среду службы приложений можно создать **либо** в виртуальной сети Azure Resource Manager, **либо** в [виртуальной сети][virtualnetwork], использующей классическую модель развертывания.  Новые виртуальную сеть и подсеть можно определить во время создания среды службы приложений.  Кроме того, среду службы приложений можно создать в существующих виртуальной сети и подсети.  В связи с изменением от июня 2016 г. среды ASE можно также развертывать в виртуальных сетях, использующих либо диапазоны общедоступных адресов, либо адресные пространства RFC1918 (т. е. частные адреса).  Дополнительные сведения о создании среды службы приложений см. в [этой статье][HowToCreateAnAppServiceEnvironment].

Среда службы приложений всегда должна создаваться в подсети, поскольку подсеть обеспечивает границы сети, которые можно использовать для блокировки входящего трафика за вышестоящими устройствами и службами, например трафик HTTP и HTTPS допускается только от определенных вышестоящих IP-адресов.

Входящий и исходящий сетевой трафик в подсети контролируется с помощью [группы сетевой безопасности][NetworkSecurityGroups]. Для управления входящим трафиком необходимо создать правила сетевой безопасности в группе сетевой безопасности, а затем назначить группу сетевой безопасности для подсети, содержащей среду службы приложений.

После назначения группы сетевой безопасности для подсети входящий трафик на приложения в среде службы приложений разрешается или блокируется в зависимости от правил разрешения или блокировки, определенных в группе сетевой безопасности.

[!INCLUDE [app-service-web-to-api-and-mobile](../../../includes/app-service-web-to-api-and-mobile.md)]

## <a name="inbound-network-ports-used-in-an-app-service-environment"></a>Входящие сетевые порты, используемые в среде службы приложений
Перед блокировкой входящего сетевого трафика с помощью группы сетевой безопасности важно знать набор обязательных и необязательных сетевых портов, используемых средой службы приложений.  Случайное закрытие трафика на некоторых портах может привести к потере функциональности в среде службы приложений.

Ниже приведен список портов, используемых средой службы приложений. Это все **TCP**-порты, если явно не указано иное.

* 454: **обязательный порт**, используемый инфраструктурой Azure для обслуживания сред службы приложений и управления ими через SSL.  Не блокируйте трафик на этом порту.  Этот порт всегда привязан к общедоступному виртуальному IP-адресу ASE.
* 455: **обязательный порт**, используемый инфраструктурой Azure для обслуживания сред службы приложений и управления ими через SSL.  Не блокируйте трафик на этом порту.  Этот порт всегда привязан к общедоступному виртуальному IP-адресу ASE.
* 80: порт по умолчанию для входящего HTTP-трафика для приложений, выполняемых в планах службы приложений в среде службы приложений.  В ASE с внутренним балансировщиком нагрузки этот порт привязан к адресу балансировщика нагрузки ASE.
* 443: порт по умолчанию для входящего трафика SSL для приложений, выполняемых в планах службы приложений в среде службы приложений.  В ASE с внутренним балансировщиком нагрузки этот порт привязан к адресу балансировщика нагрузки ASE.
* 21: канал управления для FTP.  Этот порт можно безопасно заблокировано, если FTP не используется.  В ASE с внутренним балансировщиком нагрузки этот порт может быть привязан к адресу балансировщика нагрузки ASE.
* 990: канал управления для FTPS.  Этот порт можно благополучно заблокировать, если не используется FTPS.  В ASE с внутренним балансировщиком нагрузки этот порт может быть привязан к адресу балансировщика нагрузки ASE.
* 10001 10020: каналы данных для FTP.  Как и при использовании канала управления, эти порты можно безопасно заблокировать, если FTP не используется.  В ASE с внутренним балансировщиком нагрузки этот порт может быть привязан к адресу балансировщика нагрузки ASE.
* 4016: используется для удаленной отладки с помощью Visual Studio 2012.  Этот порт можно безопасно заблокировано, если функция не используется.  В ASE с внутренним балансировщиком нагрузки этот порт привязан к адресу балансировщика нагрузки ASE.
* 4018: используется для удаленной отладки с помощью Visual Studio 2013.  Этот порт можно безопасно заблокировано, если функция не используется.  В ASE с внутренним балансировщиком нагрузки этот порт привязан к адресу балансировщика нагрузки ASE.
* 4020: используется для удаленной отладки с помощью Visual Studio 2015.  Этот порт можно безопасно заблокировано, если функция не используется.  В ASE с внутренним балансировщиком нагрузки этот порт привязан к адресу балансировщика нагрузки ASE.

## <a name="outbound-connectivity-and-dns-requirements"></a>Требования к DNS и исходящим подключениям
Для надлежащего функционирования среды службы приложений также требуется исходящий доступ к различным конечным точкам. Полный список внешних конечных точек, используемых в ASE, приведен в разделе "Необходимое сетевое подключение" статьи [Сведения о конфигурации сети для сред службы приложений с ExpressRoute](app-service-app-service-environment-network-configuration-expressroute.md#required-network-connectivity) .

Для сред службы приложений требуется, чтобы для виртуальной сети была настроена допустимая инфраструктура DNS.  Если после создания среды службы приложений по какой-либо причине меняется конфигурация DNS, разработчик может принудительно задать выбор новой конфигурации DNS в среде службы приложений.  Если перезагрузить разворачиваемую среду, используя значок "Перезапуск", расположенный в верхней части колонки управления средой службы приложений на [классическом портале Azure][NewPortal], будет выбрана новая конфигурация DNS в среде.

Также рекомендуется настроить пользовательские DNS-серверы в виртуальной сети заранее, т. е. до создания среды службы приложений.  Если конфигурация виртуальной сети DNS изменяется во время создания среды службы приложений, это приведет к сбою процесса создания среды службы приложений.  Аналогично, если на другой стороне VPN-шлюза имеется пользовательский DNS-сервер, который недоступен, процесс создания среды службы приложений будет прерван.

## <a name="creating-a-network-security-group"></a>Создание группы сетевой безопасности
Подробные сведения о принципах работы групп сетевой безопасности см. [здесь][NetworkSecurityGroups].  Ниже приведен пример управления службами Azure, в котором рассматриваются группы сетевой безопасности. Особое внимание уделено настройке и применению группы сетевой безопасности к подсети, которая содержит среду службы приложений.

**Примечание**. Группы безопасности сети можно настроить с помощью графического пользовательского интерфейса на [портале Azure](https://portal.azure.com) или с помощью Azure PowerShell.

Сначала группы сетевой безопасности создаются как отдельные сущности, связанные с подпиской. Так как группы сетевой безопасности создаются в области Azure, убедитесь, что группа сетевой безопасности создана в той же области, что и среда службы приложений.

Ниже показано создание группы сетевой безопасности.

    New-AzureNetworkSecurityGroup -Name "testNSGexample" -Location "South Central US" -Label "Example network security group for an app service environment"

После создания группы сетевой безопасности к ней добавляются одно или несколько правил сетевой безопасности.  Поскольку набор правил может со временем меняться, рекомендуется организовать схему нумерации, используемую для приоритетов правил, таким образом, чтобы дополнительные правила можно было просто вставить в дальнейшем.

В приведенном ниже примере показано правило, которое разрешает доступ к портам управления, необходимым для управления и обслуживания среды службы приложений инфраструктурой Azure.  Обратите внимание, что весь трафик управления проходит по SSL и защищен клиентскими сертификатами, поэтому, несмотря на то, что порты открыты, они недоступны для любой сущности, кроме инфраструктуры управления Azure.

    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "ALLOW AzureMngmt" -Type Inbound -Priority 100 -Action Allow -SourceAddressPrefix 'INTERNET'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '454-455' -Protocol TCP


При блокировании доступа к портам 80 и 443, чтобы «скрыть» среду службы приложений за вышестоящими устройствами или службами, необходимо знать вышестоящий IP-адрес.  Например, если вы используете брандмауэр веб-приложения (WAF), WAF будет иметь свой собственный IP-адрес (или адреса), которые он использует при перенаправлении трафика на нисходящую среду службы приложений.  Необходимо будет использовать этот IP-адрес в параметре *SourceAddressPrefix* правила сетевой безопасности.

В следующем примере входящий трафик от конкретного вышестоящего IP-адреса полностью разрешен.  Адрес *1.2.3.4* используется как заполнитель для IP-адреса вышестоящего WAF.  Измените значение адреса на адрес, используемый вышестоящим устройством или службой.

    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT HTTP" -Type Inbound -Priority 200 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '80' -Protocol TCP
    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT HTTPS" -Type Inbound -Priority 300 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '443' -Protocol TCP

Если требуется поддержка FTP, следующие правила можно использовать как шаблон для предоставления доступа к порту управления FTP и портал каналов данных.  Поскольку протокол FTP является протоколом с отслеживанием состояния, нельзя будет направить FTP-трафик через обычный брандмауэр HTTP/HTTPS или прокси-устройство.  В этом случае необходимо задать для параметра *SourceAddressPrefix* другое значение, например диапазон IP-адресов машин разработчика или развертывания, на которых запущены FTP-клиенты. 

    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT FTPCtrl" -Type Inbound -Priority 400 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '21' -Protocol TCP
    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT FTPDataRange" -Type Inbound -Priority 500 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '10001-10020' -Protocol TCP

(**Примечание.** Диапазон портов канала данных может измениться в период использования предварительной версии.)

Следующие правила показывают, как предоставить доступ при использовании удаленной отладки с помощью Visual Studio.  Существует отдельное правило для каждой поддерживаемой версии Visual Studio, поскольку каждая версия использует другой порт для удаленной отладки.  Как и для FTP-доступа, трафик удаленной отладки не может правильно проходить через традиционный брандмауэр WAF или прокси-устройство.  Для параметра *SourceAddressPrefix* вместо этого можно задать значение диапазона IP-адресов машины разработчиков, на которых запущена программа Visual Studio.

    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT RemoteDebuggingVS2012" -Type Inbound -Priority 600 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '4016' -Protocol TCP
    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT RemoteDebuggingVS2013" -Type Inbound -Priority 700 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '4018' -Protocol TCP
    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityRule -Name "RESTRICT RemoteDebuggingVS2015" -Type Inbound -Priority 800 -Action Allow -SourceAddressPrefix '1.2.3.4/32'  -SourcePortRange '*' -DestinationAddressPrefix '*' -DestinationPortRange '4020' -Protocol TCP

## <a name="assigning-a-network-security-group-to-a-subnet"></a>Назначение группы сетевой безопасности для подсети
Группа сетевой безопасности имеет правило безопасности по умолчанию, которое запрещает доступ для любого внешнего трафика.  Результатом объединения описанных выше правил сетевой безопасности и правила безопасности по умолчанию, которое блокирует входящий трафик, является то, что только трафик из исходных диапазонов адресов, связанных с действием *Разрешить* , будет отправляться к приложениям, работающим в среде службы приложений.

После заполнения группы сетевой безопасности правилами безопасности ее необходимо назначить для подсети, содержащей среду службы приложений.  Команда назначения ссылается как на имя виртуальной сети, в которой находится среда службы приложений, так и на имя подсети, в которой была создана среда службы приложений.  

В приведенном ниже примере показана группа сетевой безопасности, назначаемая для подсети и виртуальной сети.

    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Set-AzureNetworkSecurityGroupToSubnet -VirtualNetworkName 'testVNet' -SubnetName 'Subnet-test'

После успешного назначения группы сетевой безопасности (назначение является длительным процессом и может занять несколько минут) только входящий трафик, соответствующий правилам *Разрешить* , успешно дойдет до приложений в среде службы приложений.

Для полноты картины в приведенном ниже примере показано, как удалить группу сетевой безопасности для подсети и тем самым отменить связь между ними.

    Get-AzureNetworkSecurityGroup -Name "testNSGexample" | Remove-AzureNetworkSecurityGroupFromSubnet -VirtualNetworkName 'testVNet' -SubnetName 'Subnet-test'

## <a name="special-considerations-for-explicit-ip-ssl"></a>Специальные рекомендации для SSL на основе явного IP
Если для приложения настроен явный адрес SSL на основе IP (применяемый *только* к ASE, у которых есть общедоступный виртуальный IP-адрес), то вместо IP-адреса по умолчанию среды службы приложений трафик HTTP и HTTPS пропускается в подсеть через другой набор портов, отличный от портов 80 и 443.

Отдельные пары портов, используемых каждым адресом SSL на основе IP, можно найти в пользовательском интерфейсе портала, в колонке со сведениями о среде службы приложений.  Выберите "Все параметры" > "IP-адреса".  В колонке "IP-адреса" показана таблица всех явно заданных адресов SSL на основе IP для среды службы приложений, а также специальные пары портов, используемых для маршрутизации трафика HTTP и HTTPS, связанного с каждым адресом SSL на основе IP.  Эти пары портов необходимо использовать для параметров DestinationPortRange при настройке правил в группе безопасности сети.

Если настроить приложение в ASE для использования SSL на основе IP, то внешним клиентам можно будет не беспокоиться о сопоставлении специальных пар портов, так как это будет выполняться незаметно для них.  Трафик к приложениям будет проходить обычным образом по настроенному адресу SSL на основе IP.  Трансляция в специальную пару портов происходит внутри автоматически во время маршрутизации трафика по последнему участку в подсети, содержащей ASE. 

## <a name="getting-started"></a>Приступая к работе
Сведения о том, как начать работу со средами службы приложений, см. в статье [Введение в среду службы приложений][IntroToAppServiceEnvironment].

Подробные сведения о безопасном подключении приложений к серверным ресурсам из среды службы приложений см. в статье [Безопасное подключение к серверным ресурсам из среды службы приложений][SecurelyConnecttoBackend].

[!INCLUDE [app-service-web-try-app-service](../../../includes/app-service-web-try-app-service.md)]

<!-- LINKS -->
[virtualnetwork]: https://azure.microsoft.com/documentation/articles/virtual-networks-faq/
[HowToCreateAnAppServiceEnvironment]: app-service-web-how-to-create-an-app-service-environment.md
[NetworkSecurityGroups]: https://azure.microsoft.com/documentation/articles/virtual-networks-nsg/
[IntroToAppServiceEnvironment]:  app-service-app-service-environment-intro.md
[SecurelyConnecttoBackend]:  app-service-app-service-environment-securely-connecting-to-backend-resources.md
[NewPortal]:  https://portal.azure.com  

<!-- IMAGES -->


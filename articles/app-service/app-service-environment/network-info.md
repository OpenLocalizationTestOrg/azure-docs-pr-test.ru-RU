---
title: "Рекомендации по работе с сетями при помощи среды службы приложений Azure"
description: "Сведения о трафике в среде ASE, а также установке групп NSG и определяемых пользователем маршрутов при ее помощи"
services: app-service
documentationcenter: na
author: ccompy
manager: stefsch
ms.assetid: 955a4d84-94ca-418d-aa79-b57a5eb8cb85
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/08/2017
ms.author: ccompy
ms.openlocfilehash: 3be0d7a202ff53f5532fd7169a50a04cfaf88832
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="networking-considerations-for-an-app-service-environment"></a><span data-ttu-id="38bac-103">Рекомендации по работе с сетями в среде службы приложений</span><span class="sxs-lookup"><span data-stu-id="38bac-103">Networking considerations for an App Service environment</span></span> #

## <a name="overview"></a><span data-ttu-id="38bac-104">Обзор</span><span class="sxs-lookup"><span data-stu-id="38bac-104">Overview</span></span> ##

 <span data-ttu-id="38bac-105">[Среда службы приложений][Intro] — это развернутая служба приложений Azure в подсети виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="38bac-105">Azure [App Service Environment][Intro] is a deployment of Azure App Service into a subnet in your Azure virtual network (VNet).</span></span> <span data-ttu-id="38bac-106">Есть два типа развертывания для среды службы приложений (ASE):</span><span class="sxs-lookup"><span data-stu-id="38bac-106">There are two deployment types for an App Service environment (ASE):</span></span>

- <span data-ttu-id="38bac-107">**Внешняя ASE** — предоставляет приложения, размещенные в ASE, по доступному в Интернете IP-адресу.</span><span class="sxs-lookup"><span data-stu-id="38bac-107">**External ASE**: Exposes the ASE-hosted apps on an internet-accessible IP address.</span></span> <span data-ttu-id="38bac-108">Дополнительные сведения см. в разделе о [создании внешней среды ASE][MakeExternalASE].</span><span class="sxs-lookup"><span data-stu-id="38bac-108">For more information, see [Create an External ASE][MakeExternalASE].</span></span>
- <span data-ttu-id="38bac-109">**ASE с ILB** — предоставляет приложения в ASE по IP-адресу в вашей виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="38bac-109">**ILB ASE**: Exposes the ASE-hosted apps on an IP address inside your VNet.</span></span> <span data-ttu-id="38bac-110">Внутренняя конечная точка является внутренним балансировщиком нагрузки (ILB). Поэтому среда называется ASE с ILB.</span><span class="sxs-lookup"><span data-stu-id="38bac-110">The internal endpoint is an internal load balancer (ILB), which is why it's called an ILB ASE.</span></span> <span data-ttu-id="38bac-111">Дополнительные сведения см. в статье о [создании и использовании ILB для ASE][MakeILBASE].</span><span class="sxs-lookup"><span data-stu-id="38bac-111">For more information, see [Create and use an ILB ASE][MakeILBASE].</span></span>

<span data-ttu-id="38bac-112">В настоящее время существует две версии среды службы приложений: ASEv1 и ASEv2.</span><span class="sxs-lookup"><span data-stu-id="38bac-112">There are now two versions of App Service Environment: ASEv1 and ASEv2.</span></span> <span data-ttu-id="38bac-113">Сведения об ASEv1 см. в статье [Введение в среду службы приложения][ASEv1Intro].</span><span class="sxs-lookup"><span data-stu-id="38bac-113">For information on ASEv1, see [Introduction to App Service Environment v1][ASEv1Intro].</span></span> <span data-ttu-id="38bac-114">ASEv1 можно развернуть в классической виртуальной сети или в виртуальной сети Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="38bac-114">ASEv1 can be deployed in a classic or Resource Manager VNet.</span></span> <span data-ttu-id="38bac-115">ASEv2 можно развернуть только в виртуальной сети Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="38bac-115">ASEv2 can only be deployed into a Resource Manager VNet.</span></span>

<span data-ttu-id="38bac-116">Все вызовы из ASE поступают в Интернет через виртуальный IP-адрес виртуальной сети, присвоенный ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-116">All calls from an ASE that go to the internet leave the VNet through a VIP assigned for the ASE.</span></span> <span data-ttu-id="38bac-117">Общедоступным IP-адресом этого виртуального IP-адреса является исходный IP-адрес для всех вызовов из ASE, поступающих в Интернет.</span><span class="sxs-lookup"><span data-stu-id="38bac-117">The public IP of this VIP is then the source IP for all calls from the ASE that go to the internet.</span></span> <span data-ttu-id="38bac-118">Если приложения в вашей среде ASE отправляют вызовы к ресурсам в виртуальной сети или в VPN, то исходный IP-адрес является одним из IP-адресов в подсети, используемой ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-118">If the apps in your ASE make calls to resources in your VNet or across a VPN, the source IP is one of the IPs in the subnet used by your ASE.</span></span> <span data-ttu-id="38bac-119">Среда ASE размещена в виртуальной сети, и ее ресурсы доступны для ASE без дополнительной настройки.</span><span class="sxs-lookup"><span data-stu-id="38bac-119">Because the ASE is within the VNet, it can also access resources within the VNet without any additional configuration.</span></span> <span data-ttu-id="38bac-120">Если виртуальная сеть подключена к локальной сети, то ее ресурсы также доступны для приложений в среде ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-120">If the VNet is connected to your on-premises network, apps in your ASE also have access to resources there.</span></span> <span data-ttu-id="38bac-121">Дополнительно настраивать ASE или приложения не требуется.</span><span class="sxs-lookup"><span data-stu-id="38bac-121">You don't need to configure the ASE or your app any further.</span></span>

![Внешняя среда ASE][1] 

<span data-ttu-id="38bac-123">При использовании внешней ASE общедоступный виртуальный IP-адрес также является конечной точкой, с которой приложения ASE сопоставляют данные для:</span><span class="sxs-lookup"><span data-stu-id="38bac-123">If you have an External ASE, the public VIP is also the endpoint that your ASE apps resolve to for:</span></span>

* <span data-ttu-id="38bac-124">HTTP/S;</span><span class="sxs-lookup"><span data-stu-id="38bac-124">HTTP/S.</span></span> 
* <span data-ttu-id="38bac-125">FTP/S;</span><span class="sxs-lookup"><span data-stu-id="38bac-125">FTP/S.</span></span> 
* <span data-ttu-id="38bac-126">веб-развертывания;</span><span class="sxs-lookup"><span data-stu-id="38bac-126">Web deployment.</span></span>
* <span data-ttu-id="38bac-127">удаленной отладки.</span><span class="sxs-lookup"><span data-stu-id="38bac-127">Remote debugging.</span></span>

![Среда ASE с ILB][2]

<span data-ttu-id="38bac-129">При использовании ASE с ILB конечной точкой для HTTP/S, FTP/S, веб-развертывания и удаленной отладки является IP-адрес ILB.</span><span class="sxs-lookup"><span data-stu-id="38bac-129">If you have an ILB ASE, the IP address of the ILB is the endpoint for HTTP/S, FTP/S, web deployment, and remote debugging.</span></span>

<span data-ttu-id="38bac-130">Стандартные порты доступа для приложения:</span><span class="sxs-lookup"><span data-stu-id="38bac-130">The normal app access ports are:</span></span>

| <span data-ttu-id="38bac-131">Использование</span><span class="sxs-lookup"><span data-stu-id="38bac-131">Use</span></span> | <span data-ttu-id="38bac-132">Из</span><span class="sxs-lookup"><span data-stu-id="38bac-132">From</span></span> | <span data-ttu-id="38bac-133">Кому</span><span class="sxs-lookup"><span data-stu-id="38bac-133">To</span></span> |
|----------|---------|-------------|
|  <span data-ttu-id="38bac-134">HTTP/HTTPS</span><span class="sxs-lookup"><span data-stu-id="38bac-134">HTTP/HTTPS</span></span>  | <span data-ttu-id="38bac-135">Настраивается пользователем</span><span class="sxs-lookup"><span data-stu-id="38bac-135">User configurable</span></span> |  <span data-ttu-id="38bac-136">80, 443</span><span class="sxs-lookup"><span data-stu-id="38bac-136">80, 443</span></span> |
|  <span data-ttu-id="38bac-137">FTP/FTPS</span><span class="sxs-lookup"><span data-stu-id="38bac-137">FTP/FTPS</span></span>    | <span data-ttu-id="38bac-138">Настраивается пользователем</span><span class="sxs-lookup"><span data-stu-id="38bac-138">User configurable</span></span> |  <span data-ttu-id="38bac-139">21, 990, 10001-10020</span><span class="sxs-lookup"><span data-stu-id="38bac-139">21, 990, 10001-10020</span></span> |
|  <span data-ttu-id="38bac-140">Удаленная отладка в Visual Studio</span><span class="sxs-lookup"><span data-stu-id="38bac-140">Visual Studio remote debugging</span></span>  |  <span data-ttu-id="38bac-141">Настраивается пользователем</span><span class="sxs-lookup"><span data-stu-id="38bac-141">User configurable</span></span> |  <span data-ttu-id="38bac-142">4016, 4018, 4020, 4022</span><span class="sxs-lookup"><span data-stu-id="38bac-142">4016, 4018, 4020, 4022</span></span> |

<span data-ttu-id="38bac-143">Эти порты применимы, если используется внешняя среда ASE или ASE с ILB.</span><span class="sxs-lookup"><span data-stu-id="38bac-143">This is true if you're on an External ASE or on an ILB ASE.</span></span> <span data-ttu-id="38bac-144">Во внешней ASE переход к этим портам осуществляется по общедоступному виртуальному IP-адресу.</span><span class="sxs-lookup"><span data-stu-id="38bac-144">If you're on an External ASE, you hit those ports on the public VIP.</span></span> <span data-ttu-id="38bac-145">В среде ASE с ILB переход к этим портам осуществляется в ILB.</span><span class="sxs-lookup"><span data-stu-id="38bac-145">If you're on an ILB ASE, you hit those ports on the ILB.</span></span> <span data-ttu-id="38bac-146">Блокировка порта 443 может повлиять на некоторые возможности, предоставляемые на портале.</span><span class="sxs-lookup"><span data-stu-id="38bac-146">If you lock down port 443, there can be an effect on some features exposed in the portal.</span></span> <span data-ttu-id="38bac-147">Дополнительные сведения см. в разделе [Зависимости портала](#portaldep).</span><span class="sxs-lookup"><span data-stu-id="38bac-147">For more information, see [Portal dependencies](#portaldep).</span></span>

## <a name="ase-dependencies"></a><span data-ttu-id="38bac-148">Зависимости ASE</span><span class="sxs-lookup"><span data-stu-id="38bac-148">ASE dependencies</span></span> ##

<span data-ttu-id="38bac-149">Зависимости ASE для входящего трафика:</span><span class="sxs-lookup"><span data-stu-id="38bac-149">An ASE inbound access dependency is:</span></span>

| <span data-ttu-id="38bac-150">Использование</span><span class="sxs-lookup"><span data-stu-id="38bac-150">Use</span></span> | <span data-ttu-id="38bac-151">Из</span><span class="sxs-lookup"><span data-stu-id="38bac-151">From</span></span> | <span data-ttu-id="38bac-152">Кому</span><span class="sxs-lookup"><span data-stu-id="38bac-152">To</span></span> |
|-----|------|----|
| <span data-ttu-id="38bac-153">управления</span><span class="sxs-lookup"><span data-stu-id="38bac-153">Management</span></span> | <span data-ttu-id="38bac-154">Адреса управления службой приложений</span><span class="sxs-lookup"><span data-stu-id="38bac-154">App Service management addresses</span></span> | <span data-ttu-id="38bac-155">Подсеть ASE: 454, 455</span><span class="sxs-lookup"><span data-stu-id="38bac-155">ASE subnet: 454, 455</span></span> |
|  <span data-ttu-id="38bac-156">Внутренний обмен данными ASE</span><span class="sxs-lookup"><span data-stu-id="38bac-156">ASE internal communication</span></span> | <span data-ttu-id="38bac-157">Подсеть ASE: все порты</span><span class="sxs-lookup"><span data-stu-id="38bac-157">ASE subnet: All ports</span></span> | <span data-ttu-id="38bac-158">Подсеть ASE: все порты</span><span class="sxs-lookup"><span data-stu-id="38bac-158">ASE subnet: All ports</span></span>
|  <span data-ttu-id="38bac-159">Разрешение входящего трафика Azure Load Balancer</span><span class="sxs-lookup"><span data-stu-id="38bac-159">Allow Azure load balancer inbound</span></span> | <span data-ttu-id="38bac-160">Azure Load Balancer</span><span class="sxs-lookup"><span data-stu-id="38bac-160">Azure load balancer</span></span> | <span data-ttu-id="38bac-161">Подсеть ASE: все порты</span><span class="sxs-lookup"><span data-stu-id="38bac-161">ASE subnet: All ports</span></span>
|  <span data-ttu-id="38bac-162">IP-адреса, присвоенные приложению</span><span class="sxs-lookup"><span data-stu-id="38bac-162">App assigned IP addresses</span></span> | <span data-ttu-id="38bac-163">Адреса, присвоенные приложению</span><span class="sxs-lookup"><span data-stu-id="38bac-163">App assigned addresses</span></span> | <span data-ttu-id="38bac-164">Подсеть ASE: все порты</span><span class="sxs-lookup"><span data-stu-id="38bac-164">ASE subnet: All ports</span></span>

<span data-ttu-id="38bac-165">Помимо системы мониторинга, входящий трафик обеспечивает контроль и управление ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-165">The inbound traffic provides command and control of the ASE in addition to system monitoring.</span></span> <span data-ttu-id="38bac-166">Исходные IP-адреса для этого трафика перечислены в документе [Адреса управления среды службы приложений][ASEManagement].</span><span class="sxs-lookup"><span data-stu-id="38bac-166">The source IPs for this traffic are listed in the [ASE Management addresses][ASEManagement] document.</span></span> <span data-ttu-id="38bac-167">В конфигурации безопасности сети необходимо разрешить доступ со всех IP-адресов через порты 454 и 455.</span><span class="sxs-lookup"><span data-stu-id="38bac-167">The network security configuration needs to allow access from all IPs on ports 454 and 455.</span></span>

<span data-ttu-id="38bac-168">В подсети ASE существует много портов, используемых для внутреннего взаимодействия компонентов, которые можно изменять.</span><span class="sxs-lookup"><span data-stu-id="38bac-168">Within the ASE subnet there are many ports used for internal component communication and they can change.</span></span>  <span data-ttu-id="38bac-169">Для этого необходимо, чтобы все порты в подсети ASE были доступны из нее.</span><span class="sxs-lookup"><span data-stu-id="38bac-169">This requires all of the ports in the ASE subnet to be accessible from the ASE subnet.</span></span> 

<span data-ttu-id="38bac-170">Для взаимодействия между балансировщиком нагрузки Azure и подсетью ASE необходимо открыть как минимум порты 454, 455 и 16001.</span><span class="sxs-lookup"><span data-stu-id="38bac-170">For the communication between the Azure load balancer and the ASE subnet the minimum ports that need to be open are 454, 455 and 16001.</span></span> <span data-ttu-id="38bac-171">Порт 16001 используется для трафика проверки активности между балансировщиком нагрузки и ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-171">The 16001 port is used for keep alive traffic between the load balancer and the ASE.</span></span> <span data-ttu-id="38bac-172">Используя ASE с ILB, можно ограничить трафик портами 454, 455 и 16001.</span><span class="sxs-lookup"><span data-stu-id="38bac-172">If you are using an ILB ASE then you can lock traffic down to just the 454, 455, 16001 ports.</span></span>  <span data-ttu-id="38bac-173">При использовании внешней среды ASE необходимо учесть обычные порты доступа к приложениям.</span><span class="sxs-lookup"><span data-stu-id="38bac-173">If you are using an External ASE then you need to take into account the normal app access ports.</span></span>  <span data-ttu-id="38bac-174">Если вы используете адреса, присвоенные приложению, необходимо открыть его для всех портов.</span><span class="sxs-lookup"><span data-stu-id="38bac-174">If you are using app assigned addresses you need to open it to all ports.</span></span>  <span data-ttu-id="38bac-175">Если адрес присваивается определенному приложению, балансировщик нагрузки будет заранее использовать неизвестные порты для отправки трафика HTTP и HTTPS в ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-175">When an address is assigned to a specific app, then the load balancer will use ports that are not known of in advance to send HTTP and HTTPS traffic to the ASE.</span></span>

<span data-ttu-id="38bac-176">Если вы используете IP-адреса, присвоенные приложению, необходимо разрешить передачу трафика с этих адресов в подсеть ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-176">If you are using app assigned IP addresses you need to allow traffic from the IPs assigned to your apps to the ASE subnet.</span></span>

<span data-ttu-id="38bac-177">Что касается доступа исходящего трафика, среда ASE зависит от различных внешних систем.</span><span class="sxs-lookup"><span data-stu-id="38bac-177">For outbound access, an ASE depends on multiple external systems.</span></span> <span data-ttu-id="38bac-178">Эти зависимости системы определяются при помощи DNS-имен и не сопоставляются с фиксированным набором IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="38bac-178">Those system dependencies are defined with DNS names and don't map to a fixed set of IP addresses.</span></span> <span data-ttu-id="38bac-179">Среде ASE требуется доступ исходящего трафика из подсети ASE для всех внешних IP-адресов через различные порты.</span><span class="sxs-lookup"><span data-stu-id="38bac-179">Thus, the ASE requires outbound access from the ASE subnet to all external IPs across a variety of ports.</span></span> <span data-ttu-id="38bac-180">Зависимости ASE для исходящего трафика:</span><span class="sxs-lookup"><span data-stu-id="38bac-180">An ASE has the following outbound dependencies:</span></span>

| <span data-ttu-id="38bac-181">Использование</span><span class="sxs-lookup"><span data-stu-id="38bac-181">Use</span></span> | <span data-ttu-id="38bac-182">Из</span><span class="sxs-lookup"><span data-stu-id="38bac-182">From</span></span> | <span data-ttu-id="38bac-183">Кому</span><span class="sxs-lookup"><span data-stu-id="38bac-183">To</span></span> |
|-----|------|----|
| <span data-ttu-id="38bac-184">Хранилище Azure</span><span class="sxs-lookup"><span data-stu-id="38bac-184">Azure Storage</span></span> | <span data-ttu-id="38bac-185">Подсеть ASE</span><span class="sxs-lookup"><span data-stu-id="38bac-185">ASE subnet</span></span> | <span data-ttu-id="38bac-186">table.core.windows.net, blob.core.windows.net, queue.core.windows.net, file.core.windows.net: 80, 443, 445 (445 необходим только для ASEv1)</span><span class="sxs-lookup"><span data-stu-id="38bac-186">table.core.windows.net, blob.core.windows.net, queue.core.windows.net, file.core.windows.net: 80, 443, 445 (445 is only needed for ASEv1.)</span></span> |
| <span data-ttu-id="38bac-187">База данных SQL Azure</span><span class="sxs-lookup"><span data-stu-id="38bac-187">Azure SQL Database</span></span> | <span data-ttu-id="38bac-188">Подсеть ASE</span><span class="sxs-lookup"><span data-stu-id="38bac-188">ASE subnet</span></span> | <span data-ttu-id="38bac-189">database.windows.net: 1433, 11000-11999, 14000-14999 (дополнительные сведения см. в статье об [использовании портов Базы данных SQL версии 12](../../sql-database/sql-database-develop-direct-route-ports-adonet-v12.md))</span><span class="sxs-lookup"><span data-stu-id="38bac-189">database.windows.net: 1433, 11000-11999, 14000-14999 (For more information, see [SQL Database V12 port usage](../../sql-database/sql-database-develop-direct-route-ports-adonet-v12.md).)</span></span>|
| <span data-ttu-id="38bac-190">Управление Azure</span><span class="sxs-lookup"><span data-stu-id="38bac-190">Azure management</span></span> | <span data-ttu-id="38bac-191">Подсеть ASE</span><span class="sxs-lookup"><span data-stu-id="38bac-191">ASE subnet</span></span> | <span data-ttu-id="38bac-192">management.core.windows.net, management.azure.com: 443</span><span class="sxs-lookup"><span data-stu-id="38bac-192">management.core.windows.net, management.azure.com: 443</span></span> 
| <span data-ttu-id="38bac-193">Проверка сертификатов SSL</span><span class="sxs-lookup"><span data-stu-id="38bac-193">SSL certificate verification</span></span> |  <span data-ttu-id="38bac-194">Подсеть ASE</span><span class="sxs-lookup"><span data-stu-id="38bac-194">ASE subnet</span></span>            |  <span data-ttu-id="38bac-195">ocsp.msocsp.com, mscrl.microsoft.com, crl.microsoft.com: 443</span><span class="sxs-lookup"><span data-stu-id="38bac-195">ocsp.msocsp.com, mscrl.microsoft.com, crl.microsoft.com: 443</span></span>
| <span data-ttu-id="38bac-196">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="38bac-196">Azure Active Directory</span></span>        | <span data-ttu-id="38bac-197">Подсеть ASE</span><span class="sxs-lookup"><span data-stu-id="38bac-197">ASE subnet</span></span>            |  <span data-ttu-id="38bac-198">Интернет: 443</span><span class="sxs-lookup"><span data-stu-id="38bac-198">Internet: 443</span></span>
| <span data-ttu-id="38bac-199">Управление службой приложений</span><span class="sxs-lookup"><span data-stu-id="38bac-199">App Service management</span></span>        | <span data-ttu-id="38bac-200">Подсеть ASE</span><span class="sxs-lookup"><span data-stu-id="38bac-200">ASE subnet</span></span>            |  <span data-ttu-id="38bac-201">Интернет: 443</span><span class="sxs-lookup"><span data-stu-id="38bac-201">Internet: 443</span></span>
| <span data-ttu-id="38bac-202">Azure DNS</span><span class="sxs-lookup"><span data-stu-id="38bac-202">Azure DNS</span></span>                     | <span data-ttu-id="38bac-203">Подсеть ASE</span><span class="sxs-lookup"><span data-stu-id="38bac-203">ASE subnet</span></span>            |  <span data-ttu-id="38bac-204">Интернет: 53</span><span class="sxs-lookup"><span data-stu-id="38bac-204">Internet: 53</span></span>
| <span data-ttu-id="38bac-205">Внутренний обмен данными ASE</span><span class="sxs-lookup"><span data-stu-id="38bac-205">ASE internal communication</span></span>    | <span data-ttu-id="38bac-206">Подсеть ASE: все порты</span><span class="sxs-lookup"><span data-stu-id="38bac-206">ASE subnet: All ports</span></span> |  <span data-ttu-id="38bac-207">Подсеть ASE: все порты</span><span class="sxs-lookup"><span data-stu-id="38bac-207">ASE subnet: All ports</span></span>

<span data-ttu-id="38bac-208">Если у ASE нет доступа к этим зависимостям, среда прекращает работу.</span><span class="sxs-lookup"><span data-stu-id="38bac-208">If the ASE loses access to these dependencies, it stops working.</span></span> <span data-ttu-id="38bac-209">Если это происходит достаточно долго, ASE переходит в состояние приостановки.</span><span class="sxs-lookup"><span data-stu-id="38bac-209">When that happens long enough, the ASE is suspended.</span></span>

### <a name="customer-dns"></a><span data-ttu-id="38bac-210">DNS пользователя</span><span class="sxs-lookup"><span data-stu-id="38bac-210">Customer DNS</span></span> ###

<span data-ttu-id="38bac-211">Если в виртуальной сети настроен определенный пользователем DNS-сервер, то она используется для рабочих нагрузок клиента.</span><span class="sxs-lookup"><span data-stu-id="38bac-211">If the VNet is configured with a customer-defined DNS server, the tenant workloads use it.</span></span> <span data-ttu-id="38bac-212">ASE по-прежнему необходим обмен данными со службой DNS Azure в целях управления.</span><span class="sxs-lookup"><span data-stu-id="38bac-212">The ASE still needs to communicate with Azure DNS for management purposes.</span></span> 

<span data-ttu-id="38bac-213">Если виртуальная сеть настроена с помощью DNS пользователя на другом конце VPN, то DNS-сервер должен быть доступен из подсети, в которой размещена ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-213">If the VNet is configured with a customer DNS on the other side of a VPN, the DNS server must be reachable from the subnet that contains the ASE.</span></span>

<a name="portaldep"></a>

## <a name="portal-dependencies"></a><span data-ttu-id="38bac-214">Зависимости портала</span><span class="sxs-lookup"><span data-stu-id="38bac-214">Portal dependencies</span></span> ##

<span data-ttu-id="38bac-215">Помимо функциональных зависимостей ASE есть несколько дополнительных элементов, относящихся к интерфейсу портала.</span><span class="sxs-lookup"><span data-stu-id="38bac-215">In addition to the ASE functional dependencies, there are a few extra items related to the portal experience.</span></span> <span data-ttu-id="38bac-216">Некоторые возможности на портале Azure зависят от прямого доступа к _сайту диспетчера служб_.</span><span class="sxs-lookup"><span data-stu-id="38bac-216">Some of the capabilities in the Azure portal depend on direct access to _SCM site_.</span></span> <span data-ttu-id="38bac-217">Для каждого приложения в службе приложений Azure предусмотрено два URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="38bac-217">For every app in Azure App Service, there are two URLs.</span></span> <span data-ttu-id="38bac-218">Первый URL-адрес предназначен для доступа к вашему приложению.</span><span class="sxs-lookup"><span data-stu-id="38bac-218">The first URL is to access your app.</span></span> <span data-ttu-id="38bac-219">Второй URL-адрес предназначен для доступа к сайту диспетчера служб, который также называется _Консоль Kudu_.</span><span class="sxs-lookup"><span data-stu-id="38bac-219">The second URL is to access the SCM site, which is also called the _Kudu console_.</span></span> <span data-ttu-id="38bac-220">Ниже перечислены компоненты, использующие сайт диспетчера служб.</span><span class="sxs-lookup"><span data-stu-id="38bac-220">Features that use the SCM site include:</span></span>

-   <span data-ttu-id="38bac-221">Веб-задания</span><span class="sxs-lookup"><span data-stu-id="38bac-221">Web jobs</span></span>
-   <span data-ttu-id="38bac-222">Функции</span><span class="sxs-lookup"><span data-stu-id="38bac-222">Functions</span></span>
-   <span data-ttu-id="38bac-223">Потоковая передача журналов</span><span class="sxs-lookup"><span data-stu-id="38bac-223">Log streaming</span></span>
-   <span data-ttu-id="38bac-224">Kudu</span><span class="sxs-lookup"><span data-stu-id="38bac-224">Kudu</span></span>
-   <span data-ttu-id="38bac-225">расширения.</span><span class="sxs-lookup"><span data-stu-id="38bac-225">Extensions</span></span>
-   <span data-ttu-id="38bac-226">Обозреватель процессов</span><span class="sxs-lookup"><span data-stu-id="38bac-226">Process Explorer</span></span>
-   <span data-ttu-id="38bac-227">Консоль</span><span class="sxs-lookup"><span data-stu-id="38bac-227">Console</span></span>

<span data-ttu-id="38bac-228">При использовании среды ASE с ILB сайт диспетчера служб недоступен через Интернет вне виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="38bac-228">When you use an ILB ASE, the SCM site isn't internet accessible from outside the VNet.</span></span> <span data-ttu-id="38bac-229">Если приложение размещается на ILB ASE, некоторые возможности не будут работать с портала.</span><span class="sxs-lookup"><span data-stu-id="38bac-229">When your app is hosted on an ILB ASE, some capabilities will not work from the portal.</span></span>  

<span data-ttu-id="38bac-230">Многие возможности, зависящих от доступа к сайту диспетчера служб, доступны непосредственно в консоли Kudu.</span><span class="sxs-lookup"><span data-stu-id="38bac-230">Many of those capabilities that depend upon the SCM site are also available directly in the Kudu console.</span></span> <span data-ttu-id="38bac-231">Можно подключиться к ней напрямую, не используя портал.</span><span class="sxs-lookup"><span data-stu-id="38bac-231">You can connect to it directly rather than by using the portal.</span></span> <span data-ttu-id="38bac-232">Если приложение размещено в ASE с ILB, то войдите в систему с помощью учетных данных для публикации.</span><span class="sxs-lookup"><span data-stu-id="38bac-232">If your app is hosted in an ILB ASE, use your publishing credentials to sign in.</span></span> <span data-ttu-id="38bac-233">Формат URL-адреса для доступа к сайту диспетчера служб из приложения, размещенного в ASE с ILB:</span><span class="sxs-lookup"><span data-stu-id="38bac-233">The URL to access the SCM site of an app hosted in an ILB ASE has the following format:</span></span> 

```
<appname>.scm.<domain name the ILB ASE was created with> 
```

<span data-ttu-id="38bac-234">Если доменное имя вашей среды ASE с ILB — *contoso.net*, а имя приложения — *testapp*, то приложение доступно по адресу *testapp.contoso.net*.</span><span class="sxs-lookup"><span data-stu-id="38bac-234">If your ILB ASE is the domain name *contoso.net* and your app name is *testapp*, the app is reached at *testapp.contoso.net*.</span></span> <span data-ttu-id="38bac-235">Связанный с ним сайт диспетчера служб доступен по адресу *testapp.scm.contoso.net*.</span><span class="sxs-lookup"><span data-stu-id="38bac-235">The SCM site that goes with it is reached at *testapp.scm.contoso.net*.</span></span>

### <a name="functions-and-web-jobs"></a><span data-ttu-id="38bac-236">Служба "Функции" и "Веб-задания"</span><span class="sxs-lookup"><span data-stu-id="38bac-236">Functions and Web jobs</span></span> ###

<span data-ttu-id="38bac-237">Службы "Функции" и "Веб-задания" зависят от сайта SCM, но поддерживаются для использования на портале, если браузер может подключиться к сайту SCM, даже если приложения находятся в среде ASE с ILB.</span><span class="sxs-lookup"><span data-stu-id="38bac-237">Both Functions and Web jobs depend on the SCM site but are supported for use in the portal, even if your apps are in an ILB ASE, so long as your browser can reach the SCM site.</span></span>  <span data-ttu-id="38bac-238">При использовании самозаверяющего сертификата со средой ASE с ILB необходимо, чтобы браузер доверял этому сертификату.</span><span class="sxs-lookup"><span data-stu-id="38bac-238">If you are using a self-signed certificate with your ILB ASE, you will need to enable your browser to trust that certificate.</span></span>  <span data-ttu-id="38bac-239">Для IE и Edge это означает, что сертификат должен находиться в доверенном хранилище компьютера.</span><span class="sxs-lookup"><span data-stu-id="38bac-239">For IE and Edge that means the certificate has to be in the computer trust store.</span></span>  <span data-ttu-id="38bac-240">Если вы используете Chrome, то это означает, что вы приняли сертификат в браузере ранее, предположительно непосредственно на сайте SCM.</span><span class="sxs-lookup"><span data-stu-id="38bac-240">If you are using Chrome then that means you accepted the certificate in the browser earlier by presumably hitting the scm site directly.</span></span>  <span data-ttu-id="38bac-241">Лучше всего использовать коммерческий сертификат, который находится в цепочке доверия браузера.</span><span class="sxs-lookup"><span data-stu-id="38bac-241">The best solution is to use a commercial certificate that is in the browser chain of trust.</span></span>  

## <a name="ase-ip-addresses"></a><span data-ttu-id="38bac-242">IP-адреса ASE</span><span class="sxs-lookup"><span data-stu-id="38bac-242">ASE IP addresses</span></span> ##

<span data-ttu-id="38bac-243">В среде ASE есть несколько IP-адресов, на которые следует обратить внимание.</span><span class="sxs-lookup"><span data-stu-id="38bac-243">An ASE has a few IP addresses to be aware of.</span></span> <span data-ttu-id="38bac-244">К ним относятся:</span><span class="sxs-lookup"><span data-stu-id="38bac-244">They are:</span></span>

- <span data-ttu-id="38bac-245">**Общедоступный IP-адрес для входящего трафика**. Используется для трафика приложений во внешней среде ASE и трафика управления в обоих средах (внешняя ASE и ASE с ILB).</span><span class="sxs-lookup"><span data-stu-id="38bac-245">**Public inbound IP address**: Used for app traffic in an External ASE, and management traffic in both an External ASE and an ILB ASE.</span></span>
- <span data-ttu-id="38bac-246">**Общедоступный IP-адрес для исходящего трафика**. Используется в качестве IP-адреса для исходящих подключений ASE из виртуальной сети, которым не назначен маршрут VPN.</span><span class="sxs-lookup"><span data-stu-id="38bac-246">**Outbound public IP**: Used as the "from" IP for outbound connections from the ASE that leave the VNet, which aren't routed down a VPN.</span></span>
- <span data-ttu-id="38bac-247">**IP-адрес ILB**. Применяется при использовании среды ASE с ILB.</span><span class="sxs-lookup"><span data-stu-id="38bac-247">**ILB IP address**: If you use an ILB ASE.</span></span>
- <span data-ttu-id="38bac-248">**Присвоенные приложению адреса с SSL на основе IP**. Могут применяться, только если используется внешняя ASE и настроен SSL на основе IP-адреса.</span><span class="sxs-lookup"><span data-stu-id="38bac-248">**App-assigned IP-based SSL addresses**: Only possible with an External ASE and when IP-based SSL is configured.</span></span>

<span data-ttu-id="38bac-249">Все эти IP-адреса можно просмотреть в ASEv2 на портале Azure в пользовательском интерфейсе ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-249">All these IP addresses are easily visible in an ASEv2 in the Azure portal from the ASE UI.</span></span> <span data-ttu-id="38bac-250">Если вы используете ASE с ILB, то отображается IP-адрес для ILB.</span><span class="sxs-lookup"><span data-stu-id="38bac-250">If you have an ILB ASE, the IP for the ILB is listed.</span></span>

![IP-адреса;][3]

### <a name="app-assigned-ip-addresses"></a><span data-ttu-id="38bac-252">Присвоенные приложению IP-адреса</span><span class="sxs-lookup"><span data-stu-id="38bac-252">App-assigned IP addresses</span></span> ###

<span data-ttu-id="38bac-253">Внешняя ASE позволяет назначать IP-адреса отдельным приложениям.</span><span class="sxs-lookup"><span data-stu-id="38bac-253">With an External ASE, you can assign IP addresses to individual apps.</span></span> <span data-ttu-id="38bac-254">В ASE с ILB такая возможность не предусмотрена.</span><span class="sxs-lookup"><span data-stu-id="38bac-254">You can't do that with an ILB ASE.</span></span> <span data-ttu-id="38bac-255">Дополнительные сведения о настройке приложения для получения собственного IP-адреса см. в статье [Привязывание существующего настраиваемого SSL-сертификата к веб-приложениям Azure](../../app-service-web/app-service-web-tutorial-custom-ssl.md).</span><span class="sxs-lookup"><span data-stu-id="38bac-255">For more information on how to configure your app to have its own IP address, see [Bind an existing custom SSL certificate to Azure web apps](../../app-service-web/app-service-web-tutorial-custom-ssl.md).</span></span>

<span data-ttu-id="38bac-256">Если у приложения есть собственный адрес с SSL на основе IP, ASE резервирует два порта для сопоставления с этим IP-адресом.</span><span class="sxs-lookup"><span data-stu-id="38bac-256">When an app has its own IP-based SSL address, the ASE reserves two ports to map to that IP address.</span></span> <span data-ttu-id="38bac-257">Один порт используется для трафика HTTP, а другой — для трафика HTTPS.</span><span class="sxs-lookup"><span data-stu-id="38bac-257">One port is for HTTP traffic, and the other port is for HTTPS.</span></span> <span data-ttu-id="38bac-258">Эти порты указаны в разделе IP-адресов пользовательского интерфейса ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-258">Those ports are listed in the ASE UI in the IP addresses section.</span></span> <span data-ttu-id="38bac-259">Порты должны быть открыты для трафика, поступающего с виртуального IP-адреса, иначе приложения будут недоступны.</span><span class="sxs-lookup"><span data-stu-id="38bac-259">Traffic must be able to reach those ports from the VIP or the apps are inaccessible.</span></span> <span data-ttu-id="38bac-260">Это требование важно помнить при настройке групп безопасности сети (NSG).</span><span class="sxs-lookup"><span data-stu-id="38bac-260">This requirement is important to remember when you configure Network Security Groups (NSGs).</span></span>

## <a name="network-security-groups"></a><span data-ttu-id="38bac-261">группы сетевой безопасности;</span><span class="sxs-lookup"><span data-stu-id="38bac-261">Network Security Groups</span></span> ##

<span data-ttu-id="38bac-262">[Группы безопасности сети][NSGs] дают возможность управлять сетевым доступом в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="38bac-262">[Network Security Groups][NSGs] provide the ability to control network access within a VNet.</span></span> <span data-ttu-id="38bac-263">При использовании портала действует неявное правило всеобщего запрета с самым низким приоритетом.</span><span class="sxs-lookup"><span data-stu-id="38bac-263">When you use the portal, there's an implicit deny rule at the lowest priority to deny everything.</span></span> <span data-ttu-id="38bac-264">Поэтому необходимо создать правила разрешения.</span><span class="sxs-lookup"><span data-stu-id="38bac-264">What you build are your allow rules.</span></span>

<span data-ttu-id="38bac-265">В среде ASE нет доступа к виртуальным машинам, используемым для ее размещения.</span><span class="sxs-lookup"><span data-stu-id="38bac-265">In an ASE, you don't have access to the VMs used to host the ASE itself.</span></span> <span data-ttu-id="38bac-266">Они входят в подписку, управляемую корпорацией Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="38bac-266">They're in a Microsoft-managed subscription.</span></span> <span data-ttu-id="38bac-267">Чтобы ограничить доступ к приложениям в ASE, задайте в подсети ASE группы безопасности сети.</span><span class="sxs-lookup"><span data-stu-id="38bac-267">If you want to restrict access to the apps on the ASE, set NSGs on the ASE subnet.</span></span> <span data-ttu-id="38bac-268">При этом обратите особое внимание на зависимости ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-268">In doing so, pay careful attention to the ASE dependencies.</span></span> <span data-ttu-id="38bac-269">Блокировка любой зависимости останавливает работу ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-269">If you block any dependencies, the ASE stops working.</span></span>

<span data-ttu-id="38bac-270">Группы NSG можно настроить на портале Azure или с помощью PowerShell.</span><span class="sxs-lookup"><span data-stu-id="38bac-270">NSGs can be configured through the Azure portal or via PowerShell.</span></span> <span data-ttu-id="38bac-271">Здесь описана настройка на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="38bac-271">The information here shows the Azure portal.</span></span> <span data-ttu-id="38bac-272">Группы NSG создаются и управляются на портале в разделе **Сеть** как ресурс верхнего уровня.</span><span class="sxs-lookup"><span data-stu-id="38bac-272">You create and manage NSGs in the portal as a top-level resource under **Networking**.</span></span>

<span data-ttu-id="38bac-273">Когда учтены требования к входящему и исходящему трафику, группы безопасности сети должны быть оформлены, как показано в этом примере.</span><span class="sxs-lookup"><span data-stu-id="38bac-273">When the inbound and outbound requirements are taken into account, the NSGs should look similar to the NSGs shown in this example.</span></span> <span data-ttu-id="38bac-274">Диапазон адресов в виртуальной сети — _192.168.250.0/16_, а диапазон адресов в подсети с ASE — _192.168.251.128/25_.</span><span class="sxs-lookup"><span data-stu-id="38bac-274">The VNet address range is _192.168.250.0/16_, and the subnet that the ASE is in is _192.168.251.128/25_.</span></span>

<span data-ttu-id="38bac-275">Первые два требования к входящему трафику для работы ASE показаны в верхней части примера.</span><span class="sxs-lookup"><span data-stu-id="38bac-275">The first two inbound requirements for the ASE to function are shown at the top of the list in this example.</span></span> <span data-ttu-id="38bac-276">Они отвечают за управление и внутренний обмен данными в ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-276">They enable ASE management and allow the ASE to communicate with itself.</span></span> <span data-ttu-id="38bac-277">Другие записи можно настроить во всех клиентах и использовать для управления сетевым доступом к приложениям в ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-277">The other entries are all tenant configurable and can govern network access to the ASE-hosted applications.</span></span> 

![Правила безопасности для входящего трафика][4]

<span data-ttu-id="38bac-279">Правило по умолчанию активирует обмен данными между IP-адресами в виртуальной сети и подсетью ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-279">A default rule enables the IPs in the VNet to talk to the ASE subnet.</span></span> <span data-ttu-id="38bac-280">Другое правило по умолчанию позволяет балансировщику нагрузки, который также называют общедоступным виртуальным IP-адресом, обмениваться данными с ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-280">Another default rule enables the load balancer, also known as the public VIP, to communicate with the ASE.</span></span> <span data-ttu-id="38bac-281">Чтобы просмотреть правила по умолчанию, щелкните **Правила по умолчанию** рядом со значком **Добавить**.</span><span class="sxs-lookup"><span data-stu-id="38bac-281">To see the default rules, select **Default rules** next to the **Add** icon.</span></span> <span data-ttu-id="38bac-282">Если поместить правило всеобщего запрета после приведенных правил группы безопасности сети, то это будет препятствовать трафику между виртуальным IP-адресом и ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-282">If you put a deny everything else rule after the NSG rules shown, you prevent traffic between the VIP and the ASE.</span></span> <span data-ttu-id="38bac-283">Чтобы запретить трафик, поступающий из виртуальной сети, добавьте собственное правило для разрешения входящего трафика.</span><span class="sxs-lookup"><span data-stu-id="38bac-283">To prevent traffic coming from inside the VNet, add your own rule to allow inbound.</span></span> <span data-ttu-id="38bac-284">Укажите для источника значение AzureLoadBalancer, для назначения — значение **Any** (Любое), а для диапазона портов — **\***.</span><span class="sxs-lookup"><span data-stu-id="38bac-284">Use a source equal to AzureLoadBalancer with a destination of **Any** and a port range of **\***.</span></span> <span data-ttu-id="38bac-285">Поскольку правило группы безопасности сети применяется к подсети ASE, указывать конкретное назначение не требуется.</span><span class="sxs-lookup"><span data-stu-id="38bac-285">Because the NSG rule is applied to the ASE subnet, you don't need to be specific in the destination.</span></span>

<span data-ttu-id="38bac-286">Если приложению присвоен IP-адрес, то убедитесь, что порты остаются открытыми.</span><span class="sxs-lookup"><span data-stu-id="38bac-286">If you assigned an IP address to your app, make sure you keep the ports open.</span></span> <span data-ttu-id="38bac-287">Чтобы просмотреть порты, последовательно выберите **Среда службы приложений** > **IP-адреса**.</span><span class="sxs-lookup"><span data-stu-id="38bac-287">To see the ports, select **App Service Environment** > **IP addresses**.</span></span>  

<span data-ttu-id="38bac-288">Требуются все элементы, показанные в следующих правилах для исходящего трафика, за исключением последнего элемента.</span><span class="sxs-lookup"><span data-stu-id="38bac-288">All the items shown in the following outbound rules are needed, except for the last item.</span></span> <span data-ttu-id="38bac-289">Они обеспечивают доступ к сети для зависимостей ASE, которые упоминались ранее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="38bac-289">They enable network access to the ASE dependencies that were noted earlier in this article.</span></span> <span data-ttu-id="38bac-290">При блокировке любого из этих элементов ASE прекратит работу.</span><span class="sxs-lookup"><span data-stu-id="38bac-290">If you block any of them, your ASE stops working.</span></span> <span data-ttu-id="38bac-291">Последний элемент в списке позволяет среде ASE обмениваться данными с другими ресурсами в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="38bac-291">The last item in the list enables your ASE to communicate with other resources in your VNet.</span></span>

![Правила безопасности для исходящего трафика][5]

<span data-ttu-id="38bac-293">Определив группы безопасности сети, присвойте их подсети, в которой размещена ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-293">After your NSGs are defined, assign them to the subnet that your ASE is on.</span></span> <span data-ttu-id="38bac-294">Если вы не помните название виртуальной сети или подсети ASE, можно найти его на портале управления ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-294">If you don’t remember the ASE VNet or subnet, you can see it from the ASE management portal.</span></span> <span data-ttu-id="38bac-295">Чтобы присвоить подсети группу NSG, перейдите к пользовательскому интерфейсу подсети и выберите NSG.</span><span class="sxs-lookup"><span data-stu-id="38bac-295">To assign the NSG to your subnet, go to the subnet UI and select the NSG.</span></span>

## <a name="routes"></a><span data-ttu-id="38bac-296">Маршруты</span><span class="sxs-lookup"><span data-stu-id="38bac-296">Routes</span></span> ##

<span data-ttu-id="38bac-297">При настройке виртуальной сети с помощью Azure ExpressRoute маршрутизация зачастую сопровождается проблемами.</span><span class="sxs-lookup"><span data-stu-id="38bac-297">Routes become problematic most commonly when you configure your VNet with Azure ExpressRoute.</span></span> <span data-ttu-id="38bac-298">В виртуальной сети существует три типа маршрутов:</span><span class="sxs-lookup"><span data-stu-id="38bac-298">There are three types of routes in a VNet:</span></span>

-   <span data-ttu-id="38bac-299">Системные маршруты</span><span class="sxs-lookup"><span data-stu-id="38bac-299">System routes</span></span>
-   <span data-ttu-id="38bac-300">Маршруты BGP</span><span class="sxs-lookup"><span data-stu-id="38bac-300">BGP routes</span></span>
-   <span data-ttu-id="38bac-301">Определяемые пользователем маршруты</span><span class="sxs-lookup"><span data-stu-id="38bac-301">User-defined routes (UDRs)</span></span>

<span data-ttu-id="38bac-302">Маршруты BGP переопределяют системные маршруты.</span><span class="sxs-lookup"><span data-stu-id="38bac-302">BGP routes override system routes.</span></span> <span data-ttu-id="38bac-303">Определяемые пользователем маршруты переопределяют маршруты BGP.</span><span class="sxs-lookup"><span data-stu-id="38bac-303">UDRs override BGP routes.</span></span> <span data-ttu-id="38bac-304">Дополнительные сведения о маршрутах в виртуальных сетях Azure см. в статье [Определяемые пользователем маршруты и IP-пересылка][UDRs].</span><span class="sxs-lookup"><span data-stu-id="38bac-304">For more information about routes in Azure virtual networks, see [User-defined routes overview][UDRs].</span></span>

<span data-ttu-id="38bac-305">База данных SQL Azure, которая используется средой ASE для управления системой, оснащена брандмауэром.</span><span class="sxs-lookup"><span data-stu-id="38bac-305">The Azure SQL database that the ASE uses to manage the system has a firewall.</span></span> <span data-ttu-id="38bac-306">Передача данных должна осуществляться с общедоступного виртуального IP-адреса ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-306">It requires communication to originate from the ASE public VIP.</span></span> <span data-ttu-id="38bac-307">Подключения к базе данных SQL из ASE будут отклонены, если запросы на подключение отправлены по ExpressRoute и с другого IP-адреса.</span><span class="sxs-lookup"><span data-stu-id="38bac-307">Connections to the SQL database from the ASE will be denied if they are sent down the ExpressRoute connection and out another IP address.</span></span>

<span data-ttu-id="38bac-308">Если ответы на входящие запросы управления отправляются по ExpressRoute, то адрес ответа отличается от исходного адреса назначения.</span><span class="sxs-lookup"><span data-stu-id="38bac-308">If replies to incoming management requests are sent down the ExpressRoute, the reply address is different than the original destination.</span></span> <span data-ttu-id="38bac-309">Это несоответствие нарушает связь TCP.</span><span class="sxs-lookup"><span data-stu-id="38bac-309">This mismatch breaks the TCP communication.</span></span>

<span data-ttu-id="38bac-310">Ниже описан самый простой метод, обеспечивающий работу среды ASE, если виртуальная сеть настроена с помощью ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="38bac-310">For your ASE to work while your VNet is configured with an ExpressRoute, the easiest thing to do is:</span></span>

-   <span data-ttu-id="38bac-311">Настройте ExpressRoute для объявления маршрута _0.0.0.0/0_.</span><span class="sxs-lookup"><span data-stu-id="38bac-311">Configure ExpressRoute to advertise _0.0.0.0/0_.</span></span> <span data-ttu-id="38bac-312">Это по умолчанию приведет к принудительному туннелированию всего исходящего трафика в локальную среду.</span><span class="sxs-lookup"><span data-stu-id="38bac-312">By default, it force tunnels all outbound traffic on-premises.</span></span>
-   <span data-ttu-id="38bac-313">Создайте определяемый пользователем маршрут.</span><span class="sxs-lookup"><span data-stu-id="38bac-313">Create a UDR.</span></span> <span data-ttu-id="38bac-314">Примените его к подсети со средой ASE, добавив к адресу префикс _0.0.0.0/0_ и указав для следующего прыжка тип _Интернет_.</span><span class="sxs-lookup"><span data-stu-id="38bac-314">Apply it to the subnet that contains the ASE with an address prefix of _0.0.0.0/0_ and a next hop type of _Internet_.</span></span>

<span data-ttu-id="38bac-315">После этих двух изменений исходящий трафик из подсети ASE в Интернет не будет принудительно направляться по маршруту ExpressRoute, а среда ASE возобновит работу.</span><span class="sxs-lookup"><span data-stu-id="38bac-315">If you make these two changes, internet-destined traffic that originates from the ASE subnet isn't forced down the ExpressRoute and the ASE works.</span></span> 

> [!IMPORTANT]
> <span data-ttu-id="38bac-316">Определяемые пользователем маршруты должны быть достаточно конкретными, чтобы иметь приоритет над всеми маршрутами, объявленными в конфигурации ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="38bac-316">The routes defined in a UDR must be specific enough to take precedence over any routes advertised by the ExpressRoute configuration.</span></span> <span data-ttu-id="38bac-317">В приведенном выше примере используется широкий диапазон адресов 0.0.0.0/0.</span><span class="sxs-lookup"><span data-stu-id="38bac-317">The preceding example uses the broad 0.0.0.0/0 address range.</span></span> <span data-ttu-id="38bac-318">Он может быть случайно заменен объявлениями маршрутов с более узкими диапазонами адресов.</span><span class="sxs-lookup"><span data-stu-id="38bac-318">It can potentially be accidentally overridden by route advertisements that use more specific address ranges.</span></span>
>
> <span data-ttu-id="38bac-319">Среды ASE с конфигурациями ExpressRoute, осуществляющие перекрестное объявление маршрутов из пути общедоступного пиринга в путь частного пиринга, не поддерживаются.</span><span class="sxs-lookup"><span data-stu-id="38bac-319">ASEs aren't supported with ExpressRoute configurations that cross-advertise routes from the public-peering path to the private-peering path.</span></span> <span data-ttu-id="38bac-320">Конфигурации ExpressRoute с настроенным общедоступным пирингом получают объявления маршрутов от корпорации Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="38bac-320">ExpressRoute configurations with public peering configured receive route advertisements from Microsoft.</span></span> <span data-ttu-id="38bac-321">Эти объявления содержат большой набор диапазонов IP-адресов Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="38bac-321">The advertisements contain a large set of Microsoft Azure IP address ranges.</span></span> <span data-ttu-id="38bac-322">Если диапазоны адресов перекрестно объявляются по пути частного пиринга, то все исходящие сетевые пакеты из подсети ASE принудительно туннелируются в локальную сетевую инфраструктуру клиента.</span><span class="sxs-lookup"><span data-stu-id="38bac-322">If the address ranges are cross-advertised on the private-peering path, all outbound network packets from the ASE's subnet are force tunneled to a customer's on-premises network infrastructure.</span></span> <span data-ttu-id="38bac-323">В настоящее время этот сетевой поток не поддерживается в средах ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-323">This network flow is currently not supported with ASEs.</span></span> <span data-ttu-id="38bac-324">Чтобы решить эту проблему, необходимо остановить перекрестное объявление маршрутов между путями общедоступного и частного пиринга.</span><span class="sxs-lookup"><span data-stu-id="38bac-324">One solution to this problem is to stop cross-advertising routes from the public-peering path to the private-peering path.</span></span>

<span data-ttu-id="38bac-325">Чтобы создать определяемый пользователем маршрут, выполните следующие действия:</span><span class="sxs-lookup"><span data-stu-id="38bac-325">To create a UDR, follow these steps:</span></span>

1. <span data-ttu-id="38bac-326">Перейдите на портал Azure.</span><span class="sxs-lookup"><span data-stu-id="38bac-326">Go to the Azure portal.</span></span> <span data-ttu-id="38bac-327">Последовательно выберите **Cети** > **Таблицы маршрутов**.</span><span class="sxs-lookup"><span data-stu-id="38bac-327">Select **Networking** > **Route Tables**.</span></span>

2. <span data-ttu-id="38bac-328">Создайте таблицу маршрутов в том же регионе, где находится виртуальная сеть.</span><span class="sxs-lookup"><span data-stu-id="38bac-328">Create a new route table in the same region as your VNet.</span></span>

3. <span data-ttu-id="38bac-329">В пользовательском интерфейсе таблицы маршрутов последовательно выберите **Маршруты** > **Добавить**.</span><span class="sxs-lookup"><span data-stu-id="38bac-329">From within your route table UI, select **Routes** > **Add**.</span></span>

4. <span data-ttu-id="38bac-330">Задайте для параметра **Тип следующего прыжка** значение **Интернет**, а для параметра **Префикс адреса** — значение **0.0.0.0/0**.</span><span class="sxs-lookup"><span data-stu-id="38bac-330">Set the **Next hop type** to **Internet** and the **Address prefix** to **0.0.0.0/0**.</span></span> <span data-ttu-id="38bac-331">Щелкните **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="38bac-331">Select **Save**.</span></span>

    <span data-ttu-id="38bac-332">Отобразится примерно следующее:</span><span class="sxs-lookup"><span data-stu-id="38bac-332">You then see something like the following:</span></span>

    ![Функциональные маршруты][6]

5. <span data-ttu-id="38bac-334">Создав таблицу маршрутов, перейдите к подсети со средой ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-334">After you create the new route table, go to the subnet that contains your ASE.</span></span> <span data-ttu-id="38bac-335">Выберите свою таблицу маршрутов из списка на портале.</span><span class="sxs-lookup"><span data-stu-id="38bac-335">Select your route table from the list in the portal.</span></span> <span data-ttu-id="38bac-336">После сохранения изменений отобразится список групп безопасности сети и маршрутов, указанных в подсети.</span><span class="sxs-lookup"><span data-stu-id="38bac-336">After you save the change, you should then see the NSGs and routes noted with your subnet.</span></span>

    ![Группы безопасности сети и маршруты][7]

### <a name="deploy-into-existing-azure-virtual-networks-that-are-integrated-with-expressroute"></a><span data-ttu-id="38bac-338">Развертывание в существующих виртуальных сетях Azure, интегрированных с ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="38bac-338">Deploy into existing Azure virtual networks that are integrated with ExpressRoute</span></span> ###

<span data-ttu-id="38bac-339">Чтобы развернуть ASE в виртуальной сети, интегрированной с ExpressRoute, предварительно настройте подсеть, в которой будет развернута среда ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-339">To deploy your ASE into a VNet that's integrated with ExpressRoute, preconfigure the subnet where you want the ASE deployed.</span></span> <span data-ttu-id="38bac-340">Затем выполните развертывание, воспользовавшись шаблоном Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="38bac-340">Then use a Resource Manager template to deploy it.</span></span> <span data-ttu-id="38bac-341">Чтобы создать ASE в виртуальной сети, где уже выполнена настройка ExpressRoute, следуйте инструкциям ниже.</span><span class="sxs-lookup"><span data-stu-id="38bac-341">To create an ASE in a VNet that already has ExpressRoute configured:</span></span>

- <span data-ttu-id="38bac-342">Создайте подсеть для размещения ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-342">Create a subnet to host the ASE.</span></span>

    > [!NOTE]
    > <span data-ttu-id="38bac-343">В подсети должна размещаться исключительно среда ASE.</span><span class="sxs-lookup"><span data-stu-id="38bac-343">Nothing else can be in the subnet but the ASE.</span></span> <span data-ttu-id="38bac-344">Обязательно выберите достаточно большое адресное пространство для будущего расширения.</span><span class="sxs-lookup"><span data-stu-id="38bac-344">Be sure to choose an address space that allows for future growth.</span></span> <span data-ttu-id="38bac-345">Впоследствии этот параметр уже нельзя изменить.</span><span class="sxs-lookup"><span data-stu-id="38bac-345">You can't change this setting later.</span></span> <span data-ttu-id="38bac-346">Рекомендуемый размер — `/25` с 128 адресами.</span><span class="sxs-lookup"><span data-stu-id="38bac-346">We recommend a size of `/25` with 128 addresses.</span></span>

- <span data-ttu-id="38bac-347">Создайте определяемые пользователем маршруты (например, таблицы маршрутов), как описано выше, и задайте их для подсети.</span><span class="sxs-lookup"><span data-stu-id="38bac-347">Create UDRs (for example, route tables) as described earlier, and set that on the subnet.</span></span>
- <span data-ttu-id="38bac-348">Создайте среду ASE с помощью шаблона Resource Manager, как описано в статье [Создание среды службы приложений с внутренней подсистемой балансировки нагрузки с помощью шаблонов Azure Resource Manager][MakeASEfromTemplate].</span><span class="sxs-lookup"><span data-stu-id="38bac-348">Create the ASE by using a Resource Manager template as described in [Create an ASE by using a Resource Manager template][MakeASEfromTemplate].</span></span>

<!--Image references-->
[1]: ./media/network_considerations_with_an_app_service_environment/networkase-overflow.png
[2]: ./media/network_considerations_with_an_app_service_environment/networkase-overflow2.png
[3]: ./media/network_considerations_with_an_app_service_environment/networkase-ipaddresses.png
[4]: ./media/network_considerations_with_an_app_service_environment/networkase-inboundnsg.png
[5]: ./media/network_considerations_with_an_app_service_environment/networkase-outboundnsg.png
[6]: ./media/network_considerations_with_an_app_service_environment/networkase-udr.png
[7]: ./media/network_considerations_with_an_app_service_environment/networkase-subnet.png

<!--Links-->
[Intro]: ./intro.md
[MakeExternalASE]: ./create-external-ase.md
[MakeASEfromTemplate]: ./create-from-template.md
[MakeILBASE]: ./create-ilb-ase.md
[ASENetwork]: ./network-info.md
[ASEReadme]: ./readme.md
[UsingASE]: ./using-an-ase.md
[UDRs]: ../../virtual-network/virtual-networks-udr-overview.md
[NSGs]: ../../virtual-network/virtual-networks-nsg.md
[ConfigureASEv1]: ../../app-service-web/app-service-web-configure-an-app-service-environment.md
[ASEv1Intro]: ../../app-service-web/app-service-app-service-environment-intro.md
[webapps]: ../../app-service-web/app-service-web-overview.md
[mobileapps]: ../../app-service-mobile/app-service-mobile-value-prop.md
[APIapps]: ../../app-service-api/app-service-api-apps-why-best-platform.md
[Functions]: ../../azure-functions/index.yml
[Pricing]: http://azure.microsoft.com/pricing/details/app-service/
[ARMOverview]: ../../azure-resource-manager/resource-group-overview.md
[ConfigureSSL]: ../../app-service-web/web-sites-purchase-ssl-web-site.md
[Kudu]: http://azure.microsoft.com/resources/videos/super-secret-kudu-debug-console-for-azure-web-sites/
[AppDeploy]: ../../app-service-web/web-sites-deploy.md
[ASEWAF]: ../../app-service-web/app-service-app-service-environment-web-application-firewall.md
[AppGW]: ../../application-gateway/application-gateway-web-application-firewall-overview.md
[ASEManagement]: ./management-addresses.md

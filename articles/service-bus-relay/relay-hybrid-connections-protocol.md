---
title: "Гибридные подключения ретрансляции aaaAzure протокола руководство | Документы Microsoft"
description: "Руководство по использованию протокола гибридных подключений ретранслятора Azure."
services: service-bus-relay
documentationcenter: na
author: clemensv
manager: timlt
editor: 
ms.assetid: 149f980c-3702-4805-8069-5321275bc3e8
ms.service: service-bus-relay
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/03/2017
ms.author: sethm;clemensv
ms.openlocfilehash: 2d145d919d606ae4722b063e1baf39fb845a600a
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# Протокол гибридных подключений ретранслятора Azure
Ретрансляция Azure является одним из положений hello ключевые возможности платформы Azure Service Bus hello. новый Hello *гибридных подключений* возможности ретрансляции является развитием безопасный, протокол open, на основе HTTP и WebSockets. Он заменяет первое hello, одинаково с именем *службы BizTalk* компонент, который был создан на основе собственный протокол. Интеграция Hello гибридных подключений в службы приложений Azure будет продолжено toofunction как-является.

Функция "Гибридные подключения" позволяет установить двунаправленное соединение и организовать передачу двоичных потоков между двумя сетевыми приложениями, в течение которой одно из приложений (или оба) может находиться за NAT или брандмауэром. В этой статье описывается hello клиентские взаимодействий с hello гибридных подключений ретрансляции для подключающихся клиентов в прослушиватель отправителя ролей, и как прослушиватели принять новые подключения.

## Модель взаимодействия
Гибридные подключения ретрансляции Hello подключается двумя сторонами, предоставляя точку встречи в облако Azure, как сторон может обнаруживать и подключения toofrom собственные сети перспективы hello. Этой встречи называется «Гибридный соединения» в этом и другую документацию в hello API-интерфейсов, а также в hello портал Azure. Hello гибридных подключений, конечная точка службы ссылается hello tooas «служба» для hello оставшейся части этой статьи. модель взаимодействия Hello полагается на номенклатуру hello, заданные в другие сети API.

Имеется прослушиватель, который сначала указывает готовность toohandle входящие подключения, а впоследствии воспринимает их по мере их поступления. На hello другой стороны, имеется подключающегося клиента, который подключается к hello прослушивателя, ожидается, toobe соединений, принятых для установления пути двунаправленный обмен данными.
«Подключиться» «Прослушивание» и «Принять» являются hello же условия поиска в большинстве сокета API-интерфейсы.

Любой модели ретранслироваться связи имеет исходящих подключений к конечной точки службы, который делает hello «прослушиватель» также «клиент» colloquial используется и также могут вызывать другие перегрузки терминология любой из сторон. Hello точный терминология, поэтому мы используем для гибридных подключений выглядит следующим образом:

Hello программы на обеих сторонах соединения называются «клиенты», поскольку они зависят от службы toohello клиентов. Hello клиента, который ожидает и принимает соединения является «прослушиватель» или говорят, что toobe в hello «прослушиватель роли.» Hello клиента, который инициирует новое подключение к прослушивателя через службу hello называется «sender» hello, или «роль отправителя».

### Взаимодействия прослушивателя
Hello прослушиватель имеет четыре операциями со службой hello; все сведения о сети описаны далее в этой статье в разделе справочника hello.

#### Прослушивание
Служба toohello готовности tooindicate прослушиватель был готов tooaccept подключений, он создает исходящее подключение WebSocket. Hello подтверждения соединения содержит имя гибридного подключения, настроенная на пространство имен ретрансляции hello и маркера безопасности, который предоставляет hello «Прослушивание» правой кнопкой, именем hello.
При hello WebSocket принимается службой hello, выполнена регистрация hello и hello устанавливаются для веб-WebSocket хранится как hello «канал управления» для включения все последующие действия. Hello служба позволяет создавать копии too25 параллельных слушателей на гибридного подключения. При наличии двух и более активных прослушивателей входящие подключения распределяются между ними в произвольном порядке. Равномерное распределение при этом не гарантируется.

#### Принять
При открытии нового соединения в службе hello отправителя службы hello выбирает и уведомляет один hello active прослушивателей hello гибридного подключения. Это уведомление отправляется по каналу управления откройте hello прослушивателя toohello как сообщение JSON, содержащий hello URL-адрес конечной точки WebSocket hello, hello прослушивателя необходимо подключить toofor принимающей hello.

URL-адрес Hello можно и должен использоваться напрямую прослушивателем hello без дополнительных действий.
сведения о кодировке Hello только допустимые на короткое время, по существу столько же, как отправитель hello toowait пойти для hello подключение установлено toobe-законченный, но копирование tooa до 30 секунд. Hello URL-адрес может использоваться только для одного успешного подключения. Как можно скорее hello соединения с hello встречи, который устанавливается URL-адрес, все последующие действия на этом WebSocket ретранслируется от WebSocket и toohello отправителя, без вмешательства и интерпретация службой hello.

#### Возобновление
Hello маркер безопасности, используемые tooregister hello прослушивателя и вести канал управления может истечь срок действия во время активного hello прослушивателя. Срок действия токена Hello не влияет на исходящих подключений, но она причиной hello управления канал toobe удалены службой hello в или вскоре после hello момента истечения срока действия. Операция «обновить» Hello данный сообщение JSON, hello прослушиватель может отправить tooreplace hello маркером, связанным с канал управления hello, таким образом, чтобы hello канал управления может поддерживаться продолжительное время.

#### Проверка связи
Если канал управления hello остается простоя в течение долгого времени, посредников по способу hello, например нагрузки балансировки нагрузки или NAT может удалить hello TCP-соединение. Операция «ping» Hello избегает, отправляя небольшой объем данных в канале hello, каждый член hello сетевого маршрута напоминает соединение hello предназначенный toobe активности, и также служит в качестве теста «live» hello прослушивателя. В случае сбоя hello ping канал управления hello считается недоступным для использования и hello прослушиватель должен подключиться снова.

### Взаимодействия отправителя
Отправитель Hello имеет только одного взаимодействия со службой hello: он подключается.

#### Подключение
Операция «подключиться» Hello открывает WebSocket на службу hello, указав имя hello hello гибридного подключения и (при необходимости, но необходимые по умолчанию) маркера безопасности, предоставления разрешений «Отправить» в строке запроса hello. Hello службы затем взаимодействует с прослушивателя hello в hello, как описано выше, и обратное подключение, который объединяется с этой WebSocket создает прослушиватель hello. После принятия hello WebSocket с подключенной прослушивателя являются все дальнейшего взаимодействия на этом WebSocket.

### Сводка взаимодействий
Hello этой модели взаимодействия образом этому клиенту отправителя hello поступает из подтверждение с «чистого» WebSocket, который является подключенных tooa прослушивателя и, требующий без дальнейшего преамбулы или при подготовке. Эта модель позволяет практически любой существующий WebSocket клиента реализацию tooreadily воспользуйтесь преимуществами hello гибридные подключения службы, указав URL-адрес правильно составить в их уровень клиента WebSocket.

Hello обратное подключение WebSocket, hello прослушивателя, получаемые через взаимодействие accept также очистить и может быть передана существующую реализацию сервера WebSocket tooany с некоторых минимальной лишние абстракции, различающий «accept» операции с их framework прослушиватели локальной сети и гибридные подключения удаленного «принять» операций.

## Справочник по протоколу

В этом разделе приводятся сведения hello взаимодействий протокола hello было описано выше.

Все подключения через веб-сокет выполняются через порт 443 как обновление с HTTPS 1.1, которое часто абстрагируется некоторыми платформами веб-сокета или API. В данном описании не указывается конкретная реализации и не предлагается определенная платформа.

### Протокол прослушивателя
прослушиватель протокола Hello состоит из двух жестов соединения и три операции с сообщениями.

#### Подключение канала управления прослушивателя
При создании соединения WebSocket для открытия канала управления Hello:

```
wss://{namespace-address}/$hc/{path}?sb-hc-action=...[&sb-hc-id=...]&sb-hc-token=...
```

Hello `namespace-address` hello полное доменное имя пространства имен Azure ретрансляции hello, узлы hello гибридного подключения обычно формы hello `{myname}.servicebus.windows.net`.

Ниже приведены параметры параметр строки запроса Hello.

| Параметр | Обязательно | Описание |
| --- | --- | --- |
| `sb-hc-action` |Да |Для роли hello hello прослушиватель должен быть **sb контроллер action = прослушивания** |
| `{path}` |Да |путь URL-адреса пространства имен Hello hello предварительно настроен tooregister гибридного подключения этого прослушивателя на. Это выражение является присоединенных toohello фиксированной `$hc/` часть пути. |
| `sb-hc-token` |Да\* |Hello прослушивателя необходимо указать допустимый, URL-адреса службы шины общих токена доступа для пространства имен hello или гибридного подключения, которая предоставляет hello **прослушивания** вправо. |
| `sb-hc-id` |Нет |Этот необязательный идентификатор, предоставляемый клиентом, обеспечивает комплексную диагностическую трассировку. |

Сбой из-за toohello гибридного подключения путь не зарегистрированы, или токен недопустим или отсутствует или другой ошибки hello соединения WebSocket hello Ошибка обратной связи с использованием hello регулярного HTTP 1.1 состояние отзыва модели. Описание состояния содержит идентификатор отслеживания ошибки, который можно сообщить в службу поддержки Azure.

| Код | Ошибка | Description (Описание) |
| --- | --- | --- |
| 404 |Не найдено |Недопустимый путь Hello гибридное подключение или hello базовый URL-адрес имеет неправильный формат. |
| 401 |Не авторизовано |Hello маркера безопасности отсутствует или имеет неправильный формат или является недопустимым. |
| 403 |Запрещено |маркер безопасности Hello не является действительным для данного пути для этого действия. |
| 500 |Внутренняя ошибка |Произошла ошибка в службе hello. |

Если соединение WebSocket hello намеренно завершает службой hello после он был изначально настройки, причина hello в этом случае передается с помощью соответствующего кода ошибки протокола WebSocket вместе с сообщение с описанием ошибки, который также включает отслеживания ИДЕНТИФИКАТОР. Hello не завершит работу канала управления без возникновения ошибки. Любое завершение работы без ошибок контролируется клиентом.

| Состояние веб-сокета | Описание |
| --- | --- |
| 1001 |путь Hello гибридного подключения был удален или отключен. |
| 1008 |истек срок действия маркера безопасности Hello, поэтому нарушения политики авторизации hello. |
| 1011 |Произошла ошибка в службе hello. |

### Подтверждение приема
Hello «принять» отправляется уведомление toohello прослушивателем hello службы по каналу управления предварительно установленного как сообщение JSON в рамке WebSocket. Нет toothis не сопровождается ответным сообщением.

приветственное сообщение содержит объект JSON с именем «принять», который определяет следующие свойства в данный момент hello:

* **адрес** — hello toobe строку URL-адрес, используемый для установления hello WebSocket toothe службы tooaccept входящего подключения.
* **Идентификатор** — hello уникальный идентификатор для этого подключения. Если идентификатор hello предоставлена клиенту отправителя hello, hello отправителя указанное значение, в противном случае это созданный системой значение.
* **connectHeaders** — всех заголовков HTTP, которые были предоставленный конечной точки ретрансляции toohello отправителем hello, который также включает hello сек WebSocket протокола и заголовки сек WebSocket расширениям.

#### Сообщение accept

```json
{                                                           
    "accept" : {
        "address" : "wss://168.61.148.205:443/$hc/{path}?..."    
        "id" : "4cb542c3-047a-4d40-a19f-bdc66441e736",  
        "connectHeaders" : {                                         
            "Host" : "...",                                                
            "Sec-WebSocket-Protocol" : "...",                              
            "Sec-WebSocket-Extensions" : "..."                             
        }                                                            
     }                                                         
}
```

URL-адрес Hello предоставляемых в hello сообщения JSON используется прослушивателем hello для установления hello WebSocket для принятия или отклонения hello отправителя сокета.

#### Принятие сокета hello
tooaccept, hello прослушиватель устанавливает адресом toohello предоставленный соединения WebSocket.

Если hello «принять» сообщений выполняет `Sec-WebSocket-Protocol` заголовок, ожидается прослушиватель hello принимает hello WebSocket, только если он поддерживает этот протокол. Кроме того он задает заголовок hello как hello установлено WebSocket.

Hello применимо и к toohello `Sec-WebSocket-Extensions` заголовок. Если hello framework поддерживает расширение, он должен устанавливать ответ серверные toohello заголовок hello объекта требуется hello `Sec-WebSocket-Extensions` подтверждения для расширения hello.

Hello URL-адрес должен использоваться в качестве-— для установления hello принять сокетов, но содержит следующие параметры:

| Параметр | Обязательно | Описание |
| --- | --- | --- |
| `sb-hc-action` |Да |Для принятия сокета, hello параметр должен быть`sb-hc-action=accept` |
| `{path}` |Да |(см. следующий абзац hello.) |
| `sb-hc-id` |Нет |См. описание параметра **id**, приведенное выше. |

`{path}`представляет путь URL-адреса пространства имен hello hello заранее настроенные гибридное подключение на какие tooregister этого прослушивателя. Это выражение является присоединенных toothe фиксированной `$hc/` часть пути. 

Hello `path` выражения могут быть расширены с помощью суффикса и строковое выражения запроса, следующий за отделение косой черты hello зарегистрированное имя. Позволяет hello отправителя toopass диспетчеризации аргументы toohello принимает прослушивателя клиента, если не возможные tooinclude HTTP-заголовки. Hello предположения прослушиватель hello разбивает framework часть фиксированный путь hello и hello зарегистрированное имя из пути и делает остаток hello возможно без аргументов строки запроса, префиксом `sb-`, доступные toohello приложения для Выбор ли tooaccept hello соединения.

Дополнительные сведения см. в разделе hello в следующем разделе «Отправитель протокола».

Если возникает ошибка, служба hello ответить можно следующим образом:

| Код | Ошибка | Description (Описание) |
| --- | --- | --- |
| 403 |Запрещено |Недопустимый URL-адрес Hello. |
| 500 |Внутренняя ошибка |Произошла ошибка в службе hello |

После установления соединения hello hello сервер выключается hello WebSocket hello отправителя WebSocket отключения, а с hello следующие состояния:

| Состояние веб-сокета | Описание |
| --- | --- |
| 1001 |клиенту отправителя Hello завершает работу hello соединения. |
| 1001 |путь Hello гибридного подключения был удален или отключен. |
| 1008 |истек срок действия маркера безопасности Hello, поэтому нарушения политики авторизации hello. |
| 1011 |Произошла ошибка в службе hello. |

#### Отклонение hello сокета
Отклонение hello сокета после сообщения «принять» проверка hello требует аналогичные подтверждения чего hello код состояния и описание состояния связи, что могут перемещаться относительно причины отклонения hello обратно отправителю toohello.

Hello протокол Выбор здесь toouse WebSocket подтверждение установления связи (то есть спроектированный tooend в состоянии определенные ошибки), находится реализациям прослушивателя клиента могут продолжать выполняться toorely клиент WebSocket и не обязательно должны использовать дополнительный, восстановление HTTP-клиента.

tooreject hello сокета, hello клиент принимает адрес hello URI из сообщения «принять» hello и добавляет два tooit параметров строки запроса, как показано ниже:

| Параметр | Обязательно | Описание |
| --- | --- | --- |
| statusCode |Да |Числовой код состояния HTTP. |
| statusDescription |Да |Понятное для чтения причина отклонения hello. |

Hello, полученный URI будет использовать tooestablish соединения WebSocket.

При правильном выполнении это подтверждение намеренно завершится ошибкой с кодом HTTP 410, так как подключение по протоколу WebSocket не было установлено. Если что-то пойдет не так, следующие коды hello описания ошибки hello:

| Код | Ошибка | Description (Описание) |
| --- | --- | --- |
| 403 |Запрещено |Недопустимый URL-адрес Hello. |
| 500 |Внутренняя ошибка |Произошла ошибка в службе hello. |

### Возобновление действия маркера прослушивателя
Когда токен прослушивателя hello о tooexpire, его можно заменить путем отправки через канал управления hello установить службу toohello сообщений кадра текста. Сообщение содержит объект JSON с именем `renewToken`, который определяет следующие свойства в данный момент hello:

* **токен** — токен допустимый, URL-адреса Service Bus общего доступа для пространства имен или гибридного подключения, которая предоставляет hello **прослушивания** вправо.

#### Сообщение renewToken

```json
{                                                                                                                                                                        
    "renewToken" : {                                                                                                                                                      
        "token" : "SharedAccessSignature sr=http%3a%2f%2fcontoso.servicebus.windows.net%2fhyco%2f&amp;sig=XXXXXXXXXX%3d&amp;se=1471633754&amp;skn=SasKeyName"  
    }                                                                                                                                                                     
}
```

При сбое проверки токенов hello, отказано в доступе и hello облачная служба закрывает канал управления hello WebSocket с ошибкой. В противном случае ответа не будет.

| Состояние веб-сокета | Описание |
| --- | --- |
| 1008 |истек срок действия маркера безопасности Hello, поэтому нарушения политики авторизации hello. |

## Протокол отправителя
протокол Hello отправителя является фактически совпадает toohello, как установить прослушиватель.
Задача Hello — максимальное прозрачности для hello-законченный WebSocket. Hello адрес для подключения hello toois так же, как прослушиватель hello, но действие «hello» отличается, так и маркер требуется другое разрешение:

```
wss://{namespace-address}/$hc/{path}?sb-hc-action=...&sb-hc-id=...&sbc-hc-token=...
```

Hello *адрес пространства имен* hello полное доменное имя пространства имен Azure ретрансляции hello, узлы hello гибридного подключения обычно формы hello `{myname}.servicebus.windows.net`.

Hello запрос может содержать произвольный дополнительных заголовков HTTP, включая определяемые приложением. Все предоставленные заголовки потока toohello прослушиватель и можно найти на hello `connectHeader` hello объекта **принимать** контрольное сообщение.

Ниже приведены параметры параметр строки запроса Hello.

| Параметр | Обязательный? | Описание |
| --- | --- | --- |
| `sb-hc-action` |Да |Для роли отправителя hello hello параметр должен быть `action=connect`. |
| `{path}` |Да |(см. следующий абзац hello.) |
| `sb-hc-token` |Да\* |Hello прослушивателя необходимо указать допустимый, URL-адреса службы шины общих токена доступа для пространства имен hello или гибридного подключения, которая предоставляет hello **отправки** вправо. |
| `sb-hc-id` |Нет |Необязательный идентификатор, который включает диагностическую трассировку начала до конца и становится доступной toohello прослушивателя во время hello принять подтверждения. |

Hello `{path}` является путь URL-адреса пространства имен hello hello заранее настроенные гибридное подключение на какие tooregister этого прослушивателя. Hello `path` выражение можно дополнить суффикс и запрос строковое выражение toocommunicate дальнейшей. Если зарегистрировано hello гибридного подключения по пути hello `hyco`, hello `path` выражение может быть `hyco/suffix?param=value&...` следуют определенные здесь параметры строки запроса hello. Тогда полное выражение может иметь такой вид:

```
wss://{namespace-address}/$hc/hyco/suffix?param=value&sb-hc-action=...[&sb-hc-id=...&]sbc-hc-token=...
```

Hello `path` выражение передается через toohello прослушивателя в адресе hello URI, содержащемся в сообщении элемент управления «принять» hello.

Сбой из-за toohello гибридное подключение путь не зарегистрирован, токен недопустим или отсутствует или другой ошибки hello соединения WebSocket hello Ошибка обратной связи с использованием hello регулярного HTTP 1.1 состояние отзыва модели. Описание состояния содержит идентификатор отслеживания ошибки, который можно сообщить в службу поддержки Azure.

| Код | Ошибка | Description (Описание) |
| --- | --- | --- |
| 404 |Не найдено |Недопустимый путь Hello гибридное подключение или hello базовый URL-адрес имеет неправильный формат. |
| 401 |Не авторизовано |Hello маркера безопасности отсутствует или имеет неправильный формат или является недопустимым. |
| 403 |Запрещено |для этого пути и для этого действия недопустимый маркер безопасности Hello. |
| 500 |Внутренняя ошибка |Произошла ошибка в службе hello. |

Если hello соединения WebSocket намеренно завершается после его первоначальной настройки службой hello, причиной этого hello таким образом передается с помощью соответствующего кода ошибки протокола WebSocket вместе с сообщение с описанием ошибки, который также включает Идентификатор трассировки.

| Состояние веб-сокета | Description (Описание) |
| --- | --- |
| 1000 |прослушиватель Hello завершение работы сокета hello. |
| 1001 |путь Hello гибридного подключения был удален или отключен. |
| 1008 |истек срок действия маркера безопасности Hello, поэтому нарушения политики авторизации hello. |
| 1011 |Произошла ошибка в службе hello. |

## Дальнейшие действия
* [Вопросы и ответы по ретранслятору](relay-faq.md)
* [Создание пространства имен](relay-create-namespace-portal.md)
* [Приступая к работе с .NET](relay-hybrid-connections-dotnet-get-started.md)
* [Приступая к работе с Node](relay-hybrid-connections-node-get-started.md)


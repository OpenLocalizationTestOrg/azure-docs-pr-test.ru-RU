---
title: "Azure AD B2C: поток кода авторизации | Документация Майкрософт"
description: "Узнайте, как создавать веб-приложения с использованием протокола аутентификации Azure AD B2C и OpenID Connect."
services: active-directory-b2c
documentationcenter: 
author: saeedakhter-msft
manager: mtillman
editor: parakhj
ms.assetid: c371aaab-813a-4317-97df-b62e2f53d865
ms.service: active-directory-b2c
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/16/2017
ms.author: saeedakhter-msft
ms.openlocfilehash: 99a292c6be66016264e528525a5920667207b605
ms.sourcegitcommit: e266df9f97d04acfc4a843770fadfd8edf4fa2b7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/11/2017
---
# <a name="azure-active-directory-b2c-oauth-20-authorization-code-flow"></a>Azure Active Directory B2C: поток кода авторизации OAuth 2.0
Код авторизации OAuth 2.0 может использоваться в приложениях, установленных на устройстве, для получения доступа к защищенным ресурсам, таким как веб-API. С помощью реализации OAuth 2.0 в Azure Active Directory B2C можно добавить регистрацию, вход и другие задачи по управлению пользователями в мобильные и настольные приложения. Эта статья не зависит от языка. В ней описывается, как отправлять и получать сообщения HTTP, не используя ни одну из библиотек с открытым исходным кодом.

<!-- TODO: Need link to libraries -->

Описание потока кода авторизации OAuth 2.0 см. в [разделе 4.1 спецификации OAuth 2.0](http://tools.ietf.org/html/rfc6749). Его можно использовать для проверки подлинности и авторизации в большинстве типов приложений, включая [веб-приложения](active-directory-b2c-apps.md#web-apps) и [изначально установленные приложения](active-directory-b2c-apps.md#mobile-and-native-apps). Вы можете использовать поток кода авторизации OAuth 2.0, чтобы безопасно получать *маркеры доступа* для приложений, с помощью которых можно получить доступ к ресурсам, защищенным [сервером авторизации](active-directory-b2c-reference-protocols.md#the-basics).

В этой статье мы сосредоточимся на потоке кода авторизации OAuth 2.0 для **открытых клиентов**. Открытый клиент — это любое клиентское приложение, которому нельзя доверять в безопасном сохранении целостности секретного пароля. К ним относятся мобильные приложения, приложения для настольных компьютеров и практически любые приложения, которые выполняются на устройстве и должны получать маркеры доступа. 

> [!NOTE]
> Чтобы добавить управление идентификацией в веб-приложение с помощью Azure AD B2C, используйте [OpenID Connect](active-directory-b2c-reference-oidc.md), а не OAuth 2.0.

В Azure AD B2C стандартные потоки OAuth 2.0 выходят за рамки простой проверки подлинности и авторизации. В этой службе появляется [параметр политики](active-directory-b2c-reference-policies.md). С помощью внедренных политик можно использовать OAuth 2.0 для добавления в приложение действий по управлению пользователями, таких как регистрация, вход и управление профилями. В этой статье мы покажем, как с помощью OAuth 2.0 и политик реализовать каждую из этих функций в собственных приложениях и получить маркеры доступа к веб-интерфейсам API.

В приведенных в этой статье запросах HTTP используется наш пример каталога Azure AD B2C **fabrikamb2c.onmicrosoft.com**, а также наши примеры приложения и политик. Вы можете пробовать выполнять запросы с этими значениями или заменить их собственными.
Узнайте, как [получить собственный каталог Azure AD B2C, приложение и политики](#use-your-own-azure-ad-b2c-directory).

## <a name="1-get-an-authorization-code"></a>1. Получение кода авторизации
Поток кода авторизации начинается с того, что клиент направляет пользователя к конечной точке `/authorize` . Это интерактивная часть потока, в которой пользователь выполняет действие. В этом запросе клиент указывает в параметре `scope` разрешения, которые ему требуется получить от пользователя. В параметре `p` он указывает политику, которую необходимо выполнить. Ниже приведены три примера (переносы строк добавлены для удобства чтения), в которых используются разные политики.

### <a name="use-a-sign-in-policy"></a>Пример с политикой входа в систему
```
GET https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code
&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob
&response_mode=query
&scope=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
&p=b2c_1_sign_in
```

### <a name="use-a-sign-up-policy"></a>Пример с политикой регистрации
```
GET https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code
&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob
&response_mode=query
&scope=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
&p=b2c_1_sign_up
```

### <a name="use-an-edit-profile-policy"></a>Пример с политикой изменения профиля
```
GET https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code
&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob
&response_mode=query
&scope=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
&p=b2c_1_edit_profile
```

| Параметр | Обязательный? | ОПИСАНИЕ |
| --- | --- | --- |
| client_id |Требуется |Идентификатор приложения, назначенный вашему приложению на [портале Azure](https://portal.azure.com). |
| response_type |Требуется |Тип ответа, который должен содержать `code` для потока кода авторизации. |
| redirect_uri |Требуется |URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| scope |Требуется |Список областей с разделителями-пробелами. При указании одной области в Azure Active Directory (Azure AD) также обозначаются запрашиваемые разрешения. Использование идентификатора клиента в качестве области указывает на то, что приложению нужен маркер доступа, который может использоваться в вашей службе или веб-API, представленных таким же идентификатором клиента.  Область `offline_access` означает, что вашему приложению потребуется маркер обновления для продолжительного доступа к ресурсам. Вы также можете использовать область `openid` для запроса идентификатора маркера из Azure AD B2C. |
| response_mode |Рекомендуется |Метод, используемый для отправки полученного кода авторизации приложению. Он может иметь значение `query`, `form_post` или `fragment`. |
| state |Рекомендуется |Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого содержимого. Как правило, с целью предотвращения подделки межсайтовых запросов используется генерируемое случайным образом уникальное значение. Этот параметр также включает информацию о состоянии пользователя в приложении перед созданием запроса на проверку подлинности. Например, об открытой пользователем в тот момент странице или выполняемой политике. |
| p |Требуется |Выполняемая политика. Это имя политики, созданной в каталоге Azure AD B2C. Оно должно начинаться с **b2c\_1\_**. Дополнительные сведения о политиках см. в статье [Azure Active Directory B2C: расширяемая инфраструктура политик](active-directory-b2c-reference-policies.md). |
| prompt |Необязательно |Требуемый тип взаимодействия с пользователем. Сейчас единственное допустимое значение — это `login`, при котором пользователю приходится вводить учетные данные по запросу. Единый вход не сработает. |

На этом этапе пользователю предлагается выполнить рабочий процесс политики. Для этого могут потребоваться ввод имени пользователя и пароля, вход с помощью удостоверения социальной сети, регистрация в каталоге или любые другие шаги. Действия пользователя определяются в политике.

Когда пользователь выполнит рабочий процесс политики, служба Azure AD вернет ответ приложению, используя значение, указанное для `redirect_uri`. Она использует метод, указанный в параметре `response_mode`. Во всех сценариях действий пользователя ответ будет одинаковым независимо от политики, которая была выполнена.

Успешный ответ с использованием метода `response_mode=query` выглядит следующим образом:

```
GET urn:ietf:wg:oauth:2.0:oob?
code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...        // the authorization_code, truncated
&state=arbitrary_data_you_can_receive_in_the_response                // the value provided in the request
```

| Параметр | ОПИСАНИЕ |
| --- | --- |
| Код |Запрашиваемый приложением код авторизации. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса. Срок действия кодов авторизации крайне мал. и обычно истекает по прошествии порядка 10 минут. |
| state |Полное описание см. в таблице выше. Если запрос содержит параметр `state`, то в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра `state` в запросе и ответе. |

Сообщения об ошибках также можно отправлять на универсальный код ресурса (URI) перенаправления, чтобы приложение могло их правильно обработать:

```
GET urn:ietf:wg:oauth:2.0:oob?
error=access_denied
&error_description=The+user+has+cancelled+entering+self-asserted+information
&state=arbitrary_data_you_can_receive_in_the_response
```

| Параметр | ОПИСАНИЕ |
| --- | --- |
| error |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description |Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки аутентификации. |
| state |См. полное описание в предыдущей таблице. Если запрос содержит параметр `state`, то в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра `state` в запросе и ответе. |

## <a name="2-get-a-token"></a>2. Получение маркера
После получения кода авторизации можно использовать `code`, чтобы получить маркер для целевого ресурса путем отправки запроса POST на конечную точку `/token`. В Azure AD B2C вы можете запросить маркер только для веб-API серверной части вашего приложения. В соответствии с соглашением, которое используется при запросе маркера для себя, следует использовать идентификатор клиента в качестве области.

```
POST fabrikamb2c.onmicrosoft.com/oauth2/v2.0/token?p=b2c_1_sign_in HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6&scope=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...&redirect_uri=urn:ietf:wg:oauth:2.0:oob

```

| Параметр | Обязательный? | ОПИСАНИЕ |
| --- | --- | --- |
| p |Требуется |Политика, которая использовалась для получения кода авторизации. Другую политику в этом запросе использовать нельзя. Обратите внимание, что этот параметр добавляется к *строке запроса*, а не в тело запроса POST. |
| client_id |Требуется |Идентификатор приложения, назначенный вашему приложению на [портале Azure](https://portal.azure.com). |
| grant_type |Требуется |Тип предоставления. Для потока кода авторизации это должен быть тип `authorization_code`. |
| scope |Рекомендуется |Список областей с разделителями-пробелами. При указании одной области также обозначаются запрашиваемые разрешения. Использование идентификатора клиента в качестве области указывает на то, что приложению нужен маркер доступа, который может использоваться в вашей службе или веб-API, представленных таким же идентификатором клиента.  Область `offline_access` означает, что вашему приложению потребуется маркер обновления для продолжительного доступа к ресурсам.  Вы также можете использовать область `openid` для запроса идентификатора маркера из Azure AD B2C. |
| Код |Требуется |Код авторизации, полученный на первом участке потока. |
| redirect_uri |Требуется |URI перенаправления приложения, в котором вы получили код авторизации. |

Успешный ответ маркера выглядит следующим образом:

```
{
    "not_before": "1442340812",
    "token_type": "Bearer",
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "scope": "90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access",
    "expires_in": "3600",
    "refresh_token": "AAQfQmvuDy8WtUv-sd0TBwWVQs1rC-Lfxa_NDkLqpg50Cxp5Dxj0VPF1mx2Z...",
}
```
| Параметр | ОПИСАНИЕ |
| --- | --- |
| not_before |Момент времени, в который маркер начинает считаться действительным (с начала эпохи). |
| token_type |Значение типа маркера. Единственный тип, поддерживаемый Azure AD — носитель. |
| access_token |Подписанный маркер JSON Web Token (JWT), который вы запрашивали. |
| scope |Области, для которых действителен маркер. Области также можно использовать, чтобы кэшировать маркеры для последующего использования. |
| expires_in |Срок действия маркера (в секундах). |
| refresh_token |Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров по истечении срока действия текущего маркера. Маркеры обновления имеют большой срок действия. Их можно использовать для длительного сохранения доступа к ресурсам. Дополнительные сведения см. в статье [Azure AD B2C: справочник по маркерам](active-directory-b2c-reference-tokens.md). |

Сообщения об ошибках выглядят следующим образом:

```
{
    "error": "access_denied",
    "error_description": "The user revoked access to the app.",
}
```

| Параметр | ОПИСАНИЕ |
| --- | --- |
| error |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description |Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки аутентификации. |

## <a name="3-use-the-token"></a>3. Использование маркера
После успешного получения маркера доступа маркер можно использовать в запросах к веб-API серверной части приложения, включая маркер в заголовок `Authorization`.

```
GET /tasks
Host: https://mytaskwebapi.com
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

## <a name="4-refresh-the-token"></a>4. Обновление маркера
Срок действия маркеров доступа и маркеров идентификации крайне мал. Для сохранения доступа к ресурсам маркеры с истекшим сроком действия необходимо обновлять. Для этого нужно отправить еще один запрос POST в конечную точку `/token`, указав `refresh_token` вместо `code`:

```
POST fabrikamb2c.onmicrosoft.com/oauth2/v2.0/token?p=b2c_1_sign_in HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6&scope=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access&refresh_token=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...&redirect_uri=urn:ietf:wg:oauth:2.0:oob
```

| Параметр | Обязательный? | ОПИСАНИЕ |
| --- | --- | --- |
| p |Требуется |Политика, которая использовалась для получения исходного маркера обновления. Другую политику в этом запросе использовать нельзя. Обратите внимание, что этот параметр добавляется к *строке запроса*, а не в тело запроса POST. |
| client_id |Рекомендуется |Идентификатор приложения, назначенный вашему приложению на [портале Azure](https://portal.azure.com). |
| grant_type |Требуется |Тип предоставления. Для этого участка потока кода авторизации это должен быть тип `refresh_token`. |
| scope |Рекомендуется |Список областей с разделителями-пробелами. При указании одной области также обозначаются запрашиваемые разрешения. Использование идентификатора клиента в качестве области указывает на то, что приложению нужен маркер доступа, который может использоваться в вашей службе или веб-API, представленных таким же идентификатором клиента.  Область `offline_access` означает, что вашему приложению потребуется маркер обновления для продолжительного доступа к ресурсам.  Вы также можете использовать область `openid` для запроса идентификатора маркера из Azure AD B2C. |
| redirect_uri |Необязательно |URI перенаправления приложения, в котором вы получили код авторизации. |
| refresh_token |Требуется |Исходный маркер обновления, полученный на втором участке потока. |

Успешный ответ маркера выглядит следующим образом:

```
{
    "not_before": "1442340812",
    "token_type": "Bearer",
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "scope": "90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access",
    "expires_in": "3600",
    "refresh_token": "AAQfQmvuDy8WtUv-sd0TBwWVQs1rC-Lfxa_NDkLqpg50Cxp5Dxj0VPF1mx2Z...",
}
```
| Параметр | ОПИСАНИЕ |
| --- | --- |
| not_before |Момент времени, в который маркер начинает считаться действительным (с начала эпохи). |
| token_type |Значение типа маркера. Единственный тип, поддерживаемый Azure AD — носитель. |
| access_token |Подписанный маркер JWT, который вы запрашивали. |
| scope |Области, для которых действителен маркер. Области также можно использовать, чтобы кэшировать маркеры для последующего использования. |
| expires_in |Срок действия маркера (в секундах). |
| refresh_token |Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров по истечении срока действия текущего маркера. У маркеров обновления длительный срок действия. Их можно использовать, чтобы надолго сохранять доступ к ресурсам. Дополнительные сведения см. в статье [Azure AD B2C: справочник по маркерам](active-directory-b2c-reference-tokens.md). |

Сообщения об ошибках выглядят следующим образом:

```
{
    "error": "access_denied",
    "error_description": "The user revoked access to the app.",
}
```

| Параметр | ОПИСАНИЕ |
| --- | --- |
| error |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description |Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки аутентификации. |

## <a name="use-your-own-azure-ad-b2c-directory"></a>Использование собственного каталога Azure AD B2C
Чтобы отправить эти запросы самостоятельно, выполните следующие действия. Замените значения, приведенные в этой статье в качестве примера, собственными.

1. [Создайте каталог Azure AD B2C](active-directory-b2c-get-started.md). Используйте имя своего каталога в запросах.
2. [Создайте приложение](active-directory-b2c-app-registration.md) для получения идентификатора приложения и URI перенаправления. Включите собственный клиент в приложение.
3. [Создайте собственные политики](active-directory-b2c-reference-policies.md) для получения имен политик.


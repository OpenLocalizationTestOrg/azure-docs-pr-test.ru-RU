---
title: "Azure Active Directory B2C: устранение неполадок в пользовательских политиках | Документация Майкрософт"
description: "Узнайте о способах решения проблем при работе с пользовательскими политиками в Azure Active Directory."
services: active-directory-b2c
documentationcenter: 
author: rojasja
manager: mtillman
editor: rojasja
ms.assetid: 
ms.service: active-directory-b2c
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/07/2017
ms.author: joroja
ms.openlocfilehash: 8718f9c1dfce81682174eec11e8cbb731cbdf796
ms.sourcegitcommit: e266df9f97d04acfc4a843770fadfd8edf4fa2b7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/11/2017
---
# <a name="troubleshoot-azure-ad-b2c-custom-policies-and-identity-experience-framework"></a>Устранение неполадок в пользовательских политиках Azure AD B2C и инфраструктуре процедур идентификации

Если вы используете пользовательские политики Azure Active Directory B2C (Azure AD B2C), вы можете столкнуться с некоторыми трудностями при настройке инфраструктуры процедур идентификации на языке политики в формате XML.  Обучение написанию пользовательских политик подобно изучению нового языка. В этой статье вы ознакомитесь со средствами и подсказками, которые помогут вам быстро обнаружить и решить проблемы. 

> [!NOTE]
> Мы рассмотрим устранение неполадок, связанных с настройками пользовательских политик Azure AD B2C. В этой статье не рассматривается приложение проверяющей стороны или его библиотека удостоверений.

## <a name="xml-editing"></a>Редактирование кода XML

Самой распространенной ошибкой при настройке пользовательских политик является неправильный формат XML. Вам нужен хороший редактор XML. Хороший редактор XML отображает XML в изначальном виде, помечает содержимое цветовыми кодами, предварительно заполняет общие термины, индексирует элементы XML и может проверять их по схеме. Мы предлагаем использовать следующие два редактора XML:

* [Visual Studio Code](https://code.visualstudio.com/)
* [Notepad++](https://notepad-plus-plus.org/)

При проверке по схеме XML определяются ошибки перед отправкой XML-файла. Получите определение схемы XML TrustFrameworkPolicy_0.3.0.0.xsd из корневой папки начального пакета. Чтобы получить дополнительные сведения, в документации редактора XML прочтите о *средствах XML* и *проверке XML*.

Не будет лишним также ознакомиться с правилами XML. Azure AD B2C отклоняет любые обнаруженные ошибки форматирования. Иногда, если используется XML неправильного формата, могут появляться сообщения об ошибках, вводящие в заблуждение.

## <a name="upload-policies-and-policy-validation"></a>Передача политик и их проверка

 Проверка передачи XML-файла выполняется автоматически. Большинство ошибок приводят к сбою отправки. Проверка включает файл политики, который вы отправляете. Она также включает цепочку файлов, с которыми связан файл для отправки (файл политики проверяющей стороны, файл расширения и базовый файл). 
 
 Ниже представлены распространенные ошибки проверки.

Фрагмент кода ошибки: `... makes a reference to ClaimType with id "displaName" but neither the policy nor any of its base policies contain such an element`
* Значение ClaimType может быть введено неверно или не существовать в схеме.
* Значения ClaimType нужно определить по крайней мере в одном из файлов политики. 
    Например: ` <ClaimType Id="socialIdpUserId">`
* Если параметр ClaimType определен в файле расширения, но также используется в значении TechnicalProfile в базовом файле, передача базового файла приведет к ошибке.

Фрагмент кода ошибки: `...makes a reference to a ClaimsTransformation with id...`
* Причины ошибки могут быть такими же, как и для ошибок, описанных для параметра ClaimType.

Фрагмент кода ошибки: `Reason: User is currently logged as a user of 'yourtenant.onmicrosoft.com' tenant. In order to manage 'yourtenant.onmicrosoft.com', please login as a user of 'yourtenant.onmicrosoft.com' tenant`
* Значение TenantId в **\<TrustFrameworkPolicy\>** и элементы **\<BasePolicy\>** должны соответствовать целевому клиенту Azure AD B2C.  

## <a name="troubleshoot-the-runtime"></a>Устранение неполадок среды выполнения

* Используйте `Run Now` и `https://jwt.io`, чтобы проверить свои политики независимо от мобильного приложения или веб-приложения. Этот веб-сайт работает как приложение проверяющей стороны. Он отображает содержимое маркера JSON Web Token (JWT), созданного политикой Azure AD B2C. Чтобы создать тестовое приложение в инфраструктуре процедур идентификации, используйте следующие свойства:
    * Имя: TestApp.
    * Веб-приложение или веб-интерфейс API: нет.
    * Собственный клиент: нет.

* Чтобы отследить обмен сообщениями между клиентским браузером и Azure AD B2C, используйте [Fiddler](http://www.telerik.com/fiddler). Это позволит узнать, где в шагах оркестрации случился сбой пути взаимодействия пользователя.

* Используйте **Application Insights** в **режиме разработки**, чтобы отслеживать поведение в рамках пути взаимодействия пользователя в инфраструктуре процедур идентификации. В **режиме разработки** можно отслеживать обмен утверждениями между инфраструктурой процедур идентификации и различными поставщиками утверждений, определяемых техническими профилями, такими как поставщик удостоверений, службы на базе API, пользовательский каталог Azure AD B2C и другие службы, например Многофакторная идентификация Azure.  

## <a name="recommended-practices"></a>Рекомендации

**Храните нескольких версий своих сценариев. Группируйте их в проект со своим приложением.** Базовые файлы, файлы расширения и файлы проверяющей стороны напрямую зависят друг от друга. Сохраните их как группу. Используйте отдельные рабочие версии по мере реализации новых функций в политиках. Поместите рабочие версии в свою собственную файловую систему с кодом приложения, с которым они взаимодействуют.  Приложения могут вызывать многие различные политики проверяющей стороны в клиенте. Они могут стать зависимыми от утверждений, ожидаемых на основе политик Azure AD B2C.

**Разрабатывайте и тестируйте технические профили с известными путями взаимодействия пользователя.** Используйте проверенные политики начального пакета, чтобы настроить технические профили. Прежде чем встраивать их в собственные пути взаимодействия пользователя, проверьте их по отдельности.

**Разрабатывайте и тестируйте пути взаимодействия пользователя с проверенными техническими профилями.** Поэтапно измените шаги оркестрации пути взаимодействия пользователя. Прогрессивно создавайте целевые сценарии.

## <a name="next-steps"></a>Дальнейшие действия

* На портале GitHub загрузите ZIP-файл [active-directory-b2c-custom-policy-starterpack] (https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/archive/master.zip).

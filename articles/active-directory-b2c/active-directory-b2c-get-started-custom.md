---
title: "Azure Active Directory B2C: начало работы с настраиваемыми политиками | Документы Майкрософт"
description: "Как начать работу с настраиваемыми политиками Azure Active Directory B2C"
services: active-directory-b2c
documentationcenter: 
author: rojasja
manager: krassk
editor: rojasja
ms.assetid: 658c597e-3787-465e-b377-26aebc94e46d
ms.service: active-directory-b2c
ms.workload: identity
ms.tgt_pltfrm: na
ms.topic: article
ms.devlang: na
ms.date: 08/04/2017
ms.author: joroja;parahk;gsacavdm
ms.openlocfilehash: 4f14dbf4b66f10290cd4f98d56a005f97cc6a207
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="azure-active-directory-b2c-get-started-with-custom-policies"></a>Azure Active Directory B2C: начало работы с настраиваемыми политиками

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

После выполнения действий, описанных в этой статье, настраиваемая политика будет поддерживать регистрацию и вход с помощью локальной учетной записи с использованием адреса электронной почты и пароля. Кроме того, будет подготовлена среда для добавления поставщиков удостоверений (например, Facebook или Azure Active Directory). Мы рекомендуем выполнить эти действия перед знакомством с другими вариантами использования инфраструктуры процедур идентификации Azure AD B2C.

## <a name="prerequisites"></a>Предварительные требования

Прежде чем продолжить, убедитесь, что у вас есть клиент Azure AD B2C, который является контейнером для всех пользователей, приложений, политик и т. д. Если у вас еще нет клиента Azure AD B2C, его необходимо [создать](active-directory-b2c-get-started.md). Прежде чем продолжить, мы настоятельно советуем всем разработчикам ознакомиться с руководствами по работе с внедренными политиками Azure AD B2C и настроить приложения на основе этих политик. Ваши приложения будут поддерживать оба типа политик. Вы можете немного изменить имя политики, чтобы вызвать настраиваемую политику.

>[!NOTE]
>Чтобы получить доступ к изменению настраиваемых политик, необходимо связать с клиентом действующую подписку Azure. Если вы еще не [привязали свою подписку Azure к клиенту Azure AD B2C](active-directory-b2c-how-to-enable-billing.md) или подписка Azure отключена, кнопка Identity Experience Framework будет недоступна.

## <a name="add-signing-and-encryption-keys-to-your-b2c-tenant-for-use-by-custom-policies"></a>Добавление ключей подписывания и шифрования в клиент B2C для использования настраиваемыми политиками

1. Откройте колонку **Инфраструктура процедур идентификации** в параметрах клиента Azure AD B2C.
2. Выберите **Policy Keys** (Ключи политики), чтобы просмотреть доступные в клиенте ключи.
3. Создайте B2C_1A_TokenSigningKeyContainer, если он не существует:<br>
    а. Выберите **Добавить**. <br>
    b. Выберите **Создать**.<br>
    c. Для параметра **Имя** используйте значение `TokenSigningKeyContainer`. <br> 
    Префикс `B2C_1A_` может быть добавлен автоматически.<br>
    d. Для параметра **Тип ключа** используйте значение **RSA**.<br>
    д. Для параметра **Даты** используйте значения по умолчанию. <br>
    f. Для параметра **Использование ключа** задайте значение **Подпись**.<br>
    ж. Нажмите кнопку **Создать**.<br>
4. Создайте B2C_1A_TokenEncryptionKeyContainer, если он не существует:<br>
 а. Выберите **Добавить**.<br>
 b. Выберите **Создать**.<br>
 c. Для параметра **Имя** используйте значение `TokenEncryptionKeyContainer`. <br>
   Префикс `B2C_1A`_ может быть добавлен автоматически.<br>
 г) Для параметра **Тип ключа** используйте значение **RSA**.<br>
 д. Для параметра **Даты** используйте значения по умолчанию.<br>
 Е. Для параметра **Использование ключа** задайте значение **Шифрование**.<br>
 g. Нажмите кнопку **Создать**.<br>
5. Создайте B2C_1A_FacebookSecret. <br>
При наличии секретного кода приложения Facebook добавьте его как ключ политики в клиенте. В противном случае создайте ключ со значением-заполнителем. Это позволит политикам проходить проверку.<br>
 а. Выберите **Добавить**.<br>
 b. В пункте **Параметры** используйте вариант **Вручную**.<br>
 c. Для параметра **Имя** используйте значение `FacebookSecret`. <br>
 Префикс `B2C_1A_` может быть добавлен автоматически.<br>
 г) В поле **Секрет** введите значение FacebookSecret, указанное на сайте developers.facebook.com, или задайте значение `0` в качестве заполнителя. *Это не идентификатор приложения Facebook.* <br>
 д. Для параметра **Использование ключа** задайте значение **Подпись**. <br>
 Е. Выберите **Создать** и подтвердите создание.

## <a name="register-identity-experience-framework-applications"></a>Регистрация приложений инфраструктуры процедур идентификации

Для Azure AD B2C необходимо зарегистрировать два дополнительных приложения, которые используются подсистемой для регистрации и входа пользователей.

>[!NOTE]
>Создайте два приложения, обеспечивающие поддержку входа с помощью локальных учетных записей: IdentityExperienceFramework (веб-приложение) и ProxyIdentityExperienceFramework (встроенное приложение) с делегированным разрешением IdentityExperienceFramework. Локальные учетные записи хранятся только в клиенте. Пользователи регистрируются в системе, используя уникальное сочетание адреса электронной почты и пароля, чтобы получить доступ к зарегистрированным в клиенте приложениям.

### <a name="create-the-identityexperienceframework-application"></a>Создание приложения IdentityExperienceFramework

1. На [портале Azure](https://portal.azure.com) переключитесь в [контекст клиента Azure AD B2C](active-directory-b2c-navigate-to-b2c-context.md).
2. Откройте колонку **Azure Active Directory** (не перепутайте ее с колонкой **Azure AD B2C**). Чтобы найти ее, возможно, потребуется выбрать пункт **Больше служб**.
3. Щелкните **Регистрация приложений**.
4. Выберите **Регистрация нового приложения**.
   * Для параметра **Имя** используйте значение `IdentityExperienceFramework`.
   * Для параметра **Тип приложения** используйте значение **Веб-приложение/API**.
   * Для параметра **URL-адрес входа** используйте адрес `https://login.microsoftonline.com/yourtenant.onmicrosoft.com`, где `yourtenant` — это доменное имя клиента Azure AD B2C.
5. Нажмите кнопку **Создать**.
6. Когда создание будет завершено, выберите только что созданное приложение **IdentityExperienceFramework**.<br>
   * Выберите **Свойства**.<br>
   * Скопируйте идентификатор приложения и сохраните его для использования в будущем.

### <a name="create-the-proxyidentityexperienceframework-application"></a>Создание приложения ProxyIdentityExperienceFramework

1. Щелкните **Регистрация приложений**.
1. Выберите **Регистрация нового приложения**.
   * Для параметра **Имя** используйте значение `ProxyIdentityExperienceFramework`.
   * Для параметра **Тип приложения** используйте значение **Встроенное**.
   * Для параметра **URI перенаправления**, используйте адрес `https://login.microsoftonline.com/yourtenant.onmicrosoft.com`, где `yourtenant` — это ваш клиент Azure AD B2C.
1. Нажмите кнопку **Создать**.
1. Когда создание будет завершено, выберите приложение **ProxyIdentityExperienceFramework**.<br>
   * Выберите **Свойства**. <br>
   * Скопируйте идентификатор приложения и сохраните его для использования в будущем.
1. Выберите **Необходимые разрешения**.
1. Выберите **Добавить**.
1. Выберите **Выбор API**.
1. Выполните поиск по имени IdentityExperienceFramework. В результатах поиска выберите **IdentityExperienceFramework**, затем щелкните **Выбрать**.
1. Установите флажок рядом с элементом **Доступ к IdentityExperienceFramework**, затем нажмите **Выбрать**.
1. Нажмите кнопку **Готово**.
1. Выберите **Предоставление разрешений**, затем **Да** для подтверждения.

## <a name="download-starter-pack-and-modify-policies"></a>Скачивание начального пакета и изменение политик

Настраиваемые политики — это набор XML-файлов, которые нужно отправить в клиент Azure AD B2C. Мы предоставляем начальные пакеты, которые позволяют быстро приступить к работе. Каждый начальный пакет из следующего списка содержит минимальное количество технических профилей и путей взаимодействия пользователей, необходимых для достижения описанных сценариев:
 * LocalAccounts. Позволяет использовать только локальные учетные записи.
 * SocialAccounts. Позволяет использовать только учетные записи социальных сетей (или федеративные учетные записи).
 * **SocialAndLocalAccounts**. Мы будем использовать этот файл в нашем пошаговом руководстве.
 * SocialAndLocalAccountsWithMFA. Сюда включены параметры локальной идентификации, многофакторной идентификации и идентификации с помощью социальных сетей.

Каждый начальный пакет содержит:

* [Базовый файл](active-directory-b2c-overview-custom.md#policy-files) политики. Для базового файла требуется несколько изменений.
* [Файл расширения](active-directory-b2c-overview-custom.md#policy-files) политики.  В этот файл вносится большинство изменений конфигурации.
* [Файлы проверяющей стороны](active-directory-b2c-overview-custom.md#policy-files) — это файлы, которые вызывает приложение для выполнения определенных задач.

>[!NOTE]
>Если в редакторе XML поддерживается проверка, проверьте файлы с помощью XML-файла схемы TrustFrameworkPolicy_0.3.0.0.xsd, который расположен в корневом каталоге начального пакета. При проверке по схеме XML определяются ошибки перед отправкой.

 Давайте приступим.

1. Скачайте пакет active-directory-b2c-custom-policy-starterpack из репозитория GitHub. [Скачайте ZIP-файл](https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/archive/master.zip) или выполните команду

    ```console
    git clone https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack
    ```
2. Откройте папку SocialAndLocalAccounts.  В базовом файле (TrustFrameworkBase.xml) в этой папке имеется содержимое, необходимое для локальных учетных записей, корпоративных учетных записей и учетных записей социальных сетей. Содержимое из социальных сетей не влияет на настройку и запуск локальных учетных записей.
3. Откройте файл TrustFrameworkBase.xml. Если вам нужен редактор XML, [попробуйте Visual Studio Code](https://code.visualstudio.com/download) — упрощенный кроссплатформенный редактор.
4. В корневом элементе `TrustFrameworkPolicy` обновите атрибуты `TenantId` и `PublicPolicyUri`, заменив `yourtenant.onmicrosoft.com` доменным именем клиента Azure AD B2C:
   ```xml
    <TrustFrameworkPolicy
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06"
    PolicySchemaVersion="0.3.0.0"
    TenantId="yourtenant.onmicrosoft.com"
    PolicyId="B2C_1A_TrustFrameworkBase"
    PublicPolicyUri="http://yourtenant.onmicrosoft.com">
    ```
   >[!NOTE]
   >`PolicyId` — это имя политики, которое отображается на портале, и имя, по которому другие файлы политики ссылаются на этот файл политики.

5. Сохраните файл.
6. Откройте файл TrustFrameworkExtensions.xml. Внесите те же два изменения, заменив `yourtenant.onmicrosoft.com` клиентом Azure AD B2C. Внесите такие же изменения в значение элемента `<TenantId>` (в результате будут внесены 3 изменения). Сохраните файл.
7. Откройте файл SignUpOrSignIn.xml. Внесите те же изменения, заменив `yourtenant.onmicrosoft.com` клиентом Azure AD B2C в трех местах. Сохраните файл.
8. Откройте файлы сброса пароля и редактирования профиля. Внесите те же изменения, заменив `yourtenant.onmicrosoft.com` клиентом Azure AD B2C в трех местах в каждом файле. Сохраните файлы.

### <a name="add-the-application-ids-to-your-custom-policy"></a>Добавление идентификаторов приложений в настраиваемую политику
Добавьте идентификаторы приложений в файл расширения (`TrustFrameworkExtensions.xml`):

1. Найдите элемент `<TechnicalProfile Id="login-NonInteractive">` в файле расширения (TrustFrameworkExtensions.xml).
2. Замените оба экземпляра `IdentityExperienceFrameworkAppId` идентификатором созданного ранее приложения инфраструктуры процедур идентификации. Пример:

   ```xml
   <Item Key="client_id">8322dedc-cbf4-43bc-8bb6-141d16f0f489</Item>
   ```
3. Замените оба экземпляра `ProxyIdentityExperienceFrameworkAppId` идентификатором созданного ранее приложения прокси инфраструктуры процедур идентификации.
4. Сохраните файл расширений.

## <a name="upload-the-policies-to-your-tenant"></a>Отправка политик в клиент

1. На [портале Azure](https://portal.azure.com) переключитесь в [контекст клиента Azure AD B2C](active-directory-b2c-navigate-to-b2c-context.md) и откройте колонку **Azure AD B2C**.
2. Выберите **Инфраструктура процедур идентификации**.
3. Щелкните **Отправить политику**.

    >[!WARNING]
    >Файлы настраиваемой политики необходимо отправить в следующем порядке:

1. Отправьте файл TrustFrameworkBase.xml.
2. Отправьте файл TrustFrameworkExtensions.xml.
3. Отправьте файл SignUpOrSignin.xml.
4. Отправьте другие файлы политики.

При отправке к имени файла политики добавляется префикс `B2C_1A_`.

## <a name="test-the-custom-policy-by-using-run-now"></a>Тестирование настраиваемой политики с помощью команды "Запустить сейчас"

1. Откройте **Параметры Azure AD B2C** и перейдите к элементу **Инфраструктура процедур идентификации**.

   >[!NOTE]
   >Для использования команды **Запустить сейчас** необходимо, чтобы в клиенте было предварительно зарегистрировано хотя бы одно приложение. Для регистрации приложений в клиенте B2C выберите меню **Приложения** в Azure AD B2C или используйте инфраструктуру процедур идентификации, чтобы вызвать встроенные и настраиваемые политики. Каждое приложение необходимо зарегистрировать один раз.<br><br>
   Дополнительные сведения о регистрации приложений см. в статье [Azure AD B2C: начало работы](active-directory-b2c-get-started.md) или [Регистрация приложения](active-directory-b2c-app-registration.md).  

2. Откройте политику B2C_1A_signup_signin, отправленную вами настраиваемую политику проверяющей стороны. Выберите **Запустить сейчас**.

3. Вы сможете зарегистрироваться, используя адрес электронной почты.

4. Войдите в систему с помощью той же учетной записи, чтобы подтвердить правильность конфигурации.

>[!NOTE]
>Часто причина ошибки при входе заключается в неправильной настройке приложения IdentityExperienceFramework.


## <a name="next-steps"></a>Дальнейшие действия

### <a name="add-facebook-as-an-identity-provider"></a>Добавление Facebook в качестве поставщика удостоверений
Чтобы настроить Facebook, сделайте следующее.
1. [Настройте приложение Facebook на сайте developers.facebook.com](active-directory-b2c-setup-fb-app.md).
2. [Добавьте секретный код приложения Facebook в клиент Azure AD B2C](#add-signing-and-encryption-keys-to-your-b2c-tenant-for-use-by-custom-policies).
3. Замените значение параметра `client_id` идентификатором приложения Facebook в файле политики TrustFrameworkExtensions:

   ```xml
   <TechnicalProfile Id="Facebook-OAUTH">
     <Metadata>
     <!--Replace the value of client_id in this technical profile with the Facebook app ID"-->
       <Item Key="client_id">00000000000000</Item>
   ```
4. Отправьте файл политики TrustFrameworkExtensions.xml в клиент.
5. Выполните проверку с помощью команды **Запустить сейчас** или вызовите политику непосредственно из зарегистрированного приложения.

### <a name="add-azure-active-directory-as-an-identity-provider"></a>Добавление Azure Active Directory в качестве поставщика удостоверений
В базовом файле, который использовался в этом руководстве по началу работы, уже имеется некоторое содержимое, необходимое для добавления других поставщиков удостоверений. Сведения о настройке входа в систему см. в статье [Azure Active Directory B2C. Выполнение входа с помощью учетных записей Azure AD](active-directory-b2c-setup-aad-custom.md).

Обзор настраиваемых политик в Azure AD B2C, использующих инфраструктуру процедур идентификации, см. в статье [Azure Active Directory B2C: пользовательские политики](active-directory-b2c-overview-custom.md). 

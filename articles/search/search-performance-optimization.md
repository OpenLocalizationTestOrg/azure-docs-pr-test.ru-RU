---
title: "Рекомендации по производительности и оптимизации службы поиска Azure | Документация Майкрософт"
description: "Настройка производительности Поиска Azure и выбор оптимального масштаба"
services: search
documentationcenter: 
author: LiamCavanagh
manager: pablocas
editor: 
ms.assetid: 4d3cd864-29d2-4921-be0d-a3f1a819de46
ms.service: search
ms.devlang: rest-api
ms.workload: search
ms.topic: article
ms.tgt_pltfrm: na
ms.date: 05/01/2017
ms.author: liamca
ms.openlocfilehash: f4e371fc16bc57e6963f1ec51c0ea864fa568f0c
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="azure-search-performance-and-optimization-considerations"></a>Рекомендации по производительности и оптимизации Поиска Azure
Эффективный поиск является ключом к успеху многих мобильных и веб-приложений. Быстрый поиск и получение соответствующих результатов влияют на качество обслуживания клиентов как в сфере недвижимости или продаж подержанных автомобилей, так и в сфере интернет-каталогов. Этот документ поможет получить рекомендации по эффективному использованию Поиска Azure, особенно для сложных сценариев с расширенными требованиями к масштабируемости, многоязыковой поддержке или пользовательской модели ранжирования.  Кроме того, в этом документе описаны внутренние механизмы и рассмотрены подходы, которые эффективно работают в реальных клиентских приложениях.

## <a name="performance-and-scale-tuning-for-search-services"></a>Настройка производительности и масштабирования для служб поиска
Мы все привыкли к таким поисковым системам, как Bing и Google, и к тому, как быстро они работают.  В результате, когда клиенты используют ваше мобильное или веб-приложение с функцией поиска, они ожидают подобных характеристик производительности.  При оптимизации производительности поиска один из оптимальных способов — сосредоточиться на задержке, то есть времени, необходимом для выполнения запроса и возвращения результатов.  При оптимизации задержки при поиске важно следующее.

1. Выберите целевую задержку (или максимальное количество времени), которая типична для выполнения запроса на поиск.
2. Создайте и протестируйте реальную рабочую нагрузку на своей службе поиска, используя правдоподобный набор данных, чтобы измерить эти показатели задержки.
3. Начните с небольшого количества запросов в секунду (QPS) и увеличивайте это значение по мере выполнения теста, пока задержка при обработке запросов не превысит определенное целевое значение.  Это важный тест производительности, который поможет спланировать масштабирование приложения по мере того, как оно будет охватывать все больше пользователей.
4. По возможности повторно используйте подключения HTTP.  Если используется пакет SDK для Поиска Azure для .NET, то это означает, что следует повторно использовать экземпляр или экземпляр [SearchIndexClient](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.searchindexclient) , а если используется REST API, то следует использовать один HttpClient.

При создании этих тестовых рабочих нагрузок следует помнить о некоторых характеристиках Поиска Azure.

1. Можно отправить так много поисковых запросов за один раз, что ресурсы, доступные в службе Поиска Azure, окажутся перегружены.  В этом случае вы увидите коды ответов HTTP 503.  По этой причине лучше начать с разных диапазонов запросов на поиск, чтобы наблюдать за разницей в задержке по мере добавления запросов на поиск.
2. Передача содержимого в Поиск Azure повлияет на общую производительность и задержки службы Поиска Azure.  Если вы собираетесь отправлять данные во время выполнения поиска пользователями, то важно учесть эту рабочую нагрузку в тестах.
3. Не все поисковые запросы будут выполняться с одинаковым уровнем производительности.  Например, поиск документа или предложение по поиску обычно будет выполняться быстрее, чем запрос со значительным количеством аспектов и фильтров.  При создании тестов лучше добавить различные запросы, которые вы хотите учесть.  
4. Варьирование запросов на поиск важно, так как если постоянно выполнять одинаковые запросы на поиск, то кэширование данных создаст впечатление более высокой производительности, чем было бы при более разнообразных запросах.

> [!NOTE]
> [Нагрузочное тестирование Visual Studio](https://www.visualstudio.com/docs/test/performance-testing/run-performance-tests-app-before-release) — очень удобный способ измерять производительность, так как оно позволяет выполнять HTTP-запросы точно так же, как выполняются запросы к Поиску Azure, и обеспечивает их параллельную обработку.
> 
> 

## <a name="scaling-azure-search-for-high-query-rates-and-throttled-requests"></a>Масштабирование Поиска Azure для обработки высокой частоты запросов и регулируемых запросов
Если поступает слишком много отрегулированных запросов или превышается целевая задержка из-за повышенной нагрузки запросов, то можно уменьшить задержки одним из двух способов.

1. **Увеличьте число реплик**. Реплика — это как копия ваших данных, позволяющая Поиску Azure балансировать нагрузку запросов, распределяя их между несколькими копиями.  Всеми операциями балансировки нагрузки и репликации данных между репликами управляет Поиск Azure, и в любое время можно изменить число реплик, выделенных для вашей службы.  Можно выделить до 12 реплик для службы поиска уровня "Стандартный" и до 3 реплик для службы поиска уровня "Базовый". Реплики можно изменить на [портале Azure](search-create-service-portal.md) или в [PowerShell](search-manage-powershell.md).
2. **Повысьте уровень поиска**. Поиск Azure поставляется на [нескольких уровнях](https://azure.microsoft.com/pricing/details/search/), и каждый из них предлагает различные уровни производительности.  В некоторых случаях число запросов может превысить возможности текущего уровня, приводя к недопустимо высоким задержкам даже при максимальном числе реплик.  В этом случае можно воспользоваться одним из более высоких уровней Поиска Azure, например уровнем S3, который хорошо подходит для сценариев с большим количеством документов и чрезвычайно высокими рабочими нагрузками запросов.

## <a name="scaling-azure-search-for-slow-individual-queries"></a>Масштабирование Поиска Azure для медленных отдельных запросов
Еще одна возможная причина высоких задержек — слишком долгое выполнение какого-либо одного запроса.  В этом случае добавление реплик не понизит задержки.  Доступны два варианта.

1. **Увеличьте число секций**. Секция представляет собой механизм разделения данных между дополнительными ресурсами.  Поэтому при добавлении второй секции данные делятся на две части.  Третья секция разделит ваш индекс на три и т. д.  В некоторых случаях это также позволит ускорить выполнение медленных запросов за счет распараллеливания вычислений.  Существует ряд примеров, в которых распараллеливание было чрезвычайно эффективно при выполнении запросов, содержащих запросы с низкой селективностью.  К ним относятся запросы, которые выбирают большое число документов, или запросы, аспекты которых должны выдавать большое количество документов.  Так как для оценки релевантности документов или подсчета их количества требуется большой объем вычислений, добавление секций позволяет получить дополнительные вычислительные ресурсы.  
   
   Для службы поиска уровня "Стандартный" можно использовать до 12 секций, а для службы поиска уровня "Базовый" — только 1 секцию.  Секции можно изменить на [портале Azure](search-create-service-portal.md) или в [PowerShell](search-manage-powershell.md).
2. **Ограничьте число полей с высокой кратностью**. К полям с высокой кратностью относятся поля, поддерживающие применение аспектов и фильтров, которые имеют значительное количество уникальных значений и поэтому требуют большого числа вычислительных ресурсов для вычисления результатов.   Например, если указать поле "Код продукта" или "Описание" как поддерживающее аспекты или фильтры, оно станет полем с высокой кратностью, так как большинство его значений между документами является уникальным. По возможности ограничивайте число полей с высокой кратностью.
3. **Повысьте уровень службы поиска**. Переход на более высокий уровень Поиска Azure также может повысить скорость обработки медленно выполняемых запросов.  Более высокий уровень также предоставляет более быстрые процессоры и больше памяти, что может положительно повлиять на производительность запросов.

## <a name="scaling-for-availability"></a>Масштабирование для обеспечения доступности
Реплики не только уменьшают задержки при обработке запросов, но и могут обеспечить высокий уровень доступности.  При использовании одной реплики следует ожидать периодических простоев из-за перезагрузки сервера после обновления программного обеспечения или других операций технического обслуживания.  Поэтому важно определить, требуется ли приложению высокий уровень доступности операций поиска (запросов) и записи (событий индексирования).  Поиск Azure предлагает различные варианты соглашения об уровне обслуживания для всех платных предложений поиска со следующими атрибутами:

* 2 реплики для обеспечения высокой доступности рабочих нагрузок для чтения (запросов).
* 3 или более реплики для обеспечения высокой доступности рабочих нагрузок чтения и записи (запросов и индексирования).

Дополнительные сведения об этом см. в [соглашении об уровне обслуживания для Поиска Azure](https://azure.microsoft.com/support/legal/sla/search/v1_0/).

Так как реплики — это копии ваших данных, то наличие нескольких реплик позволяет Поиску Azure перезагружать виртуальные машины или компьютеры и осуществлять их обслуживание для одной реплики, обеспечивая выполнение запросов к другим репликам.  Поэтому необходимо также рассмотреть, как эти простои могут повлиять на запросы, для выполнения которых теперь доступно на одну копию данных меньше.

## <a name="scaling-geo-distributed-workloads-and-provide-geo-redundancy"></a>Масштабирование геораспределенных рабочих нагрузок и обеспечение геоизбыточности
При геораспределенных рабочих нагрузках вы увидите, что у пользователей, которые расположены далеко от центра обработки данных, где размещается служба Поиска Azure, выше значения задержки.  По этой причине важно иметь несколько служб поиска в регионах, близких к этим пользователям.  В настоящее время Поиск Azure не предоставляет автоматический метод георепликации индексов Поиска Azure между регионами, но доступны некоторые методы, с помощью которых легко реализовать этот процесс и управлять им. Они описаны в нескольких следующих разделах.

Цель геораспределенного набора служб поиска — предоставить два или больше индексов, доступных в двух или больше регионах, в которые пользователь будет перенаправлен к службе Поиска Azure, обеспечивающей наименьшую задержку, как показано в этом примере.

   ![Перекрестные запросы к службам по региону][1]

### <a name="keeping-data-in-sync-across-multiple-azure-search-services"></a>Синхронизация данных между несколькими службами Поиска Azure
Существует два варианта обеспечить синхронизацию распределенных служб поиска: использовать [индексатор Поиска Azure](search-indexer-overview.md) или API Push (также называемый [REST API Поиска Azure](https://docs.microsoft.com/rest/api/searchservice/)).  

### <a name="azure-search-indexers"></a>Индексаторы Поиска Azure
При использовании индексатора поиска Azure выполняется импорт изменений данных из центрального хранилища данных, такого как база данных SQL Azure или Azure Cosmos DB. При создании новой службы поиска можно просто создать новый индексатор Поиска Azure для нее, который указывает на то же хранилище данных. В этом случае при каждом поступлении новых изменений в хранилище данных они будут индексироваться различными индексаторами.  

Ниже приведен пример этой архитектуры.

   ![Один источник данных с сочетаниями распределенного индексатора и службы][2]

### <a name="push-api"></a>API Push
При использовании API Push службы поиска Azure для [обновления содержимого в индексе Поиска Azure](https://docs.microsoft.com/rest/api/searchservice/update-index)можно обеспечить синхронизацию различных служб поиска, отправляя изменения во все службы поиска всякий раз, когда требуется обновление.  При этом важно предусмотреть обработку случаев, когда происходит сбой обновления одной службы поиска, но успешно выполнено одно или несколько обновлений.

## <a name="leveraging-azure-traffic-manager"></a>Использование диспетчера трафика Azure
[Диспетчер трафика Azure](../traffic-manager/traffic-manager-overview.md) позволяет перенаправлять запросы на несколько расположенных в разных географических регионах веб-сайтов, которые поддерживаются несколькими службами Поиска Azure.  Одним из преимуществ диспетчера трафика является то, что он может проверять доступность Поиска Azure и направлять пользователей к альтернативным службам поиска в случае сбоя.  Кроме того, если маршрутизация запросов на поиск осуществляется через веб-сайты Azure, то диспетчер трафика Azure позволяет балансировать нагрузку в случаях, когда веб-сайт работает, а Поиск Azure — нет.  Ниже приведен пример архитектуры, использующей диспетчер трафика.

   ![Перекрестные запросы к службам по региону с использованием диспетчера трафика][3]

## <a name="monitoring-performance"></a>Мониторинг производительности
Поиск Azure предлагает возможность анализа и мониторинга производительности службы с помощью [аналитики поискового трафика (STA)](search-traffic-analytics.md). С помощью службы STA можно дополнительно вести журнал отдельных операций поиска, а также объединенных метрик в учетной записи хранения Azure, который затем можно обработать для анализа или визуализации в Power BI.  С помощью метрик STA можно просмотреть статистику производительности, например среднее количество запросов или время ответа на запрос.  Кроме того, ведение журнала операций позволяет детализировать сведения об операциях поиска.

STA является ценным инструментом, позволяющим понять причину задержек с точки зрения Поиска Azure.  Так как метрики производительности запросов, регистрируемые в журнале, основаны на времени полного выполнения запроса в Поиске Azure (с момента поступления запроса до его отправки обратно), вы можете использовать их, чтобы определить источник проблем, порождающих задержки. Это могут быть задержки из-за службы Поиска Azure или, например, задержки сети.  

## <a name="next-steps"></a>Дальнейшие действия
Чтобы больше узнать о ценовых категориях и лимитах служб, ознакомьтесь с разделом [Ограничения поиска Azure](search-limits-quotas-capacity.md).

Статья [Планирование ресурсов](search-capacity-planning.md) поможет больше узнать о различных сочетаниях секций и реплик.

Чтобы более детально ознакомиться с производительностью и увидеть, как можно реализовать оптимизации, описанные в этой статье, посмотрите следующее видео.

> [!VIDEO https://channel9.msdn.com/Events/Microsoft-Azure/AzureCon-2015/ACON319/player]
> 
> 

<!--Image references-->
[1]: ./media/search-performance-optimization/geo-redundancy.png
[2]: ./media/search-performance-optimization/scale-indexers.png
[3]: ./media/search-performance-optimization/geo-search-traffic-mgr.png

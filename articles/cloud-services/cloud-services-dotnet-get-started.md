---
title: "Начало работы с облачными службами Azure и ASP.NET | Документация Майкрософт"
description: "Узнайте, как можно создать многоуровневое приложение с помощью ASP.NET MVC и Azure. Такое приложение выполняется в облачной службе и обладает веб-ролью и рабочей ролью. В его работе используются: Entity Framework, база данных SQL, очереди и BLOB-объекты службы хранилища Azure."
services: cloud-services, storage
documentationcenter: .net
author: Thraka
manager: timlt
editor: 
ms.assetid: d7aa440d-af4a-4f80-b804-cc46178df4f9
ms.service: cloud-services
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: dotnet
ms.topic: hero-article
ms.date: 05/15/2017
ms.author: adegeo
ms.openlocfilehash: f0cdafdb88604b8874a245751246d219e8df3813
ms.sourcegitcommit: afc78e4fdef08e4ef75e3456fdfe3709d3c3680b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/16/2017
---
# <a name="get-started-with-azure-cloud-services-and-aspnet"></a>Начало работы с облачными службами Azure и ASP.NET

## <a name="overview"></a>Обзор
Это руководство описывает, как создавать многоуровневое приложение .NET с внешним ASP.NET MVC и как развернуть его в [облачной службе Azure](cloud-services-choose-me.md). Приложение использует [базу данных Azure SQL](http://msdn.microsoft.com/library/azure/ee336279), [службу BLOB-объектов Azure](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage) и [службу очередей Azure](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern). Можно [загрузить проект Visual Studio](http://code.msdn.microsoft.com/Simple-Azure-Cloud-Service-e01df2e4) из галереи кода MSDN.

В руководстве показано, как строить и запускать приложение локально, как разворачивать его в Azure и запускать в облаке и как создавать его с нуля. Можно начать с построения с нуля и затем выполнить шаги по тестированию и развертыванию по желанию.

## <a name="contoso-ads-application"></a>Приложение Contoso Ads
Приложение представляет собой рекламную доску объявлений. Пользователи создают рекламу, вводя текст и загружая изображения. Они могут видеть список рекламы по эскизам изображений, и они могут видеть изображения в полном размере, когда выбирают рекламу для просмотра деталей.

![Список рекламы](./media/cloud-services-dotnet-get-started/list.png)

Приложение использует [рабочий шаблон на основе очередей](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern) для разгрузки процессора от задач создания эскизов в фоновом режиме.

## <a name="alternative-architecture-websites-and-webjobs"></a>Альтернативная архитектура: веб-сайты и веб-задания
Это руководство описывает, как запускать фоновые и интерфейсные компоненты в облачной службе Azure. Альтернативой является запуск интерфейсного компонента на [веб-сайте Azure](/services/web-sites/) и использование [веб-заданий](http://go.microsoft.com/fwlink/?LinkId=390226) (пока предварительной версии) для фонового компонента. Руководство по веб-заданиям см. в статье [Создание веб-задания .NET в службе приложений Azure](https://github.com/Azure/azure-webjobs-sdk/wiki). Сведения о том, как выбрать службы, см. в статье о [сравнении веб-сайтов, облачных служб и виртуальных машин Azure](../app-service/choose-web-site-cloud-service-vm.md).

## <a name="what-youll-learn"></a>Что вы узнаете
* Как подготовить компьютер к разработке для Azure путем установки пакета Azure SDK.
* Как создать облачный проект Visual Studio с веб-ролью ASP.NET MVC и рабочей ролью ASP.NET MVC.
* Как тестировать локально проект облачной службы, используя эмулятор хранилища Azure.
* Как опубликовать облачный проект в облачной службе Azure и тестировать его с использованием учетной записи хранилища Azure.
* Как отправлять файлы и хранить их в службе BLOB-объектов Azure.
* Как использовать службу очередей Azure для связи между уровнями.

## <a name="prerequisites"></a>Предварительные требования
В руководстве предполагается, что вы понимаете [базовые концепции облачной службы Azure](cloud-services-choose-me.md), такие как термины *веб-роль* и *рабочая роль*.  Кроме того, предполагается, что вы знаете, как работать с проектами [ASP.NET MVC](http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started) или [веб-форм](http://www.asp.net/web-forms/tutorials/aspnet-45/getting-started-with-aspnet-45-web-forms/introduction-and-overview) в Visual Studio. Пример приложения использует MVC, но многое в руководство также применимо к веб-формам.

Вы можете запускать приложение локально без подписки Azure, но она понадобится для развертывания приложения в облаке. Если у вас нет учетной записи, можно [активировать преимущества для подписчиков MSDN](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A55E3C668) или [подписаться на бесплатную пробную версию](https://azure.microsoft.com/pricing/free-trial/?WT.mc_id=A55E3C668).

Инструкции руководства применимы со следующими продуктами:

* Visual Studio 2013
* Visual Studio 2015
* Visual Studio 2017

Если у вас нет ни одного из этих продуктов, Visual Studio может быть установлен автоматически при установке пакета SDK для Azure.

## <a name="application-architecture"></a>Архитектура приложения
Приложение хранит рекламу в базе данных SQL, используя Entity Framework Code First для создания таблиц и доступа к данным. Для каждого рекламного объявления база данных хранит два URL-адреса: один для полноразмерного изображения, другой для эскиза.

![Таблица рекламы](./media/cloud-services-dotnet-get-started/adtable.png)

Когда пользователь отправляет изображение, внешнее приложение, работающее в веб-роли, сохраняет его в [большой двоичный объект Azure](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/unstructured-blob-storage), а информацию о рекламе с URL-адресом, который указывает на большой двоичный объект, — в базе данных. В это же время оно записывает сообщение в очередь Azure. Фоновый процесс, работающий в рабочей роли, периодически опрашивает очередь о новых сообщениях. Когда появляется новое сообщение, рабочая роль создает эскиз для изображения и обновляет поле базы данных с URL-адресом эскиза для этой рекламы. На схеме ниже показано, как взаимодействуют части приложения.

![Архитектура Contoso Ads](./media/cloud-services-dotnet-get-started/apparchitecture.png)

[!INCLUDE [install-sdk](../../includes/install-sdk-2017-2015-2013.md)]

## <a name="download-and-run-the-completed-solution"></a>Загрузка и запуск готового решения
1. Загрузите и распакуйте [готовое решение](http://code.msdn.microsoft.com/Simple-Azure-Cloud-Service-e01df2e4).
2. Запустите Visual Studio.
3. В меню **Файл** выберите **Открыть проект**, перейдите к папке, куда вы скачали решение, а затем откройте файл решения.
4. Чтобы построить решение, нажмите CTRL+SHIFT+B.

    По умолчанию Visual Studio автоматически восстанавливает содержимое пакета NuGet, которое не включено в *ZIP*-файл. Если пакеты не восстановлены, установите их вручную, перейдя к диалоговому окну **Управление пакетами NuGet** для решения и нажав кнопку **Восстановить** вверху справа.
5. В **обозревателе решений** в качестве запускаемого проекта должен быть выбран **ContosoAdsCloudService**.
6. Если вы используете Visual Studio 2015 или более поздней версии, измените строку подключения SQL Server в файле приложения *Web.config* в проекте ContosoAdsWeb и в файле *ServiceConfiguration.Local.cscfg* проекта ContosoAdsCloudService. В каждом файле измените (localdb)\v11.0 на (localdb)\MSSQLLocalDB.
7. Для запуска приложения нажмите сочетание клавиш CTRL+F5.

    Когда запускаете локально проект облачной службы, Visual Studio автоматически вызывает *эмулятор вычислений* Azure и *эмулятор хранилища* Azure. Эмулятор хранилища использует ресурсы компьютера для эмуляции сред рабочей и веб-ролей. Эмулятор хранилища использует базу данных [SQL Server Express LocalDB](http://msdn.microsoft.com/library/hh510202.aspx) для эмуляции работы хранилища Azure в облаке.

    При первом запуске проекта облачной службы, запуск эмулятора займет порядка одной минуты. После завершения работы эмулятора стандартный браузер открывается с домашней страницей приложения.

    ![Архитектура Contoso Ads](./media/cloud-services-dotnet-get-started/home.png)
8. Нажмите кнопку **Create an Ad** (Создать приложение AD).
9. Введите тестовые данные, выберите файл изображения с расширением *.jpg* , предназначенный для загрузки, и нажмите **Создать**.

    ![Страница создания](./media/cloud-services-dotnet-get-started/create.png)

    Приложение переходит к странице индексации, но не показывает эскиз для новой рекламы, поскольку индексирование еще не проводилось.
10. Подождите немного и затем обновите страницу индексации, чтобы увидеть эскиз.

     ![Страница индексации](./media/cloud-services-dotnet-get-started/list.png)
11. Щелкните **Details** , чтобы увидеть рекламу в полный размер.

     ![Страница сведений](./media/cloud-services-dotnet-get-started/details.png)

Приложение запущено полностью локально, без соединения с облаком. Эмулятор хранилища сохраняет очередь и данные большого двоичного объекта в базе данных SQL Server Express LocalDB, и приложение хранит данные рекламы в другой базе данных LocalDB. Entity Framework Code First автоматически создает базу данных рекламы в первый раз при обращении приложения к ней.

В следующем разделе будет настроено решение для использования ресурсов облака Azure для очередей, больших двоичных объектов и базы данных приложения, когда оно работает в облаке. При желании можно запускать приложение локально и далее, но можно делать это, используя облачные ресурсы хранилища и базы данных. Все зависит только от задания строк подключения, что показано далее.

## <a name="deploy-the-application-to-azure"></a>Развертывание приложения в Azure
Чтобы запустить приложение в облаке, выполните следующие действия:

* Создайте облачную службу Azure.
* Создайте базу данных SQL Azure.
* Создайте учетную запись хранения Azure.
* Настройте приложение для использования базы данных SQL Azure, когда оно работает в облаке Azure.
* Настройте приложение на использование вашей учетной записи хранения при запуске в Azure.
* Разверните проект в облачной службе Azure.

### <a name="create-an-azure-cloud-service"></a>Создание облачной службы Azure
Облачная служба Azure — это среда, в которой запускают приложение.

1. В браузере откройте [портал Azure](https://portal.azure.com).
2. Щелкните **Создать > Вычисления > Облачная служба**.

3. В поле ввода DNS-имени введите префикс URL-адреса для облачной службы.

    Этот URL-адрес должен быть уникальным.  Если выбранный префикс уже используется, появится сообщение об ошибке.
4. Укажите новую группу ресурсов для службы. Щелкните **Создать**, а затем введите имя группы ресурсов в поле ввода, например CS_contososadsRG.

5. Задайте регион, в котором требуется развернуть приложение.

    В этом поле указывается в каком центре обработки данных будет размещаться облачная служба. В рабочем приложении следует выбрать регион, ближайший к заказчикам. Выберите здесь ближайший к вам регион.
5. Щелкните **Создать**.

    На следующем рисунке показано, как создается облачная служба с использованием URL-адреса CSvccontosoads.cloudapp.net.

    ![Новая облачная служба](./media/cloud-services-dotnet-get-started/newcs.png)

### <a name="create-an-azure-sql-database"></a>Создание базы данных SQL Azure
Когда приложение запускается в облаке, оно использует расположенную в облаке базу данных.

1. На [портале Azure](https://portal.azure.com) щелкните **Создать > Базы данных > База данных SQL**.
2. В поле **Имя базы данных** введите *contosoads*.
3. В разделе **Группа ресурсов** щелкните **Использовать существующий** и выберите группу ресурсов, используемую для облачной службы.
4. Щелкните **Сервер —Настроить обязательные параметры** и **Создать сервер**, как показано на следующем рисунке.

    ![Туннель к серверу базы данных](./media/cloud-services-dotnet-get-started/newdb.png)

    Если в подписке уже есть сервер, можно выбрать его в раскрывающемся списке.
5. В поле **Имя сервера** введите *csvccontosodbserver*.

6. Введите **имя для входа в систему** и **пароль администратора**.

    Если вы выбрали **Создать сервер**, не используйте имеющиеся имя и пароль. Введите новые имя и пароль, которые в дальнейшем будут использоваться при обращении к базе данных. Если выбран созданный ранее сервер, появится запрос на ввод пароля для ранее созданной административной учетной записи.
7. Выберите то же **расположение**, что и для облачной службы.

    Когда облачная служба и база данных находятся в разных центрах обработки данных (различных регионах), увеличивается задержка и вам потребуется оплачивать пропускную способность за пределами центра обработки данных. Пропускная способность в рамках центра обработки данных предоставляется бесплатно.
8. Проверьте **Разрешить службам Azure доступ к серверу**.
9. Нажмите кнопку **Выбрать** для нового сервера.

    ![Новый сервер базы данных SQL](./media/cloud-services-dotnet-get-started/newdbserver.png)
10. Щелкните **Создать**.

### <a name="create-an-azure-storage-account"></a>Создание учетной записи хранения Azure
Учетная запись хранилища Azure обеспечивает ресурсы для хранения данных очередей и больших двоичных объектов в облаке.

В реальном приложении обычно создают отдельные учетные записи для данных приложения и данных журналов, а также отдельные учетные записи для тестовых данных и рабочих данных. В этом руководстве будет использоваться одна учетная запись.

1. На [портале Azure](https://portal.azure.com) щелкните **Создать > Хранилище > Учетная запись хранения — большой двоичный объект, файл, таблица, очередь**.
2. В поле ввода **Имя** введите префикс URL-адреса.

    Этот префикс в сочетании с текстом, который отображается под полем, будет уникальным URL-адресом для вашей учетной записи хранения. Если введенный префикс уже использован где-либо, придется выбрать другой.
3. Задайте *классическую* **модель развертывания**.

4. В раскрывающемся списке **Репликация** установите значение **Locally redundant storage** (Локально избыточное хранилище).

    При включении георепликации для учетной записи хранения хранящиеся данные реплицируются в дополнительный центр обработки данных для обеспечения возможности отработки отказа в случае крупной аварии в основном расположении. Георепликация может потребовать дополнительных затрат. Для учетных записей тестирования и разработки оплачивать георепликацию обычно не требуется. Дополнительные сведения см. в статье [Об учетных записях хранения Azure](../storage/common/storage-create-storage-account.md).

5. В разделе **Группа ресурсов** щелкните **Использовать существующий** и выберите группу ресурсов, используемую для облачной службы.
6. В раскрывающемся списке **Расположение** выберите тот же регион, который выбрали для облачной службы.

    Когда облачная служба и учетная запись хранения находятся в разных центрах обработки данных (различных областях), увеличивается задержка и вам потребуется оплачивать пропускную способность за пределами центра обработки данных. Пропускная способность в рамках центра обработки данных предоставляется бесплатно.

    Территориальные группы Azure обеспечивают механизм для минимизации расстояния между ресурсами в центре обработки данных, что позволяет уменьшить задержку. В этом учебнике территориальные группы не используются. Дополнительные сведения см. в разделе о [создании территориальной группы в Azure](http://msdn.microsoft.com/library/jj156209.aspx).
7. Щелкните **Создать**.

    ![Новая учетная запись хранения](./media/cloud-services-dotnet-get-started/newstorage.png)

    На следующем рисунке показано создание учетной записи хранилища с URL-адресом `csvccontosoads.core.windows.net`.

### <a name="configure-the-solution-to-use-your-azure-sql-database-when-it-runs-in-azure"></a>Настройка приложения для использования базы данных SQL Azure, когда оно работает в облаке Azure
Веб-проект и проект рабочей роли имеют свои строки подключения к базе данных, и обе они должны указывать на базу данных SQL Azure, когда приложение работает в Azure.

Мы используем [преобразование Web.config](http://www.asp.net/mvc/tutorials/deployment/visual-studio-web-deployment/web-config-transformations) для веб-роли и настройку среды облачной службы для рабочей роли.

> [!NOTE]
> В этом и следующем разделах учетные данные будут сохранены в файлах проектов. [Не сохраняйте важные данные в общедоступном репозитории исходного кода](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control#secrets).
>
>

1. В проекте ContosoAdsWeb откройте файл преобразования *Web.Release.config* для файла приложения *Web.config*, удалите блок комментариев, содержащий элемент `<connectionStrings>`, и вставьте вместо него следующий код.

    ```xml
    <connectionStrings>
        <add name="ContosoAdsContext" connectionString="{connectionstring}"
        providerName="System.Data.SqlClient" xdt:Transform="SetAttributes" xdt:Locator="Match(name)"/>
    </connectionStrings>
    ```

    Оставьте файл открытым для редактирования.
2. На [портале Azure](https://portal.azure.com) в области слева щелкните **Базы данных SQL**, выберите базу данных, созданную для этого руководства, а затем щелкните **Показать строки подключения**.

    ![Показать строки подключения](./media/cloud-services-dotnet-get-started/showcs.png)

    Портал выведет строки подключения со звездочками вместо пароля.

    ![Строки подключения](./media/cloud-services-dotnet-get-started/connstrings.png)
3. В файле преобразования *Web.Release.config* удалите `{connectionstring}` и вставьте на это место строку подключения ADO.NET с портала Azure.
4. В строке подключения, вставленной в файл преобразования *Web.Release.config*, замените `{your_password_here}` паролем, созданным для новой базы данных SQL.
5. Сохраните файл.  
6. Выберите и скопируйте строку подключения (без знаков кавычек) для использования на следующих шагах настройки проекта с рабочей ролью.
7. В **обозревателе решений** в разделе **Роли** в проекте облачной службы щелкните правой кнопкой мыши пункт **ContosoAdsWorker** и выберите **Свойства**.

    ![Свойства роли](./media/cloud-services-dotnet-get-started/rolepropertiesworker.png)
8. Перейдите на вкладку **Параметры** .
9. В раскрывающемся списке **Конфигурация службы** выберите значение **Облако**.
10. Выберите поле **Значение** для параметра `ContosoAdsDbConnectionString` и вставьте строку подключения, которую скопировали в предыдущем разделе руководства.

     ![Строка подключения базы данных для рабочей роли](./media/cloud-services-dotnet-get-started/workerdbcs.png)
11. Сохраните изменения.  

### <a name="configure-the-solution-to-use-your-azure-storage-account-when-it-runs-in-azure"></a>Настройка приложения для использования вашей учетной записи хранения при запуске в Azure
Строки подключения учетной записи хранения Azure для проектов рабочей роли и веб-роли сохраняются в настройках среды в проекте облачной службы. Для каждого проекта используется отдельный набор настроек, если приложение запущено локально или в облаке. Следует обновить настройки облачной среды для проектов рабочей роли и веб-роли.

1. В **обозревателе решений** щелкните правой кнопкой мыши пункт **ContosoAdsWeb** в области **Роли** проекта **ContosoAdsCloudService**, а затем выберите **Свойства**.

    ![Свойства роли](./media/cloud-services-dotnet-get-started/roleproperties.png)
2. Перейдите на вкладку **Параметры** . В раскрывающемся списке **Конфигурация службы** выберите значение **Облако**.

    ![Конфигурация облака](./media/cloud-services-dotnet-get-started/sccloud.png)
3. Выберите запись **StorageConnectionString**, и вы увидите кнопку с многоточием (**...**) в правом конце строки. Нажмите эту кнопку с многоточием, чтобы открыть диалоговое окно **Создание строки подключения учетной записи хранения** .

    ![Откройте окно создания строки подключения](./media/cloud-services-dotnet-get-started/opencscreate.png)
4. В диалоговом окне **Создание строки подключения к хранилищу** установите переключатель **Ваша подписка**, выберите учетную запись хранения, созданную ранее, и нажмите кнопку **ОК**. Если вы еще не вошли, появится запрос на ввод учетных данных учетной записи Azure.

    ![Создайте строку подключения хранилища](./media/cloud-services-dotnet-get-started/createstoragecs.png)
5. Сохраните изменения.
6. Следуйте той же процедуре, которую использовали для строки подключения `StorageConnectionString`, чтобы задать строку подключения `Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString`.

    Эта строка подключения используется для журнала.
7. Выполните ту же процедуру, которую использовали для роли **ContosoAdsWeb**, чтобы задать строки подключения для роли **ContosoAdsWorker**. В раскрывающемся списке **Конфигурация службы** выберите значение **Облако**.

Настройки среды роли, которые были заданы с использованием интерфейса Visual Studio, сохраняются в следующих файлах в проекте ContosoAdsCloudService:

* *ServiceDefinition.csdef* - определяет имена настроек.
* *ServiceConfiguration.Cloud.cscfg* - предоставляет значения для приложения при запуске в облаке.
* *ServiceConfiguration.Cloud.cscfg* - предоставляет значения для приложения при локальном запуске.

Например, ServiceDefinition.csdef включает следующие определения:

```xml
<ConfigurationSettings>
    <Setting name="StorageConnectionString" />
    <Setting name="ContosoAdsDbConnectionString" />
</ConfigurationSettings>
```

Файл *ServiceConfiguration.Cloud.cscfg* включает значения, которые были введены для этих настроек в Visual Studio:

```xml
<Role name="ContosoAdsWorker">
    <Instances count="1" />
    <ConfigurationSettings>
        <Setting name="StorageConnectionString" value="{yourconnectionstring}" />
        <Setting name="ContosoAdsDbConnectionString" value="{yourconnectionstring}" />
        <!-- other settings not shown -->

    </ConfigurationSettings>
    <!-- other settings not shown -->

</Role>
```

Параметр `<Instances>` указывает число виртуальных машин, на которых Azure будет запускать код рабочий роли. В раздел [Дальнейшие действия](#next-steps) включены ссылки на дополнительную информацию о горизонтальном масштабировании облачной службы.

### <a name="deploy-the-project-to-azure"></a>Развертывание проекта в Azure
1. В **обозревателе решений** щелкните правой кнопкой мыши проект **ContosoAdsCloudService** и выберите пункт **Опубликовать**.

   ![Меню публикации](./media/cloud-services-dotnet-get-started/pubmenu.png)
2. На шаге **Вход** мастера **публикации приложений Azure** нажмите кнопку **Далее**.

    ![Этап входа](./media/cloud-services-dotnet-get-started/pubsignin.png)
3. На этапе **Настройки** мастера нажмите кнопку **Далее**.

    ![Этап настроек](./media/cloud-services-dotnet-get-started/pubsettings.png)

    Заданные на вкладке **Дополнительно** значения по умолчанию подходят для работы с этим руководством. Дополнительные сведения о вкладке "Дополнительно" см. в разделе о [мастере публикации приложения Azure](http://msdn.microsoft.com/library/hh535756.aspx).
4. На этапе **Сводка** щелкните **Опубликовать**.

    ![Сводка действий](./media/cloud-services-dotnet-get-started/pubsummary.png)

   В Visual Studio открывается окно **Журнал действий Azure** .
5. Нажмите значок со стрелкой вправо, чтобы развернуть сведения о развертывании.

    Развертывание может занять около 5 минут и более.

    ![Окно журнал действий Azure](./media/cloud-services-dotnet-get-started/waal.png)
6. После завершения развертывания щелкните **URL-адрес веб-приложения** для запуска приложения.
7. Теперь можно протестировать приложение, создавая, просматривая и редактируя некоторые элементы рекламы так же, как это происходило при локальном запуске приложения.

> [!NOTE]
> После завершения тестирования удалите или остановите облачную службу. Даже если облачная служба не используется, плата за нее начисляется, поскольку ресурсы виртуальной машины для нее зарезервированы. Если оставить ее работающей, любой кто найдет этот URL-адрес, сможет создать и просмотреть рекламу. На [портале Azure](https://portal.azure.com) перейдите на вкладку **Обзор** для облачной службы, а затем в верхней части страницы щелкните **Удалить**. Если необходимо временно предотвратить доступ посторонних к сайту, вместо этого щелкните **Остановить** . В этом случае плата будет взиматься. Можно повторить эту же процедуру для удаления базы данных SQL и учетной записи хранилища, если они больше не нужны.
>
>

## <a name="create-the-application-from-scratch"></a>Создание приложения с нуля
Если [завершенное приложение](http://code.msdn.microsoft.com/Simple-Azure-Cloud-Service-e01df2e4)еще не загружено, сделайте это сейчас. Скопируйте файлы из загруженного проекта в новый проект.

Создание приложения Contoso Ads состоит из следующих шагов:

* Создайте новое решение облачной службы в Visual Studio.
* Обновите и добавьте пакеты NuGet.
* Указание ссылок на проекты.
* Настройте строки подключения.
* Добавьте файлы кода.

После создания решения просмотрите код, уникальный для проектов облачных служб, больших двоичных объектов и очередей Azure.

### <a name="create-a-cloud-service-visual-studio-solution"></a>Создайте новое решение облачной службы в Visual Studio
1. В Visual Studio выберите **Новый проект** from the **Файл** .
2. В диалоговом окне **Создание проекта** в области слева разверните раздел **Visual C#**, выберите шаблоны **Облако** и шаблон **Облачная служба Azure**.
3. Присвойте проекту имя ContosoAdsCloudService и нажмите кнопку **ОК**.

    ![Новый проект](./media/cloud-services-dotnet-get-started/newproject.png)
4. В диалоговом окне **Новая облачная служба Azure** добавьте веб-роль и рабочую роль. Присвойте веб-роли имя ContosoAdsWeb, а рабочей роли — ContosoAdsWorker. (Используйте значок карандаша на правой панели для изменения имен ролей по умолчанию.)

    ![Проект новой облачной службы](./media/cloud-services-dotnet-get-started/newcsproj.png)
5. Когда появится диалоговое окно **Новый проект ASP.NET** для веб-роли, выберите шаблон MVC и щелкните **Изменить проверку подлинности**.

    ![Изменить проверку подлинности](./media/cloud-services-dotnet-get-started/chgauth.png)
6. В диалоговом окне **Изменение проверки подлинности** щелкните **Без проверки подлинности** и нажмите кнопку **ОК**.

    ![Без аутентификации](./media/cloud-services-dotnet-get-started/noauth.png)
7. В диалоговом окне **Новый проект ASP.NET** нажмите кнопку **ОК**.
8. В **обозревателе решений** щелкните правой кнопкой мыши решение (не проект) и выберите **Добавить новый проект**.
9. В диалоговом окне **Добавить новый проект** выберите **Windows** в разделе **Visual C#** на панели слева, а затем щелкните шаблон **Библиотека классов**.  
10. Присвойте проекту имя *ContosoAdsCommon*и нажмите кнопку **ОК**.

    Необходимо сослаться на контекст и модель данных Entity Framework в обоих проектах — веб-роли и рабочей роли. Как вариант, можно определить связанные с EF классы в проекте веб-роли и сослаться на этот проект из проекта рабочей роли. Но в случае альтернативного метода в проекте рабочей роли будет ссылка на веб-сборки, которые ему не нужны.

### <a name="update-and-add-nuget-packages"></a>Обновите и добавьте пакеты NuGet
1. Откройте диалоговое окно **Управление пакетами NuGet** для решения.
2. В верхней части окна выберите пункт **Обновления**.
3. Найдите пакет *WindowsAzure.Storage* и, если он есть в списке, выберите его и выберите веб-проект и проект рабочей роли для обновления пакета в этих проектах, а затем нажмите кнопку **Обновить**.

    Клиентская библиотека хранилища обновляется чаще, чем шаблоны проектов Visual Studio, поэтому часто происходит так, что версию во вновь создаваемых проектах необходимо обновить.
4. В верхней части окна выберите пункт **Обзор**.
5. Найдите пакет NuGet *EntityFramework* и установите его во все проекты.
6. Найдите пакет NuGet *Microsoft.WindowsAzure.ConfigurationManager* и установите его в проект рабочей роли.

### <a name="set-project-references"></a>Установите ссылки проекта
1. Задайте в проекте ContosoAdsWeb ссылку на проект ContosoAdsCommon. Щелкните правой кнопкой мыши проект ContosoAdsWeb и выберите пункты **Ссылки** - **Добавление ссылок**. В диалоговом окне **Диспетчер ссылок** выберите пункты **Решение — Проекты** на панели слева, щелкните **ContosoAdsCommon**, а затем нажмите кнопку **ОК**.
2. Задайте в проекте ContosoAdsWorker ссылку на проект ContosoAdsCommon.

    ContosoAdsCommon будет содержать модель данных и контекстный класс Entity Framework, который будет использован как фоновой, так и интерфейсной службой.
3. Задайте в проекте ContosoAdsWorker ссылку на `System.Drawing`.

    Сборка используется внутренней службой для преобразования изображений в эскизы.

### <a name="configure-connection-strings"></a>Настройте строки подключения
В этом разделе настройте хранилище Azure и строки подключения SQL для локального тестирования. Инструкции по развертыванию ранее в этом руководстве объясняют, как установить строки подключения в случае, когда приложение работает в облаке.

1. В проекте ContosoAdsWeb откройте файл приложения Web.config и вставьте следующий элемент `connectionStrings` после элемента `configSections`:

    ```xml
    <connectionStrings>
        <add name="ContosoAdsContext" connectionString="Data Source=(localdb)\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;" providerName="System.Data.SqlClient" />
    </connectionStrings>
    ```

    Если вы используете Visual Studio 2015 или более поздней версии, замените v11.0 на MSSQLLocalDB.
2. Сохраните изменения.
3. В проекте ContosoAdsCloudService щелкните правой кнопкой мыши ContosoAdsWeb в разделе **Роли**, а затем выберите **Свойства**.

    ![Свойства роли](./media/cloud-services-dotnet-get-started/roleproperties.png)
4. В окне свойств **ContosAdsWeb [роль]** щелкните вкладку **Настройки** и затем щелкните **Добавить настройку**.

    В раскрывающемся списке **Конфигурация службы** выберите значение **Все конфигурации**.
5. Добавьте настройку с именем *StorageConnectionString*. Задайте для параметра **Тип** значение *ConnectionString*, а для параметра **Значение** — *UseDevelopmentStorage=true*.

    ![Новая строка подключения](./media/cloud-services-dotnet-get-started/scall.png)
6. Сохраните изменения.
7. Следуйте этой же процедуре для добавления строки подключения хранилища в свойства роли ContosoAdsWorker.
8. Там же в окне свойств **ContosoAdsWorker [роль]** добавьте другую строку подключения:

   * Имя: ContosoAdsDbConnectionString
   * Тип: строка
   * Значение. Вставьте ту же строку подключения, которая была использована для проекта веб-роли. (Этот пример предназначен для Visual Studio 2013. Не забудьте изменить источник данных при копировании этого примера для Visual Studio 2015 или более поздней версии.)

       ```
       Data Source=(localdb)\v11.0; Initial Catalog=ContosoAds; Integrated Security=True; MultipleActiveResultSets=True;
       ```

### <a name="add-code-files"></a>Добавьте файлы кода
В этом разделе скопируйте файлы кода из скачанного решения в новое решение. Следующие разделы покажут и объяснят важные части этого кода.

Чтобы добавить файлы в проект или папку, щелкните правой кнопкой мыши проект или папку и щелкните **Добавить** - **Существующий элемент**. Выберите необходимые файлы и щелкните **Добавить**. При запросе о том, заменять ли существующие файлы, щелкните **Да**.

1. В проекте ContosoAdsCommon удалите файл *Class1.cs* и добавьте на его место файлы *Ad.cs* и *ContosoAdscontext.cs* из скачанного проекта.
2. В проекте ContosoAdsCommon добавьте следующие файлы из загруженного проекта.

   * *Global.asax.cs*.  
   * В папку *Views\Shared*: файл *\_Layout.cshtml*.
   * В папку *Views\Home*: файл *Index.cshtml*.
   * В папку *Controllers*: файл *AdController.cs*.
   * В папку *Views\Ad* (сначала создайте эту папку): пять файлов *CSHTML*.
3. В проекте ContosoAdsCommon добавьте *WorkerRole.cs* из загруженного проекта.

Теперь можно создать и запустить приложение, как описывали инструкции ранее в этом руководстве, и приложение будет использовать локальные ресурсы эмуляторов базы данных и хранилища.

В следующих разделах объясняется код, связанный с работой среды Azure, больших двоичных объектов и очередей. В этом учебнике не представлены следующие пошаговые инструкции: "Создание контроллеров и представлений MVC с помощью формирования шаблонов", "Запись кода Entity Framework, который работает с базами данных SQL Server" или "Основы асинхронного программирования в ASP.NET 4.5". Дополнительные сведения см. в следующих статьях:

* [Начало работы с MVC 5](http://www.asp.net/mvc/tutorials/mvc-5/introduction/getting-started)
* [Начало работы с EF 6 и MVC 5](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc)
* [Введение в асинхронное программирование в .NET 4.5](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/web-development-best-practices#async)

### <a name="contosoadscommon---adcs"></a>ContosoAdsCommon - Ad.cs
Файл Ad.cs определяет перечисляемый тип для класса Ad и класс сущностей POCO для информации в рекламе.

```csharp
public enum Category
{
    Cars,
    [Display(Name="Real Estate")]
    RealEstate,
    [Display(Name = "Free Stuff")]
    FreeStuff
}

public class Ad
{
    public int AdId { get; set; }

    [StringLength(100)]
    public string Title { get; set; }

    public int Price { get; set; }

    [StringLength(1000)]
    [DataType(DataType.MultilineText)]
    public string Description { get; set; }

    [StringLength(1000)]
    [DisplayName("Full-size Image")]
    public string ImageURL { get; set; }

    [StringLength(1000)]
    [DisplayName("Thumbnail")]
    public string ThumbnailURL { get; set; }

    [DataType(DataType.Date)]
    [DisplayFormat(DataFormatString = "{0:yyyy-MM-dd}", ApplyFormatInEditMode = true)]
    public DateTime PostedDate { get; set; }

    public Category? Category { get; set; }
    [StringLength(12)]
    public string Phone { get; set; }
}
```

### <a name="contosoadscommon---contosoadscontextcs"></a>ContosoAdsCommon - ContosoAdsContext.cs
Класс ContosoAdsContext указывает, что класс Ad используется коллекцией DbSet, которую Entity Framework хранит в базе данных SQL.

```csharp
public class ContosoAdsContext : DbContext
{
    public ContosoAdsContext() : base("name=ContosoAdsContext")
    {
    }
    public ContosoAdsContext(string connString)
        : base(connString)
    {
    }
    public System.Data.Entity.DbSet<Ad> Ads { get; set; }
}
```

Класс имеет два конструктора. Первый из них используется веб-проектом и указывает имя строки подключения, которая сохранена в файле Web.config Второй конструктор дает возможность передачи действующей строки подключения, которая используется проектом рабочей роли, так как она не имеет файла Web.config. Ранее было показано, где хранится строка подключения, а потом будет показано, как код извлекает строку подключения, когда он создает экземпляр класса DbContext.

### <a name="contosoadsweb---globalasaxcs"></a>ContosoAdsWeb - Global.asax.cs
Код, который вызывается из метода `Application_Start`, создает контейнер больших двоичных объектов *images* и очередь *images*, если они отсутствуют. Это гарантирует, что при начале использования новой учетной записи хранения или эмулятора хранилища на новом компьютере требуемый контейнер больших двоичных объектов и очередь создаются автоматически.

Код получает доступ к учетной записи хранилища, используя строку подключения из файла *.cscfg* .

```csharp
var storageAccount = CloudStorageAccount.Parse
    (RoleEnvironment.GetConfigurationSettingValue("StorageConnectionString"));
```

Затем он получает ссылку на контейнер больших двоичных объектов *images* , создает контейнер, если он еще не существует, и устанавливает разрешения доступа к новому контейнеру. По умолчанию новые контейнеры разрешают доступ к большим двоичным объектам только клиентам с данными учетной записи хранения. Веб-сайту требуются общедоступные большие двоичные объекты, чтобы он мог выводить изображения с использованием URL-адресов, которые указывают на объекты изображений.

```csharp
var blobClient = storageAccount.CreateCloudBlobClient();
var imagesBlobContainer = blobClient.GetContainerReference("images");
if (imagesBlobContainer.CreateIfNotExists())
{
    imagesBlobContainer.SetPermissions(
        new BlobContainerPermissions
        {
            PublicAccess =BlobContainerPublicAccessType.Blob
        });
}
```

Аналогичный код получает ссылку на очередь *images* и создает новую очередь. В этом случае изменения разрешений не требуется.

```csharp
CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient();
var imagesQueue = queueClient.GetQueueReference("images");
imagesQueue.CreateIfNotExists();
```

### <a name="contosoadsweb---layoutcshtml"></a>ContosoAdsWeb — \_Layout.cshtml
Файл *_Layout.cshtml* задает имя приложения в заголовке и нижнем колонтитуле и создает запись меню "Ads".

### <a name="contosoadsweb---viewshomeindexcshtml"></a>ContosoAdsWeb - Views\Home\Index.cshtml
Файл *Views\Home\Index.cshtml* выводит ссылки категорий на домашней странице. Ссылки передают целочисленное значение перечисляемого типа `Category` в переменную querystring на странице индекса Ads.

```razor
<li>@Html.ActionLink("Cars", "Index", "Ad", new { category = (int)Category.Cars }, null)</li>
<li>@Html.ActionLink("Real estate", "Index", "Ad", new { category = (int)Category.RealEstate }, null)</li>
<li>@Html.ActionLink("Free stuff", "Index", "Ad", new { category = (int)Category.FreeStuff }, null)</li>
<li>@Html.ActionLink("All", "Index", "Ad", null, null)</li>
```

### <a name="contosoadsweb---adcontrollercs"></a>ContosoAdsWeb - AdController.cs
В файле *AdController.cs* конструктор вызывает метод `InitializeStorage` для создания объектов клиентской библиотеки службы хранилища Azure, которые предоставляют API-интерфейс для работы с большими двоичными объектами и очередями.

Затем код получает ссылку на контейнер больших двоичных объектов *images*, как показано ранее в *Global.asax.cs*. При этом он устанавливает [политику повторения](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/transient-fault-handling) по умолчанию, подходящую для веб-приложения. Политика повторения с экспоненциальной задержкой по умолчанию может застопорить веб-приложение более чем на минуту при повторяющихся повторах во время кратковременного сбоя. Политика повторения здесь указывает ожидание в три секунды после каждой попытки, всего до трех повторений.

```csharp
var blobClient = storageAccount.CreateCloudBlobClient();
blobClient.DefaultRequestOptions.RetryPolicy = new LinearRetry(TimeSpan.FromSeconds(3), 3);
imagesBlobContainer = blobClient.GetContainerReference("images");
```

Аналогичный код получает ссылку на очередь *images* .

```csharp
CloudQueueClient queueClient = storageAccount.CreateCloudQueueClient();
queueClient.DefaultRequestOptions.RetryPolicy = new LinearRetry(TimeSpan.FromSeconds(3), 3);
imagesQueue = queueClient.GetQueueReference("images");
```

Большая часть кода контроллера обычна для работы с моделью данных Entity Framework с использованием класса DbContext. Исключением является метод `Create` HttpPost, который отправляет файл и сохраняет его в хранилище больших двоичных объектов. Связыватель модели предоставляет объект [HttpPostedFileBase](http://msdn.microsoft.com/library/system.web.httppostedfilebase.aspx) для метода.

```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<ActionResult> Create(
    [Bind(Include = "Title,Price,Description,Category,Phone")] Ad ad,
    HttpPostedFileBase imageFile)
```

При выбора файла для отправки код отправляет его, сохраняет его в большом двоичном объекте и обновляет запись базы данных URL-адресом, который указывает на большой двоичный объект.

```csharp
if (imageFile != null && imageFile.ContentLength != 0)
{
    blob = await UploadAndSaveBlobAsync(imageFile);
    ad.ImageURL = blob.Uri.ToString();
}
```

Код отправки содержится в методе `UploadAndSaveBlobAsync` . Он создает имя GUID для большого двоичного объекта, отправляет и сохраняет файл, а также возвращает ссылку на сохраненный большой двоичный объект.

```csharp
private async Task<CloudBlockBlob> UploadAndSaveBlobAsync(HttpPostedFileBase imageFile)
{
    string blobName = Guid.NewGuid().ToString() + Path.GetExtension(imageFile.FileName);
    CloudBlockBlob imageBlob = imagesBlobContainer.GetBlockBlobReference(blobName);
    using (var fileStream = imageFile.InputStream)
    {
        await imageBlob.UploadFromStreamAsync(fileStream);
    }
    return imageBlob;
}
```

После того как метод HttpPost `Create` загружает большой двоичный объект и обновляет базу данных, он создает сообщение очереди для информирования фонового процесса о том, что изображение готово для преобразования в эскиз.

```csharp
string queueMessageString = ad.AdId.ToString();
var queueMessage = new CloudQueueMessage(queueMessageString);
await queue.AddMessageAsync(queueMessage);
```

Код для метода HttpPost `Edit` аналогичен, за одним исключением — если пользователь выбирает новый файл изображения, все существующие большие двоичные объекты должны быть удалены.

```csharp
if (imageFile != null && imageFile.ContentLength != 0)
{
    await DeleteAdBlobsAsync(ad);
    imageBlob = await UploadAndSaveBlobAsync(imageFile);
    ad.ImageURL = imageBlob.Uri.ToString();
}
```

Ниже представлен пример кода, который удаляет большие двоичные объекты при удалении элемента рекламы.

```csharp
private async Task DeleteAdBlobsAsync(Ad ad)
{
    if (!string.IsNullOrWhiteSpace(ad.ImageURL))
    {
        Uri blobUri = new Uri(ad.ImageURL);
        await DeleteAdBlobAsync(blobUri);
    }
    if (!string.IsNullOrWhiteSpace(ad.ThumbnailURL))
    {
        Uri blobUri = new Uri(ad.ThumbnailURL);
        await DeleteAdBlobAsync(blobUri);
    }
}
private static async Task DeleteAdBlobAsync(Uri blobUri)
{
    string blobName = blobUri.Segments[blobUri.Segments.Length - 1];
    CloudBlockBlob blobToDelete = imagesBlobContainer.GetBlockBlobReference(blobName);
    await blobToDelete.DeleteAsync();
}
```

### <a name="contosoadsweb---viewsadindexcshtml-and-detailscshtml"></a>ContosoAdsWeb - Views\Ad\Index.cshtml и Details.cshtml
Файл *Index.cshtml* выводит эскиз с другими данными рекламы.

```razor
<img src="@Html.Raw(item.ThumbnailURL)" />
```

Файл *Details.cshtml* выводит изображение в полном размере.

```razor
<img src="@Html.Raw(Model.ImageURL)" />
```

### <a name="contosoadsweb---viewsadcreatecshtml-and-editcshtml"></a>ContosoAdsWeb - Views\Ad\Create.cshtml и Edit.cshtml
Файлы *Create.cshtml* и *Edit.cshtml* указывают кодирование формы, которое дает возможность контроллеру получить объект `HttpPostedFileBase`.

```razor
@using (Html.BeginForm("Create", "Ad", FormMethod.Post, new { enctype = "multipart/form-data" }))
```

Элемент `<input>` сообщает браузеру, что нужно открыть диалоговое окно выбора файла.

```razor
<input type="file" name="imageFile" accept="image/*" class="form-control fileupload" />
```

### <a name="contosoadsworker---workerrolecs---onstart-method"></a>ContosoAdsWorker - WorkerRole.cs - метод OnStart
Среда рабочей роли Azure вызывает метод `OnStart` в классе `WorkerRole`, когда рабочая роль начинает работу, и вызывает метод `Run`, когда метод `OnStart` завершает работу.

Метод `OnStart` получает строку подключения к базе данных из *CSCFG-файла* и передает ее в класс Entity Framework DbContext. Поставщик SQLClient используется по умолчанию, поэтому поставщик не нужно указывать.

```csharp
var dbConnString = CloudConfigurationManager.GetSetting("ContosoAdsDbConnectionString");
db = new ContosoAdsContext(dbConnString);
```

Затем метод получит ссылку на учетную запись хранилища и создаст контейнер больших двоичных объектов и очередь, если они не существуют. Этот код аналогичен тому, что показан в методе `Application_Start` веб-роли.

### <a name="contosoadsworker---workerrolecs---run-method"></a>ContosoAdsWorker - WorkerRole.cs - метод Run
Метод `Run` вызывается, когда метод `OnStart` завершает свою начальную работу. Метод выполняет бесконечный цикл, в котором ждет новые сообщения в очереди и обрабатывает их, когда они прибывают.

```csharp
public override void Run()
{
    CloudQueueMessage msg = null;

    while (true)
    {
        try
        {
            msg = this.imagesQueue.GetMessage();
            if (msg != null)
            {
                ProcessQueueMessage(msg);
            }
            else
            {
                System.Threading.Thread.Sleep(1000);
            }
        }
        catch (StorageException e)
        {
            if (msg != null && msg.DequeueCount > 5)
            {
                this.imagesQueue.DeleteMessage(msg);
            }
            System.Threading.Thread.Sleep(5000);
        }
    }
}
```

После каждой итерации цикла, если сообщение найдено в очереди, программа останавливается на секунду. Это защищает рабочую роль от создания ненужных затрат при использовании времени процессора и транзакций в хранилище. Команда Microsoft Customer Advisory рассказывала о разработчике, который забыл включить этот функционал, развернул код в рабочей среде и ушел в отпуск. Когда он вернулся, то выяснил, что забывчивость встала ему в копеечку.

Иногда содержимое сообщения очереди вызывает ошибку при обработке. Это *ядовитое сообщение* — если ошибка только протоколируется и цикл будет перезапущен, то сообщение можно обрабатывать бесконечно.  Поэтому блок catch включает правило if, которое проверяет, сколько раз приложение пыталось обработать текущее сообщение. Если уже насчитано 5 раз, сообщение удаляется из очереди.

`ProcessQueueMessage` вызывается, когда сообщение найдено в очереди.

```csharp
private void ProcessQueueMessage(CloudQueueMessage msg)
{
    var adId = int.Parse(msg.AsString);
    Ad ad = db.Ads.Find(adId);
    if (ad == null)
    {
        throw new Exception(String.Format("AdId {0} not found, can't create thumbnail", adId.ToString()));
    }

    CloudBlockBlob inputBlob = this.imagesBlobContainer.GetBlockBlobReference(ad.ImageURL);

    string thumbnailName = Path.GetFileNameWithoutExtension(inputBlob.Name) + "thumb.jpg";
    CloudBlockBlob outputBlob = this.imagesBlobContainer.GetBlockBlobReference(thumbnailName);

    using (Stream input = inputBlob.OpenRead())
    using (Stream output = outputBlob.OpenWrite())
    {
        ConvertImageToThumbnailJPG(input, output);
        outputBlob.Properties.ContentType = "image/jpeg";
    }

    ad.ThumbnailURL = outputBlob.Uri.ToString();
    db.SaveChanges();

    this.imagesQueue.DeleteMessage(msg);
}
```

Код читает базу данных для получения URL-адреса изображения, конвертирует изображение в эскиз, сохраняет эскиз в большой двоичный объект, добавляет в базу данных URL-адрес большого двоичного объекта эскиза и удаляет сообщение из очереди.

> [!NOTE]
> Для простоты код в методе `ConvertImageToThumbnailJPG` использует классы в пространстве имен System.Drawing. Однако классы в этом пространстве имен были спроектированы для использования с формами Windows. Они не поддерживаются в службе Windows или ASP.NET. Дополнительные сведения о параметрах обработки изображений см. в статьях [Back to Basics: Dynamic Image Generation, ASP.NET Controllers, Routing, IHttpHandlers, and runAllManagedModulesForAllRequests](http://www.hanselman.com/blog/BackToBasicsDynamicImageGenerationASPNETControllersRoutingIHttpHandlersAndRunAllManagedModulesForAllRequests.aspx) (Основы: создание динамического образа, контроллеры ASP.NET, маршрутизация, IHttpHandlers и runAllManagedModulesForAllRequests) и [Deep Inside Image Resizing and scaling with ASP.NET and IIS with ImageResizing.net author Nathanael](http://www.hanselminutes.com/313/deep-inside-image-resizing-and-scaling-with-aspnet-and-iis-with-imageresizingnet-author-na) (Особенности изменения размеров и масштабирования образов с использованием ASP.NET и IIS с автором ImageResizing.net Натанаэлем).
>
>

## <a name="troubleshooting"></a>Устранение неполадок
У вас что-то не работает, когда вы выполняете инструкции из этого руководства? Вот несколько общих ошибок и способы их устранения.

### <a name="serviceruntimeroleenvironmentexception"></a>ServiceRuntime.RoleEnvironmentException
Объект `RoleEnvironment` предоставляется Azure, когда приложение запущено в Azure или локально с использованием эмулятора вычислений Azure.  Если сообщение об этой ошибке появляется при локальном выполнении, убедитесь, что проект ContosoAdsCloudService установлен как начальный. Это настраивает проект для запуска с использованием эмулятора вычислений Azure.

Одной из причин, по которым приложение использует RoleEnvironment в Azure, — это получение значений строки подключения, которые что они хранятся в файлах *.cscfg* , поэтому другой причиной этого исключения является отсутствие строки подключения. Убедитесь, что настройка StorageConnectionString создана для вариантов "Облако" и "Локально" в проекте ContosoAdsWeb, и что созданы обе строки подключения для обоих вариантов в проекте ContosoAdsWorker. Выполните поиск **Найти все** по StorageConnectionString во всем решении; запись должна появиться 9 раз в 6 файлах.

### <a name="cannot-override-to-port-xxx-new-port-below-minimum-allowed-value-8080-for-protocol-http"></a>Невозможно переопределить на порт ххх. Новый порт ниже минимально разрешенного значения 8080 для протокола http
Попробуйте изменить номер порта, используемый веб-проектом. Щелкните правой кнопкой мыши проект ContosoAdsWeb и выберите пункт **Свойства**. Щелкните вкладку **Веб** и измените номер порта в параметре **URL-адрес проекта**.

Другим вариантом может быть решение в следующем разделе.

### <a name="other-errors-when-running-locally"></a>Другие ошибки при работе локально
По умолчанию новые проекты облачной службы используют облегченный эмулятор вычислений Azure для имитации среды Azure. Это облегченная версия полнофункционального эмулятора вычислений; при некоторых условиях полнофункциональный эмулятор будет работать, а облегченный — нет.  

Для переключения проекта на использование полнофункционального эмулятора щелкните правой кнопкой мыши проект ContosoAdsCloudService и выберите **Свойства**. В окне **Свойства** щелкните вкладку **Веб**, а затем установите переключатель **Использовать полный эмулятор**.

Для запуска приложения с полным эмулятором следует открыть Visual Studio с правами администратора.

## <a name="next-steps"></a>Дальнейшие действия
Приложение Contoso Ads намеренно сделано простым для руководства по началу работы. Например, оно не реализует [вставку зависимостей](http://www.asp.net/mvc/tutorials/hands-on-labs/aspnet-mvc-4-dependency-injection) или [репозиторий и блок рабочих шаблонов](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/advanced-entity-framework-scenarios-for-an-mvc-web-application#repo), не использует [интерфейс для журналов](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry#log), не использует [EF Code First Migrations](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application) для управления изменениями модели данных или [EF Connection Resiliency](http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application) для управления кратковременными ошибками сети и т. д.

Есть несколько примеров приложений облачной службы, которые демонстрируют более жизненные примеры кодирования — от менее сложных к более сложным:

* [PhluffyFotos](http://code.msdn.microsoft.com/PhluffyFotos-Sample-7ecffd31). Похоже на Contoso Ads, но реализует больше функций и больше примеров реального кода.
* [Многоуровневое облачное приложение Azure с таблицами, квотами, и большими двоичными объектами](http://code.msdn.microsoft.com/windowsazure/Windows-Azure-Multi-Tier-eadceb36). Представляет таблицы, а также большие двоичные объекты и очереди службы хранилища Azure. Этот пример основан на более старой версии пакета SDK для Azure для .NET, поэтому для работы с текущей версией потребуются некоторые изменения.
* [Основы облачных служб в Microsoft Azure](http://code.msdn.microsoft.com/Cloud-Service-Fundamentals-4ca72649). Полный пример для демонстрации широкого набора приемов, применяемых группой Microsoft Patterns and Practices.

Общую информацию об облачной разработке см. в статье о [создании реальных облачных приложений в Azure](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction).

Видеоинструкции по рекомендациям для службы хранилища Azure см. в разделе [Microsoft Azure Storage – What's New, Best Practices and Patterns](http://channel9.msdn.com/Events/Build/2014/3-628) (Хранилище Microsoft — новости, рекомендации и шаблоны).

Для получения дополнительных сведений см. следующие ресурсы:

* [Облачные службы Azure, часть 1: Введение](http://justazure.com/microsoft-azure-cloud-services-part-1-introduction/)
* [Управление облачными службами](cloud-services-how-to-manage-portal.md)
* [Хранилище Azure](/documentation/services/storage/)
* [Как выбрать поставщика облачных служб](https://azure.microsoft.com/overview/choosing-a-cloud-service-provider/)

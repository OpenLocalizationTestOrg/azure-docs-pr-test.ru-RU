---
title: "Устранение неполадок облачных служб с помощью Application Insights | Документация Майкрософт"
description: "Узнайте, как устранять неполадки облачной службы, используя Application Insights для обработки данных из системы диагностики Azure."
services: cloud-services
documentationcenter: .net
author: sbtron
manager: timlt
editor: tysonn
ms.assetid: e93f387b-ef29-4731-ae41-0676722accb6
ms.service: cloud-services
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 05/23/2017
ms.author: saurabh
ms.openlocfilehash: 4001ca908ff00b1a40829d687589080e9b07b18a
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="troubleshoot-cloud-services-using-application-insights"></a><span data-ttu-id="1cc90-103">Устранение неполадок облачных служб с помощью Application Insights</span><span class="sxs-lookup"><span data-stu-id="1cc90-103">Troubleshoot Cloud Services using Application Insights</span></span>
<span data-ttu-id="1cc90-104">[Пакет Azure SDK 2.8](https://azure.microsoft.com/downloads/) и расширение диагностики Azure 1.5 позволяют отправлять данные диагностики Azure для облачной службы непосредственно в Application Insights.</span><span class="sxs-lookup"><span data-stu-id="1cc90-104">With [Azure SDK 2.8](https://azure.microsoft.com/downloads/) and Azure diagnostics extension 1.5, you can send Azure Diagnostics data for your Cloud Service directly to Application Insights.</span></span> <span data-ttu-id="1cc90-105">В Application Insights можно отправлять журналы, собранные системой диагностики Azure, &mdash;включая журналы приложений, журналы событий Windows и счетчики производительности&mdash;.</span><span class="sxs-lookup"><span data-stu-id="1cc90-105">The logs collected by Azure Diagnostics&mdash;including application logs, Windows Event Logs, ETW Logs, and performance counters&mdash;can be sent to Application Insights.</span></span> <span data-ttu-id="1cc90-106">Затем эти сведения можно визуализировать в пользовательском интерфейсе портала Application Insights.</span><span class="sxs-lookup"><span data-stu-id="1cc90-106">You can then visualize this information in the Application Insights portal UI.</span></span> <span data-ttu-id="1cc90-107">Используя пакет SDK Application Insights, вы можете получать данные из метрик и журналов, создаваемых вашим приложением, а также данные на уровне системы и инфраструктуры, поступающие из системы диагностики Azure.</span><span class="sxs-lookup"><span data-stu-id="1cc90-107">You can then use the Application Insights SDK to get insights into metrics and logs that come from your application, as well as the system and infrastructure-level data that comes from Azure Diagnostics.</span></span>

## <a name="configure-azure-diagnostics-to-send-data-to-application-insights"></a><span data-ttu-id="1cc90-108">Настройка диагностики Azure для отправки данных в Application Insights</span><span class="sxs-lookup"><span data-stu-id="1cc90-108">Configure Azure Diagnostics to send data to Application Insights</span></span>
<span data-ttu-id="1cc90-109">Чтобы настроить проект облачной службы для отправки данных диагностики Azure в Application Insights, выполните описанные ниже действия.</span><span class="sxs-lookup"><span data-stu-id="1cc90-109">Follow these steps to set up your cloud service project to send Azure Diagnostics data to Application Insights.</span></span>

1. <span data-ttu-id="1cc90-110">В обозревателе решений Visual Studio щелкните роль правой кнопкой мыши и выберите **Свойства**, чтобы открыть конструктор ролей.</span><span class="sxs-lookup"><span data-stu-id="1cc90-110">In Visual Studio Solution Explorer, right-click a role and select **Properties** to open the Role designer.</span></span>

    ![Свойства роли обозревателя решений][1]

2. <span data-ttu-id="1cc90-112">В разделе **Диагностика** конструктора ролей выберите параметр **Отправка диагностических данных в Application Insights**.</span><span class="sxs-lookup"><span data-stu-id="1cc90-112">In the **Diagnostics** section of the Role designer, select the **Send diagnostics data to Application Insights** option.</span></span>

    ![Конструктор ролей отправляет данные диагностики в Application Insights][2]

3. <span data-ttu-id="1cc90-114">В появившемся диалоговом окне выберите ресурс Application Insights, в который требуется отправлять данные диагностики Azure.</span><span class="sxs-lookup"><span data-stu-id="1cc90-114">In the dialog box that pops up, select the Application Insights resource that you want to send the Azure diagnostics data to.</span></span> <span data-ttu-id="1cc90-115">Это диалоговое окно позволяет выбрать имеющийся ресурс Application Insights из подписки или вручную задать ключ инструментирования для такого ресурса.</span><span class="sxs-lookup"><span data-stu-id="1cc90-115">The dialog box allows you to select an existing Application Insights resource from your subscription or to manually specify an instrumentation key for an Application Insights resource.</span></span> <span data-ttu-id="1cc90-116">Дополнительные сведения о создании ресурса Application Insights см. в статье [Создание ресурса Application Insights](../application-insights/app-insights-create-new-resource.md).</span><span class="sxs-lookup"><span data-stu-id="1cc90-116">For more information on creating an Application Insights resource, see [Create a new Application Insights resource](../application-insights/app-insights-create-new-resource.md).</span></span>

    ![выберите ресурс application insights][3]

    <span data-ttu-id="1cc90-118">После добавления ресурса Application Insights соответствующий ему ключ инструментирования будет сохранен в качестве параметра конфигурации службы с именем **APPINSIGHTS_INSTRUMENTATIONKEY**.</span><span class="sxs-lookup"><span data-stu-id="1cc90-118">Once you have added the Application Insights resource, the instrumentation key for that resource is stored as a service configuration setting with the name **APPINSIGHTS_INSTRUMENTATIONKEY**.</span></span> <span data-ttu-id="1cc90-119">Этот параметр конфигурации можно изменить для каждой конфигурации службы или окружения.</span><span class="sxs-lookup"><span data-stu-id="1cc90-119">You can change this configuration setting for each service configuration or environment.</span></span> <span data-ttu-id="1cc90-120">Для этого выберите другую конфигурацию в списке **Конфигурация службы** и укажите для нее новый ключ инструментирования.</span><span class="sxs-lookup"><span data-stu-id="1cc90-120">To do so, select a different configuration from the **Service Configuration** list and specify a new instrumentation key for that configuration.</span></span>

    ![выберите конфигурацию службы][4]

    <span data-ttu-id="1cc90-122">Visual Studio использует параметр конфигурации **APPINSIGHTS_INSTRUMENTATIONKEY** для настройки расширения диагностики с использованием соответствующих данных ресурса Application Insights во время публикации.</span><span class="sxs-lookup"><span data-stu-id="1cc90-122">The **APPINSIGHTS_INSTRUMENTATIONKEY** configuration setting is used by Visual Studio to configure the diagnostics extension with the appropriate Application Insights resource information during publishing.</span></span> <span data-ttu-id="1cc90-123">Параметр конфигурации — это удобный способ определения различных ключей инструментирования для разных конфигураций службы.</span><span class="sxs-lookup"><span data-stu-id="1cc90-123">The configuration setting is a convenient way of defining different instrumentation keys for different service configurations.</span></span> <span data-ttu-id="1cc90-124">Visual Studio преобразует этот параметр и вставит его в открытую конфигурацию расширения диагностики при публикации.</span><span class="sxs-lookup"><span data-stu-id="1cc90-124">Visual Studio will translate that setting and insert it into the diagnostics extension public configuration during the publish process.</span></span> <span data-ttu-id="1cc90-125">Выходные данные пакета Visual Studio содержат, среди прочего, общедоступный XML-файл конфигурации с соответствующим ключом инструментирования Application Insights. Это позволяет упростить процесс настройки расширения с помощью PowerShell.</span><span class="sxs-lookup"><span data-stu-id="1cc90-125">To simplify the process of configuring the diagnostics extension with PowerShell, the package output from Visual Studio also contains the public configuration XML with the appropriate Application Insights instrumentation key.</span></span> <span data-ttu-id="1cc90-126">Общедоступные файлы конфигураций создаются в папке Extensions с именами в формате *PaaSDiagnostics.&lt;имя_роли&gt;.PubConfig.xml*.</span><span class="sxs-lookup"><span data-stu-id="1cc90-126">The public config files are created in the Extensions folder and follow the pattern *PaaSDiagnostics.&lt;RoleName&gt;.PubConfig.xml*.</span></span> <span data-ttu-id="1cc90-127">Все развертывания с использованием PowerShell могут использовать этот шаблон имени для сопоставления каждой конфигурации с ролью.</span><span class="sxs-lookup"><span data-stu-id="1cc90-127">Any PowerShell-based deployments can use this pattern to map each configuration to a role.</span></span>

4) <span data-ttu-id="1cc90-128">Чтобы настроить систему диагностики Azure для отправки всех счетчиков производительности и журналов ошибок, собранных агентом диагностики Azure, в Application Insights, установите флажок **Отправка диагностических данных в Application Insights**.</span><span class="sxs-lookup"><span data-stu-id="1cc90-128">To configure Azure diagnostics to send all performance counters and error-level logs collected by the Azure diagnostics agent to Application Insights, enable the **Send diagnostics data to Application Insights** option.</span></span> 

    <span data-ttu-id="1cc90-129">Чтобы указать, какие данные должны отправляться в службу Application Insights, вручную отредактируйте файл *diagnostics.wadcfgx* для каждой роли.</span><span class="sxs-lookup"><span data-stu-id="1cc90-129">If you want to further configure what data is sent to Application Insights, you must manually edit the *diagnostics.wadcfgx* file for each role.</span></span> <span data-ttu-id="1cc90-130">Дополнительные сведения об обновлении конфигурации вручную см. в статье [Настройка диагностики Azure для отправки данных в Application Insights](#configure-azure-diagnostics-to-send-data-to-application-insights).</span><span class="sxs-lookup"><span data-stu-id="1cc90-130">See [Configure Azure Diagnostics to send data to Application Insights](#configure-azure-diagnostics-to-send-data-to-application-insights) to learn more about manually updating the configuration.</span></span>

<span data-ttu-id="1cc90-131">Настроив облачную службу для отправки диагностических данных Azure в Application Insights, вы можете развернуть ее в Azure, как обычно, включив расширение диагностики Azure.</span><span class="sxs-lookup"><span data-stu-id="1cc90-131">When the cloud service is configured to send Azure diagnostics data to application insights, you can deploy it to Azure normally, making sure the Azure diagnostics extension is enabled.</span></span> <span data-ttu-id="1cc90-132">Дополнительные сведения см. в статье [Публикация облачной службы с помощью Visual Studio](../vs-azure-tools-publishing-a-cloud-service.md).</span><span class="sxs-lookup"><span data-stu-id="1cc90-132">For more information, see  [Publishing a Cloud Service using Visual Studio](../vs-azure-tools-publishing-a-cloud-service.md).</span></span>  

## <a name="viewing-azure-diagnostics-data-in-application-insights"></a><span data-ttu-id="1cc90-133">Просмотр данных диагностики Azure в Application Insights</span><span class="sxs-lookup"><span data-stu-id="1cc90-133">Viewing Azure diagnostics data in Application Insights</span></span>
<span data-ttu-id="1cc90-134">Телеметрия диагностики Azure появляется в ресурсе Application Insights, настроенном для вашей облачной службы.</span><span class="sxs-lookup"><span data-stu-id="1cc90-134">The Azure diagnostic telemetry shows up in the Application Insights resource configured for your cloud service.</span></span>

<span data-ttu-id="1cc90-135">Типы журналов системы диагностики Azure соотносятся с понятиями Application Insights по-разному:</span><span class="sxs-lookup"><span data-stu-id="1cc90-135">Azure diagnostics log types map to Application Insights concepts in these ways:</span></span>

* <span data-ttu-id="1cc90-136">Счетчики производительности отображаются в Application Insights в виде пользовательских метрик.</span><span class="sxs-lookup"><span data-stu-id="1cc90-136">Performance counters are displayed as Custom Metrics in Application Insights.</span></span>
* <span data-ttu-id="1cc90-137">Журналы событий Windows отображаются в Application Insights в виде трассировок и пользовательских событий.</span><span class="sxs-lookup"><span data-stu-id="1cc90-137">Windows Event Logs are shown as Traces and Custom Events in Application Insights.</span></span>
* <span data-ttu-id="1cc90-138">Журналы приложений, журналы ETW и все журналы инфраструктуры диагностики отображаются в Application Insights в виде трассировок.</span><span class="sxs-lookup"><span data-stu-id="1cc90-138">Application logs, ETW logs, and any Diagnostics Infrastructure logs are shown as Traces in Application Insights.</span></span>

<span data-ttu-id="1cc90-139">Чтобы просмотреть данные диагностики Azure в Application Insights, выполните одно из следующих действий:</span><span class="sxs-lookup"><span data-stu-id="1cc90-139">To view Azure diagnostics data in Application Insights, do one of the following:</span></span>

* <span data-ttu-id="1cc90-140">Используйте [обозреватель метрик](../application-insights/app-insights-metrics-explorer.md) для визуализации пользовательских счетчиков производительности или других типов счетчиков для событий журналов событий Windows.</span><span class="sxs-lookup"><span data-stu-id="1cc90-140">Use [Metrics explorer](../application-insights/app-insights-metrics-explorer.md) to visualize any custom performance counters or counts of different types of Windows Event Log events.</span></span>

    ![Пользовательские метрики в обозревателе метрик][5]

* <span data-ttu-id="1cc90-142">Используйте функцию [Поиск](../application-insights/app-insights-diagnostic-search.md) для поиска в журналах трассировки, отправляемых системой диагностики Azure.</span><span class="sxs-lookup"><span data-stu-id="1cc90-142">Use [Search](../application-insights/app-insights-diagnostic-search.md) to search across the  trace logs sent by Azure Diagnostics.</span></span> <span data-ttu-id="1cc90-143">Например, если из-за необработанного исключения произошел сбой и перезапуск роли, соответствующие данные появляются в канале *Приложение* *журнала событий Windows*.</span><span class="sxs-lookup"><span data-stu-id="1cc90-143">For example, if an unhandled exception has caused the role to crash and recycle, information about the exception shows up in the *Application* channel of *Windows Event Log*.</span></span> <span data-ttu-id="1cc90-144">Можно воспользоваться поиском, чтобы просмотреть ошибку в журнале событий Windows и получить полную трассировку стека для исключения, что поможет найти причину проблемы.</span><span class="sxs-lookup"><span data-stu-id="1cc90-144">You can use search to look at the Windows Event Log error and get the full stack trace for the exception to help find the cause of the issue.</span></span>

    ![Поиск трассировок][6]

## <a name="next-steps"></a><span data-ttu-id="1cc90-146">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="1cc90-146">Next Steps</span></span>
* <span data-ttu-id="1cc90-147">[Добавьте пакет SDK Application Insights в свою облачную службу](../application-insights/app-insights-cloudservices.md) для отправки данных о запросах, исключениях, зависимостях и других данных пользовательской телеметрии из приложения.</span><span class="sxs-lookup"><span data-stu-id="1cc90-147">[Add the Application Insights SDK to your cloud service](../application-insights/app-insights-cloudservices.md) to send data about requests, exceptions, dependencies, and any custom telemetry from your application.</span></span> <span data-ttu-id="1cc90-148">В сочетании с данными диагностики Azure эта информация позволяет получить полное представление о приложении и системе в одном и том же ресурсе Application Insight.</span><span class="sxs-lookup"><span data-stu-id="1cc90-148">When combined with the Azure Diagnostics data, this information you can get a complete view of your application and system, all in the same Application Insight resource.</span></span>  

<!--Image references-->
[1]: ./media/cloud-services-dotnet-diagnostics-applicationinsights/solution-explorer-properties.png
[2]: ./media/cloud-services-dotnet-diagnostics-applicationinsights/role-designer-sendtoappinsights.png
[3]: ./media/cloud-services-dotnet-diagnostics-applicationinsights/select-appinsights-resource.png
[4]: ./media/cloud-services-dotnet-diagnostics-applicationinsights/role-designer-appinsights-serviceconfig.png
[5]: ./media/cloud-services-dotnet-diagnostics-applicationinsights/metrics-explorer-custom-metrics.png
[6]: ./media/cloud-services-dotnet-diagnostics-applicationinsights/search-windowseventlog-error.png

---
title: "aaaHow tooupdate облачной службы | Документы Microsoft"
description: "Узнайте, как tooupdate облачных служб в Azure. Узнайте, как обновления в облачной службе происходит tooensure доступности."
services: cloud-services
documentationcenter: 
author: Thraka
manager: timlt
editor: 
ms.assetid: c6a8b5e6-5c99-454c-9911-5c7ae8d1af63
ms.service: cloud-services
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/19/2017
ms.author: adegeo
ms.openlocfilehash: 7e4c8bd46e51a555b4309ea8927d120e8efcf0ea
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="how-tooupdate-a-cloud-service"></a>Как tooupdate облачной службы

Обновление облачной службы, включая ее роли или гостевую ОС, состоит их трех этапов. Во-первых hello двоичные файлы и файлы конфигурации для hello новой облачной службы или версия ОС необходимо передать. Далее Azure зарезервирует вычислительных и сетевых ресурсов для hello облачной службы в соответствии с требованиями hello hello новой версии облачной службы. Наконец Azure выполняет последовательного обновления tooincrementally hello клиента toohello новые версии обновления или гостевой ОС, сохраняя доступность. В этой статье рассматриваются hello сведения об этом последнем шаге — hello последовательное обновление.

## <a name="update-an-azure-service"></a>Обновление службы Azure
Azure распределяет экземпляры роли по логическим группам, которые называются доменами обновления. Домены обновления — это логические наборы экземпляров ролей, которые обновляются одновременно.  Обновляет Azure облачной службы один UD одновременно, что позволит экземпляры других toocontinue доменам обновления, обслуживающий трафик.

по умолчанию Hello, количество доменов обновления — 5. Можно указать другое количество доменов обновления, включив атрибут upgradeDomainCount hello в файл определения hello службы (csdef). Дополнительные сведения об атрибуте upgradeDomainCount hello см. в разделе [схема WebRole](https://msdn.microsoft.com/library/azure/gg557553.aspx) или [схема WorkerRole](https://msdn.microsoft.com/library/azure/gg557552.aspx).

При выполнении обновления на месте одной или нескольких ролей в службе Azure обновляет наборы экземпляров ролей в соответствии с toowhich toohello домен обновления, которые они входят. Обновления Azure, все экземпляры hello в заданном домене обновления — останавливает их, обновляет их, их снова делает доступными, перемещается на следующий домен hello. Остановив только hello экземпляров, работающих в hello текущий домен обновления, Azure проверяет, выполнять обновление с минимальное возможное влияние toohello hello службой. Дополнительные сведения см. в разделе [как происходит обновление hello](#howanupgradeproceeds) далее в этой статье.

> [!NOTE]
> Хотя условия hello **обновление** и **обновление** имеют несколько различный смысл в контексте hello Azure, они взаимозаменяемы процессы hello и описание функций hello в этом документе.
>
>

Служба должна определять по крайней мере двух экземпляров роли для этой роли toobe обновление на месте без простоя. Если служба hello состоит только из одного экземпляра одной роли, службы будет недоступна, пока hello обновления на месте завершения.

В этом разделе рассматриваются hello следующую информацию об обновлениях Azure:

* [Допустимые изменения службы во время обновления](#AllowedChanges)
* [Как происходит обновление](#howanupgradeproceeds)
* [Откат обновления](#RollbackofanUpdate)
* [Запуск нескольких операций изменения в текущем развертывании](#multiplemutatingoperations)
* [Распределение ролей в доменах обновления](#distributiondfroles)

<a name="AllowedChanges"></a>

## <a name="allowed-service-changes-during-an-update"></a>Допустимые изменения службы во время обновления
Hello следующей таблице показаны hello допускается изменения tooa службы во время обновления.

| Разрешенные изменения toohosting, службы и роли | Обновление "на месте" | Промежуточная среда (переключение виртуального IP-адреса) | Удаление и повторное развертывание |
| --- | --- | --- | --- |
| Версия операционной системы |Да |Да |Да |
| Уровень доверия .NET |Да |Да |Да |
| Размер виртуальной машины <sup>1</sup> |Да <sup>2</sup> |Да |Да |
| Параметры хранилища Azure |Только увеличение <sup>2</sup> |Да |Да |
| Добавление и удаление ролей в службе |Да |Да |Да |
| Количество экземпляров определенной роли |Да |Да |Да |
| Количество и тип конечных точек службы |Да <sup>2</sup> |Нет |Да |
| Имена и значения параметров конфигурации |Да |Да |Да |
| Только значения параметров конфигурации |Да |Да |Да |
| Добавление сертификатов |Да |Да |Да |
| Изменение существующих сертификатов |Да |Да |Да |
| Развертывание нового кода |Да |Да |Да |

<sup>1</sup> toohello подмножество размеры, доступные для облачной службы hello ограниченные изменения размера.

<sup>2</sup> Требуется пакет SDK Azure 1.5 или более поздней версии.

> [!WARNING]
> Изменение размера виртуальной машины hello разрушит локальные данные.
>
>

во время обновления не поддерживаются Hello следующих элементов:

* Изменение имени роли hello. Удалите, а затем добавьте hello роль с новым именем hello.
* Изменение счетчика доменов обновления hello.
* Уменьшение размера hello hello локальных ресурсов.

Если производятся другие обновления определения tooyour службы, например уменьшается размер локального ресурса hello вместо этого необходимо выполнить обновление с переключением виртуальных IP-адресов. Дополнительные сведения см. в статье о [переключении развертывания](https://msdn.microsoft.com/library/azure/ee460814.aspx).

<a name="howanupgradeproceeds"></a>

## <a name="how-an-upgrade-proceeds"></a>Как происходит обновление
Можно решить, следует ли tooupdate все роли hello в службе или в одной роли в службе hello. В любом случае все экземпляры каждой роли, которая обновляется и принадлежат toohello первый домен обновления останавливаются, обновить и возвращается в оперативный режим. После их вернется в оперативный режим, hello экземпляров в hello втором домене обновления останавливаются, обновить и вернется в оперативный режим. Для каждой облачной службы в один момент времени выполняется только один процесс обновления. Обновление Hello всегда выполняется для последней версии hello hello облачной службы.

Hello следующей схеме показана как hello обновление происходит при обновлении все роли hello в службе hello.

![Обновление службы](media/cloud-services-update-azure-service/IC345879.png "Обновление службы")

На следующей диаграмме показано, как происходит обновление hello при обновлении одной роли:

![Обновление роли](media/cloud-services-update-azure-service/IC345880.png "Обновление роли")  

Во время автоматического обновления hello Azure Fabric Controller периодически оценивает работоспособность hello hello облачной службы toodetermine при безопасном toowalk hello UD Далее. Этой оценки работоспособности выполняется для каждой роли отдельно и рассматривает только экземпляры в последней версии hello (т. е. экземпляры из доменам обновления, которые уже были рассмотреть). Чтобы служба считалась работоспособной, удовлетворительного конечного состояния должно достичь минимальное заданное количество экземпляров каждой роли.

### <a name="role-instance-start-timeout"></a>Время ожидания запуска экземпляра роли
Hello контроллер структуры будет ожидать 30 минут для каждой роли экземпляра tooreach состоянии Started. Если истекает время ожидания hello, hello Fabric Controller продолжит проходу toohello следующего экземпляра роли.

### <a name="impact-toodrive-data-during-cloud-service-upgrades"></a>Данные влияния toodrive во время обновления облачной службы

При обновлении службы из toomultiple единственных экземпляров службы будет отключена время hello обновления из-за способа toohello Azure обновляет по службами. гарантирующее доступность службы Hello службы соглашения об уровне применяется только tooservices, которые развертываются с более чем одним экземпляром. Hello следующий список описывает влияние hello данные на каждом диске сценариев обновления службы Azure:

|Сценарий|Диск C|Диск D|Диск Е|
|--------|-------|-------|-------|
|Перезагрузка виртуальной машины|Сохраняются|Сохраняются|Сохраняются|
|Перезагрузка портала|Сохраняются|Сохраняются|Уничтожаются|
|Пересоздание образа портала|Сохраняются|Уничтожаются|Уничтожаются|
|Обновление «на месте»|Сохраняются|Сохраняются|Уничтожаются|
|Миграция узла|Уничтожаются|Уничтожаются|Уничтожаются|

Обратите внимание, что, в hello над списком hello диск E: представляет корневой диск роли hello не следует жестко. Вместо этого используйте hello **% RoleRoot %** диск hello toorepresent переменной среды.

toominimize hello простоя при обновлении экземпляра службы, развертывание нового нескольких экземпляров службы toohello промежуточного сервера и выполнить переключение виртуального IP-адреса.

<a name="RollbackofanUpdate"></a>

## <a name="rollback-of-an-update"></a>Откат обновления
Azure предоставляет гибкость в управлении службами во время обновления, позволяя проводить дополнительные действия для службы, после hello первый запрос изменения принимается hello Azure Fabric Controller. Откат может выполняться, только когда обновление (изменение конфигурации), а также обновление находится в hello **выполняется** состояния hello в развертывании. Установка обновления или обновления считается toobe выполняется при условии, что по крайней мере один экземпляр службы hello, которая еще не обновленные toohello новой версии. tootest запрет на откат, проверьте hello значение флага RollbackAllowed hello, возвращенных [Get Deployment](https://msdn.microsoft.com/library/azure/ee460804.aspx) и [получение свойств облачной службы](https://msdn.microsoft.com/library/azure/ee460806.aspx) операций, имеет значение tootrue.

> [!NOTE]
> Только делает toocall смысле Rollback на **на месте** обновления или обновления, поскольку виртуальных IP-адресов вызывают замену одного работающего экземпляра службы с другим.
>
>

Откат выполняющегося обновления имеет следующие эффекты в развертывании hello hello.

* Все экземпляры ролей, которые еще не выполнялось toohello обновленные или обновить новую версию не обновляются или обновлены, поскольку в этих экземплярах уже выполняется целевая версия службы hello hello.
* Любой роли экземпляров, которая уже была обновлена или обновленные toohello новой версии пакета обновления hello (\*.cspkg) файла или hello конфигурации службы (\*.cscfg) файла (или оба файла), возвращенной toohello до обновления версии Эти файлы.

Эта функциональность предоставляется с hello следующие атрибуты:

* Hello [отката обновления или обновления](https://msdn.microsoft.com/library/azure/hh403977.aspx) операцию, которая может быть вызван для обновления конфигурации (срабатывает при вызове [изменение конфигурации развертывания](https://msdn.microsoft.com/library/azure/ee460809.aspx)) или обновления (срабатывает при вызове [ Обновление развертывания](https://msdn.microsoft.com/library/azure/ee460793.aspx)) при условии, что имеется по крайней мере один экземпляр в службе hello которого еще не был обновлен toohello новой версии.
* Здравствуйте, Locked и hello RollbackAllowed элементы, которые возвращаются в составе hello в тексте ответа hello [Get Deployment](https://msdn.microsoft.com/library/azure/ee460804.aspx) и [получение свойств облачной службы](https://msdn.microsoft.com/library/azure/ee460806.aspx) операций:

  1. элемент заблокирован Hello позволяет toodetect при операции изменения можно вызвать в заданном развертывании.
  2. Hello RollbackAllowed элемент позволяет toodetect при hello [отката обновления](https://msdn.microsoft.com/library/azure/hh403977.aspx) операция может быть вызвана в заданном развертывании.

  В tooperform порядок откат у вас toocheck hello Locked и hello RollbackAllowed элементов. Будет достаточным tooconfirm, что RollbackAllowed имеет значение tootrue. Эти элементы возвращаются только в том случае, если эти методы вызываются с помощью слишком набор заголовков запроса hello "x-ms-version: 2011-10-01» или более поздней версии. Подробнее о заголовках управления версиями см. в статье [Работа с версиями при управлении службами](https://msdn.microsoft.com/library/azure/gg592580.aspx).

Существуют ситуации, когда откат обновления невозможен. Примеры таких ситуаций представлены ниже.

* Сокращение на локальных ресурсах — Если hello обновления увеличивается hello локальных ресурсов для роли hello платформы Azure разрешает откат.
* Ограничения квоты — Если hello обновление было операцией масштабирования вниз, у вас может не иметь достаточно вычислительные операции отката hello квоты toocomplete. Каждая подписка Azure имеет квоту, связанные с ним, указывающее максимальное количество ядер, которые могут использоваться всеми размещенными службами, которые принадлежат toothat подписки hello. Если для выполнения отката обновления требуется превысить квоту подписки, такой откат будет запрещен.
* Гонки — Если hello начальное Обновление завершено, откат невозможен.

Пример когда hello откат обновления может быть полезным — Если вы используете hello [обновление развертывания](https://msdn.microsoft.com/library/azure/ee460793.aspx) распространен операции в ручной режим toocontrol hello скорость, с которой основных tooyour обновления на месте Azure размещенной службы.

Во время этого этапа hello обновления hello вызвать [обновление развертывания](https://msdn.microsoft.com/library/azure/ee460793.aspx) в ручном режиме и начать toowalk доменов обновления. Если в определенный момент при наблюдении за обновление hello, можно выполнить некоторые экземпляры роли в hello первые обновления домены, которые вы рассматриваете, перестали отвечать, вы можете вызвать hello [отката обновления](https://msdn.microsoft.com/library/azure/hh403977.aspx) операции hello в развертывании, который останется без изменений hello экземпляров, которые еще не были обновлены и откатит экземпляры, которые бы была обновлена toohello предыдущего пакета служб и конфигурации.

<a name="multiplemutatingoperations"></a>

## <a name="initiating-multiple-mutating-operations-on-an-ongoing-deployment"></a>Запуск нескольких операций изменения в текущем развертывании
В некоторых случаях может понадобиться tooinitiate множественных одновременных операций изменения в текущем развертывании. Например может выполнить обновление службы и, хотя это обновление разворачивается в службе, требуется toomake некоторые изменения, например tooroll hello обновление назад, применить другое обновление или даже удалить развертывание hello. Случай, в котором такая необходимость может возникнуть — если обновление службы содержит дефектный код, который вызывает сбой toorepeatedly обновленного роли экземпляра. В этом случае hello Azure Fabric Controller не будет возможности toomake продолжить применение этого обновления из-за недостаточного количества экземпляров в домене обновления hello находятся в работоспособном состоянии. Это состояние является ссылка tooas *застрявшее развертывание*. Откат обновления hello или применения свежего обновления поверх hello сбой одного можно запуске развертывания hello.

После получения hello начального запроса обновления или tooupdate hello службы по hello Azure Fabric Controller можно начинать последующие операции изменения. То есть у вас toowait для начальной операции toocomplete hello перед началом другой операции изменения.

Запуск второй операции обновления, во время первого обновления hello будет выполнять аналогичные операции отката toohello. Если hello второе обновление проводится в автоматическом режиме, hello первый домен обновления будет обновлен немедленно, могущие привести tooinstances из нескольких доменов обновления, находится в автономном режиме на hello же момент времени.

Hello изменяющаяся протоколируются следующие операции: [изменение конфигурации развертывания](https://msdn.microsoft.com/library/azure/ee460809.aspx), [обновление развертывания](https://msdn.microsoft.com/library/azure/ee460793.aspx), [состояние развертывания обновлений](https://msdn.microsoft.com/library/azure/ee460808.aspx), [удалить Развертывание](https://msdn.microsoft.com/library/azure/ee460815.aspx), и [отката обновления или модернизации](https://msdn.microsoft.com/library/azure/hh403977.aspx).

Две операции [Get Deployment](https://msdn.microsoft.com/library/azure/ee460804.aspx) и [получение свойств облачной службы](https://msdn.microsoft.com/library/azure/ee460806.aspx), возвращают флаг заблокирована hello, который может быть проверенных toodetermine ли предпринять операцию можно вызвать в заданном развертывании.

В порядке toocall hello версии этих методов возвращающий флаг hello заблокирована, необходимо установить заголовок запроса слишком "x-ms-version: 2011-10-01» или более поздней версии. Подробнее о заголовках управления версиями см. в статье [Работа с версиями при управлении службами](https://msdn.microsoft.com/library/azure/gg592580.aspx).

<a name="distributiondfroles"></a>

## <a name="distribution-of-roles-across-upgrade-domains"></a>Распределение ролей в доменах обновления
Azure распределяет экземпляры роли равномерно по определенному набору доменов обновления, которые могут быть настроены как часть файла определения службы(.csdef) hello службы. Hello максимальное количество доменов обновления — 20 и hello по умолчанию равно 5. Дополнительные сведения о том, как toomodify hello файла определения службы см. в разделе [схема определения службы Azure (.csdef файла)](cloud-services-model-and-package.md#csdef).

Например, для роли с 10 экземплярами к каждому домену обновления по умолчанию будет отнесено 2 экземпляра. Если ваша роль содержит 14 экземпляров, то четыре hello доменов обновления содержат 3 экземпляра, а пятый домен содержит 2.

Домены обновления определяются с отсчетом от нуля: hello первый домен обновления имеет идентификатор 0, а hello второй домен обновления имеет идентификатор 1 и т. д.

Hello следующая диаграмма иллюстрирует как служба, содержащая две роли распределяются при hello службы определяется в двух доменах обновления. запущена служба Hello восьми экземпляров hello веб-роли и 9 экземпляров рабочей роли hello.

![Распределение доменов обновления](media/cloud-services-update-azure-service/IC345533.png "Распределение доменов обновления")

> [!NOTE]
> Обратите внимание, что распределением экземпляров в домены обновления управляет Azure. Это не возможные toospecify экземпляры, которые выделяются toowhich домена.
>
>

## <a name="next-steps"></a>Дальнейшие действия
[Как tooManage облачных служб](cloud-services-how-to-manage.md)  
[Как tooMonitor облачных служб](cloud-services-how-to-monitor.md)  
[Как tooConfigure облачных служб](cloud-services-how-to-configure.md)  

---
title: "Обновление облачной службы | Документация Майкрософт"
description: "Узнайте, как обновлять облачные службы в Azure. Узнайте, как обеспечивается доступность облачной службы при ее обновлении."
services: cloud-services
documentationcenter: 
author: Thraka
manager: timlt
editor: 
ms.assetid: c6a8b5e6-5c99-454c-9911-5c7ae8d1af63
ms.service: cloud-services
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/19/2017
ms.author: adegeo
ms.openlocfilehash: 2ba9676ed2afce7f18446642527971f5001b5ca7
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="how-to-update-a-cloud-service"></a><span data-ttu-id="c61dc-104">Обновление облачной службы</span><span class="sxs-lookup"><span data-stu-id="c61dc-104">How to update a cloud service</span></span>

<span data-ttu-id="c61dc-105">Обновление облачной службы, включая ее роли или гостевую ОС, состоит их трех этапов.</span><span class="sxs-lookup"><span data-stu-id="c61dc-105">Updating a cloud service, including both its roles and guest OS, is a three step process.</span></span> <span data-ttu-id="c61dc-106">Сначала нужно передать двоичные файлы и файлы конфигурации новой облачной службы или новой версии ОС.</span><span class="sxs-lookup"><span data-stu-id="c61dc-106">First, the binaries and configuration files for the new cloud service or OS version must be uploaded.</span></span> <span data-ttu-id="c61dc-107">Затем Azure резервирует вычислительные и сетевые ресурсы для облачной службы в соответствии с требованиями новой версии облачной службы.</span><span class="sxs-lookup"><span data-stu-id="c61dc-107">Next, Azure reserves compute and network resources for the cloud service based on the requirements of the new cloud service version.</span></span> <span data-ttu-id="c61dc-108">И, наконец, Azure выполняет процесс последовательного обновления клиента до новой версии службы или гостевой ОС, сохраняя при этом доступность.</span><span class="sxs-lookup"><span data-stu-id="c61dc-108">Finally, Azure performs a rolling upgrade to incrementally update the tenant to the new version or guest OS, while preserving your availability.</span></span> <span data-ttu-id="c61dc-109">В этой статье подробно описан последний шаг этого процесса — последовательное обновление.</span><span class="sxs-lookup"><span data-stu-id="c61dc-109">This article discusses the details of this last step – the rolling upgrade.</span></span>

## <a name="update-an-azure-service"></a><span data-ttu-id="c61dc-110">Обновление службы Azure</span><span class="sxs-lookup"><span data-stu-id="c61dc-110">Update an Azure Service</span></span>
<span data-ttu-id="c61dc-111">Azure распределяет экземпляры роли по логическим группам, которые называются доменами обновления.</span><span class="sxs-lookup"><span data-stu-id="c61dc-111">Azure organizes your role instances into logical groupings called upgrade domains (UD).</span></span> <span data-ttu-id="c61dc-112">Домены обновления — это логические наборы экземпляров ролей, которые обновляются одновременно.</span><span class="sxs-lookup"><span data-stu-id="c61dc-112">Upgrade domains (UD) are logical sets of role instances that are updated as a group.</span></span>  <span data-ttu-id="c61dc-113">Azure поочередно обновляет по одному домену обновления облачной службы, позволяя экземплярам в других доменах обновления продолжать обработку запросов.</span><span class="sxs-lookup"><span data-stu-id="c61dc-113">Azure updates a cloud service one UD at a time, which allows instances in other UDs to continue serving traffic.</span></span>

<span data-ttu-id="c61dc-114">Количество доменов обновления по умолчанию равно 5.</span><span class="sxs-lookup"><span data-stu-id="c61dc-114">The default number of upgrade domains is 5.</span></span> <span data-ttu-id="c61dc-115">Вы можете указать любое другое количество доменов обновления, включив в файл определения службы (CSDEF) атрибут upgradeDomainCount.</span><span class="sxs-lookup"><span data-stu-id="c61dc-115">You can specify a different number of upgrade domains by including the upgradeDomainCount attribute in the service’s definition file (.csdef).</span></span> <span data-ttu-id="c61dc-116">Дополнительные сведения об атрибуте upgradeDomainCount см. в статьях [Схема WebRole](https://msdn.microsoft.com/library/azure/gg557553.aspx) и [Схема WorkerRole](https://msdn.microsoft.com/library/azure/gg557552.aspx).</span><span class="sxs-lookup"><span data-stu-id="c61dc-116">For more information about the upgradeDomainCount attribute, see [WebRole Schema](https://msdn.microsoft.com/library/azure/gg557553.aspx) or [WorkerRole Schema](https://msdn.microsoft.com/library/azure/gg557552.aspx).</span></span>

<span data-ttu-id="c61dc-117">Когда вы выполняете обновление на месте, Azure обновляет наборы экземпляров ролей поочередно в соответствии с их распределением в доменах обновления.</span><span class="sxs-lookup"><span data-stu-id="c61dc-117">When you perform an in-place update of one or more roles in your service, Azure updates sets of role instances according to the upgrade domain to which they belong.</span></span> <span data-ttu-id="c61dc-118">Azure одновременно обновляет все экземпляры, входящие в домен обновления: останавливает их, выполняет изменения и снова возвращает в работу. Затем Azure переходит к следующему домену обновления.</span><span class="sxs-lookup"><span data-stu-id="c61dc-118">Azure updates all of the instances in a given upgrade domain – stopping them, updating them, bringing them back on-line – then moves onto the next domain.</span></span> <span data-ttu-id="c61dc-119">Поскольку работу прекращают только те экземпляры, которые находятся в текущем домене обновления, Azure обновляет службу без существенного влияния на ее работу.</span><span class="sxs-lookup"><span data-stu-id="c61dc-119">By stopping only the instances running in the current upgrade domain, Azure makes sure that an update occurs with the least possible impact to the running service.</span></span> <span data-ttu-id="c61dc-120">Подробнее этот процесс описан в разделе [Как происходит обновление](#howanupgradeproceeds).</span><span class="sxs-lookup"><span data-stu-id="c61dc-120">For more information, see [How the update proceeds](#howanupgradeproceeds) later in this article.</span></span>

> [!NOTE]
> <span data-ttu-id="c61dc-121">Служба Azure выполняет два типа обновления: **обновление (изменение) конфигурации** и **обновление версий программ**. Описываемые в этой статье процессы и функции работают одинаково в обоих случаях, поэтому мы будем собирательно называть их обновлением.</span><span class="sxs-lookup"><span data-stu-id="c61dc-121">While the terms **update** and **upgrade** have slightly different meaning in the context Azure, they can be used interchangeably for the processes and descriptions of the features in this document.</span></span>
>
>

<span data-ttu-id="c61dc-122">Чтобы обновление роли на месте проходило без остановки ее работы, для этой роли следует определить не менее двух экземпляров.</span><span class="sxs-lookup"><span data-stu-id="c61dc-122">Your service must define at least two instances of a role for that role to be updated in-place without downtime.</span></span> <span data-ttu-id="c61dc-123">Служба, содержащая только один экземпляр одной роли, будет недоступна во время обновления на месте.</span><span class="sxs-lookup"><span data-stu-id="c61dc-123">If the service consists of only one instance of one role, your service will be unavailable until the in-place update has finished.</span></span>

<span data-ttu-id="c61dc-124">В этом разделе мы рассмотрим следующие сведения об обновлениях Azure.</span><span class="sxs-lookup"><span data-stu-id="c61dc-124">This topic covers the following information about Azure updates:</span></span>

* [<span data-ttu-id="c61dc-125">Допустимые изменения службы во время обновления</span><span class="sxs-lookup"><span data-stu-id="c61dc-125">Allowed service changes during an update</span></span>](#AllowedChanges)
* [<span data-ttu-id="c61dc-126">Как происходит обновление</span><span class="sxs-lookup"><span data-stu-id="c61dc-126">How an upgrade proceeds</span></span>](#howanupgradeproceeds)
* [<span data-ttu-id="c61dc-127">Откат обновления</span><span class="sxs-lookup"><span data-stu-id="c61dc-127">Rollback of an update</span></span>](#RollbackofanUpdate)
* [<span data-ttu-id="c61dc-128">Запуск нескольких операций изменения в текущем развертывании</span><span class="sxs-lookup"><span data-stu-id="c61dc-128">Initiating multiple mutating operations on an ongoing deployment</span></span>](#multiplemutatingoperations)
* [<span data-ttu-id="c61dc-129">Распределение ролей в доменах обновления</span><span class="sxs-lookup"><span data-stu-id="c61dc-129">Distribution of roles across upgrade domains</span></span>](#distributiondfroles)

<a name="AllowedChanges"></a>

## <a name="allowed-service-changes-during-an-update"></a><span data-ttu-id="c61dc-130">Допустимые изменения службы во время обновления</span><span class="sxs-lookup"><span data-stu-id="c61dc-130">Allowed service changes during an update</span></span>
<span data-ttu-id="c61dc-131">Все допустимые изменения службы во время обновления приведены в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="c61dc-131">The following table shows the allowed changes to a service during an update:</span></span>

| <span data-ttu-id="c61dc-132">Изменения, которые можно выполнять для хостинга, служб и ролей</span><span class="sxs-lookup"><span data-stu-id="c61dc-132">Changes permitted to hosting, services, and roles</span></span> | <span data-ttu-id="c61dc-133">Обновление "на месте"</span><span class="sxs-lookup"><span data-stu-id="c61dc-133">In-place update</span></span> | <span data-ttu-id="c61dc-134">Промежуточная среда (переключение виртуального IP-адреса)</span><span class="sxs-lookup"><span data-stu-id="c61dc-134">Staged (VIP swap)</span></span> | <span data-ttu-id="c61dc-135">Удаление и повторное развертывание</span><span class="sxs-lookup"><span data-stu-id="c61dc-135">Delete and re-deploy</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="c61dc-136">Версия операционной системы</span><span class="sxs-lookup"><span data-stu-id="c61dc-136">Operating system version</span></span> |<span data-ttu-id="c61dc-137">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-137">Yes</span></span> |<span data-ttu-id="c61dc-138">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-138">Yes</span></span> |<span data-ttu-id="c61dc-139">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-139">Yes</span></span> |
| <span data-ttu-id="c61dc-140">Уровень доверия .NET</span><span class="sxs-lookup"><span data-stu-id="c61dc-140">.NET trust level</span></span> |<span data-ttu-id="c61dc-141">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-141">Yes</span></span> |<span data-ttu-id="c61dc-142">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-142">Yes</span></span> |<span data-ttu-id="c61dc-143">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-143">Yes</span></span> |
| <span data-ttu-id="c61dc-144">Размер виртуальной машины <sup>1</sup></span><span class="sxs-lookup"><span data-stu-id="c61dc-144">Virtual machine size<sup>1</sup></span></span> |<span data-ttu-id="c61dc-145">Да <sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="c61dc-145">Yes<sup>2</sup></span></span> |<span data-ttu-id="c61dc-146">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-146">Yes</span></span> |<span data-ttu-id="c61dc-147">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-147">Yes</span></span> |
| <span data-ttu-id="c61dc-148">Параметры хранилища Azure</span><span class="sxs-lookup"><span data-stu-id="c61dc-148">Local storage settings</span></span> |<span data-ttu-id="c61dc-149">Только увеличение <sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="c61dc-149">Increase only<sup>2</sup></span></span> |<span data-ttu-id="c61dc-150">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-150">Yes</span></span> |<span data-ttu-id="c61dc-151">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-151">Yes</span></span> |
| <span data-ttu-id="c61dc-152">Добавление и удаление ролей в службе</span><span class="sxs-lookup"><span data-stu-id="c61dc-152">Add or remove roles in a service</span></span> |<span data-ttu-id="c61dc-153">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-153">Yes</span></span> |<span data-ttu-id="c61dc-154">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-154">Yes</span></span> |<span data-ttu-id="c61dc-155">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-155">Yes</span></span> |
| <span data-ttu-id="c61dc-156">Количество экземпляров определенной роли</span><span class="sxs-lookup"><span data-stu-id="c61dc-156">Number of instances of a particular role</span></span> |<span data-ttu-id="c61dc-157">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-157">Yes</span></span> |<span data-ttu-id="c61dc-158">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-158">Yes</span></span> |<span data-ttu-id="c61dc-159">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-159">Yes</span></span> |
| <span data-ttu-id="c61dc-160">Количество и тип конечных точек службы</span><span class="sxs-lookup"><span data-stu-id="c61dc-160">Number or type of endpoints for a service</span></span> |<span data-ttu-id="c61dc-161">Да <sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="c61dc-161">Yes<sup>2</sup></span></span> |<span data-ttu-id="c61dc-162">Нет</span><span class="sxs-lookup"><span data-stu-id="c61dc-162">No</span></span> |<span data-ttu-id="c61dc-163">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-163">Yes</span></span> |
| <span data-ttu-id="c61dc-164">Имена и значения параметров конфигурации</span><span class="sxs-lookup"><span data-stu-id="c61dc-164">Names and values of configuration settings</span></span> |<span data-ttu-id="c61dc-165">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-165">Yes</span></span> |<span data-ttu-id="c61dc-166">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-166">Yes</span></span> |<span data-ttu-id="c61dc-167">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-167">Yes</span></span> |
| <span data-ttu-id="c61dc-168">Только значения параметров конфигурации</span><span class="sxs-lookup"><span data-stu-id="c61dc-168">Values (but not names) of configuration settings</span></span> |<span data-ttu-id="c61dc-169">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-169">Yes</span></span> |<span data-ttu-id="c61dc-170">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-170">Yes</span></span> |<span data-ttu-id="c61dc-171">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-171">Yes</span></span> |
| <span data-ttu-id="c61dc-172">Добавление сертификатов</span><span class="sxs-lookup"><span data-stu-id="c61dc-172">Add new certificates</span></span> |<span data-ttu-id="c61dc-173">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-173">Yes</span></span> |<span data-ttu-id="c61dc-174">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-174">Yes</span></span> |<span data-ttu-id="c61dc-175">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-175">Yes</span></span> |
| <span data-ttu-id="c61dc-176">Изменение существующих сертификатов</span><span class="sxs-lookup"><span data-stu-id="c61dc-176">Change existing certificates</span></span> |<span data-ttu-id="c61dc-177">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-177">Yes</span></span> |<span data-ttu-id="c61dc-178">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-178">Yes</span></span> |<span data-ttu-id="c61dc-179">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-179">Yes</span></span> |
| <span data-ttu-id="c61dc-180">Развертывание нового кода</span><span class="sxs-lookup"><span data-stu-id="c61dc-180">Deploy new code</span></span> |<span data-ttu-id="c61dc-181">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-181">Yes</span></span> |<span data-ttu-id="c61dc-182">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-182">Yes</span></span> |<span data-ttu-id="c61dc-183">Да</span><span class="sxs-lookup"><span data-stu-id="c61dc-183">Yes</span></span> |

<span data-ttu-id="c61dc-184"><sup>1</sup> Размер можно изменять в пределах подмножества размеров, доступных для облачной службы.</span><span class="sxs-lookup"><span data-stu-id="c61dc-184"><sup>1</sup> Size change limited to the subset of sizes available for the cloud service.</span></span>

<span data-ttu-id="c61dc-185"><sup>2</sup> Требуется пакет SDK Azure 1.5 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="c61dc-185"><sup>2</sup> Requires Azure SDK 1.5 or later versions.</span></span>

> [!WARNING]
> <span data-ttu-id="c61dc-186">Изменение размера виртуальной машины приведет к уничтожению локальных данных.</span><span class="sxs-lookup"><span data-stu-id="c61dc-186">Changing the virtual machine size will destroy local data.</span></span>
>
>

<span data-ttu-id="c61dc-187">Следующие действия не могут выполняться во время обновления:</span><span class="sxs-lookup"><span data-stu-id="c61dc-187">The following items are not supported during an update:</span></span>

* <span data-ttu-id="c61dc-188">Изменение имени роли.</span><span class="sxs-lookup"><span data-stu-id="c61dc-188">Changing the name of a role.</span></span> <span data-ttu-id="c61dc-189">Роль следует удалить, а затем добавить с новым именем.</span><span class="sxs-lookup"><span data-stu-id="c61dc-189">Remove and then add the role with the new name.</span></span>
* <span data-ttu-id="c61dc-190">Изменение количества доменов обновления.</span><span class="sxs-lookup"><span data-stu-id="c61dc-190">Changing of the Upgrade Domain count.</span></span>
* <span data-ttu-id="c61dc-191">Уменьшение размера локальных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="c61dc-191">Decreasing the size of the local resources.</span></span>

<span data-ttu-id="c61dc-192">Чтобы внести другие изменения в определение службы, например уменьшить размер локального ресурса, вы можете выполнить переключение виртуального IP-адреса.</span><span class="sxs-lookup"><span data-stu-id="c61dc-192">If you are making other updates to your service's definition, such as decreasing the size of local resource, you must perform a VIP swap update instead.</span></span> <span data-ttu-id="c61dc-193">Дополнительные сведения см. в статье о [переключении развертывания](https://msdn.microsoft.com/library/azure/ee460814.aspx).</span><span class="sxs-lookup"><span data-stu-id="c61dc-193">For more information, see [Swap Deployment](https://msdn.microsoft.com/library/azure/ee460814.aspx).</span></span>

<a name="howanupgradeproceeds"></a>

## <a name="how-an-upgrade-proceeds"></a><span data-ttu-id="c61dc-194">Как происходит обновление</span><span class="sxs-lookup"><span data-stu-id="c61dc-194">How an upgrade proceeds</span></span>
<span data-ttu-id="c61dc-195">Вы можете выбрать обновление всех ролей службы или только одной.</span><span class="sxs-lookup"><span data-stu-id="c61dc-195">You can decide whether you want to update all of the roles in your service or a single role in the service.</span></span> <span data-ttu-id="c61dc-196">В любом случае сначала Azure остановит, обновит и снова запустит все экземпляры всех обновляемых ролей, входящих в первый домен обновления.</span><span class="sxs-lookup"><span data-stu-id="c61dc-196">In either case, all instances of each role that is being upgraded and belong to the first upgrade domain are stopped, upgraded, and brought back online.</span></span> <span data-ttu-id="c61dc-197">Когда все роли возобновят работу, экземпляры во втором домене обновления будут остановлены, обновлены и запущены.</span><span class="sxs-lookup"><span data-stu-id="c61dc-197">Once they are back online, the instances in the second upgrade domain are stopped, upgraded, and brought back online.</span></span> <span data-ttu-id="c61dc-198">Для каждой облачной службы в один момент времени выполняется только один процесс обновления.</span><span class="sxs-lookup"><span data-stu-id="c61dc-198">A cloud service can have at most one upgrade active at a time.</span></span> <span data-ttu-id="c61dc-199">Обновление всегда выполняется до самой последней версии облачной службы.</span><span class="sxs-lookup"><span data-stu-id="c61dc-199">The upgrade is always performed against the latest version of the cloud service.</span></span>

<span data-ttu-id="c61dc-200">На следующей схеме показан процесс обновления всех ролей в службе.</span><span class="sxs-lookup"><span data-stu-id="c61dc-200">The following diagram illustrates how the upgrade proceeds if you are upgrading all of the roles in the service:</span></span>

<span data-ttu-id="c61dc-201">![Обновление службы](media/cloud-services-update-azure-service/IC345879.png "Обновление службы")</span><span class="sxs-lookup"><span data-stu-id="c61dc-201">![Upgrade service](media/cloud-services-update-azure-service/IC345879.png "Upgrade service")</span></span>

<span data-ttu-id="c61dc-202">На следующей диаграмме показан процесс обновления одной роли службы.</span><span class="sxs-lookup"><span data-stu-id="c61dc-202">This next diagram illustrates how the update proceeds if you are upgrading only a single role:</span></span>

<span data-ttu-id="c61dc-203">![Обновление роли](media/cloud-services-update-azure-service/IC345880.png "Обновление роли")</span><span class="sxs-lookup"><span data-stu-id="c61dc-203">![Upgrade role](media/cloud-services-update-azure-service/IC345880.png "Upgrade role")</span></span>  

<span data-ttu-id="c61dc-204">В ходе автоматического обновления контроллер структуры Azure периодически проверяет работоспособность облачной службы, чтобы определить безопасный момент для перехода к следующему домену обновления.</span><span class="sxs-lookup"><span data-stu-id="c61dc-204">During an automatic update, the Azure Fabric Controller periodically evaluates the health of the cloud service to determine when it’s safe to walk the next UD.</span></span> <span data-ttu-id="c61dc-205">Проверка работоспособности выполняется для каждой роли отдельно с учетом экземпляров только самой последней версии (т. е. экземпляров из тех доменов обновления, для которых процесс уже начат).</span><span class="sxs-lookup"><span data-stu-id="c61dc-205">This health evaluation is performed on a per-role basis and considers only instances in the latest version (i.e. instances from UDs that have already been walked).</span></span> <span data-ttu-id="c61dc-206">Чтобы служба считалась работоспособной, удовлетворительного конечного состояния должно достичь минимальное заданное количество экземпляров каждой роли.</span><span class="sxs-lookup"><span data-stu-id="c61dc-206">It verifies that a minimum number of role instances, for each role, have achieved a satisfactory terminal state.</span></span>

### <a name="role-instance-start-timeout"></a><span data-ttu-id="c61dc-207">Время ожидания запуска экземпляра роли</span><span class="sxs-lookup"><span data-stu-id="c61dc-207">Role Instance Start Timeout</span></span>
<span data-ttu-id="c61dc-208">Контроллер структуры будет 30 минут ожидать перехода каждого экземпляра роли в запущенное состояние.</span><span class="sxs-lookup"><span data-stu-id="c61dc-208">The Fabric Controller will wait 30 minutes for each role instance to reach a Started state.</span></span> <span data-ttu-id="c61dc-209">По истечении времени ожидания контроллер структуры переходит к следующему экземпляру роли.</span><span class="sxs-lookup"><span data-stu-id="c61dc-209">If the timeout duration elapses, the Fabric Controller will continue walking to the next role instance.</span></span>

### <a name="impact-to-drive-data-during-cloud-service-upgrades"></a><span data-ttu-id="c61dc-210">Влияние установки новой версии облачной службы на данные, хранящиеся на дисках</span><span class="sxs-lookup"><span data-stu-id="c61dc-210">Impact to drive data during Cloud Service upgrades</span></span>

<span data-ttu-id="c61dc-211">Если при обновлении службы количество ее экземпляров увеличивается от одного до нескольких, Azure остановит такую службу на время обновления. Это обусловлено особенностями процесса обновления.</span><span class="sxs-lookup"><span data-stu-id="c61dc-211">When upgrading a service from a single instance to multiple instances your service will be brought down while the upgrade is performed due to the way Azure upgrades services.</span></span> <span data-ttu-id="c61dc-212">Соглашение об уровне обслуживания, гарантирующее доступность службы, применяется только для служб с несколькими экземплярами.</span><span class="sxs-lookup"><span data-stu-id="c61dc-212">The service level agreement guaranteeing service availability only applies to services that are deployed with more than one instance.</span></span> <span data-ttu-id="c61dc-213">Следующий список описывает, что происходит с данными на дисках при различных сценариях обновления службы Azure.</span><span class="sxs-lookup"><span data-stu-id="c61dc-213">The following list describes how the data on each drive is affected by each Azure service upgrade scenario:</span></span>

|<span data-ttu-id="c61dc-214">Сценарий</span><span class="sxs-lookup"><span data-stu-id="c61dc-214">Scenario</span></span>|<span data-ttu-id="c61dc-215">Диск C</span><span class="sxs-lookup"><span data-stu-id="c61dc-215">C Drive</span></span>|<span data-ttu-id="c61dc-216">Диск D</span><span class="sxs-lookup"><span data-stu-id="c61dc-216">D Drive</span></span>|<span data-ttu-id="c61dc-217">Диск Е</span><span class="sxs-lookup"><span data-stu-id="c61dc-217">E Drive</span></span>|
|--------|-------|-------|-------|
|<span data-ttu-id="c61dc-218">Перезагрузка виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="c61dc-218">VM reboot</span></span>|<span data-ttu-id="c61dc-219">Сохраняются</span><span class="sxs-lookup"><span data-stu-id="c61dc-219">Preserved</span></span>|<span data-ttu-id="c61dc-220">Сохраняются</span><span class="sxs-lookup"><span data-stu-id="c61dc-220">Preserved</span></span>|<span data-ttu-id="c61dc-221">Сохраняются</span><span class="sxs-lookup"><span data-stu-id="c61dc-221">Preserved</span></span>|
|<span data-ttu-id="c61dc-222">Перезагрузка портала</span><span class="sxs-lookup"><span data-stu-id="c61dc-222">Portal reboot</span></span>|<span data-ttu-id="c61dc-223">Сохраняются</span><span class="sxs-lookup"><span data-stu-id="c61dc-223">Preserved</span></span>|<span data-ttu-id="c61dc-224">Сохраняются</span><span class="sxs-lookup"><span data-stu-id="c61dc-224">Preserved</span></span>|<span data-ttu-id="c61dc-225">Уничтожаются</span><span class="sxs-lookup"><span data-stu-id="c61dc-225">Destroyed</span></span>|
|<span data-ttu-id="c61dc-226">Пересоздание образа портала</span><span class="sxs-lookup"><span data-stu-id="c61dc-226">Portal reimage</span></span>|<span data-ttu-id="c61dc-227">Сохраняются</span><span class="sxs-lookup"><span data-stu-id="c61dc-227">Preserved</span></span>|<span data-ttu-id="c61dc-228">Уничтожаются</span><span class="sxs-lookup"><span data-stu-id="c61dc-228">Destroyed</span></span>|<span data-ttu-id="c61dc-229">Уничтожаются</span><span class="sxs-lookup"><span data-stu-id="c61dc-229">Destroyed</span></span>|
|<span data-ttu-id="c61dc-230">Обновление «на месте»</span><span class="sxs-lookup"><span data-stu-id="c61dc-230">In-Place Upgrade</span></span>|<span data-ttu-id="c61dc-231">Сохраняются</span><span class="sxs-lookup"><span data-stu-id="c61dc-231">Preserved</span></span>|<span data-ttu-id="c61dc-232">Сохраняются</span><span class="sxs-lookup"><span data-stu-id="c61dc-232">Preserved</span></span>|<span data-ttu-id="c61dc-233">Уничтожаются</span><span class="sxs-lookup"><span data-stu-id="c61dc-233">Destroyed</span></span>|
|<span data-ttu-id="c61dc-234">Миграция узла</span><span class="sxs-lookup"><span data-stu-id="c61dc-234">Node migration</span></span>|<span data-ttu-id="c61dc-235">Уничтожаются</span><span class="sxs-lookup"><span data-stu-id="c61dc-235">Destroyed</span></span>|<span data-ttu-id="c61dc-236">Уничтожаются</span><span class="sxs-lookup"><span data-stu-id="c61dc-236">Destroyed</span></span>|<span data-ttu-id="c61dc-237">Уничтожаются</span><span class="sxs-lookup"><span data-stu-id="c61dc-237">Destroyed</span></span>|

<span data-ttu-id="c61dc-238">Обратите внимание, что в приведенном выше списке диск E: обозначает корневой диск роли. Это значение не должно быть жестко запрограммированным.</span><span class="sxs-lookup"><span data-stu-id="c61dc-238">Note that, in the above list, the E: drive represents the role’s root drive, and should not be hard-coded.</span></span> <span data-ttu-id="c61dc-239">Для обращения к этому диску используйте переменную среды **%RoleRoot%**.</span><span class="sxs-lookup"><span data-stu-id="c61dc-239">Instead, use the **%RoleRoot%** environment variable to represent the drive.</span></span>

<span data-ttu-id="c61dc-240">Чтобы сократить время простоя при обновлении службы с одним экземпляром, вы можете развернуть на промежуточном сервере новую службу с несколькими экземплярами и выполнить переключение виртуального IP-адреса.</span><span class="sxs-lookup"><span data-stu-id="c61dc-240">To minimize the downtime when upgrading a single-instance service, deploy a new multi-instance service to the staging server and perform a VIP swap.</span></span>

<a name="RollbackofanUpdate"></a>

## <a name="rollback-of-an-update"></a><span data-ttu-id="c61dc-241">Откат обновления</span><span class="sxs-lookup"><span data-stu-id="c61dc-241">Rollback of an update</span></span>
<span data-ttu-id="c61dc-242">Во время обновления Azure обеспечивает определенную гибкость в управлении службами. Система принимает запросы на дополнительные операции для службы даже после того, как контроллер структуры Azure получит первичный запрос на обновление.</span><span class="sxs-lookup"><span data-stu-id="c61dc-242">Azure provides flexibility in managing services during an update by letting you initiate additional operations on a service, after the initial update request is accepted by the Azure Fabric Controller.</span></span> <span data-ttu-id="c61dc-243">Откат может быть выполнен только тогда, когда обновление версии или конфигурации развертывания находится в состоянии **выполнения**.</span><span class="sxs-lookup"><span data-stu-id="c61dc-243">A rollback can only be performed when an update (configuration change) or upgrade is in the **in progress** state on the deployment.</span></span> <span data-ttu-id="c61dc-244">Обновление версии или конфигурации считается выполняющимся, если существует хотя бы один экземпляр службы, который еще не обновлен до новой версии.</span><span class="sxs-lookup"><span data-stu-id="c61dc-244">An update or upgrade is considered to be in-progress as long as there is at least one instance of the service which has not yet been updated to the new version.</span></span> <span data-ttu-id="c61dc-245">Чтобы проверить возможность отката, убедитесь, что тег RollbackAllowed имеет значение True (значение этого тега возвращают операции [Получить развертывание](https://msdn.microsoft.com/library/azure/ee460804.aspx) и [Получить свойства облачной службы](https://msdn.microsoft.com/library/azure/ee460806.aspx)).</span><span class="sxs-lookup"><span data-stu-id="c61dc-245">To test whether a rollback is allowed, check the value of the RollbackAllowed flag, returned by [Get Deployment](https://msdn.microsoft.com/library/azure/ee460804.aspx) and [Get Cloud Service Properties](https://msdn.microsoft.com/library/azure/ee460806.aspx) operations, is set to true.</span></span>

> [!NOTE]
> <span data-ttu-id="c61dc-246">Откат имеет смысл только в случае обновления **на месте** , так как обновление путем переключения виртуального IP-адреса подразумевает замену одного работающего экземпляра службы другим.</span><span class="sxs-lookup"><span data-stu-id="c61dc-246">It only makes sense to call Rollback on an **in-place** update or upgrade because VIP swap upgrades involve replacing one entire running instance of your service with another.</span></span>
>
>

<span data-ttu-id="c61dc-247">Откат выполняющегося обновления влияет на развертывание следующим образом.</span><span class="sxs-lookup"><span data-stu-id="c61dc-247">Rollback of an in-progress update has the following effects on the deployment:</span></span>

* <span data-ttu-id="c61dc-248">Все экземпляры ролей, которые еще не были обновлены, останутся в прежнем состоянии, поскольку на них выполняется нужная версия службы.</span><span class="sxs-lookup"><span data-stu-id="c61dc-248">Any role instances which had not yet been updated or upgraded to the new version are not updated or upgraded, because those instances are already running the target version of the service.</span></span>
* <span data-ttu-id="c61dc-249">На все экземпляры ролей с установленными новыми версиями файла пакета (\*.cspkg) и/или файла конфигурации (\*.cscfg) будут возвращены старые версии этих файлов.</span><span class="sxs-lookup"><span data-stu-id="c61dc-249">Any role instances which had already been updated or upgraded to the new version of the service package (\*.cspkg) file or the service configuration (\*.cscfg) file (or both files) are reverted to the pre-upgrade version of these files.</span></span>

<span data-ttu-id="c61dc-250">Это обеспечивается следующими функциями.</span><span class="sxs-lookup"><span data-stu-id="c61dc-250">This functionally is provided by the following features:</span></span>

* <span data-ttu-id="c61dc-251">Операция [Откатить обновление](https://msdn.microsoft.com/library/azure/hh403977.aspx). Ее можно вызвать во время обновления конфигурации (запускается операцией [Изменить конфигурацию развертывания](https://msdn.microsoft.com/library/azure/ee460809.aspx)) или версии (запускается операцией [Обновить развертывание](https://msdn.microsoft.com/library/azure/ee460793.aspx)) при условии, что хотя бы один экземпляр службы еще не был обновлен до новой версии.</span><span class="sxs-lookup"><span data-stu-id="c61dc-251">The [Rollback Update Or Upgrade](https://msdn.microsoft.com/library/azure/hh403977.aspx) operation, which can be called on a configuration update (triggered by calling [Change Deployment Configuration](https://msdn.microsoft.com/library/azure/ee460809.aspx)) or an upgrade (triggered by calling [Upgrade Deployment](https://msdn.microsoft.com/library/azure/ee460793.aspx)) as long as there is at least one instance in the service which has not yet been updated to the new version.</span></span>
* <span data-ttu-id="c61dc-252">Элементы Locked и RollbackAllowed, которые возвращаются в теле ответа операциями [Получить развертывание](https://msdn.microsoft.com/library/azure/ee460804.aspx) и [Получить свойства облачной службы](https://msdn.microsoft.com/library/azure/ee460806.aspx).</span><span class="sxs-lookup"><span data-stu-id="c61dc-252">The Locked element and the RollbackAllowed element, which are returned as part of the response body of the [Get Deployment](https://msdn.microsoft.com/library/azure/ee460804.aspx) and [Get Cloud Service Properties](https://msdn.microsoft.com/library/azure/ee460806.aspx) operations:</span></span>

  1. <span data-ttu-id="c61dc-253">Элемент Locked (Заблокировано) позволяет определить, можно ли выполнять операции изменения в этом развертывании.</span><span class="sxs-lookup"><span data-stu-id="c61dc-253">The Locked element allows you to detect when a mutating operation can be invoked on a given deployment.</span></span>
  2. <span data-ttu-id="c61dc-254">Элемент RollbackAllowed (Откат разрешен) позволяет определить, можно ли выполнять операцию [Откатить обновление](https://msdn.microsoft.com/library/azure/hh403977.aspx) в этом развертывании.</span><span class="sxs-lookup"><span data-stu-id="c61dc-254">The RollbackAllowed element allows you to detect when the [Rollback Update Or Upgrade](https://msdn.microsoft.com/library/azure/hh403977.aspx) operation can be called on a given deployment.</span></span>

  <span data-ttu-id="c61dc-255">Чтобы выполнить откат, не обязательно проверять оба элемента (Locked и RollbackAllowed).</span><span class="sxs-lookup"><span data-stu-id="c61dc-255">In order to perform a rollback, you do not have to check both the Locked and the RollbackAllowed elements.</span></span> <span data-ttu-id="c61dc-256">Достаточно удостовериться, что RollbackAllowed имеет значение True.</span><span class="sxs-lookup"><span data-stu-id="c61dc-256">It suffices to confirm that RollbackAllowed is set to true.</span></span> <span data-ttu-id="c61dc-257">Эти элементы возвращаются только в том случае, если в запросе при вызове метода указан заголовок x-ms-version: 2011-10-01 или с более поздней версией.</span><span class="sxs-lookup"><span data-stu-id="c61dc-257">These elements are only returned if these methods are invoked by using the request header set to “x-ms-version: 2011-10-01” or a later version.</span></span> <span data-ttu-id="c61dc-258">Подробнее о заголовках управления версиями см. в статье [Работа с версиями при управлении службами](https://msdn.microsoft.com/library/azure/gg592580.aspx).</span><span class="sxs-lookup"><span data-stu-id="c61dc-258">For more information about versioning headers, see [Service Management Versioning](https://msdn.microsoft.com/library/azure/gg592580.aspx).</span></span>

<span data-ttu-id="c61dc-259">Существуют ситуации, когда откат обновления невозможен. Примеры таких ситуаций представлены ниже.</span><span class="sxs-lookup"><span data-stu-id="c61dc-259">There are some situations where a rollback of an update or upgrade is not supported, these are as follows:</span></span>

* <span data-ttu-id="c61dc-260">Сокращение размера локальных ресурсов — если обновление увеличивает локальные ресурсы для роли, платформа Azure запрещает выполнять откат.</span><span class="sxs-lookup"><span data-stu-id="c61dc-260">Reduction in local resources - If the update increases the local resources for a role the Azure platform does not allow rolling back.</span></span>
* <span data-ttu-id="c61dc-261">Ограничения квоты — если обновление предусматривает уменьшение масштаба, вы можете выйти за рамки квоты на вычислительные ресурсы для завершения отката.</span><span class="sxs-lookup"><span data-stu-id="c61dc-261">Quota limitations - If the update was a scale down operation you may no longer have sufficient compute quota to complete the rollback operation.</span></span> <span data-ttu-id="c61dc-262">Для каждой подписки Azure установлена определенная квота на количество ядер, которые могут использовать все службы в рамках этой подписки.</span><span class="sxs-lookup"><span data-stu-id="c61dc-262">Each Azure subscription has a quota associated with it that specifies the maximum number of cores which can be consumed by all hosted services that belong to that subscription.</span></span> <span data-ttu-id="c61dc-263">Если для выполнения отката обновления требуется превысить квоту подписки, такой откат будет запрещен.</span><span class="sxs-lookup"><span data-stu-id="c61dc-263">If performing a rollback of a given update would put your subscription over quota then that a rollback will not be enabled.</span></span>
* <span data-ttu-id="c61dc-264">Состояние гонки — если обновление уже завершено, откат невозможен.</span><span class="sxs-lookup"><span data-stu-id="c61dc-264">Race condition - If the initial update has completed, a rollback is not possible.</span></span>

<span data-ttu-id="c61dc-265">Давайте рассмотрим ситуацию, когда может быть полезен откат обновления. Вы запускаете операцию [Обновить развертывание](https://msdn.microsoft.com/library/azure/ee460793.aspx) в ручном режиме, чтобы управлять скоростью крупномасштабного обновления размещенной в Azure службы, которое выполняется на месте.</span><span class="sxs-lookup"><span data-stu-id="c61dc-265">An example of when the rollback of an update might be useful is if you are using the [Upgrade Deployment](https://msdn.microsoft.com/library/azure/ee460793.aspx) operation in manual mode to control the rate at which a major in-place upgrade to your Azure hosted service is rolled out.</span></span>

<span data-ttu-id="c61dc-266">Во время выполнения автоматического обновления вы запускаете операцию [Обновить развертывание](https://msdn.microsoft.com/library/azure/ee460793.aspx) в ручном режиме и начинаете отслеживать домены обновления.</span><span class="sxs-lookup"><span data-stu-id="c61dc-266">During the rollout of the upgrade you call [Upgrade Deployment](https://msdn.microsoft.com/library/azure/ee460793.aspx) in manual mode and begin to walk upgrade domains.</span></span> <span data-ttu-id="c61dc-267">В определенный момент, контролируя ход обновления, вы замечаете, что некоторые экземпляры роли в первых доменах обновления перестали отвечать на запросы. В этот момент вы можете вызвать операцию [Откатить обновление](https://msdn.microsoft.com/library/azure/hh403977.aspx), которая оставит без изменений необновленные экземпляры, а обновленные вернет к прежнему состоянию пакета и конфигурации службы.</span><span class="sxs-lookup"><span data-stu-id="c61dc-267">If at some point, as you monitor the upgrade, you note some role instances in the first upgrade domains that you examine have become unresponsive, you can call the [Rollback Update Or Upgrade](https://msdn.microsoft.com/library/azure/hh403977.aspx) operation on the deployment, which will leave untouched the instances which had not yet been upgraded and rollback instances which had been upgraded to the previous service package and configuration.</span></span>

<a name="multiplemutatingoperations"></a>

## <a name="initiating-multiple-mutating-operations-on-an-ongoing-deployment"></a><span data-ttu-id="c61dc-268">Запуск нескольких операций изменения в текущем развертывании</span><span class="sxs-lookup"><span data-stu-id="c61dc-268">Initiating multiple mutating operations on an ongoing deployment</span></span>
<span data-ttu-id="c61dc-269">В некоторых случаях будет удобно одновременно запустить несколько операций изменения в рамках текущего развертывания.</span><span class="sxs-lookup"><span data-stu-id="c61dc-269">In some cases you may want to initiate multiple simultaneous mutating operations on an ongoing deployment.</span></span> <span data-ttu-id="c61dc-270">Например, во время обновления службы вам может понадобиться внести какие-то изменения, например откатить это обновление, применить другое обновление или даже удалить развертывание.</span><span class="sxs-lookup"><span data-stu-id="c61dc-270">For example, you may perform a service update and, while that update is being rolled out across your service, you want to make some change, e.g. to roll the update back, apply a different update, or even delete the deployment.</span></span> <span data-ttu-id="c61dc-271">Эта необходимость может возникнуть, если обновление службы содержит ошибку в коде, из-за которой обновленные экземпляры роли постоянно завершаются сбоем.</span><span class="sxs-lookup"><span data-stu-id="c61dc-271">A case in which this might be necessary is if a service upgrade contains buggy code which causes an upgraded role instance to repeatedly crash.</span></span> <span data-ttu-id="c61dc-272">В этом случае контроллер структуры Azure не сможет завершить процесс обновления, поскольку в текущем домене обновления не будет запущено достаточное количество работоспособных экземпляров.</span><span class="sxs-lookup"><span data-stu-id="c61dc-272">In this case, the Azure Fabric Controller will not be able to make progress in applying that upgrade because an insufficient number of instances in the upgraded domain are healthy.</span></span> <span data-ttu-id="c61dc-273">Такое состояние называется *константной неисправностью развертывания*.</span><span class="sxs-lookup"><span data-stu-id="c61dc-273">This state is referred to as a *stuck deployment*.</span></span> <span data-ttu-id="c61dc-274">Выйти из этой ситуации поможет откат обновления или применение свежего обновления поверх неисправного.</span><span class="sxs-lookup"><span data-stu-id="c61dc-274">You can unstick the deployment by rolling back the update or applying a fresh update over top of the failing one.</span></span>

<span data-ttu-id="c61dc-275">Когда первоначальный запрос на обновление службы будет принят контроллером структуры Azure, можно начинать другие операции изменения.</span><span class="sxs-lookup"><span data-stu-id="c61dc-275">Once the initial request to update or upgrade the service has been received by the Azure Fabric Controller, you can start subsequent mutating operations.</span></span> <span data-ttu-id="c61dc-276">Таким образом, чтобы начать следующую операцию изменения, вам не нужно ждать завершения предыдущей.</span><span class="sxs-lookup"><span data-stu-id="c61dc-276">That is, you do not have to wait for the initial operation to complete before you can start another mutating operation.</span></span>

<span data-ttu-id="c61dc-277">Запуск второй операции обновления во время первого обновления будет обработан так же, как операция отката.</span><span class="sxs-lookup"><span data-stu-id="c61dc-277">Initiating a second update operation while the first update is ongoing will perform similar to the rollback operation.</span></span> <span data-ttu-id="c61dc-278">Если второе обновление выполняется в автоматическом режиме, первый домен обновления будет обновлен немедленно. Это может привести к тому, что одновременно будут отключены экземпляры из нескольких доменов обновления.</span><span class="sxs-lookup"><span data-stu-id="c61dc-278">If the second update is in automatic mode, the first upgrade domain will be upgraded immediately, possibly leading to instances from multiple upgrade domains being offline at the same point in time.</span></span>

<span data-ttu-id="c61dc-279">Существуют следующие операции изменения: [Изменить конфигурацию развертывания](https://msdn.microsoft.com/library/azure/ee460809.aspx), [Обновить развертывание](https://msdn.microsoft.com/library/azure/ee460793.aspx), [Обновить состояние развертывания](https://msdn.microsoft.com/library/azure/ee460808.aspx), [Удалить развертывание](https://msdn.microsoft.com/library/azure/ee460815.aspx) и [Откатить обновление](https://msdn.microsoft.com/library/azure/hh403977.aspx).</span><span class="sxs-lookup"><span data-stu-id="c61dc-279">The mutating operations are as follows: [Change Deployment Configuration](https://msdn.microsoft.com/library/azure/ee460809.aspx), [Upgrade Deployment](https://msdn.microsoft.com/library/azure/ee460793.aspx), [Update Deployment Status](https://msdn.microsoft.com/library/azure/ee460808.aspx), [Delete Deployment](https://msdn.microsoft.com/library/azure/ee460815.aspx), and [Rollback Update Or Upgrade](https://msdn.microsoft.com/library/azure/hh403977.aspx).</span></span>

<span data-ttu-id="c61dc-280">Две операции ([Получить развертывание](https://msdn.microsoft.com/library/azure/ee460804.aspx) и [Получить свойства облачной службы](https://msdn.microsoft.com/library/azure/ee460806.aspx)) возвращают тег блокировки Locked, который позволяет определить, можно ли запустить операции изменения в определенном развертывании.</span><span class="sxs-lookup"><span data-stu-id="c61dc-280">Two operations, [Get Deployment](https://msdn.microsoft.com/library/azure/ee460804.aspx) and [Get Cloud Service Properties](https://msdn.microsoft.com/library/azure/ee460806.aspx), return the Locked flag which can be examined to determine whether a mutating operation can be invoked on a given deployment.</span></span>

<span data-ttu-id="c61dc-281">Чтобы получить эти элементы, в запросе при вызове метода должен быть указан заголовок «x-ms-version: 2011-10-01» или с более поздней версией.</span><span class="sxs-lookup"><span data-stu-id="c61dc-281">In order to call the version of these methods which returns the Locked flag, you must set request header to “x-ms-version: 2011-10-01” or a later.</span></span> <span data-ttu-id="c61dc-282">Подробнее о заголовках управления версиями см. в статье [Работа с версиями при управлении службами](https://msdn.microsoft.com/library/azure/gg592580.aspx).</span><span class="sxs-lookup"><span data-stu-id="c61dc-282">For more information about versioning headers, see [Service Management Versioning](https://msdn.microsoft.com/library/azure/gg592580.aspx).</span></span>

<a name="distributiondfroles"></a>

## <a name="distribution-of-roles-across-upgrade-domains"></a><span data-ttu-id="c61dc-283">Распределение ролей в доменах обновления</span><span class="sxs-lookup"><span data-stu-id="c61dc-283">Distribution of roles across upgrade domains</span></span>
<span data-ttu-id="c61dc-284">Azure равномерно распределяет экземпляры роли по заданному количеству доменов обновления, которое можно указать в файле определения службы (CSDEF).</span><span class="sxs-lookup"><span data-stu-id="c61dc-284">Azure distributes instances of a role evenly across a set number of upgrade domains, which can be configured as part of the service definition (.csdef) file.</span></span> <span data-ttu-id="c61dc-285">По умолчанию используется 5 доменов обновления, а максимально возможное количество равно 20.</span><span class="sxs-lookup"><span data-stu-id="c61dc-285">The max number of upgrade domains is 20 and the default is 5.</span></span> <span data-ttu-id="c61dc-286">Подробнее об изменении файла определения службы см. в разделе о [схеме определения службы Azure (CSDEF-файл)](cloud-services-model-and-package.md#csdef).</span><span class="sxs-lookup"><span data-stu-id="c61dc-286">For more information about how to modify the service definition file, see [Azure Service Definition Schema (.csdef File)](cloud-services-model-and-package.md#csdef).</span></span>

<span data-ttu-id="c61dc-287">Например, для роли с 10 экземплярами к каждому домену обновления по умолчанию будет отнесено 2 экземпляра.</span><span class="sxs-lookup"><span data-stu-id="c61dc-287">For example, if your role has ten instances, by default each upgrade domain contains two instances.</span></span> <span data-ttu-id="c61dc-288">Если роль содержит 14 экземпляров, в четырех доменах обновления будет по три экземпляра, а в пятом — два экземпляра.</span><span class="sxs-lookup"><span data-stu-id="c61dc-288">If your role has 14 instances, then four of the upgrade domains contain three instances, and a fifth domain contains two.</span></span>

<span data-ttu-id="c61dc-289">Нумерация доменов обновления начинается с нуля: первый домен обновления имеет идентификатор 0, второй — идентификатор 1 и т. д.</span><span class="sxs-lookup"><span data-stu-id="c61dc-289">Upgrade domains are identified with a zero-based index: the first upgrade domain has an ID of 0, and the second upgrade domain has an ID of 1, and so on.</span></span>

<span data-ttu-id="c61dc-290">Следующая схема демонстрирует распределение экземпляров в службе, содержащей две роли, если задано два домена обновления.</span><span class="sxs-lookup"><span data-stu-id="c61dc-290">The following diagram illustrates how a service than contains two roles are distributed when the service defines two upgrade domains.</span></span> <span data-ttu-id="c61dc-291">Служба выполняет восемь экземпляров веб-роли и девять экземпляров рабочей роли.</span><span class="sxs-lookup"><span data-stu-id="c61dc-291">The service is running eight instances of the web role and nine instances of the worker role.</span></span>

<span data-ttu-id="c61dc-292">![Распределение доменов обновления](media/cloud-services-update-azure-service/IC345533.png "Распределение доменов обновления")</span><span class="sxs-lookup"><span data-stu-id="c61dc-292">![Distribution of Upgrade Domains](media/cloud-services-update-azure-service/IC345533.png "Distribution of Upgrade Domains")</span></span>

> [!NOTE]
> <span data-ttu-id="c61dc-293">Обратите внимание, что распределением экземпляров в домены обновления управляет Azure.</span><span class="sxs-lookup"><span data-stu-id="c61dc-293">Note that Azure controls how instances are allocated across upgrade domains.</span></span> <span data-ttu-id="c61dc-294">Вы не можете повлиять на то, в какой домен будут включены конкретные экземпляры.</span><span class="sxs-lookup"><span data-stu-id="c61dc-294">It's not possible to specify which instances are allocated to which domain.</span></span>
>
>

## <a name="next-steps"></a><span data-ttu-id="c61dc-295">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="c61dc-295">Next steps</span></span>
[<span data-ttu-id="c61dc-296">Управление облачными службами</span><span class="sxs-lookup"><span data-stu-id="c61dc-296">How to Manage Cloud Services</span></span>](cloud-services-how-to-manage.md)  
[<span data-ttu-id="c61dc-297">Мониторинг облачных служб</span><span class="sxs-lookup"><span data-stu-id="c61dc-297">How to Monitor Cloud Services</span></span>](cloud-services-how-to-monitor.md)  
[<span data-ttu-id="c61dc-298">Настройка облачных служб</span><span class="sxs-lookup"><span data-stu-id="c61dc-298">How to Configure Cloud Services</span></span>](cloud-services-how-to-configure.md)  

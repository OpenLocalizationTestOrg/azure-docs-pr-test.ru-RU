---
title: "Устранение ошибок выделения ресурсов для облачной службы | Документация Майкрософт"
description: "Устранение ошибки выделения при развертывании облачных служб в Azure"
services: azure-service-management, cloud-services
documentationcenter: 
author: simonxjx
manager: felixwu
editor: 
tags: top-support-issue
ms.assetid: 529157eb-e4a1-4388-aa2b-09e8b923af74
ms.service: cloud-services
ms.workload: na
ms.tgt_pltfrm: ibiza
ms.devlang: na
ms.topic: article
ms.date: 7/26/2017
ms.author: v-six
ms.openlocfilehash: 3379b6d9bea874abecae7e56d30cfb15e6b0c2fc
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="troubleshooting-allocation-failure-when-you-deploy-cloud-services-in-azure"></a><span data-ttu-id="79952-103">Устранение ошибки выделения при развертывании облачных служб в Azure</span><span class="sxs-lookup"><span data-stu-id="79952-103">Troubleshooting allocation failure when you deploy Cloud Services in Azure</span></span>
## <a name="summary"></a><span data-ttu-id="79952-104">Сводка</span><span class="sxs-lookup"><span data-stu-id="79952-104">Summary</span></span>
<span data-ttu-id="79952-105">При развертывании экземпляров в облачной службе или добавлении новых экземпляров веб-узлов или рабочих ролей Microsoft Azure выделяет вычислительные ресурсы.</span><span class="sxs-lookup"><span data-stu-id="79952-105">When you deploy instances to a Cloud Service or add new web or worker role instances, Microsoft Azure allocates compute resources.</span></span> <span data-ttu-id="79952-106">Иногда во время выполнения этих операций могут возникать ошибки, даже если еще не достигнуты ограничения подписки Azure.</span><span class="sxs-lookup"><span data-stu-id="79952-106">You may occasionally receive errors when performing these operations even before you reach the Azure subscription limits.</span></span> <span data-ttu-id="79952-107">В этой статье объясняются причины возникновения некоторых распространенных ошибок выделения, а также представлены возможные способы их устранения.</span><span class="sxs-lookup"><span data-stu-id="79952-107">This article explains the causes of some of the common allocation failures and suggests possible remediation.</span></span> <span data-ttu-id="79952-108">Эта информация также может быть полезна при планировании развертывания служб.</span><span class="sxs-lookup"><span data-stu-id="79952-108">The information may also be useful when you plan the deployment of your services.</span></span>

[!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]

### <a name="background--how-allocation-works"></a><span data-ttu-id="79952-109">Общая информация — принцип выделения ресурсов</span><span class="sxs-lookup"><span data-stu-id="79952-109">Background – How allocation works</span></span>
<span data-ttu-id="79952-110">Серверы в центрах обработки данных Azure разделены на кластеры.</span><span class="sxs-lookup"><span data-stu-id="79952-110">The servers in Azure datacenters are partitioned into clusters.</span></span> <span data-ttu-id="79952-111">Запрос о выделении новой облачной службы отправляется в несколько кластеров.</span><span class="sxs-lookup"><span data-stu-id="79952-111">A new cloud service allocation request is attempted in multiple clusters.</span></span> <span data-ttu-id="79952-112">Когда первый экземпляр развертывается в облачной службе (в тестовой или рабочей области), эта облачная служба прикрепляется к кластеру.</span><span class="sxs-lookup"><span data-stu-id="79952-112">When the first instance is deployed to a cloud service(in either staging or production), that cloud service gets pinned to a cluster.</span></span> <span data-ttu-id="79952-113">Все последующие развертывания облачной службы выполняются в том же кластере.</span><span class="sxs-lookup"><span data-stu-id="79952-113">Any further deployments for the cloud service will happen in the same cluster.</span></span> <span data-ttu-id="79952-114">В этой статье мы будем называть этот процесс прикреплением к кластеру.</span><span class="sxs-lookup"><span data-stu-id="79952-114">In this article, we'll refer to this as "pinned to a cluster".</span></span> <span data-ttu-id="79952-115">На приведенной ниже схеме 1 показано, как обычно происходит выделение при попытке выполнения в нескольких кластерах. На схеме 2 показано выделение ресурсов, прикрепленное к кластеру 2, так как в нем размещена существующая облачная служба CS_1.</span><span class="sxs-lookup"><span data-stu-id="79952-115">Diagram 1 below illustrates the case of a normal allocation which is attempted in multiple clusters; Diagram 2 illustrates the case of an allocation that's pinned to Cluster 2 because that's where the existing Cloud Service CS_1 is hosted.</span></span>

![Схема выделения ресурсов](./media/cloud-services-allocation-failure/Allocation1.png)

### <a name="why-allocation-failure-happens"></a><span data-ttu-id="79952-117">Причины возникновения ошибок выделения ресурсов</span><span class="sxs-lookup"><span data-stu-id="79952-117">Why allocation failure happens</span></span>
<span data-ttu-id="79952-118">Если запрос на выделение прикреплен к одному кластеру, возрастает вероятность того, что не удастся найти свободные ресурсы, так как пул доступных ресурсов ограничен размером кластера.</span><span class="sxs-lookup"><span data-stu-id="79952-118">When an allocation request is pinned to a cluster, there's a higher chance of failing to find free resources since the available resource pool is limited to a cluster.</span></span> <span data-ttu-id="79952-119">Кроме того, если запрос на выделение прикреплен к одному кластеру, а тип запрошенного ресурса не поддерживается, запрос завершится ошибкой, даже если в кластере есть свободные ресурсы.</span><span class="sxs-lookup"><span data-stu-id="79952-119">Furthermore, if your allocation request is pinned to a cluster but the type of resource you requested is not supported by that cluster, your request will fail even if the cluster has free resource.</span></span> <span data-ttu-id="79952-120">На схеме 3 ниже показан случай, когда ошибка выделения прикрепленных ресурсов произошла из-за отсутствия свободных ресурсов в единственном подходящем кластере.</span><span class="sxs-lookup"><span data-stu-id="79952-120">Diagram 3 below illustrates the case where a pinned allocation fails because the only candidate cluster does not have free resources.</span></span> <span data-ttu-id="79952-121">На схеме 4 показан случай, когда ошибка выделения прикрепленных ресурсов произошла потому, что единственный подходящий кластер не поддерживает запрошенный размер виртуальной машины, несмотря на наличие свободных ресурсов в кластере.</span><span class="sxs-lookup"><span data-stu-id="79952-121">Diagram 4 illustrates the case where a pinned allocation fails because the only candidate cluster does not support the requested VM size, even though the cluster has free resources.</span></span>

![Ошибка выделения прикрепленных ресурсов](./media/cloud-services-allocation-failure/Allocation2.png)

## <a name="troubleshooting-allocation-failure-for-cloud-services"></a><span data-ttu-id="79952-123">Устранение ошибок выделения для облачных служб</span><span class="sxs-lookup"><span data-stu-id="79952-123">Troubleshooting allocation failure for cloud services</span></span>
### <a name="error-message"></a><span data-ttu-id="79952-124">Сообщение об ошибке</span><span class="sxs-lookup"><span data-stu-id="79952-124">Error Message</span></span>
<span data-ttu-id="79952-125">Вы можете получить следующее сообщение об ошибке:</span><span class="sxs-lookup"><span data-stu-id="79952-125">You may see the following error message:</span></span>

    "Azure operation '{operation id}' failed with code Compute.ConstrainedAllocationFailed. Details: Allocation failed; unable to satisfy constraints in request. The requested new service deployment is bound to an Affinity Group, or it targets a Virtual Network, or there is an existing deployment under this hosted service. Any of these conditions constrains the new deployment to specific Azure resources. Please retry later or try reducing the VM size or number of role instances. Alternatively, if possible, remove the aforementioned constraints or try deploying to a different region."

### <a name="common-issues"></a><span data-ttu-id="79952-126">Распространенные проблемы</span><span class="sxs-lookup"><span data-stu-id="79952-126">Common Issues</span></span>
<span data-ttu-id="79952-127">В этом разделе описаны распространенные сценарии выделения ресурсов, вызывающие прикрепление запросов о распределении к отдельному кластеру.</span><span class="sxs-lookup"><span data-stu-id="79952-127">Here are the common allocation scenarios that cause an allocation request to be pinned to a single cluster.</span></span>

* <span data-ttu-id="79952-128">Развертывание в промежуточном слоте. Если в одном из слотов облачной службы имеется развертывание, вся облачная служба прикрепляется к определенному кластеру.</span><span class="sxs-lookup"><span data-stu-id="79952-128">Deploying to Staging Slot - If a cloud service has a deployment in either slot, then the entire cloud service is pinned to a specific cluster.</span></span>  <span data-ttu-id="79952-129">Это означает, что если развертывание уже существует в рабочей области, то новое промежуточное развертывание может быть выделено только в том же кластере, что и рабочая область.</span><span class="sxs-lookup"><span data-stu-id="79952-129">This means that if a deployment already exists in the production slot, then a new staging deployment can only be allocated in the same cluster as the production slot.</span></span> <span data-ttu-id="79952-130">Если кластер близок к заполнению, запрос может завершиться ошибкой.</span><span class="sxs-lookup"><span data-stu-id="79952-130">If the cluster is nearing capacity, the request may fail.</span></span>
* <span data-ttu-id="79952-131">Масштабирование. Для добавления новых экземпляров в существующую облачную службу требуется выделение ресурсов в том же кластере.</span><span class="sxs-lookup"><span data-stu-id="79952-131">Scaling - Adding new instances to an existing cloud service must allocate in the same cluster.</span></span>  <span data-ttu-id="79952-132">Для мелких запросов масштабирования ресурсы обычно выделяются, но это происходит не всегда.</span><span class="sxs-lookup"><span data-stu-id="79952-132">Small scaling requests can usually be allocated, but not always.</span></span> <span data-ttu-id="79952-133">Если кластер близок к заполнению, запрос может завершиться ошибкой.</span><span class="sxs-lookup"><span data-stu-id="79952-133">If the cluster is nearing capacity, the request may fail.</span></span>
* <span data-ttu-id="79952-134">Территориальная группа. Если облачная служба не прикреплена ни к какой территориальной группе, структура может распределить новое развертывание в пустую облачную службу в любом кластере соответствующего региона.</span><span class="sxs-lookup"><span data-stu-id="79952-134">Affinity Group - A new deployment to an empty cloud service can be allocated by the fabric in any cluster in that region, unless the cloud service is pinned to an affinity group.</span></span> <span data-ttu-id="79952-135">По возможности развертывания в одну и ту же территориальную группу будут выполняться в одном и том же кластере.</span><span class="sxs-lookup"><span data-stu-id="79952-135">Deployments to the same affinity group will be attempted on the same cluster.</span></span> <span data-ttu-id="79952-136">Если кластер близок к заполнению, запрос может завершиться ошибкой.</span><span class="sxs-lookup"><span data-stu-id="79952-136">If the cluster is nearing capacity, the request may fail.</span></span>
* <span data-ttu-id="79952-137">Территориальная группа vNet. Раньше виртуальные сети привязывались не к регионам, а к территориальным группам, а облачные службы в этих виртуальных сетях — к кластеру территориальной группы.</span><span class="sxs-lookup"><span data-stu-id="79952-137">Affinity Group vNet - Older Virtual Networks were tied to affinity groups instead of regions, and cloud services in these Virtual Networks would be pinned to the affinity group cluster.</span></span> <span data-ttu-id="79952-138">По возможности развертывания в виртуальную сеть такого типа будут выполняться в связанном кластере.</span><span class="sxs-lookup"><span data-stu-id="79952-138">Deployments to this type of virtual network will be attempted on the pinned cluster.</span></span> <span data-ttu-id="79952-139">Если кластер близок к заполнению, запрос может завершиться ошибкой.</span><span class="sxs-lookup"><span data-stu-id="79952-139">If the cluster is nearing capacity, the request may fail.</span></span>

## <a name="solutions"></a><span data-ttu-id="79952-140">Решения</span><span class="sxs-lookup"><span data-stu-id="79952-140">Solutions</span></span>
1. <span data-ttu-id="79952-141">Повторное развертывание в новую облачную службу. Данное решение, как правило, является самым удачным, поскольку позволяет платформе выбрать все кластеры в соответствующем регионе.</span><span class="sxs-lookup"><span data-stu-id="79952-141">Redeploy to a new cloud service - This solution is likely to be most successful as it allows the platform to choose from all clusters in that region.</span></span>

   * <span data-ttu-id="79952-142">Разверните рабочую нагрузку в новую облачную службу.</span><span class="sxs-lookup"><span data-stu-id="79952-142">Deploy the workload to a new cloud service</span></span>  
   * <span data-ttu-id="79952-143">Обновите запись CNAME или A таким образом, чтобы она направляла трафик в новую облачную службу.</span><span class="sxs-lookup"><span data-stu-id="79952-143">Update the CNAME or A record to point traffic to the new cloud service</span></span>
   * <span data-ttu-id="79952-144">После того как трафик, направляемый на старый сайт, станет нулевым, старую облачную службу можно будет удалить.</span><span class="sxs-lookup"><span data-stu-id="79952-144">Once zero traffic is going to the old site, you can delete the old cloud service.</span></span> <span data-ttu-id="79952-145">В этом случае время простоя должно быть нулевым.</span><span class="sxs-lookup"><span data-stu-id="79952-145">This solution should incur zero downtime.</span></span>
2. <span data-ttu-id="79952-146">Удалите рабочий и промежуточный слоты. Данное решение позволяет сохранить существующее имя DNS, но вызывает простой приложения.</span><span class="sxs-lookup"><span data-stu-id="79952-146">Delete both production and staging slots - This solution will preserve your existing DNS name, but will cause downtime to your application.</span></span>

   * <span data-ttu-id="79952-147">Удалите рабочий и промежуточный слоты существующей облачной службы, чтобы облачная служба стала пустой.</span><span class="sxs-lookup"><span data-stu-id="79952-147">Delete the production and staging slots of an existing cloud service so that the cloud service is empty, and then</span></span>
   * <span data-ttu-id="79952-148">Создайте в существующей облачной службе новое развертывание.</span><span class="sxs-lookup"><span data-stu-id="79952-148">Create a new deployment in the existing cloud service.</span></span> <span data-ttu-id="79952-149">Оно попытается заново распределить все кластеры в регионе.</span><span class="sxs-lookup"><span data-stu-id="79952-149">This will re-attempt to allocation on all clusters in the region.</span></span> <span data-ttu-id="79952-150">Убедитесь, что облачная служба не привязана к территориальной группе.</span><span class="sxs-lookup"><span data-stu-id="79952-150">Ensure the cloud service is not tied to an affinity group.</span></span>
3. <span data-ttu-id="79952-151">Зарезервированный IP-адрес. Это решение позволит сохранить существующий IP-адрес, но вызовет простой приложения.</span><span class="sxs-lookup"><span data-stu-id="79952-151">Reserved IP -  This solution will preserve your existing IP address, but will cause downtime to your application.</span></span>  

   * <span data-ttu-id="79952-152">Создайте адрес ReservedIP для существующего развертывания с помощью Powershell.</span><span class="sxs-lookup"><span data-stu-id="79952-152">Create a ReservedIP for your existing deployment using Powershell</span></span>

     ```
     New-AzureReservedIP -ReservedIPName {new reserved IP name} -Location {location} -ServiceName {existing service name}
     ```
   * <span data-ttu-id="79952-153">Выполните описанный выше пункт 2 и убедитесь, что в CSCFG службы указан новый адрес ReservedIP.</span><span class="sxs-lookup"><span data-stu-id="79952-153">Follow #2 from above, making sure to specify the new ReservedIP in the service's CSCFG.</span></span>
4. <span data-ttu-id="79952-154">Удалите территориальную группу для новых развертываний. Использовать территориальные группы больше не рекомендуются.</span><span class="sxs-lookup"><span data-stu-id="79952-154">Remove affinity group for new deployments - Affinity Groups are no longer recommended.</span></span> <span data-ttu-id="79952-155">Выполните описанный выше пункт 1, чтобы развернуть новую облачную службу.</span><span class="sxs-lookup"><span data-stu-id="79952-155">Follow steps for #1 above to deploy a new cloud service.</span></span> <span data-ttu-id="79952-156">Убедитесь, что облачная служба не входит в территориальную группу.</span><span class="sxs-lookup"><span data-stu-id="79952-156">Ensure cloud service is not in an affinity group.</span></span>
5. <span data-ttu-id="79952-157">Сведения о выполнении преобразования в региональную виртуальную сеть см. в статье [Переход от территориальных групп к региональной виртуальной сети](../virtual-network/virtual-networks-migrate-to-regional-vnet.md).</span><span class="sxs-lookup"><span data-stu-id="79952-157">Convert to a Regional Virtual Network - See [How to migrate from Affinity Groups to a Regional Virtual Network (VNet)](../virtual-network/virtual-networks-migrate-to-regional-vnet.md).</span></span>

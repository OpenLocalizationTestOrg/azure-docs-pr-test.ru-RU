---
title: "Планирование переноса ресурсов IaaS из классической модели в модель Azure Resource Manager | Документация Майкрософт"
description: "Планирование переноса ресурсов IaaS из классической модели развертывания в модель Azure Resource Manager."
services: virtual-machines-windows
documentationcenter: 
author: singhkays
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 78492a2c-2694-4023-a7b8-c97d3708dcb7
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: article
ms.date: 04/01/2017
ms.author: kasing
ms.openlocfilehash: db23eba9ff8debd5268cd02bc4f37c4e6501bfac
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="planning-for-migration-of-iaas-resources-from-classic-to-azure-resource-manager"></a>Планирование переноса ресурсов IaaS из классической модели в модель Azure Resource Manager
Хотя Azure Resource Manager и предлагает множество разнообразных возможностей, чрезвычайно важно спланировать процесс переноса ресурсов, чтобы не столкнуться с какими-либо проблемами. Грамотное планирование позволит предотвратить возникновение ошибок при выполнении действий по переносу ресурсов.

> [!NOTE]
> Над этим руководством тщательно поработала команда консультирования клиентов Azure, а также архитекторы облачных решений, которые помогали клиентам переносить большие среды. Данное руководство будет периодически обновляться новыми рекомендациями, поэтому мы советуем просматривать его время от времени.

Перенос ресурсов состоит из четырех основных этапов.<br>

![Этапы переноса](../media/virtual-machines-windows-migration-classic-resource-manager/plan-labtest-migrate-beyond.png)

## <a name="plan"></a>План

### <a name="technical-considerations-and-tradeoffs"></a>Технические вопросы и компромиссы

В зависимости от величины технических требований, географических регионов и применяемых методик, необходимо учесть следующее.

1. Почему ваша организация хочет перейти на использование Azure Resource Manager?  По каким коммерческим соображениям требуется перенести ресурсы?
2. Каковы технические причины использования Azure Resource Manager?  Какие из дополнительных служб Azure вы хотите использовать?
3. Какое приложение или какие наборы виртуальных машин участвуют в переносе ресурсов?
4. Какие сценарии поддерживает API миграции?  Ознакомьтесь со списком [возможностей и конфигураций, которые не поддерживаются](migration-classic-resource-manager-overview.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json#unsupported-features-and-configurations).
5. Поддерживают ли рабочие группы приложения и виртуальные машины в классической модели и модели Azure Resource Manager?
6. Каким образом Azure Resource Manager изменяет процессы развертывания, администрирования, мониторинга виртуальной машины и отправки отчетов?  Нужно ли обновлять сценарии развертывания?
7. Каков ваш план взаимодействия для оповещения заинтересованных лиц (пользователей, владельцев приложений и владельцев инфраструктур)?
8. Учитывая сложность среды, предусмотрен ли какой-либо период обслуживания, в течение которого приложение недоступно для пользователей и его владельцев?  Если да, то как надолго?
9. Каков план обучения заинтересованных лиц работе с Azure Resource Manager?
10. Что представляет собой план управления программой или проектом для переноса?
11. Сколько времени занимает переход на Azure Resource Manager и планируемое внедрение связанных технологий?  Согласованы ли они друг с другом оптимальным образом?

### <a name="patterns-of-success"></a>Рекомендации для удачного перемещения

У успешных клиентов есть подробные планы, где задокументированы соображения, касающиеся приведенных выше вопросов.  Спонсоры и заинтересованные лица должны быть хорошо ознакомлены с планами по переносу.  Чтобы получить представления о средствах и процедуре миграции, мы настоятельно рекомендуем изучить приведенные ниже руководства.

* [Обзор поддерживаемого платформой переноса ресурсов IaaS из классической модели в модель Azure Resource Manager](migration-classic-resource-manager-overview.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Техническое руководство по поддерживаемому платформой переносу из классической модели в модель Azure Resource Manager](migration-classic-resource-manager-deep-dive.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Planning for migration of IaaS resources from classic to Azure Resource Manager](migration-classic-resource-manager-plan.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (Планирование переноса ресурсов IaaS из классической модели в модель Azure Resource Manager)
* [Перенос ресурсов IaaS из классической модели в модель Azure Resource Manager с помощью Azure PowerShell](migration-classic-resource-manager-ps.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Перенос ресурсов IaaS из классической модели в модель Azure Resource Manager с помощью интерфейса командной строки Azure](../linux/migration-classic-resource-manager-cli.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Community tools to migrate IaaS resources from classic to Azure Resource Manager](migration-classic-resource-manager-community-tools.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (Инструменты сообщества для перемещения ресурсов IaaS из классической модели в модель Azure Resource Manager)
* [Распространенные ошибки миграции](migration-classic-resource-manager-errors.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Часто задаваемые вопросы о миграции из классической модели в модель Azure Resource Manager](migration-classic-resource-manager-faq.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)

### <a name="pitfalls-to-avoid"></a>Типичные недочеты

- Отказ от планирования.  Технические этапы переноса являются проверенными, а результат — прогнозируемым.
- Предположение о том, что имеется API миграции, поддерживаемый платформой, для всех сценариев. Поддерживаемые сценарии описаны в разделе о [возможностях и конфигурациях, которые не поддерживаются](migration-classic-resource-manager-overview.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json#unsupported-features-and-configurations).
- Отсутствие планирования потенциальных простоев в работе приложений для пользователей.  Рассчитайте достаточный буфер, чтобы соответствующим образом предупредить пользователей о потенциальном простое в работе приложения.


## <a name="lab-test"></a>Лабораторный анализ

**Репликация среды и выполнение тестового переноса**
  > [!NOTE]
  > Точная репликация существующей среды выполняется с помощью инструмента, предоставленного сообществом, который официально не поддерживается службой поддержки Майкрософт. Следовательно, этот шаг является **необязательным**, но это лучший способ обнаружить проблемы без реализации в рабочих средах. Если вы не планируете использовать этот инструмент, ознакомьтесь с приведенными ниже рекомендациями по проверке, подготовке и отмене пробного запуска.
  >

  Проведение лабораторного анализа конкретного сценария (вычислительных, сетевых ресурсов и ресурсов хранения) — залог успешного переноса ресурсов. На этом этапе вы можете:

  - Использовать отдельную лабораторную среду или существующую среду (отличную от рабочей среды) для тестирования. Мы советуем использовать отдельную лабораторную среду, которую можно переместить несколько раз и разрушительно изменить.  Ниже перечислены сценарии сбора и расконсервации метаданных из реальных подписок.
  - Хорошая идея — создать лабораторную среду в отдельной подписке. Так как лабораторная среда будет несколько раз удаляться, отдельная, изолированная подписка снизит вероятность ненамеренного удаления каких-нибудь существенных элементов.

  Для этого вы можете использовать инструмент AsmMetadataParser. См. дополнительные сведения о нем [здесь](https://github.com/Azure/classic-iaas-resourcemanager-migration/tree/master/AsmToArmMigrationApiToolset).

### <a name="patterns-of-success"></a>Рекомендации для удачного перемещения

Ниже представлены проблемы, характерные для многих масштабных переносов. Приведенный ниже список не является окончательным. С дополнительными сведениями можно ознакомиться в разделе о [возможностях и конфигурациях, которые не поддерживаются](migration-classic-resource-manager-overview.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json#unsupported-features-and-configurations).  Возможно, вы и не столкнетесь с этими техническими неполадками, но устранив их перед попыткой миграции, вы обеспечите плавный перенос ресурсов.

- **Выполнение проверки, подготовки и отмены пробного запуска**. Это, наверное, самый важный шаг в обеспечении успешного перемещения из классической модели в модель Azure Resource Manager. API миграции выполняет три основных этапа: проверку, подготовку и фиксацию. Проверка будет считывать состояние классической среды и возвращать сведения обо всех неполадках. Но так как некоторые проблемы могут быть связаны со стеком Azure Resource Manager, в результате проверки обнаружить удастся не все. Следующим шагом является процедура подготовки. С помощью подготовки метаданные перемещаются из классической модели в модель Azure Resource Manager, но при этом перемещение не фиксируется, и в классической модели ничего не удаляется и не изменяется. Пробный запуск включает в себя подготовку переноса, а затем отмену (**не фиксацию**) этой подготовки. Целью проверки, подготовки и отмены пробного запуска является просмотр всех метаданных в стеке Azure Resource Manager, их анализ (*программным образом или на портале*), а также проверка корректности переноса всех компонентов и устранение технических неполадок.  Таким образом вы также узнаете о продолжительности переноса, что позволит спланировать время простоя.  Этот этап не вызывает простой в работе пользователей, а значит никаким образом не нарушает работу приложений.
  - Вопросы, приведенные ниже, необходимо разрешить непосредственно перед пробным запуском, хотя даже если их упустить, все необходимые этапы будут выполнены. Во время корпоративного перемещения пробный запуск зарекомендовал себя как безопасный метод, незаменимый при обеспечении готовности к миграции.
  - При выполнении подготовки плоскость управления (операции управления Azure) будет заблокирована для всей виртуальной сети, поэтому в процессе проверки, подготовки или отмены вы не сможете изменить метаданные виртуальной машины.  Но кроме этого функции приложения (использование удаленного рабочего стола, виртуальной машины и т. д.) никак не будут затронуты.  Пользователи виртуальных машин не будут уведомлены о выполнении пробного запуска.

- **Каналы ExpressRoute и VPN.** В настоящее время шлюзы ExpressRoute со ссылками для авторизации невозможно перенести без простоя. Обходные пути описываются в статье [Перенос каналов ExpressRoute и связанных виртуальных сетей из классической модели развертывания на модель Resource Manager](../../expressroute/expressroute-migration-classic-resource-manager.md).

- **Расширения виртуальной машины.** Расширения виртуальной машины потенциально являются одним из наибольших препятствий для миграции запущенных виртуальных машин. Учтите при планировании, что исправление расширений виртуальной машины может занять до 1–2 дней.  Для сообщения состояния расширения виртуальной машины на запущенных виртуальных машин требуется работающий агент Azure. Если состояние на запущенной виртуальной машине неудовлетворительное, то миграция будет прервана. Сам агент не является таким уж необходимым для выполнения миграции, но если на виртуальной машине есть расширения, то для успешной миграции потребуются как работающий агент, так и исходящее подключение к Интернету (с использованием DNS).
  - Если во время миграции связь с DNS-сервером прервется, то, прежде чем начнется подготовка к миграции, все расширения виртуальной машины, за исключением BGInfo версии 1.\*, потребуется сначала удалить с каждой виртуальной машины, а затем, когда миграция в Azure Resource Manager будет выполнена, снова добавить на виртуальные машины.  **Это необходимо сделать только для запущенных виртуальных машин.**  Если виртуальные машины находятся в состоянии "Остановлено", их расширения удалять не нужно.

  > [!NOTE]
  > Многие расширения, например расширение системы диагностики Azure и расширение мониторинга центра безопасности, будут автоматически переустановлены после миграции, так что их удаление не представляет проблемы.

  - Кроме того, группы безопасности сети не должны ограничивать исходящий доступ к Интернету, что возможно в некоторых конфигурациях групп безопасности сети. Исходящий доступ к Интернету (и DNS) необходим для переноса расширений виртуальной машины в модель Azure Resource Manager.
  - Существуют две версии расширения BGInfo, версия 1 и версия 2.  

      - Если виртуальная машина использует расширение BGInfo версии 1, то можно оставить это расширение как есть. API миграции пропускает это расширение. Расширение BGInfo можно будет добавить после миграции.
      - Если виртуальная машина использует расширение BGInfo версии 2 на основе JSON, значит, она была создана с помощью портала Azure. API миграции добавляет это расширение в процесс миграции в Azure Resource Manager при условии, что агент работает и имеет исходящий доступ к Интернету (и DNS).

  - **Способ исправления 1.** Если у виртуальных машин нет исходящего доступа к Интернету, работающей службы DNS и агентов Azure, тогда удалите все расширения виртуальной машины непосредственно перед подготовкой, входящей в процесс миграции, а затем, после его завершения, повторно установите их.
  - **Способ исправления 2.** Если расширения виртуальной машины слишком большие, можно также завершить работу всех виртуальных машин или отменить их распределение перед миграцией. Перенесите освобожденные виртуальные машины, а затем перезапустите их в модели Azure Resource Manager. Преимущество здесь заключается в том, что расширения виртуальной машины переместятся. Недостатком же является то, что все общедоступные виртуальные IP-адреса будут потеряны, работа виртуальных машин завершится, что заметно отразится на работе запущенных приложений.

    > [!NOTE]
    > Если политика центра безопасности Azure не предусматривает миграцию запущенных виртуальных машин, то перед удалением расширений ее необходимо остановить. В противном случае удаленное расширение мониторинга безопасности будет автоматически повторно установлено на виртуальной машине.

- **Группы доступности.** Чтобы переместить виртуальную сеть в Azure Resource Manager, все виртуальные машины, которые содержит классическое развертывание (например, облачная служба), должны либо находиться в одной группе доступности, либо не принадлежать ни к одной из групп. Azure Resource Manager не поддерживает наличие нескольких групп доступности в облачной службе, и это приведет к остановке миграции.  Как было сказано выше, в группе доступности должны находиться либо все виртуальные машины, либо ни одной. Чтобы устранить эту проблему, необходимо реорганизовать облачную службу или же исправить несоответствия.  Это может занять некоторое время, что следует учесть при планировании.

- **Развертывания веб-ролей и рабочих ролей.** Облачные службы, содержащие веб-роли и рабочие роли, невозможно переместить в Azure Resource Manager. Их необходимо удалить из виртуальной сети до начала переноса.  Стандартным решением является обычное перемещение экземпляров веб-ролей и рабочих ролей в отдельную классическую виртуальную сеть, которая также связана с каналом ExpressRoute. Или же можно переместить код в более новые службы приложений PaaS (что не относится к теме данного руководства). Как и в предыдущем случае повторного развертывания, вам необходимо создать новую классическую виртуальную сеть, переместить и повторно развернуть веб-роли или рабочие роли в этой сети, а затем удалить развернутые службы из перемещаемой виртуальной сети. Не требует изменения кода. Вы можете использовать новую функцию [пиринга между виртуальными сетями](../../virtual-network/virtual-network-peering-overview.md), чтобы установить пиринг между классической виртуальной сетью, содержащей веб-роли и рабочие роли, и другими виртуальными сетями в одном регионе Azure (например, это может быть **уже перемещенная виртуальная сеть, так как пиринговые виртуальные сети переместить невозможно**). Это не повлияет на возможности и не приведет к потере производительности или штрафам за задержки или пропускную способность. С помощью [пиринга между виртуальными сетями](../../virtual-network/virtual-network-peering-overview.md) теперь можно легко переносить развертывания веб-ролей и рабочих ролей, не вызывая блокирование миграции в модель Azure Resource Manager.

- **Квоты Azure Resource Manager.** У регионов Azure есть отдельные квоты и ограничения для классической модели и модели Azure Resource Manager. Несмотря на то, что в сценарии перемещения мы не используем новое оборудование (*мы переключаем существующие виртуальные машины из классической модели в модель Azure Resource Manager*), квоты Azure Resource Manager все равно должны выполняться, чтобы можно было начать перемещение. Основные ограничения, вызывающие проблемы, приведены ниже.  Отправьте запрос на квоту в службу поддержки, чтобы увеличить значения ограничений.

    > [!NOTE]
    > Это нужно сделать в том же регионе, в который будет перемещена текущая среда.
    >

    - Сетевые интерфейсы
    - Балансировщики нагрузки
    - Общедоступные IP-адреса.
    - Статические общедоступные IP-адреса.
    - Ядра
    - группы сетевой безопасности;
    - таблицы маршрутов;

    Используйте команды ниже с помощью последней версии Azure PowerShell, чтобы проверить текущие квоты Azure Resource Manager.

    **Вычисления** *(ядра, группы доступности)*

    ```powershell
    Get-AzureRmVMUsage -Location <azure-region>
    ```

    **Сети** *(виртуальные сети, статические общедоступные IP-адреса, общедоступные IP-адреса, группы безопасности сети, сетевые интерфейсы, подсистемы балансировки нагрузки, таблицы маршрутов)*

    ```powershell
    Get-AzureRmUsage /subscriptions/<subscription-id>/providers/Microsoft.Network/locations/<azure-region> -ApiVersion 2016-03-30 | Format-Table
    ```

    **Хранилище** *(учетная запись хранения)*

    ```powershell
    Get-AzureRmStorageUsage
    ```

- **Ограничения регулирования API Azure Resource Manager**. Если среда достаточно большая (например, более 400 виртуальных машин в виртуальной сети), вы можете достигнуть ограничения регулирования по умолчанию API для операций записи (в этом случае это `1200 writes/hour` операций) в Azure Resource Manager. Перед началом переноса создайте запрос в службу поддержки, чтобы увеличить это ограничение для подписки.


- **Состояние виртуальной машины "Превышено время ожидания подготовки"**. Если любая виртуальная машина находится в состоянии `provisioning timed out`, это необходимо исправить до начала переноса. Единственный способ — это использовать режим простоя. Необходимо отозвать процесс подготовки виртуальной машины или повторно запустить его (удалить виртуальную машину, сохранить диск и снова создать виртуальную машину).

- **Состояние виртуальной машины RoleStateUnknown**. Если миграция прерывается из-за ошибки `role state unknown`, выполните анализ виртуальной машины с помощью портала и убедитесь, что она исправна. Обычно через несколько минут такая ошибка самоустраняется (не нужны никакие дополнительные действия). Это ошибка временного типа, которая происходит во время таких операций виртуальной машины, как `start`, `stop` и `restart`. **Рекомендация.** Повторите попытку миграции через несколько минут.

- **Кластер Fabric не существует.** В некоторых случаях определенные виртуальные машины невозможно переместить из-за нетипичных причин. Например, если виртуальная машина была создана недавно (неделю назад или около того), а затем перемещена в кластер Azure, который еще не подготовлен для рабочих нагрузок Azure Resource Manager.  В таком случае вы увидите ошибку `fabric cluster does not exist`, и миграция виртуальной машины станет невозможна. Обычно эту ошибку удается устранить в течение нескольких дней, когда для кластера будет включена поддержка Azure Resource Manager. Самый быстрый обходной путь — выполнить операцию `stop-deallocate` с виртуальной машиной, затем продолжить миграцию, а после ее завершения выполнить архивацию виртуальной машины в Azure Resource Manager.

### <a name="pitfalls-to-avoid"></a>Типичные недочеты

- Не ищите легких путей, пренебрегая проверкой, подготовкой и отменой пробного запуска миграции.
- Большинство (если не все) потенциальных проблем возникает в процессе проверки, подготовки и отмены пробного запуска.

## <a name="migration"></a>Миграция

### <a name="technical-considerations-and-tradeoffs"></a>Технические вопросы и компромиссы

Так как вы ознакомились с известными проблемами среды, вы готовы к миграции.

Для выполнения фактической миграции следует учесть приведенные ниже рекомендации.

1. Планируйте перенос виртуальных сетей (наименьших элементов при переносе) в порядке приоритета.  Рекомендуется начать с простых виртуальных сетей, постепенно переходя к более сложным.
2. У большинства клиентов будут рабочие среды и прочие среды.  Выполняйте перенос рабочей среды в последнюю очередь.
3. **(Необязательно.)** Спланируйте время планового обслуживания, оставив достаточный буфер на случай непредвиденных ошибок.
4. Обращайтесь к службам поддержки и принимайте во внимание рекомендации в случае проблем.

### <a name="patterns-of-success"></a>Рекомендации для удачного перемещения

Технические рекомендации, описанные в разделе _Лабораторный анализ_, необходимо учесть и выполнить до фактической миграции.  С помощью соответствующей проверки можно выполнить миграцию без непредвиденных событий.  В рабочих средах рекомендуется наличие дополнительной поддержки, например доверенного партнера корпорации Майкрософт или служб Microsoft Premier.

### <a name="pitfalls-to-avoid"></a>Типичные недочеты

Неполная проверка может вызвать проблемы и задержку миграции.  

## <a name="beyond-migration"></a>Вспомогательные вопросы миграции

### <a name="technical-considerations-and-tradeoffs"></a>Технические вопросы и компромиссы

Теперь, когда вы переместили ресурсы в Azure Resource Manager, максимально используйте возможности платформы.  Сведения о дополнительных преимуществах см. в [обзоре Azure Resource Manager](../../azure-resource-manager/resource-group-overview.md).

Необходимо учитывать следующее:

- Совместите миграцию с другими действиями.  Большинство пользователей использует окно обслуживания приложений.  В таком случае вы можете использовать простой, чтобы включить другие возможности Azure Resource Manager, например шифрование и переход на управляемые диски.
- Пересмотрите технические и коммерческие соображения для Azure Resource Manager. Включите дополнительные службы, доступные только в Azure Resource Manager, которые применимы к вашей среде.
- Модернизируйте среду с помощью служб PaaS.

### <a name="patterns-of-success"></a>Рекомендации для удачного перемещения

Включайте только необходимые службы в Azure Resource Manager.  Ниже приведены службы, которыми ограничивается большинство клиентов, использующих среды Azure.

- [Управление доступом на основе ролей](../../azure-resource-manager/resource-group-overview.md#access-control).
- [Шаблоны Azure Resource Manager для быстрого и контролируемого развертывания](../../azure-resource-manager/resource-group-overview.md#template-deployment).
- [Теги](../../azure-resource-manager/resource-group-using-tags.md).
- [Управление действиями](../../azure-resource-manager/resource-group-audit.md).
- [Политики ресурсов](../../azure-resource-manager/resource-manager-policy.md).

### <a name="pitfalls-to-avoid"></a>Типичные недочеты

Не забывайте об основной цели миграции из классической модели в модель Azure Resource Manager.  Каковы были первоначальные коммерческие соображения? Достигли ли вы этих целей?


## <a name="next-steps"></a>Дальнейшие действия

* [Обзор поддерживаемого платформой переноса ресурсов IaaS из классической модели в модель Azure Resource Manager](migration-classic-resource-manager-overview.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Техническое руководство по поддерживаемому платформой переносу из классической модели в модель Azure Resource Manager](migration-classic-resource-manager-deep-dive.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Перенос ресурсов IaaS из классической модели в модель Azure Resource Manager с помощью Azure PowerShell](migration-classic-resource-manager-ps.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Перенос ресурсов IaaS из классической модели в модель Azure Resource Manager с помощью интерфейса командной строки Azure](../linux/migration-classic-resource-manager-cli.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Community tools to migrate IaaS resources from classic to Azure Resource Manager](migration-classic-resource-manager-community-tools.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (Инструменты сообщества для перемещения ресурсов IaaS из классической модели в модель Azure Resource Manager)
* [Распространенные ошибки миграции](migration-classic-resource-manager-errors.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [Часто задаваемые вопросы о миграции из классической модели в модель Azure Resource Manager](migration-classic-resource-manager-faq.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)

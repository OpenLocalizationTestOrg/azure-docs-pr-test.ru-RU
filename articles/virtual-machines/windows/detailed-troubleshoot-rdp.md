---
title: "Подробное руководство по устранению неполадок с удаленным рабочим столом в Azure | Документация Майкрософт"
description: "Подробное руководство по устранению неполадок с удаленным рабочим столом, не позволяющих подключиться к виртуальным машинам Windows в Azure"
services: virtual-machines-windows
documentationcenter: 
author: genlin
manager: timlt
editor: 
tags: top-support-issue,azure-service-management,azure-resource-manager
keywords: "не удается подключиться к удаленному рабочему столу, устранение неполадок удаленного рабочего стола, удаленному рабочему столу не удается подключиться, ошибки удаленного рабочего стола, устранение неполадок удаленного рабочего стола, проблемы удаленного рабочего стола"
ms.assetid: 9da36f3d-30dd-44af-824b-8ce5ef07e5e0
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: support-article
ms.date: 07/25/2017
ms.author: genli
ms.openlocfilehash: 22080b9402b13fd8162024db10aef5475880e4a7
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="detailed-troubleshooting-steps-for-remote-desktop-connection-issues-to-windows-vms-in-azure"></a><span data-ttu-id="43364-104">Подробное руководство по устранению неполадок с подключением к удаленному рабочему столу на виртуальной машине Windows в Azure</span><span class="sxs-lookup"><span data-stu-id="43364-104">Detailed troubleshooting steps for remote desktop connection issues to Windows VMs in Azure</span></span>
<span data-ttu-id="43364-105">В этой статье приводятся подробные инструкции по диагностике и устранению сложных ошибок удаленного рабочего стола для виртуальных машин Azure на базе Windows.</span><span class="sxs-lookup"><span data-stu-id="43364-105">This article provides detailed troubleshooting steps to diagnose and fix complex Remote Desktop errors for Windows-based Azure virtual machines.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="43364-106">Чтобы устранить более распространенные ошибки удаленного рабочего стола, обязательно ознакомьтесь с [основными способами устранения неполадок удаленного рабочего стола](troubleshoot-rdp-connection.md), прежде чем продолжить.</span><span class="sxs-lookup"><span data-stu-id="43364-106">To eliminate the more common Remote Desktop errors, make sure to read [the basic troubleshooting article for Remote Desktop](troubleshoot-rdp-connection.md) before proceeding.</span></span>

<span data-ttu-id="43364-107">Вам может встретиться сообщение об ошибке удаленного рабочего стола, не похожее ни на одно из сообщений, описанных в статье [Устранение неполадок с подключением к удаленному рабочему столу на виртуальной машине Azure под управлением Windows](troubleshoot-rdp-connection.md).</span><span class="sxs-lookup"><span data-stu-id="43364-107">You may encounter a Remote Desktop error message that does not resemble any of the specific error messages covered in [the basic Remote Desktop troubleshooting guide](troubleshoot-rdp-connection.md).</span></span> <span data-ttu-id="43364-108">Выполните следующие действия, чтобы определить, почему клиент удаленного рабочего стола (RDP) не может подключиться к службе удаленного рабочего стола на виртуальной машине Azure.</span><span class="sxs-lookup"><span data-stu-id="43364-108">Follow these steps to determine why the Remote Desktop (RDP) client is unable to connect to the RDP service on the Azure VM.</span></span>

[!INCLUDE [learn-about-deployment-models](../../../includes/learn-about-deployment-models-both-include.md)]

<span data-ttu-id="43364-109">Если вам потребуется дополнительная помощь по любому из вопросов, рассматриваемых в статье, вы можете обратиться к экспертам по Azure на [форумах MSDN Azure и Stack Overflow](https://azure.microsoft.com/support/forums/).</span><span class="sxs-lookup"><span data-stu-id="43364-109">If you need more help at any point in this article, you can contact the Azure experts on [the MSDN Azure and the Stack Overflow forums](https://azure.microsoft.com/support/forums/).</span></span> <span data-ttu-id="43364-110">Кроме того, можно зарегистрировать обращение в службу поддержки Azure.</span><span class="sxs-lookup"><span data-stu-id="43364-110">Alternatively, you can also file an Azure support incident.</span></span> <span data-ttu-id="43364-111">Перейдите на [веб-сайт поддержки Azure](https://azure.microsoft.com/support/options/) и щелкните **Получить поддержку**.</span><span class="sxs-lookup"><span data-stu-id="43364-111">Go to the [Azure Support site](https://azure.microsoft.com/support/options/) and click **Get Support**.</span></span> <span data-ttu-id="43364-112">Дополнительные сведения об использовании службы поддержки Azure см. в статье [Часто задаваемые вопросы о поддержке Microsoft Azure](https://azure.microsoft.com/support/faq/).</span><span class="sxs-lookup"><span data-stu-id="43364-112">For information about using Azure Support, read the [Microsoft Azure Support FAQ](https://azure.microsoft.com/support/faq/).</span></span>

## <a name="components-of-a-remote-desktop-connection"></a><span data-ttu-id="43364-113">Компоненты подключения к удаленному рабочему столу</span><span class="sxs-lookup"><span data-stu-id="43364-113">Components of a Remote Desktop connection</span></span>
<span data-ttu-id="43364-114">В подключении к удаленному рабочему столу участвуют следующие компоненты:</span><span class="sxs-lookup"><span data-stu-id="43364-114">The following components are involved in an RDP connection:</span></span>

![](./media/detailed-troubleshoot-rdp/tshootrdp_0.png)

<span data-ttu-id="43364-115">Прежде чем продолжить, проанализируйте, что изменилось с последнего успешного подключения удаленного рабочего стола к виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="43364-115">Before proceeding, it might help to mentally review what has changed since the last successful Remote Desktop connection to the VM.</span></span> <span data-ttu-id="43364-116">Например:</span><span class="sxs-lookup"><span data-stu-id="43364-116">For example:</span></span>

* <span data-ttu-id="43364-117">Изменен общедоступный IP-адрес виртуальной машины или облачной службы, в которой находится виртуальная машина (также называется [виртуальным IP-адресом](https://en.wikipedia.org/wiki/Virtual_IP_address)).</span><span class="sxs-lookup"><span data-stu-id="43364-117">The public IP address of the VM or the cloud service containing the VM (also called the virtual IP address [VIP](https://en.wikipedia.org/wiki/Virtual_IP_address)) has changed.</span></span> <span data-ttu-id="43364-118">Сбой подключения к удаленному рабочему столу может быть связан с тем, что в кэше DNS-клиента сохранился *старый IP-адрес* .</span><span class="sxs-lookup"><span data-stu-id="43364-118">The RDP failure could be because your DNS client cache still has the *old IP address* registered for the DNS name.</span></span> <span data-ttu-id="43364-119">Очистите кэш DNS-клиента и попробуйте подключиться к виртуальной машине еще раз.</span><span class="sxs-lookup"><span data-stu-id="43364-119">Flush your DNS client cache and try connecting the VM again.</span></span> <span data-ttu-id="43364-120">Либо попробуйте подключиться напрямую по новому виртуальному IP-адресу.</span><span class="sxs-lookup"><span data-stu-id="43364-120">Or try connecting directly with the new VIP.</span></span>
* <span data-ttu-id="43364-121">Вы используете стороннее приложение для управления подключениями к удаленному рабочему столу вместо стандартного подключения, созданного на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="43364-121">You are using a third-party application to manage your Remote Desktop connections instead of using the connection generated by the Azure portal.</span></span> <span data-ttu-id="43364-122">Убедитесь, что конфигурация приложения содержит правильный TCP-порт для трафика удаленного рабочего стола.</span><span class="sxs-lookup"><span data-stu-id="43364-122">Verify that the application configuration includes the correct TCP port for the Remote Desktop traffic.</span></span> <span data-ttu-id="43364-123">Чтобы узнать номер порта для классической виртуальной машины на [портале Azure](https://portal.azure.com), на виртуальной машине щелкните "Параметры" и выберите пункт "Конечные точки".</span><span class="sxs-lookup"><span data-stu-id="43364-123">You can check this port for a classic virtual machine in the [Azure portal](https://portal.azure.com), by clicking the VM's Settings > Endpoints.</span></span>

## <a name="preliminary-steps"></a><span data-ttu-id="43364-124">Предварительные действия</span><span class="sxs-lookup"><span data-stu-id="43364-124">Preliminary steps</span></span>
<span data-ttu-id="43364-125">Прежде чем перейти к подробной диагностике, выполните следующие действия:</span><span class="sxs-lookup"><span data-stu-id="43364-125">Before proceeding to the detailed troubleshooting,</span></span>

* <span data-ttu-id="43364-126">Проверьте состояние виртуальной машины на портале Azure на наличие очевидных проблем.</span><span class="sxs-lookup"><span data-stu-id="43364-126">Check the status of the virtual machine in the Azure portal for any obvious issues.</span></span>
* <span data-ttu-id="43364-127">Выполните [процедуры быстрого устранения ошибок протокола удаленного рабочего стола, описанные в руководстве по устранению неполадок](troubleshoot-rdp-connection.md#quick-troubleshooting-steps).</span><span class="sxs-lookup"><span data-stu-id="43364-127">Follow the [quick fix steps for common RDP errors in the basic troubleshooting guide](troubleshoot-rdp-connection.md#quick-troubleshooting-steps).</span></span>

<span data-ttu-id="43364-128">Выполнив эти действия, попробуйте заново подключиться к виртуальной машине через удаленный рабочий стол.</span><span class="sxs-lookup"><span data-stu-id="43364-128">Try reconnecting to the VM via Remote Desktop after these steps.</span></span>

## <a name="detailed-troubleshooting-steps"></a><span data-ttu-id="43364-129">Подробное описание устранения неполадок</span><span class="sxs-lookup"><span data-stu-id="43364-129">Detailed troubleshooting steps</span></span>
<span data-ttu-id="43364-130">Возможно, клиенту удаленного рабочего стола не удалось подключиться к службе удаленных рабочих столов на виртуальной машине Azure из-за проблем в перечисленных ниже источниках:</span><span class="sxs-lookup"><span data-stu-id="43364-130">The Remote Desktop client may not be able to reach the Remote Desktop service on the Azure VM due to issues at the following sources:</span></span>

* [<span data-ttu-id="43364-131">Компьютер с клиентом удаленного рабочего стола</span><span class="sxs-lookup"><span data-stu-id="43364-131">Remote Desktop client computer</span></span>](#source-1-remote-desktop-client-computer)
* [<span data-ttu-id="43364-132">Пограничное устройство интрасети организации</span><span class="sxs-lookup"><span data-stu-id="43364-132">Organization intranet edge device</span></span>](#source-2-organization-intranet-edge-device)
* [<span data-ttu-id="43364-133">Конечная точка облачной службы и список управления доступом (ACL)</span><span class="sxs-lookup"><span data-stu-id="43364-133">Cloud service endpoint and access control list (ACL)</span></span>](#source-3-cloud-service-endpoint-and-acl)
* [<span data-ttu-id="43364-134">Группы безопасности сети</span><span class="sxs-lookup"><span data-stu-id="43364-134">Network security groups</span></span>](#source-4-network-security-groups)
* [<span data-ttu-id="43364-135">Виртуальная машина Azure под управлением Windows</span><span class="sxs-lookup"><span data-stu-id="43364-135">Windows-based Azure VM</span></span>](#source-5-windows-based-azure-vm)

## <a name="source-1-remote-desktop-client-computer"></a><span data-ttu-id="43364-136">Источник 1: компьютер с клиентом удаленного рабочего стола</span><span class="sxs-lookup"><span data-stu-id="43364-136">Source 1: Remote Desktop client computer</span></span>
<span data-ttu-id="43364-137">Убедитесь, что ваш компьютер способен устанавливать подключения к удаленному рабочему столу на другом локальном компьютере под управлением Windows.</span><span class="sxs-lookup"><span data-stu-id="43364-137">Verify that your computer can make Remote Desktop connections to another on-premises, Windows-based computer.</span></span>

![](./media/detailed-troubleshoot-rdp/tshootrdp_1.png)

<span data-ttu-id="43364-138">Если это не так, проверьте следующие настройки на компьютере.</span><span class="sxs-lookup"><span data-stu-id="43364-138">If you cannot, check for the following settings on your computer:</span></span>

* <span data-ttu-id="43364-139">Настройки локального брандмауэра, которые могут блокировать обмен данными с удаленным рабочим столом.</span><span class="sxs-lookup"><span data-stu-id="43364-139">A local firewall setting that is blocking Remote Desktop traffic.</span></span>
* <span data-ttu-id="43364-140">Наличие локального программного обеспечения с функциями прокси-сервера, которое не позволяет установить подключение к удаленному рабочему столу.</span><span class="sxs-lookup"><span data-stu-id="43364-140">Locally installed client proxy software that is preventing Remote Desktop connections.</span></span>
* <span data-ttu-id="43364-141">Наличие локального программного обеспечения для мониторинга сети, которое не позволяет установить подключение к удаленному рабочему столу.</span><span class="sxs-lookup"><span data-stu-id="43364-141">Locally installed network monitoring software that is preventing Remote Desktop connections.</span></span>
* <span data-ttu-id="43364-142">Наличие других программ для обеспечения безопасности, которые ведут мониторинг трафика либо разрешают и запрещают трафик определенных типов, поэтому могут блокировать подключение к удаленному рабочему столу.</span><span class="sxs-lookup"><span data-stu-id="43364-142">Other types of security software that either monitor traffic or allow/disallow specific types of traffic that is preventing Remote Desktop connections.</span></span>

<span data-ttu-id="43364-143">В любом из перечисленных выше случаев временно отключите соответствующее программное обеспечение и попробуйте установить соединение с локальным компьютером через удаленный рабочий стол.</span><span class="sxs-lookup"><span data-stu-id="43364-143">In all these cases, temporarily disable the software and try to connect to an on-premises computer via Remote Desktop.</span></span> <span data-ttu-id="43364-144">Если это не помогло вам найти причину, обратитесь к администратору сети и измените параметры программного обеспечения таким образом, чтобы оно не блокировало подключения к удаленным рабочим столам.</span><span class="sxs-lookup"><span data-stu-id="43364-144">If you can find out the actual cause this way, work with your network administrator to correct the software settings to allow Remote Desktop connections.</span></span>

## <a name="source-2-organization-intranet-edge-device"></a><span data-ttu-id="43364-145">Источник 2: пограничное устройство интрасети организации</span><span class="sxs-lookup"><span data-stu-id="43364-145">Source 2: Organization intranet edge device</span></span>
<span data-ttu-id="43364-146">Убедитесь, что компьютер, подключенный непосредственно к Интернету, способен устанавливать подключения удаленного рабочего стола к виртуальной машине Azure.</span><span class="sxs-lookup"><span data-stu-id="43364-146">Verify that a computer directly connected to the Internet can make Remote Desktop connections to your Azure virtual machine.</span></span>

![](./media/detailed-troubleshoot-rdp/tshootrdp_2.png)

<span data-ttu-id="43364-147">Если у вас нет такого компьютера, создайте и протестируйте новую виртуальную машину Azure, размещенную в собственной группе ресурсов или облачной службе.</span><span class="sxs-lookup"><span data-stu-id="43364-147">If you do not have a computer that is directly connected to the Internet, create and test with a new Azure virtual machine in a resource group or cloud service.</span></span> <span data-ttu-id="43364-148">Дополнительные сведения см. в статье [Создание виртуальной машины Windows в среде Azure](../virtual-machines-windows-hero-tutorial.md).</span><span class="sxs-lookup"><span data-stu-id="43364-148">For more information, see [Create a virtual machine running Windows in Azure](../virtual-machines-windows-hero-tutorial.md).</span></span> <span data-ttu-id="43364-149">По завершении проверки удалите виртуальную машину и группу ресурсов или облачную службу.</span><span class="sxs-lookup"><span data-stu-id="43364-149">You can delete the virtual machine and the resource group or the cloud service, after the test.</span></span>

<span data-ttu-id="43364-150">Если вам удается установить соединение с удаленным рабочим столом с компьютера, непосредственно подключенного к Интернету, проверьте, нет ли на пограничном устройстве интрасети вашей организации:</span><span class="sxs-lookup"><span data-stu-id="43364-150">If you can create a Remote Desktop connection with a computer directly attached to the Internet, check your organization intranet edge device for:</span></span>

* <span data-ttu-id="43364-151">интернет-брандмауэра, который блокирует подключения к Интернету по протоколу HTTPS;</span><span class="sxs-lookup"><span data-stu-id="43364-151">An internal firewall blocking HTTPS connections to the Internet.</span></span>
* <span data-ttu-id="43364-152">прокси-сервера, который не позволяет установить подключение к удаленному рабочему столу;</span><span class="sxs-lookup"><span data-stu-id="43364-152">A proxy server preventing Remote Desktop connections.</span></span>
* <span data-ttu-id="43364-153">программного обеспечения для обнаружения атак и мониторинга сети, которое работает на устройствах в вашей сети периметра и блокирует подключения к удаленным рабочим столам.</span><span class="sxs-lookup"><span data-stu-id="43364-153">Intrusion detection or network monitoring software running on devices in your edge network that is preventing Remote Desktop connections.</span></span>

<span data-ttu-id="43364-154">При помощи администратора сети измените параметры пограничного устройства интрасети вашей организации таким образом, чтобы оно не блокировало HTTPS-подключения к удаленным рабочим столам через Интернет.</span><span class="sxs-lookup"><span data-stu-id="43364-154">Work with your network administrator to correct the settings of your organization intranet edge device to allow HTTPS-based Remote Desktop connections to the Internet.</span></span>

## <a name="source-3-cloud-service-endpoint-and-acl"></a><span data-ttu-id="43364-155">Источник 3: конечная точка облачной службы и список управления доступом (ACL)</span><span class="sxs-lookup"><span data-stu-id="43364-155">Source 3: Cloud service endpoint and ACL</span></span>
<span data-ttu-id="43364-156">Если виртуальная машина создана с помощью классической модели развертывания, убедитесь, что другая виртуальная машина Azure, которая находится в той же облачной службе или виртуальной сети, может устанавливать подключения к удаленному рабочему столу на вашей виртуальной машине Azure.</span><span class="sxs-lookup"><span data-stu-id="43364-156">For VMs created using the Classic deployment model, verify that another Azure VM that is in the same cloud service or virtual network can make Remote Desktop connections to your Azure VM.</span></span>

![](./media/detailed-troubleshoot-rdp/tshootrdp_3.png)

> [!NOTE]
> <span data-ttu-id="43364-157">Для виртуальных машин, созданных в Resource Manager, см. раздел [Источник 4: группы безопасности сети](#source-4-network-security-groups).</span><span class="sxs-lookup"><span data-stu-id="43364-157">For virtual machines created in Resource Manager, skip to [Source 4: Network Security Groups](#source-4-network-security-groups).</span></span>

<span data-ttu-id="43364-158">Если у вас нет другой виртуальной машины в той же облачной службе или виртуальной сети, создайте ее.</span><span class="sxs-lookup"><span data-stu-id="43364-158">If you do not have another virtual machine in the same cloud service or virtual network, create one.</span></span> <span data-ttu-id="43364-159">Для этого выполните действия, описанные в статье [Создание первой виртуальной машины Windows на портале Azure](../virtual-machines-windows-hero-tutorial.md).</span><span class="sxs-lookup"><span data-stu-id="43364-159">Follow the steps in [Create a virtual machine running Windows in Azure](../virtual-machines-windows-hero-tutorial.md).</span></span> <span data-ttu-id="43364-160">По завершении теста удалите тестовую виртуальную машину.</span><span class="sxs-lookup"><span data-stu-id="43364-160">Delete the test virtual machine after the test is completed.</span></span>

<span data-ttu-id="43364-161">Если вам удается подключиться к удаленному рабочему столу на виртуальной машине в той же облачной службе или виртуальной сети, проверьте перечисленные ниже компоненты.</span><span class="sxs-lookup"><span data-stu-id="43364-161">If you can connect via Remote Desktop to a virtual machine in the same cloud service or virtual network, check for these settings:</span></span>

* <span data-ttu-id="43364-162">Конфигурация конечной точки для трафика удаленного рабочего стола на целевой виртуальной машине: частный TCP-порт конечной точки должен совпадать с TCP-портом, который используется для прослушивания службы удаленных рабочих столов для виртуальных машин (по умолчанию — 3389).</span><span class="sxs-lookup"><span data-stu-id="43364-162">The endpoint configuration for Remote Desktop traffic on the target VM: The private TCP port of the endpoint must match the TCP port on which the VM's Remote Desktop service is listening (default is 3389).</span></span>
* <span data-ttu-id="43364-163">Список управления доступом на конечной точке для обмена данными с удаленным рабочим столом на целевой виртуальной машине: позволяет разрешать и запрещать входящий трафик из Интернета в зависимости от IP-адреса источника.</span><span class="sxs-lookup"><span data-stu-id="43364-163">The ACL for the Remote Desktop traffic endpoint on the target VM: ACLs allow you to specify allowed or denied incoming traffic from the Internet based on its source IP address.</span></span> <span data-ttu-id="43364-164">Если он неправильно настроен, входящие данные с удаленного рабочего стола на эту конечную точку могут блокироваться.</span><span class="sxs-lookup"><span data-stu-id="43364-164">Misconfigured ACLs can prevent incoming Remote Desktop traffic to the endpoint.</span></span> <span data-ttu-id="43364-165">Проверьте свои списки управления доступом и убедитесь в том, что входящий трафик с общедоступных IP-адресов вашего прокси-сервера или другого пограничного сервера разрешен.</span><span class="sxs-lookup"><span data-stu-id="43364-165">Check your ACLs to ensure that incoming traffic from your public IP addresses of your proxy or other edge server is allowed.</span></span> <span data-ttu-id="43364-166">Дополнительные сведения см. в статье [Список управления доступом (ACL) конечной точки](../../virtual-network/virtual-networks-acl.md).</span><span class="sxs-lookup"><span data-stu-id="43364-166">For more information, see [What is a Network Access Control List (ACL)?](../../virtual-network/virtual-networks-acl.md)</span></span>

<span data-ttu-id="43364-167">Чтобы устранить конечную точку из числа потенциальных источников проблемы, удалите ее и создайте новую, выбрав в качестве номера внешнего порта любой порт в диапазоне от 49152 до 65535.</span><span class="sxs-lookup"><span data-stu-id="43364-167">To check if the endpoint is the source of the problem, remove the current endpoint and create a new one, choosing a random port in the range 49152–65535 for the external port number.</span></span> <span data-ttu-id="43364-168">Дополнительные сведения см. в статье [Настройка конечных точек виртуальной машины](classic/setup-endpoints.md?toc=%2fazure%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="43364-168">For more information, see [How to set up endpoints to a virtual machine](classic/setup-endpoints.md?toc=%2fazure%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json).</span></span>

## <a name="source-4-network-security-groups"></a><span data-ttu-id="43364-169">Источник 4: группы безопасности сети</span><span class="sxs-lookup"><span data-stu-id="43364-169">Source 4: Network Security Groups</span></span>
<span data-ttu-id="43364-170">Группы безопасности сети позволяют точнее настраивать параметры разрешенного входящего и исходящего трафика.</span><span class="sxs-lookup"><span data-stu-id="43364-170">Network Security Groups allow more granular control of allowed inbound and outbound traffic.</span></span> <span data-ttu-id="43364-171">Можно создавать правила, которые распространяются на подсети и облачные службы в виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="43364-171">You can create rules spanning subnets and cloud services in an Azure virtual network.</span></span>

<span data-ttu-id="43364-172">Используйте [проверку потока для IP-адреса](../../network-watcher/network-watcher-check-ip-flow-verify-portal.md), чтобы определить, блокирует ли правило в группе безопасности сети входящий или исходящий трафик виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="43364-172">Use [IP flow verify](../../network-watcher/network-watcher-check-ip-flow-verify-portal.md) to confirm if a rule in a Network Security Group is blocking traffic to or from a virtual machine.</span></span> <span data-ttu-id="43364-173">Вы можете также просмотреть действующие правила группы безопасности и убедиться, что для порта RDP (3389 по умолчанию) существует и является приоритетным правило NSG, разрешающее входящий трафик.</span><span class="sxs-lookup"><span data-stu-id="43364-173">You can also review effective security group rules to ensure inbound "Allow" NSG rule exists and is prioritized for RDP port(default 3389).</span></span> <span data-ttu-id="43364-174">См. дополнительные сведения об [использовании действующих правил безопасности для устранения проблем с потоком трафика в виртуальной машине](../../virtual-network/virtual-network-nsg-troubleshoot-portal.md#using-effective-security-rules-to-troubleshoot-vm-traffic-flow).</span><span class="sxs-lookup"><span data-stu-id="43364-174">For more information, see [Using Effective Security Rules to troubleshoot VM traffic flow](../../virtual-network/virtual-network-nsg-troubleshoot-portal.md#using-effective-security-rules-to-troubleshoot-vm-traffic-flow).</span></span>

## <a name="source-5-windows-based-azure-vm"></a><span data-ttu-id="43364-175">Источник 5: виртуальная машина Azure под управлением Windows</span><span class="sxs-lookup"><span data-stu-id="43364-175">Source 5: Windows-based Azure VM</span></span>
![](./media/detailed-troubleshoot-rdp/tshootrdp_5.png)

<span data-ttu-id="43364-176">Следуйте инструкциям в [этой статье](reset-rdp.md).</span><span class="sxs-lookup"><span data-stu-id="43364-176">Follow the instructions in [this article](reset-rdp.md).</span></span> <span data-ttu-id="43364-177">В ней объясняется, как вернуть службу удаленного рабочего стола на виртуальной машине в исходное состояние.</span><span class="sxs-lookup"><span data-stu-id="43364-177">This article resets the Remote Desktop service on the virtual machine:</span></span>

* <span data-ttu-id="43364-178">будет включено правило по умолчанию «Удаленный рабочий стол» в брандмауэре Windows (TCP-порт 3389);</span><span class="sxs-lookup"><span data-stu-id="43364-178">Enable the "Remote Desktop" Windows Firewall default rule (TCP port 3389).</span></span>
* <span data-ttu-id="43364-179">будут разрешены подключения к удаленным рабочим столам в реестре (для параметра HKLM\System\CurrentControlSet\Control\Terminal Server\fDenyTSConnections будет установлено значение 0).</span><span class="sxs-lookup"><span data-stu-id="43364-179">Enable Remote Desktop connections by setting the HKLM\System\CurrentControlSet\Control\Terminal Server\fDenyTSConnections registry value to 0.</span></span>

<span data-ttu-id="43364-180">Попытайтесь снова установить подключение со своего компьютера.</span><span class="sxs-lookup"><span data-stu-id="43364-180">Try the connection from your computer again.</span></span> <span data-ttu-id="43364-181">Если установить подключение через виртуальный рабочий стол по-прежнему не удается, проверьте наличие следующих проблем:</span><span class="sxs-lookup"><span data-stu-id="43364-181">If you are still not able to connect via Remote Desktop, check for the following possible problems:</span></span>

* <span data-ttu-id="43364-182">На целевой виртуальной машине не запущена служба удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="43364-182">The Remote Desktop service is not running on the target VM.</span></span>
* <span data-ttu-id="43364-183">Служба удаленных рабочих столов не прослушивается через TCP-порт 3389.</span><span class="sxs-lookup"><span data-stu-id="43364-183">The Remote Desktop service is not listening on TCP port 3389.</span></span>
* <span data-ttu-id="43364-184">В брандмауэре Windows или другом локальном брандмауэре есть правило для исходящего трафика, блокирующее трафик удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="43364-184">Windows Firewall or another local firewall has an outbound rule that is preventing Remote Desktop traffic.</span></span>
* <span data-ttu-id="43364-185">Программное обеспечение для обнаружения атак и мониторинга сети на виртуальной машине Azure блокирует подключения к удаленным рабочим столам.</span><span class="sxs-lookup"><span data-stu-id="43364-185">Intrusion detection or network monitoring software running on the Azure virtual machine is preventing Remote Desktop connections.</span></span>

<span data-ttu-id="43364-186">Для виртуальных машин, созданных по классической модели развертывания, можно использовать удаленный сеанс Azure PowerShell на виртуальной машине Azure.</span><span class="sxs-lookup"><span data-stu-id="43364-186">For VMs created using the classic deployment model, you can use a remote Azure PowerShell session to the Azure virtual machine.</span></span> <span data-ttu-id="43364-187">Сначала нужно установить сертификат для доступа к облачной службе, в которой размещена виртуальная машина.</span><span class="sxs-lookup"><span data-stu-id="43364-187">First, you need to install a certificate for the virtual machine's hosting cloud service.</span></span> <span data-ttu-id="43364-188">Откройте страницу [Configure Secure Remote PowerShell Access to Windows Azure Virtual Machines](http://gallery.technet.microsoft.com/scriptcenter/Configures-Secure-Remote-b137f2fe) (Настройка защищенного удаленного доступа PowerShell к виртуальным машинам Azure) и скачайте файл сценария **InstallWinRMCertAzureVM.ps1** на локальный компьютер.</span><span class="sxs-lookup"><span data-stu-id="43364-188">Go to [Configure Secure Remote PowerShell Access to Azure Virtual Machines](http://gallery.technet.microsoft.com/scriptcenter/Configures-Secure-Remote-b137f2fe) and download the **InstallWinRMCertAzureVM.ps1** script file to your local computer.</span></span>

<span data-ttu-id="43364-189">Затем установите Azure PowerShell, если еще не сделали этого.</span><span class="sxs-lookup"><span data-stu-id="43364-189">Next, install Azure PowerShell if you haven't already.</span></span> <span data-ttu-id="43364-190">См. статью [Установка и настройка Azure PowerShell](/powershell/azure/overview).</span><span class="sxs-lookup"><span data-stu-id="43364-190">See [How to install and configure Azure PowerShell](/powershell/azure/overview).</span></span>

<span data-ttu-id="43364-191">Затем откройте командную строку Azure PowerShell и перейдите из текущей папки в папку с файлом сценария **InstallWinRMCertAzureVM.ps1**.</span><span class="sxs-lookup"><span data-stu-id="43364-191">Next, open an Azure PowerShell command prompt and change the current folder to the location of the **InstallWinRMCertAzureVM.ps1** script file.</span></span> <span data-ttu-id="43364-192">Для запуска сценария Azure PowerShell необходимо задать правильную политику выполнения.</span><span class="sxs-lookup"><span data-stu-id="43364-192">To run an Azure PowerShell script, you must set the correct execution policy.</span></span> <span data-ttu-id="43364-193">Выполните команду **Get-ExecutionPolicy**, чтобы определить текущий уровень политики.</span><span class="sxs-lookup"><span data-stu-id="43364-193">Run the **Get-ExecutionPolicy** command to determine your current policy level.</span></span> <span data-ttu-id="43364-194">Инструкции по выбору подходящего уровня см. в описании команды [Set-ExecutionPolicy](https://technet.microsoft.com/library/hh849812.aspx).</span><span class="sxs-lookup"><span data-stu-id="43364-194">For information about setting the appropriate level, see [Set-ExecutionPolicy](https://technet.microsoft.com/library/hh849812.aspx).</span></span>

<span data-ttu-id="43364-195">Затем введите имя своей подписки Azure, имя облачной службы и имя виртуальной машины (удалив знаки "<" и ">"). После этого выполните следующие команды.</span><span class="sxs-lookup"><span data-stu-id="43364-195">Next, fill in your Azure subscription name, the cloud service name, and your virtual machine name (removing the < and > characters), and then run these commands.</span></span>

```powershell
$subscr="<Name of your Azure subscription>"
$serviceName="<Name of the cloud service that contains the target virtual machine>"
$vmName="<Name of the target virtual machine>"
.\InstallWinRMCertAzureVM.ps1 -SubscriptionName $subscr -ServiceName $serviceName -Name $vmName
```

<span data-ttu-id="43364-196">Правильное имя подписки можно получить из свойства *SubscriptionName* в выходных данных команды **Get-AzureSubscription**.</span><span class="sxs-lookup"><span data-stu-id="43364-196">You can get the correct subscription name from the *SubscriptionName* property of the display of the **Get-AzureSubscription** command.</span></span> <span data-ttu-id="43364-197">Имя облачной службы для виртуальной машины можно получить из столбца *ServiceName* в выходных данных команды **Get-AzureVM**.</span><span class="sxs-lookup"><span data-stu-id="43364-197">You can get the cloud service name for the virtual machine from the *ServiceName* column in the display of the **Get-AzureVM** command.</span></span>

<span data-ttu-id="43364-198">Убедитесь, что используется новый сертификат.</span><span class="sxs-lookup"><span data-stu-id="43364-198">Check if you have the new certificate.</span></span> <span data-ttu-id="43364-199">Для этого откройте оснастку "Сертификаты" для текущего пользователя и просмотрите папку **Доверенные корневые центры сертификации\Сертификаты**.</span><span class="sxs-lookup"><span data-stu-id="43364-199">Open a Certificates snap-in for the current user and look in the **Trusted Root Certification Authorities\Certificates** folder.</span></span> <span data-ttu-id="43364-200">Там должен быть сертификат с DNS-именем вашей облачной службы в столбце получателя (пример: cloudservice4testing.cloudapp.net).</span><span class="sxs-lookup"><span data-stu-id="43364-200">You should see a certificate with the DNS name of your cloud service in the Issued To column (example: cloudservice4testing.cloudapp.net).</span></span>

<span data-ttu-id="43364-201">Затем инициируйте удаленный сеанс Azure PowerShell с помощью следующих команд.</span><span class="sxs-lookup"><span data-stu-id="43364-201">Next, initiate a remote Azure PowerShell session by using these commands.</span></span>

```powershell
$uri = Get-AzureWinRMUri -ServiceName $serviceName -Name $vmName
$creds = Get-Credential
Enter-PSSession -ConnectionUri $uri -Credential $creds
```

<span data-ttu-id="43364-202">Указав действительные учетные данные администратора, вы должны увидеть в командной строке Azure PowerShell примерно следующее:</span><span class="sxs-lookup"><span data-stu-id="43364-202">After entering valid administrator credentials, you should see something similar to the following Azure PowerShell prompt:</span></span>

```powershell
[cloudservice4testing.cloudapp.net]: PS C:\Users\User1\Documents>
```

<span data-ttu-id="43364-203">Первая часть строки — это имя облачной службы, в которой находится целевая виртуальная машина (может отличаться от "cloudservice4testing.cloudapp.net").</span><span class="sxs-lookup"><span data-stu-id="43364-203">The first part of this prompt is your cloud service name that contains the target VM, which could be different from "cloudservice4testing.cloudapp.net".</span></span> <span data-ttu-id="43364-204">Теперь можно выполнить команды Azure PowerShell для этой облачной службы, чтобы проанализировать перечисленные выше проблемы и исправить конфигурацию.</span><span class="sxs-lookup"><span data-stu-id="43364-204">You can now issue Azure PowerShell commands for this cloud service to investigate the problems mentioned and correct the configuration.</span></span>

### <a name="to-manually-correct-the-remote-desktop-services-listening-tcp-port"></a><span data-ttu-id="43364-205">Изменение вручную TCP-порта прослушивания служб удаленных рабочих столов</span><span class="sxs-lookup"><span data-stu-id="43364-205">To manually correct the Remote Desktop Services listening TCP port</span></span>
<span data-ttu-id="43364-206">Выполните приведенную команду в командной строке удаленного сеанса Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="43364-206">At the remote Azure PowerShell session prompt, run this command.</span></span>

```powershell
Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"
```

<span data-ttu-id="43364-207">Свойство PortNumber содержит текущий номер порта.</span><span class="sxs-lookup"><span data-stu-id="43364-207">The PortNumber property shows the current port number.</span></span> <span data-ttu-id="43364-208">При необходимости вы можете восстановить номер порта удаленного рабочего стола по умолчанию (3389) с помощью следующей команды:</span><span class="sxs-lookup"><span data-stu-id="43364-208">If needed, change the Remote Desktop port number back to its default value (3389) by using this command.</span></span>

```powershell
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber" -Value 3389
```

<span data-ttu-id="43364-209">Убедитесь в том, что номер порта изменен на 3389, с помощью следующей команды:</span><span class="sxs-lookup"><span data-stu-id="43364-209">Verify that the port has been changed to 3389 by using this command.</span></span>

```powershell
Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"
```

<span data-ttu-id="43364-210">Закройте удаленный сеанс Azure PowerShell с помощью этой команды:</span><span class="sxs-lookup"><span data-stu-id="43364-210">Exit the remote Azure PowerShell session by using this command.</span></span>

```powershell
Exit-PSSession
```

<span data-ttu-id="43364-211">Также убедитесь в том, что на конечной точке удаленного рабочего стола для виртуальной машины Azure в качестве внутреннего порта задан TCP-порт 3398.</span><span class="sxs-lookup"><span data-stu-id="43364-211">Verify that the Remote Desktop endpoint for the Azure VM is also using TCP port 3398 as its internal port.</span></span> <span data-ttu-id="43364-212">Перезапустите виртуальную машину Azure и попробуйте установить подключение к удаленному рабочему столу еще раз.</span><span class="sxs-lookup"><span data-stu-id="43364-212">Restart the Azure VM and try the Remote Desktop connection again.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="43364-213">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="43364-213">Additional resources</span></span>
[<span data-ttu-id="43364-214">Сброс пароля или службы удаленных рабочих столов для виртуальных машин Windows</span><span class="sxs-lookup"><span data-stu-id="43364-214">How to reset a password or the Remote Desktop service for Windows virtual machines</span></span>](reset-rdp.md)

[<span data-ttu-id="43364-215">Установка и настройка Azure PowerShell</span><span class="sxs-lookup"><span data-stu-id="43364-215">How to install and configure Azure PowerShell</span></span>](/powershell/azure/overview)

[<span data-ttu-id="43364-216">Устранение неполадок с подключением Secure Shell (SSH) к виртуальной машине Azure под управлением Linux</span><span class="sxs-lookup"><span data-stu-id="43364-216">Troubleshoot Secure Shell (SSH) connections to a Linux-based Azure virtual machine</span></span>](../linux/troubleshoot-ssh-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)

[<span data-ttu-id="43364-217">Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure</span><span class="sxs-lookup"><span data-stu-id="43364-217">Troubleshoot access to an application running on an Azure virtual machine</span></span>](../linux/troubleshoot-app-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)


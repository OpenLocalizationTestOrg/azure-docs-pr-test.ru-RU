---
title: "aaaHow toouse PerfInsights в Microsoft Azure | Документы Microsoft"
description: "Узнает, как проблемы с производительностью toouse PerfInsights tootroubleshoot виртуальной Машины Windows."
services: virtual-machines-windows'
documentationcenter: 
author: genlin
manager: cshepard
editor: na
tags: 
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: article
ms.date: 07/18/2017
ms.author: genli
ms.openlocfilehash: f23ff7708c0c63bd02674b1bdc07753e8a89d9be
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="how-toouse-perfinsights"></a>Как toouse PerfInsights 

[PerfInsights](http://aka.ms/perfinsightsdownload) — автоматизированный скрипт собирает полезных диагностических данных, который запускает загружает нагрузки ввода-вывода и обеспечивает toohelp отчета анализа диагностику проблем производительности виртуальной Машины Windows в Microsoft Azure. 

Мы советуем запускать этот скрипт, прежде чем отправлять запрос в службу поддержки Майкрософт на устранение проблем производительности на виртуальных машинах.

## <a name="supported-troubleshooting-scenarios"></a>Поддерживаемые сценарии устранения неисправностей

PerfInsights может собирать и анализировать несколько типов данных, которые группируются в уникальные сценарии.

### <a name="collect-disk-configuration"></a>Сбор данных конфигурации дисков 

Этот сценарий собирает конфигурацию диска hello и другие важные сведения, включая hello следующих элементов:

-   Журналы событий

-   состояние всех входящих и исходящих сетевых подключений;

-   параметры конфигурации сети и брандмауэра;

-   Список задач для всех приложений, запущенных в системе hello

-   Файл сведений о созданных msinfo32 для hello виртуальной машины (VM)

-   Параметры конфигурации базы данных Microsoft SQL Server (если hello виртуальной Машины определяется как сервер, на котором выполняется SQL Server)

-   счетчики надежности хранилища;

-   важные исправления Windows;

-   установленные драйверы фильтра.

Это пассивный коллекцию данных, ошибка не влияет на систему hello. 

>[!Note]
>Этот сценарий, автоматически включается в каждом hello следующие сценарии.

### <a name="benchmarkstorage-performance-test"></a>Тест производительности хранилища

Этот сценарий запускается hello [diskspd](https://github.com/Microsoft/diskspd) производительности теста (операции ввода-ВЫВОДА и Мбит/с) для всех дисков, которые являются присоединенного toohello виртуальной Машины. 

> [!Note]
> Этот сценарий может повлиять на системы hello и не должны выполняться в производственной системе. При необходимости следует запустите этот сценарий, в tooavoid окна обслуживания выделенный проблем. Увеличение рабочей нагрузки, вызванное теста трассировки или тестирования может негативно повлиять на производительность hello вашей виртуальной Машины.
>

### <a name="general-vm-slow-analysis"></a>Общий анализ понижения производительности виртуальной машины 

Этот сценарий запускается [счетчика производительности](https://msdn.microsoft.com/library/windows/desktop/aa373083(v=vs.85).aspx) трассировки с помощью счетчиков hello, заданные в файле Generalcounters.txt hello. Если hello виртуальной Машины, определяется как сервер, на котором выполняется SQL Server, оно выполняется трассировки счетчика производительности с помощью hello счетчиков, которые находятся в файле Sqlcounters.txt hello. Он также содержит данные диагностики производительности.

### <a name="vm-slow-analysis-and-benchmark"></a>Тест и анализ понижения производительности виртуальной машины

Этот сценарий запускает трассировку [счетчиков производительности](https://msdn.microsoft.com/library/windows/desktop/aa373083(v=vs.85).aspx), за которой следует тест производительности [diskspd](https://github.com/Microsoft/diskspd). 

> [!Note]
> Этот сценарий может повлиять на системы hello и не должны выполняться в производственной системе. При необходимости следует запустите этот сценарий, в tooavoid окна обслуживания выделенный проблем. Увеличение рабочей нагрузки, вызванное теста трассировки или тестирования может негативно повлиять на производительность hello вашей виртуальной Машины.
>

### <a name="azure-files-analysis"></a>Анализ файлов Azure 

Этот сценарий запускает специальную запись счетчиков производительности вместе с функцией сетевой трассировки. Запись включает в себя все счетчики «SMB ресурсы клиента» hello. Hello ниже приведены некоторые ключевые SMB общего ресурса счетчиков производительности клиента, являющиеся частью отслеживания hello.

| **Тип**     | **Общие ресурсы SMB-клиента** |
|--------------|-------------------------------|
| ОПЕРАЦИЙ ВВОДА-ВЫВОДА         | Запросов данных в секунду             |
|              | Запросов на чтение в секунду             |
|              | Запросов на запись в секунду            |
| Задержка      | Среднее число секунд на запрос данных         |
|              | Среднее число секунд на запрос на чтение                 |
|              | Среднее число секунд на запрос на запись                |
| Размер ввода-вывода      | Среднее число байтов в запросе       |
|              | Среднее число байтов в запросе на чтение               |
|              | Среднее число байтов в запросе на запись              |
| Пропускная способность   | Байтов в секунду                |
|              | Прочитано байтов в секунду                |
|              | Записано байтов в секунду               |
| Длина очереди | Среднее Длина очереди чтения        |
|              | Среднее Длина очереди записи       |
|              | Среднее Длина очереди данных        |

### <a name="custom-configuration"></a>Настраиваемая конфигурация 

При запуске пользовательской конфигурации все трассировки выполняются в параллельном режиме (диагностика производительности, счетчик производительности, xperf, сеть, storport), в зависимости от того, сколько различных трассировок выбрано. После завершения трассировки средство hello выполняет тест diskspd hello, если он установлен. 

> [!Note]
> Этот сценарий может повлиять на системы hello и не должны выполняться в производственной системе. При необходимости следует запустите этот сценарий, в tooavoid окна обслуживания выделенный проблем. Увеличение рабочей нагрузки, вызванное теста трассировки или тестирования может негативно повлиять на производительность hello вашей виртуальной Машины.
>

## <a name="what-kind-of-information-is-collected-by-hello-script"></a>Какие сведения собираются с помощью сценария hello?

Сведения о виртуальной Машине Windows, дисков или хранения пулов конфигурации, счетчики производительности, журналы и различных трассировки собираются в зависимости от сценария оценки производительности hello используется:

|Собираемые данные                              |  |  | Сценарии тестирования производительности |  |  | |
|----------------------------------|----------------------------|------------------------------------|--------------------------|--------------------------------|----------------------|----------------------|
|                              | Сбор данных конфигурации дисков | Тест производительности хранилища. | Общий анализ понижения производительности виртуальной машины | Тест и анализ понижения производительности виртуальной машины | Анализ файлов Azure | Настраиваемая конфигурация |
| Сведения из журналов событий      | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Сведения о системе               | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Сопоставление томов                       | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Сопоставление дисков                         | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Выполняемые задачи                    | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Счетчики надежности хранилища     | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Сведения о хранилище              | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Выходные данные fsutil                    | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Сведения о драйвере фильтра               | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Выходные данные netstat                   | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Конфигурация сети            | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Настройка брандмауэра           | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Конфигурация SQL Server         | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Трассировки диагностики производительности* |                            |                                    | Да                      |                                |                      | Да                  |
| Трассировка счетчиков производительности**     |                            |                                    |                          |                                |                      | Да                  |
| Трассировка счетчиков SMB**             |                            |                                    |                          |                                | Да                  |                      |
| Трассировка счетчиков SQL Server**      |                            |                                    |                          |                                |                      | Да                  |
| Трассировка XPerf                      |                            |                                    |                          |                                |                      | Да                  |
| Трассировка StorPort                   |                            |                                    |                          |                                |                      | Да                  |
| Трассировка сети                    |                            |                                    |                          |                                | Да                  | Да                  |
| Трассировка теста производительности Diskspd***      |                            | Да                                |                          | Да                            |                      |                      |
|       |                            |                         |                                                   |                      |                      |

### <a name="performance-diagnostics-trace-"></a>Трассировка диагностики производительности (*)

Выполняет модуль на основе правил в hello фоновых toocollect данных и диагностики проблем производительности системы. в настоящее время поддерживаются Hello следующие правила:

- Правило HighCpuUsage: Определяет высокой периодов использования ЦП и показывает hello наиболее активных потребителях использования ЦП в течение этих периодов.
- Правило HighDiskUsage: Определяет периодах дисков на физических дисках и показано потребителей об использовании диска top hello в эти периоды.
- Правило HighResolutionDiskMetric. Показывает метрики операций ввода-вывода, пропускной способности и задержки операций ввода-вывода за 50 мс для каждого физического диска. Это помогает tooquickly идентификации диска регулирования периодов.
- Правило HighMemoryUsage: Определяет периодах большого объема памяти и показано использование потребителей hello верхней памяти в эти периоды.

> [!NOTE] 
> В настоящее время поддерживаются версии Windows, которые включают hello .NET Framework 3.5 или более поздней версии.

### <a name="performance-counter-trace-"></a>Трассировка счетчиков производительности (**)

Собирает hello следующие счетчики производительности:

- \Процесс, \Процессор, \Память, \Поток, \Физический диск, \Логический диск
- \Кэш\" Грязные" страницы, \Кэш\Сбросов ленивой записи/с, \Сервер\Невыгружаемый пул, ошибки, \Сервер\Отказов выгружаемого страничного пула
- Выбранные счетчики в категориях \Сетевой интерфейс \IPv4\Датаграммы, \IPv6\Датаграммы, \TCPv4\Сегменты, \TCPv6\Сегменты, \Сетевой адаптер, \WFPv4\Пакеты, \WFPv6\Пакеты, \UDPv4\Датаграммы, \UDPv6\Датаграммы, \TCPv4\Подключение, \TCPv6\Подключение, \Политика качества обслуживания сети\Пакеты, \Активность сетевой карты для каждого процессора, \Microsoft Winsock BSP

#### <a name="for-sql-server-instances"></a>Для экземпляров SQL Server
- \SQL Server:Buffer Manager, \SQLServer:Resource Pool Stats, \SQLServer: статистика SQL\
- \SQLServer: блокировки, \SQLServer: общая статистика
- \SQLServer: способы доступа

#### <a name="for-azure-files"></a>Для файлов Azure
\Общие ресурсы SMB-клиента

### <a name="diskspd-benchmark-trace-"></a>Трассировка теста производительности Diskspd (***)
Тестирование рабочей нагрузки операций ввода-вывода Diskspd [диск операционной системы (запись) и диски пула (чтение и запись)]

## <a name="run-hello-perfinsights-on-your-vm"></a>Запустите hello PerfInsights на виртуальной Машине

### <a name="what-do-i-have-tooknow-before-i-run-hello-script"></a>Что нужно ли tooknow запуска сценария hello? 

**Требования скрипта**

1.  Этот скрипт должен выполняться на виртуальной Машине, которая имеет проблемы производительности hello hello. 

2.  Привет, поддерживаются в следующих операционных систем: Windows Server 2008 R2, 2012, 2012 R2, 2016; Windows 8.1 и Windows 10.

**Возможные причины неполадок при запуске скрипта hello на рабочих виртуальных машин:**

1.  Hello скрипт может неблагоприятно повлиять на производительность hello hello виртуальной Машины, при использовании вместе с hello «Тест» или «Custom» сценарий, настроенный с помощью программы XPerf или DiskSpd. Будьте внимательны при запуске скрипта hello в рабочей среде.

2.  При использовании сценария hello вместе с hello «Тест» или «Custom» сценарий, настроенный с помощью DiskSpd, убедитесь, что никакие другие действия фона мешает рабочей нагрузки ввода-вывода hello на дисках hello протестированы.

3.  По умолчанию hello скрипт использует диск toocollect hello временного хранилища данных. Если трассировка включена на длительное время остается, hello объем собираемых данных может быть применимо. Это позволяет сократить hello доступного пространства на диске временный hello, поэтому влияет на все приложения, основанные на этом диске.

### <a name="how-do-i-run-perfinsights"></a>Способ запуска PerfInsights 

toorun Здравствуйте сценария, выполните следующие действия:

1. Скачайте [PerfInsights.zip](http://aka.ms/perfinsightsdownload).

2. Разблокируйте файл PerfInsights.zip hello. toodo это файл PerfInsights.zip hello щелкните правой кнопкой мыши, выберите **свойства**. В hello **Общие** выберите **Unblock** , а затем выберите **ОК**. Это гарантирует выполнение скрипта hello без запрашивает все дополнительные параметры безопасности.  

    ![Разблокировать hello ZIP-файл](media/how-to-use-perfInsights/unlock-file.png)

3.  Разверните файл PerfInsights.zip hello сжимаются в дисковод временные (по умолчанию, обычно это диск hello D). Hello сжатый файл должен содержать hello следующие файлы и папки:

    ![файлы в ZIP-папки hello](media/how-to-use-perfInsights/file-folder.png)

4.  Откройте Windows PowerShell с правами администратора и запустите сценарий PerfInsights.ps1 hello.

    ```
    cd <hello path of PerfInsights folder >
    Powershell.exe -ExecutionPolicy UnRestricted -NoProfile -File .\\PerfInsights.ps1
    ```

    Может потребоваться tooenter «y» вы tooif запроса tooconfirm, политику выполнения toochange hello.

    В диалоговом окне заявление об отказе hello пользователь получает диагностические сведения hello параметр tooshare со службой поддержки Майкрософт. Кроме того, должен дать согласие toohello лицензионного соглашения toocontinue. Выберите нужные параметры и нажмите кнопку **Выполнить скрипт**.

    ![Диалоговое окно "Отказ от ответственности"](media/how-to-use-perfInsights/disclaimer.png)

5.  Отправьте номер обращения hello, если оно доступно, при запуске скрипта hello (это для наших статистики). Затем нажмите кнопку **ОК**.
    
    ![Ввод идентификатора поддержки](media/how-to-use-perfInsights/enter-support-number.png)

6.  Выберите диск временного хранилища. Hello сценария можно автоматическое обнаружение hello буква hello. При возникновении любых проблем на этом этапе, может быть предложено tooselect hello диск (диск по умолчанию hello — D). Созданные журналы хранятся здесь в журнале hello\_папку коллекции. Введите или используйте hello букву диска, нажмите кнопку **ОК**.

    ![Выбор буквы диска](media/how-to-use-perfInsights/enter-drive.png)

7.  Выберите hello, предоставленный список сценария устранения неполадок.

       ![Выбор сценария поддержки](media/how-to-use-perfInsights/select-scenarios.png)

8.  Также вы можете запустить PerfInsights без пользовательского интерфейса.

    Hello следующую команду hello запуски «Общая виртуальная машина медленно анализ» Устранение неполадок сценарий без запроса пользовательского интерфейса или захват данных в течение 30 секунд. Запрашивает tooconsent toohello же заявление об отказе и лицензионное соглашение, упомянутых в шаге 4.

        powershell.exe -ExecutionPolicy UnRestricted -NoProfile -Command ".\\PerfInsights.ps1 -NoGui -Scenario vmslow -TracingDuration 30"

    PerfInsights toorun в автоматическом режиме, используйте **- AcceptDisclaimerAndShareDiagnostics** параметра. Например используйте hello следующую команду:

        powershell.exe -ExecutionPolicy UnRestricted -NoProfile -Command ".\\PerfInsights.ps1 -NoGui -Scenario vmslow -TracingDuration 30 -AcceptDisclaimerAndShareDiagnostics"

### <a name="how-do-i-troubleshoot-issues-while-running-hello-script"></a>Устранение проблем при выполнении скрипта hello

При аварийном завершении сценария hello несогласованное состояние, запустив сценарий hello вместе с можно очистить hello - коммутатор очистки следующим образом:

    powershell.exe -ExecutionPolicy UnRestricted -NoProfile -Command ".\\PerfInsights.ps1 -Cleanup"

При возникновении любых проблем во время автоматического обнаружения hello временный диск hello, может быть предложено tooselect hello диск (диск по умолчанию hello — D).

![ввод буквы диска](media/how-to-use-perfInsights/enter-drive.png)

сценарий Hello удаляет средства служебной программы hello и удаляет временные папки.

### <a name="troubleshooting-other-script-issues"></a>Устранение неполадок, связанных с запуском скриптов 

При возникновении любых проблем, при запуске скрипта hello, нажмите клавишу выполнение скрипта hello toointerrupt Ctrl + C. временные объекты tooremove, см. раздел «Очистка после аварийного завершения» hello.

В случае продолжения сбоя сценария tooexperience даже после нескольких попыток рекомендуется запустить скрипт hello в «режиме отладки» с помощью hello «-отладка» параметра при запуске.

После сбоя hello происходит копирование hello полного вывода консоли PowerShell hello и отправить его агента toohello технической поддержки Майкрософт, который поможет устранить toohelp устранения неполадок hello.

### <a name="how-do-i-run-hello-script-in-custom-configuration-mode"></a>Как выполнить скрипт hello в режиме настраиваемой конфигурации

Выбрав hello **настраиваемый** конфигурации, можно включить несколько трассировок в параллельном режиме (с помощью toomulti Shift-select):

![выбор сценариев](media/how-to-use-perfInsights/select-scenario.png)

При выборе диагностики производительности hello трассировки счетчик производительности, XPerf трассировки, сетевой трассировки или сценарии трассировки Storport следуйте инструкциям hello в диалоговых окнах hello и повторите tooreproduce hello низкой производительностью проблему после начала трассировки hello.

Привет, следуя диалоговое окно позволяет запустить трассировку:

![запуск трассировки](media/how-to-use-perfInsights/start-trace-message.png)

toostop hello трассировок, у вас есть команда hello tooconfirm во втором диалоговом окне.

![stop-trace](media/how-to-use-perfInsights/stop-trace-message.png)
![stop-trace](media/how-to-use-perfInsights/ok-trace-message.png)

Когда hello трассировки или завершения операций, новый файл создается в D:\\журнала\_коллекции (или временный диск hello) с именем **CollectedData\_гггг мм дд\_hh\_мм \_ss.zip.** Вы можете отправить этот файл toohello поддержки агент для анализа.

## <a name="review-hello-diagnostics-report-created-by-perfinsights"></a>Просмотрите отчет о диагностике hello созданные PerfInsights

В рамках hello **CollectedData\_гггг мм дд\_hh\_мм\_файл ss.zip** , созданный PerfInsights, можно найти HTML-отчет с подробными сведениями о hello результатов PerfInsights. tooreview Здравствуйте отчет, разверните hello **CollectedData\_гггг мм дд\_hh\_мм\_ss.zip** файла, а затем откройте hello **PerfInsights Report.html**файла.

Выберите hello **результаты** вкладки.

![вкладка "Результаты"](media/how-to-use-perfInsights/findingtab.png)

**Примечания**

-   Сообщения, выделенные красным, представляют известные проблемы конфигурации, которые могут вызвать снижение производительности.

-   Сообщения, выделенные желтым цветом, обозначают предупреждения о том, что конфигурации не являются оптимальными, но необязательно вызывают проблемы с производительностью.

-   Сообщения, выделенные синим цветом, — это просто информативные инструкции.

Просмотрите hello ссылки HTTP для всех сообщений об ошибках в red tooget более подробные сведения о результаты hello и как они могут повлиять на производительность hello или рекомендации по оптимизации производительности конфигурации.

### <a name="disk-configuration-tab"></a>Вкладка конфигурации дисков

Hello **Обзор** разделе отображаются различные представления hello хранилища конфигурации, включая сведения из Diskpart и дисковые пространства

Hello **DiskMap** и **VolumeMap** разделах описаны на перспективе двух логических томов и физических дисков, связанных tooeach других.

В hello перспективы физический диск (DiskMap) hello таблице показаны все логические тома, которые выполняются на диске hello. В следующем примере hello PhysicalDrive2 запускает 2 логического тома, созданные на несколько разделов ("J" и "H"):

![вкладка с данными](media/how-to-use-perfInsights/disktab.png)

В hello перспективы тома (*VolumeMap*), hello таблицах показаны все физические диски hello в каждом логическом томе. Обратите внимание, что для RAID-массивов и динамических дисков можно разместить логический том на нескольких физических дисках. В следующий образец hello *C:\\подключить* является точка монтирования настроен в качестве *SpannedDisk* на физические диски \#2 и \#3:

![вкладка томов](media/how-to-use-perfInsights/volumetab.png)

### <a name="sql-server-tab"></a>вкладка SQL Server

Если целевой hello виртуальной Машины размещаются экземпляры SQL Server, вы увидите дополнительную вкладку в отчете hello, которая называется **SQL Server**:

![вкладка SQL](media/how-to-use-perfInsights/sqltab.png)

Этот раздел содержит вкладки дополнительных sub и «Обзор» для каждого экземпляра SQL Server hello, размещенных на hello виртуальной Машины.

раздел «Обзор» Hello содержит полезные таблицы, которая обобщает все hello физические диски (системы и дисков данных), которые работают и которые содержат сочетание файлов данных и файлов журнала транзакций.

В следующий пример, hello *Диск_0* (под управлением hello C диска) отображается, так как оба hello *modeldev* и *modellog* файлы находятся на диске hello C и они относятся к различным типам (таких как файл данных и журнала транзакций, соответственно):

![сведения журнала](media/how-to-use-perfInsights/loginfo.png)

вкладки данного экземпляра SQL Server Hello содержать общие раздел, в котором отображаются основные сведения о выбранном экземпляре hello и дополнительные разделы, Дополнительные сведения, включая параметры конфигурации и параметры пользователя.

## <a name="references-toohello-external-tools-used"></a>Ссылается на внешние средства toohello используется

### <a name="diskspd"></a>Diskspd

DISKSPD — это хранилище нагрузки генератора и производительности теста средство приветствия Windows и Windows Server и сервера инфраструктуры облака группы engineering. Дополнительные сведения можно найти по [этой ссылке](https://github.com/Microsoft/diskspd).

### <a name="xperf"></a>XPerf

XPerf является трассировки toocapture средство командной строки из набора средств производительности Windows hello.

Дополнительные сведения см. в записи блога [Windows Performance Toolkit - Xperf](https://blogs.msdn.microsoft.com/ntdebugging/2008/04/03/windows-performance-toolkit-xperf/) (Набор средств оценки производительности Windows — XPerf).

## <a name="next-steps"></a>Дальнейшие действия

### <a name="upload-diagnostics-logs-and-reports-toomicrosoft-support-for-further-review"></a>Отправить диагностические журналы и отчеты tooMicrosoft поддержки для дальнейшего анализа

При работе с hello персонал службы поддержки Майкрософт, может быть запрошенный tootransmit hello вывода, создаваемые hello tooassist PerfInsights, поиск и устранение неполадок.

агент поддержки Hello создаст DTM рабочей области автоматически, и вы получите сообщение электронной почты, включающий ссылку toohello [DTM портала (https://filetransfer.support.microsoft.com/EFTClient/Account/Login.htm) и уникальный идентификатор пользователя и пароль.

Это сообщение будет отправлено **службой автоматической диагностики CTS** (ctsadiag@microsoft.com).

![Образец hello сообщения](media/how-to-use-perfInsights/supportemail.png)

Для обеспечения дополнительной безопасности можно необходимые toochange пароля на первом использовании.

После входа в tooDTM вы найдете hello диалогового окна поле tooupload **CollectedData\_гггг мм дд\_hh\_мм\_ss.zip** файлов, собранных с PerfInsights.

---
title: "Как использовать PerfInsights в Microsoft Azure | Документация Майкрософт"
description: "Использование PerfInsights для устранения проблем производительности на виртуальных машинах Windows."
services: virtual-machines-windows'
documentationcenter: 
author: genlin
manager: cshepard
editor: na
tags: 
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: troubleshooting
ms.date: 11/03/2017
ms.author: genli
ms.openlocfilehash: f15875610e2035c6f4c10c36e19c02f3e045b3ea
ms.sourcegitcommit: 3fca41d1c978d4b9165666bb2a9a1fe2a13aabb6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/15/2017
---
# <a name="how-to-use-perfinsights"></a>Как использовать PerfInsights 

[PerfInsights](http://aka.ms/perfinsightsdownload) является автоматизированного скрипта, собирающий полезных диагностических данных. Он также выполняет загрузку нагрузки ввода-вывода и отчета об анализе проблем производительности виртуальной машины Windows в Azure. Это можно запускать на виртуальных машинах как изолированный сценарий, или непосредственно на портале, установив [расширения виртуальной Машины для диагностики производительности Azure](performance-diagnostics-vm-extension.md).

При возникновении проблем производительности с виртуальными машинами, перед обращением в службу поддержки этого сценария.

## <a name="supported-troubleshooting-scenarios"></a>Поддерживаемые сценарии устранения неисправностей

PerfInsights можно собирать и анализировать несколько типов данных. В следующих разделах описываются распространенные сценарии.

### <a name="collect-basic-configuration"></a>Собирать базовой конфигурации 

Этот сценарий собирает конфигурацию диска и другие важные сведения, включая:

-   Журналы событий

-   состояние всех входящих и исходящих сетевых подключений;

-   параметры конфигурации сети и брандмауэра;

-   список задач всех приложений, запущенных в системе;

-   Файл сведений о созданных msinfo32 для виртуальной машины

-   параметры конфигурации базы данных Microsoft SQL Server (если виртуальная машина определяется как сервер, на котором выполняется SQL Server);

-   счетчики надежности хранилища;

-   важные исправления Windows;

-   установленные драйверы фильтра.

Это пассивный сбор данных, который не должен повлиять на систему. 

>[!Note]
>Этот сценарий автоматически включен в каждый из следующих сценариев.

### <a name="benchmarking"></a>Тестирование производительности

Этот сценарий запускается [Diskspd](https://github.com/Microsoft/diskspd) тестов производительности (операции ввода-ВЫВОДА и Мбит/с) для всех дисков, подключенных к виртуальной машине. 

> [!Note]
> Этот сценарий может повлиять на системы и не должны выполняться в производственной системе. При необходимости запустите этот сценарий во время выделенного периода обслуживания, чтобы избежать проблем. Увеличение рабочей нагрузки, вызванное теста трассировки или тестирования может отрицательно сказаться на производительности виртуальной Машины.
>

### <a name="slow-vm-analysis"></a>Анализ медленной виртуальной машины 

Этот сценарий запускает трассировку [счетчиков производительности](https://msdn.microsoft.com/library/windows/desktop/aa373083(v=vs.85).aspx), которые указаны в файле Generalcounters.txt. Если ВМ, определяется как сервер, на котором выполняется SQL Server, оно выполняется трассировки счетчика производительности. Это достигается с помощью счетчиков, которые находятся в файле Sqlcounters.txt и включает данные диагностики производительности.

### <a name="slow-vm-analysis-and-benchmarking"></a>Анализ и тестирование производительности медленной виртуальной машины

Этот сценарий запускается [счетчика производительности](https://msdn.microsoft.com/library/windows/desktop/aa373083(v=vs.85).aspx) трассировки, за которым следуют [Diskspd](https://github.com/Microsoft/diskspd) тестов производительности. 

> [!Note]
> Этот сценарий может повлиять на системы и не должны выполняться в производственной системе. При необходимости запустите этот сценарий во время выделенного периода обслуживания, чтобы избежать проблем. Увеличение рабочей нагрузки, вызванное теста трассировки или тестирования может отрицательно сказаться на производительности виртуальной Машины.
>

### <a name="azure-files-analysis"></a>Анализ файлов Azure 

Этот сценарий запускает специальную запись счетчиков производительности вместе с функцией сетевой трассировки. Запись включает все счетчики общих папок клиента Server Message Block (SMB). Ниже приведены некоторые ключевые счетчики производительности общих ресурсов SMB-клиента, которые являются частью записи.

| **Тип**     | **Общие ресурсы SMB-клиента** |
|--------------|-------------------------------|
| ОПЕРАЦИЙ ВВОДА-ВЫВОДА         | Запросов данных в секунду             |
|              | Запросов на чтение в секунду             |
|              | Запросов на запись в секунду            |
| Latency      | Среднее число секунд на запрос данных         |
|              | Среднее число секунд на запрос на чтение                 |
|              | Среднее число секунд на запрос на запись                |
| Размер ввода-вывода      | Среднее число байтов в запросе       |
|              | Среднее число байтов в запросе на чтение               |
|              | Среднее число байтов в запросе на запись              |
| Throughput   | Байтов в секунду                |
|              | Прочитано байтов в секунду                |
|              | Записано байтов в секунду               |
| Длина очереди | Среднее Длина очереди чтения        |
|              | Среднее Длина очереди записи       |
|              | Среднее Длина очереди данных        |

### <a name="custom-slow-vm-analysis"></a>Пользовательский анализ медленной виртуальной машины 

При запуске пользовательский медленно анализ виртуальной Машины, выбрать трассировки для параллельного выполнения. Вы можете выполнять их все (счетчик производительности, Xperf, сети и StorPort) Если необходимо. После завершения трассировки, средство выполняет тест Diskspd, если он установлен. 

> [!Note]
> Этот сценарий может повлиять на системы и не должны выполняться в производственной системе. При необходимости запустите этот сценарий во время выделенного периода обслуживания, чтобы избежать проблем. Увеличение рабочей нагрузки, вызванное теста трассировки или тестирования может отрицательно сказаться на производительности виртуальной Машины.
>

## <a name="what-kind-of-information-is-collected-by-the-script"></a>Сведения, которые собираются с помощью скрипта

Записывает сведения о виртуальной Машине Windows, дисков или конфигурации пулов носителей, счетчики производительности, а различные трассировки собираются. Это зависит от сценария оценки производительности, которую вы используете. Подробности приведены в следующей таблице.

|Собираемые данные                              |  |  | Сценарии производительности |  |  | |
|----------------------------------|----------------------------|------------------------------------|--------------------------|--------------------------------|----------------------|----------------------|
|                              | Собирать базовой конфигурации | Тестирование производительности | Анализ медленной виртуальной машины | Анализ и тестирование производительности медленной виртуальной машины | Анализ файлов Azure | Пользовательский анализ медленной виртуальной машины |
| Сведения из журналов событий      | Yes                        | Yes                                | Yes                      | Yes                            | Yes                  | Yes                  |
| Сведения о системе               | Yes                        | Yes                                | Yes                      | Yes                            | Yes                  | Yes                  |
| Карты тома                       | Yes                        | Yes                                | Yes                      | Yes                            | Yes                  | Yes                  |
| Сопоставление диска                         | Yes                        | Yes                                | Yes                      | Yes                            | Yes                  | Yes                  |
| Выполняющиеся задачи                    | Yes                        | Yes                                | Yes                      | Yes                            | Yes                  | Yes                  |
| счетчики надежности хранилища;     | Yes                        | Yes                                | Yes                      | Yes                            | Yes                  | Yes                  |
| Сведения о хранилище              | Yes                        | Yes                                | Yes                      | Yes                            | Yes                  | Yes                  |
| Выходные данные fsutil                    | Yes                        | Yes                                | Yes                      | Yes                            | Yes                  | Yes                  |
| Фильтр сведений о драйверах устройств               | Yes                        | Yes                                | Yes                      | Yes                            | Yes                  | Yes                  |
| Выходные данные netstat                   | Yes                        | Yes                                | Yes                      | Yes                            | Yes                  | Yes                  |
| Конфигурация сети            | Yes                        | Yes                                | Yes                      | Yes                            | Yes                  | Yes                  |
| Настройка брандмауэра           | Yes                        | Yes                                | Yes                      | Yes                            | Yes                  | Yes                  |
| Конфигурация SQL Server         | Yes                        | Yes                                | Yes                      | Yes                            | Yes                  | Yes                  |
| Трассировки диагностики производительности * | Yes                        | Yes                                | Yes                      |                                | Yes                  | Yes                  |
| Трассировка счетчика производительности **     |                            |                                    |                          |                                |                      | Yes                  |
| Счетчик трассировки SMB **             |                            |                                    |                          |                                | Yes                  |                      |
| Трассировка SQL Server счетчика **      |                            |                                    |                          |                                |                      | Yes                  |
| Трассировки XPerf                      |                            |                                    |                          |                                |                      | Yes                  |
| StorPort трассировки                   |                            |                                    |                          |                                |                      | Yes                  |
| Трассировка сети                    |                            |                                    |                          |                                | Yes                  | Yes                  |
| Трассировки тесте Diskspd ***      |                            | Yes                                |                          | Yes                            |                      |                      |
|       |                            |                         |                                                   |                      |                      |

### <a name="performance-diagnostics-trace-"></a>Трассировки для диагностики производительности (*)

Запускает в фоновом режиме модуль на основе правила для сбора данных и диагностики проблем с производительностью системы. В настоящее время поддерживаются следующие правила:

- Правило HighCpuUsage: Определяет высокой периодов использования ЦП и показывает основных потребителей использования ЦП в течение этих периодов.
- Правило HighDiskUsage: Определяет периодах дисков на физических дисках и показывает потребители использование top диска в эти периоды.
- Правило HighResolutionDiskMetric: показывает метрики задержки операций ввода-ВЫВОДА, пропускная способность и ввода-вывода на 50 мс для каждого физического диска. Это позволяет быстро найти периоды регулирования диска.
- Правило HighMemoryUsage. Определяет периоды высокой загрузки памяти и показывает основных потребителей памяти в эти периоды.

> [!NOTE] 
> В настоящее время поддерживаются версии Windows, которые содержат .NET Framework 3.5 или более поздней версии.

### <a name="performance-counter-trace-"></a>Трассировка счетчиков производительности (*)

Собирает следующие счетчики производительности:

- \Process, \Processor, \Memory, \Thread, \PhysicalDisk и \LogicalDisk
- \Server\Pool страниц на диск \Cache\Lazy записи/с, \Cache\Dirty невыгружаемой, ошибок и \Server\Pool, разбитых на страницы
- Выбранные счетчики в категорию \Network интерфейс \IPv4\Datagrams, \IPv6\Datagrams, \TCPv4\Segments, \TCPv6\Segments, \Network адаптера, \WFPv4\Packets, \WFPv6\Packets, \UDPv4\Datagrams, \UDPv6\Datagrams, \TCPv4\Connection, \TCPv6\Connection, \ Сетевые QoS Policy\Packets, \Per процессор сетевой интерфейс карты активности и \Microsoft Winsock BSP

#### <a name="for-sql-server-instances"></a>Для экземпляров SQL Server
- \SQL server: Buffer Manager \SQLServer:Resource Pool Stats и \SQLServer:SQL Statistics\
- \SQLServer: блокировки, \SQLServer: общая статистика
- \SQLServer: способы доступа

#### <a name="for-azure-files"></a>Для файлов Azure
\Общие ресурсы SMB-клиента

### <a name="diskspd-benchmark-trace-"></a>Трассировки тесте Diskspd (*)
Тесты рабочей нагрузки ввода-вывода Diskspd (диск операционной системы [write] и диски пула [только чтение])

## <a name="run-the-perfinsights-script-on-your-vm"></a>Запустите сценарий PerfInsights на виртуальной Машине

### <a name="what-do-i-have-to-know-before-i-run-the-script"></a>Что нужно знать, прежде чем запускать скрипт 

#### <a name="script-requirements"></a>Требования к скриптам

-  Этот скрипт следует выполнять на виртуальных машинах с проблемами производительности. 

-  Поддерживаются следующие операционные системы: Windows Server 2008 R2, Windows Server 2012, Windows Server 2012 R2 и Windows Server 2016; Windows 8.1 и Windows 10.

#### <a name="possible-problems-when-you-run-the-script-on-production-vms"></a>Возможные проблемы при запуске сценария на рабочих виртуальных машин

-  Для оценки эффективности сценарии или сценарии «Custom медленно анализ виртуальной Машины», который настроен на использование Xperf или Diskspd скрипт может неблагоприятно повлиять на производительность виртуальной машины. Эти сценарии не следует запускать в рабочей среде.

-  Для оценки эффективности сценарии или сценарии «Custom медленно анализ виртуальной Машины», который настроен для использования Diskspd убедитесь, не фоновой активности мешает рабочей нагрузки ввода-вывода.

-  По умолчанию для сбора данных скрипт использует диск временного хранилища. Если трассировка остается включенной длительное время, объем собираемых данных может увеличится соответственно. Это может снизить доступного пространства на временном диске и таким образом влияют на все приложения, основанные на этом диске.

### <a name="how-do-i-run-perfinsights"></a>Способ запуска PerfInsights 

PerfInsights можно запускать на виртуальной машине, установив [расширения виртуальной Машины для диагностики производительности Azure](performance-diagnostics-vm-extension.md). Можно также запустить ее как сценарий автономной. 

**Установка и запуск PerfInsights на портале Azure**

Дополнительные сведения об этом параметре см. в разделе [установить расширения ВМ диагностики Azure производительности](performance-diagnostics-vm-extension.md#install-the-extension).  

**Запуск сценария PerfInsights в автономном режиме**

Чтобы запустить сценарий PerfInsights, сделайте следующее.


1. Скачайте [PerfInsights.zip](http://aka.ms/perfinsightsdownload).

2. Разблокируйте файл PerfInsights.zip. Для этого щелкните правой кнопкой мыши файл PerfInsights.zip и выберите **свойства**. В **Общие** выберите **Unblock**, а затем выберите **ОК**. Это гарантирует, что сценарий выполняется без запросам любой дополнительной безопасности.  

    ![Снимок экрана PerfInsights свойства использования, с выделенной Unblock](media/how-to-use-perfInsights/unlock-file.png)

3.  Разверните сжатый файл PerfInsights.zip в дисковод временные (по умолчанию, это обычно диск D). Сжатый файл должен содержать следующие файлы и папки:

    ![Снимок экрана файлов в ZIP-папки](media/how-to-use-perfInsights/file-folder.png)

4.  Откройте Windows PowerShell с правами администратора и запустите скрипт PerfInsights.ps1.

    ```
    cd <the path of PerfInsights folder >
    Powershell.exe -ExecutionPolicy UnRestricted -NoProfile -File .\\PerfInsights.ps1
    ```

    Может потребоваться ввести «y», чтобы убедиться, что вы хотите изменить политику выполнения.

    В **Обратите внимание и дать согласие,** диалоговое окно, вы можете совместно использовать диагностические данные службе технической поддержки Майкрософт. Также необходимо принять лицензионное соглашение, чтобы продолжить. Внесите нужные изменения, а затем выберите **выполнить сценарий**.

    ![Снимок экрана уведомления и согласия диалоговое окно](media/how-to-use-perfInsights/disclaimer.png)

5.  Отправьте номер обращения, если оно доступно, при запуске скрипта. Нажмите кнопку **ОК**.
    
    ![Снимок экрана диалогового окна идентификатор поддержки](media/how-to-use-perfInsights/enter-support-number.png)

6.  Выберите диск временного хранилища. Скрипт может автоматическое обнаружение букву диска. При возникновении каких-либо проблем на этом этапе вам может быть предложено выбрать диск (по умолчанию это диск D). Созданные журналы хранятся здесь, в журнале\_папку коллекции. После ввода или используйте букву диска, выберите **ОК**.

    ![Снимок экрана: диалоговое окно временный диск](media/how-to-use-perfInsights/enter-drive.png)

7.  Выберите сценарий устранения неполадок в предоставленном списке.

       ![Снимок экрана: список сценариев устранения неполадок](media/how-to-use-perfInsights/select-scenarios.png)

Также вы можете запустить PerfInsights без пользовательского интерфейса. Следующая команда выполняет устранение неполадок сценарий без пользовательского интерфейса «виртуальная машина медленно анализ». Вам будет предложено принять отказ от ответственности и лицензионное соглашение, указанные на шаге 4.

        powershell.exe -ExecutionPolicy UnRestricted -NoProfile -Command ".\\PerfInsights.ps1 -NoGui -Scenario vmslow -TracingDuration 30"

Для запуска PerfInsights в автоматическом режиме используйте параметр **-AcceptDisclaimerAndShareDiagnostics**. Например, используйте следующую команду:

        powershell.exe -ExecutionPolicy UnRestricted -NoProfile -Command ".\\PerfInsights.ps1 -NoGui -Scenario vmslow -TracingDuration 30 -AcceptDisclaimerAndShareDiagnostics"

### <a name="how-do-i-troubleshoot-issues-while-running-the-script"></a>Устранение проблем во время выполнении скрипта

При аварийном завершении скрипт может возвращать в согласованное состояние, запустив скрипт с параметром очистки следующим образом:

    powershell.exe -ExecutionPolicy UnRestricted -NoProfile -Command ".\\PerfInsights.ps1 -Cleanup"

При возникновении каких-либо проблем во время автоматического обнаружения временного диска вам может быть предложено выбрать диск (по умолчанию это диск D).

![Снимок экрана: диалоговое окно временный диск](media/how-to-use-perfInsights/enter-drive.png)

Этот скрипт удаляет средства служебной программы и временные папки.

### <a name="troubleshoot-other-script-issues"></a>Устранение неполадок других сценариев 

При возникновении любых проблем при запуске сценария, нажмите Ctrl + C, чтобы прервать выполнение скрипта. При повторном возникновении сбоя сценария даже после нескольких попыток выполнения скрипта в режиме отладки с помощью «-отладки» параметра при запуске.

После возникновения сбоя скопируйте все выходные данные в консоли PowerShell и отправьте их представителю службы поддержки Майкрософт, который поможет устранить проблему.

### <a name="how-do-i-run-the-script-in-custom-slow-vm-analysis-mode"></a>Как выполнить скрипт в режиме «Custom медленно анализ виртуальной Машины»

Выбрав **медленно ВМ анализа пользовательских**, можно включить несколько трассировок в параллельном режиме (чтобы выбрать несколько трассировок, используйте клавишу Shift):

![Снимок экрана: список сценариев](media/how-to-use-perfInsights/select-scenario.png)

При выборе трассировки счетчик производительности, Xperf трассировки, сетевой трассировки или сценарии трассировки Storport, следуйте инструкциям в последующие диалоговые окна. Попробуйте воспроизвести проблему снижения производительности после начала трассировки.

Можно запустить трассировку через следующее диалоговое окно:

![Снимок экрана для запуска производительности счетчик трассировки-диалоговое окно](media/how-to-use-perfInsights/start-trace-message.png)

Чтобы остановить трассировку, необходимо подтвердить выполнение команды во втором диалоговом окне.

![Снимок экрана для остановки производительности счетчик трассировки диалоговое](media/how-to-use-perfInsights/stop-trace-message.png)
![экрана остановка всех трассировок диалоговое окно](media/how-to-use-perfInsights/ok-trace-message.png)

После завершения трассировки или операции создается новый файл отображается в D:\\журнала\_коллекции (или временный диск). Имя файла является **CollectedData\_гггг мм дд\_hh\_мм\_ss.zip.** Этот файл можно отправить в службу поддержки для анализа.

## <a name="review-the-diagnostics-report"></a>Просмотрите отчет о диагностике

В пределах **CollectedData\_гггг мм дд\_hh\_мм\_ss.zip** файл, можно найти с подробными сведениями о результаты PerfInsights HTML-отчета. Чтобы просмотреть отчет, разверните файл **CollectedData\_ГГГГ-ММ-ДД\_ЧЧ\_ММ\_ss.zip**, а затем откройте файл **PerfInsights Report.html**.

Выберите вкладку **Результаты**.

![Снимок экрана отчета PerfInsights](media/how-to-use-perfInsights/findingtab.png)
![экрана PerfInsights отчета](media/how-to-use-perfInsights/findings.PNG)

> [!NOTE] 
> Результаты, которые классифицируются как важные известные проблемы, которые могут вызвать проблемы с производительностью. В категорию важных попадают результаты, указывающие на неоптимальную конфигурацию, которая может не приводить к проблемам с производительностью. Результаты из категории информационных содержат сообщения, которые полезно принять к сведению.

Просмотрите рекомендации и приведены ссылки на все критические и важные результаты. Сведения о том, как они могут повлиять на производительность, а также советы и рекомендации для оптимизации производительности конфигураций.

### <a name="storage-tab"></a>Вкладка хранилища

В разделе **Результаты** отображаются разные результаты и рекомендации, которые относятся к хранилищу.

**Карты диск** и **карты тома** рассматриваются как логические тома, а физические диски связаны друг с другом.

В перспективе физический диск (диск карта) в таблице показаны все логические тома, которые выполняются на диске. В следующем примере **PhysicalDrive2** выполняется два логических томов, созданных на несколько разделов ("J" и "H"):

![Снимок экрана: вкладка «диск»](media/how-to-use-perfInsights/disktab.png)

В перспективе тома (тома карта) в таблицах показаны все физические диски в каждом логическом томе. Обратите внимание, что для RAID и динамические диски, можно запустить логический том на несколько физических дисков. В следующем примере *C:\\подключить* точку подключения настраивается как *SpannedDisk* на физических дисках, 2 и 3:

![Снимок экрана: вкладка тома](media/how-to-use-perfInsights/volumetab.png)

### <a name="sql-tab"></a>Вкладка SQL

Если в целевой виртуальной Машины размещаются экземпляры SQL Server, вы видите дополнительную вкладку в отчете, с именем **SQL**:

![Снимок экрана SQL-вкладка](media/how-to-use-perfInsights/sqltab.png)

В этом разделе содержатся **результаты** вкладки и дополнительные вкладки для каждого экземпляра SQL Server, размещенных на виртуальной Машине.

**Результаты** вкладка содержит список всех SQL проблем производительности найден, а также рекомендации.

В следующем примере **Диск_0** отображается (запущенной на диск C). Это обусловлено как **modeldev** и **modellog** файлы находятся на диске C, и они относятся к различным типам (например данных файла журнала транзакций, соответственно).

![Снимок экрана: сведения о журнале](media/how-to-use-perfInsights/loginfo.png)

На вкладке для определенных экземпляров SQL Server содержатся общие раздел, который содержит базовые сведения о выбранном экземпляре. На вкладке содержатся также дополнительные разделы, Дополнительные сведения, включая параметры конфигурации и параметры пользователя.

### <a name="diagnostic-tab"></a>Вкладка диагностики
**Диагностики** вкладка содержит сведения о наиболее активных потребителях ЦП, диска и памяти на компьютере в течение выполнения PerfInsights. Также можно найти сведения о важных исправлений, система может быть отсутствует, список задач и важных системных событий. 

## <a name="references-to-the-external-tools-used"></a>Ссылки на внешние используемые средства

### <a name="diskspd"></a>Diskspd

Diskspd — это хранилище нагрузки генератора и производительности теста средство корпорации Майкрософт. Дополнительные сведения можно найти по [этой ссылке](https://github.com/Microsoft/diskspd).

### <a name="xperf"></a>XPerf

XPerf является средством командной строки для захвата трассировок из набора средств производительности Windows. Дополнительные сведения см. в записи блога [Windows Performance Toolkit - Xperf](https://blogs.msdn.microsoft.com/ntdebugging/2008/04/03/windows-performance-toolkit-xperf/) (Набор средств оценки производительности Windows — XPerf).

## <a name="next-steps"></a>Дальнейшие действия

Журналы диагностики и отчетов можно отправить в службу поддержки Майкрософт для дальнейшего анализа. Служба поддержки может запросить передачи выходные данные, создаваемые PerfInsights, облегчающие процесс устранения неполадок.

На следующем рисунке показан сообщение может появиться примерно:

![Снимок экрана: пример сообщения от службы поддержки Майкрософт](media/how-to-use-perfInsights/supportemail.png)

Следуйте инструкциям в сообщении, чтобы открыть рабочую область передачи файла. Для обеспечения дополнительной защиты необходимо изменить пароль при первом использовании.

После входа вы найдете диалоговое окно для отправки **CollectedData\_гггг мм дд\_hh\_мм\_ss.zip** файлов, собранных с PerfInsights.

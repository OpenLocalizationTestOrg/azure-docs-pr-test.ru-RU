---
title: "Как использовать PerfInsights в Microsoft Azure | Документация Майкрософт"
description: "Использование PerfInsights для устранения проблем производительности на виртуальных машинах Windows."
services: virtual-machines-windows'
documentationcenter: 
author: genlin
manager: cshepard
editor: na
tags: 
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: article
ms.date: 07/18/2017
ms.author: genli
ms.openlocfilehash: f22bd42302b96118dba0d4e5e387c6798a0b8777
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="how-to-use-perfinsights"></a>Как использовать PerfInsights 

[PerfInsights](http://aka.ms/perfinsightsdownload) — это автоматический скрипт, который собирает полезные диагностические данные, выполняет стрессовые нагрузки ввода-вывода и предоставляет отчеты об анализе для устранения проблем производительности на виртуальных машинах Windows в Microsoft Azure. 

Мы советуем запускать этот скрипт, прежде чем отправлять запрос в службу поддержки Майкрософт на устранение проблем производительности на виртуальных машинах.

## <a name="supported-troubleshooting-scenarios"></a>Поддерживаемые сценарии устранения неисправностей

PerfInsights может собирать и анализировать несколько типов данных, которые группируются в уникальные сценарии.

### <a name="collect-disk-configuration"></a>Сбор данных конфигурации дисков 

Этот сценарий собирает данные конфигурации дисков и другие важные сведения,в том числе:

-   Журналы событий

-   состояние всех входящих и исходящих сетевых подключений;

-   параметры конфигурации сети и брандмауэра;

-   список задач всех приложений, запущенных в системе;

-   файл со сведениями, созданный для виртуальной машины с помощью msinfo32;

-   параметры конфигурации базы данных Microsoft SQL Server (если виртуальная машина определяется как сервер, на котором выполняется SQL Server);

-   счетчики надежности хранилища;

-   важные исправления Windows;

-   установленные драйверы фильтра.

Это пассивный сбор данных, который не должен повлиять на систему. 

>[!Note]
>Этот сценарий автоматически включен в каждый из следующих сценариев.

### <a name="benchmarkstorage-performance-test"></a>Тест производительности хранилища

Этот сценарий запускает тест производительности [diskspd](https://github.com/Microsoft/diskspd) (операции ввода-вывода в Мбит/с) всех дисков, подключенных к виртуальной машине. 

> [!Note]
> Данный сценарий не рекомендуется запускать в рабочей системе, так как он может повлиять на систему. При необходимости запустите этот сценарий во время выделенного периода обслуживания, чтобы избежать проблем. Увеличение рабочей нагрузки, вызванное тестом производительности или трассировкой, может негативно повлиять на производительность виртуальной машины.
>

### <a name="general-vm-slow-analysis"></a>Общий анализ понижения производительности виртуальной машины 

Этот сценарий запускает трассировку [счетчиков производительности](https://msdn.microsoft.com/library/windows/desktop/aa373083(v=vs.85).aspx), которые указаны в файле Generalcounters.txt. Если виртуальная машина определяется как сервер, на котором работает SQL Server, сценарий выполняет трассировку счетчиков производительности, которые указаны в файле Generalcounters.txt. Он также содержит данные диагностики производительности.

### <a name="vm-slow-analysis-and-benchmark"></a>Тест и анализ понижения производительности виртуальной машины

Этот сценарий запускает трассировку [счетчиков производительности](https://msdn.microsoft.com/library/windows/desktop/aa373083(v=vs.85).aspx), за которой следует тест производительности [diskspd](https://github.com/Microsoft/diskspd). 

> [!Note]
> Данный сценарий не рекомендуется запускать в рабочей системе, так как он может повлиять на систему. При необходимости запустите этот сценарий во время выделенного периода обслуживания, чтобы избежать проблем. Увеличение рабочей нагрузки, вызванное тестом производительности или трассировкой, может негативно повлиять на производительность виртуальной машины.
>

### <a name="azure-files-analysis"></a>Анализ файлов Azure 

Этот сценарий запускает специальную запись счетчиков производительности вместе с функцией сетевой трассировки. Запись включает в себя все счетчики "Общие ресурсы SMB-клиента". Ниже приведены некоторые ключевые счетчики производительности общих ресурсов SMB-клиента, которые являются частью записи.

| **Тип**     | **Общие ресурсы SMB-клиента** |
|--------------|-------------------------------|
| ОПЕРАЦИЙ ВВОДА-ВЫВОДА         | Запросов данных в секунду             |
|              | Запросов на чтение в секунду             |
|              | Запросов на запись в секунду            |
| Задержка      | Средняя запроса данные/сек         |
|              | Среднее время чтения с                 |
|              | Среднее время записи сек                |
| Размер ввода-вывода      | Среднее число байтов в запросе       |
|              | Среднее число байтов в запросе на чтение               |
|              | Среднее число байтов в запросе на запись              |
| Пропускная способность   | Байтов в секунду                |
|              | Прочитано байтов в секунду                |
|              | Записано байтов в секунду               |
| Длина очереди | Среднее Длина очереди чтения        |
|              | Среднее Длина очереди записи       |
|              | Среднее Длина очереди данных        |

### <a name="custom-configuration"></a>Настраиваемая конфигурация 

При запуске пользовательской конфигурации все трассировки выполняются в параллельном режиме (диагностика производительности, счетчик производительности, xperf, сеть, storport), в зависимости от того, сколько различных трассировок выбрано. После завершения трассировки средство выполняет тест производительности diskspd, если он выбран. 

> [!Note]
> Данный сценарий не рекомендуется запускать в рабочей системе, так как он может повлиять на систему. При необходимости запустите этот сценарий во время выделенного периода обслуживания, чтобы избежать проблем. Увеличение рабочей нагрузки, вызванное тестом производительности или трассировкой, может негативно повлиять на производительность виртуальной машины.
>

## <a name="what-kind-of-information-is-collected-by-the-script"></a>Сведения, которые собираются с помощью скрипта

В зависимости от используемого сценария тестирования производительности собираются сведения о виртуальных машинах Windows, конфигурацию дисков или пулов хранения, счетчики производительности, журналы и различные трассировки.

|Собираемые данные                              |  |  | Сценарии тестирования производительности |  |  | |
|----------------------------------|----------------------------|------------------------------------|--------------------------|--------------------------------|----------------------|----------------------|
|                              | Сбор данных конфигурации дисков | Тест производительности хранилища. | Общий анализ понижения производительности виртуальной машины | Тест и анализ понижения производительности виртуальной машины | Анализ файлов Azure | Настраиваемая конфигурация |
| Сведения из журналов событий      | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Сведения о системе               | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Сопоставление томов                       | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Сопоставление дисков                         | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Выполняемые задачи                    | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Счетчики надежности хранилища     | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Сведения о хранилище              | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Выходные данные fsutil                    | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Сведения о драйвере фильтра               | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Выходные данные netstat                   | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Конфигурация сети            | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Настройка брандмауэра           | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Конфигурация SQL Server         | Да                        | Да                                | Да                      | Да                            | Да                  | Да                  |
| Трассировки диагностики производительности* |                            |                                    | Да                      |                                |                      | Да                  |
| Трассировка счетчиков производительности**     |                            |                                    |                          |                                |                      | Да                  |
| Трассировка счетчиков SMB**             |                            |                                    |                          |                                | Да                  |                      |
| Трассировка счетчиков SQL Server**      |                            |                                    |                          |                                |                      | Да                  |
| Трассировка XPerf                      |                            |                                    |                          |                                |                      | Да                  |
| Трассировка StorPort                   |                            |                                    |                          |                                |                      | Да                  |
| Трассировка сети                    |                            |                                    |                          |                                | Да                  | Да                  |
| Трассировка теста производительности Diskspd***      |                            | Да                                |                          | Да                            |                      |                      |
|       |                            |                         |                                                   |                      |                      |

### <a name="performance-diagnostics-trace-"></a>Трассировка диагностики производительности (*)

Запускает в фоновом режиме модуль на основе правила для сбора данных и диагностики проблем с производительностью системы. В настоящее время поддерживаются следующие правила:

- Правило HighCpuUsage. Определяет периоды высокой загрузки ЦП и показывает основных потребителей ресурсов ЦП в эти периоды.
- Правило HighDiskUsage. Определяет периоды высокой загрузки физического диска и показывает основных потребителей диска в эти периоды.
- Правило HighResolutionDiskMetric. Показывает метрики операций ввода-вывода, пропускной способности и задержки операций ввода-вывода за 50 мс для каждого физического диска. Это позволяет быстро найти периоды регулирования диска.
- Правило HighMemoryUsage. Определяет периоды высокой загрузки памяти и показывает основных потребителей памяти в эти периоды.

> [!NOTE] 
> В настоящее время поддерживаются версии Windows, которые содержат .NET Framework 3.5 или более поздней версии.

### <a name="performance-counter-trace-"></a>Трассировка счетчиков производительности (**)

Собирает следующие счетчики производительности.

- \Процесс, \Процессор, \Память, \Поток, \Физический диск, \Логический диск
- \Кэш\" Грязные" страницы, \Кэш\Сбросов ленивой записи/с, \Сервер\Невыгружаемый пул, ошибки, \Сервер\Отказов выгружаемого страничного пула
- Выбранные счетчики в категориях \Сетевой интерфейс \IPv4\Датаграммы, \IPv6\Датаграммы, \TCPv4\Сегменты, \TCPv6\Сегменты, \Сетевой адаптер, \WFPv4\Пакеты, \WFPv6\Пакеты, \UDPv4\Датаграммы, \UDPv6\Датаграммы, \TCPv4\Подключение, \TCPv6\Подключение, \Политика качества обслуживания сети\Пакеты, \Активность сетевой карты для каждого процессора, \Microsoft Winsock BSP

#### <a name="for-sql-server-instances"></a>Для экземпляров SQL Server
- \SQL Server:Buffer Manager, \SQLServer:Resource Pool Stats, \SQLServer: статистика SQL\
- \SQLServer: блокировки, \SQLServer: общая статистика
- \SQLServer: способы доступа

#### <a name="for-azure-files"></a>Для файлов Azure
\Общие ресурсы SMB-клиента

### <a name="diskspd-benchmark-trace-"></a>Трассировка теста производительности Diskspd (***)
Тестирование рабочей нагрузки операций ввода-вывода Diskspd [диск операционной системы (запись) и диски пула (чтение и запись)]

## <a name="run-the-perfinsights-on-your-vm"></a>Выполнение PerfInsights на виртуальной машине

### <a name="what-do-i-have-to-know-before-i-run-the-script"></a>Что нужно знать, прежде чем запускать скрипт 

**Требования скрипта**

1.  Этот скрипт следует выполнять на виртуальных машинах с проблемами производительности. 

2.  Поддерживаются следующие операционные системы: Windows Server 2008 R2, 2012, 2012 R2, 2016; Windows 8.1 и Windows 10.

**Возможные проблемы при запуске сценария на рабочих виртуальных машинах:**

1.  Скрипт может неблагоприятно повлиять на производительность виртуальной машины, если он используется вместе со сценариями "Тест производительности" или "Пользовательский", настроенными с помощью XPerf или DiskSpd. Будьте внимательны при запуске сценария в рабочей среде.

2.  При использовании скрипта вместе со сценариями "Тест производительности" или "Пользовательский", настроенными с помощью DiskSpd, убедитесь, что никакие другие фоновые действия не мешают рабочей нагрузке ввода-вывода на тестируемых дисках.

3.  По умолчанию для сбора данных скрипт использует диск временного хранилища. Если трассировка остается включенной длительное время, объем собираемых данных может увеличится соответственно. Это может сократить доступное пространство на временном диске, что повлияет на все приложения, которые используют этот диск.

### <a name="how-do-i-run-perfinsights"></a>Способ запуска PerfInsights 

Чтобы запустить скрипт, выполните следующее.

1. Скачайте [PerfInsights.zip](http://aka.ms/perfinsightsdownload).

2. Разблокируйте файл PerfInsights.zip. Чтобы сделать это, щелкните правой кнопкой мыши файл PerfInsights.zip и выберите **Свойства**. На вкладке **Общие** выберите **Разблокировать** и нажмите кнопку **ОК**. После этого скрип запустится без дополнительных запросов безопасности.  

    ![Разблокирование ZIP-файла](media/how-to-use-perfInsights/unlock-file.png)

3.  Разверните сжатый файл PerfInsights.zip на временный диск (по умолчанию обычно это диск D). Сжатый файл должен содержать следующие файлы и папки:

    ![файлы в ZIP-папке](media/how-to-use-perfInsights/file-folder.png)

4.  Откройте Windows PowerShell с правами администратора и запустите скрипт PerfInsights.ps1.

    ```
    cd <the path of PerfInsights folder >
    Powershell.exe -ExecutionPolicy UnRestricted -NoProfile -File .\\PerfInsights.ps1
    ```

    Может потребоваться ввести"y", если будет предложено подтвердить изменение политики выполнения.

    В диалоговом окне "Отказ от ответственности" можно выбрать вариант предоставления сведений диагностики в службу технической поддержки Майкрософт. Также необходимо принять лицензионное соглашение, чтобы продолжить. Выберите нужные параметры и нажмите кнопку **Выполнить скрипт**.

    ![Диалоговое окно "Отказ от ответственности"](media/how-to-use-perfInsights/disclaimer.png)

5.  При запуске скрипта отправьте номер обращения, если он доступен (он нужен для нашей статистики). Затем нажмите кнопку **ОК**.
    
    ![Ввод идентификатора поддержки](media/how-to-use-perfInsights/enter-support-number.png)

6.  Выберите диск временного хранилища. Скрипт может автоматически обнаружить букву диска. При возникновении каких-либо проблем на этом этапе вам может быть предложено выбрать диск (по умолчанию это диск D). Созданные журналы хранятся в папке log\_collection. Введите или выберите букву диска и нажмите кнопку **ОК**.

    ![Выбор буквы диска](media/how-to-use-perfInsights/enter-drive.png)

7.  Выберите сценарий устранения неполадок в предоставленном списке.

       ![Выбор сценария поддержки](media/how-to-use-perfInsights/select-scenarios.png)

8.  Также вы можете запустить PerfInsights без пользовательского интерфейса.

    Следующая команда запустит сценарий устранения неполадок "Общий анализ понижения производительности виртуальной машины" без запросов пользовательского интерфейса и сохранения данных в течение 30 секунд. Вам будет предложено принять то же заявление об отказе и лицензионное соглашение, указанные на шаге 4.

        powershell.exe -ExecutionPolicy UnRestricted -NoProfile -Command ".\\PerfInsights.ps1 -NoGui -Scenario vmslow -TracingDuration 30"

    Для запуска PerfInsights в автоматическом режиме используйте параметр **-AcceptDisclaimerAndShareDiagnostics**. Например, используйте следующую команду:

        powershell.exe -ExecutionPolicy UnRestricted -NoProfile -Command ".\\PerfInsights.ps1 -NoGui -Scenario vmslow -TracingDuration 30 -AcceptDisclaimerAndShareDiagnostics"

### <a name="how-do-i-troubleshoot-issues-while-running-the-script"></a>Устранение проблем во время выполнении скрипта

При аварийном завершении скрипта несогласованное состояние можно очистить, запустив скрипт с параметром -Cleanup, следующим образом:

    powershell.exe -ExecutionPolicy UnRestricted -NoProfile -Command ".\\PerfInsights.ps1 -Cleanup"

При возникновении каких-либо проблем во время автоматического обнаружения временного диска вам может быть предложено выбрать диск (по умолчанию это диск D).

![ввод буквы диска](media/how-to-use-perfInsights/enter-drive.png)

Этот скрипт удаляет средства служебной программы и временные папки.

### <a name="troubleshooting-other-script-issues"></a>Устранение неполадок, связанных с запуском скриптов 

При возникновении проблем при выполнении скрипта нажмите CTRL+C, чтобы прервать его выполнение. Как удалить временные объекты см. в разделе "Очистка после аварийного завершения".

При возникновении сбоя скрипта даже после нескольких попыток рекомендуется запустить скрипт в режиме отладки с помощью параметра -Debug.

После возникновения сбоя скопируйте все выходные данные в консоли PowerShell и отправьте их представителю службы поддержки Майкрософт, который поможет устранить проблему.

### <a name="how-do-i-run-the-script-in-custom-configuration-mode"></a>Запуск скрипта в режиме настраиваемой конфигурации

Если выбрать **настраиваемую** конфигурацию, можно включить несколько трассировок в параллельном режиме (используйте клавишу SHIFT для множественного выбора).

![выбор сценариев](media/how-to-use-perfInsights/select-scenario.png)

При выборе диагностики производительности, трассировки счетчиков производительности, трассировки XPerf, сетевой трассировки или сценариев трассировки Storport следуйте инструкциям в диалоговых окнах и попробуйте воспроизвести проблему снижения производительности после начала трассировки.

Следующее диалоговое окно позволяет запустить трассировку.

![запуск трассировки](media/how-to-use-perfInsights/start-trace-message.png)

Чтобы остановить трассировку, необходимо подтвердить выполнение команды во втором диалоговом окне.

![stop-trace](media/how-to-use-perfInsights/stop-trace-message.png)
![stop-trace](media/how-to-use-perfInsights/ok-trace-message.png)

После завершения трассировок или операций создается новый файл в папке D:\\log\_collection (или на временном диске) с именем **CollectedData\_ГГГГ-ММ-ДД\_ЧЧ\_ММ\_ss.zip.** Этот файл можно отправить представителю службы поддержки для анализа.

## <a name="review-the-diagnostics-report-created-by-perfinsights"></a>Просмотр отчета PerfInsights о диагностике

В созданном PerfInsights файле **CollectedData\_ГГГГ-ММ-ДД\_ЧЧ\_ММ\_ss.zip** находится отчет в формате HTML с подробными сведениями о результате проверки PerfInsights. Чтобы просмотреть отчет, разверните файл **CollectedData\_ГГГГ-ММ-ДД\_ЧЧ\_ММ\_ss.zip**, а затем откройте файл **PerfInsights Report.html**.

Выберите вкладку **Результаты**.

![вкладка "Результаты"](media/how-to-use-perfInsights/findingtab.png)

**Примечания**

-   Сообщения, выделенные красным, представляют известные проблемы конфигурации, которые могут вызвать снижение производительности.

-   Сообщения, выделенные желтым цветом, обозначают предупреждения о том, что конфигурации не являются оптимальными, но необязательно вызывают проблемы с производительностью.

-   Сообщения, выделенные синим цветом, — это просто информативные инструкции.

Перейдите по HTTP-ссылкам всех сообщений об ошибках, выделенных красным цветом, чтобы получить более подробные сведения о найденных проблемах и их влиянии на производительность или рекомендации по оптимизации конфигурации для лучшей производительности.

### <a name="disk-configuration-tab"></a>Вкладка конфигурации дисков

В разделе **Обзор** отображаются различные представления конфигурации хранилища, включая сведения о служебной программе Diskpart и дисковых пространствах.

В разделах **DiskMap** и **VolumeMap** описаны два варианта связи между логическими томами и физическими дисками.

В перспективе физического диска (DiskMap) в таблице показаны все логические тома, которые размещены на диске. В следующем примере на PhysicalDrive2 размещены 2 логических тома, созданные на нескольких разделах (J и H):

![вкладка с данными](media/how-to-use-perfInsights/disktab.png)

В перспективе тома (*VolumeMap*) в таблицах показаны все физические диски в каждом логическом томе. Обратите внимание, что для RAID-массивов и динамических дисков можно разместить логический том на нескольких физических дисках. В следующем примере *C:\\mount* является точкой подключения, которая настроена в качестве *SpannedDisk* на физических дисках \#2 и \#3.

![вкладка томов](media/how-to-use-perfInsights/volumetab.png)

### <a name="sql-server-tab"></a>вкладка SQL Server

Если на целевой виртуальной машине размещаются экземпляры SQL Server, в отчете будет дополнительная вкладка, которая называется **SQL Server**.

![вкладка SQL](media/how-to-use-perfInsights/sqltab.png)

Этот раздел содержит вкладку "Обзор" и дополнительные вкладки для каждого экземпляра SQL Server, размещенного на виртуальной машине.

В разделе "Обзор" содержится полезная таблица, представляющая все работающие физические диски (системные и диски данных), которые содержат сочетание файлов данных и файлов журнала транзакций.

В следующем примере отображается *PhysicalDrive0* (на диске C), так как файлы *modeldev* и *modellog* находятся на диске C и относятся к различным типам (файл данных и журнал транзакций, соответственно).

![сведения журнала](media/how-to-use-perfInsights/loginfo.png)

На вкладках каждого экземпляра SQL Server содержится общий раздел, в котором отображаются основные сведения о выбранном экземпляре и разделы с дополнительными сведениями, включая параметры, конфигурации и параметры пользователя.

## <a name="references-to-the-external-tools-used"></a>Ссылки на внешние используемые средства

### <a name="diskspd"></a>Diskspd

DISKSPD — это генератор нагрузки хранилища и средство для проверки производительности групп разработки Windows, Windows Server и инфраструктуры облачного сервера. Дополнительные сведения можно найти по [этой ссылке](https://github.com/Microsoft/diskspd).

### <a name="xperf"></a>XPerf

XPerf является средством командной строки для записи сведений трассировок из набора средств оценки производительности Windows.

Дополнительные сведения см. в записи блога [Windows Performance Toolkit - Xperf](https://blogs.msdn.microsoft.com/ntdebugging/2008/04/03/windows-performance-toolkit-xperf/) (Набор средств оценки производительности Windows — XPerf).

## <a name="next-steps"></a>Дальнейшие действия

### <a name="upload-diagnostics-logs-and-reports-to-microsoft-support-for-further-review"></a>Отправка журналов диагностики и отчетов в службу поддержки Майкрософт для дальнейшего анализа

При работе со службой поддержки Майкрософт может потребоваться передать выходные данные, созданные PerfInsights, чтобы упростить процесс устранения неполадок.

Представитель службы поддержки создаст рабочую область DTM и вы получите сообщение электронной почты со ссылкой на портал DTM (https://filetransfer.support.microsoft.com/EFTClient/Account/Login.htm), а также идентификатор пользователя и пароль.

Это сообщение будет отправлено **службой автоматической диагностики CTS** (ctsadiag@microsoft.com).

![Пример сообщения](media/how-to-use-perfInsights/supportemail.png)

Для обеспечения дополнительной безопасности необходимо изменить пароль при первом использовании.

После входа в DTM появится диалоговое окно для отправки файла **CollectedData\_ГГГГ-ММ-ДД\_ЧЧ\_ММ\_ss.zip**, собранного PerfInsights.

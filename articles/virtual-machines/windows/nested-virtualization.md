---
title: "Включение вложенной виртуализации в виртуальных машинах Azure | Документация Майкрософт"
description: "Включение вложенной виртуализации в виртуальных машинах Azure."
services: virtual-machines-windows
documentationcenter: virtual-machines
author: philmea
manager: timlt
ms.author: philmea
ms.date: 10/09/2017
ms.topic: howto
ms.service: virtual-machines-windows
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure
ms.openlocfilehash: 180b87e18d98bb1e7ddefdcce09fc45d2fc26d0f
ms.sourcegitcommit: 79683e67911c3ab14bcae668f7551e57f3095425
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/25/2018
---
# <a name="how-to-enable-nested-virtualization-in-an-azure-vm"></a>Как включить вложенную виртуализацию в виртуальных машинах Azure

Вложенная виртуализация поддерживается в виртуальных машинах Azure серии Dv3 и Ev3. Эта возможность обеспечивает большую гибкость при поддержке сценариев, например в средах разработки, тестирования, обучения и демонстрации. 

В этой статье приведены шаги по включению вложенной виртуализации на виртуальной машине Azure и настройке подключения к Интернету в этой гостевой виртуальной машине.

## <a name="create-a-dv3-or-ev3-series-azure-vm"></a>Создание виртуальных машин Azure серии Dv3 или Ev3

Создайте виртуальную машину Azure с Windows Server 2016 и выберите размер из серии Dv3 или Ev3. Размер должен быть достаточно большим для поддержки требований гостевой виртуальной машины. В этом примере используется виртуальная машина Azure размера D3_v3. 

Просмотреть региональную доступность виртуальных машин серий Dv3 и Ev3 можно [здесь](https://azure.microsoft.com/regions/services/).

>[!NOTE]
>
>Подробные инструкции по созданию виртуальной машины см. в статье [Создание виртуальных машин Windows и управление ими с помощью модуля Azure PowerShell](https://docs.microsoft.com/azure/virtual-machines/windows/tutorial-manage-vm).
    
## <a name="connect-to-your-azure-vm"></a>Подключение к виртуальной машине Azure

Создайте подключение удаленного рабочего стола к виртуальной машине.

1. Нажмите кнопку **Подключиться** в свойствах виртуальной машины. Будет создан и скачан файл протокола удаленного рабочего стола (RDP-файл).

2. Чтобы подключиться к виртуальной машине, откройте скачанный RDP-файл. При появлении запроса нажмите кнопку **Подключиться**. На компьютере Mac вам понадобится клиент RDP, например [Remote Desktop Client](https://itunes.apple.com/us/app/microsoft-remote-desktop/id715768417?mt=12) из Mac App Store.

3. Введите имя пользователя и пароль, указанные при создании виртуальной машины, и нажмите кнопку **ОК**.

4. При входе в систему может появиться предупреждение о сертификате. Чтобы продолжить процесс подключения, нажмите кнопку **Да** или **Продолжить**.

## <a name="enable-the-hyper-v-feature-on-the-azure-vm"></a>Включение компонента Hyper-V на виртуальной машине Azure
Можно настроить эти параметры вручную или использовать предоставленный скрипт PowerShell, автоматизирующий настройку.

### <a name="option-1-use-a-powershell-script-to-configure-nested-virtualization"></a>Вариант 1. Использование скрипта PowerShell для настройки вложенной виртуализации
Скрипт PowerShell, который включает вложенную виртуализацию на узле Windows Server 2016, доступен на [GitHub](https://github.com/charlieding/Virtualization-Documentation/tree/live/hyperv-tools/Nested). Скрипт проверяет предварительные требования, а затем настраивает вложенную виртуализацию на виртуальной машине Azure. Для завершения настройки требуется перезагрузить виртуальную машину Azure. Этот скрипт может работать в других средах, однако это не гарантируется. Просмотрите запись блога Azure с видеодемонстрацией вложенной виртуализации, выполняемой в Azure! https://aka.ms/AzureNVblog.

### <a name="option-2-configure-nested-virtualization-manually"></a>Вариант 2. Настройка вложенной виртуализации вручную

1. На виртуальной машине Azure откройте PowerShell от имени администратора. 

2. Включите компонент Hyper-V и средства управления.

    ```powershell
    Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart
    ```

    >[!WARNING] 
    >
    >Эта команда перезапускает виртуальную машину Azure. Подключение RDP будет потеряно во время процесса перезагрузки.
    
3. После перезагрузки виртуальной машины Azure повторно подключитесь к виртуальной машине с помощью RDP.

## <a name="set-up-internet-connectivity-for-the-guest-virtual-machine"></a>Настройка подключения к Интернету для гостевой виртуальной машины
Создайте адаптер виртуальной сети для гостевой виртуальной машины и настройте шлюз NAT для подключения к Интернету.

### <a name="create-a-nat-virtual-network-switch"></a>Создание переключателя виртуальной сети NAT

1. На виртуальной машине Azure откройте PowerShell от имени администратора.
   
2. Создайте внутренний переключатель.

    ```powershell
    New-VMSwitch -Name "InternalNATSwitch" -SwitchType Internal
    ```

3. Просмотрите свойства переключателя и запишите параметр ifIndex для нового адаптера.

    ```powershell
    Get-NetAdapter
    ```

    ![NetAdapter](./media/virtual-machines-nested-virtualization/get-netadapter.png)

    >[!NOTE] 
    >
    >Запишите "ifIndex" виртуального переключателя, который был только что создан.
    
4. Создайте IP-адрес шлюза NAT.
    
Чтобы настроить шлюз, необходимы некоторые сведения о сети:    
  * IPAddress. IP-адрес шлюза NAT определяет адрес IPv4 или IPv6, используемый в качестве адреса шлюза по умолчанию для подсети виртуальной сети. Универсальный формат — a.b.c.1 (например, "192.168.0.1"). Хотя последняя позиция не обязательно равна ".1", однако обычно это так (на основе длины префикса). Обычно следует использовать адресное пространство для частной сети RFC 1918. 
  * PrefixLength. Длина префикса подсети определяет размер локальной подсети (маска подсети). Длина префикса подсети будет иметь целочисленное значение от 0 до 32. Значение 0 будет соответствовать всему Интернету, а 32 — разрешать только один сопоставленный IP-адрес. Обычный диапазон значений — от 24 до 12 в зависимости количества IP-адресов, которые необходимо подключить к NAT. Обычный PrefixLength равен 24. Это маска подсети 255.255.255.0.
  * InterfaceIndex. **ifIndex** — это индекс интерфейса виртуального переключателя, созданного на предыдущем шаге. 

    ```powershell
    New-NetIPAddress -IPAddress 192.168.0.1 -PrefixLength 24 -InterfaceIndex 13
    ```

### <a name="create-the-nat-network"></a>Создание сети NAT

Чтобы настроить шлюз, необходимо предоставить данные о сети и шлюзе NAT:
  * Name. Это имя сети NAT. 
  * InternalIPInterfaceAddressPrefix. Префикс подсети NAT описывает упомянутый выше IP-адрес шлюза NAT, а также длину префикса подсети NAT, описанную выше. Универсальный формат длины префикса подсети — a.b.c.0/NAT. 

Создайте сеть NAT в PowerShell.
```powershell
New-NetNat -Name "InternalNat" -InternalIPInterfaceAddressPrefix 192.168.0.0/24
```


## <a name="create-the-guest-virtual-machine"></a>Создание гостевой виртуальной машины

1. Откройте диспетчер Hyper-V и создайте виртуальную машину. Настройте виртуальную машину для использования созданной внутренней сети.
    
    ![NetworkConfig](./media/virtual-machines-nested-virtualization/configure-networking.png)
    
2. Установите операционную систему на гостевой виртуальной машине.
    
    >[!NOTE] 
    >
    >Вам потребуется установочный носитель для установки операционной системы на виртуальную машину. В этом случае используется Windows 10 Корпоративная.

## <a name="assign-an-ip-address-to-the-guest-virtual-machine"></a>Присвоение IP-адреса гостевой виртуальной машине

IP-адрес можно присвоить гостевой виртуальной машине, вручную установив статичный IP-адрес на ней или настроив DHCP на виртуальной машине Azure для динамического присвоения IP-адреса.

###  <a name="option-1-configure-dhcp-to-dynamically-assign-an-ip-address-to-the-guest-virtual-machine"></a>Вариант 1. Настройка DHCP для динамического присвоения IP-адреса для гостевой виртуальной машины
Выполните следующие действия, чтобы настроить DHCP на виртуальной машине узла для динамического присвоения адреса.

#### <a name="install-dchp-server-on-the-azure-vm"></a>Установка сервера DHCP на виртуальной машине Azure

1. Откройте диспетчер сервера. На панели мониторинга щелкните **Добавить роли и компоненты**. Откроется мастер добавления ролей и компонентов.
  
2. В мастере нажимайте кнопку **Далее**, пока не появится страница "Роли сервера".
  
3. Щелкните, чтобы установить флажок **DHCP-сервер**, а затем выберите **Добавить компоненты** и нажимайте кнопку **Далее** до завершения работы мастера.
  
4. Щелкните **Install**(Установить).

#### <a name="configure-a-new-dhcp-scope"></a>Настройка новой области DHCP

1. Откройте диспетчер DHCP.
  
2. В области навигации разверните имя сервера, щелкните правой кнопкой мыши **IPv4**, а затем щелкните **Создать область**. Когда откроется мастер создания области, нажмите кнопку **Далее**.
  
3. Введите имя и описание области и нажмите кнопку **Далее**.
  
4. Определите диапазон IP-адресов для сервера DCHP (например, от 192.168.0.100 до 192.168.0.200).
  
5. Нажимайте кнопку **Далее**, пока не появится страница шлюза по умолчанию. Введите IP-адрес, созданный ранее (например, 192.168.0.1) в качестве шлюза по умолчанию.
  
6. Нажимайте кнопку **Далее** до завершения работы мастера, оставляя все значения по умолчанию, а затем нажмите кнопку **Готово**.
    
### <a name="option-2-manually-set-a-static-ip-address-on-the-guest-virtual-machine"></a>Вариант 2. Настройка статического IP-адреса на гостевой виртуальной машине вручную
Если вы не настроили DHCP для динамического присвоения IP-адреса для гостевой виртуальной машины, выполните следующие шаги, чтобы установить статический IP-адрес.

1. На виртуальной машине Azure откройте PowerShell от имени администратора.

2. Щелкните правой кнопкой мыши гостевую виртуальную машину и выберите "Подключить".

3. Войдите на гостевую виртуальную машину.

4. На гостевой виртуальной машине откройте Центр управления сетями и общим доступом.

5. Настройте сетевой адаптер для адреса в диапазоне сети NAT, созданной в предыдущем разделе.

В этом примере будем использовать адрес в диапазоне 192.168.0.0/24.

## <a name="test-connectivity-in-guest-virtual-machine"></a>Проверка подключения на гостевой виртуальной машине

На гостевой виртуальной машине откройте браузер и перейдите на веб-страницу.
    ![GuestVM](./media/virtual-machines-nested-virtualization/guest-virtual-machine.png)

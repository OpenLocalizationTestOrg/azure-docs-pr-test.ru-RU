---
title: "aaaCreate прослушивателя группы доступности SQL Server в виртуальных машинах Azure | Документы Microsoft"
description: "Пошаговые инструкции по созданию прослушивателя для группы доступности AlwaysOn для SQL Server в службе виртуальных машин Azure."
services: virtual-machines
documentationcenter: na
author: MikeRayMSFT
manager: jhubbard
editor: monicar
ms.assetid: d1f291e9-9af2-41ba-9d29-9541e3adcfcf
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 05/01/2017
ms.author: mikeray
ms.openlocfilehash: c6a44dc5c7c18b572c2bf5772b4651b7210aacbd
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="configure-a-load-balancer-for-an-always-on-availability-group-in-azure"></a>Настройка подсистемы балансировки нагрузки для группы доступности AlwaysOn в Azure
В этой статье объясняется, как toocreate балансировки нагрузки для SQL Server Always On группы доступности в Azure виртуальных машинах, которые выполняются с помощью диспетчера ресурсов Azure. Группы доступности требуется подсистемы балансировки нагрузки для hello экземпляров SQL Server в виртуальных машинах Azure. Подсистема балансировки нагрузки Hello хранит hello IP-адрес для прослушивателя группы доступности hello. Если группа доступности распространяется на несколько регионов, для каждого из них нужен отдельный балансировщик.

toocomplete этой задачи необходимо toohave группы доступности SQL Server развернуты на виртуальных машинах Azure, выполняются с помощью диспетчера ресурсов. Обе виртуальные машины SQL Server должны принадлежать toohello одной группе доступности. Можно использовать hello [шаблона Microsoft](virtual-machines-windows-portal-sql-alwayson-availability-groups.md) tooautomatically Создание группы доступности hello в диспетчере ресурсов. Этот шаблон также автоматически создает внутреннюю подсистему балансировки нагрузки. 

При необходимости [группу доступности можно настроить вручную](virtual-machines-windows-portal-sql-alwayson-availability-groups-manual.md).

Здесь предполагается, что группы доступности уже настроены.  

Связанные разделы включают:

* [Введение в группы доступности AlwaysOn SQL Server на виртуальных машинах Azure](virtual-machines-windows-portal-sql-alwayson-availability-groups-manual.md)   
* [Настройка подключения между виртуальными сетями с помощью Azure Resource Manager и PowerShell](../../../vpn-gateway/vpn-gateway-vnet-vnet-rm-ps.md)

При рассмотрении в этой статье, создания и настройки балансировки нагрузки в hello портал Azure. После завершения процесса hello, настройке hello toouse hello IP-адрес кластера из hello балансировки нагрузки для прослушивателя группы доступности hello.

## <a name="create-and-configure-hello-load-balancer-in-hello-azure-portal"></a>Создание и Настройка балансировки нагрузки hello в hello портал Azure
В этой части задачу hello hello следующие:

1. В hello портал Azure создайте hello балансировки нагрузки и настроить hello IP-адрес.
2. Настройте пул hello серверной части.
3. Создайте пробу hello. 
4. Задайте правила подсистемы балансировки нагрузки hello.

> [!NOTE]
> Если экземпляры SQL Server hello в несколько групп ресурсов и регионах, все действия дважды, один раз в каждой группе ресурсов.
> 
> 

### <a name="step-1-create-hello-load-balancer-and-configure-hello-ip-address"></a>Шаг 1: Создание hello балансировки нагрузки и hello IP-адрес
Во-первых создайте hello подсистемы балансировки нагрузки. 

1. Hello портал Azure откройте hello группы ресурсов, содержащем виртуальные машины SQL Server hello. 

2. В группе ресурсов hello, нажмите кнопку **добавить**.

3. Поиск **подсистемы балансировки нагрузки** и выберите в результатах поиска hello, **подсистемы балансировки нагрузки**, который публикуется с **Microsoft**.

4. На hello **балансировки нагрузки** колонка, щелкните **создать**.

5. В hello **создать балансировки нагрузки** диалогового окна поле, настройте подсистемы балансировки нагрузки hello следующим образом:

   | Настройка | Значение |
   | --- | --- |
   | **Имя** |Текстовое имя, представляющее hello подсистемы балансировки нагрузки. Например, **sqlLB**. |
   | **Тип** |**Внутренняя**: большинство реализаций использовать внутреннюю подсистему балансировки нагрузки, позволяющая приложениям внутри hello одной группы доступности toohello tooconnect виртуальной сети.  </br> **Внешние**: позволяет группе доступности приложений tooconnect toohello через открытые подключение к Интернету. |
   | **Виртуальная сеть** |Выберите виртуальную сеть hello, принимаемые экземпляры SQL Server hello. |
   | **Подсеть** |Выберите подсеть hello, принадлежат hello экземпляры SQL Server. |
   | **Назначение IP-адресов** |**Статическое** |
   | **Частный IP-адрес** |Укажите IP-адрес доступен из подсети hello. Используйте этот IP-адрес при создании прослушивателя в кластере hello. В скрипте PowerShell далее в этой статье, можно использовать этот адрес для hello `$ILBIP` переменной. |
   | **Подписка** |Это поле может появиться, если у вас несколько подписок. Выберите подписку hello, что требуется tooassociate с этим ресурсом. Он является обычно Здравствуйте, той же подписке, как все ресурсы hello для группы доступности hello. |
   | **Группа ресурсов** |Выберите группу ресурсов hello, экземпляры SQL Server hello. |
   | **Расположение** |Выберите hello Azure hello экземпляры SQL Server находятся в расположении. |

6. Щелкните **Создать**. 

Azure создает hello подсистемы балансировки нагрузки. Подсистема балансировки нагрузки Hello принадлежит tooa конкретной сети, подсети, группы ресурсов и расположение. После завершения задачи hello Azure проверьте hello параметры подсистемы балансировки нагрузки в Azure. 

### <a name="step-2-configure-hello-back-end-pool"></a>Шаг 2: Настройка пула hello серверной части
Пул адресов серверной части hello Azure вызовы *внутренний пул*. В этом случае пул hello серверной части — адреса hello hello двух экземпляров SQL Server в группе доступности. 

1. В группе ресурсов щелкните hello подсистемы балансировки нагрузки, вы создали. 

2. В колонке **Параметры** щелкните **Серверные пулы**.

3. На **внутренние пулы**, нажмите кнопку **добавить** toocreate пул адресов серверной части. 

4. На **Добавление внутреннего пула**в разделе **имя**, введите имя для пула hello серверной части.

5. В разделе **Виртуальные машины** щелкните **Добавить виртуальную машину**. 

6. В разделе **выберите виртуальные машины**, нажмите кнопку **выберите группу доступности**, а затем укажите группу доступности hello, виртуальных машин SQL Server hello относятся к.

7. После выбора набора доступности hello щелкните **выберите виртуальные машины hello**, выберите hello две виртуальные машины, на которых размещены экземпляры SQL Server hello в группе доступности hello и нажмите кнопку **выберите**. 

8. Нажмите кнопку **ОК** tooclose hello колонок для **выберите виртуальные машины**, и **Добавление внутреннего пула**. 

Azure обновляет параметры hello hello пула адресов серверной части. Теперь в вашей группе доступности есть пул из двух экземпляров SQL Server.

### <a name="step-3-create-a-probe"></a>Шаг 3. Создание пробы
зонд Hello определяет, как Azure проверяет, что hello экземпляров SQL Server в данный момент принадлежит hello прослушивателя группы доступности. Azure зондами hello службы на основании hello IP-адрес, порт, определяются при создании пробы hello.

1. Подсистема балансировки нагрузки на hello **параметры** колонка, щелкните **зонды работоспособности**. 

2. На hello **зонды работоспособности** колонка, щелкните **добавить**.

3. Настройка проверки hello на hello **пробы добавить** колонку. Используйте hello после проверки hello tooconfigure значения:

   | Настройка | Значение |
   | --- | --- |
   | **Имя** |Текстовое имя, представляющее пробы hello. Например, **SQLAlwaysOnEndPointProbe**. |
   | **Протокол** |**TCP** |
   | **Порт** |Вы можете использовать любой доступный порт. Например, *59999*. |
   | **Интервал** |*5* |
   | **Пороговое значение сбоя** |*2* |

4.  Нажмите кнопку **ОК**. 

> [!NOTE]
> Убедитесь, что открыт порт hello, указываемые на брандмауэре hello обоих экземпляров SQL Server. Оба экземпляра требуют входящее правило для hello TCP-порт, который можно использовать. Дополнительные сведения см. в статье [Добавление и изменение правила брандмауэра](http://technet.microsoft.com/library/cc753558.aspx). 
> 
> 

Azure создает Проба hello и использует его tootest, какой экземпляр SQL Server имеет hello прослушиватель для группы доступности hello.

### <a name="step-4-set-hello-load-balancing-rules"></a>Шаг 4: Настройка правил балансировки нагрузки, hello
правила балансировки нагрузки Hello настроить как hello балансировки нагрузки направляет трафик экземпляров SQL Server toohello. Для этой подсистемы балансировки нагрузки включен прямой возврат сервера так, как только один из двух экземпляров SQL Server hello принадлежит ресурс прослушивателя группы доступности hello одновременно.

1. Подсистема балансировки нагрузки на hello **параметры** колонке нажмите кнопку **правила подсистемы балансировки нагрузки**. 

2. На hello **правила подсистемы балансировки нагрузки** колонка, щелкните **добавить**.

3. На hello **правила подсистемы балансировки нагрузки добавить** колонки, настройте правило балансировки нагрузки hello. Используйте hello следующие параметры: 

   | Настройка | Значение |
   | --- | --- |
   | **Имя** |Текстовое имя, представляющее правила подсистемы балансировки нагрузки hello. Например, **SQLAlwaysOnEndPointListener**. |
   | **Протокол** |**TCP** |
   | **Порт** |*1433* |
   | **Серверный порт** |*1433*. Это значение игнорируется, поскольку правило использует **плавающий IP-адрес (прямой ответ от сервера)**. |
   | **Проба** |Используйте имя hello hello пробы, созданный для этой подсистемы балансировки нагрузки. |
   | **Сохранение сеанса** |**None** |
   | **Время ожидания простоя (в минутах)** |*4* |
   | **Плавающий IP-адрес (прямой ответ от сервера)** |**Включено** |

   > [!NOTE]
   > Может потребоваться tooscroll вниз колонку tooview hello все параметры hello.
   > 

4. Нажмите кнопку **ОК**. 
5. Azure настраивает правила балансировки нагрузки hello. Теперь подсистемы балансировки нагрузки hello — экземпляр SQL Server toohello трафика настроенных tooroute, на котором размещена hello прослушиватель для группы доступности hello. 

В этот момент hello группа ресурсов содержит подсистемы балансировки нагрузки, соединяющей tooboth машины SQL Server. Hello балансировки нагрузки также содержит IP-адрес для hello SQL Server Always On прослушивателя группы доступности, поэтому любой компьютер может отвечать toorequests для групп доступности hello.

> [!NOTE]
> Если экземпляры SQL Server находятся в двух разных регионах, повторите шаги hello hello другой области. Балансировщик нагрузки необходим для каждого региона. 
> 
> 

## <a name="configure-hello-cluster-toouse-hello-load-balancer-ip-address"></a>Настройка hello кластера toouse hello подсистемы балансировки нагрузки IP-адреса
Hello следующим шагом является прослушивателем hello tooconfigure на кластере hello и перевод hello прослушивателя в оперативный режим. Здравствуйте, следующие: 

1. Создайте hello прослушивателя группы доступности в отказоустойчивом кластере hello. 

2. Перевод прослушивателя hello в оперативный режим.

### <a name="step-5-create-hello-availability-group-listener-on-hello-failover-cluster"></a>Шаг 5: Создание hello прослушивателя группы доступности в отказоустойчивом кластере hello
На этом шаге вы вручную создать прослушиватель группы доступности hello в Диспетчер отказоустойчивости кластеров и SQL Server Management Studio.

[!INCLUDE [ag-listener-configure](../../../../includes/virtual-machines-ag-listener-configure.md)]

### <a name="verify-hello-configuration-of-hello-listener"></a>Проверка конфигурации hello hello прослушивателя

Ресурсы кластера hello и зависимости настроены правильно, следует прослушиватель может tooview hello в SQL Server Management Studio. tooset Здравствуйте порта прослушивателя, hello следующие:

1. Запустите SQL Server Management Studio и подключитесь toohello первичной реплики.

2. Go слишком**высокий уровень доступности AlwaysOn** > **группы доступности** > **прослушиватели группы доступности**.  
    Теперь вы увидите имя прослушивателя hello, созданный в диспетчере отказоустойчивости кластеров. 

3. Щелкните правой кнопкой мыши имя прослушивателя hello и нажмите кнопку **свойства**.

4. В hello **порт** укажите hello номер порта для прослушивателя группы доступности hello $EndpointPort ранее с помощью hello (по умолчанию hello — 1433), а затем нажмите кнопку **ОК**.

Теперь у вас есть группа доступности на виртуальных машинах Azure, работающих в режиме Resource Manager. 

## <a name="test-hello-connection-toohello-listener"></a>Подключение toohello теста hello прослушивателя
Проверка соединения hello, выполнив hello ниже:

1. Экземпляр SQL Server tooa протокола удаленного рабочего СТОЛА, hello виртуальных сетевых, но не собственные hello реплики. Этот сервер можно hello другой экземпляр SQL Server в кластере hello.

2. Используйте **sqlcmd** программа tootest hello соединения. Например, следующий скрипт hello устанавливает **sqlcmd** toohello первичной подключения через прослушиватель hello с проверкой подлинности Windows:
   
        sqlcmd -S <listenerName> -E

Hello SQLCMD подключения автоматически подключается toohello экземпляр SQL Server, на котором размещена первичная реплика hello. 

## <a name="create-an-ip-address-for-an-additional-availability-group"></a>Создание IP-адреса для дополнительной группы доступности

Каждая группа доступности использует отдельный прослушиватель. У каждого прослушивателя имеется собственный IP-адрес. Используйте hello же загрузить балансировки toohold hello IP-адрес для дополнительных прослушивателей. После создания группы доступности, добавления подсистемы балансировки нагрузки toohello hello IP адрес, а затем настройте прослушиватель hello.

tooadd IP адрес tooa подсистемы балансировки нагрузки с портала Azure hello hello следующие:

1. В hello портал Azure откройте группу ресурсов hello, содержит подсистему балансировки нагрузки hello и нажмите кнопку hello подсистемы балансировки нагрузки. 

2. В разделе **Параметры** щелкните **Пул внешних IP-адресов**, а затем щелкните **Добавить**. 

3. В разделе **добавить IP-адрес внешнего интерфейса**, укажите имя для hello переднего плана. 

4. Убедитесь, что hello **виртуальная сеть** и hello **подсети** являются hello так же, как hello экземпляров SQL Server.

5. Задать hello IP-адрес для прослушивателя hello. 
   
   >[!TIP]
   >Можно задать hello IP адрес toostatic и введите адрес, который в настоящее время не используется в подсети hello. Кроме того можно задать hello IP адрес toodynamic и сохранить hello нового интерфейса пула IP-адресов. При этом hello портал Azure автоматически назначает доступные toohello пул IP-адресов. Затем можно повторно открыть пул hello интерфейсный IP-адресов и изменить назначения toostatic hello. 

6. Сохраните hello IP-адрес для прослушивателя hello. 

7. Добавьте проверку работоспособности с помощью hello следующие параметры:

   |Настройка |Значение
   |:-----|:----
   |**Имя** |Имя зонда hello tooidentify.
   |**Протокол** |TCP
   |**Порт** |Неиспользуемый TCP-порт, который должен быть доступен для всех виртуальных машин. Он не должен использоваться для других целей. Нет двух прослушивателей можно использовать hello же порта пробы. 
   |**Интервал** |промежуток времени между пробы Hello попыток. Используйте по умолчанию hello (5).
   |**Пороговое значение сбоя** |Количество последовательных пороговых значений, которые должно не выполняться виртуальной машины будет считаться неработоспособной Hello.

8. Нажмите кнопку **ОК** toosave hello пробы. 

9. Создайте правило балансировки нагрузки. Выберите **Правила балансировки нагрузки**, затем щелкните **Добавить**.

10. Настройка hello новый балансировки нагрузки правила с помощью hello следующие параметры:

   |Настройка |Значение
   |:-----|:----
   |**Имя** |Имя tooidentify hello нагрузки правила балансировки. 
   |**Frontend IP address** (Интерфейсный IP-адрес) |Выберите hello IP-адрес, созданный. 
   |**Протокол** |TCP
   |**Порт** |Используйте порт hello, в которых используется hello экземпляров SQL Server. Экземпляр по умолчанию использует порт 1433, если только вы не изменили его. 
   |**Внутренний порт** |Используйте hello совпадает со значением в **порт**.
   |**Внутренний пул** |Hello пула, содержащего виртуальные машины hello hello экземплярами SQL Server. 
   |**Зонд работоспособности** |Выберите hello пробы, созданный.
   |**Сохранение сеанса** |None
   |**Время ожидания простоя (в минутах)** |Оставьте значение по умолчанию (4).
   |**Плавающий IP-адрес (прямой ответ от сервера)** | Включено

### <a name="configure-hello-availability-group-toouse-hello-new-ip-address"></a>Настройка hello доступности группы toouse hello новый IP-адрес

toofinish настройка кластера hello hello повторите шаги при внесении hello первой группы доступности. То есть, настройте hello [toouse hello новый IP-адрес кластера](#configure-the-cluster-to-use-the-load-balancer-ip-address). 

После добавления IP-адрес для прослушивателя hello, настройте hello повышенную доступность группы, выполнив следующие hello: 

1. Убедитесь, что порт пробы hello для нового IP-адреса hello открыт на обеих виртуальных машин SQL Server. 

2. [В диспетчере кластера добавьте точку доступа клиента hello](#addcap).

3. [Настройка hello IP-ресурс для группы доступности hello](#congroup).

   >[!IMPORTANT]
   >При создании hello IP-адрес, используйте hello IP-адрес, что вы добавили toohello подсистемы балансировки нагрузки.  

4. [Сделать зависимым от точки доступа клиента hello ресурс группы доступности SQL Server hello](#dependencyGroup).

5. [Сделать hello клиентского доступа точки ресурса, зависящее от hello IP-адрес](#listname).
 
6. [Задайте параметры кластера hello в PowerShell](#setparam).

После настройки hello доступности группы toouse hello новый IP-адрес, настройте прослушиватель toohello hello соединения. 

## <a name="next-steps"></a>Дальнейшие действия

- [Настройка группы доступности AlwaysOn на виртуальных машинах Azure в разных регионах](virtual-machines-windows-portal-sql-availability-group-dr.md)

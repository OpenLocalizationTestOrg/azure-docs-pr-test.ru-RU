---
title: "aaaPerformance советы и рекомендации по SQL Server в Azure | Документы Microsoft"
description: "Содержит рекомендации по оптимизации производительности SQL Server в виртуальных машинах Microsoft Azure."
services: virtual-machines-windows
documentationcenter: na
author: rothja
manager: jhubbard
editor: 
tags: azure-service-management
ms.assetid: a0c85092-2113-4982-b73a-4e80160bac36
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 06/27/2017
ms.author: jroth
ms.openlocfilehash: 42ec9fbeb2dec3a654b93bbd08d666369835ee73
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="performance-best-practices-for-sql-server-in-azure-virtual-machines"></a>Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure

## <a name="overview"></a>Обзор

В этом разделе приведены рекомендации по оптимизации производительности SQL Server в виртуальной машине Microsoft Azure. Во время работы SQL Server в виртуальных машинах Azure, рекомендуется продолжать использовать hello же параметров производительности базы данных, применимых tooSQL сервер в локальной среде. Однако производительность hello реляционной базы данных в общедоступном облаке зависит от многих факторов, таких как hello размер виртуальной машины и конфигурации hello hello дисков данных.

При создании образов SQL Server [рассмотрим, подготовки виртуальных машин в Azure portal hello](virtual-machines-windows-portal-sql-server-provision.md). Виртуальные машины SQL Server, подготовленный в hello портала с помощью диспетчера ресурсов реализовывать все эти рекомендации, включая настройку хранилища hello.

В этой статье основное внимание уделено начало hello *наиболее* производительности для SQL Server на виртуальных машинах Azure. Если рабочая нагрузка не так велика, могут потребоваться не все перечисленные ниже оптимизации. При оценке этих рекомендаций учитывайте актуальные потребности в производительности и характер рабочих нагрузок.

[!INCLUDE [learn-about-deployment-models](../../../../includes/learn-about-deployment-models-both-include.md)]

## <a name="quick-check-list"></a>Краткий контрольный список

Hello ниже приведен краткий контрольный список для обеспечения оптимальной производительности SQL Server на виртуальных машинах Azure:

| Область | Оптимизация |
| --- | --- |
| [Размер виртуальной машины](#vm-size-guidance) |[DS3](../../virtual-machines-windows-sizes-memory.md) или выше для выпуска SQL Enterprise.<br/><br/>[DS2](../../virtual-machines-windows-sizes-memory.md) или выше для выпусков SQL Standard и Web Edition. |
| [Хранилище](#storage-guidance) |Используйте [хранилище класса Premium](../../../storage/common/storage-premium-storage.md). Стандартное хранилище рекомендуется использовать только для разработки и тестирования.<br/><br/>Сохранить hello [учетной записи хранилища](../../../storage/common/storage-create-storage-account.md) и VM SQL Server в hello одного региона.<br/><br/>Отключить Azure [географически избыточное хранилище](../../../storage/common/storage-redundancy.md) (георепликация) в учетной записи хранения hello. |
| [диски;](#disks-guidance) |Используйте как минимум 2 [диска P30](../../../storage/common/storage-premium-storage.md#scalability-and-performance-targets) (1 для файлов журнала, 1 для файлов данных и TempDB).<br/><br/>Избегайте использования дисков операционной системы или временных дисков для хранения базы данных или журналов.<br/><br/>Включите кэширование чтения на дисках hello, размещение файлов данных hello и TempDB.<br/><br/>Не включайте кэширование на дисках, размещение файла журнала hello.<br/><br/>Внимание: Остановка службы SQL Server hello, при изменении параметров кэша hello для диска виртуальной Машины Azure.<br/><br/>Чередовать несколько производительности ввода-ВЫВОДА tooget увеличить диски данных Azure.<br/><br/>Выполняйте форматирование с использованием задокументированных размеров кластеров. |
| [ВВОД-ВЫВОД](#io-guidance) |Включите сжатие страниц базы данных.<br/><br/>Включите быструю инициализацию для файлов данных.<br/><br/>Ограничить или отключить авторасширение базы данных hello.<br/><br/>Отключите Автосжатие hello базы данных.<br/><br/>Переместите все диски toodata баз данных, включая системные базы данных.<br/><br/>Перемещение SQL Server ошибка журнала и трассировки файла каталоги toodata дисков.<br/><br/>Настройка расположений по умолчанию для файлов резервных копий и базы данных.<br/><br/>Включите заблокированные страницы.<br/><br/>Примените исправления производительности SQL Server. |
| [Зависит от определенных функций](#feature-specific-guidance) |Резервное копирование непосредственно tooblob хранилища. |

Дополнительные сведения о *как* и *почему* toomake эти оптимизации см. в статье hello сведения и рекомендации, приведенные в следующих разделах.

## <a name="vm-size-guidance"></a>Рекомендации по выбору размеров виртуальных машин

Для уязвимых приложений производительности, рекомендуется использовать следующие hello [размеры виртуальных машин](../sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json):

* **Выпуск SQL Server Enterprise**: DS3 или выше
* **Выпуски SQL Server Standard и Web**: DS2 или выше

## <a name="storage-guidance"></a>Рекомендации по выбору хранилища

Виртуальные машины серий DS, DSv2 и GS поддерживают [хранилище класса Premium](../../../storage/common/storage-premium-storage.md). Для всех производственных рабочих нагрузок рекомендуется хранилище класса Premium.

> [!WARNING]
> Стандартное хранилище характеризуется различными задержками и пропускной способностью и рекомендуется только для рабочих нагрузок по разработке и тестированию. Для производственных рабочих нагрузок необходимо использовать хранилище класса Premium.

Кроме того, рекомендуется создать учетную запись хранения Azure в hello одного центра обработки данных, как в SQL Server виртуальной машины tooreduce задержки при передаче. При создании учетной записи хранения отключите георепликацию, поскольку согласованный порядок записи на несколько дисков не гарантируется. Вместо этого рекомендуется реализовать средства аварийного восстановления SQL Server между двумя центрами обработки данных Azure. Дополнительные сведения см. в статье [Высокий уровень доступности и аварийное восстановление для SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-high-availability-dr.md).

## <a name="disks-guidance"></a>Рекомендации по использованию дисков

Виртуальная машина Azure поддерживает три основных типа дисков:

* **Диск ОС**: при создании виртуальной машины Azure hello платформа подключает к ней по крайней мере один диск (с меткой hello **C** диска) toohello виртуальной Машины для диска операционной системы. Этот диск представляет собой VHD-файл, сохраненный как страничный BLOB-объект в хранилище.
* **Временный диск**: виртуальные машины Azure содержит другой диск, называемый hello временный диск (с меткой hello **D**: диск). Это диск на узле hello, который может использоваться для области временных файлов.
* **Диски с данными**: как диски данных можно также присоединить дополнительные диски tooyour виртуальной машины, и они будут храниться в хранилище как страничные большие двоичные объекты.

Hello следующих разделах описаны рекомендации по использованию этих разных дисках.

### <a name="operating-system-disk"></a>Диск операционной системы

Диск операционной системы — это виртуальный жесткий диск, который можно установить и использовать как диск с установленной операционной системой, данный диск имеет метку **C:** .

По умолчанию политика кэширования на диске операционной системы hello — **чтения и записи**. Для уязвимых приложений производительности рекомендуется использовать диски данных вместо диска операционной системы hello. В разделе hello на дисках данных ниже.

### <a name="temporary-disk"></a>Временный диск

Здравствуйте, диск временного хранилища, обозначенный как hello **D**: диска, не сохраненные tooAzure хранилища больших двоичных объектов. Не храните файлы базы данных пользователя или пользователя файлы журнала транзакций на hello **D**: диск.

Для серии D, серии Dv2 и виртуальные машины серии G hello временный диск на этих виртуальных машин на основе SSD. Если рабочая нагрузка активно использует базы данных tempdb (например, для временных объектов или сложные соединения), хранение базы данных TempDB на hello **D** диск может привести к более высокую пропускную способность базы данных TempDB и более низкая задержка базы данных TempDB.

Для виртуальных машин (серии D, Dv2 и G), которые поддерживают хранилище класса Premium, рекомендуется хранить базу данных TempDB на диске, поддерживающем хранилище класса Premium, с включенным кэшированием чтения. Имеется одна рекомендация toothis исключение; Если использование базы данных TempDB много записи, можно добиться более высокой производительности путем сохранения базы данных TempDB на локальных hello **D** диск, который также на основе SSD на этих машинах размера.

### <a name="data-disks"></a>Диски данных

* **Использовать диски данных для файлов данных и журналов**: как минимум, использование 2 хранилища Premium [P30 дисков](../../../storage/common/storage-premium-storage.md#scalability-and-performance-targets) где один диск содержит файлы журнала hello, а другие hello hello данные и файлы базы данных TempDB. Каждый диск хранилища Premium предоставляет ряд операций ввода-вывода и пропускную способность (МБ/с) в зависимости от его размера, как описано в следующей статьей hello: [с помощью хранилища Premium для дисков](../../../storage/common/storage-premium-storage.md).

* **Чередование дисков**: для повышения пропускной способности можно добавить дополнительные диски данных и использовать чередование дисков. toodetermine hello число дисков данных, необходимо tooanalyze hello число операций ввода-ВЫВОДА и пропускной способности, необходимой для ваших файлов журнала, а для данных и файлов базы данных TempDB. Обратите внимание, что различные размеры виртуальной Машины различные ограничения на число операций ввода-вывода и пропускной способности поддерживается hello см. в разделе hello таблиц на значениях IOP для [размер виртуальной Машины](../sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json). Hello используйте следующие рекомендации:

  * Windows 8 и Windows Server 2012 или более поздней версии, используйте [дисковых пространств](https://technet.microsoft.com/library/hh831739.aspx) с hello, следование правилам:

      1. Набор hello чередовать (размер чередования) too64 КБ (65 536 байт) для рабочих нагрузок OLTP и 256 КБ (262144 байт) для хранения влияет на производительность рабочих нагрузок tooavoid из-за toopartition Рассогласование данных. Это следует сделать в PowerShell.
      1. Задайте число столбцов равным количеству физических дисков. Используйте PowerShell (не пользовательский интерфейс диспетчера сервера) при настройке более 8 дисков. 

    Например, следующая PowerShell hello создает новый пул носителей с hello чередовать размер too64 КБ и hello число too2 столбцы:

    ```powershell
    $PoolCount = Get-PhysicalDisk -CanPool $True
    $PhysicalDisks = Get-PhysicalDisk | Where-Object {$_.FriendlyName -like "*2" -or $_.FriendlyName -like "*3"}

    New-StoragePool -FriendlyName "DataFiles" -StorageSubsystemFriendlyName "Storage Spaces*" -PhysicalDisks $PhysicalDisks | New-VirtualDisk -FriendlyName "DataFiles" -Interleave 65536 -NumberOfColumns 2 -ResiliencySettingName simple –UseMaximumSize |Initialize-Disk -PartitionStyle GPT -PassThru |New-Partition -AssignDriveLetter -UseMaximumSize |Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataDisks" -AllocationUnitSize 65536 -Confirm:$false 
    ```

  * Для Windows 2008 R2 или более ранней версии можно воспользоваться динамическими дисками (чередующимися томами операционной системы) и размер чередования hello всегда составляет 64 КБ. Обратите внимание, что эта возможность не поддерживается в Windows 8 и Windows Server 2012. Сведения см. заявление о поддержке hello в [службу виртуальных дисков находится в состоянии перехода tooWindows API управления хранилищами](https://msdn.microsoft.com/library/windows/desktop/hh848071.aspx).

  * Если рабочая нагрузка не слишком активно использует функции ведения журнала и не требует выделенного числа операций ввода-вывода в секунду, можно настроить только один пул носителей. В противном случае можно создайте два пула носителей, один для файлов журнала hello и другим пулом носителей для файлов данных hello и TempDB. Определите hello количество дисков, связанных с каждого пула носителей, в зависимости от нагрузки ожиданиям. Помните, что в разных размерах виртуальной машины можно подключать различное число дисков данных. Дополнительные сведения см. в статье [Размеры виртуальных машин в Azure](../sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

  * Если вы не используете хранилище Premium (сценариев разработки и тестирования), hello рекомендуется tooadd hello максимальное число дисков данных, поддерживаемых вашей [размер виртуальной Машины](../sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) и используйте чередование дисков.

* **Политика кэширования**: дисков с данными для хранения Premium кэширование чтения на дисках данных hello только размещение файлов данных и базы данных TempDB. Если хранилище класса Premium не используется, не включайте кэширование ни для каких дисков данных. Инструкции по настройке кэширования диска, см. в разделе hello следующие вопросы: [Set-AzureOSDisk](https://msdn.microsoft.com/library/azure/jj152847) и [Set-AzureDataDisk](https://msdn.microsoft.com/library/azure/jj152851.aspx).

  > [!WARNING]
  > Остановка службы SQL Server hello, при изменении параметра кэша hello дисков виртуальной Машины Azure tooavoid вероятность hello повреждений базы данных.

* **Размер единицы размещения NTFS**: при форматировании диска данных hello, рекомендуется использовать размер 64 КБ для файлов данных и журналов, а также базы данных TempDB.

* **Диск рекомендаций по управлению**: при удалении диска данных или изменения своего кэша типа, остановка службы SQL Server hello во время изменения hello. При наличии параметров кэширования hello изменен на диске ОС hello Azure останавливает hello виртуальной Машины, изменяется тип кэша hello и перезапускает hello виртуальной Машины. При изменении параметров кэша hello диска данных виртуальной Машины hello не остановлен, но отсоединен от hello виртуальной Машины во время hello, изменить, а затем снова присоединить диск данных hello.

  > [!WARNING]
  > Hello toostop сбой службы SQL Server во время таких операций могут привести к повреждению базы данных.

## <a name="io-guidance"></a>Рекомендации по использованию операций ввода-вывода

* Hello наилучший результат при использовании хранилища Premium достигается при параллелизации приложений и запросов. Хранилище Premium предназначена для сценариев, где hello глубина очереди ввода-ВЫВОДА больше 1, поэтому она почти или совсем не выигрыш в производительности для однопоточных последовательных запросов (даже если они являются большим объемом хранилища). Например это могло повлиять на результаты теста, однопоточных hello средств анализа производительности, такие как SQLIO.

* Рекомендуется использовать [сжатие страниц базы данных](https://msdn.microsoft.com/library/cc280449.aspx) , так как это позволяет повысить производительность рабочих нагрузок с большим объемом операций ввода-вывода. Однако сжатие данных hello может увеличить hello потребление ресурсов ЦП на сервере базы данных hello.

* Рассмотрите возможность включения hello Мгновенная инициализация tooreduce время, необходимое для начального выделения файлов. преимущества tootake быстрой инициализацией файлов, предоставьте учетной записи службы SQL Server (MSSQLSERVER) hello с SE_MANAGE_VOLUME_NAME и добавить его toohello **выполнение задач обслуживания тома** политики безопасности. Если вы используете образ платформы SQL Server для Azure, учетная запись службы по умолчанию hello (NT Service\MSSQLSERVER) не добавляется toohello **выполнение задач обслуживания тома** политики безопасности. Другими словами, быстрая инициализация файлов в образе платформы SQL Server Azure не включена. После добавления toohello учетной записи службы SQL Server hello **выполнение задач обслуживания тома** политику безопасности, перезапуск службы SQL Server hello. Использование этой функции может быть показано из соображений безопасности. Дополнительные сведения см. в статье [Мгновенная инициализация файлов базы данных](https://msdn.microsoft.com/library/ms175935.aspx).

* **автоматическое увеличение** считается toobe лишь предупредительной мерой на случай непредвиденного роста. Не используйте авторасширение для повседневного управления ростом данных и журналов. Если используется авторасширение, предварительно увеличьте размер файла hello, с помощью переключателя размер hello.

* Убедитесь, что **autoshrink** — отключено tooavoid ненужных затрат, которые могут отрицательно повлиять на производительность.

* Переместите все диски toodata баз данных, включая системные базы данных. Дополнительные сведения см. в статье [Перемещение системных баз данных](https://msdn.microsoft.com/library/ms345408.aspx).

* Перемещение SQL Server ошибка журнала и трассировки файла каталоги toodata дисков. Для этого в диспетчере конфигурации SQL Server щелкните правой кнопкой мыши свой экземпляр SQL Server и выберите пункт "Свойства". Hello ошибка параметры файла журнала и трассировки можно изменить в hello **параметры запуска** вкладку hello в hello указан каталог дампа **Дополнительно** вкладку hello следующий снимок экрана показано, где toolook для параметр запуска журнала ошибок Hello.

    ![Снимок экрана SQL ErrorLog](./media/virtual-machines-windows-sql-performance/sql_server_error_log_location.png)

* Настройка расположений по умолчанию для файлов резервных копий и базы данных. Используйте hello рекомендации в этом разделе и внесите изменения hello в окне свойств сервера hello. Инструкции см. в разделе [hello Просмотр или изменение расположения по умолчанию для файлов данных и журналов (SQL Server Management Studio)](https://msdn.microsoft.com/library/dd206993.aspx). Hello следующем снимке экрана показано, как toomake эти изменения.

    ![Файлы журнала данных SQL и резервных копий](./media/virtual-machines-windows-sql-performance/sql_server_default_data_log_backup_locations.png)
* Включить блокировки страниц tooreduce операции ввода-ВЫВОДА, а также все действия разбиения на страницы. Дополнительные сведения см. в разделе [включить hello блокировка страниц в памяти (Windows)](https://msdn.microsoft.com/library/ms190730.aspx).

* Если вы используете SQL Server 2012, установите накопительный пакет обновления 10 для пакета обновления 1. Это обновление содержит исправление hello низкой производительности ввода-вывода при выборке во временные таблицы в SQL Server 2012. Дополнительные сведения см. в этой [статье базы знаний](http://support.microsoft.com/kb/2958012).

* Рекомендуется сжимать файлы данных при их передаче в среду Azure и из нее.

## <a name="feature-specific-guidance"></a>Рекомендации по использованию определенных функций 

Для некоторых развертываний получить дополнительные преимущества, используя более сложные методики настройки. Hello следующем списке перечислены некоторые функции SQL Server, которые могут помочь повысить производительность tooachieve:

* **Создать резервную копию хранилища tooAzure**: при выполнении резервного копирования для SQL Server на виртуальных машинах Azure, можно использовать [tooURL резервного копирования SQL Server](https://msdn.microsoft.com/library/dn435916.aspx). Эта функция доступна начиная с SQL Server 2012 SP1 CU2 и рекомендуется для резервного копирования toohello присоединенные диски с данными. Когда вы резервного копирования и восстановления из хранилища Azure, выполните hello рекомендации, приведенные в [резервного копирования SQL Server tooURL рекомендации и устранение неполадок и восстановлении из резервных копий в хранилище Azure](https://msdn.microsoft.com/library/jj919149.aspx). Кроме того, можно автоматизировать эти процессы архивации с помощью [автоматической архивации SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-automated-backup.md).

    Предыдущий tooSQL Server 2012, можно использовать [tooAzure резервного копирования SQL Server средство](https://www.microsoft.com/download/details.aspx?id=40740). Это средство может помочь tooincrease пропускная способность резервного копирования с использованием нескольких чередующихся целей резервного копирования.

* **Файлы данных SQL Server в Azure**: эта новая функция [Файлы данных SQL Server в Azure](https://msdn.microsoft.com/library/dn385720.aspx)доступна, начиная с SQL Server 2014. Выполнение SQL Server с файлами данных в Azure демонстрирует уровень производительности, сравнимый с использованием дисков данных Azure.

## <a name="next-steps"></a>Дальнейшие действия

Рекомендации по безопасности см. в статье [Вопросы безопасности SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-security.md).

Просмотрите другие разделы, посвященные виртуальным машинам SQL Server, в статье [Приступая к работе с SQL Server в виртуальных машинах Azure](virtual-machines-windows-sql-server-iaas-overview.md).

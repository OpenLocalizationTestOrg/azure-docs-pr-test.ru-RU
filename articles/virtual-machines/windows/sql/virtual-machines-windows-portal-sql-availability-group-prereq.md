---
title: "Группирует aaaSQL доступность сервера - виртуальных машинах Azure — обязательные требования | Документы Microsoft"
description: "В этом учебнике показано, как группировать условия hello tooconfigure создания доступности AlwaysOn в SQL Server на виртуальных машинах Azure."
services: virtual-machines
documentationCenter: na
authors: MikeRayMSFT
manager: jhubbard
editor: monicar
tags: azure-service-management
ms.assetid: c492db4c-3faa-4645-849f-5a1a663be55a
ms.service: virtual-machines-sql
ms.devlang: na
ms.custom: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 05/09/2017
ms.author: mikeray
ms.openlocfilehash: eed0729ead25c7793bb17a04cd7fd996c7dc8c9d
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="complete-hello-prerequisites-for-creating-always-on-availability-groups-on-azure-virtual-machines"></a>Выполните hello предварительные требования для создания групп доступности AlwaysOn на виртуальных машинах Azure

В этом учебнике показано, как toocomplete hello предварительные условия для создания [SQL Server группы доступности AlwaysOn на виртуальных машинах (ВМ) Azure](virtual-machines-windows-portal-sql-availability-group-tutorial.md). После завершения необходимых компонентов hello имеется контроллер домена, две виртуальные машины SQL Server и следящего сервера в единой группы ресурсов.

**Примерное время**: может занять несколько часов предварительные требования toocomplete hello. Большая часть времени уходит на создание виртуальных машин.

Hello следующей схеме показано построение hello учебника.

![Группа доступности](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/00-EndstateSampleNoELB.png)

## <a name="review-availability-group-documentation"></a>Обзор документации по группам доступности

В этом руководстве предполагается, что у вас имеется базовое представление о группах доступности AlwaysOn SQL Server. Если же данная технология вам незнакома, изучите статью [Обзор групп доступности AlwaysOn (SQL Server)](http://msdn.microsoft.com/library/ff877884.aspx).


## <a name="create-an-azure-account"></a>Создание учетной записи Azure
Вам понадобится учетная запись Azure. Вы можете [создать бесплатную учетную запись Azure](/pricing/free-trial/?WT.mc_id=A261C142F) или [активировать преимущества для подписчиков Visual Studio](/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A261C142F).

## <a name="create-a-resource-group"></a>Создание группы ресурсов
1. Войдите в toohello [портал Azure](http://portal.azure.com).
2. Нажмите кнопку  **+**  toocreate объекта hello портала.

   ![Новый объект](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/01-portalplus.png)

3. Тип **группы ресурсов** в hello **Marketplace** окно поиска.

   ![Группа ресурсов](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/01-resourcegroupsymbol.png)
4. Щелкните **Группа ресурсов**.
5. Щелкните **Создать**.
6. На hello **группы ресурсов** колонки в разделе **имя группы ресурсов**, введите имя группы ресурсов hello. Например, введите **sql-ha-rg**.
7. Если у вас несколько подписок Azure, проверьте подписки hello hello подписки Azure, который необходимо включить группы доступности toocreate hello.
8. Выберите расположение. расположение Hello — hello место группы доступности hello toocreate регион Azure. В этом учебнике мы будем toobuild все ресурсы в одном расположении Azure.
9. Убедитесь, что **toodashboard ПИН-код** проверяется. Этот необязательный параметр помещает ярлык для группы ресурсов hello hello Azure панели мониторинга портала.

   ![Группа ресурсов](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/01-resourcegroup.png)

10. Нажмите кнопку **создать** группы ресурсов toocreate hello.

Azure создает группы ресурсов hello и ПИН-кодов группы ресурсов toohello ярлыков на портале hello.

## <a name="create-hello-network-and-subnets"></a>Создать hello сети и подсети
Hello следующим шагом является toocreate hello сети и подсети в группе ресурсов Azure hello.

Hello решении используется одна виртуальная сеть с двумя подсетями. Hello [Обзор виртуальной сети](../../../virtual-network/virtual-networks-overview.md) предоставляет дополнительные сведения о сетях в Azure.

Виртуальная сеть hello toocreate:

1. В hello портал Azure, в группе ресурсов, нажмите кнопку **+ добавить**. Hello Azure открывает **все** колонку.

   ![Новый элемент](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/02-newiteminrg.png)
2. Введите в поле поиска **виртуальная сеть**.

     ![Поиск виртуальной сети](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/04-findvirtualnetwork.png)
3. Щелкните **Виртуальная сеть**.
4. На hello **виртуальная сеть** колонка, щелкните hello **диспетчера ресурсов** модель развертывания, а затем щелкните **создать**.

    Hello следующей таблице показаны параметры hello hello виртуальной сети.

   | **Поле** | Значение |
   | --- | --- |
   | **Имя** |autoHAVNET |
   | **Пространство адресов** |10.33.0.0/24 |
   | **Имя подсети** |Администратор |
   | **Диапазон адресов подсети** |10.33.0.0/29 |
   | **Подписка** |Укажите, следует присвоить toouse подписки hello. **Подписка.** Если есть только одна подписка, то этот параметр может быть пустым. |
   | **Группа ресурсов** |Выберите **использовать существующие** и выберите имя группы ресурсов hello hello. |
   | **Расположение** |Укажите расположение Azure hello. |

   Диапазон адресов пространства и подсети адрес может отличаться от таблицы hello. В зависимости от подписки портал hello предлагает доступное адресное пространство и соответствующий диапазон адресов подсети. Если достаточное пространство адресов недоступно, используйте другую подписку.

   пример Hello использует hello имя подсети **администратора**. Эта подсеть — для контроллеров домена hello.

5. Щелкните **Создать**.

   ![Настройка виртуальной сети hello](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/06-configurevirtualnetwork.png)

Возврат toohello панели мониторинга портала Azure и уведомляет о том, при создании новой сети hello.

### <a name="create-a-second-subnet"></a>Создание второй подсети
Hello новой виртуальной сети имеет одну подсеть, с именем **администратора**. использовать эту подсеть, контроллеры домена hello. Hello виртуальные машины SQL Server использовать вторую подсеть с именем **SQL**. tooconfigure этой подсети:

1. На панели мониторинга щелкните группу ресурсов hello, вы создали, **SQL-HA-RG**. Найдите hello сети в группе ресурсов hello под **ресурсов**.

    Если **SQL-HA-RG** не отображается, найдите его, нажав кнопку **групп ресурсов** и фильтрации по имени группы ресурсов hello.
2. Нажмите кнопку **autoHAVNET** на hello список ресурсов. Azure открывает колонку конфигурации сети hello.
3. На hello **autoHAVNET** колонки виртуальной сети в разделе **параметры** , нажмите кнопку **подсети**.

    Обратите внимание, hello подсети, уже созданы.

   ![Настройка виртуальной сети hello](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/07-addsubnet.png)
5. Создайте вторую подсеть. Щелкните **+ Subnet**(+Подсеть).
6. На hello **добавить подсеть** колонке настроить подсеть hello, введя **sqlsubnet** под **имя**. Azure автоматически укажет допустимое значение в поле **Диапазон адресов**. Убедитесь, что этот диапазон адресов содержит по крайней мере 10 адресов. Для рабочей среды может потребоваться больше адресов.
7. Нажмите кнопку **ОК**.

    ![Настройка виртуальной сети hello](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/08-configuresubnet.png)

Привет, в следующей таблице описаны параметры конфигурации сети hello:

| **Поле** | Значение |
| --- | --- |
| **Имя** |**autoHAVNET** |
| **Пространство адресов** |Это значение зависит от доступных адресные пространства hello в вашей подписке. Стандартное значение — 10.0.0.0/16. |
| **Имя подсети** |**admin** |
| **Диапазон адресов подсети** |Это значение зависит от hello доступных диапазонов адресов в вашей подписке. Стандартное значение — 10.0.0.0/24. |
| **Имя подсети** |**sqlsubnet** |
| **Диапазон адресов подсети** |Это значение зависит от hello доступных диапазонов адресов в вашей подписке. Стандартное значение — 10.0.1.0/24. |
| **Подписка** |Укажите, следует присвоить toouse подписки hello. |
| **Группа ресурсов** |**SQL-HA-RG** |
| **Расположение** |Укажите Здравствуйте, то расположение, которое было выбрано для группы ресурсов hello. |

## <a name="create-availability-sets"></a>Создание групп доступности

Перед созданием виртуальных машин необходимо toocreate группы доступности. Наборы доступности позволит сократить время простоя hello события запланированного или незапланированного обслуживания. Группа доступности Azure представляет собой логическую группу ресурсов, которую Azure помещает в физические домены сбоя и домены обновления. Домен сбоя гарантирует hello элементы набора доступности hello отдельные питания и сетевые ресурсы. Домен обновления гарантирует, что элементы набора доступности hello не отключена для обслуживания на hello же время. Дополнительные сведения см. в разделе [Управление доступностью виртуальных машин hello](../manage-availability.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

Вам потребуется две группы доступности: Один — для контроллеров домена hello. Во-вторых, Hello предназначен для hello виртуальные машины SQL Server.

toocreate доступности задать откройте toohello группы ресурсов и щелкните **добавить**. Фильтрация результатов hello, введя **набор доступности**. Нажмите кнопку **набор доступности** в hello результатов и нажмите кнопку **создать**.

Настройте две группы доступности, в соответствии с параметрами toohello в hello в следующей таблице:

| **Поле** | Группа доступности контроллера домена | Группа доступности SQL Server |
| --- | --- | --- |
| **Имя** |adavailabilityset |sqlavailabilityset |
| **Группа ресурсов** |SQL-HA-RG |SQL-HA-RG |
| **Домены сбоя** |3 |3 |
| **Домены обновления** |5 |3 |

После создания группы доступности hello возвращают toohello группы ресурсов в hello портал Azure.

## <a name="create-domain-controllers"></a>Создание контроллеров домена
После создания hello сети, подсети, группы доступности и балансировки нагрузки с выходом в Интернет, вы готовы toocreate hello виртуальных машин контроллеров домена hello.

### <a name="create-virtual-machines-for-hello-domain-controllers"></a>Создание виртуальных машин для hello контроллеров домена
toocreate и настройка контроллеров домена hello, возвращают toohello **SQL-HA-RG** группы ресурсов.

1. Щелкните **Добавить**. Hello **все** открывает колонку.
2. Введите **Windows Server 2016 Datacenter**.
3. Щелкните **Windows Server 2016 Datacenter**. В hello **Windows Server 2016 Datacenter** колонке проверки этой модели развертывания hello **диспетчера ресурсов**и нажмите кнопку **создать**. Hello Azure открывает **создать виртуальную машину** колонку.

Повторите hello, предшествующих шагов toocreate две виртуальные машины. Имя hello две виртуальные машины:

* ad-primary-dc
* ad-secondary-dc.

  > [!NOTE]
  > Hello **дополнительного контроллера домена Active Directory** виртуальной машины необязательно, tooprovide высокий уровень доступности для доменных служб Active Directory.
  >
  >

Hello следующей таблице показаны параметры hello для этих двух компьютеров.

| **Поле** | Значение |
| --- | --- |
| **Имя** |Первый контроллер домена: *ad-primary-dc*.</br>Второй контроллер домена *ad-secondary-dc*. |
| **Тип диска виртуальной машины** |SSD |
| **Имя пользователя** |DomainAdmin |
| **Пароль** |Contoso!0000 |
| **Подписка** |*Ваша подписка* |
| **Группа ресурсов** |SQL-HA-RG |
| **Расположение** |*Ваше расположение* |
| **Размер** |DS1_V2 |
| **Хранилище** | **Использование управляемых дисков** - **Да** |
| **Виртуальная сеть** |autoHAVNET |
| **Подсеть** |admin |
| **Общедоступный IP-адрес** |*Совпадает с именем hello виртуальной Машины* |
| **группа безопасности сети**. |*Совпадает с именем hello виртуальной Машины* |
| **группа доступности;** |adavailabilityset </br>**Домены сбоя**: 2</br>**Домены обновления**: 2|
| **Диагностика** |Включено |
| **Учетная запись хранения для диагностики** |*Создается автоматически* |

   >[!IMPORTANT]
   >Виртуальную машину можно разместить в группе доступности только при ее создании. Невозможно изменить доступность hello задать после создания виртуальной Машины. В разделе [Управление доступностью виртуальных машин hello](../manage-availability.md).

Azure создает hello виртуальных машин.

После создания виртуальных машин hello настройки контроллера домена hello.

### <a name="configure-hello-domain-controller"></a>Настройка контроллера домена hello
В hello следующие шаги настройки hello **основного контроллера домена Active Directory** компьютера в качестве контроллера домена для corp.contoso.com.

1. Откройте портал hello hello **SQL-HA-RG** группы ресурсов и выберите hello **основного контроллера домена Active Directory** машины. На hello **основного контроллера домена Active Directory** колонка, щелкните **Connect** tooopen RDP-файла для удаленного доступа к рабочему столу.

    ![Подключение tooa виртуальной машины](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/20-connectrdp.png)
2. Войдите в систему, используя настроенную учетную запись администратора (**\DomainAdmin**) и ее пароль (**Contoso!0000**).
3. По умолчанию hello **диспетчера сервера** должна отображаться панель мониторинга.
4. Нажмите кнопку hello **Добавить роли и компоненты** ссылку на панель мониторинга hello.

    ![Диспетчер сервера. Добавление ролей](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/22-addfeatures.png)
5. Выберите **Далее** до получения toohello **ролей сервера** раздела.
6. Выберите hello **доменных служб Active Directory** и **DNS-сервер** ролей. При появлении запроса добавьте требуемые для этих ролей дополнительные компоненты.

   > [!NOTE]
   > Windows предупреждает о том, что статического IP-адреса не существует. Если вы тестируете hello конфигурации, нажмите кнопку **Продолжить**. Для рабочих сценариев, задайте hello IP адрес toostatic в hello портал Azure или [PowerShell tooset hello статический IP-адрес компьютера контроллера домена hello](../../../virtual-network/virtual-networks-reserved-private-ip.md).
   >
   >

    ![Диалоговое окно добавления ролей](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/23-addroles.png)
7. Нажмите кнопку **Далее** пока не достигнете hello **Подтверждение** раздела. Выберите hello **перезапустите hello целевой сервер автоматически, если необходимо** флажок.
8. Щелкните **Install**(Установить).
9. После установки, возвращают toohello функции hello **диспетчера сервера** панели мониторинга.
10. Выберите hello новый **AD DS** параметр на левой панели hello.
11. Нажмите кнопку hello **дополнительные** ссылку на hello желтой строке предупреждения.

    ![Диалоговое окно AD DS на ВМ DNS-сервера hello](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/24-addsmore.png)
12. В hello **действия** столбец hello **все сведения о задаче сервера** диалоговое окно, нажмите кнопку **повысить роль этого контроллера домена server tooa**.
13. В hello **мастер настройки доменных служб Active Directory**, использовать hello следующие значения:

    | **Страница** | Настройка |
    | --- | --- |
    | **Конфигурация развертывания** |**Добавить новый лес**<br/> **Имя корневого домена** = corp.contoso.com |
    | **Параметры контроллера домена** |**Пароль DSRM** = Contoso!0000<br/>**Подтверждение пароля** = Contoso!0000 |
14. Нажмите кнопку **Далее** toogo через hello других страницах мастера hello. На hello **проверка предварительных требований** страницы, убедитесь, что отображаются следующие сообщения hello: **наличие всех необходимых компонентов прошла успешно**. Можно просмотреть любые применимые предупреждающие сообщения, но это возможно toocontinue с установкой hello.
15. Щелкните **Install**(Установить). Hello **основного контроллера домена Active Directory** виртуальная машина автоматически перезагружается.

### <a name="note-hello-ip-address-of-hello-primary-domain-controller"></a>Обратите внимание, IP-адрес hello hello основного контроллера домена

Используйте hello основного контроллера домена для службы DNS. Обратите внимание, IP-адрес контроллера hello основного домена.

Одним из способов tooget hello первичного контроллера IP-адрес домена выполняется с помощью портала Azure hello.

1. На hello портал Azure откройте группу ресурсов hello.

2. Щелкните hello основного контроллера домена.

3. В колонке контроллера hello основной домен, щелкните **сетевых интерфейсов**.

![Сетевые интерфейсы](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/25-primarydcip.png)

Обратите внимание, hello частный IP-адрес для этого сервера.

### <a name="configure-hello-virtual-network-dns"></a>Настройка виртуальной сети hello DNS
После создания первого контроллера домена hello и включить DNS на первом сервере hello, toouse hello виртуальной сети этот сервер настроен для DNS.

1. В hello портал Azure щелкните hello виртуальной сети.

2. В разделе **Параметры** выберите **DNS-сервер**.

3. Нажмите кнопку **настраиваемый**и введите hello частный IP-адрес hello основного контроллера домена.

4. Щелкните **Сохранить**.

### <a name="configure-hello-second-domain-controller"></a>Настройка hello второго контроллера домена
После перезагрузки hello основного контроллера домена, можно настроить hello второго контроллера домена. Этот необязательный шаг выполняется для обеспечения высокой доступности. Выполните эти шаги tooconfigure hello второго контроллера домена.

1. Откройте портал hello hello **SQL-HA-RG** группы ресурсов и выберите hello **дополнительного контроллера домена Active Directory** машины. На hello **дополнительного контроллера домена Active Directory** колонка, щелкните **Connect** tooopen RDP-файла для удаленного доступа к рабочему столу.
2. Войдите в toohello виртуальной Машины с помощью учетной записи администратора (**BUILTIN\DomainAdmin**) и пароль (**Contoso! 0000**).
3. Изменение hello предпочтительный адрес DNS-сервера адрес toohello hello контроллера домена.
4. В **сетями и общим доступом**, нажмите кнопку hello сетевого интерфейса.
   ![Сетевой интерфейс](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/26-networkinterface.png)

5. Щелкните **Свойства**.
6. Выберите **Протокол IP версии 4 (TCP/IPv4)** и нажмите кнопку **Свойства**.
7. Выберите **hello использовать следующие адреса DNS-серверов** и укажите адрес hello hello основной контроллер домена в **предпочитаемый DNS-сервер**.
8. Нажмите кнопку **ОК**, а затем **закрыть** toocommit hello изменения. Теперь вы находитесь может toojoin hello виртуальной Машины слишком**corp.contoso.com**.

   >[!IMPORTANT]
   >При утере соединения hello tooyour удаленного рабочего стола после изменения параметра hello DNS перейдите toohello портала и перезапустите hello виртуальной машины Azure.

9. Hello удаленного рабочего стола toohello дополнительный контроллер домена, откройте **панели мониторинга диспетчера сервера**.
10. Нажмите кнопку hello **Добавить роли и компоненты** ссылку на панель мониторинга hello.

    ![Диспетчер сервера. Добавление ролей](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/22-addfeatures.png)
11. Выберите **Далее** до получения toohello **ролей сервера** раздела.
12. Выберите hello **доменных служб Active Directory** и **DNS-сервер** ролей. При появлении запроса добавьте требуемые для этих ролей дополнительные компоненты.
13. После установки, возвращают toohello функции hello **диспетчера сервера** панели мониторинга.
14. Выберите hello новый **AD DS** параметр на левой панели hello.
15. Нажмите кнопку hello **дополнительные** ссылку на hello желтой строке предупреждения.
16. В hello **действия** столбец hello **все сведения о задаче сервера** диалоговое окно, нажмите кнопку **повысить роль этого контроллера домена server tooa**.
17. В разделе **конфигурации развертывания**выберите **добавить контроллер домена tooan существующего домена**.
   ![Конфигурация развертывания](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/28-deploymentconfig.png)
18. Нажмите кнопку **Выбрать**.
19. Подключаться с учетной записью администратора hello (**CORP. Contoso.COM\domainadmin**) и пароль (**Contoso! 0000**).
20. В **выберите домен из леса hello**, щелкните свой домен и нажмите кнопку **ОК**.
21. В **параметры контроллера домена**, используйте значения по умолчанию hello и задать пароль DSRM.

   >[!NOTE]
   >Hello **параметры DNS** страницы может предупреждение о том, что делегирование для этого DNS-сервера создавать нельзя. В нерабочей среде это предупреждение можно игнорировать.
22. Нажмите кнопку **Далее** пока не достигнет диалоговое окно приветствия hello **необходимые компоненты** проверки. Нажмите **Install**(Установить).

По завершении изменения конфигурации hello hello server перезапустите сервер hello.

### <a name="add-hello-private-ip-address-toohello-second-domain-controller-toohello-vpn-dns-server"></a>Добавить hello частный IP-адрес toohello второй контроллер toohello домена DNS-сервера VPN

В hello портале Azure в виртуальной сети измените hello DNS tooinclude hello IP-адрес сервера hello дополнительный контроллер домена. Это обеспечивает избыточность службы DNS hello.

### <a name=DomainAccounts></a>Настройка учетных записей домена hello

В следующих шагах hello настройте учетные записи Active Directory hello. Hello Следующая таблица показывает учетные записи hello.

| |Учетная запись установки<br/> |sqlserver-0 <br/>Учетная запись SQL Server и службы агента SQL |sqlserver-1<br/>Учетная запись SQL Server и службы агента SQL
| --- | --- | --- | ---
|**Имя** |Install |SQLSvc1 | SQLSvc2
|**User SamAccountName** |Install |SQLSvc1 | SQLSvc2

Используйте следующие шаги toocreate hello каждой учетной записи.

1. Войдите в toohello **основного контроллера домена Active Directory** машины.
2. На панели **Диспетчер серверов** выберите **Средства**, а затем щелкните **Центр администрирования Active Directory**.   
3. Выберите **corp (local)** hello левой панели.
4. На правом hello **задачи** выберите **New**и нажмите кнопку **пользователя**.
   ![Центр администрирования Active Directory](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/29-addcnewuser.png)

   >[!TIP]
   >Задайте сложный пароль для каждой учетной записи.<br/> Для непроизводственных средах toonever учетной записи пользователя hello набор срока действия.

5. Нажмите кнопку **ОК** toocreate hello пользователя.
6. Повторите hello в предыдущих шагах, для каждого из трех hello учетных записей.

### <a name="grant-hello-required-permissions-toohello-installation-account"></a>Учетная запись установки toohello hello необходимые разрешения
1. В hello **Центр администрирования Active Directory**выберите **corp (local)** hello левой панели. Затем в правом hello **задачи** области, нажмите кнопку **свойства**.

    ![Свойства пользователя CORP](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/31-addcproperties.png)
2. Выберите **расширения**, а затем нажмите кнопку hello **Дополнительно** кнопку на hello **безопасности** вкладку.
3. В hello **Дополнительные параметры безопасности для corp** диалоговое окно, нажмите кнопку **добавить**.
4. Щелкните **Выберите субъект**, найдите **CORP\Install** и нажмите кнопку **ОК**.
5. Выберите hello **чтение всех свойств** флажок.

6. Выберите hello **создание объектов-компьютеров** флажок.

     ![Разрешения пользователя CORP](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/33-addpermissions.png)
7. Нажмите кнопку **ОК**, а затем снова кнопку **ОК**. Закрыть hello **corp** окно "Свойства".

Теперь, после завершения настройки Active Directory и объектов пользователей hello, создайте две виртуальные машины SQL Server и следящего сервера виртуальной Машины. Присоедините все три домена toohello.

## <a name="create-sql-server-vms"></a>Создание виртуальных машин SQL Server

Создайте три дополнительные виртуальные машины. Hello решение требует двух виртуальных машин с экземплярами SQL Server. Третья виртуальная машина будет выполнять роль свидетеля. Windows Server 2016 может использовать [облако-свидетель](http://docs.microsoft.com/windows-server/failover-clustering/deploy-cloud-witness), но для обеспечения согласованности с предыдущими операционными системами в этом документе в качестве свидетеля используется виртуальная машина.  

Перед продолжением рассмотрите следующие решения deisign hello.

* **Хранилище — управляемые диски Azure**

   Для хранилища виртуальных машин hello Используйте управляемые диски Azure. Корпорация Майкрософт рекомендует управляемые диски для виртуальных машин SQL Server. Управлять дисками управляет хранилищем фоновом hello. Кроме того, когда виртуальные машины с дисками управляемых находятся в hello одной группе доступности Azure распределяет соответствующие избыточности ресурсы хранилища tooprovide hello. Дополнительные сведения см. в [обзоре управляемых дисков Azure](../managed-disks-overview.md). Подробные сведения об управляемых дисках в группе доступности см. в разделе [Использование управляемых дисков для виртуальных машин в группе доступности](../manage-availability.md#use-managed-disks-for-vms-in-an-availability-set).

* **Сеть — частные IP-адреса в рабочей среде**

   Для виртуальных машин hello в этом учебнике используется общих IP-адресов. Это позволяет удаленного подключения напрямую toohello виртуальную машину по hello Интернет - он упрощает настройку. В производственной среде Корпорация Майкрософт рекомендует только частных IP-адресов в порядке tooreduce зона уязвимости hello экземпляра SQL Server hello ресурса виртуальной Машины.

### <a name="create-and-configure-hello-sql-server-vms"></a>Создание и настройка виртуальных машин SQL Server hello
Далее создайте три виртуальные машины: две виртуальные машины SQL Server и виртуальную машину для дополнительного узла кластера. toocreate каждой ВМ hello, вернитесь к предыдущему окну toohello **SQL-HA-RG** группы ресурсов, нажмите кнопку **добавить**поиск элемента коллекции, соответствующий hello, нажмите кнопку **виртуальной машины**, а затем Нажмите кнопку **из коллекции**. Используйте сведения hello в hello после создания виртуальных машин hello toohelp таблицы.


| Страница | VM1 | VM2 | VM3 |
| --- | --- | --- | --- |
| Выберите элемент, соответствующий коллекции hello |**Windows Server 2016 Datacenter** |**SQL Server 2016 SP1 Enterprise на базе Windows Server 2016** |**SQL Server 2016 SP1 Enterprise на базе Windows Server 2016** |
| Конфигурация виртуальной машины **Базовый** |**Имя** = cluster-fsw<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** = ваше расположение Azure |**Имя** = sqlserver-0<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** = ваше расположение Azure |**Имя** = sqlserver-1<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** = ваше расположение Azure |
| Конфигурация виртуальной машины **Размер** |**Размер** = DS1\_V2 (1 ядро, 3,5 ГБ) |**Размер** = DS2\_V2 (2 ядра, 7 ГБ)</br>размер Hello должен поддерживать SSD-хранилище (расширенная поддержка диска. ) |**Размер** = DS2\_V2 (2 ядра, 7 ГБ) |
| Конфигурация виртуальной машины **Параметры** |**Хранилище**: используйте управляемые диски.<br/>**Виртуальная сеть** = autoHAVNET<br/>**Подсеть** = sqlsubnet(10.1.1.0/24)<br/>**Общедоступный IP-адрес** создается автоматически.<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** = sqlAvailabilitySet<br/> |**Хранилище**: используйте управляемые диски.<br/>**Виртуальная сеть** = autoHAVNET<br/>**Подсеть** = sqlsubnet(10.1.1.0/24)<br/>**Общедоступный IP-адрес** создается автоматически.<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** = sqlAvailabilitySet<br/> |**Хранилище**: используйте управляемые диски.<br/>**Виртуальная сеть** = autoHAVNET<br/>**Подсеть** = sqlsubnet(10.1.1.0/24)<br/>**Общедоступный IP-адрес** создается автоматически.<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** = sqlAvailabilitySet<br/> |
| Конфигурация виртуальной машины **Параметры SQL Server** |Не применяется |**Подключение к SQL** = закрытое (в виртуальной сети)<br/>**Порт** = 1433<br/>**Проверка подлинности SQL** = отключено<br/>**Конфигурация хранилища** = общая<br/>**Автоматическое исправление** = воскресенье в 2:00<br/>**Автоматическая архивация** = отключено</br>**Интеграция хранилища ключей Azure** = отключено |**Подключение к SQL** = закрытое (в виртуальной сети)<br/>**Порт** = 1433<br/>**Проверка подлинности SQL** = отключено<br/>**Конфигурация хранилища** = общая<br/>**Автоматическое исправление** = воскресенье в 2:00<br/>**Автоматическая архивация** = отключено</br>**Интеграция хранилища ключей Azure** = отключено |

<br/>

> [!NOTE]
> размеры машины Hello, предложенные ниже предназначены для тестирования группы доступности в виртуальных машинах Azure. Для наилучшей производительности hello на рабочие нагрузки, увидеть рекомендации hello размеров машины SQL Server и конфигурации в [рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure](virtual-machines-windows-sql-performance.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).
>
>

После полного выделения hello трех виртуальных машин необходимо toojoin их toohello **corp.contoso.com** домена и предоставьте машины toohello CORP\Install права администратора.

### <a name="joinDomain"></a>Домену toohello hello серверов

Вы теперь может toojoin hello виртуальных машин слишком**corp.contoso.com**. Используйте для виртуальных машин SQL Server hello и файл hello следующие hello следящего сервера:

1. Удаленное подключение toohello виртуальную машину с **BUILTIN\DomainAdmin**.
2. В **диспетчере сервера** щелкните **Локальный сервер**.
3. Нажмите кнопку hello **рабочей группы** ссылку.
4. В hello **имя компьютера** щелкните **изменений**.
5. Выберите hello **домена** флажок и введите **corp.contoso.com** в текстовом поле hello. Нажмите кнопку **ОК**.
6. В hello **безопасности Windows** всплывающем диалоговом окне укажите hello учетные данные для учетной записи администратора домена по умолчанию hello (**CORP\DomainAdmin**) и пароль hello (**Contoso! 0000**).
7. После появления сообщения «toohello приветствия домена corp.contoso.com» hello, нажмите кнопку **ОК**.
8. Нажмите кнопку **закрыть**, а затем нажмите кнопку **Перезагрузить сейчас** в появившемся диалоговом окне приветствия.

### <a name="add-hello-corpinstall-user-as-an-administrator-on-each-cluster-vm"></a>Добавить hello Corp\Install пользователя с правами администратора на каждом кластере виртуальных Машин

После перезапуска каждой виртуальной машины является членом домена hello, добавить **CORP\Install** является членом группы локальных администраторов hello.

1. Подождите, пока hello виртуальная машина перезапускается и запустите файл протокола удаленного рабочего СТОЛА hello еще раз из toosign hello основной домен контроллера, в слишком**sqlserver 0** с помощью hello **CORP\DomainAdmin** учетной записи.
   >[!TIP]
   >Убедитесь, что вход hello учетной записи администратора домена. В предыдущих шагах hello с учетной записью администратора в BUILT hello. Теперь, когда hello сервера в домене hello, используйте учетную запись домена hello. В сеансе RDP укажите *Домен*\\*имя пользователя*.

2. На панели **Диспетчер серверов** выберите **Инструменты**, а затем щелкните **Управление компьютером**.
3. В hello **Управление компьютером** окна, разверните **локальные пользователи и группы**, а затем выберите **группы**.
4. Дважды щелкните hello **Администраторы** группы.
5. В hello **свойства администратора** диалоговое окно, нажмите кнопку hello **добавить** кнопки.
6. Введите пользователя hello **CORP\Install**, а затем нажмите кнопку **ОК**.
7. Нажмите кнопку **ОК** tooclose hello **свойства администратора** диалогового окна.
8. Повторите предыдущие шаги hello в **sqlserver 1** и **fsw кластера**.

### <a name="setServiceAccount"></a>Задайте учетные записи служб SQL Server hello

На каждой виртуальной Машине SQL Server задайте учетную запись службы SQL Server hello. Использовать учетные записи hello созданы во время вы [настроены учетные записи домена hello](#DomainAccounts).

1. Откройте **диспетчер конфигурации SQL Server**.
2. Щелкните правой кнопкой мыши hello службы SQL Server и нажмите кнопку **свойства**.
3. Набор hello учетную запись и пароль.
4. Повторите эти действия на hello других ВМ SQL Server.  

Для групп доступности SQL Server каждой виртуальной Машине SQL Server должен toorun под учетной записью домена.

### <a name="create-a-sign-in-on-each-sql-server-vm-for-hello-installation-account"></a>Создать вход на каждой виртуальной Машине SQL Server hello учетной записи для установки

Используйте hello установки учетной записи (CORP\install) tooconfigure hello группы доступности. Эта учетная запись должна toobe членом hello **sysadmin** предопределенной роли сервера на каждой виртуальной Машине SQL Server. Hello следующие действия создадут вход hello учетной записи для установки:

1. Подключение сервера toohello через hello удаленного рабочего стола (RDP) с помощью hello  *\<MachineName\>\DomainAdmin* учетной записи.

1. Откройте среду SQL Server Management Studio и подключитесь toohello локальный экземпляр SQL Server.

1. В **обозревателе объектов** щелкните **Безопасность**.

1. Щелкните правой кнопкой мыши **Имена входа**. Выберите **Создать имя входа**.

1. В разделе **Создание имени входа** щелкните **Поиск**.

1. Щелкните **Расположения**.

1. Введите учетные данные администратора сети hello домена.

1. Используйте учетную запись для установки hello.

1. Задать hello вход toobe членом hello **sysadmin** предопределенной роли сервера.

1. Нажмите кнопку **ОК**.

Повторите hello предыдущих шагах на hello других ВМ SQL Server.

## <a name="add-failover-clustering-features-tooboth-sql-server-vms"></a>Добавить tooboth функции отказоустойчивой кластеризации виртуальных машин SQL Server

функции отказоустойчивой кластеризации tooadd hello на обеих виртуальных машин SQL Server:

1. Подключения виртуальной машины SQL Server toohello через hello удаленного рабочего стола (RDP) с помощью hello *CORP\install* учетной записи. Откройте **панель мониторинга диспетчера сервера**.
2. Нажмите кнопку hello **Добавить роли и компоненты** ссылку на панель мониторинга hello.

    ![Диспетчер сервера. Добавление ролей](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/22-addfeatures.png)
3. Выберите **Далее** до получения toohello **компонентов сервера** раздела.
4. В разделе **функций** выберите **Отказоустойчивость кластеров**.
5. Добавьте другие необходимые функции.
6. Нажмите кнопку **установить** tooadd функции hello.

Повторите шаги hello на hello других ВМ SQL Server.

## <a name="a-nameendpoint-firewall-configure-hello-firewall-on-each-sql-server-vm"></a><a name="endpoint-firewall">Настройка брандмауэра hello на каждой виртуальной Машине SQL Server

Hello решения требуются следующие порты TCP toobe открыть в брандмауэре hello hello:

- **Виртуальная машина SQL Server**.<br/>
   Порт 1433 для экземпляра сервера SQL Server по умолчанию.
- **Проба Azure Load Balancer**.<br/>
   Любой доступный порт. В примерах часто используется 59999.
- **Конечная точка зеркального отображения базы данных**. <br/>
   Любой доступный порт. В примерах часто используется 5022.

Hello брандмауэра порты toobe необходимость, открыт на обоих виртуальных машин SQL Server.

Открытие портов hello Hello метод зависит от hello брандмауэра решение, которое вы используете. Hello следующем разделе показано, как tooopen hello порты в брандмауэре Windows. Привет открыть необходимые порты на всех виртуальных машин SQL Server.

### <a name="open-a-tcp-port-in-hello-firewall"></a>Откройте TCP-порт в брандмауэре hello

1. На hello первого SQL Server **запустить** экрана, запустить **брандмауэр Windows в режиме повышенной безопасности**.
2. Выберите на левой панели hello **правила для входящих подключений**. На правой панели hello щелкните **новое правило**.
3. Для параметра **Тип правила** выберите **Порт**.
4. Порт hello укажите **TCP** и соответствующие номера портов hello типа. См. следующий пример hello.

   ![Брандмауэр SQL](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/35-tcpports.png)

5. Щелкните **Далее**.
6. На hello **действия** оставьте **разрешить подключение hello** , а затем нажмите кнопку **Далее**.
7. На hello **профиль** примите параметры по умолчанию hello и нажмите кнопку **Далее**.
8. На hello **имя** укажите имя правила (например, **проверки балансировки Нагрузки Azure**) в hello **имя** текстовое поле и нажмите кнопку **Готово**.

Повторите эти шаги на hello второй виртуальной Машине SQL Server.

## <a name="next-steps"></a>Дальнейшие действия

* [Настройка группы доступности AlwaysOn на виртуальной машине Azure вручную](virtual-machines-windows-portal-sql-availability-group-tutorial.md)

---
title: "aaaHigh доступности и аварийное восстановление для SQL Server | Документы Microsoft"
description: "Обсуждение hello различных стратегий HADR для SQL Server в виртуальных машинах Azure."
services: virtual-machines-windows
documentationcenter: na
author: MikeRayMSFT
manager: jhubbard
editor: 
tags: azure-service-management
ms.assetid: 53981f7e-8370-4979-b26a-93a5988d905f
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 06/27/2017
ms.author: mikeray
ms.openlocfilehash: 2b62d8b30520952ba6b7da7177a2c2de95bea8ce
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="high-availability-and-disaster-recovery-for-sql-server-in-azure-virtual-machines"></a>Высокий уровень доступности и аварийное восстановление для SQL Server на виртуальных машинах Azure

Виртуальные машины Microsoft Azure (ВМ) с SQL Server может помочь сократить стоимость hello решения высокого уровня доступности и аварийного восстановления (HADR) базы данных. Виртуальные машины Azure поддерживают большинство решений HADR для SQL Server как для использования только в службе Azure, так и в качестве гибридных решений. В решении только в Azure hello вся система HADR работает в Azure. В гибридной конфигурации часть решения hello выполняется в Azure и hello другие части — локально в вашей организации. Hello гибкость hello среды Azure позволяет toomove частично или полностью tooAzure toosatisfy hello бюджету и требований HADR вашего сервера SQL Server систем баз данных.

[!INCLUDE [learn-about-deployment-models](../../../../includes/learn-about-deployment-models-both-include.md)]

## <a name="understanding-hello-need-for-an-hadr-solution"></a>Основные сведения о необходимости hello HADR-решении
Он работает tooyou tooensure, ваша система поддерживает возможности HADR hello, требует hello соглашения об уровне обслуживания (SLA). Hello факт, что Azure предоставляет механизмы высокого уровня доступности, такие как восстановление облачных служб и обнаружение восстановления после сбоя для виртуальных машин не сам гарантирует, что можно достичь требуемой hello соглашения об уровне ОБСЛУЖИВАНИЯ. Эти механизмы защищают высокий уровень доступности hello hello виртуальные машины, но не hello высокой доступности SQL Server, работающей ВМ hello. Существует возможность toofail экземпляр SQL Server hello, пока hello виртуальной Машины и исправен. Кроме того, разрешить hello даже механизмы высокого уровня доступности, предоставляемые Azure времени простоя для hello виртуальных машин из-за tooevents, такие как восстановление после сбоев оборудования или программного обеспечения и обновлений операционной системы.

Кроме того, геоизбыточного хранилища (GRS) в Azure, которое реализуется с помощью такой функции, как георепликация, может оказаться недостаточно для аварийного восстановления баз данных. Поскольку георепликация отправляет данные асинхронно, последние обновления может быть потеряна в событии hello аварии. Дополнительные сведения об ограничениях георепликации охваченных hello [георепликация не поддерживается для файлов данных и журналов на разных дисках](#geo-replication-support) раздела.

## <a name="hadr-deployment-architectures"></a>Архитектуры развертывания HADR
В Azure поддерживаются следующие технологии HADR для SQL Server.

* [Группы доступности Always On](https://technet.microsoft.com/library/hh510230.aspx)
* [Экземпляры отказоустойчивого кластера Always On](https://technet.microsoft.com/library/ms189134.aspx)
* [Доставка журналов](https://technet.microsoft.com/library/ms187103.aspx)
* [Резервное копирование и восстановление SQL Server с помощью службы хранилища BLOB-объектов Azure](https://msdn.microsoft.com/library/jj919148.aspx)
* [Зеркальное отображение базы данных (SQL Server)](https://technet.microsoft.com/library/ms189852.aspx) — устаревшее в SQL Server 2016

Это возможно toocombine hello технологий вместе tooimplement решение SQL Server, который имеет высокий уровень доступности и возможности аварийного восстановления. В зависимости от используемой технологии hello гибридного развертывания может потребоваться VPN-туннель с hello виртуальной сети Azure. в следующих разделах Hello показаны некоторые примеры архитектур развертывания hello.

## <a name="azure-only-high-availability-solutions"></a>Только в Azure: решения высокого уровня доступности

Решение для обеспечения высокого уровня доступности SQL Server можно реализовать на уровне базы данных с помощью групп доступности AlwaysOn. Его можно также создать на уровне экземпляра с помощью экземпляров отказоустойчивого кластера AlwaysOn. Чтобы повысить избыточность на обоих уровнях, можно также создать группы доступности для экземпляров отказоустойчивого кластера. 

| Технология | Примеры архитектур |
| --- | --- |
| **Группы доступности** |Таким же Здравствуйте, реплики доступности выполняются на виртуальных машинах Azure в области обеспечения высокого уровня доступности. Необходимо tooconfigure контроллер домена виртуальной Машины, так как отказоустойчивая кластеризация Windows требуется домен Active Directory.<br/> ![Группы доступности](./media/virtual-machines-windows-sql-high-availability-dr/azure_only_ha_always_on.gif)<br/>Дополнительные сведения см. в статье [Автоматическая настройка групп доступности AlwaysOn на виртуальных машинах Azure с использованием Resource Manager](virtual-machines-windows-portal-sql-alwayson-availability-groups.md). |
| **Экземпляры отказоустойчивого кластера** |Экземпляры отказоустойчивого кластера (FCI), которые требуют наличия общего хранилища, можно создавать тремя способами.<br/><br/>1. В двухузловом отказоустойчивом кластере в виртуальных машинах Azure с хранилищем с помощью [Windows Server 2016 Storage Spaces Direct \(S2D\) ](virtual-machines-windows-portal-sql-create-failover-cluster.md) tooprovide виртуальную сеть SAN на основе программного обеспечения.<br/><br/>2. Отказоустойчивый кластер с двумя узлами, выполняющийся на виртуальных машинах Azure, с хранилищем, поддерживаемым сторонним решением кластеризации. Конкретный пример, в котором используется SIOS DataKeeper, приведен в публикации блога [High Availability for a file share using WSFC, ILB and 3rd-party Software SIOS Datakeeper](https://azure.microsoft.com/blog/high-availability-for-a-file-share-using-wsfc-ilb-and-3rd-party-software-sios-datakeeper/) (Обеспечение высокого уровня доступности файлового ресурса с помощью WSFC, внутренней подсистемы балансировки нагрузки и стороннего ПО SIOS Datakeeper).<br/><br/>3. Отказоустойчивый кластер с двумя узлами, выполняющийся на виртуальных машинах Azure, с удаленным целевым общим блочным хранилищем iSCSI, подключенным через ExpressRoute. Например NetApp частного хранилища (NPS) обеспечивает доступ к цели iSCSI через ExpressRoute с Equinix tooAzure виртуальных машин.<br/><br/>Для общего хранилища сторонних решений и данных репликации следует обратиться к поставщику hello tooaccessing связанных данных проблем при отработке отказа.<br/><br/>Обратите внимание, что использование экземпляра FCI поверх [хранилища файлов Azure](https://azure.microsoft.com/services/storage/files/) пока не поддерживается, так как это решение не использует хранилище уровня "Премиум". Мы активно работаем над toosupport этом скоро. |

## <a name="azure-only-disaster-recovery-solutions"></a>Только в Azure: решения аварийного восстановления
У вас может быть решение аварийного восстановления для баз данных SQL Server в Azure, использующее группы доступности, зеркальное отображение базы данных или архивацию и восстановление с большими двоичными объектами хранилища.

| Технология | Примеры архитектур |
| --- | --- |
| **Группы доступности** |Реплики доступности, выполняемые в нескольких центрах обработки данных на виртуальных машинах Azure для аварийного восстановления. Это межрегиональное решение обеспечивает защиту от простоя всего сайта. <br/> ![Группы доступности](./media/virtual-machines-windows-sql-high-availability-dr/azure_only_dr_alwayson.png)<br/>В области все реплики должны быть в пределах hello же облачную службу и hello одной виртуальной сети. Так как в каждом регионе может быть отдельная VNet, эти решения требуют подключения к виртуальной сети tooVNet. Дополнительные сведения см. в разделе [VNet к VNet Настройка соединения с помощью портала Azure "hello"](../../../vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal.md). Подробные инструкции см. в статье [Настройка группы доступности AlwaysOn на виртуальных машинах Azure в разных регионах](virtual-machines-windows-portal-sql-availability-group-dr.md).|
| **Зеркальное отображение базы данных** |Основной, зеркальный и другие серверы, выполняемые в разных центрах обработки данных для аварийного восстановления. Для развертывания необходимо использовать сертификаты сервера, так как домен Active Directory не может охватывать несколько центров обработки данных.<br/>![Зеркальное отображение базы данных](./media/virtual-machines-windows-sql-high-availability-dr/azure_only_dr_dbmirroring.gif) |
| **Резервное копирование и восстановление с помощью службы хранилища больших двоичных объектов Azure** |Производственные базы данных, резервные копии непосредственно tooblob хранилища в другом центре обработки данных для аварийного восстановления.<br/>![Резервное копирование и восстановление](./media/virtual-machines-windows-sql-high-availability-dr/azure_only_dr_backup_restore.gif)<br/>Дополнительные сведения см. в статье [Резервное копирование и восстановление SQL Server в виртуальных машинах Azure](virtual-machines-windows-sql-backup-recovery.md). |

## <a name="hybrid-it-disaster-recovery-solutions"></a>Гибридная ИТ-среда: решения аварийного восстановления
У вас может быть решение аварийного восстановления для баз данных SQL Server в гибридной ИТ-среде, использующее группы доступности, зеркальное отображение базы данных и доставку журналов, а также архивацию и восстановление с помощью хранилища больших двоичных объектов Azure.

| Технология | Примеры архитектур |
| --- | --- |
| **Группы доступности** |Некоторые реплики доступности, выполняемые на виртуальных машинах Azure, и другие реплики, которые выполняются локально для аварийного восстановления на нескольких сайтах. Hello рабочий сайт может размещаться локально или в центре обработки данных Azure.<br/>![Группы доступности](./media/virtual-machines-windows-sql-high-availability-dr/hybrid_dr_alwayson.gif)<br/>Поскольку все реплики доступности должны находиться в hello один отказоустойчивый кластер hello кластер должен охватывать обе сети (несколькими подсетями отказоустойчивого кластера). Этой конфигурации требуется VPN-подключение между Azure и hello в локальной сети.<br/><br/>Для успешного аварийного восстановления баз данных следует также установить реплики контроллера домена на сайте аварийного восстановления hello.<br/><br/>Это возможно toouse приветствия мастера добавления реплики в SSMS tooadd tooan реплики Azure существующей группы доступности AlwaysOn. Дополнительные сведения см. в разделе учебника: расширить tooAzure вашей группы доступности AlwaysOn. |
| **Зеркальное отображение базы данных** |Один участник выполняется на ВМ Azure, а другие hello выполняется локально для межсайтовой аварийного восстановления, с использованием сертификатов сервера. Партнеры не обязательно toobe в Привет одному домену Active Directory и VPN-подключение не требуется.<br/>![Зеркальное отображение базы данных](./media/virtual-machines-windows-sql-high-availability-dr/hybrid_dr_dbmirroring.gif)<br/>Сценарии зеркального отражения другой базы данных включает в себя один участник выполняется на виртуальной Машине Azure и hello другой выполняется локально в hello же домене Active Directory для аварийного восстановления между сайтами. Объект [VPN-подключение между hello Azure виртуальной сети и hello в локальной сети](../../../vpn-gateway/vpn-gateway-site-to-site-create.md) является обязательным.<br/><br/>Для успешного аварийного восстановления баз данных следует также установить реплики контроллера домена на сайте аварийного восстановления hello. |
| **Доставка журналов** |Один сервер работает на виртуальной Машине Azure и других hello выполняется локально для аварийного восстановления между сайтами. Доставка журналов зависит от совместное использование файлов Windows, поэтому VPN-подключение между hello виртуальной сети Azure и hello в локальной сети не требуется.<br/>![Доставка журналов](./media/virtual-machines-windows-sql-high-availability-dr/hybrid_dr_log_shipping.gif)<br/>Для успешного аварийного восстановления баз данных следует также установить реплики контроллера домена на сайте аварийного восстановления hello. |
| **Резервное копирование и восстановление с помощью службы хранилища больших двоичных объектов Azure** |Локальных рабочих баз данных, резервные копии непосредственно tooAzure хранилища BLOB-данных для аварийного восстановления.<br/>![Резервное копирование и восстановление](./media/virtual-machines-windows-sql-high-availability-dr/hybrid_dr_backup_restore.gif)<br/>Дополнительные сведения см. в статье [Резервное копирование и восстановление SQL Server в виртуальных машинах Azure](virtual-machines-windows-sql-backup-recovery.md). |

## <a name="important-considerations-for-sql-server-hadr-in-azure"></a>Важные соображения в отношении HADR для SQL Server в Azure
Виртуальные машины, хранилища и сети Azure имеют рабочие характеристики, отличные от характеристик локальной, невиртуализированной ИТ-инфраструктуры. Для успешной реализации решение HADR SQL Server в Azure необходимо понимать эти различия и разработать вашего решения tooaccommodate их.

### <a name="high-availability-nodes-in-an-availability-set"></a>Узлы с высоким уровнем доступности в группе доступности
Группы доступности в Azure включить узлы высокой доступности tooplace hello в отдельном ошибки доменах отказоустойчивости и обновления доменах. Виртуальные машины Azure toobe помещается в hello же группу доступности необходимо развернуть их в hello же облачной службе. Только узлы в одной облачной службе могут участвовать в приветствия hello одной группе доступности. Дополнительные сведения см. в разделе [hello Управление доступностью виртуальных машин](../manage-availability.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

### <a name="failover-cluster-behavior-in-azure-networking"></a>Поведение отказоустойчивого кластера в сети Azure
Hello не соответствует RFC служба DHCP в Azure может привести к hello создания определенных toofail кластера конфигурации отработки отказа, из-за сетевого имени кластера toohello, присваиваемого дублирующийся IP-адрес, например hello же IP-адрес как один из узлов кластера hello. Это важно при реализации групп доступности, который зависит от компонента отказоустойчивого кластера для Windows hello.

Рассмотрим сценарий hello, при создании двухузлового кластера и перевести в оперативный режим.

1. Hello кластер переходит в оперативный режим, а затем NODE1 запрашивает динамически назначаемый IP-адрес для сетевого имени кластера hello.
2. Отсутствует IP-адрес, отличный от NODE1 собственный IP-адрес задается hello службой DHCP, так как hello служба DHCP распознает, что hello запрос поступает от NODE1 сам.
3. Windows обнаруживает, что повторяющийся адрес назначен tooNODE1 и toohello сетевое имя отказоустойчивого кластера и группы кластера по умолчанию hello не toocome через Интернет.
4. Кластерная группа по умолчанию Hello перемещает tooNODE2, который обрабатывает IP-адрес NODE1 как IP-адрес кластера hello и переводит группу кластера по умолчанию hello через Интернет.
5. Когда NODE2 пытается tooestablish соединение с NODE1, пакеты, направляемые на NODE1 никогда не покидают NODE2, так как он разрешается NODE1 IP адрес tooitself. NODE2 не может установить соединение с NODE1, теряет кворум и завершает работу кластера hello.
6. В это время hello NODE1 может отправлять пакеты tooNODE2, но NODE2 не может ответить. NODE1 теряет кворум и завершает работу кластера hello.

Этот сценарий можно избежать, если назначить неиспользуемый статический IP-адрес, такие как IP-адрес локальной связи, такой как 169.254.1.1, toohello сетевое имя кластера в порядке toobring hello сетевое имя кластера в оперативный режим. toosimplify Эта процедура, в разделе [отказоустойчивого кластера Windows, Настройка в Azure для групп доступности](http://social.technet.microsoft.com/wiki/contents/articles/14776.configuring-windows-failover-cluster-in-windows-azure-for-alwayson-availability-groups.aspx).

Дополнительные сведения см. в статье [Автоматическая настройка групп доступности AlwaysOn на виртуальных машинах Azure с использованием Resource Manager](virtual-machines-windows-portal-sql-alwayson-availability-groups.md).

### <a name="availability-group-listener-support"></a>Поддержка прослушивателя группы доступности
Прослушиватели группы доступности поддерживаются на виртуальных машинах Azure, работающих под управлением Windows Server 2008 R2, Windows Server 2012, Windows Server 2012 R2 и Windows Server 2016. Эта поддержка возможна при hello использование конечных точек с балансировкой нагрузки включена на виртуальных машинах Azure hello, являющихся узлами группы доступности. Выполните специальные шаги настройки для hello toowork прослушиватели для обоих клиентских приложений, выполняющихся в Azure, а также те выполняется локально.

Существует два основных способа настройки: внешний (общедоступный) или внутренний прослушиватель. использует внешних (открытых) прослушиватель Hello из Интернета, подсистема балансировки нагрузки и связан с открытый виртуальных IP-адресов (VIP), доступном через hello Интернета. Внутренний прослушиватель использует внутренний балансировщик нагрузки и только для поддержки клиентов в пределах hello одной виртуальной сети. Для обоих типов балансировщика нагрузки необходимо включить прямой ответ от сервера. 

Если hello группа доступности распространяется на несколько подсетей, Azure (например, развертывания, пересекающего регионы Azure), необходимо включить строку подключения клиента hello»**MultisubnetFailover = True**». Это приводит к реплик toohello попытки параллельных подключений в разных подсетях hello. Инструкции по настройке прослушивателя см. в разделах:

* [Настройка прослушивателя внутренней подсистемы балансировки нагрузки для групп доступности в Azure](virtual-machines-windows-portal-sql-ps-alwayson-int-listener.md).
* [Настройка внешнего прослушивателя для групп доступности в Azure](../classic/ps-sql-ext-listener.md).

Вы можете подключаться tooeach реплике доступности отдельно, напрямую подключившись toohello экземпляра службы. Кроме того, поскольку группы доступности обратно совместимы с клиентами зеркального отображения базы данных, можно подключиться toohello репликам доступности как к участникам зеркального отображения при условии, что hello реплики настроены как toodatabase зеркального отображения:

* имеется по одной первичной и вторичной реплике;
* Hello вторичная реплика настроена как недоступный для чтения (**вторичной** параметр установлен слишком**нет**)

Пример строки подключения клиента, соответствующий конфигурации подобной зеркальному отображению базы данных toothis, с использованием ADO.NET или собственный клиент SQL Server используется следующим образом:

    Data Source=ReplicaServer1;Failover Partner=ReplicaServer2;Initial Catalog=AvailabilityDatabase;

Дополнительные сведения о подключении клиента см. в следующих статьях.

* [Использование ключевых слов строки подключения с собственным клиентом SQL Server](https://msdn.microsoft.com/library/ms130822.aspx)
* [Подключение клиентов tooa сеанса зеркального отображения базы данных (SQL Server)](https://technet.microsoft.com/library/ms175484.aspx)
* [Подключение tooAvailability прослушиватель группы в гибридной ИТ](http://blogs.msdn.com/b/sqlalwayson/archive/2013/02/14/connecting-to-availability-group-listener-in-hybrid-it.aspx)
* [Прослушиватели групп доступности, возможность подключения клиентов и отработка отказа приложений (SQL Server)](https://technet.microsoft.com/library/hh213417.aspx)
* [Использование строк подключения к зеркально отображаемой базе данных с группами доступности](https://technet.microsoft.com/library/hh213417.aspx)

### <a name="network-latency-in-hybrid-it"></a>Задержки сети в гибридной ИТ-среде
Следует развернуть решение HADR hello предположение, что может быть периоды времени задержки между локальной сетью и Azure. При развертывании tooAzure реплики, следует использовать асинхронную фиксацию вместо одновременной фиксации для режима синхронизации hello. При развертывании серверов зеркального отображения базы данных как в локальной среде и в Azure, используйте режим высокой производительности hello вместо режима высокой безопасности hello.

### <a name="geo-replication-support"></a>Поддержка георепликации
Георепликация на дисках Azure не поддерживает hello файла данных и файлов журналов hello же toobe базы данных, хранящихся на разных дисках. GRS реплицирует изменения на каждом диске независимо и асинхронно. Этот механизм обеспечивает hello порядок записи на одном диске в геореплицированной копии hello, но не для геореплицированных копий нескольких дисков. При настройке toostore базы данных, файла данных и файла журнала на разных дисках, hello восстановления дисков после сбоя может содержать более позднюю копию файла данных hello, чем файла журнала hello, останавливающий выполнение hello упреждающего ведения журнала в SQL Server и hello ACID Свойства транзакции. Если у вас hello параметр toodisable георепликация для учетной записи хранилища hello, необходимо хранить все данные и файлы журналов для базы данных на hello же диска. Если необходимо использовать более одного диска из-за размера toohello hello базы данных, необходимо одно hello решения аварийного восстановления, перечисленных выше избыточность данных tooensure toodeploy.

## <a name="next-steps"></a>Дальнейшие действия
Если вам требуется toocreate виртуальной машине Azure с SQL Server, см. раздел [подготовки виртуальной машины SQL Server в Azure](virtual-machines-windows-portal-sql-server-provision.md).

tooget hello наилучшей производительности SQL Server на Виртуальной машине Azure см. руководство hello в [рекомендации по производительности для SQL Server в виртуальных машинах Azure](virtual-machines-windows-sql-performance.md).

Другие разделы, посвященные toorunning SQL Server в виртуальных машинах Azure, см. в разделе [SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-server-iaas-overview.md).

### <a name="other-resources"></a>Другие ресурсы:
* [Установка нового леса Active Directory в виртуальной сети Azure](../../../active-directory/active-directory-new-forest-virtual-machine.md)
* [Создание отказоустойчивого кластера для групп доступности на виртуальной машине Azure](http://gallery.technet.microsoft.com/scriptcenter/Create-WSFC-Cluster-for-7c207d3a)


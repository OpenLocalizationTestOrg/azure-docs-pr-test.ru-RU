---
title: "Развертывание виртуальной машины Azure с помощью Chef | Документация Майкрософт"
description: "Узнайте, как использовать Chef для автоматизированного развертывания и настройки виртуальных машин в Microsoft Azure."
services: virtual-machines-windows
documentationcenter: 
author: diegoviso
manager: timlt
tags: azure-service-management,azure-resource-manager
editor: 
ms.assetid: 0b82ca70-89ed-496d-bb49-c04ae59b4523
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-multiple
ms.devlang: na
ms.topic: article
ms.date: 05/30/2017
ms.author: diviso
ms.openlocfilehash: b6db0fbb4e0de896994954974ddcc39daad9c125
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="automating-azure-virtual-machine-deployment-with-chef"></a>Автоматизация развертывания виртуальной машины Azure с помощью Chef
[!INCLUDE [learn-about-deployment-models](../../../includes/learn-about-deployment-models-both-include.md)]

Chef — это отличное средство для автоматизации и для настройки требуемого состояния.

После нашего последнего выпуска облачного API средство Chef обеспечивает прозрачную интеграцию с Azure, позволяя подготовить и развернуть состояния конфигурации одной командой.

В этой статье показано, как настроить среду Chef для подготовки виртуальных машин Azure, а также рассматривается пошаговая процедура создания политики или "подробной инструкции", после чего данная инструкция применяется на практике к виртуальной машине Azure.

Итак, начнем!

## <a name="chef-basics"></a>Основы использования Chef
Прежде чем начать, рекомендую вам изучить основные принципы работы со средой Chef. <a href="http://www.chef.io/chef" target="_blank">Вот</a> великолепный материал. Я рекомендую быстро ознакомиться с ним, прежде чем начать работу с данным пошаговым руководством. Однако перед началом работы мы все равно повторим основы.

На приведенной ниже схеме показана высокоуровневая архитектура Chef.

![][2]

Chef имеет три основных компонента архитектуры: сервер Chef, клиент (узел) Chef и рабочая станция Chef.

Сервер Chef является управляющим компонентом и доступен в двух вариантах: размещенное решение или локальное решение. Мы будем использовать размещенное решение.

Клиент Chef (узел) — это агент, который находится на управляемых серверах.

Рабочая станция Chef является нашей рабочей станцией администрирования, где мы создаем политики и выполняем команды управления. Для управления инфраструктурой мы выполняем команду **knife** на рабочей станции Chef.

Кроме того, существует понятие "детальных инструкций" и "рецептов". Фактически, это те политики, которые мы определяем и применяем к своим серверам.

## <a name="preparing-the-workstation"></a>Подготовка рабочей станции
Сначала давайте подготовим рабочую станцию. В данном случае используется стандартная рабочая станция Windows. Необходимо создать каталог для хранения файлов конфигурации и детальных инструкций.

Сначала создайте каталог с именем C:\chef.

Затем создайте каталог C:\chef\cookbooks.

Теперь нам нужно скачать наш файл параметров Azure, чтобы средство Chef могло взаимодействовать с нашей подпиской Azure.

<!--Download your publish settings from [here](https://manage.windowsazure.com/publishsettings/).-->
Скачайте свои параметры публикации с помощью команды PowerShell Azure [Get-AzurePublishSettingsFile](https://docs.microsoft.com/en-us/powershell/module/azure/get-azurepublishsettingsfile?view=azuresmps-4.0.0). 

Сохраните файл параметров публикации в каталоге C:\chef.

## <a name="creating-a-managed-chef-account"></a>Создание управляемой учетной записи Chef
Зарегистрируйте размещенную учетную запись Chef [здесь](https://manage.chef.io/signup).

В процессе регистрации вам будет предложено создать новую организацию.

![][3]

После создания организации скачайте начальный набор.

![][4]

> [!NOTE]
> Если появится предупреждение о том, что ваши ключи будут сброшены, вы можете спокойно продолжить процедуру, так как у вас пока нет никакой настроенной инфраструктуры.
> 
> 

Этот ZIP-файл начального набора содержит ключи и файлы конфигурации вашей организации.

## <a name="configuring-the-chef-workstation"></a>Настройка рабочей станции Chef
Извлеките содержимое файла chef-starter.zip в каталог C:\chef.

Скопируйте все файлы из расположения chef-starter\chef-repo\.chef в каталог C:\chef.

Теперь ваш каталог должен выглядеть, как показано ниже.

![][5]

У вас должно быть четыре файла, включая файл публикации Azure в корне каталога C:\chef.

PEM-файлы содержат закрытые ключи администратора и организации для обеспечения связи, а файл knife.rb содержит конфигурацию knife. Нам потребуется изменить файл knife.rb.

Откройте файл в предпочитаемом вами редакторе и измените путь cookbook_path, удалив из него "/../" и получив следующий вид:

    cookbook_path  ["#{current_dir}/cookbooks"]

Кроме того, добавьте следующие строки с учетом имени своего файла параметров публикации Azure.

    knife[:azure_publish_settings_file] = "yourfilename.publishsettings"

Теперь файл knife.rb должен выглядеть как в показанном ниже примере.

![][6]

Благодаря этим строкам Knife ссылается на каталог подробных инструкций C:\chef\cookbooks, а также использует наш файл параметров публикации Azure во время выполнения операций Azure.

## <a name="installing-the-chef-development-kit"></a>Установка пакета средств разработки Chef
Затем [скачайте и установите](http://downloads.getchef.com/chef-dk/windows) ChefDK (пакет средств разработки Chef) для настройки рабочей станции Chef.

![][7]

Установите пакет в расположение по умолчанию — C:\opscode. Эта установка займет около 10 минут.

Убедитесь, что переменная PATH содержит записи для путей C:\opscode\chefdk\bin, C:\opscode\chefdk\embedded\bin и C:\users\yourusername\.chefdk\gem\ruby\2.0.0\bin.

Если они отсутствуют, обязательно добавьте эти пути!

*ОБРАТИТЕ ВНИМАНИЕ, ЧТО ВАЖЕН ПОРЯДОК ПУТЕЙ!* Если пути opscode указаны в неправильном порядке, возникнут проблемы.

Прежде чем продолжить, перезагрузите рабочую станцию.

Далее мы установим расширение для Knife Azure. Это предоставляет Knife "подключаемый модуль Azure".

Выполните следующую команду:

    chef gem install knife-azure ––pre

> [!NOTE]
> Благодаря аргументу –pre вы получите последнюю версию-кандидат подключаемого модуля Knife для Azure, предоставляющего доступ к актуальному набору API.
> 
> 

Вполне вероятно, что в это же время будет установлен набор зависимостей.

![][8]

Чтобы проверить правильность настройки, выполните следующую команду.

    knife azure image list

Если все настроено правильно, появится прокручиваемый список доступных образов Azure.

Поздравляем! Рабочая станция настроена.

## <a name="creating-a-cookbook"></a>Создание подробной инструкции
Подробная инструкция Chef используется для определения набора команд, которые необходимо выполнить на управляемом клиенте. Создание подробной инструкции не вызывает проблем, поэтому для создания шаблона подробной инструкции мы используем команду **chef generate cookbook** . Мы назовем свою подробную инструкцию именем webserver, так как нам нужна политика, которая автоматически развертывает службы IIS.

В каталоге C:\Chef выполните следующую команду:

    chef generate cookbook webserver

Будет создан набор файлов в каталоге C:\Chef\cookbooks\webserver. Теперь необходимо определить набор команд, который наш клиент Chef должен будет выполнять на управляемой виртуальной машине.

Команды хранятся в файле default.rb. В этом файле мы определим набор команд, который устанавливает службы IIS, запускает их и копирует файл шаблона в папку wwwroot.

Измените файл C:\chef\cookbooks\webserver\recipes\default.rb и добавьте в него указанные ниже строки.

    powershell_script 'Install IIS' do
         action :run
         code 'add-windowsfeature Web-Server'
    end

    service 'w3svc' do
         action [ :enable, :start ]
    end

    template 'c:\inetpub\wwwroot\Default.htm' do
         source 'Default.htm.erb'
         rights :read, 'Everyone'
    end

После завершения работы сохраните файл.

## <a name="creating-a-template"></a>Создание шаблона
Как упоминалось ранее, необходимо создать файл шаблона, который будет использоваться в качестве нашей страницы default.html.

Выполните следующую команду, чтобы создать шаблон:

    chef generate template webserver Default.htm

Перейдите к файлу C:\chef\cookbooks\webserver\templates\default\Default.htm.erb. Добавьте в него простой HTML-код Hello World и сохраните файл.

## <a name="upload-the-cookbook-to-the-chef-server"></a>Передача подробной инструкции на сервер Chef
В этом шаге мы отправляем копию подробной инструкции, созданной на локальном компьютере, на размещенный сервер Chef. После передачи подробная инструкция появится на вкладке **Политика** .

    knife cookbook upload webserver

![][9]

## <a name="deploy-a-virtual-machine-with-knife-azure"></a>Развертывание виртуальной машины с помощью Knife Azure
Теперь мы развернем виртуальную машину Azure и применим подробную инструкцию Webserver, которая установит нашу веб-службу IIS и веб-страницу по умолчанию.

Чтобы сделать это, используйте команду **knife azure server create** .

Пример этой команды приводится ниже.

    knife azure server create --azure-dns-name 'diegotest01' --azure-vm-name 'testserver01' --azure-vm-size 'Small' --azure-storage-account 'portalvhdsxxxx' --bootstrap-protocol 'cloud-api' --azure-source-image 'a699494373c04fc0bc8f2bb1389d6106__Windows-Server-2012-Datacenter-201411.01-en.us-127GB.vhd' --azure-service-location 'Southeast Asia' --winrm-user azureuser --winrm-password 'myPassword123' --tcp-endpoints 80,3389 --r 'recipe[webserver]'

Названия параметров говорят сами за себя. Подставьте свои переменные и запустите команду.

> [!NOTE]
> Мы автоматизируем работу правил сетевых фильтров конечной точки, используя параметр –tcp-endpoints в командной строке. Здесь открыты порты 80 и 3389, чтобы обеспечить доступ к веб-странице и сеансу протокола удаленного рабочего стола.
> 
> 

После выполнения команды перейдите на портал Azure, где можно наблюдать за началом подготовки виртуальной машины.

![][13]

Откроется командная строка.

![][10]

После завершения развертывания мы должны получить возможность подключения к веб-службе через порт 80, так как мы открыли этот порт, когда подготавливали виртуальную машину с помощью команды Knife Azure. Поскольку эта виртуальная машина — единственная в моей облачной службе, я подключусь к ней по URL-адресу облачной службы.

![][11]

Здесь вы могли наблюдать пример творческого подхода к написанию кода.

Не забывайте, что можно также подключиться через сеанс протокола удаленного рабочего стола с портала Azure через порт 3389.

Надеюсь, что эта информация была для вас полезной! Начинайте использовать подход "инфраструктура как код" прямо сейчас с помощью Azure!

<!--Image references-->
[2]: media/chef-automation/2.png
[3]: media/chef-automation/3.png
[4]: media/chef-automation/4.png
[5]: media/chef-automation/5.png
[6]: media/chef-automation/6.png
[7]: media/chef-automation/7.png
[8]: media/chef-automation/8.png
[9]: media/chef-automation/9.png
[10]: media/chef-automation/10.png
[11]: media/chef-automation/11.png
[13]: media/chef-automation/13.png


<!--Link references-->

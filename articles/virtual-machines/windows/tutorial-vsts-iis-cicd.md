---
title: "Создание конвейера CI/CD в Azure с помощью служб Team Services | Документация Майкрософт"
description: "Сведения о создании с помощью Visual Studio Team Services конвейера для непрерывной интеграции и доставки, который выполняет развертывание веб-приложения в IIS на виртуальной машине Windows"
services: virtual-machines-windows
documentationcenter: virtual-machines
author: iainfoulds
manager: timlt
editor: tysonn
tags: azure-resource-manager
ms.assetid: 
ms.service: virtual-machines-windows
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure
ms.date: 05/12/2017
ms.author: iainfou
ms.custom: mvc
ms.openlocfilehash: a587f58fad2ec74c7633823c4d34f900e7c01f7e
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="create-a-continuous-integration-pipeline-with-visual-studio-team-services-and-iis"></a>Создание конвейера для непрерывной интеграции с помощью Visual Studio Team Services и IIS
Чтобы автоматизировать этапы создания, тестирования и развертывания проекта приложения, вы можете использовать конвейер для непрерывной интеграции и развертывания (CI/CD). В рамках этого руководства вы создадите конвейер CI/CD с помощью Visual Studio Team Services и виртуальной машины Windows в Azure, где выполняются службы IIS. Вы узнаете, как выполнять такие задачи.

> [!div class="checklist"]
> * Публикация веб-приложения ASP.NET в проекте Team Services.
> * создавать определение сборки, которое активируется фиксациями кода;
> * устанавливать и настраивать IIS на виртуальной машине в Azure;
> * добавлять экземпляр IIS в группу развертывания в Team Services;
> * создавать определение выпуска для публикации новых пакетов веб-развертывания в IIS;
> * Тестирование конвейера CI/CD

Для работы с этим руководством требуется модуль Azure PowerShell версии не ниже 3.6. Чтобы узнать версию, выполните команду `Get-Module -ListAvailable AzureRM`. Если вам необходимо выполнить обновление, ознакомьтесь со статьей, посвященной [установке модуля Azure PowerShell](/powershell/azure/install-azurerm-ps).


## <a name="create-project-in-team-services"></a>Создание проекта в Team Services
Visual Studio Team Services обеспечивает совместную работу и разработку без необходимости обслуживания решения для управления локальным кодом. Team Services также позволяет выполнять тестирование кода в облака, а также создавать и анализировать приложение. Вы можете выбрать интегрированную среду разработки и репозиторий системы управления версиями, которые лучше всего подходят для вашего сценария разработки кода. В рамках этого руководства вы можете использовать бесплатную учетную запись, чтобы создать базовое веб-приложение ASP.NET и конвейер CI/CD. Если у вас еще нет учетной записи Team Services, [создайте ее](http://go.microsoft.com/fwlink/?LinkId=307137).

Чтобы управлять процессом фиксации кода, определениями сборки и выпуска, создайте проект в Team Services следующим образом:

1. В браузере откройте панель мониторинга Team Services и выберите **Новый проект**.
2. Введите *myWebApp* для **имени проекта**. Оставьте все остальные значения по умолчанию, чтобы использовать управление версиями *Git* и процесс рабочих элементов *Agile*.
3. Выберите параметр для **совместного использования** с *участниками команды*, а затем выберите **Создать**.
5. После создания проекта выберите параметр для **инициализации с файлом сведений или GITIGNORE-файлом**, а затем щелкните **Инициализировать**.
6. Внутри нового проекта выберите **Панели мониторинга** в верхней области, а затем — **Открыть в Visual Studio**.


## <a name="create-aspnet-web-application"></a>Создание веб-приложения ASP.NET
На предыдущем шаге вы создали проект в Team Services. На последнем шаге новый проект открывается в Visual Studio. Управление фиксациями кода выполняется в окне **Team Explorer**. Создайте локальную копию нового проекта, а затем создайте веб-приложение ASP.NET из шаблона, как показано ниже.

1. Нажмите кнопку **Клонировать**, чтобы создать локальный репозиторий Git проекта Team Services.
    
    ![Клонирование репозитория из проекта Team Services](media/tutorial-vsts-iis-cicd/clone_repo.png)

2. В разделе **Решения** выберите **Создать**.

    ![Создание решения веб-приложения](media/tutorial-vsts-iis-cicd/new_solution.png)

3. Выберите шаблоны **Веб**, а затем выберите шаблон **Веб-приложение ASP.NET**.
    1. Введите имя приложения, например *myWebApp*, а затем снимите флажок для параметра **Создать каталог для решения**.
    2. Снимите флажок для параметра **Добавить Application Insights в проект**, если он доступен. Вам потребуется авторизовать веб-приложение в Azure Application Insights. Чтобы упростить работу с этим руководством, пропустите этот процесс.
    3. Нажмите кнопку **ОК**.
4. Из списка шаблонов выберите **MVC**.
    1. Выберите **Изменить способ проверки подлинности**, затем — **Нет проверки подлинности** и нажмите кнопку **ОК**.
    2. Нажмите кнопку **ОК**, чтобы создать решение.
5. В окне **Team Explorer** выберите **Изменения**.

    ![Фиксация локальных изменений в репозитории Git в Team Services](media/tutorial-vsts-iis-cicd/commit_changes.png)

6. В текстовом поле фиксации введите сообщение, например *Начальная фиксация*. В раскрывающемся меню выберите **Зафиксировать все и синхронизировать**.


## <a name="create-build-definition"></a>Создание определения сборки
Вы используете определение сборки в Team Services, чтобы обозначить, как должно быть создано приложение. В рамках этого руководства мы создадим базовое определение, которое выполняет сборку решения на основе исходного кода, а затем создает пакет веб-развертывания, который мы можем использовать для запуска веб-приложения на сервере IIS.

1. В проекте Team Services выберите **Сборка и выпуск** в верхней области, а затем — **Сборки**.
3. Выберите **+ Новое определение**.
4. Выберите шаблон **ASP.NET (предварительная версия)**, а затем щелкните **Применить**.
5. Оставьте все значения задач по умолчанию. В разделе **Получить исходные коды** выберите репозиторий *myWebApp* и *главную* ветвь.

    ![Создание определения сборки в проекте Team Services](media/tutorial-vsts-iis-cicd/create_build_definition.png)

6. На вкладке **Триггеры** переместите ползунок для параметра **включения триггера** в значение *Включено*.
7. Сохраните определение сборки и поместите в очередь новую сборку, выбрав **Сохранить и поместить в очередь**, а затем **снова выберите этот параметр**. Оставьте остальные значения по умолчанию, а затем выберите **Очередь**.

Просмотрите, как планируется выполнение сборки на размещенном агенте и как выполняется сам процесс сборки. Вы должны увидеть результат, аналогичный приведенному ниже.

![Успешная сборка проекта Team Services](media/tutorial-vsts-iis-cicd/successful_build.png)


## <a name="create-virtual-machine"></a>Создание виртуальной машины
Чтобы предоставить платформу для выполнения веб-приложения ASP.NET, вам необходима виртуальная машина Windows, где выполняются службы IIS. Team Services использует агент для взаимодействия с экземпляром IIS после фиксации кода и активации сборок.

Создайте виртуальную машину Windows Server 2016 с помощью [этого примера скрипта](../scripts/virtual-machines-windows-powershell-sample-create-vm.md?toc=%2fpowershell%2fmodule%2ftoc.json). Выполнение скрипта и создание виртуальной машины занимает несколько минут. После создания виртуальной машины откройте порт 80 для веб-трафика с помощью команды [Add-AzureRmNetworkSecurityRuleConfig](/powershell/module/azurerm.resources/new-azurermresourcegroup), как показано ниже.

```powershell
Get-AzureRmNetworkSecurityGroup `
  -ResourceGroupName $resourceGroup `
  -Name "myNetworkSecurityGroup" | `
Add-AzureRmNetworkSecurityRuleConfig `
  -Name "myNetworkSecurityGroupRuleWeb" `
  -Protocol "Tcp" `
  -Direction "Inbound" `
  -Priority "1001" `
  -SourceAddressPrefix "*" `
  -SourcePortRange "*" `
  -DestinationAddressPrefix "*" `
  -DestinationPortRange "80" `
  -Access "Allow" | `
Set-AzureRmNetworkSecurityGroup
```

Чтобы подключиться к виртуальной машине, получите общедоступный IP-адрес с помощью команды [Get-AzureRmPublicIpAddress](/powershell/module/azurerm.network/get-azurermpublicipaddress), как показано ниже.

```powershell
Get-AzureRmPublicIpAddress -ResourceGroupName $resourceGroup | Select IpAddress
```

Создайте сеанс подключения к удаленному рабочему столу виртуальной машины:

```cmd
mstsc /v:<publicIpAddress>
```

На виртуальной машине откройте окно командной строки **PowerShell с правами администратора**. Установите IIS и необходимые компоненты .NET, как показано ниже.

```powershell
Install-WindowsFeature Web-Server,Web-Asp-Net45,NET-Framework-Features
```


## <a name="create-deployment-group"></a>Создание группы развертывания
Чтобы передать пакет веб-развертывания на сервер IIS, вам необходимо определить группу развертывания в Team Services. Эта группа позволяет указать, какие серверы являются целевыми серверами новых сборок после фиксации кода в Team Services и завершения сборок.

1. В Team Services выберите **Сборка и выпуск**, а затем — **Группы развертываний**.
2. Выберите **Добавить группу развертывания**.
3. Введите имя группы, например *myIIS*, а затем выберите **Создать**.
4. В разделе **Регистрация компьютеров** выберите *Windows*, а затем установите флажок для параметра **использования личного маркера доступа в скрипте для проверки подлинности**.
5. Выберите параметр **Copy script to clipboard** (Копировать скрипт в буфер обмена).


### <a name="add-iis-vm-to-the-deployment-group"></a>Добавление виртуальной машины с IIS в группу развертывания
Добавьте каждый экземпляр IIS в созданную группу развертывания. Team Services создает скрипт, который загружает и настраивает агент на виртуальной машине, которая получает новые пакеты веб-развертывания, а затем применяет их к IIS.

1. Вернитесь в сеанс **PowerShell с правами администратора**, запущенный на виртуальной машине, вставьте и запустите скрипт, скопированный из Team Services.
2. При появлении запроса на настройку тегов для агента выберите *Y* и введите *web*.
3. При появлении запроса на указание учетной записи пользователя щелкните *Возврат*, чтобы принять значения по умолчанию.
4. Ожидайте сообщение о завершении выполнения скрипта — *Служба vstsagent.account.computername успешно запущена*.
5. На странице **групп развертывания** меню **сборки и выпуска** откройте группу развертывания *myIIS*. Убедитесь, что ваша виртуальная машина находится в списке на вкладке **Компьютеры**.

    ![Виртуальная машина успешно добавлена в группу развертывания Team Services](media/tutorial-vsts-iis-cicd/deployment_group.png)


## <a name="create-release-definition"></a>Создание определения выпуска
Чтобы опубликовать сборки, создайте определение выпуска в Team Services. Это определение запускается автоматически при успешной сборке приложения. Вам необходимо выбрать группу развертывания, в которую требуется опубликовать пакет веб-развертывания, а также определить соответствующие параметры IIS.

1. Выберите **Сборка и выпуск**, а затем — **Сборки**. Выберите определение сборки, созданное на предыдущем шаге.
2. В разделе **Недавно завершенные** выберите последнюю сборку, а затем — **Версия**.
3. Щелкните **Да**, чтобы создать определение выпуска.
4. Выберите шаблон **Пустой**, а затем щелкните **Далее**.
5. Параметры проекта и определения сборки источника должны быть заполнены данными вашего проекта.
6. Установите флажок для параметра **Непрерывное развертывание**, а затем выберите **Создать**.
7. Щелкните раскрывающийся список рядом с параметром **+ Добавить задачи** и выберите *Добавить этап группы развертывания*.
    
    ![Добавление задачи в определение выпуска в Team Services](media/tutorial-vsts-iis-cicd/add_release_task.png)

8. Выберите **Добавить** рядом с **IIS Web App Deploy(Preview)** (Развертывание веб-приложения IIS (предварительная версия)), а затем выберите **Закрыть**.
9. Выберите родительскую задачу **Запуск в группе развертывания**.
    1. Для **группы развертывания** выберите ранее созданную группу развертывания, например *myIIS*.
    2. В поле **Теги компьютера** выберите **Добавить**, а затем выберите тег *web*.
    
    ![Задача группы развертывания определения выпуска для IIS](media/tutorial-vsts-iis-cicd/release_definition_iis.png)
 
11. Выберите задачу **развертывания веб-приложения IIS**, чтобы настроить параметры экземпляра IIS, как показано ниже.
    1. Для **имени веб-сайта** введите *Веб-сайт по умолчанию*.
    2. Оставьте все остальные параметры по умолчанию.
12. Щелкните **Сохранить**, а затем дважды нажмите кнопку **ОК**.


## <a name="create-a-release-and-publish"></a>Создание выпуска и публикация
Теперь вы можете отправить пакет веб-развертывания как новый выпуск. На этом шаге выполняется взаимодействие с агентом в каждом экземпляре, который является частью группы развертывания, отправка пакета веб-развертывания, а затем настройка IIS для выполнения обновленного веб-приложения.

1. В определении выпуска выберите **+ Выпуск**, затем выберите **Создать выпуск**.
2. В раскрывающемся списке выберите последнюю сборку, а также триггер **Автоматическое развертывание: после создания выпуска**. Нажмите кнопку **Создать**.
3. В верхней области определения выпуска появится небольшой баннер, например *Создан выпуск 1*. Выберите ссылку выпуска.
4. Откройте вкладку **Журналы**, чтобы просмотреть состояние выпуска.
    
    ![Успешное создание выпуска Team Services и отправка пакета веб-развертывания](media/tutorial-vsts-iis-cicd/successful_release.png)

5. После создания выпуска откройте браузер и введите общедоступный IP-адрес виртуальной машины. Вы увидите, что веб-приложение ASP.NET выполняется.

    ![Выполнение веб-приложения ASP.NET на виртуальной машине IIS](media/tutorial-vsts-iis-cicd/running_web_app.png)


## <a name="test-the-whole-cicd-pipeline"></a>Тестирование всего конвейера CI/CD
Теперь, когда у вас есть веб-приложение, выполняющееся на IIS, запустите конвейер CI/CD. После внесения изменений в Visual Studio и фиксации кода активируется сборка, которая затем запускает выпуск обновленного пакета веб-развертывания в IIS:

1. В Visual Studio откройте окно **обозревателя решений**.
2. Выберите *myWebApp | Views | Home | Index.cshtml*.
3. Измените строку 6 на следующую:

    `<h1>ASP.NET with VSTS and CI/CD!</h1>`

4. Сохраните файл.
5. Откройте окно **Team Explorer** и выберите проект *myWebApp*, а затем — **Изменения**.
6. Введите сообщение фиксации, например *Тестирование конвейера CI/CD*, а затем в раскрывающемся меню выберите **Зафиксировать все и синхронизировать**.
7. В рабочей области Team Services новая сборка активируется из фиксации кода. 
    - Выберите **Сборка и выпуск**, а затем — **Сборки**. 
    - Выберите свое определение сборки, а затем выберите сборку **В очереди и выполняется** для отслеживания процесса сборки.
9. После успешного выполнения сборки активируется новый выпуск.
    - Выберите **Сборка и выпуск**, а затем — **Выпуски**, чтобы увидеть пакет веб-развертывания, отправленный на виртуальную машину IIS. 
    - Щелкните значок **обновления**, чтобы обновить состояние. Появление в столбце *сред* зеленой галочки означает успешное развертывание выпуска в IIS.
11. Чтобы увидеть, что изменения применены, обновите веб-сайт IIS в браузере.

    ![Выполнение веб-приложения ASP.NET на виртуальной машине IIS из конвейера CI/CD](media/tutorial-vsts-iis-cicd/running_web_app_cicd.png)


## <a name="next-steps"></a>Дальнейшие действия

В рамках этого руководства вы создали веб-приложение ASP.NET в Team Services, а также настроили определения сборки и выпуска для развертывания новых пакетов веб-развертывания в IIS для каждой фиксации кода. Вы научились выполнять следующие задачи:

> [!div class="checklist"]
> * публиковать веб-приложение ASP.NET в проекте Team Services;
> * создавать определение сборки, которое активируется фиксациями кода;
> * устанавливать и настраивать IIS на виртуальной машине в Azure;
> * добавлять экземпляр IIS в группу развертывания в Team Services;
> * создавать определение выпуска для публикации новых пакетов веб-развертывания в IIS;
> * Тестирование конвейера CI/CD

Перейдите к следующему руководству, чтобы узнать, как защитить веб-сервер с помощью SSL-сертификата.

> [!div class="nextstepaction"]
> [Secure a web server with SSL certificates on a Linux virtual machine in Azure](tutorial-secure-web-server.md) (Защита веб-сервера на виртуальной машине Linux в облаке Azure с помощью SSL-сертификата)
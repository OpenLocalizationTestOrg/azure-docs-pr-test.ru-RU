---
title: "Добавление средств мониторинга и диагностики в виртуальную машину Azure | Документация Майкрософт"
description: "Используйте шаблон диспетчера ресурсов Azure, чтобы создать виртуальную машину Windows с помощью расширения системы диагностики Azure."
services: virtual-machines-windows
documentationcenter: 
author: sbtron
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 8cde8fe7-977b-43d2-be74-ad46dc946058
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: article
ms.date: 05/31/2017
ms.author: saurabh
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 6955e3d8c7b032ee898be11e611080905b5069ba
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="use-monitoring-and-diagnostics-with-a-windows-vm-and-azure-resource-manager-templates"></a><span data-ttu-id="00a0e-103">Использование мониторинга и системы диагностики с виртуальной машиной Windows и шаблонами Azure Resource Manager</span><span class="sxs-lookup"><span data-stu-id="00a0e-103">Use monitoring and diagnostics with a Windows VM and Azure Resource Manager templates</span></span>
<span data-ttu-id="00a0e-104">Расширение системы диагностики Azure позволяет использовать возможности мониторинга и диагностики в виртуальной машине Azure под управлением Windows.</span><span class="sxs-lookup"><span data-stu-id="00a0e-104">The Azure Diagnostics Extension provides the monitoring and diagnostics capabilities on a Windows based Azure virtual machine.</span></span> <span data-ttu-id="00a0e-105">Чтобы использовать эти возможности на виртуальной машине, необходимо включить расширение в шаблон диспетчера ресурсов Azure.</span><span class="sxs-lookup"><span data-stu-id="00a0e-105">You can enable these capabilities on the virtual machine by including the extension as part of the azure resource manager template.</span></span> <span data-ttu-id="00a0e-106">Дополнительные сведения о включении любого расширения в шаблон виртуальной машины см. в статье [Создание шаблонов диспетчера ресурсов Azure с расширениями виртуальных машин](template-description.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json#extensions).</span><span class="sxs-lookup"><span data-stu-id="00a0e-106">See [Authoring Azure Resource Manager Templates with VM Extensions](template-description.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json#extensions) for more information on including any extension as part of a virtual machine template.</span></span> <span data-ttu-id="00a0e-107">В этой статье описывается, как добавить расширение системы диагностики Azure в шаблон виртуальной машины Windows.</span><span class="sxs-lookup"><span data-stu-id="00a0e-107">This article describes how you can add the Azure Diagnostics extension to a windows virtual machine template.</span></span>  

## <a name="add-the-azure-diagnostics-extension-to-the-vm-resource-definition"></a><span data-ttu-id="00a0e-108">Добавление расширения системы диагностики Azure в определения ресурсов виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="00a0e-108">Add the Azure Diagnostics extension to the VM resource definition</span></span>
<span data-ttu-id="00a0e-109">Чтобы использовать расширение системы диагностики в виртуальной машине Windows, необходимо добавить его в шаблон диспетчера ресурсов в качестве ресурса виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="00a0e-109">To enable the diagnostics extension on a Windows Virtual Machine you need to add the extension as a VM resource in the Resource manager template.</span></span>

<span data-ttu-id="00a0e-110">Для простой виртуальной машины на основе диспетчера ресурсов добавьте конфигурацию расширения в массив *resources* для соответствующей виртуальной машины:</span><span class="sxs-lookup"><span data-stu-id="00a0e-110">For a simple Resource Manager based Virtual Machine add the extension configuration to the *resources* array for the Virtual Machine:</span></span> 

    "resources": [
                {
                    "name": "Microsoft.Insights.VMDiagnosticsSettings",
                    "type": "extensions",
                    "location": "[resourceGroup().location]",
                    "apiVersion": "2015-06-15",
                    "dependsOn": [
                        "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
                    ],
                    "tags": {
                        "displayName": "AzureDiagnostics"
                    },
                    "properties": {
                        "publisher": "Microsoft.Azure.Diagnostics",
                        "type": "IaaSDiagnostics",
                        "typeHandlerVersion": "1.5",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                            "xmlCfg": "[base64(concat(variables('wadcfgxstart'), variables('wadmetricsresourceid'), variables('vmName'), variables('wadcfgxend')))]",
                            "storageAccount": "[parameters('existingdiagnosticsStorageAccountName')]"
                        },
                        "protectedSettings": {
                            "storageAccountName": "[parameters('existingdiagnosticsStorageAccountName')]",
                            "storageAccountKey": "[listkeys(variables('accountid'), '2015-05-01-preview').key1]",
                            "storageAccountEndPoint": "https://core.windows.net"
                        }
                    }
                }
            ]


<span data-ttu-id="00a0e-111">Другой распространенный способ — добавить конфигурацию расширения в корневой узел ресурсов шаблона, не определяя ее в узле ресурсов виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="00a0e-111">Another common convention is add the extension configuration at the root resources node of the template instead of defining it under the virtual machine's resources node.</span></span> <span data-ttu-id="00a0e-112">При таком подходе необходимо явно указать иерархические связи между расширением и виртуальной машиной с помощью значений *name* и *type*.</span><span class="sxs-lookup"><span data-stu-id="00a0e-112">With this approach you have to explicitly specify a hierarchical relation between the extension and the virtual machine with the *name* and *type* values.</span></span> <span data-ttu-id="00a0e-113">Например:</span><span class="sxs-lookup"><span data-stu-id="00a0e-113">For example:</span></span> 

    "name": "[concat(variables('vmName'),'Microsoft.Insights.VMDiagnosticsSettings')]",
    "type": "Microsoft.Compute/virtualMachines/extensions",

<span data-ttu-id="00a0e-114">Расширение всегда связано с виртуальной машиной. Его можно определить непосредственно в узле ресурсов виртуальной машины или на базовом уровне и связать его с виртуальной машиной с помощью соглашения об иерархическом именовании.</span><span class="sxs-lookup"><span data-stu-id="00a0e-114">The extension is always associated with the virtual machine, you can either directly define it under the virtual machine's resource node directly or define it at the base level and use the hierarchical naming convention to associate it with the virtual machine.</span></span>

<span data-ttu-id="00a0e-115">Для масштабируемых наборов виртуальных машин конфигурация расширений указывается в свойстве *extensionProfile* параметра *VirtualMachineProfile*.</span><span class="sxs-lookup"><span data-stu-id="00a0e-115">For Virtual Machine Scale Sets the extensions configuration is specified in the *extensionProfile* property of the *VirtualMachineProfile*.</span></span>

<span data-ttu-id="00a0e-116">Свойство *publisher* со значением **Microsoft.Azure.Diagnostics** и *type* со значением **IaaSDiagnostics** уникальным образом определяет расширение системы диагностики Azure.</span><span class="sxs-lookup"><span data-stu-id="00a0e-116">The *publisher* property with the value of **Microsoft.Azure.Diagnostics** and the *type* property with the value of **IaaSDiagnostics** uniquely identify the Azure Diagnostics extension.</span></span>

<span data-ttu-id="00a0e-117">Значение свойства *name* можно использовать для обращения к расширению в группе ресурсов.</span><span class="sxs-lookup"><span data-stu-id="00a0e-117">The value of the *name* property can be used to refer to the extension in the resource group.</span></span> <span data-ttu-id="00a0e-118">Если задать значение **Microsoft.Insights.VMDiagnosticsSettings**, портал Azure сможет легко определить это расширение и диаграммы мониторинга будут отображаться правильно на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="00a0e-118">Setting it specifically to **Microsoft.Insights.VMDiagnosticsSettings** will enable it to be easily identified by the Azure portal ensuring that the monitoring charts show up correctly in the Azure portal.</span></span>

<span data-ttu-id="00a0e-119">Значение *typeHandlerVersion* указывает версию расширения, которую нужно использовать.</span><span class="sxs-lookup"><span data-stu-id="00a0e-119">The *typeHandlerVersion* specifies the version of the extension you would like to use.</span></span> <span data-ttu-id="00a0e-120">Если задать для параметра дополнительного номера версии *autoUpgradeMinorVersion* значение **true** , вы будете получать последний доступный дополнительный номер версии расширения.</span><span class="sxs-lookup"><span data-stu-id="00a0e-120">Setting *autoUpgradeMinorVersion* minor version to **true** ensures that you will get the latest Minor version of the extension that is available.</span></span> <span data-ttu-id="00a0e-121">Рекомендуется всегда указывать для параметра *autoUpgradeMinorVersion* значение **true** , чтобы иметь возможность использовать последнее доступное расширение системы диагностики со всеми новыми функциями и исправлениями ошибок.</span><span class="sxs-lookup"><span data-stu-id="00a0e-121">It is highly recommended that you always set *autoUpgradeMinorVersion* to always be **true** so that you always get to use the latest available diagnostics extension with all the new features and bug fixes.</span></span> 

<span data-ttu-id="00a0e-122">Элемент *settings* содержит свойства конфигураций для расширения, которые можно задать и считывать с расширения (иногда они называются открытой конфигурацией).</span><span class="sxs-lookup"><span data-stu-id="00a0e-122">The *settings* element contains configurations properties for the extension that can be set and read back from the extension (sometimes referred to as public configuration).</span></span> <span data-ttu-id="00a0e-123">Свойство *xmlcfg* содержит конфигурацию в формате XML для журналов диагностики, счетчиков производительности и т. д., данные которых будет собирать агент диагностики.</span><span class="sxs-lookup"><span data-stu-id="00a0e-123">The *xmlcfg* property contains xml based configuration for the diagnostics logs, performance counters etc that will be collected by the diagnostics agent.</span></span> <span data-ttu-id="00a0e-124">Дополнительные сведения о схеме XML см. в разделе [Схема конфигурации системы диагностики](https://msdn.microsoft.com/library/azure/dn782207.aspx).</span><span class="sxs-lookup"><span data-stu-id="00a0e-124">See [Diagnostics Configuration Schema](https://msdn.microsoft.com/library/azure/dn782207.aspx) for more information about the xml schema itself.</span></span> <span data-ttu-id="00a0e-125">Традиционно конфигурации в формате XML хранятся в качестве переменных в шаблоне диспетчера ресурсов Azure, после чего они объединяются и шифруются в кодировке base64, чтобы задать значение для *xmlcfg*.</span><span class="sxs-lookup"><span data-stu-id="00a0e-125">A common practice is to store the actual xml configuration as a variable in the Azure Resource Manager template and then concatenate and base64 encode them to set the value for *xmlcfg*.</span></span> <span data-ttu-id="00a0e-126">Дополнительные сведения о способах хранения конфигурации в формате XML в качестве переменных см. в разделе [Переменные конфигурации диагностики](#diagnostics-configuration-variables).</span><span class="sxs-lookup"><span data-stu-id="00a0e-126">See the section on [diagnostics configuration variables](#diagnostics-configuration-variables) to understand more about how to store the xml in variables.</span></span> <span data-ttu-id="00a0e-127">Свойство *storageAccount* указывает имя учетной записи хранения, в которую будут передаваться диагностические данные.</span><span class="sxs-lookup"><span data-stu-id="00a0e-127">The *storageAccount* property specifies the name of the storage account to which diagnostics data will be transferred.</span></span> 

<span data-ttu-id="00a0e-128">Свойства в параметре *protectedSettings* (иногда называются закрытой конфигурацией) можно задать, но затем невозможно считать.</span><span class="sxs-lookup"><span data-stu-id="00a0e-128">The properties in *protectedSettings* (sometimes referred to as private configuration) can be set but cannot be read back after being set.</span></span> <span data-ttu-id="00a0e-129">Благодаря тому, что параметр *protectedSettings* предназначен только для записи, он подходит для хранения секретных данных, например ключа учетной записи хранения, в которую будут записываться диагностические данные.</span><span class="sxs-lookup"><span data-stu-id="00a0e-129">The write-only nature of *protectedSettings* makes it useful for storing secrets like the storage account key where the diagnostics data will be written.</span></span>    

## <a name="specifying-diagnostics-storage-account-as-parameters"></a><span data-ttu-id="00a0e-130">Указание учетной записи хранения диагностических данных в качестве параметра</span><span class="sxs-lookup"><span data-stu-id="00a0e-130">Specifying diagnostics storage account as parameters</span></span>
<span data-ttu-id="00a0e-131">Во фрагменте кода JSON расширения системы диагностики выше предполагается использование параметров *existingdiagnosticsStorageAccountName* и *existingdiagnosticsStorageAccountName* для указания учетной записи хранения диагностических данных.</span><span class="sxs-lookup"><span data-stu-id="00a0e-131">The diagnostics extension json snippet above assumes two parameters *existingdiagnosticsStorageAccountName* and *existingdiagnosticsStorageResourceGroup* to specify the diagnostics storage account where diagnostics data will be stored.</span></span> <span data-ttu-id="00a0e-132">Если указать учетную запись хранения диагностических данных в качестве параметра, это упрощает процесс смены учетной записи хранения диагностических данных в различных средах. Например, может потребоваться использовать разные учетные записи хранения диагностических данных для тестирования и развертывания в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="00a0e-132">Specifying the diagnostics storage account as a parameter makes it easy to change the diagnostics storage account across different environments e.g. you may want to use a different diagnostics storage account for testing and a different one for your production deployment.</span></span>  

        "existingdiagnosticsStorageAccountName": {
            "type": "string",
            "metadata": {
        "description": "The name of an existing storage account to which diagnostics data will be transfered."
            }        
        },
        "existingdiagnosticsStorageResourceGroup": {
            "type": "string",
            "metadata": {
        "description": "The resource group for the storage account specified in existingdiagnosticsStorageAccountName"
              }
        }

<span data-ttu-id="00a0e-133">Рекомендуется указать учетную запись хранения диагностических данных в группе ресурсов, отличной от группы ресурсов для виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="00a0e-133">It is best practice to specify a diagnostics storage account in a different resource group than the resource group for the virtual machine.</span></span> <span data-ttu-id="00a0e-134">Группа ресурсов может считаться единицей развертывания с отдельным временем существования, а виртуальную машину можно развернуть, а затем повторно развернуть после соответствующих обновлений конфигураций. Но диагностические данные можно продолжить хранить в одной учетной записи в этих развертываниях виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="00a0e-134">A resource group can be considered to be a deployment unit with its own lifetime, a virtual machine can be deployed and redeployed as new configurations updates are made it to it but you may want to continue storing the diagnostics data in the same storage account across those virtual machine deployments.</span></span> <span data-ttu-id="00a0e-135">Если разместить учетную запись хранения в другом ресурсе, она может получать данные из различных развертываний виртуальных машин, что упрощает устранение неполадок в разных версиях.</span><span class="sxs-lookup"><span data-stu-id="00a0e-135">Having the storage account in a different resource enables the storage account to accept data from various virtual machine deployments making it easy to troubleshoot issues across the various versions.</span></span>

> [!NOTE]
> <span data-ttu-id="00a0e-136">При создании шаблона виртуальной машины Windows в Visual Studio для учетной записи хранения по умолчанию может быть настроено использование учетной записи хранения, в которую добавляется виртуальный жесткий диск виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="00a0e-136">If you create a windows virtual machine template from Visual Studio the default storage account might be set to use the same storage account where the virtual machine VHD is uploaded.</span></span> <span data-ttu-id="00a0e-137">Это позволяет упростить начальную настройку виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="00a0e-137">This is to simplify initial setup of the VM.</span></span> <span data-ttu-id="00a0e-138">Чтобы использовать другую учетную запись хранения, которую можно передать в качестве параметра, следует выполнить рефакторинг шаблона.</span><span class="sxs-lookup"><span data-stu-id="00a0e-138">You should re-factor the template to use a different storage account that can be passed in as a parameter.</span></span> 
> 
> 

## <a name="diagnostics-configuration-variables"></a><span data-ttu-id="00a0e-139">Переменные конфигурации диагностики</span><span class="sxs-lookup"><span data-stu-id="00a0e-139">Diagnostics configuration variables</span></span>
<span data-ttu-id="00a0e-140">Во фрагменте кода JSON расширения системы диагностики выше определена переменная *accountid* , позволяющая упростить получение ключа учетной записи хранения для хранилища диагностических данных:</span><span class="sxs-lookup"><span data-stu-id="00a0e-140">The diagnostics extension json snippet above defines an *accountid* variable to simplify getting the storage account key for the diagnostics storage:</span></span>   

    "accountid": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/',parameters('existingdiagnosticsStorageResourceGroup'), '/providers/','Microsoft.Storage/storageAccounts/', parameters('existingdiagnosticsStorageAccountName'))]"


<span data-ttu-id="00a0e-141">Свойство *xmlcfg* расширения системы диагностики определено путем использования нескольких объединенных переменных.</span><span class="sxs-lookup"><span data-stu-id="00a0e-141">The *xmlcfg* property for the diagnostics extension is defined using multiple variables that are concatenated together.</span></span> <span data-ttu-id="00a0e-142">Значения этих переменных находятся в формате XML, поэтому при настройке переменных JSON их необходимо должным образом экранировать.</span><span class="sxs-lookup"><span data-stu-id="00a0e-142">The values of these variables are in xml so they need to be escaped correctly when setting the json variables.</span></span>

<span data-ttu-id="00a0e-143">Во фрагменте кода ниже приведен XML-файл конфигурации диагностики, который собирает данные стандартных системных счетчиков производительности и некоторые журналы событий и инфраструктуры диагностики Windows.</span><span class="sxs-lookup"><span data-stu-id="00a0e-143">The following describes the diagnostics configuration xml that collects standard system level performance counters along with some windows event logs and diagnostics infrastructure logs.</span></span> <span data-ttu-id="00a0e-144">Он экранирован должным образом и написан в правильном формате, поэтому конфигурацию можно вставлять непосредственно в раздел переменных шаблона.</span><span class="sxs-lookup"><span data-stu-id="00a0e-144">It has been escaped and formatted correctly so that the configuration can directly be pasted into the variables section of your template.</span></span> <span data-ttu-id="00a0e-145">Дополнительные примеры XML-файлов конфигурации в формате, удобном для чтения, см. в разделе [Схема конфигурации системы диагностики](https://msdn.microsoft.com/library/azure/dn782207.aspx).</span><span class="sxs-lookup"><span data-stu-id="00a0e-145">See the [Diagnostics Configuration Schema](https://msdn.microsoft.com/library/azure/dn782207.aspx) for a more human readable example of the configuration xml.</span></span>

        "wadlogs": "<WadCfg> <DiagnosticMonitorConfiguration overallQuotaInMB=\"4096\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration\"> <DiagnosticInfrastructureLogs scheduledTransferLogLevelFilter=\"Error\"/> <WindowsEventLog scheduledTransferPeriod=\"PT1M\" > <DataSource name=\"Application!*[System[(Level = 1 or Level = 2)]]\" /> <DataSource name=\"Security!*[System[(Level = 1 or Level = 2)]]\" /> <DataSource name=\"System!*[System[(Level = 1 or Level = 2)]]\" /></WindowsEventLog>",
        "wadperfcounters1": "<PerformanceCounters scheduledTransferPeriod=\"PT1M\"><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Processor Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU utilization\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Privileged Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU privileged time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% User Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"CPU user time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Processor Information(_Total)\\Processor Frequency\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"CPU frequency\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\System\\Processes\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Processes\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Process(_Total)\\Thread Count\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Threads\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Process(_Total)\\Handle Count\" sampleRate=\"PT15S\" unit=\"Count\"><annotation displayName=\"Handles\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\% Committed Bytes In Use\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Memory usage\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Available Bytes\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory available\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Committed Bytes\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory committed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Commit Limit\" sampleRate=\"PT15S\" unit=\"Bytes\"><annotation displayName=\"Memory commit limit\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active time\" locale=\"en-us\"/></PerformanceCounterConfiguration>",
        "wadperfcounters2": "<PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Read Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active read time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\% Disk Write Time\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk active write time\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Transfers/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Reads/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk read operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Writes/sec\" sampleRate=\"PT15S\" unit=\"CountPerSecond\"><annotation displayName=\"Disk write operations\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Read Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk read speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\PhysicalDisk(_Total)\\Disk Write Bytes/sec\" sampleRate=\"PT15S\" unit=\"BytesPerSecond\"><annotation displayName=\"Disk write speed\" locale=\"en-us\"/></PerformanceCounterConfiguration><PerformanceCounterConfiguration counterSpecifier=\"\\LogicalDisk(_Total)\\% Free Space\" sampleRate=\"PT15S\" unit=\"Percent\"><annotation displayName=\"Disk free space (percentage)\" locale=\"en-us\"/></PerformanceCounterConfiguration></PerformanceCounters>",
        "wadcfgxstart": "[concat(variables('wadlogs'), variables('wadperfcounters1'), variables('wadperfcounters2'), '<Metrics resourceId=\"')]",
        "wadmetricsresourceid": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name , '/providers/', 'Microsoft.Compute/virtualMachines/')]",
        "wadcfgxend": "\"><MetricAggregation scheduledTransferPeriod=\"PT1H\"/><MetricAggregation scheduledTransferPeriod=\"PT1M\"/></Metrics></DiagnosticMonitorConfiguration></WadCfg>"

<span data-ttu-id="00a0e-146">Узел определения метрик в формате XML в представленной выше конфигурации — важный элемент конфигурации, так как он определяет способ агрегирования и хранения счетчиков производительности, определенных ранее в XML в узле *PerformanceCounter* .</span><span class="sxs-lookup"><span data-stu-id="00a0e-146">The Metrics definition xml node in the above configuration is an important configuration element as it defines how the performance counters defined earlier in the xml in *PerformanceCounter* node will be aggregated and stored.</span></span> 

> [!IMPORTANT]
> <span data-ttu-id="00a0e-147">Эти метрики обеспечивают данными диаграммы мониторинга и оповещения на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="00a0e-147">These metrics drive the monitoring charts and alerts in the Azure portal.</span></span>  <span data-ttu-id="00a0e-148">Узел **Metrics** с *resourceID* и **MetricAggregation** должен быть включен в конфигурацию диагностики виртуальной машины, если вы хотите видеть на портале Azure данные мониторинга этой виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="00a0e-148">The **Metrics** node with the *resourceID* and **MetricAggregation** must be included in the diagnostics configuration for your VM if you want to see the VM monitoring data in the Azure portal.</span></span> 
> 
> 

<span data-ttu-id="00a0e-149">Ниже приведен пример XML-кода для определений метрик:</span><span class="sxs-lookup"><span data-stu-id="00a0e-149">The following is an example of the xml for metrics definitions:</span></span> 

        <Metrics resourceId="/subscriptions/subscription().subscriptionId/resourceGroups/resourceGroup().name/providers/Microsoft.Compute/virtualMachines/vmName">
            <MetricAggregation scheduledTransferPeriod="PT1H"/>
            <MetricAggregation scheduledTransferPeriod="PT1M"/>
        </Metrics>

<span data-ttu-id="00a0e-150">Свойство *resourceID* уникальным образом определяет виртуальную машину в подписке.</span><span class="sxs-lookup"><span data-stu-id="00a0e-150">The *resourceID* attribute uniquely identifies the virtual machine in your subscription.</span></span> <span data-ttu-id="00a0e-151">Обязательно используйте функции subscription() и resourceGroup(), чтобы шаблон автоматически обновлял эти значения на основе подписки и группы ресурсов, в которых выполняется развертывание.</span><span class="sxs-lookup"><span data-stu-id="00a0e-151">Make sure to use the subscription() and resourceGroup() functions so that the template automatically updates those values based on the subscription and resource group you are deploying to.</span></span>

<span data-ttu-id="00a0e-152">Если создается несколько виртуальных машин в цикле, необходимо указать функцию copyIndex() в значении *resourceID* , чтобы должным образом провести различия между каждой отдельной виртуальной машиной.</span><span class="sxs-lookup"><span data-stu-id="00a0e-152">If you are creating multiple Virtual Machines in a loop then you will have to populate the *resourceID* value with an copyIndex() function to correctly differentiate each individual VM.</span></span> <span data-ttu-id="00a0e-153">Для поддержки такого сценария свойство *xmlCfg* можно обновить следующим образом.</span><span class="sxs-lookup"><span data-stu-id="00a0e-153">The *xmlCfg* value can be updated to support this as follows:</span></span>  

    "xmlCfg": "[base64(concat(variables('wadcfgxstart'), variables('wadmetricsresourceid'), concat(parameters('vmNamePrefix'), copyindex()), variables('wadcfgxend')))]", 

<span data-ttu-id="00a0e-154">Значение MetricAggregation *PT1H* и *PT1M* обозначает значение агрегирования за минуту и час.</span><span class="sxs-lookup"><span data-stu-id="00a0e-154">The MetricAggregation value of *PT1H* and *PT1M* signify an aggregation over a minute and an aggregation over an hour.</span></span>

## <a name="wadmetrics-tables-in-storage"></a><span data-ttu-id="00a0e-155">Таблицы WADMetrics в хранилище</span><span class="sxs-lookup"><span data-stu-id="00a0e-155">WADMetrics tables in storage</span></span>
<span data-ttu-id="00a0e-156">Конфигурация метрик выше создаст таблицы в учетной записи хранения диагностических данных с использованием следующих соглашений об именовании.</span><span class="sxs-lookup"><span data-stu-id="00a0e-156">The Metrics configuration above will generate tables in your diagnostics storage account with the following naming conventions:</span></span>

* <span data-ttu-id="00a0e-157">**WADMetrics** — стандартный префикс для всех таблиц WADMetrics.</span><span class="sxs-lookup"><span data-stu-id="00a0e-157">**WADMetrics** : Standard prefix for all WADMetrics tables</span></span>
* <span data-ttu-id="00a0e-158">**PT1H** или **PT1M** — указывает, что таблица содержит сводные данные за 1 час и 1 минуту.</span><span class="sxs-lookup"><span data-stu-id="00a0e-158">**PT1H** or **PT1M** : Signifies that the table contains aggregate data over 1 hour or 1 minute</span></span>
* <span data-ttu-id="00a0e-159">**P10D** — указывает, что таблица будет содержать данные за 10 дней с момента, когда таблица начала собирать данные.</span><span class="sxs-lookup"><span data-stu-id="00a0e-159">**P10D** : Signifies the table will contain data for 10 days from when the table started collecting data</span></span>
* <span data-ttu-id="00a0e-160">**V2S** — строковая константа.</span><span class="sxs-lookup"><span data-stu-id="00a0e-160">**V2S** : String constant</span></span>
* <span data-ttu-id="00a0e-161">**yyyymmdd** — дата начала сбора данных таблицей.</span><span class="sxs-lookup"><span data-stu-id="00a0e-161">**yyyymmdd** : The date at which the table started collecting data</span></span>

<span data-ttu-id="00a0e-162">Например, таблица *WADMetricsPT1HP10DV2S20151108* будет содержать данные метрик, агрегированные за час в течение 10 дней, начиная с 11 ноября 2015 года.</span><span class="sxs-lookup"><span data-stu-id="00a0e-162">Example: *WADMetricsPT1HP10DV2S20151108* will contain metrics data aggregated over an hour for 10 days starting on 11-Nov-2015</span></span>    

<span data-ttu-id="00a0e-163">Каждая таблица WADMetrics будет содержать следующие столбцы:</span><span class="sxs-lookup"><span data-stu-id="00a0e-163">Each WADMetrics table will contain the following columns:</span></span>

* <span data-ttu-id="00a0e-164">**PartitionKey**— ключ секции создается на основе значения *resourceID* , которое используется для определения ресурса виртуальной машины уникальным образом.</span><span class="sxs-lookup"><span data-stu-id="00a0e-164">**PartitionKey**: The partitionkey is constructed based on the *resourceID* value to uniquely identify the VM resource.</span></span> <span data-ttu-id="00a0e-165">например: 002Fsubscriptions:<subscriptionID>:002FresourceGroups:002F<ResourceGroupName>:002Fproviders:002FMicrosoft:002ECompute:002FvirtualMachines:002F<vmName></span><span class="sxs-lookup"><span data-stu-id="00a0e-165">for e.g. : 002Fsubscriptions:<subscriptionID>:002FresourceGroups:002F<ResourceGroupName>:002Fproviders:002FMicrosoft:002ECompute:002FvirtualMachines:002F<vmName></span></span>  
* <span data-ttu-id="00a0e-166">**RowKey** — указывается в формате <Descending time tick>:<Performance Counter Name>.</span><span class="sxs-lookup"><span data-stu-id="00a0e-166">**RowKey** : Follows the format <Descending time tick>:<Performance Counter Name>.</span></span> <span data-ttu-id="00a0e-167">Такты времени вычисляются в порядке убывания следующим образом: от максимального количества тактов времени отнимается время начала периода агрегирования.</span><span class="sxs-lookup"><span data-stu-id="00a0e-167">The descending time tick calculation is max time ticks minus the time of the beginning of the aggregation period.</span></span> <span data-ttu-id="00a0e-168">Например: </span><span class="sxs-lookup"><span data-stu-id="00a0e-168">E.g.</span></span> <span data-ttu-id="00a0e-169">если период выборки начался 10 ноября 2015 г. в 00:00 в формате UTC, вычисление выглядело бы следующим образом: DateTime.MaxValue.Ticks - (new DateTime(2015,11,10,0,0,0,DateTimeKind.Utc).Ticks).</span><span class="sxs-lookup"><span data-stu-id="00a0e-169">if the sample period started on 10-Nov-2015 and 00:00Hrs UTC then the calculation would be: DateTime.MaxValue.Ticks - (new DateTime(2015,11,10,0,0,0,DateTimeKind.Utc).Ticks).</span></span> <span data-ttu-id="00a0e-170">Для счетчика производительности доступных байтов памяти ряд будет выглядеть так: 2519551871999999999__:005CMemory:005CAvailable:0020Bytes.</span><span class="sxs-lookup"><span data-stu-id="00a0e-170">For the memory available bytes performance counter the row key will look like: 2519551871999999999__:005CMemory:005CAvailable:0020Bytes</span></span>
* <span data-ttu-id="00a0e-171">**CounterName** — имя счетчика производительности.</span><span class="sxs-lookup"><span data-stu-id="00a0e-171">**CounterName** : Is the name of the performance counter.</span></span> <span data-ttu-id="00a0e-172">Это значение соответствует *counterSpecifier* , определенному в XML-файле конфигурации.</span><span class="sxs-lookup"><span data-stu-id="00a0e-172">This matches the *counterSpecifier* defined in the xml config.</span></span>
* <span data-ttu-id="00a0e-173">**Maximum** — максимальное значение счетчика производительности в течение периода сбора.</span><span class="sxs-lookup"><span data-stu-id="00a0e-173">**Maximum** : The maximum value of the performance counter over the aggregation period.</span></span>
* <span data-ttu-id="00a0e-174">**Minimum** — минимальное значение счетчика производительности в течение периода сбора.</span><span class="sxs-lookup"><span data-stu-id="00a0e-174">**Minimum** : The minimum value of the performance counter over the aggregation period.</span></span>
* <span data-ttu-id="00a0e-175">**Total** — сумма всех значений счетчика производительности, переданных в течение периода сбора.</span><span class="sxs-lookup"><span data-stu-id="00a0e-175">**Total** : The sum of all values of the performance counter reported over the aggregation period.</span></span>
* <span data-ttu-id="00a0e-176">**Count** — общее количество значений, переданных для счетчика производительности.</span><span class="sxs-lookup"><span data-stu-id="00a0e-176">**Count** : The total number of values reported for the performance counter.</span></span>
* <span data-ttu-id="00a0e-177">**Average** — среднее значение (сумма значений, деленная на общее количество значений) счетчика производительности в течение периода сбора.</span><span class="sxs-lookup"><span data-stu-id="00a0e-177">**Average** : The average (total/count) value of the performance counter over the aggregation period.</span></span>

## <a name="next-steps"></a><span data-ttu-id="00a0e-178">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="00a0e-178">Next Steps</span></span>
* <span data-ttu-id="00a0e-179">Полный пример шаблона виртуальной машины Windows с расширением системы диагностики см. в разделе [201-vm-monitoring-diagnostics-extension](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-monitoring-diagnostics-extension).</span><span class="sxs-lookup"><span data-stu-id="00a0e-179">For a complete sample template of a Windows virtual machine with diagnostics extension see [201-vm-monitoring-diagnostics-extension](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-monitoring-diagnostics-extension)</span></span>   
* <span data-ttu-id="00a0e-180">Разверните шаблон диспетчера ресурсов с использованием [Azure PowerShell](ps-template.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) или [командной строки Azure](../linux/create-ssh-secured-vm-from-template.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="00a0e-180">Deploy the resource manager template using [Azure PowerShell](ps-template.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) or [Azure Command Line](../linux/create-ssh-secured-vm-from-template.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)</span></span>
* <span data-ttu-id="00a0e-181">Узнайте больше о [создании шаблонов диспетчера ресурсов Azure](../../resource-group-authoring-templates.md)</span><span class="sxs-lookup"><span data-stu-id="00a0e-181">Learn more about [authoring Azure Resource Manager templates](../../resource-group-authoring-templates.md)</span></span>


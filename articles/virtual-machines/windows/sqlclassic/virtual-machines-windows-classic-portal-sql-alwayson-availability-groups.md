---
title: "aaaConfigure группы доступности AlwaysOn в виртуальных машинах Azure (классические) | Документы Microsoft"
description: "Создание группы доступности AlwaysOn на виртуальных машинах Azure. В этом учебнике используется главным образом hello пользовательского интерфейса и средства, а не сценарии."
services: virtual-machines-windows
documentationcenter: na
author: MikeRayMSFT
manager: jhubbard
editor: 
tags: azure-service-management
ms.assetid: 8d48a3d2-79f8-4ab0-9327-2f30ee0b2ff1
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 03/17/2017
ms.author: mikeray
ms.openlocfilehash: f428ad994a55378c281c959f4696fdcaf50632b1
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="configure-always-on-availability-group-in-azure-virtual-machines-classic"></a>Настройка группы доступности AlwaysOn на виртуальных машинах Azure (классическая модель)
> [!div class="op_single_selector"]
> * [Классическая модель: пользовательский интерфейс](../classic/portal-sql-alwayson-availability-groups.md)
> * [Классическая модель: PowerShell](../classic/ps-sql-alwayson-availability-groups.md)
<br/>

Прежде чем начать, учтите, что теперь можно выполнить эту задачу в модели Azure Resource Manager. Для новых развертываний мы советуем использовать модель Azure Resource Manager. См. сведения в статье [Введение в группы доступности Always On SQL Server на виртуальных машинах Azure](../sql/virtual-machines-windows-portal-sql-availability-group-overview.md).

> [!IMPORTANT] 
> Корпорация Майкрософт рекомендует наиболее новые развертывания модели hello диспетчера ресурсов. Azure имеет два toocreate модели развертывания и работы с ресурсами: [диспетчера ресурсов и классическом](../../../azure-resource-manager/resource-manager-deployment-model.md). В этой статье объясняется, как toouse hello классической модели развертывания. 

toocomplete этой задачи с моделью hello диспетчера ресурсов Azure, в разделе [SQL Server групп доступности AlwaysOn на виртуальных машинах Azure](../sql/virtual-machines-windows-portal-sql-availability-group-overview.md).

Это конца в конец учебнике рассказывается о том, как группы доступности tooimplement с помощью AlwaysOn в SQL Server на виртуальных машинах Azure.

В конце учебника hello hello решения AlwaysOn в SQL Server в Azure будет состоять из hello следующие элементы:

* виртуальной сети, которая содержит несколько подсетей, в том числе внешнюю и внутреннюю подсети;
* контроллера домена с доменом Active Directory (Azure AD);
* Две виртуальные машины под управлением SQL Server, — toohello развернутой серверной подсети и домен присоединены к домену toohello Azure AD
* Трех узлов отказоустойчивого кластера с моделью кворума большинства узлов hello
* группа доступности с двумя репликами базы данных доступности с синхронной фиксацией.

Следующая иллюстрация Hello является графическим представлением решения hello.

![Тестовая архитектура для групп доступности в Azure](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC791912.png)

Обратите внимание, что это одна из возможных конфигураций. Например можно свести к минимуму hello количество виртуальных машин для группы доступности с двумя репликами. Эта конфигурация сохраняет на часы вычислений в Azure, используя hello контроллер домена как следящую общую папку hello кворума в кластере с двумя узлами. Этот метод уменьшает число hello виртуальной машины одним из конфигурации показано hello.

В этом учебнике предполагается hello следующее:

* У вас уже есть учетная запись Azure.
* Вы уже знаете, как toouse hello графического интерфейса пользователя в коллекции tooprovision hello виртуальной машины классической виртуальной машины под управлением SQL Server.
* Вы хорошо понимаете принцип работы групп доступности AlwaysOn. Дополнительные сведения см. в разделе [Группы доступности AlwaysOn (SQL Server)](https://msdn.microsoft.com/library/hh510230.aspx).

> [!NOTE]
> Если вы планируете использовать группы доступности AlwaysOn с SharePoint, ознакомьтесь также со статьей [Настройка групп обеспечения доступности SQL Server 2012 AlwaysOn для SharePoint 2013](https://technet.microsoft.com/library/jj715261.aspx).
> 
> 

## <a name="create-hello-virtual-network-and-domain-controller-server"></a>Создание виртуальной сети hello и контроллер домена
Сначала создайте новую пробную учетную запись Azure. После настройки учетной записи должно быть на начальном экране hello объекта hello классический портал Azure.

1. Нажмите кнопку hello **New** кнопки в левом углу hello hello внизу страницы приветствия, как показано на следующий снимок экрана приветствия.
   
    ![Нажмите кнопку "Создать" портала hello](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665511.gif)
2. Нажмите кнопку **сетевые службы** > **виртуальной сети** > **настраиваемое создание**, как показано в следующих экрана приветствия.
   
    ![Создание виртуальной сети](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665512.gif)
3. В hello **Создание ВИРТУАЛЬНОЙ сети** диалогового окна поле, создайте новую виртуальную сеть с помощью параметров hello hello в следующей таблице и пошаговое выполнение страницы приветствия. 
   
   | Страница | данных |
   | --- | --- |
   | Информация о виртуальной сети |**Имя — ContosoNET**<br/>**REGION = West US** |
   | DNS-серверы и подключение VPN |None |
   | Адресные пространства виртуальной сети |Параметры показаны на следующий снимок экрана приветствия: ![Создание виртуальной сети](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784620.png) |
4. Создайте виртуальную машину hello, который будет использоваться в качестве hello контроллера домена (DC). Нажмите кнопку **New** > **вычислений** > **виртуальной машины** > **из коллекции**, как показано в Следующий снимок экрана приветствия.
   
    ![Создание виртуальной машины](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784621.png)
5. В hello **Создание ВИРТУАЛЬНОЙ МАШИНЫ** диалоговом окне настройте новую виртуальную машину с помощью параметров hello hello в следующей таблице и пошаговое выполнение страницы приветствия. 
   
   | Страница | данных |
   | --- | --- |
   | Выберите операционную систему виртуальной машины hello |Центр обработки данных Windows Server 2012 R2; |
   | Конфигурация виртуальной машины |**Дата выпуска версии** — (последняя)<br/>**Имя виртуальной машины** — ContosoDC<br/>**Уровень** — Стандартный<br/>**Размер** — A2 (2 ядра)<br/>**Новое имя пользователя** — AzureAdmin<br/>**Новый пароль** — Contoso!000<br/>**ПОДТВЕРЖДЕНИЕ** = Contoso!000 |
   | Конфигурация виртуальной машины |**Облачная служба** — создайте облачную службу<br/>**DNS-имя облачной службы** — уникальное имя облачной службы<br/>**DNS-имя** — уникальное имя (например, ContosoDC123)<br/>**Регион, территориальная группа, виртуальная сеть** — ContosoNET<br/>**Подсети виртуальной сети** — Back(10.10.2.0/24)<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**ГРУППА ДОСТУПНОСТИ** = (нет) |
   | Параметры виртуальной машины |По умолчанию |

После настройки hello новой виртуальной машины, дождитесь провизионирования toobe hello виртуальной машины. Этот процесс занимает некоторое время toofinish. При нажатии кнопки hello **виртуальной машины** на вкладке hello Azure классического портала, можно увидеть ContosoDC циклического состояния из **запуск (Подготовка)** слишком**остановлена**, **Запуск**, **выполняется (Провизионирование)**и, наконец, **под управлением**.

Hello Контроллера домена успешно подготовлен. После этого вы настроите hello домена Active Directory на этом сервере контроллера домена.

## <a name="configure-hello-domain-controller"></a>Настройка контроллера домена hello
В hello, выполнив действия настроить машину ContosoDC hello как контроллер домена для corp.contoso.com.

1. Hello портале выберите hello **ContosoDC** машины. На hello **мониторинга** щелкните **Connect** tooopen файл удаленного рабочего стола (RDP) для удаленного доступа к рабочему столу.
   
    ![Подключение tooVritual машины](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784622.png)
2. Войдите в систему с использованием настроенной учетной записи администратора (**\AzureAdmin**) и пароля (**Contoso!000**).
3. По умолчанию hello **диспетчера сервера** должна отображаться панель мониторинга.
4. Нажмите кнопку hello **Добавить роли и компоненты** ссылку на панель мониторинга hello.
   
    ![Добавление ролей с помощью обозревателя серверов](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784623.png)
5. Нажмите кнопку **Далее** до получения toohello **ролей сервера** раздела.
6. Выберите hello **доменных служб Active Directory** и **DNS-сервер** ролей. При появлении запроса добавьте требуемые для этих ролей дополнительные компоненты.
   
   > [!NOTE]
   > Вы получите предупреждение проверки об отсутствии статического IP-адреса. Если вы тестируете конфигурацию hello, нажмите кнопку **Продолжить**. Для рабочих сценариев [PowerShell tooset hello статический IP-адрес компьютера контроллера домена hello](../../../virtual-network/virtual-networks-reserved-private-ip.md).
   > 
   > 
   
    ![Диалоговое окно добавления ролей](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784624.png)
7. Нажмите кнопку **Далее** пока не достигнете hello **Подтверждение** раздела. Выберите hello **перезапустите hello целевой сервер автоматически, если необходимо** флажок.
8. Щелкните **Install**(Установить).
9. После установки функции hello возвращают toohello **диспетчера сервера** панели мониторинга.
10. Выберите hello новый **AD DS** параметр в левой области hello.
11. Нажмите кнопку hello **дополнительные** ссылку на hello желтой строке предупреждения.
    
     ![Диалоговое окно "AD DS" на виртуальной машине DNS-сервера](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784625.png)
12. В hello **действия** столбец hello **все сведения о задаче сервера** диалоговое окно, нажмите кнопку **повысить роль этого контроллера домена server tooa**.
13. В hello **мастер настройки доменных служб Active Directory**, использовать hello следующие значения:
    
    | Страница | Настройка |
    | --- | --- |
    | Конфигурация развертывания |**Добавить новый лес** = выбрано<br/>**Имя корневого домена** = corp.contoso.com |
    | Параметры контроллера домена |**Пароль** = Contoso!000<br/>**Подтверждение пароля** = Contoso!000 |
14. Нажмите кнопку **Далее** toogo через hello других страницах мастера hello. На hello **проверка предварительных требований** страницы, убедитесь, что отображаются следующие сообщения hello: **наличие всех необходимых компонентов прошла успешно**. Обратите внимание, что следует просмотреть все применимые предупреждающие сообщения, но это возможно toocontinue с установкой hello.
15. Щелкните **Install**(Установить). Hello **ContosoDC** виртуальной машины будет автоматически перезагружен.

## <a name="configure-domain-accounts"></a>Настройка учетных записей в домене
Дальнейшие действия Hello настроить учетные записи Active Directory hello для последующего использования.

1. Войти снова toohello **ContosoDC** машины.
2. На панели **Диспетчер серверов** выберите **Сервис** > **Центр администрирования Active Directory**.
   
    ![Центр администрирования Active Directory](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784626.png)
3. В hello **Центр администрирования Active Directory**выберите **corp (local)** hello левой панели.
4. На правом hello **задачи** области, нажмите кнопку **New** > **пользователя**. Используйте hello следующие параметры:
   
   | Настройка | Значение |
   | --- | --- |
   | **Имя** |Install |
   | **User SamAccountName** |Install |
   | **Пароль** |Contoso!000 |
   | **Подтверждение пароля.** |Contoso!000 |
   | **Другие параметры пароля** |Выбрано |
   | **Срок действия пароля не ограничен** |Флажок установлен |
5. Нажмите кнопку **ОК** toocreate hello **установить** пользователя. Эта учетная запись будет использоваться tooconfigure hello отказоустойчивого кластера и hello группы доступности.
6. Создайте двух дополнительных пользователей **CORP\SQLSvc1** и **CORP\SQLSvc2**, с hello одну последовательность шагов. Эти учетные записи будут использоваться для экземпляров SQL Server hello. Далее необходимо toogive **CORP\Install** hello необходимые разрешения tooconfigure отказоустойчивой кластеризации в Windows.
7. В hello **Центр администрирования Active Directory**, нажмите кнопку **corp (local)** hello левой панели. В hello **задачи** области, нажмите кнопку **свойства**.
   
    ![Свойства пользователя CORP](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784627.png)
8. Выберите **расширения**, а затем нажмите кнопку hello **Дополнительно** кнопку на hello **безопасности** вкладку.
9. В hello **Дополнительные параметры безопасности для corp** диалоговое окно, нажмите кнопку **добавить**.
10. Щелкните **Выберите субъект**, найдите **CORP\Install** и нажмите кнопку **ОК**.
11. Выберите hello **чтение всех свойств** и **создание объектов-компьютеров** разрешения.
    
     ![Разрешения пользователя CORP](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784628.png)
12. Нажмите кнопку **ОК**, а затем снова кнопку **ОК**. Окно свойств corp закрыть hello.

Теперь, когда вы настроили Active Directory и объектов пользователей hello, вы создадите три виртуальные машины SQL Server и присоединять их toothis домена.

## <a name="create-hello-sql-server-virtual-machines"></a>Создание виртуальных машин SQL Server hello
Создайте три виртуальные машины. Одна из них предназначена для узла кластера, а другие две — для SQL Server. toocreate каждого hello виртуальных машин, перейти обратно toohello классический портал Azure, щелкните **New** > **вычислений** > **виртуальной машины**  >  **Из коллекции**. Затем с помощью шаблонов hello в следующие таблицы toohelp при создании виртуальных машин hello hello.

| Страница | VM1 | VM2 | VM3 |
| --- | --- | --- | --- |
| Выберите операционную систему виртуальной машины hello |**Центр обработки данных Windows Server 2012 R2** |**SQL Server 2014 RTM Enterprise** |**SQL Server 2014 RTM Enterprise** |
| Конфигурация виртуальной машины |**Дата выпуска версии** — (последняя)<br/>**Имя виртуальной машины** — ContosoWSFCNode<br/>**Уровень** — Стандартный<br/>**Размер** — A2 (2 ядра)<br/>**Новое имя пользователя** — AzureAdmin<br/>**Новый пароль** — Contoso!000<br/>**ПОДТВЕРЖДЕНИЕ** = Contoso!000 |**Дата выпуска версии** — (последняя)<br/>**Имя виртуальной машины** — ContosoSQL1<br/>**Уровень** — Стандартный<br/>**Размер** — A3 (4 ядра)<br/>**Новое имя пользователя** — AzureAdmin<br/>**Новый пароль** — Contoso!000<br/>**ПОДТВЕРЖДЕНИЕ** = Contoso!000 |**Дата выпуска версии** — (последняя)<br/>**Имя виртуальной машины** — ContosoSQL2<br/>**Уровень** — Стандартный<br/>**Размер** — A3 (4 ядра)<br/>**Новое имя пользователя** — AzureAdmin<br/>**Новый пароль** — Contoso!000<br/>**ПОДТВЕРЖДЕНИЕ** = Contoso!000 |
| Конфигурация виртуальной машины |**Облачная служба** — уникальное DNS-имя ранее созданной облачной службы (например, ContosoDC123)<br/>**Регион, территориальная группа, виртуальная сеть** — ContosoNET<br/>**Подсети виртуальной сети** — Back(10.10.2.0/24)<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** — создайте группу доступности<br/>**ИМЯ ГРУППЫ ДОСТУПНОСТИ** = SQLHADR |**Облачная служба** — уникальное DNS-имя ранее созданной облачной службы (например, ContosoDC123)<br/>**Регион, территориальная группа, виртуальная сеть** — ContosoNET<br/>**Подсети виртуальной сети** — Back(10.10.2.0/24)<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**ГРУППА ДОСТУПНОСТИ** = SQLHADR (вы можете также настроить hello доступности после создания машины hello. Все три машины следует назначить доступности sqlhadr toohello.) |**Облачная служба** — уникальное DNS-имя ранее созданной облачной службы (например, ContosoDC123)<br/>**Регион, территориальная группа, виртуальная сеть** — ContosoNET<br/>**Подсети виртуальной сети** — Back(10.10.2.0/24)<br/>**УЧЕТНАЯ ЗАПИСЬ ХРАНЕНИЯ** = используйте автоматически созданную учетную запись хранения<br/>**ГРУППА ДОСТУПНОСТИ** = SQLHADR (вы можете также настроить hello доступности после создания машины hello. Все три машины следует назначить доступности sqlhadr toohello.) |
| Параметры виртуальной машины |По умолчанию |По умолчанию |По умолчанию |

<br/>

> [!NOTE]
> Hello предыдущей конфигурации предлагает стандартный уровень виртуальных машин, так как БАЗОВЫЙ уровень машины не поддерживают конечных точек с балансировкой нагрузки. Требуется конечных точек с балансировкой нагрузки более поздней версии toocreate прослушивателя группы доступности. Кроме того размеры hello машины, которые предлагаются здесь предназначены для тестирования на виртуальных машинах Azure для группы доступности. Для наилучшей производительности hello на рабочие нагрузки, увидеть рекомендации hello размеров машины SQL Server и конфигурации в [рекомендации по производительности для SQL Server в виртуальных машинах Azure](../sql/virtual-machines-windows-sql-performance.md).
> 
> 

После полного выделения hello трех виртуальных машин необходимо toojoin их toohello **corp.contoso.com** домена и предоставьте машины toohello CORP\Install права администратора. toodo, hello используйте следующие шаги для каждой из трех hello виртуальных машин.

1. Во-первых измените hello предпочитаемый адрес DNS-сервера. Загрузите локальный каталог файла протокола удаленного рабочего СТОЛА tooyour каждой виртуальной машины, выбрав в списке hello hello виртуальную машину и щелкнув hello **Connect** кнопки. tooselect виртуальной машины, щелкните в любом но hello первую ячейку в строке приветствия, как показано на следующий снимок экрана приветствия.
   
    ![Загрузить RDP-файл hello](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC664953.jpg)
2. Файл, который был загружен Привет открыть RDP и выполните вход toohello виртуальной машины с помощью учетной записи администратора (**BUILTIN\AzureAdmin**) и пароль (**Contoso! 000**).
3. После входа вы увидите hello **диспетчера сервера** панели мониторинга. Нажмите кнопку **локального сервера** hello левой панели.
4. Нажмите кнопку hello **IPv4-адрес, назначенный DHCP, IPv6 включены** ссылку.
5. В hello **сетевых подключений** диалогового окна выберите значок сети hello.
   
    ![Изменение hello виртуальной машины предпочитаемый DNS-сервер](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784629.png)
6. На панели команд hello, нажмите кнопку **изменить параметры этого подключения hello**. (В зависимости от размера окна hello, может потребоваться tooclick hello двойную стрелку справа toosee этой команды).
7. Выберите пункт **Протокол Интернета версии 4 (TCP/IPv4)** и нажмите кнопку **Свойства**.
8. Выберите **hello использовать следующие адреса DNS-серверов** и укажите **10.10.2.4** в **предпочитаемый DNS-сервер**.
9. Hello **10.10.2.4** адрес является hello, назначенный tooa виртуальная машина в подсети 10.10.2.0/24 hello в виртуальной сети Azure. Речь идет о виртуальной машине **ContosoDC**. tooverify **ContosoDC**его IP-адрес, используйте **nslookup contosodc** в окне командной строки hello, как показано на следующий снимок экрана приветствия.
   
    ![Использование команды NSLOOKUP toofind IP-адреса для контроллера домена](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC664954.jpg)
10. Нажмите кнопку **ОК** > **закрыть** toocommit hello изменения. Теперь можно присоединить hello виртуальную машину слишком**corp.contoso.com**.
11. Обратно в hello **локального сервера** окно, нажмите кнопку hello **рабочей группы** ссылку.
12. В hello **имя компьютера** щелкните **изменений**.
13. Выберите hello **домена** флажок, введите **corp.contoso.com** в hello текстовое поле и нажмите кнопку **ОК**.
14. В hello **безопасности Windows** диалоговом окне укажите hello учетные данные для учетной записи администратора домена по умолчанию hello (**CORP\AzureAdmin**) и пароль hello (**Contoso! 000**).
15. После появления сообщения «toohello приветствия домена corp.contoso.com» hello, нажмите кнопку **ОК**.
16. Нажмите кнопку **закрыть** > **Перезагрузить сейчас** в диалоговое окно «hello».

### <a name="add-hello-corpinstall-user-as-an-administrator-on-each-virtual-machine"></a>Добавить hello Corp\Install пользователя с правами администратора на каждой виртуальной машине
1. Подождите, пока hello виртуальная машина перезапускается и откройте hello RDP файлов снова toosign toohello виртуальной машине с использованием hello **BUILTIN\AzureAdmin** учетной записи.
2. В области **Диспетчер серверов** выберите **Сервис** > **Управление компьютером**.
   
    ![Управление компьютерами](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784630.png)
3. В hello **Управление компьютером** диалогового окна разверните **локальные пользователи и группы**, а затем нажмите кнопку **группы**.
4. Дважды щелкните hello **Администраторы** группы.
5. В hello **свойства администратора** диалоговое окно, нажмите кнопку hello **добавить** кнопки.
6. Введите пользователя hello **CORP\Install**, а затем нажмите кнопку **ОК**. При запросе учетных данных следует использовать hello **AzureAdmin** учетную запись с hello **Contoso! 000** пароль.
7. Нажмите кнопку **ОК** tooclose hello **свойства администратора** диалоговое окно.

### <a name="add-hello-failover-clustering-feature-tooeach-virtual-machine"></a>Добавление tooeach отказоустойчивой кластеризации функции hello виртуальной машины
1. В hello **диспетчера сервера** панели мониторинга, щелкните **Добавить роли и компоненты**.
2. В hello **мастера добавления ролей и компонентов**, нажмите кнопку **Далее** до получения toohello **функции** страницы.
3. Выберите **Отказоустойчивость кластеров**. При появлении запроса добавьте остальные зависимые компоненты.
   
    ![Добавить машину toovirtual отказоустойчивости кластеров](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784631.png)
4. Нажмите кнопку **Далее**, а затем нажмите кнопку **установить** на hello **Подтверждение** страницы.
5. Здравствуйте, когда **отказоустойчивой кластеризации** выполнена установка компонентов, нажмите кнопку **закрыть**.
6. Выйдите из виртуальной машины hello.
7. Повторите шаги с hello в этом разделе для всех трех серверов: **ContosoWSFCNode**, **ContosoSQL1**, и **ContosoSQL2**.

Здравствуйте, SQL Server, виртуальные машины настроены и запущены, но каждый из них имеет параметры по умолчанию hello для SQL Server.

## <a name="create-hello-failover-cluster"></a>Создание отказоустойчивого кластера hello
В этом разделе создайте hello отказоустойчивого кластера, где будет размещаться hello группы доступности, которая будет создана в более поздней версии. К этому моменту необходимо выполнить следующие tooeach hello трех виртуальных машин, которые будут использоваться в отказоустойчивом кластере hello hello:

* Полностью подготовленные hello виртуальную машину в Azure
* Присоединен к домену toohello hello виртуальной машины
* Добавлен **CORP\Install** toohello локальной группы администраторов
* Добавлены hello отказоустойчивости кластеров

Все это предварительные условия для каждой виртуальной машины, прежде чем присоединить его toohello отказоустойчивого кластера.

Кроме того, обратите внимание, что hello виртуальная сеть Azure работает не так hello таким же, как и в локальной сети. Требуется toocreate кластера hello в hello следующий порядок:

1. Создайте кластер с одним узлом на одном из узлов (**ContosoSQL1**).
2. Изменить IP адрес hello кластера tooan неиспользуемый IP-адрес (**10.10.2.101**).
3. Перевести hello имя кластера в оперативный режим.
4. Добавить другие узлы hello (**ContosoSQL2** и **ContosoWSFCNode**).

Используйте следующие шаги toocomplete hello задачи, которые полностью настроить кластер hello hello.

1. Привет открыть RDP-файл для **ContosoSQL1**и вход с помощью учетной записи домена hello **CORP\Install**.
2. В hello **диспетчера сервера** панели мониторинга, щелкните **средства** > **Диспетчер отказоустойчивости кластеров**.
3. Hello левой панели щелкните правой кнопкой мыши **Диспетчер отказоустойчивости кластеров**, а затем нажмите кнопку **создать кластер**, как показано в следующих экрана приветствия.
   
    ![Создание кластера](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784632.png)
4. В Здравствуйте, мастер создания кластера, создать кластер с одним узлом, настроив страницах hello и с использованием параметров hello в следующей таблице hello:
   
   | Страница | Параметры |
   | --- | --- |
   | Перед началом работы |По умолчанию |
   | Выбор серверов |Введите **ContosoSQL1** в поле **Введите имя сервера** и щелкните **Добавить**. |
   | Предупреждение проверки |Выберите **проверяет, но мне не требуется поддержка Майкрософт для этого кластера, а не требуется проверка toorun hello. После нажатия кнопки Далее продолжить создание кластера hello**. |
   | Точка доступа для hello администрирование кластера |Введите **Cluster1** в поле **Имя кластера** |
   | Подтверждение |Используйте параметры по умолчанию, если вы не используете дисковые пространства. В разделе hello предупреждение после этой таблицы. |
   
   > [!WARNING]
   > При использовании [дисковых пространств](https://technet.microsoft.com/library/hh831739), которые группируют несколько дисков в пулы носителей, необходимо очистить hello **Добавление всех допустимых хранилищ toohello кластера** флажок на hello **Подтверждение** страницы. Если вы не снят, hello виртуальные диски будут отсоединены во время процесса кластеризации hello. В результате они также не отображаются в диспетчере дисков или проводнике пока удаляются из кластера hello hello дисковых пространств и повторно присоединить, с помощью PowerShell.
   > 
   > 
5. Hello левой панели разверните **Диспетчер отказоустойчивости кластеров**, а затем нажмите кнопку **Cluster1.corp.contoso.com**.
6. В центральной области hello, прокрутите вниз toohello **основные ресурсы кластера** статьи, а затем разверните hello **имя: Clutser1** сведения. Вы увидите обоих hello **имя** и hello **IP-адрес** ресурсы hello **сбой** состояния. Hello ресурс IP-адреса не удается подключить из-за hello кластеру назначен hello IP-адресом hello машине, который является повторяющийся адрес.
7. Щелкните правой кнопкой мыши hello сбой **IP-адрес** ресурсов, а затем щелкните **свойства**.
   
    ![Свойства кластера](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784633.png)
8. Выберите **статический IP-адрес**, укажите **10.10.2.101** в hello **адрес** текстовое поле и нажмите кнопку **ОК**.
9. В hello **основные ресурсы кластера** щелкните правой кнопкой мыши **имя: Cluster1**, а затем нажмите кнопку **перевести в оперативный режим**. Подождите, пока оба ресурса будут подключены. Когда ресурс имени кластера hello станет доступной, сервер DC hello обновляется новой учетной записи компьютера Active Directory. Эта учетная запись Active Directory будет использоваться toorun hello доступности группы кластеризованную службу позже.
10. Добавьте оставшихся узлах кластера toohello hello. Дерево обозревателя hello, щелкните правой кнопкой мыши **Cluster1.corp.contoso.com**, а затем нажмите кнопку **добавления узла**, как показано в следующих экрана приветствия.
    
     ![Добавление узла кластера toohello](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC784634.png)
11. В hello **мастер добавления узла**, нажмите кнопку **Далее** на hello **Выбор серверов** добавьте **ContosoSQL2** и **ContosoWSFCNode**  toohello список, введя имя сервера hello в **введите имя сервера** и выбрав **добавить**. Когда будете готовы, нажмите кнопку **Далее**.
12. На hello **предупреждение проверки** щелкните **нет**, несмотря на то, что в рабочих сценариях необходимо выполнить проверочные тесты hello. Затем щелкните **Далее**.
13. На hello **Подтверждение** щелкните **Далее** tooadd hello узлов.
    
    > [!WARNING]
    > Если вы используете [дисковых пространств](https://technet.microsoft.com/library/hh831739), которые группируют несколько дисков в пулы носителей, необходимо очистить hello **Добавление всех допустимых хранилищ toohello кластера** флажок. Если вы не снят, hello виртуальные диски будут отсоединены во время процесса кластеризации hello. В результате они не будут отображаться в диспетчере дисков или проводнике пока hello дисковых пространств, удаляются из кластера и повторно подключены с помощью PowerShell.
    > 
    > 
14. После добавления узлов hello toohello кластера, нажмите кнопку **Готово**. Диспетчер отказоустойчивости кластеров теперь покажет, что кластер имеет три узла и перечислять в hello **узлы** контейнера.
15. Выйдите из сеанса удаленного рабочего стола hello.

## <a name="prepare-hello-sql-server-instances-for-availability-groups"></a>Подготовка экземпляров SQL Server hello для групп доступности
В этом разделе будет выполнять hello, выполнив на обоих **ContosoSQL1** и **contosoSQL2**:

* Добавьте имя входа для **NT AUTHORITY\System** экземпляр SQL Server по умолчанию toohello установите необходимые разрешения.
* Добавить **CORP\Install** как экземпляр SQL Server по умолчанию toohello роли sysadmin.
* Откройте брандмауэр Windows hello для удаленного доступа к SQL Server.
* Включите hello Always On функции групп доступности.
* Изменение учетной записи службы SQL Server hello слишком**CORP\SQLSvc1** и **CORP\SQLSvc2**соответственно.

Эти действия можно выполнять в любом порядке. Тем не менее следующие шаги hello поможет выполнить их в порядке. Выполните действия hello для обоих **ContosoSQL1** и **ContosoSQL2**:

1. Если вы не выполнили выход из системы hello сеанса удаленного рабочего стола для виртуальной машины hello, сделайте это сейчас.
2. Привет открыть RDP файлы для **ContosoSQL1** и **ContosoSQL2**и войдите как **BUILTIN\AzureAdmin**.
3. Добавить **NT AUTHORITY\System** toohello имена входа SQL Server с необходимыми разрешениями. Откройте **SQL Server Management Studio**.
4. Нажмите кнопку **Connect** экземпляр SQL Server по умолчанию toohello tooconnect.
5. В **обозревателе объектов** разверните элемент **Безопасность**, а затем элемент **Имена входа**.
6. Щелкните правой кнопкой мыши hello **NT AUTHORITY\System** входа в систему, а затем щелкните **свойства**.
7. На hello **защищаемые объекты** страницы для hello локального сервера выберите **Grant** для hello следующие разрешения, а затем нажмите кнопку **ОК**.
   
   * Изменение любой группы доступности
   * Соединение SQL
   * Просмотр состояния сервера
8. Добавить **CORP\Install** как **sysadmin** экземпляра SQL Server по умолчанию toohello роли. В **обозревателе объектов** щелкните правой кнопкой мыши узел **Имена для входа**, а затем выберите пункт **Создать имя входа**.
9. Введите **CORP\Install** в поле **Имя для входа**.
10. На hello **ролей сервера** выберите **sysadmin**, а затем нажмите кнопку **ОК**. После создания имени входа hello, его можно просматривать, развернув **входа** в **обозревателя объектов**.
11. правило брандмауэра для SQL Server на hello toocreate **запустить** экрана, откройте **брандмауэр Windows в режиме повышенной безопасности**.
12. Выберите в левой области hello **правила для входящих подключений**. Hello правой панели щелкните **новое правило**.
13. На hello **тип правила** щелкните **программы** > **Далее**.
14. На hello **программы** выберите **путь к этой программе**, тип **%ProgramFiles%\Microsoft SQL Server\MSSQL12. MSSQLSERVER\MSSQL\Binn\sqlservr.exe** в hello текстовое поле и нажмите кнопку **Далее**. Если вы следуете этим указаниям, но с помощью SQL Server 2012, каталог SQL Server hello имеет **MSSQL11. MSSQLSERVER**.
15. На hello **действия** оставьте **разрешить подключение hello** , а затем нажмите кнопку **Далее**.
16. На hello **профиль** примите параметры по умолчанию hello и нажмите кнопку **Далее**.
17. На hello **имя** укажите имя правила, например **SQL Server (правило программы)**, в hello **имя** текстовое поле, а затем нажмите кнопку **Готово**.
18. tooenable hello **группы доступности AlwaysOn** функции в hello **запустить** открывшегося экрана **диспетчер конфигурации SQL Server**.
19. В дереве обозревателя hello, нажмите кнопку **служб SQL Server**, щелкните правой кнопкой мыши hello **SQL Server (MSSQLSERVER)** службы, а затем нажмите кнопку **свойства**.
20. Нажмите кнопку hello **высокий уровень доступности AlwaysOn** выберите **включить группы доступности AlwaysOn**, как показано в hello следующий снимок экрана, а затем нажмите кнопку **применить**. Нажмите кнопку **ОК** в hello диалоговое окно и не закрывайте hello **свойства** еще диалоговое окно «». Службы SQL Server hello будет перезагружен после изменения учетной записи службы hello.
    
     ![Включение групп доступности AlwaysOn](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665520.gif)
21. hello toochange учетной записи службы SQL Server, нажмите кнопку hello **вход в систему** введите **CORP\SQLSvc1** (для **ContosoSQL1**) или **CORP\SQLSvc2** () для **ContosoSQL2**) в **имя учетной записи**, заполните и подтвердите пароль hello и нажмите кнопку **ОК**.
22. В hello открывшемся диалоговом окне, щелкните **Да** toorestart hello службы SQL Server. После перезапуска службы SQL Server hello, изменения, внесенные в hello **свойства** диалоговое окно, вступают в силу.
23. Выйдите из виртуальных машин hello.

## <a name="create-hello-availability-group"></a>Создание группы доступности hello
Теперь вы находитесь готов tooconfigure группы доступности. Ниже приведено краткое описание того, что вам потребуется сделать:

* Создание базы данных (**MyDB1**) на **ContosoSQL1**.
* Отключите полной резервной копии и резервной копии журнала транзакций базы данных hello.
* Восстановление полной hello и резервные копии журналов слишком**ContosoSQL2** с hello **NORECOVERY** параметр.
* Создание группы доступности hello (**AG1**) с синхронной фиксацией, автоматической отработки отказа и вторичные реплики для чтения.

### <a name="create-hello-mydb1-database-on-contososql1"></a>Создание базы данных MyDB1 hello на ContosoSQL1
1. Если вы не уже вышли hello сеансов удаленного рабочего стола для **ContosoSQL1** и **ContosoSQL2**, сделайте это сейчас.
2. Привет открыть RDP-файл для **ContosoSQL1**и войдите как **CORP\Install**.
3. В **проводнике** на диске **C:\\** создайте каталог **backup**. Будет использоваться этот каталог tooback и восстановление базы данных.
4. Щелкните правой кнопкой мыши новый каталог hello, укажите слишком**предоставить**и нажмите кнопку **конкретные пользователи**, как показано в следующих экрана приветствия.
   
    ![Создание папки резервного копирования](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665521.gif)
5. Добавить **CORP\SQLSvc1**и присвойте ему hello **чтения и записи** разрешение. Добавить **CORP\SQLSvc2**и присвойте ему hello **чтения** разрешения, как показано в hello следующий снимок экрана, а затем нажмите кнопку **общего ресурса**. После завершения процесса обмена файлами hello щелкните **сделать**.
   
    ![Предоставление разрешений для папки резервного копирования](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665522.gif)
6. базы данных hello toocreate из hello **запустить** выберите пункт **SQL Server Management Studio**и нажмите кнопку **Connect** экземпляр SQL Server по умолчанию toohello tooconnect.
7. В **обозревателе объектов** щелкните правой кнопкой мыши элемент **Базы данных** и выберите пункт **Создать базу данных**.
8. В поле **Имя базы данных** введите **MyDB1**, а затем нажмите кнопку **ОК**.

### <a name="make-a-full-backup-of-mydb1-and-restore-it-on-contososql2"></a>Создание полной резервной копии MyDB1 и восстановление ее на ContosoSQL2
1. toomake hello полной резервной копии базы данных, в **обозревателя объектов**, разверните **баз данных**, щелкните правой кнопкой мыши **MyDB1**, слишком точки**задачи**, и Нажмите кнопку **резервное копирование**.
2. В hello **источника** установите **тип резервной копии** значение слишком**полного**. В hello **назначения** щелкните **удалить** tooremove hello по умолчанию путь к файлу hello резервного копирования.
3. В hello **назначения** щелкните **добавить**.
4. В hello **имя файла** введите  **\\ContosoSQL1\backup\MyDB1.bak**, нажмите кнопку **ОК**, а затем нажмите кнопку **ОК** еще раз tooback hello базы данных. По завершении операции резервного копирования приветствия нажмите кнопку **ОК** снова tooclose hello диалоговое окно.
5. toomake транзакции вход резервной копии hello, **обозревателя объектов**, разверните **баз данных**, щелкните правой кнопкой мыши **MyDB1**, слишком точки**задачи**, а затем нажмите кнопку **резервное копирование**.
6. В поле **Тип резервной копии** выберите вариант **Журнал транзакций**. Сохранить hello **назначения** файла toohello набор путь был указан ранее и нажмите кнопку **ОК**. После завершения операции резервного копирования hello щелкните **ОК** еще раз.
7. hello toorestore полная и журналов транзакций резервных копий **ContosoSQL2**откройте hello RDP-файла для **ContosoSQL2**и войдите как **CORP\Install**. Оставьте hello сеанса удаленного рабочего стола для **ContosoSQL1** открыть.
8. Из hello **запустить** выберите пункт **SQL Server Management Studio**и нажмите кнопку **Connect** экземпляр SQL Server по умолчанию toohello tooconnect.
9. В **обозревателе объектов** щелкните правой кнопкой мыши элемент **Базы данных** и выберите пункт **Восстановить базу данных**.
10. В hello **источника** выберите **устройства**и нажмите кнопку с многоточием hello **...** .
11. В разделе **Выберите устройства резервного копирования** нажмите кнопку **Добавить**.
12. В поле **Расположение файла резервной копии** введите **\\ContosoSQL1\backup**, нажмите кнопку **Обновить**, выберите **MyDB1.bak**, нажмите кнопку **ОК** и еще раз нажмите кнопку **ОК**. Должно отобразиться hello полную резервную копию и резервную копию журнала hello в hello **резервные наборы данных toorestore** области.
13. Go toohello **параметры** выберите **инструкции RESTORE WITH NORECOVERY** в **состояние восстановления**, а затем нажмите кнопку **ОК** базы данных toorestore hello. После hello для завершения операции восстановления, нажмите кнопку **ОК**.

### <a name="create-hello-availability-group"></a>Создание группы доступности hello
1. Перейдите обратно toohello сеанс удаленного рабочего стола для **ContosoSQL1**. В **обозревателя объектов** в SQL Server Management Studio, щелкните правой кнопкой мыши **высокий уровень доступности AlwaysOn**, а затем нажмите кнопку **мастера создания группы доступности**, как показано в hello Следующий снимок экрана.
   
    ![Запуск мастера создания групп доступности](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665523.gif)
2. На hello **Введение** щелкните **Далее**. На hello **Указание имени группы доступности** введите **AG1** в **имя группы доступности**, нажмите кнопку **Далее** еще раз.
   
    ![Мастер создания групп доступности, страница "Указание имени группы доступности"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665524.gif)
3. На hello **Выбор баз данных** выберите **MyDB1**, а затем нажмите кнопку **Далее**. Hello базы данных предварительным требованиям hello для группы доступности из-за выполнения по крайней мере одну полную резервную копию на hello целевой первичной реплики.
   
    ![Мастер создания групп доступности, страница "Выбор баз данных"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665525.gif)
4. на hello **Выбор реплик** щелкните **добавления реплики**.
   
    ![Мастер создания групп доступности, страница "Указание реплик"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665526.gif)
5. В hello **подключения tooServer** диалоговое окно, введите **ContosoSQL2** в **имя сервера**, а затем нажмите кнопку **Connect**.
   
    ![Мастер создания групп доступности, Connect tooserver](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665527.gif)
6. Включите hello **Выбор реплик** страницы должна появиться **ContosoSQL2** в **доступные реплики**. Настройка реплик hello, как показано на следующий снимок экрана приветствия. После завершения нажмите кнопку **Далее**.
   
    ![Мастер создания групп доступности, заполненная страница "Указание реплик"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665528.gif)
7. На hello **Выбор начальной синхронизации данных** выберите **только присоединение**, а затем нажмите кнопку **Далее**. Вы уже выполнили синхронизации данных вручную при внесении hello full и операции резервного копирования на **ContosoSQL1** и их восстановление на **ContosoSQL2**. Можно выбрать не tooperform hello операции резервного копирования и восстановления базы данных, а вместо этого выберите **полного** toolet приветствия мастера создания группы доступности выполнил синхронизацию данных. Однако мы не рекомендуем такой вариант для очень крупных баз данных, которые иногда используются на предприятиях.
   
    ![Мастер создания групп доступности, страница "Выбор начальной синхронизации данных"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665529.gif)
8. На hello **проверки** щелкните **Далее**. Эта страница должна выглядеть примерно toohello следующий снимок экрана. Имеется предупреждение для конфигурации прослушивателя hello, так как вы не настроили прослушиватель группы доступности. Вы можете пропустить это предупреждение, поскольку процедура настройки прослушивателя не описана в этом учебнике. прослушиватель hello tooconfigure после завершения этого учебника, см. в разделе [настроить прослушиватель ILB для группы доступности AlwaysOn в Azure](../classic/ps-sql-int-listener.md).
   
    ![Мастер создания групп доступности, страница "Проверка"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665530.gif)
9. На hello **Сводка** нажмите кнопку **Готово**, а затем подождите, пока мастер hello настраивает hello новой группы доступности. На hello **выполняется** страницы, можно щелкнуть **Дополнительные сведения о** tooview hello подробные хода выполнения. По окончании работы мастера hello проверять hello **результатов** tooverify странице этой группы доступности hello успешно создан, как показано на следующий снимок экрана приветствия и нажмите кнопку **закрыть** tooexit hello мастер.
   
    ![Мастер создания групп доступности, страница "Результаты"](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665531.gif)
10. В **обозревателе объектов** разверните узел **Высокий уровень доступности AlwaysOn**, а затем узел **Группы доступности**. Теперь вы увидите hello новой группы доступности в этом контейнере. Щелкните правой кнопкой мыши элемент **AG1 (основная)** и выберите пункт **Отобразить панель мониторинга**.
    
     ![Отображение панели мониторинга группы доступности](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665532.gif)
11. Ваш **панели мониторинга AlwaysOn** следует искать аналогичные toohello один в hello следующий снимок экрана. Вы увидите реплики hello, hello режима отработки отказа для каждой реплики и состояние синхронизации hello.
    
     ![Панель мониторинга группы доступности](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665533.gif)
12. Возвращает слишком**диспетчера сервера**, нажмите кнопку **средства**и откройте **Диспетчер отказоустойчивости кластеров**.
13. Разверните элемент **Cluster1.corp.contoso.com**, а затем разверните элемент **Службы и приложения**. Выберите **ролей** и обратите внимание, что hello **AG1** была создана роль группы доступности. Обратите внимание, что AG1 не имеет IP-адрес, базы данных, который клиенты могут подключаться toohello группы доступности, так как не удалось настроить прослушиватель. Можно подключаться напрямую toohello основным узлом для операций чтения и записи и hello дополнительного узла для запросов только для чтения.
    
     ![Группа доступности в диспетчере отказоустойчивости кластеров](./media/virtual-machines-windows-classic-portal-sql-alwayson-availability-groups/IC665534.gif)

> [!WARNING]
> Не предпринимайте toofail hello группы доступности из hello диспетчера отказоустойчивости кластеров. Все операции отработки отказа следует выполнять через **панель мониторинга AlwaysOn** в SQL Server Management Studio. Дополнительные сведения см. в разделе [ограничения на использование hello Диспетчер отказоустойчивости кластеров с группами доступности](https://msdn.microsoft.com/library/ff929171.aspx).
> 
> 

## <a name="next-steps"></a>Дальнейшие действия
Решение SQL Server Always On на основе группы доступности в Azure успешно создано. tooconfigure прослушивателя для этой группы доступности. в разделе [настроить прослушиватель ILB для групп доступности AlwaysOn в Azure](../classic/ps-sql-int-listener.md).

Дополнительные сведения об использовании SQL Server в Azure см. в статье [Общие сведения об SQL Server на виртуальных машинах Azure](../sql/virtual-machines-windows-sql-server-iaas-overview.md).


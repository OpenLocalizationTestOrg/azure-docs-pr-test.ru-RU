---
title: "Инфраструктура и подключение к SAP HANA в Azure (крупные экземпляры) | Документация Майкрософт"
description: "Настройте требуемую инфраструктуру для подключения, чтобы использовать SAP HANA в Azure (крупные экземпляры)."
services: virtual-machines-linux
documentationcenter: 
author: RicksterCDN
manager: timlt
editor: 
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 12/01/2016
ms.author: rclaus
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 177627d8f72dbd04fb918ac7ece18321246a9c62
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="sap-hana-large-instances-infrastructure-and-connectivity-on-azure"></a>Инфраструктура и возможности подключения SAP HANA в Azure (крупные экземпляры) 

В этом руководстве используются некоторые общие определения. Ознакомьтесь с ними, прежде чем приступать к изучению руководства. В статье [Обзор и описание архитектуры SAP HANA в Azure (крупные экземпляры)](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/hana-overview-architecture) мы представили два разных класса единиц крупных экземпляров HANA с:

- S72, S72m, S144, S144m, S192 и S192m, которые обычно называются номерами SKU 1 класса;
- S384, S384m, S384xm, S576, S768 и S960, которые обычно называются номерами SKU 2 класса.

В документации по крупным экземплярам HANA описатели классов будут использоваться для ссылки на различные возможности и требования, основанные на номерах SKU крупных экземпляров HANA.

Кроме того, часто используются следующие определения.
- **Стек крупных экземпляров:** сертифицированный для программы SAP HANA TDI аппаратный стек, предназначенный для запуска экземпляров SAP HANA в Azure.
- **SAP HANA в Azure (крупные экземпляры):** официальное название предложения в Azure, предусматривающее запуск экземпляров SAP HANA на оборудовании, сертифицированном для программы SAP HANA TDI, которые развертываются в стеках крупных экземпляров в разных регионах Azure. Связанный термин **крупные экземпляры HANA** — сокращенное название SAP HANA в Azure (крупные экземпляры), которое широко используется в этом техническом руководстве по развертыванию.
 

После завершения процесса покупки SAP HANA в Azure (крупные экземпляры) со службой поддержки корпоративных учетных записей Майкрософт необходимо указать следующие сведения, чтобы специалисты Майкрософт развернули единицы крупных экземпляров HANA:

- Имя клиента.
- Корпоративные контактные сведения (адрес электронной почты и номер телефона).
- Технические контактные сведения (адрес электронной почты и номер телефона).
- Технические сетевые контактные сведения (адрес электронной почты и номер телефона).
- Регион развертывания Azure (запад США, восток США, Восточная Австралия, Юго-Восточная Австралия, Западная Европа и Северная Европа, начиная с июля 
- 2017)
- Подтверждение номера SKU SAP HANA в Azure (крупные экземпляры) (конфигурация).
- Как уже упоминалось в документах с общими сведениями и данными об архитектуре, крупные экземпляры HANA для каждого региона Azure развертываются в следующих ресурсах:
    - диапазон IP-адресов с маской /29 для подключений ER-P2P между виртуальными сетями Azure и крупными экземплярами HANA;
    - блок CIDR с маской /24 (используется для пула NAT крупных экземпляров HANA).
- Значения диапазона IP-адресов, используемые в атрибуте адресного пространства виртуальной сети, каждой виртуальной сети Azure, которая будет подключаться к крупным экземплярам HANA.
- Данные для каждой системы крупных экземпляров HANA:
  - Требуемое имя узла (в идеале с полным доменным именем).
  - Требуемый IP-адрес для единицы крупного экземпляра HANA вне диапазона IP-адресов пула серверов. Помните, что первые 30 IP-адресов в диапазоне IP-адресов пула серверов зарезервированы для внутреннего использования в крупных экземплярах HANA.
  - Имя ИД безопасности SAP HANA для экземпляра SAP HANA (требуется для создания необходимых томов дисков SAP HANA). ИД безопасности HANA необходим для создания разрешений для <sidadm> на томах NFS, которые присоединяются к единице крупного экземпляра HANA. Он также используется как один из компонентов имени подключаемых томов на диске. Для запуска более одного экземпляра HANA на одной единице необходимо перечислить несколько идентификаторов безопасности HANA. Каждый из них возвращает отдельный набор назначенных томов.
  - Идентификатор группы пользователя hana-sidadm в ОС Linux требуется для создания томов диска, связанных с SAP HANA. При установке SAP HANA обычно создается группа sapsys с идентификатором группы 1001, в которую входит пользователь hana-sidadm.
  - Идентификатор пользователя hana-sidadm в ОС Linux требуется для создания томов диска, связанных с SAP HANA. Если на одной единице запущено несколько экземпляров HANA, необходимо перечислить всех администраторов <sid> 
- Идентификатор подписки Azure, к которой будет напрямую подключаться SAP HANA в Azure (крупные экземпляры). Этот идентификатор подписки ссылается на подписку Azure, которая будет связана с единицами HANA (крупные экземпляры).

После того как вы предоставите сведения, специалисты Майкрософт подготовят SAP HANA в Azure (крупные экземпляры) и отправят вам сведения, необходимые для связывания ваших виртуальных сетей Azure с крупными экземплярами HANA и доступа к единицам крупных экземпляров HANA.

## <a name="connecting-azure-vms-to-hana-large-instances"></a>Подключение виртуальных машин Azure к крупным экземплярам HANA

Как уже упоминалось в статье [Обзор и описание архитектуры SAP HANA в Azure (крупные экземпляры)](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/hana-overview-architecture), минимальное развертывание крупных экземпляров HANA с уровнем приложений SAP в Azure выглядит следующим образом:

![Виртуальная сеть Azure подключена к SAP HANA в Azure (крупные экземпляры) и к локальной сети](./media/hana-overview-architecture/image3-on-premises-infrastructure.png)

Обратите внимание на виртуальную сеть Azure. Для нее требуется следующее:

- Определение виртуальной сети Azure, которое будет использоваться для развертывания виртуальных машин на уровне приложений SAP.
- Это автоматически означает, что в виртуальной сети Azure определяется подсеть по умолчанию, в которой будут фактически развернуты виртуальные машины.
- В создаваемой виртуальной сети Azure должна быть по крайней мере одна подсеть виртуальной машины и одна подсеть шлюза для ExpressRoute. Таким подсетям нужно назначить диапазоны IP-адресов в соответствии со сведениями, указанными в разделах ниже.

Итак, давайте подробнее рассмотрим создание виртуальной сети Azure для крупных экземпляров HANA.

### <a name="creating-the-azure-vnet-for-hana-large-instances"></a>Создание виртуальной сети Azure для крупных экземпляров HANA

>[!Note]
>Эту виртуальную сеть Azure для крупных экземпляров HANA следует создавать с использованием модели развертывания с помощью Azure Resource Manager. Крупные экземпляры HANA не поддерживают старую модель развертывания Azure, известную как классическая модель развертывания.

Виртуальную сеть можно создать с помощью портала Azure, PowerShell, шаблона Azure или Azure CLI (см. статью [Создание виртуальной сети с помощью портала Azure](../../../virtual-network/virtual-networks-create-vnet-arm-pportal.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)). В следующем примере мы рассмотрим виртуальную сеть, созданную с помощью портала Azure.

Просматривая определения виртуальной сети Azure на портале Azure, давайте обратим внимание на некоторые определения и их взаимосвязь с перечисленными ниже различными диапазонами IP-адресов. Говоря об **адресном пространстве**, мы имеем в виду адресное пространство, которое разрешено использовать виртуальной сети Azure. Оно будет использоваться в виртуальной сети для распространения маршрутов BGP. Это **адресное пространство** можно увидеть здесь:

![Адресное пространство виртуальной сети Azure на портале Azure](./media/hana-overview-connectivity/image1-azure-vnet-address-space.png)

В предыдущем случае пространству адресов 10.16.0.0/16 виртуальной сети Azure назначен достаточно большой диапазон IP-адресов. Это значит, что все диапазоны IP-адресов последующих подсетей в виртуальной сети могут входить в указанное адресное пространство. Обычно мы не рекомендуем использовать настолько большой диапазон адресов для одной виртуальной сети в Azure. Однако давайте заглянем немного наперед и посмотрим подсети, определенные в виртуальной сети Azure:

![Подсети виртуальной сети Azure и их IP-адреса](./media/hana-overview-connectivity/image2b-vnet-subnets.png)

Как видно, создана виртуальная сеть с первой подсетью виртуальной машины (default) и подсеть GatewaySubnet.
В следующем разделе мы будем называть диапазон IP-адресов подсети default на снимке экрана **диапазоном IP-адресов подсети виртуальной машины Azure**, а диапазон IP-адресов подсети шлюза — **диапазоном IP-адресов подсети шлюза виртуальной сети**. 

В случае выше на двух снимках экрана можно увидеть, что в **адресное пространство виртуальной сети** входит **диапазон IP-адресов подсети виртуальной машины Azure** и **диапазон IP-адресов подсети шлюза виртуальной сети**. 

В других случаях, где необходимо сохранить диапазоны IP-адресов или использовать определенные диапазоны, можно ограничить **адресное пространство виртуальной сети** определенными диапазонами, используемыми каждой подсетью. В этом случае **адресное пространство виртуальной сети** можно определить как несколько конкретных диапазонов, как показано ниже:

![Адресное пространство виртуальной сети Azure в качестве двух пространств](./media/hana-overview-connectivity/image3-azure-vnet-address-space_alternate.png)

В этом случае для **адресного пространства виртуальной сети** определено два пространства, идентичных диапазонам IP-адресов, определенным для **диапазона IP-адресов подсети виртуальной машины Azure** и **диапазона IP-адресов подсети шлюза виртуальной сети**.

Для этих подсетей клиента (подсетей виртуальной машины) можно использовать любой стандарт именования. Тем не менее **каждой виртуальной подсети должна соответствовать только одна подсеть шлюза**, подключающаяся к каналу ExpressRoute для SAP HANA в Azure (крупные экземпляры). **Эту подсеть шлюза нужно называть GatewaySubnet**, чтобы обеспечить правильное размещение шлюза ExpressRoute.

> [!WARNING] 
> Крайне важно, чтобы подсеть шлюза называлась GatewaySubnet.

Вы можете использовать несколько подсетей виртуальной машины, даже при применении несмежных адресов. Однако, как упоминалось ранее, эти диапазоны адресов должны входить в **адресное пространство виртуальной сети** и указываться в сводной форме или в списке точных диапазонов подсетей виртуальной машины и подсети шлюза.

Ниже представлены важные факты о виртуальной сети Azure, которая подключается к крупным экземплярам HANA:

- При выполнении первоначального развертывания больших экземпляров HANA необходимо отправить **адресное пространство виртуальной сети** в корпорацию Майкрософт. 
- **Адресное пространство адресов виртуальной сети** может представлять собой один большой диапазон, охватывающий диапазоны IP-адресов подсети виртуальной машины Azure и диапазон IP-адресов подсети шлюза,
- или несколько диапазонов, **охватывающих разные** диапазоны IP-адресов в пределах диапазонов IP-адресов подсети виртуальной машины и диапазона IP-адресов подсети шлюза.
- Определенное **адресное пространство виртуальной сети** используется для распространения маршрутов BGP.
- Для подсети шлюза должно использоваться имя **GatewaySubnet**.
- **Адресное пространство виртуальной сети** используется в качестве фильтра на стороне крупных экземпляров HANA, чтобы разрешать или запрещать передачу трафика к единицам крупных экземпляров HANA из Azure. Если сведения о маршрутах BGP виртуальной сети Azure и диапазонах IP-адресов, настроенных для фильтрации на стороне крупных экземпляров HANA, не совпадают, могут возникнуть проблемы с подключением.
- В разделе "Подключение виртуальной сети к каналу ExpressRoute крупных экземпляров HANA" ниже указаны некоторые дополнительные сведения о подсети шлюза.



### <a name="different-ip-address-ranges-to-be-defined"></a>Определение разных диапазонов IP-адресов 

В предыдущих разделах мы уже рассмотрели некоторые диапазоны IP-адресов, необходимые для развертывания крупных экземпляров HANA. Однако стоит упомянуть и о других важных диапазонах IP-адресов. Давайте рассмотрим их подробнее. Вам нужно определить следующие IP-адреса перед отправкой запроса на первоначальное развертывание (лишь некоторые из них нужно отправлять в корпорацию Майкрософт):

- **Адресное пространство виртуальной сети** — это диапазон IP-адресов (как уже представлено выше), назначенный (или который планируется назначить) пространству адресов виртуальной сети Azure, которая подключается к среде крупных экземпляров SAP HANA. Мы рекомендуем, чтобы параметр адресного пространства использовался в качестве многострочного значения, состоящего из диапазонов подсети виртуальной машины Azure и диапазона подсети шлюза Azure, как показано на рисунке выше. Этот диапазон НЕ ДОЛЖЕН пересекаться с локальным диапазоном адресов, диапазоном IP-адресов пула серверов или с диапазоном адресов ER-P2P. Как это можно осуществить? Специалисты по работе с корпоративными сетями или поставщик услуг должны предоставить один или несколько диапазонов IP-адресов в сети или вне ее. Например, если используется подсеть виртуальной машины Azure 10.0.1.0/24 (см. выше) и подсеть шлюза Azure 10.0.2.0/28 (см. ниже), мы рекомендуем применять адресное пространство виртуальной сети Azure 10.0.1.0/24 и 10.0.2.0/28. Хотя значения адресных пространств можно агрегировать, мы рекомендуем сопоставить их с диапазонами подсетей, чтобы избежать случайного повторного использования неиспользуемых диапазонов IP-адресов с более крупными адресными пространствами в сети в будущем. **Адресное пространство виртуальной сети — это диапазон IP-адресов, который нужно отправить в корпорацию Майкрософт вместе с запросом на первоначальное развертывание.**

- **Диапазон IP-адресов подсети виртуальной машины Azure** — это диапазон IP-адресов (как уже представлено выше), назначенный (или который планируется назначить) подсети виртуальной сети Azure, которая подключается к среде крупных экземпляров SAP HANA. Этот диапазон IP-адресов используется для назначения IP-адресов виртуальным машинам Azure. IP-адреса вне этого диапазона разрешено использовать для подключения к серверам крупных экземпляров SAP HANA. При необходимости можно использовать несколько подсетей виртуальной машины Azure. Майкрософт рекомендует использовать по блоку CIDR с маской /24 для каждой подсети виртуальной машины Azure. Этот диапазон адресов должен быть частью значений, используемых в адресном пространстве виртуальной сети Azure. Как это можно осуществить? Специалисты по работе с корпоративными сетями или поставщик услуг должен предоставить диапазон IP-адресов вне сети.

- **Диапазон IP-адресов подсети шлюза виртуальной сети.** В зависимости от функций, которые планируется использовать, мы рекомендуем применять следующие размеры:
   - Ультрапроизводительный шлюз ExpressRoute: блок адресов размером /26 — требуется для номеров SKU класса II
   - Сосуществование с VPN и ExpressRoute с применением шлюза HighPerformance ExpressRoute (или более низкой версии): блок адресов размером /27.
   - Другие ситуации: блок адресов размером /28. Этот диапазон адресов должен быть частью значений, используемых в адресном пространстве виртуальной сети. Этот диапазон адресов должен быть частью значений, используемых в адресном пространстве виртуальной сети Azure, которые нужно отправить в корпорацию Майкрософт. Как это можно осуществить? Специалисты по работе с корпоративными сетями или поставщик услуг должен предоставить диапазон IP-адресов вне сети. 

- **Диапазон адресов для подключения ER-P2P** — это диапазон IP-адресов для однорангового подключения ExpressRoute (ER) крупных экземпляров SAP HANA. Это должен быть диапазон IP-адресов CIDR с маской /29. Этот диапазон НЕ ДОЛЖЕН пересекаться с локальным диапазоном адресов и с другими диапазонами IP-адресов Azure. Он используется для настройки подключения ER между шлюзом ExpressRoute виртуальной сети Azure и серверами крупных экземпляров SAP HANA. Как это можно осуществить? Специалисты по работе с корпоративными сетями или поставщик услуг должен предоставить диапазон IP-адресов вне сети. **Этот диапазон IP-адресов нужно отправить в корпорацию Майкрософт вместе с запросом на первоначальное развертывание.**
  
- **Диапазон IP-адресов пула серверов.** Этот диапазон IP-адресов используется для назначения отдельных IP-адресов серверам больших экземпляров HANA. Мы рекомендуем использовать такой размер подсети, как блоки CIDR с маской /24. При необходимости его можно уменьшить, чтобы предоставлять минимальное число IP-адресов (64). Первые 30 IP-адресов в этом диапазоне будут зарезервированы для использования корпорацией Майкрософт. Учитывайте это, выбирая размер диапазона. Этот диапазон НЕ ДОЛЖЕН пересекаться с локальным диапазоном адресов и с другими диапазонами IP-адресов Azure. Как это можно осуществить? Специалисты по работе с корпоративными сетями или поставщик услуг должен предоставить диапазон IP-адресов вне сети. Уникальный блок CIDR с диапазоном /24 (рекомендуется) для назначения определенных IP-адресов, необходимых для SAP HANA в Azure (крупные экземпляры). **Этот диапазон IP-адресов нужно отправить в корпорацию Майкрософт вместе с запросом на первоначальное развертывание.**
 
Хотя необходимо определить и спланировать диапазоны IP-адресов выше, не все из них нужно отправлять в корпорацию Майкрософт. Итак, вам нужно отправить в корпорацию Майкрософт следующие диапазоны IP-адресов:

- Адресное пространство виртуальной сети Azure.
- Диапазон IP-адресов для подключений ER-P2P.
- Диапазон IP-адресов пула серверов.

Для добавления дополнительных виртуальных сетей, которым требуется подключиться к крупным экземплярам HANA, необходимо отправить новое адресное пространство виртуальной сети Azure, добавляемой в корпорацию Майкрософт. 

Ниже приведен пример различных диапазонов, которые нужно настроить и отправить в корпорацию Майкрософт. В первом примере значение адресного пространства виртуальной сети Azure не агрегировано. Оно определяется по диапазонам первого диапазона IP-адресов подсети виртуальной машины Azure и диапазона IP-адресов подсети шлюза виртуальной сети. Чтобы вы могли использовать несколько подсетей виртуальной машины в виртуальной сети Azure соответствующим образом, настройте и отправьте дополнительные диапазоны IP-адресов дополнительных виртуальных подсетей в составе адресного пространства виртуальной сети Azure.

![Диапазоны IP-адресов, необходимые для минимального развертывания SAP HANA в Azure (крупные экземпляры)](./media/hana-overview-connectivity/image4b-ip-addres-ranges-necessary.png)

Вы также можете выполнить статистическую обработку данных, отправляемых в корпорацию Майкрософт. В этом случае адресное пространство виртуальной сети Azure будет содержать всего одно пространство. Если использовать диапазоны IP-адресов из примера выше, агрегированное адресное пространство виртуальной сети может выглядеть так:

![Второй вариант диапазонов IP-адресов, необходимых для минимального развертывания SAP HANA в Azure (крупные экземпляры)](./media/hana-overview-connectivity/image5b-ip-addres-ranges-necessary-one-value.png)

Как можно заметить, вместо двух диапазонов меньшего размера, определяющих адресное пространство виртуальной сети Azure, у нас есть один больший диапазон, охватывающий 4096 IP-адресов. При таком крупном определении адресного пространства некоторые крупные диапазоны не используются. Так как значения адресного пространства виртуальной сети используются для распространения маршрутов BGP, использование неиспользуемых диапазонов локально или в другой части сети может вызвать проблемы маршрутизации. Поэтому мы рекомендуем обеспечить точное соответствие адресного пространства фактически используемому адресному пространству подсети. При необходимости вы можете в любое время добавить новые значения адресного пространства позже, не вызывая простои в виртуальной сети.
 
> [!IMPORTANT] 
> IP-адреса адресного пространства ER-P2P, пула серверов и виртуальной сети Azure **НЕ** должны пересекаться между собой или с другими диапазонами IP-адресов в сети. Это должны быть отдельные адреса и, как показано на двух рисунках выше, они не должны быть частью подсети другого диапазона. Если диапазоны пересекаются, виртуальная сеть Azure может не подключиться к каналу ExpressRoute.

### <a name="next-steps-after-address-ranges-have-been-defined"></a>Дальнейшие действия после определения диапазонов адресов
После определения диапазонов IP-адресов нужно сделать следующее:

1. Отправьте диапазоны IP-адресов для адресного пространства виртуальной сети Azure, подключения ER-P2P и диапазона IP-адресов пула серверов, а также другие данные, указанные в начале документа. Сейчас также можно приступить к созданию виртуальной сети и подсети виртуальной машины. 
2. Корпорация Майкрософт создает канал ExpressRoute между подпиской Azure и стеком крупных экземпляров HANA.
3. Корпорация Майкрософт создает клиентскую сеть в стеке крупных экземпляров.
4. Специалисты Майкрософт настроят сеть таким образом, чтобы инфраструктура SAP HANA в Azure (крупные экземпляры) принимала IP-адреса из адресного диапазона виртуальной сети Azure, которая будет взаимодействовать с крупными экземплярами HANA.
5. В зависимости от конкретного приобретенного SKU SAP HANA в Azure (крупные экземпляры), корпорация Майкрософт назначит единицу вычисления в сети клиента, выделит и подключит хранилище, а также установит операционную систему (SUSE или RedHat Linux). IP-адреса для этих единиц берутся из диапазона IP-адресов пула серверов, отправленного в корпорацию Майкрософт.

В конце развертывания специалисты Майкрософт отправят вам следующие данные:
- Сведения, нужные для подключения виртуальной сети Azure к каналу ExpressRoute, по которому они подключаются к крупным экземплярам HANA.
     - ключи авторизации;
     - код узла ExpressRoute.
- Данные для доступа к крупным экземплярам HANA по настроенному каналу ExpressRoute и виртуальной сети Azure.

Можно также обратиться к последовательности подключения крупных экземпляров HANA, которая описана в документе [Комплексная настройка крупных экземпляров SAP HANA](https://azure.microsoft.com/resources/sap-hana-on-azure-large-instances-setup/). Многие из следующих действий демонстрируются в примере развертывания в этом документе. 


## <a name="connecting-a-vnet-to-hana-large-instance-expressroute"></a>Подключение виртуальной сети к каналу ExpressRoute крупных экземпляров HANA

Определив диапазоны IP-адресов и получив данные из корпорации Майкрософт, вы можете приступить к подключению виртуальной сети, созданной ранее, к крупным экземплярам HANA. После создания виртуальной сети Azure в ней нужно создать шлюз ExpressRoute, чтобы связать эту виртуальную сеть с каналом ExpressRoute, подключающимся к клиенту пользователя по метке крупного экземпляра.

> [!NOTE] 
> Это может занять до 30 минут, так как при этом создается шлюз в обозначенной подписке Azure, который затем подключается к указанной виртуальной сети Azure.

Если шлюз уже существует, проверьте, является ли он шлюзом ExpressRoute. В противном случае шлюз необходимо удалить и повторно создать в качестве шлюза ExpressRoute. Если шлюз ExpressRoute уже установлен, а виртуальная сеть Azure подключена к каналу ExpressRoute для локального подключения, перейдите к разделу "Связывание виртуальных сетей" ниже.

- Используйте новый [портал Azure](https://portal.azure.com/) или PowerShell, чтобы создать VPN-шлюз ExpressRoute, подключенный к виртуальной сети.
  - Если вы используете портал Azure, добавьте новый **шлюз виртуальной сети**, а затем в качестве типа шлюза выберите **ExpressRoute**.
  - Если же вы выбрали PowerShell, сначала скачайте и используйте последнюю версию [пакета SDK для Azure PowerShell](https://azure.microsoft.com/downloads/) для оптимальной работы. Следующие команды создают шлюз ExpressRoute. Текст, перед которым стоит символ _$_, — это определяемые пользователем переменные, которые нужно обновить, используя ваши сведения.

```PowerShell
# These Values should already exist, update to match your environment
$myAzureRegion = "eastus"
$myGroupName = "SAP-East-Coast"
$myVNetName = "VNet01"

# These values are used to create the gateway, update for how you wish the GW components to be named
$myGWName = "VNet01GW"
$myGWConfig = "VNet01GWConfig"
$myGWPIPName = "VNet01GWPIP"
$myGWSku = "HighPerformance" # Supported values for HANA Large Instances are: HighPerformance or UltraPerformance

# These Commands create the Public IP and ExpressRoute Gateway
$vnet = Get-AzureRmVirtualNetwork -Name $myVNetName -ResourceGroupName $myGroupName
$subnet = Get-AzureRmVirtualNetworkSubnetConfig -Name 'GatewaySubnet' -VirtualNetwork $vnet
New-AzureRmPublicIpAddress -Name $myGWPIPName -ResourceGroupName $myGroupName `
-Location $myAzureRegion -AllocationMethod Dynamic
$gwpip = Get-AzureRmPublicIpAddress -Name $myGWPIPName -ResourceGroupName $myGroupName
$gwipconfig = New-AzureRmVirtualNetworkGatewayIpConfig -Name $myGWConfig -SubnetId $subnet.Id `
-PublicIpAddressId $gwpip.Id

New-AzureRmVirtualNetworkGateway -Name $myGWName -ResourceGroupName $myGroupName -Location $myAzureRegion `
-IpConfigurations $gwipconfig -GatewayType ExpressRoute `
-GatewaySku $myGWSku -VpnType PolicyBased -EnableBgp $true
```

В этом примере использовался номер SKU шлюза HighPerformance. Имеются следующие варианты: HighPerformance или UltraPerformance. Это единственные номера SKU шлюза, которые поддерживает SAP HANA в Azure (крупные экземпляры).

> [!IMPORTANT]
> Для больших экземпляров HANA с номерами SKU типов S384, S384m, S384xm, S576, S768 и S960 (номера SKU класса II) использование номер SKU ультрапроизводительного шлюза является обязательным.

### <a name="linking-vnets"></a>Связывание виртуальных сетей

Теперь, когда для виртуальной сети Azure создан шлюз ExpressRoute, используйте сведения об авторизации, предоставленные корпорацией Майкрософт, для подключения шлюза ExpressRoute к каналу ExpressRoute SAP HANA в Azure (крупные экземпляры), созданного именно для этого. Это можно сделать на портале Azure или с помощью PowerShell. Мы рекомендуем использовать портал. Тем не менее далее указаны инструкции для PowerShell. 

- Выполните следующие команды для каждого шлюза виртуальной сети, используя разные AuthGUID для каждого подключения. Первые две записи, приведенные в сценарии ниже, получены из сведений, предоставленных корпорацией Майкрософт. Кроме того, каждый AuthGUID связан с конкретной виртуальной сетью и шлюзом. Это значит, что если вы хотите добавить еще одну виртуальную сеть Azure, вам необходимо получить другой AuthID для канала ExpressRoute, по которому крупные экземпляры HANA подключаются к Azure. 

```PowerShell
# Populate with information provided by Microsoft Onboarding team
$PeerID = "/subscriptions/9cb43037-9195-4420-a798-f87681a0e380/resourceGroups/Customer-USE-Circuits/providers/Microsoft.Network/expressRouteCircuits/Customer-USE01"
$AuthGUID = "76d40466-c458-4d14-adcf-3d1b56d1cd61"

# Your ExpressRoute Gateway Information
$myGroupName = "SAP-East-Coast"
$myGWName = "VNet01GW"
$myGWLocation = "East US"

# Define the name for your connection
$myConnectionName = "VNet01GWConnection"

# Create a new connection between the ER Circuit and your Gateway using the Authorization
$gw = Get-AzureRmVirtualNetworkGateway -Name $myGWName -ResourceGroupName $myGroupName
    
New-AzureRmVirtualNetworkGatewayConnection -Name $myConnectionName `
-ResourceGroupName $myGroupName -Location $myGWLocation -VirtualNetworkGateway1 $gw `
-PeerId $PeerID -ConnectionType ExpressRoute -AuthorizationKey $AuthGUID
```

Возможно, вам потребуется сделать это несколько раз, если вы хотите подключить шлюз к нескольким каналам ExpressRoute, связанным с вашей подпиской. Например, скорее всего, вам потребуется подключить тот же шлюз виртуальной сети к каналу ExpressRoute, с помощью которого виртуальная сеть подключается к локальной сети.

## <a name="adding-more-ip-addresses-or-subnets"></a>Добавление дополнительных IP-адресов или подсетей

При добавлении дополнительных IP-адресов или подсетей используйте портал Azure, PowerShell или интерфейс командной строки.

В этом случае мы рекомендуем добавить новый диапазон IP-адресов в адресное пространство виртуальной сети, а не создавать агрегированный диапазон. В любом случае необходимо отправить соответствующие сведения в корпорацию Майкрософт, чтобы разрешить подключение к единицам крупных экземпляров HANA в клиентском приложении с использованием нового диапазона IP-адресов. Вы можете отправить запрос на добавление адресного пространства виртуальной сети в службу поддержки Azure. Получив подтверждение, выполните следующие шаги.

Чтобы создать дополнительные подсети с помощью портала Azure, см. статью [Создание виртуальной сети с помощью портала Azure](../../../virtual-network/virtual-networks-create-vnet-arm-pportal.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json), а для создания с помощью PowerShell см. статью [Создание виртуальной сети с помощью PowerShell](../../../virtual-network/virtual-networks-create-vnet-arm-ps.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

## <a name="adding-vnets"></a>Добавление виртуальных сетей

Подключив одну или несколько виртуальных сетей Azure, вы, возможно, захотите добавить дополнительные виртуальные сети, которые обращаются к SAP HANA в Azure (крупные экземпляры). Сначала отправьте запрос на поддержку Azure и укажите в нем сведения о конкретном развертывании Azure и диапазоны IP-адресов из адресного пространства виртуальных сетей Azure. Затем специалисты службы поддержки "SAP HANA для управления службами Azure" предоставят сведения, необходимые для подключения дополнительных виртуальных сетей и ExpressRoute. Для каждой виртуальной сети следует использовать уникальный ключ авторизации для подключения к каналу ExpressRoute для крупных экземпляров HANA.

Процедура добавления новой виртуальной сети Azure

1. Выполните первый шаг в процессе внедрения (см. раздел _Создание виртуальной сети Azure_).
2. Выполните второй шаг в процессе внедрения (см. раздел _Создание подсети шлюза_).
3. Откройте запрос на поддержку Azure, указав сведения о новой виртуальной сети, и запросите новый ключ авторизации для подключения дополнительных виртуальных сетей к каналу ExpressRoute крупных экземпляров HANA.
4. Получив уведомление о завершении авторизации, используйте сведения об авторизации, предоставленные корпорацией Майкрософт, чтобы выполнить третий шаг в процессе внедрения (см. раздел _Связывание виртуальных сетей_).

## <a name="increasing-expressroute-circuit-bandwidth"></a>Повышение пропускной способности канала ExpressRoute

Обратитесь в службу поддержки решения "SAP HANA для управления службами Azure". Если вам порекомендовали увеличить пропускную способность канала ExpressRoute SAP HANA в Azure (крупные экземпляры), создайте запрос на поддержку Azure. (Вы можете отправить запрос о повышении пропускной способности одного канала до максимального показателя — 10 Гбит/с.) После завершения операции вы получите уведомление. Чтобы таким образом повысить производительность в Azure, не нужно больше ничего делать.

## <a name="adding-an-additional-expressroute-circuit"></a>Добавление дополнительного канала ExpressRoute

Обратитесь в службу поддержки решения "SAP HANA для управления службами Azure", если вам порекомендовали добавить дополнительный канал ExpressRoute. Отправьте запрос на поддержку Azure для создания канала ExpressRoute (а также для получения сведений об авторизации для подключения к нему). Перед этим определите адресное пространство, которое будет использоваться в виртуальной сети, чтобы специалисты службы поддержки решения "SAP HANA для управления службами Azure" предоставили вам возможность авторизации.

После создания канала и завершения настройки решения "SAP HANA для управления службами Azure" вы получите уведомление со сведениями, необходимыми, чтобы продолжить. Выполните шаги, описанные выше, чтобы создать виртуальную сеть и подключить ее к этому дополнительному каналу. Вы не сможете подключить виртуальные сети Azure к этому дополнительному каналу, если они уже подключены к другому каналу ExpressRoute SAP HANA в Azure (крупные экземпляры) в том же регионе Azure.

## <a name="deleting-a-subnet"></a>Удаление подсети

Чтобы удалить подсеть виртуальной сети, можно использовать портал Azure, PowerShell или интерфейс командной строки. Если диапазон IP-адресов или адресное пространство виртуальной сети Azure представляли собой агрегированный диапазон, вам не нужно ничего отправлять в Майкрософт. Однако виртуальная сеть распространяет маршруты BGP по адресному пространству, включающему удаленную подсеть. Если вы определили диапазон IP-адресов или адресное пространство виртуальной сети Azure как несколько диапазонов IP-адресов, один из которых был назначен удаленной подсети, его следует удалить из адресного пространства виртуальной сети и сообщить специалистам отдела по управлению службами SAP HANA в Azure, что его нужно удалить из диапазонов, с которыми разрешено взаимодействовать SAP HANA в Azure (крупные экземпляры).

Хотя на сайте Azure.com нет конкретных рекомендаций по удалению подсетей, этот процесс противоположен процессу добавления. Дополнительные сведения о создании подсетей см. в статье [Создание виртуальной сети с помощью портала Azure](../../../virtual-network/virtual-networks-create-vnet-arm-pportal.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

## <a name="deleting-a-vnet"></a>Удаление виртуальной сети

При удалении виртуальной сети используйте портал Azure, PowerShell или интерфейс командной строки. Специалисты отдела по управлению службами SAP HANA в Azure удаляют существующую авторизацию для канала ExpressRoute HANA SAP в Azure (крупные экземпляры), а также удаляют диапазоны IP-адресов и адресное пространство виртуальной сети Azure для взаимодействия с крупными экземплярами HANA.

После удаления виртуальной сети откройте запрос на поддержку Azure, чтобы указать адресные пространства диапазона IP-адресов, которые следует удалить.

Хотя на сайте Azure.com нет конкретных рекомендаций по удалению виртуальных сетей, этот процесс противоположен процессу добавления (описано выше). Дополнительные сведения о создании виртуальных сетей см. в статьях [Создание виртуальной сети с помощью портала Azure](../../../virtual-network/virtual-networks-create-vnet-arm-pportal.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) и [Создание виртуальной сети с помощью PowerShell](../../../virtual-network/virtual-networks-create-vnet-arm-ps.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

Чтобы убедиться, что все удалено, удалите следующие компоненты:

- Подключение ExpressRoute, шлюз виртуальной сети, общедоступный IP-адрес шлюза виртуальной сети и виртуальную сеть.

## <a name="deleting-an-expressroute-circuit"></a>Удаление канала ExpressRoute

Чтобы удалить дополнительный канал ExpressRoute SAP HANA в Azure (крупные экземпляры), откройте запрос на поддержку Azure в службе поддержки решения "SAP HANA для управления службами Azure" и укажите, что нужно удалить канал. В подписке Azure вы можете по желанию удалить или оставить виртуальную сеть. Тем не менее нужно удалить подключение между каналом ExpressRoute крупных экземпляров HANA и связанным шлюзом виртуальной сети.

Если требуется также удалить виртуальную сеть, следуйте соответствующим указаниям в предыдущем разделе.



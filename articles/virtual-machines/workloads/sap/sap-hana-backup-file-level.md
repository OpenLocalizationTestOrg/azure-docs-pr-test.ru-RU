---
title: "Резервное копирование SAP HANA в Azure на уровне файлов | Документация Майкрософт"
description: "Существуют две основные возможности резервного копирования SAP HANA на виртуальных машинах Azure. В этой статье рассматривается резервное копирование на уровне файлов."
services: virtual-machines-linux
documentationcenter: 
author: hermanndms
manager: timlt
editor: 
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ums.tgt_pltfrm: vm-linux
ms.workload: infrastructure-services
ms.date: 3/13/2017
ms.author: rclaus
ms.openlocfilehash: 5db0ceb1648b5afa278e1cbe1c42fce8033bfdc1
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="sap-hana-azure-backup-on-file-level"></a>Резервное копирование SAP HANA в Azure на уровне файлов

## <a name="introduction"></a>Введение

Эта статья входит в цикл из трех связанных статей, посвященных резервному копированию SAP HANA. В [руководстве по резервному копированию SAP HANA на виртуальных машинах Azure](./sap-hana-backup-guide.md) содержатся общие сведения, а также информация о начале работы, а в статье [Резервное копирование SAP HANA на основе моментальных снимков хранилища](./sap-hana-backup-storage-snapshots.md) рассматривается процесс резервного копирования на основе моментальных снимков.

К виртуальной машине Azure типа GS5 можно подключить максимум 64 диска данных. В крупных системах SAP HANA большее число этих дисков могут занимать файлы данных и журналов, а также программный RAID-массив, обеспечивающий оптимальную пропускную способность операций ввода-вывода на диске. Со временем возникает вопрос о том, где хранить файлы резервных копий SAP HANA после заполнения объема подключенных дисков данных. Таблицы размеров виртуальных машин Azure см. в [этой статье](../../linux/sizes.md).

Сейчас служба архивации Azure не поддерживает интеграцию с резервным копированием SAP HANA. Стандартный способ управления резервным копированием и восстановлением на уровне файлов заключается в создании резервных копий на основе файлов через SAP HANA Studio или инструкции SQL. Дополнительные сведения см. в [справочнике по системным представлениям и представлениям SQL для SAP HANA](https://help.sap.com/hana/SAP_HANA_SQL_and_System_Views_Reference_en.pdf).

![Диалоговое окно меню резервного копирования в SAP HANA Studio](media/sap-hana-backup-file-level/image022.png)

На рисунке выше показано диалоговое окно меню резервного копирования в SAP HANA Studio. Выбрав тип &quot;Файл&quot;, пользователь должен указать путь в файловой системе, по которому SAP HANA записывает файлы резервных копий. То же самое касается и процесса восстановления.

Хотя этот вариант выглядит простым, он имеет некоторые особенности. Как упоминалось ранее, к виртуальной машине Azure можно подключить ограничение количества дисков данных. В зависимости от размера базы данных и требований к пропускной способности диска, необходимой для программного RAID-массива, выполняющего чередование данных по нескольким дискам, доступной емкости может не хватать для хранения файлов резервных копий SAP HANA в файловых системах. Сведения о разных вариантах перемещения этих файлов резервных копий, а также об управлении ограничениями размера и производительностью при обработке терабайт данных приведены далее в этой статье.

Еще один вариант, обеспечивающий большую гибкость в отношении общей емкости, — это хранилище BLOB-объектов Azure. Сейчас отдельный большой двоичный объект может хранить 1 ТБ данных, но общий объем контейнера BLOB-объектов составляет 500 ТБ. Кроме того, пользователи могут использовать более экономичное &quot;холодное&quot; хранилище BLOB-объектов. Сведения об этом хранилище см. в статье [Хранилище BLOB-объектов Azure: "горячий" и "холодный" уровни хранилища](../../../storage/blobs/storage-blob-storage-tiers.md).

Чтобы обеспечить более высокий уровень безопасности, для хранения резервных копий SAP HANA используйте геореплицированную учетную запись хранения. Дополнительные сведения о репликации учетной записи хранения см. в статье [Репликация службы хранилища Azure](../../../storage/common/storage-redundancy.md).

Пользователи могут поместить выделенные виртуальные жесткие диски, на которых хранятся резервные копии SAP HANA, в геореплицированную учетную запись хранения резервных копий. Кроме того, эти виртуальные жесткие диски можно скопировать в геореплицированную учетную запись хранения или в учетную запись хранения, расположенную в другом регионе.

## <a name="azure-backup-agent"></a>Агент службы архивации Azure

Служба архивации Azure позволяет не только создавать полные резервные копии виртуальных машин, но также файлов и каталогов. Для этого используется агент службы архивации, который необходимо установить в гостевой ОС. С декабря 2016 года этот агент поддерживается только в операционной системе Windows. (Дополнительные сведения см. в статье [Архивация сервера Windows Server или клиента Windows в Azure с использованием модели развертывания с помощью Resource Manager](../../../backup/backup-configure-vault.md).)

В качестве обходного решения можно сначала скопировать файлы резервных копий SAP HANA на виртуальную машину Windows в Azure (например, через SAMBA), а затем использовать агент службы архивации Azure. Хотя технически это возможно, это усложняет и замедляет резервное копирование и восстановление из-за копирования между виртуальной машиной Linux и Windows. Мы не советуем использовать этот подход.

## <a name="azure-blobxfer-utility-details"></a>Сведения о служебной программе Azure blobxfer

Чтобы сохранить каталоги и файлы в службе хранилища Azure, можно использовать интерфейс командной строки, PowerShell или средство, разработанное на основе одного из [пакетов SDK](https://azure.microsoft.com/downloads/). Кроме того, можно использовать готовую служебную программу AzCopy для копирования данных в службу хранилища Azure, но она поддерживается только в операционной системе Windows. (Дополнительные сведения см. в статье [Приступая к работе со служебной программой командной строки AzCopy](../../../storage/common/storage-use-azcopy.md).)

Поэтому в рамках этой статьи для копирования файлов резервных копий SAP HANA мы используем blobxfer. Это средство с открытым исходным кодом доступно в [GitHub](https://github.com/Azure/blobxfer). Большое количество пользователей использует его в рабочих средах. Оно также позволяет копировать данные непосредственно в хранилище BLOB-объектов Azure или файловый ресурс Azure. Кроме того, это средство предоставляет ряд полезных возможностей, таких как поддержка MD5-хэша или автоматического параллелизма при копировании каталога с несколькими файлами.

## <a name="sap-hana-backup-performance"></a>Производительность резервного копирования SAP HANA

![Консоль резервного копирования SAP HANA в SAP HANA Studio](media/sap-hana-backup-file-level/image023.png)

На снимке экрана выше показана консоль резервного копирования SAP HANA в SAP HANA Studio. Создание резервной копии 230 ГБ данных на отдельном диске хранилища Azure класса Standard, подключенном к виртуальной машине HANA, с файловой системой XFS занимает приблизительно 42 минуты.

![Средство YaST на тестовой виртуальной машине SAP HANA](media/sap-hana-backup-file-level/image024.png)

На снимке экрана выше показано средство YaST на тестовой виртуальной машине SAP HANA. Как упоминалось ранее, резервные копии SAP HANA хранятся на отдельном диске емкостью 1 ТБ. Создание резервной копии 230 ГБ данных занимает приблизительно 42 минуты. Кроме того, к виртуальной машине подключены 5 дисков емкостью 200 ГБ, на которых установлен программный RAID-массив md0, выполняющий чередование по этим дискам данных Azure.

![Повторное резервное копирование в программном RAID-массиве с чередованием по пяти дискам данных хранилища Azure класса Standard](media/sap-hana-backup-file-level/image025.png)

Время повторного резервного копирования в программном RAID-массиве с чередованием по пяти дискам данных хранилища Azure класса Standard сократилось с 42 до 10 минут. Диски, подключенные к виртуальной машине, не кэшируются. Поэтому очевидно, что время резервного копирования сильно зависит от пропускной способности операций записи. Чтобы оптимизировать производительность процесса, пользователи могут использовать хранилище Azure класса Premium. Как правило, это хранилище следует использовать в рабочих системах.

## <a name="copy-sap-hana-backup-files-to-azure-blob-storage"></a>Копирование файлов резервных копий SAP HANA в хранилище BLOB-объектов Azure

С декабря 2016 года самый лучший вариант в плане быстрого сохранения файлов резервных копий SAP HANA — использовать хранилище BLOB-объектов Azure. Отдельный контейнер больших двоичных объектов может хранить 500 ТБ данных. Этого объема достаточно для хранения резервных копий большинства систем SAP HANA, выполняющихся на виртуальной машине типа GS5 в Azure. Пользователи могут выбирать между &quot;горячим&quot; и &quot;холодным&quot; хранилищем BLOB-объектов. (Дополнительные сведения см. в статье [Хранилище BLOB-объектов Azure: "горячий" и "холодный" уровни хранилища](../../../storage/blobs/storage-blob-storage-tiers.md).)

Средство blobxfer упрощает копирование файлов резервных копий SAP HANA непосредственно в хранилище BLOB-объектов Azure.

![Файлы полной резервной копии SAP HANA](media/sap-hana-backup-file-level/image026.png)

На снимке экрана выше показаны файлы полной резервной копии SAP HANA. Эта полная резервная копия состоит из 4 файлов. Размер самого большого файла составляет примерно 230 ГБ.

![Копирование 230 ГБ данных в контейнер больших двоичных объектов учетной записи хранения класса Standard занимает примерно 3000 секунд](media/sap-hana-backup-file-level/image027.png)

Копирование 230 ГБ данных в контейнер больших двоичных объектов учетной записи хранения класса Standard занимает примерно 3000 секунд (в начальном тесте не использовался MD5-хэш).

![Контейнер больших двоичных объектов на портале Azure](media/sap-hana-backup-file-level/image028.png)

На снимке экрана выше показан контейнер больших двоичных объектов на портале Azure. Созданный контейнер больших двоичных объектов &quot;sap-hana-backups&quot; включает в себя 4 больших двоичных объекта, представляющих файлы резервных копий SAP HANA. Размер одного из них составляет 230 ГБ.

В консоли резервного копирования HANA Studio можно ограничить максимальный размер файлов резервных копий HANA. Это позволило улучшить производительность в примере среды, так как вместо одного большого файла емкостью 230 ГБ можно использовать несколько меньших.

![Ограничение размера файлов резервных копий HANA не сокращает время резервного копирования](media/sap-hana-backup-file-level/image029.png)

Ограничение размера файлов резервных копий HANA не сокращает время резервного копирования, так как файлы записываются последовательно (см. рисунок ниже). Для максимального размера файла задано значение 60 ГБ. Поэтому вместо одного большого файла емкостью 230 ГБ было создано 4 меньших файла данных.

![Чтобы проверить параллелизм средства blobxfer, максимальный размер файла резервных копий HANA изменили на 15 ГБ](media/sap-hana-backup-file-level/image030.png)

Чтобы проверить параллелизм средства blobxfer, максимальный размер файла резервных копий HANA изменили на 15 ГБ. В общем количество файлов составило 19. С такой конфигурацией время копирования 230 ГБ данных в хранилище BLOB-объектов Azure с помощью средства blobxfer сократилось с 3000 до 875 секунд.

Это связано с ограничением в 60 МБ/с на запись в большой двоичный объект Azure. Наличие нескольких больших двоичных объектов обеспечивает параллелизм. Это, в свою очередь, позволяет решить проблему с производительностью. Недостаток этого подхода заключается в том, что при увеличении производительности средства blobxfer (для копирования всех этих файлов резервных копий HANA в хранилище BLOB-объектов Azure) увеличивается также нагрузка на виртуальную машину HANA и сеть, а это влияет на операции в системе HANA.

## <a name="blob-copy-of-dedicated-azure-data-disks-in-backup-software-raid"></a>Копирование большого двоичного объекта выделенных дисков данных Azure в программном RAID-массиве резервного копирования

В отличие от резервного копирования дисков данных вручную, при использовании этого подхода пользователь не должен создавать резервные копии всех дисков виртуальной машины, чтобы полностью сохранить установку SAP, в том числе данные HANA, файлы журнала HANA и файлы конфигурации. Суть заключается в том, чтобы создать выделенный программный RAID-массив с чередованием по нескольким виртуальным жестким дискам данных Azure для хранения полной резервной копии файла SAP HANA. В этом случае копировать нужно только диски, на которых хранится резервная копия SAP HANA. Их можно легко сохранить в выделенной учетной записи хранения резервных копий HANA или подключить к выделенной &quot;виртуальной машине управления резервным копированием&quot; для дальнейшей обработки.

![Копирование всех задействованных виртуальных жестких дисков с помощью команды PowerShell **start-azurestorageblobcopy**](media/sap-hana-backup-file-level/image031.png)

После выполнения резервного копирования в локальный программный RAID-массив все задействованные виртуальные жесткие диски были скопированы с помощью команды PowerShell **start-azurestorageblobcopy**. (Дополнительные сведения см. в статье о командлете [Start-AzureStorageBlobCopy](/powershell/module/azure.storage/start-azurestorageblobcopy).) Так как хранение файлов резервных копий влияет только на выделенную файловую систему, никаких проблем в отношении согласованности файла данных и журнала SAP HANA нет. Преимущество этой команды заключается в том, что она выполняется при включенной виртуальной машине. Чтобы убедиться, что в чередующемся наборе резервного копирования не выполняются операции записи, отключите его перед копированием большого двоичного объекта, а по завершении снова подключите. Кроме того, файловую систему можно также &quot;заморозить&quot;. Например, чтобы заморозить файловую систему XFS используйте xfs\_freeze.

![Список больших двоичных объектов в контейнере виртуальных жестких дисков на портале Azure](media/sap-hana-backup-file-level/image032.png)

На снимке экрана выше показан список больших двоичных объектов в контейнере &quot;виртуальных жестких дисков&quot; на портале Azure. К виртуальной машине сервера SAP HANA подключены 5 виртуальных жестких дисков. Они используются в качестве программного RAID-массива для хранения файлов резервных копий SAP HANA. На этом снимке экрана также показаны 5 копий, созданных с помощью команды копирования больших двоичных объектов.

![Копии дисков программного RAID-массива, используемых для хранения резервных копий SAP HANA, подключены к виртуальной машине сервера приложений](media/sap-hana-backup-file-level/image033.png)

Для тестирования копии дисков программного RAID-массива, используемых для хранения резервных копий SAP HANA, были подключены к виртуальной машине сервера приложений.

![Отключение виртуальной машины сервера приложений для подключения копий дисков](media/sap-hana-backup-file-level/image034.png)

Перед подключением копий дисков виртуальную машину сервера приложений отключили. После запуска виртуальной машины были обнаружены RAID-массив и диски, подключенные через UUID. Отсутствовала только точка подключения, но ее создали с помощью разделителя YaST. После этого копии файлов резервных копий SAP HANA отобразились на уровне операционной системы.

## <a name="copy-sap-hana-backup-files-to-nfs-share"></a>Копирование файлов резервных копий SAP HANA в общий ресурс NFS

Чтобы снизить возможное влияние на производительность и дисковое пространство системы SAP HANA, мы советуем хранить файлы резервных копий SAP HANA в общем ресурсе NFS. Технически это возможно, но в процессе потребуется вторая виртуальная машина, которая используется как узел общего ресурса NFS. Учитывая пропускную способность сети, следует использовать виртуальную машину крупного размера. Мы также советуем отключить эту &quot;виртуальную машину резервного копирования&quot; и использовать ее только при выполнении резервного копирования SAP HANA. При записи в общий ресурс NFS увеличивается нагрузка на сеть и влияние на систему SAP HANA. Но последующее управление файлами резервных копий на &quot;виртуальной машине резервного копирования&quot; не вредит системе SAP HANA.

![Подключение общего ресурса NFS из другой виртуальной машины Azure к виртуальной машине сервера SAP HANA](media/sap-hana-backup-file-level/image035.png)

Чтобы проверить систему NFS, мы подключили общий ресурс NFS из другой виртуальной машины Azure к виртуальной машине сервера SAP HANA, не используя специальные настройки этой системы.

![Резервное копирование заняло 1 час 46 минут](media/sap-hana-backup-file-level/image036.png)

Общий ресурс NFS — это быстрый чередующийся набор, наподобие того, который использовался на сервере SAP HANA. Тем не менее создание резервной копии непосредственно в общем ресурсе NFS заняло 1 час 46 минут, а не 10 минут, как при записи в локальный чередующийся набор.

![Альтернативный вариант создания резервной копии занял 1 час 43 минуты](media/sap-hana-backup-file-level/image037.png)

Альтернативный вариант заключается в создании резервной копии в локальном чередующемся наборе и последующем ее копировании в общий ресурс NFS на уровне операционной системы (с помощью команды **cp -avr**). В целом этот процесс занимает 1 час 43 минуты, что не сильно отличается от первого значения.

Этот вариант приемлем, но при выполнении резервного копирования данных емкостью 230 ГБ не удалось достичь необходимой производительности. А при резервном копировании нескольких терабайт производительность будет еще ниже.

## <a name="copy-sap-hana-backup-files-to-azure-file-service"></a>Копирование файлов резервных копий SAP HANA в службу файлов Azure

К виртуальной машине Azure под управлением Linux можно подключить файловый ресурс Azure. Дополнительные сведения см. в статье [Использование хранилища файлов Azure в Linux](../../../storage/files/storage-how-to-use-files-linux.md). Помните, что сейчас в файловом ресурсе Azure можно хранить 5 ТБ данных, а максимальный размер файла составляет 1 ТБ. Дополнительные сведения об ограничениях хранилища см. в статье [Целевые показатели масштабируемости и производительности службы хранилища Azure](../../../storage/common/storage-scalability-targets.md).

Тесты показывают, что сейчас резервное копирование SAP HANA напрямую не поддерживает этот тип подключения CIFS. В [примечании к SAP 1820529](https://launchpad.support.sap.com/#/notes/1820529) также указано, что специалисты не советуют использовать CIFS.

![Ошибка в диалоговом окне резервного копирования в SAP HANA Studio](media/sap-hana-backup-file-level/image038.png)

На рисунке выше показана ошибка в диалоговом окне резервного копирования в SAP HANA Studio, появившаяся при попытке создать резервную копию непосредственно в файловом ресурсе Azure, подключенном по протоколу CIFS. В этом случае необходимо сначала создать стандартную резервную копию SAP HANA в файловой системе виртуальной машины, а затем скопировать файлы резервных копий в службу файлов Azure.

![Копирование 19 файлов резервных копий SAP HANA занимает примерно 929 секунд](media/sap-hana-backup-file-level/image039.png)

На рисунке выше показано, что копирование 19 файлов резервных копий SAP HANA общим размером примерно 230 ГБ в файловый ресурс Azure занимает примерно 929 секунд.

![Структура исходного каталога виртуальной машины SAP HANA, скопированная в файловый ресурс Azure](media/sap-hana-backup-file-level/image040.png)

На снимке экрана выше показано, что структура исходного каталога виртуальной машины SAP HANA была скопирована в файловый ресурс Azure: один каталог (hana\_backup\_fsl\_15gb) и 19 отдельных файлов резервных копий.

Хранение файлов резервных копий SAP HANA в файлах Azure может стать более подходящим вариантом в будущем, когда пользователи смогут создавать резервные копии файлов SAP HANA непосредственно в файловом ресурсе Azure или когда файлы Azure можно будет подключать через NFS, а максимальный размер будет значительно выше, чем 5 ТБ.

## <a name="next-steps"></a>Дальнейшие действия
* Общие сведения и информацию о начале работы см. в [руководстве по резервному копированию SAP HANA на виртуальных машинах Azure](sap-hana-backup-guide.md).
* Дополнительные сведения о резервном копировании SAP HANA на основе моментальных снимков хранилища см. в [этой статье](sap-hana-backup-storage-snapshots.md).
* Дополнительные сведения об обеспечении высокого уровня доступности и планировании аварийного восстановления SAP HANA в Azure (крупные экземпляры) см. в [этой статье](hana-overview-high-availability-disaster-recovery.md).

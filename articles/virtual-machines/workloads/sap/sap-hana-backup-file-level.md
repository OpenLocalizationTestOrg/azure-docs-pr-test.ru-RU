---
title: "Резервное копирование SAP HANA в Azure на уровне файлов | Документация Майкрософт"
description: "Существуют две основные возможности резервного копирования SAP HANA на виртуальных машинах Azure. В этой статье рассматривается резервное копирование на уровне файлов."
services: virtual-machines-linux
documentationcenter: 
author: hermanndms
manager: timlt
editor: 
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ums.tgt_pltfrm: vm-linux
ms.workload: infrastructure-services
ms.date: 3/13/2017
ms.author: rclaus
ms.openlocfilehash: 5db0ceb1648b5afa278e1cbe1c42fce8033bfdc1
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="sap-hana-azure-backup-on-file-level"></a><span data-ttu-id="55a97-103">Резервное копирование SAP HANA в Azure на уровне файлов</span><span class="sxs-lookup"><span data-stu-id="55a97-103">SAP HANA Azure Backup on file level</span></span>

## <a name="introduction"></a><span data-ttu-id="55a97-104">Введение</span><span class="sxs-lookup"><span data-stu-id="55a97-104">Introduction</span></span>

<span data-ttu-id="55a97-105">Эта статья входит в цикл из трех связанных статей, посвященных резервному копированию SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="55a97-105">This is part of a three-part series of related articles on SAP HANA backup.</span></span> <span data-ttu-id="55a97-106">В [руководстве по резервному копированию SAP HANA на виртуальных машинах Azure](./sap-hana-backup-guide.md) содержатся общие сведения, а также информация о начале работы, а в статье [Резервное копирование SAP HANA на основе моментальных снимков хранилища](./sap-hana-backup-storage-snapshots.md) рассматривается процесс резервного копирования на основе моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="55a97-106">[Backup guide for SAP HANA on Azure Virtual Machines](./sap-hana-backup-guide.md) provides an overview and information on getting started, and [SAP HANA backup based on storage snapshots](./sap-hana-backup-storage-snapshots.md) covers the storage snapshot-based backup option.</span></span>

<span data-ttu-id="55a97-107">К виртуальной машине Azure типа GS5 можно подключить максимум 64 диска данных.</span><span class="sxs-lookup"><span data-stu-id="55a97-107">Looking at the Azure VM sizes, one can see that a GS5 allows 64 attached data disks.</span></span> <span data-ttu-id="55a97-108">В крупных системах SAP HANA большее число этих дисков могут занимать файлы данных и журналов, а также программный RAID-массив, обеспечивающий оптимальную пропускную способность операций ввода-вывода на диске.</span><span class="sxs-lookup"><span data-stu-id="55a97-108">For large SAP HANA systems, a significant number of disks might already be taken for data and log files, possibly in combination with software RAID for optimal disk IO throughput.</span></span> <span data-ttu-id="55a97-109">Со временем возникает вопрос о том, где хранить файлы резервных копий SAP HANA после заполнения объема подключенных дисков данных.</span><span class="sxs-lookup"><span data-stu-id="55a97-109">The question then is where to store SAP HANA backup files, which could fill up the attached data disks over time?</span></span> <span data-ttu-id="55a97-110">Таблицы размеров виртуальных машин Azure см. в [этой статье](../../linux/sizes.md).</span><span class="sxs-lookup"><span data-stu-id="55a97-110">See [Sizes for Linux virtual machines in Azure](../../linux/sizes.md) for the Azure VM size tables.</span></span>

<span data-ttu-id="55a97-111">Сейчас служба архивации Azure не поддерживает интеграцию с резервным копированием SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="55a97-111">There is no SAP HANA backup integration available with Azure Backup service at this time.</span></span> <span data-ttu-id="55a97-112">Стандартный способ управления резервным копированием и восстановлением на уровне файлов заключается в создании резервных копий на основе файлов через SAP HANA Studio или инструкции SQL.</span><span class="sxs-lookup"><span data-stu-id="55a97-112">The standard way to manage backup/restore at the file level is with a file-based backup via SAP HANA Studio or via SAP HANA SQL statements.</span></span> <span data-ttu-id="55a97-113">Дополнительные сведения см. в [справочнике по системным представлениям и представлениям SQL для SAP HANA](https://help.sap.com/hana/SAP_HANA_SQL_and_System_Views_Reference_en.pdf).</span><span class="sxs-lookup"><span data-stu-id="55a97-113">See [SAP HANA SQL and System Views Reference](https://help.sap.com/hana/SAP_HANA_SQL_and_System_Views_Reference_en.pdf) for more information.</span></span>

![Диалоговое окно меню резервного копирования в SAP HANA Studio](media/sap-hana-backup-file-level/image022.png)

<span data-ttu-id="55a97-115">На рисунке выше показано диалоговое окно меню резервного копирования в SAP HANA Studio.</span><span class="sxs-lookup"><span data-stu-id="55a97-115">This figure shows the dialog of the backup menu item in SAP HANA Studio.</span></span> <span data-ttu-id="55a97-116">Выбрав тип &quot;Файл&quot;, пользователь должен указать путь в файловой системе, по которому SAP HANA записывает файлы резервных копий.</span><span class="sxs-lookup"><span data-stu-id="55a97-116">When choosing type &quot;file,&quot; one has to specify a path in the file system where SAP HANA writes the backup files.</span></span> <span data-ttu-id="55a97-117">То же самое касается и процесса восстановления.</span><span class="sxs-lookup"><span data-stu-id="55a97-117">Restore works the same way.</span></span>

<span data-ttu-id="55a97-118">Хотя этот вариант выглядит простым, он имеет некоторые особенности.</span><span class="sxs-lookup"><span data-stu-id="55a97-118">While this choice sounds simple and straight forward, there are some considerations.</span></span> <span data-ttu-id="55a97-119">Как упоминалось ранее, к виртуальной машине Azure можно подключить ограничение количества дисков данных.</span><span class="sxs-lookup"><span data-stu-id="55a97-119">As mentioned before, an Azure VM has a limitation of number of data disks that can be attached.</span></span> <span data-ttu-id="55a97-120">В зависимости от размера базы данных и требований к пропускной способности диска, необходимой для программного RAID-массива, выполняющего чередование данных по нескольким дискам, доступной емкости может не хватать для хранения файлов резервных копий SAP HANA в файловых системах.</span><span class="sxs-lookup"><span data-stu-id="55a97-120">There might not be capacity to store SAP HANA backup files on the file systems of the VM, depending on the size of the database and disk throughput requirements, which might involve software RAID using striping across multiple data disks.</span></span> <span data-ttu-id="55a97-121">Сведения о разных вариантах перемещения этих файлов резервных копий, а также об управлении ограничениями размера и производительностью при обработке терабайт данных приведены далее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="55a97-121">Various options for moving these backup files, and managing file size restrictions and performance when handling terabytes of data, are provided later in this article.</span></span>

<span data-ttu-id="55a97-122">Еще один вариант, обеспечивающий большую гибкость в отношении общей емкости, — это хранилище BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="55a97-122">Another option, which offers more freedom regarding total capacity, is Azure blob storage.</span></span> <span data-ttu-id="55a97-123">Сейчас отдельный большой двоичный объект может хранить 1 ТБ данных, но общий объем контейнера BLOB-объектов составляет 500 ТБ.</span><span class="sxs-lookup"><span data-stu-id="55a97-123">While a single blob is also restricted to 1 TB, the total capacity of a single blob container is currently 500 TB.</span></span> <span data-ttu-id="55a97-124">Кроме того, пользователи могут использовать более экономичное &quot;холодное&quot; хранилище BLOB-объектов.</span><span class="sxs-lookup"><span data-stu-id="55a97-124">Additionally, it gives customers the choice to select so-called &quot;cool&quot; blob storage, which has a cost benefit.</span></span> <span data-ttu-id="55a97-125">Сведения об этом хранилище см. в статье [Хранилище BLOB-объектов Azure: "горячий" и "холодный" уровни хранилища](../../../storage/blobs/storage-blob-storage-tiers.md).</span><span class="sxs-lookup"><span data-stu-id="55a97-125">See [Azure Blob Storage: Hot and cool storage tiers](../../../storage/blobs/storage-blob-storage-tiers.md) for details about cool blob storage.</span></span>

<span data-ttu-id="55a97-126">Чтобы обеспечить более высокий уровень безопасности, для хранения резервных копий SAP HANA используйте геореплицированную учетную запись хранения.</span><span class="sxs-lookup"><span data-stu-id="55a97-126">For additional safety, use a geo-replicated storage account to store the SAP HANA backups.</span></span> <span data-ttu-id="55a97-127">Дополнительные сведения о репликации учетной записи хранения см. в статье [Репликация службы хранилища Azure](../../../storage/common/storage-redundancy.md).</span><span class="sxs-lookup"><span data-stu-id="55a97-127">See [Azure Storage replication](../../../storage/common/storage-redundancy.md) for details about storage account replication.</span></span>

<span data-ttu-id="55a97-128">Пользователи могут поместить выделенные виртуальные жесткие диски, на которых хранятся резервные копии SAP HANA, в геореплицированную учетную запись хранения резервных копий.</span><span class="sxs-lookup"><span data-stu-id="55a97-128">One could place dedicated VHDs for SAP HANA backups in a dedicated backup storage account that is geo-replicated.</span></span> <span data-ttu-id="55a97-129">Кроме того, эти виртуальные жесткие диски можно скопировать в геореплицированную учетную запись хранения или в учетную запись хранения, расположенную в другом регионе.</span><span class="sxs-lookup"><span data-stu-id="55a97-129">Or else one could copy the VHDs that keep the SAP HANA backups to a geo-replicated storage account, or to a storage account that is in a different region.</span></span>

## <a name="azure-backup-agent"></a><span data-ttu-id="55a97-130">Агент службы архивации Azure</span><span class="sxs-lookup"><span data-stu-id="55a97-130">Azure backup agent</span></span>

<span data-ttu-id="55a97-131">Служба архивации Azure позволяет не только создавать полные резервные копии виртуальных машин, но также файлов и каталогов. Для этого используется агент службы архивации, который необходимо установить в гостевой ОС.</span><span class="sxs-lookup"><span data-stu-id="55a97-131">Azure backup offers the option to not only back up complete VMs, but also files and directories via the backup agent, which has to be installed on the guest OS.</span></span> <span data-ttu-id="55a97-132">С декабря 2016 года этот агент поддерживается только в операционной системе Windows. (Дополнительные сведения см. в статье [Архивация сервера Windows Server или клиента Windows в Azure с использованием модели развертывания с помощью Resource Manager](../../../backup/backup-configure-vault.md).)</span><span class="sxs-lookup"><span data-stu-id="55a97-132">But as of December 2016, this agent is only supported on Windows (see [Back up a Windows Server or client to Azure using the Resource Manager deployment model](../../../backup/backup-configure-vault.md)).</span></span>

<span data-ttu-id="55a97-133">В качестве обходного решения можно сначала скопировать файлы резервных копий SAP HANA на виртуальную машину Windows в Azure (например, через SAMBA), а затем использовать агент службы архивации Azure.</span><span class="sxs-lookup"><span data-stu-id="55a97-133">A workaround is to first copy SAP HANA backup files to a Windows VM on Azure (for example, via SAMBA share) and then use the Azure backup agent from there.</span></span> <span data-ttu-id="55a97-134">Хотя технически это возможно, это усложняет и замедляет резервное копирование и восстановление из-за копирования между виртуальной машиной Linux и Windows.</span><span class="sxs-lookup"><span data-stu-id="55a97-134">While it is technically possible, it would add complexity and slow down the backup or restore process quite a bit due to the copy between the Linux and the Windows VM.</span></span> <span data-ttu-id="55a97-135">Мы не советуем использовать этот подход.</span><span class="sxs-lookup"><span data-stu-id="55a97-135">It is not recommended to follow this approach.</span></span>

## <a name="azure-blobxfer-utility-details"></a><span data-ttu-id="55a97-136">Сведения о служебной программе Azure blobxfer</span><span class="sxs-lookup"><span data-stu-id="55a97-136">Azure blobxfer utility details</span></span>

<span data-ttu-id="55a97-137">Чтобы сохранить каталоги и файлы в службе хранилища Azure, можно использовать интерфейс командной строки, PowerShell или средство, разработанное на основе одного из [пакетов SDK](https://azure.microsoft.com/downloads/).</span><span class="sxs-lookup"><span data-stu-id="55a97-137">To store directories and files on Azure storage, one could use CLI or PowerShell, or develop a tool using one of the [Azure SDKs](https://azure.microsoft.com/downloads/).</span></span> <span data-ttu-id="55a97-138">Кроме того, можно использовать готовую служебную программу AzCopy для копирования данных в службу хранилища Azure, но она поддерживается только в операционной системе Windows. (Дополнительные сведения см. в статье [Приступая к работе со служебной программой командной строки AzCopy](../../../storage/common/storage-use-azcopy.md).)</span><span class="sxs-lookup"><span data-stu-id="55a97-138">There is also a ready-to-use utility, AzCopy, for copying data to Azure storage, but it is Windows only (see [Transfer data with the AzCopy Command-Line Utility](../../../storage/common/storage-use-azcopy.md)).</span></span>

<span data-ttu-id="55a97-139">Поэтому в рамках этой статьи для копирования файлов резервных копий SAP HANA мы используем blobxfer.</span><span class="sxs-lookup"><span data-stu-id="55a97-139">Therefore blobxfer was used for copying SAP HANA backup files.</span></span> <span data-ttu-id="55a97-140">Это средство с открытым исходным кодом доступно в [GitHub](https://github.com/Azure/blobxfer). Большое количество пользователей использует его в рабочих средах.</span><span class="sxs-lookup"><span data-stu-id="55a97-140">It is open source, used by many customers in production environments, and available on [GitHub](https://github.com/Azure/blobxfer).</span></span> <span data-ttu-id="55a97-141">Оно также позволяет копировать данные непосредственно в хранилище BLOB-объектов Azure или файловый ресурс Azure.</span><span class="sxs-lookup"><span data-stu-id="55a97-141">This tool allows one to copy data directly to either Azure blob storage or Azure file share.</span></span> <span data-ttu-id="55a97-142">Кроме того, это средство предоставляет ряд полезных возможностей, таких как поддержка MD5-хэша или автоматического параллелизма при копировании каталога с несколькими файлами.</span><span class="sxs-lookup"><span data-stu-id="55a97-142">It also offers a range of useful features, like md5 hash or automatic parallelism when copying a directory with multiple files.</span></span>

## <a name="sap-hana-backup-performance"></a><span data-ttu-id="55a97-143">Производительность резервного копирования SAP HANA</span><span class="sxs-lookup"><span data-stu-id="55a97-143">SAP HANA backup performance</span></span>

![Консоль резервного копирования SAP HANA в SAP HANA Studio](media/sap-hana-backup-file-level/image023.png)

<span data-ttu-id="55a97-145">На снимке экрана выше показана консоль резервного копирования SAP HANA в SAP HANA Studio.</span><span class="sxs-lookup"><span data-stu-id="55a97-145">This screenshot is of the SAP HANA backup console in SAP HANA Studio.</span></span> <span data-ttu-id="55a97-146">Создание резервной копии 230 ГБ данных на отдельном диске хранилища Azure класса Standard, подключенном к виртуальной машине HANA, с файловой системой XFS занимает приблизительно 42 минуты.</span><span class="sxs-lookup"><span data-stu-id="55a97-146">It took about 42 minutes to do the backup of the 230 GB on a single Azure standard storage disk attached to the HANA VM using XFS file system.</span></span>

![Средство YaST на тестовой виртуальной машине SAP HANA](media/sap-hana-backup-file-level/image024.png)

<span data-ttu-id="55a97-148">На снимке экрана выше показано средство YaST на тестовой виртуальной машине SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="55a97-148">This screenshot is of YaST on the SAP HANA test VM.</span></span> <span data-ttu-id="55a97-149">Как упоминалось ранее, резервные копии SAP HANA хранятся на отдельном диске емкостью 1 ТБ.</span><span class="sxs-lookup"><span data-stu-id="55a97-149">One can see the 1-TB single disk for SAP HANA backup as mentioned before.</span></span> <span data-ttu-id="55a97-150">Создание резервной копии 230 ГБ данных занимает приблизительно 42 минуты.</span><span class="sxs-lookup"><span data-stu-id="55a97-150">It took about 42 minutes to backup 230 GB.</span></span> <span data-ttu-id="55a97-151">Кроме того, к виртуальной машине подключены 5 дисков емкостью 200 ГБ, на которых установлен программный RAID-массив md0, выполняющий чередование по этим дискам данных Azure.</span><span class="sxs-lookup"><span data-stu-id="55a97-151">In addition, five 200-GB disks were attached and software RAID md0 created, with striping on top of these five Azure data disks.</span></span>

![Повторное резервное копирование в программном RAID-массиве с чередованием по пяти дискам данных хранилища Azure класса Standard](media/sap-hana-backup-file-level/image025.png)

<span data-ttu-id="55a97-153">Время повторного резервного копирования в программном RAID-массиве с чередованием по пяти дискам данных хранилища Azure класса Standard сократилось с 42 до 10 минут.</span><span class="sxs-lookup"><span data-stu-id="55a97-153">Repeating the same backup on software RAID with striping across five attached Azure standard storage data disks brought the backup time from 42 minutes down to 10 minutes.</span></span> <span data-ttu-id="55a97-154">Диски, подключенные к виртуальной машине, не кэшируются.</span><span class="sxs-lookup"><span data-stu-id="55a97-154">The disks were attached without caching to the VM.</span></span> <span data-ttu-id="55a97-155">Поэтому очевидно, что время резервного копирования сильно зависит от пропускной способности операций записи.</span><span class="sxs-lookup"><span data-stu-id="55a97-155">So it is obvious how important disk write throughput is for the backup time.</span></span> <span data-ttu-id="55a97-156">Чтобы оптимизировать производительность процесса, пользователи могут использовать хранилище Azure класса Premium.</span><span class="sxs-lookup"><span data-stu-id="55a97-156">One could then switch to Azure premium storage to further accelerate the process for optimal performance.</span></span> <span data-ttu-id="55a97-157">Как правило, это хранилище следует использовать в рабочих системах.</span><span class="sxs-lookup"><span data-stu-id="55a97-157">In general, Azure premium storage should be used for production systems.</span></span>

## <a name="copy-sap-hana-backup-files-to-azure-blob-storage"></a><span data-ttu-id="55a97-158">Копирование файлов резервных копий SAP HANA в хранилище BLOB-объектов Azure</span><span class="sxs-lookup"><span data-stu-id="55a97-158">Copy SAP HANA backup files to Azure blob storage</span></span>

<span data-ttu-id="55a97-159">С декабря 2016 года самый лучший вариант в плане быстрого сохранения файлов резервных копий SAP HANA — использовать хранилище BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="55a97-159">As of December 2016, the best option to quickly store SAP HANA backup files is Azure blob storage.</span></span> <span data-ttu-id="55a97-160">Отдельный контейнер больших двоичных объектов может хранить 500 ТБ данных. Этого объема достаточно для хранения резервных копий большинства систем SAP HANA, выполняющихся на виртуальной машине типа GS5 в Azure.</span><span class="sxs-lookup"><span data-stu-id="55a97-160">One single blob container has a limit of 500 TB, enough for most SAP HANA systems, running in a GS5 VM on Azure, to keep sufficient SAP HANA backups.</span></span> <span data-ttu-id="55a97-161">Пользователи могут выбирать между &quot;горячим&quot; и &quot;холодным&quot; хранилищем BLOB-объектов. (Дополнительные сведения см. в статье [Хранилище BLOB-объектов Azure: "горячий" и "холодный" уровни хранилища](../../../storage/blobs/storage-blob-storage-tiers.md).)</span><span class="sxs-lookup"><span data-stu-id="55a97-161">Customers have the choice between &quot;hot&quot; and &quot;cold&quot; blob storage (see [Azure Blob Storage: Hot and cool storage tiers](../../../storage/blobs/storage-blob-storage-tiers.md)).</span></span>

<span data-ttu-id="55a97-162">Средство blobxfer упрощает копирование файлов резервных копий SAP HANA непосредственно в хранилище BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="55a97-162">With the blobxfer tool, it is easy to copy the SAP HANA backup files directly to Azure blob storage.</span></span>

![Файлы полной резервной копии SAP HANA](media/sap-hana-backup-file-level/image026.png)

<span data-ttu-id="55a97-164">На снимке экрана выше показаны файлы полной резервной копии SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="55a97-164">Here one can see the files of a full SAP HANA file backup.</span></span> <span data-ttu-id="55a97-165">Эта полная резервная копия состоит из 4 файлов. Размер самого большого файла составляет примерно 230 ГБ.</span><span class="sxs-lookup"><span data-stu-id="55a97-165">There are four files and the biggest one has roughly 230 GB.</span></span>

![Копирование 230 ГБ данных в контейнер больших двоичных объектов учетной записи хранения класса Standard занимает примерно 3000 секунд](media/sap-hana-backup-file-level/image027.png)

<span data-ttu-id="55a97-167">Копирование 230 ГБ данных в контейнер больших двоичных объектов учетной записи хранения класса Standard занимает примерно 3000 секунд (в начальном тесте не использовался MD5-хэш).</span><span class="sxs-lookup"><span data-stu-id="55a97-167">Not using md5 hash in the initial test, it took roughly 3000 seconds to copy the 230 GB to an Azure standard storage account blob container.</span></span>

![Контейнер больших двоичных объектов на портале Azure](media/sap-hana-backup-file-level/image028.png)

<span data-ttu-id="55a97-169">На снимке экрана выше показан контейнер больших двоичных объектов на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="55a97-169">In this screenshot, one can see how it looks on the Azure portal.</span></span> <span data-ttu-id="55a97-170">Созданный контейнер больших двоичных объектов &quot;sap-hana-backups&quot; включает в себя 4 больших двоичных объекта, представляющих файлы резервных копий SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="55a97-170">A blob container named &quot;sap-hana-backups&quot; was created and includes the four blobs, which represent the SAP HANA backup files.</span></span> <span data-ttu-id="55a97-171">Размер одного из них составляет 230 ГБ.</span><span class="sxs-lookup"><span data-stu-id="55a97-171">One of them has a size of roughly 230 GB.</span></span>

<span data-ttu-id="55a97-172">В консоли резервного копирования HANA Studio можно ограничить максимальный размер файлов резервных копий HANA.</span><span class="sxs-lookup"><span data-stu-id="55a97-172">The HANA Studio backup console allows one to restrict the max file size of HANA backup files.</span></span> <span data-ttu-id="55a97-173">Это позволило улучшить производительность в примере среды, так как вместо одного большого файла емкостью 230 ГБ можно использовать несколько меньших.</span><span class="sxs-lookup"><span data-stu-id="55a97-173">In the sample environment, it improved performance by making it possible to have multiple smaller backup files, instead of one large 230-GB file.</span></span>

![Ограничение размера файлов резервных копий HANA не сокращает время резервного копирования](media/sap-hana-backup-file-level/image029.png)

<span data-ttu-id="55a97-175">Ограничение размера файлов резервных копий HANA не сокращает время резервного копирования, так как файлы записываются последовательно (см. рисунок ниже).</span><span class="sxs-lookup"><span data-stu-id="55a97-175">Setting the backup file size limit on the HANA side doesn&#39;t improve the backup time, because the files are written sequentially as shown in this figure.</span></span> <span data-ttu-id="55a97-176">Для максимального размера файла задано значение 60 ГБ. Поэтому вместо одного большого файла емкостью 230 ГБ было создано 4 меньших файла данных.</span><span class="sxs-lookup"><span data-stu-id="55a97-176">The file size limit was set to 60 GB, so the backup created four large data files instead of the 230-GB single file.</span></span>

![Чтобы проверить параллелизм средства blobxfer, максимальный размер файла резервных копий HANA изменили на 15 ГБ](media/sap-hana-backup-file-level/image030.png)

<span data-ttu-id="55a97-178">Чтобы проверить параллелизм средства blobxfer, максимальный размер файла резервных копий HANA изменили на 15 ГБ. В общем количество файлов составило 19.</span><span class="sxs-lookup"><span data-stu-id="55a97-178">To test parallelism of the blobxfer tool, the max file size for HANA backups was then set to 15 GB, which resulted in 19 backup files.</span></span> <span data-ttu-id="55a97-179">С такой конфигурацией время копирования 230 ГБ данных в хранилище BLOB-объектов Azure с помощью средства blobxfer сократилось с 3000 до 875 секунд.</span><span class="sxs-lookup"><span data-stu-id="55a97-179">This configuration brought the time for blobxfer to copy the 230 GB to Azure blob storage from 3000 seconds down to 875 seconds.</span></span>

<span data-ttu-id="55a97-180">Это связано с ограничением в 60 МБ/с на запись в большой двоичный объект Azure.</span><span class="sxs-lookup"><span data-stu-id="55a97-180">This result is due to the limit of 60 MB/sec for writing an Azure blob.</span></span> <span data-ttu-id="55a97-181">Наличие нескольких больших двоичных объектов обеспечивает параллелизм. Это, в свою очередь, позволяет решить проблему с производительностью. Недостаток этого подхода заключается в том, что при увеличении производительности средства blobxfer (для копирования всех этих файлов резервных копий HANA в хранилище BLOB-объектов Azure) увеличивается также нагрузка на виртуальную машину HANA и сеть,</span><span class="sxs-lookup"><span data-stu-id="55a97-181">Parallelism via multiple blobs solves the bottleneck, but there is a downside: increasing performance of the blobxfer tool to copy all these HANA backup files to Azure blob storage puts load on both the HANA VM and the network.</span></span> <span data-ttu-id="55a97-182">а это влияет на операции в системе HANA.</span><span class="sxs-lookup"><span data-stu-id="55a97-182">Operation of HANA system becomes impacted.</span></span>

## <a name="blob-copy-of-dedicated-azure-data-disks-in-backup-software-raid"></a><span data-ttu-id="55a97-183">Копирование большого двоичного объекта выделенных дисков данных Azure в программном RAID-массиве резервного копирования</span><span class="sxs-lookup"><span data-stu-id="55a97-183">Blob copy of dedicated Azure data disks in backup software RAID</span></span>

<span data-ttu-id="55a97-184">В отличие от резервного копирования дисков данных вручную, при использовании этого подхода пользователь не должен создавать резервные копии всех дисков виртуальной машины, чтобы полностью сохранить установку SAP, в том числе данные HANA, файлы журнала HANA и файлы конфигурации.</span><span class="sxs-lookup"><span data-stu-id="55a97-184">Unlike the manual VM data disk backup, in this approach one does not back up all the data disks on a VM to save the whole SAP installation, including HANA data, HANA log files, and config files.</span></span> <span data-ttu-id="55a97-185">Суть заключается в том, чтобы создать выделенный программный RAID-массив с чередованием по нескольким виртуальным жестким дискам данных Azure для хранения полной резервной копии файла SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="55a97-185">Instead, the idea is to have dedicated software RAID with striping across multiple Azure data VHDs for storing a full SAP HANA file backup.</span></span> <span data-ttu-id="55a97-186">В этом случае копировать нужно только диски, на которых хранится резервная копия SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="55a97-186">One copies only these disks, which have the SAP HANA backup.</span></span> <span data-ttu-id="55a97-187">Их можно легко сохранить в выделенной учетной записи хранения резервных копий HANA или подключить к выделенной &quot;виртуальной машине управления резервным копированием&quot; для дальнейшей обработки.</span><span class="sxs-lookup"><span data-stu-id="55a97-187">They could easily be kept in a dedicated HANA backup storage account, or attached to a dedicated &quot;backup management VM&quot; for further processing.</span></span>

![Копирование всех задействованных виртуальных жестких дисков с помощью команды PowerShell **start-azurestorageblobcopy**](media/sap-hana-backup-file-level/image031.png)

<span data-ttu-id="55a97-189">После выполнения резервного копирования в локальный программный RAID-массив все задействованные виртуальные жесткие диски были скопированы с помощью команды PowerShell **start-azurestorageblobcopy**. (Дополнительные сведения см. в статье о командлете [Start-AzureStorageBlobCopy](/powershell/module/azure.storage/start-azurestorageblobcopy).)</span><span class="sxs-lookup"><span data-stu-id="55a97-189">After the backup to the local software RAID was completed, all VHDs involved were copied using the **start-azurestorageblobcopy** PowerShell command (see [Start-AzureStorageBlobCopy](/powershell/module/azure.storage/start-azurestorageblobcopy)).</span></span> <span data-ttu-id="55a97-190">Так как хранение файлов резервных копий влияет только на выделенную файловую систему, никаких проблем в отношении согласованности файла данных и журнала SAP HANA нет.</span><span class="sxs-lookup"><span data-stu-id="55a97-190">As it only affects the dedicated file system for keeping the backup files, there are no concerns about SAP HANA data or log file consistency on the disk.</span></span> <span data-ttu-id="55a97-191">Преимущество этой команды заключается в том, что она выполняется при включенной виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="55a97-191">A benefit of this command is that it works while the VM stays online.</span></span> <span data-ttu-id="55a97-192">Чтобы убедиться, что в чередующемся наборе резервного копирования не выполняются операции записи, отключите его перед копированием большого двоичного объекта, а по завершении снова подключите.</span><span class="sxs-lookup"><span data-stu-id="55a97-192">To be certain that no process writes to the backup stripe set, be sure to unmount it before the blob copy, and mount it again afterwards.</span></span> <span data-ttu-id="55a97-193">Кроме того, файловую систему можно также &quot;заморозить&quot;.</span><span class="sxs-lookup"><span data-stu-id="55a97-193">Or one could use an appropriate way to &quot;freeze&quot; the file system.</span></span> <span data-ttu-id="55a97-194">Например, чтобы заморозить файловую систему XFS используйте xfs\_freeze.</span><span class="sxs-lookup"><span data-stu-id="55a97-194">For example, via xfs\_freeze for the XFS file system.</span></span>

![Список больших двоичных объектов в контейнере виртуальных жестких дисков на портале Azure](media/sap-hana-backup-file-level/image032.png)

<span data-ttu-id="55a97-196">На снимке экрана выше показан список больших двоичных объектов в контейнере &quot;виртуальных жестких дисков&quot; на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="55a97-196">This screenshot shows the list of blobs in the &quot;vhds&quot; container on the Azure portal.</span></span> <span data-ttu-id="55a97-197">К виртуальной машине сервера SAP HANA подключены 5 виртуальных жестких дисков. Они используются в качестве программного RAID-массива для хранения файлов резервных копий SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="55a97-197">The screenshot shows the five VHDs, which were attached to the SAP HANA server VM to serve as the software RAID to keep SAP HANA backup files.</span></span> <span data-ttu-id="55a97-198">На этом снимке экрана также показаны 5 копий, созданных с помощью команды копирования больших двоичных объектов.</span><span class="sxs-lookup"><span data-stu-id="55a97-198">It also shows the five copies, which were taken via the blob copy command.</span></span>

![Копии дисков программного RAID-массива, используемых для хранения резервных копий SAP HANA, подключены к виртуальной машине сервера приложений](media/sap-hana-backup-file-level/image033.png)

<span data-ttu-id="55a97-200">Для тестирования копии дисков программного RAID-массива, используемых для хранения резервных копий SAP HANA, были подключены к виртуальной машине сервера приложений.</span><span class="sxs-lookup"><span data-stu-id="55a97-200">For testing purposes, the copies of the SAP HANA backup software RAID disks were attached to the app server VM.</span></span>

![Отключение виртуальной машины сервера приложений для подключения копий дисков](media/sap-hana-backup-file-level/image034.png)

<span data-ttu-id="55a97-202">Перед подключением копий дисков виртуальную машину сервера приложений отключили.</span><span class="sxs-lookup"><span data-stu-id="55a97-202">The app server VM was shut down to attach the disk copies.</span></span> <span data-ttu-id="55a97-203">После запуска виртуальной машины были обнаружены RAID-массив и диски, подключенные через UUID.</span><span class="sxs-lookup"><span data-stu-id="55a97-203">After starting the VM, the disks and the RAID were discovered correctly (mounted via UUID).</span></span> <span data-ttu-id="55a97-204">Отсутствовала только точка подключения, но ее создали с помощью разделителя YaST.</span><span class="sxs-lookup"><span data-stu-id="55a97-204">Only the mount point was missing, which was created via the YaST partitioner.</span></span> <span data-ttu-id="55a97-205">После этого копии файлов резервных копий SAP HANA отобразились на уровне операционной системы.</span><span class="sxs-lookup"><span data-stu-id="55a97-205">Afterwards the SAP HANA backup file copies became visible on OS level.</span></span>

## <a name="copy-sap-hana-backup-files-to-nfs-share"></a><span data-ttu-id="55a97-206">Копирование файлов резервных копий SAP HANA в общий ресурс NFS</span><span class="sxs-lookup"><span data-stu-id="55a97-206">Copy SAP HANA backup files to NFS share</span></span>

<span data-ttu-id="55a97-207">Чтобы снизить возможное влияние на производительность и дисковое пространство системы SAP HANA, мы советуем хранить файлы резервных копий SAP HANA в общем ресурсе NFS.</span><span class="sxs-lookup"><span data-stu-id="55a97-207">To lessen the potential impact on the SAP HANA system from a performance or disk space perspective, one might consider storing the SAP HANA backup files on an NFS share.</span></span> <span data-ttu-id="55a97-208">Технически это возможно, но в процессе потребуется вторая виртуальная машина, которая используется как узел общего ресурса NFS.</span><span class="sxs-lookup"><span data-stu-id="55a97-208">Technically it works, but it means using a second Azure VM as the host of the NFS share.</span></span> <span data-ttu-id="55a97-209">Учитывая пропускную способность сети, следует использовать виртуальную машину крупного размера.</span><span class="sxs-lookup"><span data-stu-id="55a97-209">It should not be a small VM size, due to the VM network bandwidth.</span></span> <span data-ttu-id="55a97-210">Мы также советуем отключить эту &quot;виртуальную машину резервного копирования&quot; и использовать ее только при выполнении резервного копирования SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="55a97-210">It would make sense then to shut down this &quot;backup VM&quot; and only bring it up for executing the SAP HANA backup.</span></span> <span data-ttu-id="55a97-211">При записи в общий ресурс NFS увеличивается нагрузка на сеть и влияние на систему SAP HANA. Но последующее управление файлами резервных копий на &quot;виртуальной машине резервного копирования&quot; не вредит системе SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="55a97-211">Writing on an NFS share puts load on the network and impacts the SAP HANA system, but merely managing the backup files afterwards on the &quot;backup VM&quot; would not influence the SAP HANA system at all.</span></span>

![Подключение общего ресурса NFS из другой виртуальной машины Azure к виртуальной машине сервера SAP HANA](media/sap-hana-backup-file-level/image035.png)

<span data-ttu-id="55a97-213">Чтобы проверить систему NFS, мы подключили общий ресурс NFS из другой виртуальной машины Azure к виртуальной машине сервера SAP HANA,</span><span class="sxs-lookup"><span data-stu-id="55a97-213">To verify the NFS use case, an NFS share from another Azure VM was mounted to the SAP HANA server VM.</span></span> <span data-ttu-id="55a97-214">не используя специальные настройки этой системы.</span><span class="sxs-lookup"><span data-stu-id="55a97-214">There was no special NFS tuning applied.</span></span>

![Резервное копирование заняло 1 час 46 минут](media/sap-hana-backup-file-level/image036.png)

<span data-ttu-id="55a97-216">Общий ресурс NFS — это быстрый чередующийся набор, наподобие того, который использовался на сервере SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="55a97-216">The NFS share was a fast stripe set, like the one on the SAP HANA server.</span></span> <span data-ttu-id="55a97-217">Тем не менее создание резервной копии непосредственно в общем ресурсе NFS заняло 1 час 46 минут, а не 10 минут, как при записи в локальный чередующийся набор.</span><span class="sxs-lookup"><span data-stu-id="55a97-217">Nevertheless, it took 1 hour and 46 minutes to do the backup directly on the NFS share instead of 10 minutes, when writing to a local stripe set.</span></span>

![Альтернативный вариант создания резервной копии занял 1 час 43 минуты](media/sap-hana-backup-file-level/image037.png)

<span data-ttu-id="55a97-219">Альтернативный вариант заключается в создании резервной копии в локальном чередующемся наборе и последующем ее копировании в общий ресурс NFS на уровне операционной системы (с помощью команды **cp -avr**).</span><span class="sxs-lookup"><span data-stu-id="55a97-219">The alternative of doing a backup to a local stripe set and copying to the NFS share on OS level (a simple **cp -avr** command) wasn't much quicker.</span></span> <span data-ttu-id="55a97-220">В целом этот процесс занимает 1 час 43 минуты, что не сильно отличается от первого значения.</span><span class="sxs-lookup"><span data-stu-id="55a97-220">It took 1 hour and 43 minutes.</span></span>

<span data-ttu-id="55a97-221">Этот вариант приемлем, но при выполнении резервного копирования данных емкостью 230 ГБ не удалось достичь необходимой производительности.</span><span class="sxs-lookup"><span data-stu-id="55a97-221">So it works, but performance wasn't good for the 230-GB backup test.</span></span> <span data-ttu-id="55a97-222">А при резервном копировании нескольких терабайт производительность будет еще ниже.</span><span class="sxs-lookup"><span data-stu-id="55a97-222">It would look even worse for multi terabytes.</span></span>

## <a name="copy-sap-hana-backup-files-to-azure-file-service"></a><span data-ttu-id="55a97-223">Копирование файлов резервных копий SAP HANA в службу файлов Azure</span><span class="sxs-lookup"><span data-stu-id="55a97-223">Copy SAP HANA backup files to Azure file service</span></span>

<span data-ttu-id="55a97-224">К виртуальной машине Azure под управлением Linux можно подключить файловый ресурс Azure.</span><span class="sxs-lookup"><span data-stu-id="55a97-224">It is possible to mount an Azure file share inside an Azure Linux VM.</span></span> <span data-ttu-id="55a97-225">Дополнительные сведения см. в статье [Использование хранилища файлов Azure в Linux](../../../storage/files/storage-how-to-use-files-linux.md).</span><span class="sxs-lookup"><span data-stu-id="55a97-225">The article [How to use Azure File storage with Linux](../../../storage/files/storage-how-to-use-files-linux.md) provides details on how to do it.</span></span> <span data-ttu-id="55a97-226">Помните, что сейчас в файловом ресурсе Azure можно хранить 5 ТБ данных, а максимальный размер файла составляет 1 ТБ.</span><span class="sxs-lookup"><span data-stu-id="55a97-226">Keep in mind that there is currently a 5-TB quota limit of one Azure file share, and a file size limit of 1 TB per file.</span></span> <span data-ttu-id="55a97-227">Дополнительные сведения об ограничениях хранилища см. в статье [Целевые показатели масштабируемости и производительности службы хранилища Azure](../../../storage/common/storage-scalability-targets.md).</span><span class="sxs-lookup"><span data-stu-id="55a97-227">See [Azure Storage Scalability and Performance Targets](../../../storage/common/storage-scalability-targets.md) for information on storage limits.</span></span>

<span data-ttu-id="55a97-228">Тесты показывают, что сейчас резервное копирование SAP HANA напрямую не поддерживает этот тип подключения CIFS.</span><span class="sxs-lookup"><span data-stu-id="55a97-228">Tests have shown, however, that SAP HANA backup doesn&#39;t currently work directly with this kind of CIFS mount.</span></span> <span data-ttu-id="55a97-229">В [примечании к SAP 1820529](https://launchpad.support.sap.com/#/notes/1820529) также указано, что специалисты не советуют использовать CIFS.</span><span class="sxs-lookup"><span data-stu-id="55a97-229">It is also stated in [SAP Note 1820529](https://launchpad.support.sap.com/#/notes/1820529) that CIFS is not recommended.</span></span>

![Ошибка в диалоговом окне резервного копирования в SAP HANA Studio](media/sap-hana-backup-file-level/image038.png)

<span data-ttu-id="55a97-231">На рисунке выше показана ошибка в диалоговом окне резервного копирования в SAP HANA Studio, появившаяся при попытке создать резервную копию непосредственно в файловом ресурсе Azure, подключенном по протоколу CIFS.</span><span class="sxs-lookup"><span data-stu-id="55a97-231">This figure shows an error in the backup dialog in SAP HANA Studio, when trying to back up directly to a CIFS-mounted Azure file share.</span></span> <span data-ttu-id="55a97-232">В этом случае необходимо сначала создать стандартную резервную копию SAP HANA в файловой системе виртуальной машины, а затем скопировать файлы резервных копий в службу файлов Azure.</span><span class="sxs-lookup"><span data-stu-id="55a97-232">So one has to do a standard SAP HANA backup into a VM file system first, and then copy the backup files from there to Azure file service.</span></span>

![Копирование 19 файлов резервных копий SAP HANA занимает примерно 929 секунд](media/sap-hana-backup-file-level/image039.png)

<span data-ttu-id="55a97-234">На рисунке выше показано, что копирование 19 файлов резервных копий SAP HANA общим размером примерно 230 ГБ в файловый ресурс Azure занимает примерно 929 секунд.</span><span class="sxs-lookup"><span data-stu-id="55a97-234">This figure shows that it took about 929 seconds to copy 19 SAP HANA backup files with a total size of roughly 230 GB to the Azure file share.</span></span>

![Структура исходного каталога виртуальной машины SAP HANA, скопированная в файловый ресурс Azure](media/sap-hana-backup-file-level/image040.png)

<span data-ttu-id="55a97-236">На снимке экрана выше показано, что структура исходного каталога виртуальной машины SAP HANA была скопирована в файловый ресурс Azure: один каталог (hana\_backup\_fsl\_15gb) и 19 отдельных файлов резервных копий.</span><span class="sxs-lookup"><span data-stu-id="55a97-236">In this screenshot, one can see that the source directory structure on the SAP HANA VM was copied to the Azure file share: one directory (hana\_backup\_fsl\_15gb) and 19 individual backup files.</span></span>

<span data-ttu-id="55a97-237">Хранение файлов резервных копий SAP HANA в файлах Azure может стать более подходящим вариантом в будущем, когда пользователи смогут создавать резервные копии файлов SAP HANA непосредственно в файловом ресурсе Azure или</span><span class="sxs-lookup"><span data-stu-id="55a97-237">Storing SAP HANA backup files on Azure files could be an interesting option in the future when SAP HANA file backups support it directly.</span></span> <span data-ttu-id="55a97-238">когда файлы Azure можно будет подключать через NFS, а максимальный размер будет значительно выше, чем 5 ТБ.</span><span class="sxs-lookup"><span data-stu-id="55a97-238">Or when it becomes possible to mount Azure files via NFS and the maximum quota limit is considerably higher than 5 TB.</span></span>

## <a name="next-steps"></a><span data-ttu-id="55a97-239">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="55a97-239">Next steps</span></span>
* <span data-ttu-id="55a97-240">Общие сведения и информацию о начале работы см. в [руководстве по резервному копированию SAP HANA на виртуальных машинах Azure](sap-hana-backup-guide.md).</span><span class="sxs-lookup"><span data-stu-id="55a97-240">[Backup guide for SAP HANA on Azure Virtual Machines](sap-hana-backup-guide.md) gives an overview and information on getting started.</span></span>
* <span data-ttu-id="55a97-241">Дополнительные сведения о резервном копировании SAP HANA на основе моментальных снимков хранилища см. в [этой статье](sap-hana-backup-storage-snapshots.md).</span><span class="sxs-lookup"><span data-stu-id="55a97-241">[SAP HANA backup based on storage snapshots](sap-hana-backup-storage-snapshots.md) describes the storage snapshot-based backup option.</span></span>
* <span data-ttu-id="55a97-242">Дополнительные сведения об обеспечении высокого уровня доступности и планировании аварийного восстановления SAP HANA в Azure (крупные экземпляры) см. в [этой статье](hana-overview-high-availability-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="55a97-242">To learn how to establish high availability and plan for disaster recovery of SAP HANA on Azure (large instances), see [SAP HANA (large instances) high availability and disaster recovery on Azure](hana-overview-high-availability-disaster-recovery.md).</span></span>

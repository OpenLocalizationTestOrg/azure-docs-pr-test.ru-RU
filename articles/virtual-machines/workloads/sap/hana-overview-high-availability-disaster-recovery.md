---
title: "Обеспечение высокого уровня доступности и аварийное восстановление решения \"SAP HANA в Azure (крупные экземпляры)\" | Документация Майкрософт"
description: "Сведения об обеспечении высокого уровня доступности и о планировании аварийного восстановления решения \"SAP HANA в Azure (крупные экземпляры)\"."
services: virtual-machines-linux
documentationcenter: 
author: RicksterCDN
manager: timlt
editor: 
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 12/01/2016
ms.author: rclaus
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: f95e944fc3ec3a831d97386443eb644420ae54dc
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="sap-hana-large-instances-high-availability-and-disaster-recovery-on-azure"></a><span data-ttu-id="aff6a-103">Высокий уровень доступности и аварийное восстановление SAP HANA в Azure (крупные экземпляры)</span><span class="sxs-lookup"><span data-stu-id="aff6a-103">SAP HANA (large instances) high availability and disaster recovery on Azure</span></span> 

<span data-ttu-id="aff6a-104">Для работы критически важных серверов SAP HANA в Azure (крупные экземпляры) важно обеспечить высокий уровень доступности и реализовать стратегию аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-104">High availability and disaster recovery are important aspects of running your mission-critical SAP HANA on Azure (large instances) servers.</span></span> <span data-ttu-id="aff6a-105">Кроме того, важно сотрудничать с SAP, вашим системным интегратором и (или) корпорацией Майкрософт, чтобы правильно создать архитектуру и реализовать подходящую стратегию обеспечения высокой доступности и аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-105">It's important to work with SAP, your system integrator, or Microsoft to properly architect and implement the right high-availability/disaster-recovery strategy.</span></span> <span data-ttu-id="aff6a-106">Также важно учитывать целевую точку восстановления и целевое время восстановления, характерные для вашей среды.</span><span class="sxs-lookup"><span data-stu-id="aff6a-106">It is also important to consider the recovery point objective and recovery time objective, which are specific to your environment.</span></span>

## <a name="high-availability"></a><span data-ttu-id="aff6a-107">высокую доступность;</span><span class="sxs-lookup"><span data-stu-id="aff6a-107">High availability</span></span>

<span data-ttu-id="aff6a-108">По умолчанию корпорация Майкрософт поддерживает методы обеспечения высокого уровня доступности SAP HANA, в том числе следующие:</span><span class="sxs-lookup"><span data-stu-id="aff6a-108">Microsoft supports SAP HANA high-availability methods "out of the box," which include:</span></span>

- <span data-ttu-id="aff6a-109">**Репликация хранилища** — возможность системы хранения самостоятельно реплицировать все данные в другое расположение (в том же центре обработки данных или за его пределами).</span><span class="sxs-lookup"><span data-stu-id="aff6a-109">**Storage replication:** The storage system's ability to replicate all data to another location (within, or separate from, the same datacenter).</span></span> <span data-ttu-id="aff6a-110">SAP HANA работает независимо от этого метода.</span><span class="sxs-lookup"><span data-stu-id="aff6a-110">SAP HANA operates independently of this method.</span></span>
- <span data-ttu-id="aff6a-111">**Репликация системы HANA** — репликация всех данных SAP HANA в отдельную систему SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-111">**HANA system replication:** The replication of all data in SAP HANA to a separate SAP HANA system.</span></span> <span data-ttu-id="aff6a-112">Целевое время восстановления уменьшается благодаря репликации данных с регулярными интервалами.</span><span class="sxs-lookup"><span data-stu-id="aff6a-112">The recovery time objective is minimized through data replication at regular intervals.</span></span> <span data-ttu-id="aff6a-113">SAP HANA поддерживает асинхронные, выполняющиеся в памяти синхронные и синхронные режимы (мы советуем использовать их только для систем SAP HANA, расположенных в том же центре обработки данных или на расстоянии менее 100 км от него).</span><span class="sxs-lookup"><span data-stu-id="aff6a-113">SAP HANA supports asynchronous, synchronous in-memory, and synchronous modes (recommended only for SAP HANA systems that are within the same datacenter or less than 100 KM apart).</span></span> <span data-ttu-id="aff6a-114">В текущей архитектуре стеков крупных экземпляров HANA репликацию системы HANA можно использовать только для обеспечения высокой доступности.</span><span class="sxs-lookup"><span data-stu-id="aff6a-114">In the current design of HANA large-instance stamps, HANA system replication can be used for high availability only.</span></span>
- <span data-ttu-id="aff6a-115">**Автоматическая отработка отказа узла** — решение для локального восстановления после сбоя, используемое в качестве альтернативы репликации системы.</span><span class="sxs-lookup"><span data-stu-id="aff6a-115">**Host auto-failover:** A local fault-recovery solution to use as an alternative to system replication.</span></span> <span data-ttu-id="aff6a-116">Один или несколько резервных узлов SAP HANA настроены в режиме горизонтального масштабирования, и SAP HANA автоматически выполняет отработку отказа на другой узел, когда главный узел становится недоступным.</span><span class="sxs-lookup"><span data-stu-id="aff6a-116">When the master node becomes unavailable, one or more standby SAP HANA nodes are configured in scale-out mode and SAP HANA automatically fails over to another node.</span></span>

<span data-ttu-id="aff6a-117">Дополнительные сведения о высоком уровне доступности SAP HANA см. в следующих источниках:</span><span class="sxs-lookup"><span data-stu-id="aff6a-117">For more information on SAP HANA high availability, see the following SAP information:</span></span>

- [<span data-ttu-id="aff6a-118">Техническая документация по высокому уровню доступности SAP HANA</span><span class="sxs-lookup"><span data-stu-id="aff6a-118">SAP HANA High-Availability Whitepaper</span></span>](http://go.sap.com/documents/2016/05/f8e5eeba-737c-0010-82c7-eda71af511fa.html)
- [<span data-ttu-id="aff6a-119">Руководство по администрированию SAP HANA</span><span class="sxs-lookup"><span data-stu-id="aff6a-119">SAP HANA Administration Guide</span></span>](http://help.sap.com/hana/SAP_HANA_Administration_Guide_en.pdf)
- [<span data-ttu-id="aff6a-120">Видеокурс SAP по репликации системы SAP HANA</span><span class="sxs-lookup"><span data-stu-id="aff6a-120">SAP Academy Video on SAP HANA System Replication</span></span>](http://scn.sap.com/community/hana-in-memory/blog/2015/05/19/sap-hana-system-replication)
- [<span data-ttu-id="aff6a-121">Примечание по SAP № 1999880. Часто задаваемые вопросы о репликации системы SAP HANA</span><span class="sxs-lookup"><span data-stu-id="aff6a-121">SAP Support Note #1999880 – FAQ on SAP HANA System Replication</span></span>](https://bcs.wdf.sap.corp/sap/support/notes/1999880)
- <span data-ttu-id="aff6a-122">[Примечание по SAP № 2165547. Резервное копирование и восстановление SAP HANA в среде репликации системы SAP HANA](https://websmp230.sap-ag.de/sap(bD1lbiZjPTAwMQ==)/bc/bsp/sno/ui_entry/entry.htm?param=69765F6D6F64653D3030312669765F7361706E6F7465735F6E756D6265723D3231363535343726)</span><span class="sxs-lookup"><span data-stu-id="aff6a-122">[SAP Support Note #2165547 – SAP HANA Backup and Restore within SAP HANA System Replication Environment](https://websmp230.sap-ag.de/sap(bD1lbiZjPTAwMQ==)/bc/bsp/sno/ui_entry/entry.htm?param=69765F6D6F64653D3030312669765F7361706E6F7465735F6E756D6265723D3231363535343726)</span></span>
- <span data-ttu-id="aff6a-123">[Примечание по SAP № 1984882. Использование репликации системы SAP HANA для замены оборудования без простоя](https://websmp230.sap-ag.de/sap(bD1lbiZjPTAwMQ==)/bc/bsp/sno/ui_entry/entry.htm?param=69765F6D6F64653D3030312669765F7361706E6F7465735F6E756D6265723D3139383438383226)</span><span class="sxs-lookup"><span data-stu-id="aff6a-123">[SAP Support Note #1984882 – Using SAP HANA System Replication for Hardware Exchange with Minimum/Zero Downtime](https://websmp230.sap-ag.de/sap(bD1lbiZjPTAwMQ==)/bc/bsp/sno/ui_entry/entry.htm?param=69765F6D6F64653D3030312669765F7361706E6F7465735F6E756D6265723D3139383438383226)</span></span>

## <a name="disaster-recovery"></a><span data-ttu-id="aff6a-124">Аварийное восстановление</span><span class="sxs-lookup"><span data-stu-id="aff6a-124">Disaster recovery</span></span>

<span data-ttu-id="aff6a-125">Решение "SAP HANA в Azure (крупные экземпляры)" доступно в двух регионах Azure геополитического региона.</span><span class="sxs-lookup"><span data-stu-id="aff6a-125">SAP HANA on Azure (large instances) is offered in two Azure regions in a geopolitical region.</span></span> <span data-ttu-id="aff6a-126">Между двумя стеками крупных экземпляров, расположенными в разных регионах, устанавливается прямое сетевое подключение, используемое для репликации во время аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-126">Between the two large-instance stamps of two different regions is a direct network connectivity for replicating data during disaster recovery.</span></span> <span data-ttu-id="aff6a-127">Репликация данных зависит от инфраструктуры хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-127">The replication of the data is storage-infrastructure based.</span></span> <span data-ttu-id="aff6a-128">По умолчанию репликация не выполняется.</span><span class="sxs-lookup"><span data-stu-id="aff6a-128">The replication is not done by default.</span></span> <span data-ttu-id="aff6a-129">Она выполняется для клиентских конфигураций, предусматривающих аварийное восстановление.</span><span class="sxs-lookup"><span data-stu-id="aff6a-129">It is done for the customer configurations that ordered the disaster recovery.</span></span> <span data-ttu-id="aff6a-130">В текущей архитектуре решения репликацию системы HANA нельзя использовать для аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-130">In the current design, HANA system replication can't be used for disaster recovery.</span></span>

<span data-ttu-id="aff6a-131">Тем не менее, чтобы воспользоваться преимуществами аварийного восстановления, вам потребуется установить сетевое подключение к двум разным регионам Azure.</span><span class="sxs-lookup"><span data-stu-id="aff6a-131">However, to take advantage of the disaster recovery, you need to start to design the network connectivity to the two different Azure regions.</span></span> <span data-ttu-id="aff6a-132">Для этого вам нужно создать канал Azure ExpressRoute с подключением между локальной средой и основным регионом Azure и еще один канал с подключением между локальной средой и регионом аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-132">To do so, you need an Azure ExpressRoute circuit connection from on-premises in your main Azure region and another circuit connection from on-premises to your disaster-recovery region.</span></span> <span data-ttu-id="aff6a-133">Это позволит обеспечить работоспособность в случае возникновения проблем со всем регионом Azure, в том числе с расположением конечного маршрутизатора Microsoft Enterprise (MSEE).</span><span class="sxs-lookup"><span data-stu-id="aff6a-133">This measure would cover a situation in which a complete Azure region, including a Microsoft enterprise edge router (MSEE) location, has an issue.</span></span>

<span data-ttu-id="aff6a-134">Вы также можете подключить все виртуальные сети Azure, подключенные к SAP HANA в Azure (крупные экземпляры) в одном из регионов, к этим двум каналам ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="aff6a-134">As a second measure, you can connect all Azure virtual networks that connect to SAP HANA on Azure (large instances) in one of the regions to both of those ExpressRoute circuits.</span></span> <span data-ttu-id="aff6a-135">Это позволит устранить проблемы при выходе из обслуживания одного из расположений MSEE, используемых для установки подключения между локальным расположением и Azure.</span><span class="sxs-lookup"><span data-stu-id="aff6a-135">This measure addresses a case where only one of the MSEE locations that connects your on-premises location with Azure goes off duty.</span></span>

<span data-ttu-id="aff6a-136">На рисунке ниже показана оптимальная конфигурация для аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-136">The following figure shows the optimal configuration for disaster recovery:</span></span>

![Оптимальная конфигурация для аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/image1-optimal-configuration.png)

<span data-ttu-id="aff6a-138">Чтобы создать оптимальную конфигурацию аварийного восстановления сети, вам потребуется два канала ExpressRoute, соединяющих локальную среду и два разных региона Azure.</span><span class="sxs-lookup"><span data-stu-id="aff6a-138">The optimal case for a disaster-recovery configuration of the network is to have two ExpressRoute circuits from on-premises to the two different Azure regions.</span></span> <span data-ttu-id="aff6a-139">Первый канал подключается к региону 1, в котором выполняется рабочий экземпляр.</span><span class="sxs-lookup"><span data-stu-id="aff6a-139">One circuit goes to region #1, running a production instance.</span></span> <span data-ttu-id="aff6a-140">Второй канал ExpressRoute подключается к региону 2, где выполняются несколько нерабочих экземпляров HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-140">The second ExpressRoute circuit goes to region #2, running some non-production HANA instances.</span></span> <span data-ttu-id="aff6a-141">(Это важно, если весь регион Azure, в том числе MSEE и стек крупных экземпляров, выходит из обслуживания.)</span><span class="sxs-lookup"><span data-stu-id="aff6a-141">(This is important if an entire Azure region, including the MSEE and large-instance stamp, goes off the grid.)</span></span>

<span data-ttu-id="aff6a-142">Кроме того, различные виртуальные сети подключаются к различным каналам ExpressRoute, подключенным к SAP HANA в Azure (крупные экземпляры).</span><span class="sxs-lookup"><span data-stu-id="aff6a-142">As a second measure, the various virtual networks are connected to the various ExpressRoute circuits that are connected to SAP HANA on Azure (large instances).</span></span> <span data-ttu-id="aff6a-143">Вы можете обойти расположение, в котором возникли проблемы с MSEE, или снизить значение целевой точки восстановления для аварийного восстановления. Мы поговорим об этом позже.</span><span class="sxs-lookup"><span data-stu-id="aff6a-143">You can bypass the location where an MSEE is failing, or you can lower the recovery point objective for disaster recovery, as we discuss later.</span></span>

<span data-ttu-id="aff6a-144">Для настройки аварийного восстановления вам также потребуется сделать следующее:</span><span class="sxs-lookup"><span data-stu-id="aff6a-144">The next requirements for a disaster-recovery setup are:</span></span>

- <span data-ttu-id="aff6a-145">Закажите номера SKU для SAP HANA в Azure (крупные экземпляры) того же размера, что и рабочие номера SKU, и разверните их в регионе аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-145">You must order SAP HANA on Azure (large instances) SKUs of the same size as your production SKUs and deploy them in the disaster-recovery region.</span></span> <span data-ttu-id="aff6a-146">Эти экземпляры можно использовать для запуска экземпляров тестирования, песочницы или контроля качества HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-146">These instances can be used to run test, sandbox, or QA HANA instances.</span></span>
- <span data-ttu-id="aff6a-147">Кроме того, при необходимости закажите профиль аварийного восстановления для каждого номера SKU решения "SAP HANA в Azure (крупные экземпляры)", который вы хотите восстановить на сайте аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-147">You must order a disaster-recovery profile for each of your SAP HANA on Azure (large instances) SKUs that you want to recover in the disaster-recovery site, if necessary.</span></span> <span data-ttu-id="aff6a-148">Это обеспечивает выделение томов хранения данных, используемых при репликации хранилища из рабочего региона в регион аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-148">This action leads to the allocation of storage volumes, which are the target of the storage replication from your production region into the disaster-recovery region.</span></span>

<span data-ttu-id="aff6a-149">Как только вы выполните приведенные выше требования, можно приступать к запуску репликации хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-149">After you meet the preceding requirements, it is your responsibility to start the storage replication.</span></span> <span data-ttu-id="aff6a-150">В инфраструктуре хранилища, используемой для SAP HANA в Azure (крупные экземпляры), репликация хранилища выполняется на основе моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="aff6a-150">In the storage infrastructure used for SAP HANA on Azure (large instances), the basis of storage replication is storage snapshots.</span></span> <span data-ttu-id="aff6a-151">Чтобы начать репликацию и аварийное восстановление, вам потребуются:</span><span class="sxs-lookup"><span data-stu-id="aff6a-151">To start the disaster-recovery replication, you need to perform:</span></span>

- <span data-ttu-id="aff6a-152">моментальный снимок загрузочного логического номера устройства (LUN), как описано выше;</span><span class="sxs-lookup"><span data-stu-id="aff6a-152">A snapshot of your boot LUN, as described earlier.</span></span>
- <span data-ttu-id="aff6a-153">моментальный снимок томов, связанных с HANA, как описано выше.</span><span class="sxs-lookup"><span data-stu-id="aff6a-153">A snapshot of your HANA-related volumes, as described earlier.</span></span>

<span data-ttu-id="aff6a-154">После получения моментальных снимков исходная реплика этих томов заполняется на томах, связанных с профилем аварийного восстановления в соответствующем регионе.</span><span class="sxs-lookup"><span data-stu-id="aff6a-154">After you execute these snapshots, an initial replica of the volumes is seeded on the volumes that are associated with your disaster-recovery profile in the disaster-recovery region.</span></span>

<span data-ttu-id="aff6a-155">Следовательно, последний моментальный снимок хранилища используется каждый час для репликации изменений, произошедших на томах хранения.</span><span class="sxs-lookup"><span data-stu-id="aff6a-155">Subsequently, the most recent storage snapshot is used every hour to replicate the deltas that develop on the storage volumes.</span></span>

<span data-ttu-id="aff6a-156">При такой конфигурации целевая точка восстановления (RPO) составляет от 60 до 90 минут.</span><span class="sxs-lookup"><span data-stu-id="aff6a-156">The recovery point objective that's achieved with this configuration is from 60 to 90 minutes.</span></span> <span data-ttu-id="aff6a-157">Чтобы улучшить показатель RPO в случае аварийного восстановления, скопируйте резервные копии журнала транзакций HANA из SAP HANA в Azure (крупные экземпляры) и переместите их в другой регион Azure.</span><span class="sxs-lookup"><span data-stu-id="aff6a-157">To achieve a better recovery point objective in the disaster-recovery case, copy the HANA transaction log backups from SAP HANA on Azure (large instances) to the other Azure region.</span></span> <span data-ttu-id="aff6a-158">Чтобы достичь такой целевой точки восстановления, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="aff6a-158">To achieve this recovery point objective, do the following:</span></span>

1. <span data-ttu-id="aff6a-159">Выполняйте резервное копирование журнала транзакций HANA на том /hana/log/backup с максимально возможной частотой.</span><span class="sxs-lookup"><span data-stu-id="aff6a-159">Back up the HANA transaction log as frequently as possible to /hana/log/backup.</span></span>
2. <span data-ttu-id="aff6a-160">Скопируйте созданные резервные копии журнала транзакций на виртуальную машину Azure, расположенную в виртуальной сети, подключенной к серверу SAP HANA в Azure (крупные экземпляры).</span><span class="sxs-lookup"><span data-stu-id="aff6a-160">Copy the transaction log backups when they are finished to an Azure virtual machine (VM), which is in a virtual network that's connected to the SAP HANA on Azure (large instances) server.</span></span>
3. <span data-ttu-id="aff6a-161">Из этой виртуальной машины скопируйте резервные копии на виртуальную машину, которая находится в виртуальной сети в регионе аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-161">From that VM, copy the backup to a VM that's in a virtual network in the disaster-recovery region.</span></span>
4. <span data-ttu-id="aff6a-162">Храните резервные копии журнала транзакций на виртуальной машине в этом регионе.</span><span class="sxs-lookup"><span data-stu-id="aff6a-162">Keep the transaction log backups in that region in the VM.</span></span>

<span data-ttu-id="aff6a-163">В случае сбоя после развертывания профиля аварийного восстановления на фактическом сервере скопируйте резервные копии журнала транзакций из виртуальной машины на сервер SAP HANA в Azure (крупные экземпляры), который теперь основной в регионе аварийного восстановления, и восстановите их.</span><span class="sxs-lookup"><span data-stu-id="aff6a-163">In case of disaster, after the disaster-recovery profile has been deployed on an actual server, copy the transaction log backups from the VM to the SAP HANA on Azure (large instances) that is now the primary server in the disaster-recovery region, and restore those backups.</span></span> <span data-ttu-id="aff6a-164">Восстановление возможно благодаря тому, что состояние HANA на дисках аварийного восстановления и на моментальном снимке HANA совпадает,</span><span class="sxs-lookup"><span data-stu-id="aff6a-164">This recovery is possible because the state of HANA on the disaster-recovery disks is that of a HANA snapshot.</span></span> <span data-ttu-id="aff6a-165">что используется в качестве точки смещения для дальнейших восстановлений резервных копий журнала транзакций.</span><span class="sxs-lookup"><span data-stu-id="aff6a-165">This is the offset point for further restorations of transaction log backups.</span></span>

## <a name="backup-and-restore"></a><span data-ttu-id="aff6a-166">Архивация и восстановление</span><span class="sxs-lookup"><span data-stu-id="aff6a-166">Backup and restore</span></span>

<span data-ttu-id="aff6a-167">При работе с базами данных очень важно защитить их от различных событий, которые приводят к сбоям.</span><span class="sxs-lookup"><span data-stu-id="aff6a-167">One of the most important aspects to operating databases is making sure the database can be protected from various catastrophic events.</span></span> <span data-ttu-id="aff6a-168">Эти события могут возникать как в результате стихийных бедствий, так и через простые ошибки пользователей.</span><span class="sxs-lookup"><span data-stu-id="aff6a-168">These events can be caused by anything from natural disasters to simple user errors.</span></span>

<span data-ttu-id="aff6a-169">Резервное копирование с возможностью восстановления до любой точки во времени (например, перед удалением важных данных) обеспечивает восстановление базы данных до состояния, максимально приближенного к состоянию перед сбоем.</span><span class="sxs-lookup"><span data-stu-id="aff6a-169">Backing up a database, with the ability to restore it to any point in time (such as before somebody deleted critical data), allows restoration to a state that is as close as possible to the way it was before the disruption occurred.</span></span>

<span data-ttu-id="aff6a-170">Для получения оптимальных результатов выполните следующие два типа резервного копирования:</span><span class="sxs-lookup"><span data-stu-id="aff6a-170">Two types of backups must be performed for best results:</span></span>

- <span data-ttu-id="aff6a-171">Резервные копии базы данных</span><span class="sxs-lookup"><span data-stu-id="aff6a-171">Database backups</span></span>
- <span data-ttu-id="aff6a-172">резервное копирование журналов транзакций.</span><span class="sxs-lookup"><span data-stu-id="aff6a-172">Transaction log backups</span></span>

<span data-ttu-id="aff6a-173">Помимо полного резервного копирования базы данных на уровне приложений, вы также можете выполнить резервное копирование на основе моментальных снимков хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-173">In addition to full database backups performed at an application-level, you can be even more thorough by performing backups with storage snapshots.</span></span> <span data-ttu-id="aff6a-174">Чтобы восстановить базу данных, также важно выполнять резервное копирование журналов (и очищать журналы от уже выполненных транзакций).</span><span class="sxs-lookup"><span data-stu-id="aff6a-174">Performing log backups is also important for restoring the database (and to empty the logs from already committed transactions).</span></span>

<span data-ttu-id="aff6a-175">SAP HANA в Azure (крупные экземпляры) поддерживает следующие два варианта резервного копирования и восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-175">SAP HANA on Azure (large instances) offers two backup and restore options:</span></span>

- <span data-ttu-id="aff6a-176">Модель "Сделай сам".</span><span class="sxs-lookup"><span data-stu-id="aff6a-176">Do it yourself (DIY).</span></span> <span data-ttu-id="aff6a-177">После вычисления для обеспечения достаточного объема пространства на дисках выполните полное резервное копирование базы данных и журналов (на эти диски), используя методы резервного копирования дисков.</span><span class="sxs-lookup"><span data-stu-id="aff6a-177">After you calculate to ensure enough disk space, perform full database and log backups by using disk backup methods (to those disks).</span></span> <span data-ttu-id="aff6a-178">Со временем эти резервные копии будут скопированы в учетную запись хранения Azure (после настройки файлового сервера на основе Azure с практически неограниченным хранилищем). Кроме того, их можно скопировать в хранилище службы архивации Azure или в автономное неструктурированное защищенное хранилище Azure.</span><span class="sxs-lookup"><span data-stu-id="aff6a-178">Over time, the backups are copied to an Azure storage account (after you set up an Azure-based file server with virtually unlimited storage), or use an Azure Backup vault or Azure cold storage.</span></span> <span data-ttu-id="aff6a-179">Для хранения резервных данных после их копирования в учетную запись хранения можно также использовать стороннее средство защиты данных, например Commvault.</span><span class="sxs-lookup"><span data-stu-id="aff6a-179">Another option is to use a third-party data protection tool, such as Commvault, to store the backups after they are copied to a storage account.</span></span> <span data-ttu-id="aff6a-180">Из-за соответствия нормативным требованиям и возможностей аудита мы советуем использовать этот метод резервного копирования для длительного хранения данных.</span><span class="sxs-lookup"><span data-stu-id="aff6a-180">The DIY backup option might also be necessary for data that needs to be stored for longer periods for compliancy and auditing purposes.</span></span>
- <span data-ttu-id="aff6a-181">Используйте функции резервного копирования и восстановления, предоставленные базовой инфраструктурой SAP HANA в Azure (крупные экземпляры).</span><span class="sxs-lookup"><span data-stu-id="aff6a-181">Use the backup and restore functionality that the underlying infrastructure of SAP HANA on Azure (large instances) provides.</span></span> <span data-ttu-id="aff6a-182">Этот вариант полностью удовлетворяет потребности в резервном копировании и делает ручное резервное копирование практически неактуальным (кроме тех случаев, когда резервные копии данных нужны для соответствия нормативным требованиям).</span><span class="sxs-lookup"><span data-stu-id="aff6a-182">This option fulfills the need for backups, and it makes manual backups nearly obsolete (except where data backups are required for compliance purposes).</span></span> <span data-ttu-id="aff6a-183">В остальной части этого раздела описываются функции резервного копирования и восстановления, предоставляемые крупными экземплярами HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-183">The rest of this section addresses the backup and restore functionality that's offered with HANA (large instances).</span></span>

> [!NOTE]
> <span data-ttu-id="aff6a-184">Технология моментальных снимков, используемая в базовой инфраструктуре HANA (крупные экземпляры), зависима от моментальных снимков SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-184">The snapshot technology that is used by the underlying infrastructure of HANA (large instances) has a dependency on SAP HANA snapshots.</span></span> <span data-ttu-id="aff6a-185">Моментальные снимки SAP HANA не работают в сочетании с мультитенантными контейнерами баз данных SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-185">SAP HANA snapshots do not work in conjunction with SAP HANA Multitenant Database Containers.</span></span> <span data-ttu-id="aff6a-186">Таким образом, этот метод резервного копирования не может использоваться для развертывания мультитенантных контейнеров баз данных SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-186">As a result, this method of backup cannot be used to deploy SAP HANA Multitenant Database Containers.</span></span>

### <a name="using-storage-snapshots-of-sap-hana-on-azure-large-instances"></a><span data-ttu-id="aff6a-187">Использование моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры)</span><span class="sxs-lookup"><span data-stu-id="aff6a-187">Using storage snapshots of SAP HANA on Azure (large instances)</span></span>

<span data-ttu-id="aff6a-188">Базовая инфраструктура хранилища SAP HANA в Azure (крупные экземпляры) поддерживает концепцию моментальных снимков хранилища для томов.</span><span class="sxs-lookup"><span data-stu-id="aff6a-188">The storage infrastructure underlying SAP HANA on Azure (large instances) supports the notion of a storage snapshot of volumes.</span></span> <span data-ttu-id="aff6a-189">Вы можете выполнять резервное копирование и восстановление определенного тома, но следует учитывать следующее:</span><span class="sxs-lookup"><span data-stu-id="aff6a-189">Both backup and restoration of a particular volume are supported, with the following considerations:</span></span>

- <span data-ttu-id="aff6a-190">Вместо резервных копий базы данных на регулярной основе создаются моментальные снимки тома хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-190">Instead of database backups, storage volume snapshots are taken on a frequent basis.</span></span>
- <span data-ttu-id="aff6a-191">Перед созданием моментального снимка хранилища он инициирует моментальный снимок SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-191">The storage snapshot initiates an SAP HANA snapshot before it executes the storage snapshot.</span></span> <span data-ttu-id="aff6a-192">Этот моментальный снимок SAP HANA является точкой настройки для восстановления журнала после восстановления моментального снимка хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-192">This SAP HANA snapshot is the setup point for eventual log restorations after recovery of the storage snapshot.</span></span>
- <span data-ttu-id="aff6a-193">Если моментальный снимок хранилища создан успешно, моментальный снимок SAP HANA удаляется.</span><span class="sxs-lookup"><span data-stu-id="aff6a-193">At the point where the storage snapshot is executed successfully, the SAP HANA snapshot is deleted.</span></span>
- <span data-ttu-id="aff6a-194">Резервные копии журналов создаются часто и хранятся на томе резервных копий журналов или в Azure.</span><span class="sxs-lookup"><span data-stu-id="aff6a-194">Log backups are taken frequently and stored in the log backup volume or in Azure.</span></span>
- <span data-ttu-id="aff6a-195">Если базу данных необходимо восстановить до определенной точки во времени, отправьте в службу поддержки Microsoft Azure (рабочий сбой) или отдел по управлению службами SAP HANA в Azure запрос на восстановление до определенного моментального снимка хранилища (например, плановое восстановление системы типа "песочница" до исходного состояния).</span><span class="sxs-lookup"><span data-stu-id="aff6a-195">If the database must be restored to a certain point in time, a request is made to Microsoft Azure Support (production outage) or SAP HANA on Azure Service Management to restore to a certain storage snapshot (for example, a planned restoration of a sandbox system to its original state).</span></span>
- <span data-ttu-id="aff6a-196">Моментальный снимок SAP HANA, добавленный в моментальный снимок хранилища, используется в качестве точки смещения для применения резервных копий журнала, полученных и сохраненных после создания моментального снимка хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-196">The SAP HANA snapshot that's included in the storage snapshot is an offset point for applying log backups that have been executed and stored after the storage snapshot was taken.</span></span>
- <span data-ttu-id="aff6a-197">Эти резервные копии журналов используются для восстановления базы данных до определенной точки во времени.</span><span class="sxs-lookup"><span data-stu-id="aff6a-197">These log backups are taken to restore the database back to a certain point in time.</span></span>

<span data-ttu-id="aff6a-198">Задав имя резервной копии, вы создадите моментальный снимок следующих томов:</span><span class="sxs-lookup"><span data-stu-id="aff6a-198">Specifying the backup\_name creates a snapshot of the following volumes:</span></span>

- <span data-ttu-id="aff6a-199">hana/data;</span><span class="sxs-lookup"><span data-stu-id="aff6a-199">hana/data</span></span>
- <span data-ttu-id="aff6a-200">hana/log;</span><span class="sxs-lookup"><span data-stu-id="aff6a-200">hana/log</span></span>
- <span data-ttu-id="aff6a-201">hana/log\_backup (подключен как резервная копия в hana/log);</span><span class="sxs-lookup"><span data-stu-id="aff6a-201">hana/log\_backup (mounted as backup into hana/log)</span></span>
- <span data-ttu-id="aff6a-202">hana/shared.</span><span class="sxs-lookup"><span data-stu-id="aff6a-202">hana/shared</span></span>

### <a name="storage-snapshot-considerations"></a><span data-ttu-id="aff6a-203">Факторы, которые необходимо учитывать при создании моментальных снимков хранилища</span><span class="sxs-lookup"><span data-stu-id="aff6a-203">Storage snapshot considerations</span></span>

>[!NOTE]
><span data-ttu-id="aff6a-204">Моментальные снимки хранилища _не_ предоставляются бесплатно, так как для их хранения требуется дополнительное дисковое пространство.</span><span class="sxs-lookup"><span data-stu-id="aff6a-204">Storage snapshots are _not_ provided free of charge, because additional storage space must be allocated.</span></span>

<span data-ttu-id="aff6a-205">Принцип действия моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры) включает в себя следующие аспекты:</span><span class="sxs-lookup"><span data-stu-id="aff6a-205">The specific mechanics of storage snapshots for SAP HANA on Azure (large instances) include:</span></span>

- <span data-ttu-id="aff6a-206">Определенный моментальный снимок хранилища (созданный на определенный момент времени) занимает очень мало пространства в хранилище.</span><span class="sxs-lookup"><span data-stu-id="aff6a-206">A specific storage snapshot (at the point in time when it is taken) consumes very little storage.</span></span>
- <span data-ttu-id="aff6a-207">На моментальном снимке должен храниться исходный набор данных, так как данные и содержимое файлов данных в SAP HANA изменяются на томе хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-207">As data content changes and the content in SAP HANA data files change on the storage volume, the snapshot needs to store the original block content.</span></span>
- <span data-ttu-id="aff6a-208">Размер моментального снимка хранилища увеличивается</span><span class="sxs-lookup"><span data-stu-id="aff6a-208">The storage snapshot increases in size.</span></span> <span data-ttu-id="aff6a-209">в зависимости от срока его хранения.</span><span class="sxs-lookup"><span data-stu-id="aff6a-209">The longer the snapshot exists, the larger the storage snapshot becomes.</span></span>
- <span data-ttu-id="aff6a-210">Чем больше изменений внесено на томе базы данных SAP HANA в течение жизненного цикла моментального снимка хранилища, тем больше места он занимает.</span><span class="sxs-lookup"><span data-stu-id="aff6a-210">The more changes made to the SAP HANA database volume over the lifetime of a storage snapshot, the larger the space consumption of the storage snapshot becomes.</span></span>

<span data-ttu-id="aff6a-211">SAP HANA в Azure (крупные экземпляры) поставляется с фиксированными размерами томов для данных и журнального тома SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-211">SAP HANA on Azure (large instances) comes with fixed volume sizes for the SAP HANA data and log volume.</span></span> <span data-ttu-id="aff6a-212">При создании моментальных снимков этих томов используется место на томе. Вы должны самостоятельно спланировать создание моментальных снимков хранилища (в рамках процесса SAP HANA в Azure (крупные экземпляры)).</span><span class="sxs-lookup"><span data-stu-id="aff6a-212">Performing snapshots of those volumes eats into your volume space, so it is your responsibility to schedule storage snapshots (within the SAP HANA on Azure [large instances] process).</span></span>

<span data-ttu-id="aff6a-213">В следующих разделах содержатся сведения о создании этих моментальных снимков, а также общие рекомендации.</span><span class="sxs-lookup"><span data-stu-id="aff6a-213">The following sections provide information for performing these snapshots, including general recommendations:</span></span>

- <span data-ttu-id="aff6a-214">Хотя оборудование поддерживает 255 моментальных снимков на том, мы настоятельно советуем хранить намного меньшее их количество.</span><span class="sxs-lookup"><span data-stu-id="aff6a-214">Though the hardware can sustain 255 snapshots per volume, we highly recommend that you stay well below this number.</span></span>
- <span data-ttu-id="aff6a-215">Прежде чем выполнять моментальные снимки хранилища, отслеживайте свободное пространство.</span><span class="sxs-lookup"><span data-stu-id="aff6a-215">Before you perform storage snapshots, monitor and keep track of free space.</span></span>
- <span data-ttu-id="aff6a-216">В зависимости от свободного пространства количество моментальных снимков хранилища можно уменьшить.</span><span class="sxs-lookup"><span data-stu-id="aff6a-216">Lower the number of storage snapshots based on free space.</span></span> <span data-ttu-id="aff6a-217">Может потребоваться уменьшить количество хранящихся моментальных снимков или расширить тома.</span><span class="sxs-lookup"><span data-stu-id="aff6a-217">You might need to lower the number of snapshots that you keep, or you might need to extend the volumes.</span></span> <span data-ttu-id="aff6a-218">(Вы можете заказать дополнительное пространство в единицах по 1 ТБ.)</span><span class="sxs-lookup"><span data-stu-id="aff6a-218">(You can order additional storage in 1-TB units.)</span></span>
- <span data-ttu-id="aff6a-219">При выполнении действий, например при переносе данных в SAP HANA с помощью средств переноса системы (в частности, с помощью R3load) или при восстановлении баз данных SAP HANA на основе резервных копий, мы настоятельно советуем не создавать моментальные снимки хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-219">During activities such as moving data into SAP HANA with system migration tools (with R3load, or by restoring SAP HANA databases from backups), we highly recommended that you not perform any storage snapshots.</span></span> <span data-ttu-id="aff6a-220">Если перенос системы выполняется в новой системе SAP HANA, моментальные снимки создавать не нужно.</span><span class="sxs-lookup"><span data-stu-id="aff6a-220">(If a system migration is being done on a new SAP HANA system, storage snapshots would not need to be performed.)</span></span>
- <span data-ttu-id="aff6a-221">При более значительных реорганизациях таблиц SAP HANA по возможности не создавайте моментальные снимки хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-221">During larger reorganizations of SAP HANA tables, storage snapshots should be avoided if possible.</span></span>
- <span data-ttu-id="aff6a-222">Моментальные снимки хранилища необходимы для поддержки возможностей аварийного восстановления SAP HANA в Azure (крупные экземпляры).</span><span class="sxs-lookup"><span data-stu-id="aff6a-222">Storage snapshots are a prerequisite to engaging the disaster-recovery capabilities of SAP HANA on Azure (large instances).</span></span>

### <a name="setting-up-storage-snapshots"></a><span data-ttu-id="aff6a-223">Настройка моментальных снимков хранилища</span><span class="sxs-lookup"><span data-stu-id="aff6a-223">Setting up storage snapshots</span></span>

1. <span data-ttu-id="aff6a-224">Установите Perl в операционной системе Linux на сервере решения "Крупные экземпляры HANA".</span><span class="sxs-lookup"><span data-stu-id="aff6a-224">Make sure that Perl is installed in the Linux operating system on the HANA (large instances) server.</span></span>
2. <span data-ttu-id="aff6a-225">Добавьте в файл /etc/ssh/ssh\_config строку _MACs hmac-sha1_.</span><span class="sxs-lookup"><span data-stu-id="aff6a-225">Modify /etc/ssh/ssh\_config to add the line _MACs hmac-sha1_.</span></span>
3. <span data-ttu-id="aff6a-226">На главном узле создайте учетную запись резервного копирования SAP HANA для каждого запущенного экземпляра SAP HANA (если применимо).</span><span class="sxs-lookup"><span data-stu-id="aff6a-226">Create an SAP HANA backup user account on the master node for each SAP HANA instance you are running (if applicable).</span></span>
4. <span data-ttu-id="aff6a-227">Установите на всех серверах решения "Крупные экземпляры SAP HANA" клиент SAP HANA HDB.</span><span class="sxs-lookup"><span data-stu-id="aff6a-227">The SAP HANA HDB client must be installed on all SAP HANA (large instances) servers.</span></span>
5. <span data-ttu-id="aff6a-228">На первом сервере решения "Крупные экземпляры SAP HANA" каждого региона создайте открытый ключ, используемый для доступа к базовой инфраструктуре хранилища, отвечающей за создание моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="aff6a-228">On the first SAP HANA (large instances) server of each region, a public key must be created to access the underlying storage infrastructure that controls snapshot creation.</span></span>
6. <span data-ttu-id="aff6a-229">Скопируйте скрипт azure\_hana\_backup.pl из /scripts в расположение **hdbsql**, где установлена система SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-229">Copy the script azure\_hana\_backup.pl from /scripts to the location of **hdbsql** of the SAP HANA installation.</span></span>
7. <span data-ttu-id="aff6a-230">Скопируйте файл HANABackupDetails.txt из /scripts в то же расположение, что и скрипт Perl.</span><span class="sxs-lookup"><span data-stu-id="aff6a-230">Copy the HANABackupDetails.txt file from /scripts to the same location as the Perl script.</span></span>
8. <span data-ttu-id="aff6a-231">Измените файл HANABackupDetails.txt в соответствии с определенной спецификацией клиента.</span><span class="sxs-lookup"><span data-stu-id="aff6a-231">Modify the HANABackupDetails.txt file as necessary for the appropriate customer specifications.</span></span>

### <a name="step-1-install-sap-hana-hdbclient"></a><span data-ttu-id="aff6a-232">Этап 1. Установка клиента SAP HANA HDB</span><span class="sxs-lookup"><span data-stu-id="aff6a-232">Step 1: Install SAP HANA HDBClient</span></span>

<span data-ttu-id="aff6a-233">Операционная система Linux, установленная в решении "SAP HANA в Azure (крупные экземпляры)", содержит папки и скрипты, необходимые для создания моментальных снимков хранилища SAP HANA, используемых для резервного копирования и восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-233">The Linux installed on SAP HANA on Azure (large instances) includes the folders and scripts necessary to execute SAP HANA storage snapshots for backup and disaster-recovery purposes.</span></span> <span data-ttu-id="aff6a-234">Однако во время установки SAP HANA вы должны самостоятельно установить клиент SAP HANA HDB.</span><span class="sxs-lookup"><span data-stu-id="aff6a-234">However, it is your responsibility to install SAP HANA HDBclient while you are installing SAP HANA.</span></span> <span data-ttu-id="aff6a-235">(Корпорация Майкрософт не устанавливает ни клиент HDB, ни SAP HANA.)</span><span class="sxs-lookup"><span data-stu-id="aff6a-235">(Microsoft installs neither the HDBclient nor SAP HANA.)</span></span>

### <a name="step-2-change-etcsshsshconfig"></a><span data-ttu-id="aff6a-236">Этап 2. Изменение файла /etc/ssh/ssh\_config</span><span class="sxs-lookup"><span data-stu-id="aff6a-236">Step 2: Change /etc/ssh/ssh\_config</span></span>

<span data-ttu-id="aff6a-237">Добавьте в файл /etc/ssh/ssh\_config строку _MACs hmac-sha1_, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="aff6a-237">Change /etc/ssh/ssh\_config by adding _MACs hmac-sha1_ line as shown here:</span></span>
```
#   RhostsRSAAuthentication no
#   RSAAuthentication yes
#   PasswordAuthentication yes
#   HostbasedAuthentication no
#   GSSAPIAuthentication no
#   GSSAPIDelegateCredentials no
#   GSSAPIKeyExchange no
#   GSSAPITrustDNS no
#   BatchMode no
#   CheckHostIP yes
#   AddressFamily any
#   ConnectTimeout 0
#   StrictHostKeyChecking ask
#   IdentityFile ~/.ssh/identity
#   IdentityFile ~/.ssh/id_rsa
#   IdentityFile ~/.ssh/id_dsa
#   Port 22
Protocol 2
#   Cipher 3des
#   Ciphers aes128-ctr,aes192-ctr,aes256-ctr,arcfour256,arcfour128,aes128-cbc,3des-cbc
#   MACs hmac-md5,hmac-sha1,umac-64@openssh.com,hmac-ripemd160
MACs hmac-sha1
#   EscapeChar ~
#   Tunnel no
#   TunnelDevice any:any
#   PermitLocalCommand no
#   VisualHostKey no
#   ProxyCommand ssh -q -W %h:%p gateway.example.com
```

### <a name="step-3-create-a-public-key"></a><span data-ttu-id="aff6a-238">Этап 3. Создание открытого ключа</span><span class="sxs-lookup"><span data-stu-id="aff6a-238">Step 3: Create a public key</span></span>

<span data-ttu-id="aff6a-239">Для создания моментальных снимков на первом сервере решения "SAP HANA в Azure (крупные экземпляры)" каждого региона Azure создайте открытый ключ, используемый для доступа к инфраструктуре хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-239">On the first SAP HANA on Azure (large instances) server in each Azure region, create a public key to be used to access the storage infrastructure so that you can create snapshots.</span></span> <span data-ttu-id="aff6a-240">Этот ключ позволит входить в хранилище без пароля, что устраняет необходимость в настройке последнего.</span><span class="sxs-lookup"><span data-stu-id="aff6a-240">The public key ensures that a password is not required to sign in to the storage and that password credentials are not maintained.</span></span> <span data-ttu-id="aff6a-241">Чтобы создать открытый ключ, в операционной системе Linux на сервере решения "Крупные экземпляры SAP HANA" выполните следующую команду:</span><span class="sxs-lookup"><span data-stu-id="aff6a-241">In Linux on the SAP HANA (large instances) server, execute the following command to generate the public key:</span></span>
```
  ssh-keygen –t dsa –b 1024
```
<span data-ttu-id="aff6a-242">Новое расположение — _/root/.ssh/id\_dsa.pub.</span><span class="sxs-lookup"><span data-stu-id="aff6a-242">The new location is _/root/.ssh/id\_dsa.pub.</span></span> <span data-ttu-id="aff6a-243">Не вводите фактическую парольную фразу, иначе вам нужно будет вводить ее при каждом входе.</span><span class="sxs-lookup"><span data-stu-id="aff6a-243">Do not enter an actual passphrase, or else you will be required to enter the passphrase each time you sign in.</span></span> <span data-ttu-id="aff6a-244">Вместо этого нажмите клавишу **ВВОД** дважды, чтобы закрыть этот запрос.</span><span class="sxs-lookup"><span data-stu-id="aff6a-244">Instead, press **Enter** twice to remove the enter passphrase requirement for signing in.</span></span>

<span data-ttu-id="aff6a-245">Убедитесь, что открытый ключ был исправлен надлежащим образом. Для этого измените папки на /root/.ssh/ и выполните команду **ls**.</span><span class="sxs-lookup"><span data-stu-id="aff6a-245">Check to make sure that the public key was corrected as expected by changing folders to /root/.ssh/ and then executing the **ls** command.</span></span> <span data-ttu-id="aff6a-246">Если ключ присутствует, его можно скопировать, выполнив следующую команду:</span><span class="sxs-lookup"><span data-stu-id="aff6a-246">If the key is present, you can copy it by running the following command:</span></span>

![Команда для копирования открытого ключа](./media/hana-overview-high-availability-disaster-recovery/image2-public-key.png)

<span data-ttu-id="aff6a-248">На этом этапе обратитесь в отдел по управлению службами SAP HANA в Azure и предоставьте этот ключ.</span><span class="sxs-lookup"><span data-stu-id="aff6a-248">At this point, contact SAP HANA on Azure Service Management and provide the key.</span></span> <span data-ttu-id="aff6a-249">Уполномоченный представитель зарегистрирует его в базовой инфраструктуре хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-249">The service representative uses the public key to register it in the underlying storage infrastructure.</span></span>

### <a name="step-4-create-an-sap-hana-user-account"></a><span data-ttu-id="aff6a-250">Этап 4. Создание учетной записи пользователя SAP HANA</span><span class="sxs-lookup"><span data-stu-id="aff6a-250">Step 4: Create an SAP HANA user account</span></span>

<span data-ttu-id="aff6a-251">Создайте в SAP HANA Studio учетную запись пользователя SAP HANA. Она будет использоваться для резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="aff6a-251">Create an SAP HANA user account within SAP HANA Studio for backup purposes.</span></span> <span data-ttu-id="aff6a-252">Предоставьте ей привилегии _администратора резервного копирования_ и _права на чтение каталогов_.</span><span class="sxs-lookup"><span data-stu-id="aff6a-252">This account must have the following privileges: _Backup Admin_ and _Catalog Read_.</span></span> <span data-ttu-id="aff6a-253">В этом примере мы создали имя пользователя SCADMIN.</span><span class="sxs-lookup"><span data-stu-id="aff6a-253">In this example, the username SCADMIN is created.</span></span>

![Создание пользователя в HANA Studio](./media/hana-overview-high-availability-disaster-recovery/image3-creating-user.png)

### <a name="step-5-authorize-the-sap-hana-user-account"></a><span data-ttu-id="aff6a-255">Этап 5. Авторизация учетной записи пользователя SAP HANA</span><span class="sxs-lookup"><span data-stu-id="aff6a-255">Step 5: Authorize the SAP HANA user account</span></span>

<span data-ttu-id="aff6a-256">Авторизируйте учетную запись SAP HANA (это позволит каждый раз использовать ее при запуске скрипта, в котором не требуется выполнять авторизацию).</span><span class="sxs-lookup"><span data-stu-id="aff6a-256">Authorize the SAP HANA user account (to be used by the scripts without requiring authorization every time the script is run).</span></span> <span data-ttu-id="aff6a-257">Команда SAP HANA `hdbuserstore` позволяет создать ключ пользователя SAP HANA, который хранится на одном или нескольких узлах SAP HANA,</span><span class="sxs-lookup"><span data-stu-id="aff6a-257">The SAP HANA command `hdbuserstore` allows the creation of an SAP HANA user key, which is stored on one or more SAP HANA nodes.</span></span> <span data-ttu-id="aff6a-258">и предоставляет пользователю доступ к SAP HANA (при этом в процессе написания скрипта, описанном ниже, не нужно заботиться об управлении паролями).</span><span class="sxs-lookup"><span data-stu-id="aff6a-258">The user key also allows the user to access SAP HANA without having to manage passwords from within the scripting process that's discussed later.</span></span>

>[!IMPORTANT]
><span data-ttu-id="aff6a-259">Выполните следующую команду от имени `_root_`:</span><span class="sxs-lookup"><span data-stu-id="aff6a-259">Run the following command as `_root_`.</span></span> <span data-ttu-id="aff6a-260">В противном случае скрипт не будет работать должным образом.</span><span class="sxs-lookup"><span data-stu-id="aff6a-260">Otherwise, the script cannot work properly.</span></span>

<span data-ttu-id="aff6a-261">Введите команду `hdbuserstore`, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="aff6a-261">Enter the `hdbuserstore` command as follows:</span></span>

![Ввод команды hdbuserstore](./media/hana-overview-high-availability-disaster-recovery/image4-hdbuserstore-command.png)

<span data-ttu-id="aff6a-263">В следующем примере используется пользователь SCADMIN01, а имя узла — lhanad01. В этом случае команда выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="aff6a-263">In the following example, where the user is SCADMIN01 and the hostname is lhanad01, the command is:</span></span>
```
hdbuserstore set SCADMIN01 lhanad01:30115 <backup username> <password>
```
<span data-ttu-id="aff6a-264">Управляйте всеми процессами написания скрипта для масштабируемых экземпляров HANA с одного сервера.</span><span class="sxs-lookup"><span data-stu-id="aff6a-264">Manage all scripting from a single server for scale-out HANA instances.</span></span> <span data-ttu-id="aff6a-265">В этом примере ключ SAP HANA пользователя SCADMIN01 необходимо изменить для каждого узла. Этот ключ должен отражать узел, связанный с ним.</span><span class="sxs-lookup"><span data-stu-id="aff6a-265">In this example, the SAP HANA key SCADMIN01 must be altered for each host in a way that reflects the host that is related to the key.</span></span> <span data-ttu-id="aff6a-266">Это означает, что в учетной записи резервного копирования SAP HANA нужно изменить номер экземпляра узла **lhanad** для базы данных HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-266">That is, the SAP HANA backup account is amended with the instance number of the HANA DB, **lhanad**.</span></span> <span data-ttu-id="aff6a-267">Предоставьте ключу права администратора на узле, которому он назначен, а пользователю резервного копирования, используемому для масштабирования, — права на доступ ко всем экземплярам SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-267">The key must have administrative privileges on the host it is assigned to, and the backup user for scale-out must have access rights to all SAP HANA instances.</span></span>
```
hdbuserstore set SCADMIN01 lhanad:30015 SCADMIN <password>
hdbuserstore set SCADMIN02 lhanad:30115 SCADMIN <password>
hdbuserstore set SCADMIN03 lhanad:30215 SCADMIN <password>
```

### <a name="step-6-copy-items-from-the-scripts-folder"></a><span data-ttu-id="aff6a-268">Этап 6. Копирование элементов из папки /scripts</span><span class="sxs-lookup"><span data-stu-id="aff6a-268">Step 6: Copy items from the /scripts folder</span></span>

<span data-ttu-id="aff6a-269">Из папки /scripts (включенной в эталонный образ установки) скопируйте в рабочий каталог **hdbsql** следующие элементы.</span><span class="sxs-lookup"><span data-stu-id="aff6a-269">Copy the following items from the /scripts folder (included on the gold image of the installation) to the working directory for **hdbsql**.</span></span> <span data-ttu-id="aff6a-270">Для текущих установок HANA это каталог /hana/shared/D01/exe/linuxx86\_64/hdb.</span><span class="sxs-lookup"><span data-stu-id="aff6a-270">For current HANA installations, this directory is /hana/shared/D01/exe/linuxx86\_64/hdb.</span></span>
```
azure\_hana\_backup.pl
testHANAConnection.pl
testStorageSnapshotConnection.pl
removeTestStorageSnapshot.pl
HANABackupCustomerDetails.txt
```
<span data-ttu-id="aff6a-271">Скопируйте следующие элементы, если они выполняются в масштабируемой среде или в среде OLAP:</span><span class="sxs-lookup"><span data-stu-id="aff6a-271">Copy the following items if they are running scale-out or OLAP:</span></span>
```
azure\_hana\_backup\_bw.pl
testHANAConnectionBW.pl
testStorageSnapshotConnectionBW.pl
removeTestStorageSnapshotBW.pl
HANABackupCustomerDetailsBW.txt
```
<span data-ttu-id="aff6a-272">Файл HANABackupCustomerDetails.txt можно изменить для масштабного развертывания.</span><span class="sxs-lookup"><span data-stu-id="aff6a-272">The HANABackupCustomerDetails.txt file is modifiable as follows for a scale-up deployment.</span></span> <span data-ttu-id="aff6a-273">Это файл параметров и конфигурации скрипта, выполняющего моментальные снимки хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-273">It is the control and configuration file for the script that runs the storage snapshots.</span></span> <span data-ttu-id="aff6a-274">После развертывания экземпляров отдел по управлению службами SAP HANA в Azure должен был предоставить _имя резервного копирования_ и _IP-адрес хранилища_.</span><span class="sxs-lookup"><span data-stu-id="aff6a-274">You should have received the _Storage Backup Name_ and _Storage IP Address_ from SAP HANA on Azure Service Management when your instances were deployed.</span></span> <span data-ttu-id="aff6a-275">Порядок, упорядочение переменных или интервал между ними изменять нельзя, иначе скрипт не будет запускаться должным образом.</span><span class="sxs-lookup"><span data-stu-id="aff6a-275">You cannot modify the sequence, ordering, or spacing of any of the variables, or the script does not run properly.</span></span>

<span data-ttu-id="aff6a-276">Файл конфигурации, используемый для масштабного развертывания, выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="aff6a-276">For a scale-up deployment, the configuration file would look like:</span></span>
```
#Provided by Microsoft Service Management
Storage Backup Name: lhanad01backup
Storage IP Address: 10.250.20.21
#Created by customer using hdbuserstore
HANA Backup Name: SCADMIND01
```
<span data-ttu-id="aff6a-277">Файл HANABackupCustomerDetailsBW.txt, используемый для масштабного развертывания, выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="aff6a-277">For a scale-out configuration, the HANABackupCustomerDetailsBW.txt file would look like:</span></span>
```
#Provided by Microsoft Service Management
Storage Backup Name: lhanad01backup
Storage IP Address: 10.250.20.21
#Node IP addresses, instance numbers, and HANA backup name
#provided by customer.  HANA backup name created using
#hdbuserstore utility.
Node 1 IP Address: 10.254.15.21
Node 1 HANA instance number: 01
Node 1 HANA Backup Name: SCADMIN01
Node 2 IP Address: 10.254.15.22
Node 2 HANA instance number: 02
Node 2 HANA Backup Name: SCADMIN02
Node 3 IP Address: 10.254.15.23
Node 3 HANA instance number: 03
Node 3 HANA Backup Name: SCADMIN03
Node 4 IP Address: 10.254.15.24
Node 4 HANA instance number: 04
Node 4 HANA Backup Name: SCADMIN04
Node 5 IP Address: 10.254.15.25
Node 5 HANA instance number: 05
Node 5 HANA Backup Name: SCADMIN05
Node 6 IP Address: 10.254.15.26
Node 6 HANA instance number: 06
Node 6 HANA Backup Name: SCADMIN06
Node 7 IP Address: 10.254.15.27
Node 7 HANA instance number: 07
Node 7 HANA Backup Name: SCADMIN07
Node 8 IP Address: 10.254.15.28
Node 8 HANA instance number: 08
Node 8 HANA Backup Name: SCADMIN08
```
>[!NOTE]
><span data-ttu-id="aff6a-278">В настоящее время в фактическом скрипте создания моментальных снимков хранилища HANA используются только сведения об узле 1.</span><span class="sxs-lookup"><span data-stu-id="aff6a-278">Currently, only Node 1 details are used in the actual HANA storage snapshot script.</span></span> <span data-ttu-id="aff6a-279">Мы советуем проверить доступ ко всем узлам HANA и из них. Так вы сможете убедиться, что в случае возможного изменения главного узла резервного копирования любой другой узел сможет занять его место за счет изменения сведений в узле 1.</span><span class="sxs-lookup"><span data-stu-id="aff6a-279">We recommend that you test access to or from all HANA nodes so that, if the master backup node ever changes, you have already ensured that any other node can take its place by modifying the details in Node 1.</span></span>

<span data-ttu-id="aff6a-280">Чтобы удостовериться в правильности конфигураций в файле конфигурации и подключения к экземплярам HANA, выполните один из следующих скриптов.</span><span class="sxs-lookup"><span data-stu-id="aff6a-280">To check for the correct configurations in the configuration file or proper connectivity to the HANA instances, run either of the following scripts:</span></span>
- <span data-ttu-id="aff6a-281">Для конфигурации вертикального масштабирования (независимо от рабочей нагрузки SAP):</span><span class="sxs-lookup"><span data-stu-id="aff6a-281">For a scale-up configuration (independent on SAP workload):</span></span>

 ```
testHANAConnection.pl
```
- <span data-ttu-id="aff6a-282">Для конфигурации горизонтального масштабирования:</span><span class="sxs-lookup"><span data-stu-id="aff6a-282">For a scale-out configuration:</span></span>

 ```
testHANAConnectionBW.pl
```

<span data-ttu-id="aff6a-283">Главный экземпляр HANA должен иметь доступ ко всем необходимым серверам.</span><span class="sxs-lookup"><span data-stu-id="aff6a-283">Ensure that the master HANA instance has access to all required HANA servers.</span></span> <span data-ttu-id="aff6a-284">В этом скрипте отсутствуют параметры, но для надлежащего его выполнения необходимо создать соответствующий файл HANABackupCustomerDetails и HANABackupCustomerDetailsBW.</span><span class="sxs-lookup"><span data-stu-id="aff6a-284">There are no parameters to the script, but you must complete the appropriate HANABackupCustomerDetails/ HANABackupCustomerDetailsBW file for the script to run properly.</span></span> <span data-ttu-id="aff6a-285">Этот скрипт не поддерживает поиск ошибок в каждом отдельном экземпляре, так как возвращаются только коды ошибок в команде оболочки.</span><span class="sxs-lookup"><span data-stu-id="aff6a-285">Because only the shell command error codes are returned, it is not possible for the script to error-check every instance.</span></span> <span data-ttu-id="aff6a-286">Однако он предоставляет некоторые полезные сведения, которые нужно тщательно проверить.</span><span class="sxs-lookup"><span data-stu-id="aff6a-286">Even so, the script does provide some helpful comments for you to double-check.</span></span>

<span data-ttu-id="aff6a-287">Выполните следующее, чтобы запустить этот сценарий.</span><span class="sxs-lookup"><span data-stu-id="aff6a-287">To run the script:</span></span>
```
 ./testHANAConnection.pl
```
 <span data-ttu-id="aff6a-288">Если в результате выполнения скрипта возвращается состояние экземпляра HANA, отобразится сообщение об успешном подключении к HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-288">If the script successfully obtains the status of the HANA instance, it displays a message that the HANA connection was successful.</span></span>

<span data-ttu-id="aff6a-289">Кроме того, возможность подключения сервера главного экземпляра HANA к хранилищу можно также проверить с помощью скрипта другого типа.</span><span class="sxs-lookup"><span data-stu-id="aff6a-289">Additionally, there is a second type of script you can use to check the master HANA instance server's ability to sign in to the storage.</span></span> <span data-ttu-id="aff6a-290">Перед выполнением скрипта azure\_hana\_backup(\_bw).pl необходимо выполнить следующий скрипт.</span><span class="sxs-lookup"><span data-stu-id="aff6a-290">Before you execute the azure\_hana\_backup(\_bw).pl script, you must execute the next script.</span></span> <span data-ttu-id="aff6a-291">Если на томе отсутствуют моментальные снимки, вы не сможете определить разницу между таким томом и SSH-ошибкой при получении сведений о моментальных снимках.</span><span class="sxs-lookup"><span data-stu-id="aff6a-291">If a volume contains no snapshots, it is impossible to determine whether the volume is simply empty or there is an ssh failure to obtain the snapshot details.</span></span> <span data-ttu-id="aff6a-292">По этой причине выполнение скрипта состоит из двух этапов:</span><span class="sxs-lookup"><span data-stu-id="aff6a-292">For this reason, the script executes two steps:</span></span>

- <span data-ttu-id="aff6a-293">проверка доступности консоли хранилища;</span><span class="sxs-lookup"><span data-stu-id="aff6a-293">It verifies that the storage console is accessible.</span></span>
- <span data-ttu-id="aff6a-294">создание тестового (фиктивного) моментального снимка для каждого тома экземпляра HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-294">It creates a test, or dummy, snapshot for each volume by HANA instance.</span></span>

<span data-ttu-id="aff6a-295">Из-за этого экземпляр HANA добавляется в качестве аргумента.</span><span class="sxs-lookup"><span data-stu-id="aff6a-295">For this reason, the HANA instance is included as an argument.</span></span> <span data-ttu-id="aff6a-296">Опять же, вы не можете настроить поиск ошибок для подключения хранилища. Однако в случае сбоя выполнения скрипт предоставляет некоторые полезные сведения.</span><span class="sxs-lookup"><span data-stu-id="aff6a-296">Again, it is not possible to provide error checking for the storage connection, but the script provides helpful hints if the execution fails.</span></span>

<span data-ttu-id="aff6a-297">Скрипт выполняется как:</span><span class="sxs-lookup"><span data-stu-id="aff6a-297">The script is run as:</span></span>
```
 ./testStorageSnapshotConnection.pl <hana instance>
```
<span data-ttu-id="aff6a-298">Или как:</span><span class="sxs-lookup"><span data-stu-id="aff6a-298">Or it is run as:</span></span>
```
./testStorageSnapshotConnectionBW.pl <hana instance>
```
<span data-ttu-id="aff6a-299">Кроме того, этот скрипт выводит сообщение о возможности входа в развернутый клиент хранилища, в основе которого лежат логические номера устройства, используемые вашими экземплярами сервера.</span><span class="sxs-lookup"><span data-stu-id="aff6a-299">The script also displays a message that you are able to sign in appropriately to your deployed storage tenant, which is organized around the logical unit numbers (LUNs) that are used by the server instances you own.</span></span>

<span data-ttu-id="aff6a-300">Перед созданием первых резервных копий на основе моментальных снимков хранилища проверьте правильность конфигурации, выполнив приведенные ниже скрипты.</span><span class="sxs-lookup"><span data-stu-id="aff6a-300">Before you execute the first storage snapshot-based backups, run the next scripts to make sure that the configuration is correct.</span></span>

<span data-ttu-id="aff6a-301">Затем вы можете удалить эти моментальные снимки с помощью следующей команды:</span><span class="sxs-lookup"><span data-stu-id="aff6a-301">After running these scripts, you can delete the snapshots by executing:</span></span>
```
./removeTestStorageSnapshot.pl <hana instance>
```
<span data-ttu-id="aff6a-302">или</span><span class="sxs-lookup"><span data-stu-id="aff6a-302">Or</span></span>
```
./removeTestStorageSnapshot.pl <hana instance>
```

### <a name="step-7-perform-on-demand-snapshots"></a><span data-ttu-id="aff6a-303">Этап 7. Создание моментальных снимков по запросу</span><span class="sxs-lookup"><span data-stu-id="aff6a-303">Step 7: Perform on-demand snapshots</span></span>

<span data-ttu-id="aff6a-304">Создайте моментальные снимки по запросу (или же запланируйте регулярное создание этих снимков с помощью Cron), выполнив один из следующих скриптов.</span><span class="sxs-lookup"><span data-stu-id="aff6a-304">Perform on-demand snapshots (as well as schedule regular snapshots by using cron) as described here.</span></span>

<span data-ttu-id="aff6a-305">Для конфигурации вертикального масштабирования:</span><span class="sxs-lookup"><span data-stu-id="aff6a-305">For scale-up configurations, execute the following script:</span></span>
```
./azure_hana_backup.pl lhanad01 customer 20
```
<span data-ttu-id="aff6a-306">Для конфигурации горизонтального масштабирования:</span><span class="sxs-lookup"><span data-stu-id="aff6a-306">For scale-out configurations, execute the following script:</span></span>
```
./azure_hana_backup_bw.pl lhanad01 customer 20
```
<span data-ttu-id="aff6a-307">Скрипт горизонтального масштабирования выполняет дополнительные проверки доступа ко всем серверам HANA. Перед выполнением дальнейших действий по созданию моментальных снимков SAP HANA или хранилища все экземпляры HANA должны вернуть соответствующее состояние.</span><span class="sxs-lookup"><span data-stu-id="aff6a-307">The scale-out script does some additional checking to make sure that all HANA servers can be accessed, and all HANA instances return appropriate status of the instance before proceeding with creating SAP HANA or storage snapshots.</span></span>

<span data-ttu-id="aff6a-308">Вам потребуются следующие аргументы:</span><span class="sxs-lookup"><span data-stu-id="aff6a-308">The following arguments are required:</span></span>

- <span data-ttu-id="aff6a-309">соответствующая резервная копия экземпляра HANA;</span><span class="sxs-lookup"><span data-stu-id="aff6a-309">The HANA instance requiring backup.</span></span>
- <span data-ttu-id="aff6a-310">префикс для моментального снимка хранилища;</span><span class="sxs-lookup"><span data-stu-id="aff6a-310">The snapshot prefix for the storage snapshot.</span></span>
- <span data-ttu-id="aff6a-311">несколько моментальных снимков с определенным префиксом.</span><span class="sxs-lookup"><span data-stu-id="aff6a-311">The number of snapshots to be kept for the specific prefix.</span></span>

```
./azure_hana_backup.pl lhanad01 customer 20
```

<span data-ttu-id="aff6a-312">Создание моментальных снимков с помощью этого скрипта состоит из следующих трех этапов:</span><span class="sxs-lookup"><span data-stu-id="aff6a-312">The execution of the script creates the storage snapshot in these three distinct phases:</span></span>

- <span data-ttu-id="aff6a-313">создание моментального снимка HANA;</span><span class="sxs-lookup"><span data-stu-id="aff6a-313">Execute a HANA snapshot.</span></span>
- <span data-ttu-id="aff6a-314">создание моментального снимка хранилища;</span><span class="sxs-lookup"><span data-stu-id="aff6a-314">Execute a storage snapshot.</span></span>
- <span data-ttu-id="aff6a-315">удаление моментального снимка HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-315">Remove the HANA snapshot.</span></span>

<span data-ttu-id="aff6a-316">Выполните скрипт, вызвав его из выполняемой папки HDB, в которую он был скопирован.</span><span class="sxs-lookup"><span data-stu-id="aff6a-316">Execute the script by calling it from the HDB executable folder that it was copied to.</span></span> <span data-ttu-id="aff6a-317">Это позволит создать резервные копии по крайней мере указанных ниже томов, а также томов с явным именем экземпляра SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-317">It backs up at least the following volumes, but it also backs up any volume that has the explicit SAP HANA instance name in the volume name.</span></span>
```
hana_data_<hana instance>_prod_t020_vol
hana_log_<hana instance>_prod_t020_vol
hana_log_backup_<hana instance>_prod_t020_vol
hana_shared_<hana instance>_prod_t020_vol
```
<span data-ttu-id="aff6a-318">Срок хранения совпадает с количеством моментальных снимков. Это значение задается как параметр во время выполнения скрипта (например, 20 в примере выше).</span><span class="sxs-lookup"><span data-stu-id="aff6a-318">The retention period is strictly administered, with the number of snapshots submitted as a parameter when you execute the script (such as 20, shown previously).</span></span> <span data-ttu-id="aff6a-319">Поэтому количество времени зависит от времени выполнения скрипта и заданного в нем количества моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="aff6a-319">So the amount of time is a function of the period of execution and the number of snapshots in the call of the script.</span></span> <span data-ttu-id="aff6a-320">Если число моментальных снимков превышает значение, заданное при выполнении скрипта, перед созданием следующего моментального снимка хранилища удаляется самый старый моментальный снимок этой временной метки (_custom_ в описанном выше случае).</span><span class="sxs-lookup"><span data-stu-id="aff6a-320">If the number of snapshots that are kept exceeds the number that are named as a parameter in the call of the script, the oldest storage snapshot of this label (in our previous case, _custom_) is deleted before a new snapshot is executed.</span></span> <span data-ttu-id="aff6a-321">Это означает, что допустимое количество моментальных снимков можно задать в последнем параметре скрипта.</span><span class="sxs-lookup"><span data-stu-id="aff6a-321">This means the number you give as the last parameter of the call is the number you can use to control the number of snapshots.</span></span>

>[!NOTE]
><span data-ttu-id="aff6a-322">После изменения метки отсчет начинается сначала.</span><span class="sxs-lookup"><span data-stu-id="aff6a-322">As soon as you change the label, the counting starts again.</span></span>

<span data-ttu-id="aff6a-323">При создании моментальных снимков среды с несколькими узлами добавьте имя экземпляра HANA, предоставленное отделом по управлению службами SAP HANA в Azure, в качестве аргумента.</span><span class="sxs-lookup"><span data-stu-id="aff6a-323">You need to include the HANA instance name that's provided by SAP HANA on Azure Service Management as an argument if they are creating snapshots in multi-node environments.</span></span> <span data-ttu-id="aff6a-324">В средах с одним узлом можно использовать имя решения "SAP HANA в Azure (крупные экземпляры)". Однако мы советуем использовать имя экземпляра HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-324">In single-node environments, the name of the SAP HANA on Azure (large instances) unit is sufficient, but the HANA instance name is still recommended.</span></span>

<span data-ttu-id="aff6a-325">Кроме того, можно выполнить резервное копирование томов загрузки или логических томов, используя тот же скрипт.</span><span class="sxs-lookup"><span data-stu-id="aff6a-325">Additionally, you can back up boot volumes\LUNs by using the same script.</span></span> <span data-ttu-id="aff6a-326">Резервную копию загрузочного тома необходимо создать по крайней мере при первом запуске HANA. Однако мы советуем запланировать резервное копирование, выполняемое каждую неделю или каждую ночь, с помощью Cron.</span><span class="sxs-lookup"><span data-stu-id="aff6a-326">You must back up your boot volume at least once when you first run HANA, although we recommend a weekly or nightly backup schedule for booting in cron.</span></span> <span data-ttu-id="aff6a-327">В этом случае не нужно добавлять имя экземпляра SAP HANA. Просто вставьте в следующий скрипт аргумент _boot_, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="aff6a-327">Rather than add an SAP HANA instance name, insert _boot_ as the argument into the script as follows:</span></span>
```
./azure_hana_backup boot customer 20
```
<span data-ttu-id="aff6a-328">К загрузочному тому применяется та же политика хранения.</span><span class="sxs-lookup"><span data-stu-id="aff6a-328">The same retention policy is afforded to the boot volume as well.</span></span> <span data-ttu-id="aff6a-329">Создавать моментальные снимки по запросу нужно только в определенных случаях (например, во время обновления SAP EHP или если нужно создать моментальный снимок отдельного хранилища).</span><span class="sxs-lookup"><span data-stu-id="aff6a-329">Use on-demand snapshots, as described previously, for special cases only, such as during an SAP enhancement package (EHP) upgrade, or when you need to create a distinct storage snapshot.</span></span>

<span data-ttu-id="aff6a-330">Мы настоятельно советуем настроить плановое создание моментальных снимков хранилища с помощью средства Cron. Кроме того, мы советуем использовать один скрипт для создания всех резервных копий и аварийного восстановления (в этом случае нужно изменять входные данные скрипта в соответствии со временем резервного копирования).</span><span class="sxs-lookup"><span data-stu-id="aff6a-330">We encourage you to perform scheduled storage snapshots using cron, and we recommend that you use the same script for all backups and disaster-recovery needs (modifying the script inputs to match the various requested backup times).</span></span> <span data-ttu-id="aff6a-331">Это средство позволяет настроить резервное копирование на регулярной основе, например каждый час, каждые 12 часов, каждый день или каждую неделю.</span><span class="sxs-lookup"><span data-stu-id="aff6a-331">These are all scheduled differently in cron depending on their execution time: hourly, 12-hour, daily, or weekly.</span></span> <span data-ttu-id="aff6a-332">Средство Cron позволяет создавать моментальные снимки хранилища в соответствии с рассмотренным выше периодом удержания меток для длительного удаленного резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="aff6a-332">The cron schedule is designed to create storage snapshots that match the previously discussed retention labeling for long-term off-site backup.</span></span> <span data-ttu-id="aff6a-333">Этот скрипт содержит команды резервного копирования всех рабочих томов с запрошенной частотой (резервные копии данных и файлов журналов создаются каждый час, а загрузочного тома — каждый день).</span><span class="sxs-lookup"><span data-stu-id="aff6a-333">The script includes commands to back up all production volumes, depending on their requested frequency (data and log files are backed up hourly, whereas the boot volume is backed up daily).</span></span>

<span data-ttu-id="aff6a-334">Следующий скрипт Cron выполняется каждый час, каждые 12 часов и каждый день на десятой минуте.</span><span class="sxs-lookup"><span data-stu-id="aff6a-334">The entries in the following cron script run every hour at the tenth minute, every 12 hours at the tenth minute, and daily at the tenth minute.</span></span> <span data-ttu-id="aff6a-335">Задания Cron созданы таким образом, что в течение заданного часа выполняется только один моментальный снимок хранилища. Поэтому ежедневное и ежечасное резервное копирование выполняется в разное время (00:10).</span><span class="sxs-lookup"><span data-stu-id="aff6a-335">The cron jobs are created in such a way that only one SAP HANA storage snapshot takes place during any particular hour, so that the hourly and daily backups do not occur at the same time (12:10 AM).</span></span> <span data-ttu-id="aff6a-336">Чтобы оптимизировать создание и репликацию моментальных снимков, отдел по управлению службами SAP HANA в Azure предоставляет сведения о рекомендуемом времени выполнения резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="aff6a-336">To help optimize your snapshot creation and replication, SAP HANA on Azure Service Management provides the recommended time for you to run your backups.</span></span>

<span data-ttu-id="aff6a-337">При стандартных настройках содержимое файла расписания /etc/crontab имеет следующий вид:</span><span class="sxs-lookup"><span data-stu-id="aff6a-337">The default cron scheduling in /etc/crontab is as follows:</span></span>
```
10 1-11,13-23 * * * ./azure_hana_backup.pl lhanad01 hourly 66
10 12 * * *  ./azure_hana_backup.pl lhanad01 12hour 14
```
<span data-ttu-id="aff6a-338">В инструкции Cron выше моментальные снимки томов HANA (без загрузочного тома) создаются каждый час,</span><span class="sxs-lookup"><span data-stu-id="aff6a-338">In the previous cron instructions, the HANA volumes (without boot volume) get an hourly snapshot with the label.</span></span> <span data-ttu-id="aff6a-339">и 66 из них сохраняются.</span><span class="sxs-lookup"><span data-stu-id="aff6a-339">Of these snapshots, 66 are retained.</span></span> <span data-ttu-id="aff6a-340">Кроме того, сохраняются также 14 моментальных снимков, создаваемых каждые 12 часов.</span><span class="sxs-lookup"><span data-stu-id="aff6a-340">Additionally, 14 snapshots with the 12-hour label are retained.</span></span> <span data-ttu-id="aff6a-341">Таким образом, вы можете хранить моментальные снимки, создаваемые каждый час, в течение трех дней и моментальные снимки, создаваемые каждые 12 часов, в течение четырех дней. Следовательно, моментальные снимки позволяют охватить целую неделю.</span><span class="sxs-lookup"><span data-stu-id="aff6a-341">You potentially get hourly snapshots for three days, plus 12-hour snapshots for another four days, which gives you an entire week of snapshots.</span></span>

<span data-ttu-id="aff6a-342">Планирование графика в Cron может оказаться непростой задачей. Это связано с тем, что в конкретный момент времени можно выполнить только один скрипт, за исключением тех случаев, когда скрипт выполняется периодически в течение нескольких минут.</span><span class="sxs-lookup"><span data-stu-id="aff6a-342">Scheduling within cron can be tricky, because only one script should be executed at any particular time, unless the scripts are staggered by several minutes.</span></span> <span data-ttu-id="aff6a-343">Если вы хотите создавать ежедневные резервные копии и хранить их на протяжение длительного времени, настройте как ежедневное создание моментальных снимков, так и их создание с двенадцатичасовым интервалом (для периода удержания задайте значение 7). Кроме того, вместо двенадцатичасового можно настроить ежечасное создание моментальных снимков, выполняемое на 10 минут позднее.</span><span class="sxs-lookup"><span data-stu-id="aff6a-343">If you want daily backups for long-term retention, either a daily snapshot is kept along with a 12-hour snapshot (with a retention count of seven each), or the hourly snapshot is staggered to take place 10 minutes later.</span></span> <span data-ttu-id="aff6a-344">Но в этом случае на рабочем томе будет храниться только один ежедневный моментальный снимок.</span><span class="sxs-lookup"><span data-stu-id="aff6a-344">Only one daily snapshot is kept in the production volume.</span></span>
```
10 1-11,13-23 * * * ./azure_hana_backup.pl lhanad01 hourly 66
10 12 * * *  ./azure_hana_backup.pl lhanad01 12hour 7
10 0 * * * ./azure_hana_backup.pl lhanad01 daily 7
```
<span data-ttu-id="aff6a-345">Указанные здесь значения частоты приведены исключительно для примера.</span><span class="sxs-lookup"><span data-stu-id="aff6a-345">The frequencies listed here are only examples.</span></span> <span data-ttu-id="aff6a-346">Чтобы определить оптимальное количество моментальных снимков, полагайтесь на следующие критерии:</span><span class="sxs-lookup"><span data-stu-id="aff6a-346">To derive your optimum number of snapshots, use the following criteria:</span></span>

- <span data-ttu-id="aff6a-347">Требования к RTO для восстановления на определенный момент времени.</span><span class="sxs-lookup"><span data-stu-id="aff6a-347">Requirements in recovery time objective for point-in-time recovery.</span></span>
- <span data-ttu-id="aff6a-348">Использование пространства.</span><span class="sxs-lookup"><span data-stu-id="aff6a-348">Space usage.</span></span>
- <span data-ttu-id="aff6a-349">Требования к RTO и RTO в случае возможного аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-349">Requirements in recovery point objective and recovery time objective for potential disaster recovery.</span></span>
- <span data-ttu-id="aff6a-350">Последующее выполнение полного резервного копирования базы данных HANA на диски.</span><span class="sxs-lookup"><span data-stu-id="aff6a-350">Eventual execution of HANA full database backups against disks.</span></span> <span data-ttu-id="aff6a-351">При выполнении полного резервного копирования базы данных на диски (или в интерфейс _backint_) создание моментальных снимков хранилища завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="aff6a-351">Whenever a full database backup against disks, or _backint_ interface, is performed, the execution of storage snapshots fails.</span></span> <span data-ttu-id="aff6a-352">Если вы хотите выполнить полное резервное копирование базы данных на основе моментальных снимков хранилища, отключите на это время создание этих моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="aff6a-352">If you plan to execute full database backups on top of storage snapshots, make sure that the execution of storage snapshots is disabled during this time.</span></span>

>[!IMPORTANT]
> <span data-ttu-id="aff6a-353">Резервное копирование SAP HANA на основе моментальных снимков хранилища выполняется, только если моментальные снимки создаются совместно с резервным копированием журналов SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-353">The use of storage snapshots for SAP HANA backups is valid only when the snapshots are performed in conjunction with SAP HANA log backups.</span></span> <span data-ttu-id="aff6a-354">Эти резервные копии журналов должны охватывать временные периоды между моментальными снимками хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-354">These log backups need to be able to cover the time periods between the storage snapshots.</span></span> <span data-ttu-id="aff6a-355">Если необходимо выполнить восстановление на определенный момент времени в пределах 30 дней, вам потребуются:</span><span class="sxs-lookup"><span data-stu-id="aff6a-355">If you've set a commitment to users of a point-in-time recovery of 30 days, you need the following:</span></span>

- <span data-ttu-id="aff6a-356">доступ к моментальным снимкам хранилища тридцатидневной давности;</span><span class="sxs-lookup"><span data-stu-id="aff6a-356">Ability to access a storage snapshot that is 30 days old.</span></span>
- <span data-ttu-id="aff6a-357">связанные резервные копии журналов за последние 30 дней.</span><span class="sxs-lookup"><span data-stu-id="aff6a-357">Contiguous log backups over the last 30 days.</span></span>

<span data-ttu-id="aff6a-358">Вам также потребуется создать моментальный снимок резервной копии журнального тома.</span><span class="sxs-lookup"><span data-stu-id="aff6a-358">In the range of log backups, create a snapshot of the backup log volume as well.</span></span> <span data-ttu-id="aff6a-359">Кроме того, обязательно настройте регулярное резервное копирование журнала, чтобы:</span><span class="sxs-lookup"><span data-stu-id="aff6a-359">However, be sure to perform regular log backups so that you can:</span></span>

- <span data-ttu-id="aff6a-360">иметь связанные резервные копии журналов, необходимые для выполнения восстановлений до точки во времени;</span><span class="sxs-lookup"><span data-stu-id="aff6a-360">Have the contiguous log backups needed to perform point-in-time recoveries.</span></span>
- <span data-ttu-id="aff6a-361">предотвратить нехватку места на журнальном томе SAP HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-361">Prevent the SAP HANA log volume from running out of space.</span></span>

<span data-ttu-id="aff6a-362">Один из последних этапов заключается в настройке расписания для создания резервных копий журнала SAP HANA в SAP HANA Studio.</span><span class="sxs-lookup"><span data-stu-id="aff6a-362">One of the last steps is to schedule SAP HANA backup logs in SAP HANA Studio.</span></span> <span data-ttu-id="aff6a-363">Резервные копии журнала SAP HANA сохраняются на специальном томе hana/log\_backups с точкой подключения /hana/log/backups.</span><span class="sxs-lookup"><span data-stu-id="aff6a-363">The SAP HANA backup log target destination is the specially created hana/log\_backups volume with the mount point of /hana/log/backups.</span></span>

![Настройка расписания для создания резервных копий журнала SAP HANA в SAP HANA Studio.](./media/hana-overview-high-availability-disaster-recovery/image5-schedule-backup.png)

<span data-ttu-id="aff6a-365">Можно выполнять резервные копии намного чаще, чем каждые 15 минут.</span><span class="sxs-lookup"><span data-stu-id="aff6a-365">You can choose backups that are more frequent than every 15 minutes.</span></span> <span data-ttu-id="aff6a-366">Некоторые пользователи выполняют резервное копирование журналов каждую минуту. Однако мы не советуем создавать резервные копии _реже_, чем раз в 15 минут.</span><span class="sxs-lookup"><span data-stu-id="aff6a-366">Some users even perform log backups every minute, although we do not recommend going _over_ 15 minutes.</span></span>

<span data-ttu-id="aff6a-367">Последний этап заключается в создании файловой резервной копии (после начальной установки SAP HANA). Это позволит создать единую резервную копию записи, которая должна находиться в каталоге резервных копий.</span><span class="sxs-lookup"><span data-stu-id="aff6a-367">The final step is to perform a file-based backup (after the initial installation of SAP HANA) to create a single backup entry that must exist within the backup catalog.</span></span> <span data-ttu-id="aff6a-368">В противном случае SAP HANA не может инициировать резервное копирование журнала.</span><span class="sxs-lookup"><span data-stu-id="aff6a-368">Otherwise SAP HANA cannot initiate your specified log backups.</span></span>

![Создание файловой резервной копии для формирования единой записи о резервной копии](./media/hana-overview-high-availability-disaster-recovery/image6-make-backup.png)

### <a name="monitoring-the-number-and-size-of-snapshots-on-the-disk-volume"></a><span data-ttu-id="aff6a-370">Мониторинг количества и размера моментальных снимков на томе диска</span><span class="sxs-lookup"><span data-stu-id="aff6a-370">Monitoring the number and size of snapshots on the disk volume</span></span>

<span data-ttu-id="aff6a-371">Количество моментальных снимков и потребляемое ими пространство на определенном томе хранилища можно отслеживать.</span><span class="sxs-lookup"><span data-stu-id="aff6a-371">On a particular storage volume, you can monitor the number of snapshots and the storage consumption of snapshots.</span></span> <span data-ttu-id="aff6a-372">Команда `ls` не возвращает сведения о каталоге или файлах моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="aff6a-372">The `ls` command doesn't show the snapshot directory or files.</span></span> <span data-ttu-id="aff6a-373">Эти сведения можно получить, добавив команду `du` операционной системы Linux в следующие команды:</span><span class="sxs-lookup"><span data-stu-id="aff6a-373">However, the Linux OS command `du` does, with the following commands:</span></span>

- <span data-ttu-id="aff6a-374">`du –sh .snapshot` — возвращает общее число моментальных снимков в каталоге моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="aff6a-374">`du –sh .snapshot` provides a total of all snapshots within the snapshot directory.</span></span>
- <span data-ttu-id="aff6a-375">`du –sh --max-depth=1` — выводит список всех моментальных снимков, сохраненных в папке .snapshot, и размер каждого моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="aff6a-375">`du –sh --max-depth=1` lists all snapshots that are saved in the .snapshot folder and the size of each snapshot.</span></span>
- <span data-ttu-id="aff6a-376">`du –hc` — возвращает общий размер всех моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="aff6a-376">`du –hc` provides the total size used by all snapshots.</span></span>

<span data-ttu-id="aff6a-377">Следующие команды предоставляют сведения о создании и хранении моментальных снимков, а также об используемом ими пространстве на томах.</span><span class="sxs-lookup"><span data-stu-id="aff6a-377">Use these commands to make sure that the snapshots that are taken and stored are not consuming all the storage on the volumes.</span></span>

### <a name="reducing-the-number-of-snapshots-on-a-server"></a><span data-ttu-id="aff6a-378">Уменьшение количества моментальных снимков на сервере</span><span class="sxs-lookup"><span data-stu-id="aff6a-378">Reducing the number of snapshots on a server</span></span>

<span data-ttu-id="aff6a-379">Как упоминалось ранее, количество моментальных снимков, создаваемых с определенным интервалом, можно уменьшить.</span><span class="sxs-lookup"><span data-stu-id="aff6a-379">As explained earlier, you can reduce the number of certain labels of snapshots that you store.</span></span> <span data-ttu-id="aff6a-380">Последние два параметра команды позволяют указать временную метку и количество хранимых моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="aff6a-380">The last two parameters of the command to initiate a snapshot are a label and the number of snapshots you want to retain.</span></span>
```
./azure_hana_backup.pl lhanad01 customer 20
```
<span data-ttu-id="aff6a-381">В примере выше для моментальных снимков задана метка _customer_, а количество моментальных снимков, которые должны храниться с этой меткой, равно _20_.</span><span class="sxs-lookup"><span data-stu-id="aff6a-381">In the previous example, the snapshot label is _customer_ and the number of snapshots with this label to be retained is _20_.</span></span> <span data-ttu-id="aff6a-382">За использование дискового пространства отвечаете вы, и поэтому вам может потребоваться уменьшить количество сохраненных моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="aff6a-382">As you respond to disk space consumption, you might want to reduce the number of stored snapshots.</span></span> <span data-ttu-id="aff6a-383">Это можно легко сделать с помощью скрипта ниже, указав для последнего параметра значение 5.</span><span class="sxs-lookup"><span data-stu-id="aff6a-383">The easy way to reduce the number of snapshots is to run the script with the last parameter set to 5:</span></span>
```
./azure_hana_backup.pl lhanad01 customer 5
```
<span data-ttu-id="aff6a-384">Выполнение этого скрипта позволяет уменьшить количество моментальных снимков, в том числе новый моментальный снимок хранилища, до _5_.</span><span class="sxs-lookup"><span data-stu-id="aff6a-384">As a result of running the script with this setting, the number of snapshots, including the new storage snapshot, is _5_.</span></span>

 >[!NOTE]
 > <span data-ttu-id="aff6a-385">Этот скрипт уменьшает количество моментальных снимков, только если последний моментальный снимок создан более часа назад.</span><span class="sxs-lookup"><span data-stu-id="aff6a-385">This script reduces the number of snapshots only if the most recent previous snapshot is more than one hour old.</span></span> <span data-ttu-id="aff6a-386">Он не удаляет моментальные снимки, созданные менее часа назад.</span><span class="sxs-lookup"><span data-stu-id="aff6a-386">The script does not delete snapshots that are less than one hour old.</span></span>

<span data-ttu-id="aff6a-387">Эти ограничения связаны с предоставленными необязательными функциями аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-387">These restrictions are related to the optional disaster-recovery functionality offered.</span></span>

<span data-ttu-id="aff6a-388">Если больше не требуется хранить моментальные снимки с этим префиксом, выполните скрипт, задав для периода удержания значение _0_. Скрипт удалит все моментальные снимки с соответствующим префиксом, а затем завершит работу.</span><span class="sxs-lookup"><span data-stu-id="aff6a-388">If you no longer want to maintain a set of snapshots with that prefix, you can execute the script with _0_ as the retention number to remove all snapshots matching that prefix.</span></span> <span data-ttu-id="aff6a-389">Однако это повлияет на возможности аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-389">However, removing all snapshots can affect the capabilities of disaster recovery.</span></span>

### <a name="recovering-to-the-most-recent-hana-snapshot"></a><span data-ttu-id="aff6a-390">Восстановление до последнего моментального снимка HANA</span><span class="sxs-lookup"><span data-stu-id="aff6a-390">Recovering to the most recent HANA snapshot</span></span>

<span data-ttu-id="aff6a-391">В случае сбоя рабочей системы, обратившись в отдел по управлению службами SAP HANA в Azure, вы можете инициировать процесс восстановления из моментального снимка хранилища как пользовательский инцидент.</span><span class="sxs-lookup"><span data-stu-id="aff6a-391">In the event that you experience a production-down scenario, the process of recovering from a storage snapshot can be initiated as a customer incident with SAP HANA on Azure Service Management.</span></span> <span data-ttu-id="aff6a-392">В некоторых случаях удаление данных в рабочей системе невозможно предвидеть, и единственный способ быстро вернуть их — восстановить рабочую базу данных.</span><span class="sxs-lookup"><span data-stu-id="aff6a-392">Such an unexpected scenario might be a high-urgency matter if data was deleted in a production system and the only way to retrieve the data is to restore the production database.</span></span>

<span data-ttu-id="aff6a-393">С другой стороны, восстановление на определенный момент времени может быть не срочным и планироваться наперед.</span><span class="sxs-lookup"><span data-stu-id="aff6a-393">On the other hand, a point-in-time recovery could be low urgency and planned for days in advance.</span></span> <span data-ttu-id="aff6a-394">Чтобы спланировать восстановление, можно обратиться в отдел по управлению службами SAP HANA в Azure и поднять высокоприоритетные вопросы.</span><span class="sxs-lookup"><span data-stu-id="aff6a-394">You can plan this recovery with SAP HANA on Azure Service Management instead of raising a high-priority issue.</span></span> <span data-ttu-id="aff6a-395">К примеру, вы планируете установить новую версию пакета расширений для программного обеспечения SAP, а затем хотите вернуться до состояния перед обновлением EHP.</span><span class="sxs-lookup"><span data-stu-id="aff6a-395">For example, you might be planning to try an upgrade of the SAP software by applying a new enhancement package, and you then need to revert back to a snapshot that represents the state before the EHP upgrade.</span></span>

<span data-ttu-id="aff6a-396">Прежде чем подать запрос, необходимо выполнить некоторые подготовительные действия,</span><span class="sxs-lookup"><span data-stu-id="aff6a-396">Before you issue the request, you need to do some preparation.</span></span> <span data-ttu-id="aff6a-397">чтобы отдел по управлению службами SAP HANA в Azure мог обработать запрос и предоставить восстановленные тома,</span><span class="sxs-lookup"><span data-stu-id="aff6a-397">SAP HANA on Azure Service Management team can then handle the request and provide the restored volumes.</span></span> <span data-ttu-id="aff6a-398">после чего вы сможете восстановить базу данных HANA на основе моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="aff6a-398">Afterward, it is up to you to restore the HANA database based on the snapshots.</span></span> <span data-ttu-id="aff6a-399">Ниже приведены действия для подготовки к запросу.</span><span class="sxs-lookup"><span data-stu-id="aff6a-399">Here is how to prepare for the request:</span></span>

>[!NOTE]
><span data-ttu-id="aff6a-400">В зависимости от используемого выпуска SAP HANA пользовательский интерфейс может отличаться от следующих снимков экрана.</span><span class="sxs-lookup"><span data-stu-id="aff6a-400">Your user interface might vary from the following screenshots, depending on the SAP HANA release you are using.</span></span>

1. <span data-ttu-id="aff6a-401">Выберите моментальный снимок, который нужно восстановить.</span><span class="sxs-lookup"><span data-stu-id="aff6a-401">Decide which snapshot to restore.</span></span> <span data-ttu-id="aff6a-402">Если не указано другое, будет восстановлен только том hana/data.</span><span class="sxs-lookup"><span data-stu-id="aff6a-402">Only the hana/data volume would be restored unless you are instructed otherwise.</span></span>

2. <span data-ttu-id="aff6a-403">Завершите работу экземпляра HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-403">Shut down the HANA instance.</span></span>

 ![Завершение работы экземпляра HANA](./media/hana-overview-high-availability-disaster-recovery/image7-shutdown-hana.png)

3. <span data-ttu-id="aff6a-405">Отключите тома данных на каждом узле базы данных HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-405">Unmount the data volumes on each HANA database node.</span></span> <span data-ttu-id="aff6a-406">Если они не отключены, восстановление моментального снимка завершится сбоем.</span><span class="sxs-lookup"><span data-stu-id="aff6a-406">The restoration of the snapshot fails if the data volumes are not unmounted.</span></span>

 ![Отключение томов данных на каждом узле базы данных HANA](./media/hana-overview-high-availability-disaster-recovery/image8-unmount-data-volumes.png)

4. <span data-ttu-id="aff6a-408">Отправьте запрос в службу поддержки Azure, чтобы получить указания по восстановлению определенного моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="aff6a-408">Open an Azure support request to instruct the restoration of a specific snapshot.</span></span>

 - <span data-ttu-id="aff6a-409">Во время восстановления: представитель отдела по управлению службами SAP HANA в Azure может присоединить вас к конференции, чтобы гарантировать восстановление всех данных.</span><span class="sxs-lookup"><span data-stu-id="aff6a-409">During the restoration: SAP HANA on Azure Service Management might ask you to attend a conference call to ensure that no data is getting lost.</span></span>

 - <span data-ttu-id="aff6a-410">После восстановления: отдел по управлению службами SAP HANA в Azure отправит вам оповещение о восстановлении моментального снимка хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-410">After the restoration: SAP HANA on Azure Service Management notifies you when the storage snapshot has been restored.</span></span>

5. <span data-ttu-id="aff6a-411">Когда процесс восстановления завершится, подключите все тома данных.</span><span class="sxs-lookup"><span data-stu-id="aff6a-411">After the restoration process is complete, remount all data volumes.</span></span>

 ![Подключение всех томов данных](./media/hana-overview-high-availability-disaster-recovery/image9-remount-data-volumes.png)

6. <span data-ttu-id="aff6a-413">Выберите параметры восстановления в SAP HANA Studio, если они не отобразились автоматически при повторном подключении к базе данных HANA через SAP HANA Studio.</span><span class="sxs-lookup"><span data-stu-id="aff6a-413">Select recovery options within SAP HANA Studio, if they do not automatically come up when you reconnect to HANA DB through SAP HANA Studio.</span></span> <span data-ttu-id="aff6a-414">В приведенном ниже примере показано, как выполнить восстановление до последнего моментального снимка HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-414">The following example shows a restoration to the last HANA snapshot.</span></span> <span data-ttu-id="aff6a-415">Моментальный снимок хранилища внедряет моментальный снимок HANA. При восстановлении до последнего моментального снимка хранилища это будет последний моментальный снимок HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-415">A storage snapshot embeds one HANA snapshot, and if you are restoring to the most recent storage snapshot, it should be the most recent HANA snapshot.</span></span> <span data-ttu-id="aff6a-416">(При восстановлении до более старого моментального снимка хранилища найдите моментальный снимок HANA на основе времени создания моментального снимка хранилища.)</span><span class="sxs-lookup"><span data-stu-id="aff6a-416">(If you are restoring to older storage snapshots, you need to locate the HANA snapshot based on the time the storage snapshot was taken.)</span></span>

 ![Выбор параметров восстановления в SAP HANA Studio](./media/hana-overview-high-availability-disaster-recovery/image10-recover-options-a.png)

7. <span data-ttu-id="aff6a-418">Установите переключатель **Recover the database to a specific data backup or storage snapshot** (Восстановить базу данных до определенной резервной копии или моментального снимка хранилища).</span><span class="sxs-lookup"><span data-stu-id="aff6a-418">Select **Recover the database to a specific data backup or storage snapshot**.</span></span>

 ![Окно Specify Recovery Type (Выбор типа восстановления)](./media/hana-overview-high-availability-disaster-recovery/image11-recover-options-b.png)

8. <span data-ttu-id="aff6a-420">Установите переключатель **Specify backup without catalog** (Указать резервную копию без каталога).</span><span class="sxs-lookup"><span data-stu-id="aff6a-420">Select **Specify backup without catalog**.</span></span>

 ![Окно Specify Backup Location (Указание расположения резервной копии)](./media/hana-overview-high-availability-disaster-recovery/image12-recover-options-c.png)

9. <span data-ttu-id="aff6a-422">В списке **Destination Type** (Тип назначения) выберите **Snapshot** (Моментальный снимок).</span><span class="sxs-lookup"><span data-stu-id="aff6a-422">In the **Destination Type** list, select **Snapshot**.</span></span>

 ![Окно Specify the Backup to Recover (Указание резервной копии для восстановления)](./media/hana-overview-high-availability-disaster-recovery/image13-recover-options-d.png)

10. <span data-ttu-id="aff6a-424">Нажмите кнопку **Finish** (Готово), чтобы запустить процесс восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-424">Click **Finish** to start the recovery process.</span></span>

 ![Нажатие кнопки Finish (Готово) для запуска процесса восстановления](./media/hana-overview-high-availability-disaster-recovery/image14-recover-options-e.png)

11. <span data-ttu-id="aff6a-426">Восстановление базы данных HANA выполняется в моментальный снимок HANA, добавленный моментальным снимком хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-426">The HANA database is restored and recovered to the HANA snapshot that's included in the storage snapshot.</span></span>

 ![Восстановление базы данных HANA в моментальный снимок HANA](./media/hana-overview-high-availability-disaster-recovery/image15-recover-options-f.png)

### <a name="recovering-to-the-most-recent-state"></a><span data-ttu-id="aff6a-428">Восстановление до последнего состояния</span><span class="sxs-lookup"><span data-stu-id="aff6a-428">Recovering to the most recent state</span></span>

<span data-ttu-id="aff6a-429">Здесь описывается восстановление моментального снимка HANA, содержащегося в моментальном снимке хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-429">The following process restores the HANA snapshot that is included in the storage snapshot.</span></span> <span data-ttu-id="aff6a-430">Затем выполняется восстановление резервных копий журнала транзакций до последнего состояния базы данных перед восстановлением моментального снимка хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-430">It then restores the transaction log backups to the most recent state of the database before restoring the storage snapshot.</span></span>

>[!IMPORTANT]
><span data-ttu-id="aff6a-431">Прежде чем продолжить, завершите создание цепочки последовательных резервных копий журнала транзакций.</span><span class="sxs-lookup"><span data-stu-id="aff6a-431">Before you proceed, make sure that you have a complete and contiguous chain of transaction log backups.</span></span> <span data-ttu-id="aff6a-432">Без этих резервных копий невозможно восстановить текущее состояние базы данных.</span><span class="sxs-lookup"><span data-stu-id="aff6a-432">Without these backups, you cannot restore the current state of the database.</span></span>

1. <span data-ttu-id="aff6a-433">Выполните действия 1–6, описанные в разделе "Восстановление до последнего моментального снимка HANA".</span><span class="sxs-lookup"><span data-stu-id="aff6a-433">Complete steps 1-6 of the preceding procedure in "Recovering to the most recent HANA snapshot."</span></span>

2. <span data-ttu-id="aff6a-434">Установите переключатель **Recover the database to its most recent state** (Восстановить базу данных до последнего состояния).</span><span class="sxs-lookup"><span data-stu-id="aff6a-434">Select **Recover the database to its most recent state**.</span></span>

 ![Установка переключателя Recover the database to its most recent state (Восстановить базу данных до последнего состояния).](./media/hana-overview-high-availability-disaster-recovery/image16-recover-database-a.png)

3. <span data-ttu-id="aff6a-436">Укажите расположение последних резервных копий журнала HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-436">Specify the location of the most recent HANA log backups.</span></span> <span data-ttu-id="aff6a-437">В этом расположении должны находиться все резервные копии журнала транзакций HANA от моментального снимка HANA до последнего состояния.</span><span class="sxs-lookup"><span data-stu-id="aff6a-437">The location needs to contain all HANA transaction log backups from the HANA snapshot to the most recent state.</span></span>

 ![Указание расположения последних резервных копий журнала HANA](./media/hana-overview-high-availability-disaster-recovery/image17-recover-database-b.png)

4. <span data-ttu-id="aff6a-439">Выберите резервную копию, из которой нужно выполнить восстановление базы данных.</span><span class="sxs-lookup"><span data-stu-id="aff6a-439">Select a backup as a base from which to recover the database.</span></span> <span data-ttu-id="aff6a-440">В нашем примере это моментальный снимок HANA, включенный в моментальный снимок хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-440">In our example, this is the HANA snapshot that was included in the storage snapshot.</span></span> <span data-ttu-id="aff6a-441">(На следующем снимке экрана показан только один моментальный снимок.)</span><span class="sxs-lookup"><span data-stu-id="aff6a-441">(Only one snapshot is listed in the following screenshot.)</span></span>

 ![Выбор резервной копии, из которой нужно выполнить восстановление базы данных](./media/hana-overview-high-availability-disaster-recovery/image18-recover-database-c.png)

5. <span data-ttu-id="aff6a-443">Снимите флажок **Use Delta Backups** (Использовать измененные резервные копии), если в промежуток между созданием моментального снимка HANA и последним состоянием в резервные копии не вносились изменения.</span><span class="sxs-lookup"><span data-stu-id="aff6a-443">Clear the **Use Delta Backups** check box if deltas do not exist between the time of the HANA snapshot and the most recent state.</span></span>

 ![Флажок Use Delta Backups (Использовать измененные резервные копии), который нужно снять, если изменения не вносились](./media/hana-overview-high-availability-disaster-recovery/image19-recover-database-d.png)

6. <span data-ttu-id="aff6a-445">В окне сводки нажмите кнопку **Finish** (Готово), чтобы запустить процедуру восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-445">On the summary screen, click **Finish** to start the restoration procedure.</span></span>

 ![Кнопка Finish (Готово) в окне сводки](./media/hana-overview-high-availability-disaster-recovery/image20-recover-database-e.png)

### <a name="recovering-to-another-point-in-time"></a><span data-ttu-id="aff6a-447">Восстановление до другой точки во времени</span><span class="sxs-lookup"><span data-stu-id="aff6a-447">Recovering to another point in time</span></span>
<span data-ttu-id="aff6a-448">Чтобы выполнить восстановление на момент между созданием моментального снимка HANA (включенного в моментальный снимок хранилища) и более позднего моментального снимка, выполните следующее:</span><span class="sxs-lookup"><span data-stu-id="aff6a-448">To recover to a point in time between the HANA snapshot (included in the storage snapshot) and one that is later than the HANA snapshot point-in-time recovery, do the following:</span></span>

1. <span data-ttu-id="aff6a-449">Соберите все резервные копии журнала транзакций от момента создания моментального снимка HANA до момента восстановления.</span><span class="sxs-lookup"><span data-stu-id="aff6a-449">Make sure that you have all transaction log backups from the HANA snapshot to the time you want to recover.</span></span>
2. <span data-ttu-id="aff6a-450">Выполните процедуру, описанную в разделе "Восстановление до последнего состояния".</span><span class="sxs-lookup"><span data-stu-id="aff6a-450">Begin the procedure under "Recovering to the most recent state."</span></span>
3. <span data-ttu-id="aff6a-451">На шаге 2 процедуры в окне **Specify Recovery Type** (Выбор типа восстановления) установите переключатель **Recover the database to the following point in time** (Восстановить базу данных до следующей точки во времени), укажите точку во времени, а затем завершите шаги 3–6.</span><span class="sxs-lookup"><span data-stu-id="aff6a-451">In step 2 of the procedure, in the **Specify Recovery Type** window, select **Recover the database to the following point in time**, specify the point in time, and then complete steps 3-6.</span></span>

## <a name="monitoring-the-execution-of-snapshots"></a><span data-ttu-id="aff6a-452">Мониторинг создания моментальных снимков</span><span class="sxs-lookup"><span data-stu-id="aff6a-452">Monitoring the execution of snapshots</span></span>

<span data-ttu-id="aff6a-453">Вам необходимо наблюдать за созданием моментальных снимков хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-453">You need to monitor the execution of storage snapshots.</span></span> <span data-ttu-id="aff6a-454">При выполнении скрипта создания моментального снимка хранилища выходные данные записываются в файл, а сам файл сохраняется в том же расположении, что и скрипты Perl.</span><span class="sxs-lookup"><span data-stu-id="aff6a-454">The script that executes a storage snapshot writes output to a file and then saves it to the same location as the Perl scripts.</span></span> <span data-ttu-id="aff6a-455">Для каждого моментального снимка создается отдельный файл.</span><span class="sxs-lookup"><span data-stu-id="aff6a-455">A separate file is written for each snapshot.</span></span> <span data-ttu-id="aff6a-456">На основе выходных данных в каждом файле можно четко понять различные этапы, которые выполняет скрипт создания моментальных снимков:</span><span class="sxs-lookup"><span data-stu-id="aff6a-456">The output of each file clearly shows the various phases that the snapshot script executes:</span></span>

- <span data-ttu-id="aff6a-457">поиск томов, для которых необходимо создать моментальные снимки;</span><span class="sxs-lookup"><span data-stu-id="aff6a-457">Finding the volumes that need to create a snapshot</span></span>
- <span data-ttu-id="aff6a-458">поиск моментальных снимков этих томов;</span><span class="sxs-lookup"><span data-stu-id="aff6a-458">Finding the snapshots taken from these volumes</span></span>
- <span data-ttu-id="aff6a-459">удаление имеющихся моментальных снимков в соответствии с указанным их количеством;</span><span class="sxs-lookup"><span data-stu-id="aff6a-459">Deleting eventual existing snapshots to match the number of snapshots you specified</span></span>
- <span data-ttu-id="aff6a-460">создание моментального снимка HANA;</span><span class="sxs-lookup"><span data-stu-id="aff6a-460">Creating a HANA snapshot</span></span>
- <span data-ttu-id="aff6a-461">создание моментального снимка хранилища для тома;</span><span class="sxs-lookup"><span data-stu-id="aff6a-461">Creating the storage snapshot over the volumes</span></span>
- <span data-ttu-id="aff6a-462">удаление моментального снимка HANA;</span><span class="sxs-lookup"><span data-stu-id="aff6a-462">Deleting the HANA snapshot</span></span>
- <span data-ttu-id="aff6a-463">изменение имени последнего моментального снимка на **.0**.</span><span class="sxs-lookup"><span data-stu-id="aff6a-463">Renaming the most recent snapshot to **.0**</span></span>

<span data-ttu-id="aff6a-464">Ниже приведена самая важная часть скрипта.</span><span class="sxs-lookup"><span data-stu-id="aff6a-464">The most important part of the script is this:</span></span>
```
**********************Creating HANA snapshot**********************
Creating the HANA snapshot with command: "./hdbsql -n localhost -i 01 -U SCADMIN01 "backup data create snapshot"" ...
HANA snapshot created successfully.
**********************Creating Storage snapshot**********************
Taking snapshot hourly.recent for hana_data_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_log_backup_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_log_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_shared_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for sapmnt_lhanad01_t020_vol ...
Snapshot created successfully.
**********************Deleting HANA snapshot**********************
Deleting the HANA snapshot with command: "./hdbsql -n localhost -i 01 -U SCADMIN01 "backup data drop snapshot"" ...
HANA snapshot deletion successfully.
```
<span data-ttu-id="aff6a-465">В этом примере видно, как скрипт записывает создание моментального снимка HANA.</span><span class="sxs-lookup"><span data-stu-id="aff6a-465">You can see from this sample how the script records the creation of the HANA snapshot.</span></span> <span data-ttu-id="aff6a-466">В случае горизонтального масштабирования этот процесс инициируется на главном узле.</span><span class="sxs-lookup"><span data-stu-id="aff6a-466">In the scale-out case, this process is initiated on the master node.</span></span> <span data-ttu-id="aff6a-467">Главный узел инициирует синхронное создание моментальных снимков всех рабочих узлов.</span><span class="sxs-lookup"><span data-stu-id="aff6a-467">The master node initiates the synchronous creation of the snapshots on each of the worker nodes.</span></span> <span data-ttu-id="aff6a-468">Затем создается моментальный снимок хранилища.</span><span class="sxs-lookup"><span data-stu-id="aff6a-468">Then the storage snapshot is taken.</span></span> <span data-ttu-id="aff6a-469">После создания этого снимка моментальный снимок HANA удаляется.</span><span class="sxs-lookup"><span data-stu-id="aff6a-469">After the successful execution of the storage snapshots, the HANA snapshot is deleted.</span></span>

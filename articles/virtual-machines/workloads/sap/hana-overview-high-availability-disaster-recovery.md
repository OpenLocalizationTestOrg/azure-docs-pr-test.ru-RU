---
title: "Обеспечение высокого уровня доступности и аварийное восстановление решения \"SAP HANA в Azure (крупные экземпляры)\" | Документация Майкрософт"
description: "Сведения об обеспечении высокого уровня доступности и о планировании аварийного восстановления решения \"SAP HANA в Azure (крупные экземпляры)\"."
services: virtual-machines-linux
documentationcenter: 
author: RicksterCDN
manager: timlt
editor: 
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 12/01/2016
ms.author: rclaus
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: f95e944fc3ec3a831d97386443eb644420ae54dc
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="sap-hana-large-instances-high-availability-and-disaster-recovery-on-azure"></a>Высокий уровень доступности и аварийное восстановление SAP HANA в Azure (крупные экземпляры) 

Для работы критически важных серверов SAP HANA в Azure (крупные экземпляры) важно обеспечить высокий уровень доступности и реализовать стратегию аварийного восстановления. Кроме того, важно сотрудничать с SAP, вашим системным интегратором и (или) корпорацией Майкрософт, чтобы правильно создать архитектуру и реализовать подходящую стратегию обеспечения высокой доступности и аварийного восстановления. Также важно учитывать целевую точку восстановления и целевое время восстановления, характерные для вашей среды.

## <a name="high-availability"></a>высокую доступность;

По умолчанию корпорация Майкрософт поддерживает методы обеспечения высокого уровня доступности SAP HANA, в том числе следующие:

- **Репликация хранилища** — возможность системы хранения самостоятельно реплицировать все данные в другое расположение (в том же центре обработки данных или за его пределами). SAP HANA работает независимо от этого метода.
- **Репликация системы HANA** — репликация всех данных SAP HANA в отдельную систему SAP HANA. Целевое время восстановления уменьшается благодаря репликации данных с регулярными интервалами. SAP HANA поддерживает асинхронные, выполняющиеся в памяти синхронные и синхронные режимы (мы советуем использовать их только для систем SAP HANA, расположенных в том же центре обработки данных или на расстоянии менее 100 км от него). В текущей архитектуре стеков крупных экземпляров HANA репликацию системы HANA можно использовать только для обеспечения высокой доступности.
- **Автоматическая отработка отказа узла** — решение для локального восстановления после сбоя, используемое в качестве альтернативы репликации системы. Один или несколько резервных узлов SAP HANA настроены в режиме горизонтального масштабирования, и SAP HANA автоматически выполняет отработку отказа на другой узел, когда главный узел становится недоступным.

Дополнительные сведения о высоком уровне доступности SAP HANA см. в следующих источниках:

- [Техническая документация по высокому уровню доступности SAP HANA](http://go.sap.com/documents/2016/05/f8e5eeba-737c-0010-82c7-eda71af511fa.html)
- [Руководство по администрированию SAP HANA](http://help.sap.com/hana/SAP_HANA_Administration_Guide_en.pdf)
- [Видеокурс SAP по репликации системы SAP HANA](http://scn.sap.com/community/hana-in-memory/blog/2015/05/19/sap-hana-system-replication)
- [Примечание по SAP № 1999880. Часто задаваемые вопросы о репликации системы SAP HANA](https://bcs.wdf.sap.corp/sap/support/notes/1999880)
- [Примечание по SAP № 2165547. Резервное копирование и восстановление SAP HANA в среде репликации системы SAP HANA](https://websmp230.sap-ag.de/sap(bD1lbiZjPTAwMQ==)/bc/bsp/sno/ui_entry/entry.htm?param=69765F6D6F64653D3030312669765F7361706E6F7465735F6E756D6265723D3231363535343726)
- [Примечание по SAP № 1984882. Использование репликации системы SAP HANA для замены оборудования без простоя](https://websmp230.sap-ag.de/sap(bD1lbiZjPTAwMQ==)/bc/bsp/sno/ui_entry/entry.htm?param=69765F6D6F64653D3030312669765F7361706E6F7465735F6E756D6265723D3139383438383226)

## <a name="disaster-recovery"></a>Аварийное восстановление

Решение "SAP HANA в Azure (крупные экземпляры)" доступно в двух регионах Azure геополитического региона. Между двумя стеками крупных экземпляров, расположенными в разных регионах, устанавливается прямое сетевое подключение, используемое для репликации во время аварийного восстановления. Репликация данных зависит от инфраструктуры хранилища. По умолчанию репликация не выполняется. Она выполняется для клиентских конфигураций, предусматривающих аварийное восстановление. В текущей архитектуре решения репликацию системы HANA нельзя использовать для аварийного восстановления.

Тем не менее, чтобы воспользоваться преимуществами аварийного восстановления, вам потребуется установить сетевое подключение к двум разным регионам Azure. Для этого вам нужно создать канал Azure ExpressRoute с подключением между локальной средой и основным регионом Azure и еще один канал с подключением между локальной средой и регионом аварийного восстановления. Это позволит обеспечить работоспособность в случае возникновения проблем со всем регионом Azure, в том числе с расположением конечного маршрутизатора Microsoft Enterprise (MSEE).

Вы также можете подключить все виртуальные сети Azure, подключенные к SAP HANA в Azure (крупные экземпляры) в одном из регионов, к этим двум каналам ExpressRoute. Это позволит устранить проблемы при выходе из обслуживания одного из расположений MSEE, используемых для установки подключения между локальным расположением и Azure.

На рисунке ниже показана оптимальная конфигурация для аварийного восстановления.

![Оптимальная конфигурация для аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/image1-optimal-configuration.png)

Чтобы создать оптимальную конфигурацию аварийного восстановления сети, вам потребуется два канала ExpressRoute, соединяющих локальную среду и два разных региона Azure. Первый канал подключается к региону 1, в котором выполняется рабочий экземпляр. Второй канал ExpressRoute подключается к региону 2, где выполняются несколько нерабочих экземпляров HANA. (Это важно, если весь регион Azure, в том числе MSEE и стек крупных экземпляров, выходит из обслуживания.)

Кроме того, различные виртуальные сети подключаются к различным каналам ExpressRoute, подключенным к SAP HANA в Azure (крупные экземпляры). Вы можете обойти расположение, в котором возникли проблемы с MSEE, или снизить значение целевой точки восстановления для аварийного восстановления. Мы поговорим об этом позже.

Для настройки аварийного восстановления вам также потребуется сделать следующее:

- Закажите номера SKU для SAP HANA в Azure (крупные экземпляры) того же размера, что и рабочие номера SKU, и разверните их в регионе аварийного восстановления. Эти экземпляры можно использовать для запуска экземпляров тестирования, песочницы или контроля качества HANA.
- Кроме того, при необходимости закажите профиль аварийного восстановления для каждого номера SKU решения "SAP HANA в Azure (крупные экземпляры)", который вы хотите восстановить на сайте аварийного восстановления. Это обеспечивает выделение томов хранения данных, используемых при репликации хранилища из рабочего региона в регион аварийного восстановления.

Как только вы выполните приведенные выше требования, можно приступать к запуску репликации хранилища. В инфраструктуре хранилища, используемой для SAP HANA в Azure (крупные экземпляры), репликация хранилища выполняется на основе моментальных снимков. Чтобы начать репликацию и аварийное восстановление, вам потребуются:

- моментальный снимок загрузочного логического номера устройства (LUN), как описано выше;
- моментальный снимок томов, связанных с HANA, как описано выше.

После получения моментальных снимков исходная реплика этих томов заполняется на томах, связанных с профилем аварийного восстановления в соответствующем регионе.

Следовательно, последний моментальный снимок хранилища используется каждый час для репликации изменений, произошедших на томах хранения.

При такой конфигурации целевая точка восстановления (RPO) составляет от 60 до 90 минут. Чтобы улучшить показатель RPO в случае аварийного восстановления, скопируйте резервные копии журнала транзакций HANA из SAP HANA в Azure (крупные экземпляры) и переместите их в другой регион Azure. Чтобы достичь такой целевой точки восстановления, сделайте следующее:

1. Выполняйте резервное копирование журнала транзакций HANA на том /hana/log/backup с максимально возможной частотой.
2. Скопируйте созданные резервные копии журнала транзакций на виртуальную машину Azure, расположенную в виртуальной сети, подключенной к серверу SAP HANA в Azure (крупные экземпляры).
3. Из этой виртуальной машины скопируйте резервные копии на виртуальную машину, которая находится в виртуальной сети в регионе аварийного восстановления.
4. Храните резервные копии журнала транзакций на виртуальной машине в этом регионе.

В случае сбоя после развертывания профиля аварийного восстановления на фактическом сервере скопируйте резервные копии журнала транзакций из виртуальной машины на сервер SAP HANA в Azure (крупные экземпляры), который теперь основной в регионе аварийного восстановления, и восстановите их. Восстановление возможно благодаря тому, что состояние HANA на дисках аварийного восстановления и на моментальном снимке HANA совпадает, что используется в качестве точки смещения для дальнейших восстановлений резервных копий журнала транзакций.

## <a name="backup-and-restore"></a>Архивация и восстановление

При работе с базами данных очень важно защитить их от различных событий, которые приводят к сбоям. Эти события могут возникать как в результате стихийных бедствий, так и через простые ошибки пользователей.

Резервное копирование с возможностью восстановления до любой точки во времени (например, перед удалением важных данных) обеспечивает восстановление базы данных до состояния, максимально приближенного к состоянию перед сбоем.

Для получения оптимальных результатов выполните следующие два типа резервного копирования:

- Резервные копии базы данных
- резервное копирование журналов транзакций.

Помимо полного резервного копирования базы данных на уровне приложений, вы также можете выполнить резервное копирование на основе моментальных снимков хранилища. Чтобы восстановить базу данных, также важно выполнять резервное копирование журналов (и очищать журналы от уже выполненных транзакций).

SAP HANA в Azure (крупные экземпляры) поддерживает следующие два варианта резервного копирования и восстановления.

- Модель "Сделай сам". После вычисления для обеспечения достаточного объема пространства на дисках выполните полное резервное копирование базы данных и журналов (на эти диски), используя методы резервного копирования дисков. Со временем эти резервные копии будут скопированы в учетную запись хранения Azure (после настройки файлового сервера на основе Azure с практически неограниченным хранилищем). Кроме того, их можно скопировать в хранилище службы архивации Azure или в автономное неструктурированное защищенное хранилище Azure. Для хранения резервных данных после их копирования в учетную запись хранения можно также использовать стороннее средство защиты данных, например Commvault. Из-за соответствия нормативным требованиям и возможностей аудита мы советуем использовать этот метод резервного копирования для длительного хранения данных.
- Используйте функции резервного копирования и восстановления, предоставленные базовой инфраструктурой SAP HANA в Azure (крупные экземпляры). Этот вариант полностью удовлетворяет потребности в резервном копировании и делает ручное резервное копирование практически неактуальным (кроме тех случаев, когда резервные копии данных нужны для соответствия нормативным требованиям). В остальной части этого раздела описываются функции резервного копирования и восстановления, предоставляемые крупными экземплярами HANA.

> [!NOTE]
> Технология моментальных снимков, используемая в базовой инфраструктуре HANA (крупные экземпляры), зависима от моментальных снимков SAP HANA. Моментальные снимки SAP HANA не работают в сочетании с мультитенантными контейнерами баз данных SAP HANA. Таким образом, этот метод резервного копирования не может использоваться для развертывания мультитенантных контейнеров баз данных SAP HANA.

### <a name="using-storage-snapshots-of-sap-hana-on-azure-large-instances"></a>Использование моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры)

Базовая инфраструктура хранилища SAP HANA в Azure (крупные экземпляры) поддерживает концепцию моментальных снимков хранилища для томов. Вы можете выполнять резервное копирование и восстановление определенного тома, но следует учитывать следующее:

- Вместо резервных копий базы данных на регулярной основе создаются моментальные снимки тома хранилища.
- Перед созданием моментального снимка хранилища он инициирует моментальный снимок SAP HANA. Этот моментальный снимок SAP HANA является точкой настройки для восстановления журнала после восстановления моментального снимка хранилища.
- Если моментальный снимок хранилища создан успешно, моментальный снимок SAP HANA удаляется.
- Резервные копии журналов создаются часто и хранятся на томе резервных копий журналов или в Azure.
- Если базу данных необходимо восстановить до определенной точки во времени, отправьте в службу поддержки Microsoft Azure (рабочий сбой) или отдел по управлению службами SAP HANA в Azure запрос на восстановление до определенного моментального снимка хранилища (например, плановое восстановление системы типа "песочница" до исходного состояния).
- Моментальный снимок SAP HANA, добавленный в моментальный снимок хранилища, используется в качестве точки смещения для применения резервных копий журнала, полученных и сохраненных после создания моментального снимка хранилища.
- Эти резервные копии журналов используются для восстановления базы данных до определенной точки во времени.

Задав имя резервной копии, вы создадите моментальный снимок следующих томов:

- hana/data;
- hana/log;
- hana/log\_backup (подключен как резервная копия в hana/log);
- hana/shared.

### <a name="storage-snapshot-considerations"></a>Факторы, которые необходимо учитывать при создании моментальных снимков хранилища

>[!NOTE]
>Моментальные снимки хранилища _не_ предоставляются бесплатно, так как для их хранения требуется дополнительное дисковое пространство.

Принцип действия моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры) включает в себя следующие аспекты:

- Определенный моментальный снимок хранилища (созданный на определенный момент времени) занимает очень мало пространства в хранилище.
- На моментальном снимке должен храниться исходный набор данных, так как данные и содержимое файлов данных в SAP HANA изменяются на томе хранилища.
- Размер моментального снимка хранилища увеличивается в зависимости от срока его хранения.
- Чем больше изменений внесено на томе базы данных SAP HANA в течение жизненного цикла моментального снимка хранилища, тем больше места он занимает.

SAP HANA в Azure (крупные экземпляры) поставляется с фиксированными размерами томов для данных и журнального тома SAP HANA. При создании моментальных снимков этих томов используется место на томе. Вы должны самостоятельно спланировать создание моментальных снимков хранилища (в рамках процесса SAP HANA в Azure (крупные экземпляры)).

В следующих разделах содержатся сведения о создании этих моментальных снимков, а также общие рекомендации.

- Хотя оборудование поддерживает 255 моментальных снимков на том, мы настоятельно советуем хранить намного меньшее их количество.
- Прежде чем выполнять моментальные снимки хранилища, отслеживайте свободное пространство.
- В зависимости от свободного пространства количество моментальных снимков хранилища можно уменьшить. Может потребоваться уменьшить количество хранящихся моментальных снимков или расширить тома. (Вы можете заказать дополнительное пространство в единицах по 1 ТБ.)
- При выполнении действий, например при переносе данных в SAP HANA с помощью средств переноса системы (в частности, с помощью R3load) или при восстановлении баз данных SAP HANA на основе резервных копий, мы настоятельно советуем не создавать моментальные снимки хранилища. Если перенос системы выполняется в новой системе SAP HANA, моментальные снимки создавать не нужно.
- При более значительных реорганизациях таблиц SAP HANA по возможности не создавайте моментальные снимки хранилища.
- Моментальные снимки хранилища необходимы для поддержки возможностей аварийного восстановления SAP HANA в Azure (крупные экземпляры).

### <a name="setting-up-storage-snapshots"></a>Настройка моментальных снимков хранилища

1. Установите Perl в операционной системе Linux на сервере решения "Крупные экземпляры HANA".
2. Добавьте в файл /etc/ssh/ssh\_config строку _MACs hmac-sha1_.
3. На главном узле создайте учетную запись резервного копирования SAP HANA для каждого запущенного экземпляра SAP HANA (если применимо).
4. Установите на всех серверах решения "Крупные экземпляры SAP HANA" клиент SAP HANA HDB.
5. На первом сервере решения "Крупные экземпляры SAP HANA" каждого региона создайте открытый ключ, используемый для доступа к базовой инфраструктуре хранилища, отвечающей за создание моментальных снимков.
6. Скопируйте скрипт azure\_hana\_backup.pl из /scripts в расположение **hdbsql**, где установлена система SAP HANA.
7. Скопируйте файл HANABackupDetails.txt из /scripts в то же расположение, что и скрипт Perl.
8. Измените файл HANABackupDetails.txt в соответствии с определенной спецификацией клиента.

### <a name="step-1-install-sap-hana-hdbclient"></a>Этап 1. Установка клиента SAP HANA HDB

Операционная система Linux, установленная в решении "SAP HANA в Azure (крупные экземпляры)", содержит папки и скрипты, необходимые для создания моментальных снимков хранилища SAP HANA, используемых для резервного копирования и восстановления. Однако во время установки SAP HANA вы должны самостоятельно установить клиент SAP HANA HDB. (Корпорация Майкрософт не устанавливает ни клиент HDB, ни SAP HANA.)

### <a name="step-2-change-etcsshsshconfig"></a>Этап 2. Изменение файла /etc/ssh/ssh\_config

Добавьте в файл /etc/ssh/ssh\_config строку _MACs hmac-sha1_, как показано ниже.
```
#   RhostsRSAAuthentication no
#   RSAAuthentication yes
#   PasswordAuthentication yes
#   HostbasedAuthentication no
#   GSSAPIAuthentication no
#   GSSAPIDelegateCredentials no
#   GSSAPIKeyExchange no
#   GSSAPITrustDNS no
#   BatchMode no
#   CheckHostIP yes
#   AddressFamily any
#   ConnectTimeout 0
#   StrictHostKeyChecking ask
#   IdentityFile ~/.ssh/identity
#   IdentityFile ~/.ssh/id_rsa
#   IdentityFile ~/.ssh/id_dsa
#   Port 22
Protocol 2
#   Cipher 3des
#   Ciphers aes128-ctr,aes192-ctr,aes256-ctr,arcfour256,arcfour128,aes128-cbc,3des-cbc
#   MACs hmac-md5,hmac-sha1,umac-64@openssh.com,hmac-ripemd160
MACs hmac-sha1
#   EscapeChar ~
#   Tunnel no
#   TunnelDevice any:any
#   PermitLocalCommand no
#   VisualHostKey no
#   ProxyCommand ssh -q -W %h:%p gateway.example.com
```

### <a name="step-3-create-a-public-key"></a>Этап 3. Создание открытого ключа

Для создания моментальных снимков на первом сервере решения "SAP HANA в Azure (крупные экземпляры)" каждого региона Azure создайте открытый ключ, используемый для доступа к инфраструктуре хранилища. Этот ключ позволит входить в хранилище без пароля, что устраняет необходимость в настройке последнего. Чтобы создать открытый ключ, в операционной системе Linux на сервере решения "Крупные экземпляры SAP HANA" выполните следующую команду:
```
  ssh-keygen –t dsa –b 1024
```
Новое расположение — _/root/.ssh/id\_dsa.pub. Не вводите фактическую парольную фразу, иначе вам нужно будет вводить ее при каждом входе. Вместо этого нажмите клавишу **ВВОД** дважды, чтобы закрыть этот запрос.

Убедитесь, что открытый ключ был исправлен надлежащим образом. Для этого измените папки на /root/.ssh/ и выполните команду **ls**. Если ключ присутствует, его можно скопировать, выполнив следующую команду:

![Команда для копирования открытого ключа](./media/hana-overview-high-availability-disaster-recovery/image2-public-key.png)

На этом этапе обратитесь в отдел по управлению службами SAP HANA в Azure и предоставьте этот ключ. Уполномоченный представитель зарегистрирует его в базовой инфраструктуре хранилища.

### <a name="step-4-create-an-sap-hana-user-account"></a>Этап 4. Создание учетной записи пользователя SAP HANA

Создайте в SAP HANA Studio учетную запись пользователя SAP HANA. Она будет использоваться для резервного копирования. Предоставьте ей привилегии _администратора резервного копирования_ и _права на чтение каталогов_. В этом примере мы создали имя пользователя SCADMIN.

![Создание пользователя в HANA Studio](./media/hana-overview-high-availability-disaster-recovery/image3-creating-user.png)

### <a name="step-5-authorize-the-sap-hana-user-account"></a>Этап 5. Авторизация учетной записи пользователя SAP HANA

Авторизируйте учетную запись SAP HANA (это позволит каждый раз использовать ее при запуске скрипта, в котором не требуется выполнять авторизацию). Команда SAP HANA `hdbuserstore` позволяет создать ключ пользователя SAP HANA, который хранится на одном или нескольких узлах SAP HANA, и предоставляет пользователю доступ к SAP HANA (при этом в процессе написания скрипта, описанном ниже, не нужно заботиться об управлении паролями).

>[!IMPORTANT]
>Выполните следующую команду от имени `_root_`: В противном случае скрипт не будет работать должным образом.

Введите команду `hdbuserstore`, как показано ниже.

![Ввод команды hdbuserstore](./media/hana-overview-high-availability-disaster-recovery/image4-hdbuserstore-command.png)

В следующем примере используется пользователь SCADMIN01, а имя узла — lhanad01. В этом случае команда выглядит следующим образом:
```
hdbuserstore set SCADMIN01 lhanad01:30115 <backup username> <password>
```
Управляйте всеми процессами написания скрипта для масштабируемых экземпляров HANA с одного сервера. В этом примере ключ SAP HANA пользователя SCADMIN01 необходимо изменить для каждого узла. Этот ключ должен отражать узел, связанный с ним. Это означает, что в учетной записи резервного копирования SAP HANA нужно изменить номер экземпляра узла **lhanad** для базы данных HANA. Предоставьте ключу права администратора на узле, которому он назначен, а пользователю резервного копирования, используемому для масштабирования, — права на доступ ко всем экземплярам SAP HANA.
```
hdbuserstore set SCADMIN01 lhanad:30015 SCADMIN <password>
hdbuserstore set SCADMIN02 lhanad:30115 SCADMIN <password>
hdbuserstore set SCADMIN03 lhanad:30215 SCADMIN <password>
```

### <a name="step-6-copy-items-from-the-scripts-folder"></a>Этап 6. Копирование элементов из папки /scripts

Из папки /scripts (включенной в эталонный образ установки) скопируйте в рабочий каталог **hdbsql** следующие элементы. Для текущих установок HANA это каталог /hana/shared/D01/exe/linuxx86\_64/hdb.
```
azure\_hana\_backup.pl
testHANAConnection.pl
testStorageSnapshotConnection.pl
removeTestStorageSnapshot.pl
HANABackupCustomerDetails.txt
```
Скопируйте следующие элементы, если они выполняются в масштабируемой среде или в среде OLAP:
```
azure\_hana\_backup\_bw.pl
testHANAConnectionBW.pl
testStorageSnapshotConnectionBW.pl
removeTestStorageSnapshotBW.pl
HANABackupCustomerDetailsBW.txt
```
Файл HANABackupCustomerDetails.txt можно изменить для масштабного развертывания. Это файл параметров и конфигурации скрипта, выполняющего моментальные снимки хранилища. После развертывания экземпляров отдел по управлению службами SAP HANA в Azure должен был предоставить _имя резервного копирования_ и _IP-адрес хранилища_. Порядок, упорядочение переменных или интервал между ними изменять нельзя, иначе скрипт не будет запускаться должным образом.

Файл конфигурации, используемый для масштабного развертывания, выглядит следующим образом:
```
#Provided by Microsoft Service Management
Storage Backup Name: lhanad01backup
Storage IP Address: 10.250.20.21
#Created by customer using hdbuserstore
HANA Backup Name: SCADMIND01
```
Файл HANABackupCustomerDetailsBW.txt, используемый для масштабного развертывания, выглядит следующим образом:
```
#Provided by Microsoft Service Management
Storage Backup Name: lhanad01backup
Storage IP Address: 10.250.20.21
#Node IP addresses, instance numbers, and HANA backup name
#provided by customer.  HANA backup name created using
#hdbuserstore utility.
Node 1 IP Address: 10.254.15.21
Node 1 HANA instance number: 01
Node 1 HANA Backup Name: SCADMIN01
Node 2 IP Address: 10.254.15.22
Node 2 HANA instance number: 02
Node 2 HANA Backup Name: SCADMIN02
Node 3 IP Address: 10.254.15.23
Node 3 HANA instance number: 03
Node 3 HANA Backup Name: SCADMIN03
Node 4 IP Address: 10.254.15.24
Node 4 HANA instance number: 04
Node 4 HANA Backup Name: SCADMIN04
Node 5 IP Address: 10.254.15.25
Node 5 HANA instance number: 05
Node 5 HANA Backup Name: SCADMIN05
Node 6 IP Address: 10.254.15.26
Node 6 HANA instance number: 06
Node 6 HANA Backup Name: SCADMIN06
Node 7 IP Address: 10.254.15.27
Node 7 HANA instance number: 07
Node 7 HANA Backup Name: SCADMIN07
Node 8 IP Address: 10.254.15.28
Node 8 HANA instance number: 08
Node 8 HANA Backup Name: SCADMIN08
```
>[!NOTE]
>В настоящее время в фактическом скрипте создания моментальных снимков хранилища HANA используются только сведения об узле 1. Мы советуем проверить доступ ко всем узлам HANA и из них. Так вы сможете убедиться, что в случае возможного изменения главного узла резервного копирования любой другой узел сможет занять его место за счет изменения сведений в узле 1.

Чтобы удостовериться в правильности конфигураций в файле конфигурации и подключения к экземплярам HANA, выполните один из следующих скриптов.
- Для конфигурации вертикального масштабирования (независимо от рабочей нагрузки SAP):

 ```
testHANAConnection.pl
```
- Для конфигурации горизонтального масштабирования:

 ```
testHANAConnectionBW.pl
```

Главный экземпляр HANA должен иметь доступ ко всем необходимым серверам. В этом скрипте отсутствуют параметры, но для надлежащего его выполнения необходимо создать соответствующий файл HANABackupCustomerDetails и HANABackupCustomerDetailsBW. Этот скрипт не поддерживает поиск ошибок в каждом отдельном экземпляре, так как возвращаются только коды ошибок в команде оболочки. Однако он предоставляет некоторые полезные сведения, которые нужно тщательно проверить.

Выполните следующее, чтобы запустить этот сценарий.
```
 ./testHANAConnection.pl
```
 Если в результате выполнения скрипта возвращается состояние экземпляра HANA, отобразится сообщение об успешном подключении к HANA.

Кроме того, возможность подключения сервера главного экземпляра HANA к хранилищу можно также проверить с помощью скрипта другого типа. Перед выполнением скрипта azure\_hana\_backup(\_bw).pl необходимо выполнить следующий скрипт. Если на томе отсутствуют моментальные снимки, вы не сможете определить разницу между таким томом и SSH-ошибкой при получении сведений о моментальных снимках. По этой причине выполнение скрипта состоит из двух этапов:

- проверка доступности консоли хранилища;
- создание тестового (фиктивного) моментального снимка для каждого тома экземпляра HANA.

Из-за этого экземпляр HANA добавляется в качестве аргумента. Опять же, вы не можете настроить поиск ошибок для подключения хранилища. Однако в случае сбоя выполнения скрипт предоставляет некоторые полезные сведения.

Скрипт выполняется как:
```
 ./testStorageSnapshotConnection.pl <hana instance>
```
Или как:
```
./testStorageSnapshotConnectionBW.pl <hana instance>
```
Кроме того, этот скрипт выводит сообщение о возможности входа в развернутый клиент хранилища, в основе которого лежат логические номера устройства, используемые вашими экземплярами сервера.

Перед созданием первых резервных копий на основе моментальных снимков хранилища проверьте правильность конфигурации, выполнив приведенные ниже скрипты.

Затем вы можете удалить эти моментальные снимки с помощью следующей команды:
```
./removeTestStorageSnapshot.pl <hana instance>
```
или
```
./removeTestStorageSnapshot.pl <hana instance>
```

### <a name="step-7-perform-on-demand-snapshots"></a>Этап 7. Создание моментальных снимков по запросу

Создайте моментальные снимки по запросу (или же запланируйте регулярное создание этих снимков с помощью Cron), выполнив один из следующих скриптов.

Для конфигурации вертикального масштабирования:
```
./azure_hana_backup.pl lhanad01 customer 20
```
Для конфигурации горизонтального масштабирования:
```
./azure_hana_backup_bw.pl lhanad01 customer 20
```
Скрипт горизонтального масштабирования выполняет дополнительные проверки доступа ко всем серверам HANA. Перед выполнением дальнейших действий по созданию моментальных снимков SAP HANA или хранилища все экземпляры HANA должны вернуть соответствующее состояние.

Вам потребуются следующие аргументы:

- соответствующая резервная копия экземпляра HANA;
- префикс для моментального снимка хранилища;
- несколько моментальных снимков с определенным префиксом.

```
./azure_hana_backup.pl lhanad01 customer 20
```

Создание моментальных снимков с помощью этого скрипта состоит из следующих трех этапов:

- создание моментального снимка HANA;
- создание моментального снимка хранилища;
- удаление моментального снимка HANA.

Выполните скрипт, вызвав его из выполняемой папки HDB, в которую он был скопирован. Это позволит создать резервные копии по крайней мере указанных ниже томов, а также томов с явным именем экземпляра SAP HANA.
```
hana_data_<hana instance>_prod_t020_vol
hana_log_<hana instance>_prod_t020_vol
hana_log_backup_<hana instance>_prod_t020_vol
hana_shared_<hana instance>_prod_t020_vol
```
Срок хранения совпадает с количеством моментальных снимков. Это значение задается как параметр во время выполнения скрипта (например, 20 в примере выше). Поэтому количество времени зависит от времени выполнения скрипта и заданного в нем количества моментальных снимков. Если число моментальных снимков превышает значение, заданное при выполнении скрипта, перед созданием следующего моментального снимка хранилища удаляется самый старый моментальный снимок этой временной метки (_custom_ в описанном выше случае). Это означает, что допустимое количество моментальных снимков можно задать в последнем параметре скрипта.

>[!NOTE]
>После изменения метки отсчет начинается сначала.

При создании моментальных снимков среды с несколькими узлами добавьте имя экземпляра HANA, предоставленное отделом по управлению службами SAP HANA в Azure, в качестве аргумента. В средах с одним узлом можно использовать имя решения "SAP HANA в Azure (крупные экземпляры)". Однако мы советуем использовать имя экземпляра HANA.

Кроме того, можно выполнить резервное копирование томов загрузки или логических томов, используя тот же скрипт. Резервную копию загрузочного тома необходимо создать по крайней мере при первом запуске HANA. Однако мы советуем запланировать резервное копирование, выполняемое каждую неделю или каждую ночь, с помощью Cron. В этом случае не нужно добавлять имя экземпляра SAP HANA. Просто вставьте в следующий скрипт аргумент _boot_, как показано ниже.
```
./azure_hana_backup boot customer 20
```
К загрузочному тому применяется та же политика хранения. Создавать моментальные снимки по запросу нужно только в определенных случаях (например, во время обновления SAP EHP или если нужно создать моментальный снимок отдельного хранилища).

Мы настоятельно советуем настроить плановое создание моментальных снимков хранилища с помощью средства Cron. Кроме того, мы советуем использовать один скрипт для создания всех резервных копий и аварийного восстановления (в этом случае нужно изменять входные данные скрипта в соответствии со временем резервного копирования). Это средство позволяет настроить резервное копирование на регулярной основе, например каждый час, каждые 12 часов, каждый день или каждую неделю. Средство Cron позволяет создавать моментальные снимки хранилища в соответствии с рассмотренным выше периодом удержания меток для длительного удаленного резервного копирования. Этот скрипт содержит команды резервного копирования всех рабочих томов с запрошенной частотой (резервные копии данных и файлов журналов создаются каждый час, а загрузочного тома — каждый день).

Следующий скрипт Cron выполняется каждый час, каждые 12 часов и каждый день на десятой минуте. Задания Cron созданы таким образом, что в течение заданного часа выполняется только один моментальный снимок хранилища. Поэтому ежедневное и ежечасное резервное копирование выполняется в разное время (00:10). Чтобы оптимизировать создание и репликацию моментальных снимков, отдел по управлению службами SAP HANA в Azure предоставляет сведения о рекомендуемом времени выполнения резервного копирования.

При стандартных настройках содержимое файла расписания /etc/crontab имеет следующий вид:
```
10 1-11,13-23 * * * ./azure_hana_backup.pl lhanad01 hourly 66
10 12 * * *  ./azure_hana_backup.pl lhanad01 12hour 14
```
В инструкции Cron выше моментальные снимки томов HANA (без загрузочного тома) создаются каждый час, и 66 из них сохраняются. Кроме того, сохраняются также 14 моментальных снимков, создаваемых каждые 12 часов. Таким образом, вы можете хранить моментальные снимки, создаваемые каждый час, в течение трех дней и моментальные снимки, создаваемые каждые 12 часов, в течение четырех дней. Следовательно, моментальные снимки позволяют охватить целую неделю.

Планирование графика в Cron может оказаться непростой задачей. Это связано с тем, что в конкретный момент времени можно выполнить только один скрипт, за исключением тех случаев, когда скрипт выполняется периодически в течение нескольких минут. Если вы хотите создавать ежедневные резервные копии и хранить их на протяжение длительного времени, настройте как ежедневное создание моментальных снимков, так и их создание с двенадцатичасовым интервалом (для периода удержания задайте значение 7). Кроме того, вместо двенадцатичасового можно настроить ежечасное создание моментальных снимков, выполняемое на 10 минут позднее. Но в этом случае на рабочем томе будет храниться только один ежедневный моментальный снимок.
```
10 1-11,13-23 * * * ./azure_hana_backup.pl lhanad01 hourly 66
10 12 * * *  ./azure_hana_backup.pl lhanad01 12hour 7
10 0 * * * ./azure_hana_backup.pl lhanad01 daily 7
```
Указанные здесь значения частоты приведены исключительно для примера. Чтобы определить оптимальное количество моментальных снимков, полагайтесь на следующие критерии:

- Требования к RTO для восстановления на определенный момент времени.
- Использование пространства.
- Требования к RTO и RTO в случае возможного аварийного восстановления.
- Последующее выполнение полного резервного копирования базы данных HANA на диски. При выполнении полного резервного копирования базы данных на диски (или в интерфейс _backint_) создание моментальных снимков хранилища завершается сбоем. Если вы хотите выполнить полное резервное копирование базы данных на основе моментальных снимков хранилища, отключите на это время создание этих моментальных снимков.

>[!IMPORTANT]
> Резервное копирование SAP HANA на основе моментальных снимков хранилища выполняется, только если моментальные снимки создаются совместно с резервным копированием журналов SAP HANA. Эти резервные копии журналов должны охватывать временные периоды между моментальными снимками хранилища. Если необходимо выполнить восстановление на определенный момент времени в пределах 30 дней, вам потребуются:

- доступ к моментальным снимкам хранилища тридцатидневной давности;
- связанные резервные копии журналов за последние 30 дней.

Вам также потребуется создать моментальный снимок резервной копии журнального тома. Кроме того, обязательно настройте регулярное резервное копирование журнала, чтобы:

- иметь связанные резервные копии журналов, необходимые для выполнения восстановлений до точки во времени;
- предотвратить нехватку места на журнальном томе SAP HANA.

Один из последних этапов заключается в настройке расписания для создания резервных копий журнала SAP HANA в SAP HANA Studio. Резервные копии журнала SAP HANA сохраняются на специальном томе hana/log\_backups с точкой подключения /hana/log/backups.

![Настройка расписания для создания резервных копий журнала SAP HANA в SAP HANA Studio.](./media/hana-overview-high-availability-disaster-recovery/image5-schedule-backup.png)

Можно выполнять резервные копии намного чаще, чем каждые 15 минут. Некоторые пользователи выполняют резервное копирование журналов каждую минуту. Однако мы не советуем создавать резервные копии _реже_, чем раз в 15 минут.

Последний этап заключается в создании файловой резервной копии (после начальной установки SAP HANA). Это позволит создать единую резервную копию записи, которая должна находиться в каталоге резервных копий. В противном случае SAP HANA не может инициировать резервное копирование журнала.

![Создание файловой резервной копии для формирования единой записи о резервной копии](./media/hana-overview-high-availability-disaster-recovery/image6-make-backup.png)

### <a name="monitoring-the-number-and-size-of-snapshots-on-the-disk-volume"></a>Мониторинг количества и размера моментальных снимков на томе диска

Количество моментальных снимков и потребляемое ими пространство на определенном томе хранилища можно отслеживать. Команда `ls` не возвращает сведения о каталоге или файлах моментальных снимков. Эти сведения можно получить, добавив команду `du` операционной системы Linux в следующие команды:

- `du –sh .snapshot` — возвращает общее число моментальных снимков в каталоге моментальных снимков.
- `du –sh --max-depth=1` — выводит список всех моментальных снимков, сохраненных в папке .snapshot, и размер каждого моментального снимка.
- `du –hc` — возвращает общий размер всех моментальных снимков.

Следующие команды предоставляют сведения о создании и хранении моментальных снимков, а также об используемом ими пространстве на томах.

### <a name="reducing-the-number-of-snapshots-on-a-server"></a>Уменьшение количества моментальных снимков на сервере

Как упоминалось ранее, количество моментальных снимков, создаваемых с определенным интервалом, можно уменьшить. Последние два параметра команды позволяют указать временную метку и количество хранимых моментальных снимков.
```
./azure_hana_backup.pl lhanad01 customer 20
```
В примере выше для моментальных снимков задана метка _customer_, а количество моментальных снимков, которые должны храниться с этой меткой, равно _20_. За использование дискового пространства отвечаете вы, и поэтому вам может потребоваться уменьшить количество сохраненных моментальных снимков. Это можно легко сделать с помощью скрипта ниже, указав для последнего параметра значение 5.
```
./azure_hana_backup.pl lhanad01 customer 5
```
Выполнение этого скрипта позволяет уменьшить количество моментальных снимков, в том числе новый моментальный снимок хранилища, до _5_.

 >[!NOTE]
 > Этот скрипт уменьшает количество моментальных снимков, только если последний моментальный снимок создан более часа назад. Он не удаляет моментальные снимки, созданные менее часа назад.

Эти ограничения связаны с предоставленными необязательными функциями аварийного восстановления.

Если больше не требуется хранить моментальные снимки с этим префиксом, выполните скрипт, задав для периода удержания значение _0_. Скрипт удалит все моментальные снимки с соответствующим префиксом, а затем завершит работу. Однако это повлияет на возможности аварийного восстановления.

### <a name="recovering-to-the-most-recent-hana-snapshot"></a>Восстановление до последнего моментального снимка HANA

В случае сбоя рабочей системы, обратившись в отдел по управлению службами SAP HANA в Azure, вы можете инициировать процесс восстановления из моментального снимка хранилища как пользовательский инцидент. В некоторых случаях удаление данных в рабочей системе невозможно предвидеть, и единственный способ быстро вернуть их — восстановить рабочую базу данных.

С другой стороны, восстановление на определенный момент времени может быть не срочным и планироваться наперед. Чтобы спланировать восстановление, можно обратиться в отдел по управлению службами SAP HANA в Azure и поднять высокоприоритетные вопросы. К примеру, вы планируете установить новую версию пакета расширений для программного обеспечения SAP, а затем хотите вернуться до состояния перед обновлением EHP.

Прежде чем подать запрос, необходимо выполнить некоторые подготовительные действия, чтобы отдел по управлению службами SAP HANA в Azure мог обработать запрос и предоставить восстановленные тома, после чего вы сможете восстановить базу данных HANA на основе моментальных снимков. Ниже приведены действия для подготовки к запросу.

>[!NOTE]
>В зависимости от используемого выпуска SAP HANA пользовательский интерфейс может отличаться от следующих снимков экрана.

1. Выберите моментальный снимок, который нужно восстановить. Если не указано другое, будет восстановлен только том hana/data.

2. Завершите работу экземпляра HANA.

 ![Завершение работы экземпляра HANA](./media/hana-overview-high-availability-disaster-recovery/image7-shutdown-hana.png)

3. Отключите тома данных на каждом узле базы данных HANA. Если они не отключены, восстановление моментального снимка завершится сбоем.

 ![Отключение томов данных на каждом узле базы данных HANA](./media/hana-overview-high-availability-disaster-recovery/image8-unmount-data-volumes.png)

4. Отправьте запрос в службу поддержки Azure, чтобы получить указания по восстановлению определенного моментального снимка.

 - Во время восстановления: представитель отдела по управлению службами SAP HANA в Azure может присоединить вас к конференции, чтобы гарантировать восстановление всех данных.

 - После восстановления: отдел по управлению службами SAP HANA в Azure отправит вам оповещение о восстановлении моментального снимка хранилища.

5. Когда процесс восстановления завершится, подключите все тома данных.

 ![Подключение всех томов данных](./media/hana-overview-high-availability-disaster-recovery/image9-remount-data-volumes.png)

6. Выберите параметры восстановления в SAP HANA Studio, если они не отобразились автоматически при повторном подключении к базе данных HANA через SAP HANA Studio. В приведенном ниже примере показано, как выполнить восстановление до последнего моментального снимка HANA. Моментальный снимок хранилища внедряет моментальный снимок HANA. При восстановлении до последнего моментального снимка хранилища это будет последний моментальный снимок HANA. (При восстановлении до более старого моментального снимка хранилища найдите моментальный снимок HANA на основе времени создания моментального снимка хранилища.)

 ![Выбор параметров восстановления в SAP HANA Studio](./media/hana-overview-high-availability-disaster-recovery/image10-recover-options-a.png)

7. Установите переключатель **Recover the database to a specific data backup or storage snapshot** (Восстановить базу данных до определенной резервной копии или моментального снимка хранилища).

 ![Окно Specify Recovery Type (Выбор типа восстановления)](./media/hana-overview-high-availability-disaster-recovery/image11-recover-options-b.png)

8. Установите переключатель **Specify backup without catalog** (Указать резервную копию без каталога).

 ![Окно Specify Backup Location (Указание расположения резервной копии)](./media/hana-overview-high-availability-disaster-recovery/image12-recover-options-c.png)

9. В списке **Destination Type** (Тип назначения) выберите **Snapshot** (Моментальный снимок).

 ![Окно Specify the Backup to Recover (Указание резервной копии для восстановления)](./media/hana-overview-high-availability-disaster-recovery/image13-recover-options-d.png)

10. Нажмите кнопку **Finish** (Готово), чтобы запустить процесс восстановления.

 ![Нажатие кнопки Finish (Готово) для запуска процесса восстановления](./media/hana-overview-high-availability-disaster-recovery/image14-recover-options-e.png)

11. Восстановление базы данных HANA выполняется в моментальный снимок HANA, добавленный моментальным снимком хранилища.

 ![Восстановление базы данных HANA в моментальный снимок HANA](./media/hana-overview-high-availability-disaster-recovery/image15-recover-options-f.png)

### <a name="recovering-to-the-most-recent-state"></a>Восстановление до последнего состояния

Здесь описывается восстановление моментального снимка HANA, содержащегося в моментальном снимке хранилища. Затем выполняется восстановление резервных копий журнала транзакций до последнего состояния базы данных перед восстановлением моментального снимка хранилища.

>[!IMPORTANT]
>Прежде чем продолжить, завершите создание цепочки последовательных резервных копий журнала транзакций. Без этих резервных копий невозможно восстановить текущее состояние базы данных.

1. Выполните действия 1–6, описанные в разделе "Восстановление до последнего моментального снимка HANA".

2. Установите переключатель **Recover the database to its most recent state** (Восстановить базу данных до последнего состояния).

 ![Установка переключателя Recover the database to its most recent state (Восстановить базу данных до последнего состояния).](./media/hana-overview-high-availability-disaster-recovery/image16-recover-database-a.png)

3. Укажите расположение последних резервных копий журнала HANA. В этом расположении должны находиться все резервные копии журнала транзакций HANA от моментального снимка HANA до последнего состояния.

 ![Указание расположения последних резервных копий журнала HANA](./media/hana-overview-high-availability-disaster-recovery/image17-recover-database-b.png)

4. Выберите резервную копию, из которой нужно выполнить восстановление базы данных. В нашем примере это моментальный снимок HANA, включенный в моментальный снимок хранилища. (На следующем снимке экрана показан только один моментальный снимок.)

 ![Выбор резервной копии, из которой нужно выполнить восстановление базы данных](./media/hana-overview-high-availability-disaster-recovery/image18-recover-database-c.png)

5. Снимите флажок **Use Delta Backups** (Использовать измененные резервные копии), если в промежуток между созданием моментального снимка HANA и последним состоянием в резервные копии не вносились изменения.

 ![Флажок Use Delta Backups (Использовать измененные резервные копии), который нужно снять, если изменения не вносились](./media/hana-overview-high-availability-disaster-recovery/image19-recover-database-d.png)

6. В окне сводки нажмите кнопку **Finish** (Готово), чтобы запустить процедуру восстановления.

 ![Кнопка Finish (Готово) в окне сводки](./media/hana-overview-high-availability-disaster-recovery/image20-recover-database-e.png)

### <a name="recovering-to-another-point-in-time"></a>Восстановление до другой точки во времени
Чтобы выполнить восстановление на момент между созданием моментального снимка HANA (включенного в моментальный снимок хранилища) и более позднего моментального снимка, выполните следующее:

1. Соберите все резервные копии журнала транзакций от момента создания моментального снимка HANA до момента восстановления.
2. Выполните процедуру, описанную в разделе "Восстановление до последнего состояния".
3. На шаге 2 процедуры в окне **Specify Recovery Type** (Выбор типа восстановления) установите переключатель **Recover the database to the following point in time** (Восстановить базу данных до следующей точки во времени), укажите точку во времени, а затем завершите шаги 3–6.

## <a name="monitoring-the-execution-of-snapshots"></a>Мониторинг создания моментальных снимков

Вам необходимо наблюдать за созданием моментальных снимков хранилища. При выполнении скрипта создания моментального снимка хранилища выходные данные записываются в файл, а сам файл сохраняется в том же расположении, что и скрипты Perl. Для каждого моментального снимка создается отдельный файл. На основе выходных данных в каждом файле можно четко понять различные этапы, которые выполняет скрипт создания моментальных снимков:

- поиск томов, для которых необходимо создать моментальные снимки;
- поиск моментальных снимков этих томов;
- удаление имеющихся моментальных снимков в соответствии с указанным их количеством;
- создание моментального снимка HANA;
- создание моментального снимка хранилища для тома;
- удаление моментального снимка HANA;
- изменение имени последнего моментального снимка на **.0**.

Ниже приведена самая важная часть скрипта.
```
**********************Creating HANA snapshot**********************
Creating the HANA snapshot with command: "./hdbsql -n localhost -i 01 -U SCADMIN01 "backup data create snapshot"" ...
HANA snapshot created successfully.
**********************Creating Storage snapshot**********************
Taking snapshot hourly.recent for hana_data_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_log_backup_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_log_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for hana_shared_lhanad01_t020_vol ...
Snapshot created successfully.
Taking snapshot hourly.recent for sapmnt_lhanad01_t020_vol ...
Snapshot created successfully.
**********************Deleting HANA snapshot**********************
Deleting the HANA snapshot with command: "./hdbsql -n localhost -i 01 -U SCADMIN01 "backup data drop snapshot"" ...
HANA snapshot deletion successfully.
```
В этом примере видно, как скрипт записывает создание моментального снимка HANA. В случае горизонтального масштабирования этот процесс инициируется на главном узле. Главный узел инициирует синхронное создание моментальных снимков всех рабочих узлов. Затем создается моментальный снимок хранилища. После создания этого снимка моментальный снимок HANA удаляется.

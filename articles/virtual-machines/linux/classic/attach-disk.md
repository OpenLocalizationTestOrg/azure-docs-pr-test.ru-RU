---
title: "Подключение диска к виртуальной машине Linux в Azure | Документация Майкрософт"
description: "Узнайте, как подключить диск данных к виртуальной машине Linux, используя классическую модель развертывания, и инициализировать его, чтобы подготовить к использованию."
services: virtual-machines-linux
documentationcenter: 
author: iainfoulds
manager: timlt
editor: tysonn
tags: azure-service-management
ms.assetid: 4901384d-2a6f-4f46-bba0-337a348b7f87
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: na
ms.topic: article
ms.date: 02/09/2017
ms.author: iainfou
ms.openlocfilehash: 017ba7197e11c2b222082833d5acabb9e542b762
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="how-to-attach-a-data-disk-to-a-linux-virtual-machine"></a>Подключение диска данных к виртуальной машине Linux
> [!IMPORTANT] 
> В Azure предлагаются две модели развертывания для создания ресурсов и работы с ними: [модель диспетчера ресурсов и классическая модель](../../../resource-manager-deployment-model.md). В этой статье рассматривается использование классической модели развертывания. Для большинства новых развертываний Майкрософт рекомендует использовать модель диспетчера ресурсов. См. статью о том, как [присоединить диск данных, используя модель развертывания с помощью Resource Manager](../add-disk.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

К виртуальным машинам Azure можно присоединять пустые диски и диски с данными. В обоих случаях диски — это VHD-файлы, которые размещаются в учетной записи хранения Azure. Как и при добавлении диска к машине Linux, после присоединения диск нужно инициализировать и отформатировать, чтобы подготовить его к использованию. В этой статье подробно описывается присоединение пустых дисков и дисков с данными к виртуальным машинам, а также рассматривается, как затем инициализировать и отформатировать новый диск.

> [!NOTE]
> Рекомендуется использовать один или несколько отдельных дисков для хранения данных виртуальной машины. При создании виртуальной машины Azure у нее есть диск для операционной системы и временный диск. **Не используйте для постоянного хранения данных временный диск.** Как и предполагает его имя, он предназначен только для временного хранения. Этот диск не обеспечивает избыточности или резервного копирования, поскольку он не размещается в хранилище Azure.
> Временный диск обычно управляется агентом Azure для Linux и автоматически подключается к **/mnt/resource** (или **/mnt** в образах Ubuntu). Однако в некоторых случаях диск данных может получить от ядра Linux обозначение вида `/dev/sdc`, и тогда вам необходимо самостоятельно разделить, отформатировать и подключить этот ресурс. Дополнительные сведения см. в [руководстве пользователя агента Linux для Azure][Agent].
> 
> 

[!INCLUDE [howto-attach-disk-windows-linux](../../../../includes/howto-attach-disk-linux.md)]

## <a name="initialize-a-new-data-disk-in-linux"></a>Инициализация нового диска данных в Linux
1. Установите SSH-подключение к виртуальной машине. Дополнительные сведения см. в статье [Создание пары из открытого и закрытого ключей SSH для виртуальных машин Linux][Logon].
2. Далее вам необходимо найти идентификатор устройства для инициализации диска данных. Это можно осуществить двумя способами.
   
    а) примените функцию grep для устройств SCSI в журналах, например, как в следующей команде:
   
    ```bash
    sudo grep SCSI /var/log/messages
    ```
   
    Для установки последних дистрибутивов Ubuntu вам может потребоваться использовать `sudo grep SCSI /var/log/syslog`, так как вход в `/var/log/messages` может быть отключен по умолчанию.
   
    Идентификатор последнего добавленного диска данных можно найти в отображаемых сообщениях.
   
    ![Получение сообщений диска](./media/attach-disk/scsidisklog.png)
   
    ИЛИ
   
    б) Используйте команду `lsscsi` , чтобы узнать идентификатор устройства. Вы можете установить `lsscsi` с помощью `yum install lsscsi` (в дистрибутивах на основе Red Hat) или `apt-get install lsscsi` (в дистрибутивах на основе Debian). Нужный вам диск вы можете найти по его *LUN* ( **логическому номеру устройства**). Например, для подключенных вами дисков *LUN* можно легко получить, выполнив команду `azure vm disk list <virtual-machine>`.

    ```azurecli
    azure vm disk list myVM
    ```

    Выход аналогичен приведенному ниже:

    ```azurecli
    info:    Executing command vm disk list
    + Fetching disk images
    + Getting virtual machines
    + Getting VM disks
    data:    Lun  Size(GB)  Blob-Name                         OS
    data:    ---  --------  --------------------------------  -----
    data:         30        myVM-2645b8030676c8f8.vhd  Linux
    data:    0    100       myVM-76f7ee1ef0f6dddc.vhd
    info:    vm disk list command OK
    ```
   
    Сравните эти данные с выводом команды `lsscsi` для той же виртуальной машины.
   
    ```bash
    [1:0:0:0]    cd/dvd  Msft     Virtual CD/ROM   1.0   /dev/sr0
    [2:0:0:0]    disk    Msft     Virtual Disk     1.0   /dev/sda
    [3:0:1:0]    disk    Msft     Virtual Disk     1.0   /dev/sdb
    [5:0:0:0]    disk    Msft     Virtual Disk     1.0   /dev/sdc
    ```
   
    Последний номер в кортеже в каждой строке и есть номер *LUN*. Дополнительные сведения см. в `man lsscsi`.
3. В командной строке введите следующую команду, чтобы создать устройство:
   
    ```bash
    sudo fdisk /dev/sdc
    ```

4. При появлении запроса введите  **n**  для создания секции.

    ![Создание устройства](./media/attach-disk/fdisknewpartition.png)

5. При появлении запроса введите **p** , чтобы сделать раздел основным (primary). Введите **1** , чтобы сделать его первым разделом, а затем нажмите клавишу ВВОД, чтобы принять значение по умолчанию для цилиндра. В некоторых системах в первом и последнем секторах вместо цилиндра могут отображаться значения по умолчанию. При желании вы можете их принять.

    ![Создание раздела](./media/attach-disk/fdisknewpartdetails.png)


6. Введите **p** , чтобы просмотреть сведения о диске, на котором создаются разделы.

    ![Просмотр сведений о диске](./media/attach-disk/fdiskpartitiondetails.png)


7. Введите **w** , чтобы записать параметры данного диска.

    ![Запись изменений на диске](./media/attach-disk/fdiskwritedisk.png)

8. Теперь можно создать файловую систему в новом разделе. Добавьте номер раздела в код устройства (в примере ниже это `/dev/sdc1`). В следующем примере создается раздел ext4 в устройстве /dev/sdc1:
   
    ```bash
    sudo mkfs -t ext4 /dev/sdc1
    ```
   
    ![Создание файловой системы](./media/attach-disk/mkfsext4.png)
   
   > [!NOTE]
   > Системы SuSE Linux Enterprise 11 поддерживают доступ только для чтения в файловых системах ext4. Для этих систем рекомендуется форматировать новую файловую систему как ext3, а не ext4.

9. Создайте каталог для подключения новой файловой системы с помощью следующей команды:
   
    ```bash
    sudo mkdir /datadrive
    ```

10. Теперь вы можете подключить диск с помощью следующей команды:
   
    ```bash
    sudo mount /dev/sdc1 /datadrive
    ```
   
    Диск данных теперь готов для использования как **/datadrive**.
   
    ![Создание каталога и подключение диска](./media/attach-disk/mkdirandmount.png)

11. Добавьте новый диск в /etc/fstab:
   
    Чтобы обеспечить автоматическое повторное подключение диска после перезагрузки, его необходимо добавить в файл /etc/fstab. Кроме того, для ссылки на диск настоятельно рекомендуется использовать идентификатор UUID (глобально уникальный идентификатор) в /etc/fstab, а не просто имя устройства (т. е. /dev/sdc1). Использование идентификатора UUID позволяет избежать подключения неправильного диска к нужному расположению, если операционная система обнаруживает сбой диска во время загрузки, а остальные диски с данными связываются с этими идентификаторами устройств. Чтобы найти идентификатор UUID нового диска, можно использовать служебную программу **blkid**:
   
    ```bash
    sudo -i blkid
    ```
   
    Результат должен быть аналогичным приведенному ниже:
   
    ```bash
    /dev/sda1: UUID="11111111-1b1b-1c1c-1d1d-1e1e1e1e1e1e" TYPE="ext4"
    /dev/sdb1: UUID="22222222-2b2b-2c2c-2d2d-2e2e2e2e2e2e" TYPE="ext4"
    /dev/sdc1: UUID="33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e" TYPE="ext4"
    ```

    > [!NOTE]
    > Некорректное изменение файла **/etc/fstab** может привести к невозможности загрузить систему. Если у вас есть сомнения, см. инструкции по правильному изменению этого файла в документации дистрибутива. Также рекомендуется перед внесением изменений создать резервную копию файла /etc/fstab.

    Затем откройте файл **/etc/fstab** в текстовом редакторе:

    ```bash
    sudo vi /etc/fstab
    ```

    В этом примере мы используем значение UUID для нового устройства **/dev/sdc1**, созданного на предыдущих шагах, и точку подключения **/datadrive**. Добавьте следующую строку в конец файла **/etc/fstab** :

    ```sh
    UUID=33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e   /datadrive   ext4   defaults,nofail   1   2
    ```

    В системах на базе SUSE Linux может потребоваться использовать другой формат:

    ```sh
    /dev/disk/by-uuid/33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e   /datadrive   ext3   defaults,nofail   1   2
    ```

    > [!NOTE]
    > Параметр `nofail` гарантирует, что виртуальная машина запустится, даже если файловая система повреждена или отсутствует диск во время загрузки. Без этого параметра может возникнуть ситуация, описанная в записи блога [Cannot SSH to Linux VM due to FSTAB errors](https://blogs.msdn.microsoft.com/linuxonazure/2016/07/21/cannot-ssh-to-linux-vm-after-adding-data-disk-to-etcfstab-and-rebooting/) (Не удается подключиться к виртуальной машине Linux по протоколу SSH из-за ошибок FSTAB).

    Теперь можно проверить, правильно ли подключена файловая система, отключив и повторно подключив файловую систему, т. е. используя типовую точку подключения `/datadrive`, созданную на предыдущих этапах:

    ```bash
    sudo umount /datadrive
    sudo mount /datadrive
    ```

    Если команда `mount` приводит к ошибке, проверьте правильность синтаксиса в файле /etc/fstab. При создании дополнительных дисков данных и разделов также введите их в файл /etc/fstab отдельно.

    Сделайте диск доступным для записи, выполнив следующую команду:

    ```bash
    sudo chmod go+w /datadrive
    ```

    > [!NOTE]
    > Последующее удаление диска данных без редактирования fstab может привести к тому, что виртуальная машина не загрузится. Если это происходит часто, то большинство дистрибутивов предоставляют варианты `nofail` и/или `nobootwait` fstab, которые позволяют системе загружаться, даже если диск не подключается во время загрузки. Дополнительные сведения об этих параметрах см. в документации дистрибутива.

### <a name="trimunmap-support-for-linux-in-azure"></a>Поддержка операций TRIM и UNMAP для Linux в Azure
Некоторые ядра Linux поддерживают операции TRIM и UNMAP для отмены неиспользуемых блоков на диске. Эти операции особенно удобно использовать в хранилище уровня "Стандартный", чтобы сообщать Azure о том, что удаленные страницы больше не действительны и могут быть удалены. Удаление страниц позволит сократить затраты, если вы создаете большие файлы, а затем удаляете их.

Существует два способа включить поддержку операций TRIM в виртуальной машине Linux. Как обычно, обратитесь к документации дистрибутива, чтобы выбрать рекомендуемый метод.

* Используйте параметр подключения `discard` в `/etc/fstab`. Ниже приведен пример.

    ```sh
    UUID=33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e   /datadrive   ext4   defaults,discard   1   2
    ```

* В некоторых случаях параметр `discard` может негативно влиять на производительность. Кроме того, вы можете вручную выполнить команду `fstrim` из командной строки или добавить ее в crontab для регулярного выполнения.
  
    **Ubuntu**
  
    ```bash
    sudo apt-get install util-linux
    sudo fstrim /datadrive
    ```
  
    **RHEL или CentOS**
  
    ```bash
    sudo yum install util-linux
    sudo fstrim /datadrive
    ```

## <a name="troubleshooting"></a>Устранение неполадок
[!INCLUDE [virtual-machines-linux-lunzero](../../../../includes/virtual-machines-linux-lunzero.md)]

## <a name="next-steps"></a>Дальнейшие действия
Узнать больше об использовании виртуальной машины Linux можно в следующих статьях.

* [Вход в виртуальную машину под управлением ОС Linux][Logon]
* [Отсоединение диска от виртуальной машины Linux](detach-disk.md)
* [Команды Azure CLI в режиме управления службами Azure (ASM)](https://docs.microsoft.com/cli/azure/get-started-with-az-cli2)
* [Настройка программного RAID-массива в Linux](../configure-raid.md)
* [Настройка диспетчера логических томов на виртуальной машине Linux в Azure](../configure-lvm.md)

<!--Link references-->
[Agent]:../agent-user-guide.md
[Logon]:../mac-create-ssh-keys.md

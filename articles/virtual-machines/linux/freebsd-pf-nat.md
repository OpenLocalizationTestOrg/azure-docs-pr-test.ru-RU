---
title: "Создание брандмауэра в Azure с помощью PF FreeBSD | Документация Майкрософт"
description: "Узнайте о том, как развернуть брандмауэр NAT с использованием PF FreeBSD в Azure."
services: virtual-machines-linux
documentationcenter: 
author: KylieLiang
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 
ms.service: virtual-machines-linux
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure-services
ms.date: 02/20/2017
ms.author: kyliel
ms.openlocfilehash: cd777291a1321eabf4efe0d7b9b101f932d9398b
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="how-to-use-freebsds-packet-filter-to-create-a-secure-firewall-in-azure"></a><span data-ttu-id="b9b6a-103">Создание защищенного брандмауэра в Azure с использованием PF FreeBSD</span><span class="sxs-lookup"><span data-stu-id="b9b6a-103">How to use FreeBSD's Packet Filter to create a secure firewall in Azure</span></span>
<span data-ttu-id="b9b6a-104">В этой статье рассматривается использование фильтра пакетов FreeBSD для развертывания брандмауэра для NAT с помощью шаблона Azure Resource Manager для общего сценария веб-сервера.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-104">This article introduces how to deploy a NAT firewall using FreeBSD’s Packer Filter through Azure Resource Manager template for common web server scenario.</span></span>

## <a name="what-is-pf"></a><span data-ttu-id="b9b6a-105">Что такое PF?</span><span class="sxs-lookup"><span data-stu-id="b9b6a-105">What is PF?</span></span>
<span data-ttu-id="b9b6a-106">PF — это лицензированный (по лицензии BSD) фильтр пакетов с отслеживанием состояния, а также основной элемент программного обеспечения для брандмауэра.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-106">PF (Packet Filter, also written pf) is a BSD licensed stateful packet filter, a central piece of software for firewalling.</span></span> <span data-ttu-id="b9b6a-107">Фильтр пакетов получил широкое распространение, так как он обладает рядом преимуществ по сравнению с другими доступными брандмауэрами.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-107">PF has since evolved quickly and now has several advantages over other available firewalls.</span></span> <span data-ttu-id="b9b6a-108">Возможность преобразования сетевых адресов (NAT) внедрена в PF с самого начала. Затем за счет интеграции платформы ALTQ и реализации возможности ее настройки в конфигурации в PF были интегрированы планировщик пакетов и активное управление очередями.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-108">Network Address Translation (NAT) is in PF since day one, then packet scheduler and active queue management have been integrated into PF, by integrating the ALTQ and making it configurable through PF's configuration.</span></span> <span data-ttu-id="b9b6a-109">В PF были добавлены такие функции, как pfsync и CARP — для отработки отказа и обеспечения избыточности, authpf — для аутентификации сеанса и ftp-proxy — чтобы упростить проверку FTP-протокола в брандмауэре.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-109">Features such as pfsync and CARP for failover and redundancy, authpf for session authentication, and ftp-proxy to ease firewalling the difficult FTP protocol, have also extended PF.</span></span> <span data-ttu-id="b9b6a-110">Короче говоря, PF — это брандмауэр с расширенными возможностями.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-110">In short, PF is a powerful and feature-rich firewall.</span></span> 

## <a name="get-started"></a><span data-ttu-id="b9b6a-111">Начало работы</span><span class="sxs-lookup"><span data-stu-id="b9b6a-111">Get started</span></span>
<span data-ttu-id="b9b6a-112">Если вы хотите настроить безопасный брандмауэр в облаке для веб-серверов, тогда самое время начать.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-112">If you are interested in setting up a secure firewall in the cloud for your web servers, then let’s get started.</span></span> <span data-ttu-id="b9b6a-113">Чтобы настроить топологию сети, можно также применить сценарии, используемые в шаблоне Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-113">You can also apply the scripts used in this Azure Resource Manager template to set up your networking topology.</span></span>
<span data-ttu-id="b9b6a-114">Шаблон Azure Resource Manager позволяет настроить виртуальную машину FreeBSD, выполняющую преобразование сетевых адресов (NAT) или перенаправление с помощью PF, а также две виртуальные машины FreeBSD с установленным и настроенным веб-сервером Nginx.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-114">The Azure Resource Manager template set up a FreeBSD virtual machine that performs NAT /redirection using PF and two FreeBSD virtual machines with the Nginx web server installed and configured.</span></span> <span data-ttu-id="b9b6a-115">Кроме преобразования сетевых адресов для исходящего трафика двух веб-серверов, виртуальная машина, выполняющая преобразование сетевых адресов или перенаправление, перехватывает HTTP-запросы и методом циклического перебора перенаправляет их к двум веб-серверам.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-115">In addition to performing NAT for the two web servers egress traffic, the NAT/redirection virtual machine intercepts HTTP requests and redirect them to the two web servers in round-robin fashion.</span></span> <span data-ttu-id="b9b6a-116">Виртуальная сеть использует закрытое пространство IP-адресов 10.0.0.2/24 без поддержки маршрутизации. Параметры шаблона можно изменить.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-116">The VNet uses the private non-routable IP address space 10.0.0.2/24 and you can modify the parameters of the template.</span></span> <span data-ttu-id="b9b6a-117">Шаблон Azure Resource Manager также определяет таблицу маршрутов для всей виртуальной сети, которая является набором отдельных маршрутов, используемым для переопределения маршрутов Azure по умолчанию на основе конечного IP-адреса.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-117">The Azure Resource Manager template also defines a route table for the whole VNet, which is a collection of individual routes used to override Azure default routes based on the destination IP address.</span></span> 

![pf_topology](./media/freebsd-pf-nat/pf_topology.jpg)
    
### <a name="deploy-through-azure-cli"></a><span data-ttu-id="b9b6a-119">Развертывание с помощью Azure CLI</span><span class="sxs-lookup"><span data-stu-id="b9b6a-119">Deploy through Azure CLI</span></span>
<span data-ttu-id="b9b6a-120">Вам нужно установить последнюю версию [Azure CLI 2.0](/cli/azure/install-az-cli2) и войти в учетную запись Azure, выполнив команду [az login](/cli/azure/#login).</span><span class="sxs-lookup"><span data-stu-id="b9b6a-120">You need the latest [Azure CLI 2.0](/cli/azure/install-az-cli2) installed and logged in to an Azure account using [az login](/cli/azure/#login).</span></span> <span data-ttu-id="b9b6a-121">Создайте группу ресурсов с помощью команды [az group create](/cli/azure/group#create).</span><span class="sxs-lookup"><span data-stu-id="b9b6a-121">Create a resource group with [az group create](/cli/azure/group#create).</span></span> <span data-ttu-id="b9b6a-122">В примере ниже создается имя группы ресурсов `myResourceGroup` в расположении `West US`.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-122">The following example creates a resource group name `myResourceGroup` in the `West US` location.</span></span>

```azurecli
az group create --name myResourceGroup --location westus
```

<span data-ttu-id="b9b6a-123">Далее разверните шаблон [pf-freebsd-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/pf-freebsd-setup), используя команду [az group deployment create](/cli/azure/group/deployment#create).</span><span class="sxs-lookup"><span data-stu-id="b9b6a-123">Next, deploy the template [pf-freebsd-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/pf-freebsd-setup) with [az group deployment create](/cli/azure/group/deployment#create).</span></span> <span data-ttu-id="b9b6a-124">Скачайте файл [azuredeploy.parameters.json](https://github.com/Azure/azure-quickstart-templates/blob/master/pf-freebsd-setup/azuredeploy.parameters.json), путь к которому тот же, и определите значения ресурсов, например `adminPassword`, `networkPrefix` и `domainNamePrefix`.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-124">Download [azuredeploy.parameters.json](https://github.com/Azure/azure-quickstart-templates/blob/master/pf-freebsd-setup/azuredeploy.parameters.json) under the same path and define your own resource values, such as `adminPassword`, `networkPrefix`, and `domainNamePrefix`.</span></span> 

```azurecli
az group deployment create --resource-group myResourceGroup --name myDeploymentName \
    --template-uri https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/pf-freebsd-setup/azuredeploy.json \
    --parameters '@azuredeploy.parameters.json' --verbose
```

<span data-ttu-id="b9b6a-125">По истечении пять минут отобразится сообщение `"provisioningState": "Succeeded"`.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-125">After about five minutes, you will get the information of `"provisioningState": "Succeeded"`.</span></span> <span data-ttu-id="b9b6a-126">Затем вы можете подключиться к внешней виртуальной машине (NAT) по протоколу SSH или получить доступ к веб-серверу Nginx в браузере по общедоступному IP-адресу либо полному доменному имени виртуальной машины (NAT).</span><span class="sxs-lookup"><span data-stu-id="b9b6a-126">Then you can ssh to the frontend VM (NAT) or access Nginx web server in a browser using the public IP address or FQDN of the frontend VM (NAT).</span></span> <span data-ttu-id="b9b6a-127">В примере ниже указаны полное доменное имя и общедоступный IP-адрес, назначенные внешней виртуальной машине (NAT) в группе ресурсов `myResourceGroup`.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-127">The following example lists FQDN and public IP address that assigned to the frontend VM (NAT) in the `myResourceGroup` resource group.</span></span> 

```azurecli
az network public-ip list --resource-group myResourceGroup
```
    
## <a name="next-steps"></a><span data-ttu-id="b9b6a-128">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="b9b6a-128">Next steps</span></span>
<span data-ttu-id="b9b6a-129">Если вы хотите настроить NAT в Azure,</span><span class="sxs-lookup"><span data-stu-id="b9b6a-129">Do you want to set up your own NAT in Azure?</span></span> <span data-ttu-id="b9b6a-130">используя бесплатное и эффективное средство с открытым кодом,</span><span class="sxs-lookup"><span data-stu-id="b9b6a-130">Open Source, free but powerful?</span></span> <span data-ttu-id="b9b6a-131">PF отлично подходит для этого.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-131">Then PF is a good choice.</span></span> <span data-ttu-id="b9b6a-132">Шаблон [pf-freebsd-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/pf-freebsd-setup) позволит всего за пять минут настроить брандмауэр NAT с балансировкой нагрузки методом циклического перебора с помощью PF FreeBSD в Azure для общего сценария веб-сервера.</span><span class="sxs-lookup"><span data-stu-id="b9b6a-132">By using the template [pf-freebsd-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/pf-freebsd-setup), you only need five minutes to set up a NAT firewall with round-robin load balancing using FreeBSD's PF in Azure for common web server scenario.</span></span> 

<span data-ttu-id="b9b6a-133">Дополнительные сведения о предложениях FreeBSD в Azure см. в статье [Введение в FreeBSD в Azure](freebsd-intro-on-azure.md).</span><span class="sxs-lookup"><span data-stu-id="b9b6a-133">If you want to learn the offering of FreeBSD in Azure, refer to [introduction to FreeBSD on Azure](freebsd-intro-on-azure.md).</span></span>

<span data-ttu-id="b9b6a-134">Дополнительные сведения о PF см. в [руководстве FreeBSD](https://www.freebsd.org/doc/handbook/firewalls-pf.html) или в [руководстве пользователя PF](https://www.freebsd.org/doc/handbook/firewalls-pf.html).</span><span class="sxs-lookup"><span data-stu-id="b9b6a-134">If you want to know more about PF, refer to [FreeBSD handbook](https://www.freebsd.org/doc/handbook/firewalls-pf.html) or [PF-User's Guide](https://www.freebsd.org/doc/handbook/firewalls-pf.html).</span></span>

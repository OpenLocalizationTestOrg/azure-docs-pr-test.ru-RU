---
title: "Архивация виртуальных машин Linux в Azure | Документы Майкрософт"
description: "Защита виртуальных машин Linux путем их архивации с помощью службы архивации Azure."
services: virtual-machines-linux
documentationcenter: virtual-machines
author: cynthn
manager: timlt
editor: tysonn
tags: azure-resource-manager
ms.assetid: 
ms.service: virtual-machines-linux
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 07/27/2017
ms.author: cynthn
ms.custom: mvc
ms.openlocfilehash: 2eb0958169b175813b0dca775e9250da1cb364d4
ms.sourcegitcommit: 7d4b3cf1fc9883c945a63270d3af1f86e3bfb22a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2018
---
# <a name="back-up-linux--virtual-machines-in-azure"></a>Архивация виртуальных машин Linux в Azure

Защиту данных можно обеспечить, выполняя архивацию через регулярные интервалы. Служба архивации Azure создает точки восстановления, которые хранятся в геоизбыточных хранилищах восстановления. Используя точку восстановления, можно восстановить всю виртуальную машину или только определенные файлы. В этой статье описана процедура восстановления одного файла на виртуальной машине Linux с помощью nginx. Если у вас еще нет виртуальной машины, создайте ее, используя сведения, приведенные в статье [Создание виртуальной машины Linux с помощью Azure CLI](quick-create-cli.md). Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * Создание архива виртуальной машины
> * Планирование ежедневной архивации
> * Восстановление файла из архива



## <a name="backup-overview"></a>Обзор службы архивации

Служба архивации Azure запускает архивацию. При этом модуль архивации создает снимок текущего состояния. Служба архивации Azure использует расширение _VMSnapshotLinux_ в Linux. Расширение устанавливается во время первой архивации виртуальной машины, если виртуальная машина запущена. Если виртуальная машина не запущена, служба резервного копирования создает моментальный снимок базового хранилища (так как операции записи в приложении не выполняются, пока виртуальная машина остановлена).

По умолчанию Azure Backup создает резервную копию с согласованным состоянием файловой системы для виртуальной машины Linux, но эту службу можно настроить для создания [согласованных с приложениями резервных копий с помощью предварительного и последующего сценариев](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent). После создания моментального снимка службой архивации Azure данные передаются в хранилище. Для повышения эффективности служба анализирует блоки данных и передает только те из них, которые были изменены с момента предыдущего резервного копирования.

После передачи данных служба удаляет моментальный снимок и создает точку восстановления.


## <a name="create-a-backup"></a>Создание резервной копии
Создайте простую операцию ежедневной архивации в хранилище служб восстановления. 

1. Войдите на [портале Azure](https://portal.azure.com/).
2. В меню слева выберите **Виртуальные машины**. 
3. В этом списке выберите нужную виртуальную машину для архивации.
4. В колонке виртуальной машины в разделе **Параметры** щелкните **Архивация**. Откроется колонка **Включение архивации**.
5. В **хранилище служб восстановления** щелкните **Создать** и укажите имя нового хранилища. Новое хранилище создается в той же группе ресурсов и в том же расположении, что и виртуальная машина.
6. Щелкните **Политика архивации**. Для этого примера оставьте значения по умолчанию и нажмите кнопку **ОК**.
7. В колонке **Включение архивации** щелкните **Включить архивацию**. При этом создается задание ежедневной архивации на основе расписания по умолчанию.
10. Для создания начальной точки восстановления в колонке **Архивация** щелкните **Создать архив**.
11. В колонке **Создать архив** щелкните значок календаря и с помощью элементов управления календарем выберите последний день сохранения этой точки восстановления, а затем нажмите кнопку **Архивировать**.
12. В колонке **Архивировать** виртуальной машины вы увидите количество выполненных точек восстановления.

    ![Точки восстановления](./media/tutorial-backup-vms/backup-complete.png)

Первая архивация длится около 20 минут. После завершения архивации перейдите к следующей части этого руководства.

## <a name="restore-a-file"></a>Восстановление файла

Если вы случайно удалили файл или внесли в него ненужные изменения, его можно восстановить из резервного хранилища, используя функцию восстановления файлов. Для восстановления файлов на виртуальной машине запускается скрипт, который позволяет подключить точку восстановления в качестве локального диска. Эти диски остаются подключенными в течение 12 часов, чтобы вы могли скопировать файлы из точки восстановления и восстановить их на виртуальной машине.  

В этом примере показано, как восстановить веб-страницу nginx по умолчанию /var/www/html/index.nginx-debian.html. Общедоступный IP-адрес виртуальной машины в этом примере — *13.69.75.209*. IP-адрес виртуальной машины можно определить, выполнив следующую команду:

 ```bash 
 az vm show --resource-group myResourceGroup --name myVM -d --query [publicIps] --o tsv
 ```

 
1. На локальном компьютере откройте браузер и введите общедоступный IP-адрес виртуальной машины, чтобы увидеть веб-страницу nginx по умолчанию.

    ![Веб-страница nginx по умолчанию](./media/tutorial-backup-vms/nginx-working.png)

1. Подключитесь к виртуальной машине по протоколу SSH.

    ```bash
    ssh 13.69.75.209
    ```
2. Удалите /var/www/html/index.nginx-debian.html.

    ```bash
    sudo rm /var/www/html/index.nginx-debian.html
    ```
    
4. На локальном компьютере обновите браузер, нажав сочетание клавиш CTRL+F5, чтобы увидеть, что страница nginx по умолчанию отсутствует.

    ![Веб-страница nginx по умолчанию](./media/tutorial-backup-vms/nginx-broken.png)
    
1. На локальном компьютере войдите на [портал Azure](https://portal.azure.com/).
6. В меню слева выберите **Виртуальные машины**. 
7. Выберите пользователя из списка.
8. В колонке виртуальной машины в разделе **Параметры** щелкните **Архивация**. Откроется колонка **Архивация**. 
9. В меню в верхней части колонки выберите **Восстановление файлов**. Откроется колонка **Восстановление файлов**.
10. В разделе **Шаг 1. Выбор точки восстановления** выберите точку восстановления из раскрывающегося списка.
11. В разделе **Шаг 2. Скачивание скрипта для просмотра и восстановления файлов** нажмите кнопку **Скачать исполняемый файл**. Сохраните скачанный файл на локальный компьютер.
7. Щелкните **Скачать скрипт** для скачивания файла скрипта в локальное расположение.
8. Откройте строку Bash и введите следующую команду, заменив *Linux_myVM_05-05-2017.sh* правильным путем и именем файла скрипта, который вы скачали, замените *azureuser* именем пользователя виртуальной машины, а *13.69.75.209* — общедоступным IP-адресом виртуальной машины.
    
    ```bash
    scp Linux_myVM_05-05-2017.sh azureuser@13.69.75.209:
    ```
    
9. На локальном компьютере установите SSH-подключение к виртуальной машине.

    ```bash
    ssh 13.69.75.209
    ```
    
10. На виртуальной машине добавьте разрешения на выполнение для файла скрипта.

    ```bash
    chmod +x Linux_myVM_05-05-2017.sh
    ```
    
11. На виртуальной машине выполните скрипт, чтобы подключить точку восстановления в качестве файловой системы.

    ```bash
    ./Linux_myVM_05-05-2017.sh
    ```
    
12. В результате выполнения скрипта вы получите путь к точке подключения. Результат будет выглядеть примерно так:

    ```bash
    Microsoft Azure VM Backup - File Recovery
    ______________________________________________
                          
    Connecting to recovery point using ISCSI service...
    
    Connection succeeded!
    
    Please wait while we attach volumes of the recovery point to this machine...
                         
    ************ Volumes of the recovery point and their mount paths on this machine ************

    Sr.No.  |  Disk  |  Volume  |  MountPath 

    1)  | /dev/sdc  |  /dev/sdc1  |  /home/azureuser/myVM-20170505191055/Volume1

    ************ Open File Explorer to browse for files. ************

    After recovery, to remove the disks and close the connection to the recovery point, please click 'Unmount Disks' in step 3 of the portal.

    Please enter 'q/Q' to exit...
    ```

12. На виртуальной машине скопируйте веб-страницу nginx по умолчанию из точки подключения обратно в расположение, где был удален файл.

    ```bash
    sudo cp ~/myVM-20170505191055/Volume1/var/www/html/index.nginx-debian.html /var/www/html/
    ```
    
17. На локальном компьютере откройте вкладку браузера с подключением к IP-адресу виртуальной машины, на которой отображается страница nginx по умолчанию. Нажмите CTRL+F5, чтобы обновить страницу в браузере. Страница по умолчанию должна снова заработать.

    ![Веб-страница nginx по умолчанию](./media/tutorial-backup-vms/nginx-working.png)

18. На локальном компьютере вернитесь к вкладке портала Azure в браузере и в разделе **Шаг 3. Отключение дисков после восстановления** нажмите кнопку **Отключить диски**. Если вы забудете сделать это, соединение с точкой подключения будет автоматически закрыто через 12 часов. После этих 12 часов для создания нового соединения с точкой подключения потребуется скачать новый скрипт.


## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как выполнить следующие задачи:

> [!div class="checklist"]
> * Создание архива виртуальной машины
> * Планирование ежедневной архивации
> * Восстановление файла из архива

Перейдите к следующему руководству, чтобы узнать о мониторинге виртуальных машин.

> [!div class="nextstepaction"]
> [Мониторинг виртуальных машин](tutorial-monitoring.md)


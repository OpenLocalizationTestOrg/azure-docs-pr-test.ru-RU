---
title: "Настройка SSHD на виртуальных машинах Azure Linux | Документация Майкрософт"
description: "Вы можете настроить SSHD в соответствии с рекомендациями по обеспечению безопасности для блокировки SSH на виртуальных машин Azure Linux."
services: virtual-machines-linux
documentationcenter: 
author: vlivech
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: na
ms.topic: article
ms.date: 11/21/2016
ms.author: v-livech
ms.openlocfilehash: 0195c385b00ab92b2b92ce8ff00983a0d91bf3a1
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="configure-sshd-on-azure-linux-vms"></a>Настройка SSHD на виртуальных машинах Azure Linux

В этой статье показано, как выполнить блокировку SSH Server на платформе Linux, чтобы реализовать рекомендации по обеспечению безопасности и ускорить процедуру входа SSH с использованием ключей SSH, а не паролей.  Для блокировки SSHD мы отключим возможность входа для привилегированных пользователей, ограничим вход пользователей вход с помощью списка утвержденных групп, отключим протокол SSH версии 1, установим минимальное число бит для ключа и настроим автоматический выход неактивных пользователей.  Требования для работы с этим руководством: учетная запись Azure ([получите бесплатную пробную версию](https://azure.microsoft.com/pricing/free-trial/)) и [файлы открытого и закрытого ключей SSH](mac-create-ssh-keys.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

## <a name="quick-commands"></a>Быстрые команды

Настройте `/etc/ssh/sshd_config`, используя следующие параметры.

### <a name="disable-password-logins"></a>Отключение входа с использованием пароля

```bash
PasswordAuthentication no
```

### <a name="disable-login-by-the-root-user"></a>Отключение входа для привилегированного пользователя

```bash
PermitRootLogin no
```

### <a name="allowed-groups-list"></a>Список разрешенных групп

```bash
AllowGroups wheel
```

### <a name="allowed-users-list"></a>Список разрешенных пользователей

```bash
AllowUsers ahmet ralph
```

### <a name="disable-ssh-protocol-version-1"></a>Отключение протокола SSH версии 1

```bash
Protocol 2
```

### <a name="minimum-key-bits"></a>Минимальное число битов в ключе

```bash
ServerKeyBits 2048
```

### <a name="disconnect-idle-users"></a>Отключение неактивных пользователей

```bash
ClientAliveInterval 300
ClientAliveCountMax 0
```

## <a name="detailed-walkthrough"></a>Подробное пошаговое руководство

SSHD — это SSH-сервер, работающий на виртуальной машине Linux.  SSH — это клиент, который запускается из оболочки на рабочей станции MacBook или Linux, а также из Bash в Windows.  SSH — это также протокол, используемый для защиты и шифрования обмена данными между рабочей станцией и виртуальной машиной Linux. Иными словами, SSH также является VPN (виртуальной частной сетью).

Для работы с этим руководством статьи очень важно не закрывать один сеанс работы с виртуальной машиной Linux, пока вы не выполните все инструкции.  Установленное SSH-подключение сохраняется, пока открыто окно сеанса.  Работа с одним терминалом позволяет вносить изменения в службу SSHD без блокировки в случае критических изменений.  Если ВМ Linux заблокирована с помощью неработающей конфигурации SSHD, Azure поможет вам сбросить ее, используя [расширения для доступа к ВМ Azure](using-vmaccess-extension.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

Для этого мы откроем два терминала и установим подключение SSH к ВМ Linux в каждом из них.  Первый терминал будет использоваться для изменений файла конфигурации SSHD и перезапуска службы SSHD.  Второй терминал будет использоваться для тестирования этих изменений после перезапуска службы.  Поскольку мы отключаем SSH-пароли и полагаемся исключительно на SSH-ключи, если ваши SSH-ключи неверны и вы закроете подключение к виртуальной машине, эта виртуальная машины окажется безвозвратно заблокированной. Никто не сможет войти в нее, поэтому ее придется удалить и создать заново.

## <a name="disable-password-logins"></a>Отключение входа с использованием пароля

Отключить вход с использованием пароля — самый быстрый способ защитить ВМ Linux.  Когда вход с использованием пароля включен, программы-роботы, которые сканируют содержимое в Интернете, немедленно начнут попытки подобрать пароль к виртуальной ВМ Linux с помощью SSH.  Когда вход с помощью пароля отключен, сервер SSH игнорирует все попытки входа с использованием пароля.

```bash
PasswordAuthentication no
```

## <a name="disable-login-by-the-root-user"></a>Отключение входа для привилегированного пользователя

В соответствии с рекомендациями по работе с Linux, пользователи `root` не должны входить с помощью SSH или `sudo su`.  Все команды, требующие привилегированного доступа, всегда должны выполняться с использованием команды `sudo`, которая регистрирует все действия для будущего аудита.  Отключение для пользователя `root` возможности входа с помощью SSH — это лучший способ защиты, который разрешает эту процедуру только авторизованным пользователям.

```bash
PermitRootLogin no
```

## <a name="allowed-groups-list"></a>Список разрешенных групп

SSH предусматривает способ ограничить для пользователей и групп возможность входа с помощью SSH.  Эта функция использует списки для утверждения или отклонения запросов на вход, поступающих от определенных пользователей и групп.  Включив группу wheel в список `AllowGroups`, вы разрешите возможность входа по протоколу SSH только для учетных записей пользователей, входящих в группу wheel.

```bash
AllowGroups wheel
```

## <a name="allowed-users-list"></a>Список разрешенных пользователей

Ограничение входа по протоколу SSH только для пользователей — это частный пример выполнения этой задачи с помощью `AllowGroups`.  

```bash
AllowUsers ahmet ralph
```

## <a name="disable-ssh-protocol-version-1"></a>Отключение протокола SSH версии 1

Протокол SSH версии 1 является небезопасным и должен быть отключен.  Протокол SSH версии 2 — это текущая версия, которая обеспечивает безопасный способ использования SSH на сервере.  Отключение SSH версии 1 запрещает любым SSH-клиентам подключаться к серверу SSH с помощью SSH версии 1.  Подключаться к серверу SSH разрешено только через SSH версии 2.

```bash
Protocol 2
```

## <a name="minimum-key-bits"></a>Минимальное число битов в ключе

Рекомендации по обеспечению безопасности требуют отключать вход SSH с использованием пароля и выполнять проверку подлинности на SSH-сервере только с использованием SSH-ключей.  Эти SSH-ключи могут быть разной длины (измеряется в битах).  Рекомендуется использовать ключи длиной не менее 2048 бит.  Ключи меньше 2048 бит теоретически могут быть повреждены.  Присвоив параметру `ServerKeyBits` значение `2048`, вы разрешите все подключения с использованием ключей длиной от 2048 бит и, соответственно, запретите использование более коротких ключей (до 2048 бит).

```bash
ServerKeyBits 2048
```

## <a name="disconnect-idle-users"></a>Отключение неактивных пользователей

SSH может отключать пользователей с открытыми подключениями, которые остаются в состоянии простоя в течение заданного периода в секундах.  Сохранение открытых сеансов только для активных пользователей ограничивает возможность доступа к ВМ Linux.

```bash
ClientAliveInterval 300
ClientAliveCountMax 0
```

## <a name="restart-sshd"></a>Перезапуск SSHD

Чтобы включить параметры в `/etc/ssh/sshd_config`, перезапустите процесс SSHD, что, в свою очередь, перезапустит сервер SSH.  Окно терминала, используемое для перезапуска сервера SSH, останется открытым без потери сеанса SSH.  Чтобы проверить новые параметры SSH сервера, используйте второе окно или вкладку терминала.  Используя разные терминалы для проверки SSH-подключения, вы сможете вернуться и внести в первом терминале дополнительные изменения в `/etc/ssh/sshd_config` без блокировки SSHD при внесении критических изменений.  

### <a name="on-redhat-centos-and-fedora"></a>В Redhat, Centos и Fedora

```bash
service sshd restart
```

### <a name="on-debian--ubuntu"></a>В Debian и Ubuntu

```bash
service ssh restart
```

## <a name="reset-sshd-using-azure-reset-access"></a>Сброс SSHD с помощью команды Azure reset-access

Если у вас заблокирована возможность вносить критические изменения в конфигурацию SSHD, можно использовать расширение доступа к ВМ Azure, чтобы сбросить конфигурацию SSHD до исходной.

Замените все имена в примере собственными.

```azurecli
azure vm reset-access \
--resource-group myResourceGroup \
--name myVM \
--reset-ssh
```

## <a name="install-fail2ban"></a>Установка Fail2ban

Настоятельно рекомендуется установить и настроить приложение с открытым исходным кодом Fail2ban, которое блокирует повторные попытки входа на ВМ Linux по протоколу SSH методом подбора.  Fail2ban регистрирует повторяющиеся неудачные попытки входа по протоколу SSH, а затем создает правила брандмауэра, чтобы заблокировать IP-адрес, связанный с этими попытками.

* [Домашняя страница Fail2ban](http://www.fail2ban.org/wiki/index.php/Main_Page)

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы настроили и заблокировали сервер SSH на ВМ Linux, можно переходить к изучению дополнительных рекомендаций по обеспечению безопасности.  

* [Управление пользователями, SSH и проверка или восстановление дисков в виртуальных машинах Azure с помощью расширения VMAccess](using-vmaccess-extension.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)

* [Encrypt disks on a Linux VM using the Azure CLI](encrypt-disks.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) (Шифрование дисков на виртуальной машине Linux с помощью интерфейса командной строки Azure)

* [Доступ и безопасность в шаблонах Azure Resource Manager](dotnet-core-3-access-security.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)

---
title: "Мониторинг виртуальных машин Linux в Azure | Документация Майкрософт"
description: "Инструкции по мониторингу диагностических данных загрузки и метрик производительности на виртуальных машинах Linux в Azure"
services: virtual-machines-linux
documentationcenter: virtual-machines
author: davidmu1
manager: timlt
editor: tysonn
tags: azure-resource-manager
ms.assetid: 
ms.service: virtual-machines-linux
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 05/08/2017
ms.author: davidmu
ms.custom: mvc
ms.openlocfilehash: 3fe8390e88e609b57a462e066f972346f8e8730e
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="how-to-monitor-a-linux-virtual-machine-in-azure"></a>Мониторинг виртуальных машин Linux в Azure

Чтобы убедиться в правильной работе виртуальных машин в Azure, можно просмотреть диагностические данные загрузки и метрики производительности. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Включение диагностики загрузки на виртуальной машине.
> * Просмотр диагностики загрузки
> * Просмотр метрик узла.
> * Включение расширения системы диагностики на виртуальной машине.
> * Просмотр метрик виртуальной машины.
> * Создание оповещений на основе метрик диагностики.
> * Настройка расширенного мониторинга


[!INCLUDE [cloud-shell-try-it.md](../../../includes/cloud-shell-try-it.md)]

Если вы решили установить и использовать интерфейс командной строки локально, для работы с этим руководством вам понадобится Azure CLI 2.0.4 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0]( /cli/azure/install-azure-cli). 

## <a name="create-vm"></a>Создание виртуальной машины

Чтобы увидеть данные диагностики и метрики в действии, необходима виртуальная машина. Сначала создайте группу ресурсов с помощью команды [az group create](/cli/azure/group#create). В следующем примере создается группа ресурсов с именем *myResourceGroupMonitor* в расположении *eastus*.

```azurecli-interactive 
az group create --name myResourceGroupMonitor --location eastus
```

Теперь создайте виртуальную машину командой [az vm create](https://docs.microsoft.com/cli/azure/vm#create). В следующем примере создается виртуальная машина с именем *myVM*.

```azurecli-interactive 
az vm create \
  --resource-group myResourceGroupMonitor \
  --name myVM \
  --image UbuntuLTS \
  --admin-username azureuser \
  --generate-ssh-keys
```

## <a name="enable-boot-diagnostics"></a>Включение диагностики загрузки

Во время загрузки виртуальных машин Linux расширение системы диагностики записывает выходные данные загрузки и сохраняет их в хранилище Azure. Эти данные можно использовать для устранения неполадок загрузки виртуальной машины. При создании виртуальной машины Linux с помощью Azure CLI диагностика загрузки не включается автоматически.

Перед включением диагностики загрузки необходимо создать учетную запись хранения для хранения журналов загрузки. Имена учетных записей хранения должны быть глобально уникальными, иметь длину от 3 до 24 символов и содержать только цифры и буквы в нижнем регистре. Создайте учетную запись хранения с помощью команды [az storage account create](/cli/azure/storage/account#create). В этом примере для создания уникального имени учетной записи хранения используется случайная строка. 

```azurecli-interactive 
storageacct=mydiagdata$RANDOM

az storage account create \
  --resource-group myResourceGroupMonitor \
  --name $storageacct \
  --sku Standard_LRS \
  --location eastus
```

При включении диагностики загрузки необходим URI контейнера хранилища BLOB-объектов. Следующая команда запрашивает URI учетной записи хранения. Значение URI хранится в именах переменных *bloburi*, которые используются на следующем шаге.

```azurecli-interactive 
bloburi=$(az storage account show --resource-group myResourceGroupMonitor --name $storageacct --query 'primaryEndpoints.blob' -o tsv)
```

Включите диагностику загрузки с помощью команды [az vm boot-diagnostics enable](https://docs.microsoft.com/cli/azure/vm/boot-diagnostics#enable). Значение `--storage` — это URI BLOB-объекта, полученный на предыдущем шаге.

```azurecli-interactive 
az vm boot-diagnostics enable \
  --resource-group myResourceGroupMonitor \
  --name myVM \
  --storage $bloburi
```


## <a name="view-boot-diagnostics"></a>Просмотр диагностики загрузки

Если включена диагностика загрузки, каждый раз при остановке и запуске виртуальной машины сведения о процессе загрузки записываются в файл журнала. В этом примере сначала освободите виртуальную машину с помощью команды [az vm deallocate](/cli/azure/vm#deallocate) следующим образом:

```azurecli-interactive 
az vm deallocate --resource-group myResourceGroupMonitor --name myVM
```

Теперь запустите виртуальную машину с помощью команды [az vm start]( /cli/azure/vm#stop) следующим образом:

```azurecli-interactive 
az vm start --resource-group myResourceGroupMonitor --name myVM
```

Данные диагностики загрузки для *myVM* можно получить с помощью команды [az vm boot-diagnostics get-boot-log](https://docs.microsoft.com/cli/azure/vm/boot-diagnostics#get-boot-log) следующим образом:

```azurecli-interactive 
az vm boot-diagnostics get-boot-log --resource-group myResourceGroupMonitor --name myVM
```


## <a name="view-host-metrics"></a>Просмотр метрик узла

Виртуальная машина Linux имеет выделенный узел в Azure, с которым она взаимодействует. Метрики узла собираются автоматически и их можно просмотреть на портале Azure следующим образом:

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroupMonitor**, а затем в списке ресурсов выберите **myVM**.
1. Чтобы увидеть, как работает узел виртуальной машины, в колонке виртуальной машины щелкните **Метрики**, а затем выберите любую метрику *узла* в группе **Доступные метрики**.

    ![Просмотр метрик узла](./media/tutorial-monitoring/monitor-host-metrics.png)


## <a name="install-diagnostics-extension"></a>Установка расширения диагностики

> [!IMPORTANT]
> В этом документе описывается версия 2.3 диагностического расширения для Linux, которая признана нерекомендуемой. Версия 2.3 будет поддерживаться до 30 июня 2018 г.
>
> Вместо нее можно включить диагностическое расширение для Linux версии 3.0. Дополнительные сведения см. в [документации](./diagnostic-extension.md).

По умолчанию доступны основные метрики узла. Чтобы просмотреть более детальные метрики определенной виртуальной машины, требуется установить расширение системы диагностики Azure, позволяющее получать дополнительные данные мониторинга и диагностики виртуальной машины. С помощью этих метрик производительности можно создать уведомления с учетом работы виртуальной машины. Расширение системы диагностики устанавливается на портале Azure следующим образом:

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroup**, а затем **myVM** в списке ресурсов.
1. Щелкните **Параметры диагностики**. В списке будет указано, что *диагностика загрузки* уже включена в предыдущем разделе. Установите флажок для параметра *Базовые метрики*.
1. В разделе *Учетные записи хранения* найдите и выберите учетную запись *mydiagdata[1234]*, созданную при работе с предыдущим разделом.
1. Нажмите кнопку **Сохранить** .

    ![Просмотр метрик диагностики](./media/tutorial-monitoring/enable-diagnostics-extension.png)


## <a name="view-vm-metrics"></a>Просмотр метрик виртуальной машины

Метрики виртуальной машины можно просмотреть аналогично метрикам узла виртуальной машины:

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroup**, а затем **myVM** в списке ресурсов.
1. Чтобы увидеть, как работает виртуальная машина, в колонке виртуальной машины щелкните **Метрики**, затем выберите любую метрику диагностики в группе **Доступные метрики**.

    ![Просмотр метрик виртуальной машины](./media/tutorial-monitoring/monitor-vm-metrics.png)


## <a name="create-alerts"></a>Создание оповещений

На основе метрик производительности можно создавать оповещения. Например, оповещения можно использовать для уведомления о том, что средняя загрузка ЦП превышает пороговое значение или свободное место на диске ниже определенного значения. Оповещения отображаются на портале Azure или могут быть отправлены по электронной почте. Вы также можете активировать модули Runbook службы автоматизации Azure или Azure Logic Apps в ответ на создаваемые оповещения.

В следующем примере создается предупреждение на основе среднего показателя использования ЦП.

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroup**, а затем **myVM** в списке ресурсов.
2. В колонке виртуальной машины щелкните **Правила оповещения**, а затем выберите **Добавить оповещение метрики**.
4. Укажите **имя** оповещения, например *myAlertRule*.
5. Для активации оповещения о превышении процента использования ЦП на 1.0 в течение пяти минут оставьте все настройки по умолчанию.
6. При необходимости установите флажок возле параметра *Участники, читатели и владельцы электронной почты* для отправки уведомлений по электронной почте. Действие по умолчанию — предоставлять уведомления на портале.
7. Нажмите кнопку **ОК**.


## <a name="advanced-monitoring"></a>Расширенный мониторинг 

Более сложный мониторинг виртуальной машины можно выполнить с помощью [Operations Management Suite](https://docs.microsoft.com/azure/operations-management-suite/operations-management-suite-overview). Зарегистрируйтесь для получения [бесплатной пробной версии](https://www.microsoft.com/en-us/cloud-platform/operations-management-suite-trial) Operations Management Suite, если вы еще не сделали этого.

При наличии доступа к порталу OMS ключи и идентификатор рабочей области можно найти в колонке "Параметры". Замените <workspace-key> и <workspace-id> значениями рабочей области OMS, а затем воспользуйтесь командой **az vm extension set**, чтобы добавить расширение OMS на виртуальную машину:

```azurecli-interactive 
az vm extension set \
  --resource-group myResourceGroupMonitor \
  --vm-name myVM \
  --name OmsAgentForLinux \
  --publisher Microsoft.EnterpriseCloud.Monitoring \
  --version 1.3 \
  --protected-settings '{"workspaceKey": "<workspace-key>"}' \
  --settings '{"workspaceId": "<workspace-id>"}'
```

В колонке "Поиск по журналу" на портале OMS вы увидите *myVM*, как на следующем изображении:

![Колонка OMS](./media/tutorial-monitoring/tutorial-monitor-oms.png)

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы выполнили настройку и проверку виртуальных машин с помощью центра безопасности Azure. Вы научились выполнять следующие задачи:

> [!div class="checklist"]
> * Включение диагностики загрузки на виртуальной машине.
> * Просмотр диагностики загрузки
> * Просмотр метрик узла.
> * Включение расширения системы диагностики на виртуальной машине.
> * Просмотр метрик виртуальной машины.
> * Создание оповещений на основе метрик диагностики.
> * Настройка расширенного мониторинга.

Перейдите к следующему руководству, чтобы узнать о центре безопасности Azure.

> [!div class="nextstepaction"]
> [Мониторинг защиты виртуальных машин с помощью центра безопасности Azure](./tutorial-azure-security.md)
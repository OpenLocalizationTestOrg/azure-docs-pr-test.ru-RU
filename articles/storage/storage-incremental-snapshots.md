---
title: "aaaUse добавочных моментальных снимков для резервного копирования и восстановления неуправляемые дисков виртуальной Машины Azure | Документы Microsoft"
description: "Создание пользовательского решения для архивации и восстановления дисков виртуальной машины Azure с помощью добавочных моментальных снимков."
services: storage
documentationcenter: na
author: aungoo-msft
manager: tadb
editor: tysonn
ms.assetid: 3524b987-bd65-4e35-83e7-fbc2136643e5
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/23/2017
ms.author: aungoo
ms.openlocfilehash: 6d3e6d78e953f77a1028ac35dcde1ef046dbc3bb
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="back-up-azure-unmanaged-vm-disks-with-incremental-snapshots"></a>Архивация неуправляемых дисков виртуальной машины Azure с помощью добавочных моментальных снимков
## <a name="overview"></a>Обзор
Хранилище Azure предоставляет возможность hello tootake моментальные снимки больших двоичных объектов. Моментальные снимки записать состояние hello большого двоичного объекта на момент времени. В этой статье мы опишем, как можно поддерживать архивы дисков виртуальной машины с помощью моментальных снимков. Этот метод можно использовать при выборе не toouse резервного копирования Azure и служба восстановления и пожеланий toocreate пользовательской стратегией резервного копирования для дисков виртуальной машины.

Диски виртуальной машины Azure хранятся в службе хранилища Azure как страничные BLOB-объекты. Поскольку мы говорим о стратегию резервного копирования для дисков виртуальной машины в этой статье, мы будет ссылаться toosnapshots в контексте hello страничные большие двоичные объекты. toolearn Дополнительные сведения о моментальных снимков, см. слишком[создание моментального снимка большого двоичного объекта](https://msdn.microsoft.com/library/azure/hh488361.aspx).

## <a name="what-is-a-snapshot"></a>Что такое моментальный снимок?
Моментальный снимок большого двоичного объекта — это доступная только для чтения версия большого двоичного объекта, созданная в определенный момент времени. После создания моментального снимка его можно читать, копировать или удалять, но нельзя изменять. Моментальные снимки обеспечивают tooback способом копирования большого двоичного объекта, как оно отображается в момент времени. До версии 2015-04-05 REST имели возможность hello toocopy полный моментальные снимки. С hello REST версии 2015-07-08 и более поздних версий, можно также можно скопировать добавочных моментальных снимков.

## <a name="full-snapshot-copy"></a>Копирование полных моментальных снимков
Моментальные снимки могут быть скопированы tooanother учетной записи хранения в качестве резервных копий больших двоичных объектов tookeep hello базового большого двоичного объекта. Также можно скопировать моментальный снимок через его базовый большой двоичный объект, как восстановление tooan hello большой двоичный объект более ранней версии. При копировании из одной tooanother учетной записи хранилища моментального снимка будет занимать hello же пространства как большой двоичный объект базовой страницы приветствия. Таким образом копирование всего моментальных снимков из одного tooanother учетную запись хранилища будет выполняться медленно и также будет занимать много места в hello целевой учетной записи хранения.

> [!NOTE]
> При копировании hello базового большого двоичного объекта tooanother назначения hello снимков hello BLOB-объекта не копируются вместе с ним. Аналогичным образом при перезаписи базового BLOB-объекта с копией, моментальные снимки, связанные с hello базового большого двоичного объекта не затрагиваются и остаются неизменными, под именем базового большого двоичного объекта.
> 
> 

### <a name="back-up-disks-using-snapshots"></a>Архивация дисков с помощью моментальных снимков
В рамках стратегии резервного копирования для дисков виртуальной машины можно периодическое создание большого двоичного объекта диска или страницу приветствия и скопировать их tooanother учетной записи хранилища с помощью таких средств, как [копирования BLOB-объекта](https://msdn.microsoft.com/library/azure/dd894037.aspx) операции или [AzCopy](storage-use-azcopy.md). Можно скопировать моментальный снимок tooa страницы BLOB-объект назначения с другим именем. Hello результирующий целевой страничный большой двоичный объект является большой двоичный объект для записи страницы и моментальный снимок не. Далее в этой статье рассматриваются действия tootake резервных копий с использованием моментальных снимков дисков виртуальной машины.

### <a name="restore-disks-using-snapshots"></a>Восстановление дисков с помощью моментальных снимков
Когда диск tooa предыдущей стабильной версии, записанные в одной из резервных копий моментальных снимков hello toorestore времени, можно скопировать моментальный снимок на большой двоичный объект базовой страницы приветствия. После hello моментального снимка большого двоичного объекта повышенного уровня toohello базовой страницы, hello моментальный снимок остается, но его исходник перезаписывается копией, можно как для чтения и записи. Далее в этой статье рассматриваются действия toorestore предыдущей версии на диске из ее моментального снимка.

### <a name="implementing-full-snapshot-copy"></a>Реализация копирования полных моментальных снимков
Копирование полного моментального снимка можно реализовать, выполнив следующие hello

* Во-первых, сделайте снимок hello базового BLOB-объекта с помощью hello [моментального снимка большого двоичного объекта](https://msdn.microsoft.com/library/azure/ee691971.aspx) операции.
* Затем копия hello моментального снимка tooa целевого хранилища учетной записи с помощью [копирования BLOB-объекта](https://msdn.microsoft.com/library/azure/dd894037.aspx).
* Повторите этот процесс toomaintain резервные копии базового большого двоичного объекта.

## <a name="incremental-snapshot-copy"></a>Копирование добавочных моментальных снимков
Новая функция Hello в [GetPageRanges](https://msdn.microsoft.com/library/azure/ee691973.aspx) API-Интерфейс обеспечивает гораздо лучшую tooback способом, копирование моментальных снимков hello страничные большие двоичные объекты или дисков. Hello API возвращает hello список изменений между hello базового большого двоичного объекта и моментальные снимки hello. Это уменьшает hello объем хранилища используется для резервного копирования hello учетной записи. Hello API поддерживает страничные большие двоичные объекты в хранилище Premium, а также стандартное хранилище. С помощью данного API можно создавать более быстрые и эффективные решения архивации для виртуальных машин Azure. Это будет hello REST версии 2015-07-08 и более поздних версий.

Добавочное копирование моментального снимка допускает toocopy из одного хранилища учетной записи tooanother hello разность,

* между базовым большим двоичным объектом и его моментальным снимком ИЛИ
* Любые два снимка hello базового большого двоичного объекта

Если выполняются следующие условия hello,

* Hello BLOB-объект был создан Jan 1 2016 г. или более поздней версии.
* Hello большой двоичный объект не был перезаписан с [PutPage](https://msdn.microsoft.com/library/azure/ee691975.aspx) или [копирования BLOB-объекта](https://msdn.microsoft.com/library/azure/dd894037.aspx) между двумя моментальными снимками.

**Примечание**. Эта функция доступна для страничных BLOB-объектов Azure класса Premium или "Стандартный".

При наличии пользовательской стратегией резервного копирования, который использует моментальные снимки, копирование моментальных снимков hello из одного tooanother учетной записи хранилища может вычисляться очень медленно и требует много места. Вместо копирования учетной записи для хранения резервных копий tooa всего моментального снимка hello, можно написать hello различие между последовательных моментальные снимки tooa резервного копирования страничного большого двоичного объекта. В этом случае hello время toocopy пространства toostore резервного копирования и значительно снижается.

### <a name="implementing-incremental-snapshot-copy"></a>Реализация копирования добавочных моментальных снимков
Можно реализовать копирования моментального снимка, выполнив следующие hello

* Создание снимка hello базового BLOB-объекта с помощью [моментального снимка большого двоичного объекта](https://msdn.microsoft.com/library/azure/ee691971.aspx).
* Копировать hello моментального снимка toohello целевого хранилища резервных копий учетной записи с помощью [копирования BLOB-объекта](https://msdn.microsoft.com/library/azure/dd894037.aspx). Это будет резервного копирования страничным hello. Сделайте моментальный снимок этого архивного страничного BLOB-объекта и сохраните его в архивной учетной записи.
* Создайте другой моментальный снимок hello базового BLOB-объекта с помощью моментального снимка большого двоичного объекта.
* Получить hello разницу между первой и второй моментальные снимки с помощью базового большого двоичного объекта [GetPageRanges](https://msdn.microsoft.com/library/azure/ee691973.aspx). Использовать новый параметр hello **prevsnapshot** toospecify hello значение DateTime hello снимок tooget отличие hello. Если этот параметр присутствует, hello REST ответ будет содержать только hello страницы, которые были изменены между целевой снимком и предыдущим снимком, включая страницы, снимите флажок.
* Используйте [PutPage](https://msdn.microsoft.com/library/azure/ee691975.aspx) tooapply эти изменения toohello резервного копирования страничного большого двоичного объекта.
* Наконец снимок резервной копии страничным hello и их сохранения в учетной записи хранилища резервных копий hello.

В следующем разделе hello рассматриваются более подробно как можно сохранять резервные копии дисков, с помощью добавочного копирования моментального снимка

## <a name="scenario"></a>Сценарий
В этом разделе описывается сценарий, включающий в себя пользовательскую стратегию архивации для дисков виртуальной машины с помощью моментальных снимков.

Рассмотрим виртуальную машину Azure серии DS с подключенным диском P30 хранилища уровня "Премиум". диск Hello P30 называют *mypremiumdisk* хранятся в учетной записи хранения premium вызывается *mypremiumaccount*. Стандартная учетная запись хранения называется *mybackupstdaccount* будет использоваться для хранения резервной копии hello *mypremiumdisk*. Мы хотели бы tookeep моментального снимка из *mypremiumdisk* каждые 12 часов.

toolearn о создании учетной записи хранилища и диски, см. слишком[учетных записей хранилища Azure о](storage-create-storage-account.md).

toolearn о резервном копировании виртуальных машинах Azure, см. слишком[резервных копий виртуальной Машины Azure плана](../backup/backup-azure-vms-introduction.md).

## <a name="steps-toomaintain-backups-of-a-disk-using-incremental-snapshots"></a>Действия toomaintain резервных копий на диск с помощью добавочных моментальных снимков
Hello описанные ниже действия будут создавать снимки *mypremiumdisk* и сохранять резервные копии hello в *mybackupstdaccount*. Hello резервная копия будет Стандартная страничного большого двоичного объекта вызывается *mybackupstdpageblob*. Hello резервного копирования страничного большого двоичного объекта, всегда представляют Привет же состояний в качестве hello последний моментальный снимок *mypremiumdisk*.

1. Во-первых создайте hello резервного копирования страничного большого двоичного объекта для диска хранения premium. toodo это, создайте снимок *mypremiumdisk* вызывается *mypremiumdisk_ss1*.
2. Скопируйте этот моментальный снимок toomybackupstdaccount как страничного большого двоичного объекта вызывается *mybackupstdpageblob*.
3. Создайте моментальный снимок *mybackupstdpageblob* с именем *mybackupstdpageblob_ss1* с помощью операции [создания моментального снимка BLOB-объекта](https://msdn.microsoft.com/library/azure/ee691971.aspx) и сохраните его в *mybackupstdaccount*.
4. Во время резервного копирования hello, создайте другой моментальный снимок *mypremiumdisk*, например *mypremiumdisk_ss2*и сохранить ее в *mypremiumaccount*.
5. Получить hello добавочные изменения между снимками hello двух *mypremiumdisk_ss2* и *mypremiumdisk_ss1*, с использованием [GetPageRanges](https://msdn.microsoft.com/library/azure/ee691973.aspx) на  *mypremiumdisk_ss2* с **prevsnapshot** параметру отметка времени toohello *mypremiumdisk_ss1*. Записать эти добавочные изменения toohello резервного копирования страничного большого двоичного объекта *mybackupstdpageblob* в *mybackupstdaccount*. Если имеются удаленные диапазоны в hello добавочные изменения, должен быть снят из большого двоичного объекта резервного копирования страницы приветствия. Используйте [PutPage](https://msdn.microsoft.com/library/azure/ee691975.aspx) toowrite добавочные изменения toohello резервного копирования страничного большого двоичного объекта.
6. Создать моментальный снимок резервной копии страничным hello *mybackupstdpageblob*, который называется *mybackupstdpageblob_ss2*. Удаление предыдущего снимка hello *mypremiumdisk_ss1* из учетной записи хранения premium.
7. Повторите шаги 4–6 в каждом окне архивации. Так вы сможете хранить архивы *mypremiumdisk* в учетной записи хранения класса "Стандартный".

![Архивация диска с помощью добавочных моментальных снимков](./media/storage-incremental-snapshots/storage-incremental-snapshots-1.png)

## <a name="steps-toorestore-a-disk-from-snapshots"></a>Действия toorestore диска из моментальных снимков
Hello описанные ниже действия приведет к восстановлению диска premium *mypremiumdisk* tooan ранее моментального снимка из учетной записи хранилища резервных копий hello *mybackupstdaccount*.

1. Идентифицирует hello момент времени, в которых надо toorestore hello premium диска. Предположим, что, — snapshot *mybackupstdpageblob_ss2*, который хранится в учетной записи хранилища резервных копий hello *mybackupstdaccount*.
2. В mybackupstdaccount, повышение уровня моментального снимка hello *mybackupstdpageblob_ss2* как hello нового резервного копирования базовой страницы большого двоичного объекта *mybackupstdpageblobrestored*.
3. Создайте моментальный снимок восстановленного из резервной копии страничного BLOB-объекта с именем *mybackupstdpageblob_ss1*.
4. Страница hello восстановить копирования BLOB-объекта *mybackupstdpageblobrestored* из *mybackupstdaccount* слишком*mypremiumaccount* как новый диск premium hello  *mypremiumdiskrestored*.
5. Создайте моментальный снимок *mypremiumdiskrestored* с именем *mypremiumdiskrestored_ss1* для дальнейшего добавочного резервного копирования.
6. Точка ряда hello доменных служб Active Directory toohello восстановить диск виртуальной Машины *mypremiumdiskrestored* и отсоединения старой hello *mypremiumdisk* из hello виртуальной Машины.
7. Начать hello резервного копирования процесс, описанный в предыдущем разделе hello восстановить диск *mypremiumdiskrestored*, с помощью hello *mybackupstdpageblobrestored* как большой двоичный объект резервной копии страницы приветствия.

![Восстановление диска из моментальных снимков](./media/storage-incremental-snapshots/storage-incremental-snapshots-2.png)

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о планировании инфраструктуры резервного копирования виртуальной Машины, используя приведенные ниже ссылки hello и создание моментальных снимков большого двоичного объекта.

* [Создание моментального снимка большого двоичного объекта](https://msdn.microsoft.com/library/azure/hh488361.aspx)
* [Планирование инфраструктуры резервного копирования виртуальных машин в Azure](../backup/backup-azure-vms-introduction.md)


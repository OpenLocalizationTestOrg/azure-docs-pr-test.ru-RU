---
title: "виртуальные машины aaaMigrating tooAzure хранилище Premium | Документы Microsoft"
description: "Перенос в существующие виртуальные машины tooAzure хранилище Premium. Хранилище Premium обеспечивает поддержку дисков с высокой производительностью и малой задержкой для интенсивных рабочих нагрузок ввода-вывода на виртуальных машинах Azure."
services: storage
documentationcenter: na
author: yuemlu
manager: tadb
editor: tysonn
ms.assetid: 272250b3-fd4e-41d2-8e34-fd8cc341ec87
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/27/2017
ms.author: yuemlu
ms.openlocfilehash: cd812bdbe39f43fe053a998d96788045d5a43258
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="migrating-tooazure-premium-storage-unmanaged-disks"></a>Миграция tooAzure хранилище Premium (неуправляемой диски)

> [!NOTE]
> В этой статье рассматриваются как toomigrate виртуальной Машины, которая использует tooa неуправляемые стандартные диски виртуальной Машины, использующей неуправляемого диски premium. Рекомендуется использовать диски управляемых Azure для новых виртуальных машин и преобразовании предыдущих дисков toomanaged неуправляемые дисков. Управляемые диски дескриптор hello базового хранилища счетов, не нужно. Дополнительные сведения см. в статье [Managed Disks Overview](storage-managed-disks-overview.md) (Обзор Управляемых дисков).
>

Хранилище Azure Premium обеспечивает поддержку дисков с высокой производительностью и малой задержкой для виртуальных машин с интенсивной рабочей нагрузкой ввода-вывода. Путем переноса приложения в виртуальной Машине диски tooAzure хранилище Premium, могут пользоваться преимуществами hello скорости и производительность этих дисков.

в этом руководстве Hello задачей является новым пользователям toohelp хранилища Azure Premium лучше подготовить toomake плавный переход от их текущего tooPremium системы хранения. Hello руководстве рассматриваются три основные компоненты hello в этом процессе:

* [Планирование миграции hello tooPremium хранилища](#plan-the-migration-to-premium-storage)
* [Подготовка и копирования виртуальные жесткие диски (VHD) tooPremium хранилища](#prepare-and-copy-virtual-hard-disks-VHDs-to-premium-storage)
* [создание виртуальной машины Azure c использованием хранилища класса Premium](#create-azure-virtual-machine-using-premium-storage).

Можно перенести виртуальные машины из других платформ tooAzure хранилище Premium или переноса существующих виртуальных машин Azure из стандартного хранилища tooPremium хранилища. В этом руководстве рассматриваются оба этих сценария. Выполните действия hello, указанный в hello соответствующий подраздел в зависимости от вашего сценария.

> [!NOTE]
> Общие сведения о возможностях хранилища класса Premium и ценах на него см. в статье [Хранилище класса «Премиум»: высокопроизводительная служба хранилища для рабочих нагрузок виртуальных машин Azure](storage-premium-storage.md). Мы рекомендуем перейти любого диска виртуальной машины, требуя высокой tooAzure операций ввода-ВЫВОДА хранилища Premium для hello наилучшей производительности для вашего приложения. Если диск не требует большого числа операций ввода-вывода в секунду, выберите более доступное хранилище уровня Standard — в этом случае данные с диска виртуальной машины будут храниться не на твердотельных, а на жестких дисках.
>

Завершение процесса миграции hello в полном объеме может потребоваться дополнительные действия до и после hello шаги, описанные в этом руководстве. Примеры включают настройку виртуальных сетей или конечные точки или внесения изменений в код приложения hello сам которого может потребоваться некоторое время простоя в приложении. Эти действия являются уникальными tooeach приложения и они должны выполняться вместе с hello шаги, описанные в этом руководство по toomake hello полного перехода tooPremium хранилища, как можно менее заметным.

## <a name="plan-the-migration-to-premium-storage"></a>Планирование миграции hello tooPremium хранилища
В этом разделе гарантирует, что будут готовы toofollow шагов миграции hello в этой статье и помогает toomake hello наилучшее решение в типах виртуальной Машины и диска.

### <a name="prerequisites"></a>Предварительные требования
* Вам понадобится подписка Azure. Если у вас нет подписки, можно оформить [бесплатную пробную](https://azure.microsoft.com/pricing/free-trial/) подписку на один месяц или посетить страницу [Цены Azure](https://azure.microsoft.com/pricing/), чтобы ознакомиться с дополнительными возможностями.
* tooexecute командлеты PowerShell, необходимо будет hello модуля Microsoft Azure PowerShell. В разделе [как tooinstall и настройка Azure PowerShell](/powershell/azure/overview) для hello установить точку и инструкции по установке.
* При планировании toouse Azure виртуальные машины на хранилище Premium необходимо hello toouse хранилище Premium поддерживает виртуальные машины. С этими виртуальными машинами можно использовать диски хранилища класса Premium и Standard. Диски хранилища Premium можно найти с несколько типов ВМ в будущем hello. Дополнительные сведения о всех доступных типах и размерах дисков виртуальной машины Azure см. в разделах [Размеры виртуальных машин](../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) и [Размеры для облачных служб](../cloud-services/cloud-services-sizes-specs.md).

### <a name="considerations"></a>Рекомендации
Виртуальной машине Azure поддерживает подключение нескольких дисках хранилища Premium, чтобы приложения может содержать до too256 ТБ хранилища каждой виртуальной Машины. С хранилищем Premium вы получите выполнение до 80 000 операций ввода-вывода в секунду на виртуальную машину и пропускную способность второго диска до 2000 МБ в секунду на виртуальную машину с очень низкой задержкой при операциях чтения. Вы можете выбирать виртуальные машины и диски среди множества различных вариантов. Этот раздел представляет toohelp toofind параметр, который лучше всего подходит для рабочей нагрузки.

#### <a name="vm-sizes"></a>Размеры виртуальной машины
Hello спецификаций размера виртуальной Машины Azure, перечислены в [размеры виртуальных машин](../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json). Проверьте характеристики производительности hello виртуальные машины, работающие с хранилищем Premium и выберите размер виртуальной Машины наиболее подходящий hello, который лучше всего подходит для рабочей нагрузки. Убедитесь, что недоступна достаточную пропускную способность трафика диска виртуальной Машины toodrive hello.

#### <a name="disk-sizes"></a>Размеры диска
Существуют пять типов дисков, которые можно использовать с виртуальной машиной. Для каждого из них действуют определенные ограничения на количество операций ввода-вывода в секунду и пропускную способность. При выборе типа hello диска для виртуальной Машины исходя из потребностей hello приложения с точки зрения производительности, производительность, масштабируемость и пиковых нагрузок учитывайте эти ограничения.

| Диски уровня "Премиум"  | P10   | P20   | P30            | P40            | P50            | 
|:-------------------:|:-----:|:-----:|:--------------:|:--------------:|:--------------:|
| Размер диска           | 128 ГБ| 512 ГБ| 1024 ГБ (1 ТБ) | 2048 ГБ (2 ТБ) | 4095 ГБ (4 ТБ) | 
| Количество операций ввода-вывода в секунду на диск       | 500   | 2300  | 5000           | 7500           | 7500           | 
| Пропускная способность на диск | 100 МБ в секунду | 150 МБ в секунду | 200 МБ в секунду | 250 МБ в секунду | 250 МБ в секунду |

В зависимости от рабочей нагрузки определите, требуются ли дополнительные диски данных для виртуальной машины. Можно присоединить несколько tooyour дисков постоянных данных виртуальной Машины. При необходимости вы можете создать чередующийся через hello дисков tooincrease hello емкости и производительности hello тома. (Дополнительные сведения о чередовании дисков см. [здесь](storage-premium-storage-performance.md#disk-striping).) Если вы создаете чередующийся том на дисках данных хранилища уровня "Премиум" с помощью [дисковых пространств][4], то необходимо настроить по одному столбцу для каждого используемого диска. В противном случае hello общую производительность hello чередующемся томе может быть ниже, чем ожидается, из-за toouneven распределение трафика между дисками hello. Для виртуальных машин Linux можно использовать hello *mdadm* tooachieve программа hello таким же. Дополнительные сведения см. в статье [Настройка программного RAID-массива в Linux](../virtual-machines/linux/configure-raid.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

#### <a name="storage-account-scalability-targets"></a>Целевые показатели масштабируемости для учетной записи хранения
Учетные записи хранения Premium имеют следующие целевые показатели масштабируемости в toohello сложения hello [целевые показатели производительности и масштабируемости хранилища Azure](storage-scalability-targets.md). Если требования вашего приложения превышают целевые показатели масштабируемости hello единым хранилища учетной записи, сборка toouse вашего приложения несколькими учетными записями хранения и секционировать данные по этим учетных записям хранения.

| Общая емкость учетной записи | Общая пропускная способность для учетной записи локально избыточного хранилища |
|:--- |:--- |
| Емкость диска: 35 ТБ<br />Емкость для моментальных снимков: 10 ТБ |Копирование too50 гигабит в секунду входящие + исходящие |

Для hello Дополнительные сведения о спецификациях хранилище Premium, ознакомьтесь с [масштабируемость и целевые показатели производительности при использовании хранилища Premium](storage-premium-storage.md#scalability-and-performance-targets).

#### <a name="disk-caching-policy"></a>Политика кэширования дисков
По умолчанию политика кэширования диска — *только для чтения* для всех hello Premium дисков с данными и *чтения и записи* для диска операционной системы Premium hello присоединенного toohello виртуальной Машины. Этот параметр конфигурации рекомендуется tooachieve hello оптимальную производительность операций ввода-вывода приложения. Отключите кэширование дисков данных, которые отличаются высокой интенсивностью записи или используются только для записи (например, файлов журналов SQL Server), чтобы улучшить производительность приложения. Параметры кэша Hello для существующих дисков данных можно обновить с помощью [портала Azure](https://portal.azure.com) или hello *- HostCaching* параметр hello *Set-AzureDataDisk* командлета.

#### <a name="location"></a>Расположение
Выберите расположение, где доступно хранилище Azure Premium. Актуальные сведения о доступных расположениях см. на странице [Доступность продуктов по регионам](https://azure.microsoft.com/regions/#services). Виртуальные машины находятся в hello же региона, как hello учетной записи хранилища, что магазины hello дисков для hello ВМ обеспечит гораздо более высокую производительность, чем если они находятся в отдельные области.

#### <a name="other-azure-vm-configuration-settings"></a>Прочие параметры конфигурации виртуальной машины Azure
При создании виртуальной Машины Azure, будет задаваемые tooconfigure некоторые параметры виртуальной Машины. Помните, что некоторые параметры имеют фиксированное время существования hello hello виртуальной Машины, хотя можно изменить или добавить другие позже. Просмотрите эти параметры конфигурации виртуальной Машины Azure и убедитесь в том, что они настроены правильно toomatch требований рабочей нагрузки.

### <a name="optimization"></a>Оптимизация
В статье [Хранилище Azure класса «Премиум»: разработка, обеспечивающая повышенную производительность](storage-premium-storage-performance.md) приведены рекомендации по разработке высокопроизводительных приложений с использованием хранилища Azure класса Premium. Можно следовать правилам hello, в сочетании с производительности лучшие методики применимо tootechnologies, используемого приложением.

## <a name="prepare-and-copy-virtual-hard-disks-VHDs-to-premium-storage"></a>Подготовка и скопируйте виртуальные жесткие диски (VHD) tooPremium хранилища
Hello в следующем разделе содержатся рекомендации по подготовке виртуальных жестких дисков из виртуальной Машины и копирование виртуальных жестких дисков tooAzure хранилища.

* [Сценарий 1: «я перехожу существующих виртуальных машинах Azure tooAzure хранилище Premium.»](#scenario1)
* [Сценарий 2: «я перехожу виртуальные машины из других платформ tooAzure хранилище Premium.»](#scenario2)

### <a name="prerequisites"></a>Предварительные требования
hello tooprepare виртуальные жесткие диски для миграции, необходимо:

* Подписка Azure, учетной записи хранилища и контейнера в этом хранилище учетной записи toowhich, можно скопировать вашего виртуального жесткого диска. Обратите внимание, что hello целевой учетной записью хранения может быть учетной записью Standard или Premium хранилища, в зависимости от ваших требований.
* Hello toogeneralize средство виртуального жесткого диска, если планируется toocreate несколько экземпляров виртуальных Машин из него. Например, sysprep для Windows или virt-sysprep для Ubuntu.
* Средство tooupload hello VHD файл toohello учетной записи хранилища. В разделе [перенесите данные с помощью служебной программы командной строки AzCopy hello](storage-use-azcopy.md) или использовать [обозреватель хранилища Azure](http://blogs.msdn.com/b/windowsazurestorage/archive/2014/03/11/windows-azure-storage-explorers-2014.aspx). В этом руководстве описано копирование вашего виртуального жесткого диска, с помощью инструмента AzCopy hello.

> [!NOTE]
> При выборе параметра синхронного копирования с помощью AzCopy, для обеспечения оптимальной производительности, скопируйте вашего виртуального жесткого диска, выполнив одно из этих средств из виртуальной Машины Azure, hello же регионе, что hello целевой учетной записью хранения. При копировании виртуального жесткого диска из виртуальной машины Azure в другом регионе производительность может быть ниже.
>
> При копировании ограниченной пропускной способностью большой объем данных, рассмотрите возможность [tooBlob hello импорта и экспорта Azure службы tootransfer данные хранилища с помощью](storage-import-export-service.md); это позволяет tootransfer tooan Azure диски данных путем доставки жесткого диска Центр обработки данных. Можно использовать hello импорта и экспорта Azure toocopy данных tooa стандартное хранилище учетной записи службы только. После hello данные хранятся в учетной записи хранения standard, можно использовать либо hello [API копирования BLOB-объектов](https://msdn.microsoft.com/library/azure/dd894037.aspx) или AzCopy tootransfer hello данных tooyour premium учетной записи хранилища.
>
> Обратите внимание, что Microsoft Azure поддерживает только файлы виртуальных жестких дисков фиксированного размера. VHDX-файлы или динамические виртуальные жесткие диски не поддерживаются. При наличии динамического виртуального жесткого диска, можно преобразовать его с помощью hello размер toofixed [Convert-VHD](http://technet.microsoft.com/library/hh848454.aspx) командлета.
>
>

### <a name="scenario1"></a>Сценарий 1: «я перехожу существующих виртуальных машинах Azure tooAzure хранилище Premium.»
При переносе существующих виртуальных машинах Azure, hello остановка виртуальной Машины, виртуальные жесткие диски каждого типа hello виртуального жесткого диска, необходимо подготовить и скопируйте hello виртуального жесткого диска с помощью AzCopy или PowerShell.

Hello виртуальной Машины должен toobe полностью вниз toomigrate исходное состояние. До завершения миграции hello будет простоя.

#### <a name="step-1-prepare-vhds-for-migration"></a>Шаг 1. Подготовка VHD к переносу
При переносе существующих виртуальных машинах Azure tooPremium хранилища, то виртуальный ДИСК может быть:

* обобщенный образ операционной системы;
* уникальный диск операционной системы;
* диск данных.

Ниже рассмотрены три соответствующих сценария подготовки VHD.

##### <a name="use-a-generalized-operating-system-vhd-toocreate-multiple-vm-instances"></a>Использовать несколько экземпляров ВМ обобщенный toocreate виртуального жесткого диска операционной системы
При выгрузке виртуального жесткого диска, который будет использоваться toocreate несколько экземпляров универсального виртуальной Машине Azure, сначала необходимо обобщить виртуального жесткого диска с помощью программы sysprep. Это относится tooa виртуального жесткого диска, локально или в облаке hello. Удаляются все сведения, относящиеся к машине из hello виртуального жесткого диска.

> [!IMPORTANT]
> Создайте моментальный снимок или резервную копию виртуальной машины перед ее обобщением. Выполнение средства sysprep будет останавливать и освобождать hello экземпляр виртуальной Машины. Выполните действия ниже toosysprep виртуального жесткого диска операционной системы Windows. Обратите внимание, что выполнив команду Sysprep hello потребует tooshut работу виртуальной машины hello. Дополнительные сведения о команде Sysprep см. в разделах [Обзор Sysprep](http://technet.microsoft.com/library/hh825209.aspx) или [Технический справочник по Sysprep](http://technet.microsoft.com/library/cc766049.aspx).
>
>

1. Откройте окно командной строки с правами администратора.
2. Введите следующая команда tooopen Sysprep hello:

    ```
    %windir%\system32\sysprep\sysprep.exe
    ```

3. В hello средство подготовки системы, выберите выберите Enter System Out-of-Box Experience (OOBE), выберите hello Generalize флажок **завершение работы**, а затем нажмите кнопку **ОК**, как показано в приведенном ниже рисунке hello. Sysprep будет generalize hello операционной системы и завершение работы системы hello.

    ![][1]

Для Виртуальной машине Ubuntu используйте virt sysprep tooachieve hello таким же. Дополнительные сведения см. в разделе [virt-sysprep](http://manpages.ubuntu.com/manpages/precise/man1/virt-sysprep.1.html). См. также некоторые Привет открыть источник [Подготовка сервера Linux программного обеспечения](http://www.cyberciti.biz/tips/server-provisioning-software.html) для других операционных систем Linux.

##### <a name="use-a-unique-operating-system-vhd-toocreate-a-single-vm-instance"></a>Используйте уникальный toocreate виртуального жесткого диска операционной системы один экземпляр виртуальной Машины
При наличии приложения, работающего на ВМ, для которой требуются определенные данные машина hello hello не подходит hello виртуального жесткого диска. Специализированного виртуального жесткого диска можно использовать toocreate уникальный экземпляр виртуальной Машины Azure. Например, при наличии контроллера домена на вашем виртуальном жестком диске выполнение команды sysprep сделает его неэффективным в качестве контроллера домена. Просмотрите hello приложений, выполняющихся на вашей виртуальной Машины и hello влияние запуск sysprep в их перед обобщение hello виртуального жесткого диска.

##### <a name="register-data-disk-vhd"></a>Регистрация VHD в качестве диска данных
Если диски с данными в Azure toobe миграции, необходимо убедиться, что hello виртуальных машин, использующих эти диски, завершают работу данных.

Выполните описанные ниже tooAzure VHD toocopy хранилище Premium действия hello и зарегистрировать его в качестве диска подготовленных данных.

#### <a name="step-2-create-hello-destination-for-your-vhd"></a>Шаг 2. Создание назначения hello для вашего виртуального жесткого диска
Создайте учетную запись хранения для обслуживания виртуальных жестких дисков. Рассмотрим следующие точки при планировании расположения hello toostore виртуальные жесткие диски:

* Hello целевой учетной записи хранения Premium.
* расположение учетной записи хранения Hello должен быть такой же, как хранилище Premium поддерживает виртуальные машины Azure создаст заключительном этапе hello. Можно скопировать tooa новой учетной записи хранения или учетную запись хранения зависимости от потребностей hello toouse плана.
* Скопируйте и сохраните ключ учетной записи хранения hello учетной записи хранения hello назначения для следующего этапа hello.

Для дисков данных вы можете tookeep некоторые диски с данными в стандартном хранилище учетной записи (например, диски, имеющие охлаждающего хранилище), но настоятельно рекомендуется переместить все данные хранилища уровня premium toouse рабочей нагрузки.

#### <a name="copy-vhd-with-azcopy-or-powershell"></a>Шаг 3. Копирование VHD с помощью AzCopy или PowerShell
Необходимо будет toofind путь контейнера и хранения данных учетной записи ключа tooprocess любой из этих двух параметров. (выберите **Портал Azure** > **Хранилище**, чтобы узнать их). URL-адрес контейнера Hello будет отображаться как «https://myaccount.blob.core.windows.net/mycontainer/».

##### <a name="option-1-copy-a-vhd-with-azcopy-asynchronous-copy"></a>Способ 1. Копирование VHD с помощью AzCopy (асинхронное копирование)
С помощью AzCopy, который можно передать hello виртуальный жесткий ДИСК через Интернет hello. В зависимости от размера hello hello виртуальные жесткие диски это может занять время. При использовании этого параметра следует помните ограничения Исходящие и входящие данные учетной записи хранения toocheck hello. Дополнительные сведения см. в статье [Целевые показатели производительности и масштабируемости службы хранилища Azure](storage-scalability-targets.md).

1. Загрузите и установите AzCopy по ссылке: [последняя версия AzCopy](http://aka.ms/downloadazcopy)
2. Откройте Azure PowerShell и перейдите toohello папка, содержащая AzCopy.
3. Используйте hello следующая команда toocopy hello VHD-файл из «Источник» слишком «Назначение».

    ```azcopy
    AzCopy /Source: <source> /SourceKey: <source-account-key> /Dest: <destination> /DestKey: <dest-account-key> /BlobType:page /Pattern: <file-name>
    ```

    Пример:

    ```azcopy
    AzCopy /Source:https://sourceaccount.blob.core.windows.net/mycontainer1 /SourceKey:key1 /Dest:https://destaccount.blob.core.windows.net/mycontainer2 /DestKey:key2 /Pattern:abc.vhd
    ```

    Ниже приведены описания параметров hello, используемых в hello команды AzCopy.

   * **-Источник:  *&lt;источника&gt;:***  hello папки или URL-адрес хранилища контейнер, содержащий hello виртуального жесткого диска.
   * **/ SourceKey:  *&lt;ключ учетной записи источника&gt;:***  ключ учетной записи хранилища учетной записи хранения источника hello.
   * **/ Dest:  *&lt;назначения&gt;:***  toocopy URL-адрес контейнера хранилища hello виртуального жесткого диска.
   * **/ DestKey:  *&lt;ключ для учетной записи dest&gt;:***  ключ учетной записи хранилища учетной записи хранения назначения hello.
   * **Или: шаблон  *&lt;имя файла&gt;:***  укажите имя файла hello toocopy hello виртуального жесткого диска.

Дополнительные сведения об использовании AzCopy инструментов см. в разделе [перенесите данные с помощью служебной программы командной строки AzCopy hello](storage-use-azcopy.md).

##### <a name="option-2-copy-a-vhd-with-powershell-synchronized-copy"></a>Способ 2. Копирование VHD с помощью PowerShell (синхронное копирование)
Также можно скопировать hello VHD-файл с помощью командлета PowerShell hello AzureStorageBlobCopy запуска. Используйте следующую команду на Azure PowerShell toocopy VHD hello. Замените значения hello в угловых скобках соответствующими значениями из источника и назначения учетной записи хранилища. toouse эту команду, необходимо иметь контейнер с именем виртуальные жесткие диски в целевой учетной записью хранения. Если контейнер hello не существует, создайте его перед выполнением команды hello.

```powershell
$sourceBlobUri = <source-vhd-uri>

$sourceContext = New-AzureStorageContext  –StorageAccountName <source-account> -StorageAccountKey <source-account-key>

$destinationContext = New-AzureStorageContext  –StorageAccountName <dest-account> -StorageAccountKey <dest-account-key>

Start-AzureStorageBlobCopy -srcUri $sourceBlobUri -SrcContext $sourceContext -DestContainer <dest-container> -DestBlob <dest-disk-name> -DestContext $destinationContext
```

Пример:

```powershell
C:\PS> $sourceBlobUri = "https://sourceaccount.blob.core.windows.net/vhds/myvhd.vhd"

C:\PS> $sourceContext = New-AzureStorageContext  –StorageAccountName "sourceaccount" -StorageAccountKey "J4zUI9T5b8gvHohkiRg"

C:\PS> $destinationContext = New-AzureStorageContext  –StorageAccountName "destaccount" -StorageAccountKey "XZTmqSGKUYFSh7zB5"

C:\PS> Start-AzureStorageBlobCopy -srcUri $sourceBlobUri -SrcContext $sourceContext -DestContainer "vhds" -DestBlob "myvhd.vhd" -DestContext $destinationContext
```

### <a name="scenario2"></a>Сценарий 2: «я перехожу виртуальные машины из других платформ tooAzure хранилище Premium.»
При переносе виртуального жесткого диска из tooAzure не Azure облачного хранилища, необходимо экспортировать hello VHD tooa локальный каталог. Полный исходный путь hello hello локальный каталог, где хранится под рукой виртуального жесткого диска, а затем с помощью AzCopy tooupload его tooAzure хранилища.

#### <a name="step-1-export-vhd-tooa-local-directory"></a>Шаг 1. Экспорт локальный каталог tooa виртуального жесткого диска
##### <a name="copy-a-vhd-from-aws"></a>Копирование VHD из AWS
1. Если вы используете AWS, экспортируйте hello EC2 экземпляр tooa виртуального жесткого диска в сегмент Amazon S3. Следуйте hello действия, описанные в документации Amazon для экспорта экземпляров EC2 Amazon tooinstall hello Amazon EC2 командной строки (CLI) средства hello и запустите hello команда создания экземпляра export задач tooexport hello EC2 экземпляр tooa VHD-файл. Быть убедиться, что toouse **VHD** для hello диска &#95; образ &#95; ФОРМАТ переменной при выполнении hello **создания экземпляра export задач** команды. Hello экспортированный файл VHD сохраняется в контейнере hello Amazon S3, определенное во время этого процесса.

    ```
    aws ec2 create-instance-export-task --instance-id ID --target-environment TARGET_ENVIRONMENT \
      --export-to-s3-task DiskImageFormat=DISK_IMAGE_FORMAT,ContainerFormat=ova,S3Bucket=BUCKET,S3Prefix=PREFIX
    ```

2. Загрузите файл виртуального жесткого диска hello с сегмент S3 hello. Выберите hello VHD-файл, затем **действия** > **загрузить**.

    ![][3]

##### <a name="copy-a-vhd-from-other-non-azure-cloud"></a>Копирование VHD из облака (вне Azure)
При переносе виртуального жесткого диска из tooAzure не Azure облачного хранилища, необходимо экспортировать hello VHD tooa локальный каталог. Скопируйте полный исходный путь hello hello локальный каталог, где хранится виртуальный жесткий ДИСК.

##### <a name="copy-a-vhd-from-on-premises"></a>Копирование VHD из локальной среды
Если вы переносите VHD из локальной среды, необходимо будет hello полный исходный путь, где хранится виртуальный жесткий ДИСК. Hello исходный путь может быть server расположение или в общей папке.

#### <a name="step-2-create-hello-destination-for-your-vhd"></a>Шаг 2. Создание назначения hello для вашего виртуального жесткого диска
Создайте учетную запись хранения для обслуживания виртуальных жестких дисков. Рассмотрим следующие точки при планировании расположения hello toostore виртуальные жесткие диски:

* Hello целевой учетной записи хранения может быть стандартного или расширенного хранилища в зависимости от требований приложения.
* Хранилище Premium поддерживает виртуальные машины Azure создаст заключительном этапе hello должен совпадать Hello регион учетной записи хранения. Можно скопировать tooa новой учетной записи хранения или учетную запись хранения зависимости от потребностей hello toouse плана.
* Скопируйте и сохраните ключ учетной записи хранения hello учетной записи хранения hello назначения для следующего этапа hello.

Мы настоятельно рекомендуем вам перемещение всех данных для хранения premium toouse рабочей рабочей нагрузки.

#### <a name="step-3-upload-hello-vhd-tooazure-storage"></a>Шаг 3. Отправка VHD hello tooAzure хранилища
Теперь, когда имеется вашего виртуального жесткого диска в локальном каталоге hello, можно использовать AzCopy или AzurePowerShell tooupload hello .vhd файл tooAzure хранилища. Это можно сделать двумя способами.

##### <a name="option-1-using-azure-powershell-add-azurevhd-tooupload-hello-vhd-file"></a>Вариант 1: С помощью Azure PowerShell Add-AzureVhd tooupload hello VHD-файл

```powershell
Add-AzureVhd [-Destination] <Uri> [-LocalFilePath] <FileInfo>
```

Пример <Uri> может выглядеть следующим образом: ***https://storagesample.blob.core.windows.net/mycontainer/blob1.vhd***. Пример <FileInfo>: ***C:\path\to\upload.vhd***.

##### <a name="option-2-using-azcopy-tooupload-hello-vhd-file"></a>Вариант 2: С помощью AzCopy tooupload hello VHD-файл
С помощью AzCopy, который можно передать hello виртуальный жесткий ДИСК через Интернет hello. В зависимости от размера hello hello виртуальные жесткие диски это может занять время. При использовании этого параметра следует помните ограничения Исходящие и входящие данные учетной записи хранения toocheck hello. Дополнительные сведения см. в статье [Целевые показатели производительности и масштабируемости службы хранилища Azure](storage-scalability-targets.md).

1. Загрузите и установите AzCopy по ссылке: [последняя версия AzCopy](http://aka.ms/downloadazcopy)
2. Откройте Azure PowerShell и перейдите toohello папка, содержащая AzCopy.
3. Используйте hello следующая команда toocopy hello VHD-файл из «Источник» слишком «Назначение».

    ```azcopy
    AzCopy /Source: <source> /SourceKey: <source-account-key> /Dest: <destination> /DestKey: <dest-account-key> /BlobType:page /Pattern: <file-name>
    ```

    Пример:

    ```azcopy
    AzCopy /Source:https://sourceaccount.blob.core.windows.net/mycontainer1 /SourceKey:key1 /Dest:https://destaccount.blob.core.windows.net/mycontainer2 /DestKey:key2 /BlobType:page /Pattern:abc.vhd
    ```

    Ниже приведены описания параметров hello, используемых в hello команды AzCopy.

   * **-Источник:  *&lt;источника&gt;:***  hello папки или URL-адрес хранилища контейнер, содержащий hello виртуального жесткого диска.
   * **/ SourceKey:  *&lt;ключ учетной записи источника&gt;:***  ключ учетной записи хранилища учетной записи хранения источника hello.
   * **/ Dest:  *&lt;назначения&gt;:***  toocopy URL-адрес контейнера хранилища hello виртуального жесткого диска.
   * **/ DestKey:  *&lt;ключ для учетной записи dest&gt;:***  ключ учетной записи хранилища учетной записи хранения назначения hello.
   * **/ BlobType: страница:** указывает указанное назначение hello страничного большого двоичного объекта.
   * **Или: шаблон  *&lt;имя файла&gt;:***  укажите имя файла hello toocopy hello виртуального жесткого диска.

Дополнительные сведения об использовании AzCopy инструментов см. в разделе [перенесите данные с помощью служебной программы командной строки AzCopy hello](storage-use-azcopy.md).

##### <a name="other-options-for-uploading-a-vhd"></a>Другие возможности загрузки виртуального жесткого диска
Можно также передать учетную запись хранения tooyour виртуального жесткого диска с помощью одного из hello следующие средства:

* [API копирования BLOB-объекта хранилища Azure](https://msdn.microsoft.com/library/azure/dd894037.aspx)
* [Обозреватель хранилищ Azure для передачи больших двоичных объектов](https://azurestorageexplorer.codeplex.com/)
* [Справочник по API REST служб хранилища импорта и экспорта](https://msdn.microsoft.com/library/dn529096.aspx)

> [!NOTE]
> Мы рекомендуем использовать службу импорта и экспорта, если предполагаемое время передачи больше 7 дней. Можно использовать [DataTransferSpeedCalculator](https://github.com/Azure-Samples/storage-dotnet-import-export-job-management/blob/master/DataTransferSpeedCalculator.html) tooestimate время hello из единицу размера и передачи данных.
>
> Импорт и экспорт можно использовать toocopy tooa Стандартная учетная запись хранения. Вам потребуется toocopy из учетной записи хранения toopremium стандартного хранилища с помощью таких средств, как AzCopy.
>
>

## <a name="create-azure-virtual-machine-using-premium-storage"></a>Создание виртуальной машины Azure с использованием хранилища Premium
После учетной записи хранения загруженного или скопированного toohello требуемого hello виртуального жесткого диска следуйте инструкциям hello в этот раздел tooregister hello VHD как образ ОС или диска ОС, в зависимости от вашего сценария, а затем создайте экземпляр виртуальной Машины из него. Hello диск данных виртуального жесткого диска может быть вложенного toohello виртуальной Машины, после его создания.
В конце hello в этом разделе предоставляется пример сценария миграции. Это простой скрипт, и он подходит не для всех сценариев. Может потребоваться сценарий toomatch tooupdate hello с конкретного сценария. см. ниже toosee, если этот сценарий применяется сценарий tooyour [сценарий миграции](#a-sample-migration-script).

### <a name="checklist"></a>Контрольный список
1. Подождать, пока все диски VHD hello копирования завершена.
2. Убедитесь, что хранилище Premium доступно в области hello, которую вы переносите.
3. Решите, Серия виртуальных Машин новый hello, который будет использоваться. Должно быть хранения Premium может и hello размер должен быть в зависимости от доступности hello в регионе hello и зависимости от потребностей.
4. Выберите размер виртуальной Машины точное hello, который будет использоваться. Размер виртуальной Машины должен toobe достаточно большой toosupport hello количество дисков данных вами. Например:  При наличии 4 диска данных hello ВМ необходимо иметь 2 или более ядер. Кроме того, учитывайте требования к вычислительной мощности, памяти и пропускной способности сети.
5. Создайте учетную запись хранения Premium в целевой области hello. Это hello учетная запись будет использоваться для hello новой виртуальной Машины.
6. Иметь hello текущей виртуальной Машины сведений под рукой, включая hello список дисков и соответствующих больших двоичных объектов VHD.

Подготовьте приложение к простою. toodo очистить миграции у вас toostop вся обработка hello в текущей системе hello. Только после этого можно получить его состояние tooconsistent, который можно перенести toohello новой платформы. Длительность времени простоя будет зависеть от hello объем данных в toomigrate диски hello.

> [!NOTE]
> При создании виртуальной Машины диспетчера ресурсов Azure из специализированного диска VHD можно найти слишком[этот шаблон](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-specialized-vhd) для развертывания виртуальных Машин диспетчера ресурсов с помощью существующего диска.
>
>

### <a name="register-your-vhd"></a>Регистрация виртуального жесткого диска
toocreate виртуальной Машины из виртуального жесткого диска операционной системы или диска данных tooa tooattach новой виртуальной Машины, необходимо сначала зарегистрировать их. Выполните приведенные ниже шаги в зависимости от сценария VHD.

#### <a name="generalized-operating-system-vhd-toocreate-multiple-azure-vm-instances"></a>Обобщенный виртуальный жесткий ДИСК операционной системы toocreate несколько экземпляров виртуальной Машины Azure
После передачи обобщенный образ ОС, виртуального жесткого диска является учетная запись хранения toohello зарегистрировать ее в качестве **образа виртуальной Машины Azure** , чтобы один или несколько экземпляров виртуальной Машины можно создать из него. Используйте следующие tooregister командлеты PowerShell hello вашего виртуального жесткого диска как образ ОС виртуальной Машины Azure. Укажите полный контейнера hello URL-адрес, где виртуальный жесткий ДИСК был скопирован.

```powershell
Add-AzureVMImage -ImageName "OSImageName" -MediaLocation "https://storageaccount.blob.core.windows.net/vhdcontainer/osimage.vhd" -OS Windows
```

Скопируйте и сохраните имя hello этот новый образ виртуальной Машины Azure. В приведенном выше примере hello, это *OSImageName*.

#### <a name="unique-operating-system-vhd-toocreate-a-single-azure-vm-instance"></a>Уникальный виртуального жесткого диска операционной системы toocreate один экземпляр виртуальной Машины Azure
После hello уникальный виртуального жесткого диска ОС — хранилище отправленного toohello учетной записи, зарегистрируйте его как **диска ОС Azure** , чтобы экземпляр виртуальной Машины можно создать из него. Используйте эти tooregister командлеты PowerShell вашего виртуального жесткого диска в качестве диска ОС Azure. Укажите полный контейнера hello URL-адрес, где виртуальный жесткий ДИСК был скопирован.

```powershell
Add-AzureDisk -DiskName "OSDisk" -MediaLocation "https://storageaccount.blob.core.windows.net/vhdcontainer/osdisk.vhd" -Label "My OS Disk" -OS "Windows"
```

Скопируйте и сохраните имя hello этот новый диск ОС Azure. В приведенном выше примере hello, это *OSDisk*.

#### <a name="data-disk-vhd-toobe-attached-toonew-azure-vm-instances"></a>Toobe виртуального жесткого диска для диска данных присоединенного toonew экземпляры виртуальной Машины Azure
После hello диск данных виртуального жесткого диска является передачи toostorage учетной записью, зарегистрировать его в качестве диска данных Azure, чтобы он мог быть вложенного tooyour новой серии DS, серии DSv2 ряда или экземпляра виртуальной Машины Azure серии GS.

Используйте эти tooregister командлеты PowerShell вашего виртуального жесткого диска в качестве диска данных Azure. Укажите полный контейнера hello URL-адрес, где виртуальный жесткий ДИСК был скопирован.

```powershell
Add-AzureDisk -DiskName "DataDisk" -MediaLocation "https://storageaccount.blob.core.windows.net/vhdcontainer/datadisk.vhd" -Label "My Data Disk"
```

Скопируйте и сохраните hello имя для этого нового диска данных Azure. В приведенном выше примере hello, это *DataDisk*.

### <a name="create-a-premium-storage-capable-vm"></a>Создание виртуальной машины, поддерживающей хранилище класса Premium
Один раз hello образ ОС или диска ОС зарегистрированы, создать новый серии DS, серии DSv2 ряда или виртуальных Машин серии GS. Вы используете образ операционной системы hello или имя диска операционной системы, которое вы зарегистрировали. Выберите тип hello виртуальной Машины из уровня хранилища Premium hello. В приведенном ниже примере мы используем hello *Standard_DS2* размер виртуальной Машины.

> [!NOTE]
> Обновите том, что он соответствует емкости и требований к производительности и размеры hello Azure свободного toomake размер диска hello.
>
>

Командлеты PowerShell выполните hello шаг за шагом ниже toocreate hello новой виртуальной Машины. Во-первых можно задать общие параметры hello:

```powershell
$serviceName = "yourVM"
$location = "location-name" (e.g., West US)
$vmSize ="Standard_DS2"
$adminUser = "youradmin"
$adminPassword = "yourpassword"
$vmName ="yourVM"
$vmSize = "Standard_DS2"
```

Сначала создайте облачную службу, в которой будут размещаться новые виртуальные машины.

```powershell
New-AzureService -ServiceName $serviceName -Location $location
```

В зависимости от вашего сценария, создайте экземпляр виртуальной Машины Azure hello из либо hello образ ОС или диска ОС, которое вы зарегистрировали.

#### <a name="generalized-operating-system-vhd-toocreate-multiple-azure-vm-instances"></a>Обобщенный виртуальный жесткий ДИСК операционной системы toocreate несколько экземпляров виртуальной Машины Azure
Создать один или несколько новых виртуальных Машин Azure серии DS экземпляров с помощью hello hello **образа ОС Azure** которого вы зарегистрировали. Укажите имя этого образа ОС в конфигурации виртуальной Машины hello, при создании новой виртуальной Машины, как показано ниже.

```powershell
$OSImage = Get-AzureVMImage –ImageName "OSImageName"

$vm = New-AzureVMConfig -Name $vmName –InstanceSize $vmSize -ImageName $OSImage.ImageName

Add-AzureProvisioningConfig -Windows –AdminUserName $adminUser -Password $adminPassword –VM $vm

New-AzureVM -ServiceName $serviceName -VM $vm
```

#### <a name="unique-operating-system-vhd-toocreate-a-single-azure-vm-instance"></a>Уникальный виртуального жесткого диска операционной системы toocreate один экземпляр виртуальной Машины Azure
Создание нового доменных служб Active Directory виртуальной Машины Azure экземпляра ряда с помощью hello **диска ОС Azure** которого вы зарегистрировали. Укажите имя этого диска ОС в конфигурации виртуальной Машины hello при создании hello новой виртуальной Машины, как показано ниже.

```powershell
$OSDisk = Get-AzureDisk –DiskName "OSDisk"

$vm = New-AzureVMConfig -Name $vmName -InstanceSize $vmSize -DiskName $OSDisk.DiskName

New-AzureVM -ServiceName $serviceName –VM $vm
```

Укажите другие сведения о виртуальной машине Azure, например: облачную службу, регион, учетную запись хранения, группу доступности и политику кэширования. Заметьте, что экземпляр виртуальной Машины hello должна быть совмещена с операционной системой, или диски с данными, поэтому hello выбран облачной службы, регион и учетную запись хранилища должен быть в hello местоположения hello базовые виртуальные жесткие диски таких дисков.

### <a name="attach-data-disk"></a>Присоединение диска данных
Наконец, если вы зарегистрировали данных диск VHD, присоедините их toohello нового хранилище Premium поддерживает виртуальной Машине Azure.

Использовать следующий PowerShell командлет tooattach данных диска toohello новой виртуальной Машины и укажите hello политика кэширования. В примере ниже hello политика кэширования задается слишком*ReadOnly*.

```powershell
$vm = Get-AzureVM -ServiceName $serviceName -Name $vmName

Add-AzureDataDisk -ImportFrom -DiskName "DataDisk" -LUN 0 –HostCaching ReadOnly –VM $vm

Update-AzureVM  -VM $vm
```

> [!NOTE]
> Может быть toosupport необходимые дополнительные действия приложения, не будут рассмотрены в данном руководстве.
>
>

### <a name="checking-and-plan-backup"></a>Проверка и планирование резервного копирования
Один раз приветствия работает Новая виртуальная машина запущена, доступ с помощью hello же идентификатор входа и пароль как hello исходной виртуальной Машины и убедитесь, что все работает должным образом. Все настройки hello, включая hello чередующимися томами, может присутствовать в hello новой виртуальной Машины.

Последний шаг Hello — tooplan расписание резервного копирования и обслуживания для новой виртуальной Машины в зависимости от потребностей приложения hello hello.

### <a name="a-sample-migration-script"></a>Пример скрипта переноса
При наличии нескольких виртуальных машин toomigrate пригодятся автоматизации с помощью сценариев PowerShell. Ниже приведен пример сценария, который автоматизирует процесс миграции hello виртуальной машины. Обратите внимание, ниже сценарий — пример и существуют некоторые предположения о hello текущего дисков виртуальной Машины. Может потребоваться сценарий toomatch tooupdate hello с конкретного сценария.

допущения Hello являются:

* Вы создаете классическую виртуальную машину Azure.
* Исходные диски операционной системы и диски данных находятся в одной учетной записи хранения и одном контейнере. Если диски ОС и диски с данными не находятся в hello же поместить, можно использовать AzCopy или Azure PowerShell toocopy виртуальные жесткие диски по контейнеров и учетных записей хранилища. См. предыдущий шаг toohello: [копирования VHD с помощью AzCopy или PowerShell](#copy-vhd-with-azcopy-or-powershell). Редактирование toomeet этот скрипт сценария является выбор другого, но мы рекомендуем использовать AzCopy или PowerShell, так как это проще и быстрее.

сценарий автоматизации Hello приведена ниже. Замените текст своими данными и обновляют toomatch сценария hello конкретного сценария.

> [!NOTE]
> С помощью существующего скрипта hello не сохраняет hello сетевая конфигурация источника данных виртуальной Машины. Вам потребуется toore-config hello сетевых параметров на перенесенных виртуальных машин.
>
>

```
    <#
    .Synopsis
    This script is provided as an EXAMPLE tooshow how toomigrate a VM from a standard storage account tooa premium storage account. You can customize it according tooyour specific requirements.

    .Description
    hello script will copy hello vhds (page blobs) of hello source VM toohello new storage account.
    And then it will create a new VM from these copied vhds based on hello inputs that you specified for hello new VM.
    You can modify hello script toosatisfy your specific requirement, but please be aware of hello items specified
    in hello Terms of Use section.

    .Terms of Use
    Copyright © 2015 Microsoft Corporation.  All rights reserved.

    THIS CODE AND ANY ASSOCIATED INFORMATION ARE PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND,
    EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED toohello IMPLIED WARRANTIES OF MERCHANTABILITY
    AND/OR FITNESS FOR A PARTICULAR PURPOSE. hello ENTIRE RISK OF USE, INABILITY tooUSE, OR
    RESULTS FROM hello USE OF THIS CODE REMAINS WITH hello USER.

    .Example (Save this script as Migrate-AzureVM.ps1)

    .\Migrate-AzureVM.ps1 -SourceServiceName CurrentServiceName -SourceVMName CurrentVMName –DestStorageAccount newpremiumstorageaccount -DestServiceName NewServiceName -DestVMName NewDSVMName -DestVMSize "Standard_DS2" –Location "Southeast Asia"

    .Link
    toofind more information about how tooset up Azure PowerShell, refer toohello following links.
    http://azure.microsoft.com/documentation/articles/powershell-install-configure/
    http://azure.microsoft.com/documentation/articles/storage-powershell-guide-full/
    http://azure.microsoft.com/blog/2014/10/22/migrate-azure-virtual-machines-between-storage-accounts/

    #>

    Param(
    # hello cloud service name of hello VM.
    [Parameter(Mandatory = $true)]
    [string] $SourceServiceName,

    # hello VM name toocopy.
    [Parameter(Mandatory = $true)]
    [String] $SourceVMName,

    # hello destination storage account name.
    [Parameter(Mandatory = $true)]
    [String] $DestStorageAccount,

    # hello destination cloud service name
    [Parameter(Mandatory = $true)]
    [String] $DestServiceName,

    # hello destination vm name
    [Parameter(Mandatory = $true)]
    [String] $DestVMName,

    # hello destination vm size
    [Parameter(Mandatory = $true)]
    [String] $DestVMSize,

    # hello location of destination VM.
    [Parameter(Mandatory = $true)]
    [string] $Location,

    # whether or not toocopy hello os disk, hello default is only copy data disks
    [Parameter(Mandatory = $false)]
    [Bool] $DataDiskOnly = $true,

    # how frequently tooreport hello copy status in sceconds
    [Parameter(Mandatory = $false)]
    [Int32] $CopyStatusReportInterval = 15,

    # hello name suffix tooadd toonew created disks tooavoid conflict with source disk names
    [Parameter(Mandatory = $false)]
    [String]$DiskNameSuffix = "-prem"

    ) #end param

    #######################################################################
    #  Verify Azure PowerShell module and version
    #######################################################################

    #import hello Azure PowerShell module
    Write-Host "`n[WORKITEM] - Importing Azure PowerShell module" -ForegroundColor Yellow
    $azureModule = Import-Module Azure -PassThru

    if ($azureModule -ne $null)
    {
        Write-Host "`tSuccess" -ForegroundColor Green
    }
    else
    {
        #show module not found interaction and bail out
        Write-Host "[ERROR] - PowerShell module not found. Exiting." -ForegroundColor Red
        Exit
    }


    #Check hello Azure PowerShell module version
    Write-Host "`n[WORKITEM] - Checking Azure PowerShell module verion" -ForegroundColor Yellow
    If ($azureModule.Version -ge (New-Object System.Version -ArgumentList "0.8.14"))
    {
        Write-Host "`tSuccess" -ForegroundColor Green
    }
    Else
    {
        Write-Host "[ERROR] - Azure PowerShell module must be version 0.8.14 or higher. Exiting." -ForegroundColor Red
        Exit
    }

    #Check if there is an azure subscription set up in PowerShell
    Write-Host "`n[WORKITEM] - Checking Azure Subscription" -ForegroundColor Yellow
    $currentSubs = Get-AzureSubscription -Current
    if ($currentSubs -ne $null)
    {
        Write-Host "`tSuccess" -ForegroundColor Green
        Write-Host "`tYour current azure subscription in PowerShell is $($currentSubs.SubscriptionName)." -ForegroundColor Green
    }
    else
    {
        Write-Host "[ERROR] - There is no valid Azure subscription found in PowerShell. Please refer toothis article http://azure.microsoft.com/documentation/articles/powershell-install-configure/ tooconnect an Azure subscription. Exiting." -ForegroundColor Red
        Exit
    }


    #######################################################################
    #  Check if hello VM is shut down
    #  Stopping hello VM is a required step so that hello file system is consistent when you do hello copy operation.
    #  Azure does not support live migration at this time..
    #######################################################################

    if (($sourceVM = Get-AzureVM –ServiceName $SourceServiceName –Name $SourceVMName) -eq $null)
    {
        Write-Host "[ERROR] - hello source VM doesn't exist in hello current subscription. Exiting." -ForegroundColor Red
        Exit
    }

    # check if VM is shut down
    if ( $sourceVM.Status -notmatch "Stopped" )
    {
        Write-Host "[Warning] - Stopping hello VM is a required step so that hello file system is consistent when you do hello copy operation. Azure does not support live migration at this time. If you'd like toocreate a VM from a generalized image, sys-prep hello Virtual Machine before stopping it." -ForegroundColor Yellow
        $ContinueAnswer = Read-Host "`n`tDo you wish toostop $SourceVMName now? Input 'N' if you want tooshut down hello VM manually and come back later.(Y/N)"
        If ($ContinueAnswer -ne "Y") { Write-Host "`n Exiting." -ForegroundColor Red;Exit }
        $sourceVM | Stop-AzureVM

        # wait until hello VM is shut down
        $VMStatus = (Get-AzureVM –ServiceName $SourceServiceName –Name $vmName).Status
        while ($VMStatus -notmatch "Stopped")
        {
            Write-Host "`n[Status] - Waiting VM $vmName tooshut down" -ForegroundColor Green
            Sleep -Seconds 5
            $VMStatus = (Get-AzureVM –ServiceName $SourceServiceName –Name $vmName).Status
        }
    }

    # exporting hello sourve vm tooa configuration file, you can restore hello original VM by importing this config file
    # see more information for Import-AzureVM
    $workingDir = (Get-Location).Path
    $vmConfigurationPath = $env:HOMEPATH + "\VM-" + $SourceVMName + ".xml"
    Write-Host "`n[WORKITEM] - Exporting VM configuration too$vmConfigurationPath" -ForegroundColor Yellow
    $exportRe = $sourceVM | Export-AzureVM -Path $vmConfigurationPath


    #######################################################################
    #  Copy hello vhds of hello source vm
    #  You can choose toocopy all disks including os and data disks by specifying the
    #  parameter -DataDiskOnly toobe $false. hello default is toocopy only data disk vhds
    #  and hello new VM will boot from hello original os disk.
    #######################################################################

    $sourceOSDisk = $sourceVM.VM.OSVirtualHardDisk
    $sourceDataDisks = $sourceVM.VM.DataVirtualHardDisks

    # Get source storage account information, not considering hello data disks and os disks are in different accounts
    $sourceStorageAccountName = $sourceOSDisk.MediaLink.Host -split "\." | select -First 1
    $sourceStorageKey = (Get-AzureStorageKey -StorageAccountName $sourceStorageAccountName).Primary
    $sourceContext = New-AzureStorageContext –StorageAccountName $sourceStorageAccountName -StorageAccountKey $sourceStorageKey

    # Create destination context
    $destStorageKey = (Get-AzureStorageKey -StorageAccountName $DestStorageAccount).Primary
    $destContext = New-AzureStorageContext –StorageAccountName $DestStorageAccount -StorageAccountKey $destStorageKey

    # Create a container of vhds if it doesn't exist
    if ((Get-AzureStorageContainer -Context $destContext -Name vhds -ErrorAction SilentlyContinue) -eq $null)
    {
        Write-Host "`n[WORKITEM] - Creating a container vhds in hello destination storage account." -ForegroundColor Yellow
        New-AzureStorageContainer -Context $destContext -Name vhds
    }


    $allDisksToCopy = $sourceDataDisks
    # check if need toocopy os disk
    $sourceOSVHD = $sourceOSDisk.MediaLink.Segments[2]
    if ($DataDiskOnly)
    {
        # copy data disks only, this option requires deleting hello source VM so that dest VM can boot
        # from hello same vhd blob.
        $ContinueAnswer = Read-Host "`n`t[Warning] You chose toocopy data disks only. Moving VM requires removing hello original VM (hello disks and backing vhd files will NOT be deleted) so that hello new VM can boot from hello same vhd. This is an irreversible action. Do you wish tooproceed right now? (Y/N)"
        If ($ContinueAnswer -ne "Y") { Write-Host "`n Exiting." -ForegroundColor Red;Exit }
        $destOSVHD = Get-AzureStorageBlob -Blob $sourceOSVHD -Container vhds -Context $sourceContext
        Write-Host "`n[WORKITEM] - Removing hello original VM (hello vhd files are NOT deleted)." -ForegroundColor Yellow
        Remove-AzureVM -Name $SourceVMName -ServiceName $SourceServiceName

        Write-Host "`n[WORKITEM] - Waiting utill hello OS disk is released by source VM. This may take up tooseveral minutes."
        $diskAttachedTo = (Get-AzureDisk -DiskName $sourceOSDisk.DiskName).AttachedTo
        while ($diskAttachedTo -ne $null)
        {
            Start-Sleep -Seconds 10
            $diskAttachedTo = (Get-AzureDisk -DiskName $sourceOSDisk.DiskName).AttachedTo
        }

    }
    else
    {
        # copy hello os disk vhd
        Write-Host "`n[WORKITEM] - Starting copying os disk $($disk.DiskName) at $(get-date)." -ForegroundColor Yellow
        $allDisksToCopy += @($sourceOSDisk)
        $targetBlob = Start-AzureStorageBlobCopy -SrcContainer vhds -SrcBlob $sourceOSVHD -DestContainer vhds -DestBlob $sourceOSVHD -Context $sourceContext -DestContext $destContext -Force
        $destOSVHD = $targetBlob
    }


    # Copy all data disk vhds
    # Start all async copy requests in parallel.
    foreach($disk in $sourceDataDisks)
    {
        $blobName = $disk.MediaLink.Segments[2]
        # copy all data disks
        Write-Host "`n[WORKITEM] - Starting copying data disk $($disk.DiskName) at $(get-date)." -ForegroundColor Yellow
        $targetBlob = Start-AzureStorageBlobCopy -SrcContainer vhds -SrcBlob $blobName -DestContainer vhds -DestBlob $blobName -Context $sourceContext -DestContext $destContext -Force
        # update hello media link toopoint toohello target blob link
        $disk.MediaLink = $targetBlob.ICloudBlob.Uri.AbsoluteUri
    }

    # Wait until all vhd files are copied.
    $diskComplete = @()
    do
    {
        Write-Host "`n[WORKITEM] - Waiting for all disk copy toocomplete. Checking status every $CopyStatusReportInterval seconds." -ForegroundColor Yellow
        # check status every 30 seconds
        Sleep -Seconds $CopyStatusReportInterval
        foreach ( $disk in $allDisksToCopy)
        {
            if ($diskComplete -contains $disk)
            {
                Continue
            }
            $blobName = $disk.MediaLink.Segments[2]
            $copyState = Get-AzureStorageBlobCopyState -Blob $blobName -Container vhds -Context $destContext
            if ($copyState.Status -eq "Success")
            {
                Write-Host "`n[Status] - Success for disk copy $($disk.DiskName) at $($copyState.CompletionTime)" -ForegroundColor Green
                $diskComplete += $disk
            }
            else
            {
                if ($copyState.TotalBytes -gt 0)
                {
                    $percent = ($copyState.BytesCopied / $copyState.TotalBytes) * 100
                    Write-Host "`n[Status] - $('{0:N2}' -f $percent)% Complete for disk copy $($disk.DiskName)" -ForegroundColor Green
                }
            }
        }
    }
    while($diskComplete.Count -lt $allDisksToCopy.Count)

    #######################################################################
    #  Create a new vm
    #  hello new VM can be created from hello copied disks or hello original os disk.
    #  You can ddd your own logic here toosatisfy your specific requirements of hello vm.
    #######################################################################

    # Create a VM from hello existing os disk
    if ($DataDiskOnly)
    {
        $vm = New-AzureVMConfig -Name $DestVMName -InstanceSize $DestVMSize -DiskName $sourceOSDisk.DiskName
    }
    else
    {
        $newOSDisk = Add-AzureDisk -OS $sourceOSDisk.OS -DiskName ($sourceOSDisk.DiskName + $DiskNameSuffix) -MediaLocation $destOSVHD.ICloudBlob.Uri.AbsoluteUri
        $vm = New-AzureVMConfig -Name $DestVMName -InstanceSize $DestVMSize -DiskName $newOSDisk.DiskName
    }
    # Attached hello copied data disks toohello new VM
    foreach ($dataDisk in $sourceDataDisks)
    {
        # add -DiskLabel $dataDisk.DiskLabel if there are labels for disks of hello source vm
        $diskLabel = "drive" + $dataDisk.Lun
        $vm | Add-AzureDataDisk -ImportFrom -DiskLabel $diskLabel -LUN $dataDisk.Lun -MediaLocation $dataDisk.MediaLink
    }

    # Edit this if you want tooadd more custimization toohello new VM
    # $vm | Add-AzureEndpoint -Protocol tcp -LocalPort 443 -PublicPort 443 -Name 'HTTPs'
    # $vm | Set-AzureSubnet "PubSubnet","PrivSubnet"

    New-AzureVM -ServiceName $DestServiceName -VMs $vm -Location $Location
```

#### <a name="optimization"></a>Оптимизация
Можно настроить конфигурацию виртуальной Машины специально toowork с стандартные диски. Например tooincrease hello производительности с помощью много дисков в чередующемся томе. Например вместо 4 диска отдельно в хранилище класса Premium, может быть стоимость hello может toooptimize наличием одного диска. Оптимизация, например это toobe необходимость обрабатываются на индивидуальной основе и требуются пользовательские действия после миграции hello. Кроме того Обратите внимание, что этот процесс может хорошо работать для баз данных и приложений, зависящих от разметка диска hello, определенные в программе установки hello.

##### <a name="preparation"></a>Подготовка
1. Полный hello простой миграции, как описано в hello в разделе. Оптимизация выполняется на hello новой виртуальной Машине после миграции hello.
2. Определите размеры дисков новый hello, необходимый для настройки оптимизации hello.
3. Определите сопоставление спецификаций hello текущего дисков или томов toohello новый диск.

##### <a name="execution-steps"></a>Шаги выполнения
1. Создайте новые диски hello hello соответствующего размера на hello ВМ хранилища Premium.
2. Имя входа toohello ВМ и скопируйте hello данные hello текущего тома toohello нового диска, который сопоставляет toothat тома. Сделайте это для всех hello текущих томов, требующих toomap tooa новый диск.
3. Затем измените hello приложения параметры tooswitch toohello новых дисков и отсоединение hello старых томов.

Помощник по настройке приложения hello для повышения производительности диска, можно найти слишком[оптимизация производительности приложений](storage-premium-storage-performance.md#optimizing-application-performance).

### <a name="application-migrations"></a>Перенос приложений
Базы данных и других сложных приложений может потребоваться особые действия в соответствии с определением поставщика приложения hello hello миграции. См. документацию toorespective приложения. Например:  обычно базы данных можно переносить путем резервного копирования и восстановления.

## <a name="next-steps"></a>Дальнейшие действия
См. следующие ресурсы для конкретных сценариев для автоматической миграции виртуальных машин hello.

* [Перенос виртуальных машин Azure между учетными записями хранения.](https://azure.microsoft.com/blog/2014/10/22/migrate-azure-virtual-machines-between-storage-accounts/)
* [Создание и отправка tooAzure виртуального жесткого диска Windows Server.](../virtual-machines/windows/classic/createupload-vhd.md?toc=%2fazure%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json)
* [Создание и загрузка виртуального жесткого диска, который содержит hello операционной системы Linux](../virtual-machines/linux/classic/create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2fclassic%2ftoc.json)
* [Перенос виртуальных машин из Amazon AWS tooMicrosoft Azure](http://channel9.msdn.com/Series/Migrating-Virtual-Machines-from-Amazon-AWS-to-Microsoft-Azure)

Кроме того см. следующие ресурсы toolearn Дополнительные сведения о хранилище Azure и виртуальных машин Azure hello:

* [Хранилище Azure](https://azure.microsoft.com/documentation/services/storage/)
* [Виртуальные машины Azure](https://azure.microsoft.com/documentation/services/virtual-machines/)
* [Хранилище Premium: высокопроизводительное хранилище для рабочих нагрузок виртуальной машины Azure](storage-premium-storage.md)

[1]:./media/storage-migration-to-premium-storage/migration-to-premium-storage-1.png
[2]:./media/storage-migration-to-premium-storage/migration-to-premium-storage-1.png
[3]:./media/storage-migration-to-premium-storage/migration-to-premium-storage-3.png
[4]: http://technet.microsoft.com/library/hh831739.aspx

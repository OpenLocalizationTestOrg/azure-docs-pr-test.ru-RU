---
title: "aaaBackup и аварийного восстановления для дисков Azure IaaS | Документы Microsoft"
description: "В этой статье объясняется, как tooplan для резервного копирования и аварийного восстановления (DR) IaaS виртуальных машин (ВМ) и дисков в Azure. В этом документе рассматриваются как управляемые, так и неуправляемые диски."
services: storage
cloud: Azure
documentationcenter: na
author: luywang
manager: kavithag
ms.assetid: 
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/19/2017
ms.author: luywang
ms.openlocfilehash: 17c697bc411fb47c4b7483b59829af1c40732ac1
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="backup-and-disaster-recovery-for-azure-iaas-disks"></a>Архивация и аварийное восстановление для дисков IaaS Azure

В этой статье объясняется, как tooplan для резервного копирования и аварийного восстановления (DR) IaaS виртуальных машин (ВМ) и дисков в Azure. В этом документе рассматриваются как управляемые, так и неуправляемые диски.

Сначала рассмотрим hello встроенные возможности отказоустойчивости в hello платформы Azure которых защиту от локальных сбоев. Затем мы обсудим hello аварийного сценарии не полностью, hello встроенными возможностями, который является основной раздел hello, описанной в этом документе. Мы также рассмотрим несколько примеров сценариев рабочей нагрузки, в которых могут применяться различные вопросы архивации и аварийного восстановления. Затем мы рассмотрим возможные решения для аварийного восстановления дисков IaaS. 

## <a name="introduction"></a>Введение

Hello платформы Azure использует различные методы для обеспечения избыточности и toohelp отклонения ошибки защититься от сбоев оборудования локализованные, которые могут возникнуть. Локальные ошибки могут вызвать проблемы с машиной сервера хранилища Azure, которая содержит часть данных hello для виртуального диска или SSD или HDD сбоев на этом сервере. Таких сбоев компонентов изолированное оборудовании может произойти во время обычной работы и платформа hello — спроектированный toobe устойчивым toothese сбоев. Серьезные аварии могут привести к сбоям или недоступности большого количества серверов хранилища или всего центра обработки данных. Хотя виртуальные машины и диски обычно защита от сбоев локализованные, дополнительные действия, необходимые tooprotect рабочей нагрузки от всей области критическим сбоям (например серьезной аварии), влияющих на ВМ и дисков.

В дополнение к этому toohello вероятность сбоев платформы, с клиентского приложения hello или данных могут возникнуть проблемы. Например новая версия приложения может непреднамеренно становится критические изменения toohello данных. В этом случае можно привести приложение hello toorevert и hello данных tooa предыдущей версии содержащего hello последнее удачное состояние. Для этого необходима регулярная архивация.

Для региональных аварийного восстановления должен создать резервную вашей диски ВМ IaaS tooa другой регион. 

Прежде чем мы рассмотрим параметры резервного копирования и аварийного восстановления, давайте освежим в памяти несколько методов обработки локальных сбоев.

### <a name="azure-iaas-resiliency"></a>Устойчивость Azure IaaS

*Устойчивость* означает toohello отклонения для обычных ошибок, возникающих в аппаратных компонентов. Устойчивость является toorecover возможность hello от сбоев и продолжить toofunction. Не о как избежать ошибок, но отвечает toofailures образом, чтобы избежать простоя и потери данных. Задача Hello устойчивости — tooreturn hello tooa полнофункциональной состояние приложения после сбоя. Виртуальные машины Azure и диски, спроектированный toobe устойчивым toocommon аппаратных сбоев. Рассмотрим как платформы Azure IaaS hello предоставляет этот устойчивости.

Виртуальная машина основном состоит из двух частей: (1) A вычислений сервера и постоянные диски hello (2). Оба влияет на отказоустойчивость hello виртуальной машины.

Если сервер узла hello вычислений Azure, содержащий ВМ происходит сбой оборудования (что бывает редко), Azure — hello спроектированный tooautomatically восстановления виртуальной Машины на другом сервере. В этом случае будет возникать перезагрузка и hello виртуальной Машины будет резервное копирование через некоторое время. Azure автоматически обнаруживает такие сбои оборудования и выполняет восстановление toohelp обеспечить hello клиента виртуальной Машины будут доступны как можно быстрее.

О дисках IaaS Устойчивость данных крайне важна для платформы hello постоянное хранилище. Azure клиенты имеют важные бизнес-приложений, выполняемой в IaaS, и они зависят от hello сохраняемости данных hello. Azure обеспечивает защиту этих дисков IaaS, создавая три избыточных локальных копии данных, что позволяет получить высокий уровень защиты от локальных сбоев. В случае сбоя одного hello аппаратных компонентов, которые хранятся на диске виртуальной Машины не влияет на так как имеются два дополнительных копий toosupport диска запросы. Устройство работает даже в случае отказа двух различных аппаратных компонентов, поддерживающих диск на hello же времени (что было бы очень редко). toohelp убедитесь, мы всегда поддерживать три реплики, службе хранилища Azure hello автоматически порождает новую копию данных в фоновом режиме hello, если один из трех копий hello становится недоступным. Таким образом не следует необходимые toouse RAID с дисками Azure для обеспечения отказоустойчивости. Простой RAID 0 конфигурации должно быть достаточно для чередование дисков hello, при необходимости toocreate больших томах.

Благодаря этой архитектуре **в Azure удалось гарантировать надежность дисков IaaS корпоративного уровня с ведущим в отрасли [нулевым показателем процента сбоев в течение года](https://en.wikipedia.org/wiki/Annualized_failure_rate).**

Локализованным сбоям оборудования на hello вычислений размещения или в хранилище hello платформы иногда может привести к временной недоступности для виртуальной Машины, описанном hello hello [соглашения об уровне ОБСЛУЖИВАНИЯ Azure](https://azure.microsoft.com/support/legal/sla/virtual-machines/) для обеспечения доступности виртуальной Машины. Azure также предоставляет ведущее в отрасли Соглашение об уровне обслуживания для отдельных экземпляров виртуальных машин, в которых используются диски хранилища класса "Премиум".

рабочие нагрузки приложений toosafeguard от простоев из-за временной недоступности toohello диска или виртуальных Машин, клиенты могут использовать [наборов доступности](../virtual-machines/windows/manage-availability.md). Два или несколько виртуальных машин в наборе доступности обеспечивает избыточность для приложения hello. Azure создает эти виртуальные машины и диски в отдельных доменах сбоя с различными компонентами питания, сетевыми компонентами и серверными компонентами. Таким образом, сбоев оборудования локализованные обычно не влияют на несколько виртуальных машин в hello равным hello одновременно, обеспечивая высокий уровень доступности для вашего приложения. Считается, что задает доступности toouse рекомендуется всегда, когда требуется высокая доступность. Дополнительные сведения см. в разделе аспекты hello аварийного восстановления, см. ниже.

### <a name="backup-and-disaster-recovery"></a>Резервное копирование и аварийное восстановление

Аварийное восстановление (DR) является toorecover возможность hello из редко, но основные инцидентов: Повторяющаяся, масштаб всей неполадок, например нарушения обслуживания, которая влияет на весь регион. Аварийное восстановление включает резервное копирование данных и архивацию и может включать ручное вмешательство, например восстановление базы данных из резервной копии.

Hello платформы Azure встроенную защиту от сбоев локализованные может не защищают полностью hello виртуальные машины и диски, в случае серьезных аварий, заставляющие крупномасштабных простои hello. К таким сбоям относятся катастрофические события, такие как воздействие на центр обработки данных урагана, землетрясения, пожара, или крупномасштабный сбой оборудования. Кроме того возможны сбои из-за проблем с tooapplication или данных.

toohelp рабочих нагрузок IaaS защиты от сбоев, необходимо запланировать восстановления tooenable избыточность и резервные копии. Для аварийного восстановления следует запланировать избыточность и резервной копии в разных географических расположениях hello основной узел. Это помогает обеспечить резервного копирования не подвержены hello того же события, которое изначально повлиять hello виртуальной Машины или дисков. Дополнительные сведения см. в статье [Аварийное восстановление для приложений на платформе Azure](https://docs.microsoft.com/azure/architecture/resiliency/disaster-recovery-azure-applications).

Вопросы вашей аварийного восстановления может включать hello следующие аспекты:

1. Высокий уровень доступности (HA) — это способность hello toocontinue приложения hello в работоспособное состояние, без значительно увеличить время простоя. «Исправен», мы означает приложения hello отвечать на запросы, и пользователи могут подключаться toohello приложения и взаимодействовать с ней. Некоторые критически важных приложений и баз данных может быть обязательным toobe доступны всегда, даже в том случае, когда происходит ошибка в платформе hello. Для этих рабочих нагрузок может потребоваться tooplan избыточность для приложения hello, а также данные hello.

2. Надежность данных: В некоторых случаях hello главное, помнить убедитесь, что hello данные сохраняются в случае аварийной ситуации, когда hello. Поэтому может потребоваться создание резервной копии данных на другом сайте. Для таких рабочих нагрузок которые могут потребоваться полную избыточность для приложения hello, но регулярного резервного копирования дисков hello.

## <a name="backup-and-dr-scenarios"></a>Сценарии архивации и аварийного восстановления

Рассмотрим несколько примеров типичных сценариев рабочей нагрузки приложения и hello размышления о планировании аварийного восстановления.

### <a name="scenario-1-major-database-solutions"></a>Сценарий 1. Решения для крупных баз данных

Рассмотрим рабочий сервер базы данных, например SQL Server или Oracle, поддерживающий высокий уровень доступности. От этой базы данных зависят критически важные рабочие приложения и пользователи. Hello план аварийного восстановления для этой системы может понадобиться hello toosupport следующие требования:

1. Данные должны быть защищены и иметь возможность восстановления.
2.  Сервер должен быть доступен для использования.

Для этого может потребоваться поддержание реплики базы данных hello в другом регионе в качестве резервной копии. В зависимости от требований hello для обеспечения доступности сервера и восстановление данных hello решение может включать активный / активный "или" активный / пассивный реплики сайта tooperiodic автономного резервного копирования данных hello. Реляционные базы данных, такие как SQL Server и Oracle, предоставляют различные варианты репликации. Для обеспечения высокого уровня доступности в SQL Server можно использовать [Группы доступности Always On SQL Server](https://msdn.microsoft.com/library/hh510230.aspx).

Для обеспечения избыточности в базах данных NoSQL, таких как MongoDB, также поддерживаются [реплики](https://docs.mongodb.com/manual/replication/). можно использовать Hello реплики для обеспечения высокой доступности.

### <a name="scenario-2-a-cluster-of-redundant-vms"></a>Сценарий 2. Кластер избыточных виртуальных машин

Рассмотрим рабочую нагрузку, поддерживаемую кластером виртуальных машин, который обеспечивает избыточность и балансировку нагрузки. В качестве примера такой нагрузки можно рассмотреть кластер Cassandra, развернутый в регионе. Этот тип архитектуры уже обеспечивает высокий уровень избыточности в этом регионе. Тем не менее рабочая нагрузка hello tooprotect региональных уровня после сбоя, следует распространение hello кластеров в двух областях или сделав области tooanother периодическое резервное копирование.

### <a name="scenario-3-iaas-application-workload"></a>Сценарий 3. Рабочая нагрузка приложения IaaS

К такой рабочей нагрузке можно отнести обычную рабочую нагрузку, запущенную на виртуальной машине Azure. Например это может быть веб-сервера или файлового сервера, удерживая hello содержимое и другие ресурсы сайта. Это также может быть запущен на виртуальной Машине, хранятся на дисках виртуальной Машины hello его данных, ресурсов и состояния приложения пользовательские бизнес-приложений. В этом случае это важно toomake в том, что резервные копии на регулярной основе. Интервал резервного копирования должно быть основано на характер hello нагрузки виртуальной Машины hello. Например приложение hello запускается каждый день и изменяет данные, затем hello резервная копия должна ли быть принята каждый час.

Еще один пример — сервер отчетов, который извлекает данные из других источников и создает статистические отчеты. Потери этой виртуальной Машины или дисков могут стать причиной потери toohello hello отчетов. Тем не менее часто бывает hello возможных toorerun процесса и повторное создание hello выходные данные отчетов. В этом случае не нужно действительно потери данных, даже если hello сервера отчетов с аварии, поэтому может иметь более высокий уровень отклонения для потери части данных hello на приветствия сервера отчетов. В этом случае более частое создание резервных копий является параметр tooreduce hello затрат.

### <a name="scenario-4-iaas-application-data-issues"></a>Сценарий 4. Проблемы с данными для приложения IaaS

У вас есть приложение, которое вычисляет, хранит и обслуживает критически важные коммерческие данные, такие как сведения о ценах. Новая версия приложения были ошибки программного обеспечения, которой неправильно вычислено цены hello и поврежденные данные commerce существующих hello, обслуживаемых hello платформы. Здесь hello наилучшее решение будет toorevert toohello более ранней версии приложения hello и hello данных первого. tooenable этого, принимают периодическое резервное копирование системы.

## <a name="disaster-recovery-solution-azure-backup-service"></a>Решение для аварийного восстановления: служба архивация Azure

[Службу архивации Azure](https://azure.microsoft.com/services/backup/) можно использовать для архивации и аварийного восстановления. Эта служба работает как с [управляемыми](storage-managed-disks-overview.md), так и с [неуправляемыми](storage-about-disks-and-vhds-windows.md#unmanaged-disks) дисками. Вы можете создавать задания архивации с учетом времени, легко восстанавливать виртуальные машины и использовать политики хранения архивов. 

При использовании [дисках хранилища Premium](storage-premium-storage.md), [управляемых дисков](storage-managed-disks-overview.md), или другие типы дисков с помощью hello [локально избыточное хранилище (LRS)](storage-redundancy.md#locally-redundant-storage) параметр, это особенно важно tooleverage Периодическое резервное копирование аварийного восстановления. Резервное копирование Azure хранит данные hello в хранилище служб восстановления для долговременного хранения. Выберите hello [географически избыточное хранилище (GRS)](storage-redundancy.md#geo-redundant-storage) параметр для hello службы восстановления резервной копии в хранилище. Убедитесь, что резервные копии находятся в другом регионе Azure реплицированных tooa для защиты от аварий регионального.

Для [неуправляемые дисков](storage-about-disks-and-vhds-windows.md#unmanaged-disks), можно использовать тип хранения LRS hello для дисков IaaS, но включить резервное копирование Azure с hello параметр GRS для hello хранилище служб восстановления.

**Если вы используете hello [GRS](storage-redundancy.md#geo-redundant-storage)/[RA-GRS](storage-redundancy.md#read-access-geo-redundant-storage) параметр для неуправляемых дисков, вы по-прежнему требуется моментальных снимков для резервного копирования и аварийного восстановления.** Необходимо использовать [службу архивации Azure](https://azure.microsoft.com/services/backup/) или [моментальные снимки](#alternative-solution-consistent-snapshots).

Hello ниже приводится сводка решений для аварийного восстановления.

| Сценарий | Автоматическая репликация | Решение аварийного восстановления |
| --- | --- | --- |
| *Диски хранилища класса "Премиум"* | Локальная ([локально избыточное хранилище](storage-redundancy.md#locally-redundant-storage)) | [Служба архивации Azure](https://azure.microsoft.com/services/backup/) |
| *Управляемые диски* | Локальная ([локально избыточное хранилище](storage-redundancy.md#locally-redundant-storage)) | [Служба архивации Azure](https://azure.microsoft.com/services/backup/) |
| *Неуправляемые диски локально избыточного хранилища* | Локальная ([локально избыточное хранилище](storage-redundancy.md#locally-redundant-storage)) | [Служба архивации Azure](https://azure.microsoft.com/services/backup/) |
| *Неуправляемые диски геоизбыточного хранилища* | Межрегиональная ([геоизбыточное хранилище](storage-redundancy.md#geo-redundant-storage)) | [Служба архивации Azure](https://azure.microsoft.com/services/backup/)<br/>[Согласованные моментальные снимки](#alternative-solution-consistent-snapshots) |
| *Неуправляемые диски геоизбыточного хранилища с доступом на чтение* | Межрегиональная ([геоизбыточное хранилище с доступом на чтение](storage-redundancy.md#read-access-geo-redundant-storage)) | [Служба архивации Azure](https://azure.microsoft.com/services/backup/)<br/>[Согласованные моментальные снимки](#alternative-solution-consistent-snapshots) |

Высокий уровень доступности можно путем соответствовать посредством использования hello управляемый дисков в группе доступности вместе с Azure Backup. Для неуправляемых дисков все равно можно использовать службу архивации Azure для аварийного восстановления. Если не удается toouse резервного копирования Azure, затем выполняя [снимков](#alternative-solution-consistent-snapshots) как описано в следующем разделе является альтернативным решением для резервного копирования и аварийного восстановления.

Выбранные параметры высокой доступности, архивации и аварийного восстановления на уровне приложения или инфраструктуры можно представить следующим образом:

| *Level* | Высокая доступность   | Архивация/аварийное восстановление |
| --- | --- | --- |
| *Приложения* | SQL Always On | Служба архивации Azure |
| *Инфраструктура*  | Группа доступности  | Геоизбыточное хранилище с согласованными моментальными снимками |

### <a name="using-hello-azure-backup-service"></a>С помощью службы архивации Azure hello

[Резервное копирование Azure](../backup/backup-azure-vms-introduction.md) может выполнять резервное копирование виртуальных машин под управлением Windows или Linux toohello хранилище служб восстановления Azure. Резервное копирование и восстановление данных на важных осложняется hello факт, что важные данные, следует воспользоваться резервным копированием при hello приложений, обеспечивающих hello данных работают. tooaddress, служба архивации Azure предлагает резервных копий, согласованных приложения для рабочих нагрузок Майкрософт с помощью tooensure hello службы теневого тома (VSS), что данные записываются правильно toostorage. Для виртуальных машин Linux только совместимые в файлами резервных копий возможны, поскольку Linux отсутствует эквивалент tooVSS функциональные возможности.

![][1]

При архивации Azure инициирует задание резервного копирования во время запланированного hello, система инициирует установлены в hello tootake ВМ моментальный снимок в момент расширение резервного копирования hello. Моментальный снимок совместно с VSS tooget согласованный моментальный снимок hello дисков на виртуальной машине hello без необходимости tooshut его работу. расширение резервного копирования Hello в hello ВМ очищает все операции записи перед созданием hello согласованный моментальный снимок всех дисков hello. После hello моментальный снимок, hello данные передаются с резервного копирования Azure toohello резервного хранилища. toomake hello процесс резервного копирования более эффективно, служба hello идентифицирует и передает только hello блоков данных, которые были изменены с момента последнего резервного копирования hello.


toorestore, вы можете просматривать hello доступные резервные копии Azure с помощью и затем запустить восстановление. Можно создать и восстановления резервных копий в Azure через hello [портал Azure](https://portal.azure.com/), [с помощью PowerShell](../backup/backup-azure-vms-automation.md ), или с помощью hello [Azure CLI](https://docs.microsoft.com/azure/xplat-cli-install). Дополнительные сведения см. в разделе "Служба архивации Azure".

### <a name="steps-tooenable-backup"></a>TooEnable действия резервной копии

Hello следующие действия являются типовыми tooenable резервные копии виртуальных машин с помощью hello [портала Azure](https://portal.azure.com/). Возможны некоторые различия в зависимости от вашего сценария. См. toohello [резервного копирования Azure](../backup/backup-azure-vms-introduction.md) документации полные сведения. Служба архивации Azure также [поддерживает виртуальные машины с управляемыми дисками](https://azure.microsoft.com/blog/azure-managed-disk-backup/).

1.  Создайте хранилище служб восстановления для виртуальной Машины с помощью hello следующие шаги:

    а.  С помощью hello [портал Azure](https://portal.azure.com/)найдите все ресурсы и найти «Хранилищами служб восстановления».

    b.  На hello службы восстановления хранилищ меню, нажмите кнопку Добавить и выполните шаги hello toocreate новое хранилище в hello же регионе, что hello виртуальной Машины. Например если ваша ВМ находится в регионе, Запад США, выберите Запад США для hello хранилища.

2.  Проверьте репликацию хранилища hello для hello созданное хранилище. toodo хранилища hello, доступ из hello службы восстановления хранилищ колонки и go toohello параметры резервного копирования или конфигурации. Убедитесь, что hello GRS параметр выбран по умолчанию. Это обеспечит ваше хранилище автоматически реплицированных tooa вторичный центр обработки данных. Например хранилище на Западе США будет автоматически реплицированных tooEast США.

3.  Настройте политику резервного копирования hello и выберите hello виртуальной Машины из hello же пользовательского интерфейса.

4.  Убедитесь, что приветствия на hello виртуальной Машине установлен агент резервного копирования. Если ВМ создается с помощью образа коллекции Azure, уже установлены агент резервного копирования hello. В противном случае (Если вы используете пользовательский образ), используйте инструкции слишком[hello установки агента виртуальной Машины на виртуальной машине hello](../backup/backup-azure-arm-vms-prepare.md#install-the-vm-agent-on-the-virtual-machine).

5.  Убедитесь, что hello виртуальной Машины позволяет сетевым подключением toofunction hello службы резервного копирования. Для настройки сетевого подключения выполните действия, описанные в [этом разделе](../backup/backup-azure-arm-vms-prepare.md#network-connectivity).

6.  После завершения hello выше шаги для запуска архивации hello через регулярные интервалы, как указано в политику резервного копирования hello. При необходимости вы можете активировать hello первой резервной копии вручную из hello мониторинга хранилища на hello портал Azure.

Для автоматизации резервного копирования Azure с помощью скриптов, можно найти слишком[командлеты PowerShell для резервного копирования виртуальной Машины](../backup/backup-azure-vms-automation.md).

### <a name="steps-for-recovery"></a>Действия для восстановления

Если необходимо toorepair или перестроить виртуальной Машины, hello виртуальной Машины можно восстановить из любой точки восстановления резервной копии hello в хранилище hello. Существует несколько различных параметров для выполнения восстановления hello:

1.  Вы можете создать новую виртуальную машину, которая будет представлять собой архивированную виртуальную машину в определенный момент времени.

2.  Можно восстановить диски hello и затем применять шаблон hello для виртуальной Машины toocustomize hello и перестроения hello восстановления виртуальной Машины. 

См. инструкции слишком[виртуальных машин Azure используйте портала toorestore](../backup/backup-azure-arm-restore-vms.md#restoring-a-vm-during-azure-datacenter-disaster). Hello документ также объясняется hello конкретные шаги для восстановления резервных копий виртуальных машин toohello парной ЦОД с помощью геоизбыточных резервного хранилища в случае аварии на hello основного центра обработки данных, когда hello. В этом случае резервного копирования Azure использует службы вычислений hello hello дополнительный регион toocreate hello восстановления виртуальной машины.

Вы также можете [восстановить виртуальную машину](../backup/backup-azure-vms-automation.md#restore-an-azure-vm) с помощью PowerShell или [создать новую виртуальную машину из восстановленных дисков](../backup/backup-azure-vms-automation.md#create-a-vm-from-restored-disks).

## <a name="alternative-solution-consistent-snapshots"></a>Альтернативное решение: согласованные моментальные снимки

Если не удается toouse hello службы резервного копирования Azure, можно реализовать собственный механизм резервного копирования, с использованием моментальных снимков. Он является сложной toocreate моментальные снимки для всех дисков, используемых виртуальной машиной, а затем реплицировать эти области tooanother моментальные снимки. По этой причине Azure считает, что использование hello службы резервного копирования лучшим вариантом, чем создание пользовательского решения. При использовании хранилища GRS или RA-GRS для дисков, моментальные снимки доступны автоматически реплицированных tooa вторичный центр обработки данных. При использовании LRS хранения для дисков, необходимо будет tooreplicate hello данных самостоятельно. Дополнительные сведения см. в разделе [Архивация неуправляемых дисков виртуальной машины Azure с помощью добавочных моментальных снимков](storage-incremental-snapshots.md).

Моментальный снимок — это представление объекта в определенный момент времени. Моментальный снимок повлечет за собой выставления счетов для hello добавочное размер hello данных он содержит. Дополнительные сведения см. в разделе [Создание моментального снимка BLOB-объекта](storage-blob-snapshots.md).

### <a name="creating-snapshots-while-hello-vm-is-running"></a>Создание моментальных снимков при hello Виртуальная машина запущена

Моментального снимка можно выполнить в любое время, в случае hello Виртуальная машина запущена, по-прежнему данных потоковой передачи toohello диски и моментальные снимки hello может содержать частичного операций, которые были в процессе передачи. Кроме того если задействованы несколько дисков, моментальные снимки hello различных дисков мог произойти в разное время, что означает, что эти моментальные снимки не может быть согласован. Это представляет особенную сложность для томов с чередованием, файлы на которых могут быть повреждены, если в ходе архивации данные были изменены.

tooavoid этой ситуации hello процесс резервного копирования необходимо реализовать hello следующие шаги:

1.  Заморозить все диски hello

2.  Очистить все hello ожидающие операции записи

3.  Затем [создания моментального снимка большого двоичного объекта](storage-blob-snapshots.md) для всех hello дисков

Некоторые приложения Windows, как SQL Server предоставляет механизм скоординированного резервного копирования через VSS, согласованные с приложениями toocreate резервных копий. В Linux можно использовать средства, подобного fsfreeze координацию hello диски, обеспечивающие совместимые в файлами резервных копий, но не моментальные снимки приложений. Этот процесс весьма сложен, поэтому следует воспользоваться [службой архивации Azure](../backup/backup-azure-vms-introduction.md) или сторонним решением архивации, в котором уже реализован этот механизм.

Hello выше процесса приведет к коллекции скоординированного моментальных снимков для всех дисков виртуальной Машины hello, представления конкретного момента времени hello виртуальной Машины. Это точка резервного копирования и восстановления для виртуальной Машины hello. Можно повторить процесс hello для периодического резервного копирования toocreate запланированные интервалы времени. Ниже приведены шаги hello слишком[копирования hello резервные копии tooanother области](#copy-the-snapshots-to-another-region) для аварийного восстановления.

### <a name="creating-snapshots-while-hello-vm-is-offline"></a>Создание моментальных снимков при hello виртуальная машина находится в автономном режиме

Другой вариант toocreate согласованных копий завершает работу hello виртуальной Машины и создание больших двоичных объектов моментальные снимки для каждого диска. Этот вариант проще, чем создание скоординированных моментальных снимков работающей виртуальной машины, но для его выполнения потребуется несколько минут простоя. Для реализации этого варианта выполните следующие действия:

1. Завершите работу виртуальной Машины hello.

2. Создайте моментальный снимок BLOB-объекта для каждого виртуального жесткого диска. Это займет всего несколько секунд.

    toocreate моментального снимка, можно использовать [PowerShell](storage-powershell-guide-full.md#how-to-manage-azure-blob-snapshots), hello [API Rest хранилища Azure](https://msdn.microsoft.com/library/azure/ee691971.aspx), [Azure CLI](https://docs.microsoft.com/azure/xplat-cli-install), или один из клиентских библиотек хранилища hello Azure как [ Hello клиентская библиотека хранилища для .NET](https://msdn.microsoft.com/library/azure/hh488361.aspx).

3. Запустите виртуальную Машину, которая заканчивается простоя hello hello. Обычно в течение нескольких минут завершения всего процесса hello.

Этот процесс создает коллекцию моментальных снимков для всех дисков hello, предоставляя точки резервного копирования и восстановления для hello виртуальной Машины. Ниже приведена hello действия toocopy hello моментальные снимки tooanother регионе для аварийного восстановления.

### <a name="copy-hello-snapshots-tooanother-region"></a>Скопируйте hello моментальные снимки tooanother области

Создание моментальных снимков hello сама по себе может быть недостаточно для аварийного восстановления. Также необходимо реплицировать область tooanother резервные копии моментальных снимков hello.

При использовании GRS или RA-GRS для дисков, затем hello моментальные снимки доступны дополнительный регион реплицированных toohello автоматически. Может существовать несколько минут задержки до репликации hello и если hello основного центра обработки данных выходит из строя до завершения hello моментальных снимков репликации, не будет моментальных снимков может tooaccess hello hello вторичный центр обработки данных. Hello вероятность того, что это очень мал.

> [!Note] 
> Только наличие hello дисков в учетной записи GRS или RA-GRS не защищает hello виртуальной Машины после сбоев. Также необходимо создать скоординированные моментальные снимки или использовать службу архивации Azure. Это обязательный toorecover в согласованное состояние виртуальной Машины tooa.

При использовании LRS необходимо скопировать hello моментальные снимки tooa другую учетную запись хранения сразу после создания моментального снимка hello. Копирование конечного Hello может быть LRS учетной записи хранения в другом регионе, возникающие при копировании hello в удаленной области. Учетная запись хранения RA-GRS tooan hello моментальных снимков также можно скопировать в hello одного региона. В этом случае hello моментального снимка будет неактивно реплицированных toohello удаленный дополнительный регион. Резервной копии защищен от аварий в первичном сайте hello после завершения копирования hello и репликации.

toocopy вашей добавочных моментальных снимков для аварийного восстановления, эффективно, изучите инструкции hello в [резервное копирование Azure неуправляемые дисков виртуальной Машины с добавочных моментальных снимков](storage-incremental-snapshots.md).

![][2]

### <a name="recovery-from-snapshots"></a>Восстановление из моментальных снимков

tooretrieve моментального снимка, скопируйте его toomake новый большой двоичный объект. При копировании из основной учетной записи hello hello моментального снимка можно скопировать hello моментальных снимков через toohello базового BLOB-объекта моментального снимка hello, таким образом отката hello диск toohello моментального снимка; Это известно как повышение уровня моментального снимка hello. Если вы копируете hello резервного копирования моментальных снимков из вторичную учетную запись (в случае hello RA-GRS), он должен быть скопирован tooa основной учетной записи. Можно скопировать моментальный снимок [с помощью PowerShell](storage-powershell-guide-full.md#how-to-copy-a-snapshot-of-a-blob) или с помощью служебной программы AzCopy hello. Дополнительные сведения см. в разделе [перенесите данные с помощью служебной программы командной строки AzCopy hello](storage-use-azcopy.md).

В случае hello виртуальных машин с несколькими дисками, необходимо скопировать все точки восстановления hello моментальных снимков, которые являются частью hello, координируемых с таким же. После копирования больших двоичных объектов VHD toowritable hello моментальные снимки можно использовать toorecreate большие двоичные объекты hello ВМ с помощью шаблона hello для hello виртуальной Машины.

## <a name="other-options"></a>Другие варианты

### <a name="sql-server"></a>SQL Server

SQL Server, запущенный на виртуальной машине имеет свой собственный toobackup Встроенные возможности вашего tooAzure базы данных SQL Server хранилища BLOB-объектов или в общей папке. Если учетная запись хранения hello GRS или RA-GRS, доступные через этих резервных копий в учетной записи хранилища hello вторичный центр обработки данных в событии hello авария, hello те же ограничения, как описано выше. Дополнительные сведения см. в статье [Резервное копирование и восстановление SQL Server в виртуальных машинах Azure](../virtual-machines/windows/sql/virtual-machines-windows-sql-backup-recovery.md). В дополнение toobackup и восстановления [SQL Server группы доступности AlwaysOn](../virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr.md) могут поддерживать вторичные реплики базы данных toogreatly сократить время восстановления после сбоев hello.

## <a name="other-considerations"></a>Дополнительные рекомендации

В этой статье описывается, как toobackup или take моментальные снимки виртуальных машин и их восстановление после сбоя дисков toosupport и как toouse этих toorecover. С моделью hello диспетчера ресурсов Azure многие пользователи используют шаблоны toocreate их виртуальные машины и другие инфраструктуры в Azure. Можно использовать toocreate шаблона виртуальной Машины с hello одной конфигурации каждый раз. При использовании пользовательских образов для создания виртуальных машин, кроме того, необходимо убедиться, что образы защищены с помощью учетных записей RA-GRS toostore их.

Следовательно, процесс архивации представляет собой сочетание двух вещей:

1. Hello резервного копирования данных (дисков)
2. Конфигурация резервного копирования hello (шаблоны, пользовательских образов)

В зависимости от hello резервного копирования выбранного параметра можно использовать toohandle hello резервной копии данных hello и конфигурации hello или hello службы резервного копирования могут обрабатывать все это для вас.

## <a name="appendix---understanding-hello-impact-of-lrs-grs-and-ra-grs"></a>Приложение - понимание влияния hello LRS, GRS и RA-GRS

Для учетных записей хранения Azure существует три типа обеспечения избыточности данных, которые следует использовать при планировании аварийного восстановления: локально избыточное хранилище (LRS), геоизбыточное хранилище (GRS) и геоизбыточное хранилище с доступом на чтение (RA-GRS). 

Локально избыточное хранилище (LRS) сохраняет три копии данных hello в hello одного центра обработки данных. При записи данных hello, все три копии обновляются до успехе toohello вызывающего объекта, поэтому известно, что они совпадают. На диске защищен после локальных сбоев, так как она является крайне маловероятно, что все три копии повлияет на hello то же время. В случае hello LRS нет не географической избыточности, поэтому hello дисков не защищены от катастрофических сбоев, которые могут повлиять на единице center или хранилища данных.

GRS и RA-GRS три копии данных хранятся в основной регион hello (выбрана), и три дополнительные копии данных сохраняются в соответствующих дополнительном регионе (назначение Azure). Например если данные хранятся на Западе США, hello данные будут реплицированных tooEast США. Это происходит в асинхронном режиме, и между toohello обновлений первичного и вторичного небольшая задержка. Реплики hello дисков на вторичном сайте hello соответствуют отдельно для каждого диска (hello задержка), но реплик нескольких дисков active может быть нарушена синхронизация **друг с другом**. необходимы toohave согласованных реплик на нескольких дисках, моментальных снимков.

Hello основное различие между GRS и RA-GRS —, с RA-GRS, вы можете узнать дополнительная копия hello в любое время. Если имеется проблема, которая отображает данные hello в основном регионе hello недоступен, hello команды Azure сделает каждой доступ toorestore усилий. Хотя первичный hello не работает, если включена функция RA-GRS, данные hello в hello вторичный центр обработки данных доступны. Таким образом Если планируется tooread из hello реплики при отсутствии доступа основной hello, затем RA-GRS следует рассматривать.

Если оказалось toobe значительные сбоя, hello команды Azure может активировать географическая отработка отказа и hello основного DNS записи toopoint toosecondary хранилища. На этом этапе при наличии либо GRS или RA-GRS включено, можно доступ к данным hello hello область, которая используется toobe hello получателей. Другими словами Если в вашей учетной записи хранилища GRS и возникает проблема, можно открыть hello вторичного хранилища только в том случае, если географическая отработка отказа.

Дополнительные сведения см. в разделе [какие toodo в случае сбоя хранилища Azure](storage-disaster-recovery-guidance.md). 

Обратите внимание, что отработкой отказа управляет корпорация Майкрософт. Отработка отказа не контролируется на уровне отдельных учетных записей, поэтому она не может быть запущена по запросу отдельных клиентов. tooimplement аварийного восстановления для конкретное хранилище учетных записей или диски виртуальной машины, необходимо использовать hello методик, описанных ранее в этой статье.



[1]: ./media/storage-backup-and-disaster-recovery-for-azure-iaas-disks/backup-and-disaster-recovery-for-azure-iaas-disks-1.png
[2]: ./media/storage-backup-and-disaster-recovery-for-azure-iaas-disks/backup-and-disaster-recovery-for-azure-iaas-disks-2.png
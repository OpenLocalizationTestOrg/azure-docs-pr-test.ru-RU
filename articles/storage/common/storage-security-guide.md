---
title: "Руководство по безопасности службы хранилища Azure | Документация Майкрософт"
description: "Подробно описываются различные способы защиты службы хранилища Azure, включая, помимо прочего, управление доступом на основе ролей, шифрование службы хранения, шифрование на стороне клиента, протокол SMB 3.0 и шифрование дисков Azure."
services: storage
documentationcenter: .net
author: tamram
manager: timlt
editor: tysonn
ms.assetid: 6f931d94-ef5a-44c6-b1d9-8a3c9c327fb2
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: dotnet
ms.topic: article
ms.date: 12/08/2016
ms.author: tamram
ms.openlocfilehash: 9cb109dd9ce5a14bb80be61577c10d7191ec5ce6
ms.sourcegitcommit: 3fca41d1c978d4b9165666bb2a9a1fe2a13aabb6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/15/2017
---
# <a name="azure-storage-security-guide"></a>Руководство по безопасности службы хранилища Azure
## <a name="overview"></a>Обзор
Служба хранилища Azure предоставляет полный набор возможностей обеспечения безопасности, которые в совокупности позволяют разработчикам создавать защищенные приложения. Учетную запись хранения можно защитить с помощью управления доступом на основе ролей и Azure Active Directory. Защитить данные, передаваемые между приложением и Azure, можно с помощью [шифрования на стороне клиента](../storage-client-side-encryption.md), HTTPS или SMB 3.0. Вы можете настроить автоматическое шифрование данных при записи в службу хранилища Azure с помощью [шифрования службы хранилища (SSE)](storage-service-encryption.md). Для дисков ОС и данных, используемых виртуальными машинами, можно настроить шифрование с помощью функции [шифрования дисков Azure](../../security/azure-security-disk-encryption.md). Делегированный доступ к объектам данных в службе хранилища Azure можно предоставлять с помощью [подписанных URL-адресов](../storage-dotnet-shared-access-signature-part-1.md).

В этой статье содержатся общие сведения о функциях безопасности, которые можно использовать в службе хранилища Azure. Также приводятся ссылки на статьи с подробным описанием каждой функции.

В этой статье рассматриваются указанные ниже темы:

* [Безопасность плоскости управления](#management-plane-security) — защита учетной записи хранения

  Плоскость управления состоит из ресурсов, используемых для управления учетной записью хранения. В этом разделе мы рассмотрим модель развертывания с помощью Azure Resource Manager и использование управления доступом на основе ролей (RBAC) для контроля доступа к учетным записям хранения. Мы также поговорим об управлении ключами учетной записи хранения и их повторном создании.
* [Безопасность плоскости данных](#data-plane-security) — защита доступа к данным

  В этом разделе рассказывается о предоставлении доступа к объектам данных в учетной записи хранения, таким как большие двоичные объекты, файлы, очереди и таблицы, с помощью подписанных URL-адресов и хранимых политик доступа. Будут рассмотрены подписанные URL-адреса как уровня службы, так и уровня учетной записи. Вы также узнаете, как ограничить доступ к определенному IP-адресу (или диапазону IP-адресов), как запретить использование любых протоколов, кроме HTTPS, и как отозвать подписанный URL-адрес, не дожидаясь истечения срока его действия.
* [Шифрование при передаче](#encryption-in-transit)

  В этом разделе рассматривается, как можно защитить данные при передаче в службу хранилища Azure или из нее. Мы поговорим о рекомендуемых способах применения протокола HTTPS и методах шифрования, используемых протоколом SMB 3.0 для общих папок службы файлов Azure. Мы также рассмотрим функцию шифрования на стороне клиента, которая позволяет шифровать данные в клиентском приложении перед их передачей в хранилище и расшифровывать данные после их получения из хранилища.
* [Шифрование при хранении](#encryption-at-rest)

  Мы рассмотрим функцию шифрования службы хранилища и ее включение для учетной записи хранения для автоматического шифрования блочных, страничных и добавочных BLOB-объектов при их записи в службу хранилища Azure. Мы также расскажем, как применять шифрование дисков Azure, объясним основные различия между шифрованием дисков, шифрованием службы хранилища и шифрованием на стороне клиента, а также приведем сценарии использования каждого из этих вариантов. Вкратце будут рассмотрены вопросы обеспечения соответствия FIPS на компьютерах, используемых в государственных учреждениях США.
* Использование [аналитики хранилища](#storage-analytics) для аудита доступа к службе хранилища Azure

  В этом разделе рассматривается поиск информации о запросе в журналах аналитики хранилища. На примере реальных данных журнала аналитики хранилища вы увидите, как можно определить, был ли запрос совершен с помощью ключа учетной записи хранения, подписанного URL-адреса либо анонимно и был ли он выполнен успешно.
* [Поддержка браузерных клиентов с помощью CORS](#Cross-Origin-Resource-Sharing-CORS)

  В этом разделе рассказывается, как обеспечить общий доступ к ресурсам независимо от источника (CORS). Мы обсудим междоменный доступ и его поддержку с помощью возможностей CORS, встроенных в службу хранилища Azure.

## <a name="management-plane-security"></a>Безопасность плоскости управления
Плоскость управления образуют операции, которые влияют на саму учетную запись хранения. Например, это такие операции, как создание или удаление учетной записи хранения, получение списка учетных записей хранения, имеющихся в подписке, извлечение ключей учетных записей хранения и их повторное создание.

При создании учетной записи хранения необходимо выбрать модель развертывания: классическую или на основе Resource Manager. Классическая модель создания ресурсов в Azure обеспечивает доступ к подписке, а, следовательно, и к учетной записи хранения, только по принципу "все или ничего".

В этом руководстве в первую очередь рассматривается модель на основе Resource Manager, которая является рекомендуемым способом создания учетных записей хранения. С помощью учетных записей хранения Resource Manager вы можете не просто предоставить доступ ко всей подписке, а контролировать доступ к плоскости управления на детальном уровне, используя управление доступом на основе ролей (RBAC).

### <a name="how-to-secure-your-storage-account-with-role-based-access-control-rbac"></a>Защита учетной записи хранения с помощью управления доступом на основе ролей (RBAC)
Рассмотрим систему управления доступом на основе ролей и способы ее использования. Каждая подписка Azure имеет каталог Azure Active Directory. Пользователям, группам и приложениям из этого каталога может быть предоставлен доступ к управлению ресурсами в подписке Azure, для которых используется модель развертывания на основе Resource Manager. Это называется управлением доступом на основе ролей (RBAC). Для управления доступом можно использовать [портал Azure](https://portal.azure.com/), [инструменты интерфейса командной строки Azure (Azure CLI)](../../cli-install-nodejs.md), [PowerShell](/powershell/azureps-cmdlets-docs) или [интерфейсы REST API поставщика ресурсов службы хранилища Azure](https://msdn.microsoft.com/library/azure/mt163683.aspx).

При применении модели на основе Resource Manager учетная запись хранения помещается в группу ресурсов, а доступ к ее плоскости управления контролируется с помощью Azure Active Directory. Например, вы можете предоставить определенным пользователям доступ к ключам учетной записи хранения, а другим — запретить такой доступ, но разрешить просматривать информацию об учетной записи.

#### <a name="granting-access"></a>Предоставление доступа
Доступ предоставляется путем назначения соответствующей роли RBAC пользователям, группам и приложениям в подходящей области. Чтобы предоставить доступ ко всей подписке, назначьте роль на уровне подписки. Вы можете разрешить доступ всем ресурсам в группе ресурсов, предоставив разрешения самой группе. Вы также можете назначать определенные роли отдельным ресурсам, например учетным записям хранения.

Ниже приводятся основные моменты, которые необходимо знать об использовании RBAC для доступа к операциям управления учетной записью службы хранилища Azure.

* Предоставление доступа заключается в назначении роли соответствующей учетной записи. Вы можете контролировать доступ к операциям по управлению учетной записью хранения, но не к объектам данных в ней. Например, вы можете предоставить разрешение на извлечение свойств учетной записи хранения (например избыточности), но не на доступ к контейнеру или данным в контейнере в хранилище BLOB-объектов.
* Чтобы у пользователя было разрешение на доступ к объектам данных в учетной записи хранения, вы можете предоставить ему разрешение на чтение ключей учетной записи хранения. С помощью этих ключей пользователь сможет получать доступ к BLOB-объектам, очередям, таблицам и файлам.
* Роль можно назначить отдельной учетной записи пользователя, группе пользователей или отдельному приложению.
* Каждая роль имеет список разрешенных и запрещенных действий. Например, роль "Участник виртуальных машин" имеет разрешенное действие listKeys, которое позволяет читать ключи учетной записи хранения. Она также имеет запрещенные действия, например изменение прав доступа пользователей в Active Directory.
* Для службы хранилища доступны, помимо прочего, следующие роли:

  * "Владелец" — может управлять всем, включая доступ.
  * "Участник" — может выполнять те же действия, что и владелец, за исключением предоставления доступа. Пользователь с этой ролью может просматривать и повторно создавать ключи учетной записи хранения. С помощью этих ключей он может получать доступ к объектам данных.
  * "Читатель" — может просматривать сведения об учетной записи хранения, за исключением секретных данных. Например, если назначить пользователю роль читателя учетной записи хранения, то он сможет просматривать ее свойства, но не сможет вносить в них изменения или просматривать ключи учетной записи хранения.
  * "Участник учетных записей хранения" может управлять учетной записью хранения: читать сведения о ресурсах и группах ресурсов подписки, а также создавать развертывания групп ресурсов подписки и управлять ими. Он имеет доступ к ключам учетной записи хранения, а, следовательно, и к плоскости данных.
  * "Администратор доступа пользователей" — может управлять доступом пользователей к учетной записи хранения. Например, он может предоставить определенному пользователю доступ с правами читателя.
  * "Участник виртуальных машин" — может управлять виртуальными машинами, но не учетной записью хранения, к которой они подключены. Эта роль позволяет получать список ключей учетной записи хранения, поэтому пользователь с этой ролью может вносить изменения в плоскость данных.

    Чтобы пользователь мог создать виртуальную машину, у него должна быть возможность создать соответствующий файл VHD в учетной записи хранения. Для этого ему необходимо получить ключ учетной записи хранения и передать его в интерфейс API, с помощью которого создается виртуальная машина. Таким образом, пользователю требуется это разрешение для получения списка ключей учетной записи хранения.
* Возможность определять настраиваемые роли позволяет составлять наборы действий из списка доступных действий с ресурсами Azure.
* Прежде чем назначать роль пользователю, его необходимо создать в Azure Active Directory.
* С помощью PowerShell или интерфейса командной строки Azure можно создать отчет, содержащий сведения о том, кто предоставил или отозвал доступ, с какими правами, для каких пользователей и в какой области действия.

#### <a name="resources"></a>Ресурсы
* [Контроль доступа на основе ролей Azure Active Directory](../../active-directory/role-based-access-control-configure.md)

  В этой статье описывается система управления доступом на основе ролей в Azure Active Directory и принципы ее работы.
* [RBAC: встроенные роли](../../active-directory/role-based-access-built-in-roles.md)

  В этой статье подробно описываются встроенные роли RBAC.
* [Общие сведения о развертывании диспетчера ресурсов и классическом развертывании](../../azure-resource-manager/resource-manager-deployment-model.md)

  В этой статье рассматриваются модель развертывания с помощью Resource Manager и классическая модель, а также описываются преимущества использования Resource Manager и групп ресурсов. В ней описывается, как работают поставщики вычислительных и сетевых ресурсов, а также ресурсов службы хранилища Azure в рамках модели Resource Manager.
* [Управление доступом на основе ролей с помощью интерфейса REST API](../../active-directory/role-based-access-control-manage-access-rest.md)

  В этой статье показано, как использовать REST API для управления RBAC.
* [Справочник по API REST поставщика ресурсов службы хранилища Azure](https://msdn.microsoft.com/library/azure/mt163683.aspx)

  Справочник по интерфейсам API, с помощью которых можно управлять учетной записью хранения программными средствами.
* [Developer's guide to auth with Azure Resource Manager API](http://www.dushyantgill.com/blog/2015/05/23/developers-guide-to-auth-with-azure-resource-manager-api/) (Руководство разработчика по аутентификации с помощью API Azure Resource Manager)

  В этой статье показано, как выполнять аутентификацию с помощью интерфейсов API Resource Manager.
* [Конференция Ignite: управление доступом на основе ролей в Microsoft Azure](https://channel9.msdn.com/events/Ignite/2015/BRK2707)

  Это ссылка на видеоролик с конференции Microsoft Ignite 2015 на сайте Channel 9. На этой сессии обсуждались возможности управления доступом и ведения отчетов в Azure, а также давались рекомендации по защите доступа к подпискам Azure с помощью Azure Active Directory.

### <a name="managing-your-storage-account-keys"></a>Управление ключами учетной записи хранения
Ключи учетной записи хранения — это создаваемые в Azure 512-битные строки, которые можно использовать вместе с именем учетной записи хранения для доступа к хранящимся в ней объектам данных, например BLOB-объектам, сущностям в таблице, сообщениям в очереди и файлам в общей папке Azure. Контролируя доступ к ключам учетной записи хранения, можно управлять доступом к ее плоскости данных.

Каждая учетная запись хранения имеет два ключа, которые называются "Ключ 1" и "Ключ 2", на [портале Azure](http://portal.azure.com/) и в командлетах PowerShell. Их можно повторно создавать вручную различными способами, в том числе с помощью [портала Azure](https://portal.azure.com/), PowerShell и Azure CLI, или программными средствами с помощью клиентской библиотеки хранилища .NET или интерфейса REST API служб хранилища Azure.

Повторное создание ключей учетной записи хранения может требоваться по самым разным причинам.

* Вы можете регулярно создавать новые ключи в целях безопасности.
* Ключи учетной записи хранения необходимо создать повторно, если злоумышленнику удалось взломать приложение и извлечь ключ, который был жестко задан в коде или сохранен в файле конфигурации, получив таким образом полный доступ к учетной записи хранения.
* Ключи учетной записи хранения может потребоваться создать повторно и в том случае, если один из членов покидает вашу рабочую группу, использующую приложение "Обозреватель хранилищ", в котором хранятся эти ключи. Если не сделать этого, покинувший группу пользователь сохранит доступ к вашей учетной записи хранения. Это основная причина, по которой были созданы подписанные URL-адреса уровня учетной записи — вы можете использовать такой URL-адрес вместо хранения ключей доступа в файле конфигурации.

#### <a name="key-regeneration-plan"></a>План повторного создания ключей
Повторное создание ключей необходимо правильно спланировать. Если этого не сделать, доступ к учетной записи хранения может в какой-то момент оказаться полностью невозможным, что приведет к длительному простою. Именно поэтому используются два ключа. Повторно создавать ключи следует только по одному.

Перед повторным созданием ключей следует составить список всех приложений, работа которых зависит от учетной записи хранения, а также других используемых служб Azure. Например, если вы используете службы мультимедиа Azure, которые зависят от учетной записи хранения, повторно созданный ключ доступа необходимо еще раз синхронизировать с ними. Если вы используете какие-либо приложения, например обозреватель хранилищ, им также необходимо предоставить новые ключи. Имейте в виду, что если у вас есть виртуальные машины, файлы VHD которых хранятся в учетной записи хранения, повторное создание ключей не повлияет на их работу.

Ключи можно создать повторно на портале Azure. На синхронизацию повторно созданных ключей со службами хранилища может потребоваться до 10 минут.

Если вы готовы приступить к смене ключа, ниже приводится общее описание процедуры. В этом случае предполагается, что вы используете ключ 1 и хотите переключить все службы и приложения на использование ключа 2.

1. Создайте ключ 2 повторно, чтобы обеспечить его надежность. Это можно сделать на портале Azure.
2. Во всех приложениях, в которых хранится ключ к хранилищу данных, измените его так, чтобы использовалось новое значение ключа 2. Протестируйте и опубликуйте приложение.
3. После успешного запуска всех приложений и служб повторно создайте ключ 1. Это необходимо для того, чтобы пользователи, которым вы не предоставили новый ключ явным образом, утратили доступ к учетной записи хранения.

Если в настоящее время вы используете ключ 2, то можете использовать ту же процедуру, но поменять имена ключей.

Переход может длиться несколько дней, в течение которых вы настраиваете в каждом приложении использование нового ключа, а затем публикуете приложение. По завершении необходимо создать повторно старый ключ, чтобы он больше не работал.

Другой вариант — поместить ключ учетной записи хранения в [хранилище ключей Azure](https://azure.microsoft.com/services/key-vault/) в качестве секрета, чтобы приложения извлекали его оттуда. При повторном создании ключа и обновлении хранилища ключей Azure приложения не нужно будет развертывать повторно, так как они будут получать новый ключ из хранилища автоматически. Обратите внимание на то, что приложение может считывать ключ каждый раз, когда он необходим, либо можно кэшировать ключ в памяти, а в случае сбоя извлекать его повторно из хранилища ключей Azure.

Хранилище ключей Azure обеспечивает еще один уровень безопасности для ключей к хранилищу данных. При использовании этого метода вам не придется жестко задавать ключ в файле конфигурации, что устраняет риск получения доступа к ключам со стороны лиц, не имеющих соответствующих разрешений.

Еще одно преимущество использования хранилища ключей Azure — возможность контроля доступа к ключам с помощью Azure Active Directory. Это означает, что вы можете предоставить доступ набору приложений, которым необходимо извлекать ключ из хранилища ключей Azure, и при этом быть уверенными в том, что другие приложения не получат доступ к ключам, если только вы не предоставите им такое разрешение явно.

Примечание. Во всех приложениях рекомендуется использовать одновременно только один из ключей. Если в одних приложениях используется ключ 1, а в других — ключ 2, вы не сможете произвести смену ключей без того, чтобы некоторые приложения утратили доступ.

#### <a name="resources"></a>Ресурсы
* [Об учетных записях хранения Azure](storage-create-storage-account.md#regenerate-storage-access-keys)

  В этой статье приводятся общие сведения об учетных записях хранения и рассматривается просмотр, копирование и повторное создание ключей доступа к хранилищу.
* [Справочник по API REST поставщика ресурсов службы хранилища Azure](https://msdn.microsoft.com/library/mt163683.aspx)

  Здесь содержатся ссылки на статьи об извлечении ключей учетной записи хранения и их повторном создании для учетной записи Azure с помощью REST API. Примечание. Это относится к учетным записям хранения Resource Manager.
* [Операции с учетными записями хранения](https://msdn.microsoft.com/library/ee460790.aspx)

  Этот раздел в справочнике по REST API диспетчера службы хранилища содержит ссылки на разделы, посвященные извлечению и повторному созданию ключей учетной записи хранения в REST API. Примечание. Эти сведения предназначены для классических учетных записей хранения.
* [Попрощайтесь с управлением ключами — управляйте доступом к данным в службе хранилища Azure с помощью Azure AD](http://www.dushyantgill.com/blog/2015/04/26/say-goodbye-to-key-management-manage-access-to-azure-storage-data-using-azure-ad/)

  В этой статье показано, как использовать Active Directory для управления доступом к ключам службы хранилища Azure в хранилище ключей Azure. В ней также показано, как повторно создавать ключи каждый час с помощью задания службы автоматизации Azure.

## <a name="data-plane-security"></a>Безопасность плоскости данных
Под безопасностью плоскости данных понимаются методы защиты объектов данных в службе хранилища Azure Storage: BLOB-объектов, очередей, таблиц и файлов. Мы рассмотрели методы шифрования и защиты данных в процессе их передачи. Теперь поговорим об управлении доступом к объектам.

Существует два основных способа управления доступом к самим объектам данных. Первый заключается в управлении доступом к ключам учетной записи хранения, а второй — в использовании подписанных URL-адресов для предоставления доступа к отдельным объектам данных на определенный срок.

Кроме того, для хранилища BLOB-объектов можно предоставить общий доступ к BLOB-объектам, установив соответствующий уровень доступа для содержащего их контейнера. Если для контейнера установить уровень доступа "BLOB-объект" или "Контейнер", к BLOB-объектам в нем будет открыт общий доступ для чтения. Это означает, что любой пользователь с URL-адресом, указывающим на BLOB-объект в этом контейнере, сможет открыть его в браузере, не имея ключей учетной записи хранения и не используя подписанный URL-адрес.

Помимо ограничения доступа с помощью проверки подлинности вы также можете использовать [брандмауэры и виртуальные сети](storage-network-security.md) для ограничения доступа к учетной записи хранения на основе правил сети.  Этот подход позволяет запретить доступ к открытому интернет-трафику и предоставить доступ только к определенным виртуальным сетям Azure или к диапазонам общедоступных IP-адресов в Интернете.


### <a name="storage-account-keys"></a>Ключи учетной записи хранения
Ключи учетной записи хранения — это создаваемые в Azure 512-битные строки, которые можно использовать вместе с именем учетной записи хранения для доступа к хранящимся в ней объектам данных.

Например, с их помощью можно читать BLOB-объекты, записывать сообщения в очереди, создавать таблицы и изменять файлы. Многие из этих действий можно выполнять на портале Azure или с помощью различных приложений Storage Explorer. Для выполнения этих операций можно также написать код, использующий REST API или одну из клиентских библиотек хранилища.

Как указано в разделе, посвященном [безопасности плоскости управления](#management-plane-security), доступ к ключам для классической учетной записи хранения можно обеспечить, предоставив полный доступ к подписке Azure. Доступ к ключам для учетной записи хранения, использующей модель на основе Azure Resource Manager, можно контролировать посредством управления доступом на основе ролей (RBAC).

### <a name="how-to-delegate-access-to-objects-in-your-account-using-shared-access-signatures-and-stored-access-policies"></a>Делегирование доступа к объектам в учетной записи с помощью подписанных URL-адресов и хранимых политик доступа
Подписанный URL-адрес — это строка с токеном безопасности, который можно связать с универсальным кодом ресурса (URI), позволяющим делегировать доступ к объектам в хранилище и указывать ограничения, например разрешения и период времени доступа.

Доступ можно предоставлять к BLOB-объектам, контейнерам, сообщениям в очереди, файлам и таблицам. В случае с таблицами можно предоставить разрешение на доступ к диапазону сущностей, указав диапазоны ключей секций и строк, которые должны быть доступны пользователю. Например, если данные хранятся с ключом секции географического региона, можно предоставить пользователю доступ только к данным по Краснодарскому краю.

В другом примере веб-приложению предоставляется токен SAS, который позволяет ему записывать элементы в очередь, а приложению с рабочей ролью предоставляется токен SAS, позволяющий получать сообщения из очереди и обрабатывать их. Либо вы можете предоставить клиенту токен SAS, с помощью которого можно отправлять изображения в контейнер в хранилище BLOB-объектов, и предоставить веб-приложению разрешение на чтение этих изображений. В обоих случаях происходит разделение областей ответственности — каждому приложению можно предоставить только тот уровень доступа, который необходим ему для выполнения его задач. Это становится возможным благодаря использованию подписанных URL-адресов.

#### <a name="why-you-want-to-use-shared-access-signatures"></a>Причины использования подписанных URL-адресов.
Зачем использовать подписанный URL-адрес вместо того, чтобы просто предоставить ключ учетной записи хранения, что гораздо проще? Предоставляя ключ учетной записи хранения, вы открываете свободный доступ к хранилищу без каких-либо ограничений. С помощью этих ключей пользователь может, например, добавить всю свою коллекцию музыки в вашу учетную запись хранения. Он также может заменить ваши файлы на версии, зараженные вирусами, или украсть ваши данные. Предоставление неограниченного доступа к учетной записи хранения требует серьезного отношения.

С помощью подписанных URL-адресов вы можете предоставить клиенту только необходимые ему разрешения на ограниченный срок. Например, если кто-то отправляет BLOB-объект в вашу учетную запись, вы можете предоставить ему разрешение на запись на то время, которое требуется для отправки этого объекта (с учетом его размера, разумеется). Если вы изменили решение, то можете отозвать доступ.

Кроме того, вы можете указать, что запросы, совершаемые с помощью подписанного URL-адреса, ограничены определенным IP-адресом или диапазоном IP-адресов, внешним по отношению к Azure. Вы также можете указать, что запросы должны выполняться по определенному протоколу (HTTPS или HTTP/HTTPS). Например, если вы хотите разрешить только HTTPS-трафик, то можете задать HTTPS в качестве обязательного протокола, и HTTP-трафик будет блокироваться.

#### <a name="definition-of-a-shared-access-signature"></a>Определение подписанного URL-адреса
Подписанный URL-адрес — это набор параметров запроса, которые добавляются к URL-адресу, указывающему на ресурс.

Они содержат сведения о правах доступа и периоде времени, на который предоставляется доступ. Ниже приведен пример. Этот код URI предоставляет доступ для чтения BLOB-объекта на пять минут. Обратите внимание на то, что параметры запроса SAS должны иметь кодировку URL, например, двоеточие (:) должно обозначаться как %3A, а пробел — %20.

```
http://mystorage.blob.core.windows.net/mycontainer/myblob.txt (URL to the blob)
?sv=2015-04-05 (storage service version)
&st=2015-12-10T22%3A18%3A26Z (start time, in UTC time and URL encoded)
&se=2015-12-10T22%3A23%3A26Z (end time, in UTC time and URL encoded)
&sr=b (resource is a blob)
&sp=r (read access)
&sip=168.1.5.60-168.1.5.70 (requests can only come from this range of IP addresses)
&spr=https (only allow HTTPS requests)
&sig=Z%2FRHIX5Xcg0Mq2rqI3OlWTjEg2tYkboXr1P9ZUXDtkk%3D (signature used for the authentication of the SAS)
```

#### <a name="how-the-shared-access-signature-is-authenticated-by-the-azure-storage-service"></a>Проверка подлинности подписанного URL-адреса службой хранилища Azure
Когда служба хранилища получает запрос, она создает на основе входных параметров запроса подпись, используя тот же метод, что и вызывающая программа. Затем она сравнивает две подписи. Если они совпадают, служба хранилища проверяет, допустима ли версия службы, приходятся ли текущие дата и время на указанный период времени, соответствует ли запрошенный уровень доступа типу запроса и т. д.

Так, если в приведенном выше примере URL-адрес указывал бы на файл, а не на BLOB-объект, запрос не был бы выполнен, так как в нем указано, что подписанный URL-адрес соответствует BLOB-объекту. Если вызывалась бы команда REST для изменения BLOB-объекта, она не была бы выполнена, так как в подписанном URL-адресе указано, что разрешен доступ только для чтения.

#### <a name="types-of-shared-access-signatures"></a>Типы подписанных URL-адресов
* Подписанный URL-адрес уровня службы можно использовать для доступа к определенным ресурсам в учетной записи хранения. Это может быть, например, получение списка BLOB-объектов в контейнере, скачивание BLOB-объекта, изменение сущности в таблице, добавление сообщений в очередь или отправка файла в общую папку.
* Подписанный URL-адрес уровня учетной записи можно использовать для доступа к тем же объектам, что и подписанный URL-адрес уровня службы. Кроме того, он позволяет выполнять определенные действия с ресурсами, которые невозможны при использовании подписанного URL-адреса службы, например создавать контейнеры, таблицы, очереди и общие папки. Вы также можете настроить доступ к нескольким службам одновременно. Например, вы можете предоставить кому-либо доступ как к BLOB-объектам, так и к файлам в своей учетной записи хранения.

#### <a name="creating-an-sas-uri"></a>Создание универсального кода ресурса (URI) SAS
1. Вы можете создавать нерегламентированные коды URI по требованию, каждый раз определяя все параметры запроса.

   Это обеспечивает гибкость, но если у вас есть логически связанный и относительно постоянный набор параметров, лучше использовать хранимую политику доступа.
2. Хранимую политику доступа можно создать для всего контейнера, общей папки, таблицы или очереди. Затем ее можно использовать в качестве основы для создания кодов URI SAS. Разрешения на основе хранимых политик доступа можно легко отзывать. Для каждого контейнера, очереди, таблицы или общей папки можно определить до 5 политик.

   Например, если вы предполагаете, что много пользователей будет читать большие двоичные объекты в определенном контейнере, то вы можете создать хранимую политику доступа, предоставляющую доступ для чтения и содержащую параметры, которые повторяются каждый раз. Затем можно создать код URI SAS, используя параметры хранимой политики доступа и указав дату и время истечения срока действия. Преимущество в том, что вам не нужно каждый раз задавать все параметры запроса.

#### <a name="revocation"></a>Запрет доступа
Предположим, что подписанный URL-адрес был скомпрометирован или вы хотите изменить его в связи с корпоративными требованиями к безопасности или соответствию нормативам. Как запретить доступ к ресурсу, для которого используется этот подписанный URL-адрес? Это зависит от того, как был создан код URI SAS.

В случае с нерегламентированным кодом URI есть три варианта. Вы можете выдать токены SAS с коротким сроком действия и просто дождаться, когда этот срок истечет. Вы можете переименовать или удалить ресурс (при условии, что областью действия токена является один объект). Вы можете сменить ключи учетной записи хранения. Последний вариант может иметь существенные последствия, масштаб которых зависит от количества служб, использующих эту учетную запись хранения, и поэтому, как правило, требует определенного планирования.

Если подписанный URL-адрес был получен на основе хранимой политики доступа, то, чтобы запретить доступ, можно отменить хранимую политику доступа. Для этого можно указать, что срок ее действия истек, или полностью удалить ее. Это изменение вступает в силу немедленно и делает недействительными все подписанные URL-адреса, использующие эту хранимую политику доступа. Изменение или удаление хранимой политики доступа может повлиять на доступ пользователей к соответствующему контейнеру, общей папке, таблице или очереди с помощью подписанного URL-адреса, но если клиенты были разработаны так, чтобы запрашивать новый подписанный URL-адрес, когда старый становится недействительным, проблем не возникнет.

Та как подписанный URL-адрес, полученный на основе хранимой политики доступа, можно отозвать немедленно, рекомендуется использовать хранимые политики доступа всегда, когда это возможно.

#### <a name="resources"></a>Ресурсы
Более подробные сведения об использовании подписанных URL-адресов и хранимых политик доступа, проиллюстрированные примерами, см. в перечисленных ниже статьях.

* Справочные статьи:

  * [Подписанный URL-адрес уровня службы](https://msdn.microsoft.com/library/dn140256.aspx)

    В этой статье приводятся примеры использования подписанного URL-адреса уровня службы с BLOB-объектами, сообщениями в очереди, диапазонами в таблице и файлами.
  * [Создание подписанного URL-адреса уровня службы](https://msdn.microsoft.com/library/dn140255.aspx)
  * [Создание подписанного URL-адреса уровня учетной записи](https://msdn.microsoft.com/library/mt584140.aspx)
* Учебники по использованию клиентской библиотеки .NET для создания подписанных URL-адресов и хранимых политик доступа.

  * [Использование подписанных URL-адресов (SAS)](../storage-dotnet-shared-access-signature-part-1.md)
  * [Подписи общего доступа, часть 2: создание и использование подписи общего доступа с помощью службы BLOB-объектов](../blobs/storage-dotnet-shared-access-signature-part-2.md)

    Эта статья содержит описание модели SAS, примеры подписанных URL-адресов и рекомендации по их использованию. Также рассматривается процедура отзыва предоставленных разрешений.

* Authentication

  * [Проверка подлинности для служб хранилища Azure](https://msdn.microsoft.com/library/azure/dd179428.aspx)
* Учебник по началу работы с подписанными URL-адресами

  * [Учебник по началу работы с подписанными URL-адресами](https://github.com/Azure-Samples/storage-dotnet-sas-getting-started)

## <a name="encryption-in-transit"></a>Шифрование при передаче
### <a name="transport-level-encryption--using-https"></a>Шифрование на уровне транспорта с помощью протокола HTTPS
Еще одна мера, которую необходимо принять для защиты данных в службе хранилища Azure, — это шифрование данных между клиентом и службой хранилища Azure. Во-первых, рекомендуется всегда использовать протокол [HTTPS](https://en.wikipedia.org/wiki/HTTPS) , который обеспечивает безопасный обмен данными через Интернет.

Чтобы обеспечить защищенный канал связи, всегда используйте протокол HTTPS при вызове интерфейсов REST API или доступе к объектам в хранилище. Кроме того, **подписанные URL-адреса**, которые можно применять для доступа к объектам в службе хранилища Azure, дают возможность указывать, что с ними может использоваться только протокол HTTPS. Это позволяет гарантировать, что все получатели ссылок с маркерами SAS будут применять надлежащий протокол.

Можно принудительно задать использование протокола HTTPS при вызове интерфейсов REST API для доступа к объектам в учетных записях хранения, включив параметр [Требуется безопасное перемещение](../storage-require-secure-transfer.md) для учетной записи хранения. После этого подключения по протоколу HTTP будут отклоняться.

### <a name="using-encryption-during-transit-with-azure-file-shares"></a>Использование шифрования при обмене данными с общими папками Azure
Файлы Azure поддерживают протокол HTTPS при использовании API REST, но обычно используются в виде общей папки SMB, подключенной к виртуальной машине. Протокол SMB 2.1 не поддерживает шифрование, поэтому подключения допускаются только в пределах одного региона Azure. Однако протокол SMB 3.0 поддерживает шифрование и может использоваться в Windows Server 2012 R2, Windows 8, Windows 8.1 и Windows 10 для обеспечения доступа между регионами и даже для доступа на компьютере.

Обратите внимание, что хотя общие папки Azure можно использовать с Unix, клиент SMB для Linux пока не поддерживает шифрование, поэтому доступ разрешен только в пределах региона Azure. Реализация поддержки шифрования для Linux уже запланирована разработчиками Linux, отвечающими за функциональность SMB. Когда шифрование будет реализовано, в Linux будут те же возможности доступа к общей папке Azure, что и в Windows.

Можно принудительно задать применение шифрования для службы файлов Azure, включив параметр [Требуется безопасное перемещение](../storage-require-secure-transfer.md) для учетной записи хранения. Если используются интерфейсы REST API, требуется протокол HTTPS. При использовании протокола SMB будут успешно устанавливаться только подключения, поддерживающие шифрование.

#### <a name="resources"></a>Ресурсы
* [Общие сведения о файлах Azure](../files/storage-files-introduction.md)
* [Приступая к работе с файлами Azure в Windows](../files/storage-how-to-use-files-windows.md)

  В этой статье приводятся основные сведения об общих папках файлов Azure, а также их подключении и использовании в Windows.

* [Использование службы файлов Azure в Linux](../files/storage-how-to-use-files-linux.md)

  В этой статье показано, как подключить общую папку Azure в системе Linux и отправлять или скачивать файлы.

### <a name="using-client-side-encryption-to-secure-data-that-you-send-to-storage"></a>Использование шифрования на стороне клиента для защиты данных, отправляемых в хранилище
Еще одним средством обеспечения безопасности данных в процессе передачи между клиентским приложением и хранилищем является шифрование на стороне клиента. Данные шифруются перед передачей в службу хранилища Azure. При извлечении данных из службы хранилища Azure данные расшифровываются после получения клиентом. Даже несмотря на то, что данные шифруются при передаче по каналам связи, мы рекомендуем также использовать протокол HTTPS, так как в нем реализованы встроенные проверки целостности данных, позволяющие уменьшить последствия сетевых ошибок.

Шифрование на стороне клиента — это также способ защиты неактивных данных, так как данные хранятся в зашифрованной форме. Мы рассмотрим это более подробно в разделе, посвященном [шифрованию при хранении](#encryption-at-rest).

## <a name="encryption-at-rest"></a>Шифрование при хранении
В Azure есть три функции, обеспечивающие шифрование при хранении. Шифрование дисков Azure применяется для шифрования дисков операционной системы и данных в виртуальных машинах IaaS. Две другие — шифрование на стороне клиента и шифрование службы хранилища — применяются для шифрования данных в службе хранилища Azure. Рассмотрим каждую из этих функций, а затем сравним их и посмотрим, в каких случаях их можно использовать.

Хотя для шифрования передаваемых данных (а также для их хранения в зашифрованной форме в службе хранилища) можно использовать шифрование на стороне клиента, вы можете предпочесть использовать протокол HTTPS при передаче и обеспечить автоматическое шифрование сохраняемых данных каким-либо иным образом. Сделать это можно двумя способами: с помощью шифрования дисков Azure и с помощью шифрования службы хранилища. Первая функция служит для непосредственного шифрования данных на дисках ОС и данных, используемых виртуальными машинами, а другая — для шифрования данных, записываемых в хранилище BLOB-объектов Azure.

### <a name="storage-service-encryption-sse"></a>шифрования службы хранилища (SSE)
SSE позволяет настроить автоматическое шифрование данных, записываемых в службу хранилища Azure. При считывании данных они расшифровываются службой хранилища Azure перед возвратом. Это позволяет защитить данные, не изменяя код и не добавляя код в приложения.

Соответствующий параметр применяется ко всей учетной записи хранения. Изменяя значение этого параметра, можно включать и отключать функцию. Для этого можно использовать портал Azure, PowerShell, интерфейс командной строки Azure, REST API поставщика ресурсов службы хранилища или клиентскую библиотеку хранилища .NET. По умолчанию шифрование службы хранилища отключено.

В настоящее время ключами, используемыми для шифрования, управляет корпорация Майкрософт. Мы создаем исходные ключи и управляем их безопасным хранением, а также регулярной заменой в соответствии с внутренней политикой Майкрософт. В будущем вы получите возможность управлять ключами шифрования самостоятельно и вам будет предоставлен план перехода с ключей, управляемых корпорацией Майкрософт, на ключи, управляемые клиентом.

Эта функция доступна для учетных записей хранения категорий "Стандартный" и "Премиум", созданных с использованием модели развертывания с помощью Resource Manager. SSE относится к любой тип данных: блочные, страничные большие двоичные объекты, добавить больших двоичных объектов, таблиц, очередей и файлов.

Данные шифруются только в том случае, если шифрование службы хранилища включено и данные записываются в хранилище BLOB-объектов. Включение или отключение шифрования службы хранилища не влияет на существующие данные. Иными словами, при включении этой функции уже существующие данные не шифруются, а при ее отключении существующие данные не расшифровываются.

Если вы хотите использовать эту функцию с классической учетной записью хранения, то вы можете создать учетную запись хранения Resource Manager, а затем скопировать в нее данные с помощью программы AzCopy.

### <a name="client-side-encryption"></a>шифрования на стороне клиента
Мы упоминали шифрование на стороне клиента при обсуждении шифрования передаваемых данных. Эта функция позволяет шифровать данные программными средствами в клиентском приложении перед их отправкой по сети для записи в службу хранилища Azure и расшифровывать данные программными средствами после их получения из этой службы.

Таким образом обеспечивается не только шифрование при передаче, но и шифрование при хранении. Обратите внимание на то, что хотя данные шифруются при передаче, мы все же рекомендуем использовать протокол HTTPS, так как в нем реализованы встроенные проверки целостности данных, позволяющие уменьшить последствия сетевых ошибок.

Эту функцию можно использовать, например, в ситуации, когда имеется веб-приложение, которое сохраняет и извлекает BLOB-объекты, и вам нужно обеспечить максимальную безопасность приложения и данных. В этом случае следует применять шифрование на стороне клиента. Трафик между клиентом и службой BLOB-объектов Azure содержит зашифрованный ресурс, и никто не может перехватить передаваемые данные и воссоздать ваши личные BLOB-объекты.

Шифрование на стороне клиента встроено в клиентские библиотеки хранилища Java и .NET, которые, в свою очередь, используют API-интерфейсы хранилища ключей Azure, благодаря чему реализовать эту функцию совсем несложно. Шифрование и расшифровка данных производятся с применением методом конвертов. При этом метаданные, используемые в процессе шифрования, сохраняются в каждом объекте хранилища. Например, для BLOB-объектов они сохраняются в метаданных BLOB-объектов, а для очередей добавляются в каждое сообщение очереди.

Для самого процесса шифрования можно создавать собственные ключи шифрования и управлять ими. Кроме того, можно использовать ключи, созданные клиентской библиотекой хранилища Azure или хранилищем ключей Azure. Ключи шифрования можно хранить в локальном хранилище ключей или в хранилище ключей Azure. Хранилище ключей Azure позволяет предоставлять доступ к содержащимся в нем секретам определенным пользователям с помощью Azure Active Directory. Это означает, что не все могут читать данные из хранилища ключей Azure и получать ключи, используемые для шифрования на стороне клиента.

#### <a name="resources"></a>Ресурсы
* [Шифрование и расшифровка BLOB-объектов в хранилище Microsoft Azure с помощью хранилища ключей Azure](../blobs/storage-encrypt-decrypt-blobs-key-vault.md)

  В этой статье демонстрируется использование шифрования на стороне клиента с хранилищем ключей Azure, включая создание ключа обмена ключами и его сохранение в хранилище с помощью PowerShell.
* [Шифрование на стороне клиента для службы хранилища Microsoft Azure](../storage-client-side-encryption.md)

  В этой статье описывается шифрование на стороне клиента и приводятся примеры использования клиентской библиотеки хранилища для шифрования и расшифровки ресурсов из четырех служб хранилища. В ней также рассматривается хранилище ключей Azure.

### <a name="using-azure-disk-encryption-to-encrypt-disks-used-by-your-virtual-machines"></a>Применение шифрования дисков Azure для шифрования дисков, используемых виртуальными машинами
Шифрование дисков Azure — это новая функция. Она позволяет шифровать диски ОС и данных, используемые виртуальными машинами IaaS. Для Windows диски шифруются с помощью стандартной отраслевой технологии шифрования BitLocker. Для Linux диски шифруются с помощью технологии DM-Crypt. Функция интегрируется с хранилищем ключей Azure, что позволяет управлять ключами шифрования дисков.

В решениях, которые появляются в Microsoft Azure, реализована поддержка следующих возможностей для виртуальных машин IaaS:

* интеграция с хранилищем ключей Azure;
* виртуальные машины IaaS серий [A, D, DS, G, GS и т. д.](https://azure.microsoft.com/pricing/details/virtual-machines/) уровня "Стандартный";
* включение шифрования для виртуальных машин IaaS под управлением Windows и Linux;
* отключение шифрования дисков данных и дисков операционной системы виртуальных машин IaaS под управлением Windows;
* отключение шифрования дисков данных виртуальных машин IaaS под управлением Linux;
* включение шифрования для виртуальных машин IaaS под управлением клиентской ОС Windows;
* включение шифрования томов с путями подключения;
* включение шифрования для виртуальных машин Linux с чередованием дисков (RAID) с помощью программы mdadm;
* включение шифрования для виртуальных машин Linux с использованием диспетчера логических томов (LVM) для дисков данных;
* включение шифрования для виртуальных машин Windows, использующих дисковые пространства.
* поддерживаются все общедоступные регионы Azure.

В этом выпуске решения не поддерживаются следующие сценарии, функции и технологии:

* виртуальные машины уровня "Базовый";
* отключение шифрования диска ОС виртуальных машин IaaS под управлением Linux;
* виртуальные машины IaaS, созданные с помощью классической модели развертывания;
* интеграция с локальной службой управления ключами;
* служба файлов Azure (общая файловая система), NFS, динамические тома, виртуальные машины Windows с программными системами RAID.


> [!NOTE]
> Сейчас шифрование диска операционной системы Linux поддерживается для следующих дистрибутивов Linux: RHEL 7.2, CentOS 7.2n, Ubuntu 16.04.
>
>

Эта функция гарантирует, что все данные на дисках виртуальной машины шифруются при хранении в службе хранилища Azure.

#### <a name="resources"></a>Ресурсы
* [Дисковое шифрование Azure для виртуальных машин IaaS под управлением Windows и Linux](https://docs.microsoft.com/azure/security/azure-security-disk-encryption)

### <a name="comparison-of-azure-disk-encryption-sse-and-client-side-encryption"></a>Сравнение шифрования дисков Azure, шифрования службы хранилища и шифрования на стороне клиента
#### <a name="iaas-vms-and-their-vhd-files"></a>Виртуальные машины IaaS и их файлы VHD
Для дисков, используемых виртуальными машинами IaaS, мы рекомендуем шифрование дисков Azure. Вы можете включить шифрование службы хранилища для шифрования VHDфайлов, используемых для резервирования этих дисков в службе хранилища Azure, но при этом шифроваться будут только данные, записываемые с этого момента. Это означает, что если вы создадите виртуальную машину, а затем включите шифрование службы хранилища в учетной записи хранения, содержащей VHD-файл, то шифроваться будут только изменения, но не исходный VHD-файл.

При создании виртуальной машины из образа Azure Marketplace в вашу учетную запись хранения в службе хранилища Azure добавляется ее [неполная копия](https://en.wikipedia.org/wiki/Object_copying) , которая не шифруется, даже если включено шифрование службы хранилища. После создания виртуальной машины и начала обновления образа процесс шифрования службы хранилища начнет шифрование данных. По этой причине, если требуется полное шифрование виртуальных машин, созданных на основе образов из Azure Marketplace, лучше использовать шифрование дисков Azure.

Если вы переносите предварительно зашифрованную виртуальную машину в Azure из локальной среды, вы можете добавить ключи шифрования в хранилище ключей Azure и продолжать использовать для виртуальной машины тот же метод шифрования, что и в локальной среде. В этом сценарии включается шифрование дисков Azure.

Если имеется незашифрованный виртуальный жесткий диск из локальной среды, его можно отправить в коллекцию в качестве настраиваемого образа, а затем подготовить виртуальную машину на его основе. Если вы делаете это с помощью шаблонов Resource Manager, то можете настроить включение шифрования дисков Azure при загрузке виртуальной машины диспетчером Resource Manager.

Когда вы добавляете диск данных и подключаете его в виртуальной машине, вы можете включить для него шифрование дисков Azure. Сначала диск данных будет зашифрован локально, а затем уровень управления службами выполнит "ленивую" запись в хранилище, так что содержимое хранилища также будет зашифровано.

#### <a name="client-side-encryption"></a>шифрования на стороне клиента
Шифрование на стороне клиента является наиболее надежным способом шифрования данных, так как они шифруются перед передачей и при хранении неактивных данных. Однако оно требует добавления кода в приложения, использующие хранилище, что может быть нежелательным. В таких случаях можно применять протокол HTTPS для передаваемых данных и шифрование службы хранилища для неактивных данных.

С помощью шифрования на стороне клиента можно шифровать сущности в таблицах, сообщения в очередях и BLOB-объекты. С помощью шифрования службы хранилища можно шифровать только большие двоичные объекты. Если необходимо шифровать данные в таблицах и очередях, следует использовать шифрование на стороне клиента.

Шифрование на стороне клиента полностью управляется приложением. Это самый безопасный подход, который требует, однако, внесения программных изменений в приложение и реализации процессов управления ключами. Его следует использовать в том случае, если во время передачи данных требуется дополнительная безопасность и необходимо шифровать хранимые данные.

Шифрование на стороне клиента оказывает более значительную нагрузку на клиент, и это следует учитывать при разработке планов масштабируемости, особенно если вы передаете и шифруете большие объемы данных.

#### <a name="storage-service-encryption-sse"></a>шифрования службы хранилища (SSE)
SSE управляется службой хранилища Azure. Шифрование службы хранилища не обеспечивает защиту данных при передаче, но данные шифруются при записи в службу хранилища Azure. Использование этой функции не влияет на производительность.

Позволяет шифровать любые данные учетной записи хранилища с помощью инструкций SSE (блочные большие двоичные объекты, добавить больших двоичных объектов, страничные большие двоичные объекты, таблицы данных очереди и файлы).

Если имеется архив или библиотека VHD-файлов, на основе которой создаются виртуальные машины, вы можете создать новую учетную запись хранения, включить шифрование службы хранилища, а затем отправить данные VHD-файлы в эту учетную запись. Эти файлы VHD будут шифроваться службой хранилища Azure.

Если для дисков виртуальной машины включено шифрование дисков Azure, а для учетной записи хранения, содержащей VHD-файлы, — шифрование службы хранилища, то проблем не возникнет: новые данные будут дважды шифроваться при записи.

## <a name="storage-analytics"></a>аналитики хранилища
### <a name="using-storage-analytics-to-monitor-authorization-type"></a>Отслеживание типа авторизации с помощью аналитики хранилища
Для каждой учетной записи хранения можно включить аналитику службы хранилища Azure Storage Analytics с целью ведения журнала и сохранения данных метрик. Это очень полезное средство, если вам нужно проверить метрики производительности учетной записи хранения или устранить неполадки, связанные с ее производительностью.

Помимо этого, в журнале аналитики хранилища можно увидеть, как метод проверки подлинности применял тот или иной пользователь для доступа к хранилищу. Например, для хранилища BLOB-объектов можно узнать, использовался ли подписанный URL-адрес, ключ учетной записи хранения или BLOB-объект был общедоступным.

Это может быть очень полезным, если вы строго контролируете доступ к хранилищу. Например, в хранилище BLOB-объектов можно настроить все контейнеры как частные и реализовать использование службы SAS во всех приложениях. Затем можно регулярно проверять журналы для определения того, не осуществлялся ли доступ к большим двоичным объектам с помощью ключей учетной записи хранения, что может свидетельствовать о нарушении безопасности. Таким образом также можно установить, что большой двоичный объект является общедоступным, хотя он не должен быть таковым.

#### <a name="what-do-the-logs-look-like"></a>Как выглядят журналы?
После включения метрик и ведения журнала для учетной записи хранения на портале Azure данные аналитики начинают быстро накапливаться. Для каждой службы ведутся отдельные журналы и метрики. Данные в журнал записываются только при совершении действий в учетной записи хранения, в то время как метрики регистрируются каждую минуту, каждый час или каждый день в зависимости от настройки.

Журналы хранятся в блочных BLOB-объектах в контейнере с именем $logs в учетной записи хранения. Этот контейнер создается автоматически при включении аналитики хранилища. После того как этот контейнер создан, удалить его нельзя, но можно очистить его содержимое.

В контейнере $logs есть папка для каждой службы, в которой имеются вложенные папки, соответствующие годам, месяцам, дням и часам. В папках, соответствующих часам, журналы просто нумеруются. Структура каталогов выглядит так:

![Просмотр файлов журнала](./media/storage-security-guide/image1.png)

Каждый запрос к службе хранилища Azure регистрируется в журнале. Вот фрагмент файла журнала с первыми несколькими полями:

![Моментальный снимок файла журнала](./media/storage-security-guide/image2.png)

Как видите, журналы можно использовать для отслеживания любых обращений к учетной записи хранения.

#### <a name="what-are-all-of-those-fields-for"></a>Для чего нужны все эти поля?
В списке ресурсов ниже приведена статья, в которой перечислены все поля журналов и приведено описание их назначения. Вот список полей по порядку:

![Моментальный снимок полей в файле журнала](./media/storage-security-guide/image3.png)

Нас интересуют записи для GetBlob и способ их аутентификации, поэтому нам нужно найти записи, поле operation-type которых имеет значение "Get-Blob", и проверить поля request-status (4-й<sup></sup> столбец) и authorization-type (8-й<sup></sup> столбец).

Например, в первых нескольких строках в приведенном выше фрагменте поле request-status имеет значение "Success" (Успешно), а поле authorization-type — "authenticated" (проверка подлинности выполнена). Это означает, что запрос был проверен с помощью ключа учетной записи хранения.

#### <a name="how-are-my-blobs-being-authenticated"></a>Как производится проверка подлинности BLOB-объектов?
Нас интересуют три случая.

1. BLOB-объект является общедоступным, и доступ к нему осуществляется по URL-адресу без подписанного URL-адреса. В этом случае поле request-status имеет значение "AnonymousSuccess" (Успешный анонимный доступ), а поле authorization-type — "anonymous" (анонимный).

   1.0;2015-11-17T02:01:29.0488963Z;GetBlob;**AnonymousSuccess**;200;124;37;**anonymous**;;mystorage…
2. BLOB-объект является частным и использовался с подписанным URL-адресом. В этом случае поле request-status имеет значение "SASSuccess" (Успех SAS), а поле authorization-type — "sas".

   1.0;2015-11-16T18:30:05.6556115Z;GetBlob;**SASSuccess**;200;416;64;**sas**;;mystorage…
3. BLOB-объект является частным, а для доступа к нему использовался ключ к хранилищу данных. В этом случае поле request-status имеет значение **Success** (Успешно), а поле authorization-type — **authenticated** (проверка подлинности выполнена).

   1.0;2015-11-16T18:32:24.3174537Z;GetBlob;**Success**;206;59;22;**authenticated**;mystorage…

Для просмотра и анализа этих журналов можно использовать анализатор сообщений Майкрософт. В нем есть функции поиска и фильтрации. Например, вам может потребоваться найти экземпляры GetBlob в учетной записи хранения, чтобы узнать, используются ли они надлежащим образом.

#### <a name="resources"></a>Ресурсы
* [Аналитика службы хранилища](../storage-analytics.md)

  В этой статье содержатся общие сведения об аналитике хранилища и ее включении.
* [Формат журналов аналитик хранилища](https://msdn.microsoft.com/library/azure/hh343259.aspx)

  В этой статье демонстрируется формат журнала аналитики хранилища и подробно описываются доступные в нем поля, включая поле authentication-type, которое указывает на тип проверки подлинности, использовавшийся для запроса.
* [Мониторинг учетной записи хранения на портале Azure](../storage-monitor-storage-account.md)

  В этой статье показано, как настроить мониторинг метрик и ведение журналов для учетной записи хранения.
* [Комплексный поиск и устранение неполадок с помощью метрик хранилища Azure и ведения журнала, AzCopy и анализатора сообщений](../storage-e2e-troubleshooting.md)

  В этой статье рассматриваются способы устранения неполадок с помощью службы аналитики хранилища, а также рассказывается о том, как работать с анализатором сообщений Майкрософт.
* [Руководство по работе с анализатором сообщений (Майкрософт)](https://technet.microsoft.com/library/jj649776.aspx)

  Эта статья представляет собой справочник по анализатору сообщений Майкрософт и содержит ссылки на учебник, краткое руководство и сводку возможностей.

## <a name="cross-origin-resource-sharing-cors"></a>Общий доступ к ресурсам независимо от источника (CORS)
### <a name="cross-domain-access-of-resources"></a>Междоменный доступ к ресурсам
Когда из веб-браузера, работающего в одном домене, отправляется HTTP-запрос на получение ресурса из другого домена, такой запрос называется HTTP-запросом, не зависящим от источника. Например, с HTML-страницы, предоставляемой из домена contoso.com, выполняется запрос на получение JPEG-файла, размещенного в домене fabrikam.blob.core.windows.net. В целях безопасности браузеры блокируют не зависящие от источника HTTP-запросы, инициированные из скриптов, например на языке JavaScript. Это означает, что если какой-либо код JavaScript на веб-странице в домене contoso.com запрашивает JPEG-файл в домене fabrikam.blob.core.windows.net, браузер запрещает выполнение этого запроса.

Какое отношение это имеет к службе хранилища Azure? Если вы храните статичные ресурсы, например файлы данных JSON или XML, в хранилище BLOB-объектов в учетной записи хранения Fabrikam, доменом для этих ресурсов будет fabrikam.blob.core.windows.net, и веб-приложению в домене contoso.com не удастся получить к ним доступ с помощью JavaScript, так как домены не совпадают. Это верно и в том случае, если вы пытаетесь вызвать одну из служб хранилища Azure, например Хранилище таблиц, которое возвращает данные JSON для обработки клиентом JavaScript.

#### <a name="possible-solutions"></a>Возможные решения
Одно из решений — назначить домену fabrikam.blob.core.windows.net личный домен, например storage.contoso.com. Проблема в том, что этот личный домен можно назначить только одной учетной записи хранения, но ресурсы могут храниться в нескольких учетных записях.

Другой способ — сделать так, чтобы веб-приложение выступало в качестве прокси для вызовов службы хранилища. Это означает, что если вы отправляете файл в хранилище BLOB-объектов, веб-приложение либо записывает его локально, а затем копирует в хранилище BLOB-объектов, либо полностью считывает его, помещая в память, а затем записывает в хранилище BLOB-объектов. Кроме того, можно создать специальное веб-приложение (например веб-API), которое отправляет файлы локально и записывает их в хранилище BLOB-объектов. В любом случае эту функцию следует учитывать при определении потребностей в масштабируемости.

#### <a name="how-can-cors-help"></a>Как может помочь CORS?
Служба хранилища Azure позволяет включить CORS — общий доступ к ресурсам независимо от источника. Для каждой учетной записи хранения можно указать домены, которым разрешен доступ к ресурсам в ней. Например, в описанном выше случае можно включить CORS для учетной записи хранения fabrikam.blob.core.windows.net и настроить ее так, чтобы доступ к домену contoso.com был разрешен. После этого веб-приложение в домене contoso.com сможет напрямую обращаться к ресурсам в домене fabrikam.blob.core.windows.net.

Следует отметить, что CORS разрешает доступ, но не обеспечивает проверку подлинности, которая необходима для доступа к любым ресурсам хранилища, кроме общедоступных. Это означает, что доступ к BLOB-объектам возможен, только если они являются общедоступными или если включен подписанный URL-адрес, предоставляющий соответствующее разрешение. Таблицы, очереди и файлы не могут быть общедоступными и требуют подписанного URL-адреса.

По умолчанию механизм CORS отключен для всех служб. Включить CORS можно с помощью REST API или клиентской библиотеки хранилища, вызвав один из методов для задания политик службы. При этом необходимо включить правило CORS в формате XML. Ниже приведен пример правила CORS, определенного с помощью операции задания свойств службы для службы BLOB-объектов в учетной записи хранения. Выполнить эту операцию можно с помощью клиентской библиотеки хранилища или интерфейсов REST API для службы хранилища Azure.

```xml
<Cors>    
    <CorsRule>
        <AllowedOrigins>http://www.contoso.com, http://www.fabrikam.com</AllowedOrigins>
        <AllowedMethods>PUT,GET</AllowedMethods>
        <AllowedHeaders>x-ms-meta-data*,x-ms-meta-target*,x-ms-meta-abc</AllowedHeaders>
        <ExposedHeaders>x-ms-meta-*</ExposedHeaders>
        <MaxAgeInSeconds>200</MaxAgeInSeconds>
    </CorsRule>
<Cors>
```

Вот что означает каждая строка:

* **AllowedOrigins**. Определяет, какие несоответствующие домены могут запрашивать и получать данные из службы хранилища. В этом примере указано, что и домен contoso.com, и домен fabrikam.com могут запрашивать данные из хранилища BLOB-объектов для учетной записи хранения. Чтобы разрешить всем доменам доступ к запросам, можно указать в качестве значения подстановочный знак (\*).
* **AllowedMethods**. Список методов (команд HTTP-запросов), которые можно использовать при выполнении запроса. В этом примере разрешены только методы PUT и GET. Чтобы разрешить использование всех методов, можно указать в качестве значения подстановочный знак (\*).
* **AllowedHeaders**. Заголовки запроса, которые исходный домен может указывать в запросе. В этом примере разрешены все заголовки метаданных, которые начинаются с x-ms-meta-data, x-ms-meta-target и x-ms-meta-abc. Подстановочный знак (\*) указывает, что допустимыми являются все заголовки, начинающиеся с заданного префикса.
* **ExposedHeaders**. Определяет, какие заголовки ответов должны предоставляться браузером отправителю запроса. В этом примере это любые заголовки, начинающиеся с "x-ms-meta-".
* **MaxAgeInSeconds**. Максимальная продолжительность хранения предварительного запроса OPTIONS в кэше браузера. (Дополнительные сведения о предварительных запросах см. в первой статье в списке ниже.)

#### <a name="resources"></a>Ресурсы
Дополнительные сведения о механизме CORS и его включении см. в следующих ресурсах:

* [Поддержка общего доступа к ресурсам независимо от источника (CORS) для служб хранилища Azure (на сайте Azure.com)](../storage-cors-support.md)

  В этой статье приводятся общие сведения о механизме CORS и настройке правил для различных служб хранилища.
* [Поддержка общего доступа к ресурсам независимо от источника (CORS) для служб хранилища Azure (в MSDN)](https://msdn.microsoft.com/library/azure/dn535601.aspx)

  Это справочная документация по поддержке CORS для служб хранилища Azure. Она содержит ссылки на статьи, относящиеся к каждой службе, а также пример и описание каждого элемента в файле CORS.
* [Служба хранилища Microsoft Azure: знакомство с CORS](http://blogs.msdn.com/b/windowsazurestorage/archive/2014/02/03/windows-azure-storage-introducing-cors.aspx)

  Это ссылка на запись блога, в которой объявлялось о выходе CORS и демонстрировалось его использование.

## <a name="frequently-asked-questions-about-azure-storage-security"></a>Часто задаваемые вопросы о безопасности службы хранилища Azure
1. **Как можно проверять целостность больших двоичных объектов, передаваемых в службу хранилища Azure или из нее, если протокол HTTPS использовать невозможно?**

   Если для какой-либо причине необходимо использовать протокол HTTP вместо HTTPS, и вы работаете с блочными BLOB-объектами, то можно использовать проверку MD5 для проверки целостности передаваемых больших двоичных объектов. Это поможет защититься от ошибок транспортного и сетевого уровня, но не обязательно предотвратит атаки промежуточного уровня.

   Если можно использовать протокол HTTPS, который обеспечивает безопасность на транспортном уровне, то применение проверки MD5 является избыточным и ненужным.

   Дополнительные сведения см. в статье [Общие сведения о проверке MD5 BLOB-объектов Azure](http://blogs.msdn.com/b/windowsazurestorage/archive/2011/02/18/windows-azure-blob-md5-overview.aspx).
2. **Как обстоят дела с обеспечением соответствия FIPS в государственных учреждениях США?**

   Федеральный стандарт обработки информации (FIPS) определяет алгоритмы шифрования, одобренные к использованию в компьютерных системах федерального правительства США для защиты конфиденциальных данных. При включении режима FIPS на сервере или настольном компьютере с Windows операционной системе разрешается использовать только проверенные FIPS алгоритмы шифрования. Если приложение использует несовместимые алгоритмы, его работа будет прервана. При применении .NET Framework версии 4.5.2 или более поздней приложение автоматически переходит на использование алгоритмов шифрования, совместимых с FIPS, если компьютер находится в режиме FIPS.

   Корпорация Майкрософт оставляет за каждым клиентом право решать, следует ли включать режим FIPS. Мы не видим веских причин для включения режима FIPS по умолчанию, если деятельность клиента не подлежит правительственному контролю.

   **Ресурсы**

* [Почему мы больше не рекомендуем использовать режим FIPS](https://blogs.technet.microsoft.com/secguide/2014/04/07/why-were-not-recommending-fips-mode-anymore/)

  В этой записи блога приводятся общие сведения о FIPS и объясняется, почему режим FIPS не включен по умолчанию.
* [Проверка на соответствие стандарту FIPS 140](https://technet.microsoft.com/library/cc750357.aspx)

  В этой статье приводятся сведения о том, как продукты и модули шифрования Майкрософт соответствуют стандарту FIPS федерального правительства США.
* ["System cryptography: Use FIPS compliant algorithms for encryption, hashing, and signing" security settings effects in Windows XP and in later versions of Windows](https://support.microsoft.com/kb/811833) (Влияние параметров безопасности "Системная криптография: использовать FIPS-совместимые алгоритмы для шифрования, хэширования и подписывания" в Windows XP и более поздних версиях Windows)

  В этой статье рассказывается об использовании режима FIPS на более старых компьютерах с ОС Windows.

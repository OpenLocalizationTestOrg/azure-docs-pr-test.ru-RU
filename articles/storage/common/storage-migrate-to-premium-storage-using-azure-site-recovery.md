---
title: "Переход на хранилище Azure класса Premium с помощью Azure Site Recovery (неуправляемые диски) | Документация Майкрософт"
description: "Перенесите существующие виртуальные машины в хранилище Azure класса Premium с помощью Site Recovery (неуправляемые диски)."
services: storage
documentationcenter: 
author: luywang
manager: kavithag
ms.assetid: 
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/15/2017
ms.author: luywang
ms.openlocfilehash: fe9b5014d01e404919b53b8dc4812f357b1ca435
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="migrating-to-premium-storage-using-azure-site-recovery-unmanaged-disks"></a>Переход на хранилище класса Premium с помощью Azure Site Recovery (неуправляемые диски)

[Хранилище Azure класса Premium](storage-premium-storage.md) обеспечивает поддержку дисков с высокой производительностью и малой задержкой для виртуальных машин с интенсивной рабочей нагрузкой ввода-вывода. Это руководство предназначено упростить перенос дисков виртуальной машины из учетной записи хранения класса Standard в учетную запись хранения класса Premium с помощью [Azure Site Recovery](../../site-recovery/site-recovery-overview.md).

Служба Azure Site Recovery помогает реализовать стратегию аварийного восстановления и непрерывности бизнес-процессов. Она управляет процессами репликации локальных физических серверов и виртуальных машин в облако (Azure) или дополнительные центры обработки данных. При возникновении сбоев в исходном расположении происходит отработка отказа с выполнением перехода в дополнительное расположение. Это обеспечивает доступность приложений и рабочих нагрузок. При восстановлении нормального режима работы исходного расположения происходит переключение на него. Служба Site Recovery позволяет выполнять тестовую отработку отказа для поддержки аварийного восстановления, не влияя на рабочие среды. Вы можете выполнять отработки отказа с минимальной потерей данных (в зависимости от частоты репликации) в случае непредвиденных аварий. В случае перехода на хранилище уровня "Премиум" можно использовать [отработку отказа в Azure Site Recovery](../../site-recovery/site-recovery-failover.md), чтобы перенести целевые диски в учетную запись хранения уровня "Премиум".

Мы советуем переходить на хранилище класса Premium с помощью Site Recovery, так как этот способ обеспечивает минимальное время простоя и позволяет избежать копирования дисков и создания новых виртуальных машин вручную. В ходе отработки отказа Site Recovery будет систематически копировать диски и создавать новые виртуальные машины. Site Recovery поддерживает несколько типов отработки отказа — без простоя или с минимальным простоем. Чтобы спланировать время простоя и оценить потерю данных, см. сведения в разделе [Типы отработки отказа](../../site-recovery/site-recovery-failover.md). Если вы заранее [подготовились к подключению к виртуальным машинам Azure после отработки отказа](../../site-recovery/vmware-walkthrough-overview.md), то сможете подключиться к ним по протоколу подключения к удаленному рабочему столу.

![][1]

## <a name="azure-site-recovery-components"></a>Компоненты Azure Site Recovery

Это компоненты Site Recovery, которые относятся к этому сценарию миграции.

* **Сервер конфигурации** — виртуальная машина Azure, которая координирует обмен данными и управляет процессами репликации и восстановления данных. На этой виртуальной машине необходимо запустить отдельный файл установки, который устанавливает сервер конфигурации, а также дополнительный компонент в качестве шлюза репликации, который называется сервером обработки. См. дополнительные сведения о [требованиях к серверу конфигурации](../../site-recovery/vmware-walkthrough-overview.md). Сервер конфигурации настраивается один раз и может использоваться для всех операций переноса в одном регионе.

* **Сервер обработки** — это шлюз репликации, который получает данные репликации от исходных виртуальных машин, оптимизирует данные с помощью кэширования, сжатия и шифрования, а затем отправляет их в учетную запись хранения. Он также обеспечивает принудительную установку службы мобильности на исходных виртуальных машинах и выполняет автоматическое обнаружение исходных виртуальных машин. Сервер обработки по умолчанию устанавливается на сервере конфигурации. Для масштабирования среды можно развернуть дополнительные автономные серверы обработки. Ознакомьтесь с [рекомендациями по развертыванию сервера обработки](https://azure.microsoft.com/blog/best-practices-for-process-server-deployment-when-protecting-vmware-and-physical-workloads-with-azure-site-recovery/) и [дополнительных серверов обработки](../../site-recovery/site-recovery-plan-capacity-vmware.md#deploy-additional-process-servers). Сервер обработки настраивается один раз и может использоваться для всех операций переноса данных в одном регионе.

* **Служба мобильности** — это компонент, который развертывается на каждой стандартной виртуальной машине, для которой необходимо выполнить репликацию. Она фиксирует операции записи данных, выполняемые на стандартной виртуальной машине, и передает их на сервер обработки. Ознакомьтесь с [предварительными требованиями для реплицируемых компьютеров](../../site-recovery/vmware-walkthrough-overview.md).

На этом рисунке показано, как взаимодействуют эти компоненты.

![][15]

> [!NOTE]
> Site Recovery не поддерживает перенос дисков дисковых пространств.

Сведения о дополнительных компонентах для других сценариев см. в разделе [Архитектура сценария](../../site-recovery/vmware-walkthrough-overview.md).

## <a name="azure-essentials"></a>Основные компоненты Azure

Ниже приведены требования Azure для этого сценария миграции.

* Подписка Azure
* Учетная запись хранения Azure класса Premium для хранения реплицируемых данных.
* Виртуальная сеть Azure, к которой будут подключаться виртуальные машины, созданные при отработке отказа. Виртуальная сеть Azure должна располагаться в том же регионе, где выполняется Site Recovery.
* Учетная запись хранения Azure класса Standard для хранения журналов репликации. Это может быть та же учетная запись хранения, в которую переносятся диски виртуальных машин.

## <a name="prerequisites"></a>Предварительные требования

* Настроить компоненты сценария переноса данных, описанные в предыдущем разделе.
* Спланируйте время простоя, ознакомившись с [отработкой отказа в Site Recovery](../../site-recovery/site-recovery-failover.md).

## <a name="setup-and-migration-steps"></a>Этапы настройки и переноса данных

Site Recovery можно использовать для переноса виртуальных машин Azure IaaS между регионами или в одном регионе. Инструкции для этого сценария переноса данных основаны на шагах, описанных в статье [Репликация виртуальных машин VMware и физических компьютеров в Azure с помощью службы Azure Site Recovery и портала Azure](../../site-recovery/vmware-walkthrough-overview.md). Воспользуйтесь ссылками, чтобы получить подробные указания в дополнение к инструкциям, приведенным в этой статье.

1. **Создание хранилища служб восстановления**. Создайте хранилище Site Recovery и управляйте им с помощью [портала Azure](https://portal.azure.com). Щелкните **Создать** > **Управление** > **Архивация** и **Site Recovery (OMS)**. Также можно щелкнуть **Обзор** > **Хранилище служб восстановления** > **Добавить**. Виртуальные машины будут реплицированы в регион, указанный на этом шаге. Для переноса данных в пределах того же региона выберите регион, где находятся исходные виртуальные и машины и исходные учетные записи. 

2. Следующие шаги помогут вам **выбрать целевые объекты для защиты**.

    2.1. Откройте [портал Azure](https://portal.azure.com) на виртуальной машине, где нужно установить сервер конфигурации. Выберите **Хранилища служб восстановления** > **Параметры**. В разделе **Параметры** выберите **Site Recovery**. В разделе **Site Recovery** выберите **Шаг 1. Подготовка инфраструктуры**. В разделе **Подготовка инфраструктуры** выберите **Цель защиты**.

    ![][2]

    2.2. В разделе **Цель защиты** в первом раскрывающемся списке выберите **В Azure**. Во втором раскрывающемся списке выберите **Без виртуализации или иное**, а затем нажмите кнопку **ОК**.

    ![][3]

3. Следующие шаги помогут **настроить исходную среду (сервера конфигурации)**.

    3.1. Скачайте **программу единой установки Azure Site Recovery** и **ключ регистрации хранилища**. Для этого выберите **Подготовка инфраструктуры** > **Подготовка источника** > **Добавить сервер**. Ключ регистрации хранилища требуется для запуска программы единой установки. Ключ действителен в течение 5 дней после создания.

    ![][4]

    3.2. Добавьте сервер конфигурации в колонке **Добавить сервер**.

    ![][5]

    3.3. На виртуальной машине, которая используется в качестве сервера конфигурации, запустите программу единой установки, чтобы установить сервер конфигурации и сервер обработки. [Здесь](../../site-recovery/vmware-walkthrough-overview.md) показаны снимки экрана для всей процедуры установки. Ниже приведены снимки экрана для шагов, необходимых в этом сценарии переноса данных.

    На странице **Перед началом работы** выберите **Установить сервер конфигурации и сервер обработки**.

    ![][6]

    3.4. На странице **Регистрация** найдите и выберите регистрационный ключ, загруженный из хранилища.

    ![][7]

    3.5. На странице **Сведения о среде** укажите, нужно ли выполнять репликацию виртуальных машин VMware. В данном случае выберите **Нет**.

    ![][8]

    3.6. После завершения установки отобразится окно **сервера конфигурации Microsoft Azure Site Recovery**. Чтобы создать учетную запись, которую Site Recovery сможет использовать для автоматического обнаружения, используйте вкладку **Управление учетными записями**. (При защите физических компьютеров настройка учетной записи не нужна, однако вам потребуется по крайней мере одна учетная запись, чтобы выполнить одно из следующих действий. В этом случае для учетной записи можно задать любое имя и пароль.) Чтобы отправить файл учетных данных хранилища, используйте вкладку **Регистрация хранилища**.

    ![][9]

4. **Настройка целевой среды**. Щелкните **Подготовка инфраструктуры** > **Целевой объект** и укажите модель развертывания, которая будет использоваться для виртуальных машин после выполнения отработки отказа. В зависимости от конкретного сценария можно выбрать **классическую модель** или **модель развертывания Resource Manager**.

    ![][10]

    Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure. Обратите внимание, что если для реплицированных данных используется учетная запись хранения уровня "Премиум", потребуется настроить дополнительную учетную запись хранения уровня "Стандартный" для хранения журналов репликации.

5. **Настройте параметры репликации**. Выполните шаги, описанные в разделе [Настройка параметров репликации](../../site-recovery/vmware-walkthrough-overview.md), чтобы убедиться в том, что сервер конфигурации успешно связан с созданной политикой репликации.

6. **Планирование ресурсов**. Используйте [планировщик ресурсов](../../site-recovery/site-recovery-capacity-planner.md) для точной оценки требований к пропускной способности сети, хранилищу и других требований для репликации. После этого в поле **Вы выполнили планирование ресурсов?** выберите **Да**.

    ![][11]

7. Следующие шаги помогут **установить службу мобильности и включить репликацию**.

    7.1. Для исходных виртуальных машин можно выбрать [принудительную установку](../../site-recovery/vmware-walkthrough-overview.md) или [установить службу мобильности вручную](../../site-recovery/site-recovery-vmware-to-azure-install-mob-svc.md). Требования для принудительной установки и путь к ручному установщику можно найти, перейдя по указанной ссылке. При выполнении установки вручную может потребоваться использовать внутренний IP-адрес, чтобы найти сервер конфигурации.

    ![][12]

    Виртуальная машина после отработки отказа будет иметь два временных диска: один из основной виртуальной машины, а второй — созданный во время подготовки виртуальной машины в регионе восстановления. Чтобы исключить временный диск до репликации, установите службу мобильности, прежде чем включить репликацию. Дополнительные сведения о том, как исключить временный диск, см. в разделе [Исключение дисков из репликации](../../site-recovery/vmware-walkthrough-overview.md).

    7.2. Включите репликацию следующим образом:
      * Выберите **Репликация приложения** > **Источник**. Включив репликацию впервые, щелкните +Replicate (+Реплицировать) в хранилище, чтобы включить репликацию для дополнительных машин.
      * На шаге 1 выберите в качестве источника сервер обработки.
      * На шаге 2 укажите модель развертывания после отработки отказа, учетную запись хранения Premium для переноса данных, учетную запись хранения Standard для хранения журналов и виртуальную сеть для отработки отказа.
      * На шаге 3 добавьте защищенные виртуальные машины по IP-адресам (для их поиска может потребоваться внутренний IP-адрес).
      * На шаге 4 задайте свойства, выбрав учетные записи, настроенные ранее на сервере обработки.
      * На шаге 5 выберите созданную ранее политику репликации и настройте параметры репликации.
      Нажмите кнопку **ОК** и включите репликацию.

    > [!NOTE]
    > Когда виртуальная машина Azure освободится и перезапустится, нет никакой гарантии, что она получит тот же IP-адрес. Если IP-адрес сервера конфигурации, сервера обработки или защищенных виртуальных машин Azure изменится, репликация может быть выполнена неправильно.

    ![][13]

    При разработке среды службы хранилища Azure для каждой виртуальной машины в группе доступности рекомендуется использовать отдельные учетные записи хранения. Мы советуем вам следовать рекомендациям в отношении уровня хранения, чтобы [использовать несколько учетных записей хранения для каждой группы доступности](../../virtual-machines/windows/manage-availability.md). Распределение дисков виртуальной машины между несколькими учетными записями позволит повысить доступность хранилища. Кроме того, операции ввода-вывода будут распределены по инфраструктуре службы хранилища Azure. Если виртуальные машины находятся в группе доступности, вместо репликации дисков всех виртуальных машин в одну учетную запись хранения, рекомендуется выполнить перенос виртуальных машин по отдельности, чтобы виртуальные машины в той же группе доступности использовали разные учетные записи. Используйте колонку **Включение репликации**, чтобы настроить целевую учетную запись хранения для каждой виртуальной машины по отдельности. Вы можете выбрать модель развертывания после отработки отказа в соответствии со своими требованиями. Если выбрать Resource Manager в качестве модели развертывания после отработки отказа, вы сможете выполнять отработку отказа между виртуальными машинами Resource Manager или выполнять перенос классической виртуальной машины в виртуальную машину Resource Manager.

8. **Выполнение тестовой отработки отказа**. Чтобы проверить, завершена ли репликация, выберите Site Recovery и щелкните **Параметры** > **Реплицированные элементы**. Вы увидите состояние и прогресс процесса репликации в процентах. Когда первоначальная репликация завершится, запустите тестовую отработку отказа для проверки стратегии репликации. Подробное описание тестовой отработки отказа см. в статье [Репликация виртуальных машин VMware и физических компьютеров в Azure с помощью службы Azure Site Recovery и портала Azure](../../site-recovery/vmware-walkthrough-overview.md). Чтобы просмотреть состояние тестовой отработки отказа, выберите **Параметры** > **Задания** > **название_плана_отработки_отказа**. В открывшейся колонке вы увидите разбивку шагов и результаты выполнения (успешные и неудачные). Если какой-либо этап отработки отказа завершится ошибкой, щелкните его, чтобы просмотреть сообщение об ошибке. Прежде чем выполнять отработку отказа, убедитесь, что виртуальные машины и стратегия репликации соответствуют требованиям. Прочитайте раздел [Тестовая отработка отказа в Azure в Site Recovery](../../site-recovery/site-recovery-test-failover-to-azure.md), чтобы получить дополнительные сведения и инструкции по тестовой отработке отказа.

9. **Запустите отработку отказа**. После завершения тестовой отработки отказа запустите отработку отказа для переноса дисков в хранилище уровня "Премиум" и репликации экземпляров виртуальной машины. Выполните подробные инструкции в разделе [Запуск незапланированной отработки отказа](../../site-recovery/site-recovery-failover.md#run-a-failover). Установите флажок **Shut down VMs and synchronize the latest data** (Завершать работу виртуальных машин и синхронизировать последние данные). Этот флажок указывает, что Site Recovery следует завершать работу защищенных виртуальных машин и синхронизировать данные, чтобы можно было выполнять отработку отказа на основе последней версии данных. Если вы не установите этот флажок или попытка выполнить указанные выше действия окажется неудачной, то отработка отказа будет выполнена на основе последней доступной точки восстановления для виртуальной машины. Site Recovery создаст экземпляр виртуальной машины с типом виртуальной машины с поддержкой хранилища класса Premium или аналогичного типа. Сведения о производительности и стоимости различных экземпляров виртуальных машин см. на странице [Цены на виртуальные машины Windows](https://azure.microsoft.com/pricing/details/virtual-machines/windows/) или [Цены на виртуальные машины Linux](https://azure.microsoft.com/pricing/details/virtual-machines/linux/).

## <a name="post-migration-steps"></a>Действия после переноса данных

1. **Настройка и добавление реплицированных виртуальных машин в группу доступности (если применимо)**. Site Recovery не поддерживает перенос виртуальных машин вместе с группой доступности. В зависимости от типа развертывания реплицированной виртуальной машины выполните одно из следующих действий.
  * Для виртуальных машин, созданных с помощью классической модели развертывания, — добавьте виртуальную машину в группу доступности на портале Azure. Подробные инструкции см. в разделе [Добавление существующей виртуальной машины к группе доступности](../../virtual-machines/windows/classic/configure-availability.md#addmachine).
  * При использовании модели развертывания Resource Manager сохраните конфигурацию виртуальной машины, а затем удалите и заново создайте виртуальные машины в группе доступности. Чтобы сделать это, используйте скрипт, приведенный [здесь](https://gallery.technet.microsoft.com/Set-Azure-Resource-Manager-f7509ec4). Перед выполнением скрипта проверьте его ограничения и спланируйте время простоя.

2. **Удаление старых виртуальных машин и дисков**. Прежде чем удалять их, убедитесь, что диски класса Premium согласованы с исходными дисками и новые виртуальные машины выполняют функцию исходных виртуальных машин. При использовании модели развертывания Resource Manager удалите виртуальную машину и диски из исходных учетных записей хранения на портале Azure. При использовании классической модели развертывания можно удалить виртуальную машину и диски на классическом портале или на портале Azure. Если диск не удаляется даже после удаления виртуальной машины, см. статью [Устранение ошибок при удалении учетных записей хранения Azure, контейнеров или виртуальных жестких дисков в модели развертывания с помощью Resource Manager](storage-resource-manager-cannot-delete-storage-account-container-vhd.md).

3. **Очистка инфраструктуры Azure Site Recovery**. Если служба Site Recovery больше не нужна, можно удалить ее инфраструктуру. Для этого удалите реплицированные элементы, сервер конфигурации, политику восстановления и, наконец, хранилище Azure Site Recovery.

## <a name="troubleshooting"></a>Устранение неполадок

* [Мониторинг и устранение неполадок защиты виртуальных машин и физических серверов](../../site-recovery/site-recovery-monitoring-and-troubleshooting.md)
* [Форум Microsoft Azure Site Recovery](https://social.msdn.microsoft.com/Forums/azure/home?forum=hypervrecovmgr)

## <a name="next-steps"></a>Дальнейшие действия

Ознакомьтесь со следующими ресурсами для конкретных сценариев переноса виртуальных машин.

* [Перенос виртуальных машин Azure между учетными записями хранения.](https://azure.microsoft.com/blog/2014/10/22/migrate-azure-virtual-machines-between-storage-accounts/)
* [Создание и загрузка виртуального жесткого диска Windows Server в Azure.](../../virtual-machines/windows/classic/createupload-vhd.md?toc=%2fazure%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json)
* [Создание и загрузка виртуального жесткого диска, содержащего операционную систему Linux.](../../virtual-machines/linux/classic/create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2fclassic%2ftoc.json)
* [Перенос виртуальных машин из Amazon AWS в Microsoft Azure.](http://channel9.msdn.com/Series/Migrating-Virtual-Machines-from-Amazon-AWS-to-Microsoft-Azure)

Дополнительные сведения о службе хранилища Azure и виртуальных машинах Azure см. также в следующих источниках:

* [Хранилище Azure](https://azure.microsoft.com/documentation/services/storage/)
* [Виртуальные машины Azure](https://azure.microsoft.com/documentation/services/virtual-machines/)
* [Хранилище Premium: высокопроизводительное хранилище для рабочих нагрузок виртуальной машины Azure](storage-premium-storage.md)

[1]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-1.png
[2]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-2.png
[3]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-3.png
[4]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-4.png
[5]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-5.png
[6]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-6.PNG
[7]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-7.PNG
[8]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-8.PNG
[9]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-9.PNG
[10]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-10.png
[11]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-11.PNG
[12]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-12.PNG
[13]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-13.png
[14]:../site-recovery/media/site-recovery-vmware-to-azure/v2a-architecture-henry.png
[15]:./media/storage-migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-14.png

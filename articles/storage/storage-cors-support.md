---
title: "Поддержка доступ (CORS) aaaCross от источника ресурсов | Документы Microsoft"
description: "Дополнительные сведения о том, как tooenable поддержка CORS для службы хранилища Microsoft Azure hello."
services: storage
documentationcenter: .net
author: cbrooksmsft
manager: carmonm
editor: tysonn
ms.assetid: a0229595-5b64-4898-b8d6-fa2625ea6887
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: dotnet
ms.topic: article
ms.date: 2/22/2017
ms.author: cbrooks
ms.openlocfilehash: 0a6ec3bf6999c5faa7f0912dc2a47921aa01d3d4
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="cross-origin-resource-sharing-cors-support-for-hello-azure-storage-services"></a>Поддержка общего доступа к ресурсам независимо от источника (CORS) для hello служб хранилища Azure
Начиная с версии 2013-08-15, hello служб хранилища Azure поддерживают общий доступ к ресурсам независимо от источника (CORS) для службы BLOB-объекта, таблицы, очереди и файла hello. CORS является функцией HTTP, который позволяет веб-приложение в пределах одного домена tooaccess ресурсы в другом домене. Веб-браузеры имеют ограничение безопасности называется [политика одного источника](http://www.w3.org/Security/wiki/Same_Origin_Policy) , препятствующая веб-страницы из вызова API в других доменах. CORS обеспечивают безопасный способ tooallow одного домена (hello исходный домен) toocall API в другом домене. В разделе hello [спецификация CORS](http://www.w3.org/TR/cors/) Дополнительные сведения о CORS.

Можно задать правила CORS отдельно для каждого hello службы хранилища путем вызова [Set Blob Service Properties](https://msdn.microsoft.com/library/hh452235.aspx), [набор свойств службы очередей](https://msdn.microsoft.com/library/hh452232.aspx), и [установки таблицы свойств службы](https://msdn.microsoft.com/library/hh452240.aspx). После задания hello правил CORS для службы hello, прошедший проверку подлинности запроса к службе hello из другого домена будет вычисленное toodetermine toohello правила, заданные в соответствии с разрешена ли.

> [!NOTE]
> Обратите внимание, что CORS не является механизмом аутентификации. Любой запрос к ресурсу хранилища, в котором включен механизм CORS, должен иметь правильную подпись аутентификации или быть направлен к открытому ресурсу.
> 
> 

## <a name="understanding-cors-requests"></a>Общие сведения о запросах CORS
Запрос CORS из исходного домена может состоять из двух отдельных запросов:

* Предварительный запрос, который запрашивает ограничения CORS hello, наложенные службой hello. Hello Предварительный запрос является обязательным, если метод запроса hello [простой метод](http://www.w3.org/TR/cors/), то есть GET, HEAD или POST.
* Hello фактический запрос, к hello требуемого ресурса.

### <a name="preflight-request"></a>Предварительный запрос
Предварительный запрос Hello hello ограничения CORS, которые были установлены для hello службы хранилища владельцем учетной записи hello. Hello веб-браузер (или другой агент пользователя) отправляет запрос OPTIONS, включает заголовки запроса hello, метод и домен-источник. Hello служба хранилища оценивает hello предназначен операции на основе набора предварительно настроенных правил CORS, указывающие, какие домены-источники, методы запроса и заголовки запроса может быть указан в фактических запросах к ресурсу хранилища.

Если hello службе включен CORS и есть правило CORS, которому соответствует Предварительный запрос hello, hello служба отправляет код состояния 200 (ОК) и включает заголовки Access-Control требуется hello в ответ hello.

Если CORS не включен для службы hello или нет правила CORS соответствует Предварительный запрос hello, hello служба передаст код состояния 403 (запрещено).

Если запрос OPTIONS не содержит hello hello необходимые заголовки CORS (hello источника и заголовки Access-Control-Request-Method), hello служба передаст код состояния 400 (неправильный запрос).

Обратите внимание, что Предварительный запрос оценивается hello службы (больших двоичных объектов, очередей и таблиц), а не для hello запрашиваемый ресурс. Владелец учетной записи Hello необходимо включить механизм CORS при задании свойств службы учетных записей hello в порядке для запроса toosucceed hello.

### <a name="actual-request"></a>Фактический запрос
После принятия предварительного запросов hello и возвращается ответ hello, hello браузер отправляет сам запрос hello к ресурсу хранилища hello. браузер Hello запретит фактический запрос hello сразу же если hello Предварительный запрос отклоняется.

Hello фактический запрос считается обычным запросом к службе хранилища hello. Hello присутствие заголовка Origin hello указывает, что hello запрос является запросом CORS и hello служба будет проверять hello соответствия правилам CORS. Если соответствие найдено, заголовки hello управления доступом будут добавлены toohello ответа и отправляются назад toohello клиента. Если совпадение не найдено, hello заголовки CORS Access-Control не возвращаются.

## <a name="enabling-cors-for-hello-azure-storage-services"></a>Включение CORS для служб хранилища Azure hello
Правила CORS задаются на уровне службы hello, поэтому требуется tooenable или отключить CORS для каждой службы (больших двоичных объектов, очередей и таблиц) отдельно. По умолчанию механизм CORS отключен для всех служб. tooenable CORS необходимо tooset hello соответствующие свойства службы с помощью версии 2013-08-15 или более поздней версии и добавить правила CORS toohello свойств службы. Дополнительные сведения о том, как tooenable или отключать CORS для службы и работе правил tooset CORS, пожалуйста ссылаться слишком[Set Blob Service Properties](https://msdn.microsoft.com/library/hh452235.aspx), [набор свойств службы очередей](https://msdn.microsoft.com/library/hh452232.aspx), и [в таблице Свойств службы](https://msdn.microsoft.com/library/hh452240.aspx).

Далее приведен образец одного правила CORS, заданного с помощью операции Set Service Properties.

```xml
<Cors>    
    <CorsRule>
        <AllowedOrigins>http://www.contoso.com, http://www.fabrikam.com</AllowedOrigins>
        <AllowedMethods>PUT,GET</AllowedMethods>
        <AllowedHeaders>x-ms-meta-data*,x-ms-meta-target*,x-ms-meta-abc</AllowedHeaders>
        <ExposedHeaders>x-ms-meta-*</ExposedHeaders>
        <MaxAgeInSeconds>200</MaxAgeInSeconds>
    </CorsRule>
<Cors>
```

Все элементы, включаемые в правиле CORS hello описан ниже.

* **AllowedOrigins**: hello домены-источники, разрешенные toomake запроса к hello хранилища службы через CORS. Hello исходный домен является доменом hello, из какой hello поступил запрос. Обратите внимание, что hello origin должен быть в точности совпадать с учетом регистра, с источника hello, что возраст пользователя hello отправляет toohello службы. Можно также использовать hello подстановочный знак "*" tooallow все запросы toomake источника доменов через CORS. В приведенном выше примере hello, hello домены [http://www.contoso.com](http://www.contoso.com) и [http://www.fabrikam.com](http://www.fabrikam.com) могут делать запросы к службе hello посредством CORS.
* **AllowedMethods**: hello методы (команды HTTP-запросов), hello исходный домен может использовать для выполнения запроса CORS. В приведенном выше примере hello разрешены только запросы PUT и GET.
* **AllowedHeaders**: hello заголовки запроса, hello исходный домен может указывать на запрос CORS hello. В приведенном выше примере hello разрешены все заголовки метаданных, начиная с x-ms-meta-data, x-ms-meta цели и x-ms-meta-abc. Обратите внимание, что hello подстановочный знак "*" Указывает, что все заголовки, начинающиеся со слова hello указан префикс допускается.
* **ExposedHeaders**: hello заголовки ответа, которые могут отправлен в запрос CORS toohello ответа hello и предоставляемые hello браузера toohello запрос издателя. В примере hello выше hello браузера является соответствии tooexpose все заголовки, начинающиеся с x-ms-meta.
* **MaxAgeInSeconds**: hello максимальное количество времени, что браузер должен кэшировать Предварительный запрос OPTIONS hello.

Hello службы хранилища Azure поддерживают Указание заголовков с префиксами для обоих hello **AllowedHeaders** и **ExposedHeaders** элементов. tooallow категорию заголовков, можно указать категорию toothat Общий префикс. Например, указав *x-ms-meta** в качестве заголовка с префиксом, вы тем самым устанавливаете правило, соответствующее всем заголовкам, начинающимся с x-ms-meta.

Hello следующие ограничения применяются правила tooCORS.

* Можно указать вверх toofive правил CORS для службы хранилища (больших двоичных объектов, таблиц и очередей).
* Максимальный размер всех параметров правил CORS в запросе hello, за исключением XML-теги Hello не должен превышать 2 КБ.
* Hello длина разрешенного заголовка, представленного заголовка или разрешенного источника не должна превышать 256 символов.
* Разрешенные и представленные заголовки могут быть следующими:
  * Литеральные заголовки, где hello точное имя заголовка предоставляется, таких как **x-ms-meta-processed**. При запросе hello можно указать не более 64 литеральных заголовков.
  * Заголовки с префиксом, где указан префикс заголовка hello, таких как **x-ms-meta-data***. Этот способ задания префикс разрешает или предоставляет любой заголовок, который начинается с префиксом hello. При запросе hello можно указать не более 2 заголовков с префиксами.
* Hello методы (или HTTP-команды) указан в hello **AllowedMethods** элемент должен соответствовать toohello методам, поддерживаемым API службы хранилища Azure. Поддерживаемые методы: DELETE, GET, HEAD, MERGE, POST, OPTIONS и PUT.

## <a name="understanding-cors-rule-evaluation-logic"></a>Общие сведения о логике оценки правил CORS
Когда служба хранилища получает предварительный или фактический запрос, она оценивает этот запрос, на основе правил CORS hello, заданным для hello службы через hello соответствующие операции Set Service Properties. Правила CORS оцениваются в порядке hello, в котором они были заданы в тексте запроса hello hello операции Set Service Properties.

Правила CORS оцениваются следующим образом:

1. Во-первых, исходный домен hello hello запроса проверяется по hello доменов, указанных для hello **AllowedOrigins** элемента. Если исходный домен hello включается в список hello, или с символом-шаблоном hello разрешены все домены "*", то оценка правил продолжится. Если hello исходный домен не указан, hello запрос завершается ошибкой.
2. Затем метод hello (или HTTP-команды) hello запроса проверяется по hello методов, перечисленных в hello **AllowedMethods** элемента. Если метод hello включен в список hello, оценка правил продолжится. в противном случае происходит сбой запроса hello.
3. Если hello запрос соответствует правилу по своему домену-источнику и его метода, этого правила является запросом выбранного tooprocess hello и другим правилам вычисляются. Перед hello запрос завершится успешно, однако все заголовки, заданные в запросе hello проверяются hello заголовки, перечисленные в hello **AllowedHeaders** элемента. Если переданные заголовки hello hello допустимые заголовки не совпадают, происходит сбой запроса hello.

Поскольку hello правила обрабатываются в порядке hello они идут в тексте запроса hello, рекомендуется указать что hello наиболее строгие правила с учитывают tooorigins сначала в списке hello, чтобы они вычисляются первыми. Укажите правила, которые менее строгие например, правило tooallow все источники, указывайте в конце списка hello в hello.

### <a name="example--cors-rules-evaluation"></a>Пример: проверка соответствия правилам CORS
Hello примере показан частичный текст запроса для операции правила CORS tooset для служб хранилища hello. В разделе [Set Blob Service Properties](https://msdn.microsoft.com/library/hh452235.aspx), [набор свойств службы очередей](https://msdn.microsoft.com/library/hh452232.aspx), и [набор свойств службы таблиц](https://msdn.microsoft.com/library/hh452240.aspx) подробные сведения о построении запроса hello.

```xml
<Cors>
    <CorsRule>
        <AllowedOrigins>http://www.contoso.com</AllowedOrigins>
        <AllowedMethods>PUT,HEAD</AllowedMethods>
        <MaxAgeInSeconds>5</MaxAgeInSeconds>
        <ExposedHeaders>x-ms-*</ExposedHeaders>
        <AllowedHeaders>x-ms-blob-content-type, x-ms-blob-content-disposition</AllowedHeaders>
    </CorsRule>
    <CorsRule>
        <AllowedOrigins>*</AllowedOrigins>
        <AllowedMethods>PUT,GET</AllowedMethods>
        <MaxAgeInSeconds>5</MaxAgeInSeconds>
        <ExposedHeaders>x-ms-*</ExposedHeaders>
        <AllowedHeaders>x-ms-blob-content-type, x-ms-blob-content-disposition</AllowedHeaders>
    </CorsRule>
    <CorsRule>
        <AllowedOrigins>http://www.contoso.com</AllowedOrigins>
        <AllowedMethods>GET</AllowedMethods>
        <MaxAgeInSeconds>5</MaxAgeInSeconds>
        <ExposedHeaders>x-ms-*</ExposedHeaders>
        <AllowedHeaders>x-ms-client-request-id</AllowedHeaders>
    </CorsRule>
</Cors>
```

Теперь рассмотрим следующие запросы CORS hello:

| Запрос |  |  | Ответ |  |
| --- | --- | --- | --- | --- |
| **Метод** |**Исходный домен** |**Заголовки запроса** |**Проверяемое правило** |**Результат** |
| **PUT** |http://www.contoso.com |x-ms-blob-content-type |Первое правило |Успешно |
| **GET** |http://www.contoso.com |x-ms-blob-content-type |Второе правило |Успешно |
| **GET** |http://www.contoso.com |x-ms-client-request-id |Второе правило |Сбой |

Hello первый запрос соответствует первому правилу hello — hello исходный домен соответствует hello допускается источников, метод hello соответствует допускается методы hello и hello заголовок соответствует допустимые заголовки — hello и поэтому завершается успешно.

второй запрос Hello не соответствует первое правило hello несовпадения метод hello hello допускается методы. Тем не менее, соответствие hello второе правило, поэтому она успешно.

Hello третьего запроса соответствует второму правилу hello исходный домен и метод, поэтому вычисляются другим правилам. Здравствуйте, однако *заголовок x-ms клиент request-id* не разрешается в hello второе правило, поэтому hello запрос завершается ошибкой, несмотря на то что семантика hello hello третьего правила позволила бы ему toosucceed фактов hello.

> [!NOTE]
> Несмотря на то, что в этом примере показано менее строгое правило стоит перед более строгим, в целом hello рекомендуется наиболее строгие правила hello toolist сначала.
> 
> 

## <a name="understanding-how-hello-vary-header-is-set"></a>Понимание того, как задать Заголовок Vary hello
Hello *Vary* заголовок является стандартный заголовок HTTP/1.1, состоящая из набора полей заголовка запроса, которые сообщают hello браузеру или агенту пользователя о критериях hello, выбранные запросом hello tooprocess сервера hello. Hello *Vary* заголовок используется главным образом для кэширования, учетные записи-посредники, браузеры и CDN, которые используют его toodetermine кэширования ответа hello. Дополнительные сведения см. спецификацию hello для hello [заголовка Vary](http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html).

Когда hello браузер или другой агент пользователя кэширует hello ответ на запрос CORS, hello исходный домен кэшируется как hello допускается источника. Когда второй проблемы домена Здравствуйте же запрос ресурса хранилища, когда hello кэш активен, hello агент пользователя Получает кэшированный исходный домен hello. второй домен Hello не соответствует кэшированному домену hello, поэтому hello запрос завершается ошибкой, он бы в противном случае успешно. В некоторых случаях хранилище Azure задает заголовок Vary hello, слишком**источника** tooinstruct hello пользователя агента toosend hello последующих CORS запроса toohello службы при запросе домена отличается от hello hello кэшировании источника.

Хранилище Azure задает hello *Vary* заголовок слишком**источника** для фактических запросов GET/HEAD в следующих случаях hello:

* Когда запрос hello источника точно соответствует hello может источника определяется правилом CORS. toobe точное соответствие правилу CORS hello не может содержать подстановочные знаки "*" символов.
* Нет не источник запроса hello соответствующие правила, но включен CORS для службы хранилища hello.

В случае hello, где запрос GET/HEAD соответствует правилу CORS, которое допускает все источники ответ hello указывает, что все источники разрешены и hello кэш агента пользователя будет разрешать последующие запросы из любого домена-источника, когда hello кэш активен.

Обратите внимание, что для запросов, использующих методы, отличные от GET или HEAD, hello службы хранилища не будет устанавливать Заголовок Vary hello, так как методы toothese ответы не кэшируются агентами пользователя.

Hello в этой таблице перечислены как хранилище Azure будет отвечать tooGET-запросы HEAD в hello ранее упомянутых случаях:

| Запрос | Настройка учетной записи и результат проверки соответствия правилу |  |  | Ответ |  |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| **Заголовок исходного домена есть в запросе** |**Правила CORS, заданные для этой службы** |**Существует соответствующее правило, которое допускает все исходные домены(*)** |**Существует соответствующее правило для точно совпадающего исходного домена** |**Ответ включает tooOrigin набор заголовка Vary** |**Ответ содержит Access-Control-Allowed-Origin: "*"** |**Ответ содержит Access-Control-Exposed-Headers** |
| Нет |Нет |Нет |Нет |Нет |Нет |Нет |
| Нет |Да |Нет |Нет |Да |Нет |Нет |
| Нет |Да |Да |Нет |Нет |Да |Да |
| Да |Нет |Нет |Нет |Нет |Нет |Нет |
| Да |Да |Нет |Да |Да |Нет |Да |
| Да |Да |Нет |Нет |Да |Нет |Нет |
| Да |Да |Да |Нет |Нет |Да |Да |

## <a name="billing-for-cors-requests"></a>Выставление счетов за запросы CORS
Успешные предварительные запросы взимается плата, если вы включили CORS для любых служб хранилища hello для вашей учетной записи (вызвав [Set Blob Service Properties](https://msdn.microsoft.com/library/hh452235.aspx), [набор свойств службы очередей](https://msdn.microsoft.com/library/hh452232.aspx), или [ Задание свойств службы таблиц](https://msdn.microsoft.com/library/hh452240.aspx)). toominimize издержки, следует рассмотреть возможность установки hello **MaxAgeInSeconds** элемент в CORS правила tooa больших значений, чтобы hello агент пользователя кэширует hello запроса.

За невыполненные предварительные запросы плата не взимается.

## <a name="next-steps"></a>Дальнейшие действия
[Задание свойств службы BLOB-объектов](https://msdn.microsoft.com/library/hh452235.aspx)

[Задание свойств службы очередей](https://msdn.microsoft.com/library/hh452232.aspx)

[Задание свойств службы таблиц](https://msdn.microsoft.com/library/hh452240.aspx)

[Спецификация общего доступа к ресурсам, независимо от источника W3C](http://www.w3.org/TR/cors/)


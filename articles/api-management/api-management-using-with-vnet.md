---
title: "Как использовать управление API Azure с виртуальными сетями"
description: "Узнайте, как настроить подключение к виртуальной сети в управлении API Azure и обращаться к веб-службам через него."
services: api-management
documentationcenter: 
author: antonba
manager: erikre
editor: 
ms.assetid: 64b58f7b-ca22-47dc-89c0-f6bb0af27a48
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/15/2016
ms.author: apimpm
ms.openlocfilehash: 268cee739188d81feffc36ac07fcdfa18ff95a4d
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="how-to-use-azure-api-management-with-virtual-networks"></a><span data-ttu-id="13b78-103">Как использовать управление API Azure с виртуальными сетями</span><span class="sxs-lookup"><span data-stu-id="13b78-103">How to use Azure API Management with virtual networks</span></span>
<span data-ttu-id="13b78-104">Виртуальные сети Azure позволяют размещать любые ресурсы Azure в сети, недоступной из Интернета, доступом к которой управляете вы сами.</span><span class="sxs-lookup"><span data-stu-id="13b78-104">Azure Virtual Networks (VNETs) allow you to place any of your Azure resources in a non-internet routeable network that you control access to.</span></span> <span data-ttu-id="13b78-105">Эти сети можно подключать к локальным сетям с помощью различных технологий VPN.</span><span class="sxs-lookup"><span data-stu-id="13b78-105">These networks can then be connected to your on-premises networks using various VPN technologies.</span></span> <span data-ttu-id="13b78-106">Начать изучение виртуальных сетей Azure лучше всего со статьи [Обзор виртуальной сети](../virtual-network/virtual-networks-overview.md).</span><span class="sxs-lookup"><span data-stu-id="13b78-106">To learn more about Azure Virtual Networks start with the information here: [Azure Virtual Network Overview](../virtual-network/virtual-networks-overview.md).</span></span>

<span data-ttu-id="13b78-107">Службу управления API Azure можно развернуть в пределах виртуальной сети, обеспечив доступ к серверным службам в этой сети.</span><span class="sxs-lookup"><span data-stu-id="13b78-107">Azure API Management can be deployed inside the virtual network (VNET), so it can access backend services within the network.</span></span> <span data-ttu-id="13b78-108">Портал разработчика и шлюз API можно настроить для предоставления доступа как из Интернета, так и только в пределах виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="13b78-108">The developer portal and API gateway, can be configured to be accessible either from the Internet or only within the virtual network.</span></span>

> [!NOTE]
> <span data-ttu-id="13b78-109">Служба управления API Azure поддерживает классические виртуальные сети и виртуальные сети Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="13b78-109">Azure API Management supports both classic and Azure Resource Manager VNets.</span></span>
>
>

## <span data-ttu-id="13b78-110"><a name="enable-vpn"> </a>Включение подключения к виртуальной сети</span><span class="sxs-lookup"><span data-stu-id="13b78-110"><a name="enable-vpn"> </a>Enable VNET connection</span></span>
> [!NOTE]
> <span data-ttu-id="13b78-111">Возможность подключения к виртуальным сетям доступна на уровнях **Премиум** и **Developer**.</span><span class="sxs-lookup"><span data-stu-id="13b78-111">VNET connectivity is available in the **Premium** and **Developer** tiers.</span></span> <span data-ttu-id="13b78-112">Чтобы перейти на другой уровень, откройте службу управления API на портале Azure и перейдите на вкладку **Scale and pricing** (Масштабирование и цены). В разделе **Ценовая категория** выберите уровень "Премиум" или Developer и нажмите кнопку "Сохранить".</span><span class="sxs-lookup"><span data-stu-id="13b78-112">To switch between the tiers, open your API Management service in the Azure portal and then open the **Scale and pricing** tab. Under the **Pricing tier** section, select the Premium or Developer tier and click Save.</span></span>
>

<span data-ttu-id="13b78-113">Чтобы активировать подключения к виртуальным сетям, откройте службу управления API на портале Azure и перейдите на страницу **Виртуальная сеть**.</span><span class="sxs-lookup"><span data-stu-id="13b78-113">To enable VNET connectivity, open your API Management service in the Azure portal and open the **Virtual network** page.</span></span>

![Меню "Виртуальная сеть" для управления API][api-management-using-vnet-menu]

<span data-ttu-id="13b78-115">Выберите нужный тип доступа.</span><span class="sxs-lookup"><span data-stu-id="13b78-115">Select the desired access type:</span></span>

* <span data-ttu-id="13b78-116">**Внешний**: шлюз управления API и портал разработчика доступны из общедоступного Интернета через внешнюю подсистему балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="13b78-116">**External**: the API Management gateway and developer portal are accessible from the public internet via an external load balancer.</span></span> <span data-ttu-id="13b78-117">Шлюз может обращаться к ресурсам в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="13b78-117">The gateway can access resources within the virtual network.</span></span>

![Общедоступный пиринг][api-management-vnet-public]

* <span data-ttu-id="13b78-119">**Внутренний**: шлюз управления API и портал разработчика доступны только из виртуальной сети через внутреннюю подсистему балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="13b78-119">**Internal**: the API Management gateway and developer portal are accessible only from within the virtual network via an internal load balancer.</span></span> <span data-ttu-id="13b78-120">Шлюз может обращаться к ресурсам в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="13b78-120">The gateway can access resources within the virtual network.</span></span>

![Частный пиринг][api-management-vnet-private]

<span data-ttu-id="13b78-122">Будет показан список всех регионов, где предоставляется служба управления API.</span><span class="sxs-lookup"><span data-stu-id="13b78-122">You will now see a list of all regions where your API Management service is provisioned.</span></span> <span data-ttu-id="13b78-123">Выберите виртуальную сеть и подсеть для каждого региона.</span><span class="sxs-lookup"><span data-stu-id="13b78-123">Select a VNET and subnet for every region.</span></span> <span data-ttu-id="13b78-124">Список заполняется классическими виртуальными сетями и виртуальными сетями Resource Manager, имеющимися в подписках Azure, которые настроены в настраиваемом регионе.</span><span class="sxs-lookup"><span data-stu-id="13b78-124">The list is populated with both classic and Resource Manager virtual networks available in your Azure subscriptions that are setup in the region you are configuring.</span></span>

> [!NOTE]
> <span data-ttu-id="13b78-125">**Конечная точка службы** на схеме выше включает конечную точку шлюза или прокси-сервера, портала издателя и разработчика, GIT и конечную точку для прямого управления.</span><span class="sxs-lookup"><span data-stu-id="13b78-125">**Service Endpoint** in the above diagram includes Gateway/Proxy, Publisher Portal, Developer Portal, GIT, and the Direct Management Endpoint.</span></span>
> <span data-ttu-id="13b78-126">На схеме выше **конечная точка управления** размещается в службе для управления конфигурацией через портал Azure и PowerShell.</span><span class="sxs-lookup"><span data-stu-id="13b78-126">**Management Endpoint** in the above diagram is the endpoint hosted on the service to manage configuration via Azure portal and Powershell.</span></span>
> <span data-ttu-id="13b78-127">Кроме того, обратите внимание, что несмотря на то, что на схеме показаны IP-адреса различных конечных точек, служба управления API отвечает **только** на настроенных именах узлов.</span><span class="sxs-lookup"><span data-stu-id="13b78-127">Also, note, that, even though, the diagram shows IP Addresses for its various endpoints, API Management service **only** responds on its configured Hostnames.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="13b78-128">При развертывании экземпляра службы управления API Azure в виртуальной сети Resource Manager служба должна находиться в выделенной подсети, в которой нет других ресурсов, кроме экземпляров управления API Azure.</span><span class="sxs-lookup"><span data-stu-id="13b78-128">When deploying an Azure API Management instance to a Resource Manager VNET, the service must be in a dedicated subnet that contains no other resources except for Azure API Management instances.</span></span> <span data-ttu-id="13b78-129">Если попытаться развернуть экземпляр управления API Azure в подсети виртуальной сети Resource Manager, содержащей другие ресурсы, это приведет к сбою.</span><span class="sxs-lookup"><span data-stu-id="13b78-129">If an attempt is made to deploy an Azure API Management instance to a Resource Manager VNET subnet that contains other resources, the deployment will fail.</span></span>
>
>

![Выбор VPN][api-management-setup-vpn-select]

<span data-ttu-id="13b78-131">Щелкните **Сохранить** в верхней части экрана.</span><span class="sxs-lookup"><span data-stu-id="13b78-131">Click **Save** at the top of the screen.</span></span>

> [!NOTE]
> <span data-ttu-id="13b78-132">Виртуальный IP-адрес экземпляра управления API будет изменяться при каждом включении или отключении виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="13b78-132">The VIP address of the API Management instance will change each time VNET is enabled or disabled.</span></span>  
> <span data-ttu-id="13b78-133">Кроме того, виртуальный IP-адрес будет изменяться при изменении типа доступа для управления API с **внешнего** на **внутренний** или наоборот.</span><span class="sxs-lookup"><span data-stu-id="13b78-133">The VIP address will also change when API Management is moved from **External** to **Internal** or vice-versa</span></span>
>


> [!IMPORTANT]
> <span data-ttu-id="13b78-134">Если удалить службу управления API из виртуальной сети или изменить виртуальную сеть, в которой она развернута, ранее использовавшаяся виртуальная сеть может быть заблокирована на 4 часа.</span><span class="sxs-lookup"><span data-stu-id="13b78-134">If you remove API Management from a VNET or change the one it is deployed in, the previously used VNET can remain locked for up to 4 hours.</span></span> <span data-ttu-id="13b78-135">В этот период вы не сможете удалить виртуальную сеть или развернуть в ней новый ресурс.</span><span class="sxs-lookup"><span data-stu-id="13b78-135">During this period it will not be possible to delete the VNET or deploy a new resource to it.</span></span>

## <span data-ttu-id="13b78-136"><a name="enable-vnet-powershell"> </a>Активация подключения к виртуальной сети с помощью командлетов PowerShell</span><span class="sxs-lookup"><span data-stu-id="13b78-136"><a name="enable-vnet-powershell"> </a>Enable VNET connection using PowerShell cmdlets</span></span>
<span data-ttu-id="13b78-137">Подключение к виртуальной сети можно также активировать с помощью командлетов PowerShell.</span><span class="sxs-lookup"><span data-stu-id="13b78-137">You can also enable VNET connectivity using the PowerShell cmdlets</span></span>

* <span data-ttu-id="13b78-138">**Создание службы управления API в виртуальной сети**. Чтобы создать службу управления API Azure в виртуальной сети, используйте командлет [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement).</span><span class="sxs-lookup"><span data-stu-id="13b78-138">**Create an API Management service inside a VNET**: Use the cmdlet [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) to create an Azure API Management service inside a VNET.</span></span>

* <span data-ttu-id="13b78-139">**Развертывание существующей службы управления API в виртуальной сети**. Чтобы переместить существующую службу управления API Azure внутри виртуальной сети, используйте командлет [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment).</span><span class="sxs-lookup"><span data-stu-id="13b78-139">**Deploy an existing API Management service inside a VNET**: Use the cmdlet [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) to move an existing Azure API Management service inside a Virtual Network.</span></span>

## <span data-ttu-id="13b78-140"><a name="connect-vnet"> </a>Подключение к веб-службе, размещенной в виртуальной сети</span><span class="sxs-lookup"><span data-stu-id="13b78-140"><a name="connect-vnet"> </a>Connect to a web service hosted within a virtual Network</span></span>
<span data-ttu-id="13b78-141">После подключения службы управления API к виртуальной сети обращение к размещенным в ней внутренним службам ничем не будет отличаться от обращения к общедоступным службам.</span><span class="sxs-lookup"><span data-stu-id="13b78-141">After your API Management service is connected to the VNET, accessing backend services within it is no different than accessing public services.</span></span> <span data-ttu-id="13b78-142">Просто введите локальный IP-адрес или имя узла (если для виртуальной сети настроен DNS-сервер) веб-службы в поле **URL-адрес веб-службы** при создании нового API или редактировании существующего.</span><span class="sxs-lookup"><span data-stu-id="13b78-142">Just type in the local IP address or the host name (if a DNS server is configured for the VNET) of your web service into the **Web service URL** field when creating a new API or editing an existing one.</span></span>

![Добавление интерфейса API из VPN][api-management-setup-vpn-add-api]

## <span data-ttu-id="13b78-144"><a name="network-configuration-issues"> </a>Распространенные проблемы конфигурации сети</span><span class="sxs-lookup"><span data-stu-id="13b78-144"><a name="network-configuration-issues"> </a>Common Network Configuration Issues</span></span>
<span data-ttu-id="13b78-145">Ниже приведен список распространенных ошибок конфигурации, возникающих при развертывании службы управления API в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="13b78-145">Following is a list of common misconfiguration issues that can occur while deploying API Management service into a Virtual Network.</span></span>

* <span data-ttu-id="13b78-146">**Настройка пользовательского DNS-сервера**. Служба управления API зависит от нескольких служб Azure.</span><span class="sxs-lookup"><span data-stu-id="13b78-146">**Custom DNS server setup**: The API Management service depends on several Azure services.</span></span> <span data-ttu-id="13b78-147">Если служба управления API размещается в виртуальной сети, в которой используется пользовательский DNS-сервер, она должна разрешить имена узлов этих служб Azure.</span><span class="sxs-lookup"><span data-stu-id="13b78-147">When API Management is hosted in a VNET with a custom DNS server, it needs to resolve the hostnames of those Azure services.</span></span> <span data-ttu-id="13b78-148">Следуйте [этим](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) рекомендациям по настройке пользовательского DNS-сервера.</span><span class="sxs-lookup"><span data-stu-id="13b78-148">Please follow [this](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) guidance on custom DNS setup.</span></span> <span data-ttu-id="13b78-149">Для справки ниже приведена таблица портов, а также другие требования к сети.</span><span class="sxs-lookup"><span data-stu-id="13b78-149">See the ports table below and other network requirements for reference.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="13b78-150">При использовании настраиваемого DNS-сервера для виртуальной сети мы рекомендуем настроить его **перед** развертыванием службы управления API в этой сети.</span><span class="sxs-lookup"><span data-stu-id="13b78-150">It is recommended that, if you are using a Custom DNS Server(s) for the VNET, you set that up **before** deploying an API Management service into it.</span></span> <span data-ttu-id="13b78-151">В противном случае службу управления API необходимо обновлять каждый раз при изменении DNS-сервера, выполняя [операцию применения конфигурации сети](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates).</span><span class="sxs-lookup"><span data-stu-id="13b78-151">Otherwise you need to update the API Management service each time you change the DNS Servers(s) by running the [Apply Network Configuration Operation](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span></span>

* <span data-ttu-id="13b78-152">**Порты, необходимые для управления API**. Входящим и исходящим трафиком в подсети, в которой развернута служба управления API, можно управлять с помощью [группы безопасности сети][Network Security Group].</span><span class="sxs-lookup"><span data-stu-id="13b78-152">**Ports required for API Management**: Inbound and Outbound traffic into the Subnet in which API Management is deployed can be controlled using [Network Security Group][Network Security Group].</span></span> <span data-ttu-id="13b78-153">Если какой-либо из этих портов недоступен, служба управления API может не работать должным образом и даже стать недоступной.</span><span class="sxs-lookup"><span data-stu-id="13b78-153">If any of these ports are unavailable, API Management may not operate properly and may become inaccessible.</span></span> <span data-ttu-id="13b78-154">Блокировка одного или нескольких из этих портов является одной из распространенных проблем неправильной конфигурации при использовании управления API в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="13b78-154">Having one or more of these ports blocked is another common misconfiguration issue when using API Management with a VNET.</span></span>

<span data-ttu-id="13b78-155">При размещении экземпляра службы управления API в виртуальной сети используются порты, указанные в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="13b78-155">When an API Management service instance is hosted in a VNET, the ports in the following table are used.</span></span>

| <span data-ttu-id="13b78-156">Исходные и конечные порты</span><span class="sxs-lookup"><span data-stu-id="13b78-156">Source / Destination Port(s)</span></span> | <span data-ttu-id="13b78-157">Направление</span><span class="sxs-lookup"><span data-stu-id="13b78-157">Direction</span></span> | <span data-ttu-id="13b78-158">Транспортный протокол</span><span class="sxs-lookup"><span data-stu-id="13b78-158">Transport protocol</span></span> | <span data-ttu-id="13b78-159">Назначение</span><span class="sxs-lookup"><span data-stu-id="13b78-159">Purpose</span></span> | <span data-ttu-id="13b78-160">Ресурс и назначение</span><span class="sxs-lookup"><span data-stu-id="13b78-160">Source / Destination</span></span> | <span data-ttu-id="13b78-161">Тип доступа</span><span class="sxs-lookup"><span data-stu-id="13b78-161">Access type</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="13b78-162">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="13b78-162">* / 80, 443</span></span> |<span data-ttu-id="13b78-163">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="13b78-163">Inbound</span></span> |<span data-ttu-id="13b78-164">TCP</span><span class="sxs-lookup"><span data-stu-id="13b78-164">TCP</span></span> |<span data-ttu-id="13b78-165">Подключения клиентов к службе управления API</span><span class="sxs-lookup"><span data-stu-id="13b78-165">Client communication to API Management</span></span> |<span data-ttu-id="13b78-166">INTERNET — VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="13b78-166">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="13b78-167">Внешний</span><span class="sxs-lookup"><span data-stu-id="13b78-167">External</span></span> |
| <span data-ttu-id="13b78-168">* / 3443</span><span class="sxs-lookup"><span data-stu-id="13b78-168">* / 3443</span></span> |<span data-ttu-id="13b78-169">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="13b78-169">Inbound</span></span> |<span data-ttu-id="13b78-170">TCP</span><span class="sxs-lookup"><span data-stu-id="13b78-170">TCP</span></span> |<span data-ttu-id="13b78-171">Конечная точка управления для портала Azure и PowerShell</span><span class="sxs-lookup"><span data-stu-id="13b78-171">Management endpoint for Azure portal and Powershell</span></span> |<span data-ttu-id="13b78-172">INTERNET — VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="13b78-172">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="13b78-173">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="13b78-173">External & Internal</span></span> |
| <span data-ttu-id="13b78-174">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="13b78-174">* / 80, 443</span></span> |<span data-ttu-id="13b78-175">Исходящие</span><span class="sxs-lookup"><span data-stu-id="13b78-175">Outbound</span></span> |<span data-ttu-id="13b78-176">TCP</span><span class="sxs-lookup"><span data-stu-id="13b78-176">TCP</span></span> |<span data-ttu-id="13b78-177">Зависимость для службы хранилища Azure и служебной шины Azure</span><span class="sxs-lookup"><span data-stu-id="13b78-177">Dependency on Azure Storage and Azure Service Bus</span></span> |<span data-ttu-id="13b78-178">VIRTUAL_NETWORK — INTERNET</span><span class="sxs-lookup"><span data-stu-id="13b78-178">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="13b78-179">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="13b78-179">External & Internal</span></span> |
| <span data-ttu-id="13b78-180">* / 1433</span><span class="sxs-lookup"><span data-stu-id="13b78-180">* / 1433</span></span> |<span data-ttu-id="13b78-181">Исходящие</span><span class="sxs-lookup"><span data-stu-id="13b78-181">Outbound</span></span> |<span data-ttu-id="13b78-182">TCP</span><span class="sxs-lookup"><span data-stu-id="13b78-182">TCP</span></span> |<span data-ttu-id="13b78-183">Зависимость от SQL Azure</span><span class="sxs-lookup"><span data-stu-id="13b78-183">Dependency on Azure SQL</span></span> |<span data-ttu-id="13b78-184">VIRTUAL_NETWORK — INTERNET</span><span class="sxs-lookup"><span data-stu-id="13b78-184">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="13b78-185">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="13b78-185">External & Internal</span></span> |
| <span data-ttu-id="13b78-186">* / 11000 - 11999</span><span class="sxs-lookup"><span data-stu-id="13b78-186">* / 11000 - 11999</span></span> |<span data-ttu-id="13b78-187">Исходящие</span><span class="sxs-lookup"><span data-stu-id="13b78-187">Outbound</span></span> |<span data-ttu-id="13b78-188">TCP</span><span class="sxs-lookup"><span data-stu-id="13b78-188">TCP</span></span> |<span data-ttu-id="13b78-189">Зависимость от SQL Azure V12</span><span class="sxs-lookup"><span data-stu-id="13b78-189">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="13b78-190">VIRTUAL_NETWORK — INTERNET</span><span class="sxs-lookup"><span data-stu-id="13b78-190">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="13b78-191">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="13b78-191">External & Internal</span></span> |
| <span data-ttu-id="13b78-192">* / 14000 - 14999</span><span class="sxs-lookup"><span data-stu-id="13b78-192">* / 14000 - 14999</span></span> |<span data-ttu-id="13b78-193">Исходящие</span><span class="sxs-lookup"><span data-stu-id="13b78-193">Outbound</span></span> |<span data-ttu-id="13b78-194">TCP</span><span class="sxs-lookup"><span data-stu-id="13b78-194">TCP</span></span> |<span data-ttu-id="13b78-195">Зависимость от SQL Azure V12</span><span class="sxs-lookup"><span data-stu-id="13b78-195">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="13b78-196">VIRTUAL_NETWORK — INTERNET</span><span class="sxs-lookup"><span data-stu-id="13b78-196">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="13b78-197">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="13b78-197">External & Internal</span></span> |
| <span data-ttu-id="13b78-198">* / 5671</span><span class="sxs-lookup"><span data-stu-id="13b78-198">* / 5671</span></span> |<span data-ttu-id="13b78-199">Исходящие</span><span class="sxs-lookup"><span data-stu-id="13b78-199">Outbound</span></span> |<span data-ttu-id="13b78-200">AMQP</span><span class="sxs-lookup"><span data-stu-id="13b78-200">AMQP</span></span> |<span data-ttu-id="13b78-201">Зависимость для политики ведения журнала концентратора событий и агента мониторинга</span><span class="sxs-lookup"><span data-stu-id="13b78-201">Dependency for Log to Event Hub policy and monitoring agent</span></span> |<span data-ttu-id="13b78-202">VIRTUAL_NETWORK — INTERNET</span><span class="sxs-lookup"><span data-stu-id="13b78-202">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="13b78-203">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="13b78-203">External & Internal</span></span> |
| <span data-ttu-id="13b78-204">6381–6383 / 6381–6383</span><span class="sxs-lookup"><span data-stu-id="13b78-204">6381 - 6383 / 6381 - 6383</span></span> |<span data-ttu-id="13b78-205">Входящий и исходящий</span><span class="sxs-lookup"><span data-stu-id="13b78-205">Inbound & Outbound</span></span> |<span data-ttu-id="13b78-206">UDP</span><span class="sxs-lookup"><span data-stu-id="13b78-206">UDP</span></span> |<span data-ttu-id="13b78-207">Зависимость для кэша Redis</span><span class="sxs-lookup"><span data-stu-id="13b78-207">Dependency on Redis Cache</span></span> |<span data-ttu-id="13b78-208">VIRTUAL_NETWORK — VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="13b78-208">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="13b78-209">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="13b78-209">External & Internal</span></span> |-
| <span data-ttu-id="13b78-210">* / 445</span><span class="sxs-lookup"><span data-stu-id="13b78-210">* / 445</span></span> |<span data-ttu-id="13b78-211">Исходящие</span><span class="sxs-lookup"><span data-stu-id="13b78-211">Outbound</span></span> |<span data-ttu-id="13b78-212">TCP</span><span class="sxs-lookup"><span data-stu-id="13b78-212">TCP</span></span> |<span data-ttu-id="13b78-213">Зависимость для общей папки Azure для GIT</span><span class="sxs-lookup"><span data-stu-id="13b78-213">Dependency on Azure File Share for GIT</span></span> |<span data-ttu-id="13b78-214">VIRTUAL_NETWORK — INTERNET</span><span class="sxs-lookup"><span data-stu-id="13b78-214">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="13b78-215">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="13b78-215">External & Internal</span></span> |
| <span data-ttu-id="13b78-216">* / *</span><span class="sxs-lookup"><span data-stu-id="13b78-216">* / *</span></span> | <span data-ttu-id="13b78-217">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="13b78-217">Inbound</span></span> |<span data-ttu-id="13b78-218">TCP</span><span class="sxs-lookup"><span data-stu-id="13b78-218">TCP</span></span> |<span data-ttu-id="13b78-219">Подсистема балансировки нагрузки инфраструктуры Azure</span><span class="sxs-lookup"><span data-stu-id="13b78-219">Azure Infrastructure Load Balancer</span></span> | <span data-ttu-id="13b78-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="13b78-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="13b78-221">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="13b78-221">External & Internal</span></span> |

* <span data-ttu-id="13b78-222">**Функции SSL**. Чтобы разрешить создание и проверку цепочки сертификатов SSL, службе управления API требуется исходящее сетевое подключение к узлам ocsp.msocsp.com, mscrl.microsoft.com и crl.microsoft.com. Эта зависимость не является обязательной, если любой сертификат, передаваемый в службу управления API, содержит полную цепочку до корневого ЦС.</span><span class="sxs-lookup"><span data-stu-id="13b78-222">**SSL functionality**: To enable SSL certificate chain building and validation the API Management service needs Outbound network connectivity to ocsp.msocsp.com, mscrl.microsoft.com and crl.microsoft.com. This dependency is not required, if any certificate you upload to API Management contain the full chain to the CA root.</span></span>

* <span data-ttu-id="13b78-223">**Доступ к DNS**. Исходящий доступ через порт 53 необходим для обмена данными с DNS-серверами.</span><span class="sxs-lookup"><span data-stu-id="13b78-223">**DNS Access**: Outbound access on port 53 is required for communication with DNS servers.</span></span> <span data-ttu-id="13b78-224">Если на другой стороне VPN-шлюза имеется пользовательский DNS-сервер, этот сервер должен быть доступен из подсети, в которой размещена служба управления API.</span><span class="sxs-lookup"><span data-stu-id="13b78-224">If a custom DNS server exists on the other end of a VPN gateway, the DNS server must be reachable from the subnet hosting API Management.</span></span>

* <span data-ttu-id="13b78-225">**Наблюдение за работоспособностью и метриками**. Исходящее сетевое подключение к конечным точкам мониторинга Azure, которые разрешаются в следующих доменах: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span><span class="sxs-lookup"><span data-stu-id="13b78-225">**Metrics and Health Monitoring**: Outbound network connectivity to Azure Monitoring endpoints, which resolve under the following domains: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span></span>

* <span data-ttu-id="13b78-226">**Настройка ExpressRoute**. В типовой клиентской конфигурации определяется собственный основной маршрут (0.0.0.0/0), который направляет исходящий интернет-трафик в локальную среду.</span><span class="sxs-lookup"><span data-stu-id="13b78-226">**Express Route Setup**: A common customer configuration is to define their own default route (0.0.0.0/0) which forces outbound Internet traffic to instead flow on-premises.</span></span> <span data-ttu-id="13b78-227">Этот поток трафика неизменно прерывает подключение к службе управления API Azure, так как исходящий трафик или блокируется локально, или преобразуется с помощью NAT в нераспознаваемый набор адресов, которые больше не относятся к различным конечным точкам Azure.</span><span class="sxs-lookup"><span data-stu-id="13b78-227">This traffic flow invariably breaks connectivity with Azure API Management because the outbound traffic is either blocked on-premises, or NAT'd to an unrecognizable set of addresses that no longer work with various Azure endpoints.</span></span> <span data-ttu-id="13b78-228">Чтобы устранить эту проблему, следует указать один (или несколько) определяемый пользователем маршрут ([UDR][UDRs]) в подсети, которая содержит службу управления API Azure.</span><span class="sxs-lookup"><span data-stu-id="13b78-228">The solution is to define one (or more) user-defined routes ([UDRs][UDRs]) on the subnet that contains the Azure API Management.</span></span> <span data-ttu-id="13b78-229">Определяемые пользователем маршруты задают маршруты для подсети, которые будут использоваться вместо основного маршрута.</span><span class="sxs-lookup"><span data-stu-id="13b78-229">A UDR defines subnet-specific routes that will be honored instead of the default route.</span></span>
  <span data-ttu-id="13b78-230">При возможности рекомендуется использовать следующую конфигурацию:</span><span class="sxs-lookup"><span data-stu-id="13b78-230">If possible, it is recommended to use the following configuration:</span></span>
 * <span data-ttu-id="13b78-231">Конфигурация ExpressRoute объявляет маршрут 0.0.0.0/0 и по умолчанию организует принудительное туннелирование всех исходящих подключений в локальную среду.</span><span class="sxs-lookup"><span data-stu-id="13b78-231">The ExpressRoute configuration advertises 0.0.0.0/0 and by default force tunnels all outbound traffic on-premises.</span></span>
 * <span data-ttu-id="13b78-232">Определяемый пользователем маршрут, применяемый к подсети, которая содержит службу управления API Azure, определяет маршрут 0.0.0.0/0 с помощью типа следующего прыжка Интернета.</span><span class="sxs-lookup"><span data-stu-id="13b78-232">The UDR applied to the subnet containing the Azure API Management defines 0.0.0.0/0 with a next hop type of Internet.</span></span>
 <span data-ttu-id="13b78-233">В результате этих действий определяемый пользователем маршрут уровня подсети получает приоритет над принудительным туннелированием ExpressRoute, обеспечивая исходящий интернет-доступ из службы управления API Azure.</span><span class="sxs-lookup"><span data-stu-id="13b78-233">The combined effect of these steps is that the subnet level UDR takes precedence over the ExpressRoute forced tunneling, thus ensuring outbound Internet access from the Azure API Management.</span></span>

>[!WARNING]  
><span data-ttu-id="13b78-234">Служба управления API Azure не поддерживается с конфигурациями ExpressRoute, которые **неправильно осуществляют перекрестное объявление маршрутов из пути общедоступного пиринга в путь частного пиринга**.</span><span class="sxs-lookup"><span data-stu-id="13b78-234">Azure API Management is not supported with ExpressRoute configurations that **incorrectly cross-advertise routes from the public peering path to the private peering path**.</span></span> <span data-ttu-id="13b78-235">Конфигурации ExpressRoute, для которых настроен общедоступный пиринг, будут получать объявления маршрутов от корпорации Майкрософт для большого набора диапазонов IP-адресов Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="13b78-235">ExpressRoute configurations that have public peering configured, will receive route advertisements from Microsoft for a large set of Microsoft Azure IP address ranges.</span></span> <span data-ttu-id="13b78-236">Если эти диапазоны адресов неправильно перекрестно объявляются по пути частного пиринга, то все исходящие сетевые пакеты из подсети экземпляра управления API Azure неправильно принудительно туннелируются в локальную сетевую инфраструктуру клиента.</span><span class="sxs-lookup"><span data-stu-id="13b78-236">If these address ranges are incorrectly cross-advertised on the private peering path, the end result is that all outbound network packets from the Azure API Management instance's subnet are incorrectly force-tunneled to a customer's on-premises network infrastructure.</span></span> <span data-ttu-id="13b78-237">Этот сетевой поток нарушает работу службы управления API Azure.</span><span class="sxs-lookup"><span data-stu-id="13b78-237">This network flow breaks Azure API Management.</span></span> <span data-ttu-id="13b78-238">Решением этой проблемы является остановка перекрестного объявления маршрутов между путем общедоступного и закрытого пиринга.</span><span class="sxs-lookup"><span data-stu-id="13b78-238">The solution to this problem is to stop cross-advertising routes from the public peering path to the private peering path.</span></span>


## <span data-ttu-id="13b78-239"><a name="troubleshooting"> </a>Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="13b78-239"><a name="troubleshooting"> </a>Troubleshooting</span></span>
<span data-ttu-id="13b78-240">При внесении изменений в сеть воспользуйтесь [API NetworkStatus](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), чтобы проверить, не утратила ли служба управления API доступ к каким-либо критически важным ресурсам, от которых она зависит.</span><span class="sxs-lookup"><span data-stu-id="13b78-240">When making changes to your network, refer to [NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), to validate if the API Management service has not lost access to any of the critical resources which it depends upon.</span></span> <span data-ttu-id="13b78-241">Состояние подключения должно обновляться каждые 15 минут.</span><span class="sxs-lookup"><span data-stu-id="13b78-241">The connectivity status should be updated every 15 minutes.</span></span>

## <span data-ttu-id="13b78-242"><a name="limitations"> </a>Ограничения</span><span class="sxs-lookup"><span data-stu-id="13b78-242"><a name="limitations"> </a>Limitations</span></span>
* <span data-ttu-id="13b78-243">Подсеть, содержащая экземпляры службы управления API, не может содержать ресурсы Azure каких-либо других типов.</span><span class="sxs-lookup"><span data-stu-id="13b78-243">A subnet containing API Management instances cannot contain any other Azure resource types.</span></span>
* <span data-ttu-id="13b78-244">Эта подсеть и служба управления API должны находиться в одной подписке.</span><span class="sxs-lookup"><span data-stu-id="13b78-244">The subnet and the API Management service must be in the same subscription.</span></span>
* <span data-ttu-id="13b78-245">Невозможно переместить между подписками подсеть, содержащую экземпляры службы управления API.</span><span class="sxs-lookup"><span data-stu-id="13b78-245">A subnet containing API Management instances cannot be moved across subscriptions.</span></span>
* <span data-ttu-id="13b78-246">При использовании внутренней виртуальной сети будет доступен только внутренний IP-адрес из диапазона, перечисленного в документе [RFC 1918](https://tools.ietf.org/html/rfc1918). Общедоступный IP-адрес предоставить невозможно.</span><span class="sxs-lookup"><span data-stu-id="13b78-246">When using an internal virtual network, only an internal IP address will be available from the range stated in [RFC 1918](https://tools.ietf.org/html/rfc1918), a public IP address cannot be provided.</span></span>
* <span data-ttu-id="13b78-247">При развертывании службы управления API с внутренними виртуальными сетями в нескольких регионах пользователи отвечают за управление собственной балансировкой нагрузки, так как им принадлежит служба DNS.</span><span class="sxs-lookup"><span data-stu-id="13b78-247">For multi-region API Management deployments, with Internal virtual networks configured, users are responsible for managing their own load balancing as they own the DNS.</span></span>


## <span data-ttu-id="13b78-248"><a name="related-content"> </a>Связанная информация</span><span class="sxs-lookup"><span data-stu-id="13b78-248"><a name="related-content"> </a>Related content</span></span>
* [<span data-ttu-id="13b78-249">Подключение типа "сеть — сеть" и многосайтовое подключение (через VPN-туннель IPsec/IKE)</span><span class="sxs-lookup"><span data-stu-id="13b78-249">Connecting a Virtual Network to backend using Vpn Gateway</span></span>](../vpn-gateway/vpn-gateway-about-vpngateways.md#s2smulti)
* [<span data-ttu-id="13b78-250">Подключение виртуальных сетей из различных моделей развертывания с использованием PowerShell</span><span class="sxs-lookup"><span data-stu-id="13b78-250">Connecting a Virtual Network from different deployment models</span></span>](../vpn-gateway/vpn-gateway-connect-different-deployment-models-powershell.md)
* [<span data-ttu-id="13b78-251">Как использовать инспектор API для трассировки вызовов в службе управления API Azure</span><span class="sxs-lookup"><span data-stu-id="13b78-251">How to use the API Inspector to trace calls in Azure API Management</span></span>](api-management-howto-api-inspector.md)

[api-management-using-vnet-menu]: ./media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-type.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: ./media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: ./media/api-management-using-with-vnet/api-management-vnet-private.png
[api-management-vnet-public]: ./media/api-management-using-with-vnet/api-management-vnet-public.png

[Enable VPN connections]: #enable-vpn
[Connect to a web service behind VPN]: #connect-vpn
[Related content]: #related-content

[UDRs]: ../virtual-network/virtual-networks-udr-overview.md
[Network Security Group]: ../virtual-network/virtual-networks-nsg.md

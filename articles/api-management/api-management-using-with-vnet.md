---
title: "toouse aaaHow API управления Azure с виртуальными сетями"
description: "Узнайте, как toosetup tooa подключения виртуальной сети в Azure API управления и доступа к веб-служб через него."
services: api-management
documentationcenter: 
author: antonba
manager: erikre
editor: 
ms.assetid: 64b58f7b-ca22-47dc-89c0-f6bb0af27a48
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/15/2016
ms.author: apimpm
ms.openlocfilehash: 426b3974e4fed7daffdb0c3f02381edbc326dc28
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="how-toouse-azure-api-management-with-virtual-networks"></a><span data-ttu-id="d9325-103">Как toouse API управления Azure с виртуальными сетями</span><span class="sxs-lookup"><span data-stu-id="d9325-103">How toouse Azure API Management with virtual networks</span></span>
<span data-ttu-id="d9325-104">Виртуальные сети (Vnet) позволяют tooplace, все ресурсы Azure в сети routeable не через Интернет, которым можно управлять доступом к.</span><span class="sxs-lookup"><span data-stu-id="d9325-104">Azure Virtual Networks (VNETs) allow you tooplace any of your Azure resources in a non-internet routeable network that you control access to.</span></span> <span data-ttu-id="d9325-105">Затем эти сети можно подключенных tooyour локальным сетям с использованием различных технологий VPN.</span><span class="sxs-lookup"><span data-stu-id="d9325-105">These networks can then be connected tooyour on-premises networks using various VPN technologies.</span></span> <span data-ttu-id="d9325-106">Дополнительные сведения о виртуальных сетях Azure начинаться с здесь сведения hello toolearn: [Обзор виртуальной сети Azure](../virtual-network/virtual-networks-overview.md).</span><span class="sxs-lookup"><span data-stu-id="d9325-106">toolearn more about Azure Virtual Networks start with hello information here: [Azure Virtual Network Overview](../virtual-network/virtual-networks-overview.md).</span></span>

<span data-ttu-id="d9325-107">Управления API Azure можно развернуть внутри hello виртуальной сети (VNET), поэтому он получает доступ к внутренним службам в сети hello.</span><span class="sxs-lookup"><span data-stu-id="d9325-107">Azure API Management can be deployed inside hello virtual network (VNET), so it can access backend services within hello network.</span></span> <span data-ttu-id="d9325-108">Hello портал разработчиков и шлюза API могут быть настроенный toobe, доступном из Интернета hello или только в пределах виртуальной сети hello.</span><span class="sxs-lookup"><span data-stu-id="d9325-108">hello developer portal and API gateway, can be configured toobe accessible either from hello Internet or only within hello virtual network.</span></span>

> [!NOTE]
> <span data-ttu-id="d9325-109">Служба управления API Azure поддерживает классические виртуальные сети и виртуальные сети Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="d9325-109">Azure API Management supports both classic and Azure Resource Manager VNets.</span></span>
>
>

## <span data-ttu-id="d9325-110"><a name="enable-vpn"> </a>Включение подключения к виртуальной сети</span><span class="sxs-lookup"><span data-stu-id="d9325-110"><a name="enable-vpn"> </a>Enable VNET connection</span></span>
> [!NOTE]
> <span data-ttu-id="d9325-111">Подключение виртуальной сети доступно hello **Premium** и **разработчика** уровней.</span><span class="sxs-lookup"><span data-stu-id="d9325-111">VNET connectivity is available in hello **Premium** and **Developer** tiers.</span></span> <span data-ttu-id="d9325-112">tooswitch между уровнями hello, откройте службу управления API в hello портал Azure, а затем откройте hello **масштабирования и ценах** вкладки. В разделе hello **Ценовая категория** установите для уровня Premium или разработчика hello и нажмите кнопку Сохранить.</span><span class="sxs-lookup"><span data-stu-id="d9325-112">tooswitch between hello tiers, open your API Management service in hello Azure portal and then open hello **Scale and pricing** tab. Under hello **Pricing tier** section, select hello Premium or Developer tier and click Save.</span></span>
>

<span data-ttu-id="d9325-113">tooenable подключение к виртуальной сети, откройте службу управления API в hello портал Azure и откройте hello **виртуальная сеть** страницы.</span><span class="sxs-lookup"><span data-stu-id="d9325-113">tooenable VNET connectivity, open your API Management service in hello Azure portal and open hello **Virtual network** page.</span></span>

![Меню "Виртуальная сеть" для управления API][api-management-using-vnet-menu]

<span data-ttu-id="d9325-115">Выберите тип требуемой hello доступа:</span><span class="sxs-lookup"><span data-stu-id="d9325-115">Select hello desired access type:</span></span>

* <span data-ttu-id="d9325-116">**Внешние**: hello API управления шлюза и разработчик портала доступны из hello общедоступный Интернет через внешней подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="d9325-116">**External**: hello API Management gateway and developer portal are accessible from hello public internet via an external load balancer.</span></span> <span data-ttu-id="d9325-117">доступ к ресурсам в виртуальной сети hello Hello шлюза.</span><span class="sxs-lookup"><span data-stu-id="d9325-117">hello gateway can access resources within hello virtual network.</span></span>

![Общедоступный пиринг][api-management-vnet-public]

* <span data-ttu-id="d9325-119">**Внутренняя**: hello API управления шлюза и разработчик портала доступны только внутри hello виртуальной сети через внутренний балансировщик нагрузки.</span><span class="sxs-lookup"><span data-stu-id="d9325-119">**Internal**: hello API Management gateway and developer portal are accessible only from within hello virtual network via an internal load balancer.</span></span> <span data-ttu-id="d9325-120">доступ к ресурсам в виртуальной сети hello Hello шлюза.</span><span class="sxs-lookup"><span data-stu-id="d9325-120">hello gateway can access resources within hello virtual network.</span></span>

![Частный пиринг][api-management-vnet-private]

<span data-ttu-id="d9325-122">Будет показан список всех регионов, где предоставляется служба управления API.</span><span class="sxs-lookup"><span data-stu-id="d9325-122">You will now see a list of all regions where your API Management service is provisioned.</span></span> <span data-ttu-id="d9325-123">Выберите виртуальную сеть и подсеть для каждого региона.</span><span class="sxs-lookup"><span data-stu-id="d9325-123">Select a VNET and subnet for every region.</span></span> <span data-ttu-id="d9325-124">Hello список заполняется классический и диспетчер ресурсов виртуальных сетей, имеющихся в вашей подписки Azure, которые настраиваются в области hello, которую вы настраиваете.</span><span class="sxs-lookup"><span data-stu-id="d9325-124">hello list is populated with both classic and Resource Manager virtual networks available in your Azure subscriptions that are setup in hello region you are configuring.</span></span>

> [!NOTE]
> <span data-ttu-id="d9325-125">**Конечная точка службы** в hello выше схема включает шлюза или прокси-сервера, портал издателя, портал разработчиков, GIT и hello прямого управления конечной точки.</span><span class="sxs-lookup"><span data-stu-id="d9325-125">**Service Endpoint** in hello above diagram includes Gateway/Proxy, Publisher Portal, Developer Portal, GIT, and hello Direct Management Endpoint.</span></span>
> <span data-ttu-id="d9325-126">**Конечная точка управления** в hello выше схема является hello конечную точку, размещенную в конфигурации toomanage hello службы через портал Azure и Powershell.</span><span class="sxs-lookup"><span data-stu-id="d9325-126">**Management Endpoint** in hello above diagram is hello endpoint hosted on hello service toomanage configuration via Azure portal and Powershell.</span></span>
> <span data-ttu-id="d9325-127">Кроме того, обратите внимание, что, даже если hello показан IP-адресов для различных конечных точек, служба управления API **только** реагирует на его настроенных имен узлов.</span><span class="sxs-lookup"><span data-stu-id="d9325-127">Also, note, that, even though, hello diagram shows IP Addresses for its various endpoints, API Management service **only** responds on its configured Hostnames.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="d9325-128">При развертывании tooa экземпляр управления API Azure Resource Manager виртуальной сети, служба hello должна быть в выделенной подсетью, не содержит другие ресурсы, за исключением экземпляров службы управления API Azure.</span><span class="sxs-lookup"><span data-stu-id="d9325-128">When deploying an Azure API Management instance tooa Resource Manager VNET, hello service must be in a dedicated subnet that contains no other resources except for Azure API Management instances.</span></span> <span data-ttu-id="d9325-129">Если попытаться сделать это toodeploy tooa экземпляра службы управления API Azure подсети виртуальной сети диспетчер ресурсов, которая содержит другие ресурсы, hello развертывания не удастся.</span><span class="sxs-lookup"><span data-stu-id="d9325-129">If an attempt is made toodeploy an Azure API Management instance tooa Resource Manager VNET subnet that contains other resources, hello deployment will fail.</span></span>
>
>

![Выбор VPN][api-management-setup-vpn-select]

<span data-ttu-id="d9325-131">Нажмите кнопку **Сохранить** hello верхней части экрана приветствия.</span><span class="sxs-lookup"><span data-stu-id="d9325-131">Click **Save** at hello top of hello screen.</span></span>

> [!NOTE]
> <span data-ttu-id="d9325-132">виртуальный IP-адрес экземпляра API управления hello Hello будет меняться при каждом запуске виртуальной сети включен или отключен.</span><span class="sxs-lookup"><span data-stu-id="d9325-132">hello VIP address of hello API Management instance will change each time VNET is enabled or disabled.</span></span>  
> <span data-ttu-id="d9325-133">Hello виртуальный IP-адрес изменится при перемещении из API управления **внешних** слишком**внутренний** или наоборот</span><span class="sxs-lookup"><span data-stu-id="d9325-133">hello VIP address will also change when API Management is moved from **External** too**Internal** or vice-versa</span></span>
>


> [!IMPORTANT]
> <span data-ttu-id="d9325-134">При удалении управления API из виртуальной сети или изменить hello, который развертывается в, ранее использовавшихся виртуальной сети может оставаться hello заблокирована для too4 часов.</span><span class="sxs-lookup"><span data-stu-id="d9325-134">If you remove API Management from a VNET or change hello one it is deployed in, hello previously used VNET can remain locked for up too4 hours.</span></span> <span data-ttu-id="d9325-135">В течение этого периода он не будет возможно toodelete hello виртуальной сети или развернуть новый tooit ресурсов.</span><span class="sxs-lookup"><span data-stu-id="d9325-135">During this period it will not be possible toodelete hello VNET or deploy a new resource tooit.</span></span>

## <span data-ttu-id="d9325-136"><a name="enable-vnet-powershell"> </a>Активация подключения к виртуальной сети с помощью командлетов PowerShell</span><span class="sxs-lookup"><span data-stu-id="d9325-136"><a name="enable-vnet-powershell"> </a>Enable VNET connection using PowerShell cmdlets</span></span>
<span data-ttu-id="d9325-137">Можно также включить подключения к виртуальной сети с помощью командлетов PowerShell hello</span><span class="sxs-lookup"><span data-stu-id="d9325-137">You can also enable VNET connectivity using hello PowerShell cmdlets</span></span>

* <span data-ttu-id="d9325-138">**Создание службы управления API внутри виртуальной сети**: с помощью командлета hello [New AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) toocreate службу управления API Azure в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="d9325-138">**Create an API Management service inside a VNET**: Use hello cmdlet [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) toocreate an Azure API Management service inside a VNET.</span></span>

* <span data-ttu-id="d9325-139">**Развернуть существующую службу управления API внутри виртуальной сети**: с помощью командлета hello [AzureRmApiManagementDeployment обновление](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) toomove существующую службу управления API Azure в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="d9325-139">**Deploy an existing API Management service inside a VNET**: Use hello cmdlet [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) toomove an existing Azure API Management service inside a Virtual Network.</span></span>

## <span data-ttu-id="d9325-140"><a name="connect-vnet"></a>Подключения tooa веб-службы, размещенной в виртуальной сети</span><span class="sxs-lookup"><span data-stu-id="d9325-140"><a name="connect-vnet"> </a>Connect tooa web service hosted within a virtual Network</span></span>
<span data-ttu-id="d9325-141">После toohello подключенной виртуальной сети, служба управления API доступ к службам серверной части в нем ничем не отличается от доступа к службам public.</span><span class="sxs-lookup"><span data-stu-id="d9325-141">After your API Management service is connected toohello VNET, accessing backend services within it is no different than accessing public services.</span></span> <span data-ttu-id="d9325-142">Просто введите hello локальный IP-адрес или hello имя узла (если DNS-сервер настроен для hello виртуальной сети) веб-службу в hello **URL-адрес службы веб-** при создании нового API или редактировании уже существующей.</span><span class="sxs-lookup"><span data-stu-id="d9325-142">Just type in hello local IP address or hello host name (if a DNS server is configured for hello VNET) of your web service into hello **Web service URL** field when creating a new API or editing an existing one.</span></span>

![Добавление интерфейса API из VPN][api-management-setup-vpn-add-api]

## <span data-ttu-id="d9325-144"><a name="network-configuration-issues"> </a>Распространенные проблемы конфигурации сети</span><span class="sxs-lookup"><span data-stu-id="d9325-144"><a name="network-configuration-issues"> </a>Common Network Configuration Issues</span></span>
<span data-ttu-id="d9325-145">Ниже приведен список распространенных ошибок конфигурации, возникающих при развертывании службы управления API в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="d9325-145">Following is a list of common misconfiguration issues that can occur while deploying API Management service into a Virtual Network.</span></span>

* <span data-ttu-id="d9325-146">**Выборочная установка сервера DNS**: hello службы управления API зависит от нескольких служб Azure.</span><span class="sxs-lookup"><span data-stu-id="d9325-146">**Custom DNS server setup**: hello API Management service depends on several Azure services.</span></span> <span data-ttu-id="d9325-147">Если API управления размещен в виртуальной сети с помощью серверов DNS, он должен имена узлов hello tooresolve работу служб Azure.</span><span class="sxs-lookup"><span data-stu-id="d9325-147">When API Management is hosted in a VNET with a custom DNS server, it needs tooresolve hello hostnames of those Azure services.</span></span> <span data-ttu-id="d9325-148">Следуйте [этим](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) рекомендациям по настройке пользовательского DNS-сервера.</span><span class="sxs-lookup"><span data-stu-id="d9325-148">Please follow [this](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) guidance on custom DNS setup.</span></span> <span data-ttu-id="d9325-149">См. в следующей таблице порты hello и другие требования к сети для ссылки.</span><span class="sxs-lookup"><span data-stu-id="d9325-149">See hello ports table below and other network requirements for reference.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="d9325-150">Рекомендуется, при использовании пользовательского DNS-серверы для hello виртуальной сети, установить, **перед** развертывание службы управления API в него.</span><span class="sxs-lookup"><span data-stu-id="d9325-150">It is recommended that, if you are using a Custom DNS Server(s) for hello VNET, you set that up **before** deploying an API Management service into it.</span></span> <span data-ttu-id="d9325-151">В противном случае вы должны слишком обновление службы управления API hello каждый раз при изменении hello DNS-серверы (s), запустив hello [применение операции конфигурации сети](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span><span class="sxs-lookup"><span data-stu-id="d9325-151">Otherwise you need too update hello API Management service each time you change hello DNS Servers(s) by running hello [Apply Network Configuration Operation](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span></span>

* <span data-ttu-id="d9325-152">**Порты, необходимые для управления API**: входящего и исходящего трафика, поступающего на hello подсети, в которой развертывается API управления можно управлять с помощью [сетевой группы безопасности][Network Security Group].</span><span class="sxs-lookup"><span data-stu-id="d9325-152">**Ports required for API Management**: Inbound and Outbound traffic into hello Subnet in which API Management is deployed can be controlled using [Network Security Group][Network Security Group].</span></span> <span data-ttu-id="d9325-153">Если какой-либо из этих портов недоступен, служба управления API может не работать должным образом и даже стать недоступной.</span><span class="sxs-lookup"><span data-stu-id="d9325-153">If any of these ports are unavailable, API Management may not operate properly and may become inaccessible.</span></span> <span data-ttu-id="d9325-154">Блокировка одного или нескольких из этих портов является одной из распространенных проблем неправильной конфигурации при использовании управления API в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="d9325-154">Having one or more of these ports blocked is another common misconfiguration issue when using API Management with a VNET.</span></span>

<span data-ttu-id="d9325-155">Когда экземпляр службы управления API размещается в виртуальной сети, используются порты hello в hello в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="d9325-155">When an API Management service instance is hosted in a VNET, hello ports in hello following table are used.</span></span>

| <span data-ttu-id="d9325-156">Исходные и конечные порты</span><span class="sxs-lookup"><span data-stu-id="d9325-156">Source / Destination Port(s)</span></span> | <span data-ttu-id="d9325-157">Направление</span><span class="sxs-lookup"><span data-stu-id="d9325-157">Direction</span></span> | <span data-ttu-id="d9325-158">Транспортный протокол</span><span class="sxs-lookup"><span data-stu-id="d9325-158">Transport protocol</span></span> | <span data-ttu-id="d9325-159">Назначение</span><span class="sxs-lookup"><span data-stu-id="d9325-159">Purpose</span></span> | <span data-ttu-id="d9325-160">Ресурс и назначение</span><span class="sxs-lookup"><span data-stu-id="d9325-160">Source / Destination</span></span> | <span data-ttu-id="d9325-161">Тип доступа</span><span class="sxs-lookup"><span data-stu-id="d9325-161">Access type</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="d9325-162">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="d9325-162">* / 80, 443</span></span> |<span data-ttu-id="d9325-163">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="d9325-163">Inbound</span></span> |<span data-ttu-id="d9325-164">TCP</span><span class="sxs-lookup"><span data-stu-id="d9325-164">TCP</span></span> |<span data-ttu-id="d9325-165">TooAPI связи клиента управления</span><span class="sxs-lookup"><span data-stu-id="d9325-165">Client communication tooAPI Management</span></span> |<span data-ttu-id="d9325-166">INTERNET — VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="d9325-166">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="d9325-167">Внешний</span><span class="sxs-lookup"><span data-stu-id="d9325-167">External</span></span> |
| <span data-ttu-id="d9325-168">* / 3443</span><span class="sxs-lookup"><span data-stu-id="d9325-168">* / 3443</span></span> |<span data-ttu-id="d9325-169">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="d9325-169">Inbound</span></span> |<span data-ttu-id="d9325-170">TCP</span><span class="sxs-lookup"><span data-stu-id="d9325-170">TCP</span></span> |<span data-ttu-id="d9325-171">Конечная точка управления для портала Azure и PowerShell</span><span class="sxs-lookup"><span data-stu-id="d9325-171">Management endpoint for Azure portal and Powershell</span></span> |<span data-ttu-id="d9325-172">INTERNET — VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="d9325-172">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="d9325-173">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="d9325-173">External & Internal</span></span> |
| <span data-ttu-id="d9325-174">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="d9325-174">* / 80, 443</span></span> |<span data-ttu-id="d9325-175">Исходящие</span><span class="sxs-lookup"><span data-stu-id="d9325-175">Outbound</span></span> |<span data-ttu-id="d9325-176">TCP</span><span class="sxs-lookup"><span data-stu-id="d9325-176">TCP</span></span> |<span data-ttu-id="d9325-177">Зависимость для службы хранилища Azure и служебной шины Azure</span><span class="sxs-lookup"><span data-stu-id="d9325-177">Dependency on Azure Storage and Azure Service Bus</span></span> |<span data-ttu-id="d9325-178">VIRTUAL_NETWORK — INTERNET</span><span class="sxs-lookup"><span data-stu-id="d9325-178">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="d9325-179">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="d9325-179">External & Internal</span></span> |
| <span data-ttu-id="d9325-180">* / 1433</span><span class="sxs-lookup"><span data-stu-id="d9325-180">* / 1433</span></span> |<span data-ttu-id="d9325-181">Исходящие</span><span class="sxs-lookup"><span data-stu-id="d9325-181">Outbound</span></span> |<span data-ttu-id="d9325-182">TCP</span><span class="sxs-lookup"><span data-stu-id="d9325-182">TCP</span></span> |<span data-ttu-id="d9325-183">Зависимость от SQL Azure</span><span class="sxs-lookup"><span data-stu-id="d9325-183">Dependency on Azure SQL</span></span> |<span data-ttu-id="d9325-184">VIRTUAL_NETWORK — INTERNET</span><span class="sxs-lookup"><span data-stu-id="d9325-184">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="d9325-185">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="d9325-185">External & Internal</span></span> |
| <span data-ttu-id="d9325-186">* / 11000 - 11999</span><span class="sxs-lookup"><span data-stu-id="d9325-186">* / 11000 - 11999</span></span> |<span data-ttu-id="d9325-187">Исходящие</span><span class="sxs-lookup"><span data-stu-id="d9325-187">Outbound</span></span> |<span data-ttu-id="d9325-188">TCP</span><span class="sxs-lookup"><span data-stu-id="d9325-188">TCP</span></span> |<span data-ttu-id="d9325-189">Зависимость от SQL Azure V12</span><span class="sxs-lookup"><span data-stu-id="d9325-189">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="d9325-190">VIRTUAL_NETWORK — INTERNET</span><span class="sxs-lookup"><span data-stu-id="d9325-190">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="d9325-191">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="d9325-191">External & Internal</span></span> |
| <span data-ttu-id="d9325-192">* / 14000 - 14999</span><span class="sxs-lookup"><span data-stu-id="d9325-192">* / 14000 - 14999</span></span> |<span data-ttu-id="d9325-193">Исходящие</span><span class="sxs-lookup"><span data-stu-id="d9325-193">Outbound</span></span> |<span data-ttu-id="d9325-194">TCP</span><span class="sxs-lookup"><span data-stu-id="d9325-194">TCP</span></span> |<span data-ttu-id="d9325-195">Зависимость от SQL Azure V12</span><span class="sxs-lookup"><span data-stu-id="d9325-195">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="d9325-196">VIRTUAL_NETWORK — INTERNET</span><span class="sxs-lookup"><span data-stu-id="d9325-196">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="d9325-197">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="d9325-197">External & Internal</span></span> |
| <span data-ttu-id="d9325-198">* / 5671</span><span class="sxs-lookup"><span data-stu-id="d9325-198">* / 5671</span></span> |<span data-ttu-id="d9325-199">Исходящие</span><span class="sxs-lookup"><span data-stu-id="d9325-199">Outbound</span></span> |<span data-ttu-id="d9325-200">AMQP</span><span class="sxs-lookup"><span data-stu-id="d9325-200">AMQP</span></span> |<span data-ttu-id="d9325-201">Зависимости для политики концентратора tooEvent журнала и агент мониторинга</span><span class="sxs-lookup"><span data-stu-id="d9325-201">Dependency for Log tooEvent Hub policy and monitoring agent</span></span> |<span data-ttu-id="d9325-202">VIRTUAL_NETWORK — INTERNET</span><span class="sxs-lookup"><span data-stu-id="d9325-202">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="d9325-203">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="d9325-203">External & Internal</span></span> |
| <span data-ttu-id="d9325-204">6381–6383 / 6381–6383</span><span class="sxs-lookup"><span data-stu-id="d9325-204">6381 - 6383 / 6381 - 6383</span></span> |<span data-ttu-id="d9325-205">Входящий и исходящий</span><span class="sxs-lookup"><span data-stu-id="d9325-205">Inbound & Outbound</span></span> |<span data-ttu-id="d9325-206">UDP</span><span class="sxs-lookup"><span data-stu-id="d9325-206">UDP</span></span> |<span data-ttu-id="d9325-207">Зависимость для кэша Redis</span><span class="sxs-lookup"><span data-stu-id="d9325-207">Dependency on Redis Cache</span></span> |<span data-ttu-id="d9325-208">VIRTUAL_NETWORK — VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="d9325-208">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="d9325-209">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="d9325-209">External & Internal</span></span> |-
| <span data-ttu-id="d9325-210">* / 445</span><span class="sxs-lookup"><span data-stu-id="d9325-210">* / 445</span></span> |<span data-ttu-id="d9325-211">Исходящие</span><span class="sxs-lookup"><span data-stu-id="d9325-211">Outbound</span></span> |<span data-ttu-id="d9325-212">TCP</span><span class="sxs-lookup"><span data-stu-id="d9325-212">TCP</span></span> |<span data-ttu-id="d9325-213">Зависимость для общей папки Azure для GIT</span><span class="sxs-lookup"><span data-stu-id="d9325-213">Dependency on Azure File Share for GIT</span></span> |<span data-ttu-id="d9325-214">VIRTUAL_NETWORK — INTERNET</span><span class="sxs-lookup"><span data-stu-id="d9325-214">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="d9325-215">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="d9325-215">External & Internal</span></span> |
| <span data-ttu-id="d9325-216">* / *</span><span class="sxs-lookup"><span data-stu-id="d9325-216">* / *</span></span> | <span data-ttu-id="d9325-217">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="d9325-217">Inbound</span></span> |<span data-ttu-id="d9325-218">TCP</span><span class="sxs-lookup"><span data-stu-id="d9325-218">TCP</span></span> |<span data-ttu-id="d9325-219">Подсистема балансировки нагрузки инфраструктуры Azure</span><span class="sxs-lookup"><span data-stu-id="d9325-219">Azure Infrastructure Load Balancer</span></span> | <span data-ttu-id="d9325-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="d9325-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="d9325-221">Внешний и внутренний</span><span class="sxs-lookup"><span data-stu-id="d9325-221">External & Internal</span></span> |

* <span data-ttu-id="d9325-222">**Функциональные возможности SSL**: цепочки построение и проверка hello API службы управления должен tooocsp.msocsp.com исходящее сетевое подключение, mscrl.microsoft.com и crl.microsoft.com tooenable SSL-сертификат. Эта зависимость не является обязательным, если любой сертификат, что отправляется tooAPI управления содержит корневой ЦС toohello hello всей цепочки.</span><span class="sxs-lookup"><span data-stu-id="d9325-222">**SSL functionality**: tooenable SSL certificate chain building and validation hello API Management service needs Outbound network connectivity tooocsp.msocsp.com, mscrl.microsoft.com and crl.microsoft.com. This dependency is not required, if any certificate you upload tooAPI Management contain hello full chain toohello CA root.</span></span>

* <span data-ttu-id="d9325-223">**Доступ к DNS**. Исходящий доступ через порт 53 необходим для обмена данными с DNS-серверами.</span><span class="sxs-lookup"><span data-stu-id="d9325-223">**DNS Access**: Outbound access on port 53 is required for communication with DNS servers.</span></span> <span data-ttu-id="d9325-224">Если существует пользовательского DNS-сервера на Здравствуйте другом конце VPN-шлюза, hello DNS-сервер должен быть доступен из подсети hello размещение управления API.</span><span class="sxs-lookup"><span data-stu-id="d9325-224">If a custom DNS server exists on hello other end of a VPN gateway, hello DNS server must be reachable from hello subnet hosting API Management.</span></span>

* <span data-ttu-id="d9325-225">**Наблюдение за работоспособностью и метрики**: исходящее сетевое подключение tooAzure мониторинг конечных точек, которые решения в области hello следующие домены: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span><span class="sxs-lookup"><span data-stu-id="d9325-225">**Metrics and Health Monitoring**: Outbound network connectivity tooAzure Monitoring endpoints, which resolve under hello following domains: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span></span>

* <span data-ttu-id="d9325-226">**Экспресс-установки маршрута**: общая конфигурация клиента является toodefine собственные маршрут по умолчанию (0.0.0.0/0), благодаря чему исходящего Интернет трафика tooinstead потока в локальной среде.</span><span class="sxs-lookup"><span data-stu-id="d9325-226">**Express Route Setup**: A common customer configuration is toodefine their own default route (0.0.0.0/0) which forces outbound Internet traffic tooinstead flow on-premises.</span></span> <span data-ttu-id="d9325-227">Этот поток трафика неизменно разрывает подключение к службе управления API Azure из-за исходящий трафик hello заблокированных локально, или NAT, где tooan неопознанное набор адресов, которые больше не работают с различные конечные точки Azure.</span><span class="sxs-lookup"><span data-stu-id="d9325-227">This traffic flow invariably breaks connectivity with Azure API Management because hello outbound traffic is either blocked on-premises, or NAT'd tooan unrecognizable set of addresses that no longer work with various Azure endpoints.</span></span> <span data-ttu-id="d9325-228">Hello решением является toodefine один (или более) определяемых пользователем маршрутов ([UDRs][UDRs]) на hello подсети, содержащей hello API управления Azure.</span><span class="sxs-lookup"><span data-stu-id="d9325-228">hello solution is toodefine one (or more) user-defined routes ([UDRs][UDRs]) on hello subnet that contains hello Azure API Management.</span></span> <span data-ttu-id="d9325-229">UDR определяет маршруты конкретной подсети, которые будут соблюдаться вместо маршрут по умолчанию hello.</span><span class="sxs-lookup"><span data-stu-id="d9325-229">A UDR defines subnet-specific routes that will be honored instead of hello default route.</span></span>
  <span data-ttu-id="d9325-230">Если это возможно рекомендуется следующая конфигурация hello toouse:</span><span class="sxs-lookup"><span data-stu-id="d9325-230">If possible, it is recommended toouse hello following configuration:</span></span>
 * <span data-ttu-id="d9325-231">Конфигурация ExpressRoute Hello объявляет 0.0.0.0/0 и по умолчанию force туннелей всех исходящего трафика в локальной.</span><span class="sxs-lookup"><span data-stu-id="d9325-231">hello ExpressRoute configuration advertises 0.0.0.0/0 and by default force tunnels all outbound traffic on-premises.</span></span>
 * <span data-ttu-id="d9325-232">Hello UDR применения toohello подсеть, содержащая hello API управления Azure определяет 0.0.0.0/0 с тип следующего прыжка из Интернета.</span><span class="sxs-lookup"><span data-stu-id="d9325-232">hello UDR applied toohello subnet containing hello Azure API Management defines 0.0.0.0/0 with a next hop type of Internet.</span></span>
 <span data-ttu-id="d9325-233">Hello воздействии этих шагов — что уровне подсети hello UDR имеет приоритет над hello ExpressRoute принудительного туннелирования, обеспечивая исходящие подключения к Интернету из hello управления API Azure.</span><span class="sxs-lookup"><span data-stu-id="d9325-233">hello combined effect of these steps is that hello subnet level UDR takes precedence over hello ExpressRoute forced tunneling, thus ensuring outbound Internet access from hello Azure API Management.</span></span>

>[!WARNING]  
><span data-ttu-id="d9325-234">Управления API Azure не поддерживается с конфигурациями ExpressRoute, **неправильно кросс объявлять маршруты из hello открытого пиринга путь toohello частным путем пиринга**.</span><span class="sxs-lookup"><span data-stu-id="d9325-234">Azure API Management is not supported with ExpressRoute configurations that **incorrectly cross-advertise routes from hello public peering path toohello private peering path**.</span></span> <span data-ttu-id="d9325-235">Конфигурации ExpressRoute, для которых настроен общедоступный пиринг, будут получать объявления маршрутов от корпорации Майкрософт для большого набора диапазонов IP-адресов Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="d9325-235">ExpressRoute configurations that have public peering configured, will receive route advertisements from Microsoft for a large set of Microsoft Azure IP address ranges.</span></span> <span data-ttu-id="d9325-236">Эти диапазоны адресов, неправильно кросс объявляемых частным путем пиринга hello hello конечным результатом является, все исходящие сетевые пакеты из экземпляра службы управления API Azure hello подсети локальной сети клиента tooa неправильно принудительного туннелирования инфраструктура.</span><span class="sxs-lookup"><span data-stu-id="d9325-236">If these address ranges are incorrectly cross-advertised on hello private peering path, hello end result is that all outbound network packets from hello Azure API Management instance's subnet are incorrectly force-tunneled tooa customer's on-premises network infrastructure.</span></span> <span data-ttu-id="d9325-237">Этот сетевой поток нарушает работу службы управления API Azure.</span><span class="sxs-lookup"><span data-stu-id="d9325-237">This network flow breaks Azure API Management.</span></span> <span data-ttu-id="d9325-238">Hello решения toothis проблема заключается в toostop маршруты между рекламу от hello открытого пиринга путь toohello частным путем пиринга.</span><span class="sxs-lookup"><span data-stu-id="d9325-238">hello solution toothis problem is toostop cross-advertising routes from hello public peering path toohello private peering path.</span></span>


## <span data-ttu-id="d9325-239"><a name="troubleshooting"> </a>Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="d9325-239"><a name="troubleshooting"> </a>Troubleshooting</span></span>
<span data-ttu-id="d9325-240">При внесении изменений tooyour сети, см. слишком[NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), toovalidate, если hello службы управления API не утратил tooany доступ из hello важные ресурсы, в которых он зависит.</span><span class="sxs-lookup"><span data-stu-id="d9325-240">When making changes tooyour network, refer too[NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), toovalidate if hello API Management service has not lost access tooany of hello critical resources which it depends upon.</span></span> <span data-ttu-id="d9325-241">состояние подключения к Hello должны обновляться каждые 15 минут.</span><span class="sxs-lookup"><span data-stu-id="d9325-241">hello connectivity status should be updated every 15 minutes.</span></span>

## <span data-ttu-id="d9325-242"><a name="limitations"> </a>Ограничения</span><span class="sxs-lookup"><span data-stu-id="d9325-242"><a name="limitations"> </a>Limitations</span></span>
* <span data-ttu-id="d9325-243">Подсеть, содержащая экземпляры службы управления API, не может содержать ресурсы Azure каких-либо других типов.</span><span class="sxs-lookup"><span data-stu-id="d9325-243">A subnet containing API Management instances cannot contain any other Azure resource types.</span></span>
* <span data-ttu-id="d9325-244">Здравствуйте, подсеть Hello и hello управления API, служба должна быть в одной подписке.</span><span class="sxs-lookup"><span data-stu-id="d9325-244">hello subnet and hello API Management service must be in hello same subscription.</span></span>
* <span data-ttu-id="d9325-245">Невозможно переместить между подписками подсеть, содержащую экземпляры службы управления API.</span><span class="sxs-lookup"><span data-stu-id="d9325-245">A subnet containing API Management instances cannot be moved across subscriptions.</span></span>
* <span data-ttu-id="d9325-246">При использовании внутренней виртуальной сети только для внутреннего IP-адреса будут доступны из диапазона hello указано в [RFC 1918](https://tools.ietf.org/html/rfc1918), не может быть указан общедоступный IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="d9325-246">When using an internal virtual network, only an internal IP address will be available from hello range stated in [RFC 1918](https://tools.ietf.org/html/rfc1918), a public IP address cannot be provided.</span></span>
* <span data-ttu-id="d9325-247">Для развертываний API управления несколькими регионами с внутренней виртуальные сети, настроенные, пользователи, отвечают за управление свои собственные балансировки как они владеют hello DNS.</span><span class="sxs-lookup"><span data-stu-id="d9325-247">For multi-region API Management deployments, with Internal virtual networks configured, users are responsible for managing their own load balancing as they own hello DNS.</span></span>


## <span data-ttu-id="d9325-248"><a name="related-content"> </a>Связанная информация</span><span class="sxs-lookup"><span data-stu-id="d9325-248"><a name="related-content"> </a>Related content</span></span>
* [<span data-ttu-id="d9325-249">Подключение toobackend виртуальной сети, с помощью VPN-шлюза</span><span class="sxs-lookup"><span data-stu-id="d9325-249">Connecting a Virtual Network toobackend using Vpn Gateway</span></span>](../vpn-gateway/vpn-gateway-about-vpngateways.md#s2smulti)
* [<span data-ttu-id="d9325-250">Подключение виртуальных сетей из различных моделей развертывания с использованием PowerShell</span><span class="sxs-lookup"><span data-stu-id="d9325-250">Connecting a Virtual Network from different deployment models</span></span>](../vpn-gateway/vpn-gateway-connect-different-deployment-models-powershell.md)
* [<span data-ttu-id="d9325-251">Как hello toouse tootrace инспектора API вызывает в службе управления API Azure</span><span class="sxs-lookup"><span data-stu-id="d9325-251">How toouse hello API Inspector tootrace calls in Azure API Management</span></span>](api-management-howto-api-inspector.md)

[api-management-using-vnet-menu]: ./media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-type.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: ./media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: ./media/api-management-using-with-vnet/api-management-vnet-private.png
[api-management-vnet-public]: ./media/api-management-using-with-vnet/api-management-vnet-public.png

[Enable VPN connections]: #enable-vpn
[Connect tooa web service behind VPN]: #connect-vpn
[Related content]: #related-content

[UDRs]: ../virtual-network/virtual-networks-udr-overview.md
[Network Security Group]: ../virtual-network/virtual-networks-nsg.md

---
title: "toouse aaaHow API управления Azure с виртуальными сетями"
description: "Узнайте, как toosetup tooa подключения виртуальной сети в Azure API управления и доступа к веб-служб через него."
services: api-management
documentationcenter: 
author: antonba
manager: erikre
editor: 
ms.assetid: 64b58f7b-ca22-47dc-89c0-f6bb0af27a48
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/15/2016
ms.author: apimpm
ms.openlocfilehash: 426b3974e4fed7daffdb0c3f02381edbc326dc28
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="how-toouse-azure-api-management-with-virtual-networks"></a>Как toouse API управления Azure с виртуальными сетями
Виртуальные сети (Vnet) позволяют tooplace, все ресурсы Azure в сети routeable не через Интернет, которым можно управлять доступом к. Затем эти сети можно подключенных tooyour локальным сетям с использованием различных технологий VPN. Дополнительные сведения о виртуальных сетях Azure начинаться с здесь сведения hello toolearn: [Обзор виртуальной сети Azure](../virtual-network/virtual-networks-overview.md).

Управления API Azure можно развернуть внутри hello виртуальной сети (VNET), поэтому он получает доступ к внутренним службам в сети hello. Hello портал разработчиков и шлюза API могут быть настроенный toobe, доступном из Интернета hello или только в пределах виртуальной сети hello.

> [!NOTE]
> Служба управления API Azure поддерживает классические виртуальные сети и виртуальные сети Azure Resource Manager.
>
>

## <a name="enable-vpn"> </a>Включение подключения к виртуальной сети
> [!NOTE]
> Подключение виртуальной сети доступно hello **Premium** и **разработчика** уровней. tooswitch между уровнями hello, откройте службу управления API в hello портал Azure, а затем откройте hello **масштабирования и ценах** вкладки. В разделе hello **Ценовая категория** установите для уровня Premium или разработчика hello и нажмите кнопку Сохранить.
>

tooenable подключение к виртуальной сети, откройте службу управления API в hello портал Azure и откройте hello **виртуальная сеть** страницы.

![Меню "Виртуальная сеть" для управления API][api-management-using-vnet-menu]

Выберите тип требуемой hello доступа:

* **Внешние**: hello API управления шлюза и разработчик портала доступны из hello общедоступный Интернет через внешней подсистемы балансировки нагрузки. доступ к ресурсам в виртуальной сети hello Hello шлюза.

![Общедоступный пиринг][api-management-vnet-public]

* **Внутренняя**: hello API управления шлюза и разработчик портала доступны только внутри hello виртуальной сети через внутренний балансировщик нагрузки. доступ к ресурсам в виртуальной сети hello Hello шлюза.

![Частный пиринг][api-management-vnet-private]

Будет показан список всех регионов, где предоставляется служба управления API. Выберите виртуальную сеть и подсеть для каждого региона. Hello список заполняется классический и диспетчер ресурсов виртуальных сетей, имеющихся в вашей подписки Azure, которые настраиваются в области hello, которую вы настраиваете.

> [!NOTE]
> **Конечная точка службы** в hello выше схема включает шлюза или прокси-сервера, портал издателя, портал разработчиков, GIT и hello прямого управления конечной точки.
> **Конечная точка управления** в hello выше схема является hello конечную точку, размещенную в конфигурации toomanage hello службы через портал Azure и Powershell.
> Кроме того, обратите внимание, что, даже если hello показан IP-адресов для различных конечных точек, служба управления API **только** реагирует на его настроенных имен узлов.

> [!IMPORTANT]
> При развертывании tooa экземпляр управления API Azure Resource Manager виртуальной сети, служба hello должна быть в выделенной подсетью, не содержит другие ресурсы, за исключением экземпляров службы управления API Azure. Если попытаться сделать это toodeploy tooa экземпляра службы управления API Azure подсети виртуальной сети диспетчер ресурсов, которая содержит другие ресурсы, hello развертывания не удастся.
>
>

![Выбор VPN][api-management-setup-vpn-select]

Нажмите кнопку **Сохранить** hello верхней части экрана приветствия.

> [!NOTE]
> виртуальный IP-адрес экземпляра API управления hello Hello будет меняться при каждом запуске виртуальной сети включен или отключен.  
> Hello виртуальный IP-адрес изменится при перемещении из API управления **внешних** слишком**внутренний** или наоборот
>


> [!IMPORTANT]
> При удалении управления API из виртуальной сети или изменить hello, который развертывается в, ранее использовавшихся виртуальной сети может оставаться hello заблокирована для too4 часов. В течение этого периода он не будет возможно toodelete hello виртуальной сети или развернуть новый tooit ресурсов.

## <a name="enable-vnet-powershell"> </a>Активация подключения к виртуальной сети с помощью командлетов PowerShell
Можно также включить подключения к виртуальной сети с помощью командлетов PowerShell hello

* **Создание службы управления API внутри виртуальной сети**: с помощью командлета hello [New AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) toocreate службу управления API Azure в виртуальной сети.

* **Развернуть существующую службу управления API внутри виртуальной сети**: с помощью командлета hello [AzureRmApiManagementDeployment обновление](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) toomove существующую службу управления API Azure в виртуальной сети.

## <a name="connect-vnet"></a>Подключения tooa веб-службы, размещенной в виртуальной сети
После toohello подключенной виртуальной сети, служба управления API доступ к службам серверной части в нем ничем не отличается от доступа к службам public. Просто введите hello локальный IP-адрес или hello имя узла (если DNS-сервер настроен для hello виртуальной сети) веб-службу в hello **URL-адрес службы веб-** при создании нового API или редактировании уже существующей.

![Добавление интерфейса API из VPN][api-management-setup-vpn-add-api]

## <a name="network-configuration-issues"> </a>Распространенные проблемы конфигурации сети
Ниже приведен список распространенных ошибок конфигурации, возникающих при развертывании службы управления API в виртуальной сети.

* **Выборочная установка сервера DNS**: hello службы управления API зависит от нескольких служб Azure. Если API управления размещен в виртуальной сети с помощью серверов DNS, он должен имена узлов hello tooresolve работу служб Azure. Следуйте [этим](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) рекомендациям по настройке пользовательского DNS-сервера. См. в следующей таблице порты hello и другие требования к сети для ссылки.

> [!IMPORTANT]
> Рекомендуется, при использовании пользовательского DNS-серверы для hello виртуальной сети, установить, **перед** развертывание службы управления API в него. В противном случае вы должны слишком обновление службы управления API hello каждый раз при изменении hello DNS-серверы (s), запустив hello [применение операции конфигурации сети](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)

* **Порты, необходимые для управления API**: входящего и исходящего трафика, поступающего на hello подсети, в которой развертывается API управления можно управлять с помощью [сетевой группы безопасности][Network Security Group]. Если какой-либо из этих портов недоступен, служба управления API может не работать должным образом и даже стать недоступной. Блокировка одного или нескольких из этих портов является одной из распространенных проблем неправильной конфигурации при использовании управления API в виртуальной сети.

Когда экземпляр службы управления API размещается в виртуальной сети, используются порты hello в hello в следующей таблице.

| Исходные и конечные порты | Направление | Транспортный протокол | Назначение | Ресурс и назначение | Тип доступа |
| --- | --- | --- | --- | --- | --- |
| * / 80, 443 |Входящий трафик |TCP |TooAPI связи клиента управления |INTERNET — VIRTUAL_NETWORK |Внешний |
| * / 3443 |Входящий трафик |TCP |Конечная точка управления для портала Azure и PowerShell |INTERNET — VIRTUAL_NETWORK |Внешний и внутренний |
| * / 80, 443 |Исходящие |TCP |Зависимость для службы хранилища Azure и служебной шины Azure |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| * / 1433 |Исходящие |TCP |Зависимость от SQL Azure |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| * / 11000 - 11999 |Исходящие |TCP |Зависимость от SQL Azure V12 |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| * / 14000 - 14999 |Исходящие |TCP |Зависимость от SQL Azure V12 |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| * / 5671 |Исходящие |AMQP |Зависимости для политики концентратора tooEvent журнала и агент мониторинга |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| 6381–6383 / 6381–6383 |Входящий и исходящий |UDP |Зависимость для кэша Redis |VIRTUAL_NETWORK — VIRTUAL_NETWORK |Внешний и внутренний |-
| * / 445 |Исходящие |TCP |Зависимость для общей папки Azure для GIT |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| * / * | Входящий трафик |TCP |Подсистема балансировки нагрузки инфраструктуры Azure | AZURE_LOAD_BALANCER / VIRTUAL_NETWORK |Внешний и внутренний |

* **Функциональные возможности SSL**: цепочки построение и проверка hello API службы управления должен tooocsp.msocsp.com исходящее сетевое подключение, mscrl.microsoft.com и crl.microsoft.com tooenable SSL-сертификат. Эта зависимость не является обязательным, если любой сертификат, что отправляется tooAPI управления содержит корневой ЦС toohello hello всей цепочки.

* **Доступ к DNS**. Исходящий доступ через порт 53 необходим для обмена данными с DNS-серверами. Если существует пользовательского DNS-сервера на Здравствуйте другом конце VPN-шлюза, hello DNS-сервер должен быть доступен из подсети hello размещение управления API.

* **Наблюдение за работоспособностью и метрики**: исходящее сетевое подключение tooAzure мониторинг конечных точек, которые решения в области hello следующие домены: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.

* **Экспресс-установки маршрута**: общая конфигурация клиента является toodefine собственные маршрут по умолчанию (0.0.0.0/0), благодаря чему исходящего Интернет трафика tooinstead потока в локальной среде. Этот поток трафика неизменно разрывает подключение к службе управления API Azure из-за исходящий трафик hello заблокированных локально, или NAT, где tooan неопознанное набор адресов, которые больше не работают с различные конечные точки Azure. Hello решением является toodefine один (или более) определяемых пользователем маршрутов ([UDRs][UDRs]) на hello подсети, содержащей hello API управления Azure. UDR определяет маршруты конкретной подсети, которые будут соблюдаться вместо маршрут по умолчанию hello.
  Если это возможно рекомендуется следующая конфигурация hello toouse:
 * Конфигурация ExpressRoute Hello объявляет 0.0.0.0/0 и по умолчанию force туннелей всех исходящего трафика в локальной.
 * Hello UDR применения toohello подсеть, содержащая hello API управления Azure определяет 0.0.0.0/0 с тип следующего прыжка из Интернета.
 Hello воздействии этих шагов — что уровне подсети hello UDR имеет приоритет над hello ExpressRoute принудительного туннелирования, обеспечивая исходящие подключения к Интернету из hello управления API Azure.

>[!WARNING]  
>Управления API Azure не поддерживается с конфигурациями ExpressRoute, **неправильно кросс объявлять маршруты из hello открытого пиринга путь toohello частным путем пиринга**. Конфигурации ExpressRoute, для которых настроен общедоступный пиринг, будут получать объявления маршрутов от корпорации Майкрософт для большого набора диапазонов IP-адресов Microsoft Azure. Эти диапазоны адресов, неправильно кросс объявляемых частным путем пиринга hello hello конечным результатом является, все исходящие сетевые пакеты из экземпляра службы управления API Azure hello подсети локальной сети клиента tooa неправильно принудительного туннелирования инфраструктура. Этот сетевой поток нарушает работу службы управления API Azure. Hello решения toothis проблема заключается в toostop маршруты между рекламу от hello открытого пиринга путь toohello частным путем пиринга.


## <a name="troubleshooting"> </a>Устранение неполадок
При внесении изменений tooyour сети, см. слишком[NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), toovalidate, если hello службы управления API не утратил tooany доступ из hello важные ресурсы, в которых он зависит. состояние подключения к Hello должны обновляться каждые 15 минут.

## <a name="limitations"> </a>Ограничения
* Подсеть, содержащая экземпляры службы управления API, не может содержать ресурсы Azure каких-либо других типов.
* Здравствуйте, подсеть Hello и hello управления API, служба должна быть в одной подписке.
* Невозможно переместить между подписками подсеть, содержащую экземпляры службы управления API.
* При использовании внутренней виртуальной сети только для внутреннего IP-адреса будут доступны из диапазона hello указано в [RFC 1918](https://tools.ietf.org/html/rfc1918), не может быть указан общедоступный IP-адрес.
* Для развертываний API управления несколькими регионами с внутренней виртуальные сети, настроенные, пользователи, отвечают за управление свои собственные балансировки как они владеют hello DNS.


## <a name="related-content"> </a>Связанная информация
* [Подключение toobackend виртуальной сети, с помощью VPN-шлюза](../vpn-gateway/vpn-gateway-about-vpngateways.md#s2smulti)
* [Подключение виртуальных сетей из различных моделей развертывания с использованием PowerShell](../vpn-gateway/vpn-gateway-connect-different-deployment-models-powershell.md)
* [Как hello toouse tootrace инспектора API вызывает в службе управления API Azure](api-management-howto-api-inspector.md)

[api-management-using-vnet-menu]: ./media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-type.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: ./media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: ./media/api-management-using-with-vnet/api-management-vnet-private.png
[api-management-vnet-public]: ./media/api-management-using-with-vnet/api-management-vnet-public.png

[Enable VPN connections]: #enable-vpn
[Connect tooa web service behind VPN]: #connect-vpn
[Related content]: #related-content

[UDRs]: ../virtual-network/virtual-networks-udr-overview.md
[Network Security Group]: ../virtual-network/virtual-networks-nsg.md

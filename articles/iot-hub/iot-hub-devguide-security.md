---
title: "Общие сведения о безопасности в Центре Интернета вещей Azure | Документация Майкрософт"
description: "Руководство разработчика. Управление доступом к Центру Интернета вещей для внутренних приложений или приложений для устройств. Содержит сведения о маркерах безопасности и поддержке сертификатов X.509."
services: iot-hub
documentationcenter: .net
author: dominicbetts
manager: timlt
editor: 
ms.assetid: 45631e70-865b-4e06-bb1d-aae1175a52ba
ms.service: iot-hub
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/08/2017
ms.author: dobett
ms.openlocfilehash: e4fe5400ffcf4446392015aada031dd4dfbf238a
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="control-access-to-iot-hub"></a>Управление доступом к Центру Интернета вещей

В этой статье описаны возможности защиты Центра Интернета вещей. Центр Интернета вещей использует *разрешения* для предоставления доступа к каждой из своих конечных точек. Разрешения ограничивают доступ к Центру Интернета вещей на основе функций.

Содержание статьи

* Различные разрешения, которые можно предоставить устройству или серверному приложению для доступа к Центру Интернета вещей.
* Процесс аутентификации и маркеры, используемые для проверки разрешений.
* Определение области действия учетных данных для ограничения доступа к определенным ресурсам.
* Поддержка сертификатов X.509 в Центре Интернета вещей.
* Механизмы настраиваемой аутентификации устройства, использующие существующие реестры удостоверений устройств или схемы аутентификации.

### <a name="when-to-use"></a>Сценарии использования

Для доступа к любой конечной точке Центра Интернета вещей необходимы соответствующие разрешения. Например, устройство должно содержать маркер с учетными данными безопасности, а также все сообщения, отправленные в Центр Интернета вещей.

## <a name="access-control-and-permissions"></a>Контроль доступа и разрешений

Предоставить [разрешения](#iot-hub-permissions) можно следующими способами:

* **Политики общего доступа на уровне Центра Интернета вещей**. Политики общего доступа могут предоставлять любое сочетание [разрешений](#iot-hub-permissions). Политики можно задавать на [портале Azure][lnk-management-portal] или программно, используя [интерфейсы REST API поставщика ресурсов Центра Интернета вещей][lnk-resource-provider-apis]. По умолчанию для только что созданного Центра Интернета вещей заданы такие политики:

  * **iothubowner**: политика со всеми разрешениями;
  * **service**: политика с разрешением **ServiceConnect**;
  * **device**: политика с разрешением **DeviceConnect**;
  * **registryRead**: политика с разрешением **RegistryRead**;
  * **registryReadWrite**: политика с разрешениями **RegistryRead** и RegistryWrite.
  * **Учетные данные безопасности на уровне отдельного устройства**. Каждый Центр Интернета вещей содержит [реестр удостоверений][lnk-identity-registry]. Для каждого устройства в этом реестре удостоверений вы можете задать учетные данные безопасности, дающие вам разрешения **DeviceConnect**, которые соответствуют конечным точкам устройств.

Например, в стандартном решении IoT:

* Компонент управления устройством использует политику *registryReadWrite* .
* Компонент обработчика событий использует политику *service* .
* Компонент бизнес-логики устройства среды выполнения использует политику *service*.
* Отдельные устройства подключаются с помощью учетных данных, которые хранятся в реестре удостоверений Центра Интернета вещей.

> [!NOTE]
> Дополнительные сведения см. в статье о [разрешениях](#iot-hub-permissions).

## <a name="authentication"></a>Аутентификация

Центр Интернета вещей Azure предоставляет доступ к конечным точкам, проверяя маркер на соответствие политикам общего доступа и учетным данным безопасности в реестре удостоверений.

Учетные данные безопасности, например симметричные ключи, никогда не отправляются по сети.

> [!NOTE]
> Безопасность для поставщика ресурсов Центра Интернета вещей Azure обеспечивается с помощью подписки Azure (это касается всех поставщиков в [Azure Resource Manager][lnk-azure-resource-manager]).

Дополнительные сведения о способах создания и использования маркеров безопасности см. в разделе [Маркеры безопасности Центра Интернета вещей][lnk-sas-tokens].

### <a name="protocol-specifics"></a>Особенности протокола

Каждый поддерживаемый протокол, например MQTT, AMQP и HTTP, передает маркеры разными способами.

При использовании протокола MQTT пакет CONNECT содержит код deviceId как значение ClientId, {iothubhostname}/{deviceId} в поле "Имя пользователя", а маркер SAS — в поле "Пароль". {iothubhostname} — это полная запись CName Центра Интернета вещей (например, contoso.azure-devices.net).

При использовании [AMQP][lnk-amqp] Центр Интернета вещей поддерживает механизм [SASL PLAIN][lnk-sasl-plain] и стандарт [защиты AMQP на основе утверждений][lnk-cbs].

Стандарт защиты AMQP на основе утверждений определяет, как следует передавать эти маркеры.

Для SASL PLAIN **имя пользователя** может быть следующим:

* `{policyName}@sas.root.{iothubName}` — при использовании маркеров уровня Центра Интернета вещей;
* `{deviceId}@sas.{iothubname}` — при использовании маркеров уровня устройства.

В обоих случаях поле пароля содержит маркер, как описано в разделе [Маркеры безопасности Центра Интернета вещей][lnk-sas-tokens].

Протокол HTTP реализует аутентификацию посредством включения допустимого маркера в заголовок запроса **авторизации** .

#### <a name="example"></a>Пример

Имя пользователя (значение DeviceId следует вводить с учетом регистра): `iothubname.azure-devices.net/DeviceId`

Пароль (создайте маркер SAS с помощью [обозревателя устройств][lnk-device-explorer]): `SharedAccessSignature sr=iothubname.azure-devices.net%2fdevices%2fDeviceId&sig=kPszxZZZZZZZZZZZZZZZZZAhLT%2bV7o%3d&se=1487709501`

> [!NOTE]
> [Пакеты SDK для Azure IoT][lnk-sdks] автоматически создают маркеры при подключении к службе. В некоторых случаях пакеты SDK для Azure IoT поддерживают не все протоколы или не все методы проверки подлинности.

### <a name="special-considerations-for-sasl-plain"></a>Специальные рекомендации для SASL PLAIN

При использовании SASL PLAIN с протоколом AMQP клиент, подключающийся к Центру Интернета вещей, может использовать по одному маркеру для каждого TCP-подключения. Когда срок действия маркера истекает, TCP-подключение к службе прерывается и выполняется попытка повторного подключения. Хотя это поведение и не является проблематичным для внутреннего приложения, оно может навредить приложению для устройства по следующим причинам:

* Шлюзы обычно подключаются от имени многих устройств. Если используется SASL PLAIN, шлюзам нужно создать отдельное TCP-подключение для каждого устройства, подключающегося к Центру Интернета вещей. Этот сценарий значительно повышает потребление электроэнергии и сетевых ресурсов и увеличивает задержку подключения устройства.
* Если потребление ресурсов увеличится, устройства с ограниченными ресурсами должны будут выполнять повторное подключение после истечения срока действия маркера.

## <a name="scope-iot-hub-level-credentials"></a>Определение области действия учетных данных на уровне Центра Интернета вещей

Чтобы определить область действия для политик безопасности на уровне Центра Интернета вещей, создайте маркеры с помощью универсального кода (URI) ограниченного ресурса. Например, конечная точка для отправки сообщений с устройства в облако — **/devices/{deviceId}/messages/events**. Кроме того, вы можете использовать политику общего доступа на уровне Центра Интернета вещей с разрешениями **DeviceConnect**. С ее помощью можно подписать маркер, значение resourceURI которого — **/devices/{deviceId}**. В результате такого подхода создается маркер, который можно использовать только для отправки сообщений от имени устройства с кодом **deviceId**.

Этот механизм похож на [политику издателя концентраторов событий][lnk-event-hubs-publisher-policy]. Он позволяет реализовывать методы настраиваемой проверки подлинности.

## <a name="security-tokens"></a>Маркеры безопасности Центра Интернета вещей

Центр Интернета вещей использует маркеры безопасности для проверки подлинности устройств и служб, чтобы избежать отправки ключей по сети. Кроме того, маркеры безопасности ограничены по времени и области действия. [Пакеты SDK для Azure IoT][lnk-sdks] автоматически создают маркеры без специальной настройки. В некоторых случаях требуется напрямую создать и использовать маркеры безопасности. Ниже приведены соответствующие сценарии.

* Непосредственное использование поверхностей MQTT, AMQP или HTTP.
* Реализация схемы службы маркеров, как описано в разделе [Настраиваемая проверка подлинности устройства][lnk-custom-auth].

Центр Интернета вещей также позволяет устройствам использовать [сертификаты X.509][lnk-x509] для аутентификации в Центре Интернета вещей.

### <a name="security-token-structure"></a>Структура маркера безопасности

Маркеры безопасности используются для предоставления устройствам и службам ограниченного по времени доступа к определенным функциям в Центре Интернета вещей. Чтобы получить авторизацию для подключения к Центру Интернета вещей, устройства и службы должны отправить маркеры безопасности, подписанные с помощью общего ключа доступа или симметричного ключа, сохраненного с удостоверением устройства в реестре удостоверений.

Маркер, подписанный с помощью ключа общего доступа, предоставляет доступа ко всем функциям, связанным с разрешениями политики общего доступа. Маркер, подписанный с помощью симметричного ключа удостоверения устройства, предоставляет только разрешение **DeviceConnect** для связанного удостоверения устройства.

Маркер безопасности имеет следующий формат:

`SharedAccessSignature sig={signature-string}&se={expiry}&skn={policyName}&sr={URL-encoded-resourceURI}`

Это ожидаемые значения:

| Значение | Описание |
| --- | --- |
| {signature} |Строка подписи HMAC-SHA256 формата `{URL-encoded-resourceURI} + "\n" + expiry`. **Важно!**Ключ шифруется в кодировке base64 и используется для вычислений HMAC-SHA256. |
| {resourceURI} |Начинающийся с имени узла Центра Интернета вещей (без протокола) префикс URI (по сегменту) для конечных точек, доступ к которым можно получить с помощью этого маркера. Например, `myHub.azure-devices.net/devices/device1` |
| {expiry} |Строки в формате UTF8, отображающие количество секунд с начала эры 00:00:00 (в формате UTC) 1 января 1970 г. |
| {URL-encoded-resourceURI} |Строчное URL-кодирование строчного URL ресурса |
| {policyName} |Имя политики общего доступа, к которой относится этот маркер. Отсутствует, если маркер относится к учетным данным реестра устройства. |

**Обратите внимание**, что префикс универсального кода ресурса (URI) вычисляется по сегменту, а не по символу. Например, `/a/b` — это префикс для `/a/b/c`, а не для `/a/bc`.

В следующем фрагменте кода Node.js показан функция **generateSasToken**, которая вычисляет маркер, используя входные данные`resourceUri, signingKey, policyName, expiresInMins`. В следующих разделах показано, как инициализировать различные входные данные для различных сценариев использования маркеров.

```nodejs
var generateSasToken = function(resourceUri, signingKey, policyName, expiresInMins) {
    resourceUri = encodeURIComponent(resourceUri);

    // Set expiration in seconds
    var expires = (Date.now() / 1000) + expiresInMins * 60;
    expires = Math.ceil(expires);
    var toSign = resourceUri + '\n' + expires;

    // Use crypto
    var hmac = crypto.createHmac('sha256', new Buffer(signingKey, 'base64'));
    hmac.update(toSign);
    var base64UriEncoded = encodeURIComponent(hmac.digest('base64'));

    // Construct autorization string
    var token = "SharedAccessSignature sr=" + resourceUri + "&sig="
    + base64UriEncoded + "&se=" + expires;
    if (policyName) token += "&skn="+policyName;
    return token;
};
```

Для сравнения приведен эквивалентный код Python для создания маркера безопасности.

```python
from base64 import b64encode, b64decode
from hashlib import sha256
from time import time
from urllib import quote_plus, urlencode
from hmac import HMAC

def generate_sas_token(uri, key, policy_name, expiry=3600):
    ttl = time() + expiry
    sign_key = "%s\n%d" % ((quote_plus(uri)), int(ttl))
    print sign_key
    signature = b64encode(HMAC(b64decode(key), sign_key, sha256).digest())

    rawtoken = {
        'sr' :  uri,
        'sig': signature,
        'se' : str(int(ttl))
    }

    if policy_name is not None:
        rawtoken['skn'] = policy_name

    return 'SharedAccessSignature ' + urlencode(rawtoken)
```

> [!NOTE]
> Так как срок действия маркера проверяется на компьютерах Центра Интернета вещей, нужно обеспечить минимальное смещение на часах компьютера, где создается маркер.

### <a name="use-sas-tokens-in-a-device-app"></a>Использование маркеров SAS в приложении для устройства

Существует два способа получения разрешений **DeviceConnect** для Центра Интернета вещей с маркерами безопасности: с помощью [симметричного ключа устройства из реестра удостоверений](#use-a-symmetric-key-in-the-identity-registry) или [ключа общего доступа](#use-a-shared-access-policy).

Помните, что все функциональные возможности, доступные с устройств, намеренно предоставляются в конечных точках с префиксом `/devices/{deviceId}`.

> [!IMPORTANT]
> Единственный способ проверки подлинности конкретного устройства в Центре Интернета вещей предполагает использование симметричного ключа удостоверения устройства. В случаях, когда для доступа к функциям устройства применяется политика общего доступа, решение должно считать компонент, который выдает маркер безопасности, доверенным компонентом.

Далее указаны конечные точки, доступные с устройства (вне зависимости от протокола).

| Конечная точка | Функции |
| --- | --- |
| `{iot hub host name}/devices/{deviceId}/messages/events` |Отправка сообщений с устройства в облако. |
| `{iot hub host name}/devices/{deviceId}/devicebound` |Получение сообщений из облака на устройство. |

### <a name="use-a-symmetric-key-in-the-identity-registry"></a>Использование симметричного ключа в реестре удостоверений

Если для создания маркера используется симметричный ключ удостоверения устройства, то элемент policyName (`skn`) пропускается.

Например, маркер, созданный для доступа ко всем функциям устройства, должен иметь следующие параметры:

* универсальный код ресурса (URI): `{IoT hub name}.azure-devices.net/devices/{device id}`;
* ключ подписывания: любой симметричный ключ для удостоверения `{device id}` ;
* имя политики не требуется;
* время окончания срока действия.

Далее приведен пример использования предыдущей функции Node.js:

```nodejs
var endpoint ="myhub.azure-devices.net/devices/device1";
var deviceKey ="...";

var token = generateSasToken(endpoint, deviceKey, null, 60);
```

Результат, предоставляющий доступ ко всем возможностям устройства device1, будет иметь следующий вид:

`SharedAccessSignature sr=myhub.azure-devices.net%2fdevices%2fdevice1&sig=13y8ejUk2z7PLmvtwR5RqlGBOVwiq7rQR3WZ5xZX3N4%3D&se=1456971697`

> [!NOTE]
> Маркер SAS можно создать с помощью инструмента [обозреватель устройств][lnk-device-explorer] на основе .NET или с помощью кроссплатформенной служебной программы командной строки [iothub-explorer][lnk-iothub-explorer] на основе Node.

### <a name="use-a-shared-access-policy"></a>Использование политики общего доступа

При создании маркера из политики общего доступа в поле `skn` укажите имя политики. Эта политика должна предоставить разрешение **DeviceConnect**.

Существует два основных сценария использования политик общего доступа для доступа к возможностям устройств:

* [облачные шлюзы протоколов][lnk-endpoints];
* [службы маркеров][lnk-custom-auth], используемые для реализации настраиваемых схем аутентификации.

Так как политика общего доступа может предоставлять доступ для подключения в качестве любого устройства, при создании маркеров безопасности важно использовать правильный URI ресурса. Этот параметр имеет особое значение для служб маркеров, которые должны определять область действия маркера для конкретного устройства с помощью URI ресурса. Он менее критичен для шлюзов протоколов, так как они уже обрабатывают трафик для всех устройств.

Например, служба маркеров, использующая предварительно созданную политику общего доступа с именем **device** , создаст маркер со следующими параметрами:

* универсальный код ресурса (URI): `{IoT hub name}.azure-devices.net/devices/{device id}`;
* ключ подписывания: один из ключей политики `device` ;
* имя политики: `device`;
* время окончания срока действия.

Далее приведен пример использования предыдущей функции Node.js:

```nodejs
var endpoint ="myhub.azure-devices.net/devices/device1";
var policyName = 'device';
var policyKey = '...';

var token = generateSasToken(endpoint, policyKey, policyName, 60);
```

Результат, предоставляющий доступ ко всем возможностям устройства device1, будет иметь следующий вид:

`SharedAccessSignature sr=myhub.azure-devices.net%2fdevices%2fdevice1&sig=13y8ejUk2z7PLmvtwR5RqlGBOVwiq7rQR3WZ5xZX3N4%3D&se=1456971697&skn=device`

Шлюз протокола может использовать этот же маркер для всех устройств, задав `myhub.azure-devices.net/devices`в качестве универсального кода ресурса (URI).

### <a name="use-security-tokens-from-service-components"></a>Использование маркеров безопасности из компонентов службы

Компоненты службы могут создавать маркеры безопасности только с помощью политик общего доступа, предоставляющих соответствующие разрешения, как описано ранее.

Ниже приведены функции службы, предоставляемые в конечных точках.

| Конечная точка | Функции |
| --- | --- |
| `{iot hub host name}/devices` |Создание, обновление, извлечение и удаление удостоверений устройств. |
| `{iot hub host name}/messages/events` |Получение сообщений с устройства в облако. |
| `{iot hub host name}/servicebound/feedback` |Получение ответа на сообщения, отправляемые из облака на устройство. |
| `{iot hub host name}/devicebound` |Отправка сообщений из облака на устройство. |

Например, служба, использующая предварительно созданную политику общего доступа с именем **registryRead** , создаст маркер со следующими параметрами:

* универсальный код ресурса (URI): `{IoT hub name}.azure-devices.net/devices`;
* ключ подписывания: один из ключей политики `registryRead` ;
* имя политики: `registryRead`;
* время окончания срока действия.

```nodejs
var endpoint ="myhub.azure-devices.net/devices";
var policyName = 'device';
var policyKey = '...';

var token = generateSasToken(endpoint, policyKey, policyName, 60);
```

Результат, предоставляющий доступ для чтения всех идентификаторов устройств, будет иметь следующий вид:

`SharedAccessSignature sr=myhub.azure-devices.net%2fdevices&sig=JdyscqTpXdEJs49elIUCcohw2DlFDR3zfH5KqGJo4r4%3D&se=1456973447&skn=registryRead`

## <a name="supported-x509-certificates"></a>Поддерживаемые сертификаты X.509

Вы можете использовать любой сертификат X.509 для проверки подлинности устройства с помощью Центра Интернета вещей. Сертификаты включают в себя:

* **Существующий сертификат X.509**. Возможно, устройство уже имеет связанный сертификат X.509. Устройство может использовать этот сертификат для проверки подлинности с помощью Центра Интернета вещей.
* **Самостоятельно сформированный и самозаверяющий сертификат X-509**. Производитель устройства или внутренний специалист по развертыванию может создать эти сертификаты и сохранить соответствующий закрытый ключ (и сертификат) на устройстве. Для этого вы можете использовать такие инструменты, как [OpenSSL][lnk-openssl] и служебная программа [Windows SelfSignedCertificate][lnk-selfsigned].
* **Сертификат X.509, подписанный центром сертификации**. Для идентификации устройства и его аутентификации с помощью Центра Интернета вещей можно использовать сертификат X.509, созданный и подписанный центром сертификации (ЦС). Центр Интернета вещей только проверяет, чтобы представленный отпечаток соответствовал настроенному отпечатку. Центр Интернета вещей не проверяет цепочку сертификатов.

Для аутентификации устройство может использовать только один из вариантов: либо сертификат X.509, либо маркер безопасности.

### <a name="register-an-x509-certificate-for-a-device"></a>Регистрация сертификата X.509 для устройства

[Пакет SDK службы Интенета вещей Azure для C#][lnk-service-sdk] (версия 1.0.8+) поддерживает регистрацию устройства, которое использует сертификат X.509 для аутентификации. Другие интерфейсы API (например, импорт и экспорт устройств) также поддерживают сертификаты X.509.

### <a name="c-support"></a>Поддержка C\#

Класс **RegistryManager** предоставляет программный способ регистрации устройства. В частности, методы **AddDeviceAsync** и **UpdateDeviceAsync** позволяют регистрировать и обновлять устройства в реестре удостоверений Центра Интернета вещей. Эти два метода используют экземпляр **устройства** в качестве входных данных. Класс **Device** включает свойство **Authentication**, которое позволяет указывать основной и дополнительный отпечатки сертификата X.509. Отпечаток представляет хэш SHA-1 сертификата X.509 (сохраненного с помощью двоичного кодирования DER). Вы можете указать основной или вторичный отпечаток или оба отпечатка сразу. Основной и вторичный отпечатки поддерживаются для обработки сценариев переключения сертификатов.

> [!NOTE]
> Центр Интернета вещей не требует и не хранит весь сертификат X.509, а только его отпечаток.

Ниже приведен пример фрагмента кода C\# для регистрации устройства с использованием сертификата X.509:

```csharp
var device = new Device(deviceId)
{
  Authentication = new AuthenticationMechanism()
  {
    X509Thumbprint = new X509Thumbprint()
    {
      PrimaryThumbprint = "921BC9694ADEB8929D4F7FE4B9A3A6DE58B0790B"
    }
  }
};
RegistryManager registryManager = RegistryManager.CreateFromConnectionString(deviceGatewayConnectionString);
await registryManager.AddDeviceAsync(device);
```

### <a name="use-an-x509-certificate-during-run-time-operations"></a>Использование сертификата X.509 во время выполнения операций среды выполнения

[Пакет SDK для устройств Azure IoT для .NET][lnk-client-sdk] (версия 1.0.11+) поддерживает использование сертификатов X.509.

### <a name="c-support"></a>Поддержка C\#

Класс **DeviceAuthenticationWithX509Certificate** поддерживает создание экземпляров **DeviceClient** с помощью сертификата X.509. Сертификат X.509 должен быть в формате PFX (также называется PKCS № 12), который содержит закрытый ключ.

Ниже приведен образец фрагмента кода:

```csharp
var authMethod = new DeviceAuthenticationWithX509Certificate("<device id>", x509Certificate);

var deviceClient = DeviceClient.Create("<IotHub DNS HostName>", authMethod);
```

## <a name="custom-device-authentication"></a>Настраиваемая проверка подлинности устройства

[Реестр удостоверений][lnk-identity-registry] Центра Интернета вещей позволяет настроить контроль доступа и учетные данные безопасности для каждого устройства с помощью [маркеров][lnk-sas-tokens]. Если в решении Интернета вещей уже есть настраиваемый реестр удостоверений и (или) схема аутентификации, то рекомендуем создать *службу маркеров*, чтобы интегрировать эту инфраструктуру с Центром Интернета вещей. Таким образом можно использовать и другие функции IoT в решении.

Служба маркеров — это пользовательская облачная служба. Она использует *политику общего доступа* Центра Интернета вещей с разрешениями **DeviceConnect** для создания маркеров *уровня устройства*. Эти маркеры позволяют устройству подключиться к Центру Интернета вещей.

![Этапы для схемы службы маркеров.][img-tokenservice]

Ниже приведены основные этапы для схемы службы маркеров.

1. Создание политики общего доступа Центра Интернета вещей с разрешениями **DeviceConnect** для вашего Центра Интернета вещей. Эту политику можно создать на [портале Azure][lnk-management-portal] или программным способом. Эту политику служба маркеров будет использовать для подписания создаваемых маркеров.
1. Когда устройству требуется доступ к Центру Интернета вещей, оно запрашивает у службы маркеров подписанный маркер. Для определения удостоверения устройства, используемого службой маркеров для создания маркера, устройство может использовать настраиваемую схему аутентификации или реестр удостоверений.
1. Служба маркеров возвращает маркер. Чтобы создать маркер, используйте `/devices/{deviceId}` в качестве значения `resourceURI`, где `deviceId` — это аутентифицируемое устройство. Служба маркеров использует политики общего доступа для создания маркера.
1. Устройство использует маркер для подключения к Центру Интернета вещей.

> [!NOTE]
> Для создания маркера в службе маркеров можно использовать класс .NET [SharedAccessSignatureBuilder][lnk-dotnet-sas] или класс Java [IotHubServiceSasToken][lnk-java-sas].

При необходимости служба маркеров может задать срок действия маркера. По истечении срока действия маркера Центр Интернета вещей разрывает подключение к устройству. После этого устройство должно запросить новый маркер у службы маркеров. Короткий срок действия увеличит нагрузку как на устройство, так и на службу маркеров.

Кроме того, чтобы устройство могло подключаться к вашему центру, его необходимо добавить в реестр удостоверений Центра Интернета вещей, даже если для подключения устройство использует маркер, а не ключ. Поэтому контроль доступа на уровне отдельных устройств путем включения или отключения удостоверений устройств в [реестре удостоверений][lnk-identity-registry] продолжает работать. Это уменьшает риск существования маркеров с длительным сроком действия.

### <a name="comparison-with-a-custom-gateway"></a>Сравнение с настраиваемым шлюзом

Вариант со службой маркеров является рекомендованным способом внедрения настраиваемого реестра удостоверений или схемы проверки подлинности с использованием Центра Интернета вещей. Этот вариант рекомендуется, так как Центр Интернета вещей продолжает обрабатывать большую часть трафика решения. Однако, если настраиваемая схема аутентификации настолько тесно переплетена с протоколом, то для обработки всего трафика может потребоваться *настраиваемый шлюз*. В качестве примера сценария можно привести использование [протокола TLS и общих ключей][lnk-tls-psk]. Дополнительные сведения см. в разделе о [шлюзе протокола][lnk-protocols].

## <a name="reference-topics"></a>Справочные материалы

В следующих материалах предоставлены дополнительные сведения об управлении доступом к Центру Интернета вещей.

## <a name="iot-hub-permissions"></a>Разрешения Центра Интернета вещей

В следующей таблице указаны разрешения, с помощью которых можно управлять доступом к Центру Интернета вещей.

| Разрешение | Примечания |
| --- | --- |
| **RegistryRead** |Предоставляет доступ на чтение к реестру удостоверений. Дополнительные сведения см. в разделе о [реестре удостоверений][lnk-identity-registry]. <br/>Это разрешение используется серверными облачными службами. |
| **RegistryReadWrite** |Предоставляет доступ на чтение и запись к реестру удостоверений. Дополнительные сведения см. в разделе о [реестре удостоверений][lnk-identity-registry]. <br/>Это разрешение используется серверными облачными службами. |
| **ServiceConnect** |Предоставляет доступ к конечным точкам обмена данными и мониторинга, обращенным к облачной службе. <br/>Предоставляет разрешение облачным службам получать сообщения с устройств, отправлять сообщения на устройства и получать соответствующие уведомления о доставке. <br/>Предоставляет разрешение на получение подтверждения передачи файлов. <br/>Предоставляет разрешение на доступ к двойникам устройств для обновления тегов и требуемых свойств, извлечения сообщаемых свойств и выполнения запросов. <br/>Это разрешение используется серверными облачными службами. |
| **DeviceConnect** |Предоставляет доступ к конечным точкам для устройств. <br/>Позволяет отправлять сообщения с устройства в облако и получать сообщения, отправленные из облака на устройство. <br/>Предоставляет разрешение на передачу файлов с устройства. <br/>Предоставляет разрешение на получение уведомлений о требуемых свойствах для двойников устройств и на обновление сообщенных свойств двойных устройств. <br/>Предоставляет разрешение на передачу файлов. <br/>Это разрешение используют устройства. |

## <a name="additional-reference-material"></a>Дополнительные справочные материалы

Другие справочные статьи в руководстве разработчика для Центра Интернета вещей:

* Статья [IoT Hub endpoints][lnk-endpoints] (Конечные точки Центра Интернета вещей) содержит сведения о конечных точках, которые каждый Центр Интернета вещей предоставляет для операций управления и среды выполнения.
* Статья [Квоты и регулирование в Центре Интернета вещей][lnk-quotas] содержит сведения о квотах, применимых к службе Центра Интернета вещей, и поведении регулирования.
* В статье [Пакеты SDK для устройств и служб Интернета вещей Azure][lnk-sdks] указаны различные языковые пакеты SDK, которые можно использовать при разработке приложений для устройств и служб, взаимодействующих с Центром Интернета вещей.
* В статье [Справочник — язык запросов Центра Интернета вещей для двойников устройств, заданий и маршрутизации сообщений][lnk-query] описывается язык запросов, который можно использовать для получения сведений о двойниках устройств и заданиях из Центра Интернета вещей.
* Статья [Поддержка MQTT в Центре Интернета вещей][lnk-devguide-mqtt] содержит дополнительные сведения о поддержке протокола MQTT в Центре Интернета вещей.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы узнали, как управлять доступом к Центру Интернета вещей, вас могут заинтересовать следующие статьи в руководстве разработчика для Центра Интернета вещей:

* [Основные сведения о двойниках устройств (предварительная версия)][lnk-devguide-device-twins]
* [Вызов прямого метода на устройстве (предварительная версия)][lnk-devguide-directmethods]
* [Schedule jobs on multiple devices][lnk-devguide-jobs] (Планирование заданий на нескольких устройствах)

Если вы хотели бы применить на практике некоторые основные понятия, описанные в этой статье, можно просмотреть следующие руководства по Центру Интернета вещей:

* [Приступая к работе с Центром Интернета вещей Azure][lnk-getstarted-tutorial]
* [Учебник: как отправлять сообщения из облака на устройства с помощью центра IoT и .Net][lnk-c2d-tutorial]
* [Учебник: как обрабатывать сообщения, отправляемые с устройства центра IoT в облако, с помощью .Net][lnk-d2c-tutorial]

<!-- links and images -->

[img-tokenservice]: ./media/iot-hub-devguide-security/tokenservice.png
[lnk-endpoints]: iot-hub-devguide-endpoints.md
[lnk-quotas]: iot-hub-devguide-quotas-throttling.md
[lnk-sdks]: iot-hub-devguide-sdks.md
[lnk-query]: iot-hub-devguide-query-language.md
[lnk-devguide-mqtt]: iot-hub-mqtt-support.md
[lnk-openssl]: https://www.openssl.org/
[lnk-selfsigned]: https://technet.microsoft.com/library/hh848633

[lnk-resource-provider-apis]: https://docs.microsoft.com/rest/api/iothub/iothubresource
[lnk-sas-tokens]: iot-hub-devguide-security.md#security-tokens
[lnk-amqp]: https://www.amqp.org/
[lnk-azure-resource-manager]: ../azure-resource-manager/resource-group-overview.md
[lnk-cbs]: https://www.oasis-open.org/committees/download.php/50506/amqp-cbs-v1%200-wd02%202013-08-12.doc
[lnk-event-hubs-publisher-policy]: https://code.msdn.microsoft.com/Service-Bus-Event-Hub-99ce67ab
[lnk-management-portal]: https://portal.azure.com
[lnk-sasl-plain]: http://tools.ietf.org/html/rfc4616
[lnk-identity-registry]: iot-hub-devguide-identity-registry.md
[lnk-dotnet-sas]: https://msdn.microsoft.com/library/microsoft.azure.devices.common.security.sharedaccesssignaturebuilder.aspx
[lnk-java-sas]: https://docs.microsoft.com/java/api/com.microsoft.azure.sdk.iot.service.auth._iot_hub_service_sas_token
[lnk-tls-psk]: https://tools.ietf.org/html/rfc4279
[lnk-protocols]: iot-hub-protocol-gateway.md
[lnk-custom-auth]: iot-hub-devguide-security.md#custom-device-authentication
[lnk-x509]: iot-hub-devguide-security.md#supported-x509-certificates
[lnk-devguide-device-twins]: iot-hub-devguide-device-twins.md
[lnk-devguide-directmethods]: iot-hub-devguide-direct-methods.md
[lnk-devguide-jobs]: iot-hub-devguide-jobs.md
[lnk-service-sdk]: https://github.com/Azure/azure-iot-sdk-csharp/tree/master/service
[lnk-client-sdk]: https://github.com/Azure/azure-iot-sdk-csharp/tree/master/device
[lnk-device-explorer]: https://github.com/Azure/azure-iot-sdk-csharp/blob/master/tools/DeviceExplorer
[lnk-iothub-explorer]: https://github.com/azure/iothub-explorer

[lnk-getstarted-tutorial]: iot-hub-csharp-csharp-getstarted.md
[lnk-c2d-tutorial]: iot-hub-csharp-csharp-c2d.md
[lnk-d2c-tutorial]: iot-hub-csharp-csharp-process-d2c.md

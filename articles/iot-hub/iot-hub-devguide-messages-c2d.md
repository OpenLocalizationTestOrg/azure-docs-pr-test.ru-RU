---
title: "обмен сообщениями aaaUnderstand центр IoT Azure облака на устройство | Документы Microsoft"
description: "Руководство разработчика - как toouse облака на устройство обмена сообщениями с центром IoT. Содержит сведения о параметрах конфигурации и жизненный цикл сообщения hello."
services: iot-hub
documentationcenter: .net
author: dominicbetts
manager: timlt
editor: 
ms.service: iot-hub
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 05/25/2017
ms.author: dobett
ms.openlocfilehash: 5c747b50163873d823556a8baa769c4b8f7f8c44
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="send-cloud-to-device-messages-from-iot-hub"></a>Отправка сообщений, пересылаемых из облака на устройство, из Центра Интернета вещей

приложение для устройства toohello toosend одностороннего уведомления из серверной части вашего решения, отправлять сообщения облака для устройства с устройства tooyour концентратора IoT. Обсуждение других вариантов передачи данных из облака на устройство, поддерживаемых Центром Интернета вещей, см. в [руководстве по обмену данными между облаком и устройством][lnk-c2d-guidance].

Сообщения из облака на устройство можно отправлять через конечную точку, обращенную к службе (**/messages/devicebound**). Устройство получает сообщения hello через конечную точку конкретного устройства (**/devices/ {deviceId} / сообщений/devicebound**).

Каждое сообщение облака на устройство распространяется на отдельном устройстве параметр hello **для** свойство слишком**/devices/ {deviceId} / сообщений/devicebound**.

Одна очередь устройства содержит не более 50 сообщений, отправляемых из облака на устройство. Попытка toosend toohello дополнительные сообщения одного устройства приводит к ошибке.

## <a name="hello-cloud-to-device-message-lifecycle"></a>жизненный цикл облака на устройство сообщение Hello

Центр IoT доставки сообщений в однократная tooguarantee сохраняет облака на устройство сообщений в очереди на устройство. Устройства должны явным образом признаете *завершения* для центра IoT tooremove их из hello очереди. Этот способ гарантирует устойчивость к сбоям подключения и ошибкам устройств.

Hello следующей схеме показаны hello графа состояния жизненного цикла для облака на устройство сообщения в центр IoT.

![Жизненный цикл сообщений, отправляемых из облака на устройство][img-lifecycle]

При hello IoT Hub service отправляет сообщение tooa устройства, hello службы задает состояние сообщения hello слишком**сообщений в очереди**. Когда устройство хочет слишком*получать* сообщение центра IoT *блокировки* приветственное сообщение (, установив состояние hello слишком**невидимой**), разрешающее других потоков на устройстве toostart hello Получение других сообщений. Если устройства поток завершает обработку сообщения hello, уведомит центра IoT, *Завершение* приветственное сообщение. Центр IoT затем устанавливает состояние hello слишком**завершено**.

Устройство также может:

* *Отклонить* приветственное сообщение, что приведет к тому tooset центр IoT его toohello **считается недоставленным** состояния. Устройства, подключаемые через протокол MQTT hello не удается отклонить сообщения облака на устройство.
* *Прервать* сообщения hello, который вызывает центр IoT tooput приветственное сообщение обратно в очередь hello с состоянием hello задать слишком**сообщений в очереди**.

Поток может завершиться ошибкой tooprocess сообщение без уведомления центра IoT. В этом случае сообщения автоматически переход из hello **невидимой** toohello назад состояние **поставленных в очередь** состояния после *время ожидания видимости (или блокировка)*. значение по умолчанию Hello это время ожидания составляет одну минуту.

Сообщения можно переходить между hello **сообщений в очереди** и **невидимой** состояний, не более hello количество времени, указанного в hello **Макс. Число доставок** свойство центр IoT. После этого числа переходов центра IoT задает состояние hello приветственное сообщение, слишком**считается недоставленным**. Аналогичным образом, центр IoT задает состояние hello сообщения слишком**считается недоставленным** после истечения срока (в разделе [время toolive][lnk-ttl]).

Hello [способ сообщений toosend облака на устройство с центром IoT] [ lnk-c2d-tutorial] отображаются как облака на устройство toosend сообщения hello облако и получать их на устройстве.

Как правило устройство завершает сообщение облака на устройство при потере приветственное сообщение hello не влияет на логику приложения hello. Например, при hello устройство имеет постоянное сообщение hello содержимое локально, или успешного выполнения операции. приветственное сообщение также можно захватить промежуточной информации, не повлияет на которого потери hello функциональных возможностей приложения hello. В некоторых случаях для длительно выполняемых задач сообщение hello облака на устройство можно выполнить после сохранения hello описание задачи в локальном хранилище. Затем можно уведомить hello решения серверной части с одно или несколько сообщений устройства в облако на различных этапах хода выполнения задачи «hello».

## <a name="message-expiration-time-toolive"></a>Срок действия сообщения (время toolive)

Каждое сообщение из облака на устройство имеет срок действия. Это время задается службой hello (в hello **ExpiryTimeUtc** свойства), или с помощью по умолчанию hello центра IoT *toolive время* указан как свойство центр IoT. Ознакомьтесь с разделом [Параметры конфигурации сообщений, отправляемых из облака на устройство][lnk-c2d-configuration].

Общий способ tootake преимуществами сообщений истечение срока действия и избежать отправки сообщений toodisconnected устройства, tooset toolive значения короткое время. Такой подход позволяет достичь hello же результат как поддержки состояния подключения устройства hello, являются более эффективными. При запросе подтверждения сообщений центра IoT уведомляет устройств, которые могут tooreceive сообщений, и устройства, которые не находятся в сети, или произошел сбой.

## <a name="message-feedback"></a>Отзыв на сообщение

При отправке сообщения облака на устройство hello служба может запросить hello доставки каждого сообщения отзывов о hello конечное состояние этого сообщения.

| Свойство Ack | Поведение |
| ------------ | -------- |
| **positive** | Центр IoT создает сообщение обратной связи, если и только если сообщение hello облака на устройство достигло hello **завершено** состояния. |
| **negative** | Центр IoT создает сообщение обратной связи, если и только если сообщение hello облака на устройство достигает hello **считается недоставленным** состояния. |
| **full**     | Центр Интернета вещей создает отзыв на сообщение в любом случае. |

Если **Ack** — **полного**и вы не будете получать сообщение обратной связи, это означает, что истек срок действия сообщения hello обратной связи. Здравствуйте, служба не может знать, какая ошибка toohello исходного сообщения. На практике службы следует убедиться, возможность обработки отзывов hello до истечения срока его действия. Hello максимальный срок действия составляет двух дней, и это означает, что немало времени tooget hello службы снова выполнить при возникновении сбоя.

Как описано в статье [Endpoints][lnk-endpoints] (Конечные точки), Центр Интернета вещей предоставляет отзывы в виде сообщений через конечную точку, доступную для службы (**/messages/servicebound/feedback**). Hello семантику для получения отзывов hello таким же как и для облака на устройство сообщения и иметь hello же [жизненный цикл сообщения][lnk-lifecycle]. По возможности отзыв сообщения пакетных в одном сообщении с hello следующий формат:

| Свойство     | Описание |
| ------------ | ----------- |
| EnqueuedTime | Отметка времени, указывающее, время создания приветственных сообщений. |
| UserId       | `{iot hub name}` |
| ContentType  | `application/vnd.microsoft.iothub.feedback.json` |

текст Hello используется сериализации JSON массив записей, каждая из которых hello следующие свойства:

| Свойство           | Описание |
| ------------------ | ----------- |
| EnqueuedTimeUtc    | Отметка времени, указывающее, когда произошли результат приветственное сообщение hello. Например, hello устройства завершен или истек срок действия сообщения hello. |
| OriginalMessageId  | **Код (ID)** из toowhich облака на устройство сообщение hello связывает информацию для обратной связи. |
| StatusCode         | Обязательная строка. Используется в отзывах, созданных центром IoT. <br/> 'Success' <br/> 'Expired' <br/> 'DeliveryCountExceeded' <br/> 'Rejected' <br/> 'Purged' |
| Описание        | Строковые значения **StatusCode**. |
| deviceId           | **DeviceId** hello целевого устройства из toowhich облака на устройство сообщение hello относится эта часть обратной связи. |
| DeviceGenerationId | **DeviceGenerationId** из целевого устройства hello toowhich облака на устройство сообщение hello относится эта часть обратной связи. |

необходимо указать службы Hello **MessageId** для hello облака на устройство сообщения может toocorrelate toobe его обратной связи с исходное сообщение hello.

Hello пример hello тела сообщения обратной связи.

```json
[
  {
    "OriginalMessageId": "0987654321",
    "EnqueuedTimeUtc": "2015-07-28T16:24:48.789Z",
    "StatusCode": 0,
    "Description": "Success",
    "DeviceId": "123",
    "DeviceGenerationId": "abcdefghijklmnopqrstuvwxyz"
  },
  {
    ...
  },
  ...
]
```

## <a name="cloud-to-device-configuration-options"></a>Параметры конфигурации сообщений, отправляемых из облака на устройство

Каждый центр IoT предоставляет следующие параметры конфигурации для облака на устройство сообщений hello.

| Свойство                  | Описание | Диапазон и значение по умолчанию |
| ------------------------- | ----------- | ----------------- |
| defaultTtlAsIso8601       | Заданный по умолчанию срок жизни для сообщений, отправляемых из облака на устройство. | Интервал ISO_8601 копирование too2D (минимальное 1 минута). Значение по умолчанию — 1 час. |
| maxDeliveryCount          | Лимит доставки для очереди доставки сообщений, отправляемых из облака на устройство, для каждого отдельного устройства. | 1 too100. Значение по умолчанию — 10. |
| feedback.ttlAsIso8601     | Хранение отзывов, направленных службе. | Интервал ISO_8601 копирование too2D (минимальное 1 минута). Значение по умолчанию — 1 час. |
| feedback.maxDeliveryCount |Лимит доставок для очереди отзывов. | 1 too100. Значение по умолчанию — 100. |

Дополнительные сведения о tooset эти параметры конфигурации см. в статье [центры IoT создания][lnk-portal].

## <a name="next-steps"></a>Дальнейшие действия

Сведения о пакетах SDK hello можно использовать сообщения tooreceive облака на устройство см [пакеты SDK Azure IoT][lnk-sdks].

tootry ожидания получения сообщений облака на устройство. в разделе hello [отправки облака на устройство] [ lnk-c2d-tutorial] учебника.

[img-lifecycle]: ./media/iot-hub-devguide-messages-c2d/lifecycle.png

[lnk-portal]: iot-hub-create-through-portal.md
[lnk-c2d-guidance]: iot-hub-devguide-c2d-guidance.md
[lnk-endpoints]: iot-hub-devguide-endpoints.md
[lnk-sdks]: iot-hub-devguide-sdks.md
[lnk-ttl]: #message-expiration-time-to-live
[lnk-c2d-configuration]: #cloud-to-device-configuration-options
[lnk-lifecycle]: #message-lifecycle
[lnk-c2d-tutorial]: iot-hub-csharp-csharp-c2d.md

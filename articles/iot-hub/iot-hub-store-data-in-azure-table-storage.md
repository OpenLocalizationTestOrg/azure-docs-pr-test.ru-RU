---
title: "Сохранение сообщений Центра Интернета вещей в хранилище данных Azure | Документация Майкрософт"
description: "Сохранение сообщений Центра Интернета вещей в хранилище таблиц Azure с помощью приложения-функции Azure. Сообщения Центра Интернета вещей содержат такие сведения, как данные датчиков, отправленные из устройства Интернета вещей."
services: iot-hub
documentationcenter: 
author: shizn
manager: timlt
tags: 
keywords: "хранилище данных Центра Интернета вещей, хранилище для данных датчиков Центра Интернета вещей"
ms.assetid: 62fd14fd-aaaa-4b3d-8367-75c1111b6269
ms.service: iot-hub
ms.devlang: arduino
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/16/2017
ms.author: xshi
ms.openlocfilehash: 06503f9564e00ef62587d02f2da4778974e246c5
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="save-iot-hub-messages-that-contain-sensor-data-to-your-azure-table-storage"></a>Сохранение сообщений Центра Интернета вещей, которые содержат данные датчиков, в хранилище таблиц Azure

![Сквозная схема](media/iot-hub-get-started-e2e-diagram/3.png)

[!INCLUDE [iot-hub-get-started-note](../../includes/iot-hub-get-started-note.md)]

## <a name="what-you-learn"></a>Что вы узнаете

Вы узнаете, как создать учетную запись хранения Azure и приложение-функцию Azure для сохранения сообщений Центра Интернета вещей в хранилище таблиц.

## <a name="what-you-do"></a>В рамках этого руководства мы:

- Создайте учетную запись хранения Azure.
- Выполните подготовку к подключению Центра Интернета вещей для чтения сообщений.
- Создайте приложение-функцию Azure и разверните его.

## <a name="what-you-need"></a>Необходимые элементы

- [Настройте свое устройство](iot-hub-raspberry-pi-kit-node-get-started.md). У вас должны быть следующие компоненты:
  - активная подписка Azure;
  - Центр Интернета вещей в подписке; 
  - работающее приложение, отправляющее сообщения в Центр Интернета вещей.

## <a name="create-an-azure-storage-account"></a>Создание учетной записи хранения Azure

1. На [портале Azure](https://portal.azure.com/) щелкните **Создать** > **Хранилище** > **Учетная запись хранения** > **Создать**.

2. Введите необходимые сведения для учетной записи хранения:

   ![Создание учетной записи хранения на портале Azure](media\iot-hub-store-data-in-azure-table-storage\1_azure-portal-create-storage-account.png)

   * **Имя**. Имя учетной записи хранения. Оно должно быть глобально уникальным.

   * **Группа ресурсов**. Выберите ту же группу ресурсов, которую использует Центр Интернета вещей.

   * **Закрепить на панели мониторинга.** Установите этот флажок, чтобы быстро открывать Центр Интернета вещей с помощью панели мониторинга.

3. Щелкните **Создать**.

## <a name="prepare-your-iot-hub-connection-to-read-messages"></a>Подготовка к подключению Центра Интернета вещей для чтения сообщений

Центр Интернета вещей предоставляет встроенную совместимую с концентратором событий конечную точку, с помощью которой приложения считывают сообщения Центра Интернета вещей. В то же время, чтобы считывать данные из Центра Интернета вещей, приложения используют группы получателей. Перед созданием приложения-функции Azure для считывания данных из Центра Интернета вещей, сделайте следующее:

- получить строку подключения конечной точки Центра Интернета вещей;
- создать группу потребителей для Центра Интернета вещей.

### <a name="get-the-connection-string-of-your-iot-hub-endpoint"></a>Получение строки подключения конечной точки Центра Интернета вещей

1. Откройте Центр Интернета вещей.

2. В области **Центр Интернета вещей** в разделе **Сообщения** щелкните **Конечные точки**.

3. В правой области в разделе **Встроенные конечные точки** выберите **События**.

4. В области **Свойства** обратите внимание на следующие значения:
   - конечная точка, совместимая с концентратором событий;
   - имя, совместимое с концентратором событий.

   ![Получение строки подключения конечной точки Центра Интернета вещей на портале Azure](media\iot-hub-store-data-in-azure-table-storage\2_azure-portal-iot-hub-endpoint-connection-string.png)

5. В области **Центр Интернета вещей** в разделе **Параметры** выберите **Политики общего доступа**.

6. Щелкните **iothubowner**.

7. Запишите значение **Первичный ключ**.

8. Создайте строку подключения конечной точки Центра Интернета вещей в следующем формате:

   `Endpoint=<Event Hub-compatible endpoint>;SharedAccessKeyName=iothubowner;SharedAccessKey=<Primary key>`

   > [!NOTE]
   > Замените `<Event Hub-compatible endpoint>` и `<Primary key>` значениями, записанными ранее.

### <a name="create-a-consumer-group-for-your-iot-hub"></a>Создание группы потребителей для Центра Интернета вещей

1. Откройте Центр Интернета вещей.

2. В области **Центр Интернета вещей** в разделе **Сообщения** щелкните **Конечные точки**.

3. В правой области в разделе **Встроенные конечные точки** выберите **События**.

4. В области **Свойства** в разделе **Группы потребителей** введите имя, а затем запишите его.

5. Щелкните **Сохранить**.

## <a name="create-and-deploy-an-azure-function-app"></a>Создание и развертывание приложения-функции Azure

1. На [портале Azure](https://portal.azure.com/) щелкните **Создать** > **Вычисления** > **Приложение-функция** > **Создать**.

2. Введите необходимые сведения для приложения-функции.

   ![Создание приложения-функции на портале Azure](media\iot-hub-store-data-in-azure-table-storage\3_azure-portal-create-function-app.png)

   * **Имя приложения**. Имя приложения-функции. Оно должно быть глобально уникальным.

   * **Группа ресурсов**. Выберите ту же группу ресурсов, которую использует Центр Интернета вещей.

   * **Учетная запись хранения**. Созданная вами учетная запись хранения.

   * **Закрепить на панели мониторинга**. Установите этот флажок, чтобы быстро открывать приложение-функцию с помощью панели мониторинга.

3. Щелкните **Создать**.

4. После создания приложения-функции откройте его.

5. В приложении-функции создайте функцию, выполнив следующие действия:

   а. Щелкните **Новая функция**.

   b. Для параметра **Язык** выберите **JavaScript**, а для **Сценарий** — **Обработка данных**.

   c. Щелкните **Создайте эту функцию**, а затем — выберите **Новая функция**.

   г) Выберите **JavaScript** в качестве языка и **Обработка данных** в качестве сценария.

   д. Щелкните шаблон **EventHubTrigger-JavaScript**.

   f. Введите необходимые сведения для шаблона.

      * **Присвойте имя функции**. Имя функции.

      * **Имя концентратора событий**. Имя, совместимое с концентратором событий, которое вы записали ранее.

      * **Подключение к концентратору событий**. Щелкните **Новые**, чтобы добавить строку подключения конечной точки Центра Интернета вещей, которую вы создали.

   g. Щелкните **Создать**.

6. Настройте выходные данные функции, выполнив следующие действия:

   а. Щелкните **Интегрировать** > **Новое выходное значение** > **Хранилище таблиц Azure** > **Выбрать**.

      ![Добавление хранилища таблиц в приложение-функцию на портале Azure](media\iot-hub-store-data-in-azure-table-storage\4_azure-portal-function-app-add-output-table-storage.png)

   b. Введите необходимые сведения.

      * **Имя параметра таблицы**. Используйте `outputTable`, которое будет использоваться в коде функции Azure.
      
      * **Имя таблицы**. Используйте `deviceData`.

      * **Подключение к учетной записи хранения**. Щелкните **Новые** и выберите или введите свою учетную запись хранения. Если учетная запись хранения не отображается, ознакомьтесь с разделом [Требования к учетной записи хранения](https://docs.microsoft.com/azure/azure-functions/functions-create-function-app-portal#storage-account-requirements).
      
   c. Щелкните **Сохранить**.

7. В разделе **Триггеры** щелкните **Концентратор событий Azure (eventHubMessages)**.

8. В разделе **Группа пользователей концентратора событий** введите имя созданной вами группы получателей, а затем щелкните **Сохранить**.

9. Щелкните созданную функцию в левой части экрана, а затем щелкните **Просмотреть файлы** справа.

10. Замените код в `index.js` приведенным ниже:

   ```javascript
   'use strict';

   // This function is triggered each time a message is received in the IoT hub.
   // The message payload is persisted in an Azure storage table
 
   module.exports = function (context, iotHubMessage) {
    context.log('Message received: ' + JSON.stringify(iotHubMessage));
    var date = Date.now();
    var partitionKey = Math.floor(date / (24 * 60 * 60 * 1000)) + '';
    var rowKey = date + '';
    context.bindings.outputTable = {
     "partitionKey": partitionKey,
     "rowKey": rowKey,
     "message": JSON.stringify(iotHubMessage)
    };
    context.done();
   };
   ```

11. Щелкните **Сохранить**.

Приложение-функция создано. Приложение-функция сохраняет сообщения, которые получает Центр Интернета вещей в хранилище таблиц.

> [!NOTE]
> Используйте кнопку **Выполнить** для тестирования приложения-функции. Если вы нажмете кнопку **Выполнить**, в Центр Интернета вещей будет отправлено тестовое сообщение. Доставка сообщения должна активировать запуск приложения-функции, после чего сообщение сохранится в хранилище таблиц. В области **Журналы** записываются сведения о процессе.

## <a name="verify-your-message-in-your-table-storage"></a>Проверка сообщений в хранилище таблиц

1. Выполните пример приложения на устройстве, чтобы отправить сообщения в Центр Интернета вещей.

2. [Скачайте и установите обозреватель хранилищ Azure](http://storageexplorer.com/).

3. Откройте обозреватель хранилищ, щелкните **Add an Azure Account** (Добавление учетной записи Azure)  > **Вход**, а затем выполните вход в свою учетную запись Azure.

4. Щелкните подписку Azure > **Учетные записи хранения** > ваша учетная запись хранения > **Таблицы** > **deviceData**.

   Вы должны увидеть сообщения, отправленные с устройства в Центр Интернета вещей, в таблице `deviceData`.

## <a name="next-steps"></a>Дальнейшие действия

Вы успешно создали учетную запись хранения Azure и приложение-функцию Azure, которое сохраняет сообщения, поступающие в Центр Интернета вещей, в хранилище таблиц.

[!INCLUDE [iot-hub-get-started-next-steps](../../includes/iot-hub-get-started-next-steps.md)]

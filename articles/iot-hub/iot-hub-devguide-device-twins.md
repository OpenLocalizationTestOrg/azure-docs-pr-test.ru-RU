---
title: "близнецы устройства Azure IoT Hub aaaUnderstand | Документы Microsoft"
description: "Руководство разработчика - использовать устройство близнецы toosynchronize состояние и данные конфигурации между центр IoT и устройств"
services: iot-hub
documentationcenter: .net
author: fsautomata
manager: timlt
editor: 
ms.assetid: 8a3da072-a5bf-46e5-8de4-24cdbb2a03fa
ms.service: iot-hub
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/24/2017
ms.author: elioda
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 7dade18665108ed352ff3d18e864dc34f451bbf6
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="understand-and-use-device-twins-in-iot-hub"></a>Общие сведения о двойниках устройств и их использование в Центре Интернета вещей
## <a name="overview"></a>Обзор
*Двойники устройств* — это документы JSON, хранящие сведения о состоянии устройства (метаданные, конфигурации и условия). Центр IoT сохранение двойных устройства для каждого устройства, подключении tooIoT концентратора. Содержание статьи

* Здравствуйте структура двойных устройства hello: *теги*, *требуемой* и *сообщил свойства*, и
* операции Hello, приложений для устройств и заканчивается обратной можно выполнить на устройстве близнецы.

> [!NOTE]
> В настоящее время устройство близнецы доступны только из устройств, которые подключаются tooIoT концентратора с помощью протокола MQTT hello. Ссылки toohello [MQTT поддержки] [ lnk-devguide-mqtt] статье инструкции о том, как приложение toouse tooconvert существующие устройства MQTT.
> 
> 

### <a name="when-toouse"></a>Когда toouse
Двойники устройства используются для выполнения следующих действий:

* Метаданные для конкретного устройства хранения в облаке hello. Здравствуйте, например, Торговый автомат расположение развертывания.
* Сообщение сведений о текущем состоянии приложения устройства, таких как доступные возможности и условия. Например, устройство является центр IoT подключенных tooyour over сотовой и Wi-Fi.
* Синхронизируйте состояние hello длительных рабочих процессов между приложением устройства и серверной части приложения. Например при hello решение обратно end указывает hello новый tooinstall версии встроенного по и отчеты приложения hello устройств hello различные этапы процесса обновления hello.
* выполнение запроса метаданных, конфигурации или состояния устройства.

См. слишком[руководство связи устройства в облако] [ lnk-d2c-guidance] рекомендации по использованию выводятся свойства, сообщения из устройства в облако или передачи файла.
См. слишком[руководство связи облака на устройство] [ lnk-c2d-guidance] рекомендации по работе с нужными свойствами, непосредственные методы или сообщений облака на устройство.

## <a name="device-twins"></a>Двойники устройства
Двойники устройств хранят сведения об устройствах:

* Заканчивается устройства и обратно можно использовать условия toosynchronize устройств и конфигурации.
* Hello решения серверной части можно использовать tooquery и целевой длительных операций.

жизненный цикл Hello двойных устройства связан соответствующий toohello [удостоверение устройства][lnk-identity]. Двойники устройства неявно создаются и удаляются при создании или удалении удостоверения устройства в Центре Интернета вещей.

Двойник устройства является документом JSON, содержащим следующие компоненты:

* **Теги**. Раздела документа JSON hello, hello серверной части решения могут считывать и записывать. Теги не видны toodevice приложения.
* **Требуемые свойства**. Используется вместе с конфигурации устройства toosynchronize свойств отчета или условий. Требуемые свойства может устанавливаться только обратно решением hello end и может быть прочитан приложение hello устройства. приложение Hello устройства можно также получать уведомления в режиме реального времени изменения в hello требуемого свойства.
* **Сообщаемые свойства**. Используется вместе с нужными свойствами конфигурации устройства toosynchronize или условий. Отчета свойства могут задаваться только приложение hello устройства и можно считывать и запрашивать hello решения серверной части.

Кроме того, корневой каталог hello устройства двойных hello JSON-документ содержит hello свойства только для чтения из удостоверения устройства соответствующие hello, хранящихся в hello [реестра удостоверений][lnk-identity].

![][img-twin]

Следующий пример Hello показано устройства двойных документа JSON.

        {
            "deviceId": "devA",
            "generationId": "123",
            "status": "enabled",
            "statusReason": "provisioned",
            "connectionState": "connected",
            "connectionStateUpdatedTime": "2015-02-28T16:24:48.789Z",
            "lastActivityTime": "2015-02-30T16:24:48.789Z",

            "tags": {
                "$etag": "123",
                "deploymentLocation": {
                    "building": "43",
                    "floor": "1"
                }
            },
            "properties": {
                "desired": {
                    "telemetryConfig": {
                        "sendFrequency": "5m"
                    },
                    "$metadata" : {...},
                    "$version": 1
                },
                "reported": {
                    "telemetryConfig": {
                        "sendFrequency": "5m",
                        "status": "success"
                    }
                    "batteryLevel": 55,
                    "$metadata" : {...},
                    "$version": 4
                }
            }
        }

В корневой объект hello, являются системными свойствами hello и контейнер объектов для `tags` и `reported` и `desired` свойства. Hello `properties` контейнер содержит некоторые элементы, доступные только для чтения (`$metadata`, `$etag`, и `$version`) описано в hello [метаданные двойных устройства] [ lnk-twin-metadata] и [ Оптимистический параллелизм] [ lnk-concurrency] разделы.

### <a name="reported-property-example"></a>Пример сообщаемых свойств
В предыдущем примере hello содержит две устройства hello `batteryLevel` свойство, которое выдается приложение hello устройства. Это свойство позволяет возможных tooquery и работать на устройствах, в зависимости от последнего уровня отчета батареи hello. Другие примеры отчетов возможности устройства hello устройства приложения или параметры подключения.

> [!NOTE]
> Свойства отчета упрощения сценариев, где серверной части решения hello интересует hello последнее известное значение свойства. Используйте [сообщения из устройства в облако] [ lnk-d2c] серверной части hello решения необходимо tooprocess устройства телеметрии в форме hello последовательностей событий отметку времени, таких как временных рядов.

### <a name="desired-property-example"></a>Пример требуемого свойства
В предыдущем примере hello hello `telemetryConfig` требуемого двойных устройства и выводятся свойства используются в серверной части решения hello и конфигурации телеметрии hello toosynchronize приложения hello устройства для этого устройства. Например:

1. серверной части решения Hello присваивает свойству hello требуемого значения hello требуемой конфигурации. Вот hello часть документа hello с набором hello требуемого свойства.
   
        ...
        "desired": {
            "telemetryConfig": {
                "sendFrequency": "5m"
            },
            ...
        },
        ...
2. приложение Hello устройство получает уведомление hello изменения немедленно в том случае, если подключение или на hello сначала повторное подключение. Hello приложения для устройств затем отчет hello обновления конфигурации (или об ошибке с помощью hello `status` свойство). Вот часть hello hello сообщил свойства:
   
        ...
        "reported": {
            "telemetryConfig": {
                "sendFrequency": "5m",
                "status": "success"
            }
            ...
        }
        ...
3. серверной части решения Hello можно отслеживать результаты hello hello конфигурации операции на множестве устройств по [запрос] [ lnk-query] близнецы устройства.

> [!NOTE]
> Hello выше фрагменты являются примерами, оптимизированный для удобочитаемость, одним из способов tooencode конфигурации устройства и его состояние. Центр IoT никак не определенной схеме для требуемого двойных устройства hello и которые сообщили свойства в устройство близнецы hello.
> 
> 

Можно использовать близнецы toosynchronize продолжительных операций, таких как обновления встроенного по. Дополнительные сведения о статье toosynchronize свойства toouse и отслеживания продолжительной операции на устройствах, [используйте требуемого свойства устройства tooconfigure][lnk-twin-properties].

## <a name="back-end-operations"></a>Операции серверной части
серверной части решения Hello оперирует двойных устройства hello hello, следуя атомарных операций, доступных через HTTP с помощью:

1. **Получение двойника устройства по идентификатору.** Эта операция возвращает устройства двойных hello документ, в том числе теги и необходимо, в отчет и системные свойства.
2. **Частичное обновление двойника устройства.** Эта операция включает hello hello решения серверной части toopartially обновления тегов или требуемые свойства в двойных устройства. Частичное обновление Hello выражается как документ JSON, который добавляет или обновляет любого свойства. Заданы слишком`null` удаляются. Hello следующий пример создает новое нужного свойство со значением `{"newProperty": "newValue"}`, перезаписывает существующее значение hello объекта `existingProperty` с `"otherNewValue"`и удаляет `otherOldProperty`. Другие изменения не вносятся tooexisting требуемого свойства или теги:
   
        {
            "properties": {
                "desired": {
                    "newProperty": {
                        "nestedProperty": "newValue"
                    },
                    "existingProperty": "otherNewValue",
                    "otherOldProperty": null
                }
            }
        }
3. **Заменить требуемые свойства**. Перезаписать все существующие нужные свойства этой операции включает hello решения серверной части toocompletely и замените документ JSON для `properties/desired`.
4. **Заменить теги**. Это операция включает hello решения серверной части toocompletely перезаписать все существующие теги и замените документ JSON для `tags`.
5. **Получение уведомлений двойника**. Эта операция позволяет toobe серверной части решения hello, уведомления, когда изменяется двойных hello. toodo таким образом, вашего решения IoT должен toocreate маршрута и равенства источника данных hello tooset слишком*twinChangeEvents*. По умолчанию уведомления двойника не отправляются, то есть такие маршруты не существуют. Если скорость изменения hello слишком велико или по другим причинам, например внутренними сбоями hello центра IoT может отправлять только одно уведомление, которая содержит все изменения. Поэтому, если приложению требуется надежный аудит и ведение журнала всех промежуточных состояний, по-прежнему рекомендуется использовать сообщения, отправляемые с устройства в облако. сообщение уведомления двойных Hello включает свойства и текст.

    - Свойства

    | Имя | Значение |
    | --- | --- |
    $content-type | приложение/json |
    $iothub-enqueuedtime |  Время отправки уведомлений hello |
    $iothub-message-source | twinChangeEvents |
    $content-encoding | utf-8 |
    deviceId | Идентификатор устройства hello |
    hubName | Имя Центра Интернета вещей |
    operationTimestamp | Метка времени операции по стандарту [ISO8601] |
    iothub-message-schema | deviceLifecycleNotification |
    opType | "replaceTwin" или "updateTwin" |

    Системные свойства сообщения имеют префикс hello `'$'` символов.

    - Текст
        
    Этот раздел содержит все изменения двойных hello в формате JSON. Она использует hello в том же формате, что исправление, отличие hello что он может содержать все разделы двойных: теги, properties.reported, properties.desired и что он содержит элементы hello «$metadata». Например,
    ```
    {
        "properties": {
            "desired": {
                "$metadata": {
                    "$lastUpdated": "2016-02-30T16:24:48.789Z"
                },
                "$version": 1
            },
            "reported": {
                "$metadata": {
                    "$lastUpdated": "2016-02-30T16:24:48.789Z"
                },
                "$version": 1
            }
        }
    }
    ``` 

Все hello предыдущей операции поддержки [оптимистичного параллелизма] [ lnk-concurrency] и требуют hello **ServiceConnect** разрешения, как определено в hello [безопасности ] [ lnk-security] статьи.

В дополнение к этому toothese операций, решение hello резервные окончания может:

* Запрос близнецы hello устройства, с помощью hello SQL-подобного [язык запросов центра IoT][lnk-query].
* выполнять операции с большими наборами двойников устройств с помощью [заданий][lnk-jobs].

## <a name="device-operations"></a>Операции с устройствами
приложение Hello устройство работает двойных устройства hello hello, следуя атомарных операций с помощью:

1. **Получение двойника устройства.** Эта операция возвращает документ двойных hello устройства (в том числе теги и требуемого, отчет и системные свойства) для hello устройств, подключенных в данный момент.
2. **Частично обновить сообщаемые свойства**. Этой операции включает hello частичное обновление hello сообщил свойства hello подключенного устройства. Hello использует этой операции, обновление же JSON форматирования, hello решения задней использует для частичного обновления требуемых свойств.
3. **Отслеживать требуемые свойства**. Hello в настоящее время подключенные устройства, которые можно выбрать toobe уведомления об обновлениях toohello требуемого свойства при их возникновении. Hello получает hello же форме обновления (частично или полностью замена) исполнен hello решения серверной части.

Здравствуйте, всех предшествующих операций требуется hello **DeviceConnect** разрешения, как определено в hello [безопасности] [ lnk-security] статьи.

Hello [устройств Azure IoT SDK] [ lnk-sdks] сделать его легко toouse hello предыдущих операций из многих языках и платформах. Дополнительные сведения о hello примитивов центр IoT для синхронизации с нужными свойствами можно найти в [потока повторного подключения устройства][lnk-reconnection].

> [!NOTE]
> В настоящее время устройство близнецы доступны только из устройств, которые подключаются tooIoT концентратора с помощью протокола MQTT hello.
> 
> 

## <a name="reference-topics"></a>Справочные материалы
Hello следующие справочные разделы предоставляют дополнительные сведения о центра IoT tooyour управления доступом.

## <a name="tags-and-properties-format"></a>Формат тегов и свойств
Теги, необходимые и выводятся свойства являются объектами JSON с hello следующие ограничения:

* Все ключи в объектах JSON представляют собой 64-байтовые строки Юникода UTF-8 с учетом регистра. Разрешено использовать все знаки, кроме управляющих символов Юникода (сегменты C0 и C1), а также `'.'`, `' '` и `'$'`.
* Все значения в объектах JSON может иметь следующие типы JSON hello: логическое значение, число, строка, объект. Запрещено использовать массивы.
* Все объекты JSON в тегах, требуемых и сообщаемых свойствах могут иметь глубину не более 5. Для экземпляра hello следующий объект является допустимым:

        {
            ...
            "tags": {
                "one": {
                    "two": {
                        "three": {
                            "four": {
                                "five": {
                                    "property": "value"
                                }
                            }
                        }
                    }
                }
            },
            ...
        }

* Все строковые значения могут быть длиной не более 512 байт.

## <a name="device-twin-size"></a>Размер двойника устройства
Центр IoT применяет ограничение на размер 8 КБ значениям hello `tags`, `properties/desired`, и `properties/reported`, за исключением элементы, доступные только для чтения.
Hello размер вычисляется путем подсчета все символы, за исключением ЮНИКОДА управляющие символы (сегменты C0 и C1) и пространства `' '` при появлении за пределами строковая константа.
Центр IoT с ошибкой отклоняет все операции, которые увеличит размер hello эти документы выше ограничение hello.

## <a name="device-twin-metadata"></a>Метаданные двойника устройства
Центр IoT сохраняет отметки времени hello hello последнего обновления для каждого объекта JSON в устройстве двойных требуемого и данные свойства. Hello отметки времени в формате UTC и закодированы в hello [ISO8601] формат `YYYY-MM-DDTHH:MM:SS.mmmZ`.
Например:

        {
            ...
            "properties": {
                "desired": {
                    "telemetryConfig": {
                        "sendFrequency": "5m"
                    },
                    "$metadata": {
                        "telemetryConfig": {
                            "sendFrequency": {
                                "$lastUpdated": "2016-03-30T16:24:48.789Z"
                            },
                            "$lastUpdated": "2016-03-30T16:24:48.789Z"
                        },
                        "$lastUpdated": "2016-03-30T16:24:48.789Z"
                    },
                    "$version": 23
                },
                "reported": {
                    "telemetryConfig": {
                        "sendFrequency": "5m",
                        "status": "success"
                    }
                    "batteryLevel": "55%",
                    "$metadata": {
                        "telemetryConfig": {
                            "sendFrequency": "5m",
                            "status": {
                                "$lastUpdated": "2016-03-31T16:35:48.789Z"
                            },
                            "$lastUpdated": "2016-03-31T16:35:48.789Z"
                        }
                        "batteryLevel": {
                            "$lastUpdated": "2016-04-01T16:35:48.789Z"
                        },
                        "$lastUpdated": "2016-04-01T16:24:48.789Z"
                    },
                    "$version": 123
                }
            }
            ...
        }

Эта информация хранится на каждого уровня обновления toopreserve (не только hello концевые hello структуры JSON), которые удалить ключи объекта.

## <a name="optimistic-concurrency"></a>Оптимистичный параллелизм
Теги, а также требуемые и сообщаемые свойства поддерживают оптимистичный параллелизм.
Теги ETag, имеют согласно [RFC7232], представляющий тег hello JSON-представление. Теги eTag можно использовать в операциях условного обновления из серверной части tooensure hello решения согласованности.

Устройство двойных требуемого и данные свойства не обладают теги eTag, но которым `$version` значение, которое гарантированно toobe добавочное. Аналогичным образом можно использовать tooan ETag, версия hello hello обновление стороны tooenforce согласованности обновлений. Например устройство приложения для отчета свойства или hello решения серверную часть для нужного свойства.

Версии также полезны, когда агент наблюдения (например, наблюдая hello требуемого свойства приложения для устройств hello) необходимо согласовать состязания между hello результат операции извлечения и уведомление об обновлении. Здравствуйте, раздел [потока повторного подключения устройства] [ lnk-reconnection] предоставляет дополнительные сведения.

## <a name="device-reconnection-flow"></a>Процедура при повторном подключении устройства
Центр Интернета вещей не сохраняет уведомления об обновлении требуемых свойств для отключенных устройств. Следует, что устройство, которое подключается необходимо получить полный нужными свойствами документе hello в toosubscribing сложения для уведомления об обновлениях. Имея возможность состязания между уведомления об обновлениях, а также полный поиск hello, hello последовательности должна быть гарантирована:

1. Приложения для устройств подключается tooan центр IoT.
2. Приложение устройства подписывается на уведомления об обновлениях требуемых свойств.
3. Приложения для устройств получает полный документ hello для нужного свойства.

приложение Hello устройства можно пропустить все уведомления с `$version` меньше или равно, чем версия hello полного документа полученные hello. Такой подход возможен, так как Центр Интернета вещей гарантирует постоянное увеличение версий.

> [!NOTE]
> Эта логика уже реализован в hello [устройств Azure IoT SDK][lnk-sdks]. Это описание полезно только в том случае, если приложение hello устройство нельзя использовать никакие устройств Azure IoT SDK и необходимо запрограммировать hello MQTT интерфейса напрямую.
> 
> 

## <a name="additional-reference-material"></a>Дополнительные справочные материалы
Другие разделы ссылку в hello центра IoT руководстве для разработчиков:

* Hello [конечные точки центра IoT] [ lnk-endpoints] статье hello различные конечные точки, предоставляемые каждый центр IoT для операций времени выполнения и управления.
* Hello [регулирование и квоты] [ lnk-quotas] статье hello квот, применяемые toohello службы центр IoT и hello регулирования tooexpect поведение при использовании службы hello.
* Hello [пакетов SDK устройств и служб Azure IoT] [ lnk-sdks] статье списки hello различных пакетов SDK для языка, можно использовать при разработке приложений, устройств и служб, которые взаимодействуют с центром IoT.
* Hello [центр IoT язык запросов для близнецы устройства, задания и маршрутизация сообщений] [ lnk-query] статье hello tooretrieve сведения из центра IoT близнецы устройства и заданий можно использовать язык запросов центра IoT .
* Hello [поддержки MQTT концентратора IoT] [ lnk-devguide-mqtt] статье приведены дополнительные сведения о поддержке протокола MQTT hello центр IoT.

## <a name="next-steps"></a>Дальнейшие действия
Теперь вы узнали о близнецы устройства, можно получить в следующие разделы руководства разработчика центра IoT hello:

* [Вызов прямого метода на устройстве (предварительная версия)][lnk-methods]
* [Schedule jobs on multiple devices][lnk-jobs] (Планирование заданий на нескольких устройствах)

При желании tootry некоторые основные понятия hello, описанных в этой статье, могут быть интересны следующие учебники центра IoT hello параметры:

* [Как toouse hello двойных устройства][lnk-twin-tutorial]
* [Как свойства двойных toouse устройства][lnk-twin-properties]

<!-- links and images -->

[lnk-endpoints]: iot-hub-devguide-endpoints.md
[lnk-quotas]: iot-hub-devguide-quotas-throttling.md
[lnk-sdks]: iot-hub-devguide-sdks.md
[lnk-query]: iot-hub-devguide-query-language.md
[lnk-jobs]: iot-hub-devguide-jobs.md
[lnk-identity]: iot-hub-devguide-identity-registry.md
[lnk-d2c]: iot-hub-devguide-messages-d2c.md
[lnk-methods]: iot-hub-devguide-direct-methods.md
[lnk-security]: iot-hub-devguide-security.md
[lnk-c2d-guidance]: iot-hub-devguide-c2d-guidance.md
[lnk-d2c-guidance]: iot-hub-devguide-d2c-guidance.md

[ISO8601]: https://en.wikipedia.org/wiki/ISO_8601
[RFC7232]: https://tools.ietf.org/html/rfc7232
[lnk-devguide-mqtt]: iot-hub-mqtt-support.md

[lnk-devguide-directmethods]: iot-hub-devguide-direct-methods.md
[lnk-devguide-jobs]: iot-hub-devguide-jobs.md
[lnk-twin-tutorial]: iot-hub-node-node-twin-getstarted.md
[lnk-twin-properties]: iot-hub-node-node-twin-how-to-configure.md
[lnk-twin-metadata]: iot-hub-devguide-device-twins.md#device-twin-metadata
[lnk-concurrency]: iot-hub-devguide-device-twins.md#optimistic-concurrency
[lnk-reconnection]: iot-hub-devguide-device-twins.md#device-reconnection-flow

[img-twin]: media/iot-hub-devguide-device-twins/twin.png

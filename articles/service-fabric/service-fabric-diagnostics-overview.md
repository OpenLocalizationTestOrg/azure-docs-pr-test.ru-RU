---
title: "Обзор мониторинга и диагностики Azure Service Fabric | Документы Майкрософт"
description: "Сведения о функциях мониторинга и диагностики для кластеров, приложений и служб Azure Service Fabric."
services: service-fabric
documentationcenter: .net
author: dkkapur
manager: timlt
editor: 
ms.assetid: 
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 01/10/2018
ms.author: dekapur
ms.openlocfilehash: 43a45a31efffcd623e6381049876c3607663ec4f
ms.sourcegitcommit: c4cc4d76932b059f8c2657081577412e8f405478
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/11/2018
---
# <a name="monitoring-and-diagnostics-for-azure-service-fabric"></a>Мониторинг и диагностика для Azure Service Fabric

В этой статье предоставлены общие сведения о настройке мониторинга и диагностики для приложений, работающих в кластерах Service Fabric. Мониторинг и диагностика критически важны для разработки, тестирования и развертывания рабочих нагрузок в любой облачной среде. Мониторинг позволяет отслеживать показатели использования приложения, потребления ресурсов и общую работоспособность кластера. Эти сведения можно использовать для диагностики и устранения неполадок в кластере, а также для предотвращения возникновения проблем в будущем. 

Основные цели мониторинга и диагностики:
* обнаружение и диагностика проблем с инфраструктурой;
* обнаружение проблем с приложением;
* оценка потребления ресурсов;
* отслеживание производительности приложений, служб и инфраструктуры.

В кластере Service Fabric данные мониторинга и диагностики поступают из трех уровней: приложения, платформы (кластера) и инфраструктуры. 
* К [уровню приложения](service-fabric-diagnostics-event-generation-app.md) относятся данные о производительности приложений и другие данные, собираемые в пользовательских журналах. Данные мониторинга приложений должны поступать в Application Insights (AI) из самого приложения. Они могут поступать через пакет SDK AI, EventFlow или другой конвейер по вашему выбору.
* К [уровню платформы](service-fabric-diagnostics-event-generation-infra.md) относятся события из выполняемых на кластере действий, связанных с управлением кластером и запущенными на нем приложениями. Данные мониторинга платформы должны отправляться в OMS Log Analytics с помощью решения Service Fabric Analytics, чтобы помочь визуализировать входящие события. Эти данные обычно отправляются в учетную запись хранения через расширение системы диагностики Azure для Windows или Linux. В учетной записи к ним получает доступ OMS Log Analytics. 
* На уровне инфраструктуры основное внимание уделяется [мониторингу производительности](service-fabric-diagnostics-event-generation-perf.md), отслеживанию ключевых метрик и счетчиков производительности, чтобы определить показатели использования ресурсов и нагрузку. Мониторинг производительности может осуществляться с помощью агента. Рекомендуем использовать агент OMS (Microsoft Monitoring), чтобы данные о производительности поступали в то же место, что и события платформы. Это позволяет улучшить результаты диагностики при корреляции изменений по всему кластеру. 

![Схема обзора диагностики](media/service-fabric-diagnostics-overview/diagnostics-overview.png)

## <a name="monitoring-scenarios"></a>Сценарии мониторинга

В этом разделе рассматриваются ключевые сценарии мониторинга кластера Service Fabric — мониторинг приложения, кластера, производительности и работоспособности. Для каждого сценария приводится намерение и общий подход к мониторингу. Дополнительные сведения об этих и других общих рекомендациях по мониторингу ресурсов Azure см. в статье [Мониторинг и диагностика](https://docs.microsoft.com/azure/architecture/best-practices/monitoring). 

Эти сценарии также слабо сопоставляются с тремя уровнями данных мониторинга и диагностики, как указывалось выше. То есть для соответствующей обработки каждого сценария в кластере на соответствующем уровне должны поступать данные мониторинга и диагностики. Сценарий мониторинга работоспособности является исключением, так как охватывает кластер и все, что на нем выполняется.

## <a name="application-monitoring"></a>Мониторинг приложений
Мониторинг приложений отслеживает, как используются возможности и компоненты созданного приложения. Он позволяет перехватить проблемы, влияющие на пользователей. Мониторинг приложений может применяться при:
* определении нагрузки на приложение и пользовательского трафика: нужно ли масштабировать службы, чтобы удовлетворить требования пользователей или устранить потенциальные узкие места в приложении;
* выявлении проблем взаимодействия служб и удаленного взаимодействия в кластере;
* изучении действий пользователей с приложением: инструментирование приложений может помочь в разработке будущих компонентов и лучшей диагностике ошибок приложений.

Для мониторинга на уровне приложения в Service Fabric рекомендуется использовать Application Insights (AI). Для интеграции Application Insights с Service Fabric требуется знание средств Visual Studio и портала Azure, а также понимание контекста службы Service Fabric, удаленного взаимодействия на панели мониторинга AI и схемы приложений, благодаря чему вы сможете обеспечить комплексное ведение журналов. Хотя многие журналы автоматически создаются и собираются при использовании AI, мы советуем добавлять дополнительные настраиваемые журналы в свои приложения и отображать их в AI вместе с предоставленными компонентами, чтобы получать подробные результаты диагностики для устранения проблем в будущем. Дополнительные сведения об использовании AI с Service Fabric см. в статье [Анализ и визуализация событий с помощью Application Insights](service-fabric-diagnostics-event-analysis-appinsights.md). 

Чтобы приступить к инструментированию кода для мониторинга приложений, перейдите к [созданию событий и журналов на уровне приложений и служб](service-fabric-diagnostics-event-generation-app.md). 

### <a name="monitoring-application-availability"></a>Мониторинг доступности приложений
Возможно, что все в кластере работает должным образом и работоспособно, однако приложения недоступны или недостижимы. Хотя случаев, в которых это может произойти, немного, важно знать, каким образом как можно скорее устранить проблему. Мониторинг доступности в целом связан с отслеживанием доступности компонентов системы, чтобы понять общее "время доступности" системы. В кластере внимание сосредотачивается на доступности с точки зрения приложения. Платформа работает, чтобы гарантировать, что сценарии управления жизненным циклом приложения не вызывают простоев. Тем не менее различные проблемы, возникающие в кластере, могут повлиять на время работы приложения. О таких случаях вы, как владелец приложения, скорее всего, захотите узнать немедленно. Мы рекомендуем, чтобы наряду со всеми другими приложениями в кластере вы развернули модуль наблюдения. Цель модуля наблюдения — проверка соответствующих конечных точек приложения в заданном интервале времени и возвращение информации о том, что они доступны. Кроме того, это можно сделать с помощью внешней службы, которая выполняет проверку связи с конечной точкой и возвращает отчет с заданным интервалом времени.

## <a name="cluster-monitoring"></a>Мониторинг кластера
Мониторинг кластера Service Fabric — критически важен для обеспечения надлежащей работы платформы и запущенных на ней рабочих нагрузок. Одна из целей Service Fabric — это обеспечение работы приложения в случае сбоев оборудования. Это достигается благодаря способности системных служб платформы обнаруживать проблемы с инфраструктурой и быстро отрабатывать отказ рабочих нагрузок на другие узлы в кластере. Но в этом случае, что делать, если в самих системных службах есть проблемы? Или если при попытке перемещения рабочей нагрузки нарушаются правила размещения служб? Мониторинг кластера дает возможность получать сведения о действиях, происходящих в кластере, которые помогают диагностировать проблемы и эффективно их устранять. Некоторые ключевые аспекты, на которые следует обратить внимание:
* Работает ли Service Fabric как ожидается с точки зрения размещения приложений и балансировки нагрузки в кластере? 
* Предпринимаются ли какие-либо действия для изменения конфигурации кластера, которая была подтверждена и действовала так, как ожидалось? Это особенно важно при масштабировании кластера.
* Правильно ли Service Fabric обрабатывает данные и связь между службами в кластере?

Через каналы операции и канал данных и обмена сообщениями Service Fabric предоставляет готовый комплексный набор событий. В Windows они представлены в виде единого поставщика трассировки событий Windows с набором соответствующих фильтров `logLevelKeywordFilters`, используемых для выбора между различными каналами. В Linux все события платформы проходят через LTTng и помещаются в одну таблицу, в которой они могут быть отфильтрованы нужным образом. 

Эти каналы содержат проверенные структурированные события, которые помогают лучше понять состояние вашего кластера. "Диагностика" включается по умолчанию в момент создания кластера. При этом настраивается таблица службы хранилища Azure, в которую отправляются события из этих каналов для запроса в будущем. Дополнительные сведения о мониторинге кластеров см. в статье [Создание событий и журналов на уровне платформы](service-fabric-diagnostics-event-generation-infra.md). Для мониторинга кластера рекомендуется использовать OMS Log Analytics. OMS Log Analytics предлагает специализированное решение Service Fabric Analytics, которое предоставляет настраиваемую панель мониторинга для мониторинга кластеров Service Fabric и позволяет запрашивать события вашего кластера и настраивать оповещения. Дополнительные сведения см. в статье об [анализе событий в OMS](service-fabric-diagnostics-event-analysis-oms.md). 

### <a name="watchdogs"></a>Модули наблюдения
Как правило, модуль наблюдения является отдельной службой, которая может отслеживать работоспособность и нагрузку в службах, проверять связь с конечными точками и сообщать о работоспособности любого элемента в кластере. Он позволяет предотвратить ошибки, которые невозможно обнаружить в контексте отдельной службы. Модули наблюдения также удобны для размещения кода, выполняющего корректирующие действия без участия пользователя (например, очистку файлов журнала в хранилище через определенные интервалы времени). Пример реализации службы наблюдения см. [здесь](https://github.com/Azure-Samples/service-fabric-watchdog-service).

## <a name="performance-monitoring"></a>Мониторинг производительности
Мониторинг базовой инфраструктуры является ключевым в понимании состояния кластера и использовании ресурсов. Измерение производительности системы зависит от нескольких факторов, каждый из которых обычно определяется с помощью ключевых показателей эффективности. Соответствующие ключевые показатели эффективности Service Fabric можно сопоставить с метриками, которые могут собираться из узлов кластера в качестве счетчиков производительности.
Ключевые индикаторы производительности позволяют:
* получить общие сведения об использовании ресурсов и нагрузке с целью масштабирования кластера или оптимизации процессов службы;
* прогнозировать проблемы с инфраструктурой: возникновению многих проблем предшествуют внезапные изменения (снижения) производительности, поэтому для прогнозирования и диагностики таких проблем можно использовать ключевые показатели эффективности, такие как сетевые операции ввода-вывода и использование ЦП.

Список счетчиков производительности, которые необходимо собрать на уровне инфраструктуры, можно найти в статье [Метрики производительности](service-fabric-diagnostics-event-generation-perf.md). 

Для мониторинга производительности на уровне приложения Service Fabric предоставляет набор счетчиков производительности для моделей программирования Reliable Services и Reliable Actors. Если используется какая-либо из этих моделей, эти счетчики производительности могут предоставлять ключевые показатели эффективности, которые позволяют гарантировать, что субъекты развертываются и свертываются правильно или что запросы к надежным службам обрабатываются достаточно быстро. Дополнительные сведения см. в разделе [Счетчики производительности](service-fabric-reliable-serviceremoting-diagnostics.md#performance-counters) статьи "Диагностика и мониторинг производительности в модели Reliable Service Remoting" и разделе [Счетчики производительности](service-fabric-reliable-actors-diagnostics.md#performance-counters) статьи "Диагностика и мониторинг производительности в Reliable Actors". В дополнение к этому служба Application Insights также имеет набор метрик производительности, которые она будет собирать, если она настроена для приложения.

Агент OMS позволяет собирать соответствующие счетчики производительности и просматривать ключевые показатели эффективности в OMS Log Analytics. Для сбора и хранения метрик для анализа также можно использовать расширение агента системы диагностики Azure или другого аналогичного агента. 

## <a name="health-monitoring"></a>Мониторинг работоспособности
Платформа Service Fabric включает модель работоспособности, которая обеспечивает расширяемую отчетность о состоянии работоспособности сущностей в кластере. Каждый узел, приложение, служба, секция, реплика или экземпляр имеют постоянно обновляемое состояние работоспособности, которое может иметь значение "ОК", "Предупреждение" или "Ошибка". Состояние работоспособности меняется в отчетах о работоспособности, которые создаются для каждой сущности в зависимости от проблем в кластере. Состояние работоспособности сущностей можно проверить в любое время в Service Fabric Explorer (SFX), как показано ниже, или запросить через API работоспособности платформы. Кроме того, можно настроить отчеты о работоспособности и изменить состояние работоспособности сущности, добавляя собственные отчеты о работоспособности или используя API работоспособности. Дополнительные сведения о модели работоспособности см. в статье [Общие сведения о наблюдении за работоспособностью системы в Service Fabric](service-fabric-health-introduction.md).

![Панель мониторинга работоспособности SFX](media/service-fabric-diagnostics-overview/sfx-healthstatus.png)

Помимо отображения последних отчетов о состоянии работоспособности в SFX, каждый отчет также доступен как событие. События работоспособности можно собрать через операционный канал (см. сведения в разделе [Сбор событий работоспособности и нагрузки](service-fabric-diagnostics-event-aggregation-wad.md#collect-health-and-load-events)) и хранить в OMS Log Analytics для оповещений и запросов в будущем. Это помогает выявить проблемы, которые могут повлиять на доступность приложения, поэтому рекомендуем настроить оповещения для соответствующих сценариев сбоев (настраиваемые оповещения через OMS).

## <a name="monitoring-workflow"></a>Рабочий процесс мониторинга 

Общий рабочий процесс мониторинга и диагностики состоит из трех этапов.

1. **Создание событий**. Сюда входят события (журналы, трассировки, пользовательские события) на уровне инфраструктуры, платформы (кластер) и приложения.
2. **Агрегация событий**. Этот этап фактически является конвейером для передачи событий в средство, где их можно анализировать, например расширение Azure Diagnostics или EventFlow.
3. **Анализ**. События должны быть доступны в средстве, чтобы обеспечить анализ — визуализацию, запросы, оповещения и т. д.

Доступны разные продукты с поддержкой этих трех областей, и вы можете использовать разные инструменты для реализации каждого из этапов. Очень важно убедиться в эффективной совместной работе этих компонентов, обеспечивающей комплексное решение мониторинга для кластера.

## <a name="event-generation"></a>Создание событий

Первый этап в рабочем процессе мониторинга и диагностики — настройка создания и формирования данных событий и журналов. Эти события, журналы и счетчики производительности создаются на всех трех уровнях: уровне приложения (все инструментирование, добавляемое в приложение и службы, развернутые в кластере), платформы (события, создаваемые на основе операций в кластере Service Fabric) и инфраструктуры (метрики производительности каждого узла). Данные диагностики, собираемые на каждом из этих уровней, можно настраивать, хотя Service Fabric позволяет использовать некоторое инструментирование по умолчанию. 

Ознакомьтесь с дополнительными сведениями о [событиях уровня платформы](service-fabric-diagnostics-event-generation-infra.md) и [событиях уровня приложений](service-fabric-diagnostics-event-generation-app.md), чтобы понять, какое инструментирование предоставляется по умолчанию, а какое можно добавить дополнительно. Основное решение, которое нужно принять на этом этапе, — это метод инструментирования приложения. Для приложений .NET рекомендуется использовать ILogger, однако можно также изучить EventSource, Serilog и другие аналогичные библиотеки. Для Java рекомендуется использовать Log4j. Кроме них имеется несколько других вариантов, которые можно использовать в зависимости от характера приложения. Определите самый подходящий вариант для конкретного варианта использования или выберите тот, который наиболее удобно использовать. 

После принятия решения о поставщике ведения журнала необходимо убедиться в правильном агрегировании и хранении журналов.

## <a name="event-aggregation"></a>Агрегация событий

Для сбора журналов и событий, создаваемых приложениями и кластером, обычно рекомендуется использовать [расширение службы диагностики Azure](service-fabric-diagnostics-event-aggregation-wad.md) (аналогично сбору журналов на основе агентов) или [EventFlow](service-fabric-diagnostics-event-aggregation-eventflow.md) (внутрипроцессный сбор журналов). Если вы используете Application Insights и разрабатываете в .NET или Java, рекомендуется использовать пакет SDK Application Insights вместо EventFlow.

Хотя аналогичное задание можно выполнить, используя только один из этих вариантов, в большинстве случаев объединение агента расширения системы диагностики Azure с конвейером сбора в процессе (пакет SDK AI или EventFlow) позволяет более надежно и комплексно выполнять рабочий процесс мониторинга. Расширение системы диагностики Azure (агент) можно использовать для событий уровня платформы, тогда как пакет SDK AI или EventFlow (внутрипроцессный сбор) — для журналов уровня приложений. 

В случаях, когда необходимо использовать только один из них, ниже приведены некоторые ключевые моменты, которые следует учитывать.
* Сбор журналов приложений с помощью расширения системы диагностики Azure можно рекомендовать для служб Service Fabric, если набор источников и мест назначения журналов невелик и редко меняется, а источники и места назначения легко сопоставимы. Это связано с тем, что настройка системы диагностики Azure происходит на уровне Resource Manager, поэтому для внесения существенных изменений в конфигурацию требуется обновление всего кластера. Это означает, что это часто менее эффективно, чем работа с пакетом SDK AI или EventFlow.
* Использование EventFlow позволяет службам отправлять свои журналы непосредственно в платформу анализа и визуализации и (или) в хранилище. Для этой цели можно использовать и другие библиотеки (ILogger, Serilog и т. д.), однако EventFlow имеет преимущество, так как она была разработана специально для внутрипроцессного сбора журналов и поддержки служб Service Fabric. Это имеет несколько преимуществ с точки зрения простоты настройки и развертывания, а также обеспечивает большую гибкость при поддержке различных библиотек ведения журнала и средств анализа. 

## <a name="event-analysis"></a>Анализ событий

На рынке представлено несколько отличных платформ анализа и визуализации данных мониторинга и диагностики. Мы рекомендуем использовать [OMS](service-fabric-diagnostics-event-analysis-oms.md) и [Application Insights](service-fabric-diagnostics-event-analysis-appinsights.md), так как эти инструменты интегрируются с Service Fabric. Стоит также рассмотреть [эластичный пул](https://www.elastic.co/products) (особенно если кластер будет выполняться в автономной среде), [Splunk](https://www.splunk.com/) или любую другую платформу по вашему выбору. 

Основные моменты, на которые следует обратить внимание: удобство пользовательского интерфейса и составления запросов, возможность визуализации данных и создания удобных панелей мониторинга, а также наличие дополнительных средств для повышения эффективности мониторинга, таких как автоматическая генерация оповещений.

В дополнение к выбранной платформе при настройке кластера Service Fabric как ресурса Azure вы также получаете доступ к готовым функциям мониторинга производительности Azure для виртуальных машин.

### <a name="azure-monitor"></a>Azure Monitor

[Мониторинг Azure](../monitoring-and-diagnostics/monitoring-overview.md) дает возможность отслеживать многие ресурсы Azure, из которых состоит кластер Service Fabric. Данные по набору метрик для [масштабируемого набора виртуальных машин](../monitoring-and-diagnostics/monitoring-supported-metrics.md#microsoftcomputevirtualmachinescalesets) и отдельных [виртуальных машин](../monitoring-and-diagnostics/monitoring-supported-metrics.md#microsoftcomputevirtualmachinescalesetsvirtualmachines) автоматически собираются и отображаются на портале Azure. Чтобы просмотреть собранные сведения, выберите на портале Azure группу ресурсов, содержащую кластер Service Fabric. Затем выберите нужный масштабируемый набор виртуальных машин. В разделе **Мониторинг** (в левой области навигации) выберите **Метрики**, чтобы увидеть график значений.

![Представление собранных данных метрик на портале Azure](media/service-fabric-diagnostics-overview/azure-monitoring-metrics.png)

Настройка параметров диаграммы описана в статье [Обзор метрик в Microsoft Azure](../monitoring-and-diagnostics/insights-how-to-customize-monitoring.md). Кроме того, на основе этих метрик можно создавать оповещения, как описано в статье [Создание оповещений в Azure Monitor для служб Azure с помощью портала Azure](../monitoring-and-diagnostics/monitoring-overview-alerts.md). 

## <a name="next-steps"></a>Дополнительная информация

* Дополнительные сведения о мониторинге платформы и событиях, предоставляемых Service Fabric, см. в статье [Создание событий и журналов на уровне платформы](service-fabric-diagnostics-event-generation-infra.md).
* Сведения о начале работы с инструментированием приложений см. в статье [Создание событий и журналов на уровне приложений и служб](service-fabric-diagnostics-event-generation-app.md).
* Ознакомьтесь с руководством [Мониторинг и диагностика приложения ASP.NET Core в Service Fabric](service-fabric-tutorial-monitoring-aspnet.md).


---
title: "Использование Elasticsearch в качестве хранилища данных трассировки приложения Service Fabric | Документация Майкрософт"
description: "В этой статье описывается, как приложения Service Fabric используют ElasticSearch и Kibana для хранения, индексирования и поиска данных с помощью трассировки (журналов)."
services: service-fabric
documentationcenter: .net
author: karolz-ms
manager: adegeo
editor: 
ms.assetid: e59b0c39-e468-4d9e-b453-d5f2a8ad20d8
ms.service: service-fabric
ms.devlang: dotNet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 04/07/2017
ms.author: karolz@microsoft.com
redirect_url: /azure/service-fabric/service-fabric-diagnostics-event-aggregation-eventflow
ms.openlocfilehash: 2d2ceceea131b41ad1a1735aaa2a859d035ab098
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="use-elasticsearch-as-a-service-fabric-application-trace-store"></a><span data-ttu-id="ff21e-103">Использование ElasticSearch в качестве хранилища данных трассировки приложения Service Fabric</span><span class="sxs-lookup"><span data-stu-id="ff21e-103">Use Elasticsearch as a Service Fabric application trace store</span></span>
## <a name="introduction"></a><span data-ttu-id="ff21e-104">Введение</span><span class="sxs-lookup"><span data-stu-id="ff21e-104">Introduction</span></span>
<span data-ttu-id="ff21e-105">В этой статье описывается, как приложения [Azure Service Fabric](https://azure.microsoft.com/documentation/services/service-fabric/) используют **ElasticSearch** и **Kibana** для хранения данных трассировки приложений, индексирования и поиска.</span><span class="sxs-lookup"><span data-stu-id="ff21e-105">This article describes how [Azure Service Fabric](https://azure.microsoft.com/documentation/services/service-fabric/) applications can use **Elasticsearch** and **Kibana** for application trace storage, indexing, and search.</span></span> <span data-ttu-id="ff21e-106">[ElasticSearch](https://www.elastic.co/guide/index.html) — это распределенная и масштабируемая система с открытым кодом, предназначенная для поиска и анализа данных в режиме реального времени. Она хорошо подходит для описанной здесь задачи.</span><span class="sxs-lookup"><span data-stu-id="ff21e-106">[Elasticsearch](https://www.elastic.co/guide/index.html) is an open-source, distributed, and scalable real-time search and analytics engine that is well-suited for this task.</span></span> <span data-ttu-id="ff21e-107">Ее можно установить на виртуальные машины Windows или Linux, запущенные в Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="ff21e-107">It can be installed on Windows and Linux virtual machines running in Microsoft Azure.</span></span> <span data-ttu-id="ff21e-108">ElasticSearch может эффективно обрабатывать *структурированные* трассировки, созданные с помощью таких технологий, как **трассировка событий Windows (ETW)**.</span><span class="sxs-lookup"><span data-stu-id="ff21e-108">Elasticsearch can efficiently process *structured* traces produced using technologies such as **Event Tracing for Windows (ETW)**.</span></span>

<span data-ttu-id="ff21e-109">Трассировка событий Windows используется средой выполнения Service Fabric в качестве источника диагностических сведений (трассировки).</span><span class="sxs-lookup"><span data-stu-id="ff21e-109">ETW is used by Service Fabric runtime to source diagnostic information (traces).</span></span> <span data-ttu-id="ff21e-110">Этот способ сбора диагностических сведений также рекомендуется и для приложений Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="ff21e-110">It is the recommended method for Service Fabric applications to source their diagnostic information, too.</span></span> <span data-ttu-id="ff21e-111">Точно такой же механизм позволяет коррелировать трассировки в среде выполнения и в приложении, а также облегчает устранение неполадок.</span><span class="sxs-lookup"><span data-stu-id="ff21e-111">Using the same mechanism allows for correlation between runtime-supplied and application-supplied traces and makes troubleshooting easier.</span></span> <span data-ttu-id="ff21e-112">Шаблоны проектов Service Fabric в Visual Studio включают в себя API ведения журнала (в зависимости от класса **EventSource** .NET), который выдает трассировки ETW по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="ff21e-112">Service Fabric project templates in Visual Studio include a logging API (based on the .NET **EventSource** class) that emits ETW traces by default.</span></span> <span data-ttu-id="ff21e-113">Общие сведения о трассировке приложений Service Fabric с помощью ETW см. в разделе [Мониторинг и диагностика состояния служб в локальной среде разработки](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md).</span><span class="sxs-lookup"><span data-stu-id="ff21e-113">For a general overview of Service Fabric application tracing using ETW, see [Monitoring and diagnosing services in a local machine development setup](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md).</span></span>

<span data-ttu-id="ff21e-114">Чтобы данные трассировки отображались в ElasticSearch, их необходимо собирать на узлах кластера Service Fabric в реальном времени (во время работы приложения) и затем отправлять в конечную точку ElasticSearch.</span><span class="sxs-lookup"><span data-stu-id="ff21e-114">For the traces to show up in Elasticsearch, they need to be captured at the Service Fabric cluster nodes in real time (while the application is running) and sent to an Elasticsearch endpoint.</span></span> <span data-ttu-id="ff21e-115">Есть два основных способа записи данных трассировки.</span><span class="sxs-lookup"><span data-stu-id="ff21e-115">There are two major options for trace capturing:</span></span>

* <span data-ttu-id="ff21e-116">**Внутрипроцессная запись данных трассировки.**</span><span class="sxs-lookup"><span data-stu-id="ff21e-116">**In-process trace capturing**</span></span>  
  <span data-ttu-id="ff21e-117">Приложение или, точнее, процесс службы, отвечает за отправку диагностических данных в хранилище данных трассировки (ElasticSearch).</span><span class="sxs-lookup"><span data-stu-id="ff21e-117">The application, or more precisely, service process, is responsible for sending out the diagnostic data to the trace store (Elasticsearch).</span></span>
* <span data-ttu-id="ff21e-118">**Внепроцессная запись данных трассировки.**</span><span class="sxs-lookup"><span data-stu-id="ff21e-118">**Out-of-process trace capturing**</span></span>  
  <span data-ttu-id="ff21e-119">Отдельный агент записывает данные трассировки из процессов службы и отправляет их в хранилище данных трассировки.</span><span class="sxs-lookup"><span data-stu-id="ff21e-119">A separate agent is capturing traces from the service process or processes and sending them to the trace store.</span></span>

<span data-ttu-id="ff21e-120">Ниже мы опишем способ настройки ElasticSearch в Azure, обсудим преимущества и недостатки записи данных двумя указанными выше способами, а также объясним, как настроить службу Service Fabric для отправки данных в ElasticSearch.</span><span class="sxs-lookup"><span data-stu-id="ff21e-120">Below, we describe how to set up Elasticsearch on Azure, discuss the pros and cons for both capture options, and explain how to configure a Service Fabric service to send data to Elasticsearch.</span></span>

## <a name="set-up-elasticsearch-on-azure"></a><span data-ttu-id="ff21e-121">Настройка ElasticSearch в Azure</span><span class="sxs-lookup"><span data-stu-id="ff21e-121">Set up Elasticsearch on Azure</span></span>
<span data-ttu-id="ff21e-122">Самый простой способ настройки службы ElasticSearch в Azure — с помощью [**шаблонов Azure Resource Manager**](../azure-resource-manager/resource-group-overview.md).</span><span class="sxs-lookup"><span data-stu-id="ff21e-122">The most straightforward way to set up the Elasticsearch service on Azure is through [**Azure Resource Manager templates**](../azure-resource-manager/resource-group-overview.md).</span></span> <span data-ttu-id="ff21e-123">Полнофункциональный [шаблон быстрого запуска диспетчера ресурсов Azure для ElasticSearch](https://github.com/Azure/azure-quickstart-templates/tree/master/elasticsearch) можно получить из репозитория шаблонов быстрого запуска Azure.</span><span class="sxs-lookup"><span data-stu-id="ff21e-123">A comprehensive [Quickstart Azure Resource Manager template for Elasticsearch](https://github.com/Azure/azure-quickstart-templates/tree/master/elasticsearch) is available from Azure Quickstart templates repository.</span></span> <span data-ttu-id="ff21e-124">В этом шаблоне используются отдельные учетные записи хранения для единиц масштабирования (групп узлов).</span><span class="sxs-lookup"><span data-stu-id="ff21e-124">This template uses separate storage accounts for scale units (groups of nodes).</span></span> <span data-ttu-id="ff21e-125">Он также может подготовить отдельные узлы клиента и сервера с различными конфигурациями и различным количеством подключенных дисков данных.</span><span class="sxs-lookup"><span data-stu-id="ff21e-125">It can also provision separate client and server nodes with different configurations and various numbers of data disks attached.</span></span>

<span data-ttu-id="ff21e-126">Здесь мы используем другой шаблон — **ES-MultiNode** из [репозитория инструментов диагностики Azure](https://github.com/Azure/azure-diagnostics-tools).</span><span class="sxs-lookup"><span data-stu-id="ff21e-126">Here, we use another template, called **ES-MultiNode** from the [Azure diagnostic tools repository](https://github.com/Azure/azure-diagnostics-tools).</span></span> <span data-ttu-id="ff21e-127">Этот шаблон проще в использовании. Он создает кластер ElasticSearch, защищенный обычной проверкой подлинности HTTP.</span><span class="sxs-lookup"><span data-stu-id="ff21e-127">This template is easier to use, and it creates an Elasticsearch cluster protected by HTTP basic authentication.</span></span> <span data-ttu-id="ff21e-128">Прежде чем продолжить, скачайте репозиторий с сайта GitHub на свой компьютер (с помощью клонирования репозитория или скачав ZIP-файл).</span><span class="sxs-lookup"><span data-stu-id="ff21e-128">Before you proceed, download the repository from GitHub to your machine (by either cloning the repository or downloading a zip file).</span></span> <span data-ttu-id="ff21e-129">Шаблон ES-MultiNode находится в одноименной папке.</span><span class="sxs-lookup"><span data-stu-id="ff21e-129">The ES-MultiNode template is located in the folder with the same name.</span></span>

### <a name="prepare-a-machine-to-run-elasticsearch-installation-scripts"></a><span data-ttu-id="ff21e-130">Подготовка компьютера к выполнению скриптов установки ElasticSearch</span><span class="sxs-lookup"><span data-stu-id="ff21e-130">Prepare a machine to run Elasticsearch installation scripts</span></span>
<span data-ttu-id="ff21e-131">Самый простой способ использования шаблона ES-MultiNode — с помощью готового скрипта Azure PowerShell с именем `CreateElasticSearchCluster`.</span><span class="sxs-lookup"><span data-stu-id="ff21e-131">The easiest way to use the ES-MultiNode template is through a provided Azure PowerShell script called `CreateElasticSearchCluster`.</span></span> <span data-ttu-id="ff21e-132">Чтобы использовать этот скрипт, нужно установить модули PowerShell и средство **openssl**.</span><span class="sxs-lookup"><span data-stu-id="ff21e-132">To use this script, you need to install PowerShell modules and a tool called **openssl**.</span></span> <span data-ttu-id="ff21e-133">Это средство необходимо для создания SSH-ключа, который может использоваться для удаленного администрирования кластера ElasticSearch.</span><span class="sxs-lookup"><span data-stu-id="ff21e-133">The latter is needed for creating an SSH key that can be used to administer your Elasticsearch cluster remotely.</span></span>

<span data-ttu-id="ff21e-134">`CreateElasticSearchCluster` предназначен для удобства использования шаблона ES-MultiNode на компьютере с Windows.</span><span class="sxs-lookup"><span data-stu-id="ff21e-134">`CreateElasticSearchCluster` script is designed for ease of use with the ES-MultiNode template from a Windows machine.</span></span> <span data-ttu-id="ff21e-135">Шаблон можно использовать на компьютерах под управлением других ОС (не Windows), но в этой статье подобные случаи не рассматриваются.</span><span class="sxs-lookup"><span data-stu-id="ff21e-135">It is possible to use the template on a non-Windows machine, but that scenario is beyond the scope of this article.</span></span>

1. <span data-ttu-id="ff21e-136">Установите [**модули Azure PowerShell**](http://aka.ms/webpi-azps) (если они еще не установлены).</span><span class="sxs-lookup"><span data-stu-id="ff21e-136">If you haven't installed them already, install [**Azure PowerShell modules**](http://aka.ms/webpi-azps).</span></span> <span data-ttu-id="ff21e-137">При появлении запроса щелкните **Запуск**, а затем — **Установить**.</span><span class="sxs-lookup"><span data-stu-id="ff21e-137">When prompted, click **Run**, then **Install**.</span></span> <span data-ttu-id="ff21e-138">Требуется Azure PowerShell 1.3 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="ff21e-138">Azure PowerShell 1.3 or newer is required.</span></span>
2. <span data-ttu-id="ff21e-139">Инструмент **openssl** входит в дистрибутив [**Git для Windows**](http://www.git-scm.com/downloads).</span><span class="sxs-lookup"><span data-stu-id="ff21e-139">The **openssl** tool is included in the distribution of [**Git for Windows**](http://www.git-scm.com/downloads).</span></span> <span data-ttu-id="ff21e-140">Установите [Git для Windows](http://www.git-scm.com/downloads) , если вы этого еще не сделали.</span><span class="sxs-lookup"><span data-stu-id="ff21e-140">If you have not done so already, install [Git for Windows](http://www.git-scm.com/downloads) now.</span></span> <span data-ttu-id="ff21e-141">(Параметры установки по умолчанию изменять не нужно.)</span><span class="sxs-lookup"><span data-stu-id="ff21e-141">(The default installation options are OK.)</span></span>
3. <span data-ttu-id="ff21e-142">Далее предполагается, что компонент Git установлен, но не включен в системный путь. Откройте окно Microsoft Azure PowerShell и выполните следующие команды:</span><span class="sxs-lookup"><span data-stu-id="ff21e-142">Assuming that Git has been installed but not included in the system path, open a Microsoft Azure PowerShell window and run the following commands:</span></span>
   
    ```powershell
    $ENV:PATH += ";<Git installation folder>\usr\bin"
    $ENV:OPENSSL_CONF = "<Git installation folder>\usr\ssl\openssl.cnf"
    ```
   
    <span data-ttu-id="ff21e-143">Замените `<Git installation folder>` расположением Git на компьютере (по умолчанию это **C:\Program Files\Git**).</span><span class="sxs-lookup"><span data-stu-id="ff21e-143">Replace the `<Git installation folder>` with the Git location on your machine; the default is **"C:\Program Files\Git"**.</span></span> <span data-ttu-id="ff21e-144">Обратите внимание на точку с запятой в начале первого пути.</span><span class="sxs-lookup"><span data-stu-id="ff21e-144">Note the semicolon character at the beginning of the first path.</span></span>
4. <span data-ttu-id="ff21e-145">Обязательно войдите в Azure (с помощью командлета [`Add-AzureRmAccount`](https://msdn.microsoft.com/library/mt619267.aspx) ) и выберите подписку, которую необходимо использовать для создания кластера Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="ff21e-145">Ensure that you are logged on to Azure (via [`Add-AzureRmAccount`](https://msdn.microsoft.com/library/mt619267.aspx) cmdlet) and that you have selected the subscription that should be used to create your Elastic Search cluster.</span></span> <span data-ttu-id="ff21e-146">Проверить, правильно ли выбрана подписка, можно с помощью командлетов `Get-AzureRmContext` и `Get-AzureRmSubscription`.</span><span class="sxs-lookup"><span data-stu-id="ff21e-146">You can verify that correct subscription is selected using `Get-AzureRmContext` and `Get-AzureRmSubscription` cmdlets.</span></span>
5. <span data-ttu-id="ff21e-147">Измените текущий каталог на папку ES-MultiNode (если это еще не сделано).</span><span class="sxs-lookup"><span data-stu-id="ff21e-147">If you haven't done so already, change the current directory to the ES-MultiNode folder.</span></span>

### <a name="run-the-createelasticsearchcluster-script"></a><span data-ttu-id="ff21e-148">Запуск скрипта CreateElasticSearchCluster</span><span class="sxs-lookup"><span data-stu-id="ff21e-148">Run the CreateElasticSearchCluster script</span></span>
<span data-ttu-id="ff21e-149">Прежде чем выполнять скрипт, откройте файл `azuredeploy-parameters.json` и проверьте значения параметров скрипта или введите их.</span><span class="sxs-lookup"><span data-stu-id="ff21e-149">Before you run the script, open the `azuredeploy-parameters.json` file and verify or provide values for the script parameters.</span></span> <span data-ttu-id="ff21e-150">Необходимо указать следующие параметры:</span><span class="sxs-lookup"><span data-stu-id="ff21e-150">The following parameters are provided:</span></span>

| <span data-ttu-id="ff21e-151">Имя параметра</span><span class="sxs-lookup"><span data-stu-id="ff21e-151">Parameter Name</span></span> | <span data-ttu-id="ff21e-152">Описание</span><span class="sxs-lookup"><span data-stu-id="ff21e-152">Description</span></span> |
| --- | --- |
| <span data-ttu-id="ff21e-153">dnsNameForLoadBalancerIP</span><span class="sxs-lookup"><span data-stu-id="ff21e-153">dnsNameForLoadBalancerIP</span></span> |<span data-ttu-id="ff21e-154">Это имя будет использоваться для создания общедоступного DNS-имени кластера Elastic Search (посредством добавления домена региона Azure к указанному имени).</span><span class="sxs-lookup"><span data-stu-id="ff21e-154">The name that is used to create the publicly visible DNS name for the Elastic Search cluster (by appending the Azure region domain to the provided name).</span></span> <span data-ttu-id="ff21e-155">Например, если этот параметр имеет значение myBigCluster и выбран регион Azure "Запад США", то DNS-имя кластера будет выглядеть так: myBigCluster.westus.cloudapp.azure.com.</span><span class="sxs-lookup"><span data-stu-id="ff21e-155">For example, if this parameter value is "myBigCluster" and the chosen Azure region is West US, the resulting DNS name for the cluster is myBigCluster.westus.cloudapp.azure.com.</span></span> <br /><br /><span data-ttu-id="ff21e-156">Это имя также будет использоваться в качестве корневого для имен многих артефактов, связанных с кластером Elastic Search, например имен узлов данных.</span><span class="sxs-lookup"><span data-stu-id="ff21e-156">This name also serves as a root name for many artifacts associated with the Elastic Search cluster, such as data node names.</span></span> |
| <span data-ttu-id="ff21e-157">adminUsername</span><span class="sxs-lookup"><span data-stu-id="ff21e-157">adminUsername</span></span> |<span data-ttu-id="ff21e-158">Имя учетной записи администратора для управления кластером Elastic Search (соответствующие ключи SSH будут сформированы автоматически).</span><span class="sxs-lookup"><span data-stu-id="ff21e-158">The name of the administrator account for managing the Elastic Search cluster (corresponding SSH keys are generated automatically).</span></span> |
| <span data-ttu-id="ff21e-159">dataNodeCount</span><span class="sxs-lookup"><span data-stu-id="ff21e-159">dataNodeCount</span></span> |<span data-ttu-id="ff21e-160">Количество узлов в кластере Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="ff21e-160">The number of nodes in the Elastic Search cluster.</span></span> <span data-ttu-id="ff21e-161">Текущая версия сценария не различает узлы данных и запросов. Все узлы будут выполнять обе роли.</span><span class="sxs-lookup"><span data-stu-id="ff21e-161">The current version of the script does not distinguish between data and query nodes; all nodes play both roles.</span></span> <span data-ttu-id="ff21e-162">Значение по умолчанию — 3.</span><span class="sxs-lookup"><span data-stu-id="ff21e-162">Defaults to 3 nodes.</span></span> |
| <span data-ttu-id="ff21e-163">dataDiskSize</span><span class="sxs-lookup"><span data-stu-id="ff21e-163">dataDiskSize</span></span> |<span data-ttu-id="ff21e-164">Размер дисков данных (в ГБ), выделяемый для каждого узла данных.</span><span class="sxs-lookup"><span data-stu-id="ff21e-164">The size of data disks (in GB) that is allocated for each data node.</span></span> <span data-ttu-id="ff21e-165">Каждый узел получит по 4 диска данных, предназначенных исключительно для службы Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="ff21e-165">Each node receives 4 data disks, exclusively dedicated to Elastic Search service.</span></span> |
| <span data-ttu-id="ff21e-166">region</span><span class="sxs-lookup"><span data-stu-id="ff21e-166">region</span></span> |<span data-ttu-id="ff21e-167">Имя региона Azure, в котором будет размещаться кластер Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="ff21e-167">The name of Azure region where the Elastic Search cluster should be located.</span></span> |
| <span data-ttu-id="ff21e-168">esUserName</span><span class="sxs-lookup"><span data-stu-id="ff21e-168">esUserName</span></span> |<span data-ttu-id="ff21e-169">Имя пользователя, для которого будет настроен доступ к кластеру ES (с помощью обычной проверки подлинности HTTP).</span><span class="sxs-lookup"><span data-stu-id="ff21e-169">The user name of the user that is configured to have access to ES cluster (subject to HTTP basic authentication).</span></span> <span data-ttu-id="ff21e-170">Пароль не хранится в файле параметров и указывается при вызове скрипта `CreateElasticSearchCluster` .</span><span class="sxs-lookup"><span data-stu-id="ff21e-170">The password is not part of parameters file and must be provided when `CreateElasticSearchCluster` script is invoked.</span></span> |
| <span data-ttu-id="ff21e-171">vmSizeDataNodes</span><span class="sxs-lookup"><span data-stu-id="ff21e-171">vmSizeDataNodes</span></span> |<span data-ttu-id="ff21e-172">Размер виртуальной машины Azure для узлов кластера Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="ff21e-172">The Azure virtual machine size for Elastic Search cluster nodes.</span></span> <span data-ttu-id="ff21e-173">Значение по умолчанию — Standard_D2.</span><span class="sxs-lookup"><span data-stu-id="ff21e-173">Defaults to Standard_D2.</span></span> |

<span data-ttu-id="ff21e-174">Теперь все готово к запуску скрипта.</span><span class="sxs-lookup"><span data-stu-id="ff21e-174">Now you are ready to run the script.</span></span> <span data-ttu-id="ff21e-175">Введите следующую команду:</span><span class="sxs-lookup"><span data-stu-id="ff21e-175">Issue the following command:</span></span>

```powershell
CreateElasticSearchCluster -ResourceGroupName <es-group-name> -Region <azure-region> -EsPassword <es-password>
```

<span data-ttu-id="ff21e-176">где:</span><span class="sxs-lookup"><span data-stu-id="ff21e-176">where</span></span> 

| <span data-ttu-id="ff21e-177">Имя параметра скрипта</span><span class="sxs-lookup"><span data-stu-id="ff21e-177">Script Parameter Name</span></span> | <span data-ttu-id="ff21e-178">Описание</span><span class="sxs-lookup"><span data-stu-id="ff21e-178">Description</span></span> |
| --- | --- |
| `<es-group-name>` |<span data-ttu-id="ff21e-179">Имя группы ресурсов Azure, в которую будут входить все ресурсы кластера Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="ff21e-179">The name of the Azure resource group that will contain all Elastic Search cluster resources.</span></span> |
| `<azure-region>` |<span data-ttu-id="ff21e-180">Имя региона Azure, в котором будет размещаться кластер Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="ff21e-180">The name of the Azure region where the Elastic Search cluster should be created.</span></span> |
| `<es-password>` |<span data-ttu-id="ff21e-181">Пароль для пользователя Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="ff21e-181">The password for the Elastic Search user.</span></span> |

> [!NOTE]
> <span data-ttu-id="ff21e-182">Если при запуске командлета Test-AzureResourceGroup отображается исключение NullReferenceException, значит, вы не выполнили вход в Azure (`Add-AzureRmAccount`).</span><span class="sxs-lookup"><span data-stu-id="ff21e-182">If you get a NullReferenceException from the Test-AzureResourceGroup cmdlet, you have forgotten to log on to Azure (`Add-AzureRmAccount`).</span></span>
> 
> 

<span data-ttu-id="ff21e-183">Если возникла ошибка выполнения скрипта и вы определили, что она вызвана неправильным значением параметра шаблона, исправьте файл параметров и снова запустите скрипт с другим именем группы ресурсов.</span><span class="sxs-lookup"><span data-stu-id="ff21e-183">If you get an error from running the script and you determine that the error was caused by a wrong template parameter value, correct the parameter file and run the script again with a different resource group name.</span></span> <span data-ttu-id="ff21e-184">Также можно повторно использовать то же имя группы ресурсов и очистить старое с помощью скрипта. Для этого следует добавить параметр `-RemoveExistingResourceGroup` к вызову скрипта.</span><span class="sxs-lookup"><span data-stu-id="ff21e-184">You can also reuse the same resource group name and have the script clean up the old one by adding the `-RemoveExistingResourceGroup` parameter to the script invocation.</span></span>

### <a name="result-of-running-the-createelasticsearchcluster-script"></a><span data-ttu-id="ff21e-185">Результат выполнения скрипта CreateElasticSearchCluster</span><span class="sxs-lookup"><span data-stu-id="ff21e-185">Result of running the CreateElasticSearchCluster script</span></span>
<span data-ttu-id="ff21e-186">После выполнения скрипта `CreateElasticSearchCluster` будут созданы следующие основные артефакты.</span><span class="sxs-lookup"><span data-stu-id="ff21e-186">After you run the `CreateElasticSearchCluster` script, the following main artifacts will be created.</span></span> <span data-ttu-id="ff21e-187">В данном примере предположим, что для параметра `dnsNameForLoadBalancerIP` указано значение myBigCluster, а кластер создан в регионе "Западная часть США".</span><span class="sxs-lookup"><span data-stu-id="ff21e-187">For this example we assume that you have used "myBigCluster" as the value of the `dnsNameForLoadBalancerIP` parameter and that the region where you created the cluster is West US.</span></span>

| <span data-ttu-id="ff21e-188">Артефакт</span><span class="sxs-lookup"><span data-stu-id="ff21e-188">Artifact</span></span> | <span data-ttu-id="ff21e-189">Имя, расположение и примечания</span><span class="sxs-lookup"><span data-stu-id="ff21e-189">Name, location, and remarks</span></span> |
| --- | --- |
| <span data-ttu-id="ff21e-190">Ключ SSH для удаленного администрирования</span><span class="sxs-lookup"><span data-stu-id="ff21e-190">SSH key for remote administration</span></span> |<span data-ttu-id="ff21e-191">Файл myBigCluster.key (в каталоге, из которого запущен скрипт CreateElasticSearchCluster).</span><span class="sxs-lookup"><span data-stu-id="ff21e-191">myBigCluster.key file (in the directory from which the CreateElasticSearchCluster was run).</span></span> <br /><br /><span data-ttu-id="ff21e-192">Этот ключ может использоваться для подключения к узлу администрирования и (через узел администрирования) к узлам данных в кластере.</span><span class="sxs-lookup"><span data-stu-id="ff21e-192">This key file can be used to connect to the admin node and (through the admin node) to data nodes in the cluster.</span></span> |
| <span data-ttu-id="ff21e-193">Узел администрирования</span><span class="sxs-lookup"><span data-stu-id="ff21e-193">Admin node</span></span> |<span data-ttu-id="ff21e-194">myBigCluster-admin.westus.cloudapp.azure.com</span><span class="sxs-lookup"><span data-stu-id="ff21e-194">myBigCluster-admin.westus.cloudapp.azure.com</span></span> <br /><br /><span data-ttu-id="ff21e-195">Выделенная виртуальная машина для удаленного администрирования кластера ElasticSearch. Только для нее разрешены внешние подключения по протоколу SSH.</span><span class="sxs-lookup"><span data-stu-id="ff21e-195">A dedicated VM for remote Elasticsearch cluster administration--the only one that allows external SSH connections.</span></span> <span data-ttu-id="ff21e-196">Эта виртуальная машина работает в той же виртуальной сети, что и остальные узлы кластера ElasticSearch, но не запускает какие-либо службы ElasticSearch.</span><span class="sxs-lookup"><span data-stu-id="ff21e-196">It runs on the same virtual network as all the Elasticsearch cluster nodes, but it does not run any Elasticsearch services.</span></span> |
| <span data-ttu-id="ff21e-197">Узлы данных</span><span class="sxs-lookup"><span data-stu-id="ff21e-197">Data nodes</span></span> |<span data-ttu-id="ff21e-198">myBigCluster1–</span><span class="sxs-lookup"><span data-stu-id="ff21e-198">myBigCluster1 …</span></span> <span data-ttu-id="ff21e-199">myBigCluster*N*</span><span class="sxs-lookup"><span data-stu-id="ff21e-199">myBigCluster*N*</span></span> <br /><br /><span data-ttu-id="ff21e-200">Узлы данных, на которых работают службы ElasticSearch и Kibana.</span><span class="sxs-lookup"><span data-stu-id="ff21e-200">Data nodes that are running Elasticsearch and Kibana services.</span></span> <span data-ttu-id="ff21e-201">К каждому узлу можно подключиться по протоколу SSH, но только через узел администрирования.</span><span class="sxs-lookup"><span data-stu-id="ff21e-201">You can connect via SSH to each node, but only via the admin node.</span></span> |
| <span data-ttu-id="ff21e-202">Кластер Elasticsearch</span><span class="sxs-lookup"><span data-stu-id="ff21e-202">Elasticsearch cluster</span></span> |<span data-ttu-id="ff21e-203">http://myBigCluster.westus.cloudapp.azure.com/es/</span><span class="sxs-lookup"><span data-stu-id="ff21e-203">http://myBigCluster.westus.cloudapp.azure.com/es/</span></span> <br /><br /><span data-ttu-id="ff21e-204">Основная конечная точка кластера ElasticSearch (обратите внимание на суффикс /es).</span><span class="sxs-lookup"><span data-stu-id="ff21e-204">The primary endpoint for the Elasticsearch cluster (note the /es suffix).</span></span> <span data-ttu-id="ff21e-205">Кластер защищен с помощью базовой проверки подлинности HTTP (учетные данные указаны в параметрах esUserName/esPassword шаблона ES-MultiNode).</span><span class="sxs-lookup"><span data-stu-id="ff21e-205">It is protected by basic HTTP authentication (the credentials were the specified esUserName/esPassword parameters of the ES-MultiNode template).</span></span> <span data-ttu-id="ff21e-206">Кроме того, в кластере установлен подключаемый модуль head (http://myBigCluster.westus.cloudapp.azure.com/es/_plugin/head) для выполнения базовых задач администрирования кластера.</span><span class="sxs-lookup"><span data-stu-id="ff21e-206">The cluster has also the head plug-in installed (http://myBigCluster.westus.cloudapp.azure.com/es/_plugin/head) for basic cluster administration.</span></span> |
| <span data-ttu-id="ff21e-207">Служба Kibana</span><span class="sxs-lookup"><span data-stu-id="ff21e-207">Kibana service</span></span> |<span data-ttu-id="ff21e-208">http://myBigCluster.westus.cloudapp.azure.com</span><span class="sxs-lookup"><span data-stu-id="ff21e-208">http://myBigCluster.westus.cloudapp.azure.com</span></span> <br /><br /><span data-ttu-id="ff21e-209">Служба Kibana настраивается для отображения данных из созданного кластера ElasticSearch.</span><span class="sxs-lookup"><span data-stu-id="ff21e-209">The Kibana service is set up to show data from the created Elasticsearch cluster.</span></span> <span data-ttu-id="ff21e-210">Она защищена теми же учетными данными проверки подлинности, что и сам кластер.</span><span class="sxs-lookup"><span data-stu-id="ff21e-210">It is protected by the same authentication credentials as the cluster itself.</span></span> |

## <a name="in-process-versus-out-of-process-trace-capturing"></a><span data-ttu-id="ff21e-211">Внутрипроцессная и внепроцессная запись данных трассировки</span><span class="sxs-lookup"><span data-stu-id="ff21e-211">In-process versus out-of-process trace capturing</span></span>
<span data-ttu-id="ff21e-212">Во введении мы упомянули два основных способа сбора диагностических данных: внутрипроцессный и внепроцессный.</span><span class="sxs-lookup"><span data-stu-id="ff21e-212">In the introduction, we mentioned two fundamental ways of collecting diagnostic data: in-process and out-of-process.</span></span> <span data-ttu-id="ff21e-213">Каждый имеет свои преимущества и недостатки.</span><span class="sxs-lookup"><span data-stu-id="ff21e-213">Each has strengths and weaknesses.</span></span>

<span data-ttu-id="ff21e-214">**Внутрипроцессная запись данных трассировки** имеет следующие преимущества.</span><span class="sxs-lookup"><span data-stu-id="ff21e-214">Advantages of the **in-process trace capturing** include:</span></span>

1. <span data-ttu-id="ff21e-215">*Простая настройка и развертывание.*</span><span class="sxs-lookup"><span data-stu-id="ff21e-215">*Easy configuration and deployment*</span></span>
   
   * <span data-ttu-id="ff21e-216">Конфигурация сбора диагностических данных является лишь частью конфигурации приложения.</span><span class="sxs-lookup"><span data-stu-id="ff21e-216">The configuration of diagnostic data collection is just part of the application configuration.</span></span> <span data-ttu-id="ff21e-217">Ее легко сохранять "синхронизированной" с остальной частью приложения.</span><span class="sxs-lookup"><span data-stu-id="ff21e-217">It is easy to always keep it "in sync" with the rest of the application.</span></span>
   * <span data-ttu-id="ff21e-218">Настройка каждого приложения или службы также является несложной задачей.</span><span class="sxs-lookup"><span data-stu-id="ff21e-218">Per-application or per-service configuration is easily achievable.</span></span>
   * <span data-ttu-id="ff21e-219">Внепроцессная запись данных трассировки обычно требует отдельного развертывания и настройки агента диагностики. Как правило, это прибавляет работы администратору и может являться источником ошибок.</span><span class="sxs-lookup"><span data-stu-id="ff21e-219">Out-of-process trace capturing usually requires a separate deployment and configuration of the diagnostic agent, which is an extra administrative task and a potential source of errors.</span></span> <span data-ttu-id="ff21e-220">Технология определенного агента часто позволяет использовать только один экземпляр агента на каждую виртуальную машину (узел).</span><span class="sxs-lookup"><span data-stu-id="ff21e-220">The particular agent technology often allows only one instance of the agent per virtual machine (node).</span></span> <span data-ttu-id="ff21e-221">Это означает, что конфигурация для коллекции конфигурации диагностики является общей для всех приложений и служб, работающих на этом узле.</span><span class="sxs-lookup"><span data-stu-id="ff21e-221">This means that configuration for the collection of the diagnostic configuration is shared among all applications and services running on that node.</span></span>
2. <span data-ttu-id="ff21e-222">*Гибкость*</span><span class="sxs-lookup"><span data-stu-id="ff21e-222">*Flexibility*</span></span>
   
   * <span data-ttu-id="ff21e-223">Приложение может отправлять данные куда угодно при наличии клиентской библиотеки, поддерживающей систему хранения целевых данных.</span><span class="sxs-lookup"><span data-stu-id="ff21e-223">The application can send the data wherever it needs to go, as long as there is a client library that supports the targeted data storage system.</span></span> <span data-ttu-id="ff21e-224">При необходимости можно добавлять новые приемники.</span><span class="sxs-lookup"><span data-stu-id="ff21e-224">New sinks can be added as desired.</span></span>
   * <span data-ttu-id="ff21e-225">Можно реализовать сложные правила сбора, фильтрации и статистической обработки данных.</span><span class="sxs-lookup"><span data-stu-id="ff21e-225">Complex capture, filtering, and data-aggregation rules can be implemented.</span></span>
   * <span data-ttu-id="ff21e-226">Внепроцессная запись данных трассировки часто ограничивается приемниками данных, которые поддерживает агент.</span><span class="sxs-lookup"><span data-stu-id="ff21e-226">An out-of-process trace capturing is often limited by the data sinks that the agent supports.</span></span> <span data-ttu-id="ff21e-227">Некоторые агенты являются расширяемыми.</span><span class="sxs-lookup"><span data-stu-id="ff21e-227">Some agents are extensible.</span></span>
3. <span data-ttu-id="ff21e-228">*Доступ к внутренним данным приложения и контексту*</span><span class="sxs-lookup"><span data-stu-id="ff21e-228">*Access to internal application data and context*</span></span>
   
   * <span data-ttu-id="ff21e-229">В подсистему диагностики, которая работает внутри процесса приложения или службы, можно легко добавить трассировку с помощью контекстной информации.</span><span class="sxs-lookup"><span data-stu-id="ff21e-229">The diagnostic subsystem running inside the application/service process can easily augment the traces with contextual information.</span></span>
   * <span data-ttu-id="ff21e-230">В случае внепроцессной записи данные должны отправляться агенту с помощью механизма межпроцессного взаимодействия, например трассировки событий Windows.</span><span class="sxs-lookup"><span data-stu-id="ff21e-230">In the out-of-process approach, the data must be sent to an agent via some inter-process communication mechanism, such as Event Tracing for Windows.</span></span> <span data-ttu-id="ff21e-231">Однако при таком механизме могут возникнуть дополнительные ограничения.</span><span class="sxs-lookup"><span data-stu-id="ff21e-231">This mechanism could impose additional limitations.</span></span>

<span data-ttu-id="ff21e-232">**Внепроцессная запись данных трассировки** имеет следующие преимущества.</span><span class="sxs-lookup"><span data-stu-id="ff21e-232">Advantages of the **out-of-process trace capturing** include:</span></span>

1. <span data-ttu-id="ff21e-233">*Возможность отслеживания приложения и сбора аварийных дампов*</span><span class="sxs-lookup"><span data-stu-id="ff21e-233">*The ability to monitor the application and collect crash dumps*</span></span>
   
   * <span data-ttu-id="ff21e-234">Внутрипроцессная запись данных трассировки может быть неудачной, если приложение не удается запустить или оно прекращает работу из-за сбоя.</span><span class="sxs-lookup"><span data-stu-id="ff21e-234">In-process trace capturing may be unsuccessful if the application fails to start or crashes.</span></span> <span data-ttu-id="ff21e-235">Независимый агент имеет гораздо больше шансов собрать важные сведения для устранения неполадок.</span><span class="sxs-lookup"><span data-stu-id="ff21e-235">An independent agent has a much better chance of capturing crucial troubleshooting information.</span></span><br /><br />
2. <span data-ttu-id="ff21e-236">*Зрелость, надежность и высокая производительность*</span><span class="sxs-lookup"><span data-stu-id="ff21e-236">*Maturity, robustness, and proven performance*</span></span>
   
   * <span data-ttu-id="ff21e-237">Агент, разработанный поставщиком платформы (например, агент системы диагностики Microsoft Azure), прошел тщательное тестирование и испытан в рабочих условиях.</span><span class="sxs-lookup"><span data-stu-id="ff21e-237">An agent developed by a platform vendor (such as a Microsoft Azure Diagnostics agent) has been subject to rigorous testing and battle-hardening.</span></span>
   * <span data-ttu-id="ff21e-238">Будьте осторожны, выбирая внутрипроцессную запись данных трассировки. Следите за тем, чтобы отправка диагностических данных из процесса приложения не повлияла на его основные задачи и не привела к проблемам со своевременным выполнением задач или производительностью.</span><span class="sxs-lookup"><span data-stu-id="ff21e-238">With in-process trace capturing, care must be taken to ensure that the activity of sending diagnostic data from an application process does not interfere with the application's main tasks or introduce timing or performance problems.</span></span> <span data-ttu-id="ff21e-239">Независимый агент менее подвержен подобным проблемам и специально разработан для минимального влияния на работу системы.</span><span class="sxs-lookup"><span data-stu-id="ff21e-239">An independently running agent is less prone to these issues and is specifically designed to limit its impact on the system.</span></span>

<span data-ttu-id="ff21e-240">Преимущества обоих подходов можно объединить.</span><span class="sxs-lookup"><span data-stu-id="ff21e-240">It is possible to combine and benefit from both approaches.</span></span> <span data-ttu-id="ff21e-241">Это действительно может оказаться наилучшим решением для многих приложений.</span><span class="sxs-lookup"><span data-stu-id="ff21e-241">Indeed, it might be the best solution for many applications.</span></span>

<span data-ttu-id="ff21e-242">Здесь мы используем **библиотеку Microsoft.Diagnostic.Listeners** и внутрипроцессную запись данных трассировки для отправки данных из приложения Service Fabric в кластер ElasticSearch.</span><span class="sxs-lookup"><span data-stu-id="ff21e-242">Here, we use the **Microsoft.Diagnostic.Listeners library** and the in-process trace capturing to send data from a Service Fabric application to an Elasticsearch cluster.</span></span>

## <a name="use-the-listeners-library-to-send-diagnostic-data-to-elasticsearch"></a><span data-ttu-id="ff21e-243">Использование библиотеки прослушивателей для передачи диагностических данных в ElasticSearch</span><span class="sxs-lookup"><span data-stu-id="ff21e-243">Use the Listeners library to send diagnostic data to Elasticsearch</span></span>
<span data-ttu-id="ff21e-244">Библиотека Microsoft.Diagnostic.Listeners входит в пример приложения Service Fabric с именем PartyCluster.</span><span class="sxs-lookup"><span data-stu-id="ff21e-244">The Microsoft.Diagnostic.Listeners library is part of PartyCluster sample Service Fabric application.</span></span> <span data-ttu-id="ff21e-245">Чтобы ее использовать, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="ff21e-245">To use it:</span></span>

1. <span data-ttu-id="ff21e-246">Скачайте [пример PartyCluster](https://github.com/Azure-Samples/service-fabric-dotnet-management-party-cluster) с сайта GitHub.</span><span class="sxs-lookup"><span data-stu-id="ff21e-246">Download [the PartyCluster sample](https://github.com/Azure-Samples/service-fabric-dotnet-management-party-cluster) from GitHub.</span></span>
2. <span data-ttu-id="ff21e-247">Скопируйте проекты Microsoft.Diagnostics.Listeners и Microsoft.Diagnostics.Listeners.Fabric (папки полностью) из каталога примера приложения Party Cluster в папку решения приложения, которое должно отправлять данные в ElasticSearch.</span><span class="sxs-lookup"><span data-stu-id="ff21e-247">Copy the Microsoft.Diagnostics.Listeners and Microsoft.Diagnostics.Listeners.Fabric projects (whole folders) from the PartyCluster sample directory to the solution folder of the application that is supposed to send the data to Elasticsearch.</span></span>
3. <span data-ttu-id="ff21e-248">Откройте это решение, щелкните правой кнопкой мыши узел решения в обозревателе решений и выберите **Добавить существующий проект**.</span><span class="sxs-lookup"><span data-stu-id="ff21e-248">Open the target solution, right-click the solution node in the Solution Explorer, and choose **Add Existing Project**.</span></span> <span data-ttu-id="ff21e-249">Добавьте в решение проект Microsoft.Diagnostics.Listeners.</span><span class="sxs-lookup"><span data-stu-id="ff21e-249">Add the Microsoft.Diagnostics.Listeners project to the solution.</span></span> <span data-ttu-id="ff21e-250">Повторите те же действия с проектом Microsoft.Diagnostics.Listeners.Fabric.</span><span class="sxs-lookup"><span data-stu-id="ff21e-250">Repeat the same for the Microsoft.Diagnostics.Listeners.Fabric project.</span></span>
4. <span data-ttu-id="ff21e-251">Добавьте ссылку на проект из ваших проектов служб в два добавленных проекта.</span><span class="sxs-lookup"><span data-stu-id="ff21e-251">Add a project reference from your service project(s) to the two added projects.</span></span> <span data-ttu-id="ff21e-252">(Каждая служба, которая будет отправлять данные в ElasticSearch, должна ссылаться на Microsoft.Diagnostics.EventListeners и Microsoft.Diagnostics.EventListeners.Fabric.)</span><span class="sxs-lookup"><span data-stu-id="ff21e-252">(Each service that is supposed to send data to Elasticsearch should reference Microsoft.Diagnostics.EventListeners and Microsoft.Diagnostics.EventListeners.Fabric).</span></span>
   
    ![Проект ссылается на библиотеки Microsoft.Diagnostics.EventListeners и Microsoft.Diagnostics.EventListeners.Fabric][1]

### <a name="service-fabric-general-availability-release-and-microsoftdiagnosticstracing-nuget-package"></a><span data-ttu-id="ff21e-254">Общедоступная версия Service Fabric и пакет Microsoft.Diagnostics.Tracing NuGet</span><span class="sxs-lookup"><span data-stu-id="ff21e-254">Service Fabric General Availability release and Microsoft.Diagnostics.Tracing Nuget package</span></span>
<span data-ttu-id="ff21e-255">Приложения, основанные на общедоступной версии Service Fabric (версия 2.0.135 от 31 марта 2016 года), нацелены на платформу **.NET Framework 4.5.2**.</span><span class="sxs-lookup"><span data-stu-id="ff21e-255">Applications built with Service Fabric General Availability release (2.0.135, released March 31, 2016) target **.NET Framework 4.5.2**.</span></span> <span data-ttu-id="ff21e-256">Это самая новая версия .NET Framework, поддерживаемая Azure на этапе общедоступной версии.</span><span class="sxs-lookup"><span data-stu-id="ff21e-256">This version is the highest version of the .NET Framework supported by Azure at the time of the GA release.</span></span> <span data-ttu-id="ff21e-257">К сожалению, в этой версии платформы отсутствуют некоторые API-интерфейсы EventListener, необходимые для библиотеки Microsoft.Diagnostics.Listeners.</span><span class="sxs-lookup"><span data-stu-id="ff21e-257">Unfortunately, this version of the framework lacks certain EventListener APIs that the Microsoft.Diagnostics.Listeners library needs.</span></span> <span data-ttu-id="ff21e-258">EventSource (компонент, на котором строятся API-интерфейсы ведения журналов в приложениях Fabric) и EventListener тесно связаны. Поэтому все проекты, использующие библиотеку Microsoft.Diagnostics.Listeners, должны использовать альтернативную реализацию EventSource.</span><span class="sxs-lookup"><span data-stu-id="ff21e-258">Because EventSource (the component that forms the basis of logging APIs in Fabric applications) and EventListener are tightly coupled, every project that uses the Microsoft.Diagnostics.Listeners library must use an alternative implementation of EventSource.</span></span> <span data-ttu-id="ff21e-259">Эта реализация доступна в **пакете NuGet Microsoft.Diagnostics.Tracing**, разработанном корпорацией Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="ff21e-259">This implementation is provided by the **Microsoft.Diagnostics.Tracing Nuget package**, authored by Microsoft.</span></span> <span data-ttu-id="ff21e-260">Этот пакет обратно совместим с компонентом EventSource, который входит в платформу. Следовательно, никакие правки в код вносить не нужно, разве что могут потребоваться изменения указанного пространства имен.</span><span class="sxs-lookup"><span data-stu-id="ff21e-260">The package is fully backward-compatible with EventSource included in the framework, so no code changes should be necessary other than referenced namespace changes.</span></span>

<span data-ttu-id="ff21e-261">Чтобы начать работу с Microsoft.Diagnostics.Tracing, реализацией класса EventSource, выполните следующие действия для каждого проекта службы, который должен отправлять данные в ElasticSearch.</span><span class="sxs-lookup"><span data-stu-id="ff21e-261">To start using the Microsoft.Diagnostics.Tracing implementation of the EventSource class, follow these steps for each service project that needs to send data to Elasticsearch:</span></span>

1. <span data-ttu-id="ff21e-262">Щелкните проект службы правой кнопкой мыши и выберите **Управление пакетами NuGet**.</span><span class="sxs-lookup"><span data-stu-id="ff21e-262">Right-click on the service project and choose **Manage Nuget Packages**.</span></span>
2. <span data-ttu-id="ff21e-263">Перейдите к источнику пакета nuget.org (если он еще не выбран) и введите**Microsoft.Diagnostics.Tracing**в строке поиска.</span><span class="sxs-lookup"><span data-stu-id="ff21e-263">Switch to the nuget.org package source (if it is not already selected) and search for "**Microsoft.Diagnostics.Tracing**".</span></span>
3. <span data-ttu-id="ff21e-264">Установите пакет `Microsoft.Diagnostics.Tracing.EventSource` (и его зависимости).</span><span class="sxs-lookup"><span data-stu-id="ff21e-264">Install the `Microsoft.Diagnostics.Tracing.EventSource` package (and its dependencies).</span></span>
4. <span data-ttu-id="ff21e-265">Откройте файл **ServiceEventSource.cs** или **ActorEventSource.cs** в проекте службы и замените директиву `using System.Diagnostics.Tracing` в начале файла директивой `using Microsoft.Diagnostics.Tracing`.</span><span class="sxs-lookup"><span data-stu-id="ff21e-265">Open the **ServiceEventSource.cs** or **ActorEventSource.cs** file in your service project and replace the `using System.Diagnostics.Tracing` directive on top of the file with the `using Microsoft.Diagnostics.Tracing` directive.</span></span>

<span data-ttu-id="ff21e-266">Эти действия будут не нужны, когда в Microsoft Azure появится поддержка **.NET Framework 4.6** .</span><span class="sxs-lookup"><span data-stu-id="ff21e-266">These steps will not be necessary once the **.NET Framework 4.6** is supported by Microsoft Azure.</span></span>

### <a name="elasticsearch-listener-instantiation-and-configuration"></a><span data-ttu-id="ff21e-267">Создание и настройка экземпляра прослушивателя ElasticSearch</span><span class="sxs-lookup"><span data-stu-id="ff21e-267">Elasticsearch listener instantiation and configuration</span></span>
<span data-ttu-id="ff21e-268">Последним шагом, необходимым для отправки диагностических данных в ElasticSearch, является создание экземпляра `ElasticSearchListener` и его настройка с помощью данных подключения ElasticSearch.</span><span class="sxs-lookup"><span data-stu-id="ff21e-268">The final step for sending diagnostic data to Elasticsearch is to create an instance of `ElasticSearchListener` and configure it with Elasticsearch connection data.</span></span> <span data-ttu-id="ff21e-269">Прослушиватель будет автоматически записывать все события, вызванные через классы EventSource, заданные в проекте службы.</span><span class="sxs-lookup"><span data-stu-id="ff21e-269">The listener automatically captures all events raised via EventSource classes defined in the service project.</span></span> <span data-ttu-id="ff21e-270">Он должен быть активным в течение всего времени существования службы, поэтому лучше всего создать его в коде инициализации службы.</span><span class="sxs-lookup"><span data-stu-id="ff21e-270">It needs to be alive during the lifetime of the service, so the best place to create it is in the service initialization code.</span></span> <span data-ttu-id="ff21e-271">Вот как может выглядеть код инициализации службы без отслеживания состояния после внесения необходимых изменений (добавлений, указанных в комментариях, начиная с `****`):</span><span class="sxs-lookup"><span data-stu-id="ff21e-271">Here is how the initialization code for a stateless service could look after the necessary changes (additions pointed out in comments starting with `****`):</span></span>

```csharp
using System;
using System.Diagnostics;
using System.Fabric;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.ServiceFabric.Services.Runtime;

// **** Add the following directives
using Microsoft.Diagnostics.EventListeners;
using Microsoft.Diagnostics.EventListeners.Fabric;

namespace Stateless1
{
    internal static class Program
    {
        /// <summary>
        /// This is the entry point of the service host process.
        /// </summary>        
        private static void Main()
        {
            try
            {
                // **** Instantiate ElasticSearchListener
                var configProvider = new FabricConfigurationProvider("ElasticSearchEventListener");
                ElasticSearchListener esListener = null;
                if (configProvider.HasConfiguration)
                {
                    esListener = new ElasticSearchListener(configProvider, new FabricHealthReporter("ElasticSearchEventListener"));
                }

                // The ServiceManifest.XML file defines one or more service type names.
                // Registering a service maps a service type name to a .NET type.
                // When Service Fabric creates an instance of this service type,
                // an instance of the class is created in this host process.

                ServiceRuntime.RegisterServiceAsync("Stateless1Type", 
                    context => new Stateless1(context)).GetAwaiter().GetResult();

                ServiceEventSource.Current.ServiceTypeRegistered(Process.GetCurrentProcess().Id, typeof(Stateless1).Name);

                // Prevents this host process from terminating so services keep running.
                Thread.Sleep(Timeout.Infinite);

                // **** Ensure that the ElasticSearchListner instance is not garbage-collected prematurely
                GC.KeepAlive(esListener);
            }
            catch (Exception e)
            {
                ServiceEventSource.Current.ServiceHostInitializationFailed(e);
                throw;
            }
        }
    }
}
```

<span data-ttu-id="ff21e-272">Данные подключения ElasticSearch необходимо поместить в отдельный раздел файла конфигурации службы (**PackageRoot\Config\Settings.xml**).</span><span class="sxs-lookup"><span data-stu-id="ff21e-272">Elasticsearch connection data should be put in a separate section in the service configuration file (**PackageRoot\Config\Settings.xml**).</span></span> <span data-ttu-id="ff21e-273">Имя раздела должно соответствовать значению, которое передается конструктору `FabricConfigurationProvider` , например:</span><span class="sxs-lookup"><span data-stu-id="ff21e-273">The name of the section must correspond to the value passed to the `FabricConfigurationProvider` constructor, for example:</span></span>

```xml
<Section Name="ElasticSearchEventListener">
  <Parameter Name="serviceUri" Value="http://myBigCluster.westus.cloudapp.azure.com/es/" />
  <Parameter Name="userName" Value="(ES user name)" />
  <Parameter Name="password" Value="(ES user password)" />
  <Parameter Name="indexNamePrefix" Value="myapp" />
</Section>
```
<span data-ttu-id="ff21e-274">Значения параметров `serviceUri`, `userName` и `password` — это адрес конечной точки кластера ElasticSearch, имя пользователя ElasticSearch и его пароль, соответственно.</span><span class="sxs-lookup"><span data-stu-id="ff21e-274">The values of `serviceUri`, `userName` and `password` parameters correspond to the Elasticsearch cluster endpoint address, Elasticsearch user name, and password, respectively.</span></span> <span data-ttu-id="ff21e-275">`indexNamePrefix` — префикс для индексов ElasticSearch. Библиотека Microsoft.Diagnostics.Listeners ежедневно создает новый индекс для своих данных.</span><span class="sxs-lookup"><span data-stu-id="ff21e-275">`indexNamePrefix` is the prefix for Elasticsearch indexes; the Microsoft.Diagnostics.Listeners library creates a new index for its data daily.</span></span>

### <a name="verification"></a><span data-ttu-id="ff21e-276">Проверка</span><span class="sxs-lookup"><span data-stu-id="ff21e-276">Verification</span></span>
<span data-ttu-id="ff21e-277">Вот и все!</span><span class="sxs-lookup"><span data-stu-id="ff21e-277">That's it!</span></span> <span data-ttu-id="ff21e-278">Теперь при запуске служба будет отправлять данные трассировки в службу ElasticSearch, указанную в конфигурации.</span><span class="sxs-lookup"><span data-stu-id="ff21e-278">Now, whenever the service is run, it starts sending traces to the Elasticsearch service specified in the configuration.</span></span> <span data-ttu-id="ff21e-279">Это можно проверить, открыв пользовательский интерфейс Kibana, связанный с целевым экземпляром ElasticSearch.</span><span class="sxs-lookup"><span data-stu-id="ff21e-279">You can verify this by opening the Kibana UI associated with the target Elasticsearch instance.</span></span> <span data-ttu-id="ff21e-280">В нашем примере адрес страницы — http://myBigCluster.westus.cloudapp.azure.com/.</span><span class="sxs-lookup"><span data-stu-id="ff21e-280">In our example, the page address is http://myBigCluster.westus.cloudapp.azure.com/.</span></span> <span data-ttu-id="ff21e-281">Убедитесь, что индексы с префиксом имени, выбранным для экземпляра `ElasticSearchListener` , действительно были созданы и заполнены данными.</span><span class="sxs-lookup"><span data-stu-id="ff21e-281">Check that indexes with the name prefix chosen for the `ElasticSearchListener` instance have indeed been created and populated with data.</span></span>

![Отображение событий приложения PartyCluster в службе Kibana][2]

## <a name="next-steps"></a><span data-ttu-id="ff21e-283">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="ff21e-283">Next steps</span></span>
* [<span data-ttu-id="ff21e-284">Дополнительные сведения о диагностике и мониторинге службы Service Fabric</span><span class="sxs-lookup"><span data-stu-id="ff21e-284">Learn more about diagnosing and monitoring a Service Fabric service</span></span>](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md)

<!--Image references-->
[1]: ./media/service-fabric-diagnostics-how-to-use-elasticsearch/listener-lib-references.png
[2]: ./media/service-fabric-diagnostics-how-to-use-elasticsearch/kibana.png

---
title: "aaaService диспетчер ресурсов кластера структуры - сходства | Документы Microsoft"
description: "Общие сведения о настройке сходства для служб Service Fabric"
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: 678073e1-d08d-46c4-a811-826e70aba6c4
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 7dc9b6d9c18d9d615d39cff7de9d7cba1c040474
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="configuring-and-using-service-affinity-in-service-fabric"></a><span data-ttu-id="bc262-103">Настройка и использование сходства служб в Service Fabric</span><span class="sxs-lookup"><span data-stu-id="bc262-103">Configuring and using service affinity in Service Fabric</span></span>
<span data-ttu-id="bc262-104">Сопоставление — это элемент управления, предоставленные главным образом toohelp простота hello, передача больших монолитные приложений в облаке и микрослужбами Здравствуй, мир.</span><span class="sxs-lookup"><span data-stu-id="bc262-104">Affinity is a control that is provided mainly toohelp ease hello transition of larger monolithic applications into hello cloud and microservices world.</span></span> <span data-ttu-id="bc262-105">Он также используется для оптимизации по улучшению производительности hello служб, несмотря на то, что это может иметь побочные эффекты.</span><span class="sxs-lookup"><span data-stu-id="bc262-105">It is also used as an optimization for improving hello performance of services, although doing so can have side effects.</span></span>

<span data-ttu-id="bc262-106">Предположим, что перевод приложение большего размера или пакет, который просто не было разработано с микрослужбами в виду, tooService структуры (или любой распределенной среде).</span><span class="sxs-lookup"><span data-stu-id="bc262-106">Let’s say you’re bringing a larger app, or one that just wasn’t designed with microservices in mind, tooService Fabric (or any distributed environment).</span></span> <span data-ttu-id="bc262-107">Это вполне распространенный сценарий перехода.</span><span class="sxs-lookup"><span data-stu-id="bc262-107">This type of transition is common.</span></span> <span data-ttu-id="bc262-108">Начинается с устранением всего приложения hello в среду hello, упаковки и убедиться, что его бесперебойной.</span><span class="sxs-lookup"><span data-stu-id="bc262-108">You start by lifting hello entire app into hello environment, packaging it, and making sure it is running smoothly.</span></span> <span data-ttu-id="bc262-109">Затем вы запустите разбить его на разных служб меньшего размера, что все говорить tooeach других.</span><span class="sxs-lookup"><span data-stu-id="bc262-109">Then you start breaking it down into different smaller services that all talk tooeach other.</span></span>

<span data-ttu-id="bc262-110">Со временем может оказаться, что приложение hello возникают некоторые проблемы.</span><span class="sxs-lookup"><span data-stu-id="bc262-110">Eventually you may find that hello application is experiencing some issues.</span></span> <span data-ttu-id="bc262-111">Hello проблемы обычно относятся к одной из этих категорий:</span><span class="sxs-lookup"><span data-stu-id="bc262-111">hello issues usually fall into one of these categories:</span></span>

1. <span data-ttu-id="bc262-112">Компонент X монолитные приложение hello имел зависимость недокументированные компонента Y, и только вы включили этих компонентов по отдельным службам.</span><span class="sxs-lookup"><span data-stu-id="bc262-112">Some component X in hello monolithic app had an undocumented dependency on component Y, and you just turned those components into separate services.</span></span> <span data-ttu-id="bc262-113">Поскольку теперь эти службы работают на разных узлах в кластере hello, они работают.</span><span class="sxs-lookup"><span data-stu-id="bc262-113">Since these services are now running on different nodes in hello cluster, they're broken.</span></span>
2. <span data-ttu-id="bc262-114">Эти компоненты взаимодействуют через (локальные именованные каналы | общей памяти | файлы на диске) и действительно нужен toobe может toowrite tooa общих локальных ресурсов для повышения производительности в данный момент.</span><span class="sxs-lookup"><span data-stu-id="bc262-114">These components communicate via (local named pipes | shared memory | files on disk) and they really need toobe able toowrite tooa shared local resource for performance reasons right now.</span></span> <span data-ttu-id="bc262-115">Возможно, позже эта жесткая зависимость будет устранена.</span><span class="sxs-lookup"><span data-stu-id="bc262-115">That hard dependency gets removed later, maybe.</span></span>
3. <span data-ttu-id="bc262-116">Все работает, но оказывается, что эти два компонента выдают слишком много данных или слишком чувствительны к уровню производительности.</span><span class="sxs-lookup"><span data-stu-id="bc262-116">Everything is fine, but it turns out that these two components are actually chatty/performance sensitive.</span></span> <span data-ttu-id="bc262-117">С их переносом в отдельные службы общая производительность приложения резко упала или увеличилась задержка.</span><span class="sxs-lookup"><span data-stu-id="bc262-117">When they moved them into separate services overall application performance tanked or latency increased.</span></span> <span data-ttu-id="bc262-118">В результате hello всего приложения, не отвечают требованиям.</span><span class="sxs-lookup"><span data-stu-id="bc262-118">As a result, hello overall application is not meeting expectations.</span></span>

<span data-ttu-id="bc262-119">В таких случаях мы не требуется toolose нашей работе рефакторинга и не хотите монолита toogo toohello назад.</span><span class="sxs-lookup"><span data-stu-id="bc262-119">In these cases, we don’t want toolose our refactoring work, and don’t want toogo back toohello monolith.</span></span> <span data-ttu-id="bc262-120">Hello последнего условия даже могут требоваться plain в целях оптимизации.</span><span class="sxs-lookup"><span data-stu-id="bc262-120">hello last condition may even be desirable as a plain optimization.</span></span> <span data-ttu-id="bc262-121">Тем не менее пока мы естественным образом переработки hello компонентов toowork как службы (или пока мы можем решить ожидаемой производительности hello иным способом) мы будем tooneed некоторое ощущение местоположению.</span><span class="sxs-lookup"><span data-stu-id="bc262-121">However, until we can redesign hello components toowork naturally as services (or until we can solve hello performance expectations some other way) we're going tooneed some sense of locality.</span></span>

<span data-ttu-id="bc262-122">Какие toodo?</span><span class="sxs-lookup"><span data-stu-id="bc262-122">What toodo?</span></span> <span data-ttu-id="bc262-123">Попробуйте включить сходство.</span><span class="sxs-lookup"><span data-stu-id="bc262-123">Well, you could try turning on affinity.</span></span>

## <a name="how-tooconfigure-affinity"></a><span data-ttu-id="bc262-124">Как tooconfigure сходства</span><span class="sxs-lookup"><span data-stu-id="bc262-124">How tooconfigure affinity</span></span>
<span data-ttu-id="bc262-125">tooset копирование affinity определить связь между двумя различными службами.</span><span class="sxs-lookup"><span data-stu-id="bc262-125">tooset up affinity, you define an affinity relationship between two different services.</span></span> <span data-ttu-id="bc262-126">Это все равно, что указать одной службе на другую и сказать: "Эта служба может работать только тогда, когда та служба работает".</span><span class="sxs-lookup"><span data-stu-id="bc262-126">You can think of affinity as “pointing” one service at another and saying “This service can only run where that service is running.”</span></span> <span data-ttu-id="bc262-127">Иногда мы называем tooaffinity иерархическое отношение, (где вы указываете дочерних hello в родительской hello).</span><span class="sxs-lookup"><span data-stu-id="bc262-127">Sometimes we refer tooaffinity as a parent/child relationship (where you point hello child at hello parent).</span></span> <span data-ttu-id="bc262-128">Сопоставление гарантирует, что реплики hello или экземпляры одной службы размещаются на hello же узлы, у другой службы.</span><span class="sxs-lookup"><span data-stu-id="bc262-128">Affinity ensures that hello replicas or instances of one service are placed on hello same nodes as those of another service.</span></span>

```csharp
ServiceCorrelationDescription affinityDescription = new ServiceCorrelationDescription();
affinityDescription.Scheme = ServiceCorrelationScheme.Affinity;
affinityDescription.ServiceName = new Uri("fabric:/otherApplication/parentService");
serviceDescription.Correlations.Add(affinityDescription);
await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

> [!NOTE]
> <span data-ttu-id="bc262-129">Дочерняя служба может участвовать только в одном отношении сходства.</span><span class="sxs-lookup"><span data-stu-id="bc262-129">A child service can only participate in a single affinity relationship.</span></span> <span data-ttu-id="bc262-130">При желании hello дочерних toobe родственных tootwo родительской службы за один раз у вас есть несколько вариантов:</span><span class="sxs-lookup"><span data-stu-id="bc262-130">If you wanted hello child toobe affinitized tootwo parent services at once you have a couple options:</span></span>
> - <span data-ttu-id="bc262-131">Обратной связи hello (имеют parentService1 и parentService2 точки hello текущей дочерние службы), или</span><span class="sxs-lookup"><span data-stu-id="bc262-131">Reverse hello relationships (have parentService1 and parentService2 point at hello current child service), or</span></span>
> - <span data-ttu-id="bc262-132">Сделать одним из родительских элементов hello концентратор по соглашению и иметь точки этой службы все службы.</span><span class="sxs-lookup"><span data-stu-id="bc262-132">Designate one of hello parents as a hub by convention and have all services point at that service.</span></span> 
>
> <span data-ttu-id="bc262-133">Привет, возникающие в режима работы размещения в кластере hello следует hello же.</span><span class="sxs-lookup"><span data-stu-id="bc262-133">hello resulting placement behavior in hello cluster should be hello same.</span></span>
>

## <a name="different-affinity-options"></a><span data-ttu-id="bc262-134">Различные параметры сходства</span><span class="sxs-lookup"><span data-stu-id="bc262-134">Different affinity options</span></span>
<span data-ttu-id="bc262-135">Сопоставление представляет одна из нескольких возможных схем корреляции, которая имеет два различных режима.</span><span class="sxs-lookup"><span data-stu-id="bc262-135">Affinity is represented via one of several correlation schemes, and has two different modes.</span></span> <span data-ttu-id="bc262-136">наиболее распространенные режим Hello сходства —, называемый NonAlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="bc262-136">hello most common mode of affinity is what we call NonAlignedAffinity.</span></span> <span data-ttu-id="bc262-137">В NonAlignedAffinity, hello реплики или экземпляры hello различных служб, помещаются в hello же узлы.</span><span class="sxs-lookup"><span data-stu-id="bc262-137">In NonAlignedAffinity, hello replicas or instances of hello different services are placed on hello same nodes.</span></span> <span data-ttu-id="bc262-138">Hello другой режим — AlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="bc262-138">hello other mode is AlignedAffinity.</span></span> <span data-ttu-id="bc262-139">Он применяется только для служб с отслеживанием состояния.</span><span class="sxs-lookup"><span data-stu-id="bc262-139">Aligned Affinity is useful only with stateful services.</span></span> <span data-ttu-id="bc262-140">Настройка сопоставления toohave выравниваются службы гарантирует, что hello в источниках этих служб размещаются на два с отслеживанием состояния hello разным узлам в другом.</span><span class="sxs-lookup"><span data-stu-id="bc262-140">Configuring two stateful services toohave aligned affinity ensures that hello primaries of those services are placed on hello same nodes as each other.</span></span> <span data-ttu-id="bc262-141">Она вызывает каждая пара баз данных-получателей для этих служб toobe обмена hello же узлы.</span><span class="sxs-lookup"><span data-stu-id="bc262-141">It also causes each pair of secondaries for those services toobe placed on hello same nodes.</span></span> <span data-ttu-id="bc262-142">Это также возможно (хотя реже) tooconfigure NonAlignedAffinity для служб с отслеживанием состояния.</span><span class="sxs-lookup"><span data-stu-id="bc262-142">It is also possible (though less common) tooconfigure NonAlignedAffinity for stateful services.</span></span> <span data-ttu-id="bc262-143">Для NonAlignedAffinity разным узлам hello hello разных реплик hello, который будет выполняться две службы с отслеживанием состояния, но их в источниках могут помещаться на разных узлах.</span><span class="sxs-lookup"><span data-stu-id="bc262-143">For NonAlignedAffinity, hello different replicas of hello two stateful services would run on hello same nodes, but their primaries could end up on different nodes.</span></span>

<span data-ttu-id="bc262-144"><center>
![Режимы сопоставления и их воздействие][Image1]
</center></span><span class="sxs-lookup"><span data-stu-id="bc262-144"><center>
![Affinity Modes and Their Effects][Image1]
</center></span></span>

### <a name="best-effort-desired-state"></a><span data-ttu-id="bc262-145">Требуемое состояние не гарантируется</span><span class="sxs-lookup"><span data-stu-id="bc262-145">Best effort desired state</span></span>
<span data-ttu-id="bc262-146">Отношение сходства является не гарантируется.</span><span class="sxs-lookup"><span data-stu-id="bc262-146">An affinity relationship is best effort.</span></span> <span data-ttu-id="bc262-147">Он не предоставляет hello же гарантии выровненное размещение или надежности, работающих в hello выполняет же исполняемый процесс.</span><span class="sxs-lookup"><span data-stu-id="bc262-147">It does not provide hello same guarantees of collocation or reliability that running in hello same executable process does.</span></span> <span data-ttu-id="bc262-148">службы Hello в отношении сходства — существенно различается сущности, которые может завершиться ошибкой, поэтому перемещать их независимо друг от друга.</span><span class="sxs-lookup"><span data-stu-id="bc262-148">hello services in an affinity relationship are fundamentally different entities that can fail and be moved independently.</span></span> <span data-ttu-id="bc262-149">Отношение сходства также может нарушаться, хотя и временно.</span><span class="sxs-lookup"><span data-stu-id="bc262-149">An affinity relationship could also break, though these breaks are temporary.</span></span> <span data-ttu-id="bc262-150">Например ограничения емкости может означать только некоторые из объектов службы hello в связь hello помещается на заданном узле.</span><span class="sxs-lookup"><span data-stu-id="bc262-150">For example, capacity limitations may mean that only some of hello service objects in hello affinity relationship can fit on a given node.</span></span> <span data-ttu-id="bc262-151">В таких случаях несмотря на то, что выполняется связь, он не может быть применена из-за toohello другими ограничениями.</span><span class="sxs-lookup"><span data-stu-id="bc262-151">In these cases even though there's an affinity relationship in place, it can't be enforced due toohello other constraints.</span></span> <span data-ttu-id="bc262-152">Если это возможно toodo таким образом, нарушение hello, автоматически исправляется позже.</span><span class="sxs-lookup"><span data-stu-id="bc262-152">If it is possible toodo so, hello violation is automatically corrected later.</span></span>

### <a name="chains-vs-stars"></a><span data-ttu-id="bc262-153">Цепочки и звезды</span><span class="sxs-lookup"><span data-stu-id="bc262-153">Chains vs. stars</span></span>
<span data-ttu-id="bc262-154">Сегодня hello диспетчер ресурсов кластера не может toomodel последовательности сходство связей.</span><span class="sxs-lookup"><span data-stu-id="bc262-154">Today hello Cluster Resource Manager isn't able toomodel chains of affinity relationships.</span></span> <span data-ttu-id="bc262-155">Это означает, что служба, которая является дочерней в одном отношении сопоставления, не может быть родительской в другом.</span><span class="sxs-lookup"><span data-stu-id="bc262-155">What this means is that a service that is a child in one affinity relationship can’t be a parent in another affinity relationship.</span></span> <span data-ttu-id="bc262-156">Если требуется toomodel этот тип связи, в результате имеют toomodel его как звездочку, а не в цепочку.</span><span class="sxs-lookup"><span data-stu-id="bc262-156">If you want toomodel this type of relationship, you effectively have toomodel it as a star, rather than a chain.</span></span> <span data-ttu-id="bc262-157">toomove из звезда цепочки tooa, нижних дочерних hello вместо этого будет порождены toohello первый дочерний родительский.</span><span class="sxs-lookup"><span data-stu-id="bc262-157">toomove from a chain tooa star, hello bottommost child would be parented toohello first child’s parent instead.</span></span> <span data-ttu-id="bc262-158">В зависимости от упорядочения hello служб возможно toodo это несколько раз.</span><span class="sxs-lookup"><span data-stu-id="bc262-158">Depending on hello arrangement of your services, you may have toodo this multiple times.</span></span> <span data-ttu-id="bc262-159">Если служба не естественным родительским, возможно, toocreate, служит в качестве заполнителя.</span><span class="sxs-lookup"><span data-stu-id="bc262-159">If there's no natural parent service, you may have toocreate one that serves as a placeholder.</span></span> <span data-ttu-id="bc262-160">В зависимости от требований, можно также toolook в [групп приложений](service-fabric-cluster-resource-manager-application-groups.md).</span><span class="sxs-lookup"><span data-stu-id="bc262-160">Depending on your requirements, you may also want toolook into [Application Groups](service-fabric-cluster-resource-manager-application-groups.md).</span></span>

<span data-ttu-id="bc262-161"><center>
![Цепочки и Звезды в контексте сходство связей hello][Image2]
</center></span><span class="sxs-lookup"><span data-stu-id="bc262-161"><center>
![Chains vs. Stars in hello Context of Affinity Relationships][Image2]
</center></span></span>

<span data-ttu-id="bc262-162">Другой toonote вещь о сходство связей на сегодняшний день является, они являются направленными.</span><span class="sxs-lookup"><span data-stu-id="bc262-162">Another thing toonote about affinity relationships today is that they are directional.</span></span> <span data-ttu-id="bc262-163">Это означает, что это правило территориальной hello применяет только что hello дочерние размещается а родительского hello.</span><span class="sxs-lookup"><span data-stu-id="bc262-163">This means that hello affinity rule only enforces that hello child placed with hello parent.</span></span> <span data-ttu-id="bc262-164">Он не убедитесь, что родительской hello находится с дочерним hello.</span><span class="sxs-lookup"><span data-stu-id="bc262-164">It does not ensure that hello parent is located with hello child.</span></span> <span data-ttu-id="bc262-165">Также важно toonote, hello связь не может быть модель идеально подходит или мгновенно установлено принудительно, поскольку разных служб с разных жизненные циклы и может завершиться ошибкой и переместить независимо друг от друга.</span><span class="sxs-lookup"><span data-stu-id="bc262-165">It is also important toonote that hello affinity relationship can't be perfect or instantly enforced since different services have with different lifecycles and can fail and move independently.</span></span> <span data-ttu-id="bc262-166">Например предположим, что родительский hello внезапно при сбое узла tooanother, так как произошел сбой.</span><span class="sxs-lookup"><span data-stu-id="bc262-166">For example, let's say hello parent suddenly fails over tooanother node because it crashed.</span></span> <span data-ttu-id="bc262-167">Hello диспетчер ресурсов кластера и диспетчера отказоустойчивости дескриптор hello отработки отказа во-первых, так как в настоящий момент служб hello, согласованное и доступных hello приоритет.</span><span class="sxs-lookup"><span data-stu-id="bc262-167">hello Cluster Resource Manager and Failover Manager handle hello failover first, since keeping hello services up, consistent, and available is hello priority.</span></span> <span data-ttu-id="bc262-168">После завершения отработки отказа hello hello сходства связь нарушена, но диспетчер ресурсов кластера полагает, что все прекрасно, пока он замечает, что дочерние hello приветствия не расположен hello родительского элемента.</span><span class="sxs-lookup"><span data-stu-id="bc262-168">Once hello failover completes, hello affinity relationship is broken, but hello Cluster Resource Manager thinks everything is fine until it notices that hello child is not located with hello parent.</span></span> <span data-ttu-id="bc262-169">Такие проверки выполняются периодически.</span><span class="sxs-lookup"><span data-stu-id="bc262-169">These sorts of checks are performed periodically.</span></span> <span data-ttu-id="bc262-170">Дополнительные сведения о как hello диспетчер ресурсов кластера вычисляет ограничения недоступны в [в этой статье](service-fabric-cluster-resource-manager-management-integration.md#constraint-types), и [этого класса,](service-fabric-cluster-resource-manager-balancing.md) Подробнее о как tooconfigure hello периодичностью, на котором эти ограничения, Оценка.</span><span class="sxs-lookup"><span data-stu-id="bc262-170">More information on how hello Cluster Resource Manager evaluates constraints is available in [this article](service-fabric-cluster-resource-manager-management-integration.md#constraint-types), and [this one](service-fabric-cluster-resource-manager-balancing.md) talks more about how tooconfigure hello cadence on which these constraints are evaluated.</span></span>   


### <a name="partitioning-support"></a><span data-ttu-id="bc262-171">Поддержка секционирования</span><span class="sxs-lookup"><span data-stu-id="bc262-171">Partitioning support</span></span>
<span data-ttu-id="bc262-172">Hello заключительную toonotice о сопоставлении — что сходство связей не поддерживаются, где секционируется родительского hello.</span><span class="sxs-lookup"><span data-stu-id="bc262-172">hello final thing toonotice about affinity is that affinity relationships aren’t supported where hello parent is partitioned.</span></span> <span data-ttu-id="bc262-173">Возможно, со временем секционированные родительские службы будут поддерживаться, но на данный момент эта возможность отсутствует.</span><span class="sxs-lookup"><span data-stu-id="bc262-173">Partitioned parent services may be supported eventually, but today it is not allowed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="bc262-174">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="bc262-174">Next steps</span></span>
- <span data-ttu-id="bc262-175">Дополнительные сведения о настройке служб см. в разделе [Настройка параметров Cluster Resource Manager для служб Service Fabric](service-fabric-cluster-resource-manager-configure-services.md).</span><span class="sxs-lookup"><span data-stu-id="bc262-175">For more information on configuring services, [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)</span></span>
- <span data-ttu-id="bc262-176">toolimit служб tooa небольшой набор компьютеров или статистической обработки нагрузки hello служб, используйте [групп приложений](service-fabric-cluster-resource-manager-application-groups.md)</span><span class="sxs-lookup"><span data-stu-id="bc262-176">toolimit services tooa small set of machines or aggregating hello load of services, use [Application Groups](service-fabric-cluster-resource-manager-application-groups.md)</span></span>

[Image1]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resrouce-manager-affinity-modes.png
[Image2]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resource-manager-chains-vs-stars.png
---
title: "Добавление настраиваемых отчетов о работоспособности Service Fabric | Документация Майкрософт"
description: "Здесь описано, как отправлять настраиваемые отчеты о работоспособности в сущности работоспособности Azure Service Fabric. Здесь собраны рекомендации по разработке и реализации качественных отчетов о работоспособности."
services: service-fabric
documentationcenter: .net
author: oanapl
manager: timlt
editor: 
ms.assetid: 0a00a7d2-510e-47d0-8aa8-24c851ea847f
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/19/2017
ms.author: oanapl
ms.openlocfilehash: ed10eef347d4d93012078456b3a145589e66d30e
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="add-custom-service-fabric-health-reports"></a><span data-ttu-id="fc619-104">Добавление настраиваемых отчетов о работоспособности Service Fabric</span><span class="sxs-lookup"><span data-stu-id="fc619-104">Add custom Service Fabric health reports</span></span>
<span data-ttu-id="fc619-105">В Azure Service Fabric представлена [модель работоспособности](service-fabric-health-introduction.md) , которая предназначена для обозначения условий неработоспособности кластеров или приложений в отдельных сущностях.</span><span class="sxs-lookup"><span data-stu-id="fc619-105">Azure Service Fabric introduces a [health model](service-fabric-health-introduction.md) designed to flag unhealthy cluster and application conditions on specific entities.</span></span> <span data-ttu-id="fc619-106">В этой модели используются **информаторы о работоспособности** (системные компоненты и устройства наблюдения).</span><span class="sxs-lookup"><span data-stu-id="fc619-106">The health model uses **health reporters** (system components and watchdogs).</span></span> <span data-ttu-id="fc619-107">Их целью является простая и быстрая диагностика и восстановление.</span><span class="sxs-lookup"><span data-stu-id="fc619-107">The goal is easy and fast diagnosis and repair.</span></span> <span data-ttu-id="fc619-108">Создатели службы должны предупреждать проблемы работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-108">Service writers need to think upfront about health.</span></span> <span data-ttu-id="fc619-109">Любые условия, которые могут повлиять на работоспособность, должны регистрироваться, особенно в случаях, если это может помочь выяснить причину возникновения проблем.</span><span class="sxs-lookup"><span data-stu-id="fc619-109">Any condition that can impact health should be reported on, especially if it can help flag problems close to the root.</span></span> <span data-ttu-id="fc619-110">Сведения о работоспособности может сократить время и усилия, затрачиваемые на изучение и отладку.</span><span class="sxs-lookup"><span data-stu-id="fc619-110">The health information can save time and effort on debugging and investigation.</span></span> <span data-ttu-id="fc619-111">Полезность станет особенно очевидна после того, как служба будет масштабно запущена в облаке (в частном облаке или облаке Azure).</span><span class="sxs-lookup"><span data-stu-id="fc619-111">The usefulness is especially clear once the service is up and running at scale in the cloud (private or Azure).</span></span>

<span data-ttu-id="fc619-112">Докладчики Service Fabric отслеживают определенные условия.</span><span class="sxs-lookup"><span data-stu-id="fc619-112">The Service Fabric reporters monitor identified conditions of interest.</span></span> <span data-ttu-id="fc619-113">Они сообщают об этих условиях на основе своего локального представления.</span><span class="sxs-lookup"><span data-stu-id="fc619-113">They report on those conditions based on their local view.</span></span> <span data-ttu-id="fc619-114">В [хранилище данных о работоспособности](service-fabric-health-introduction.md#health-store) собираются данные о работоспособности, отправленные всеми информаторами, что помогает определять глобальную работоспособность сущностей.</span><span class="sxs-lookup"><span data-stu-id="fc619-114">The [health store](service-fabric-health-introduction.md#health-store) aggregates health data sent by all reporters to determine whether entities are globally healthy.</span></span> <span data-ttu-id="fc619-115">Модель оптимизирована, она гибкая и простая в использовании.</span><span class="sxs-lookup"><span data-stu-id="fc619-115">The model is intended to be rich, flexible, and easy to use.</span></span> <span data-ttu-id="fc619-116">Качество отчетов о работоспособности определяет точность представления данных о работоспособности кластера.</span><span class="sxs-lookup"><span data-stu-id="fc619-116">The quality of the health reports determines the accuracy of the health view of the cluster.</span></span> <span data-ttu-id="fc619-117">Ложные положительные результаты, которые неправильно отображают проблемы работоспособности, могут отрицательно повлиять на обновления или другие службы, использующие данные о работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-117">False positives that wrongly show unhealthy issues can negatively impact upgrades or other services that use health data.</span></span> <span data-ttu-id="fc619-118">В качестве примеров можно вспомнить службы восстановления и механизмы предупреждений.</span><span class="sxs-lookup"><span data-stu-id="fc619-118">Examples of such services are repair services and alerting mechanisms.</span></span> <span data-ttu-id="fc619-119">Поэтому нужно тщательно обдумать, как получить отчеты с отображением только нужных условий.</span><span class="sxs-lookup"><span data-stu-id="fc619-119">Therefore, some thought is needed to provide reports that capture conditions of interest in the best possible way.</span></span>

<span data-ttu-id="fc619-120">Для разработки и реализации системы отчетов о работоспособности нужно, чтобы модули наблюдения и компоненты системы могли выполнить следующее.</span><span class="sxs-lookup"><span data-stu-id="fc619-120">To design and implement health reporting, watchdogs and system components must:</span></span>

* <span data-ttu-id="fc619-121">Задать нужные условия, способ их отслеживания и влияние на работу кластера или приложения.</span><span class="sxs-lookup"><span data-stu-id="fc619-121">Define the condition they are interested in, the way it is monitored, and the impact on the cluster or application functionality.</span></span> <span data-ttu-id="fc619-122">На основе этих сведений определить свойство отчета о работоспособности и состояние работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-122">Based on this information, decide on the health report property and health state.</span></span>
* <span data-ttu-id="fc619-123">Определить [сущность](service-fabric-health-introduction.md#health-entities-and-hierarchy) , к которой применяется отчет.</span><span class="sxs-lookup"><span data-stu-id="fc619-123">Determine the [entity](service-fabric-health-introduction.md#health-entities-and-hierarchy) that the report applies to.</span></span>
* <span data-ttu-id="fc619-124">Указать, откуда должен выполняться отчет — из службы, внутреннего или внешнего устройства наблюдения.</span><span class="sxs-lookup"><span data-stu-id="fc619-124">Determine where the reporting is done, from within the service or from an internal or external watchdog.</span></span>
* <span data-ttu-id="fc619-125">Укажите источник, используемый для идентификации докладчика.</span><span class="sxs-lookup"><span data-stu-id="fc619-125">Define a source used to identify the reporter.</span></span>
* <span data-ttu-id="fc619-126">Выберите стратегию создания отчетов — периодическую или на основе переходов.</span><span class="sxs-lookup"><span data-stu-id="fc619-126">Choose a reporting strategy, either periodically or on transitions.</span></span> <span data-ttu-id="fc619-127">Рекомендуем выбирать периодическую отчетность, так как она требует более простого кода и меньше подвержена ошибкам.</span><span class="sxs-lookup"><span data-stu-id="fc619-127">The recommended way is periodically, as it requires simpler code and is less prone to errors.</span></span>
* <span data-ttu-id="fc619-128">Указать срок хранения отчетов о неработоспособности в хранилище данных о работоспособности и правила их очистки.</span><span class="sxs-lookup"><span data-stu-id="fc619-128">Determine how long the report for unhealthy conditions should stay in the health store and how it should be cleared.</span></span> <span data-ttu-id="fc619-129">На основе этой информации определить период существования отчета и необходимые действия по истечении срока хранения.</span><span class="sxs-lookup"><span data-stu-id="fc619-129">Using this information, decide the report's time to live and remove-on-expiration behavior.</span></span>

<span data-ttu-id="fc619-130">Как упоминалось выше, отчет могут создавать следующие компоненты.</span><span class="sxs-lookup"><span data-stu-id="fc619-130">As mentioned, reporting can be done from:</span></span>

* <span data-ttu-id="fc619-131">Отслеживаемая реплика службы Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="fc619-131">The monitored Service Fabric service replica.</span></span>
* <span data-ttu-id="fc619-132">Внутренние устройства наблюдения, развернутые как служба Service Fabric (например, служба без отслеживания состояния Service Fabric, которая проверяет условия и формирует отчеты).</span><span class="sxs-lookup"><span data-stu-id="fc619-132">Internal watchdogs deployed as a Service Fabric service (for example, a Service Fabric stateless service that monitors conditions and issues reports).</span></span> <span data-ttu-id="fc619-133">Модули наблюдения можно развернуть на всех узлах или сгруппировать с отслеживаемой службой</span><span class="sxs-lookup"><span data-stu-id="fc619-133">The watchdogs can be deployed an all nodes or can be affinitized to the monitored service.</span></span>
* <span data-ttu-id="fc619-134">Внутренние устройства наблюдения, которые запускаются на узлах Service Fabric, но *не* реализованы как службы Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="fc619-134">Internal watchdogs that run on the Service Fabric nodes but are *not* implemented as Service Fabric services.</span></span>
* <span data-ttu-id="fc619-135">Внешние устройства наблюдения, которые зондируют ресурс *за пределами* кластера Service Fabric (например, служба отслеживания Gomez и другие).</span><span class="sxs-lookup"><span data-stu-id="fc619-135">External watchdogs that probe the resource from *outside* the Service Fabric cluster (for example, monitoring service like Gomez).</span></span>

> [!NOTE]
> <span data-ttu-id="fc619-136">По умолчанию кластер заполняется отчетами о работоспособности, отправляемыми компонентами системы.</span><span class="sxs-lookup"><span data-stu-id="fc619-136">Out of the box, the cluster is populated with health reports sent by the system components.</span></span> <span data-ttu-id="fc619-137">Подробнее об этом читайте в статье [Использование отчетов о работоспособности системы для устранения неполадок](service-fabric-understand-and-troubleshoot-with-system-health-reports.md).</span><span class="sxs-lookup"><span data-stu-id="fc619-137">Read more at [Using system health reports for troubleshooting](service-fabric-understand-and-troubleshoot-with-system-health-reports.md).</span></span> <span data-ttu-id="fc619-138">Отчеты пользователей должны отправляться в [сущности работоспособности](service-fabric-health-introduction.md#health-entities-and-hierarchy) , которые уже созданы системой.</span><span class="sxs-lookup"><span data-stu-id="fc619-138">The user reports must be sent on [health entities](service-fabric-health-introduction.md#health-entities-and-hierarchy) that have already been created by the system.</span></span>
> 
> 

<span data-ttu-id="fc619-139">Если схема отчетности определена, отправлять отчеты о работоспособности очень просто.</span><span class="sxs-lookup"><span data-stu-id="fc619-139">Once the health reporting design is clear, health reports can be sent easily.</span></span> <span data-ttu-id="fc619-140">Для отправки отчетов о работоспособности можно использовать [FabricClient](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient), если кластер не является [безопасным](service-fabric-cluster-security.md) или клиент Service Fabric имеет привилегии администратора.</span><span class="sxs-lookup"><span data-stu-id="fc619-140">You can use [FabricClient](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient) to report health if the cluster is not [secure](service-fabric-cluster-security.md) or if the fabric client has admin privileges.</span></span> <span data-ttu-id="fc619-141">Это можно сделать через API с помощью [FabricClient.HealthManager.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth), через PowerShell или REST.</span><span class="sxs-lookup"><span data-stu-id="fc619-141">Reporting can be done through the API by using [FabricClient.HealthManager.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth), through PowerShell, or through REST.</span></span> <span data-ttu-id="fc619-142">Повысить производительность можно с помощью настройки пакетных отчетов.</span><span class="sxs-lookup"><span data-stu-id="fc619-142">Configuration knobs batch reports for improved performance.</span></span>

> [!NOTE]
> <span data-ttu-id="fc619-143">Отчеты о работоспособности синхронизированы, и они отображают только проверку на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="fc619-143">Report health is synchronous, and it represents only the validation work on the client side.</span></span> <span data-ttu-id="fc619-144">Когда отчет принимается клиентом работоспособности или объектами `Partition` или `CodePackageActivationContext`, он не сразу попадает в хранилище.</span><span class="sxs-lookup"><span data-stu-id="fc619-144">The fact that the report is accepted by the health client or the `Partition` or `CodePackageActivationContext` objects doesn't mean that it is applied in the store.</span></span> <span data-ttu-id="fc619-145">Он будет отправлен асинхронно и, возможно, объединен с другими отчетами.</span><span class="sxs-lookup"><span data-stu-id="fc619-145">It is sent asynchronously and possibly batched with other reports.</span></span> <span data-ttu-id="fc619-146">Возможно, обработка отчета на сервере не будет выполнена (из-за устаревшего порядкового номера, из-за удаления сущности, к которой должен применяться отчет, и т. д.).</span><span class="sxs-lookup"><span data-stu-id="fc619-146">The processing on the server may still fail: the sequence number could be stale, the entity on which the report must be applied has been deleted, etc.</span></span>
> 
> 

## <a name="health-client"></a><span data-ttu-id="fc619-147">Клиент работоспособности</span><span class="sxs-lookup"><span data-stu-id="fc619-147">Health client</span></span>
<span data-ttu-id="fc619-148">Отчеты о работоспособности отправляются в хранилище данных о работоспособности с помощью клиента работоспособности, который находится в клиенте Fabric.</span><span class="sxs-lookup"><span data-stu-id="fc619-148">The health reports are sent to the health store through a health client, which lives inside the fabric client.</span></span> <span data-ttu-id="fc619-149">Клиент работоспособности можно настроить с помощью приведенных ниже параметров.</span><span class="sxs-lookup"><span data-stu-id="fc619-149">The health client can be configured with the following settings:</span></span>

* <span data-ttu-id="fc619-150">**HealthReportSendInterval**. Задержка между временем добавления отчета в клиент и отправкой в хранилище данных о работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-150">**HealthReportSendInterval**: The delay between the time the report is added to the client and the time it is sent to the health store.</span></span> <span data-ttu-id="fc619-151">Она используется для отправки пакетных отчетов одним сообщением вместо отдельных сообщений для каждого отчета.</span><span class="sxs-lookup"><span data-stu-id="fc619-151">Used to batch reports into a single message, rather than sending one message for each report.</span></span> <span data-ttu-id="fc619-152">Пакетная обработка повышает производительность.</span><span class="sxs-lookup"><span data-stu-id="fc619-152">The batching improves performance.</span></span> <span data-ttu-id="fc619-153">Значение по умолчанию — 30 секунд.</span><span class="sxs-lookup"><span data-stu-id="fc619-153">Default: 30 seconds.</span></span>
* <span data-ttu-id="fc619-154">**HealthReportRetrySendInterval**. Интервал, через который клиент работоспособности повторно отправляет накопленные отчеты о работоспособности в хранилище данных о работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-154">**HealthReportRetrySendInterval**: The interval at which the health client resends accumulated health reports to the health store.</span></span> <span data-ttu-id="fc619-155">Значение по умолчанию — 30 секунд.</span><span class="sxs-lookup"><span data-stu-id="fc619-155">Default: 30 seconds.</span></span>
* <span data-ttu-id="fc619-156">**HealthOperationTimeout**. Время ожидания сообщения с отчетом, отправленного в хранилище данных о работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-156">**HealthOperationTimeout**: The timeout period for a report message sent to the health store.</span></span> <span data-ttu-id="fc619-157">После истечения времени ожидания клиент работоспособности будет повторять попытки, пока хранилище данных о работоспособности не подтвердит обработку отчета.</span><span class="sxs-lookup"><span data-stu-id="fc619-157">If a message times out, the health client retries it until the health store confirms that the report has been processed.</span></span> <span data-ttu-id="fc619-158">Значение по умолчанию — две минуты.</span><span class="sxs-lookup"><span data-stu-id="fc619-158">Default: two minutes.</span></span>

> [!NOTE]
> <span data-ttu-id="fc619-159">Чтобы отправить отчеты, объединенные в пакеты, клиент Fabric должен работать как минимум на протяжении времени, указанного в HealthReportSendInterval.</span><span class="sxs-lookup"><span data-stu-id="fc619-159">When the reports are batched, the fabric client must be kept alive for at least the HealthReportSendInterval to ensure that they are sent.</span></span> <span data-ttu-id="fc619-160">Если сообщение утеряно или хранилищу данных о работоспособности не удалось применить его из-за временных ошибок, клиент Fabric должен работать дольше, чтобы стала возможной повторная попытка.</span><span class="sxs-lookup"><span data-stu-id="fc619-160">If the message is lost or the health store cannot apply them due to transient errors, the fabric client must be kept alive longer to give it a chance to retry.</span></span>
> 
> 

<span data-ttu-id="fc619-161">Буферизация на клиенте выполняется с учетом уникальности отчетов.</span><span class="sxs-lookup"><span data-stu-id="fc619-161">The buffering on the client takes the uniqueness of the reports into consideration.</span></span> <span data-ttu-id="fc619-162">Например, если какой-либо неисправный информатор отправляет 100 отчетов в секунду для одного свойства одной сущности, будет использоваться только последняя версия отчета.</span><span class="sxs-lookup"><span data-stu-id="fc619-162">For example, if a particular bad reporter is reporting 100 reports per second on the same property of the same entity, the reports are replaced with the last version.</span></span> <span data-ttu-id="fc619-163">В очереди клиента существует только один такой отчет.</span><span class="sxs-lookup"><span data-stu-id="fc619-163">At most one such report exists in the client queue.</span></span> <span data-ttu-id="fc619-164">Если настроена пакетная обработка, в хранилище данных о работоспособности за один интервал отправки будет отправляться только один отчет.</span><span class="sxs-lookup"><span data-stu-id="fc619-164">If batching is configured, the number of reports sent to the health store is just one per send interval.</span></span> <span data-ttu-id="fc619-165">Используется последний добавленный отчет, который отображает актуальное состояние сущности.</span><span class="sxs-lookup"><span data-stu-id="fc619-165">This report is the last added report, which reflects the most current state of the entity.</span></span>
<span data-ttu-id="fc619-166">Параметры настройки можно указать при создании `FabricClient`. Для этого необходимо передать объект [FabricClientSettings](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclientsettings) с нужными значениями параметров, связанных с работоспособностью.</span><span class="sxs-lookup"><span data-stu-id="fc619-166">Specify configuration parameters when `FabricClient` is created by passing [FabricClientSettings](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclientsettings) with the desired values for health-related entries.</span></span>

<span data-ttu-id="fc619-167">В следующем примере создается клиент структуры, отчеты которого должны отправляться сразу после их добавления.</span><span class="sxs-lookup"><span data-stu-id="fc619-167">The following example creates a fabric client and specifies that the reports should be sent when they are added.</span></span> <span data-ttu-id="fc619-168">Если при повторных попытках возникают ошибки или превышено время ожидания, попытки повторяются каждые 40 секунд.</span><span class="sxs-lookup"><span data-stu-id="fc619-168">On timeouts and errors that can be retried, retries happen every 40 seconds.</span></span>

```csharp
var clientSettings = new FabricClientSettings()
{
    HealthOperationTimeout = TimeSpan.FromSeconds(120),
    HealthReportSendInterval = TimeSpan.FromSeconds(0),
    HealthReportRetrySendInterval = TimeSpan.FromSeconds(40),
};
var fabricClient = new FabricClient(clientSettings);
```

<span data-ttu-id="fc619-169">Рекомендуется оставить параметры клиента структуры по умолчанию, в которых значение `HealthReportSendInterval` равно 30 секундам.</span><span class="sxs-lookup"><span data-stu-id="fc619-169">We recommend keeping the default fabric client settings, which set `HealthReportSendInterval` to 30 seconds.</span></span> <span data-ttu-id="fc619-170">Этот параметр обеспечивает оптимальную производительность ввиду пакетной обработки.</span><span class="sxs-lookup"><span data-stu-id="fc619-170">This setting ensures optimal performance due to batching.</span></span> <span data-ttu-id="fc619-171">Для критических отчетов, которые должны отправляться как можно быстрее, используйте `HealthReportSendOptions` с флагом Immediate, имеющим значение `true`, в API [FabricClient.HealthClient.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth).</span><span class="sxs-lookup"><span data-stu-id="fc619-171">For critical reports that must be sent as soon as possible, use `HealthReportSendOptions` with Immediate `true` in [FabricClient.HealthClient.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth) API.</span></span> <span data-ttu-id="fc619-172">Немедленные отчеты игнорируют интервал пакетной обработки.</span><span class="sxs-lookup"><span data-stu-id="fc619-172">Immediate reports bypass the batching interval.</span></span> <span data-ttu-id="fc619-173">Этот флаг следует использовать с осторожностью. Нам нужно использовать преимущества пакетной обработки клиента работоспособности, когда это возможно.</span><span class="sxs-lookup"><span data-stu-id="fc619-173">Use this flag with care; we want to take advantage of the health client batching whenever possible.</span></span> <span data-ttu-id="fc619-174">Немедленная отправка также удобна при закрытии клиента (например, процесс определил недопустимое состояние и должен быть завершен, чтобы предотвратить побочные эффекты).</span><span class="sxs-lookup"><span data-stu-id="fc619-174">Immediate send is also useful when the fabric client is closing (for example, the process has determined invalid state and needs to shut down to prevent side effects).</span></span> <span data-ttu-id="fc619-175">Это гарантирует наилучшую отправку накопленных отчетов.</span><span class="sxs-lookup"><span data-stu-id="fc619-175">It ensures a best-effort send of the accumulated reports.</span></span> <span data-ttu-id="fc619-176">При добавлении одного отчета с флагом Immediate клиент работоспособности выполняет пакетную обработку всех отчетов, накопленных с момента последней отправки.</span><span class="sxs-lookup"><span data-stu-id="fc619-176">When one report is added with Immediate flag, the health client batches all the accumulated reports since last send.</span></span>

<span data-ttu-id="fc619-177">Такие же параметры можно задать во время создания подключения к кластеру через PowerShell.</span><span class="sxs-lookup"><span data-stu-id="fc619-177">Same parameters can be specified when a connection to a cluster is created through PowerShell.</span></span> <span data-ttu-id="fc619-178">Приведенный ниже пример запускает подключение к локальному кластеру.</span><span class="sxs-lookup"><span data-stu-id="fc619-178">The following example starts a connection to a local cluster:</span></span>

```powershell
PS C:\> Connect-ServiceFabricCluster -HealthOperationTimeoutInSec 120 -HealthReportSendIntervalInSec 0 -HealthReportRetrySendIntervalInSec 40
True

ConnectionEndpoint   :
FabricClientSettings : {
                       ClientFriendlyName                   : PowerShell-1944858a-4c6d-465f-89c7-9021c12ac0bb
                       PartitionLocationCacheLimit          : 100000
                       PartitionLocationCacheBucketCount    : 1024
                       ServiceChangePollInterval            : 00:02:00
                       ConnectionInitializationTimeout      : 00:00:02
                       KeepAliveInterval                    : 00:00:20
                       HealthOperationTimeout               : 00:02:00
                       HealthReportSendInterval             : 00:00:00
                       HealthReportRetrySendInterval        : 00:00:40
                       NotificationGatewayConnectionTimeout : 00:00:00
                       NotificationCacheUpdateTimeout       : 00:00:00
                       }
GatewayInformation   : {
                       NodeAddress                          : localhost:19000
                       NodeId                               : 1880ec88a3187766a6da323399721f53
                       NodeInstanceId                       : 130729063464981219
                       NodeName                             : Node.1
                       }
```

<span data-ttu-id="fc619-179">Как и в случае API, отчеты можно немедленно отправлять с помощью параметра `-Immediate`, вне зависимости от значения `HealthReportSendInterval`.</span><span class="sxs-lookup"><span data-stu-id="fc619-179">Similarly to API, reports can be sent using `-Immediate` switch to be sent immediately, regardless of the `HealthReportSendInterval` value.</span></span>

<span data-ttu-id="fc619-180">В случае REST отчеты отправляются в шлюз Service Fabric с внутренним клиентом структуры.</span><span class="sxs-lookup"><span data-stu-id="fc619-180">For REST, the reports are sent to the Service Fabric gateway, which has an internal fabric client.</span></span> <span data-ttu-id="fc619-181">По умолчанию этот клиент настроен для отправки отчетов в пакетном режиме каждые 30 секунд.</span><span class="sxs-lookup"><span data-stu-id="fc619-181">By default, this client is configured to send reports batched every 30 seconds.</span></span> <span data-ttu-id="fc619-182">Интервал пакетной отправки можно изменить с помощью параметра конфигурации кластера `HttpGatewayHealthReportSendInterval` в `HttpGateway`.</span><span class="sxs-lookup"><span data-stu-id="fc619-182">You can change the batch interval with the cluster configuration setting `HttpGatewayHealthReportSendInterval` on `HttpGateway`.</span></span> <span data-ttu-id="fc619-183">Как уже упоминалось выше, лучшим вариантом будет отправлять отчеты, указав для `Immediate` значение true.</span><span class="sxs-lookup"><span data-stu-id="fc619-183">As mentioned, a better option is to send the reports with `Immediate` true.</span></span> 

> [!NOTE]
> <span data-ttu-id="fc619-184">Чтобы запретить неавторизованным службам отправлять отчеты о работоспособности сущностям в кластере, на сервере можно настроить прием запросов только от надежных клиентов.</span><span class="sxs-lookup"><span data-stu-id="fc619-184">To ensure that unauthorized services can't report health against the entities in the cluster, configure the server to accept requests only from secured clients.</span></span> <span data-ttu-id="fc619-185">Так как отчеты отправляются с помощью `FabricClient` , для связи с кластером необходимо включить защиту (например проверку подлинности Kerberos или проверку подлинности на основе сертификата).</span><span class="sxs-lookup"><span data-stu-id="fc619-185">The `FabricClient` used for reporting must have security enabled to be able to communicate with the cluster (for example, with Kerberos or certificate authentication).</span></span> <span data-ttu-id="fc619-186">Ознакомьтесь с дополнительными сведениями о [безопасности кластера](service-fabric-cluster-security.md).</span><span class="sxs-lookup"><span data-stu-id="fc619-186">Read more about [cluster security](service-fabric-cluster-security.md).</span></span>
> 
> 

## <a name="report-from-within-low-privilege-services"></a><span data-ttu-id="fc619-187">Создание отчета из служб с низким уровнем привилегий</span><span class="sxs-lookup"><span data-stu-id="fc619-187">Report from within low privilege services</span></span>
<span data-ttu-id="fc619-188">Если службы Service Fabric не имеют административного доступа к кластеру, можно передать сведения о работоспособности сущностей из текущего контекста с помощью `Partition` или `CodePackageActivationContext`.</span><span class="sxs-lookup"><span data-stu-id="fc619-188">If Service Fabric services do not have admin access to the cluster, you can report health on entities from the current context through `Partition` or `CodePackageActivationContext`.</span></span>

* <span data-ttu-id="fc619-189">Для служб без отслеживания состояния используйте [IStatelessServicePartition.ReportInstanceHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatelessservicepartition.reportinstancehealth) , чтобы сформировать отчет о текущем экземпляре службы.</span><span class="sxs-lookup"><span data-stu-id="fc619-189">For stateless services, use [IStatelessServicePartition.ReportInstanceHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatelessservicepartition.reportinstancehealth) to report on the current service instance.</span></span>
* <span data-ttu-id="fc619-190">Для служб с отслеживанием состояния используйте [IStatefulServicePartition.ReportReplicaHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatefulservicepartition.reportreplicahealth) , чтобы сформировать отчет о текущей реплике.</span><span class="sxs-lookup"><span data-stu-id="fc619-190">For stateful services, use [IStatefulServicePartition.ReportReplicaHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatefulservicepartition.reportreplicahealth) to report on current replica.</span></span>
* <span data-ttu-id="fc619-191">Используйте [IServicePartition.ReportPartitionHealth](https://docs.microsoft.com/dotnet/api/system.fabric.iservicepartition.reportpartitionhealth) для создания отчетов о текущей сущности секции.</span><span class="sxs-lookup"><span data-stu-id="fc619-191">Use [IServicePartition.ReportPartitionHealth](https://docs.microsoft.com/dotnet/api/system.fabric.iservicepartition.reportpartitionhealth) to report on the current partition entity.</span></span>
* <span data-ttu-id="fc619-192">Используйте [CodePackageActivationContext.ReportApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportapplicationhealth) для формирования отчета о текущем приложении.</span><span class="sxs-lookup"><span data-stu-id="fc619-192">Use [CodePackageActivationContext.ReportApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportapplicationhealth) to report on current application.</span></span>
* <span data-ttu-id="fc619-193">Используйте [CodePackageActivationContext.ReportDeployedApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedapplicationhealth) для создания отчетов о текущем приложении, развернутом на текущем узле.</span><span class="sxs-lookup"><span data-stu-id="fc619-193">Use [CodePackageActivationContext.ReportDeployedApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedapplicationhealth) to report on the current application deployed on the current node.</span></span>
* <span data-ttu-id="fc619-194">Используйте [CodePackageActivationContext.ReportDeployedServicePackageHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedservicepackagehealth) для создания отчетов о пакете службы для приложения, развернутого на текущем узле.</span><span class="sxs-lookup"><span data-stu-id="fc619-194">Use [CodePackageActivationContext.ReportDeployedServicePackageHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedservicepackagehealth) to report on a service package for the application deployed on the current node.</span></span>

> [!NOTE]
> <span data-ttu-id="fc619-195">На внутреннем уровне `Partition` и `CodePackageActivationContext` содержат клиент работоспособности, для которого настроены параметры по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="fc619-195">Internally, the `Partition` and the `CodePackageActivationContext` hold a health client configured with default settings.</span></span> <span data-ttu-id="fc619-196">Как указано в описании [клиента работоспособности](service-fabric-report-health.md#health-client), отчеты обрабатываются в пакетном режиме и отправляются по таймеру.</span><span class="sxs-lookup"><span data-stu-id="fc619-196">As explained for the [health client](service-fabric-report-health.md#health-client), reports are batched and sent on a timer.</span></span> <span data-ttu-id="fc619-197">Объекты должны функционировать, чтобы иметь возможность отправить отчет.</span><span class="sxs-lookup"><span data-stu-id="fc619-197">The objects should be kept alive to have a chance to send the report.</span></span>
> 
> 

<span data-ttu-id="fc619-198">Можно указать `HealthReportSendOptions` при отправке отчетов с помощью интерфейсов API работоспособности `Partition` и `CodePackageActivationContext`.</span><span class="sxs-lookup"><span data-stu-id="fc619-198">You can specify `HealthReportSendOptions` when sending reports through `Partition` and `CodePackageActivationContext` health APIs.</span></span> <span data-ttu-id="fc619-199">При наличии критических отчетов, которые должны отправляться как можно быстрее, используйте `HealthReportSendOptions` с флагом Immediate, имеющим значение `true`.</span><span class="sxs-lookup"><span data-stu-id="fc619-199">If you have critical reports that must be sent as soon as possible, use `HealthReportSendOptions` with Immediate `true`.</span></span> <span data-ttu-id="fc619-200">Немедленные отчеты игнорируют интервал пакетной обработки внутреннего клиента работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-200">Immediate reports bypass the batching interval of the internal health client.</span></span> <span data-ttu-id="fc619-201">Как упоминалось выше, этот флаг следует использовать с осторожностью. Нам нужно использовать преимущества пакетной обработки клиента работоспособности, когда это возможно.</span><span class="sxs-lookup"><span data-stu-id="fc619-201">As mentioned before, use this flag with care; we want to take advantage of the health client batching whenever possible.</span></span>

## <a name="design-health-reporting"></a><span data-ttu-id="fc619-202">Создание отчета о работоспособности</span><span class="sxs-lookup"><span data-stu-id="fc619-202">Design health reporting</span></span>
<span data-ttu-id="fc619-203">Первым шагом в создании высококачественных отчетов является определение условий, которые могут повлиять на работоспособность службы.</span><span class="sxs-lookup"><span data-stu-id="fc619-203">The first step in generating high-quality reports is identifying the conditions that can impact the health of the service.</span></span> <span data-ttu-id="fc619-204">Если условие может помочь найти проблемы в службе или кластере при их запуске (или, что еще лучше, выявить проблемы до их возникновения), оно потенциально может сохранить миллиарды долларов.</span><span class="sxs-lookup"><span data-stu-id="fc619-204">Any condition that can help flag problems in the service or cluster when it starts--or even better, before a problem happens--can potentially save billions of dollars.</span></span> <span data-ttu-id="fc619-205">Вы получите следующие преимущества: меньшее время простоя, меньше ночей, потраченных на анализ и устранение проблем, и высокое качество обслуживания клиентов.</span><span class="sxs-lookup"><span data-stu-id="fc619-205">The benefits include less down time, fewer night hours spent investigating and repairing issues, and higher customer satisfaction.</span></span>

<span data-ttu-id="fc619-206">После задания условий создателям устройств наблюдения нужно выбрать лучший способ отслеживания, чтобы найти баланс между нагрузкой и пользой.</span><span class="sxs-lookup"><span data-stu-id="fc619-206">Once the conditions are identified, watchdog writers need to figure out the best way to monitor them for balance between overhead and usefulness.</span></span> <span data-ttu-id="fc619-207">Например, рассмотрим службу, которая выполняет сложные вычисления, используя некоторые временные файлы в общей папке.</span><span class="sxs-lookup"><span data-stu-id="fc619-207">For example, consider a service that does complex calculations that use some temporary files on a share.</span></span> <span data-ttu-id="fc619-208">Устройство наблюдения может отслеживать общую папку на наличие в ней достаточного объема свободного места.</span><span class="sxs-lookup"><span data-stu-id="fc619-208">A watchdog could monitor the share to ensure that enough space is available.</span></span> <span data-ttu-id="fc619-209">Оно может отслеживать уведомления об изменении файла или каталога.</span><span class="sxs-lookup"><span data-stu-id="fc619-209">It could listen for notifications of file or directory changes.</span></span> <span data-ttu-id="fc619-210">Модуль наблюдения может также отправлять предупреждение при приближении к порогу и сообщать об ошибке, если общедоступный ресурс заполнен.</span><span class="sxs-lookup"><span data-stu-id="fc619-210">It could report a warning if an upfront threshold is reached, and report an error if the share is full.</span></span> <span data-ttu-id="fc619-211">Получив предупреждение, система восстановления может запустить очистку старых файлов в общей папке.</span><span class="sxs-lookup"><span data-stu-id="fc619-211">On a warning, a repair system could start cleaning up older files on the share.</span></span> <span data-ttu-id="fc619-212">Получив сообщение об ошибке, система восстановления может переместить реплику службы на другой узел.</span><span class="sxs-lookup"><span data-stu-id="fc619-212">On an error, a repair system could move the service replica to another node.</span></span> <span data-ttu-id="fc619-213">Обратите внимание, что состояния условий описаны с точки зрения работоспособности: обращается внимание на то, какое состояние условия можно считать работоспособным ("ОК"), а какое нет (предупреждение или ошибка).</span><span class="sxs-lookup"><span data-stu-id="fc619-213">Note how the condition states are described in terms of health: the state of the condition that can be considered healthy (ok) or unhealthy (warning or error).</span></span>

<span data-ttu-id="fc619-214">После настройки сведений об отслеживании создатель устройства наблюдения должен определить, как реализовать устройство.</span><span class="sxs-lookup"><span data-stu-id="fc619-214">Once the monitoring details are set, a watchdog writer needs to figure out how to implement the watchdog.</span></span> <span data-ttu-id="fc619-215">Если условия можно определить из службы, модуль отслеживания может быть интегрирован в отслеживаемую службу.</span><span class="sxs-lookup"><span data-stu-id="fc619-215">If the conditions can be determined from within the service, the watchdog can be part of the monitored service itself.</span></span> <span data-ttu-id="fc619-216">Например, код службы может проверять использование общедоступного ресурса и отправлять отчет каждый раз при попытке записать файл.</span><span class="sxs-lookup"><span data-stu-id="fc619-216">For example, the service code can check the share usage, and then report every time it tries to write a file.</span></span> <span data-ttu-id="fc619-217">Преимущество такого подхода заключается в простоте отчетности.</span><span class="sxs-lookup"><span data-stu-id="fc619-217">The advantage of this approach is that reporting is simple.</span></span> <span data-ttu-id="fc619-218">Однако будьте осторожны. Следите за тем, чтобы ошибки в модуле наблюдения не влияли на работу службы.</span><span class="sxs-lookup"><span data-stu-id="fc619-218">Care must be taken to prevent watchdog bugs from impacting the service functionality.</span></span>

<span data-ttu-id="fc619-219">Создание отчетов в отслеживаемой службе не всегда целесообразно.</span><span class="sxs-lookup"><span data-stu-id="fc619-219">Reporting from within the monitored service is not always an option.</span></span> <span data-ttu-id="fc619-220">Устройство наблюдения в службе может не обнаружить условия.</span><span class="sxs-lookup"><span data-stu-id="fc619-220">A watchdog within the service may not be able to detect the conditions.</span></span> <span data-ttu-id="fc619-221">Оно может не иметь логики или данных для их определения.</span><span class="sxs-lookup"><span data-stu-id="fc619-221">It may not have the logic or data to make the determination.</span></span> <span data-ttu-id="fc619-222">Накладные затраты на отслеживание условий могут быть высокими.</span><span class="sxs-lookup"><span data-stu-id="fc619-222">The overhead of monitoring the conditions may be high.</span></span> <span data-ttu-id="fc619-223">Условия могут быть не характерными для службы, а касаться взаимодействия между службами.</span><span class="sxs-lookup"><span data-stu-id="fc619-223">The conditions also may not be specific to a service, but instead affect interactions between services.</span></span> <span data-ttu-id="fc619-224">Другой вариант — использовать устройства наблюдения в кластере как отдельные процессы.</span><span class="sxs-lookup"><span data-stu-id="fc619-224">Another option is to have watchdogs in the cluster as separate processes.</span></span> <span data-ttu-id="fc619-225">Модули наблюдения отслеживают условия и отправляют отчеты, никак не затрагивая основные службы.</span><span class="sxs-lookup"><span data-stu-id="fc619-225">The watchdogs monitor the conditions and report, without affecting the main services in any way.</span></span> <span data-ttu-id="fc619-226">Эти устройства можно реализовать, к примеру, как службы без отслеживания состояния в одном приложении, развернуть на всех узлах или на одних тех же узлах как службу.</span><span class="sxs-lookup"><span data-stu-id="fc619-226">For example, these watchdogs could be implemented as stateless services in the same application, deployed on all nodes or on the same nodes as the service.</span></span>

<span data-ttu-id="fc619-227">В некоторых случаях нецелесообразно использовать устройства наблюдения, выполняющиеся в кластере.</span><span class="sxs-lookup"><span data-stu-id="fc619-227">Sometimes, a watchdog running in the cluster is not an option either.</span></span> <span data-ttu-id="fc619-228">Если отслеживаемыми условиями выступает доступность или функциональность службы с точки зрения пользователей, лучше размещать устройства наблюдения там же, где находятся пользовательские клиенты.</span><span class="sxs-lookup"><span data-stu-id="fc619-228">If the monitored condition is the availability or functionality of the service as users see it, it's best to have the watchdogs in the same place as the user clients.</span></span> <span data-ttu-id="fc619-229">Тогда они смогут тестировать операции так же, как их вызывают пользователи.</span><span class="sxs-lookup"><span data-stu-id="fc619-229">There, they can test the operations in the same way users call them.</span></span> <span data-ttu-id="fc619-230">Например, у вас может быть модуль наблюдения, который находится за пределами кластера и отправляет запросы службе, а затем проверяет задержку и правильность результата.</span><span class="sxs-lookup"><span data-stu-id="fc619-230">For example, you can have a watchdog that lives outside the cluster, issues requests to the service, and checks the latency and correctness of the result.</span></span> <span data-ttu-id="fc619-231">(Например, запрос к службе калькулятора: возвращает ли 2 + 2 результат 4 в разумные сроки?)</span><span class="sxs-lookup"><span data-stu-id="fc619-231">(For a calculator service, for example, does 2+2 return 4 in a reasonable amount of time?)</span></span>

<span data-ttu-id="fc619-232">Когда разработка устройства наблюдения завершена, выберите идентификатор источника, который однозначно идентифицирует его.</span><span class="sxs-lookup"><span data-stu-id="fc619-232">Once the watchdog details have been finalized, you should decide on a source ID that uniquely identifies it.</span></span> <span data-ttu-id="fc619-233">Если в кластере имеется несколько модулей наблюдения одинакового типа, они должны отправлять отчеты о различных сущностях либо, если они отправляют отчеты об одной и той же сущности, они должны использовать разные идентификаторы или свойства источника.</span><span class="sxs-lookup"><span data-stu-id="fc619-233">If multiple watchdogs of the same type are living in the cluster, they must report on different entities, or, if they report on the same entity, use different source ID or property.</span></span> <span data-ttu-id="fc619-234">Убедитесь, что свойства или идентификаторы источника отличаются.</span><span class="sxs-lookup"><span data-stu-id="fc619-234">This way, their reports can coexist.</span></span> <span data-ttu-id="fc619-235">Так отчеты смогут сосуществовать.</span><span class="sxs-lookup"><span data-stu-id="fc619-235">The property of the health report should capture the monitored condition.</span></span> <span data-ttu-id="fc619-236">(В примере выше это может быть свойство **ShareSize**.) Если к одному условию применяется множество отчетов, в свойстве должны содержаться некоторые динамические сведения, чтобы отчеты могли сосуществовать.</span><span class="sxs-lookup"><span data-stu-id="fc619-236">(For the example above, the property could be **ShareSize**.) If multiple reports apply to the same condition, the property should contain some dynamic information that allows reports to coexist.</span></span> <span data-ttu-id="fc619-237">Например, при наличии нескольких общих папок, которые нужно отслеживать, имя свойства может быть **ShareSize-имя_общей_папки**.</span><span class="sxs-lookup"><span data-stu-id="fc619-237">For example, if multiple shares need to be monitored, the property name can be **ShareSize-sharename**.</span></span>

> [!NOTE]
> <span data-ttu-id="fc619-238">*Не* используйте хранилище данных о работоспособности для хранения сведений о состоянии.</span><span class="sxs-lookup"><span data-stu-id="fc619-238">Do *not* use the health store to keep status information.</span></span> <span data-ttu-id="fc619-239">В хранилище должны поступать только сведения, связанные с работоспособностью, которые влияют на оценку работоспособности сущности.</span><span class="sxs-lookup"><span data-stu-id="fc619-239">Only health-related information should be reported as health, as this information impacts the health evaluation of an entity.</span></span> <span data-ttu-id="fc619-240">Хранилище данных о работоспособности не является хранилищем общего назначения.</span><span class="sxs-lookup"><span data-stu-id="fc619-240">The health store was not designed as a general-purpose store.</span></span> <span data-ttu-id="fc619-241">Оно использует логику оценки работоспособности для сбора всех данных в состояние работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-241">It uses health evaluation logic to aggregate all data into the health state.</span></span> <span data-ttu-id="fc619-242">Отправка сведений, не связанных с работоспособностью (например, сообщений с состоянием работоспособности "ОК"), не повлияет на сводное состояние работоспособности. Но это может отрицательно сказаться на производительности хранилища данных о работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-242">Sending information unrelated to health (like reporting status with a health state of OK) doesn't impact the aggregated health state, but it can negatively affect the performance of the health store.</span></span>
> 
> 

<span data-ttu-id="fc619-243">Следующий вопрос: какие сущности включать в отчет.</span><span class="sxs-lookup"><span data-stu-id="fc619-243">The next decision point is which entity to report on.</span></span> <span data-ttu-id="fc619-244">Большую часть времени условие четко определяет сущность.</span><span class="sxs-lookup"><span data-stu-id="fc619-244">Most of the time, the condition clearly idetifies the entity.</span></span> <span data-ttu-id="fc619-245">Выберите сущность с наиболее оптимальной степенью детализации.</span><span class="sxs-lookup"><span data-stu-id="fc619-245">Choose the entity with best possible granularity.</span></span> <span data-ttu-id="fc619-246">Если условие влияет на все реплики в разделе, отправляется отчет о разделе, а не о службе.</span><span class="sxs-lookup"><span data-stu-id="fc619-246">If a condition impacts all replicas in a partition, report on the partition, not on the service.</span></span> <span data-ttu-id="fc619-247">Хотя бывают и патологические случаи, когда принять решение сложно.</span><span class="sxs-lookup"><span data-stu-id="fc619-247">There are corner cases where more thought is needed, though.</span></span> <span data-ttu-id="fc619-248">Если условие влияет на сущность (например, реплику), но его нужно помечать дольше, чем жизненный цикл реплики, должен отправляться отчет о разделе.</span><span class="sxs-lookup"><span data-stu-id="fc619-248">If the condition impacts an entity, such as a replica, but the desire is to have the condition flagged for more than the duration of replica life, then it should be reported on the partition.</span></span> <span data-ttu-id="fc619-249">В противном случае при удалении реплики хранилище данных о работоспособности очистит все отчеты о ней.</span><span class="sxs-lookup"><span data-stu-id="fc619-249">Otherwise, when the replica is deleted, the health store cleans up all its reports.</span></span> <span data-ttu-id="fc619-250">Разработчикам модулей наблюдения следует также подумать о времени существования сущности и отчета.</span><span class="sxs-lookup"><span data-stu-id="fc619-250">Watchdog writers must think about the lifetimes of the entity and the report.</span></span> <span data-ttu-id="fc619-251">Должно быть понятно, когда отчет нужно удалять из хранилища (например, когда теряет актуальность ошибка, зафиксированная для сущности).</span><span class="sxs-lookup"><span data-stu-id="fc619-251">It must be clear when a report should be cleaned up from a store (for example, when an error reported on an entity no longer applies).</span></span>

<span data-ttu-id="fc619-252">Рассмотрим пример, чтобы лучше понять все описанное выше.</span><span class="sxs-lookup"><span data-stu-id="fc619-252">Let's look at an example that puts together the points I described.</span></span> <span data-ttu-id="fc619-253">У нас есть приложение Service Fabric, которое состоит из главной службы с отслеживанием состояния и дополнительных служб без отслеживания состояния, развернутых на всех узлах (один тип дополнительной службы для одного типа задачи).</span><span class="sxs-lookup"><span data-stu-id="fc619-253">Consider a Service Fabric application composed of a master stateful persistent service and secondary stateless services deployed on all nodes (one secondary service type for each type of task).</span></span> <span data-ttu-id="fc619-254">Главная служба имеет очередь обработки команд, которые выполняются дополнительными службами.</span><span class="sxs-lookup"><span data-stu-id="fc619-254">The master has a processing queue that contains commands to be executed by secondaries.</span></span> <span data-ttu-id="fc619-255">Дополнительные службы выполняют полученные запросы и отправляют подтверждения.</span><span class="sxs-lookup"><span data-stu-id="fc619-255">The secondaries execute the incoming requests and send back acknowledgement signals.</span></span> <span data-ttu-id="fc619-256">Может отслеживаться только одно условие — длина очереди обработки главной службы.</span><span class="sxs-lookup"><span data-stu-id="fc619-256">One condition that could be monitored is the length of the master processing queue.</span></span> <span data-ttu-id="fc619-257">Если длина очереди главной службы достигает порогового значения, отображается предупреждение.</span><span class="sxs-lookup"><span data-stu-id="fc619-257">If the master queue length reaches a threshold, a warning is reported.</span></span> <span data-ttu-id="fc619-258">Оно означает, что дополнительные службы не могут справиться с нагрузкой.</span><span class="sxs-lookup"><span data-stu-id="fc619-258">The warning indicates that the secondaries can't handle the load.</span></span> <span data-ttu-id="fc619-259">Если очередь достигла максимальной длины и команды удаляются, отображается сообщение об ошибке, так как служба не может восстановить удаленные команды.</span><span class="sxs-lookup"><span data-stu-id="fc619-259">If the queue reaches the maximum length and commands are dropped, an error is reported, as the service can't recover.</span></span> <span data-ttu-id="fc619-260">Отчеты могут содержать сведения о свойстве **QueueStatus**.</span><span class="sxs-lookup"><span data-stu-id="fc619-260">The reports can be on the property **QueueStatus**.</span></span> <span data-ttu-id="fc619-261">Устройство наблюдения находится в службе и периодически отправляется в основной реплике главной службы.</span><span class="sxs-lookup"><span data-stu-id="fc619-261">The watchdog lives inside the service, and it's sent periodically on the master primary replica.</span></span> <span data-ttu-id="fc619-262">Срок жизни составляет две минуты с периодической отправкой каждые 30 секунд.</span><span class="sxs-lookup"><span data-stu-id="fc619-262">The time to live is two minutes, and it's sent periodically every 30 seconds.</span></span> <span data-ttu-id="fc619-263">Если основная реплика выходит из строя, отчет автоматически удаляется из хранилища.</span><span class="sxs-lookup"><span data-stu-id="fc619-263">If the primary goes down, the report is cleaned up automatically from store.</span></span> <span data-ttu-id="fc619-264">Если реплика службы работает, но заблокирована или имеет другие проблемы, истечет срок хранения отчета в хранилище данных.</span><span class="sxs-lookup"><span data-stu-id="fc619-264">If the service replica is up, but it is deadlocked or having other issues, the report expires in the health store.</span></span> <span data-ttu-id="fc619-265">В таком случае сущность получит состояние "Ошибка".</span><span class="sxs-lookup"><span data-stu-id="fc619-265">In this case, the entity is evaluated at error.</span></span>

<span data-ttu-id="fc619-266">Другое условие, которое можно отслеживать, — время выполнения задачи.</span><span class="sxs-lookup"><span data-stu-id="fc619-266">Another condition that can be monitored is task execution time.</span></span> <span data-ttu-id="fc619-267">Главная служба распределяет задачи для дополнительных служб в зависимости от типа задач.</span><span class="sxs-lookup"><span data-stu-id="fc619-267">The master distributes tasks to the secondaries based on the task type.</span></span> <span data-ttu-id="fc619-268">В зависимости от структуры главная служба может опрашивать дополнительные службы о состоянии задач.</span><span class="sxs-lookup"><span data-stu-id="fc619-268">Depending on the design, the master could poll the secondaries for task status.</span></span> <span data-ttu-id="fc619-269">Кроме этого, она также может ожидать от дополнительных служб подтверждения о завершении.</span><span class="sxs-lookup"><span data-stu-id="fc619-269">It could also wait for secondaries to send back acknowledgement signals when they are done.</span></span> <span data-ttu-id="fc619-270">Во втором случае необходимо внимательно следить, чтобы не пропустить ситуации, когда останавливаются дополнительные службы или теряются сообщения.</span><span class="sxs-lookup"><span data-stu-id="fc619-270">In the second case, care must be taken to detect situations where secondaries die or messages are lost.</span></span> <span data-ttu-id="fc619-271">Один из вариантов — отправка главной службой запроса проверки связи одной и той же дополнительной службе для получения ответа о состоянии.</span><span class="sxs-lookup"><span data-stu-id="fc619-271">One option is for the master to send a ping request to the same secondary, which sends back its status.</span></span> <span data-ttu-id="fc619-272">Если состояние не получено, главная служба считает, что случился сбой, и переназначает задачу.</span><span class="sxs-lookup"><span data-stu-id="fc619-272">If no status is received, the master considers it a failure and reschedules the task.</span></span> <span data-ttu-id="fc619-273">При этом предполагается, что задачи являются идемпотентными.</span><span class="sxs-lookup"><span data-stu-id="fc619-273">This behavior assumes that the tasks are idempotent.</span></span>

<span data-ttu-id="fc619-274">Для отслеживаемого условия может быть установлен статус "Предупреждение", если задача не выполняется за определенное время (например, период**t1**продолжительностью 10 минут).</span><span class="sxs-lookup"><span data-stu-id="fc619-274">The monitored condition can be translated as a warning if the task is not done in a certain time (**t1**, for example 10 minutes).</span></span> <span data-ttu-id="fc619-275">Если задача не будет выполнена вовремя (например, за период**t2**продолжительностью 20 минут), отслеживаемое условие может получить состояние "Ошибка".</span><span class="sxs-lookup"><span data-stu-id="fc619-275">If the task is not completed in time (**t2**, for example 20 minutes), the monitored condition can be translated as Error.</span></span> <span data-ttu-id="fc619-276">Отчеты можно отправлять несколькими способами.</span><span class="sxs-lookup"><span data-stu-id="fc619-276">This reporting can be done in multiple ways:</span></span>

* <span data-ttu-id="fc619-277">Основная реплика главной службы периодически отправляет отчеты о себе.</span><span class="sxs-lookup"><span data-stu-id="fc619-277">The master primary replica reports on itself periodically.</span></span> <span data-ttu-id="fc619-278">Вы можете задать одно свойство для всех ожидающих задач в очереди.</span><span class="sxs-lookup"><span data-stu-id="fc619-278">You can have one property for all pending tasks in the queue.</span></span> <span data-ttu-id="fc619-279">Если хотя бы одна задача выполняется дольше, следует отправить отчет о свойстве **PendingTasks** с предупреждением или ошибкой соответственно.</span><span class="sxs-lookup"><span data-stu-id="fc619-279">If at least one task takes longer, the report status on the property **PendingTasks** is a warning or error, as appropriate.</span></span> <span data-ttu-id="fc619-280">Если нет ожидающих задач или все они запущены, отчет получает состояние "ОК".</span><span class="sxs-lookup"><span data-stu-id="fc619-280">If there are no pending tasks or all tasks started execution, the report status is OK.</span></span> <span data-ttu-id="fc619-281">Задачи являются постоянными.</span><span class="sxs-lookup"><span data-stu-id="fc619-281">The tasks are persistent.</span></span> <span data-ttu-id="fc619-282">Если главная служба выходит из строя, назначается новая главная служба, которая продолжает отправлять отчеты надлежащим образом.</span><span class="sxs-lookup"><span data-stu-id="fc619-282">If the primary goes down, the newly promoted primary can continue to report properly.</span></span>
* <span data-ttu-id="fc619-283">Другой процесс устройства наблюдения (облачный или внешний) проверяет (снаружи, на основе нужного результата задачи) состояние завершения задач.</span><span class="sxs-lookup"><span data-stu-id="fc619-283">Another watchdog process (in the cloud or external) checks the tasks (from outside, based on the desired task result) to see if they are completed.</span></span> <span data-ttu-id="fc619-284">Если они выходят за пределы пороговых значений, отправляется отчет о главной службе.</span><span class="sxs-lookup"><span data-stu-id="fc619-284">If they do not respect the thresholds, a report is sent on the master service.</span></span> <span data-ttu-id="fc619-285">По каждой задаче также отправляется отчет с идентификатором задачи (например, **PendingTask+taskid**).</span><span class="sxs-lookup"><span data-stu-id="fc619-285">A report is also sent on each task that includes the task identifier, like **PendingTask+taskId**.</span></span> <span data-ttu-id="fc619-286">Отчеты должны отправляться только о неработоспособных состояниях.</span><span class="sxs-lookup"><span data-stu-id="fc619-286">Reports should be sent only on unhealthy states.</span></span> <span data-ttu-id="fc619-287">Укажите срок жизни в несколько минут и отметьте отчеты для удаления по истечении срока, чтобы выполнить очистку.</span><span class="sxs-lookup"><span data-stu-id="fc619-287">Set time to live to a few minutes, and mark the reports to be removed when they expire to ensure cleanup.</span></span>
* <span data-ttu-id="fc619-288">Дополнительная служба, выполняющая задачу, отправляет отчет, если ее выполнение занимает больше времени, чем ожидалось.</span><span class="sxs-lookup"><span data-stu-id="fc619-288">The secondary that is executing a task reports when it takes longer than expected to run it.</span></span> <span data-ttu-id="fc619-289">Она отправляет отчет об экземпляре службы для свойства **PendingTasks**.</span><span class="sxs-lookup"><span data-stu-id="fc619-289">It reports on the service instance on the property **PendingTasks**.</span></span> <span data-ttu-id="fc619-290">Этот отчет поможет определить проблемный экземпляр службы. Но он не фиксирует ситуации, когда экземпляр выходит из строя.</span><span class="sxs-lookup"><span data-stu-id="fc619-290">The report pinpoints the service instance that has issues, but it doesn't capture the situation where the instance dies.</span></span> <span data-ttu-id="fc619-291">Затем отчеты удаляются.</span><span class="sxs-lookup"><span data-stu-id="fc619-291">The reports are cleaned up then.</span></span> <span data-ttu-id="fc619-292">Может быть отправлен отчет о дополнительной службе.</span><span class="sxs-lookup"><span data-stu-id="fc619-292">It could report on the secondary service.</span></span> <span data-ttu-id="fc619-293">Если дополнительная служба выполняет задачу, экземпляр службы удаляет отчет из хранилища.</span><span class="sxs-lookup"><span data-stu-id="fc619-293">If the secondary completes the task, the secondary instance clears the report from the store.</span></span> <span data-ttu-id="fc619-294">В таком отчете не регистрируются ситуации, когда подтверждение утеряно и задача не выполнена для главной службы.</span><span class="sxs-lookup"><span data-stu-id="fc619-294">The report doesn't capture the situation where the acknowledgement message is lost and the task is not finished from the master's point of view.</span></span>

<span data-ttu-id="fc619-295">Независимо от того, какие отчеты отправляются в описанных выше случаях, все они будут учитываться при оценке работоспособности приложения.</span><span class="sxs-lookup"><span data-stu-id="fc619-295">However the reporting is done in the cases described above, the reports are captured in application health when health is evaluated.</span></span>

## <a name="report-periodically-vs-on-transition"></a><span data-ttu-id="fc619-296">Периодические отчеты и отчеты на основе переходов</span><span class="sxs-lookup"><span data-stu-id="fc619-296">Report periodically vs. on transition</span></span>
<span data-ttu-id="fc619-297">С помощью модели создания отчетов о работоспособности устройства наблюдения могут отправлять отчеты периодически или на основе переходов.</span><span class="sxs-lookup"><span data-stu-id="fc619-297">By using the health reporting model, watchdogs can send reports periodically or on transitions.</span></span> <span data-ttu-id="fc619-298">Мы рекомендуем выбирать периодическую отчетность для отчетов наблюдения, так как она требует более простого кода и, следовательно, меньше подвержена ошибкам.</span><span class="sxs-lookup"><span data-stu-id="fc619-298">The recommended way for watchdog reporting is periodically, because the code is much simpler and less prone to errors.</span></span> <span data-ttu-id="fc619-299">Во избежание ошибок, которые приводят к неправильным отчетам, устройства наблюдения должны быть максимально простыми.</span><span class="sxs-lookup"><span data-stu-id="fc619-299">The watchdogs must strive to be as simple as possible to avoid bugs that trigger incorrect reports.</span></span> <span data-ttu-id="fc619-300">Неправильный отчет о *неработоспособности* влияет на оценку работоспособности и на сценарии, основанные на работоспособности, в частности обновления.</span><span class="sxs-lookup"><span data-stu-id="fc619-300">Incorrect *unhealthy* reports impact health evaluations and scenarios based on health, including upgrades.</span></span> <span data-ttu-id="fc619-301">Неправильные отчеты о *работоспособности* скрывают проблемы в кластере, а это нежелательно.</span><span class="sxs-lookup"><span data-stu-id="fc619-301">Incorrect *healthy* reports hide issues in the cluster, which is not desired.</span></span>

<span data-ttu-id="fc619-302">Для периодической отчетности модуль наблюдения можно реализовать с таймером.</span><span class="sxs-lookup"><span data-stu-id="fc619-302">For periodic reporting, the watchdog can be implemented with a timer.</span></span> <span data-ttu-id="fc619-303">При обратном вызове таймера устройство наблюдения может проверить состояние и отправить отчет на основе текущего состояния.</span><span class="sxs-lookup"><span data-stu-id="fc619-303">On a timer callback, the watchdog can check the state and send a report based on the current state.</span></span> <span data-ttu-id="fc619-304">При этом не нужны сведения о том, какой отчет был отправлен ранее, и не нужно оптимизировать что-либо в обмене сообщениями.</span><span class="sxs-lookup"><span data-stu-id="fc619-304">There is no need to see which report was sent previously or make any optimizations in terms of messaging.</span></span> <span data-ttu-id="fc619-305">Клиент работоспособности использует логику пакетной обработки для повышения производительности.</span><span class="sxs-lookup"><span data-stu-id="fc619-305">The health client has batching logic to help with performance.</span></span> <span data-ttu-id="fc619-306">Пока клиент работоспособности активен, он будет повторять попытки, пока не получит подтверждение получения отчета от хранилища данных о работоспособности. Или пока модуль наблюдения не создаст новый отчет для той же комбинации сущности, свойства и источника.</span><span class="sxs-lookup"><span data-stu-id="fc619-306">While the health client is kept alive, it retries internally until the report is acknowledged by the health store or the watchdog generates a newer report with the same entity, property, and source.</span></span>

<span data-ttu-id="fc619-307">Отчеты о переходах требуют тщательной обработки состояния.</span><span class="sxs-lookup"><span data-stu-id="fc619-307">Reporting on transitions requires careful handling of state.</span></span> <span data-ttu-id="fc619-308">Устройство наблюдения отслеживает некоторые условия и создает отчеты только в случае изменения условий.</span><span class="sxs-lookup"><span data-stu-id="fc619-308">The watchdog monitors some conditions and reports only when the conditions change.</span></span> <span data-ttu-id="fc619-309">Преимущество состоит в меньшем количестве отчетов.</span><span class="sxs-lookup"><span data-stu-id="fc619-309">The upside of this approach is that fewer reports are needed.</span></span> <span data-ttu-id="fc619-310">Недостатком является сложность логики устройства наблюдения.</span><span class="sxs-lookup"><span data-stu-id="fc619-310">The downside is that the logic of the watchdog is complex.</span></span> <span data-ttu-id="fc619-311">Модуль наблюдения должен сохранять условия или отчеты, чтобы можно было отследить изменение состояний.</span><span class="sxs-lookup"><span data-stu-id="fc619-311">The watchdog must maintain the conditions or the reports, so that they can be inspected to determine state changes.</span></span> <span data-ttu-id="fc619-312">При отработке отказа необходимо позаботиться об отчетах, которые были добавлены, но еще не отправлены в хранилище данных о работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-312">On failover, care must be taken with reports added, but not yet sent to the health store.</span></span> <span data-ttu-id="fc619-313">Порядковый номер должен постоянно увеличиваться.</span><span class="sxs-lookup"><span data-stu-id="fc619-313">The sequence number must be ever-increasing.</span></span> <span data-ttu-id="fc619-314">В противном случае отчет отклоняется как устаревший.</span><span class="sxs-lookup"><span data-stu-id="fc619-314">If not, the reports are rejected as stale.</span></span> <span data-ttu-id="fc619-315">В некоторых случаях после потерь данных может понадобиться синхронизация состояния информатора с состоянием хранилища данных о работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-315">In the rare cases where data loss is incurred, synchronization may be needed between the state of the reporter and the state of the health store.</span></span>

<span data-ttu-id="fc619-316">Отчеты на основе переходов имеют смысл, когда служба сообщает данные о своем состоянии с помощью `Partition` или `CodePackageActivationContext`.</span><span class="sxs-lookup"><span data-stu-id="fc619-316">Reporting on transitions makes sense for services reporting on themselves, through `Partition` or `CodePackageActivationContext`.</span></span> <span data-ttu-id="fc619-317">При удалении локального объекта (реплика, развернутый пакет службы или развернутое приложение) все отчеты для этого объекта также удаляются.</span><span class="sxs-lookup"><span data-stu-id="fc619-317">When the local object (replica or deployed service package / deployed application) is removed, all its reports are also removed.</span></span> <span data-ttu-id="fc619-318">Такая автоматическая очистка снижает необходимость синхронизации между информаторами о работоспособности и хранилищем данных о работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-318">This automatic cleanup relaxes the need for synchronization between reporter and health store.</span></span> <span data-ttu-id="fc619-319">Если отчет предназначен для родительской секции или родительского приложения, необходимо соблюдать осторожность при отработке отказа, чтобы избежать устаревших отчетов в хранилище данных о работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-319">If the report is for parent partition or parent application, care must be taken on failover to avoid stale reports in the health store.</span></span> <span data-ttu-id="fc619-320">Необходимо добавить логику для поддержания корректного состояния и удаления отчетов из хранилища, когда они больше не нужны.</span><span class="sxs-lookup"><span data-stu-id="fc619-320">Logic must be added to maintain the correct state and clear the report from store when not needed anymore.</span></span>

## <a name="implement-health-reporting"></a><span data-ttu-id="fc619-321">Реализация отчетов о работоспособности</span><span class="sxs-lookup"><span data-stu-id="fc619-321">Implement health reporting</span></span>
<span data-ttu-id="fc619-322">Мы рассмотрели сущности и отчеты. Теперь можно переходить к отправке отчетов о работоспособности с помощью API, PowerShell или REST.</span><span class="sxs-lookup"><span data-stu-id="fc619-322">Once the entity and report details are clear, sending health reports can be done through the API, PowerShell, or REST.</span></span>

### <a name="api"></a><span data-ttu-id="fc619-323">API</span><span class="sxs-lookup"><span data-stu-id="fc619-323">API</span></span>
<span data-ttu-id="fc619-324">Чтобы отправить отчет через API, нужно создать отчет о работоспособности, соответствующий тому типу сущности, по которому нужен отчет.</span><span class="sxs-lookup"><span data-stu-id="fc619-324">To report through the API, you need to create a health report specific to the entity type they want to report on.</span></span> <span data-ttu-id="fc619-325">Затем отчет необходимо передать клиенту работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-325">Give the report to a health client.</span></span> <span data-ttu-id="fc619-326">Также можно создать сведения о работоспособности и передать их в соответствующие методы подготовки отчетов на `Partition` или `CodePackageActivationContext` для создания отчетов о текущих сущностях.</span><span class="sxs-lookup"><span data-stu-id="fc619-326">Alternatively, create a health information and pass it to correct reporting methods on `Partition` or `CodePackageActivationContext` to report on current entities.</span></span>

<span data-ttu-id="fc619-327">В приведенном ниже примере показано создание периодических отчетов из устройства наблюдения в кластере.</span><span class="sxs-lookup"><span data-stu-id="fc619-327">The following example shows periodic reporting from a watchdog within the cluster.</span></span> <span data-ttu-id="fc619-328">Устройство наблюдения проверяет наличие доступа к внешнему ресурсу с узла.</span><span class="sxs-lookup"><span data-stu-id="fc619-328">The watchdog checks whether an external resource can be accessed from within a node.</span></span> <span data-ttu-id="fc619-329">Ресурс необходим манифесту службы в приложении.</span><span class="sxs-lookup"><span data-stu-id="fc619-329">The resource is needed by a service manifest within the application.</span></span> <span data-ttu-id="fc619-330">Если ресурс недоступен, другие службы в приложении могут работать неправильно.</span><span class="sxs-lookup"><span data-stu-id="fc619-330">If the resource is unavailable, the other services within the application can still function properly.</span></span> <span data-ttu-id="fc619-331">Следовательно, отчет отправляется в развернутую сущность пакета службы каждые 30 секунд.</span><span class="sxs-lookup"><span data-stu-id="fc619-331">Therefore, the report is sent on the deployed service package entity every 30 seconds.</span></span>

```csharp
private static Uri ApplicationName = new Uri("fabric:/WordCount");
private static string ServiceManifestName = "WordCount.Service";
private static string NodeName = FabricRuntime.GetNodeContext().NodeName;
private static Timer ReportTimer = new Timer(new TimerCallback(SendReport), null, 30 * 1000, 30 * 1000);
private static FabricClient Client = new FabricClient(new FabricClientSettings() { HealthReportSendInterval = TimeSpan.FromSeconds(0) });

public static void SendReport(object obj)
{
    // Test whether the resource can be accessed from the node
    HealthState healthState = this.TestConnectivityToExternalResource();

    // Send report on deployed service package, as the connectivity is needed by the specific service manifest
    // and can be different on different nodes
    var deployedServicePackageHealthReport = new DeployedServicePackageHealthReport(
        ApplicationName,
        ServiceManifestName,
        NodeName,
        new HealthInformation("ExternalSourceWatcher", "Connectivity", healthState));

    // TODO: handle exception. Code omitted for snippet brevity.
    // Possible exceptions: FabricException with error codes
    // FabricHealthStaleReport (non-retryable, the report is already queued on the health client),
    // FabricHealthMaxReportsReached (retryable; user should retry with exponential delay until the report is accepted).
    Client.HealthManager.ReportHealth(deployedServicePackageHealthReport);
}
```

### <a name="powershell"></a><span data-ttu-id="fc619-332">PowerShell</span><span class="sxs-lookup"><span data-stu-id="fc619-332">PowerShell</span></span>
<span data-ttu-id="fc619-333">Отправляйте отчеты о работоспособности с помощью команды **Send-ServiceFabric*EntityType*HealthReport**.</span><span class="sxs-lookup"><span data-stu-id="fc619-333">Send health reports with **Send-ServiceFabric*EntityType*HealthReport**.</span></span>

<span data-ttu-id="fc619-334">В следующем примере показано создание периодических отчетов по загрузке ЦП на узле.</span><span class="sxs-lookup"><span data-stu-id="fc619-334">The following example shows periodic reporting on CPU values on a node.</span></span> <span data-ttu-id="fc619-335">Отчеты должны отправляться каждые 30 секунд, а срок их жизни составляет две минуты.</span><span class="sxs-lookup"><span data-stu-id="fc619-335">The reports should be sent every 30 seconds, and they have a time to live of two minutes.</span></span> <span data-ttu-id="fc619-336">Если срок хранения истекает, это означает, что возникли проблемы с информатором, поэтому узел будет считаться ошибочным.</span><span class="sxs-lookup"><span data-stu-id="fc619-336">If they expire, the reporter has issues, so the node is evaluated at error.</span></span> <span data-ttu-id="fc619-337">Если загрузка ЦП превышает пороговое значение, состояние работоспособности в отчете — предупреждение.</span><span class="sxs-lookup"><span data-stu-id="fc619-337">When the CPU is above a threshold, the report has a health state of warning.</span></span> <span data-ttu-id="fc619-338">Если же загрузка ЦП превышает пороговое значение в течение заданного времени, состоянием работоспособности будет ошибка.</span><span class="sxs-lookup"><span data-stu-id="fc619-338">When the CPU remains above a threshold for more than the configured time, it's reported as an error.</span></span> <span data-ttu-id="fc619-339">В противном случае информатор отправляет состояние «ОК».</span><span class="sxs-lookup"><span data-stu-id="fc619-339">Otherwise, the reporter sends a health state of OK.</span></span>

```powershell
PS C:\> Send-ServiceFabricNodeHealthReport -NodeName Node.1 -HealthState Warning -SourceId PowershellWatcher -HealthProperty CPU -Description "CPU is above 80% threshold" -TimeToLiveSec 120

PS C:\> Get-ServiceFabricNodeHealth -NodeName Node.1
NodeName              : Node.1
AggregatedHealthState : Warning
UnhealthyEvaluations  :
                        Unhealthy event: SourceId='PowershellWatcher', Property='CPU', HealthState='Warning', ConsiderWarningAsError=false.

HealthEvents          :
                        SourceId              : System.FM
                        Property              : State
                        HealthState           : Ok
                        SequenceNumber        : 5
                        SentAt                : 4/21/2015 8:01:17 AM
                        ReceivedAt            : 4/21/2015 8:02:12 AM
                        TTL                   : Infinite
                        Description           : Fabric node is up.
                        RemoveWhenExpired     : False
                        IsExpired             : False
                        Transitions           : ->Ok = 4/21/2015 8:02:12 AM

                        SourceId              : PowershellWatcher
                        Property              : CPU
                        HealthState           : Warning
                        SequenceNumber        : 130741236814913394
                        SentAt                : 4/21/2015 9:01:21 PM
                        ReceivedAt            : 4/21/2015 9:01:21 PM
                        TTL                   : 00:02:00
                        Description           : CPU is above 80% threshold
                        RemoveWhenExpired     : False
                        IsExpired             : False
                        Transitions           : ->Warning = 4/21/2015 9:01:21 PM
```

<span data-ttu-id="fc619-340">В следующем примере создается временное предупреждение о реплике.</span><span class="sxs-lookup"><span data-stu-id="fc619-340">The following example reports a transient warning on a replica.</span></span> <span data-ttu-id="fc619-341">Сначала берется идентификатор раздела и реплики для нужной службы.</span><span class="sxs-lookup"><span data-stu-id="fc619-341">It first gets the partition ID and then the replica ID for the service it is interested in.</span></span> <span data-ttu-id="fc619-342">Затем отправляется отчет из **PowershellWatcher** о свойстве **ResourceDependency**.</span><span class="sxs-lookup"><span data-stu-id="fc619-342">It then sends a report from **PowershellWatcher** on the property **ResourceDependency**.</span></span> <span data-ttu-id="fc619-343">Отчет считается актуальным только две минуты. Затем он автоматически удаляется из хранилища.</span><span class="sxs-lookup"><span data-stu-id="fc619-343">The report is of interest for only two minutes, and it is removed from the store automatically.</span></span>

```powershell
PS C:\> $partitionId = (Get-ServiceFabricPartition -ServiceName fabric:/WordCount/WordCount.Service).PartitionId

PS C:\> $replicaId = (Get-ServiceFabricReplica -PartitionId $partitionId | where {$_.ReplicaRole -eq "Primary"}).ReplicaId

PS C:\> Send-ServiceFabricReplicaHealthReport -PartitionId $partitionId -ReplicaId $replicaId -HealthState Warning -SourceId PowershellWatcher -HealthProperty ResourceDependency -Description "The external resource that the primary is using has been rebooted at 4/21/2015 9:01:21 PM. Expect processing delays for a few minutes." -TimeToLiveSec 120 -RemoveWhenExpired

PS C:\> Get-ServiceFabricReplicaHealth  -PartitionId $partitionId -ReplicaOrInstanceId $replicaId


PartitionId           : 8f82daff-eb68-4fd9-b631-7a37629e08c0
ReplicaId             : 130740415594605869
AggregatedHealthState : Warning
UnhealthyEvaluations  :
                        Unhealthy event: SourceId='PowershellWatcher', Property='ResourceDependency', HealthState='Warning', ConsiderWarningAsError=false.

HealthEvents          :
                        SourceId              : System.RA
                        Property              : State
                        HealthState           : Ok
                        SequenceNumber        : 130740768777734943
                        SentAt                : 4/21/2015 8:01:17 AM
                        ReceivedAt            : 4/21/2015 8:02:12 AM
                        TTL                   : Infinite
                        Description           : Replica has been created.
                        RemoveWhenExpired     : False
                        IsExpired             : False
                        Transitions           : ->Ok = 4/21/2015 8:02:12 AM

                        SourceId              : PowershellWatcher
                        Property              : ResourceDependency
                        HealthState           : Warning
                        SequenceNumber        : 130741243777723555
                        SentAt                : 4/21/2015 9:12:57 PM
                        ReceivedAt            : 4/21/2015 9:12:57 PM
                        TTL                   : 00:02:00
                        Description           : The external resource that the primary is using has been rebooted at 4/21/2015 9:01:21 PM. Expect processing delays for a few minutes.
                        RemoveWhenExpired     : True
                        IsExpired             : False
                        Transitions           : ->Warning = 4/21/2015 9:12:32 PM
```

### <a name="rest"></a><span data-ttu-id="fc619-344">REST</span><span class="sxs-lookup"><span data-stu-id="fc619-344">REST</span></span>
<span data-ttu-id="fc619-345">Чтобы отправить отчет о работоспособности с помощью REST, создайте запрос POST и передайте его в нужную сущность, включив в тело запроса описание отчета о работоспособности.</span><span class="sxs-lookup"><span data-stu-id="fc619-345">Send health reports using REST with POST requests that go to the desired entity and have in the body the health report description.</span></span> <span data-ttu-id="fc619-346">Ознакомьтесь с примерами отправки [отчетов о работоспособности кластера](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-cluster) и [отчетов о работоспособности службы](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-service) с помощью интерфейса REST.</span><span class="sxs-lookup"><span data-stu-id="fc619-346">For example, see how to send REST [cluster health reports](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-cluster) or [service health reports](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-service).</span></span> <span data-ttu-id="fc619-347">Поддерживаются все сущности.</span><span class="sxs-lookup"><span data-stu-id="fc619-347">All entities are supported.</span></span>

## <a name="next-steps"></a><span data-ttu-id="fc619-348">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="fc619-348">Next steps</span></span>
<span data-ttu-id="fc619-349">На основе данных о работоспособности создатели служб и администраторы кластеров или приложений могут решить, как использовать полученные сведения.</span><span class="sxs-lookup"><span data-stu-id="fc619-349">Based on the health data, service writers and cluster/application administrators can think of ways to consume the information.</span></span> <span data-ttu-id="fc619-350">Например, они могут настроить оповещения на основе состояния работоспособности для выявления серьезных проблем, которые могут вызвать простои.</span><span class="sxs-lookup"><span data-stu-id="fc619-350">For example, they can set up alerts based on health status to catch severe issues before they provoke outages.</span></span> <span data-ttu-id="fc619-351">Кроме того, администраторы могут настроить системы восстановления, чтобы устранять неполадки автоматически.</span><span class="sxs-lookup"><span data-stu-id="fc619-351">Administrators can also set up repair systems to fix issues automatically.</span></span>

[<span data-ttu-id="fc619-352">Общие сведения о наблюдении за работоспособностью системы в Service Fabric</span><span class="sxs-lookup"><span data-stu-id="fc619-352">Introduction to Service Fabric health Monitoring</span></span>](service-fabric-health-introduction.md)

[<span data-ttu-id="fc619-353">Просмотр отчетов о работоспособности Service Fabric</span><span class="sxs-lookup"><span data-stu-id="fc619-353">View Service Fabric health reports</span></span>](service-fabric-view-entities-aggregated-health.md)

[<span data-ttu-id="fc619-354">Проверка работоспособности службы и оповещение о проблемах</span><span class="sxs-lookup"><span data-stu-id="fc619-354">How to report and check service health</span></span>](service-fabric-diagnostics-how-to-report-and-check-service-health.md)

[<span data-ttu-id="fc619-355">Использование отчетов о работоспособности системы для устранения неполадок</span><span class="sxs-lookup"><span data-stu-id="fc619-355">Use system health reports for troubleshooting</span></span>](service-fabric-understand-and-troubleshoot-with-system-health-reports.md)

[<span data-ttu-id="fc619-356">Мониторинг и диагностика состояния служб в локальной среде разработки</span><span class="sxs-lookup"><span data-stu-id="fc619-356">Monitor and diagnose services locally</span></span>](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md)

[<span data-ttu-id="fc619-357">Обновление приложения Service Fabric</span><span class="sxs-lookup"><span data-stu-id="fc619-357">Service Fabric application upgrade</span></span>](service-fabric-application-upgrade.md)


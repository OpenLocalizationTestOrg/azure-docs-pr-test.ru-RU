---
title: "Инструкции и рекомендации для надежных коллекций в Azure Service Fabric | Документация Майкрософт"
description: "Правила и рекомендации по использованию надежных коллекций Service Fabric"
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: masnider,rajak
ms.assetid: 62857523-604b-434e-bd1c-2141ea4b00d1
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: required
ms.date: 5/3/2017
ms.author: mcoskun
ms.openlocfilehash: 053a7bca76362035e428fc11806b3e4f83d00946
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="guidelines-and-recommendations-for-reliable-collections-in-azure-service-fabric"></a><span data-ttu-id="a8bbc-103">Инструкции и рекомендации для надежных коллекций в Azure Service Fabric</span><span class="sxs-lookup"><span data-stu-id="a8bbc-103">Guidelines and recommendations for Reliable Collections in Azure Service Fabric</span></span>
<span data-ttu-id="a8bbc-104">В этом разделе приведены инструкции по использованию надежных коллекций и диспетчера надежных состояний.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-104">This section provides guidelines for using Reliable State Manager and Reliable Collections.</span></span> <span data-ttu-id="a8bbc-105">Цель этого руководства — помочь пользователям избежать распространенных ошибок.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-105">The goal is to help users avoid common pitfalls.</span></span>

<span data-ttu-id="a8bbc-106">Инструкции составлены как простые рекомендации со словами *Делайте*, *Постарайтесь*, *Избегайте* и *Не делайте* в начале.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-106">The guidelines are organized as simple recommendations prefixed with the terms *Do*, *Consider*, *Avoid* and *Do not*.</span></span>

* <span data-ttu-id="a8bbc-107">Не изменяйте объекты пользовательского типа, возвращаемые операциями чтения (например, `TryPeekAsync` или `TryGetValueAsync`).</span><span class="sxs-lookup"><span data-stu-id="a8bbc-107">Do not modify an object of custom type returned by read operations (for example, `TryPeekAsync` or `TryGetValueAsync`).</span></span> <span data-ttu-id="a8bbc-108">Надежные коллекции, как и параллельные коллекции, возвращают ссылку на объект, а не его копию.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-108">Reliable Collections, just like Concurrent Collections, return a reference to the objects and not a copy.</span></span>
* <span data-ttu-id="a8bbc-109">Обязательно создайте глубокую копию возвращенного объекта пользовательского типа, прежде чем изменять этот объект.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-109">Do deep copy the returned object of a custom type before modifying it.</span></span> <span data-ttu-id="a8bbc-110">Так как структуры и встроенные типы передают параметры по значению, создавать их глубокую копию не нужно.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-110">Since structs and built-in types are pass-by-value, you do not need to do a deep copy on them.</span></span>
* <span data-ttu-id="a8bbc-111">Не используйте `TimeSpan.MaxValue` для времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-111">Do not use `TimeSpan.MaxValue` for time-outs.</span></span> <span data-ttu-id="a8bbc-112">Время ожидания следует использовать для выявления взаимоблокировок.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-112">Time-outs should be used to detect deadlocks.</span></span>
* <span data-ttu-id="a8bbc-113">Не используйте транзакцию после того, как она была зафиксирована, прервана или удалена.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-113">Do not use a transaction after it has been committed, aborted, or disposed.</span></span>
* <span data-ttu-id="a8bbc-114">Не используйте перечисление за пределами области транзакции, в которой оно было создано.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-114">Do not use an enumeration outside of the transaction scope it was created in.</span></span>
* <span data-ttu-id="a8bbc-115">Не создавайте транзакцию в операторе `using` другой транзакции, так как это может привести к возникновению взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-115">Do not create a transaction within another transaction’s `using` statement because it can cause deadlocks.</span></span>
* <span data-ttu-id="a8bbc-116">Убедитесь, что реализация `IComparable<TKey>` правильна.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-116">Do ensure that your `IComparable<TKey>` implementation is correct.</span></span> <span data-ttu-id="a8bbc-117">Система использует соответствующую зависимость `IComparable<TKey>` для слияния контрольных точек и строк.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-117">The system takes dependency on `IComparable<TKey>` for merging checkpoints and rows.</span></span>
* <span data-ttu-id="a8bbc-118">Используете блокировку изменения при чтении элемента с целью обновить его, чтобы предотвратить взаимоблокировки определенного класса.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-118">Do use Update lock when reading an item with an intention to update it to prevent a certain class of deadlocks.</span></span>
* <span data-ttu-id="a8bbc-119">Постарайтесь поддерживать размер элементов (например, TKey + TValue для надежного словаря) до 80 КБ: чем меньше, тем лучше.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-119">Consider keeping your items (for example, TKey + TValue for Reliable Dictionary) below 80 KBytes: smaller the better.</span></span> <span data-ttu-id="a8bbc-120">Это позволит уменьшить объем использования кучи больших объектов, а также снизить требования к дискам и сетевым операциям ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-120">This reduces the amount of Large Object Heap usage as well as disk and network IO requirements.</span></span> <span data-ttu-id="a8bbc-121">Часто это также помогает уменьшить репликацию повторяющихся данных при обновлении только небольшой части значения.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-121">Often, it reduces replicating duplicate data when only one small part of the value is being updated.</span></span> <span data-ttu-id="a8bbc-122">Распространенный способ добиться этого в надежном словаре — разбить строки на несколько строк.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-122">Common way to achieve this in Reliable Dictionary, is to break your rows in to multiple rows.</span></span>
* <span data-ttu-id="a8bbc-123">Возможно, вас заинтересует применение функций архивации и восстановления для аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-123">Consider using backup and restore functionality to have disaster recovery.</span></span>
* <span data-ttu-id="a8bbc-124">Избегайте совместного использования операций с одной сущностью и операций с несколькими сущностями (например, `GetCountAsync`, `CreateEnumerableAsync`) в одной и той же транзакции ввиду различных уровней изоляции.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-124">Avoid mixing single entity operations and multi-entity operations (e.g `GetCountAsync`, `CreateEnumerableAsync`) in the same transaction due to the different isolation levels.</span></span>
* <span data-ttu-id="a8bbc-125">Обработайте исключение InvalidOperationException.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-125">Do handle InvalidOperationException.</span></span> <span data-ttu-id="a8bbc-126">Пользовательские транзакции могут быть прерваны системой по разным причинам.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-126">User transactions can be aborted by the system for variety of reasons.</span></span> <span data-ttu-id="a8bbc-127">Например, если диспетчер надежных состояний изменяет свою роль с основной на какую-то другую, или когда транзакция с длительным временем выполнения блокирует усечение журнала транзакций.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-127">For example, when the Reliable State Manager is changing its role out of Primary or when a long-running transaction is blocking truncation of the transactional log.</span></span> <span data-ttu-id="a8bbc-128">В таких случаях пользователь может получить исключение InvalidOperationException, указывающее на то, что его транзакция уже завершена.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-128">In such cases, user may receive InvalidOperationException indicating that their transaction has already been terminated.</span></span> <span data-ttu-id="a8bbc-129">Если предположить, что завершение транзакции не было запрошено пользователем, то лучший способ обработки этого исключения — удалить транзакцию и проверить, не получен ли сигнал в виде токена отмены (или изменена роль реплики). И если нет, то создать новую транзакцию и повторить попытку.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-129">Assuming, the termination of the transaction was not requested by the user, best way to handle this exception is to dispose the transaction, check if the cancellation token has been signaled (or the role of the replica has been changed), and if not create a new transaction and retry.</span></span>  

<span data-ttu-id="a8bbc-130">При этом нужно помнить о следующем:</span><span class="sxs-lookup"><span data-stu-id="a8bbc-130">Here are some things to keep in mind:</span></span>

* <span data-ttu-id="a8bbc-131">Время ожидания по умолчанию составляет четыре секунды для всех API надежных коллекций.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-131">The default time-out is four seconds for all the Reliable Collection APIs.</span></span> <span data-ttu-id="a8bbc-132">Большинство пользователей должны использовать время ожидания по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-132">Most users should use the default time-out.</span></span>
* <span data-ttu-id="a8bbc-133">Во всех API надежных коллекций токеном отмены по умолчанию является `CancellationToken.None` .</span><span class="sxs-lookup"><span data-stu-id="a8bbc-133">The default cancellation token is `CancellationToken.None` in all Reliable Collections APIs.</span></span>
* <span data-ttu-id="a8bbc-134">Параметр типа ключа (*TKey*) для надежного словаря должен правильно реализовывать `GetHashCode()` и `Equals()`.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-134">The key type parameter (*TKey*) for a Reliable Dictionary must correctly implement `GetHashCode()` and `Equals()`.</span></span> <span data-ttu-id="a8bbc-135">Ключи должны быть неизменяемыми.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-135">Keys must be immutable.</span></span>
* <span data-ttu-id="a8bbc-136">Чтобы обеспечить высокую доступность надежных коллекций, в каждой службе необходимый и минимальный размер набора реплик должен быть равен как минимум 3.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-136">To achieve high availability for the Reliable Collections, each service should have at least a target and minimum replica set size of 3.</span></span>
* <span data-ttu-id="a8bbc-137">Операции чтения в базе данных-получателе могут считывать версии без кворума.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-137">Read operations on the secondary may read versions that are not quorum committed.</span></span>
  <span data-ttu-id="a8bbc-138">Это означает, что версия данных, считываемая из отдельной базы данных-получателя, может быть ложно увеличена.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-138">This means that a version of data that is read from a single secondary might be false progressed.</span></span>
  <span data-ttu-id="a8bbc-139">Чтение из базы данных-источника всегда стабильно и не может вызывать ложное увеличение номера версии.</span><span class="sxs-lookup"><span data-stu-id="a8bbc-139">Reads from Primary are always stable: can never be false progressed.</span></span>

### <a name="next-steps"></a><span data-ttu-id="a8bbc-140">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="a8bbc-140">Next steps</span></span>
* [<span data-ttu-id="a8bbc-141">Работа с Reliable Collections</span><span class="sxs-lookup"><span data-stu-id="a8bbc-141">Working with Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
* [<span data-ttu-id="a8bbc-142">Транзакции и блокировки</span><span class="sxs-lookup"><span data-stu-id="a8bbc-142">Transactions and Locks</span></span>](service-fabric-reliable-services-reliable-collections-transactions-locks.md)
* [<span data-ttu-id="a8bbc-143">Внутренние компоненты Reliable State Manager и Reliable Collections</span><span class="sxs-lookup"><span data-stu-id="a8bbc-143">Reliable State Manager and Collection Internals</span></span>](service-fabric-reliable-services-reliable-collections-internals.md)
* <span data-ttu-id="a8bbc-144">Управление данными</span><span class="sxs-lookup"><span data-stu-id="a8bbc-144">Managing Data</span></span>
  * [<span data-ttu-id="a8bbc-145">Резервное копирование и восстановление</span><span class="sxs-lookup"><span data-stu-id="a8bbc-145">Backup and Restore</span></span>](service-fabric-reliable-services-backup-restore.md)
  * [<span data-ttu-id="a8bbc-146">Notifications</span><span class="sxs-lookup"><span data-stu-id="a8bbc-146">Notifications</span></span>](service-fabric-reliable-services-notifications.md)
  * [<span data-ttu-id="a8bbc-147">Влияние сериализации данных на обновление приложений</span><span class="sxs-lookup"><span data-stu-id="a8bbc-147">Serialization and Upgrade</span></span>](service-fabric-application-upgrade-data-serialization.md)
  * [<span data-ttu-id="a8bbc-148">Конфигурация диспетчера надежных состояний</span><span class="sxs-lookup"><span data-stu-id="a8bbc-148">Reliable State Manager configuration</span></span>](service-fabric-reliable-services-configuration.md)
* <span data-ttu-id="a8bbc-149">Прочее</span><span class="sxs-lookup"><span data-stu-id="a8bbc-149">Others</span></span>
  * [<span data-ttu-id="a8bbc-150">Краткое руководство по надежным службам Reliable Services</span><span class="sxs-lookup"><span data-stu-id="a8bbc-150">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  * [<span data-ttu-id="a8bbc-151">Справочник разработчика по надежным коллекциям</span><span class="sxs-lookup"><span data-stu-id="a8bbc-151">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

---
title: "Приложение для управления исправлениями Azure Service Fabric | Документация Майкрософт"
description: "Приложение для автоматизации установки исправлений операционной системы в кластере Service Fabric."
services: service-fabric
documentationcenter: .net
author: novino
manager: timlt
editor: 
ms.assetid: de7dacf5-4038-434a-a265-5d0de80a9b1d
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 5/9/2017
ms.author: nachandr
ms.openlocfilehash: 13c11902e275d1023e474d717800b3a36a6b31f2
ms.sourcegitcommit: 93902ffcb7c8550dcb65a2a5e711919bd1d09df9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/09/2017
---
# <a name="patch-the-windows-operating-system-in-your-service-fabric-cluster"></a>Установка исправлений операционной системы Windows в кластере Service Fabric

Приложение для управления исправлениями — это приложение Azure Service Fabric, которое позволяет автоматизировать установку исправлений операционной системы в кластере Service Fabric и избежать простоев.

Приложение для управления исправлениями предоставляет описанные ниже возможности.

- **Автоматическая установка обновлений операционной системы**. Обновления операционной системы автоматически загружаются и устанавливаются. При необходимости узлы кластера перезагружаются без остановки его работы.

- **Исправление с учетом состояния кластера и интеграция функций работоспособности**. При применении обновлений приложение для управления исправлениями отслеживает работоспособность узлов кластера. Узлы кластера обновляются поочередно или по одному домену обновления за раз. Если из-за установки исправлений работоспособность кластера понижается, процесс останавливается, чтобы проблема не усугублялась.

## <a name="internal-details-of-the-app"></a>Внутренние сведения приложения

Приложение для управления исправлениями состоит из описанных ниже компонентов.

- **Служба координатора** — эта служба с отслеживанием состояния отвечает за следующие задачи:
    - координация задания обновления Windows во всем кластере;
    - хранение результатов завершенных операций обновления Windows.
- **Служба агента узла** — это служба без отслеживания состояния, которая выполняется на всех узлах кластера Service Fabric. Она отвечает за следующие задачи:
    - начальная загрузка NTService агента узла;
    - мониторинг службы NTService агента узла.
- **Служба NTService агента узла** — служба Windows NT, которая выполняется с разрешением высокого уровня (СИСТЕМА). Для сравнения служба агента узла и служба координатора выполняются с разрешением более низкого уровня (СЕТЕВАЯ СЛУЖБА). Служба отвечает за выполнение следующих заданий обновления Windows на всех узлах кластера:
    - выключение автоматического обновления Windows на узле;
    - загрузка и установка обновления Windows в соответствии с политикой, назначенной пользователем;
    - перезапуск машины после установки обновлений Windows;
    - передача результатов обновления Windows в службу координатора;
    - сообщение сведений о работоспособности, если операцию не удалось выполнить, исчерпав все повторные попытки.

> [!NOTE]
> Приложение для управления исправлениями использует для включения и выключения узла, а также проверки работоспособности системную службу Service Fabric, которая называется Repair Manager. Задание восстановления, созданное приложением для управления исправлениями, отслеживает ход обновления Windows для каждого узла.

## <a name="prerequisites"></a>Предварительные требования

### <a name="enable-the-repair-manager-service-if-its-not-running-already"></a>Включение службы Repair Manager (если она еще не запущена)

Приложению для управления исправлениями необходимо, чтобы системная служба Repair Manager была включена в кластере.

#### <a name="azure-clusters"></a>Кластеры Azure

В кластерах Azure на уровне надежности Silver служба Repair Manager включена по умолчанию. В кластерах Azure на уровне надежности Gold служба Repair Manager может быть не включена в зависимости от того, когда были созданы кластеры. В кластерах Azure на уровне надежности Bronze служба Repair Manager по умолчанию не включена. Если служба уже включена, сведения о ее выполнении отображаются в разделе системных служб в Service Fabric Explorer.

##### <a name="azure-portal"></a>Портал Azure
Диспетчер восстановления можно включить на портале Azure при настройке кластера. Выберите параметр **Включить диспетчер восстановления** в разделе **Дополнительные функции** во время настройки кластера.
![Снимок экрана с подключением диспетчера восстановления на портале Azure](media/service-fabric-patch-orchestration-application/EnableRepairManager.png)

##### <a name="azure-resource-manager-template"></a>Шаблон диспетчера ресурсов Azure
Службу диспетчера восстановления также можно включить для новых и существующих кластеров Service Fabric с помощью [шаблона Azure Resource Manager](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-creation-via-arm). Получите шаблон для кластера, который требуется развернуть. Можно использовать примеры шаблонов или создать пользовательский шаблон Resource Manager. 

Чтобы включить службу диспетчера восстановления с помощью [шаблона Azure Resource Manager](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-creation-via-arm), сделайте следующее:

1. Сначала убедитесь, что `apiversion` ресурса `Microsoft.ServiceFabric/clusters` имеет значение `2017-07-01-preview`, как показано в фрагменте ниже. Если оно другое, необходимо задать для `apiVersion` значение `2017-07-01-preview`:

    ```json
    {
        "apiVersion": "2017-07-01-preview",
        "type": "Microsoft.ServiceFabric/clusters",
        "name": "[parameters('clusterName')]",
        "location": "[parameters('clusterLocation')]",
        ...
    }
    ```

2. Включите службу Repair Manager, добавив следующий раздел `addonFeatures` после раздела `fabricSettings`:

    ```json
    "fabricSettings": [
        ...      
    ],
    "addonFeatures": [
        "RepairManager"
    ],
    ```

3. После обновления шаблона кластера примените изменения и дождитесь завершения обновления. Теперь отображаются сведения о выполнении службы Repair Manager в кластере. Он указан в разделе системных служб в Service Fabric Explorer под названием `fabric:/System/RepairManagerService`. 

### <a name="standalone-on-premises-clusters"></a>Автономные локальные кластеры

Чтобы включить службу Repair Manager в новых и существующих кластерах Service Fabric, можно использовать [Параметры конфигурации для автономного кластера Windows](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-manifest).

Включение службы Repair Manager

1. Сначала убедитесь, что для параметра `apiversion` в разделе [Общие параметры кластера](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-manifest#general-cluster-configurations) установлено значение `04-2017` или выше:

    ```json
    {
        "name": "SampleCluster",
        "clusterConfigurationVersion": "1.0.0",
        "apiVersion": "04-2017",
        ...
    }
    ```

2. Включите службу Repair Manager, добавив раздел `addonFeatures` после раздела `fabricSettings`, как показано ниже.

    ```json
    "fabricSettings": [
        ...      
    ],
    "addonFeatures": [
        "RepairManager"
    ],
    ```

3. Обновите манифест кластера, добавив эти изменения с помощью манифеста обновления кластера [Создание кластера](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-creation-for-windows-server) или [Обновление конфигурации кластера](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-upgrade-windows-server#Upgrade-the-cluster-configuration). Как только кластер запустится с обновленным манифестом, вы увидите, что системная служба Repair Manager выполняется в кластере, который называется `fabric:/System/RepairManagerService`, в разделе системных служб в Service Fabric Explorer.

### <a name="disable-automatic-windows-update-on-all-nodes"></a>Отключение автоматического обновления Windows на всех узлах

Автоматическое обновление Windows может привести к потере доступности из-за одновременного перезапуска нескольких узлов кластера. Приложение для управления исправлениями по умолчанию попытается выключить автоматическое обновление Windows на каждом узле кластера. Но если параметры задаются администратором или групповой политикой, советуем явно настроить для политики обновления Windows параметр уведомления о скачивании.

## <a name="download-the-app-package"></a>Загрузка пакета установки

Загрузите приложение по [этой ссылке](https://go.microsoft.com/fwlink/P/?linkid=849590).

## <a name="configure-the-app"></a>Настройка приложения

Поведение приложения для управления исправлениями можно настроить в соответствии с вашими требованиями. Значения по умолчанию можно переопределить, передав параметр приложения во время создания или обновления приложения. Параметры приложения можно задать, указав параметр `ApplicationParameter` командлету `Start-ServiceFabricApplicationUpgrade` или `New-ServiceFabricApplication`.

|**Параметр**        |**Тип**                          | **Дополнительные сведения**|
|:-|-|-|
|MaxResultsToCache    |длинное целое                              | Максимальное количество результатов обновления Windows, которые необходимо кэшировать. <br>Значение по умолчанию — 3000 при условии, что: <br> - количество узлов —20; <br> - количество обновлений на узле в месяц — 5; <br> - количество результатов на операцию может быть 10; <br> - сохраняются результаты за последние три месяца. |
|TaskApprovalPolicy   |Перечисление. <br> { NodeWise, UpgradeDomainWise }                          |TaskApprovalPolicy указывает политику, которая будет использоваться службой координатора для установки обновлений Windows на узлы кластера Service Fabric.<br>                         Допустимые значения: <br>                                                           <b>NodeWise</b>. Обновление Windows устанавливается на один узел за раз. <br>                                                           <b>UpgradeDomainWise</b>. Обновление Windows устанавливается на один домен обновления за раз (как максимум на всех узлах, принадлежащих домену обновления).
|LogsDiskQuotaInMB   |длинное целое  <br> (значение по умолчанию: 1024)               |Максимальный размер журналов приложения для управления исправлениями, которые могут быть сохранены локально на узле (в мегабайтах).
| WUQuery               | string<br>(значение по умолчанию: IsInstalled=0)                | Запрос на получение обновлений Windows. Дополнительные сведения см. в разделе [WuQuery](https://msdn.microsoft.com/library/windows/desktop/aa386526(v=vs.85).aspx).
| InstallWindowsOSOnlyUpdates | Bool <br> (значение по умолчанию: True)                 | Этот параметр позволяет устанавливать обновления операционной системы Windows.            |
| WUOperationTimeOutInMinutes | int <br>(значение по умолчанию: 90)                   | Указывает время ожидания для любой операции обновления Windows (поиск, скачивание или установка). Если операция не завершена по истечении заданного времени ожидания, она будет прервана.       |
| WURescheduleCount     | int <br> (значение по умолчанию: 5)                  | Максимальное количество операций изменения службой расписания обновления Windows в случае постоянных сбоев операции.          |
| WURescheduleTimeInMinutes | int <br>(значение по умолчанию: 30) | Интервал, согласно которому служба будет изменять расписание обновления Windows, если сбой продолжает происходить. |
| WUFrequency           | Строка с разделителями-запятыми (по умолчанию: Weekly, Wednesday, 7:00:00)     | Частота установки обновлений Windows. Формат и возможные значения: <br>- Ежемесячно, ДД,ЧЧ:ММ:СС (например: Monthly, 5,12:22:32); <br> - Еженедельно, ДЕНЬ, ЧЧ:ММ:СС (например: Weekly, Tuesday, 12:22:32);  <br> - Ежедневно, ЧЧ:ММ:СС (например: Daily, 12:22:32);  <br> - Никогда — указывает, что обновление Windows не должно выполняться.  <br><br> Обратите внимание, что все значения времени указаны в формате UTC.|
| AcceptWindowsUpdateEula | Bool <br>(значение по умолчанию: True) | Если этот флажок установлен, приложение принимает условия лицензионного соглашения Центра обновления Windows от имени владельца компьютера.              |

> [!TIP]
> Чтобы обновление Windows началось немедленно, установите `WUFrequency` в соответствии с временем развертывания приложения. Например, у вас тестовый кластер с пятью узлами и вы планируете развернуть приложение около 17:00 UTC. Если предположить, что обновление или развертывание приложения занимает не более 30 минут, задайте для WUFrequency значение "Daily, 17:30:00".

## <a name="deploy-the-app"></a>Развертывание приложения

1. Завершите все предварительные шаги, чтобы подготовить кластер.
2. Разверните приложение для управления исправлениями, как любое другое приложение Service Fabric. Развернуть приложение можно с помощью PowerShell. Выполните инструкции из статьи [Развертывание и удаление приложений с помощью PowerShell](https://docs.microsoft.com/azure/service-fabric/service-fabric-deploy-remove-applications).
3. Чтобы настроить приложение во время развертывания, передайте `ApplicationParamater` для командлета `New-ServiceFabricApplication`. Для вашего удобства мы сопроводили приложение сценарием Deploy.ps1. Использование сценария

    - Подключитесь к кластеру Service Fabric при помощи `Connect-ServiceFabricCluster`.
    - Выполните сценарий PowerShell Deploy.ps1 с соответствующим значением `ApplicationParameter`.

> [!NOTE]
> Сохраните сценарий и папку приложения PatchOrchestrationApplication в одном каталоге.

## <a name="upgrade-the-app"></a>Обновление приложения

Чтобы обновить установленное приложение для управления исправлениями при помощи PowerShell, выполните инструкции из статьи [Обновление приложения Service Fabric с помощью PowerShell](https://docs.microsoft.com/azure/service-fabric/service-fabric-application-upgrade-tutorial-powershell).

## <a name="remove-the-app"></a>Удаление приложения

Чтобы удалить приложение, выполните инструкции из статьи [Развертывание и удаление приложений с помощью PowerShell](https://docs.microsoft.com/azure/service-fabric/service-fabric-deploy-remove-applications).

Для вашего удобства мы сопроводили приложение сценарием Undeploy.ps1. Использование сценария

  - Подключитесь к кластеру Service Fabric при помощи ```Connect-ServiceFabricCluster```.

  - Выполните сценарий PowerShell Undeploy.ps1.

> [!NOTE]
> Сохраните сценарий и папку приложения PatchOrchestrationApplication в одном каталоге.

## <a name="view-the-windows-update-results"></a>Просмотр результатов обновления Windows

Приложение для управления исправлениями предоставляет REST API для отображения исторических результатов. Пример результата JSON:
```json
[
  {
    "NodeName": "_stg1vm_1",
    "WindowsUpdateOperationResults": [
      {
        "OperationResult": 0,
        "NodeName": "_stg1vm_1",
        "OperationTime": "2017-05-21T11:46:52.1953713Z",
        "UpdateDetails": [
          {
            "UpdateId": "7392acaf-6a85-427c-8a8d-058c25beb0d6",
            "Title": "Cumulative Security Update for Internet Explorer 11 for Windows Server 2012 R2 (KB3185319)",
            "Description": "A security issue has been identified in a Microsoft software product that could affect your system. You can help protect your system by installing this update from Microsoft. For a complete listing of the issues that are included in this update, see the associated Microsoft Knowledge Base article. After you install this update, you may have to restart your system.",
            "ResultCode": 0
          }
        ],
        "OperationType": 1,
        "WindowsUpdateQuery": "IsInstalled=0",
        "WindowsUpdateFrequency": "Daily,10:00:00",
        "RebootRequired": false
      }
    ]
  },
  ...
]
```

Ниже приводится описание полей JSON.

Поле | Значения | Сведения
-- | -- | --
OperationResult | 0 — успешно<br> 1 — выполнено с ошибками<br> 2 — сбой<br> 3 — прервано<br> 4 — прервано с временем ожидания | Указывает результат общей операции (обычно с установкой одного или нескольких обновлений).
ResultCode | Как и для OperationResult | Это поле указывает результат операции установки для отдельного обновления.
OperationType | 1 — установка<br> 0 — поиск и скачивание| По умолчанию в результатах отображается только тип операции "Установка".
WindowsUpdateQuery | Значение по умолчанию: IsInstalled=0 |Запрос на обновление Windows, использованный для поиска обновлений. Дополнительные сведения см. в разделе [WuQuery](https://msdn.microsoft.com/library/windows/desktop/aa386526(v=vs.85).aspx).
RebootRequired | true — требовалась перезагрузка<br> false — перезагрузка не требовалась | Указывает, требовалась ли перезагрузка для завершения установки обновлений.

Если обновление еще не запланировано, поле результата JSON будет пустым.

Войдите в кластер для запроса результатов обновления Windows. Найдите адрес реплики для первичной службы координатора и перейдите по этому URL-адресу в браузере: http://&lt;REPLICA-IP&gt;:&lt;ApplicationPort&gt;/PatchOrchestrationApplication/v1/GetWindowsUpdateResults.

Конечная точка REST для службы координатора имеет динамический порт. Точный URL-адрес можно узнать в Service Fabric Explorer. Например, результаты доступны в `http://10.0.0.7:20000/PatchOrchestrationApplication/v1/GetWindowsUpdateResults`.

![Представление конечной точки REST](media/service-fabric-patch-orchestration-application/Rest_Endpoint.png)


Если в кластере включен обратный прокси-сервер, пользователь также может получить доступ к URL-адресу за пределами кластера.
Конечная точка, к которой нужно перейти: http://&lt;SERVERURL&gt;:&lt;REVERSEPROXYPORT&gt;/PatchOrchestrationApplication/CoordinatorService/v1/GetWindowsUpdateResults.

Чтобы включить в кластере обратный прокиз статьи [Обратный прокси-сервер Service Fabric](https://docs.microsoft.com/azure/service-fabric/service-fabric-reverseproxy). 

> 
> [!WARNING]
> Настройка обратного прокси-сервера обеспечит адресацию извне кластера всех микрослужб в этом кластере, которые предоставляют конечную точку HTTP.

## <a name="diagnosticshealth-events"></a>События диагностики и работоспособности

### <a name="diagnostic-logs"></a>Журналы диагностики

Журналы приложения для оркестрации исправлений собираются как часть журналов среды выполнения Service Fabric.

При необходимости можно собирать журналы, используя любой конвейер или средство диагностики. Приложение для оркестрации исправлений использует следующие фиксированные идентификаторы поставщиков для записи событий в журнал с использованием класса [EventSource](https://docs.microsoft.com/dotnet/api/system.diagnostics.tracing.eventsource?view=netframework-4.5.1).

- e39b723c-590c-4090-abb0-11e3e6616346
- fc0028ff-bfdc-499f-80dc-ed922c52c5e9
- 24afa313-0d3b-4c7c-b485-1047fd964b60
- 05dc046c-60e9-4ef7-965e-91660adffa68

### <a name="health-reports"></a>Отчеты о работоспособности

Приложение для управления исправлениями также публикует отчеты о работоспособности для службы координатора или службы агента узла в указанных ниже случаях.

#### <a name="a-windows-update-operation-failed"></a>Сбой операции обновления Windows

Если на узле происходит сбой операции обновления Windows, создается отчет о работоспособности для службы агента узла. Отчет о работоспособности содержит имя проблемного узла.

После установки исправления на проблемном узле отчет автоматически очищается.

#### <a name="the-node-agent-ntservice-is-down"></a>Служба NTService агента узла не работает

Если на узле не работает служба NTService агента узла, генерируется отчет о работоспособности уровня предупреждения для службы агента узла.

#### <a name="the-repair-manager-service-is-not-enabled"></a>Служба Repair Manager не включена

Если служба Repair Manager не найдена в кластере, для службы координатора создается отчет о работоспособности уровня предупреждения.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

В. **Почему мой кластер находится в состоянии ошибки, когда работает приложение для управления исправлениями?**

О. Приложение для управления исправлениями может отключать и перезапускать узлы во время установки, что может временно привести к ухудшению работоспособности кластера.

Основываясь на политике приложения, во время установки исправления любой узел может выйти из строя *или же* сбой может произойти во всем домене обновления.

К завершению установки обновлений Windows узлы будут повторно включены после перезагрузки.

В примере ниже кластер временно перешел в состояние ошибки, поскольку два узла вышли из строя и политика MaxPercentageUnhealthNodes была нарушена. Это временная ошибка. Она исчезнет, как только установка исправлений будет завершена.

![Представление неработоспособного кластера](media/service-fabric-patch-orchestration-application/MaxPercentage_causing_unhealthy_cluster.png)

Если проблема не будет устранена, см. сведения в разделе об устранении неполадок.

В. **Приложение для управления исправлениями находится в состоянии предупреждения**

О. Проверьте, является ли отчет о работоспособности, опубликованный для приложения, основной причиной. Обычно в описании предупреждения содержатся сведения о проблеме. Если проблема временная, приложение автоматически восстановится из этого состояния.

В. **Что делать, если нужно срочно обновить операционную систему, а кластер неработоспособен?**

О. Приложение для управления исправлениями не устанавливает обновления, пока кластер находится в неработоспособном состоянии. Попробуйте восстановить работоспособность кластера, чтобы разблокировать рабочий процесс приложения для управления исправлениями.

В. **Почему операция исправления в кластере так долго выполняется?**

О. Время, необходимое приложению для управления исправлениями, обычно зависит от факторов ниже.

- Политика службы координатора. 
  - Политика по умолчанию (`NodeWise`) ограничивает исправление только одним узлом за раз. Чтобы повысить скорость исправления для всех кластеров, рекомендуем использовать политику `UpgradeDomainWise` (особенно если речь идет о больших кластерах).
- Количество обновлений, доступных для загрузки и установки. 
- Среднее время загрузки и установки обновления (не более нескольких часов).
- Производительность виртуальных машин и пропуская способность сети.

В. **Почему некоторые обновления отображаются в результатах Центра обновления Windows, полученных через REST API, а не в журнале Центра обновлений Windows на компьютере?**

О. Сведения об обновлении некоторых продуктов необходимо записать после изменения в соответствующий журнал обновлений или исправлений. Например, сведения об обновлении Защитника Windows не отображаются в журнале Центра обновлений Windows в Windows Server 2016.

## <a name="disclaimers"></a>Заявления об отказе от ответственности

- Приложение для управления исправлениями принимает условия лицензионного соглашения Центра обновления Windows от имени пользователя. При необходимости этот параметр можно отключить в конфигурации приложения.

- Приложение для управления исправлениями собирает данные телеметрии для отслеживания использования и производительности. Телеметрия приложения выполняется в соответствии с настройкой телеметрии в среде выполнения Service Fabric (которая включена по умолчанию).

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="a-node-is-not-coming-back-to-up-state"></a>Узел не возвращается в рабочее состояние

**Возможная причина, по которой узел остался в отключенном состоянии**

Проверка безопасности находится в состоянии ожидания. В этом случае необходимо убедиться, что достаточное количество узлов находятся в работоспособном состоянии.

**Возможная причина, по которой узел остался в отключенном состоянии**

- Узел был отключен вручную.
- Узел был отключен из-за текущего задания инфраструктуры Azure.
- Узел был временно отключен приложением для управления исправлениями для исправления узла.

**Возможная причина, по которой узел остался в отключенном состоянии**

- Узел был переведен в неработоспособное состояние вручную.
- Узел находится в режиме перезапуска (который может быть инициирован приложением для управления исправлениями).
- Узел не работает из-за неисправности виртуальной машины, компьютера или проблем с подключением.

### <a name="updates-were-skipped-on-some-nodes"></a>Обновления на некоторых узлах пропущены

Приложение управления исправлениями пытается установить обновление Windows согласно политике перепланирования. Служба пытается восстановить узел и пропустить обновление в соответствии с политикой приложения.

В этом случае для службы агента узла будет создан отчет о работоспособности уровня предупреждения. Результат обновления Windows также содержит возможные причины сбоя.

### <a name="the-health-of-the-cluster-goes-to-error-while-the-update-installs"></a>При установке обновления кластер перешел в неработоспособное состояние

Некорректное обновление Windows может привести к потере работоспособности приложения или кластера в определенном узле или домене обновления. Приложение для управления исправлениями останавливает любые последующие операции обновления Windows, пока работоспособность кластера не восстановится.

Администратор должен определить, почему обновление Windows приводит к ухудшению работоспособности приложения или кластера.

## <a name="release-notes"></a>Заметки о выпуске

### <a name="version-110"></a>Версия 1.1.0
- Общедоступный выпуск

### <a name="version-111"></a>Версии 1.1.1
- Исправлена ошибка в SetupEntryPoint службы агента узла, которая препятствовала установке службы NTService агента узла.

### <a name="version-120-latest"></a>Версия 1.2.0 (последняя версия)

- Исправлены ошибки, связанные с рабочим процессом перезапуска системы.
- Исправлена ошибка при создании задач службы управления правами, из-за которой проверка работоспособности не выполнялась должным образом во время подготовки задач восстановления.
- Режим автоматического запуска службы POANodeSvc для Windows изменен на отложенный автоматический запуск.

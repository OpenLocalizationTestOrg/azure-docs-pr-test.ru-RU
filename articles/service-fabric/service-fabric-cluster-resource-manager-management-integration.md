---
title: "aaaService диспетчер ресурсов кластера структуры - интеграция с управлением | Документы Microsoft"
description: "Обзор hello точки интеграции между hello диспетчер ресурсов кластера и структуры управления службами."
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: 956cd0b8-b6e3-4436-a224-8766320e8cd7
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 9a24c9de121fbe2e8e5e8e4d117e64686918936a
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="cluster-resource-manager-integration-with-service-fabric-cluster-management"></a>Интеграция диспетчера кластерных ресурсов с управлением кластерами Service Fabric
Диспетчер ресурсов кластера Service Fabric Hello не диск обновления в Service Fabric, но он связан. Первый способ, помогает hello диспетчер ресурсов кластера с помощью управления за счет отслеживания hello Hello требуемое состояние кластера hello и hello служб внутри него. Диспетчер ресурсов кластера Hello отправляет отчеты о работоспособности при его невозможно перевести кластер hello в hello требуемой конфигурацией. Например если Недостаточно емкости hello диспетчер ресурсов кластера отправляет работоспособности предупреждений и ошибок, указывающих на проблемы hello. Другой фрагмент интеграции имеет toodo с работы обновления. Диспетчер ресурсов кластера Hello немного изменяет его поведение во время обновления.  

## <a name="health-integration"></a>Интеграция функций работоспособности
Диспетчер ресурсов кластера Hello постоянно отслеживает hello правил, определенных для размещения служб. Она также отслеживает hello оставшихся емкости для каждой метрики на узлах hello в кластере hello и в кластере hello в целом. Он передает предупреждения о работоспособности и сообщает об ошибках работоспособности, если не может выполнить эти правила или выделить достаточную емкость. Например если узел находится на емкость и hello диспетчер ресурсов кластера выполнит попытку toofix hello ситуации, перемещая служб. Если не удается исправить ситуацию hello он выдает предупреждение работоспособности, указывающее, какой из узлов по емкости, а какие метрики.

Еще один пример предупреждения работоспособности диспетчера ресурсов hello — нарушения ограничений размещения. Например, если вы определили ограничения размещения (например, `“NodeColor == Blue”`) и hello диспетчера ресурсов выявляется нарушение ограничения, он выдает предупреждение работоспособности. Это требование справедливо для пользовательских ограничений и ограничений по умолчанию hello (например, ограничения hello домен сбоя и доменов обновления).

Ниже приведен пример такого отчета о работоспособности. В этом случае отчет о работоспособности hello является одной из секций hello системной службы. сообщение Hello работоспособности указывает приветствия реплики этого раздела временно упакованы в слишком мало домены обновления.

```posh
PS C:\Users\User > Get-WindowsFabricPartitionHealth -PartitionId '00000000-0000-0000-0000-000000000001'


PartitionId           : 00000000-0000-0000-0000-000000000001
AggregatedHealthState : Warning
UnhealthyEvaluations  :
                        Unhealthy event: SourceId='System.PLB', Property='ReplicaConstraintViolation_UpgradeDomain', HealthState='Warning', ConsiderWarningAsError=false.

ReplicaHealthStates   :
                        ReplicaId             : 130766528804733380
                        AggregatedHealthState : Ok

                        ReplicaId             : 130766528804577821
                        AggregatedHealthState : Ok

                        ReplicaId             : 130766528854889931
                        AggregatedHealthState : Ok

                        ReplicaId             : 130766528804577822
                        AggregatedHealthState : Ok

                        ReplicaId             : 130837073190680024
                        AggregatedHealthState : Ok

HealthEvents          :
                        SourceId              : System.PLB
                        Property              : ReplicaConstraintViolation_UpgradeDomain
                        HealthState           : Warning
                        SequenceNumber        : 130837100116930204
                        SentAt                : 8/10/2015 7:53:31 PM
                        ReceivedAt            : 8/10/2015 7:53:33 PM
                        TTL                   : 00:01:05
                        Description           : hello Load Balancer has detected a Constraint Violation for this Replica: fabric:/System/FailoverManagerService Secondary Partition 00000000-0000-0000-0000-000000000001 is
                        violating hello Constraint: UpgradeDomain Details: UpgradeDomain ID -- 4, Replica on NodeName -- Node.8 Currently Upgrading -- false Distribution Policy -- Packing
                        RemoveWhenExpired     : True
                        IsExpired             : False
                        Transitions           : Ok->Warning = 8/10/2015 7:13:02 PM, LastError = 1/1/0001 12:00:00 AM
```

В сообщении о работоспособности содержатся следующие сведения:

1. Все реплики hello сами находятся в работоспособном состоянии: каждый имеет AggregatedHealthState: ОК
2. Hello ограничение распространения доменов обновления в настоящее время нарушается. Это означает, что в определенном домене обновления больше реплик из данной секции, чем должно быть.
3. Какой узел содержит может вызвать нарушение hello hello реплики. В этом случае это hello узел с именем hello «Node.8»
4. Выполняется ли в данный момент обновление этой секции ("Currently Upgrading -- false").
5. Здравствуйте, политика распространения для этой службы: «Упаковки--распространения политики». Это управляется hello `RequireDomainDistribution` [политика размещения](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md#requiring-replica-distribution-and-disallowing-packing). Значение "Packing" означает, что в этом случае распределение в доменах _не_ требовалось, поэтому нам известно, что политика размещения не была указана для этой службы. 
6. Когда отчет hello произошли - 8/10/2015 19:13:02: 00

Сведения этого предупреждения степени использования toodetect срабатывают в производственных toolet вы знаете, что-то пошло не так, а также как и прервет плохих обновлений. В этом случае toosee мы хотим, если мы выяснить, почему hello диспетчера ресурсов имели toopack hello реплик в hello доменов обновления. Обычно упаковки является временным, из-за узлов hello в hello других доменов обновления, например.

Предположим, что hello диспетчер ресурсов кластера пытается tooplace некоторые службы, но не все решения, которые работают. Если не удается поместить служб, это происходит по одной из следующих причин hello:

1. Некоторые переходным представляет собой невозможно tooplace этого экземпляра службы или реплики правильно
2. требования к размещению Hello службы быть реализован.

В этих случаях отчеты о работоспособности от hello диспетчер ресурсов кластера помогают определить, почему не могут быть размещены службы hello. Мы называем этот процесс hello ограничение исключения последовательности. Во время его hello системы рассматриваются hello настроить ограничения влияния на службу hello и записи их устранения. Таким образом, если службы не может toobe размещены, можно увидеть, какие узлы были устранены и почему.

## <a name="constraint-types"></a>Типы ограничений
Давайте поговорим о каждом hello различные ограничения в эти отчеты о работоспособности. Вы увидите ограничения toothese связанные сообщения работоспособности помещенный реплик.

* **ReplicaExclusionStatic** и **ReplicaExclusionDynamic**: этих ограничений указывает, что решение было отклонено, поскольку hello двух объектов службы из одной секции будет toobe помещены hello же узла. Это недопустимо, так как сбой данного узла чрезмерно повлиял бы на эту секцию. ReplicaExclusionStatic и ReplicaExclusionDynamic являются почти приветствия же правило и hello различия не имеет значения. Если вы видите, что последовательность исключения ограничение, содержащая либо hello ReplicaExclusionStatic или ReplicaExclusionDynamic ограничение hello диспетчер ресурсов кластера считает, что в нем не достаточное количество узлов. Для этого необходимо оставшихся решения toouse эти недопустимые размещениями, которые запрещены. Hello другими ограничениями в последовательности hello будет обычно Расскажите, почему узлы будут исключаться на первом месте hello.
* **PlacementConstraint**: Если вы видите это сообщение, значит, мы устранены некоторые узлы, так как они не удовлетворяет ограничениям hello службы размещения. Мы трассировки ограничений размещения hello в данный момент настроена как часть этого сообщения. Это нормально, если определено ограничение размещения. Тем не менее если ограничения на размещение неправильно вызывает слишком много toobe узлы устранить это, как можно будет заметить.
* **NodeCapacity**: это ограничение означает, что hello, диспетчер ресурсов кластера не удалось разместить hello реплик на hello указывает узлы, поскольку, поместить их возможности.
* **Сопоставление**: это ограничение задает, что мы не удалось размещения hello реплики на узлах hello влияет так, как это может привести к нарушению ограничения сходства hello. Дополнительные сведения о сходстве см. в [этой статье](service-fabric-cluster-resource-manager-advanced-placement-rules-affinity.md).
* **FaultDomain** и **UpgradeDomain**: это ограничение исключает узлов, если указано размещение hello реплики на hello узлов вызовет упаковки в конкретной ошибкой или домен обновления. Несколько примеров, посвященные этого ограничения перечислены в разделе hello на [ограничений доменов сбоя и обновления и результирующее поведение](service-fabric-cluster-resource-manager-cluster-description.md)
* **PreferredLocation**: это ограничение, удаление узлов из решения hello, так как он выполняется для оптимизации по умолчанию обычно не должны видеть. Hello предпочтительное ограничение расположения также присутствует во время обновления. Во время обновления это назад toowhere службы используется toomove, которые использовались при запуске обновления hello.

## <a name="blocklisting-nodes"></a>Добавление узлов в список блокировки
Узлы будут блокироваться и при другое сообщение hello диспетчер ресурсов кластера отчетов о работоспособности. Список блокировки можно считать временным ограничением, которое применяется автоматически. Узлы добавляются в список блокировки, когда на них повторяются сбои при запуске экземпляров заданного типа службы. Узлы добавляются в список блокировки на основе типа службы. Узел может быть добавлен в список блокировки для одного типа службы, но может отсутствовать в нем для другого типа службы. 

Вы увидите blocklisting включится часто во время разработки: некоторые ошибка приводит к toocrash узла службы во время запуска. Service Fabric пытается узла службы hello toocreate несколько раз, а продолжает возникать сбой hello. После нескольких попыток hello узел получает заблокированных и hello диспетчер ресурсов кластера будет пытаться toocreate hello службы в другом месте. Если, сбой повторяется на нескольких узлах, это возможно, все допустимые узлы hello в hello кластера окажутся заблокирован. Blocklisting можно также удалить так много узлов, недостаточно успешно запустить hello службы toomeet hello требуемого шкалы. Как правило, вы увидите дополнительные ошибки или предупреждения, связанные с hello диспетчер ресурсов кластера, указывающее, что служба hello ниже необходимой реплики hello или число экземпляров, а также сообщений о работоспособности, указывающее, какие ошибки hello, если приводит toohello blocklisting на первом месте hello.

Добавление в список блокировки не является окончательным. Через несколько минут hello узел удаляется из блокировки hello и Service Fabric может повторно активировать службы hello, на этом узле. Службы продолжения toofail hello узел снова становится блокироваться и для этого типа службы. 

### <a name="constraint-priorities"></a>Приоритеты ограничений

> [!WARNING]
> Изменение приоритетов ограничения не рекомендуется и может иметь значительное отрицательное воздействие на кластер. для ссылки приоритеты ограничение по умолчанию hello и их поведение предоставляется Hello ниже сведения. 
>

Со всеми этих ограничений вы может говорить «Эй — я думаю, важнее всего hello в моей системе ограничений доменов сбоя. В порядке tooensure hello ограничения домена сбоя не нарушены, я рассматривается tooviolate другими ограничениями.»

Для ограничений можно настроить различные уровни приоритета, а именно:

   - "жесткий" (0);
   - "мягкий" (1);
   - "оптимизационный" (2);
   - "отключен" (-1). 
   
Большинство ограничений hello настраиваются как жесткие ограничения по умолчанию.

Изменение приоритета hello ограничений редко. Было время там, где необходимо ограничение приоритеты toochange, обычно toowork вокруг некоторые ошибки или поведение, которое влияла на среде hello. Обычно hello гибкость инфраструктуры приоритет ограничение hello очень хорошо работает, но не требуется часто. Большую часть времени hello, все, что находится на их приоритеты по умолчанию. 

уровни приоритета Hello не означает, что ограничение данного _будет_ быть нарушен, ни, он всегда будет выполняться. Приоритеты ограничений определяют порядок, в котором накладываются ограничения. Приоритеты определяют компромиссы hello при невозможности toosatisfy все ограничения. Обычно все ограничения hello может быть выполнено, если что-то еще происходит в среде hello. Несколько примеров сценариев, которые могут стать причиной нарушения tooconstraint являются конфликтующими ограничениями или большое число одновременных сбоев.

В более сложных ситуациях можно изменить приоритеты ограничение hello. Допустим, требуется, чтобы tooensure, сопоставление будет нарушает всегда при необходимости toosolve емкость узла проблем. tooachieve это, можно установить приоритет hello hello сходства ограничения слишком «soft» (1) и оставить слишком «жесткий» задайте ограничения емкости hello (0).

значения приоритета по умолчанию Hello hello различные ограничения указаны в hello следующие конфигурации:

ClusterManifest.xml

```xml
        <Section Name="PlacementAndLoadBalancing">
            <Parameter Name="PlacementConstraintPriority" Value="0" />
            <Parameter Name="CapacityConstraintPriority" Value="0" />
            <Parameter Name="AffinityConstraintPriority" Value="0" />
            <Parameter Name="FaultDomainConstraintPriority" Value="0" />
            <Parameter Name="UpgradeDomainConstraintPriority" Value="1" />
            <Parameter Name="PreferredLocationConstraintPriority" Value="2" />
        </Section>
```

Для автономных развертываний используется ClusterConfig.json, а для размещенных в Azure кластеров — Template.json.

```json
"fabricSettings": [
  {
    "name": "PlacementAndLoadBalancing",
    "parameters": [
      {
          "name": "PlacementConstraintPriority",
          "value": "0"
      },
      {
          "name": "CapacityConstraintPriority",
          "value": "0"
      },
      {
          "name": "AffinityConstraintPriority",
          "value": "0"
      },
      {
          "name": "FaultDomainConstraintPriority",
          "value": "0"
      },
      {
          "name": "UpgradeDomainConstraintPriority",
          "value": "1"
      },
      {
          "name": "PreferredLocationConstraintPriority",
          "value": "2"
      }
    ]
  }
]
```

## <a name="fault-domain-and-upgrade-domain-constraints"></a>Ограничения доменов сбоя и обновления
Диспетчер ресурсов кластера Hello хочет tookeep служб распределено между доменами сбоя и обновления. Он моделирует как ограничение внутри hello диспетчер ресурсов кластера в модуль. Дополнительные сведения об их использовании и их определенное поведение, см. в статье hello на [конфигурация кластера](service-fabric-cluster-resource-manager-cluster-description.md#fault-and-upgrade-domain-constraints-and-resulting-behavior).

Hello диспетчер ресурсов кластера может потребоваться несколько реплик toopack в домене обновления в порядке toodeal обновления, сбои или другие нарушения ограничений. Обычно упаковки в домены сбоя или обновление происходит только при наличии нескольких ошибок или других обработки в системе hello, предотвращая правильное размещение. При желании tooprevent упаковки даже в таких ситуациях можно воспользоваться hello `RequireDomainDistribution` [политика размещения](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md#requiring-replica-distribution-and-disallowing-packing). Обратите внимание, что это может вызвать побочные эффекты, затрагивающие доступность и надежность службы, поэтому следует проявить осторожность.

Если среда hello настроена правильно, все ограничения полностью учитываются, даже во время обновления. Главное, что Hello является приветствия, диспетчер ресурсов кластера отслеживается то ограничения. При обнаружении нарушение он немедленно сообщает об этом и пытается toocorrect hello проблему.

## <a name="hello-preferred-location-constraint"></a>ограничение расположения предпочитаемый Hello
Hello PreferredLocation ограничение будет немного отличаться, как он имеет два различных варианта использования. Во-первых, это ограничение применяется во время обновления приложений. Hello диспетчер ресурсов кластера автоматически управляет этим ограничением во время обновления. Это используется tooensure что при обновлении будут завершены реплик возвращают tootheir начального расположения. Hello других hello PreferredLocation ограничение используется для hello [ `PreferredPrimaryDomain` политика размещения](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md). Оба являются оптимизации, и поэтому не hello PreferredLocation ограничение является hello Единственное ограничение, значение слишком «Оптимизация» по умолчанию.

## <a name="upgrades"></a>Обновления
Диспетчер ресурсов кластера Hello также помогает во время приложения и обновления кластера, во время которых он имеет два задания:

* Убедитесь, не скомпрометированы правила hello hello кластера
* Попробуйте перейти обновления toohelp hello плавно

### <a name="keep-enforcing-hello-rules"></a>Сохранить правила hello
учитывать toobe главное Hello — hello правила — hello строгие ограничения как ограничения размещения и емкости - по-прежнему используются во время обновления. Ограничения на размещение гарантируют, что все ваши рабочие нагрузки выполняются только на определенных узлах даже во время обновления. При высокой ограниченности служб обновления могут занимать больше времени. При hello службы или узел hello, запущенного на отключена для обновления может содержаться несколько параметров, для которых можно перейти.

### <a name="smart-replacements"></a>Интеллектуальные замены
При запуске обновления hello диспетчера ресурсов создает моментальный снимок текущего расположения hello hello кластера. Каждый домен обновления завершится, попытается tooreturn hello служб, которые были в этом расположении исходного tootheir доменов обновления. Таким образом не менее двух переходов для службы во время обновления hello. Отсутствует один перемещения out узла влияет hello и одно перемещение назад с. Возвращение hello toohow кластера или службы, которое было до обновления hello также гарантирует обновление hello не влияет на макет hello hello кластера. 

### <a name="reduced-churn"></a>Сокращение оттока
Другой происходит во время обновления заключается, который отключает диспетчер ресурсов кластера балансировки hello. Предотвращение балансировки предотвращает ненужные реакции toohello сам процесс обновления, как перемещение служб в узлы, которые были удалены для обновления hello. Если обновление hello рассматриваемой обновление кластера, весь кластер hello во время обновления hello не сбалансированы. Проверку ограничений останется активной, движение на метрик упреждающего балансировки hello отключено.

### <a name="buffered-capacity--upgrade"></a>Буферизованная емкость и обновление
Обычно нужно обновления toocomplete hello даже если кластер hello toofull ограниченного или закрыть. Управление емкостью hello hello кластера становится все более важной во время обновления чем обычно. В зависимости от hello число доменов обновления, в диапазоне от 5 до 20 процентов от общей мощности, необходимо перенести как hello обновления выполняет накат через hello кластер. Где-либо работы было toogo. Это где hello понятие [буфер производственные мощности](service-fabric-cluster-resource-manager-cluster-description.md#buffered-capacity) полезно. Буферизованная емкость учитывается во время обычной работы. во время обновления, при необходимости Hello диспетчер ресурсов кластера могут занять узлов вверх tootheir общей емкости (использование буфера hello).

## <a name="next-steps"></a>Дальнейшие действия
* Начать с начала hello и [получить введение toohello диспетчер ресурсов кластера Service Fabric](service-fabric-cluster-resource-manager-introduction.md)

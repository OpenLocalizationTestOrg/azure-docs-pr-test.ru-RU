---
title: "Настройка кластера Service Fabric с помощью Visual Studio | Документация Майкрософт"
description: "Описание настройки кластера Service Fabric с помощью шаблона Azure Resource Manager, созданного с использованием проекта группы ресурсов Azure в Visual Studio"
services: service-fabric
documentationcenter: .net
author: mikkelhegn
manager: adegeo
editor: 
ms.assetid: bd2c0511-36c9-4828-8dc3-69e4b6a70567
ms.service: service-fabric
ms.devlang: dotNet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 02/21/2017
ms.author: mikhegn
redirect_url: /azure/service-fabric/service-fabric-cluster-creation-via-arm
ms.openlocfilehash: c43145b96cdbdfaa7e1893e50d027321fe4c0510
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="set-up-a-service-fabric-cluster-by-using-visual-studio"></a>Настройка кластера Service Fabric с помощью Visual Studio
В этой статье описывается настройка кластера Azure Service Fabric с помощью Visual Studio и шаблона Azure Resource Manager. Для создания шаблона мы будем использовать проект группы ресурсов Azure Visual Studio. После создания шаблона его можно развернуть напрямую в Azure из Visual Studio. Его также можно использовать из сценария или в ходе процесса непрерывной интеграции (CI).

## <a name="create-a-service-fabric-cluster-template-by-using-an-azure-resource-group-project"></a>Создание шаблона кластера Service Fabric с помощью проекта группы ресурсов Azure
Чтобы начать работу, откройте Visual Studio и создайте проект группы ресурсов Azure (он доступен в папке **Облако** ).

![Диалоговое окно "Новый проект" с выбранным проектом группы ресурсов Azure][1]

Можно создать новое решение Visual Studio для данного проекта или добавить его в существующее решение.

> [!NOTE]
> Если проект группы ресурсов Azure не отображается в узле "Облако", значит у вас не установлен пакет SDK Azure. Запустите установщик веб-платформы ([установите его отсюда](http://www.microsoft.com/web/downloads/platform.aspx) , если еще этого не сделали), затем выполните поиск по фразе "пакет SDK Azure для .NET" и установите версию, совместимую с используемой версией Visual Studio.
> 
> 

После нажатия кнопки OK Visual Studio предложит выбрать шаблон диспетчера ресурсов, который требуется создать:

![Диалоговое окно "Выбор шаблона Azure" с выбранным шаблоном кластера Service Fabric][2]

Выберите шаблон "Кластер Service Fabric" и нажмите кнопку ОК. Проект и шаблон диспетчера ресурсов созданы.

## <a name="prepare-the-template-for-deployment"></a>Подготовка шаблона к развертыванию
Перед развертыванием шаблона для создания кластера необходимо указать значения для обязательных параметров шаблона. Эти значения параметров считываются из файла `ServiceFabricCluster.parameters.json`, который находится в папке `Templates` проекта группы ресурсов. Откройте файл и укажите следующие значения.

| Имя параметра | Описание |
| --- | --- |
| adminUserName |Имя учетной записи администратора для компьютеров Service Fabric (узлов). |
| certificateThumbprint |Отпечаток сертификата, который обеспечивает защиту кластера. |
| sourceVaultResourceId |*Идентификатор ресурса* хранилища ключей, где хранится сертификат, который обеспечивает защиту кластера. |
| certificateUrlValue |URL-адрес сертификата безопасности кластера. |

Шаблон диспетчера ресурсов Service Fabric Visual Studio создает безопасный кластер, защищенный с помощью сертификата. Этот сертификат определяется по трем последним параметрам шаблона (`certificateThumbprint`, `sourceVaultValue` и `certificateUrlValue`) и должен находиться в **хранилище ключей Azure**. Дополнительные сведения о создании сертификата безопасности кластера см. в статье [Сценарии защиты кластера Service Fabric](service-fabric-cluster-security.md#x509-certificates-and-service-fabric).

## <a name="optional-change-the-cluster-name"></a>Изменение имени кластера (необязательно)
У каждого кластера Service Fabric есть имя. При создании кластера Fabric в Azure имя кластера (вместе с регионом Azure) определяет имя системы доменных имен (DNS) для кластера. Например, если имя кластера — `myBigCluster`, а группа ресурсов, в которой будет размещаться новый кластер, находится в регионе Azure "Восточная часть США", то DNS-имя кластера будет `myBigCluster.eastus.cloudapp.azure.com`.

По умолчанию имя кластера создается автоматически, и для того, чтобы оно было уникальным, к префиксу "cluster" добавляется случайный суффикс. Это позволяет легко использовать шаблон в системе **непрерывной интеграции** (CI). Если вы хотите использовать определенное осмысленное имя для кластера, задайте его в переменной `clusterName` в файле шаблона Resource Manager (`ServiceFabricCluster.json`). Это первая переменная, определенная в этом файле.

## <a name="optional-add-public-application-ports"></a>Добавление общедоступных портов приложения (необязательно)
Также можно изменить открытые порты приложений кластера перед его развертыванием. По умолчанию в шаблоне открыты только два TCP-порта (80 и 8081). Если вашим приложениям необходимо больше открытых портов, измените определение балансировщика нагрузки Azure в шаблоне. Определение хранится в файле основного шаблона (`ServiceFabricCluster.json`). Откройте этот файл и выполните поиск `loadBalancedAppPort`. Каждый порт связан с тремя артефактами.

1. Переменная шаблона, который определяет значение TCP-порта для порта:
   
    ```json
    "loadBalancedAppPort1": "80"
    ```
2. *Проба*, которая определяет, как часто и как долго балансировщик нагрузки Azure будет пытаться использовать конкретный узел Service Fabric до перехода на другой узел. Пробы являются частью ресурса балансировщика нагрузки. Далее приводится определение проверки для первого порта приложения по умолчанию:
   
    ```json
    {
        "name": "AppPortProbe1",
        "properties": {
            "intervalInSeconds": 5,
            "numberOfProbes": 2,
            "port": "[variables('loadBalancedAppPort1')]",
            "protocol": "Tcp"
        }
    }
    ```
3. *Правило балансировки нагрузки* , которое связывает порт и пробу, которая включает балансировку нагрузки в наборе узлов кластера Service Fabric.
   
    ```json
    {
        "name": "AppPortLBRule1",
        "properties": {
            "backendAddressPool": {
                "id": "[variables('lbPoolID0')]"
            },
            "backendPort": "[variables('loadBalancedAppPort1')]",
            "enableFloatingIP": false,
            "frontendIPConfiguration": {
                "id": "[variables('lbIPConfig0')]"
            },
            "frontendPort": "[variables('loadBalancedAppPort1')]",
            "idleTimeoutInMinutes": 5,
            "probe": {
                "id": "[concat(variables('lbID0'),'/probes/AppPortProbe1')]"
            },
            "protocol": "Tcp"
        }
    }
    ```
   Если приложениям, которые вы хотите развернуть в кластере, нужны дополнительные порты, их можно добавить путем создания дополнительной проверки и определений правил балансировки нагрузки. Дополнительные сведения о работе с балансировщиком нагрузки Azure с помощью шаблонов Resource Manager см. в статье [Начало работы по созданию внутреннего балансировщика нагрузки с помощью шаблона](../load-balancer/load-balancer-get-started-ilb-arm-template.md).

## <a name="deploy-the-template-by-using-visual-studio"></a>Развертывание шаблона с помощью Visual Studio
После сохранения всех обязательных параметров в файл`ServiceFabricCluster.param.dev.json` можно приступить к развертыванию шаблона и созданию кластера Service Fabric. Щелкните правой кнопкой мыши проект группы ресурсов в обозревателе решений Visual Studio и выберите **Развернуть &gt; Новое развертывание**. В Visual Studio откроется диалоговое окно **Развертывание в группе ресурсов** с запросом на прохождение проверки подлинности в Azure (если необходимо).

![Диалоговое окно "Развертывание в группе ресурсов"][3]

В диалоговом окне можно выбрать существующую группу ресурсов диспетчера ресурсов для кластера или создать новую. Как правило, для кластера Service Fabric целесообразно использовать отдельную группу ресурсов.

После нажатия кнопки "Развернуть" Visual Studio предложит подтвердить значения параметров шаблона. Нажмите кнопку **Сохранить** . Один параметр не имеет сохраненного значения: это пароль учетной записи администратора для кластера. Это значение необходимо указать, когда Visual Studio предложит это сделать.

> [!NOTE]
> Начиная с версии Azure SDK 2.9, Visual Studio поддерживает чтение паролей из **хранилища ключей Azure** во время развертывания. Обратите внимание, что в диалоговом окне параметров шаблона у текстового поля параметра `adminPassword` есть небольшой значок ключа справа. Этот значок позволяет выбрать существующий секрет хранилища ключей в качестве пароля администратора кластера. Сначала необходимо лишь разрешить доступ Azure Resource Manager для развертывания шаблона в разделе "Политики расширенного доступа" хранилища ключей. 
> 
> 

Ход выполнения процесса развертывания можно отследить в окне выходных данных Visual Studio. После завершения развертывания шаблонов новый кластер готов к использованию!

> [!NOTE]
> Если среда PowerShell никогда не использовалась для администрирования Azure с компьютера, который используется в настоящий момент, необходимо выполнить некоторые служебные действия.
> 
> 1. Включите поддержку сценариев PowerShell, выполнив команду [`Set-ExecutionPolicy`](https://technet.microsoft.com/library/hh849812.aspx) . Для компьютеров разработчиков обычно устанавливается политика "Без ограничений".
> 2. Решите, следует ли разрешить сбор диагностических данных от команд Azure PowerShell, и при необходимости выполните команды [`Enable-AzureRmDataCollection`](https://msdn.microsoft.com/library/mt619303.aspx) или [`Disable-AzureRmDataCollection`](https://msdn.microsoft.com/library/mt619236.aspx). Это позволит избежать вывода ненужных запросов во время развертывания шаблона.
> 
> 

При появлении ошибок перейдите на [портал Azure](https://portal.azure.com/) и откройте группу ресурсов, в которую вы выполнили развертывание. Выберите **Все параметры**, а затем **Развертывания** в колонке "Параметры". Здесь будут находиться подробные диагностические сведения о неудачном развертывании группы ресурсов.

> [!NOTE]
> Для кластеров Service Fabric требуется постоянное наличие определенного количества узлов, чтобы поддерживать доступность и сохранять состояние — это называется "поддержанием кворума". Поэтому не рекомендуется завершать работу всех виртуальных машин в кластере, пока не будет выполнено [полное резервное копирование состояния](service-fabric-reliable-services-backup-restore.md), так как это может быть небезопасно.
> 
> 

## <a name="next-steps"></a>Дальнейшие действия
* [Узнайте больше о настройке кластера Service Fabric с помощью портала Azure](service-fabric-cluster-creation-via-portal.md)
* [Узнайте больше о развертывании приложений Service Fabric и управлении ими с помощью Visual Studio](service-fabric-manage-application-in-visual-studio.md)

<!--Image references-->
[1]: ./media/service-fabric-cluster-creation-via-visual-studio/azure-resource-group-project-creation.png
[2]: ./media/service-fabric-cluster-creation-via-visual-studio/selecting-azure-template.png
[3]: ./media/service-fabric-cluster-creation-via-visual-studio/deploy-to-azure.png

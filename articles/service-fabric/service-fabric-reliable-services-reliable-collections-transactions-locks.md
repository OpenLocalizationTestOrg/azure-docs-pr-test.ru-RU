---
title: "aaaTransactions и режимов блокировки в Azure Service Fabric надежного коллекций | Документы Microsoft"
description: "Транзакции и блокировка диспетчера надежных состояний и надежных коллекций Azure Service Fabric."
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: masnider,rajak
ms.assetid: 62857523-604b-434e-bd1c-2141ea4b00d1
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: required
ms.date: 5/1/2017
ms.author: mcoskun
ms.openlocfilehash: 340e029aa98f43ad6e46b48f687dad01f9d96f69
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="transactions-and-lock-modes-in-azure-service-fabric-reliable-collections"></a><span data-ttu-id="72628-103">Транзакции и режимы блокировки в надежных коллекциях Azure Service Fabric</span><span class="sxs-lookup"><span data-stu-id="72628-103">Transactions and lock modes in Azure Service Fabric Reliable Collections</span></span>

## <a name="transaction"></a><span data-ttu-id="72628-104">транзакция:</span><span class="sxs-lookup"><span data-stu-id="72628-104">Transaction</span></span>
<span data-ttu-id="72628-105">Транзакция — это последовательность операций, выполняемых в одной логической единице работы.</span><span class="sxs-lookup"><span data-stu-id="72628-105">A transaction is a sequence of operations performed as a single logical unit of work.</span></span>
<span data-ttu-id="72628-106">Транзакция должна обладать следующими свойствами ACID hello.</span><span class="sxs-lookup"><span data-stu-id="72628-106">A transaction must exhibit hello following ACID properties.</span></span> <span data-ttu-id="72628-107">(см.: https://technet.microsoft.com/en-us/library/ms190612).</span><span class="sxs-lookup"><span data-stu-id="72628-107">(see: https://technet.microsoft.com/en-us/library/ms190612)</span></span>
* <span data-ttu-id="72628-108">**Атомарность**. Транзакция должна быть атомарной единицей работы.</span><span class="sxs-lookup"><span data-stu-id="72628-108">**Atomicity**: A transaction must be an atomic unit of work.</span></span> <span data-ttu-id="72628-109">Другими словами, должны выполняться либо все ее изменения данных, либо ни одно из них.</span><span class="sxs-lookup"><span data-stu-id="72628-109">In other words, either all its data modifications are performed, or none of them is performed.</span></span>
* <span data-ttu-id="72628-110">**Согласованность**. По завершении транзакция должна оставить все данные в согласованном состоянии.</span><span class="sxs-lookup"><span data-stu-id="72628-110">**Consistency**: When completed, a transaction must leave all data in a consistent state.</span></span> <span data-ttu-id="72628-111">Все внутренние структуры данных должны быть правильными в конце hello hello транзакции.</span><span class="sxs-lookup"><span data-stu-id="72628-111">All internal data structures must be correct at hello end of hello transaction.</span></span>
* <span data-ttu-id="72628-112">**Изоляция**: изменения, произведенные в параллельных транзакций должны быть изолированы от hello изменения, сделанные другими параллельно выполняемыми транзакциями.</span><span class="sxs-lookup"><span data-stu-id="72628-112">**Isolation**: Modifications made by concurrent transactions must be isolated from hello modifications made by any other concurrent transactions.</span></span> <span data-ttu-id="72628-113">Hello уровня изоляции, используемого для операции в пределах ITransaction определяется hello IReliableState выполнение операции hello.</span><span class="sxs-lookup"><span data-stu-id="72628-113">hello isolation level used for an operation within an ITransaction is determined by hello IReliableState performing hello operation.</span></span>
* <span data-ttu-id="72628-114">**Устойчивость**: после завершения транзакции, его влияние занимают постоянное место в системе hello.</span><span class="sxs-lookup"><span data-stu-id="72628-114">**Durability**: After a transaction has completed, its effects are permanently in place in hello system.</span></span> <span data-ttu-id="72628-115">Hello изменения сохраняются даже в случае hello сбоя системы.</span><span class="sxs-lookup"><span data-stu-id="72628-115">hello modifications persist even in hello event of a system failure.</span></span>

### <a name="isolation-levels"></a><span data-ttu-id="72628-116">Уровни изоляции</span><span class="sxs-lookup"><span data-stu-id="72628-116">Isolation levels</span></span>
<span data-ttu-id="72628-117">Уровень изоляции определяет степень hello toowhich hello транзакция должна быть изолирована от изменений, внесенных другими транзакциями.</span><span class="sxs-lookup"><span data-stu-id="72628-117">Isolation level defines hello degree toowhich hello transaction must be isolated from modifications made by other transactions.</span></span>
<span data-ttu-id="72628-118">Надежные коллекции поддерживают два уровня изоляции:</span><span class="sxs-lookup"><span data-stu-id="72628-118">There are two isolation levels that are supported in Reliable Collections:</span></span>

* <span data-ttu-id="72628-119">**REPEATABLE Read**: Указывает, что инструкции не могут считывать данные, которые были изменены, но еще не зафиксированы другими транзакциями, и что другие транзакции не могут изменять данные, считанные текущей транзакцией hello до текущего hello Завершает транзакцию.</span><span class="sxs-lookup"><span data-stu-id="72628-119">**Repeatable Read**: Specifies that statements cannot read data that has been modified but not yet committed by other transactions and that no other transactions can modify data that has been read by hello current transaction until hello current transaction finishes.</span></span> <span data-ttu-id="72628-120">Дополнительные сведения см. в статье [https://msdn.microsoft.com/library/ms173763.aspx](https://msdn.microsoft.com/library/ms173763.aspx).</span><span class="sxs-lookup"><span data-stu-id="72628-120">For more details, see [https://msdn.microsoft.com/library/ms173763.aspx](https://msdn.microsoft.com/library/ms173763.aspx).</span></span>
* <span data-ttu-id="72628-121">**Моментальный снимок**: Указывает, что данные, считанные любой инструкцией транзакции является транзакционно согласованной версии hello hello данных, существовавших в начале hello hello транзакции.</span><span class="sxs-lookup"><span data-stu-id="72628-121">**Snapshot**: Specifies that data read by any statement in a transaction is hello transactionally consistent version of hello data that existed at hello start of hello transaction.</span></span>
  <span data-ttu-id="72628-122">Hello транзакция распознает только те изменения данных, которые были зафиксированы до начала hello hello транзакции.</span><span class="sxs-lookup"><span data-stu-id="72628-122">hello transaction can recognize only data modifications that were committed before hello start of hello transaction.</span></span>
  <span data-ttu-id="72628-123">Изменения данных, произведенных другими транзакциями после начала текущей транзакции hello hello не являются видимыми toostatements выполнения текущей транзакции hello.</span><span class="sxs-lookup"><span data-stu-id="72628-123">Data modifications made by other transactions after hello start of hello current transaction are not visible toostatements executing in hello current transaction.</span></span>
  <span data-ttu-id="72628-124">Hello действует, как если бы hello получения инструкциями в транзакции моментального снимка зафиксированных hello данных они имели на момент начала hello hello транзакции.</span><span class="sxs-lookup"><span data-stu-id="72628-124">hello effect is as if hello statements in a transaction get a snapshot of hello committed data as it existed at hello start of hello transaction.</span></span>
  <span data-ttu-id="72628-125">Моментальные снимки согласованы между надежными коллекциями.</span><span class="sxs-lookup"><span data-stu-id="72628-125">Snapshots are consistent across Reliable Collections.</span></span>
  <span data-ttu-id="72628-126">Дополнительные сведения см. в статье [https://msdn.microsoft.com/library/ms173763.aspx](https://msdn.microsoft.com/library/ms173763.aspx).</span><span class="sxs-lookup"><span data-stu-id="72628-126">For more details, see [https://msdn.microsoft.com/library/ms173763.aspx](https://msdn.microsoft.com/library/ms173763.aspx).</span></span>

<span data-ttu-id="72628-127">Надежные коллекции автоматически выбираться hello toouse уровня изоляции для данной операции чтения в зависимости от операции hello и роль hello hello реплики во время hello создания транзакции.</span><span class="sxs-lookup"><span data-stu-id="72628-127">Reliable Collections automatically choose hello isolation level toouse for a given read operation depending on hello operation and hello role of hello replica at hello time of transaction's creation.</span></span>
<span data-ttu-id="72628-128">Ниже приведен hello таблицы, которая описывает изоляции значения по умолчанию уровне словаря надежного и очередь операций.</span><span class="sxs-lookup"><span data-stu-id="72628-128">Following is hello table that depicts isolation level defaults for Reliable Dictionary and Queue operations.</span></span>

| <span data-ttu-id="72628-129">Операция \ Роль</span><span class="sxs-lookup"><span data-stu-id="72628-129">Operation \ Role</span></span> | <span data-ttu-id="72628-130">Первичная</span><span class="sxs-lookup"><span data-stu-id="72628-130">Primary</span></span> | <span data-ttu-id="72628-131">Вторичная</span><span class="sxs-lookup"><span data-stu-id="72628-131">Secondary</span></span> |
| --- |:--- |:--- |
| <span data-ttu-id="72628-132">Операция чтения одной сущности</span><span class="sxs-lookup"><span data-stu-id="72628-132">Single Entity Read</span></span> |<span data-ttu-id="72628-133">Повторяющаяся операция чтения</span><span class="sxs-lookup"><span data-stu-id="72628-133">Repeatable Read</span></span> |<span data-ttu-id="72628-134">Снимок</span><span class="sxs-lookup"><span data-stu-id="72628-134">Snapshot</span></span> |
| <span data-ttu-id="72628-135">Перечисление, подсчет</span><span class="sxs-lookup"><span data-stu-id="72628-135">Enumeration, Count</span></span> |<span data-ttu-id="72628-136">Снимок</span><span class="sxs-lookup"><span data-stu-id="72628-136">Snapshot</span></span> |<span data-ttu-id="72628-137">Снимок</span><span class="sxs-lookup"><span data-stu-id="72628-137">Snapshot</span></span> |

> [!NOTE]
> <span data-ttu-id="72628-138">Распространенные примеры операций с одной сущностью: `IReliableDictionary.TryGetValueAsync`, `IReliableQueue.TryPeekAsync`.</span><span class="sxs-lookup"><span data-stu-id="72628-138">Common examples for Single Entity Operations are `IReliableDictionary.TryGetValueAsync`, `IReliableQueue.TryPeekAsync`.</span></span>
> 

<span data-ttu-id="72628-139">Hello надежного словаря и hello надежные очереди поддерживает ваш записывает чтения.</span><span class="sxs-lookup"><span data-stu-id="72628-139">Both hello Reliable Dictionary and hello Reliable Queue support Read Your Writes.</span></span>
<span data-ttu-id="72628-140">Другими словами, любой записи в транзакции видны tooa следующие читается, принадлежит toohello одной транзакции.</span><span class="sxs-lookup"><span data-stu-id="72628-140">In other words, any write within a transaction will be visible tooa following read that belongs toohello same transaction.</span></span>

## <a name="locks"></a><span data-ttu-id="72628-141">Блокировки</span><span class="sxs-lookup"><span data-stu-id="72628-141">Locks</span></span>
<span data-ttu-id="72628-142">В списке надежных коллекции всех транзакций реализуйте строгие двухфазной блокировки: hello блокировки, он получил до завершения транзакции hello прерывания или фиксации транзакции не освобождает.</span><span class="sxs-lookup"><span data-stu-id="72628-142">In Reliable Collections, all transactions implement rigorous two phase locking: a transaction does not release hello locks it has acquired until hello transaction terminates with either an abort or a commit.</span></span>

<span data-ttu-id="72628-143">Надежный словарь использует блокировку уровня строки для всех операций с одной сущностью.</span><span class="sxs-lookup"><span data-stu-id="72628-143">Reliable Dictionary uses row level locking for all single entity operations.</span></span>
<span data-ttu-id="72628-144">Надежная очередь поступается параллелизмом ради строгого соблюдения транзакционного свойства FIFO.</span><span class="sxs-lookup"><span data-stu-id="72628-144">Reliable Queue trades off concurrency for strict transactional FIFO property.</span></span>
<span data-ttu-id="72628-145">Надежная очередь использует блокировки уровня операции, позволяя одновременно выполнять одну транзакцию с `TryPeekAsync` и (или) `TryDequeueAsync` и одну транзакцию с `EnqueueAsync`.</span><span class="sxs-lookup"><span data-stu-id="72628-145">Reliable Queue uses operation level locks allowing one transaction with `TryPeekAsync` and/or `TryDequeueAsync` and one transaction with `EnqueueAsync` at a time.</span></span>
<span data-ttu-id="72628-146">Обратите внимание на то что toopreserve FIFO, если `TryPeekAsync` или `TryDequeueAsync` когда-либо обнаруживает, что hello надежного очередь пуста, также блокируется `EnqueueAsync`.</span><span class="sxs-lookup"><span data-stu-id="72628-146">Note that toopreserve FIFO, if a `TryPeekAsync` or `TryDequeueAsync` ever observes that hello Reliable Queue is empty, they will also lock `EnqueueAsync`.</span></span>

<span data-ttu-id="72628-147">Операции записи всегда используют монопольные блокировки.</span><span class="sxs-lookup"><span data-stu-id="72628-147">Write operations always take Exclusive locks.</span></span>
<span data-ttu-id="72628-148">Для операций чтения hello блокировки зависит от ряд факторов.</span><span class="sxs-lookup"><span data-stu-id="72628-148">For read operations, hello locking depends on a couple of factors.</span></span>
<span data-ttu-id="72628-149">В операциях чтения, выполняемых с уровнем изоляции "Снимок", блокировки не используются.</span><span class="sxs-lookup"><span data-stu-id="72628-149">Any read operation done using Snapshot isolation is lock free.</span></span>
<span data-ttu-id="72628-150">В повторяющихся операциях чтения используются совмещаемые блокировки (по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="72628-150">Any Repeatable Read operation by default takes Shared locks.</span></span>
<span data-ttu-id="72628-151">Однако для любой операции чтения, поддерживающем Repeatable Read, hello пользователь может запросить для блокировки обновления вместо hello совмещаемой блокировки.</span><span class="sxs-lookup"><span data-stu-id="72628-151">However, for any read operation that supports Repeatable Read, hello user can ask for an Update lock instead of hello Shared lock.</span></span>
<span data-ttu-id="72628-152">Блокировка обновления — блокировки асимметричного используемых tooprevent распространенной формы взаимоблокировки, которая возникает, когда несколько транзакции блокируют ресурсы для потенциальных обновления на более позднее время.</span><span class="sxs-lookup"><span data-stu-id="72628-152">An Update lock is an asymmetric lock used tooprevent a common form of deadlock that occurs when multiple transactions lock resources for potential updates at a later time.</span></span>

<span data-ttu-id="72628-153">Матрица совместимости блокировок Hello можно найти в следующей таблице hello:</span><span class="sxs-lookup"><span data-stu-id="72628-153">hello lock compatibility matrix can be found in hello following table:</span></span>

| <span data-ttu-id="72628-154">Запрос \ Предоставлено</span><span class="sxs-lookup"><span data-stu-id="72628-154">Request \ Granted</span></span> | <span data-ttu-id="72628-155">Без блокировки</span><span class="sxs-lookup"><span data-stu-id="72628-155">None</span></span> | <span data-ttu-id="72628-156">Совмещаемая блокировка</span><span class="sxs-lookup"><span data-stu-id="72628-156">Shared</span></span> | <span data-ttu-id="72628-157">Блокировка изменений</span><span class="sxs-lookup"><span data-stu-id="72628-157">Update</span></span> | <span data-ttu-id="72628-158">Монопольная блокировка</span><span class="sxs-lookup"><span data-stu-id="72628-158">Exclusive</span></span> |
| --- |:--- |:--- |:--- |:--- |
| <span data-ttu-id="72628-159">Совмещаемая блокировка</span><span class="sxs-lookup"><span data-stu-id="72628-159">Shared</span></span> |<span data-ttu-id="72628-160">Нет конфликтов</span><span class="sxs-lookup"><span data-stu-id="72628-160">No conflict</span></span> |<span data-ttu-id="72628-161">Нет конфликтов</span><span class="sxs-lookup"><span data-stu-id="72628-161">No conflict</span></span> |<span data-ttu-id="72628-162">Конфликт</span><span class="sxs-lookup"><span data-stu-id="72628-162">Conflict</span></span> |<span data-ttu-id="72628-163">Конфликт</span><span class="sxs-lookup"><span data-stu-id="72628-163">Conflict</span></span> |
| <span data-ttu-id="72628-164">Блокировка изменений</span><span class="sxs-lookup"><span data-stu-id="72628-164">Update</span></span> |<span data-ttu-id="72628-165">Нет конфликтов</span><span class="sxs-lookup"><span data-stu-id="72628-165">No conflict</span></span> |<span data-ttu-id="72628-166">Нет конфликтов</span><span class="sxs-lookup"><span data-stu-id="72628-166">No conflict</span></span> |<span data-ttu-id="72628-167">Конфликт</span><span class="sxs-lookup"><span data-stu-id="72628-167">Conflict</span></span> |<span data-ttu-id="72628-168">Конфликт</span><span class="sxs-lookup"><span data-stu-id="72628-168">Conflict</span></span> |
| <span data-ttu-id="72628-169">Монопольная блокировка</span><span class="sxs-lookup"><span data-stu-id="72628-169">Exclusive</span></span> |<span data-ttu-id="72628-170">Нет конфликтов</span><span class="sxs-lookup"><span data-stu-id="72628-170">No conflict</span></span> |<span data-ttu-id="72628-171">Конфликт</span><span class="sxs-lookup"><span data-stu-id="72628-171">Conflict</span></span> |<span data-ttu-id="72628-172">Конфликт</span><span class="sxs-lookup"><span data-stu-id="72628-172">Conflict</span></span> |<span data-ttu-id="72628-173">Конфликт</span><span class="sxs-lookup"><span data-stu-id="72628-173">Conflict</span></span> |

<span data-ttu-id="72628-174">Аргумент тайм-аута в hello надежные API-интерфейсы коллекций используется для обнаружения взаимоблокировок.</span><span class="sxs-lookup"><span data-stu-id="72628-174">Time-out argument in hello Reliable Collections APIs is used for deadlock detection.</span></span>
<span data-ttu-id="72628-175">Например две транзакции (T1 и T2) пытаетесь tooread и обновите K1.</span><span class="sxs-lookup"><span data-stu-id="72628-175">For example, two transactions (T1 and T2) are trying tooread and update K1.</span></span>
<span data-ttu-id="72628-176">Существует возможность их toodeadlock, так как они в конечном итоге Здравствуйте, имеющих общие блокировки.</span><span class="sxs-lookup"><span data-stu-id="72628-176">It is possible for them toodeadlock, because they both end up having hello Shared lock.</span></span>
<span data-ttu-id="72628-177">В этом случае одного или нескольких операций hello выдаст ошибку времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="72628-177">In this case, one or both of hello operations will time out.</span></span>

<span data-ttu-id="72628-178">Ситуация с взаимоблокировкой является хорошим примером того, как блокировка изменений может предотвратить возникновение взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="72628-178">This deadlock scenario is a great example of how an Update lock can prevent deadlocks.</span></span>

## <a name="next-steps"></a><span data-ttu-id="72628-179">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="72628-179">Next steps</span></span>
* [<span data-ttu-id="72628-180">Работа с Reliable Collections</span><span class="sxs-lookup"><span data-stu-id="72628-180">Working with Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
* [<span data-ttu-id="72628-181">Уведомления Reliable Services</span><span class="sxs-lookup"><span data-stu-id="72628-181">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
* [<span data-ttu-id="72628-182">Архивация и восстановление (аварийное восстановление) надежных служб</span><span class="sxs-lookup"><span data-stu-id="72628-182">Reliable Services backup and restore (disaster recovery)</span></span>](service-fabric-reliable-services-backup-restore.md)
* [<span data-ttu-id="72628-183">Конфигурация диспетчера надежных состояний</span><span class="sxs-lookup"><span data-stu-id="72628-183">Reliable State Manager configuration</span></span>](service-fabric-reliable-services-configuration.md)
* [<span data-ttu-id="72628-184">Справочник разработчика по надежным коллекциям</span><span class="sxs-lookup"><span data-stu-id="72628-184">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)


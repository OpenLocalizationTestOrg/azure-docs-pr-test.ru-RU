---
title: "Транзакции и режимы блокировки в надежных коллекциях Azure Service Fabric | Документы Майкрософт"
description: "Транзакции и блокировка диспетчера надежных состояний и надежных коллекций Azure Service Fabric."
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: masnider,rajak
ms.assetid: 62857523-604b-434e-bd1c-2141ea4b00d1
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: required
ms.date: 5/1/2017
ms.author: mcoskun
ms.openlocfilehash: 3452473f5b2f86d29e46339c997193bc6403736a
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="transactions-and-lock-modes-in-azure-service-fabric-reliable-collections"></a><span data-ttu-id="d6ce4-103">Транзакции и режимы блокировки в надежных коллекциях Azure Service Fabric</span><span class="sxs-lookup"><span data-stu-id="d6ce4-103">Transactions and lock modes in Azure Service Fabric Reliable Collections</span></span>

## <a name="transaction"></a><span data-ttu-id="d6ce4-104">транзакция:</span><span class="sxs-lookup"><span data-stu-id="d6ce4-104">Transaction</span></span>
<span data-ttu-id="d6ce4-105">Транзакция — это последовательность операций, выполняемых в одной логической единице работы.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-105">A transaction is a sequence of operations performed as a single logical unit of work.</span></span>
<span data-ttu-id="d6ce4-106">Транзакция должна представлять приведенные ниже свойства ACID</span><span class="sxs-lookup"><span data-stu-id="d6ce4-106">A transaction must exhibit the following ACID properties.</span></span> <span data-ttu-id="d6ce4-107">(см.: https://technet.microsoft.com/en-us/library/ms190612).</span><span class="sxs-lookup"><span data-stu-id="d6ce4-107">(see: https://technet.microsoft.com/en-us/library/ms190612)</span></span>
* <span data-ttu-id="d6ce4-108">**Атомарность**. Транзакция должна быть атомарной единицей работы.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-108">**Atomicity**: A transaction must be an atomic unit of work.</span></span> <span data-ttu-id="d6ce4-109">Другими словами, должны выполняться либо все ее изменения данных, либо ни одно из них.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-109">In other words, either all its data modifications are performed, or none of them is performed.</span></span>
* <span data-ttu-id="d6ce4-110">**Согласованность**. По завершении транзакция должна оставить все данные в согласованном состоянии.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-110">**Consistency**: When completed, a transaction must leave all data in a consistent state.</span></span> <span data-ttu-id="d6ce4-111">Все внутренние структуры данных должны быть правильными на момент завершения транзакции.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-111">All internal data structures must be correct at the end of the transaction.</span></span>
* <span data-ttu-id="d6ce4-112">**Изоляция**. Изменения, выполняемые одной параллельной транзакцией, должны быть изолированы от изменений, выполняемых прочими параллельными транзакциями.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-112">**Isolation**: Modifications made by concurrent transactions must be isolated from the modifications made by any other concurrent transactions.</span></span> <span data-ttu-id="d6ce4-113">Уровень изоляции для операций в ITransaction определяется интерфейсом IReliableState, выполняющим операцию.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-113">The isolation level used for an operation within an ITransaction is determined by the IReliableState performing the operation.</span></span>
* <span data-ttu-id="d6ce4-114">**Устойчивость**. После завершения транзакции ее результаты постоянно сохраняются в системе.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-114">**Durability**: After a transaction has completed, its effects are permanently in place in the system.</span></span> <span data-ttu-id="d6ce4-115">Изменения сохраняются даже в случае сбоя системы.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-115">The modifications persist even in the event of a system failure.</span></span>

### <a name="isolation-levels"></a><span data-ttu-id="d6ce4-116">Уровни изоляции</span><span class="sxs-lookup"><span data-stu-id="d6ce4-116">Isolation levels</span></span>
<span data-ttu-id="d6ce4-117">Уровень изоляции определяет степень, до которой транзакция должна быть изолирована от изменений, вносимых другими транзакциями.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-117">Isolation level defines the degree to which the transaction must be isolated from modifications made by other transactions.</span></span>
<span data-ttu-id="d6ce4-118">Надежные коллекции поддерживают два уровня изоляции:</span><span class="sxs-lookup"><span data-stu-id="d6ce4-118">There are two isolation levels that are supported in Reliable Collections:</span></span>

* <span data-ttu-id="d6ce4-119">**Повторяющееся чтение**. Указывает, какие операторы не могут считывать данные, которые были изменены, но еще не зафиксированы другими транзакциями, и что другие транзакции не могут изменять данные, считанные текущей транзакцией, до ее завершения.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-119">**Repeatable Read**: Specifies that statements cannot read data that has been modified but not yet committed by other transactions and that no other transactions can modify data that has been read by the current transaction until the current transaction finishes.</span></span> <span data-ttu-id="d6ce4-120">Дополнительные сведения см. в статье [https://msdn.microsoft.com/library/ms173763.aspx](https://msdn.microsoft.com/library/ms173763.aspx).</span><span class="sxs-lookup"><span data-stu-id="d6ce4-120">For more details, see [https://msdn.microsoft.com/library/ms173763.aspx](https://msdn.microsoft.com/library/ms173763.aspx).</span></span>
* <span data-ttu-id="d6ce4-121">**Моментальный снимок**. Указывает, что данные, считанные любым оператором в транзакции, согласованы с версией данных, которые существовали в начале транзакции.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-121">**Snapshot**: Specifies that data read by any statement in a transaction is the transactionally consistent version of the data that existed at the start of the transaction.</span></span>
  <span data-ttu-id="d6ce4-122">Транзакция может распознать только те изменения данных, которые были зафиксированы до ее начала.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-122">The transaction can recognize only data modifications that were committed before the start of the transaction.</span></span>
  <span data-ttu-id="d6ce4-123">Изменения данных, произведенные другими транзакциями после запуска текущей транзакции, будут невидны для инструкций, выполняемых в текущей транзакции.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-123">Data modifications made by other transactions after the start of the current transaction are not visible to statements executing in the current transaction.</span></span>
  <span data-ttu-id="d6ce4-124">Это похоже на то, как если бы инструкции в транзакции получили снимок данных, зафиксированных на момент начала транзакции.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-124">The effect is as if the statements in a transaction get a snapshot of the committed data as it existed at the start of the transaction.</span></span>
  <span data-ttu-id="d6ce4-125">Моментальные снимки согласованы между надежными коллекциями.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-125">Snapshots are consistent across Reliable Collections.</span></span>
  <span data-ttu-id="d6ce4-126">Дополнительные сведения см. в статье [https://msdn.microsoft.com/library/ms173763.aspx](https://msdn.microsoft.com/library/ms173763.aspx).</span><span class="sxs-lookup"><span data-stu-id="d6ce4-126">For more details, see [https://msdn.microsoft.com/library/ms173763.aspx](https://msdn.microsoft.com/library/ms173763.aspx).</span></span>

<span data-ttu-id="d6ce4-127">Для операций чтения надежные коллекции автоматически выбирают уровень изоляции в зависимости от самой операции и роли реплики в момент создания транзакции.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-127">Reliable Collections automatically choose the isolation level to use for a given read operation depending on the operation and the role of the replica at the time of transaction's creation.</span></span>
<span data-ttu-id="d6ce4-128">Ниже приведена таблица уровней изоляции по умолчанию для операций надежного словаря и очереди.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-128">Following is the table that depicts isolation level defaults for Reliable Dictionary and Queue operations.</span></span>

| <span data-ttu-id="d6ce4-129">Операция \ Роль</span><span class="sxs-lookup"><span data-stu-id="d6ce4-129">Operation \ Role</span></span> | <span data-ttu-id="d6ce4-130">Первичная</span><span class="sxs-lookup"><span data-stu-id="d6ce4-130">Primary</span></span> | <span data-ttu-id="d6ce4-131">Вторичная</span><span class="sxs-lookup"><span data-stu-id="d6ce4-131">Secondary</span></span> |
| --- |:--- |:--- |
| <span data-ttu-id="d6ce4-132">Операция чтения одной сущности</span><span class="sxs-lookup"><span data-stu-id="d6ce4-132">Single Entity Read</span></span> |<span data-ttu-id="d6ce4-133">Повторяющаяся операция чтения</span><span class="sxs-lookup"><span data-stu-id="d6ce4-133">Repeatable Read</span></span> |<span data-ttu-id="d6ce4-134">Снимок</span><span class="sxs-lookup"><span data-stu-id="d6ce4-134">Snapshot</span></span> |
| <span data-ttu-id="d6ce4-135">Перечисление, подсчет</span><span class="sxs-lookup"><span data-stu-id="d6ce4-135">Enumeration, Count</span></span> |<span data-ttu-id="d6ce4-136">Снимок</span><span class="sxs-lookup"><span data-stu-id="d6ce4-136">Snapshot</span></span> |<span data-ttu-id="d6ce4-137">Снимок</span><span class="sxs-lookup"><span data-stu-id="d6ce4-137">Snapshot</span></span> |

> [!NOTE]
> <span data-ttu-id="d6ce4-138">Распространенные примеры операций с одной сущностью: `IReliableDictionary.TryGetValueAsync`, `IReliableQueue.TryPeekAsync`.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-138">Common examples for Single Entity Operations are `IReliableDictionary.TryGetValueAsync`, `IReliableQueue.TryPeekAsync`.</span></span>
> 

<span data-ttu-id="d6ce4-139">Надежный словарь и надежная очередь поддерживают мгновенную целостность данных (Read Your Writes, RYW).</span><span class="sxs-lookup"><span data-stu-id="d6ce4-139">Both the Reliable Dictionary and the Reliable Queue support Read Your Writes.</span></span>
<span data-ttu-id="d6ce4-140">Другими словами, каждая операция записи в рамках одной транзакции будет видна для последующей операции чтения, которая выполняется в рамках той же транзакции.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-140">In other words, any write within a transaction will be visible to a following read that belongs to the same transaction.</span></span>

## <a name="locks"></a><span data-ttu-id="d6ce4-141">Блокировки</span><span class="sxs-lookup"><span data-stu-id="d6ce4-141">Locks</span></span>
<span data-ttu-id="d6ce4-142">В надежных коллекциях все транзакции реализуют строгую двухэтапную блокировку: транзакция не снимает свои установленные блокировки, пока она не завершится прерыванием или фиксацией.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-142">In Reliable Collections, all transactions implement rigorous two phase locking: a transaction does not release the locks it has acquired until the transaction terminates with either an abort or a commit.</span></span>

<span data-ttu-id="d6ce4-143">Надежный словарь использует блокировку уровня строки для всех операций с одной сущностью.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-143">Reliable Dictionary uses row level locking for all single entity operations.</span></span>
<span data-ttu-id="d6ce4-144">Надежная очередь поступается параллелизмом ради строгого соблюдения транзакционного свойства FIFO.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-144">Reliable Queue trades off concurrency for strict transactional FIFO property.</span></span>
<span data-ttu-id="d6ce4-145">Надежная очередь использует блокировки уровня операции, позволяя одновременно выполнять одну транзакцию с `TryPeekAsync` и (или) `TryDequeueAsync` и одну транзакцию с `EnqueueAsync`.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-145">Reliable Queue uses operation level locks allowing one transaction with `TryPeekAsync` and/or `TryDequeueAsync` and one transaction with `EnqueueAsync` at a time.</span></span>
<span data-ttu-id="d6ce4-146">Обратите внимание, что если `TryPeekAsync` или `TryDequeueAsync` когда-либо обнаружит, что надежная очередь пуста, то для сохранения логики FIFO также заблокирует `EnqueueAsync`.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-146">Note that to preserve FIFO, if a `TryPeekAsync` or `TryDequeueAsync` ever observes that the Reliable Queue is empty, they will also lock `EnqueueAsync`.</span></span>

<span data-ttu-id="d6ce4-147">Операции записи всегда используют монопольные блокировки.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-147">Write operations always take Exclusive locks.</span></span>
<span data-ttu-id="d6ce4-148">Для операций чтения блокировка зависит от нескольких факторов.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-148">For read operations, the locking depends on a couple of factors.</span></span>
<span data-ttu-id="d6ce4-149">В операциях чтения, выполняемых с уровнем изоляции "Снимок", блокировки не используются.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-149">Any read operation done using Snapshot isolation is lock free.</span></span>
<span data-ttu-id="d6ce4-150">В повторяющихся операциях чтения используются совмещаемые блокировки (по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="d6ce4-150">Any Repeatable Read operation by default takes Shared locks.</span></span>
<span data-ttu-id="d6ce4-151">Тем не менее, для любой операции чтения, поддерживающей повторяющееся чтение, вместо совмещаемой блокировки пользователь может запросить блокировку изменений.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-151">However, for any read operation that supports Repeatable Read, the user can ask for an Update lock instead of the Shared lock.</span></span>
<span data-ttu-id="d6ce4-152">Блокировка изменений является асимметричной блокировкой, которая используется для предотвращения распространенной формы взаимоблокировки. Взаимоблокировка возникает, когда несколько транзакций блокируют ресурсы для возможного обновления в будущем.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-152">An Update lock is an asymmetric lock used to prevent a common form of deadlock that occurs when multiple transactions lock resources for potential updates at a later time.</span></span>

<span data-ttu-id="d6ce4-153">Ниже приведена таблица совместимости блокировок.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-153">The lock compatibility matrix can be found in the following table:</span></span>

| <span data-ttu-id="d6ce4-154">Запрос \ Предоставлено</span><span class="sxs-lookup"><span data-stu-id="d6ce4-154">Request \ Granted</span></span> | <span data-ttu-id="d6ce4-155">Без блокировки</span><span class="sxs-lookup"><span data-stu-id="d6ce4-155">None</span></span> | <span data-ttu-id="d6ce4-156">Совмещаемая блокировка</span><span class="sxs-lookup"><span data-stu-id="d6ce4-156">Shared</span></span> | <span data-ttu-id="d6ce4-157">Блокировка изменений</span><span class="sxs-lookup"><span data-stu-id="d6ce4-157">Update</span></span> | <span data-ttu-id="d6ce4-158">Монопольная блокировка</span><span class="sxs-lookup"><span data-stu-id="d6ce4-158">Exclusive</span></span> |
| --- |:--- |:--- |:--- |:--- |
| <span data-ttu-id="d6ce4-159">Совмещаемая блокировка</span><span class="sxs-lookup"><span data-stu-id="d6ce4-159">Shared</span></span> |<span data-ttu-id="d6ce4-160">Нет конфликтов</span><span class="sxs-lookup"><span data-stu-id="d6ce4-160">No conflict</span></span> |<span data-ttu-id="d6ce4-161">Нет конфликтов</span><span class="sxs-lookup"><span data-stu-id="d6ce4-161">No conflict</span></span> |<span data-ttu-id="d6ce4-162">Конфликт</span><span class="sxs-lookup"><span data-stu-id="d6ce4-162">Conflict</span></span> |<span data-ttu-id="d6ce4-163">Конфликт</span><span class="sxs-lookup"><span data-stu-id="d6ce4-163">Conflict</span></span> |
| <span data-ttu-id="d6ce4-164">Блокировка изменений</span><span class="sxs-lookup"><span data-stu-id="d6ce4-164">Update</span></span> |<span data-ttu-id="d6ce4-165">Нет конфликтов</span><span class="sxs-lookup"><span data-stu-id="d6ce4-165">No conflict</span></span> |<span data-ttu-id="d6ce4-166">Нет конфликтов</span><span class="sxs-lookup"><span data-stu-id="d6ce4-166">No conflict</span></span> |<span data-ttu-id="d6ce4-167">Конфликт</span><span class="sxs-lookup"><span data-stu-id="d6ce4-167">Conflict</span></span> |<span data-ttu-id="d6ce4-168">Конфликт</span><span class="sxs-lookup"><span data-stu-id="d6ce4-168">Conflict</span></span> |
| <span data-ttu-id="d6ce4-169">Монопольная блокировка</span><span class="sxs-lookup"><span data-stu-id="d6ce4-169">Exclusive</span></span> |<span data-ttu-id="d6ce4-170">Нет конфликтов</span><span class="sxs-lookup"><span data-stu-id="d6ce4-170">No conflict</span></span> |<span data-ttu-id="d6ce4-171">Конфликт</span><span class="sxs-lookup"><span data-stu-id="d6ce4-171">Conflict</span></span> |<span data-ttu-id="d6ce4-172">Конфликт</span><span class="sxs-lookup"><span data-stu-id="d6ce4-172">Conflict</span></span> |<span data-ttu-id="d6ce4-173">Конфликт</span><span class="sxs-lookup"><span data-stu-id="d6ce4-173">Conflict</span></span> |

<span data-ttu-id="d6ce4-174">В API надежных коллекций для обнаружения взаимоблокировок используется аргумент времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-174">Time-out argument in the Reliable Collections APIs is used for deadlock detection.</span></span>
<span data-ttu-id="d6ce4-175">Например, две транзакции (Т1 и Т2) пытаются считать и изменить К1.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-175">For example, two transactions (T1 and T2) are trying to read and update K1.</span></span>
<span data-ttu-id="d6ce4-176">Существует вероятность возникновения взаимоблокировки, поскольку в обеих транзакциях используется совмещаемая блокировка.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-176">It is possible for them to deadlock, because they both end up having the Shared lock.</span></span>
<span data-ttu-id="d6ce4-177">В этом случае время ожидания для одной или обеих операций будет превышено.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-177">In this case, one or both of the operations will time out.</span></span>

<span data-ttu-id="d6ce4-178">Ситуация с взаимоблокировкой является хорошим примером того, как блокировка изменений может предотвратить возникновение взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="d6ce4-178">This deadlock scenario is a great example of how an Update lock can prevent deadlocks.</span></span>

## <a name="next-steps"></a><span data-ttu-id="d6ce4-179">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="d6ce4-179">Next steps</span></span>
* [<span data-ttu-id="d6ce4-180">Работа с Reliable Collections</span><span class="sxs-lookup"><span data-stu-id="d6ce4-180">Working with Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
* [<span data-ttu-id="d6ce4-181">Уведомления Reliable Services</span><span class="sxs-lookup"><span data-stu-id="d6ce4-181">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
* [<span data-ttu-id="d6ce4-182">Архивация и восстановление (аварийное восстановление) надежных служб</span><span class="sxs-lookup"><span data-stu-id="d6ce4-182">Reliable Services backup and restore (disaster recovery)</span></span>](service-fabric-reliable-services-backup-restore.md)
* [<span data-ttu-id="d6ce4-183">Конфигурация диспетчера надежных состояний</span><span class="sxs-lookup"><span data-stu-id="d6ce4-183">Reliable State Manager configuration</span></span>](service-fabric-reliable-services-configuration.md)
* [<span data-ttu-id="d6ce4-184">Справочник разработчика по надежным коллекциям</span><span class="sxs-lookup"><span data-stu-id="d6ce4-184">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)


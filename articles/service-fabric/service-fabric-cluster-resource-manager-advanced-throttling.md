---
title: "Регулирование в диспетчере кластерных ресурсов Service Fabric | Документация Майкрософт"
description: "Узнайте, как настраивать регулирование в диспетчере кластерных ресурсов Service Fabric."
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: 4a44678b-a5aa-4d30-958f-dc4332ebfb63
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 1be0beaf2e199a9c384187efd80b33c7dab5e87c
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="throttling-the-service-fabric-cluster-resource-manager"></a><span data-ttu-id="a709f-103">Регулирование посредством диспетчера кластерных ресурсов Service Fabric</span><span class="sxs-lookup"><span data-stu-id="a709f-103">Throttling the Service Fabric Cluster Resource Manager</span></span>
<span data-ttu-id="a709f-104">Даже если диспетчер кластерных ресурсов настроен правильно, работа кластера может быть нарушена.</span><span class="sxs-lookup"><span data-stu-id="a709f-104">Even if you’ve configured the Cluster Resource Manager correctly, the cluster can get disrupted.</span></span> <span data-ttu-id="a709f-105">Например, отказы нескольких узлов и доменов сбоя могут произойти во время установки новой версии или при применении обновлений.</span><span class="sxs-lookup"><span data-stu-id="a709f-105">For example, there could be simultaneous node and fault domain failures - what would happen if that occurred during an upgrade?</span></span> <span data-ttu-id="a709f-106">Диспетчер кластерных ресурсов всегда пытается устранить любые ошибки, используя кластерные ресурсы для реорганизации и исправления кластера.</span><span class="sxs-lookup"><span data-stu-id="a709f-106">The Cluster Resource Manager always tries to fix everything, consuming the cluster's resources trying to reorganize and fix the cluster.</span></span> <span data-ttu-id="a709f-107">Регулирование обеспечивает ресурсы, чтобы кластер мог стабилизировать работу (вернуть узлы в работоспособное состояние, восстановить работоспособность сетевых разделов и развернуть исправленный код).</span><span class="sxs-lookup"><span data-stu-id="a709f-107">Throttles help provide a backstop so that the cluster can use resources to stabilize - the nodes come back, the network partitions heal, corrected bits get deployed.</span></span>

<span data-ttu-id="a709f-108">Чтобы помочь в подобных ситуациях, диспетчер кластерных ресурсов Service Fabric включает в себя несколько регулировок.</span><span class="sxs-lookup"><span data-stu-id="a709f-108">To help with these sorts of situations, the Service Fabric Cluster Resource Manager includes several throttles.</span></span> <span data-ttu-id="a709f-109">Все это достаточно масштабные средства.</span><span class="sxs-lookup"><span data-stu-id="a709f-109">These throttles are all fairly large hammers.</span></span> <span data-ttu-id="a709f-110">Обычно они не должны изменяться без тщательного планирования и тестирования.</span><span class="sxs-lookup"><span data-stu-id="a709f-110">Generally they shouldn’t be changed without careful planning and testing.</span></span>

<span data-ttu-id="a709f-111">Если вы измените регулировки диспетчера кластерных ресурсов, то их необходимо будет настроить для ожидаемой фактической нагрузки.</span><span class="sxs-lookup"><span data-stu-id="a709f-111">If you change the Cluster Resource Manager's throttles, you should tune them to your expected actual load.</span></span> <span data-ttu-id="a709f-112">Возможно, вы решите настроить несколько регулировок, даже если это означает, что в некоторых ситуациях стабилизация кластера будет занимать больше времени.</span><span class="sxs-lookup"><span data-stu-id="a709f-112">You may determine you need to have some throttles in place, even if it means the cluster takes longer to stabilize in some situations.</span></span> <span data-ttu-id="a709f-113">Тестирование требуется, чтобы определить правильные значения для регулировок.</span><span class="sxs-lookup"><span data-stu-id="a709f-113">Testing is required to determine the correct values for throttles.</span></span> <span data-ttu-id="a709f-114">Величина регулирования должна быть достаточно большой, чтобы позволить кластеру реагировать на изменения в разумные сроки, и достаточно малой, чтобы избегать слишком большого потребления ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a709f-114">Throttles need to be high enough to allow the cluster to respond to changes in a reasonable amount of time, and low enough to actually prevent too much resource consumption.</span></span> 

<span data-ttu-id="a709f-115">Чаще всего клиенты используют регулировки при работе в среде с ограниченными ресурсами.</span><span class="sxs-lookup"><span data-stu-id="a709f-115">Most of the time we’ve seen customers use throttles it has been because they were already in a resource constrained environment.</span></span> <span data-ttu-id="a709f-116">Например, в них может быть ограничена пропускная способность сети для отдельных узлов или диски не могут параллельно создавать много реплик с отслеживанием состояния из-за ограничений пропускной способности.</span><span class="sxs-lookup"><span data-stu-id="a709f-116">Some examples would be limited network bandwidth for individual nodes, or disks that aren't able to build many stateful replicas in parallel due to throughput limitations.</span></span> <span data-ttu-id="a709f-117">Без регулирования операции могут перегрузить эти ресурсы, что приведет к сбою или замедлению работы.</span><span class="sxs-lookup"><span data-stu-id="a709f-117">Without throttles, operations could overwhelm these resources, causing operations to fail or be slow.</span></span> <span data-ttu-id="a709f-118">В таких случаях клиенты использовали регулировки и знали, что они потенциально увеличивают период стабилизации работы кластера,</span><span class="sxs-lookup"><span data-stu-id="a709f-118">In these situations customers used throttles and knew they were extending the amount of time it would take the cluster to reach a stable state.</span></span> <span data-ttu-id="a709f-119">и что регулирование может привести к понижению общей надежности.</span><span class="sxs-lookup"><span data-stu-id="a709f-119">Customers also understood they could end up running at lower overall reliability while they were throttled.</span></span>


## <a name="configuring-the-throttles"></a><span data-ttu-id="a709f-120">Настройка регулирования</span><span class="sxs-lookup"><span data-stu-id="a709f-120">Configuring the throttles</span></span>

<span data-ttu-id="a709f-121">В Service Fabric есть два механизма регулирования числа перемещений реплик.</span><span class="sxs-lookup"><span data-stu-id="a709f-121">Service Fabric has two mechanisms for throttling the number of replica movements.</span></span> <span data-ttu-id="a709f-122">Механизм по умолчанию, который существовал до выпуска Service Fabric 5.7, представляет регулирование как абсолютное число допустимых перемещений.</span><span class="sxs-lookup"><span data-stu-id="a709f-122">The default mechanism that existed before Service Fabric 5.7 represents throttling as an absolute number of moves allowed.</span></span> <span data-ttu-id="a709f-123">Это подходит не для всех размеров кластеров.</span><span class="sxs-lookup"><span data-stu-id="a709f-123">This does not work for clusters of all sizes.</span></span> <span data-ttu-id="a709f-124">В частности, для больших кластеров значение по умолчанию может быть слишком мало, что значительно замедляет балансировку даже в том случае, когда она необходима, но такое значение не ухудшает работу небольших кластеров.</span><span class="sxs-lookup"><span data-stu-id="a709f-124">In particular, for large clusters the default value can be too small, significantly slowing down balancing even when it is necessary, while having no effect in smaller clusters.</span></span> <span data-ttu-id="a709f-125">Этот предыдущий механизм был заменен процентным регулированием, которое лучше масштабируется на динамических кластерах, в которых количество служб и узлов регулярно изменяется.</span><span class="sxs-lookup"><span data-stu-id="a709f-125">This prior mechanism has been superseded by percentage-based throttling, which scales better with dynamic clusters in which the number of services and nodes change regularly.</span></span>

<span data-ttu-id="a709f-126">Эти регулировки основаны на проценте числа реплик в кластерах.</span><span class="sxs-lookup"><span data-stu-id="a709f-126">The throttles are based on a percentage of the number of replicas in the clusters.</span></span> <span data-ttu-id="a709f-127">Процентное регулирование позволяет, например, применить правило: "не перемещать более 10 % реплик в течение 10 минут".</span><span class="sxs-lookup"><span data-stu-id="a709f-127">Percetage based throttles enable expressing the rule: "do not move more than 10% of replicas in a 10 minute interval", for example.</span></span>

<span data-ttu-id="a709f-128">Ниже приведены доступные параметры конфигурации процентного регулирования.</span><span class="sxs-lookup"><span data-stu-id="a709f-128">The configuration settings for percentage-based throttling are:</span></span>

  - <span data-ttu-id="a709f-129">GlobalMovementThrottleThresholdPercentage — максимальное число перемещений в кластере в любое время, выраженное в проценте от общего числа реплик в кластере.</span><span class="sxs-lookup"><span data-stu-id="a709f-129">GlobalMovementThrottleThresholdPercentage - Maximum number of movements allowed in cluster at any time, expressed as percentage of total number of replicas in the cluster.</span></span> <span data-ttu-id="a709f-130">Значение 0 означает, что ограничения отсутствуют.</span><span class="sxs-lookup"><span data-stu-id="a709f-130">0 indicates no limit.</span></span> <span data-ttu-id="a709f-131">Значение по умолчанию — 0.</span><span class="sxs-lookup"><span data-stu-id="a709f-131">The default value is 0.</span></span> <span data-ttu-id="a709f-132">Если указаны этот параметр и GlobalMovementThrottleThreshold, то используется более умеренное ограничение.</span><span class="sxs-lookup"><span data-stu-id="a709f-132">If both this setting and GlobalMovementThrottleThreshold are specified, then the more conservative limit is used.</span></span>
  - <span data-ttu-id="a709f-133">GlobalMovementThrottleThresholdPercentageForPlacement — максимальное число перемещений на этапе размещения, выраженное в проценте от общего числа реплик в кластере.</span><span class="sxs-lookup"><span data-stu-id="a709f-133">GlobalMovementThrottleThresholdPercentageForPlacement - Maximum number of movements allowed during the placement phase, expressed as percentage of total number of replicas in the cluster.</span></span> <span data-ttu-id="a709f-134">Значение 0 означает, что ограничения отсутствуют.</span><span class="sxs-lookup"><span data-stu-id="a709f-134">0 indicates no limit.</span></span> <span data-ttu-id="a709f-135">Значение по умолчанию — 0.</span><span class="sxs-lookup"><span data-stu-id="a709f-135">The default value is 0.</span></span> <span data-ttu-id="a709f-136">Если указаны этот параметр и GlobalMovementThrottleThresholdForPlacement, то используется более умеренное ограничение.</span><span class="sxs-lookup"><span data-stu-id="a709f-136">If both this setting and GlobalMovementThrottleThresholdForPlacement are specified, then the more conservative limit is used.</span></span>
  - <span data-ttu-id="a709f-137">GlobalMovementThrottleThresholdPercentageForBalancing — максимальное число перемещений на этапе балансировки, выраженное в проценте от общего числа реплик в кластере.</span><span class="sxs-lookup"><span data-stu-id="a709f-137">GlobalMovementThrottleThresholdPercentageForBalancing - Maximum number of movements allowed during the balancing phase, expressed as percentage of total number of replicas in the cluster.</span></span> <span data-ttu-id="a709f-138">Значение 0 означает, что ограничения отсутствуют.</span><span class="sxs-lookup"><span data-stu-id="a709f-138">0 indicates no limit.</span></span> <span data-ttu-id="a709f-139">Значение по умолчанию — 0.</span><span class="sxs-lookup"><span data-stu-id="a709f-139">The default value is 0.</span></span> <span data-ttu-id="a709f-140">Если указаны этот параметр и GlobalMovementThrottleThresholdForBalancing, то используется более умеренное ограничение.</span><span class="sxs-lookup"><span data-stu-id="a709f-140">If both this setting and GlobalMovementThrottleThresholdForBalancing are specified, then the more conservative limit is used.</span></span>

<span data-ttu-id="a709f-141">При указании процента регулирования 5 % указывается как 0,05.</span><span class="sxs-lookup"><span data-stu-id="a709f-141">When specifying the throttle percentage, you'd specify 5% as 0.05.</span></span> <span data-ttu-id="a709f-142">Интервал для этих регулировок определяет параметр GlobalMovementThrottleCountingInterval, который указывается в секундах.</span><span class="sxs-lookup"><span data-stu-id="a709f-142">The interval on which these throttles are governed is the GlobalMovementThrottleCountingInterval, which is specified in seconds.</span></span>


``` xml
<Section Name="PlacementAndLoadBalancing">
     <Parameter Name="GlobalMovementThrottleThresholdPercentage" Value="0" />
     <Parameter Name="GlobalMovementThrottleThresholdPercentageForPlacement" Value="0" />
     <Parameter Name="GlobalMovementThrottleThresholdPercentageForBalancing" Value="0" />
     <Parameter Name="GlobalMovementThrottleCountingInterval" Value="600" />
</Section>
```

<span data-ttu-id="a709f-143">Для автономных развертываний используется ClusterConfig.json, а для размещенных в Azure кластеров — Template.json.</span><span class="sxs-lookup"><span data-stu-id="a709f-143">via ClusterConfig.json for Standalone deployments or Template.json for Azure hosted clusters:</span></span>

```json
"fabricSettings": [
  {
    "name": "PlacementAndLoadBalancing",
    "parameters": [
      {
          "name": "GlobalMovementThrottleThresholdPercentage",
          "value": "0.0"
      },
      {
          "name": "GlobalMovementThrottleThresholdPercentageForPlacement",
          "value": "0.0"
      },
      {
          "name": "GlobalMovementThrottleThresholdPercentageForBalancing",
          "value": "0.0"
      },
      {
          "name": "GlobalMovementThrottleCountingInterval",
          "value": "600"
      }
    ]
  }
]
```

### <a name="default-count-based-throttles"></a><span data-ttu-id="a709f-144">Регулирование на основе количества по умолчанию</span><span class="sxs-lookup"><span data-stu-id="a709f-144">Default count based throttles</span></span>
<span data-ttu-id="a709f-145">Эти сведения предоставляются на случай, если у вас имеются устаревшие кластеры или в обновленных кластерах по-прежнему используются такие конфигурации.</span><span class="sxs-lookup"><span data-stu-id="a709f-145">This information is provided in case you have older clusters or still retain these configurations in clusters that have since been upgraded.</span></span> <span data-ttu-id="a709f-146">Как правило, рекомендуется заменить их конфигурациями с процентным регулированием.</span><span class="sxs-lookup"><span data-stu-id="a709f-146">In general, it is recommended that these are replaced with the percentage-based throttles above.</span></span> <span data-ttu-id="a709f-147">Так как процентное регулирование отключено по умолчанию, этот механизм регулирования используется по умолчанию для кластера, пока он не будет отключен и заменен процентным регулированием.</span><span class="sxs-lookup"><span data-stu-id="a709f-147">Since percentage-based throttling is disabled by default, these throttles remain the default throttles for a cluster until they are disabled and replaced with the percentage-based throttles.</span></span> 

  - <span data-ttu-id="a709f-148">GlobalMovementThrottleThreshold. Данный параметр управляет общим количеством перемещений в кластере за некоторое время.</span><span class="sxs-lookup"><span data-stu-id="a709f-148">GlobalMovementThrottleThreshold – this setting controls the total number of movements in the cluster over some time.</span></span> <span data-ttu-id="a709f-149">Это время указывается в секундах в параметре GlobalMovementThrottleCountingInterval.</span><span class="sxs-lookup"><span data-stu-id="a709f-149">The amount of time is specified in seconds as the GlobalMovementThrottleCountingInterval.</span></span> <span data-ttu-id="a709f-150">Значение по умолчанию GlobalMovementThrottleThreshold равно 1000, а значение по умолчанию GlobalMovementThrottleCountingInterval равно 600.</span><span class="sxs-lookup"><span data-stu-id="a709f-150">The default value for the GlobalMovementThrottleThreshold is 1000 and the default value for the GlobalMovementThrottleCountingInterval is 600.</span></span>
  - <span data-ttu-id="a709f-151">MovementPerPartitionThrottleThreshold. Данный параметр управляет общим количеством перемещений для любой секции службы за некоторое время.</span><span class="sxs-lookup"><span data-stu-id="a709f-151">MovementPerPartitionThrottleThreshold – this setting controls the total number of movements for any service partition over some time.</span></span> <span data-ttu-id="a709f-152">Это время указывается в секундах в параметре MovementPerPartitionThrottleCountingInterval.</span><span class="sxs-lookup"><span data-stu-id="a709f-152">The amount of time is specified in seconds as the MovementPerPartitionThrottleCountingInterval.</span></span> <span data-ttu-id="a709f-153">Значение по умолчанию MovementPerPartitionThrottleThreshold равно 50, а значение по умолчанию MovementPerPartitionThrottleCountingInterval равно 600.</span><span class="sxs-lookup"><span data-stu-id="a709f-153">The default value for the MovementPerPartitionThrottleThreshold is 50 and the default value for the MovementPerPartitionThrottleCountingInterval is 600.</span></span>

<span data-ttu-id="a709f-154">В конфигурации этих регулировок используется та же схема, что и в процентном регулировании.</span><span class="sxs-lookup"><span data-stu-id="a709f-154">The configuration for these throttles follows the same pattern as the percentage-based throttling.</span></span>

## <a name="next-steps"></a><span data-ttu-id="a709f-155">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="a709f-155">Next steps</span></span>
- <span data-ttu-id="a709f-156">Чтобы узнать, как диспетчер кластерных ресурсов управляет нагрузкой кластера и балансирует ее, ознакомьтесь со статьей о [балансировке нагрузки](service-fabric-cluster-resource-manager-balancing.md)</span><span class="sxs-lookup"><span data-stu-id="a709f-156">To find out about how the Cluster Resource Manager manages and balances load in the cluster, check out the article on [balancing load](service-fabric-cluster-resource-manager-balancing.md)</span></span>
- <span data-ttu-id="a709f-157">В Cluster Resource Manager предусмотрено много параметров для описания кластера.</span><span class="sxs-lookup"><span data-stu-id="a709f-157">The Cluster Resource Manager has many options for describing the cluster.</span></span> <span data-ttu-id="a709f-158">Дополнительные сведения об этих параметрах см. в статье с [описанием кластера Service Fabric](service-fabric-cluster-resource-manager-cluster-description.md).</span><span class="sxs-lookup"><span data-stu-id="a709f-158">To find out more about them, check out this article on [describing a Service Fabric cluster](service-fabric-cluster-resource-manager-cluster-description.md)</span></span>

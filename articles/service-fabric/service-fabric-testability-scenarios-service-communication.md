---
title: "Возможности тестирования: взаимодействие между службами | Документация Майкрософт"
description: "Взаимодействие между службами — критически важная точка интеграции приложения Service Fabric. В этой статье обсуждаются вопросы разработки и методы тестирования."
services: service-fabric
documentationcenter: .net
author: vturecek
manager: timlt
editor: 
ms.assetid: 017557df-fb59-4e4a-a65d-2732f29255b8
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 06/29/2017
ms.author: vturecek
ms.openlocfilehash: c182cc2062ada40029504de5b2b64b021c614ce6
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="service-fabric-testability-scenarios-service-communication"></a><span data-ttu-id="3e239-104">Сценарии тестирования платформы Service Fabric: обмен данными между службами</span><span class="sxs-lookup"><span data-stu-id="3e239-104">Service Fabric testability scenarios: Service communication</span></span>
<span data-ttu-id="3e239-105">Микрослужбы и стили сервисноориентированной архитектуры естественным образом развертываются на платформе Azure Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="3e239-105">Microservices and service-oriented architectural styles surface naturally in Azure Service Fabric.</span></span> <span data-ttu-id="3e239-106">В распределенных архитектурах этих типов компонентные приложения микрослужб обычно состоят из нескольких служб, которые должны взаимодействовать друг с другом.</span><span class="sxs-lookup"><span data-stu-id="3e239-106">In these types of distributed architectures, componentized microservice applications are typically composed of multiple services that need to talk to each other.</span></span> <span data-ttu-id="3e239-107">Даже в простейших случаях у вас обычно есть как минимум веб-служба без отслеживания состояния и служба хранилища данных с отслеживанием состояния, которые должны взаимодействовать друг с другом.</span><span class="sxs-lookup"><span data-stu-id="3e239-107">In even the simplest cases, you generally have at least a stateless web service and a stateful data storage service that need to communicate.</span></span>

<span data-ttu-id="3e239-108">Обмен данными между службами — критически важная точка интеграции приложения, так как каждая служба предоставляет удаленный API-интерфейс для других служб.</span><span class="sxs-lookup"><span data-stu-id="3e239-108">Service-to-service communication is a critical integration point of an application, because each service exposes a remote API to other services.</span></span> <span data-ttu-id="3e239-109">Работа с набором границ API, включающая ввод-вывод данных, обычно требует тщательного подхода с интенсивным тестированием и проверкой.</span><span class="sxs-lookup"><span data-stu-id="3e239-109">Working with a set of API boundaries that involves I/O generally requires some care, with a good amount of testing and validation.</span></span>

<span data-ttu-id="3e239-110">При объединении этих границ служб другом в распределенной системе следует ответить на ряд вопросов.</span><span class="sxs-lookup"><span data-stu-id="3e239-110">There are numerous considerations to make when these service boundaries are wired together in a distributed system:</span></span>

* <span data-ttu-id="3e239-111">*Транспортный протокол*.</span><span class="sxs-lookup"><span data-stu-id="3e239-111">*Transport protocol*.</span></span> <span data-ttu-id="3e239-112">Вы будете использовать протокол HTTP для улучшения взаимодействия или пользовательский двоичный протокол, чтобы обеспечить максимальную пропускную способность?</span><span class="sxs-lookup"><span data-stu-id="3e239-112">Will you use HTTP for increased interoperability, or a custom binary protocol for maximum throughput?</span></span>
* <span data-ttu-id="3e239-113">*Обработка ошибок*.</span><span class="sxs-lookup"><span data-stu-id="3e239-113">*Error handling*.</span></span> <span data-ttu-id="3e239-114">Как будут обрабатываться постоянные и временные ошибки?</span><span class="sxs-lookup"><span data-stu-id="3e239-114">How will permanent and transient errors be handled?</span></span> <span data-ttu-id="3e239-115">Что произойдет, когда служба переместится на другой узел?</span><span class="sxs-lookup"><span data-stu-id="3e239-115">What will happen when a service moves to a different node?</span></span>
* <span data-ttu-id="3e239-116">*Время ожидания и задержка*.</span><span class="sxs-lookup"><span data-stu-id="3e239-116">*Timeouts and latency*.</span></span> <span data-ttu-id="3e239-117">Как каждый слой службы будет обрабатывать задержку через стек для пользователя в многоуровневых приложениях?</span><span class="sxs-lookup"><span data-stu-id="3e239-117">In multitiered applications, how will each service layer handle latency through the stack and to the user?</span></span>

<span data-ttu-id="3e239-118">Если вы используете один из встроенных компонентов обмена данными между службами, доступных в Service Fabric, или выполняете сборку собственного компонента, тестирование взаимодействия между службами является критически важным для обеспечения устойчивости приложения.</span><span class="sxs-lookup"><span data-stu-id="3e239-118">Whether you use one of the built-in service communication components provided by Service Fabric or you build your own, testing the interactions between your services is critical to ensuring resiliency in your application.</span></span>

## <a name="prepare-for-services-to-move"></a><span data-ttu-id="3e239-119">Подготовка служб к перемещению</span><span class="sxs-lookup"><span data-stu-id="3e239-119">Prepare for services to move</span></span>
<span data-ttu-id="3e239-120">Со временем экземпляры служб могут перемещаться,</span><span class="sxs-lookup"><span data-stu-id="3e239-120">Service instances may move around over time.</span></span> <span data-ttu-id="3e239-121">особенно если они настроены с использованием метрик нагрузки для оптимальной балансировки ресурсов.</span><span class="sxs-lookup"><span data-stu-id="3e239-121">This is especially true when they are configured with load metrics for custom-tailored optimal resource balancing.</span></span> <span data-ttu-id="3e239-122">Service Fabric перемещает экземпляры вашей службы, чтобы обеспечить максимальную доступность даже во время обновлений, отработки отказов, масштабирования и других ситуаций, которые возникают за время существования распределенной системы.</span><span class="sxs-lookup"><span data-stu-id="3e239-122">Service Fabric moves your service instances to maximize their availability even during upgrades, failovers, scale-out, and other situations that occur over the lifetime of a distributed system.</span></span>

<span data-ttu-id="3e239-123">По мере перемещения служб в кластере ваши клиенты и другие службы должны быть готовы к двум сценариям, возникающим при взаимодействии со службой.</span><span class="sxs-lookup"><span data-stu-id="3e239-123">As services move around in the cluster, your clients and other services should be prepared to handle two scenarios when they talk to a service:</span></span>

* <span data-ttu-id="3e239-124">Экземпляр службы или реплика раздела перемещены с момента последнего обмена данными с ними.</span><span class="sxs-lookup"><span data-stu-id="3e239-124">The service instance or partition replica has moved since the last time you talked to it.</span></span> <span data-ttu-id="3e239-125">Это характерно для жизненного цикла службы и вполне может произойти в течение жизненного цикла приложения.</span><span class="sxs-lookup"><span data-stu-id="3e239-125">This is a normal part of a service lifecycle, and it should be expected to happen during the lifetime of your application.</span></span>
* <span data-ttu-id="3e239-126">Экземпляр службы или реплика раздела перемещается.</span><span class="sxs-lookup"><span data-stu-id="3e239-126">The service instance or partition replica is in the process of moving.</span></span> <span data-ttu-id="3e239-127">Хотя отработка отказа службы с одного узла на другой выполняется в Service Fabric очень быстро, возможны задержки в доступности, если компонент связи службы медленно запускается.</span><span class="sxs-lookup"><span data-stu-id="3e239-127">Although failover of a service from one node to another occurs very quickly in Service Fabric, there may be a delay in availability if the communication component of your service is slow to start.</span></span>

<span data-ttu-id="3e239-128">Для бесперебойной работы системы важно правильно обрабатывать такие сценарии.</span><span class="sxs-lookup"><span data-stu-id="3e239-128">Handling these scenarios gracefully is important for a smooth-running system.</span></span> <span data-ttu-id="3e239-129">Чтобы сделать это, помните следующее.</span><span class="sxs-lookup"><span data-stu-id="3e239-129">To do so, keep in mind that:</span></span>

* <span data-ttu-id="3e239-130">Каждая служба, к которой можно подключиться, имеет *адрес* для прослушивания (например, HTTP или WebSockets).</span><span class="sxs-lookup"><span data-stu-id="3e239-130">Every service that can be connected to has an *address* that it listens on (for example, HTTP or WebSockets).</span></span> <span data-ttu-id="3e239-131">При перемещении экземпляра или раздела службы меняется адрес соответствующей конечной точки</span><span class="sxs-lookup"><span data-stu-id="3e239-131">When a service instance or partition moves, its address endpoint changes.</span></span> <span data-ttu-id="3e239-132">(она перемещается на другой узел с другим IP-адресом). Если вы используете встроенные компоненты связи, они будут автоматически обрабатывать повторно разрешающиеся адреса служб.</span><span class="sxs-lookup"><span data-stu-id="3e239-132">(It moves to a different node with a different IP address.) If you're using the built-in communication components, they will handle re-resolving service addresses for you.</span></span>
* <span data-ttu-id="3e239-133">Может наблюдаться временное увеличение задержки, так как экземпляр службы снова запускает свой прослушиватель.</span><span class="sxs-lookup"><span data-stu-id="3e239-133">There may be a temporary increase in service latency as the service instance starts up its listener again.</span></span> <span data-ttu-id="3e239-134">Это зависит от того, насколько быстро служба открывает прослушиватель после перемещения экземпляра службы.</span><span class="sxs-lookup"><span data-stu-id="3e239-134">This depends on how quickly the service opens the listener after the service instance is moved.</span></span>
* <span data-ttu-id="3e239-135">При открытии службы на новом узле все существующие подключения потребуется закрыть и открыть заново.</span><span class="sxs-lookup"><span data-stu-id="3e239-135">Any existing connections need to be closed and reopened after the service opens on a new node.</span></span> <span data-ttu-id="3e239-136">Нормальное завершение работы (или перезапуск узла) предоставляет достаточно времени для нормального завершения работы существующих подключений.</span><span class="sxs-lookup"><span data-stu-id="3e239-136">A graceful node shutdown or restart allows time for existing connections to be shut down gracefully.</span></span>

### <a name="test-it-move-service-instances"></a><span data-ttu-id="3e239-137">Тестирование. Перемещение экземпляров службы</span><span class="sxs-lookup"><span data-stu-id="3e239-137">Test it: Move service instances</span></span>
<span data-ttu-id="3e239-138">С помощью средств тестирования в Service Fabric можно создать сценарий тестирования для проверки этих ситуаций разными способами.</span><span class="sxs-lookup"><span data-stu-id="3e239-138">By using Service Fabric's testability tools, you can author a test scenario to test these situations in different ways:</span></span>

1. <span data-ttu-id="3e239-139">Переместите первичную реплику службы с отслеживанием состояния.</span><span class="sxs-lookup"><span data-stu-id="3e239-139">Move a stateful service's primary replica.</span></span>
   
    <span data-ttu-id="3e239-140">Первичную реплику раздела службы с отслеживанием состояния может понадобиться переместить по ряду причин.</span><span class="sxs-lookup"><span data-stu-id="3e239-140">The primary replica of a stateful service partition can be moved for any number of reasons.</span></span> <span data-ttu-id="3e239-141">Используйте это применительно к первичной реплике определенного раздела, чтобы посмотреть, как ваши службы реагируют на перемещение, полностью их контролируя.</span><span class="sxs-lookup"><span data-stu-id="3e239-141">Use this to target the primary replica of a specific partition to see how your services react to the move in a very controlled manner.</span></span>
   
    ```powershell
   
    PS > Move-ServiceFabricPrimaryReplica -PartitionId 6faa4ffa-521a-44e9-8351-dfca0f7e0466 -ServiceName fabric:/MyApplication/MyService
   
    ```
2. <span data-ttu-id="3e239-142">Остановите работу узла.</span><span class="sxs-lookup"><span data-stu-id="3e239-142">Stop a node.</span></span>
   
    <span data-ttu-id="3e239-143">Когда работа узла будет остановлена, Service Fabric переместит все экземпляры или разделы службы, которые находились на этом узле, на один из других доступных узлов в кластере.</span><span class="sxs-lookup"><span data-stu-id="3e239-143">When a node is stopped, Service Fabric moves all of the service instances or partitions that were on that node to one of the other available nodes in the cluster.</span></span> <span data-ttu-id="3e239-144">Используйте это при проверке ситуации, при которой узел теряется для кластера, что приводит к необходимости переместить все экземпляры служб и реплики на этом узле.</span><span class="sxs-lookup"><span data-stu-id="3e239-144">Use this to test a situation where a node is lost from your cluster and all of the service instances and replicas on that node have to move.</span></span>
   
    <span data-ttu-id="3e239-145">Узел можно остановить с помощью следующего командлета PowerShell **Stop-ServiceFabricNode** :</span><span class="sxs-lookup"><span data-stu-id="3e239-145">You can stop a node by using the PowerShell **Stop-ServiceFabricNode** cmdlet:</span></span>
   
    ```powershell
   
    PS > Restart-ServiceFabricNode -NodeName Node_1
   
    ```

## <a name="maintain-service-availability"></a><span data-ttu-id="3e239-146">Поддержание доступности службы</span><span class="sxs-lookup"><span data-stu-id="3e239-146">Maintain service availability</span></span>
<span data-ttu-id="3e239-147">Платформа Service Fabric обеспечивает высокую доступность служб.</span><span class="sxs-lookup"><span data-stu-id="3e239-147">As a platform, Service Fabric is designed to provide high availability of your services.</span></span> <span data-ttu-id="3e239-148">Но в исключительных случаях проблемы с базовой инфраструктурой все еще могут привести к недоступности.</span><span class="sxs-lookup"><span data-stu-id="3e239-148">But in extreme cases, underlying infrastructure problems can still cause unavailability.</span></span> <span data-ttu-id="3e239-149">Эти сценарии также важно проверить.</span><span class="sxs-lookup"><span data-stu-id="3e239-149">It is important to test for these scenarios, too.</span></span>

<span data-ttu-id="3e239-150">В службах с отслеживанием состояния используется система на основе кворума для репликации данных о состоянии и обеспечения высокого уровня доступности.</span><span class="sxs-lookup"><span data-stu-id="3e239-150">Stateful services use a quorum-based system to replicate state for high availability.</span></span> <span data-ttu-id="3e239-151">Это значит, что для выполнения операций записи кворум реплик должен быть доступным.</span><span class="sxs-lookup"><span data-stu-id="3e239-151">This means that a quorum of replicas needs to be available to perform write operations.</span></span> <span data-ttu-id="3e239-152">В редких случаях, например при масштабном сбое оборудования, кворум реплик может быть недоступен.</span><span class="sxs-lookup"><span data-stu-id="3e239-152">In rare cases, such as a widespread hardware failure, a quorum of replicas may not be available.</span></span> <span data-ttu-id="3e239-153">В этом случае вы не сможете выполнять операции записи, но по-прежнему будете иметь возможность выполнять операции чтения.</span><span class="sxs-lookup"><span data-stu-id="3e239-153">In these cases, you will not be able to perform write operations, but you will still be able to perform read operations.</span></span>

### <a name="test-it-write-operation-unavailability"></a><span data-ttu-id="3e239-154">Тестирование. Недоступность операции записи</span><span class="sxs-lookup"><span data-stu-id="3e239-154">Test it: Write operation unavailability</span></span>
<span data-ttu-id="3e239-155">Средства тестирования в Service Fabric позволяют выполнять проверку путем внесения ошибки, которая приводит к потере кворума.</span><span class="sxs-lookup"><span data-stu-id="3e239-155">By using the testability tools in Service Fabric, you can inject a fault that induces quorum loss as a test.</span></span> <span data-ttu-id="3e239-156">Хотя такие случаи возникают редко, клиенты и службы, которые зависят от службы с отслеживанием состояния, должны быть готовы к ситуациям, когда они не смогут отправлять запросы на запись в эту службу.</span><span class="sxs-lookup"><span data-stu-id="3e239-156">Although such a scenario is rare, it is important that clients and services that depend on a stateful service are prepared to handle situations where they cannot make write requests to it.</span></span> <span data-ttu-id="3e239-157">Также следует помнить, что сама служба с отслеживанием состояния знает о такой возможности и может надлежащим образом сообщить о ней вызывающим сторонам.</span><span class="sxs-lookup"><span data-stu-id="3e239-157">It is also important that the stateful service itself is aware of this possibility and can gracefully communicate it to callers.</span></span>

<span data-ttu-id="3e239-158">Потерю кворума можно вызвать с помощью командлета PowerShell **Invoke-ServiceFabricPartitionQuorumLoss** :</span><span class="sxs-lookup"><span data-stu-id="3e239-158">You can induce quorum loss by using the PowerShell **Invoke-ServiceFabricPartitionQuorumLoss** cmdlet:</span></span>

```powershell

PS > Invoke-ServiceFabricPartitionQuorumLoss -ServiceName fabric:/Myapplication/MyService -QuorumLossMode QuorumReplicas -QuorumLossDurationInSeconds 20

```

<span data-ttu-id="3e239-159">В этом примере мы задаем для параметра `QuorumLossMode` значение `QuorumReplicas`, чтобы указать, что нам нужно вызвать потерю кворума без отключения всех реплик.</span><span class="sxs-lookup"><span data-stu-id="3e239-159">In this example, we set `QuorumLossMode` to `QuorumReplicas` to indicate that we want to induce quorum loss without taking down all replicas.</span></span> <span data-ttu-id="3e239-160">Таким образом выполнение операций чтения по-прежнему возможно.</span><span class="sxs-lookup"><span data-stu-id="3e239-160">This way, read operations are still possible.</span></span> <span data-ttu-id="3e239-161">Чтобы протестировать сценарий, при котором недоступен весь раздел, для этого параметра можно задать значение `AllReplicas`.</span><span class="sxs-lookup"><span data-stu-id="3e239-161">To test a scenario where an entire partition is unavailable, you can set this switch to `AllReplicas`.</span></span>

## <a name="next-steps"></a><span data-ttu-id="3e239-162">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="3e239-162">Next steps</span></span>
[<span data-ttu-id="3e239-163">Дополнительные сведения о действиях, доступных благодаря подсистеме тестирования</span><span class="sxs-lookup"><span data-stu-id="3e239-163">Learn more about testability actions</span></span>](service-fabric-testability-actions.md)

[<span data-ttu-id="3e239-164">Дополнительные сведения о сценариях подсистемы тестирования</span><span class="sxs-lookup"><span data-stu-id="3e239-164">Learn more about testability scenarios</span></span>](service-fabric-testability-scenarios.md)


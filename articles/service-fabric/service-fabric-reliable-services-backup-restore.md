---
title: "aaaService структуры резервного копирования и восстановления | Документы Microsoft"
description: "Основная документация по резервному копированию и восстановлению платформы Service Fabric"
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: e502b59c84999c3fe825167383f00a5ebd70c9b5
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a>Резервное копирование и восстановление служб Reliable Services и субъектов Reliable Actors
Azure Service Fabric — это платформа высокого уровня доступности, которое реплицирует состояние hello по несколько узлов toomaintain высокого уровня доступности.  Таким образом даже в случае сбоя одного узла в кластере hello hello службы по-прежнему доступны toobe. Хотя эта избыточность встроенными, предоставляемых платформой hello может быть достаточно для некоторых, в некоторых случаях желательно для hello tooback службы данных (внешнее хранилище tooan).

> [!NOTE]
> Он критических toobackup и восстановления данных (и тест, который он работает нужным образом), вы можете получить от потери данных.
> 
> 

Например служба может потребоваться tooback копирование данных в порядке tooprotect из hello следующие сценарии:

- В событии hello hello необратимой потере всего кластера Service Fabric.
- Безвозвратная потеря большинства реплик hello служебного раздела
- Административных ошибок, при котором состояние hello случайно возвращает удален или поврежден. Например это может произойти, если администратор с достаточными правами ошибочно удаляет службу hello.
- Ошибок в службе hello, привести к повреждению данных. Например это может происходить при запуске службы обновления кода записи неисправный данных tooa надежного коллекции. В этом случае оба hello кода и данных hello, возможно, toobe отменены tooan ранее состояния.
- При автономной обработке данных. Может оказаться удобным toohave автономную обработку данных для бизнес-аналитики, в который осуществляется отдельно от службы hello, создает данные hello.

функция резервного копирования и восстановления Hello позволяет службам, созданным на hello надежные API служб toocreate и восстановления резервных копий. Hello резервного копирования API-интерфейсов, предоставляемых платформой hello разрешить архивы состояния раздела службы, без блокировки чтения и записи операций. Восстановление Hello интерфейсы API позволяют toobe состояние раздела службы, восстановить из выбранной резервной копии.

## <a name="types-of-backup"></a>Типы архивации
Существует два варианта архивации: полная и добавочная.
Резервная копия, содержащая все hello данные, необходимые toorecreate hello состояние hello реплики является полной резервной копии: контрольные точки и все записи журнала.
Так как он содержит hello контрольных точек и журналов hello, сам по себе может быть восстановлена полной резервной копии.

Hello проблема с полные резервные копии возникает, когда hello контрольные точки имеют большой размер.
Например реплика, которая 16 ГБ состояния будет иметь контрольные точки, из которых состоит примерно too16 ГБ.
Если у нас есть пять минут цели точки восстановления, реплики hello должен toobe резервное копирование каждые пять минут.
Каждый раз, он создает резервную копию, он должен toocopy 16 ГБ контрольных точек в дополнение к этому too50 МБ (можно настроить с помощью `CheckpointThresholdInMB`), за которые журналы.

![Пример полной архивации.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

проблема toothis Hello решение — добавочное резервное копирование, где резервной копии содержит только записи журнала hello изменен с момента последнего резервного копирования hello.

![Пример добавочной архивации.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

Поскольку добавочное резервное копирование только изменения, сделанные с момента последнего резервного копирования hello (не включает hello контрольных точек), они, как правило, toobe быстрее, но их можно восстанавливать по отдельности.
toorestore добавочное резервное копирование всей цепочки резервных копий hello является обязательным.
Цепочка резервных копий — это ряд резервных копий, начинающийся с полной резервной копии, за которой следует несколько добавочных резервных копий, которые создавались непрерывно.

## <a name="backup-reliable-services"></a>Резервное копирование служб Reliable Services
Hello автор службы имеет полный доступ, когда toomake резервного копирования и хранения резервных копий.

toostart резервной копии hello служба должна функция-член наследуется hello tooinvoke `BackupAsync`.  
Резервные копии могут быть созданы только из основной реплики и требуют предоставлены toobe состояние записи.

Как показано ниже, `BackupAsync` принимает `BackupDescription` объекта, где один можно указать полное или добавочное резервное копирование, а также функцию обратного вызова, `Func<< BackupInfo, CancellationToken, Task<bool>>>` , вызывается, когда hello папка резервного копирования будет создана локально и готов toobe перемещается out toosome Внешнее хранилище.

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

Запрос tootake добавочного резервного копирования может завершиться `FabricMissingFullBackupException`. Это исключение указывает, что один из следующих вещей hello происходит:

- реплика Hello не переводится полной резервной копии, поскольку она теперь стала первичной,
- Некоторые hello записи журнала, с момента последнего резервного копирования hello был усечен или
- реплика, переданный hello `MaxAccumulatedBackupLogSizeInMB` ограничение.

Пользователи могут увеличивать hello вероятность может toodo добавочное резервное копирование, настроив `MinLogSizeInMB` или `TruncationThresholdFactor`.
Обратите внимание, что увеличение этих значений увеличивает hello в реплику на диске.
Чтобы узнать больше, ознакомьтесь с [конфигурацией Reliable Services](service-fabric-reliable-services-configuration.md).

`BackupInfo`Предоставляет сведения, касающиеся hello резервной копии, включая расположение hello hello папку для сохранения резервной копии hello в hello среды выполнения (`BackupInfo.Directory`). функция обратного вызова Hello можно переместить hello `BackupInfo.Directory` tooan внешнем хранилище или в другом месте.  Эта функция также возвращает логическое значение, указывающее, была ли может toosuccessfully перемещения hello tooits целевой папке архивации.

Hello следующий код демонстрирует, как hello `BackupCallbackAsync` метод может быть используется tooupload hello резервного копирования tooAzure хранилища:

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

В предыдущем примере hello `ExternalBackupStore` — класс образец hello, используемые toointerface с хранилищем больших двоичных объектов Azure и `UploadBackupFolderAsync` — метод hello, сжимает папку hello и помещает его в хранилище больших двоичных объектов Azure hello.

Обратите внимание на следующее.

  - В любой момент времени в реплике можно выполнить только одну операцию резервного копирования. Более одного `BackupAsync` вызовов одновременно вызовет `FabricBackupInProgressException` toolimit порядковых резервные копии tooone.
  - Если реплики при сбое во время резервного копирования, резервное копирование hello возможно не завершена. Таким образом, после завершения выполнения hello отработки отказа, это hello службы ответственность toorestart hello резервная копия путем вызова `BackupAsync` при необходимости.

## <a name="restore-reliable-services"></a>Восстановление служб Reliable Services
В общем случае hello случаях, когда может потребоваться tooperform операции восстановления относятся к одной из этих категорий:

  - Служба Hello секционировать данные потеряны. Например диск hello для двух из трех реплик для секции (включая первичную реплику hello) возвращает поврежден или очищено. Hello новой первичной реплике может понадобиться toorestore данных из резервной копии.
  - Hello всей службы теряется. Например администратор удаляет hello всей службе и таким образом, служба hello и hello данных должен восстановить toobe.
  - Служба Hello реплицированные данные повреждены приложения (например, из-за ошибку приложения). В этом случае служба hello имеет toobe обновления или возвращенной tooremove hello причину повреждения hello и не были повреждены данные имеет toobe восстановлена.

Хотя многими способами, возможно, мы предлагаем некоторые примеры использования `RestoreAsync` toorecover из hello выше сценариев.

## <a name="partition-data-loss-in-reliable-services"></a>Потеря данных раздела в службах Reliable Services
В этом случае среда выполнения hello автоматически обнаруживает hello потери данных и вызова неуправляемого кода hello `OnDataLossAsync` API.

автор службы Hello должен hello tooperform toorecover следующие:

  - Переопределите метод hello виртуального базового класса `OnDataLossAsync`.
  - Найти hello в последней резервной копии hello внешний носитель, содержащий резервные копии службы hello.
  - Загрузка hello последнюю резервную копию (и распаковать в папку резервного копирования hello hello резервного копирования, если она была сжата).
  - Hello `OnDataLossAsync` предоставляет метод `RestoreContext`. Вызовите hello `RestoreAsync` API на предоставленный hello `RestoreContext`.
  - Возвращает значение true, если hello восстановления завершается успешно.

Ниже приведен пример реализации hello `OnDataLossAsync` метод:

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

`RestoreDescription`Переданный toohello `RestoreContext.RestoreAsync` вызов содержит член с именем `BackupFolderPath`.
При восстановлении одной полной резервной копии, это `BackupFolderPath` следует задать локальный путь toohello hello папке, содержащей к полной резервной копии.
При восстановлении полной резервной копии и количество добавочное резервное копирование, `BackupFolderPath` должно быть установлено toohello локальный путь к папке hello, содержит не только hello полной резервной копии, но также все hello добавочных резервных копий.
`RestoreAsync`вызов может вызывать `FabricMissingFullBackupException` Если hello `BackupFolderPath` указано не содержит полной резервной копии.
Он также может породить `ArgumentException`, если `BackupFolderPath` указывает на папку с нарушенной цепочкой добавочных резервных копий.
Например если она содержит hello полного резервного копирования, сначала hello добавочных и hello третий добавочное резервное копирование, но не hello второй добавочного резервного копирования.

> [!NOTE]
> по умолчанию Hello RestorePolicy имеет значение tooSafe.  Это означает, что hello `RestoreAsync` API, будут завершаться ArgumentException при обнаружении эта папка резервного копирования hello содержит состояние, которое является более ранней, чем или равно toohello состоянием, содержащимся в этой реплике.  `RestorePolicy.Force`можно использовать tooskip такую проверку. Этот параметр указывается как часть `RestoreDescription`.
> 

## <a name="deleted-or-lost-service"></a>Удаленная или утерянная служба
При удалении службы необходимо сначала создать службу hello перед восстановлением данных hello.  Это важные toocreate службу hello с приветствия новую конфигурацию, например, схему, секционирования, которая hello данных может быть восстановлена без проблем.  После обновления hello hello данных toorestore API (`OnDataLossAsync` выше) имеет toobe вызывается в каждом разделе этой службы. Один из способов сделать это — использовать `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` в каждой секции.  

С этого момента реализации является hello аналогично hello выше сценария. Каждая секция должна toorestore hello последние соответствующего резервного копирования из внешнего хранилища hello. Один оговорка заключается в этой секции hello, возможно, идентификатор теперь изменился, поскольку среда выполнения hello динамически создает идентификаторы секций. Таким образом служба hello должна toostore hello подходящий метод секционирования сведения и службы имя tooidentify hello правильный последней резервной копии toorestore из для каждой секции.

> [!NOTE]
> Не рекомендуется toouse `FabricClient.ServiceManager.InvokeDataLossAsync` для каждой секции toorestore hello всей службы, так как, может привести к повреждению состояния кластера.
> 

## <a name="replication-of-corrupt-application-data"></a>Репликация поврежденных данных приложения
Обновление приложения hello вновь развернуть обнаруживается ошибка, может привести к повреждению данных. Например обновление приложения может запускаться tooupdate каждой записи номера телефона в надежные словаря с недопустимый код города.  В этом случае hello недопустимыми номерами телефонов будут реплицированы, поскольку Service Fabric не учитывать характер hello hello данных, которая хранится.

Hello первое, что toodo после обнаружения таких egregious ошибку, приводят к повреждению данных является toofreeze hello службы на уровне приложения hello и, если это возможно, обновление версии toohello кода приложения hello, у которого нет ошибки hello.  Даже после устранения код службы hello hello данных по-прежнему может быть поврежден и таким образом данных может потребоваться восстановить toobe.  В таких случаях его может оказаться достаточно toorestore hello последнюю резервную копию, так как hello последние резервные копии могут быть повреждены.  Таким образом у вас есть toofind hello последней резервной копии, сделанной до повреждения данных hello получен.

Если вы не уверены, какие резервные копии, повреждены, можно развернуть в новый кластер Service Fabric и восстановите резервные копии затронутые секции, так же, как hello выше «Deleted или потеряны службы» hello сценария.  Для каждой из секций запустите восстановление резервных копий hello из самой последней toohello hello бы. Найдя резервную копию, которая не повреждение hello, переместить или удалить все резервные копии этого раздела, были новее (этой резервной копии). Повторите эту процедуру для каждой секции. Теперь, когда `OnDataLossAsync` вызывается в hello производственного кластера раздела hello, hello последней резервной копии найден в hello внешнего хранилища будут hello выбрать одно, hello выше процесса.

Теперь hello шагов в hello, «Deleted или потеряны службы» раздела могут быть используется toorestore hello состояние hello службы toohello до дефектный код hello повреждения состояния hello.

Обратите внимание на следующее.

  - При восстановлении, существует вероятность того, что hello резервного копирования, восстановления старее, чем состояние hello hello секции перед hello данных было потеряно. По этой причине следует восстановить только как последнее средство спасения toorecover объема данных, насколько это возможно.
  - Строка, представляющая путь к папке резервного копирования hello Hello и hello пути к файлам в папке резервного копирования hello может превышать 255 символов, в зависимости от пути FabricDataRoot hello и длина имени типа приложения. Это может вызвать некоторые методы .NET, таких как `Directory.Move`, toothrow hello `PathTooLongException` исключение. Одно решение — toodirectly вызывает kernel32 API-интерфейсы, такие как `CopyFile`.

## <a name="backup-and-restore-reliable-actors"></a>Резервное копирование и восстановление субъектов Reliable Actors


Платформа Reliable Actors создана на основе Reliable Services. Hello ActorService, на котором размещается hello actor(s) является надежных служб с отслеживанием состояния. Таким образом все hello резервного копирования и восстановления функциональных возможностей, доступных в надежные службы также доступны tooReliable субъекты (кроме поведений, которые поставщик состояний конкретного). Так как резервные копии будут создаваться для каждого раздела, состояния всех субъектов в этом разделе будут архивированы (восстановление будет происходить для каждого раздела). tooperform резервного копирования и восстановления, владелец службы hello следует создавать пользовательские субъекта службы класс, производный от класса ActorService и затем резервного копирования и восстановления tooReliable аналогичные службы, как описано выше в предыдущих разделах.

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

При создании пользовательских субъекта классом службы, потребуется tooregister, а также при регистрации hello субъекта.

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

поставщик состояния по умолчанию Hello для службы Reliable Actor `KvsActorStateProvider`. Добавочная архивация для `KvsActorStateProvider` не включена по умолчанию. Добавочное резервное копирование можно включить, создав `KvsActorStateProvider` с hello соответствующий параметр в конструкторе и передачи его конструктору tooActorService, как показано в следующем фрагменте кода:

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

После включения добавочного резервного копирования добавочного резервного копирования может завершиться FabricMissingFullBackupException по одной из следующих причин и вам потребуется tootake полной резервной копии перед выполнением добавочного архивы:

  - Hello реплики никогда не было полной резервной копии, так как он стал основным.
  - Некоторые записи журнала hello было усечено, поскольку последняя резервная копия была сделана.

Если добавочное резервное копирование включено, `KvsActorStateProvider` не использует toomanage циклического буфера журнала записывает и периодически производит усечение. Если нет резервной копии пользователем в течение 45 минут hello системы автоматически усекает hello записей журнала. Этот интервал можно настроить, указав `logTrunctationIntervalInMinutes` в `KvsActorStateProvider` конструктор (аналогично toowhen включения добавочного резервного копирования). записи журнала Hello также может получить усечена, если первичная реплика должны toobuild другой реплике, отправляя свои данные.

При выполнении восстановления из резервной копии цепочки, аналогичные службы tooReliable, hello BackupFolderPath должен содержать подкаталогов по один вложенный каталог, содержащий полное резервное копирование и другие подкаталогов, содержащих добавочное архивы. API восстановления Hello вызовет FabricException с соответствующим сообщением об ошибке при сбое проверки hello цепочку резервных копий. 

> [!NOTE]
> `KvsActorStateProvider`в настоящее время пропускает параметр hello RestorePolicy.Safe. В следующих выпусках планируется поддержка этой функции.
> 

## <a name="testing-backup-and-restore"></a>Проверка резервного копирования и восстановления
Это важные tooensure, который выполняется резервное копирование важных данных и могут быть восстановлены из. Это можно сделать путем вызова hello `Start-ServiceFabricPartitionDataLoss` в PowerShell, который может вызвать потерю данных в заданной секции tootest ли hello данных резервного копирования и восстановления для правильной работы службы.  Это также возможно tooprogrammatically вызывать потерю данных и восстановление из этого события, а также.

> [!NOTE]
> Можно найти образец реализации резервного копирования и восстановления функциональности в hello веб-ссылку приложения на GitHub. См. в hello `Inventory.Service` службы для получения дополнительных сведений.
> 
> 

## <a name="under-hello-hood-more-details-on-backup-and-restore"></a>Hello механизме: Дополнительные сведения о резервном копировании и восстановлении
Далее представлены дополнительные сведения о резервном копировании и восстановлении.

### <a name="backup"></a>Резервное копирование
Hello надежного диспетчер состояний предоставляет hello возможность toocreate согласованных копий без блокировки любых операций чтения или записи. toodo таким образом, он использует механизм сохраняемости контрольной точки или журнала.  Hello надежного диспетчер состояния принимает нечеткого (упрощенный) контрольные точки в определенных давление toorelieve точек из журнала транзакций hello и сократить время восстановления.  При `BackupAsync` вызове hello надежного диспетчер состояния указывает, что все объекты надежного toocopy их последней контрольной точки файлы tooa локальной папки резервных копий.  Затем hello надежного диспетчер состояния копирует все записи журнала, начиная с hello «start указатель» toohello последней записи в журнале в папке резервных копий hello.  Так как все записи журнала hello вверх toohello последней записи в журнале включаются в резервную копию hello и hello надежного диспетчер состояния сохраняет упреждающее ведение журнала, hello надежного диспетчер состояния гарантирует, что все транзакции, фиксируются (`CommitAsync` вернул успешно), включаются в резервную копию hello.

Любая транзакция, которая фиксируется после `BackupAsync` был вызван может или не может быть в резервной копии hello.  После заполнения платформой hello hello локальной папки резервных копий (т. е. локальный архивирования средой выполнения hello) hello службы резервного копирования обратный вызов.  Этот обратный вызов отвечает за перемещение hello папка резервного копирования tooan внешнее расположение таких как хранилище Azure.

### <a name="restore"></a>восстановление;
Hello надежного диспетчер состояния обеспечивает возможность toorestore hello из резервной копии с помощью hello `RestoreAsync` API.  
Hello `RestoreAsync` метод `RestoreContext` может вызываться только внутри hello `OnDataLossAsync` метод.
Здравствуйте, bool, возвращенных `OnDataLossAsync` указывает ли служба hello восстановить свое состояние из внешнего источника.
Если hello `OnDataLossAsync` возвращает значение true, заново всех остальных реплик из этому Service Fabric. Гарантирует, что Service Fabric реплик, которые будут получать `OnDataLossAsync` вызывать первый переход toohello первичной роли, но не предоставляется чтение состояния или состояние записи.
Это означает, что для исполнителей StatefulService метод `RunAsync` будет вызван только после успешного завершения метода `OnDataLossAsync`.
Затем `OnDataLossAsync` будет вызван на новом сервере-источнике hello.
Пока служба завершается успешно (возвращая true или false) этот API и завершает соответствующий перенастройки hello, hello API будет хранить вызывается по одному.

`RestoreAsync`сначала удаляет все существующие состояния в hello первичной реплики, он вызывался.  
Затем hello надежного диспетчер состояний создает все hello надежного объекты, существующие в папке резервных копий hello.  
Затем объекты надежного hello, toorestore соответствии с их контрольных точек в папке резервных копий hello.  
Наконец hello надежного диспетчер состояния восстанавливает собственное состояние из hello записей журнала в папке резервных копий hello и выполняет восстановление.  
Как часть процесса восстановления hello начиная с hello «основы» операции, которые имеют фиксации записи журнала в папке резервных копий hello являются объектами надежного воспроизводимой toohello.  
Это действие гарантирует, что hello восстановленные состояние.

## <a name="next-steps"></a>Дальнейшие действия
  - [Reliable Collections](service-fabric-work-with-reliable-collections.md)
  - [Краткое руководство по надежным службам Reliable Services](service-fabric-reliable-services-quick-start.md)
  - [Уведомления Reliable Services](service-fabric-reliable-services-notifications.md)
  - [Конфигурация Reliable Services](service-fabric-reliable-services-configuration.md)
  - [Справочник разработчика по надежным коллекциям](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)


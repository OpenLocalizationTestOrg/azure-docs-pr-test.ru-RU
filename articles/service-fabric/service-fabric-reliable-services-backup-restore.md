---
title: "Резервное копирование и восстановление Service Fabric | Документация Майкрософт"
description: "Основная документация по резервному копированию и восстановлению платформы Service Fabric"
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: 4242962e7e03053ef25f198a0b2f6c8012e693eb
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="cea63-103">Резервное копирование и восстановление служб Reliable Services и субъектов Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="cea63-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="cea63-104">Azure Service Fabric — это платформа высокой доступности, которая реплицирует состояние между несколькими узлами для обеспечения высокой доступности.</span><span class="sxs-lookup"><span data-stu-id="cea63-104">Azure Service Fabric is a high-availability platform that replicates the state across multiple nodes to maintain this high availability.</span></span>  <span data-ttu-id="cea63-105">Таким образом, даже в случае сбоя одного узла в кластере службы будут оставаться доступными.</span><span class="sxs-lookup"><span data-stu-id="cea63-105">Thus, even if one node in the cluster fails, the services continue to be available.</span></span> <span data-ttu-id="cea63-106">Хотя иногда предоставленной платформой встроенной избыточности достаточно, в некоторых случаях желательно выполнять резервное копирование данных службы (во внешнее хранилище).</span><span class="sxs-lookup"><span data-stu-id="cea63-106">While this in-built redundancy provided by the platform may be sufficient for some, in certain cases it is desirable for the service to back up data (to an external store).</span></span>

> [!NOTE]
> <span data-ttu-id="cea63-107">Крайне важно создавать резервные копии и восстанавливать данные (и проверить, что они работают) в случае потери данных.</span><span class="sxs-lookup"><span data-stu-id="cea63-107">It is critical to backup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="cea63-108">Например, службе может потребоваться создать резервную копию данных для защиты от таких сценариев:</span><span class="sxs-lookup"><span data-stu-id="cea63-108">For example, a service may want to back up data in order to protect from the following scenarios:</span></span>

- <span data-ttu-id="cea63-109">в случае полной потери всего кластера Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="cea63-109">In the event of the permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="cea63-110">Полной потери большей части реплик секций служб.</span><span class="sxs-lookup"><span data-stu-id="cea63-110">Permanent loss of a majority of the replicas of a service partition</span></span>
- <span data-ttu-id="cea63-111">Если из-за административных ошибок произошло случайное удаление или повреждение состояния.</span><span class="sxs-lookup"><span data-stu-id="cea63-111">Administrative errors whereby the state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="cea63-112">Это может произойти, если администратор с достаточными привилегиями ошибочно удалил службу.</span><span class="sxs-lookup"><span data-stu-id="cea63-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes the service.</span></span>
- <span data-ttu-id="cea63-113">Если из-за ошибок в службе происходит повреждение данных.</span><span class="sxs-lookup"><span data-stu-id="cea63-113">Bugs in the service that cause data corruption.</span></span> <span data-ttu-id="cea63-114">Например, это может произойти, если при обновлении кода службы начинается запись поврежденных данных в надежную коллекцию.</span><span class="sxs-lookup"><span data-stu-id="cea63-114">For example, this may happen when a service code upgrade starts writing faulty data to a Reliable Collection.</span></span> <span data-ttu-id="cea63-115">В этом случае может потребоваться вернуть код и данные в предыдущее состояние.</span><span class="sxs-lookup"><span data-stu-id="cea63-115">In such a case, both the code and the data may have to be reverted to an earlier state.</span></span>
- <span data-ttu-id="cea63-116">При автономной обработке данных.</span><span class="sxs-lookup"><span data-stu-id="cea63-116">Offline data processing.</span></span> <span data-ttu-id="cea63-117">Автономная обработка данных для бизнес-аналитики, которая происходит отдельно от службы, создающей данные, может быть очень удобной.</span><span class="sxs-lookup"><span data-stu-id="cea63-117">It might be convenient to have offline processing of data for business intelligence that happens separately from the service that generates the data.</span></span>

<span data-ttu-id="cea63-118">Благодаря функции резервного копирования и восстановления службы, созданные на основе интерфейса API Reliable Services, могут создавать и восстанавливать резервные копии.</span><span class="sxs-lookup"><span data-stu-id="cea63-118">The Backup/Restore feature allows services built on the Reliable Services API to create and restore backups.</span></span> <span data-ttu-id="cea63-119">Интерфейсы API резервного копирования, предоставляемые платформой, позволяют выполнять резервное копирование состояния секции службы без блокировки операций чтения или записи.</span><span class="sxs-lookup"><span data-stu-id="cea63-119">The backup APIs provided by the platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="cea63-120">Благодаря им можно восстановить состояние раздела службы из выбранной резервной копии.</span><span class="sxs-lookup"><span data-stu-id="cea63-120">The restore APIs allow a service partition's state to be restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="cea63-121">Типы архивации</span><span class="sxs-lookup"><span data-stu-id="cea63-121">Types of Backup</span></span>
<span data-ttu-id="cea63-122">Существует два варианта архивации: полная и добавочная.</span><span class="sxs-lookup"><span data-stu-id="cea63-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="cea63-123">Полная резервная копия — это копия, которая содержит все данные, необходимые для воссоздания состояния реплики: контрольные точки и все записи журнала.</span><span class="sxs-lookup"><span data-stu-id="cea63-123">A full backup is a backup that contains all the data required to recreate the state of the replica: checkpoints and all log records.</span></span>
<span data-ttu-id="cea63-124">Так как она содержит контрольные точки и журнал, полная резервная копия может быть восстановлена самостоятельно.</span><span class="sxs-lookup"><span data-stu-id="cea63-124">Since it has the checkpoints and the log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="cea63-125">Проблемы с полными резервными копиями возникают, когда контрольные точки имеют большой размер.</span><span class="sxs-lookup"><span data-stu-id="cea63-125">The problem with full backups arises when the checkpoints are large.</span></span>
<span data-ttu-id="cea63-126">Например, у реплики, которая имеет 16 ГБ данных состояния, будут контрольные точки, которые добавят примерно до 16 ГБ данных.</span><span class="sxs-lookup"><span data-stu-id="cea63-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately to 16 GB.</span></span>
<span data-ttu-id="cea63-127">Если целевая точка восстановления составляет пять минут, реплику необходимо архивировать каждые пять минут.</span><span class="sxs-lookup"><span data-stu-id="cea63-127">If we have a Recovery Point Objective of five minutes, the replica needs to be backed up every five minutes.</span></span>
<span data-ttu-id="cea63-128">При каждой архивации требуется скопировать 16 ГБ контрольных точек в дополнение к 50 МБ журналов (можно настроить с помощью `CheckpointThresholdInMB`).</span><span class="sxs-lookup"><span data-stu-id="cea63-128">Each time it backs up it needs to copy 16 GB of checkpoints in addition to 50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Пример полной архивации.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="cea63-130">Решением этой проблемы является добавочная архивация, при которой архивируются только измененные записи журнала, созданные после последней архивации.</span><span class="sxs-lookup"><span data-stu-id="cea63-130">The solution to this problem is incremental backups, where backup only contains the changed log records since the last backup.</span></span>

![Пример добавочной архивации.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="cea63-132">Так как в добавочные резервные копии архивируются только изменения, внесенные с момента последней архивации (без контрольных точек), то обычно они быстрее, однако их нельзя восстановить самостоятельно.</span><span class="sxs-lookup"><span data-stu-id="cea63-132">Since incremental backups are only changes since the last backup (does not include the checkpoints), they tend to be faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="cea63-133">Чтобы восстановить добавочную резервную копию, требуется вся цепочка резервных копий.</span><span class="sxs-lookup"><span data-stu-id="cea63-133">To restore an incremental backup, the entire backup chain is required.</span></span>
<span data-ttu-id="cea63-134">Цепочка резервных копий — это ряд резервных копий, начинающийся с полной резервной копии, за которой следует несколько добавочных резервных копий, которые создавались непрерывно.</span><span class="sxs-lookup"><span data-stu-id="cea63-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="cea63-135">Резервное копирование служб Reliable Services</span><span class="sxs-lookup"><span data-stu-id="cea63-135">Backup Reliable Services</span></span>
<span data-ttu-id="cea63-136">Создатель службы полностью контролирует время выполнения резервного копирования и место хранения резервных копий.</span><span class="sxs-lookup"><span data-stu-id="cea63-136">The service author has full control of when to make backups and where backups will be stored.</span></span>

<span data-ttu-id="cea63-137">Чтобы начать архивацию, служба должна вызвать наследуемую функцию-член `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="cea63-137">To start a backup, the service needs to invoke the inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="cea63-138">Резервное копирование можно выполнить только из первичных реплик, которым необходимо присвоить состояние записи.</span><span class="sxs-lookup"><span data-stu-id="cea63-138">Backups can be made only from primary replicas, and they require write status to be granted.</span></span>

<span data-ttu-id="cea63-139">Как показано ниже, `BackupAsync` принимает объект `BackupDescription`, где можно указать полную или добавочную архивацию, а также функцию обратного вызова `Func<< BackupInfo, CancellationToken, Task<bool>>>`, которая вызывается, если папка резервных копий была создана локально и готова к переносу во внешнее хранилище.</span><span class="sxs-lookup"><span data-stu-id="cea63-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when the backup folder has been created locally and is ready to be moved out to some external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="cea63-140">Запрос на добавочную архивацию может завершиться сбоем с исключением `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="cea63-140">Request to take an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="cea63-141">Это исключение указывает, что происходит одно из следующих действий:</span><span class="sxs-lookup"><span data-stu-id="cea63-141">This exception indicates that one of the following things is happening:</span></span>

- <span data-ttu-id="cea63-142">для реплики никогда не создавалась полная резервная копия, так как она стала первичной,</span><span class="sxs-lookup"><span data-stu-id="cea63-142">the replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="cea63-143">либо с момента последнего ее создания были усечены некоторые записи журнала, либо</span><span class="sxs-lookup"><span data-stu-id="cea63-143">some of the log records since the last backup has been truncated or</span></span>
- <span data-ttu-id="cea63-144">размер реплики превысил ограничение `MaxAccumulatedBackupLogSizeInMB`.</span><span class="sxs-lookup"><span data-stu-id="cea63-144">replica passed the `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="cea63-145">Пользователи могут увеличить вероятность выполнения добавочной архивации, настроив `MinLogSizeInMB` или `TruncationThresholdFactor`.</span><span class="sxs-lookup"><span data-stu-id="cea63-145">Users can increase the likelihood of being able to do incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="cea63-146">Обратите внимание, что увеличение этих значений приведет к более интенсивному использованию дискового пространства каждой репликой.</span><span class="sxs-lookup"><span data-stu-id="cea63-146">Note that increasing these values increases the per replica disk usage.</span></span>
<span data-ttu-id="cea63-147">Чтобы узнать больше, ознакомьтесь с [конфигурацией Reliable Services](service-fabric-reliable-services-configuration.md).</span><span class="sxs-lookup"><span data-stu-id="cea63-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="cea63-148">В `BackupInfo` содержатся сведения о резервной копии, включая расположение папки в среде выполнения, где сохранена резервная копия (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="cea63-148">`BackupInfo` provides information regarding the backup, including the location of the folder where the runtime saved the backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="cea63-149">Чтобы выполнить функцию обратного вызова, необходимо переместить `BackupInfo.Directory` во внешнее хранилище или другое расположение.</span><span class="sxs-lookup"><span data-stu-id="cea63-149">The callback function can move the `BackupInfo.Directory` to an external store or another location.</span></span>  <span data-ttu-id="cea63-150">Эта функция также возвращает логическое значение bool, указывающее, успешно ли перемещена папка резервного копирования в целевое расположение.</span><span class="sxs-lookup"><span data-stu-id="cea63-150">This function also returns a bool that indicates whether it was able to successfully move the backup folder to its target location.</span></span>

<span data-ttu-id="cea63-151">В следующем коде показано, как с помощью метода `BackupCallbackAsync` можно передать резервную копию в службу хранилища Microsoft Azure:</span><span class="sxs-lookup"><span data-stu-id="cea63-151">The following code demonstrates how the `BackupCallbackAsync` method can be used to upload the backup to Azure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="cea63-152">В примере выше `ExternalBackupStore` — это пример класса, используемого для взаимодействия с хранилищем BLOB-объектов Azure, а `UploadBackupFolderAsync` — это метод, используемый для сжатия и перемещения папки в хранилище BLOB-объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="cea63-152">In the preceeding example, `ExternalBackupStore` is the sample class that is used to interface with Azure Blob storage, and `UploadBackupFolderAsync` is the method that compresses the folder and places it in the Azure Blob store.</span></span>

<span data-ttu-id="cea63-153">Обратите внимание на следующее.</span><span class="sxs-lookup"><span data-stu-id="cea63-153">Note that:</span></span>

  - <span data-ttu-id="cea63-154">В любой момент времени в реплике можно выполнить только одну операцию резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="cea63-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="cea63-155">Выполнение нескольких вызовов метода `BackupAsync` одновременно приведет к вызову исключения `FabricBackupInProgressException`, которое ограничит создание резервных копий до одной за раз.</span><span class="sxs-lookup"><span data-stu-id="cea63-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` to limit inflight backups to one.</span></span>
  - <span data-ttu-id="cea63-156">В случае сбоя реплики при резервном копировании операция не будет завершена.</span><span class="sxs-lookup"><span data-stu-id="cea63-156">If a replica fails over while a backup is in progress, the backup may not have been completed.</span></span> <span data-ttu-id="cea63-157">Таким образом после завершения отработки отказа служба должна перезапустить архивацию, при необходимости вызвав метод `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="cea63-157">Thus, once the failover finishes, it is the service's responsibility to restart the backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="cea63-158">Восстановление служб Reliable Services</span><span class="sxs-lookup"><span data-stu-id="cea63-158">Restore Reliable Services</span></span>
<span data-ttu-id="cea63-159">Как правило, ситуации, в которых может потребоваться выполнить операцию восстановления, относятся к одной из следующих категорий:</span><span class="sxs-lookup"><span data-stu-id="cea63-159">In general, the cases when you might need to perform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="cea63-160">Потеря данных в разделе службы.</span><span class="sxs-lookup"><span data-stu-id="cea63-160">The service partition lost data.</span></span> <span data-ttu-id="cea63-161">Например, диск для двух из трех реплик для раздела (включая первичную реплику) поврежден или очищен.</span><span class="sxs-lookup"><span data-stu-id="cea63-161">For example, the disk for two out of three replicas for a partition (including the primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="cea63-162">Новой первичной реплике может потребоваться восстановить данные из резервной копии.</span><span class="sxs-lookup"><span data-stu-id="cea63-162">The new primary may need to restore data from a backup.</span></span>
  - <span data-ttu-id="cea63-163">Утеря всей службы.</span><span class="sxs-lookup"><span data-stu-id="cea63-163">The entire service is lost.</span></span> <span data-ttu-id="cea63-164">К примеру, администратор удаляет всю службу, и поэтому необходимо восстановить службу и данные.</span><span class="sxs-lookup"><span data-stu-id="cea63-164">For example, an administrator removes the entire service and thus the service and the data need to be restored.</span></span>
  - <span data-ttu-id="cea63-165">Репликация поврежденных данных приложения (например, из-за ошибки приложения) в службе.</span><span class="sxs-lookup"><span data-stu-id="cea63-165">The service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="cea63-166">В этом случае необходимо обновить службу или вернуть ее в прежнее состояние, чтобы устранить причину повреждения и восстановить неповрежденные данные.</span><span class="sxs-lookup"><span data-stu-id="cea63-166">In this case, the service has to be upgraded or reverted to remove the cause of the corruption, and non-corrupt data has to be restored.</span></span>

<span data-ttu-id="cea63-167">Несмотря на то что это можно сделать многими способами, мы приведем некоторые примеры использования `RestoreAsync` для восстановления в указанных выше сценариях.</span><span class="sxs-lookup"><span data-stu-id="cea63-167">While many approaches are possible, we offer some examples on using `RestoreAsync` to recover from the above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="cea63-168">Потеря данных раздела в службах Reliable Services</span><span class="sxs-lookup"><span data-stu-id="cea63-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="cea63-169">В этом случае среда выполнения автоматически обнаруживает потерю данных и вызывает интерфейс API `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="cea63-169">In this case, the runtime would automatically detect the data loss and invoke the `OnDataLossAsync` API.</span></span>

<span data-ttu-id="cea63-170">Чтобы восстановить данные, создателю службы необходимо сделать следующее:</span><span class="sxs-lookup"><span data-stu-id="cea63-170">The service author needs to perform the following to recover:</span></span>

  - <span data-ttu-id="cea63-171">Переопределите метод виртуального базового класса `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="cea63-171">Override the virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="cea63-172">Найти последнюю резервную копию во внешнем расположении, в котором содержатся резервные копии службы.</span><span class="sxs-lookup"><span data-stu-id="cea63-172">Find the latest backup in the external location that contains the service's backups.</span></span>
  - <span data-ttu-id="cea63-173">Скачать последнюю резервную копию (и распаковать ее в папку резервного копирования, если она была сжата).</span><span class="sxs-lookup"><span data-stu-id="cea63-173">Download the latest backup (and uncompress the backup into the backup folder if it was compressed).</span></span>
  - <span data-ttu-id="cea63-174">Метод `OnDataLossAsync` предоставляет `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="cea63-174">The `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="cea63-175">Вызовите API `RestoreAsync` для указанного `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="cea63-175">Call the `RestoreAsync` API on the provided `RestoreContext`.</span></span>
  - <span data-ttu-id="cea63-176">Вернуть значение true, если восстановление выполнено успешно.</span><span class="sxs-lookup"><span data-stu-id="cea63-176">Return true if the restoration was a success.</span></span>

<span data-ttu-id="cea63-177">Ниже приведен пример реализации метода `OnDataLossAsync`:</span><span class="sxs-lookup"><span data-stu-id="cea63-177">Following is an example implementation of the `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="cea63-178">Элемент `RestoreDescription`, переданный в вызов `RestoreContext.RestoreAsync`, содержит элемент с именем `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="cea63-178">`RestoreDescription` passed in to the `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="cea63-179">При восстановлении одной полной резервной копии этому элементу `BackupFolderPath` должен быть присвоен локальный путь к папке, содержащей полную резервную копию.</span><span class="sxs-lookup"><span data-stu-id="cea63-179">When restoring a single full backup, this `BackupFolderPath` should be set to the local path of the folder that contains your full backup.</span></span>
<span data-ttu-id="cea63-180">При восстановлении полной резервной копии и нескольких добавочных резервных копий `BackupFolderPath` должен быть присвоен локальный путь к папке, которая содержит не только полную резервную копию, но и все добавочные резервные копии.</span><span class="sxs-lookup"><span data-stu-id="cea63-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set to the local path of the folder that not only contains the full backup, but also all the incremental backups.</span></span>
<span data-ttu-id="cea63-181">Вызов `RestoreAsync` может породить `FabricMissingFullBackupException`, если указанный `BackupFolderPath` не содержит путь к полной резервной копии.</span><span class="sxs-lookup"><span data-stu-id="cea63-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if the `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="cea63-182">Он также может породить `ArgumentException`, если `BackupFolderPath` указывает на папку с нарушенной цепочкой добавочных резервных копий.</span><span class="sxs-lookup"><span data-stu-id="cea63-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="cea63-183">Например, если она содержит полную резервную копию, а также первую и третью добавочные резервные копии, но не содержит вторую добавочную резервную копию.</span><span class="sxs-lookup"><span data-stu-id="cea63-183">For example, if it contains the full backup, the first incremental and the third incremental backup but no the second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="cea63-184">Для параметра RestorePolicy по умолчанию установлено значение Safe.</span><span class="sxs-lookup"><span data-stu-id="cea63-184">The RestorePolicy is set to Safe by default.</span></span>  <span data-ttu-id="cea63-185">Это означает, что в случае обнаружения в папке резервных копий состояния, которое старее состояния в данной реплике или эквивалентно ему, произойдет сбой API `RestoreAsync` с исключением ArgumentException.</span><span class="sxs-lookup"><span data-stu-id="cea63-185">This means that the `RestoreAsync` API will fail with ArgumentException if it detects that the backup folder contains a state that is older than or equal to the state contained in this replica.</span></span>  <span data-ttu-id="cea63-186">`RestorePolicy.Force` может использоваться для пропуска такой проверки.</span><span class="sxs-lookup"><span data-stu-id="cea63-186">`RestorePolicy.Force` can be used to skip this safety check.</span></span> <span data-ttu-id="cea63-187">Этот параметр указывается как часть `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="cea63-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="cea63-188">Удаленная или утерянная служба</span><span class="sxs-lookup"><span data-stu-id="cea63-188">Deleted or lost service</span></span>
<span data-ttu-id="cea63-189">Если служба удалена, прежде чем восстанавливать данные, необходимо заново создать службу.</span><span class="sxs-lookup"><span data-stu-id="cea63-189">If a service is removed, you must first re-create the service before the data can be restored.</span></span>  <span data-ttu-id="cea63-190">Важно создать службу с такой же конфигурацией, например с такой же схемой секционирования, чтобы можно было легко восстановить данные.</span><span class="sxs-lookup"><span data-stu-id="cea63-190">It is important to create the service with the same configuration, e.g., partitioning scheme, so that the data can be restored seamlessly.</span></span>  <span data-ttu-id="cea63-191">После запуска службы для восстановления данных службы необходимо вызвать интерфейс API (`OnDataLossAsync` выше) в каждой секции этой службы.</span><span class="sxs-lookup"><span data-stu-id="cea63-191">Once the service is up, the API to restore data (`OnDataLossAsync` above) has to be invoked on every partition of this service.</span></span> <span data-ttu-id="cea63-192">Один из способов сделать это — использовать `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` в каждой секции.</span><span class="sxs-lookup"><span data-stu-id="cea63-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="cea63-193">С этого момента реализация осуществляется по описанному выше сценарию.</span><span class="sxs-lookup"><span data-stu-id="cea63-193">From this point, implementation is the same as the above scenario.</span></span> <span data-ttu-id="cea63-194">Необходимо восстановить последнюю соответствующую резервную копию из внешнего хранилища для каждого раздела.</span><span class="sxs-lookup"><span data-stu-id="cea63-194">Each partition needs to restore the latest relevant backup from the external store.</span></span> <span data-ttu-id="cea63-195">Следует учитывать один недостаток: идентификатор раздела, возможно, изменен, так как среда выполнения создает идентификаторы разделов динамически.</span><span class="sxs-lookup"><span data-stu-id="cea63-195">One caveat is that the partition ID may have now changed, since the runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="cea63-196">Таким образом, служба должна хранить сведения о соответствующем разделе и имени службы, чтобы правильно определить последнюю резервную копию, которую необходимо восстановить для каждого раздела.</span><span class="sxs-lookup"><span data-stu-id="cea63-196">Thus, the service needs to store the appropriate partition information and service name to identify the correct latest backup to restore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="cea63-197">Не рекомендуется использовать `FabricClient.ServiceManager.InvokeDataLossAsync` в каждой из секций для восстановления всей службы, так как это может привести к повреждению состояния кластера.</span><span class="sxs-lookup"><span data-stu-id="cea63-197">It is not recommended to use `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition to restore the entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="cea63-198">Репликация поврежденных данных приложения</span><span class="sxs-lookup"><span data-stu-id="cea63-198">Replication of corrupt application data</span></span>
<span data-ttu-id="cea63-199">Наличие ошибки в только что развернутом обновленном приложении может привести к повреждению данных.</span><span class="sxs-lookup"><span data-stu-id="cea63-199">If the newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="cea63-200">Например, обновленное приложение может запустить обновление всех записей телефонных номеров в надежном словаре с использованием недопустимого кода региона.</span><span class="sxs-lookup"><span data-stu-id="cea63-200">For example, an application upgrade may start to update every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="cea63-201">В этом случае недопустимые телефонные номера будут реплицированы, так как Service Fabric не учитывает характер хранимых данных.</span><span class="sxs-lookup"><span data-stu-id="cea63-201">In this case, the invalid phone numbers will be replicated since Service Fabric is not aware of the nature of the data that is being stored.</span></span>

<span data-ttu-id="cea63-202">Первое, что необходимо сделать после обнаружения такой серьезной ошибки, которая приводит к повреждению данных, — заморозить службу на уровне приложения и по возможности обновить приложение до версии без ошибки в коде.</span><span class="sxs-lookup"><span data-stu-id="cea63-202">The first thing to do after you detect such an egregious bug that causes data corruption is to freeze the service at the application level and, if possible, upgrade to the version of the application code that does not have the bug.</span></span>  <span data-ttu-id="cea63-203">Даже после исправления кода службы данные по-прежнему могут быть повреждены. Поэтому может потребоваться их восстановление.</span><span class="sxs-lookup"><span data-stu-id="cea63-203">However, even after the service code is fixed, the data may still be corrupt and thus data may need to be restored.</span></span>  <span data-ttu-id="cea63-204">В таких случаях восстановления последней резервной копии может оказаться недостаточно, так как последние резервные копии также могут быть повреждены.</span><span class="sxs-lookup"><span data-stu-id="cea63-204">In such cases, it may not be sufficient to restore the latest backup, since the latest backups may also be corrupt.</span></span>  <span data-ttu-id="cea63-205">Поэтому необходимо найти последнюю резервную копию, выполненную до повреждения данных.</span><span class="sxs-lookup"><span data-stu-id="cea63-205">Thus, you have to find the last backup that was made before the data got corrupted.</span></span>

<span data-ttu-id="cea63-206">Если вы не знаете, какие резервные копии повреждены, нужно развернуть новый кластер Service Fabric и восстановить резервные копии поврежденных разделов, как описано выше в сценарии «Удаленная или утерянная служба».</span><span class="sxs-lookup"><span data-stu-id="cea63-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore the backups of affected partitions just like the above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="cea63-207">Для каждой секции начните восстановление резервных копий от самой последней до самой ранней.</span><span class="sxs-lookup"><span data-stu-id="cea63-207">For each partition, start restoring the backups from the most recent to the least.</span></span> <span data-ttu-id="cea63-208">Обнаружив резервную копию без повреждений, переместите или удалите все резервные копии этой секции, которые новее этой резервной копии.</span><span class="sxs-lookup"><span data-stu-id="cea63-208">Once you find a backup that does not have the corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="cea63-209">Повторите эту процедуру для каждой секции.</span><span class="sxs-lookup"><span data-stu-id="cea63-209">Repeat this process for each partition.</span></span> <span data-ttu-id="cea63-210">Теперь при вызове метода `OnDataLossAsync` для раздела в рабочем кластере будет обнаружена необходимая последняя резервная копия во внешнем хранилище.</span><span class="sxs-lookup"><span data-stu-id="cea63-210">Now, when `OnDataLossAsync` is called on the partition in the production cluster, the last backup found in the external store will be the one picked by the above process.</span></span>

<span data-ttu-id="cea63-211">Чтобы восстановить службу до состояния, в котором она находилась до повреждения из-за ошибки в коде, можно использовать действия, описанные в разделе "Удаленная или утерянная служба".</span><span class="sxs-lookup"><span data-stu-id="cea63-211">Now, the steps in the "Deleted or lost service" section can be used to restore the state of the service to the state before the buggy code corrupted the state.</span></span>

<span data-ttu-id="cea63-212">Обратите внимание на следующее.</span><span class="sxs-lookup"><span data-stu-id="cea63-212">Note that:</span></span>

  - <span data-ttu-id="cea63-213">При восстановлении есть вероятность того, что состояние восстанавливаемой резервной копии старее состояния раздела до потери данных.</span><span class="sxs-lookup"><span data-stu-id="cea63-213">When you restore, there is a chance that the backup being restored is older than the state of the partition before the data was lost.</span></span> <span data-ttu-id="cea63-214">Из-за этого восстановление следует использовать только в качестве последнего средства для восстановления максимального объема данных.</span><span class="sxs-lookup"><span data-stu-id="cea63-214">Because of this, you should restore only as a last resort to recover as much data as possible.</span></span>
  - <span data-ttu-id="cea63-215">Строка, представляющая собой путь к папке резервного копирования и пути к файлам в этой папке, может содержать больше 255 символов в зависимости от пути FabricDataRoot и длины имени типа приложения.</span><span class="sxs-lookup"><span data-stu-id="cea63-215">The string that represents the backup folder path and the paths of files inside the backup folder can be greater than 255 characters, depending on the FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="cea63-216">Из-за этого такие методы .NET, как `Directory.Move`, могут породить исключение `PathTooLongException`.</span><span class="sxs-lookup"><span data-stu-id="cea63-216">This can cause some .NET methods, like `Directory.Move`, to throw the `PathTooLongException` exception.</span></span> <span data-ttu-id="cea63-217">Одно из возможных решений — напрямую вызывать интерфейсы API kernel32, такие как `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="cea63-217">One workaround is to directly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="cea63-218">Резервное копирование и восстановление субъектов Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="cea63-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="cea63-219">Платформа Reliable Actors создана на основе Reliable Services.</span><span class="sxs-lookup"><span data-stu-id="cea63-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="cea63-220">ActorService, в котором размещены субъекты, является надежной службой с отслеживанием состояния.</span><span class="sxs-lookup"><span data-stu-id="cea63-220">The ActorService which hosts the actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="cea63-221">Таким образом все функции архивации и восстановления, доступные в Reliable Services, также доступны для Reliable Actors (кроме определенных поведений поставщика состояний).</span><span class="sxs-lookup"><span data-stu-id="cea63-221">Hence, all the backup and restore functionality available in Reliable Services is also available to Reliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="cea63-222">Так как резервные копии будут создаваться для каждого раздела, состояния всех субъектов в этом разделе будут архивированы (восстановление будет происходить для каждого раздела).</span><span class="sxs-lookup"><span data-stu-id="cea63-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="cea63-223">Для выполнения архивации и восстановления владельцу службы следует создать класс пользовательской службы субъектов, а затем выполнить архивацию или восстановление (аналогично Reliable Services), как описано в предыдущих разделах.</span><span class="sxs-lookup"><span data-stu-id="cea63-223">To perform backup/restore, the service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar to Reliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="cea63-224">При создании класса пользовательской службы субъекта необходимо зарегистрировать его, также как при регистрации субъекта.</span><span class="sxs-lookup"><span data-stu-id="cea63-224">When you create a custom actor service class, you need to register that as well when registering the actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="cea63-225">Поставщик состояний по умолчанию для Reliable Actors — `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="cea63-225">The default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="cea63-226">Добавочная архивация для `KvsActorStateProvider` не включена по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="cea63-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="cea63-227">Добавочную архивацию можно включить, создав `KvsActorStateProvider` с соответствующим параметром в конструкторе и передав в конструктор ActorService, как показано в следующем фрагменте кода:</span><span class="sxs-lookup"><span data-stu-id="cea63-227">You can enable incremental backup by creating `KvsActorStateProvider` with the appropriate setting in its constructor and then passing it to ActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="cea63-228">После включения добавочной архивации по одной из следующих причин во время его выполнения может возникнуть ошибка FabricMissingFullBackupException, после чего необходимо будет выполнить полную архивацию перед повторной попыткой запуска добавочной:</span><span class="sxs-lookup"><span data-stu-id="cea63-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need to take a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="cea63-229">Для реплики никогда не создавалась полная резервная копия, так как она стала первичной.</span><span class="sxs-lookup"><span data-stu-id="cea63-229">The replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="cea63-230">Некоторые записи журнала были усечены с момента последней архивации.</span><span class="sxs-lookup"><span data-stu-id="cea63-230">Some of the log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="cea63-231">Если добавочная архивация включена, `KvsActorStateProvider` не использует циклический буфер для управления записями журнала и периодически усекает его.</span><span class="sxs-lookup"><span data-stu-id="cea63-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer to manage its log records and periodically truncates it.</span></span> <span data-ttu-id="cea63-232">Если пользователь не создает резервную копию в течение 45 минут, система автоматически усекает записи журнала.</span><span class="sxs-lookup"><span data-stu-id="cea63-232">If no backup is taken by user for a period of 45 minutes, the system automatically truncates the log records.</span></span> <span data-ttu-id="cea63-233">Этот интервал можно настроить, указав `logTrunctationIntervalInMinutes` в конструкторе `KvsActorStateProvider` (как при включении добавочной архивации).</span><span class="sxs-lookup"><span data-stu-id="cea63-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar to when enabling incremental backup).</span></span> <span data-ttu-id="cea63-234">Если нужно создать первичную реплику путем отправки всех ее данных, записи журнала также могут усекаться.</span><span class="sxs-lookup"><span data-stu-id="cea63-234">The log records may also get truncated if primary replica need to build another replica by sending all its data.</span></span>

<span data-ttu-id="cea63-235">При выполнении восстановления из цепочки резервных копий BackupFolderPath (аналогично Reliable Services) должен содержать подкаталоги. Один подкаталог должен содержать полную резервную копию, а остальные — добавочные резервные копии.</span><span class="sxs-lookup"><span data-stu-id="cea63-235">When doing restore from a backup chain, similar to Reliable Services, the BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="cea63-236">API восстановления выдаст исключение FabricException с соответствующим сообщением об ошибке при сбое проверки цепочки резервных копий.</span><span class="sxs-lookup"><span data-stu-id="cea63-236">The restore API will throw FabricException with appropriate error message if the backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="cea63-237">`KvsActorStateProvider` в настоящее время пропускает параметр RestorePolicy.Safe.</span><span class="sxs-lookup"><span data-stu-id="cea63-237">`KvsActorStateProvider` currently ignores the option RestorePolicy.Safe.</span></span> <span data-ttu-id="cea63-238">В следующих выпусках планируется поддержка этой функции.</span><span class="sxs-lookup"><span data-stu-id="cea63-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="cea63-239">Проверка резервного копирования и восстановления</span><span class="sxs-lookup"><span data-stu-id="cea63-239">Testing Backup and Restore</span></span>
<span data-ttu-id="cea63-240">Важно убедиться, что для критически важных данных создается резервная копия и их можно восстановить.</span><span class="sxs-lookup"><span data-stu-id="cea63-240">It is important to ensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="cea63-241">Это можно сделать, вызвав командлет `Start-ServiceFabricPartitionDataLoss` в PowerShell, что может стать причиной потери данных в определенной секции, чтобы проверить работоспособность архивации и восстановления данных для вашей службы.</span><span class="sxs-lookup"><span data-stu-id="cea63-241">This can be done by invoking the `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition to test whether the data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="cea63-242">Можно также программно вызвать потерю данных и восстановить их из этого события.</span><span class="sxs-lookup"><span data-stu-id="cea63-242">It is also possible to programmatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="cea63-243">Пример реализации функций архивации и восстановления можно найти в эталонном веб-приложении на сайте GitHub.</span><span class="sxs-lookup"><span data-stu-id="cea63-243">You can find a sample implementation of backup and restore functionality in the Web Reference App on GitHub.</span></span> <span data-ttu-id="cea63-244">Подробные сведения см. в описании службы `Inventory.Service`.</span><span class="sxs-lookup"><span data-stu-id="cea63-244">Please look at the `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-the-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="cea63-245">Дополнительные сведения о резервном копировании и восстановлении</span><span class="sxs-lookup"><span data-stu-id="cea63-245">Under the hood: more details on backup and restore</span></span>
<span data-ttu-id="cea63-246">Далее представлены дополнительные сведения о резервном копировании и восстановлении.</span><span class="sxs-lookup"><span data-stu-id="cea63-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="cea63-247">Архивация</span><span class="sxs-lookup"><span data-stu-id="cea63-247">Backup</span></span>
<span data-ttu-id="cea63-248">Диспетчер надежных состояний позволяет создавать согласованные резервные копии без блокировки операций чтения и записи.</span><span class="sxs-lookup"><span data-stu-id="cea63-248">The Reliable State Manager provides the ability to create consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="cea63-249">Для этого используется механизм сохранения контрольных точек и журналов.</span><span class="sxs-lookup"><span data-stu-id="cea63-249">To do so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="cea63-250">Диспетчер надежных состояний создает нечеткие (упрощенные) контрольные точки в определенных точках, чтобы уменьшить нагрузку на журнал транзакций и сократить время восстановления.</span><span class="sxs-lookup"><span data-stu-id="cea63-250">The Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points to relieve pressure from the transactional log and improve recovery times.</span></span>  <span data-ttu-id="cea63-251">При вызове метода `BackupAsync` диспетчер надежных состояний дает всем надежным объектам команду копировать их последние файлы контрольных точек в локальную папку резервных копий.</span><span class="sxs-lookup"><span data-stu-id="cea63-251">When `BackupAsync` is called, the Reliable State Manager instructs all Reliable objects to copy their latest checkpoint files to a local backup folder.</span></span>  <span data-ttu-id="cea63-252">Затем он копирует в папку резервного копирования все записи журнала — от «отправной точки» до последней записи в журнале.</span><span class="sxs-lookup"><span data-stu-id="cea63-252">Then, the Reliable State Manager copies all log records, starting from the "start pointer" to the latest log record into the backup folder.</span></span>  <span data-ttu-id="cea63-253">Так как все записи журнала включаются в резервную копию и диспетчер надежных состояний сохраняет упреждающие записи журнала, все зафиксированные транзакции (которые успешно вернул `CommitAsync`) будут сохранены при архивации.</span><span class="sxs-lookup"><span data-stu-id="cea63-253">Since all the log records up to the latest log record are included in the backup and the Reliable State Manager preserves write-ahead logging, the Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in the backup.</span></span>

<span data-ttu-id="cea63-254">Любая транзакция, зафиксированная после вызова метода `BackupAsync`, может быть не включена в резервную копию.</span><span class="sxs-lookup"><span data-stu-id="cea63-254">Any transaction that commits after `BackupAsync` has been called may or may not be in the backup.</span></span>  <span data-ttu-id="cea63-255">После заполнения локальной папки резервного копирования с помощью платформы (то есть среда выполнения завершает локальное резервное копирование) осуществляется обратный вызов службы резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="cea63-255">Once the local backup folder has been populated by the platform (i.e., local backup is completed by the runtime), the service's backup callback is invoked.</span></span>  <span data-ttu-id="cea63-256">Этот обратный вызов отвечает за перемещение папки резервного копирования во внешнее расположение, например службу хранилища Azure.</span><span class="sxs-lookup"><span data-stu-id="cea63-256">This callback is responsible for moving the backup folder to an external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="cea63-257">восстановление;</span><span class="sxs-lookup"><span data-stu-id="cea63-257">Restore</span></span>
<span data-ttu-id="cea63-258">Диспетчер надежных состояний позволяет выполнять восстановление из резервной копии с помощью интерфейса API `RestoreAsync`.</span><span class="sxs-lookup"><span data-stu-id="cea63-258">The Reliable State Manager provides the ability to restore from a backup by using the `RestoreAsync` API.</span></span>  
<span data-ttu-id="cea63-259">Метод `RestoreAsync` в `RestoreContext` можно вызвать только внутри метода `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="cea63-259">The `RestoreAsync` method on `RestoreContext` can be called only inside the `OnDataLossAsync` method.</span></span>
<span data-ttu-id="cea63-260">Возвращенное методом `OnDataLossAsync` логическое значение указывает, удалось ли восстановить состояние службы из внешнего источника.</span><span class="sxs-lookup"><span data-stu-id="cea63-260">The bool returned by `OnDataLossAsync` indicates whether the service restored its state from an external source.</span></span>
<span data-ttu-id="cea63-261">Если метод `OnDataLossAsync` возвращает значение true, то Service Fabric повторит сборку всех других реплик из этой первичной реплики.</span><span class="sxs-lookup"><span data-stu-id="cea63-261">If the `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="cea63-262">Service Fabric гарантирует, что реплики, которые получат вызов `OnDataLossAsync`, сначала получат роль первичных, но им не будет присвоено состояние чтения или записи.</span><span class="sxs-lookup"><span data-stu-id="cea63-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition to the primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="cea63-263">Это означает, что для исполнителей StatefulService метод `RunAsync` будет вызван только после успешного завершения метода `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="cea63-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="cea63-264">Затем метод `OnDataLossAsync` будет вызван для новой первичной реплики.</span><span class="sxs-lookup"><span data-stu-id="cea63-264">Then, `OnDataLossAsync` will be invoked on the new primary.</span></span>
<span data-ttu-id="cea63-265">Интерфейс API будет постоянно вызываться, пока служба успешно не завершит его (возвратив значение "true" или "false").</span><span class="sxs-lookup"><span data-stu-id="cea63-265">Until a service completes this API successfully (by returning true or false) and finishes the relevant reconfiguration, the API will keep being called one at a time.</span></span>

<span data-ttu-id="cea63-266">`RestoreAsync` сначала удаляет все имеющиеся состояния в первичной реплике, для которой он вызван.</span><span class="sxs-lookup"><span data-stu-id="cea63-266">`RestoreAsync` first drops all existing state in the primary replica that it was called on.</span></span>  
<span data-ttu-id="cea63-267">После этого диспетчер надежных состояний создает все надежные объекты, существующие в папке резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="cea63-267">Then the Reliable State Manager creates all the Reliable objects that exist in the backup folder.</span></span>  
<span data-ttu-id="cea63-268">Затем все надежные объекты получают команду выполнить восстановление из контрольных точек в папке резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="cea63-268">Next, the Reliable objects are instructed to restore from their checkpoints in the backup folder.</span></span>  
<span data-ttu-id="cea63-269">Наконец, диспетчер надежных состояний восстанавливает собственное состояние из записей журнала в папке резервного копирования и выполняет восстановление.</span><span class="sxs-lookup"><span data-stu-id="cea63-269">Finally, the Reliable State Manager recovers its own state from the log records in the backup folder and performs recovery.</span></span>  
<span data-ttu-id="cea63-270">В рамках процесса восстановления операции, начиная с «отправной точки», записи журнала которых сохранены в папке резервного копирования, воспроизводятся в надежных объектах.</span><span class="sxs-lookup"><span data-stu-id="cea63-270">As part of the recovery process, operations starting from the "starting point" that have commit log records in the backup folder are replayed to the Reliable objects.</span></span>  
<span data-ttu-id="cea63-271">Этот шаг обеспечивает согласованность восстановленного состояния.</span><span class="sxs-lookup"><span data-stu-id="cea63-271">This step ensures that the recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="cea63-272">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="cea63-272">Next steps</span></span>
  - [<span data-ttu-id="cea63-273">Reliable Collections</span><span class="sxs-lookup"><span data-stu-id="cea63-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="cea63-274">Краткое руководство по надежным службам Reliable Services</span><span class="sxs-lookup"><span data-stu-id="cea63-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="cea63-275">Уведомления Reliable Services</span><span class="sxs-lookup"><span data-stu-id="cea63-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="cea63-276">Конфигурация Reliable Services</span><span class="sxs-lookup"><span data-stu-id="cea63-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="cea63-277">Справочник разработчика по надежным коллекциям</span><span class="sxs-lookup"><span data-stu-id="cea63-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)


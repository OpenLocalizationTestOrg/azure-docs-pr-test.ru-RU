---
title: "aaaUser определенные маршруты и IP-пересылки в Azure | Документы Microsoft"
description: "Узнайте, как определяемые пользователем маршруты tooconfigure (UDR) и IP-пересылка tooforward трафика toonetwork виртуальных устройств в Azure."
services: virtual-network
documentationcenter: na
author: jimdial
manager: timlt
editor: tysonn
ms.assetid: c39076c4-11b7-4b46-a904-817503c4b486
ms.service: virtual-network
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/15/2016
ms.author: jdial
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: f1f1d46166d5a7c776f472b7ade1354d943ece10
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="user-defined-routes-and-ip-forwarding"></a>Определяемые пользователем маршруты и IP-пересылка

При добавлении виртуальных машин (ВМ) tooa виртуальной сети (VNet) в Azure, вы заметите hello виртуальные машины, может toocommunicate друг с другом по сети hello автоматически. Необязательно toospecify шлюз, даже если hello виртуальные машины находятся в разных подсетях. Hello то же верно для обмена данными между toohello ВМ hello общедоступный Интернет и даже tooyour в локальной сети, когда владельцем гибридного подключения из Azure tooyour присутствует центра обработки данных.

Этот поток сообщений возможна, так как Azure предлагает ряд toodefine маршруты системы, как IP-трафик проходит. Маршруты системы управления hello поток сообщений в hello следующие сценарии:

* Изнутри hello одной подсети.
* Из tooanother подсети в виртуальной сети.
* Из виртуальных машин toohello Интернета.
* Из tooanother виртуальная сеть виртуальной сети через VPN-шлюза.
* Из виртуальной сети tooanother виртуальной сети через виртуальную сеть Пиринга (привязка службы).
* Из локальной сети tooyour виртуальной сети через VPN-шлюза.

Hello ниже рисунке простая настройка виртуальной сети, две подсети и несколько виртуальных машин, а также hello системы маршруты, позволяющие tooflow трафика IP.

![Системные маршруты в Azure](./media/virtual-networks-udr-overview/Figure1.png)

Несмотря на то, что использование hello маршруты системы упрощает трафика автоматически для развертывания, существуют случаи, в которых требуется toocontrol hello маршрутизацию пакетов с помощью виртуального устройства. Таким образом, создав определяемые пользователем маршруты, указываются hello следующего прыжка для пакетов, вместо передачи tooa конкретной подсети toogo tooyour виртуальное устройство и включение IP пересылки для hello виртуальная машина, работающая как виртуальное устройство hello.

Hello на рисунке ниже показан пример определяемые пользователем маршруты и IP-пересылки пакетов tooforce отправленных tooone подсети из другой toogo виртуального устройства в третьем подсети.

![Системные маршруты в Azure](./media/virtual-networks-udr-overview/Figure2.png)

> [!IMPORTANT]
> Определяемые пользователем маршруты не применен tootraffic, оставляя подсеть из любой ресурс (например, сетевые интерфейсы вложенных tooVMs) в подсети hello. Не удается создать маршруты toospecify как трафик вводит подсеть из Интернета, hello для экземпляра. устройство Hello, пересылке трафика toocannot находиться в hello происхождения трафика hello одной подсети. Всегда создавайте отдельную подсеть для устройств. 
> 
> 

## <a name="route-resource"></a>Маршрутизация ресурсов
Пакеты направляются через сеть TCP/IP, исходя из таблицы маршрутизации, определенные в каждом узле hello физической сети. Таблицы маршрутов — коллекция отдельных маршрутов используемых toodecide, где tooforward пакетов на основе hello конечный IP-адрес. Маршрут состоит из следующих hello.

| Свойство | Описание | Ограничения | Рекомендации |
| --- | --- | --- | --- |
| Префикс адреса |применяется Hello целевой CIDR toowhich hello маршрут, например 10.1.0.0/16. |Должен быть допустимый CIDR диапазон, представляющий адресов hello общедоступный Интернет, виртуальная сеть Azure или на локальном центре обработки данных. |Убедитесь, что hello **префикс адреса** не содержит адрес hello для hello **адрес следующего прыжка**, в противном случае будет ввести пакеты в цикле, поступающих из следующего прыжка hello источника toohello без попадание Назначение Hello. |
| Тип следующего прыжка |Тип Hello Azure прыжка hello пакета должны отправляться. |Должен быть hello следующие значения: <br/> **Виртуальная сеть**. Представляет hello локальной виртуальной сети. Для экземпляра, если имеются две подсети 10.1.0.0/16 и 10.2.0.0/16 в Здравствуйте одной виртуальной сети, hello маршрута для каждой подсети в таблице маршрутов hello будет иметь значение следующего прыжка *виртуальной сети*. <br/> **Шлюз виртуальной сети**. Представляет шлюз VPN типа «сеть-сеть» Azure. <br/> **Интернет**. Представляет шлюз Интернета по умолчанию hello, предоставляемые hello инфраструктуры Azure. <br/> **Виртуальное устройство**. Представляет виртуальное устройство, вы добавили tooyour виртуальной сети Azure. <br/> **None**. Представляет «черную дыру». Пакеты, отправляемые tooa черная дыра вообще не будут перенаправляться. |Рассмотрите возможность использования **виртуальное устройство** toodirect трафика tooa виртуальной Машины или подсистемы балансировки нагрузки Azure внутренний IP-адрес.  Этот тип позволяет задавать hello IP-адреса, как описано ниже. Рассмотрите возможность использования **нет** toostop пакеты из потоковые tooa в заданный конечный тип. |
| Адрес следующего прыжка |адрес следующего прыжка Hello содержит hello IP-адрес, который следует переадресовать пакеты. Значения следующего прыжка разрешены только в маршрутах, где тип следующего прыжка hello *виртуальное устройство*. |Должен быть IP-адрес, доступная в виртуальной сети, где применяется hello пользователем маршрута, минуя hello **шлюза виртуальной сети**. Hello IP-адрес имеет toobe на одной виртуальной сети, где он применяется hello, peered виртуальной сети. |Если IP-адрес hello представляет виртуальную Машину, убедитесь, что включен [IP-пересылки](#IP-forwarding) в Azure для hello виртуальной Машины. Hello представляет hello внутренний IP-адрес подсистемы балансировки нагрузки Azure, убедитесь, что у вас есть соответствующие правила для каждого порта с балансировкой нагрузки следует tooload баланс.|

В Azure PowerShell, некоторые значения «NextHopType» hello имеют различные имена:

* "Виртуальная сеть" — VnetLocal,
* "Шлюз виртуальной сети" — VirtualNetworkGateway,
* "Виртуальное устройство" — VirtualAppliance,
* "Интернет" — Internet,
* None (Нет) — None.

### <a name="system-routes"></a>Системные маршруты
Каждой подсети в виртуальной сети, автоматически связывается с маршрута таблицу, содержащую hello маршрута правилам системы:

* **Локальное правило виртуальной сети**: это правило создается автоматически для каждой подсети в виртуальной сети. Указывает, что имеется прямая связь между виртуальными машинами hello в hello виртуальной сети и не промежуточного следующего прыжка.
* **Локальные правила**: это правило применяется tooall трафика, предназначенного toohello локальных адресов и использует VPN-шлюза в качестве следующего прыжка назначения hello.
* **Правило IIS**: это правило обрабатывает все toohello трафика, предназначенного общедоступный Интернет (0.0.0.0/0 префикс адреса) и использует инфраструктуру hello Интернет-шлюзу как hello следующего прыжка для всех toohello трафика, предназначенного Интернета.

### <a name="user-defined-routes"></a>Определяемые пользователем маршруты
Для большинства сред потребуется только маршруты системы hello уже определен в Azure. Тем не менее могут требуется toocreate таблицы маршрутов и добавьте один или несколько маршрутов в определенных случаях, например:

* Принудительное туннелирование toohello Интернета по локальной сети.
* Использование виртуальных устройств в среде Azure.

В выше сценариев hello будет иметь toocreate таблицы маршрутов и добавьте tooit определяемых пользователем маршрутов. Может иметь несколько таблиц маршрутов и hello же таблица маршрутов может быть связан tooone или другие подсети. И в каждой подсети можно только таблицы связанного tooa один маршрут. Все виртуальные машины и облачные службы в подсети использовать hello маршрута связанные таблицы toothat подсеть.

Подсети используют маршруты системы до подсети toohello связанные таблицы маршрутов. После того, как эта связь установлена, маршрутизация выполняется по совпадению наиболее длинного префикса (LPM) среди определяемых пользователем маршрутов и системных маршрутов. Если имеется несколько маршрутов с hello же LPM соответствует выбираться маршрут в зависимости от ее источника в hello последовательностью:

1. определяемый пользователем маршрут;
2. маршрут BGP (если используется ExpressRoute);
3. Системные маршруты

toolearn toocreate пользователем маршруты, в статье [как tooCreate направляет и включить IP-пересылки в Azure](virtual-network-create-udr-arm-template.md).

> [!IMPORTANT]
> Определяемые пользователем маршруты являются только примененных tooAzure виртуальных машин и облачных служб. Для экземпляра Если требуется tooadd виртуального устройства брандмауэра между локальной сетью и Azure, имеется toocreate определяемых пользователем маршрут для таблиц Azure маршрутизации, пересылающий весь трафик, идущий toohello пространства адресов локальной toohello виртуального устройство. Можно также добавить является определяемым пользователем весь трафик из локальной tooAzure tooforward GatewaySubnet toohello маршрута (UDR) через hello виртуального устройства. Такая возможность появился только недавно.
> 
> 

### <a name="bgp-routes"></a>Маршруты BGP
При наличии подключения ExpressRoute между локальной сетью и Azure, можно включить BGP toopropagate маршруты из вашей локальной сети tooAzure. Эти маршруты BGP используются в hello так же, как система маршруты и пользователь определенных маршрутов в каждой подсети в Azure. Дополнительную информацию см. во [введении в ExpressRoute](../expressroute/expressroute-introduction.md).

> [!IMPORTANT]
> Можно настроить принудительного toouse вашей среды Azure, туннелирования с помощью локальной сети, создав пользовательские маршрут для подсети 0.0.0.0/0, использующий hello VPN-шлюза в качестве следующего прыжка hello. Тем не менее, это работает только при использовании шлюза VPN, не ExpressRoute. Для ExpressRoute принудительное туннелирование настраивается с помощью BGP.
> 
> 

## <a name="ip-forwarding"></a>IP-пересылка
Как описано выше, в один из основных причин toocreate hello маршрут определенные пользователем — tooforward трафика tooa виртуального устройства. Виртуальное устройство — это ничто иное виртуальной Машины, которая запускает приложение, toohandle сетевой трафик определенным образом, например брандмауэром или устройством NAT.

Это виртуальное устройство виртуальной Машины, необходимо будет tooreceive входящий трафик, не рассматриваются tooitself. tooallow tooreceive трафика виртуальных Машин внимания tooother назначения, необходимо включить IP-пересылку для hello виртуальной Машины. Это политика, не соответствует hello гостевой ОС Azure.

## <a name="next-steps"></a>Дальнейшие действия
* Узнайте, каким образом слишком[создайте маршруты в модели развертывания диспетчера ресурсов hello](virtual-network-create-udr-arm-template.md) и связать их toosubnets. 
* Узнайте, каким образом слишком[создайте маршруты в hello классической модели развертывания](virtual-network-create-udr-classic-ps.md) и связать их toosubnets.


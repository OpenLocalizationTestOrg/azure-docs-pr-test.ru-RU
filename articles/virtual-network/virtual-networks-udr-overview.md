---
title: "Определяемые пользователем маршруты и IP-пересылка в Azure | Документация Майкрософт"
description: "Узнайте, как настроить определяемые пользователем маршруты и IP-пересылку для перенаправления трафика на сетевые виртуальные устройства в Azure."
services: virtual-network
documentationcenter: na
author: jimdial
manager: timlt
editor: tysonn
ms.assetid: c39076c4-11b7-4b46-a904-817503c4b486
ms.service: virtual-network
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/15/2016
ms.author: jdial
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 6274e0101f6fb0864c8d1efaef7fcde78b8760c3
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="user-defined-routes-and-ip-forwarding"></a><span data-ttu-id="f6a3e-103">Определяемые пользователем маршруты и IP-пересылка</span><span class="sxs-lookup"><span data-stu-id="f6a3e-103">User-defined routes and IP forwarding</span></span>

<span data-ttu-id="f6a3e-104">При добавлении виртуальных машин в виртуальной сети (VNet) в Azure можно заметить, что они могут автоматически связываться между собой по сети.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-104">When you add virtual machines (VMs) to a virtual network (VNet) in Azure, you will notice that the VMs are able to communicate with each other over the network, automatically.</span></span> <span data-ttu-id="f6a3e-105">Несмотря на то что виртуальные машины находятся в разных подсетях, не нужно указывать шлюз.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-105">You do not need to specify a gateway, even though the VMs are in different subnets.</span></span> <span data-ttu-id="f6a3e-106">Это также относится к общедоступному подключению виртуальных машин через Интернет и даже по локальной сети при наличии гибридного подключения Azure к вашему центру обработки данных.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-106">The same is true for communication from the VMs to the public Internet, and even to your on-premises network when a hybrid connection from Azure to your own datacenter is present.</span></span>

<span data-ttu-id="f6a3e-107">Этот обмен данными возможен, так как Azure использует ряд системных маршрутов для определения передачи IP-трафика.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-107">This flow of communication is possible because Azure uses a series of system routes to define how IP traffic flows.</span></span> <span data-ttu-id="f6a3e-108">Системные маршруты управляют обменом данных в следующих случаях:</span><span class="sxs-lookup"><span data-stu-id="f6a3e-108">System routes control the flow of communication in the following scenarios:</span></span>

* <span data-ttu-id="f6a3e-109">в одной и той же подсети;</span><span class="sxs-lookup"><span data-stu-id="f6a3e-109">From within the same subnet.</span></span>
* <span data-ttu-id="f6a3e-110">из одной подсети в другую в виртуальной сети;</span><span class="sxs-lookup"><span data-stu-id="f6a3e-110">From a subnet to another within a VNet.</span></span>
* <span data-ttu-id="f6a3e-111">из виртуальных машин в Интернет;</span><span class="sxs-lookup"><span data-stu-id="f6a3e-111">From VMs to the Internet.</span></span>
* <span data-ttu-id="f6a3e-112">из одной виртуальной сети в другую через VPN-шлюз;</span><span class="sxs-lookup"><span data-stu-id="f6a3e-112">From a VNet to another VNet through a VPN gateway.</span></span>
* <span data-ttu-id="f6a3e-113">Из одной виртуальной сети в другую через пиринговую связь (цепочка служб);</span><span class="sxs-lookup"><span data-stu-id="f6a3e-113">From a VNet to another VNet through VNet Peering (Service Chaining).</span></span>
* <span data-ttu-id="f6a3e-114">из виртуальной сети в локальную сеть через VPN-шлюз.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-114">From a VNet to your on-premises network through a VPN gateway.</span></span>

<span data-ttu-id="f6a3e-115">На рисунке ниже показана простая система, состоящая из виртуальной сети, двух подсетей и нескольких виртуальных машин, а также системных маршрутов для передачи IP-трафика.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-115">The figure below shows a simple setup with a VNet, two subnets, and a few VMs, along with the system routes that allow IP traffic to flow.</span></span>

![Системные маршруты в Azure](./media/virtual-networks-udr-overview/Figure1.png)

<span data-ttu-id="f6a3e-117">Несмотря на то что при использовании системных маршрутов трафик для развертывания передается автоматически, существуют случаи, когда требуется управлять маршрутизацией пакетов через виртуальное устройство.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-117">Although the use of system routes facilitates traffic automatically for your deployment, there are cases in which you want to control the routing of packets through a virtual appliance.</span></span> <span data-ttu-id="f6a3e-118">Для этого нужно создать определяемые пользователем маршруты, которые указывают, чтобы при следующем прыжке пакеты, передаваемые в конкретную подсеть, передавались в виртуальное устройство, и включить IP-пересылку для виртуальной машины, работающей в качестве виртуального устройства.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-118">You can do so by creating user defined routes that specify the next hop for packets flowing to a specific subnet to go to your virtual appliance instead, and enabling IP forwarding for the VM running as the virtual appliance.</span></span>

<span data-ttu-id="f6a3e-119">На следующем рисунке показан пример определяемых пользователем маршрутов и IP-пересылки для принудительной отправки пакетов, передаваемых из одной подсети во вторую подсеть, в виртуальным модуль в третьей подсети.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-119">The figure below shows an example of user defined routes and IP forwarding to force packets sent to one subnet from another to go through a virtual appliance on a third subnet.</span></span>

![Системные маршруты в Azure](./media/virtual-networks-udr-overview/Figure2.png)

> [!IMPORTANT]
> <span data-ttu-id="f6a3e-121">Определяемые пользователем маршруты применяются к трафику, исходящему из подсети от любого ресурса (включая сетевые интерфейсы, подключенные к виртуальным машинам) в подсети.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-121">User-defined routes are applied to traffic leaving a subnet from any resource (such as network interfaces attached to VMs) in the subnet.</span></span> <span data-ttu-id="f6a3e-122">Например, нельзя создавать маршруты для определения того, как трафик поступает в подсеть из Интернета.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-122">You cannot create routes to specify how traffic enters a subnet from the Internet, for instance.</span></span> <span data-ttu-id="f6a3e-123">Кроме того, устройство, на которое вы пересылаете трафик, не может находиться в подсети, из которой поступает трафик.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-123">The appliance you are forwarding traffic to cannot be in the same subnet where the traffic originates.</span></span> <span data-ttu-id="f6a3e-124">Всегда создавайте отдельную подсеть для устройств.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-124">Always create a separate subnet for your appliances.</span></span> 
> 
> 

## <a name="route-resource"></a><span data-ttu-id="f6a3e-125">Маршрутизация ресурсов</span><span class="sxs-lookup"><span data-stu-id="f6a3e-125">Route resource</span></span>
<span data-ttu-id="f6a3e-126">Пакеты маршрутизируются по сети TCP/IP на основе таблицы маршрутов, определенной на каждом узле физической сети.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-126">Packets are routed over a TCP/IP network based on a route table defined at each node on the physical network.</span></span> <span data-ttu-id="f6a3e-127">Таблица маршрутов — набор отдельных маршрутов, с помощью которой определяется, куда пересылать пакеты по IP-адресу назначения.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-127">A route table is a collection of individual routes used to decide where to forward packets based on the destination IP address.</span></span> <span data-ttu-id="f6a3e-128">Маршрут состоит из следующих частей:</span><span class="sxs-lookup"><span data-stu-id="f6a3e-128">A route consists of the following:</span></span>

| <span data-ttu-id="f6a3e-129">Свойство</span><span class="sxs-lookup"><span data-stu-id="f6a3e-129">Property</span></span> | <span data-ttu-id="f6a3e-130">Описание</span><span class="sxs-lookup"><span data-stu-id="f6a3e-130">Description</span></span> | <span data-ttu-id="f6a3e-131">Ограничения</span><span class="sxs-lookup"><span data-stu-id="f6a3e-131">Constraints</span></span> | <span data-ttu-id="f6a3e-132">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="f6a3e-132">Considerations</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="f6a3e-133">Префикс адреса</span><span class="sxs-lookup"><span data-stu-id="f6a3e-133">Address Prefix</span></span> |<span data-ttu-id="f6a3e-134">Маршрутизация CIDR назначения, к которой относится маршрут, например 10.1.0.0/16.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-134">The destination CIDR to which the route applies, such as 10.1.0.0/16.</span></span> |<span data-ttu-id="f6a3e-135">Должен быть допустимым диапазоном CIDR, представляющим адреса в Интернете, виртуальной сети Azure или локальном центре данных.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-135">Must be a valid CIDR range representing addresses on the public Internet, Azure virtual network, or on-premises datacenter.</span></span> |<span data-ttu-id="f6a3e-136">Убедитесь, что в параметре **Префикс адреса** не содержится адрес для параметра **Адрес следующего прыжка**, иначе пакеты войдут в цикл: они будут переходить от источника к следующему прыжку, не попадая в место назначения.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-136">Make sure the **Address prefix** does not contain the address for the **Next hop address**, otherwise your packets will enter in a loop going from the source to the next hop without ever reaching the destination.</span></span> |
| <span data-ttu-id="f6a3e-137">Тип следующего прыжка</span><span class="sxs-lookup"><span data-stu-id="f6a3e-137">Next hop type</span></span> |<span data-ttu-id="f6a3e-138">Тип прыжка Azure, куда должны отправляться пакеты.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-138">The type of Azure hop the packet should be sent to.</span></span> |<span data-ttu-id="f6a3e-139">Необходимо установить одно из следующих значений.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-139">Must be one of the following values:</span></span> <br/> <span data-ttu-id="f6a3e-140">**Виртуальная сеть**.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-140">**Virtual Network**.</span></span> <span data-ttu-id="f6a3e-141">Представляет локальную виртуальную сеть.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-141">Represents the local virtual network.</span></span> <span data-ttu-id="f6a3e-142">Например, при наличии двух подсетей (10.1.0.0/16 и 10.2.0.0/16) в одной и той же виртуальной сети у следующего прыжка маршрута для каждой подсети в таблице маршрутов будет значение *Виртуальная сеть*.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-142">For instance, if you have two subnets, 10.1.0.0/16 and 10.2.0.0/16 in the same virtual network, the route for each subnet in the route table will have a next hop value of *Virtual Network*.</span></span> <br/> <span data-ttu-id="f6a3e-143">**Шлюз виртуальной сети**.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-143">**Virtual Network Gateway**.</span></span> <span data-ttu-id="f6a3e-144">Представляет шлюз VPN типа «сеть-сеть» Azure.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-144">Represents an Azure S2S VPN Gateway.</span></span> <br/> <span data-ttu-id="f6a3e-145">**Интернет**.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-145">**Internet**.</span></span> <span data-ttu-id="f6a3e-146">Представляет используемый по умолчанию шлюз Интернета, предоставленный инфраструктурой Azure.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-146">Represents the default Internet gateway provided by the Azure Infrastructure.</span></span> <br/> <span data-ttu-id="f6a3e-147">**Виртуальное устройство**.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-147">**Virtual Appliance**.</span></span> <span data-ttu-id="f6a3e-148">Представляет виртуальное устройство, добавленное в виртуальную сеть Azure.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-148">Represents a virtual appliance you added to your Azure virtual network.</span></span> <br/> <span data-ttu-id="f6a3e-149">**None**.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-149">**None**.</span></span> <span data-ttu-id="f6a3e-150">Представляет «черную дыру».</span><span class="sxs-lookup"><span data-stu-id="f6a3e-150">Represents a black hole.</span></span> <span data-ttu-id="f6a3e-151">Пакеты, пересылаемые в «черную дыру», вообще никуда не пересылаются.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-151">Packets forwarded to a black hole will not be forwarded at all.</span></span> |<span data-ttu-id="f6a3e-152">Рассмотрите возможность использования **виртуального устройства** для перенаправления трафика на IP-адрес виртуальной машины или внутренний IP-адрес Azure Load Balancer.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-152">Consider using **Virtual Appliance** to direct traffic to a VM or Azure Load Balancer internal IP address.</span></span>  <span data-ttu-id="f6a3e-153">Этот тип позволяет задать IP-адрес, как описано ниже.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-153">This type allows the specification of an IP address as described below.</span></span> <span data-ttu-id="f6a3e-154">Вы можете использовать тип **None** (Нет), чтобы остановить поток пакетов в заданное место назначения.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-154">Consider using a **None** type to stop packets from flowing to a given destination.</span></span> |
| <span data-ttu-id="f6a3e-155">Адрес следующего прыжка</span><span class="sxs-lookup"><span data-stu-id="f6a3e-155">Next hop address</span></span> |<span data-ttu-id="f6a3e-156">Параметр адреса следующего прыжка содержит IP-адрес, на который должны быть переадресованы пакеты.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-156">The next hop address contains the IP address packets should be forwarded to.</span></span> <span data-ttu-id="f6a3e-157">Значения следующего прыжка допускаются только в маршрутах, где следующий тип перехода — *Виртуальное устройство*.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-157">Next hop values are only allowed in routes where the next hop type is *Virtual Appliance*.</span></span> |<span data-ttu-id="f6a3e-158">IP-адрес должен быть доступен в виртуальной сети, где применяется определяемый пользователем маршрут без прохождения через **шлюз виртуальной сети**.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-158">Must be an IP address that is reachable within the Virtual Network where the User Defined Route is applied, without going through a **Virtual Network Gateway**.</span></span> <span data-ttu-id="f6a3e-159">IP-адрес должен быть в той же виртуальной сети, где он применяется, или в пиринговой виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-159">The IP address has to be on the same Virtual Network where it is applied, or on a peered Virtual Network.</span></span> |<span data-ttu-id="f6a3e-160">Если IP-адрес представляет виртуальную машину, не забудьте включить [IP-пересылку](#IP-forwarding) в Azure для виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-160">If the IP address represents a VM, make sure you enable [IP forwarding](#IP-forwarding) in Azure for the VM.</span></span> <span data-ttu-id="f6a3e-161">Если IP-адрес представляет собой внутренний IP-адрес Azure Load Balancer, убедитесь, что настроено соответствующее правило балансировки нагрузки для каждого порта, для которого требуется балансировать нагрузку.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-161">If the IP address represents the internal IP address of Azure Load Balancer, make sure you have a matching load balancing rule for each port you wish to load balance.</span></span>|

<span data-ttu-id="f6a3e-162">В Azure PowerShell некоторые значения NextHopType называются по-другому:</span><span class="sxs-lookup"><span data-stu-id="f6a3e-162">In Azure PowerShell some of the "NextHopType" values have different names:</span></span>

* <span data-ttu-id="f6a3e-163">"Виртуальная сеть" — VnetLocal,</span><span class="sxs-lookup"><span data-stu-id="f6a3e-163">Virtual Network is VnetLocal</span></span>
* <span data-ttu-id="f6a3e-164">"Шлюз виртуальной сети" — VirtualNetworkGateway,</span><span class="sxs-lookup"><span data-stu-id="f6a3e-164">Virtual Network Gateway is VirtualNetworkGateway</span></span>
* <span data-ttu-id="f6a3e-165">"Виртуальное устройство" — VirtualAppliance,</span><span class="sxs-lookup"><span data-stu-id="f6a3e-165">Virtual Appliance is VirtualAppliance</span></span>
* <span data-ttu-id="f6a3e-166">"Интернет" — Internet,</span><span class="sxs-lookup"><span data-stu-id="f6a3e-166">Internet is Internet</span></span>
* <span data-ttu-id="f6a3e-167">None (Нет) — None.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-167">None is None</span></span>

### <a name="system-routes"></a><span data-ttu-id="f6a3e-168">Системные маршруты</span><span class="sxs-lookup"><span data-stu-id="f6a3e-168">System routes</span></span>
<span data-ttu-id="f6a3e-169">Каждая подсеть, созданная в виртуальной сети, автоматически связывается с таблицей маршрутов, которая содержит следующие правила для системных маршрутов:</span><span class="sxs-lookup"><span data-stu-id="f6a3e-169">Every subnet created in a virtual network is automatically associated with a route table that contains the following system route rules:</span></span>

* <span data-ttu-id="f6a3e-170">**Локальное правило виртуальной сети**: это правило создается автоматически для каждой подсети в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-170">**Local Vnet Rule**: This rule is automatically created for every subnet in a virtual network.</span></span> <span data-ttu-id="f6a3e-171">Оно указывает, что существует прямая связь между виртуальными машинами в виртуальной сети, без промежуточного следующего прыжка.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-171">It specifies that there is a direct link between the VMs in the VNet and there is no intermediate next hop.</span></span>
* <span data-ttu-id="f6a3e-172">**Правило локальной среды**: это правило применяется для всего трафика, предназначенного для локального диапазона адресов; оно использует VPN-шлюз в качестве назначения следующего прыжка.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-172">**On-premises Rule**: This rule applies to all traffic destined to the on-premises address range and uses VPN gateway as the next hop destination.</span></span>
* <span data-ttu-id="f6a3e-173">**Правило Интернета**: это правило обрабатывает весь трафик, направляемый в общедоступный Интернет (префикс адреса 0.0.0.0/0). Оно использует шлюз Интернета инфраструктуры в качестве следующего прыжка для всего трафика, предназначенного для Интернета.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-173">**Internet Rule**: This rule handles all traffic destined to the public Internet (address prefix 0.0.0.0/0) and uses the infrastructure internet gateway as the next hop for all traffic destined to the Internet.</span></span>

### <a name="user-defined-routes"></a><span data-ttu-id="f6a3e-174">Определяемые пользователем маршруты</span><span class="sxs-lookup"><span data-stu-id="f6a3e-174">User-defined routes</span></span>
<span data-ttu-id="f6a3e-175">Для большинства сред достаточно только системных маршрутов, уже определенных в среде Azure.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-175">For most environments you will only need the system routes already defined by Azure.</span></span> <span data-ttu-id="f6a3e-176">Тем не менее, в конкретных случаях может потребоваться создать таблицу маршрутов и добавить один или несколько маршрутов, например:</span><span class="sxs-lookup"><span data-stu-id="f6a3e-176">However, you may need to create a route table and add one or more routes in specific cases, such as:</span></span>

* <span data-ttu-id="f6a3e-177">Принудительное туннелирование для доступа к Интернету через вашу локальную сеть.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-177">Force tunneling to the Internet via your on-premises network.</span></span>
* <span data-ttu-id="f6a3e-178">Использование виртуальных устройств в среде Azure.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-178">Use of virtual appliances in your Azure environment.</span></span>

<span data-ttu-id="f6a3e-179">В приведенном выше сценарии необходимо будет создать таблицу маршрутов и добавить в нее определяемые пользователем маршруты.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-179">In the scenarios above, you will have to create a route table and add user defined routes to it.</span></span> <span data-ttu-id="f6a3e-180">Можно использовать несколько таблиц маршрутов, и одна таблица маршрутов может быть связана с одной или несколькими подсетями.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-180">You can have multiple route tables, and the same route table can be associated to one or more subnets.</span></span> <span data-ttu-id="f6a3e-181">А каждая подсеть может быть связана только с одной таблицей маршрутов.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-181">And each subnet can only be associated to a single route table.</span></span> <span data-ttu-id="f6a3e-182">Все виртуальные машины и облачные службы в подсети используют таблицу маршрутов, связанную с этой подсетью.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-182">All VMs and cloud services in a subnet use the route table associated to that subnet.</span></span>

<span data-ttu-id="f6a3e-183">Пока c подсетью не связана таблица маршрутов, она использует системные маршруты.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-183">Subnets rely on system routes until a route table is associated to the subnet.</span></span> <span data-ttu-id="f6a3e-184">После того, как эта связь установлена, маршрутизация выполняется по совпадению наиболее длинного префикса (LPM) среди определяемых пользователем маршрутов и системных маршрутов.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-184">Once an association exists, routing is done based on Longest Prefix Match (LPM) among both user defined routes and system routes.</span></span> <span data-ttu-id="f6a3e-185">При наличии более одного маршрута с одинаковыми совпадающими значениями LPM маршрут выбирается по источнику в следующем порядке:</span><span class="sxs-lookup"><span data-stu-id="f6a3e-185">If there is more than one route with the same LPM match then a route is selected based on its origin in the following order:</span></span>

1. <span data-ttu-id="f6a3e-186">определяемый пользователем маршрут;</span><span class="sxs-lookup"><span data-stu-id="f6a3e-186">User defined route</span></span>
2. <span data-ttu-id="f6a3e-187">маршрут BGP (если используется ExpressRoute);</span><span class="sxs-lookup"><span data-stu-id="f6a3e-187">BGP route (when ExpressRoute is used)</span></span>
3. <span data-ttu-id="f6a3e-188">Системные маршруты</span><span class="sxs-lookup"><span data-stu-id="f6a3e-188">System route</span></span>

<span data-ttu-id="f6a3e-189">Информацию о создании определяемых пользователем маршрутов см. в статье [Как создавать маршруты и включать IP-пересылку в Azure](virtual-network-create-udr-arm-template.md).</span><span class="sxs-lookup"><span data-stu-id="f6a3e-189">To learn how to create user defined routes, see [How to Create Routes and Enable IP Forwarding in Azure](virtual-network-create-udr-arm-template.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="f6a3e-190">Определяемые пользователем маршруты применяются только для виртуальных машин и облачных служб Azure.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-190">User defined routes are only applied to Azure VMs and cloud services.</span></span> <span data-ttu-id="f6a3e-191">Например, если нужно добавить виртуальное устройство брандмауэра между локальной сетью и Azure, необходимо создать пользовательский маршрут для ваших таблиц маршрутов Azure, который будет перенаправлять на виртуальное устройство весь трафик, поступающий в локальное адресное пространство.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-191">For instance, if you want to add a firewall virtual appliance between your on-premises network and Azure, you will have to create a user defined route for your Azure route tables that forwards all traffic going to the on-premises address space to the virtual appliance.</span></span> <span data-ttu-id="f6a3e-192">Также можно добавить пользовательский маршрут для подсети GatewaySubnet, чтобы весь трафик через виртуальное устройство перенаправлялся из локального расположения в Azure.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-192">You can also add a user defined route (UDR) to the GatewaySubnet to forward all traffic from on-premises to Azure through the virtual appliance.</span></span> <span data-ttu-id="f6a3e-193">Такая возможность появился только недавно.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-193">This is a recent addition.</span></span>
> 
> 

### <a name="bgp-routes"></a><span data-ttu-id="f6a3e-194">Маршруты BGP</span><span class="sxs-lookup"><span data-stu-id="f6a3e-194">BGP routes</span></span>
<span data-ttu-id="f6a3e-195">При наличии подключения ExpressRoute между локальной сетью и Azure  можно включить BGP, чтобы распространить маршруты из локальной сети в Azure.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-195">If you have an ExpressRoute connection between your on-premises network and Azure, you can enable BGP to propagate routes from your on-premises network to Azure.</span></span> <span data-ttu-id="f6a3e-196">Эти маршруты BGP используются так же, как и системные маршруты и определенные пользователем маршруты в каждой подсети Azure.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-196">These BGP routes are used in the same way as system routes and user defined routes in each Azure subnet.</span></span> <span data-ttu-id="f6a3e-197">Дополнительную информацию см. во [введении в ExpressRoute](../expressroute/expressroute-introduction.md).</span><span class="sxs-lookup"><span data-stu-id="f6a3e-197">For more information see [ExpressRoute Introduction](../expressroute/expressroute-introduction.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="f6a3e-198">Вы можете настроить среду Azure для использования принудительного туннелирования через локальную сеть, создав определяемый пользователем маршрут для подсети 0.0.0.0/0, использующий в качестве следующего прыжка шлюз VPN.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-198">You can configure your Azure environment to use force tunneling through your on-premises network by creating a user defined route for subnet 0.0.0.0/0 that uses the VPN gateway as the next hop.</span></span> <span data-ttu-id="f6a3e-199">Тем не менее, это работает только при использовании шлюза VPN, не ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-199">However, this only works if you are using a VPN gateway, not ExpressRoute.</span></span> <span data-ttu-id="f6a3e-200">Для ExpressRoute принудительное туннелирование настраивается с помощью BGP.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-200">For ExpressRoute, forced tunneling is configured through BGP.</span></span>
> 
> 

## <a name="ip-forwarding"></a><span data-ttu-id="f6a3e-201">IP-пересылка</span><span class="sxs-lookup"><span data-stu-id="f6a3e-201">IP forwarding</span></span>
<span data-ttu-id="f6a3e-202">Как описано выше, одной из основных причин для создания пользовательского маршрута является переадресация трафика на виртуальное устройство.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-202">As described above, one of the main reasons to create a user defined route is to forward traffic to a virtual appliance.</span></span> <span data-ttu-id="f6a3e-203">Виртуальное устройство — это просто виртуальная машина, которая запускает приложение, используемое для обработки сетевого трафика определенным образом, например, как брандмауэр или устройство NAT.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-203">A virtual appliance is nothing more than a VM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="f6a3e-204">Эта виртуальная машина виртуального устройства должна иметь возможность получать входящий трафик, предназначенный не ей.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-204">This virtual appliance VM must be able to receive incoming traffic that is not addressed to itself.</span></span> <span data-ttu-id="f6a3e-205">Чтобы разрешить виртуальной машине получать трафик, направленный по другим назначениям, для нее необходимо включить IP-пересылку.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-205">To allow a VM to receive traffic addressed to other destinations, you must enable IP Forwarding for the VM.</span></span> <span data-ttu-id="f6a3e-206">Это нужно сделать в среде Azure, а не в операционной системе на виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-206">This is an Azure setting, not a setting in the guest operating system.</span></span>

## <a name="next-steps"></a><span data-ttu-id="f6a3e-207">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="f6a3e-207">Next steps</span></span>
* <span data-ttu-id="f6a3e-208">Узнайте, как [создать маршруты в модели развертывания диспетчера ресурсов](virtual-network-create-udr-arm-template.md) и связать их с подсетями.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-208">Learn how to [create routes in the Resource Manager deployment model](virtual-network-create-udr-arm-template.md) and associate them to subnets.</span></span> 
* <span data-ttu-id="f6a3e-209">Узнайте, как [создать маршруты в классической модели развертывания](virtual-network-create-udr-classic-ps.md) и связать их с подсетями.</span><span class="sxs-lookup"><span data-stu-id="f6a3e-209">Learn how to [create routes in the classic deployment model](virtual-network-create-udr-classic-ps.md) and associate them to subnets.</span></span>


---
title: "Пример: aaaDMZ построения DMZ tooProtect сетей с помощью брандмауэра, UDR и NSG | Документы Microsoft"
description: "Построение сети периметра с брандмауэром, определяемыми пользователем маршрутами и группами безопасности сети."
services: virtual-network
documentationcenter: na
author: tracsman
manager: rossort
editor: 
ms.assetid: dc01ccfb-27b0-4887-8f0b-2792f770ffff
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/01/2016
ms.author: jonor;sivae
ms.openlocfilehash: cc121f9cd5fe3c3e9ac2c70fbb7d982a80bb345d
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="example-3--build-a-dmz-tooprotect-networks-with-a-firewall-udr-and-nsg"></a>Пример 3 — построения DMZ tooProtect сетей с помощью брандмауэра, UDR и NSG
[Возвращает toohello страница лучшие рекомендации безопасности границ][HOME]

В этом примере будет создана сеть периметра (которая называется также DMZ, демилитаризованной зоной, или промежуточной подсетью) с брандмауэром, четырьмя серверами Windows Server, определяемыми пользователем маршрутами, IP-пересылкой и группами безопасности сети. Он также поможет выполнить каждого из соответствующих команд tooprovide hello более глубокого понимания каждого шага. Имеется также сценарий трафика раздел tooprovide на подробные пошаговые трафик проходит через hello уровней защиты в hello DMZ. Наконец, в разделе references hello hello полный код и должна toobuild инструкция этот tootest среды и эксперимента с помощью различных сценариев. 

![Двунаправленная сеть периметра с виртуальным сетевым устройством, группой безопасности сети и определяемыми пользователем маршрутами][1]

## <a name="environment-setup"></a>Настройка среды
В этом примере имеется подписка, содержащий hello следующее:

* три облачные службы: SecSvc001, FrontEnd001 и BackEnd001;
* виртуальная сеть CorpNetwork с тремя подсетями (SecNet, FrontEnd и BackEnd);
* Устройство виртуальной сети, в этом примере брандмауэр, подключены toohello SecNet подсети
* сервер Windows Server, который представляет веб-сервер приложений (IIS01);
* два сервера Windows Server, представляющих тыловые серверы приложений (AppVM01, AppVM02);
* сервер Windows Server, который представляет DNS-сервер (DNS01).

В разделе references hello ниже имеется сценарий PowerShell, построит большая часть среды hello, описанных выше. Построение hello ВМ и виртуальными сетями, несмотря на то, что может быть выполнено с hello пример скрипта, не подробно описаны в этом документе.

Среда toobuild hello.

1. Сохраните hello сетевой конфигурации XML-файл включаются в раздел ссылок hello (обновлено с именами, расположение и toomatch hello заданному IP адресов сценарий)
2. Переменные пользователя hello обновления в скрипт hello среды hello toomatch hello скрипта является toobe выполняться (подписок, имена служб, и т. д.)
3. Выполните сценарий hello в PowerShell

**Примечание**: hello область — в hello сценарий PowerShell должен соответствовать hello область — в XML-файл конфигурации сети hello.

После успешного выполнения сценария hello может быть переведена hello следующие шаги после сценария:

1. Настройка правил брандмауэра hello, это рассматривается в hello ниже раздел: Описание правила брандмауэра.
2. При необходимости в разделе references hello являются двумя tooset сценарии hello веб-сервер и сервер приложений с простой web tooallow приложения, тестирование с помощью этой конфигурации сети Периметра.

После успешного выполнения сценария hello hello правила брандмауэра потребуется toobe завершена, это рассматривается в разделе hello: правила брандмауэра.

## <a name="user-defined-routing-udr"></a>Определяемые пользователем маршруты
По умолчанию hello следующие маршруты системы определяются как:

        Effective routes : 
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.0.0/16}     VNETLocal                            Active   Default    
         {0.0.0.0/0}       Internet                             Active   Default    
         {10.0.0.0/8}      Null                                 Active   Default    
         {100.64.0.0/10}   Null                                 Active   Default    
         {172.16.0.0/12}   Null                                 Active   Default    
         {192.168.0.0/16}  Null                                 Active   Default

Hello VNETLocal всегда является префиксы адресов определенные hello объекта hello виртуальной сети для этой конкретной сети (ie он изменится с tooVNet виртуальной сети в зависимости от способа определения каждой определенной виртуальной сети). Здравствуйте, оставшиеся системы, статические маршруты и по умолчанию, как описано выше.

Как и для приоритетов маршруты обрабатываются через метод hello длинного соответствия префикса (LPM), таким образом hello наиболее конкретный маршрут в таблице hello бы применить tooa указанного адреса назначения.

Таким образом будет перенаправлен трафика (например toohello DNS01 сервер, 10.0.2.4), предназначенного для hello локальной сети (10.0.0.0/16) через назначения tooits hello виртуальной сети из-за toohello 10.0.0.0/16 маршрута. Другими словами для 10.0.2.4, hello 10.0.0.0/16 маршрута является наиболее конкретный маршрут hello, несмотря на то, что hello 10.0.0.0/8 и 0.0.0.0/0 также может применяться, но так как они менее точно не влияют на этого трафика. Таким образом hello трафика too10.0.2.4 бы следующего прыжка hello виртуальной локальной сети и просто маршрута toohello назначения.

Если трафика был предназначен для 10.1.1.1, например, hello 10.0.0.0/16 маршрута не применяются, но hello 10.0.0.0/8 будет наиболее подходящим hello и hello трафик будет удалены («черный поставщик только») следующего прыжка hello имеет значение Null. 

Если hello назначения не был применен tooany префиксы Null hello или префиксы VNETLocal hello, то она будет следовать hello наименее конкретным маршрута, 0.0.0.0/0 и маршрутизироваться out toohello Интернета в качестве следующего прыжка hello и, следовательно, out edge Интернета в Azure.

Если имеются два идентичных префикса в таблице маршрутов hello, hello Вот hello порядке приоритета на основе атрибута «источник» hello маршруты:

1. «VirtualAppliance» = добавленные вручную toohello таблицы маршрутизации, определяемые пользователем
2. «VPNGateway» = маршрут динамической (BGP при использовании гибридных сетях) добавлены динамические сетевым протоколом, эти маршруты может изменяться со временем как протоколом динамической hello автоматически отражает изменения в одноранговыми сети
3. «Default» = hello системы маршруты, hello локальные статические записи виртуальной сети "и" hello, как показано в таблице маршрутов hello выше.

> [!NOTE]
> Маршрутизации определенных пользователем (UDR) теперь можно использовать с ExpressRoute и VPN-шлюзов tooforce исходящего и входящего трафика между организациями трафик toobe перенаправленное tooa сети виртуальное устройство (уязвимости сети).
> 
> 

#### <a name="creating-hello-local-routes"></a>Создание локальных маршрутов hello
В этом примере требуются две таблицы маршрутизации, одному для каждого внешнего и внутреннего подсетей hello. Каждая таблица загружается статические маршруты, соответствующие заданному подсети hello. В целях hello в этом примере каждая таблица имеет три маршруты:

1. Локальной подсети трафика со следующего прыжка определенные tooallow локальной подсети трафика toobypass hello брандмауэра
2. Виртуального сетевого трафика с помощью следующего прыжка определяется как брандмауэр, он переопределяет правило по умолчанию hello и позволяющая локального tooroute трафика виртуальной сети напрямую
3. Все остальные трафика (0-0) с помощью следующего прыжка определен как hello брандмауэра

После создания таблицы маршрутизации hello это связанный tootheir подсетей. Для hello интерфейсной подсети таблицу маршрутизации после создания и привязки toohello подсети должен выглядеть следующим образом:

        Effective routes : 
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.1.0/24}     VNETLocal                            Active 
         {10.0.0.0/16}     VirtualAppliance 10.0.0.4            Active    
         {0.0.0.0/0}       VirtualAppliance 10.0.0.4            Active


В этом примере hello следующие команды, используемые toobuild таблицы маршрутов hello, добавьте маршрут определяемых пользователем и затем привязать подсети tooa таблицы маршрутов hello (Примечание; все элементы под начиная со знака доллара (например: $BESubnet), определенные пользователем переменные из сценария hello Hello справочном разделе этого документа):

1. Первая таблица маршрутизации hello для базового должна быть создана. Этот фрагмент показывает создание hello таблицы hello для внутренних подсети hello. В сценарии hello для hello внешней подсети создается соответствующая таблица.
   
     New-AzureRouteTable -Name $BERouteTableName `
   
         -Location $DeploymentLocation `
         -Label "Route table for $BESubnet subnet"
2. После создания таблицы маршрутов hello можно добавить определенные определяемые пользователем маршруты. В этом фрагмента весь трафик (0.0.0.0/0) будет проходить через hello виртуальное устройство (переменная, $VMIP [0] имеет используется toopass hello IP-адрес, назначенный при создании виртуального устройства hello, ранее в скрипте hello). В скрипте hello соответствующее правило создается также в таблице hello переднего плана.
   
     Get-AzureRouteTable $BERouteTableName | `
   
         Set-AzureRoute -RouteName "All traffic tooFW" -AddressPrefix 0.0.0.0/0 `
         -NextHopType VirtualAppliance `
         -NextHopIpAddress $VMIP[0]
3. Hello выше записи маршрута будет переопределять маршрут «0.0.0.0/0» по умолчанию hello, но правило 10.0.0.0/16 по умолчанию hello, по-прежнему существующих, что позволит трафик в виртуальной сети tooroute hello непосредственно toohello назначения и toohello виртуальное устройство в сети. toocorrect, необходимо добавить это поведение hello выполните правило.
   
        Get-AzureRouteTable $BERouteTableName | `
            Set-AzureRoute -RouteName "Internal traffic tooFW" -AddressPrefix $VNetPrefix `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
4. На этом этапе является выбор toobe внесены. С hello выше двух маршрутов весь трафик будет направлять toohello брандмауэра для оценки, даже трафика в одной подсети. Это может оказаться целесообразным, однако tooallow трафик в подсети tooroute локально без участия hello брандмауэра можно добавить третий, определенных правил. Этот маршрут состояний, которые любой адрес destine для локальной подсети hello можно просто маршрутизации существует напрямую (NextHopType = VNETLocal).
   
        Get-AzureRouteTable $BERouteTableName | `
            Set-AzureRoute -RouteName "Allow Intra-Subnet Traffic" -AddressPrefix $BEPrefix `
            -NextHopType VNETLocal
5. Наконец с hello таблицу маршрутизации создаются и заполняются определяемые пользователем маршруты, hello таблица теперь должна быть привязанного tooa подсети. В сценарий hello таблицы маршрутов hello переднего плана является привязанной toohello внешней подсети. Вот сценарий hello привязки для подсети hello серверной части.
   
     Set-AzureSubnetRouteTable -VirtualNetworkName $VNetName `
   
        -SubnetName $BESubnet `
        -RouteTableName $BERouteTableName

## <a name="ip-forwarding"></a>IP-пересылку
Функция tooUDR помощник по поиску, — IP-пересылки. Это — параметр, позволяющий ему tooreceive трафик не было специально виртуального устройства обращаться toohello устройства и затем перешлите tooits конечного назначения этого трафика.

Например если трафик от AppVM01 делает запрос серверу DNS01 toohello UDR бы маршрутизацию toohello брандмауэр. С IP-пересылка включена hello трафик для назначения DNS01 hello (10.0.2.4) будет принято устройством hello (10.0.0.4) и затем пересылаются конечного назначения tooits (10.0.2.4). Без IP-пересылка включена hello брандмауэра трафик будет не будут приниматься с устройством hello даже при таблицы маршрутов hello брандмауэра hello как hello следующего прыжка. 

> [!IMPORTANT]
> Это tooenable критические tooremember IP-пересылки в сочетании с определенных маршрутизации пользователя.
> 
> 

IP-пересылка настраивается с помощью единственной команды. Настройку можно выполнить во время создания виртуальной машины. Для hello потока следующий фрагмент кода hello пример — концу hello скрипт hello и группируются с hello UDR команды:

1. Вызова hello экземпляр виртуальной Машины, который является вашей виртуальной машины, в этом случае hello брандмауэра и включить IP-пересылку (Примечание; любой элемент в начало красным знаком доллара (например: $VMName[0]) является определяемой пользователем переменной из скрипта hello в справочном разделе hello этого документа. Здравствуйте ноль в квадратные скобки, [0], представляет hello первая виртуальная машина в массиве hello виртуальных машин, для hello пример сценария toowork без изменений, брандмауэра hello hello, должна быть первой виртуальной Машины (VM 0)):
   
     Get-AzureVM -Name $VMName[0] -ServiceName $ServiceName[0] | `
   
        Set-AzureIPForwarding -Enable

## <a name="network-security-groups-nsg"></a>Группы безопасности сети
В этом примере создается группа безопасности сети, после чего в нее загружается одно правило. Эта группа будет привязан только toohello внешнего и внутреннего подсети (не hello SecNet). Декларативно, строится hello следующие правила:

1. Любой трафик (все порты) из Интернета toohello hello запрещен всей виртуальной сети (все подсети)

В этом примере используются группы безопасности сети, но его основной целью является создание дополнительного уровня защиты от неправильной настройки вручную. Мы хотим tooblock все входящий трафик от hello internet tooeither hello переднего плана или подсети серверной части, трафик только должен проходить hello брандмауэра toohello SecNet подсети (и затем, если соответствующие на toohello клиентской или серверной подсети). Кроме того с правилами UDR hello в месте, любой трафик, который сделать hello клиентской или серверной подсетей будет направлять out toohello брандмауэра (спасибо tooUDR). брандмауэр Hello увидят это поток асимметричного и уменьшится hello исходящего трафика. Таким образом существует три уровня безопасности защищающее hello переднего плана и серверной подсети; (1) не открытые конечные точки на hello FrontEnd001 и BackEnd001 облачные службы, (2) Nsg Запрет трафика из Интернета, брандмауэр hello (3), удаление асимметричного трафика hello.

Один интересный момент относительно hello сетевой группы безопасности в этом примере является, содержащий хотя бы одно правило, показанный ниже, toodeny Интернет трафика toohello всей виртуальной сеть включающие hello безопасности подсети. 

    Get-AzureNetworkSecurityGroup -Name $NSGName | `
        Set-AzureNetworkSecurityRule -Name "Isolate hello $VNetName VNet `
        from hello Internet" `
        -Type Inbound -Priority 100 -Action Deny `
        -SourceAddressPrefix INTERNET -SourcePortRange '*' `
        -DestinationAddressPrefix VIRTUAL_NETWORK `
        -DestinationPortRange '*' `
        -Protocol *

Тем не менее, поскольку hello NSG — только привязан toohello интерфейсной и серверной подсетей, hello правило не обрабатывается на трафик входящих подключений подсети toohello безопасности. В результате несмотря на то, что правило NSG hello говорит не tooany трафика Интернет-адрес на hello виртуальной сети, поскольку приветствия NSG никогда не был привязан toohello безопасности подсети, трафик будет проходить подсети toohello безопасности.

    Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName `
        -SubnetName $FESubnet -VirtualNetworkName $VNetName

    Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName `
        -SubnetName $BESubnet -VirtualNetworkName $VNetName

## <a name="firewall-rules"></a>Правила брандмауэра
На брандмауэре hello правила перенаправления потребуется создать toobe. Так как брандмауэр hello трафика блокировки или пересылки все входящие, Исходящие и внутри виртуальной сети требуется много правил брандмауэра. Кроме того, весь входящий трафик столкнутся hello службы безопасности общедоступный IP-адрес (по различным портам), toobe обрабатываемых hello брандмауэра. Лучший способ — toodiagram hello логических потоков перед настройкой подсети hello и доработку tooavoid правила брандмауэра позже. Hello на этом рисунке — это логическое представление hello правила брандмауэра для этого примера:

![Логическое представление hello правила брандмауэра][2]

> [!NOTE]
> На основании hello используется виртуальное устройство в сети, будет зависеть порты управления hello. В этом примере брандмауэр Barracuda NextGen Firewall использует порты 22, 801 и 807. Обратитесь к hello устройства поставщика документации toofind hello точное порты, используемые для управления hello устройства, используемого.
> 
> 

### <a name="logical-rule-description"></a>Описание логического правила
Hello логической схеме выше подсети hello безопасности не отображаются, поскольку hello брандмауэра является ресурсом только hello в этой подсети, и на этой схеме показан правила брандмауэра hello и как они логически разрешить или запретить трафик, поступающий и не hello фактический перенаправленное путь. Кроме того, hello внешними портами, выбранный для hello трафик RDP, выше диапазоны портов (8014 — 8026) и были выбранного toosomewhat соответствовать hello последние два октета hello локальный IP-адрес для упрощения восприятия (например адрес локального сервера 10.0.1.4 связан с внешний порт 8014), однако все более порты неконфликтующее могут быть использованы.

В этом примере нам нужно 7 типов правил. Их описание приведено ниже.

* Внешние правила (для входящего трафика):
  1. Правило брандмауэра управления: Это правило перенаправления приложения разрешает трафик порты управления toohello toopass hello сети виртуальных устройств.
  2. Правила протокола удаленного рабочего СТОЛА (для каждого сервера windows): эти четыре правила, по одному для каждого сервера, будет разрешить управление hello отдельных серверах с помощью протокола удаленного рабочего СТОЛА. Это также может быть собраны в одно правило, в зависимости от возможностей hello hello сети виртуальной машины используется.
  3. Правила трафика приложения: Существует два правила трафика приложения hello сначала для hello внешнего интерфейса веб-трафика и hello второй для трафика серверной части hello (например, веб-сервера toodata уровня). Конфигурация Hello из этих правил будет зависеть от hello сетевую архитектуру (где располагаются серверов) и трафик, поступающий (hello какие направление трафик проходит и порты, используемые).
     * Первое правило Hello позволит hello hello фактического приложения трафика tooreach сервера приложений. Хотя hello другие правила позволяют для обеспечения безопасности, управления и т. д., правила, приложения, что разрешить внешние tooaccess пользователям или службам приложения hello. В этом примере нет одного веб-сервера на порт 80, и таким образом одно приложение правило брандмауэра будет перенаправлять входящий трафик toohello внешний IP-адрес, toohello web внутренний IP-адрес сервера. Hello перенаправление трафика сеанса будет NAT имеет toohello внутреннего сервера.
     * Hello является второе правило трафика приложения hello tootalk сервера toohello AppVM01 tooallow hello серверной части правила веб-сервера (но не AppVM02) через любой порт.
* Внутренние правила (для внутреннего трафика виртуальной сети)
  1. Исходящие tooInternet правило: это правило разрешает трафик от какой-либо сети toopass toohello выбранной сети. Это правило обычно является правилом по умолчанию уже на брандмауэре hello, но в отключенном состоянии. В нашем примере это правило следует активировать.
  2. Правило DNS: Это правило разрешает только DNS (порт 53) трафика toopass toohello DNS-сервер. Для этой среды, заблокирован большая часть трафика из toohello переднего плана hello серверной части это правило разрешает специально DNS из любой локальной подсети.
  3. Подсети tooSubnet правило: это правило является tooallow любой сервер обратной hello внутренний сервер tooany tooconnect подсети в подсети hello внешнего интерфейса (но не hello обратного).
* Резервный правило (для трафика, который не удовлетворяет любому из hello выше):
  1. Запретить все правила трафика: Это всегда должны содержать hello окончательного правило (с точки зрения приоритета) и таким образом Если трафик проходит происходит сбой toomatch любой hello предшествующий правила, которые они будут удалены с помощью этого правила. Это правило обычно уже установлено по умолчанию и активировано, поэтому не требует дополнительных действий.

> [!TIP]
> На hello второе правило трафика приложения любой порт может легко этого примера, в hello реальные сценарии наиболее конкретный порт а также диапазоны адресов должны быть уязвимость hello используется tooreduce данного правила.
> 
> 

<br />

> [!IMPORTANT]
> После создания всех hello выше правила важно tooreview hello приоритета трафика tooensure каждого правила будет разрешаться или запрещаться желаемым образом. В этом примере hello правила следуют в порядке приоритета. Это легко toobe hello брандмауэра из-за правил, упорядоченных toomis был заблокирован. Как минимум убедитесь, что hello управления сам брандмауэр hello всегда соответствует hello абсолютный наивысший приоритет правила.
> 
> 

### <a name="rule-prerequisites"></a>Предварительные требования для правил
Один необходимых компонентов для брандмауэра hello работающей виртуальной машины hello являются общедоступными конечными точками. Трафик tooprocess брандмауэра hello hello соответствующие общедоступные конечные точки должны быть открыты. Существует три типа трафика в этом примере; (1) управления трафика toocontrol hello брандмауэра и правила брандмауэра, серверов windows hello toocontrol трафик RDP (2) и трафика (3) приложения. Это hello три столбца типов трафика в hello верхней половины логическое представление выше правила брандмауэра hello.

> [!IMPORTANT]
> Ключа takeway здесь — tooremember, **все** трафик будет поступать через брандмауэр hello. Так tooremote рабочего стола toohello IIS01 server, несмотря на то, что это hello Front End облачной службы, так и в подсети hello переднего плана, tooaccess этот сервер будет необходимо tooRDP toohello брандмауэра на порт 8014 и подождите hello брандмауэра tooroute hello RDP запроса внутри toohello IIS01 порт протокола удаленного рабочего СТОЛА. Здравствуйте, портал Azure «подключиться», кнопка не будет работать, поскольку нет прямой путь tooIIS01 протокола удаленного рабочего СТОЛА (как можно увидеть hello портала). Это означает все соединения с hello Интернета будут toohello службы безопасности и номером порта, например secscv001.cloudapp.net:xxxx (Справочник по hello выше схемы для сопоставления hello внешний порт и внутренний IP-адрес и порт).
> 
> 

Может быть открыт либо во время создания виртуальной Машины hello или post сборки, как показано ниже в этом фрагменте кода и сделать в примере сценария hello конечной точки (Примечание; все элемента, начинающиеся со знака доллара (например: $VMName[$i]) является определяемой пользователем переменной из скрипта hello в hello referen CE раздел этого документа. Hello «$i» в квадратные скобки, [$i] представляет номер массива hello определенную виртуальную Машину в массиве виртуальные машины):

    Add-AzureEndpoint -Name "HTTP" -Protocol tcp -PublicPort 80 -LocalPort 80 `
        -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | `
        Update-AzureVM

Несмотря на то, что здесь не четко показано из-за toohello использование переменных, но конечные точки являются **только** открывается на hello безопасности облачной службы. Это tooensure обработки весь входящий трафик (маршрутизироваться, NAT сброшен) брандмауэром hello.

Клиент управления будет требуется toobe установлен брандмауэр hello toomanage ПК и создавать hello конфигурациях. См. документации из брандмауэр (или другие Уязвимости) поставщика hello как toomanage hello устройства. Hello оставшейся части этого раздела и следующего раздела hello, создания правил брандмауэра, описывается hello конфигурации брандмауэра hello, через hello клиент управления поставщиков (т. е. не hello портал Azure или PowerShell).

Инструкции по загрузки клиента и подключении toohello Barracuda используется в этом примере можно найти здесь: [Barracuda NG администратора](https://techlib.barracuda.com/NG61/NGAdmin)

После входа на брандмауэре hello, но до создания правила брандмауэра, существует два класса готовности объекта, которые могут облегчить создание правил hello; Объекты, сеть и службы.

В этом примере три объекта именованной сети следует определенных (одно для hello внешней подсети и подсети hello серверной части, также объект сети для IP-адреса hello hello DNS-сервера). toocreate именованной сети; начиная с панели мониторинга клиент Barracuda NG Admin hello, перейдите на вкладку toohello конфигурации, в hello рабочей конфигурации раздела выберите набор правил, нажмите кнопку «Сети» в меню объектов брандмауэра hello, нажмите нажмите кнопку "Создать" в меню Правка сетей hello. Hello объекта сети теперь можно создать, добавив приветствия имен и префиксов hello:

![Создание сетевого объекта FrontEnd][3]

Это создаст именованной сети для подсети hello переднего плана, похожих объектов, создаваемых для hello также подсети серверной части. Теперь hello подсетей можно легко ссылаться по имени в правилах брандмауэра hello.

Для hello объекта сервера DNS:

![Создание объекта сервера DNS][4]

Это ссылка на один IP адресов будут использоваться в правиле "DNS" Далее в документе hello.

Hello второй необходимые объекты являются объектами службы. Будет представляют Привет порты подключения протокола удаленного рабочего СТОЛА для каждого сервера. Поскольку hello существующего объекта службы протокола удаленного рабочего СТОЛА RDP-порту по умолчанию связанного toohello, 3389, новые службы могут создаваться tooallow трафика из hello внешние порты (8014 8026). новые порты Hello также могут быть добавлены toohello существующую службу протокола удаленного рабочего СТОЛА, но для простоты демонстрации можно создать отдельное правило для каждого сервера. toocreate новое правило протокола удаленного рабочего СТОЛА для сервера; начиная с панели мониторинга hello Barracuda NG администратора клиента, перейдите toohello вкладка конфигурации, в hello рабочей конфигурации раздела щелкните набор правил, затем щелкните «Службы» в группе hello меню объектов брандмауэра, прокрутите вниз список hello служб и выберите hello Служба «Протокола удаленного рабочего СТОЛА». Щелкните правой кнопкой мыши и выберите копию, затем щелкните правой кнопкой мыши и выберите команду «Вставить». Теперь у нас есть объект службы RDP-Copy1, который можно редактировать. Щелкните правой кнопкой мыши Copy1 протокола удаленного рабочего СТОЛА и выберите изменение, hello изменить объект службы, окно появится, как показано ниже:

![Копия правила RDP по умолчанию][5]

Hello значения затем могут быть hello измененного toorepresent службы протокола удаленного рабочего СТОЛА для конкретного сервера. Для hello AppVM01 выше по умолчанию правило протокола удаленного рабочего СТОЛА следует измененный tooreflect новое имя службы, описание, и внешний порт протокола удаленного рабочего СТОЛА используется при hello схема на рис. 8 (Примечание: hello порты изменяются с hello по умолчанию RDP 3389 внешний порт toohello используется для этого конкретного сервера, в случае, когда hello AppVM01 hello внешний порт является 8025) hello измененные службы показан ниже:

![Правило AppVM01][6]

Этот процесс должен быть повторяющихся toocreate службы протокола удаленного рабочего СТОЛА для hello оставшихся серверов. AppVM02 DNS01 и IIS01. Создание Hello этих служб сделает создание правила hello проще и более очевидным в следующем разделе hello.

> [!NOTE]
> Служба протокола удаленного рабочего СТОЛА для hello брандмауэра не требуется по двум причинам; (1) первый hello брандмауэра виртуальной Машины — это изображение под управлением Linux, поэтому SSH будет использоваться порт 22 для управления виртуальными Машинами вместо протокола удаленного рабочего СТОЛА и (2) порт 22, а два других портов управления разрешены в hello описанных ниже tooallow для управления подключением первое правило управления.
> 
> 

### <a name="firewall-rules-creation"></a>Создание правил брандмауэра
В этом примере используется три типа правил брандмауэра. Все они имеют собственные значки.

Правила перенаправления приложения Hello: ![значка перенаправления приложения][7]

правило NAT назначения Hello: ![NAT значок назначения][8]

правила этапа Hello: ![передать значок][9]

Дополнительные сведения об этих правил можно найти на веб-сайте Barracuda hello.

toocreate hello правилам (или проверить существующие правила по умолчанию), начиная с панели мониторинга клиент Barracuda NG Admin hello, перейдите на вкладку Конфигурация toohello, в hello рабочей конфигурации нажмите кнопку набора правил. Вызывается сетку, «Main правила» будет отображаться hello существующие активные и неактивные правила на этот брандмауэр. Верхний правый угол hello сетки является небольшой, зеленый «+», выберите элемент этого toocreate новое правило (Примечание: брандмауэра «заблокирована» для изменения, если кнопки помечен «Lock» и, не удается toocreate или изменение правил, нажмите эту кнопку, отображается слишком «разблокировать» hello правило se t и разрешить изменение). При желании tooedit существующее правило, выберите это правило, щелкните правой кнопкой мыши и выберите команду Изменить правило.

После создания или изменения правил, они должны быть выполнены toohello брандмауэра и затем активируется, если этого не сделать hello правило, изменения не вступят в силу. Hello принудительной отправки и активации процесс описан ниже описания правил hello сведения.

особенности Hello каждое правило требуется toocomplete в этом примере описаны следующим образом:

* **Правило управления брандмауэра**: это приложение перенаправлено правило разрешает трафик порты управления toohello toopass hello сети виртуальных устройств, в этом примере брандмауэр Barracuda NextGen. порты для управления Hello: 801, 807 и при необходимости 22. Hello внешние и внутренние порты являются hello же (т. е. без преобразования порт). SETUP-MGMT-ACCESS является правилом по умолчанию и включено по умолчанию (в брандмауэре Barracuda NextGen Firewall версии 6.1).
  
    ![Правило управления брандмауэром][10]

> [!TIP]
> Hello источника адресного пространства для этого правила может быть любым, если hello известны управления диапазоны IP-адресов, уменьшая этой области также уменьшает порты управления toohello поверхности атаки hello.
> 
> 

* **Правила протокола удаленного рабочего СТОЛА**: правила преобразования сетевых адресов эти назначения будет разрешить управление hello отдельных серверах с помощью протокола удаленного рабочего СТОЛА.
  Существует четыре toocreate критического поля, необходимые этого правила:
  
  1. Источник — tooallow RDP в любом месте hello ссылку «Любой» используется в hello исходного поля.
  2. Службы — использовать соответствующий объект службы создан ранее, в данном случае «AppVM01 RDP» приветствия, внешними портами hello перенаправить toohello серверы локальный IP-адрес и tooport 3386 (порт протокола удаленного рабочего СТОЛА по умолчанию hello). Это конкретных правило предназначено для tooAppVM01 доступ RDP.
  3. Назначение — должно представлять hello *локальных портов на брандмауэре hello*, «DCHP 1 локальный IP-адрес» или eth0 при использовании статических IP-адресов. Порядковый номер Hello (eth0, eth1, и т. д.) может отличаться, если устройство вашей сети имеет несколько локальных интерфейсов. Это hello порт брандмауэра hello отправки из (может быть hello же, как получение порта hello), hello фактическое перенаправленное назначения находится в поля со списком целевой hello.
  4. Перенаправление — в этом разделе приведен виртуальное устройство hello где tooultimately перенаправление этого трафика. Простейший перенаправление Hello является tooplace hello IP и порта (необязательно) в поле списка целевой hello. Если порт не используется hello конечный порт на входящий запрос hello будет использовать (ie без преобразования), если порт назначается hello порт также будет NAT вместе с hello IP по адресу.
     
     ![Правило RDP брандмауэра][11]
     
     Всего четыре правила RDP потребуется создать toobe: 
     
     | Имя правила | сервер; | служба | Целевой список |
     | --- | --- | --- | --- |
     | RDP-to-IIS01 |IIS01 |IIS01 RDP |10.0.1.4:3389 |
     | RDP-to-DNS01 |DNS01 |DNS01 RDP |10.0.2.4:3389 |
     | RDP-to-AppVM01 |AppVM01 |AppVM01 RDP |10.0.2.5:3389 |
     | RDP-to-AppVM02 |AppVM02 |AppVm02 RDP |10.0.2.6:3389 |

> [!TIP]
> Сужение области hello hello источника и поля службы позволяет снизить уязвимость hello. следует использовать Hello наиболее ограниченную область, которая позволит функциональные возможности.
> 
> 

* **Применение правил трафика**: существует два правила трафика приложения hello сначала для hello внешнего интерфейса веб-трафика и hello второй для трафика серверной части hello (например, веб-сервера toodata уровень). Эти правила будут зависеть от hello сетевой архитектуры, (где располагаются серверов) и трафик, поступающий (hello какие направление трафик проходит и порты, используемые).
  
    Сначала рассматриваются — hello правило внешнего интерфейса для веб-трафика.
  
    ![Веб-правило брандмауэра][12]
  
    Это правило NAT назначения разрешает hello hello фактического приложения трафика tooreach сервера приложений. Хотя hello другие правила позволяют для обеспечения безопасности, управления и т. д., правила, приложения, что разрешить внешние tooaccess пользователям или службам приложения hello. В этом примере нет одного веб-сервера на порт 80, и таким образом hello одно приложение правило брандмауэра будет перенаправлять входящий трафик toohello внешний IP-адрес, toohello web внутренний IP-адрес сервера.
  
    **Примечание**: что нет порта, назначенного в поля со списком целевой hello, таким образом hello входящий порт 80 (или 443 для hello выбранной службой) будет использоваться в перенаправлении hello hello веб-сервера. Если hello веб-сервер прослушивает другой порт, например 8080, поля со списком целевой hello может быть обновленные too10.0.1.4:8080 tooallow для hello также перенаправление портов.
  
    Hello следующего правила трафика приложения — через любую службу hello tootalk сервера toohello AppVM01 tooallow hello серверной части правила веб-сервера (но не AppVM02):
  
    ![Правило AppVM01 брандмауэра][13]
  
    Это правило проход дает любой сервер IIS на hello интерфейсной подсети tooreach hello AppVM01 (IP-адрес 10.0.2.5) через любой порт, используя любой протокол tooaccess данные, необходимые для веб-приложения hello.
  
    На этом снимке экрана "\<явные dest\>» используется в toosignify поле назначения hello 10.0.2.5 hello назначения. Это может быть либо явные показанное или с именем сетевой объект (как это было сделано в предварительных требованиях hello hello DNS-сервера). Это копирование администратора toohello hello брандмауэра будет использоваться метод toowhich. Дважды щелкните первую пустую строку hello под tooadd 10.0.2.5 как конечный Explict \<явные dest\> и введите адрес hello в окне приветствия, будет отображена.
  
    С этим правилом передать не NAT необходим, так как это внутренний трафик, чтобы можно было задать слишком hello метод подключения «Нет SNAT».
  
    **Примечание**: hello исходную сеть в этом правиле, любой ресурс на hello внешней подсети, если будет существовать только один, либо известных определенное число веб-серверы, объект сетевого ресурса может быть создан toobe более конкретные toothose точного IP-адреса вместо Hello всей подсети переднего плана.

> [!TIP]
> Это правило использует службу hello «Любой» toomake toosetup простой пример приложения hello и использовать, это также позволит ICMPv4 (ping) в одно правило. Однако так делать не рекомендуется. Hello порты и протоколы («службы») должно быть возможно минимальное узкую toohello, что позволяет операции tooreduce приложения hello возможных направлений атак через эту границу.
> 
> 

<br />

> [!TIP]
> Несмотря на то, что это правило показывает ссылку явную dest используется, целостный подход следует использовать в конфигурации брандмауэра hello. Рекомендуется, hello именованный объект сети будет использоваться в для упрощения чтения и поддержки. явные dest Hello используемые здесь только tooshow альтернативные ссылки метод и обычно не рекомендуется (особенно для сложных конфигураций).
> 
> 

* **Исходящие tooInternet правило**: передайте это правило разрешает трафик из любого источника сети toopass toohello выбранного назначения сетей. Это правило является правилом по умолчанию обычно уже брандмауэр Barracuda NextGen hello, но находится в отключенном состоянии. Щелкните правой кнопкой мыши на это правило может обращаться к команда активировать правило hello. правило Hello, показанный здесь был измененный tooadd hello двух локальных подсетях, созданных как ссылки hello необходимых компонентов из раздела этого документа toohello исходный атрибут данного правила.
  
    ![Правило исходящего трафика брандмауэра][14]
* **Правило DNS**: передайте это правило разрешает только DNS (порт 53) трафика toopass toohello DNS-сервер. Для этой среды, заблокирован большая часть трафика из toohello переднего плана hello серверной части это правило, в частности, позволяет DNS.
  
    ![Правило DNS брандмауэра][15]
  
    **Примечание**: на этом экране включено однократного hello метод подключения. Так как это правило предназначено для внутреннего IP toointernal IP-адрес трафика, не NATing не требуется, это hello задан метод подключения слишком «Нет SNAT» для этого правила этапа.
* **Подсети tooSubnet правило**: передайте это правило является правилом по умолчанию, который был активирован и измененный tooallow на любом сервере в hello обратно внутренний сервер tooany tooconnect подсети на hello подсети переднего плана. Это правило не все внутренний трафик, чтобы hello метод подключения можно задать tooNo SNAT.
  
    ![Правило брандмауэра для внутреннего трафика виртуальной сети][16]
  
    **Примечание**: hello двунаправленные флажок не установлен (и поддерживается не возврата большинство правил), это важно для этого правила в том, что она делает это правило «один письмом», соединение может быть инициирован с hello серверной части подсети toohello интерфейсную сеть но не hello обратное. Если установить флажок, правило будет разрешать двунаправленный трафик, а в нашей логической схеме это не требуется.
* **Запретить все правила трафика**: это всегда должно быть правило окончательного hello (с точки зрения приоритета), и таким образом, если трафик проходит toomatch завершается с ошибкой любой из предыдущих правил hello они будут удалены с помощью этого правила. Это правило обычно уже установлено по умолчанию и активировано, поэтому не требует дополнительных действий. 
  
    ![Правило запрета брандмауэра][17]

> [!IMPORTANT]
> После создания всех hello выше правила важно tooreview hello приоритета трафика tooensure каждого правила будет разрешаться или запрещаться желаемым образом. В этом примере hello правила являются в порядке их отображения в hello сетки Main правил в клиент управления Barracuda hello переадресации hello.
> 
> 

## <a name="rule-activation"></a>Активация правил
Спецификации hello изменить ruleset toohello схемы логики hello, hello ruleset должен быть отправлен toohello брандмауэра и затем активируется.

![Активация правила брандмауэра][18]

В правом верхнем углу hello клиент управления hello являются кластера кнопок. Щелкните toohello «Изменения отправить «hello кнопка toosend hello изменены правила брандмауэра, а затем нажмите кнопку «Активировать» hello.

Hello активации из набора правил брандмауэра hello с этой сборкой среды пример завершена.

## <a name="traffic-scenarios"></a>Варианты прохождения трафика
> [!IMPORTANT]
> Ключа takeway — tooremember, **все** трафик будет поступать через брандмауэр hello. Так tooremote рабочего стола toohello IIS01 server, несмотря на то, что это hello Front End облачной службы, так и в подсети hello переднего плана, tooaccess этот сервер будет необходимо tooRDP toohello брандмауэра на порт 8014 и подождите hello брандмауэра tooroute hello RDP запроса внутри toohello IIS01 порт протокола удаленного рабочего СТОЛА. Здравствуйте, портал Azure «подключиться», кнопка не будет работать, поскольку нет прямой путь tooIIS01 протокола удаленного рабочего СТОЛА (как можно увидеть hello портала). Это означает все соединения с hello Интернета будут toohello службы безопасности и номером порта, например secscv001.cloudapp.net:xxxx.
> 
> 

В этих сценариях hello следующие правила брандмауэра должно быть на месте:

1. Управление брандмауэром.
2. TooIIS01 протокола удаленного рабочего СТОЛА
3. TooDNS01 протокола удаленного рабочего СТОЛА
4. TooAppVM01 протокола удаленного рабочего СТОЛА
5. TooAppVM02 протокола удаленного рабочего СТОЛА
6. Toohello трафика приложения Web
7. TooAppVM01 трафика приложения
8. Исходящие toohello Интернета
9. TooDNS01 переднего плана
10. Трафик внутри подсети (только для серверной части toofront конец)
11. Запрет любого трафика.

набор правил брандмауэра фактическое Hello скорее всего будет иметь множество правил в toothese сложения, hello правила на любом брандмауэре данного также будет иметь различные приоритеты чисел, чем другие перечисленные здесь hello. Этот список и связанные с ними номера, релевантность tooprovide между только одиннадцать правил и hello относительный приоритет среди них. Другими словами; на брандмауэре фактическое hello hello «TooIIS01 протокола удаленного рабочего СТОЛА» может быть номер правила 5, но пока это под правило «Управление брандмауэром» hello и выше правило «TooDNS01 протокола удаленного рабочего СТОЛА» hello, которое будет соответствовать намерение hello этого списка. Список Hello поможет hello ниже сценарии, позволяя краткости; Например правило 9 брандмауэра (DNS) (FW Rule 9 (DNS)). Для краткости hello четыре правила протокола удаленного рабочего СТОЛА, будут совместно называется также и «hello правила протокола удаленного рабочего СТОЛА» при несвязанных tooRDP сценарий трафика hello.

Также помните, сетевые группы безопасности на месте для входящего трафика Интернета hello переднего плана и подсетей серверной части.

#### <a name="allowed-internet-tooweb-server"></a>(Разрешено) Internet tooWeb Server
1. Интернет-пользователь запрашивает страницу HTTP из службы SecSvc001.CloudApp.Net (облачная служба с выходом в Интернет).
2. Облачные службы передает трафик через открытую конечную точку на порт 80 интерфейсе toofirewall 10.0.0.4:80
3. Нет NSG назначены подсети tooSecurity, системные правила NSG разрешить трафик toofirewall
4. Трафик достигнет внутренний IP-адрес брандмауэра hello (10.0.1.4)
5. Брандмауэр начинает обработку правил.
   1. Не применяет правила 1 FW (встроенного по, управление), переместите toonext правило
   2. Правила 2 – 5 (правила RDP) не применяются, переместить toonext правило
   3. FW правила 6 (приложение: Web) применяются, трафик, брандмауэр NAT его too10.0.1.4 (IIS01)
6. Hello внешней подсети начинает обработку входящее правило:
   1. Не применяет правила 1 NSG (Интернету блок) (этот трафик был NAT следует брандмауэром hello, таким образом hello адресом источника теперь является hello брандмауэр, который находится в подсети безопасности hello и видны hello внешней подсети трафика «local» toobe NSG и таким образом может быть), переместить toonext правило
   2. По умолчанию правила NSG разрешить подсети toosubnet трафик, трафик, остановите обработки правила NSG
7. IIS01 прослушивание веб-трафик, получает этот запрос и начинает обработку запроса hello
8. IIS01 пытается tooinitiates tooAppVM01 сеанс FTP в подсети серверной части
9. маршрут UDR Hello внешней подсети делает hello брандмауэра hello следующего прыжка
10. В подсети Frontend нет правил для обработки исходящего трафика — трафик разрешается.
11. Брандмауэр начинает обработку правил.
    1. Не применяет правила 1 FW (встроенного по, управление), переместите toonext правило
    2. Не применять правило FW 2 – 5 (правила протокола удаленного рабочего СТОЛА), переместите toonext правило
    3. Правила 6 FW (приложение: Web) не применяются, переместить toonext правило
    4. Правила 7 FW (приложение: серверной части) применяются, трафик, брандмауэр направляет трафик too10.0.2.5 (AppVM01)
12. подсети серверной Hello начинает обработку входящее правило:
    1. Не применяет правила 1 NSG (блок Интернет), переместите toonext правило
    2. По умолчанию правила NSG разрешить подсети toosubnet трафик, трафик, остановите обработки правила NSG
13. Получает запрос hello и инициирует сеанс hello и отвечает AppVM01
14. маршрут UDR Hello в серверной части подсети делает hello брандмауэра hello следующего прыжка
15. Так как может быть не исходящие правила NSG на hello ответа hello подсети серверной части
16. Так как это получение трафика на сеанс связи hello пропускает hello ответ назад toohello веб-сервера (IIS01)
17. Подсеть Frontend начинает обработку правила для входящего трафика.
    1. Не применяет правила 1 NSG (блок Интернет), переместите toonext правило
    2. По умолчанию правила NSG разрешить подсети toosubnet трафик, трафик, остановите обработки правила NSG
18. сервер IIS Hello получает ответ hello завершает транзакцию hello с AppVM01 и завершает построение hello HTTP-ответа, это HTTP-ответ отправляется запрашивающей стороны toohello
19. Так как может быть не исходящие правила NSG на hello интерфейсной подсети hello ответа
20. Здравствуйте брандмауэра hello попаданий ответа HTTP, а так, как это tooan ответа hello установления сеанса NAT принимается hello брандмауэра
21. брандмауэр Hello выполняет перенаправление назад toohello hello ответа пользователя Интернета
22. Так как не существует исходящие правила NSG или UDR прыжков на hello внешней подсети разрешено ответа hello и hello пользователя Интернета получает hello веб-страницы, в запросе.

#### <a name="allowed-internet-rdp-toobackend"></a>(Разрешено) TooBackend Интернет протокола удаленного рабочего СТОЛА
1. Администратор сервера в Интернете запрашивает tooAppVM01 сеанс RDP через SecSvc001.CloudApp.Net:8025, где 8025 — номер порта, пользователь hello правила брандмауэра «RDP tooAppVM01» hello
2. Hello облачной службы передает трафик через открытую конечную точку hello на интерфейсе toofirewall 8025 порт 10.0.0.4:8025
3. Нет NSG назначены подсети tooSecurity, системные правила NSG разрешить трафик toofirewall
4. Брандмауэр начинает обработку правил.
   1. Не применяет правила 1 FW (встроенного по, управление), переместите toonext правило
   2. Не применяется правило 2 FW (RDP IIS), переместите toonext правило
   3. Не применяется правило 3 FW (RDP DNS01), переместите toonext правило
   4. Применить правила 4 FW (RDP AppVM01), трафик, брандмауэр NAT его too10.0.2.5:3386 (RDP-порту на AppVM01)
5. подсети серверной Hello начинает обработку входящее правило:
   1. Не применяет правила 1 NSG (Интернету блок) (этот трафик был NAT следует брандмауэром hello, таким образом hello адресом источника теперь является hello брандмауэр, который находится в подсети безопасности hello и видны hello серверной подсети трафика «local» toobe NSG и таким образом может быть), переместить toonext правило
   2. По умолчанию правила NSG разрешить подсети toosubnet трафик, трафик, остановите обработки правила NSG
6. AppVM01 прослушивает трафик RDP и отвечает.
7. Правил для исходящего трафика групп безопасности сети нет, поэтому применяются правила по умолчанию и обратный трафик разрешается.
8. Брандмауэр toohello UDR маршруты исходящего трафика в качестве следующего прыжка hello
9. Так как это получение трафика на сеанс связи hello пропускает пользователя Интернета задней toohello ответа hello
10. Начинается сеанс RDP.
11. Сервер AppVM01 запрашивает имя пользователя и пароль.

#### <a name="allowed-web-server-dns-lookup-on-dns-server"></a>DNS-запрос веб-сервера к серверу DNS (разрешено) 
1. Веб-сервера, IIS01, потребности в www.data.gov, но потребности tooresolve hello адрес канала данных.
2. Hello конфигурацию сети для виртуальной сети hello списков DNS01 (10.0.2.4 подсети hello серверной части) как hello основной DNS-сервер, IIS01 отправляет запрос tooDNS01 hello DNS
3. Брандмауэр toohello UDR маршруты исходящего трафика в качестве следующего прыжка hello
4. Нет исходящие правила NSG являются привязанного toohello внешней подсети, трафик
5. Брандмауэр начинает обработку правил.
   1. Не применяет правила 1 FW (встроенного по, управление), переместите toonext правило
   2. Не применять правило FW 2 – 5 (правила протокола удаленного рабочего СТОЛА), переместите toonext правило
   3. Не применять FW правила 6 и 7 (правила приложений), переместите toonext правило
   4. Не применяется правило FW 8 (tooInternet), переместите toonext правило
   5. Применить правило 9 FW (DNS), трафик, брандмауэр направляет трафик too10.0.2.4 (DNS01)
6. подсети серверной Hello начинает обработку входящее правило:
   1. Не применяет правила 1 NSG (блок Интернет), переместите toonext правило
   2. По умолчанию правила NSG разрешить подсети toosubnet трафик, трафик, остановите обработки правила NSG
7. DNS-сервер получает запрос hello
8. DNS-сервер не имеет адреса hello в кэше и запрашивает у корневой сервер DNS на hello Интернета
9. Брандмауэр toohello UDR маршруты исходящего трафика в качестве следующего прыжка hello
10. В подсети Backend нет правил для исходящего трафика групп безопасности сети, поэтому трафик разрешается.
11. Брандмауэр начинает обработку правил.
    1. Не применяет правила 1 FW (встроенного по, управление), переместите toonext правило
    2. Не применять правило FW 2 – 5 (правила протокола удаленного рабочего СТОЛА), переместите toonext правило
    3. Не применять FW правила 6 и 7 (правила приложений), переместите toonext правило
    4. Применить правило FW 8 (tooInternet), -трафика, сеанс — SNAT out tooroot DNS-сервер в Интернете hello
12. Реагирует Internet DNS-сервера, с момента этого сеанса было инициировано из брандмауэра hello, hello ответ принимается hello брандмауэра
13. Как активный сеанс связи, брандмауэр hello направляет запуск сервера DNS01 toohello ответа hello
14. подсети серверной Hello начинает обработку входящее правило:
    1. Не применяет правила 1 NSG (блок Интернет), переместите toonext правило
    2. По умолчанию правила NSG разрешить подсети toosubnet трафик, трафик, остановите обработки правила NSG
15. Hello DNS-сервер получает и кэширует ответ hello и затем отвечает назад tooIIS01 toohello исходного запроса
16. маршрут UDR Hello в серверной части подсети делает hello брандмауэра hello следующего прыжка
17. Правила NSG не исходящих существует hello серверной подсети, трафик
18. Это активный сеанс связи на брандмауэре hello, hello ответа перенаправляется сервером IIS задней toohello брандмауэра hello
19. Подсеть Frontend начинает обработку правила для входящего трафика.
    1. Нет правил NSG, применяется tooInbound трафика из hello серверной подсети toohello внешней подсети, поэтому правила NSG hello не выполнены
    2. правило системы по умолчанию Hello, разрешающее трафик между подсетями позволит трафик, трафик hello
20. IIS01 получает hello ответа от DNS01

#### <a name="allowed-backend-server-toofrontend-server"></a>(Разрешено) TooFrontend сервера базы данных сервера
1. Администратор вошел tooAppVM02 по этому Протоколу запросит файл напрямую с сервера IIS01 hello через проводник windows
2. маршрут UDR Hello в серверной части подсети делает hello брандмауэра hello следующего прыжка
3. Так как может быть не исходящие правила NSG на hello ответа hello подсети серверной части
4. Брандмауэр начинает обработку правил.
   1. Не применяет правила 1 FW (встроенного по, управление), переместите toonext правило
   2. Не применять правило FW 2 – 5 (правила протокола удаленного рабочего СТОЛА), переместите toonext правило
   3. Не применять FW правила 6 и 7 (правила приложений), переместите toonext правило
   4. Не применяется правило FW 8 (tooInternet), переместите toonext правило
   5. Не применяется правило 9 FW (DNS), переместите toonext правило
   6. Применить правило FW 10 (внутри подсеть), трафик, брандмауэр передает трафик too10.0.1.4 (IIS01)
5. Подсеть Frontend начинает обработку правила для входящего трафика.
   1. Не применяет правила 1 NSG (блок Интернет), переместите toonext правило
   2. По умолчанию правила NSG разрешить подсети toosubnet трафик, трафик, остановите обработки правила NSG
6. При условии, что надлежащую проверку подлинности и авторизации, IIS01 принимает запрос hello и отвечает
7. маршрут UDR Hello внешней подсети делает hello брандмауэра hello следующего прыжка
8. Так как может быть не исходящие правила NSG на hello интерфейсной подсети hello ответа
9. Как это существующего сеанса в брандмауэре hello допускается этот ответ и брандмауэра hello возвращает ответ tooAppVM02 hello
10. Подсеть BackEnd начинает обработку правила для входящего трафика:
    1. Не применяет правила 1 NSG (блок Интернет), переместите toonext правило
    2. По умолчанию правила NSG разрешить подсети toosubnet трафик, трафик, остановите обработки правила NSG
11. AppVM02 получает ответ hello

#### <a name="denied-internet-direct-tooweb-server"></a>(Запрещено) Прямой tooWeb Internet Server
1. Пользователь Интернета пытается tooaccess hello веб-сервер, IIS01, через hello FrontEnd001.CloudApp.Net службы
2. Поскольку конечные точки не открыты для трафика HTTP, это не будет передан через hello облачной службы и не достигают сервера hello
3. Если по некоторым причинам hello конечные точки были открыты, hello NSG (блок Интернет) на внешней подсети hello заблокирует этот трафик
4. И, наконец маршрут UDR hello интерфейсной подсети отправляла весь исходящий трафик от брандмауэра toohello IIS01 как hello следующего прыжка и hello брандмауэра будет видят в этом асимметричного трафика и drop hello исходящего ответа таким образом, по крайней мере три уровня, независимо от защите между hello Интернета и IIS01 через его облачной службы, предотвращая несанкционированный или нарушение прав доступа.

#### <a name="denied-internet-toobackend-server"></a>(Запрещено) Internet tooBackend Server
1. Пользователь Интернета пытается tooaccess файл на AppVM01 через hello BackEnd001.CloudApp.Net службы
2. Поскольку конечные точки не открыты для общего файлового ресурса, это не будет передан hello облачной службы и не достигают сервера hello
3. Если по некоторым причинам hello конечные точки были открыты, hello NSG (Интернету блок) заблокирует этот трафик
4. И, наконец маршрут UDR hello отправляла весь исходящий трафик от брандмауэра toohello AppVM01 как hello следующего прыжка и hello брандмауэра будет видят в этом асимметричного трафика и drop hello исходящего ответа таким образом, существует по крайней мере три независимых уровней защиты между Здравствуйте, Интернет и AppVM01 через его облачной службы, предотвращая несанкционированный или нарушение прав доступа.

#### <a name="denied-frontend-server-toobackend-server"></a>(Запрещено) Сервер переднего плана tooBackend сервера
1. Предположим, был скомпрометирован IIS01 и выполняется попытка tooscan hello внутренних подсети серверов вредоносный код.
2. маршрут UDR Hello интерфейсной подсети отправит весь исходящий трафик от брандмауэра toohello IIS01 как hello следующего прыжка. Это не то, что может быть изменено, hello скомпрометированы виртуальной Машины.
3. Hello брандмауэра будет обрабатывать трафик hello, если запрос hello был tooAppVM01 или toohello DNS-сервера для DNS-запросы, которые трафика может допускаются потенциально брандмауэра hello (из-за tooFW правила 7 и 9). Весь остальной трафик будет заблокирован (запрет любого трафика) правилом 11 брандмауэра.
4. Если обнаружение угроз повышенной было включено на брандмауэре hello (которого не рассматривается в этом документе, см. в документации поставщика hello для вашего устройства определенным сетевым расширенными возможностями угроз), даже трафик, который допускается по hello основные правила перенаправления описанные в этом документе может быть не выполняется, если трафик hello содержатся известные подписи или шаблонов, которые флаг правило дополнительные угрозы.

#### <a name="denied-internet-dns-lookup-on-dns-server"></a>DNS-запрос из Интернета к серверу DNS (запрещено)
1. Пользователь Интернета пытается toolookup внутренние DNS-запись на DNS01 через службу BackEnd001.CloudApp.Net 
2. Поскольку конечные точки не открыты для трафика DNS, это не будет передан через hello облачной службы и не достигают сервера hello
3. Если по некоторым причинам hello конечные точки были открыты, правило NSG hello (блок Интернет) на внешней подсети hello заблокирует этот трафик
4. И, наконец подсети UDR hello фоновых маршрутов отправляла весь исходящий трафик от брандмауэра toohello DNS01 как hello следующего прыжка и hello брандмауэра будет видят в этом асимметричного трафика и drop hello исходящего ответа таким образом, по крайней мере три уровня, независимо от защите между hello Интернета и DNS01 через его облачной службы, предотвращая несанкционированный или нарушение прав доступа.

#### <a name="denied-internet-toosql-access-through-firewall"></a>(Запрещено) TooSQL Интернет-доступ через брандмауэр
1. Интернет-пользователь запрашивает данные SQL из службы SecSvc001.CloudApp.Net (облачная служба с выходом в Интернет).
2. Поскольку конечные точки не открыты для SQL, это не будет передан hello облачной службы и не будет достигнут hello брандмауэра
3. Если конечные точки SQL были открыты для какой-либо причине, брандмауэр hello начинается обработка правил:
   1. Не применяет правила 1 FW (встроенного по, управление), переместите toonext правило
   2. Правила 2 – 5 (правила RDP) не применяются, переместить toonext правило
   3. Не применять правила FW 6 и 7 (правил приложения), переместите toonext правило
   4. Не применяется правило FW 8 (tooInternet), переместите toonext правило
   5. Не применяется правило 9 FW (DNS), переместите toonext правило
   6. Не применяется правило FW 10 (внутри подсеть), переместите toonext правило
   7. Правило 11 брандмауэра (запрет любого трафика) применяется — трафик блокируется, дальнейшая обработка правил прекращается.

## <a name="references"></a>Ссылки
### <a name="main-script-and-network-config"></a>Основной сценарий и конфигурация сети
Сохраните hello полный скрипт в файл скрипта PowerShell. Сохраните hello сетевой конфигурации в файл с именем «NetworkConf2.xml».
При необходимости измените hello определенные пользователем переменные. Запустите сценарий hello, а затем выполните hello брандмауэра правила установки инструкции выше.

#### <a name="full-script"></a>Полный сценарий
Этот скрипт будет, на основе hello определяемых пользователем переменных:

1. Подключение tooan подписки Azure
2. Создать новую учетную запись хранения
3. Создать новую виртуальную сеть и три подсети, как определено в файле конфигурации сети hello
4. Соберет пять виртуальных машин: 1 брандмауэр и 4 виртуальных машины с Windows Server.
5. Настроит определяемые пользователем маршруты, включая следующее:
   1. Создание двух новых таблиц маршрутизации.
   2. Добавление таблиц маршрутов toohello
   3. Привязка таблицы tooappropriate подсети
6. Включить IP-пересылки на приветствия Уязвимости
7. Настроит группу безопасности сети:
   1. Создаст группу безопасности сети.
   2. Добавит правило.
   3. Привязка hello NSG toohello соответствующие подсети

Этот сценарий PowerShell должен запускаться локально на ПК или сервере, подключенном к Интернету.

> [!IMPORTANT]
> При запуске этого сценария могут выдаваться предупреждения и другие информационные сообщения PowerShell. Обращать внимание следует только на сообщения об ошибках, выделенные красным цветом.
> 
> 

    <# 
     .SYNOPSIS
      Example of DMZ and User Defined Routing in an isolated network (Azure only, no hybrid connections)

     .DESCRIPTION
      This script will build out a sample DMZ setup containing:
       - A default storage account for VM disks
       - Three new cloud services
       - Three Subnets (SecNet, FrontEnd, and BackEnd subnets)
       - A Network Virtual Appliance (NVA), in this case a Barracuda NextGen Firewall
       - One server on hello FrontEnd Subnet
       - Three Servers on hello BackEnd Subnet
       - IP Forwading from hello FireWall out toohello internet
       - User Defined Routing FrontEnd and BackEnd Subnets toohello NVA

      Before running script, ensure hello network configuration file is created in
      hello directory referenced by $NetworkConfigFile variable (or update the
      variable tooreflect hello path and file name of hello config file being used).

     .Notes
      Everyone's security requirements are different and can be addressed in a myriad of ways.
      Please be sure that any sensitive data or applications are behind hello appropriate
      layer(s) of protection. This script serves as an example of some of hello techniques
      that can be used, but should not be used for all scenarios. You are responsible to
      assess your security needs and hello appropriate protections needed, and then effectively
      implement those protections.

      Security Service (SecNet subnet 10.0.0.0/24)
       myFirewall - 10.0.0.4

      FrontEnd Service (FrontEnd subnet 10.0.1.0/24)
       IIS01      - 10.0.1.4

      BackEnd Service (BackEnd subnet 10.0.2.0/24)
       DNS01      - 10.0.2.4
       AppVM01    - 10.0.2.5
       AppVM02    - 10.0.2.6

    #>

    # Fixed Variables
        $LocalAdminPwd = Read-Host -Prompt "Enter Local Admin Password toobe used for all VMs"
        $VMName = @()
        $ServiceName = @()
        $VMFamily = @()
        $img = @()
        $size = @()
        $SubnetName = @()
        $VMIP = @()

    # User Defined Global Variables
      # These should be changes tooreflect your subscription and services
      # Invalid options will fail in hello validation section

      # Subscription Access Details
        $subID = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

      # VM Account, Location, and Storage Details
        $LocalAdmin = "theAdmin"
        $DeploymentLocation = "Central US"
        $StorageAccountName = "vmstore02"

      # Service Details
        $SecureService = "SecSvc001"
        $FrontEndService = "FrontEnd001"
        $BackEndService = "BackEnd001"

      # Network Details
        $VNetName = "CorpNetwork"
        $VNetPrefix = "10.0.0.0/16"
        $SecNet = "SecNet"
        $FESubnet = "FrontEnd"
        $FEPrefix = "10.0.1.0/24"
        $BESubnet = "BackEnd"
        $BEPrefix = "10.0.2.0/24"
        $NetworkConfigFile = "C:\Scripts\NetworkConf3.xml"

      # VM Base Disk Image Details
        $SrvImg = Get-AzureVMImage | Where {$_.ImageFamily -match 'Windows Server 2012 R2 Datacenter'} | sort PublishedDate -Descending | Select ImageName -First 1 | ForEach {$_.ImageName}
        $FWImg = Get-AzureVMImage | Where {$_.ImageFamily -match 'Barracuda NextGen Firewall'} | sort PublishedDate -Descending | Select ImageName -First 1 | ForEach {$_.ImageName}

      # UDR Details
        $FERouteTableName = "FrontEndSubnetRouteTable"
        $BERouteTableName = "BackEndSubnetRouteTable"

      # NSG Details
        $NSGName = "MyVNetSG"

    # User Defined VM Specific Config
        # Note: tooensure UDR and IP forwarding is setup
        # properly this script requires VM 0 be hello NVA.

        # VM 0 - hello Network Virtual Appliance (NVA)
          $VMName += "myFirewall"
          $ServiceName += $SecureService
          $VMFamily += "Firewall"
          $img += $FWImg
          $size += "Small"
          $SubnetName += $SecNet
          $VMIP += "10.0.0.4"

        # VM 1 - hello Web Server
          $VMName += "IIS01"
          $ServiceName += $FrontEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $FESubnet
          $VMIP += "10.0.1.4"

        # VM 2 - hello First Appliaction Server
          $VMName += "AppVM01"
          $ServiceName += $BackEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $BESubnet
          $VMIP += "10.0.2.5"

        # VM 3 - hello Second Appliaction Server
          $VMName += "AppVM02"
          $ServiceName += $BackEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $BESubnet
          $VMIP += "10.0.2.6"

        # VM 4 - hello DNS Server
          $VMName += "DNS01"
          $ServiceName += $BackEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $BESubnet
          $VMIP += "10.0.2.4"

    # ----------------------------- #
    # No User Defined Varibles or   #
    # Configuration past this point #
    # ----------------------------- #

      # Get your Azure accounts
        Add-AzureAccount
        Set-AzureSubscription –SubscriptionId $subID -ErrorAction Stop
        Select-AzureSubscription -SubscriptionId $subID -Current -ErrorAction Stop

      # Create Storage Account
        If (Test-AzureName -Storage -Name $StorageAccountName) { 
            Write-Host "Fatal Error: This storage account name is already in use, please pick a diffrent name." -ForegroundColor Red
            Return}
        Else {Write-Host "Creating Storage Account" -ForegroundColor Cyan 
              New-AzureStorageAccount -Location $DeploymentLocation -StorageAccountName $StorageAccountName}

      # Update Subscription Pointer tooNew Storage Account
        Write-Host "Updating Subscription Pointer tooNew Storage Account" -ForegroundColor Cyan 
        Set-AzureSubscription –SubscriptionId $subID -CurrentStorageAccountName $StorageAccountName -ErrorAction Stop

    # Validation
    $FatalError = $false

    If (-Not (Get-AzureLocation | Where {$_.DisplayName -eq $DeploymentLocation})) {
         Write-Host "This Azure Location was not found or available for use" -ForegroundColor Yellow
         $FatalError = $true}

    If (Test-AzureName -Service -Name $SecureService) { 
        Write-Host "hello SecureService service name is already in use, please pick a different service name." -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "hello FrontEndService service name is valid for use." -ForegroundColor Green}

    If (Test-AzureName -Service -Name $FrontEndService) { 
        Write-Host "hello FrontEndService service name is already in use, please pick a different service name." -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "hello FrontEndService service name is valid for use" -ForegroundColor Green}

    If (Test-AzureName -Service -Name $BackEndService) { 
        Write-Host "hello BackEndService service name is already in use, please pick a different service name." -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "hello BackEndService service name is valid for use." -ForegroundColor Green}

    If (-Not (Test-Path $NetworkConfigFile)) { 
        Write-Host 'hello network config file was not found, please update hello $NetworkConfigFile variable toopoint toohello network config xml file.' -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "hello network config file was found" -ForegroundColor Green
            If (-Not (Select-String -Pattern $DeploymentLocation -Path $NetworkConfigFile)) {
                Write-Host 'hello deployment location was not found in hello network config file, please check hello network config file tooensure hello $DeploymentLocation varible is correct and hello netowrk config file matches.' -ForegroundColor Yellow
                $FatalError = $true}
            Else { Write-Host "hello deployment location was found in hello network config file." -ForegroundColor Green}}

    If ($FatalError) {
        Write-Host "A fatal error has occured, please see hello above messages for more information." -ForegroundColor Red
        Return}
    Else { Write-Host "Validation passed, now building hello environment." -ForegroundColor Green}

    # Create VNET
        Write-Host "Creating VNET" -ForegroundColor Cyan 
        Set-AzureVNetConfig -ConfigurationPath $NetworkConfigFile -ErrorAction Stop

    # Create Services
        Write-Host "Creating Services" -ForegroundColor Cyan
        New-AzureService -Location $DeploymentLocation -ServiceName $SecureService -ErrorAction Stop
        New-AzureService -Location $DeploymentLocation -ServiceName $FrontEndService -ErrorAction Stop
        New-AzureService -Location $DeploymentLocation -ServiceName $BackEndService -ErrorAction Stop

    # Build VMs
        $i=0
        $VMName | Foreach {
            Write-Host "Building $($VMName[$i])" -ForegroundColor Cyan
            If ($VMFamily[$i] -eq "Firewall") 
                { 
                New-AzureVMConfig -Name $VMName[$i] -ImageName $img[$i] –InstanceSize $size[$i] | `
                    Add-AzureProvisioningConfig -Linux -LinuxUser $LocalAdmin -Password $LocalAdminPwd  | `
                    Set-AzureSubnet  –SubnetNames $SubnetName[$i] | `
                    Set-AzureStaticVNetIP -IPAddress $VMIP[$i] | `
                    New-AzureVM –ServiceName $ServiceName[$i] -VNetName $VNetName -Location $DeploymentLocation
                # Set up all hello EndPoints we'll need once we're up and running
                # Note: All traffic goes through hello firewall, so we'll need tooset up all ports here.
                #       Also, hello firewall will be redirecting traffic tooa new IP and Port in a forwarding
                #       rule, so all of these endpoint have hello same public and local port and hello firewall
                #       will do hello mapping, NATing, and/or redirection as declared in hello firewall rules.
                Add-AzureEndpoint -Name "MgmtPort1" -Protocol tcp -PublicPort 801  -LocalPort 801  -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "MgmtPort2" -Protocol tcp -PublicPort 807  -LocalPort 807  -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "HTTP"      -Protocol tcp -PublicPort 80   -LocalPort 80   -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPWeb"    -Protocol tcp -PublicPort 8014 -LocalPort 8014 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPApp1"   -Protocol tcp -PublicPort 8025 -LocalPort 8025 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPApp2"   -Protocol tcp -PublicPort 8026 -LocalPort 8026 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPDNS01"  -Protocol tcp -PublicPort 8024 -LocalPort 8024 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                # Note: A SSH endpoint is automatically created on port 22 when hello appliance is created.
                }
            Else
                {
                New-AzureVMConfig -Name $VMName[$i] -ImageName $img[$i] –InstanceSize $size[$i] | `
                    Add-AzureProvisioningConfig -Windows -AdminUsername $LocalAdmin -Password $LocalAdminPwd  | `
                    Set-AzureSubnet  –SubnetNames $SubnetName[$i] | `
                    Set-AzureStaticVNetIP -IPAddress $VMIP[$i] | `
                    Set-AzureVMMicrosoftAntimalwareExtension -AntimalwareConfiguration '{"AntimalwareEnabled" : true}' | `
                    Remove-AzureEndpoint -Name "RemoteDesktop" | `
                    Remove-AzureEndpoint -Name "PowerShell" | `
                    New-AzureVM –ServiceName $ServiceName[$i] -VNetName $VNetName -Location $DeploymentLocation
                }
            $i++
        }

    # Configure UDR and IP Forwarding
        Write-Host "Configuring UDR" -ForegroundColor Cyan

      # Create hello Route Tables
        Write-Host "Creating hello Route Tables" -ForegroundColor Cyan 
        New-AzureRouteTable -Name $BERouteTableName `
            -Location $DeploymentLocation `
            -Label "Route table for $BESubnet subnet"
        New-AzureRouteTable -Name $FERouteTableName `
            -Location $DeploymentLocation `
            -Label "Route table for $FESubnet subnet"

      # Add Routes tooRoute Tables
        Write-Host "Adding Routes toohello Route Tables" -ForegroundColor Cyan 
        Get-AzureRouteTable $BERouteTableName `
            |Set-AzureRoute -RouteName "All traffic tooFW" -AddressPrefix 0.0.0.0/0 `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $BERouteTableName `
            |Set-AzureRoute -RouteName "Internal traffic tooFW" -AddressPrefix $VNetPrefix `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $BERouteTableName `
            |Set-AzureRoute -RouteName "Allow Intra-Subnet Traffic" -AddressPrefix $BEPrefix `
            -NextHopType VNETLocal
        Get-AzureRouteTable $FERouteTableName `
            |Set-AzureRoute -RouteName "All traffic tooFW" -AddressPrefix 0.0.0.0/0 `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $FERouteTableName `
            |Set-AzureRoute -RouteName "Internal traffic tooFW" -AddressPrefix $VNetPrefix `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $FERouteTableName `
            |Set-AzureRoute -RouteName "Allow Intra-Subnet Traffic" -AddressPrefix $FEPrefix `
            -NextHopType VNETLocal

      # Assoicate hello Route Tables with hello Subnets
        Write-Host "Binding Route Tables toohello Subnets" -ForegroundColor Cyan 
        Set-AzureSubnetRouteTable -VirtualNetworkName $VNetName `
            -SubnetName $BESubnet `
            -RouteTableName $BERouteTableName
        Set-AzureSubnetRouteTable -VirtualNetworkName $VNetName `
            -SubnetName $FESubnet `
            -RouteTableName $FERouteTableName

     # Enable IP Forwarding on hello Virtual Appliance
        Get-AzureVM -Name $VMName[0] -ServiceName $ServiceName[0] `
            |Set-AzureIPForwarding -Enable

    # Configure NSG
        Write-Host "Configuring hello Network Security Group (NSG)" -ForegroundColor Cyan

      # Build hello NSG
        Write-Host "Building hello NSG" -ForegroundColor Cyan
        New-AzureNetworkSecurityGroup -Name $NSGName -Location $DeploymentLocation -Label "Security group for $VNetName subnets in $DeploymentLocation"

      # Add NSG Rule
        Write-Host "Writing rules into hello NSG" -ForegroundColor Cyan
        Get-AzureNetworkSecurityGroup -Name $NSGName | Set-AzureNetworkSecurityRule -Name "Isolate hello $VNetName VNet from hello Internet" -Type Inbound -Priority 100 -Action Deny `
            -SourceAddressPrefix INTERNET -SourcePortRange '*' `
            -DestinationAddressPrefix VIRTUAL_NETWORK -DestinationPortRange '*' `
            -Protocol *

      # Assign hello NSG tootwo Subnets
        # hello NSG is *not* bound toohello Security Subnet. hello result
        # is that internet traffic flows only toohello Security subnet
        # since hello NSG bound toohello Frontend and Backback subnets
        # will Deny internet traffic toothose subnets.
        Write-Host "Binding hello NSG tootwo subnets" -ForegroundColor Cyan
        Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName -SubnetName $FESubnet -VirtualNetworkName $VNetName
        Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName -SubnetName $BESubnet -VirtualNetworkName $VNetName

    # Optional Post-script Manual Configuration
      # Configure Firewall
      # Install Test Web App (Run Post-Build Script on hello IIS Server)
      # Install Backend resource (Run Post-Build Script on hello AppVM01)
      Write-Host
      Write-Host "Build Complete!" -ForegroundColor Green
      Write-Host
      Write-Host "Optional Post-script Manual Configuration Steps" -ForegroundColor Gray
      Write-Host " - Configure Firewall" -ForegroundColor Gray
      Write-Host " - Install Test Web App (Run Post-Build Script on hello IIS Server)" -ForegroundColor Gray
      Write-Host " - Install Backend resource (Run Post-Build Script on hello AppVM01)" -ForegroundColor Gray
      Write-Host


#### <a name="network-config-file"></a>Файл конфигурации сети
Сохраните этот файл xml с новое местоположение и добавьте ссылку toothis hello файл toohello $NetworkConfigFile переменной в представленном выше сценарии hello.

    <NetworkConfiguration xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://schemas.microsoft.com/ServiceHosting/2011/07/NetworkConfiguration">
      <VirtualNetworkConfiguration>
        <Dns>
          <DnsServers>
            <DnsServer name="DNS01" IPAddress="10.0.2.4" />
            <DnsServer name="Level3" IPAddress="209.244.0.3" />
          </DnsServers>
        </Dns>
        <VirtualNetworkSites>
          <VirtualNetworkSite name="CorpNetwork" Location="Central US">
            <AddressSpace>
              <AddressPrefix>10.0.0.0/16</AddressPrefix>
            </AddressSpace>
            <Subnets>
              <Subnet name="SecNet">
                <AddressPrefix>10.0.0.0/24</AddressPrefix>
              </Subnet>
              <Subnet name="FrontEnd">
                <AddressPrefix>10.0.1.0/24</AddressPrefix>
              </Subnet>
              <Subnet name="BackEnd">
                <AddressPrefix>10.0.2.0/24</AddressPrefix>
              </Subnet>
            </Subnets>
            <DnsServersRef>
              <DnsServerRef name="DNS01" />
              <DnsServerRef name="Level3" />
            </DnsServersRef>
          </VirtualNetworkSite>
        </VirtualNetworkSites>
      </VirtualNetworkConfiguration>
    </NetworkConfiguration>

#### <a name="sample-application-scripts"></a>Сценарии примера приложения
При желании tooinstall образец приложения для этого и других примерах DMZ, оно предоставлено в hello по ссылке: [образец приложения скрипта][SampleApp]

<!--Image References-->
[1]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/example3design.png "Двунаправленная сеть периметра с виртуальным сетевым устройством, группой безопасности сети и определяемыми пользователем маршрутами"
[2]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/example3firewalllogical.png "Логическое представление hello правила брандмауэра"
[3]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectfrontend.png "Создание сетевого объекта FrontEnd"
[4]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectdns.png "Создание объекта DNS-сервера"
[5]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectrdpa.png "Копия правила RDP по умолчанию"
[6]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectrdpb.png "Правило AppVM01"
[7]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/iconapplicationredirect.png "Значок перенаправления приложения"
[8]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/icondestinationnat.png "Значок NAT назначения"
[9]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/iconpass.png "Значок передачи"
[10]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/rulefirewall.png "Правило управления брандмауэром"
[11]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/rulerdp.png "Правило RDP брандмауэра"
[12]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleweb.png "Правило Интернета брандмауэра"
[13]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleappvm01.png "Правило AppVM01 брандмауэра"
[14]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleoutbound.png "Правило исходящего трафика брандмауэра"
[15]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruledns.png "Правило DNS брандмауэра"
[16]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleintravnet.png "Правило брандмауэра для внутреннего трафика виртуальной сети"
[17]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruledeny.png "Правило запрета брандмауэра"
[18]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/firewallruleactivate.png "Активация правила брандмауэра"

<!--Link References-->
[HOME]: ../best-practices-network-security.md
[SampleApp]: ./virtual-networks-sample-app.md

---
title: "Гибридное подключение с помощью 2-уровневого приложения | Документация Майкрософт"
description: "Узнайте, как развернуть виртуальные устройства и определяемые пользователем маршруты, чтобы создать среду многоуровневого приложения в Azure"
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 544ba6484b23da425d53594622122b1e18b92359
ms.sourcegitcommit: e5355615d11d69fc8d3101ca97067b3ebb3a45ef
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/31/2017
---
# <a name="virtual-appliance-scenario"></a>Сценарий использования виртуальных устройств
Среди преимущественного количества клиентов Azure распространен сценарий, в котором нужно предоставить двухуровневое приложение, доступное из Интернета, и при этом также доступ к внутреннему уровню из локального центра данных. В этом документе подробно описан сценарий, где используются определяемые пользователем маршруты, VPN-шлюз и виртуальные сетевые устройства для развертывания двухуровневой среды, отвечающей следующим требованиям:

* Веб-приложение должно быть доступно только через общедоступное интернет-подключение.
* На веб-сервере, на котором размещено приложение, должен быть доступ к внутреннему серверу приложений.
* Весь трафик, передаваемый из Интернета в веб-приложение, должен проходить через виртуальное устройство брандмауэра. Это виртуальное устройство будет использоваться для приема трафика только из Интернета.
* Весь трафик, передаваемый на сервер приложения, должен проходить через виртуальное устройство брандмауэра. Это виртуальное устройство будет использоваться для получения доступа к внутреннему тыловому серверу и для подключения из локальной сети через VPN-шлюз.
* У администраторов должна быть возможность управлять виртуальными устройствами брандмауэров с локальных компьютеров с использованием промежуточного виртуального устройства брандмауэра, предназначенного исключительно для управления.

Это стандартный сценарий сети периметра, где используется также защищенная сеть. Такие сценарии можно реализовать в Azure, используя группы безопасности сети (NSG), виртуальные устройства брандмауэров или их сочетание. В следующей таблице приведены преимущества и недостатки NSG и виртуальных устройств брандмауэров.

|  | Преимущества | Недостатки |
| --- | --- | --- |
| Группа безопасности сети (NSG) |Бесплатное использование. <br/>Интегрирована в управление доступом на основе ролей (RBAC). <br/>Правила можно создавать в шаблонах ARM. |В больших средах сложность может меняться. |
| Брандмауэр |Полный контроль над плоскостью данных. <br/>Централизованное управление через консоль брандмауэра. |За использование устройства брандмауэра взимается плата. <br/>Не интегрирован с RBAC Azure. |

В описанном ниже решении используются виртуальные устройства брандмауэров, чтобы реализовать сценарий с сетью периметра и защищенной сетью.

## <a name="considerations"></a>Рекомендации
Вы можете развернуть описанную выше среду в Azure, используя различные современные возможности, указанные ниже.

* **Виртуальная сеть**. Виртуальная сеть Azure работает аналогично локальной сети. Ее можно разделить на одну или несколько подсетей, чтобы изолировать трафик и разделить области распространения проблем.
* **Виртуальное устройство**. В Azure Marketplace некоторые партнеры предоставляют виртуальные устройства, которые можно использовать для трех брандмауэров, описанных выше. 
* **Определяемые пользователем маршруты**. Таблицы маршрутов могут содержать определяемые пользователем маршруты, используемые в сети Azure для контроля потока передачи пакетов в виртуальной сети. Эти таблицы маршрутов можно использовать в подсетях. Одна из новых возможностей Azure — применение таблиц маршрутов к GatewaySubnet. Это позволяет перенаправлять весь трафик, передаваемый в виртуальную сеть Azure из гибридного подключения, на виртуальное устройство.
* **IP-пересылка**. По умолчанию сетевой механизм Azure пересылает пакеты на сетевые карты в виртуальной сети, только если IP-адрес назначения соответствует IP-адресу сетевой карты. Следовательно, если согласно определенному пользователем маршруту пакеты нужно отправить на заданное виртуальное устройство, сетевой механизм Azure удалит их. Чтобы обеспечить доставку пакета на виртуальную машину (в этом случае — на виртуальное устройство), которая в действительности не является местом назначения пакета, на виртуальном устройстве нужно включить IP-пересылку.
* **Группы безопасности сети**. В примере, приведенном ниже, не используются NSG, но вы можете использовать группы, применяемые к подсети или сетевым адаптерам в этом решении, чтобы в дальнейшем фильтровать входящий и исходящий трафик этих подсетей и сетевых карт.

![Подключение по протоколу IPv6](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

В этом примере используется подписка, которая содержит такие компоненты:

* Две группы ресурсов, которые не показаны на схеме. 
  * **ONPREMRG**. содержит все ресурсы, необходимые для моделирования локальной сети.
  * **AZURERG**. содержит все ресурсы, необходимые для среды виртуальной сети Azure. 
* Виртуальная сеть с именем **onpremvnet** используется для моделирования локального центра обработки данных и разделена на сегменты, перечисленные ниже.
  * **onpremsn1**. подсеть, в которой работает виртуальная машина под управлением Ubuntu для моделирования локального сервера.
  * **onpremsn2**. подсеть, в которой работает виртуальная машина под управлением Ubuntu для моделирования локального компьютера администратора.
* Одно виртуальное устройство брандмауэра с именем **OPFW** в **onpremvnet**, используемое для работы туннеля к **azurevnet**.
* Виртуальная сеть с именем **azurevnet** , разделенная на сегменты, перечисленные ниже.
  * **azsn1**. подсеть внешнего брандмауэра, которая используется исключительно для работы соответствующего брандмауэра. Через эту подсеть будет проходить весь интернет-трафик. В ней содержится только сетевой адаптер, связанный с внешним брандмауэром.
  * **azsn2**. внешняя подсеть, где размещена виртуальная машина, работающая в качестве веб-сервера, который будет доступен через Интернет.
  * **azsn3**. внутренняя подсеть, где размещена виртуальная машина, работающая в качестве внутреннего сервера приложений, который будет доступен веб-серверу переднего плана.
  * **azsn4**. подсеть управления, используемая исключительно для обеспечения доступа для управления ко всем виртуальным устройствам брандмауэров. В этой подсети содержатся только сетевые карты каждого виртуального устройства брандмауэра, используемого в решении.
  * **GatewaySubnet**. подсеть гибридного подключения, необходимая для ExpressRoute и VPN-шлюза, чтобы обеспечивать связь между виртуальными сетями Azure и другими сетями. 
* В сети **azurevnet** используются три виртуальных устройства брандмауэров. 
  * **AZF1**. внешний брандмауэр, доступный через общедоступное интернет-подключение с использованием ресурса с общедоступным IP-адресом в Azure. Вам необходимо получить шаблон, который может подготовить виртуальное устройство с тремя сетевыми адаптерами, в Marketplace или напрямую у поставщика устройства.
  * **AZF2**. Внутренний брандмауэр для контроля трафика между **azsn2** и **azsn3**. Это виртуальное устройство также обладает тремя сетевыми адаптерами.
  * **AZF3**. брандмауэр управления, доступный администраторам в локальном центре обработки данных и подключенный к подсети управления, которая используется для управления всеми устройствами брандмауэров. Шаблоны виртуальных устройств с двумя сетевыми картами можно найти в Marketplace или запросить напрямую у поставщика устройства.

## <a name="user-defined-routing-udr"></a>Определяемые пользователем маршруты
Любую подсеть в Azure можно связать с таблицей определяемых пользователем маршрутов, используемой для определения маршрута инициируемого трафика в подсети. Если эти маршруты не определены, Azure использует маршруты по умолчанию, чтобы разрешить передачу трафика из одной подсети в другую. Чтобы лучше понять, как работают определяемые пользователем маршруты, см. статью [Что такое определяемые пользователем маршруты и IP-пересылка?](virtual-networks-udr-overview.md)

Чтобы убедиться, что для взаимодействия используется правильное устройство брандмауэра, на основе последних требований, приведенных выше, необходимо создать следующую таблицу маршрутов с определяемыми пользователем маршрутами в **azurevnet**.

### <a name="azgwudr"></a>azgwudr
В этом сценарии для управления брандмауэрами будет использоваться только трафик, передающийся из локальной сети в Azure, путем подключения к **AZF3**, и этот трафик должен проходить через внутренний брандмауэр **AZF2**. Следовательно, для **GatewaySubnet** необходим только один маршрут, как показано ниже.

| Место назначения | Следующий прыжок | Пояснение |
| --- | --- | --- |
| 10.0.4.0/24 |10.0.3.11 |Разрешает передачу трафика из локальной сети на брандмауэр управления **AZF3** |

### <a name="azsn2udr"></a>azsn2udr
| Место назначения | Следующий прыжок | Пояснение |
| --- | --- | --- |
| 10.0.3.0/24 |10.0.2.11 |Разрешает передачу трафика во внутреннюю подсеть, в которой находится сервер приложения, через **AZF2** |
| 0.0.0.0/0 |10.0.2.10 |Разрешает передачу всего остального трафика через **AZF1** |

### <a name="azsn3udr"></a>azsn3udr
| Место назначения | Следующий прыжок | Пояснение |
| --- | --- | --- |
| 10.0.2.0/24 |10.0.3.10 |Разрешает передачу трафика в **azsn2** с сервера приложения на веб-сервер через **AZF2** |

Необходимо также создать таблицы маршрутов для подсетей в **onpremvnet** , чтобы смоделировать локальный центр обработки данных.

### <a name="onpremsn1udr"></a>onpremsn1udr
| Место назначения | Следующий прыжок | Пояснение |
| --- | --- | --- |
| 192.168.2.0/24 |192.168.1.4 |Разрешает передачу трафика в **onpremsn2** через **OPFW** |

### <a name="onpremsn2udr"></a>onpremsn2udr
| Место назначения | Следующий прыжок | Пояснение |
| --- | --- | --- |
| 10.0.3.0/24 |192.168.2.4 |Разрешает передачу трафика во внутреннюю подсеть в Azure через **OPFW** |
| 192.168.1.0/24 |192.168.2.4 |Разрешает передачу трафика в **onpremsn1** через **OPFW** |

## <a name="ip-forwarding"></a>IP-пересылку
Определяемые пользователем маршруты и IP-пересылка — это функции, которые можно применять вместе, чтобы обеспечить возможность использовать виртуальные устройства для управления потоком передачи трафика в виртуальной сети Azure.  Виртуальное устройство — это просто виртуальная машина, которая запускает приложение, используемое для обработки сетевого трафика определенным образом, например, как брандмауэр или устройство NAT.

Эта виртуальная машина виртуального устройства должна иметь возможность получать входящий трафик, предназначенный не ей. Чтобы разрешить виртуальной машине получать трафик, направленный по другим назначениям, для нее необходимо включить IP-пересылку. Это нужно сделать в среде Azure, а не в операционной системе на виртуальной машине. На виртуальном устройстве в любом случае должно работать какое-нибудь приложение, обрабатывающее входящий трафик и определяющее его маршрут соответствующим образом.

Дополнительные сведения об IP-пересылке см. в статье [Что такое определяемые пользователем маршруты и IP-пересылка?](virtual-networks-udr-overview.md)

Например, предположим, что в виртуальной сети Azure настроено следующее:

* В подсети **onpremsn1** есть виртуальная машина с именем **onpremvm1**.
* В подсети **onpremsn2** есть виртуальная машина с именем **onpremvm2**.
* Виртуальное устройство с именем **OPFW** подключено к **onpremsn1** и **onpremsn2**.
* Определяемый пользователем маршрут, связанный с **onpremsn1**, указывает, что весь трафик **onpremsn2** должен отправляться на **OPFW**.

На этом этапе, если **onpremvm1** попытается установить подключение к **onpremvm2**, будет использоваться определяемый пользователем маршрут и трафик будет отправляться на **OPFW** в рамках следующего прыжка. Помните, что фактический адрес назначения пакета не изменится. Им по-прежнему будет адрес **onpremvm2**. 

Если не включить поддержку IP-пересылки для **OPFW**, согласно логике виртуальной сети Azure пакеты будут удаляться, так как она позволяет передавать пакеты на виртуальные машины, если IP-адрес виртуальной машины является IP-адресом назначения пакета.

Если IP-пересылка включена, согласно логике виртуальной сети Azure пакеты будут пересылаться OPFW без изменения исходного адреса назначения. **OPFW** должно обрабатывать пакеты и определять действия, которые следует с ними выполнять.

Чтобы выполнить сценарий, описанный выше, необходимо включить IP-пересылку на сетевых адаптерах для **OPFW**, **AZF1**, **AZF2** и **AZF3**, которые используются для маршрутизации (на всех сетевых картах, кроме тех, которые связаны с подсетью управления). 

## <a name="firewall-rules"></a>Правила брандмауэра
Как описано выше, IP-пересылка только гарантирует, что пакеты будут отправляться на виртуальные устройства. На устройствах все равно необходимо определять, что делать с этими пакетами. В сценарии выше на устройствах нужно создать следующие правила:

### <a name="opfw"></a>OPFW
OPFW — это локальное устройство со следующими правилами:

* **Маршрут**. Весь трафик, отправляемый по адресу 10.0.0.0/16 (**azurevnet**), должен проходить через туннель **ONPREMAZURE**.
* **Политика**. Разрешите передачу любого двунаправленного трафика между **port2** и **ONPREMAZURE**.

### <a name="azf1"></a>AZF1
AZF1 — это виртуальное устройство Azure со следующими правилами:

* **Политика**. Разрешите передачу любого двунаправленного трафика между **port1** и **port2**.

### <a name="azf2"></a>AZF2
AZF2 — это виртуальное устройство Azure со следующими правилами:

* **Маршрут**. Весь трафик, отправляемый по адресу 10.0.0.0/16 (**onpremvnet**), должен отправляться по IP-адресу шлюза Azure (т. е. 10.0.0.1) через **port1**.
* **Политика**. Разрешите передачу любого двунаправленного трафика между **port1** и **port2**.

## <a name="network-security-groups-nsgs"></a>Группы безопасности сети (NSG)
В этом сценарии не используются NSG. Тем не менее NSG можно применить для каждой подсети, чтобы ограничить входящий и исходящий трафик. Например, можно применить следующие правила NSG ко внешней подсети брандмауэра.

**Входящий трафик**

* Разрешите передачу любого трафика TCP из Интернета на порт 80 для всех виртуальных машин в подсети.
* Запретите получение всего остального трафика из Интернета.

**Исходящий трафик**

* Запретите передачу трафика в Интернет.

## <a name="high-level-steps"></a>Шаги высокого уровня
Чтобы развернуть этот сценарий, выполните следующие основные шаги.

1. Войдите в подписку Azure.
2. Если вы хотите развернуть виртуальную сеть, чтобы смоделировать локальную сеть, подготовьте к работе ресурсы, которые являются частью **ONPREMRG**.
3. Подготовьте к работе ресурсы, которые являются частью **AZURERG**.
4. Подготовьте туннель из **onpremvnet** к **azurevnet**.
5. После подготовки всех ресурсов войдите в **onpremvm2** и проверьте связь с адресом 10.0.3.101, чтобы проверить подключение между **onpremsn2** и **azsn3**.


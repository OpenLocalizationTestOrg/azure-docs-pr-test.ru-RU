---
title: "подключение aaaHybrid с 2-уровневое приложение | Документы Microsoft"
description: "Узнайте, как toodeploy виртуальных устройств и UDR toocreate среде многоуровневого приложения в Azure"
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 53599862289dbf9c6ab3289b0cb8dda6430f20f7
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="virtual-appliance-scenario"></a>Сценарий использования виртуальных устройств
Распространенным сценарием среди большего клиента Azure является tooprovide необходимость hello двухуровневом приложении предоставляется toohello Интернета, предоставляя назад уровень доступа к toohello из центра обработки данных в локальной. Этот документ поможет вам выполнить сценарий, используя определенные маршруты пользователя (UDR), VPN-шлюз и toodeploy виртуальных устройств сети двухуровневой среде, соответствующей hello следующие требования:

* Веб-приложения должны быть доступны из hello только общедоступный Интернет.
* Приложение hello размещения веб-сервера должен быть доступ tooaccess внутреннего сервера приложений.
* Весь трафик от hello Internet toohello веб-приложение должно пройти через брандмауэр виртуального устройства. Это виртуальное устройство будет использоваться для приема трафика только из Интернета.
* Весь трафик, передаваемый server приложения toohello должны проходить через брандмауэр виртуального устройства. Это виртуальное устройство будет использоваться для доступа к toohello серверной части конечного сервера и доступ, поступающих из hello в локальной сети через VPN-шлюза.
* Администраторы должны быть виртуальных устройств может toomanage hello брандмауэра с локальных компьютеров, с помощью третьей брандмауэра виртуального устройства, используется исключительно для целей управления.

Это стандартный сценарий сети периметра, где используется также защищенная сеть. Такие сценарии можно реализовать в Azure, используя группы безопасности сети (NSG), виртуальные устройства брандмауэров или их сочетание. в следующей таблице Hello показаны некоторые hello преимуществ и недостатков между Nsg и брандмауэра виртуальных устройств.

|  | Преимущества | Недостатки |
| --- | --- | --- |
| Группа безопасности сети (NSG) |Бесплатное использование. <br/>Интегрирована в управление доступом на основе ролей (RBAC). <br/>Правила можно создавать в шаблонах ARM. |В больших средах сложность может меняться. |
| Брандмауэр |Полный контроль над плоскостью данных. <br/>Централизованное управление через консоль брандмауэра. |За использование устройства брандмауэра взимается плата. <br/>Не интегрирован с RBAC Azure. |

приведенное ниже решение Hello использует tooimplement виртуальных приборов брандмауэра сценарий DMZ/защищенные сети.

## <a name="considerations"></a>Рекомендации
Вы можете развернуть среду hello, описанные выше, в Azure с помощью различные функции, доступные в настоящее время, как показано ниже.

* **Виртуальная сеть**. Виртуальной сети Azure действует аналогично манере tooan локальной сети и может быть разбито на один или несколько подсетей tooprovide и изоляции трафика, разделение областей ответственности.
* **Виртуальное устройство**. Несколько партнеров предоставляют виртуальных устройств в hello Azure Marketplace, который может использоваться для hello три брандмауэров, описанных выше. 
* **Определяемые пользователем маршруты**. Таблицы маршрутов может содержать UDRs, используемые потоком Azure сети toocontrol hello пакетов в виртуальной сети. Эти таблицы маршрутизации может быть применен toosubnets. Одной из новых функций hello в Azure является возможность hello tooapply toohello таблицы маршрутов GatewaySubnet, предоставляя возможность tooforward hello весь трафик, поступающий на hello виртуальной сети Azure с виртуального устройства tooa гибридного подключения.
* **IP-пересылка**. По умолчанию hello Azure сети механизм пересылки пакетов toovirtual сетевых интерфейсных плат (NIC) только в том случае, если hello Сетевых IP-адрес соответствует IP-адрес назначения пакетов hello. Таким образом Если UDR определяет, что пакет должен tooa получает виртуальное устройство, hello Azure подсистемы сети уменьшится пакета. пакет tooensure hello доставляется tooa виртуальной Машины (в данном случае виртуального устройства), не hello фактическое место назначения для hello пакета, необходимо tooenable IP-пересылки для hello виртуального устройства.
* **Группы безопасности сети**. пример Hello не пользоваться Nsg, но может использовать Nsg применяется toohello подсети и (или) сетевых адаптеров в это решение toofurther фильтрации hello трафика и из него этих подсетей и сетевых адаптеров.

![Подключение по протоколу IPv6](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

В этом примере имеется подписка, содержащий hello следующее:

* 2 групп ресурсов, не отображаются в схеме hello. 
  * **ONPREMRG**. Содержит все необходимые toosimulate ресурсы локальной сети.
  * **AZURERG**. Содержит все ресурсы, необходимые для среды hello виртуальной сети Azure. 
* Виртуальная сеть с именем **onpremvnet** используется toomimic локального центра обработки данных в сегментированных приведенные ниже.
  * **onpremsn1**. Подсеть, содержащая виртуальной машины (VM) на локальном сервере под управлением Ubuntu toomimic.
  * **onpremsn2**. Подсеть, содержащая виртуальная машина, работающая на локальном компьютере, администратор Ubuntu toomimic.
* Имеется одно виртуальное устройство брандмауэра с именем **OPFW** на **onpremvnet** используется toomaintain туннель слишком**azurevnet**.
* Виртуальная сеть с именем **azurevnet** , разделенная на сегменты, перечисленные ниже.
  * **azsn1**. Внешний брандмауэр подсети, используемой исключительно для hello внешнего брандмауэра. Через эту подсеть будет проходить весь интернет-трафик. Эта подсеть содержит только внешний брандмауэр toohello сетевой Адаптер связан.
  * **azsn2**. Размещение виртуальная машина, работающая как веб-сервер, который будет доступен из Интернета hello подсети переднего плана.
  * **azsn3**. Размещение виртуальная машина, работающая внутреннего сервера приложений, будут доступны для веб-сервере переднего плана hello подсети серверной части.
  * **azsn4**. Подсеть управления используется исключительно tooprovide управления доступом tooall брандмауэра виртуальных устройств. Эта подсеть содержит только сетевой КАРТЫ для каждого виртуального устройства брандмауэра, используемые в решении hello.
  * **GatewaySubnet**. Подсеть подключения гибридной Azure требуется для шлюза VPN и ExpressRoute tooprovide подключением виртуальных сетей Azure и другими сетями. 
* Существует 3 виртуальных приборов брандмауэра в hello **azurevnet** сети. 
  * **AZF1**. Внешний брандмауэр предоставляется toohello общедоступный Интернет с помощью открытого ресурса IP-адреса в Azure. Необходимо tooensure имеется шаблон из hello Marketplace или непосредственно от поставщика устройства, которая подготавливает виртуального устройства 3 Сетевыми.
  * **AZF2**. Внутренним брандмауэром используется toocontrol трафик между **azsn2** и **azsn3**. Это виртуальное устройство также обладает тремя сетевыми адаптерами.
  * **AZF3**. Доступный tooadministrators управления брандмауэра из hello локального центра обработки данных и подсеть управления подключенной tooa использовать toomanage все аппаратные брандмауэры. Можно найти сетевой Адаптер 2 шаблоны виртуального устройства в hello Marketplace, или запросить непосредственно с поставщиком устройства.

## <a name="user-defined-routing-udr"></a>Определяемые пользователем маршруты
Каждой подсети в Azure может быть таблица, используемая связанного tooa UDR toodefine с маршрутизацией трафик, отправленный в этой подсети. При определении не UDRs Azure использует tooflow трафика tooallow маршруты по умолчанию из одной подсети tooanother. toobetter понять UDRs, посетите [Каковы определяемых пользователем маршрутов и IP-пересылка](virtual-networks-udr-overview.md#ip-forwarding).

tooensure обмен данными осуществляется с помощью устройства hello правильный брандмауэр на основе требований последнего hello выше, вы должны toocreate hello следующие таблицы маршрутов, содержащий UDRs в **azurevnet**.

### <a name="azgwudr"></a>azgwudr
В этом сценарии hello только трафик из локальной tooAzure брандмауэры используется toomanage hello подключив слишком**AZF3**, и что трафик должен проходить через брандмауэр внутренней hello, **AZF2**. Таким образом, необходим только один маршрут в hello **GatewaySubnet** как показано ниже.

| Место назначения | Следующий прыжок | Пояснение |
| --- | --- | --- |
| 10.0.4.0/24 |10.0.3.11 |Позволяет локальным трафика tooreach управления брандмауэра **AZF3** |

### <a name="azsn2udr"></a>azsn2udr
| Место назначения | Следующий прыжок | Пояснение |
| --- | --- | --- |
| 10.0.3.0/24 |10.0.2.11 |Разрешает трафик toohello серверной подсети сервером приложения hello через **AZF2** |
| 0.0.0.0/0 |10.0.2.10 |Разрешает все трафика toobe, маршрутизируются через **AZF1** |

### <a name="azsn3udr"></a>azsn3udr
| Место назначения | Следующий прыжок | Пояснение |
| --- | --- | --- |
| 10.0.2.0/24 |10.0.3.10 |Разрешает трафик слишком**azsn2** tooflow из приложения веб-сервера toohello сервер через **AZF2** |

Требуется toocreate таблиц маршрутов для подсети hello в **onpremvnet** toomimic hello локального центра обработки данных.

### <a name="onpremsn1udr"></a>onpremsn1udr
| Место назначения | Следующий прыжок | Пояснение |
| --- | --- | --- |
| 192.168.2.0/24 |192.168.1.4 |Разрешает трафик слишком**onpremsn2** через **OPFW** |

### <a name="onpremsn2udr"></a>onpremsn2udr
| Место назначения | Следующий прыжок | Пояснение |
| --- | --- | --- |
| 10.0.3.0/24 |192.168.2.4 |Позволяет toohello резервного подсети трафика в Azure через **OPFW** |
| 192.168.1.0/24 |192.168.2.4 |Разрешает трафик слишком**onpremsn1** через **OPFW** |

## <a name="ip-forwarding"></a>IP-пересылку
UDR и IP-пересылка являются компонентами, которые можно использовать в сочетании tooallow виртуальных приборов используется toobe toocontrol передачу трафика в виртуальной сети Azure.  Виртуальное устройство — это ничто иное виртуальной Машины, которая запускает приложение, toohandle сетевой трафик определенным образом, например брандмауэром или устройством NAT.

Это виртуальное устройство виртуальной Машины, необходимо будет tooreceive входящий трафик, не рассматриваются tooitself. tooallow tooreceive трафика виртуальных Машин внимания tooother назначения, необходимо включить IP-пересылку для hello виртуальной Машины. Это политика, не соответствует hello гостевой ОС Azure. Ваш виртуального устройства по-прежнему потребностей toorun некоторые тип toohandle приложения hello входящего трафика и направить ее соответствующим образом.

Посетите toolearn Дополнительные сведения об IP-пересылки, [Каковы определяемых пользователем маршрутов и IP-пересылка](virtual-networks-udr-overview.md#ip-forwarding).

Например представьте, что у вас есть hello, после завершения программы установки в виртуальную сеть Azure:

* В подсети **onpremsn1** есть виртуальная машина с именем **onpremvm1**.
* В подсети **onpremsn2** есть виртуальная машина с именем **onpremvm2**.
* Виртуальное устройство с именем **OPFW** подключено слишком**onpremsn1** и **onpremsn2**.
* Слишком связанного маршрута определяемых пользователем**onpremsn1** указывает, что весь трафик слишком**onpremsn2** должны отправляться слишком**OPFW**.

В этот момент, если **onpremvm1** пытается tooestablish соединения с **onpremvm2**, hello UDR будет использоваться, и трафик будет отправляться слишком**OPFW** как hello следующего прыжка. Имейте в виду, что hello назначения фактические пакета не были изменены, по-прежнему отображается надпись **onpremvm2** hello местом назначения. 

Без IP-пересылка включена для **OPFW**, hello Azure виртуальные сети логику приведет к удалению приветственных пакетов, поскольку только tooa toobe отправленных пакетов виртуальных Машин позволяет Если hello IP-адрес Виртуальной машины — hello назначение для пакета hello.

С IP-пересылки hello логику виртуальной сети Azure будет пересылать tooOPFW пакетов hello, без изменения его исходный адрес назначения. **OPFW** должен обрабатывать пакеты приветствия и определить, какие toodo с ними.

Для сценария hello выше toowork, необходимо включить IP-пересылки на приветствия сетевых адаптеров для **OPFW**, **AZF1**, **AZF2**, и **AZF3** , которые используются для Маршрутизация (все сетевые адаптеры Кроме подсети управления связанного toohello hello из них). 

## <a name="firewall-rules"></a>Правила брандмауэра
Как описано выше, IP-пересылка только гарантирует, что пакеты отправляются toohello виртуальных устройств. Устройства по-прежнему должен toodecide какие toodo с этими пакетами. В приведенном выше сценарии hello вам потребуется hello toocreate согласно правилам, описанным в вашего устройства:

### <a name="opfw"></a>OPFW
OPFW представляет локальное устройство, содержащее hello правилам:

* **Маршрут**: весь трафик too10.0.0.0/16 (**azurevnet**) должны быть отправлены через туннель **ONPREMAZURE**.
* **Политика**. Разрешите передачу любого двунаправленного трафика между **port2** и **ONPREMAZURE**.

### <a name="azf1"></a>AZF1
AZF1 представляет Azure виртуальное устройство, содержащее hello правилам:

* **Политика**. Разрешите передачу любого двунаправленного трафика между **port1** и **port2**.

### <a name="azf2"></a>AZF2
AZF2 представляет Azure виртуальное устройство, содержащее hello правилам:

* **Маршрут**: весь трафик too10.0.0.0/16 (**onpremvnet**) должны быть отправлены toohello шлюз Azure в IP-адрес (т. е. 10.0.0.1) через **порта 1**.
* **Политика**. Разрешите передачу любого двунаправленного трафика между **port1** и **port2**.

## <a name="network-security-groups-nsgs"></a>Группы безопасности сети (NSG)
В этом сценарии не используются NSG. Тем не менее можно применить Nsg tooeach подсети toorestrict входящий и исходящий трафик. Для экземпляра можно применить следующие NSG правила toohello внешнюю подсеть, FW hello.

**Входящий трафик**

* Разрешить весь трафик TCP от Интернета hello tooport 80 на любой виртуальной Машине в подсети hello.
* Запретить весь трафик из Интернета hello.

**Исходящий трафик**

* Запретите все toohello трафик Интернета.

## <a name="high-level-steps"></a>Шаги высокого уровня
toodeploy этого сценария выполните hello шаги на высоком уровне ниже.

1. Tooyour входа подписки Azure.
2. Если требуется toodeploy hello toomimic виртуальной сети в локальной сети, подготовьте hello ресурсы, которые являются частью **ONPREMRG**.
3. Подготовить hello ресурсы, которые являются частью **AZURERG**.
4. Туннель hello подготовки из **onpremvnet** слишком**azurevnet**.
5. После подготовки всех ресурсов, войдите на слишком**onpremvm2** и ping 10.0.3.101 tootest соединение между **onpremsn2** и **azsn3**.


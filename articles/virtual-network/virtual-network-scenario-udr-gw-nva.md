---
title: "подключение aaaHybrid с 2-уровневое приложение | Документы Microsoft"
description: "Узнайте, как toodeploy виртуальных устройств и UDR toocreate среде многоуровневого приложения в Azure"
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 53599862289dbf9c6ab3289b0cb8dda6430f20f7
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="553f1-103">Сценарий использования виртуальных устройств</span><span class="sxs-lookup"><span data-stu-id="553f1-103">Virtual appliance scenario</span></span>
<span data-ttu-id="553f1-104">Распространенным сценарием среди большего клиента Azure является tooprovide необходимость hello двухуровневом приложении предоставляется toohello Интернета, предоставляя назад уровень доступа к toohello из центра обработки данных в локальной.</span><span class="sxs-lookup"><span data-stu-id="553f1-104">A common scenario among larger Azure customer is hello need tooprovide a two-tiered application exposed toohello Internet, while allowing access toohello back tier from an on-premises datacenter.</span></span> <span data-ttu-id="553f1-105">Этот документ поможет вам выполнить сценарий, используя определенные маршруты пользователя (UDR), VPN-шлюз и toodeploy виртуальных устройств сети двухуровневой среде, соответствующей hello следующие требования:</span><span class="sxs-lookup"><span data-stu-id="553f1-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances toodeploy a two-tier environment that meets hello following requirements:</span></span>

* <span data-ttu-id="553f1-106">Веб-приложения должны быть доступны из hello только общедоступный Интернет.</span><span class="sxs-lookup"><span data-stu-id="553f1-106">Web application must be accessible from hello public Internet only.</span></span>
* <span data-ttu-id="553f1-107">Приложение hello размещения веб-сервера должен быть доступ tooaccess внутреннего сервера приложений.</span><span class="sxs-lookup"><span data-stu-id="553f1-107">Web server hosting hello application must be able tooaccess a backend application server.</span></span>
* <span data-ttu-id="553f1-108">Весь трафик от hello Internet toohello веб-приложение должно пройти через брандмауэр виртуального устройства.</span><span class="sxs-lookup"><span data-stu-id="553f1-108">All traffic from hello Internet toohello web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="553f1-109">Это виртуальное устройство будет использоваться для приема трафика только из Интернета.</span><span class="sxs-lookup"><span data-stu-id="553f1-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="553f1-110">Весь трафик, передаваемый server приложения toohello должны проходить через брандмауэр виртуального устройства.</span><span class="sxs-lookup"><span data-stu-id="553f1-110">All traffic going toohello application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="553f1-111">Это виртуальное устройство будет использоваться для доступа к toohello серверной части конечного сервера и доступ, поступающих из hello в локальной сети через VPN-шлюза.</span><span class="sxs-lookup"><span data-stu-id="553f1-111">This virtual appliance will be used for access toohello backend end server, and access coming in from hello on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="553f1-112">Администраторы должны быть виртуальных устройств может toomanage hello брандмауэра с локальных компьютеров, с помощью третьей брандмауэра виртуального устройства, используется исключительно для целей управления.</span><span class="sxs-lookup"><span data-stu-id="553f1-112">Administrators must be able toomanage hello firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="553f1-113">Это стандартный сценарий сети периметра, где используется также защищенная сеть.</span><span class="sxs-lookup"><span data-stu-id="553f1-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="553f1-114">Такие сценарии можно реализовать в Azure, используя группы безопасности сети (NSG), виртуальные устройства брандмауэров или их сочетание.</span><span class="sxs-lookup"><span data-stu-id="553f1-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="553f1-115">в следующей таблице Hello показаны некоторые hello преимуществ и недостатков между Nsg и брандмауэра виртуальных устройств.</span><span class="sxs-lookup"><span data-stu-id="553f1-115">hello table below shows some of hello pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="553f1-116">Преимущества</span><span class="sxs-lookup"><span data-stu-id="553f1-116">Pros</span></span> | <span data-ttu-id="553f1-117">Недостатки</span><span class="sxs-lookup"><span data-stu-id="553f1-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="553f1-118">Группа безопасности сети (NSG)</span><span class="sxs-lookup"><span data-stu-id="553f1-118">NSG</span></span> |<span data-ttu-id="553f1-119">Бесплатное использование.</span><span class="sxs-lookup"><span data-stu-id="553f1-119">No cost.</span></span> <br/><span data-ttu-id="553f1-120">Интегрирована в управление доступом на основе ролей (RBAC).</span><span class="sxs-lookup"><span data-stu-id="553f1-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="553f1-121">Правила можно создавать в шаблонах ARM.</span><span class="sxs-lookup"><span data-stu-id="553f1-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="553f1-122">В больших средах сложность может меняться.</span><span class="sxs-lookup"><span data-stu-id="553f1-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="553f1-123">Брандмауэр</span><span class="sxs-lookup"><span data-stu-id="553f1-123">Firewall</span></span> |<span data-ttu-id="553f1-124">Полный контроль над плоскостью данных.</span><span class="sxs-lookup"><span data-stu-id="553f1-124">Full control over data plane.</span></span> <br/><span data-ttu-id="553f1-125">Централизованное управление через консоль брандмауэра.</span><span class="sxs-lookup"><span data-stu-id="553f1-125">Central management through firewall console.</span></span> |<span data-ttu-id="553f1-126">За использование устройства брандмауэра взимается плата.</span><span class="sxs-lookup"><span data-stu-id="553f1-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="553f1-127">Не интегрирован с RBAC Azure.</span><span class="sxs-lookup"><span data-stu-id="553f1-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="553f1-128">приведенное ниже решение Hello использует tooimplement виртуальных приборов брандмауэра сценарий DMZ/защищенные сети.</span><span class="sxs-lookup"><span data-stu-id="553f1-128">hello solution below uses firewall virtual appliances tooimplement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="553f1-129">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="553f1-129">Considerations</span></span>
<span data-ttu-id="553f1-130">Вы можете развернуть среду hello, описанные выше, в Azure с помощью различные функции, доступные в настоящее время, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="553f1-130">You can deploy hello environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="553f1-131">**Виртуальная сеть**.</span><span class="sxs-lookup"><span data-stu-id="553f1-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="553f1-132">Виртуальной сети Azure действует аналогично манере tooan локальной сети и может быть разбито на один или несколько подсетей tooprovide и изоляции трафика, разделение областей ответственности.</span><span class="sxs-lookup"><span data-stu-id="553f1-132">An Azure VNet acts in similar fashion tooan on-premises network, and can be segmented into one or more subnets tooprovide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="553f1-133">**Виртуальное устройство**.</span><span class="sxs-lookup"><span data-stu-id="553f1-133">**Virtual appliance**.</span></span> <span data-ttu-id="553f1-134">Несколько партнеров предоставляют виртуальных устройств в hello Azure Marketplace, который может использоваться для hello три брандмауэров, описанных выше.</span><span class="sxs-lookup"><span data-stu-id="553f1-134">Several partners provide virtual appliances in hello Azure Marketplace that can be used for hello three firewalls described above.</span></span> 
* <span data-ttu-id="553f1-135">**Определяемые пользователем маршруты**.</span><span class="sxs-lookup"><span data-stu-id="553f1-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="553f1-136">Таблицы маршрутов может содержать UDRs, используемые потоком Azure сети toocontrol hello пакетов в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="553f1-136">Route tables can contain UDRs used by Azure networking toocontrol hello flow of packets within a VNet.</span></span> <span data-ttu-id="553f1-137">Эти таблицы маршрутизации может быть применен toosubnets.</span><span class="sxs-lookup"><span data-stu-id="553f1-137">These route tables can be applied toosubnets.</span></span> <span data-ttu-id="553f1-138">Одной из новых функций hello в Azure является возможность hello tooapply toohello таблицы маршрутов GatewaySubnet, предоставляя возможность tooforward hello весь трафик, поступающий на hello виртуальной сети Azure с виртуального устройства tooa гибридного подключения.</span><span class="sxs-lookup"><span data-stu-id="553f1-138">One of hello newest features in Azure is hello ability tooapply a route table toohello GatewaySubnet, providing hello ability tooforward all traffic coming into hello Azure VNet from a hybrid connection tooa virtual appliance.</span></span>
* <span data-ttu-id="553f1-139">**IP-пересылка**.</span><span class="sxs-lookup"><span data-stu-id="553f1-139">**IP Forwarding**.</span></span> <span data-ttu-id="553f1-140">По умолчанию hello Azure сети механизм пересылки пакетов toovirtual сетевых интерфейсных плат (NIC) только в том случае, если hello Сетевых IP-адрес соответствует IP-адрес назначения пакетов hello.</span><span class="sxs-lookup"><span data-stu-id="553f1-140">By default, hello Azure networking engine forward packets toovirtual network interface cards (NICs) only if hello packet destination IP address matches hello NIC IP address.</span></span> <span data-ttu-id="553f1-141">Таким образом Если UDR определяет, что пакет должен tooa получает виртуальное устройство, hello Azure подсистемы сети уменьшится пакета.</span><span class="sxs-lookup"><span data-stu-id="553f1-141">Therefore, if a UDR defines that a packet must be sent tooa given virtual appliance, hello Azure networking engine would drop that packet.</span></span> <span data-ttu-id="553f1-142">пакет tooensure hello доставляется tooa виртуальной Машины (в данном случае виртуального устройства), не hello фактическое место назначения для hello пакета, необходимо tooenable IP-пересылки для hello виртуального устройства.</span><span class="sxs-lookup"><span data-stu-id="553f1-142">tooensure hello packet is delivered tooa VM (in this case a virtual appliance) that is not hello actual destination for hello packet, you need tooenable IP Forwarding for hello virtual appliance.</span></span>
* <span data-ttu-id="553f1-143">**Группы безопасности сети**.</span><span class="sxs-lookup"><span data-stu-id="553f1-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="553f1-144">пример Hello не пользоваться Nsg, но может использовать Nsg применяется toohello подсети и (или) сетевых адаптеров в это решение toofurther фильтрации hello трафика и из него этих подсетей и сетевых адаптеров.</span><span class="sxs-lookup"><span data-stu-id="553f1-144">hello example below does not make use of NSGs, but you could use NSGs applied toohello subnets and/or NICs in this solution toofurther filter hello traffic in and out of those subnets and NICs.</span></span>

![Подключение по протоколу IPv6](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="553f1-146">В этом примере имеется подписка, содержащий hello следующее:</span><span class="sxs-lookup"><span data-stu-id="553f1-146">In this example there is a subscription that contains hello following:</span></span>

* <span data-ttu-id="553f1-147">2 групп ресурсов, не отображаются в схеме hello.</span><span class="sxs-lookup"><span data-stu-id="553f1-147">2 resource groups, not shown in hello diagram.</span></span> 
  * <span data-ttu-id="553f1-148">**ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="553f1-148">**ONPREMRG**.</span></span> <span data-ttu-id="553f1-149">Содержит все необходимые toosimulate ресурсы локальной сети.</span><span class="sxs-lookup"><span data-stu-id="553f1-149">Contains all resources necessary toosimulate an on-premises network.</span></span>
  * <span data-ttu-id="553f1-150">**AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="553f1-150">**AZURERG**.</span></span> <span data-ttu-id="553f1-151">Содержит все ресурсы, необходимые для среды hello виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="553f1-151">Contains all resources necessary for hello Azure virtual network environment.</span></span> 
* <span data-ttu-id="553f1-152">Виртуальная сеть с именем **onpremvnet** используется toomimic локального центра обработки данных в сегментированных приведенные ниже.</span><span class="sxs-lookup"><span data-stu-id="553f1-152">A VNet named **onpremvnet** used toomimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="553f1-153">**onpremsn1**.</span><span class="sxs-lookup"><span data-stu-id="553f1-153">**onpremsn1**.</span></span> <span data-ttu-id="553f1-154">Подсеть, содержащая виртуальной машины (VM) на локальном сервере под управлением Ubuntu toomimic.</span><span class="sxs-lookup"><span data-stu-id="553f1-154">Subnet containing a virtual machine (VM) running Ubuntu toomimic an on-premises server.</span></span>
  * <span data-ttu-id="553f1-155">**onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="553f1-155">**onpremsn2**.</span></span> <span data-ttu-id="553f1-156">Подсеть, содержащая виртуальная машина, работающая на локальном компьютере, администратор Ubuntu toomimic.</span><span class="sxs-lookup"><span data-stu-id="553f1-156">Subnet containing a VM running Ubuntu toomimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="553f1-157">Имеется одно виртуальное устройство брандмауэра с именем **OPFW** на **onpremvnet** используется toomaintain туннель слишком**azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="553f1-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used toomaintain a tunnel too**azurevnet**.</span></span>
* <span data-ttu-id="553f1-158">Виртуальная сеть с именем **azurevnet** , разделенная на сегменты, перечисленные ниже.</span><span class="sxs-lookup"><span data-stu-id="553f1-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="553f1-159">**azsn1**.</span><span class="sxs-lookup"><span data-stu-id="553f1-159">**azsn1**.</span></span> <span data-ttu-id="553f1-160">Внешний брандмауэр подсети, используемой исключительно для hello внешнего брандмауэра.</span><span class="sxs-lookup"><span data-stu-id="553f1-160">External firewall subnet used exclusively for hello external firewall.</span></span> <span data-ttu-id="553f1-161">Через эту подсеть будет проходить весь интернет-трафик.</span><span class="sxs-lookup"><span data-stu-id="553f1-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="553f1-162">Эта подсеть содержит только внешний брандмауэр toohello сетевой Адаптер связан.</span><span class="sxs-lookup"><span data-stu-id="553f1-162">This subnet only contains a NIC linked toohello external firewall.</span></span>
  * <span data-ttu-id="553f1-163">**azsn2**.</span><span class="sxs-lookup"><span data-stu-id="553f1-163">**azsn2**.</span></span> <span data-ttu-id="553f1-164">Размещение виртуальная машина, работающая как веб-сервер, который будет доступен из Интернета hello подсети переднего плана.</span><span class="sxs-lookup"><span data-stu-id="553f1-164">Front end subnet hosting a VM running as a web server that will be accessed from hello Internet.</span></span>
  * <span data-ttu-id="553f1-165">**azsn3**.</span><span class="sxs-lookup"><span data-stu-id="553f1-165">**azsn3**.</span></span> <span data-ttu-id="553f1-166">Размещение виртуальная машина, работающая внутреннего сервера приложений, будут доступны для веб-сервере переднего плана hello подсети серверной части.</span><span class="sxs-lookup"><span data-stu-id="553f1-166">Backend subnet hosting a VM running a backend application server that will be accessed by hello front end web server.</span></span>
  * <span data-ttu-id="553f1-167">**azsn4**.</span><span class="sxs-lookup"><span data-stu-id="553f1-167">**azsn4**.</span></span> <span data-ttu-id="553f1-168">Подсеть управления используется исключительно tooprovide управления доступом tooall брандмауэра виртуальных устройств.</span><span class="sxs-lookup"><span data-stu-id="553f1-168">Management subnet used exclusively tooprovide management access tooall firewall virtual appliances.</span></span> <span data-ttu-id="553f1-169">Эта подсеть содержит только сетевой КАРТЫ для каждого виртуального устройства брандмауэра, используемые в решении hello.</span><span class="sxs-lookup"><span data-stu-id="553f1-169">This subnet only contains a NIC for each firewall virtual appliance used in hello solution.</span></span>
  * <span data-ttu-id="553f1-170">**GatewaySubnet**.</span><span class="sxs-lookup"><span data-stu-id="553f1-170">**GatewaySubnet**.</span></span> <span data-ttu-id="553f1-171">Подсеть подключения гибридной Azure требуется для шлюза VPN и ExpressRoute tooprovide подключением виртуальных сетей Azure и другими сетями.</span><span class="sxs-lookup"><span data-stu-id="553f1-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway tooprovide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="553f1-172">Существует 3 виртуальных приборов брандмауэра в hello **azurevnet** сети.</span><span class="sxs-lookup"><span data-stu-id="553f1-172">There are 3 firewall virtual appliances in hello **azurevnet** network.</span></span> 
  * <span data-ttu-id="553f1-173">**AZF1**.</span><span class="sxs-lookup"><span data-stu-id="553f1-173">**AZF1**.</span></span> <span data-ttu-id="553f1-174">Внешний брандмауэр предоставляется toohello общедоступный Интернет с помощью открытого ресурса IP-адреса в Azure.</span><span class="sxs-lookup"><span data-stu-id="553f1-174">External firewall exposed toohello public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="553f1-175">Необходимо tooensure имеется шаблон из hello Marketplace или непосредственно от поставщика устройства, которая подготавливает виртуального устройства 3 Сетевыми.</span><span class="sxs-lookup"><span data-stu-id="553f1-175">You need tooensure you have a template from hello Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="553f1-176">**AZF2**.</span><span class="sxs-lookup"><span data-stu-id="553f1-176">**AZF2**.</span></span> <span data-ttu-id="553f1-177">Внутренним брандмауэром используется toocontrol трафик между **azsn2** и **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="553f1-177">Internal firewall used toocontrol traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="553f1-178">Это виртуальное устройство также обладает тремя сетевыми адаптерами.</span><span class="sxs-lookup"><span data-stu-id="553f1-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="553f1-179">**AZF3**.</span><span class="sxs-lookup"><span data-stu-id="553f1-179">**AZF3**.</span></span> <span data-ttu-id="553f1-180">Доступный tooadministrators управления брандмауэра из hello локального центра обработки данных и подсеть управления подключенной tooa использовать toomanage все аппаратные брандмауэры.</span><span class="sxs-lookup"><span data-stu-id="553f1-180">Management firewall accessible tooadministrators from hello on-premises datacenter, and connected tooa management subnet used toomanage all firewall appliances.</span></span> <span data-ttu-id="553f1-181">Можно найти сетевой Адаптер 2 шаблоны виртуального устройства в hello Marketplace, или запросить непосредственно с поставщиком устройства.</span><span class="sxs-lookup"><span data-stu-id="553f1-181">You can find 2-NIC virtual appliance templates in hello Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="553f1-182">Определяемые пользователем маршруты</span><span class="sxs-lookup"><span data-stu-id="553f1-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="553f1-183">Каждой подсети в Azure может быть таблица, используемая связанного tooa UDR toodefine с маршрутизацией трафик, отправленный в этой подсети.</span><span class="sxs-lookup"><span data-stu-id="553f1-183">Each subnet in Azure can be linked tooa UDR table used toodefine how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="553f1-184">При определении не UDRs Azure использует tooflow трафика tooallow маршруты по умолчанию из одной подсети tooanother.</span><span class="sxs-lookup"><span data-stu-id="553f1-184">If no UDRs are defined, Azure uses default routes tooallow traffic tooflow from one subnet tooanother.</span></span> <span data-ttu-id="553f1-185">toobetter понять UDRs, посетите [Каковы определяемых пользователем маршрутов и IP-пересылка](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="553f1-185">toobetter understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="553f1-186">tooensure обмен данными осуществляется с помощью устройства hello правильный брандмауэр на основе требований последнего hello выше, вы должны toocreate hello следующие таблицы маршрутов, содержащий UDRs в **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="553f1-186">tooensure communication is done through hello right firewall appliance, based on hello last requirement above, you need toocreate hello following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="553f1-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="553f1-187">azgwudr</span></span>
<span data-ttu-id="553f1-188">В этом сценарии hello только трафик из локальной tooAzure брандмауэры используется toomanage hello подключив слишком**AZF3**, и что трафик должен проходить через брандмауэр внутренней hello, **AZF2**.</span><span class="sxs-lookup"><span data-stu-id="553f1-188">In this scenario, hello only traffic flowing from on-premises tooAzure will be used toomanage hello firewalls by connecting too**AZF3**, and that traffic must go through hello internal firewall, **AZF2**.</span></span> <span data-ttu-id="553f1-189">Таким образом, необходим только один маршрут в hello **GatewaySubnet** как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="553f1-189">Therefore, only one route is necessary in hello **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="553f1-190">Место назначения</span><span class="sxs-lookup"><span data-stu-id="553f1-190">Destination</span></span> | <span data-ttu-id="553f1-191">Следующий прыжок</span><span class="sxs-lookup"><span data-stu-id="553f1-191">Next hop</span></span> | <span data-ttu-id="553f1-192">Пояснение</span><span class="sxs-lookup"><span data-stu-id="553f1-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="553f1-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="553f1-193">10.0.4.0/24</span></span> |<span data-ttu-id="553f1-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="553f1-194">10.0.3.11</span></span> |<span data-ttu-id="553f1-195">Позволяет локальным трафика tooreach управления брандмауэра **AZF3**</span><span class="sxs-lookup"><span data-stu-id="553f1-195">Allows on-premises traffic tooreach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="553f1-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="553f1-196">azsn2udr</span></span>
| <span data-ttu-id="553f1-197">Место назначения</span><span class="sxs-lookup"><span data-stu-id="553f1-197">Destination</span></span> | <span data-ttu-id="553f1-198">Следующий прыжок</span><span class="sxs-lookup"><span data-stu-id="553f1-198">Next hop</span></span> | <span data-ttu-id="553f1-199">Пояснение</span><span class="sxs-lookup"><span data-stu-id="553f1-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="553f1-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="553f1-200">10.0.3.0/24</span></span> |<span data-ttu-id="553f1-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="553f1-201">10.0.2.11</span></span> |<span data-ttu-id="553f1-202">Разрешает трафик toohello серверной подсети сервером приложения hello через **AZF2**</span><span class="sxs-lookup"><span data-stu-id="553f1-202">Allows traffic toohello backend subnet hosting hello application server through **AZF2**</span></span> |
| <span data-ttu-id="553f1-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="553f1-203">0.0.0.0/0</span></span> |<span data-ttu-id="553f1-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="553f1-204">10.0.2.10</span></span> |<span data-ttu-id="553f1-205">Разрешает все трафика toobe, маршрутизируются через **AZF1**</span><span class="sxs-lookup"><span data-stu-id="553f1-205">Allows all other traffic toobe routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="553f1-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="553f1-206">azsn3udr</span></span>
| <span data-ttu-id="553f1-207">Место назначения</span><span class="sxs-lookup"><span data-stu-id="553f1-207">Destination</span></span> | <span data-ttu-id="553f1-208">Следующий прыжок</span><span class="sxs-lookup"><span data-stu-id="553f1-208">Next hop</span></span> | <span data-ttu-id="553f1-209">Пояснение</span><span class="sxs-lookup"><span data-stu-id="553f1-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="553f1-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="553f1-210">10.0.2.0/24</span></span> |<span data-ttu-id="553f1-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="553f1-211">10.0.3.10</span></span> |<span data-ttu-id="553f1-212">Разрешает трафик слишком**azsn2** tooflow из приложения веб-сервера toohello сервер через **AZF2**</span><span class="sxs-lookup"><span data-stu-id="553f1-212">Allows traffic too**azsn2** tooflow from app server toohello webserver through **AZF2**</span></span> |

<span data-ttu-id="553f1-213">Требуется toocreate таблиц маршрутов для подсети hello в **onpremvnet** toomimic hello локального центра обработки данных.</span><span class="sxs-lookup"><span data-stu-id="553f1-213">You also need toocreate route tables for hello subnets in **onpremvnet** toomimic hello on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="553f1-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="553f1-214">onpremsn1udr</span></span>
| <span data-ttu-id="553f1-215">Место назначения</span><span class="sxs-lookup"><span data-stu-id="553f1-215">Destination</span></span> | <span data-ttu-id="553f1-216">Следующий прыжок</span><span class="sxs-lookup"><span data-stu-id="553f1-216">Next hop</span></span> | <span data-ttu-id="553f1-217">Пояснение</span><span class="sxs-lookup"><span data-stu-id="553f1-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="553f1-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="553f1-218">192.168.2.0/24</span></span> |<span data-ttu-id="553f1-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="553f1-219">192.168.1.4</span></span> |<span data-ttu-id="553f1-220">Разрешает трафик слишком**onpremsn2** через **OPFW**</span><span class="sxs-lookup"><span data-stu-id="553f1-220">Allows traffic too**onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="553f1-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="553f1-221">onpremsn2udr</span></span>
| <span data-ttu-id="553f1-222">Место назначения</span><span class="sxs-lookup"><span data-stu-id="553f1-222">Destination</span></span> | <span data-ttu-id="553f1-223">Следующий прыжок</span><span class="sxs-lookup"><span data-stu-id="553f1-223">Next hop</span></span> | <span data-ttu-id="553f1-224">Пояснение</span><span class="sxs-lookup"><span data-stu-id="553f1-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="553f1-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="553f1-225">10.0.3.0/24</span></span> |<span data-ttu-id="553f1-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="553f1-226">192.168.2.4</span></span> |<span data-ttu-id="553f1-227">Позволяет toohello резервного подсети трафика в Azure через **OPFW**</span><span class="sxs-lookup"><span data-stu-id="553f1-227">Allows traffic toohello backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="553f1-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="553f1-228">192.168.1.0/24</span></span> |<span data-ttu-id="553f1-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="553f1-229">192.168.2.4</span></span> |<span data-ttu-id="553f1-230">Разрешает трафик слишком**onpremsn1** через **OPFW**</span><span class="sxs-lookup"><span data-stu-id="553f1-230">Allows traffic too**onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="553f1-231">IP-пересылку</span><span class="sxs-lookup"><span data-stu-id="553f1-231">IP Forwarding</span></span>
<span data-ttu-id="553f1-232">UDR и IP-пересылка являются компонентами, которые можно использовать в сочетании tooallow виртуальных приборов используется toobe toocontrol передачу трафика в виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="553f1-232">UDR and IP Forwarding are features that you can use in combination tooallow virtual appliances toobe used toocontrol traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="553f1-233">Виртуальное устройство — это ничто иное виртуальной Машины, которая запускает приложение, toohandle сетевой трафик определенным образом, например брандмауэром или устройством NAT.</span><span class="sxs-lookup"><span data-stu-id="553f1-233">A virtual appliance is nothing more than a VM that runs an application used toohandle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="553f1-234">Это виртуальное устройство виртуальной Машины, необходимо будет tooreceive входящий трафик, не рассматриваются tooitself.</span><span class="sxs-lookup"><span data-stu-id="553f1-234">This virtual appliance VM must be able tooreceive incoming traffic that is not addressed tooitself.</span></span> <span data-ttu-id="553f1-235">tooallow tooreceive трафика виртуальных Машин внимания tooother назначения, необходимо включить IP-пересылку для hello виртуальной Машины.</span><span class="sxs-lookup"><span data-stu-id="553f1-235">tooallow a VM tooreceive traffic addressed tooother destinations, you must enable IP Forwarding for hello VM.</span></span> <span data-ttu-id="553f1-236">Это политика, не соответствует hello гостевой ОС Azure.</span><span class="sxs-lookup"><span data-stu-id="553f1-236">This is an Azure setting, not a setting in hello guest operating system.</span></span> <span data-ttu-id="553f1-237">Ваш виртуального устройства по-прежнему потребностей toorun некоторые тип toohandle приложения hello входящего трафика и направить ее соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="553f1-237">Your virtual appliance still needs toorun some type of application toohandle hello incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="553f1-238">Посетите toolearn Дополнительные сведения об IP-пересылки, [Каковы определяемых пользователем маршрутов и IP-пересылка](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="553f1-238">toolearn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="553f1-239">Например представьте, что у вас есть hello, после завершения программы установки в виртуальную сеть Azure:</span><span class="sxs-lookup"><span data-stu-id="553f1-239">As an example, imagine you have hello following setup in an Azure vnet:</span></span>

* <span data-ttu-id="553f1-240">В подсети **onpremsn1** есть виртуальная машина с именем **onpremvm1**.</span><span class="sxs-lookup"><span data-stu-id="553f1-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="553f1-241">В подсети **onpremsn2** есть виртуальная машина с именем **onpremvm2**.</span><span class="sxs-lookup"><span data-stu-id="553f1-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="553f1-242">Виртуальное устройство с именем **OPFW** подключено слишком**onpremsn1** и **onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="553f1-242">A virtual appliance named **OPFW** is connected too**onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="553f1-243">Слишком связанного маршрута определяемых пользователем**onpremsn1** указывает, что весь трафик слишком**onpremsn2** должны отправляться слишком**OPFW**.</span><span class="sxs-lookup"><span data-stu-id="553f1-243">A user defined route linked too**onpremsn1** specifies that all traffic too**onpremsn2** must be sent too**OPFW**.</span></span>

<span data-ttu-id="553f1-244">В этот момент, если **onpremvm1** пытается tooestablish соединения с **onpremvm2**, hello UDR будет использоваться, и трафик будет отправляться слишком**OPFW** как hello следующего прыжка.</span><span class="sxs-lookup"><span data-stu-id="553f1-244">At this point, if **onpremvm1** tries tooestablish a connection with **onpremvm2**, hello UDR will be used and traffic will be sent too**OPFW** as hello next hop.</span></span> <span data-ttu-id="553f1-245">Имейте в виду, что hello назначения фактические пакета не были изменены, по-прежнему отображается надпись **onpremvm2** hello местом назначения.</span><span class="sxs-lookup"><span data-stu-id="553f1-245">Keep in mind that hello actual packet destination is not being changed, it still says **onpremvm2** is hello destination.</span></span> 

<span data-ttu-id="553f1-246">Без IP-пересылка включена для **OPFW**, hello Azure виртуальные сети логику приведет к удалению приветственных пакетов, поскольку только tooa toobe отправленных пакетов виртуальных Машин позволяет Если hello IP-адрес Виртуальной машины — hello назначение для пакета hello.</span><span class="sxs-lookup"><span data-stu-id="553f1-246">Without IP Forwarding enabled for **OPFW**, hello Azure virtual networking logic will drop hello packets, since it only allows packets toobe sent tooa VM if hello VM’s IP address is hello destination for hello packet.</span></span>

<span data-ttu-id="553f1-247">С IP-пересылки hello логику виртуальной сети Azure будет пересылать tooOPFW пакетов hello, без изменения его исходный адрес назначения.</span><span class="sxs-lookup"><span data-stu-id="553f1-247">With IP Forwarding, hello Azure virtual network logic will forward hello packets tooOPFW, without changing its original destination address.</span></span> <span data-ttu-id="553f1-248">**OPFW** должен обрабатывать пакеты приветствия и определить, какие toodo с ними.</span><span class="sxs-lookup"><span data-stu-id="553f1-248">**OPFW** must handle hello packets and determine what toodo with them.</span></span>

<span data-ttu-id="553f1-249">Для сценария hello выше toowork, необходимо включить IP-пересылки на приветствия сетевых адаптеров для **OPFW**, **AZF1**, **AZF2**, и **AZF3** , которые используются для Маршрутизация (все сетевые адаптеры Кроме подсети управления связанного toohello hello из них).</span><span class="sxs-lookup"><span data-stu-id="553f1-249">For hello scenario above toowork, you must enable IP Forwarding on hello NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except hello ones linked toohello management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="553f1-250">Правила брандмауэра</span><span class="sxs-lookup"><span data-stu-id="553f1-250">Firewall Rules</span></span>
<span data-ttu-id="553f1-251">Как описано выше, IP-пересылка только гарантирует, что пакеты отправляются toohello виртуальных устройств.</span><span class="sxs-lookup"><span data-stu-id="553f1-251">As described above, IP Forwarding only ensures packets are sent toohello virtual appliances.</span></span> <span data-ttu-id="553f1-252">Устройства по-прежнему должен toodecide какие toodo с этими пакетами.</span><span class="sxs-lookup"><span data-stu-id="553f1-252">Your appliance still needs toodecide what toodo with those packets.</span></span> <span data-ttu-id="553f1-253">В приведенном выше сценарии hello вам потребуется hello toocreate согласно правилам, описанным в вашего устройства:</span><span class="sxs-lookup"><span data-stu-id="553f1-253">In hello scenario above, you will need toocreate hello following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="553f1-254">OPFW</span><span class="sxs-lookup"><span data-stu-id="553f1-254">OPFW</span></span>
<span data-ttu-id="553f1-255">OPFW представляет локальное устройство, содержащее hello правилам:</span><span class="sxs-lookup"><span data-stu-id="553f1-255">OPFW represents an on-premises device containing hello following rules:</span></span>

* <span data-ttu-id="553f1-256">**Маршрут**: весь трафик too10.0.0.0/16 (**azurevnet**) должны быть отправлены через туннель **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="553f1-256">**Route**: All traffic too10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="553f1-257">**Политика**. Разрешите передачу любого двунаправленного трафика между **port2** и **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="553f1-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="553f1-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="553f1-258">AZF1</span></span>
<span data-ttu-id="553f1-259">AZF1 представляет Azure виртуальное устройство, содержащее hello правилам:</span><span class="sxs-lookup"><span data-stu-id="553f1-259">AZF1 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="553f1-260">**Политика**. Разрешите передачу любого двунаправленного трафика между **port1** и **port2**.</span><span class="sxs-lookup"><span data-stu-id="553f1-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="553f1-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="553f1-261">AZF2</span></span>
<span data-ttu-id="553f1-262">AZF2 представляет Azure виртуальное устройство, содержащее hello правилам:</span><span class="sxs-lookup"><span data-stu-id="553f1-262">AZF2 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="553f1-263">**Маршрут**: весь трафик too10.0.0.0/16 (**onpremvnet**) должны быть отправлены toohello шлюз Azure в IP-адрес (т. е. 10.0.0.1) через **порта 1**.</span><span class="sxs-lookup"><span data-stu-id="553f1-263">**Route**: All traffic too10.0.0.0/16 (**onpremvnet**) must be sent toohello Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="553f1-264">**Политика**. Разрешите передачу любого двунаправленного трафика между **port1** и **port2**.</span><span class="sxs-lookup"><span data-stu-id="553f1-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="553f1-265">Группы безопасности сети (NSG)</span><span class="sxs-lookup"><span data-stu-id="553f1-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="553f1-266">В этом сценарии не используются NSG.</span><span class="sxs-lookup"><span data-stu-id="553f1-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="553f1-267">Тем не менее можно применить Nsg tooeach подсети toorestrict входящий и исходящий трафик.</span><span class="sxs-lookup"><span data-stu-id="553f1-267">However, you could apply NSGs tooeach subnet toorestrict incoming and outgoing traffic.</span></span> <span data-ttu-id="553f1-268">Для экземпляра можно применить следующие NSG правила toohello внешнюю подсеть, FW hello.</span><span class="sxs-lookup"><span data-stu-id="553f1-268">For instance, you could apply hello following NSG rules toohello external FW subnet.</span></span>

<span data-ttu-id="553f1-269">**Входящий трафик**</span><span class="sxs-lookup"><span data-stu-id="553f1-269">**Incoming**</span></span>

* <span data-ttu-id="553f1-270">Разрешить весь трафик TCP от Интернета hello tooport 80 на любой виртуальной Машине в подсети hello.</span><span class="sxs-lookup"><span data-stu-id="553f1-270">Allow all TCP traffic from hello Internet tooport 80 on any VM in hello subnet.</span></span>
* <span data-ttu-id="553f1-271">Запретить весь трафик из Интернета hello.</span><span class="sxs-lookup"><span data-stu-id="553f1-271">Deny all other traffic from hello Internet.</span></span>

<span data-ttu-id="553f1-272">**Исходящий трафик**</span><span class="sxs-lookup"><span data-stu-id="553f1-272">**Outgoing**</span></span>

* <span data-ttu-id="553f1-273">Запретите все toohello трафик Интернета.</span><span class="sxs-lookup"><span data-stu-id="553f1-273">Deny all traffic toohello Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="553f1-274">Шаги высокого уровня</span><span class="sxs-lookup"><span data-stu-id="553f1-274">High level steps</span></span>
<span data-ttu-id="553f1-275">toodeploy этого сценария выполните hello шаги на высоком уровне ниже.</span><span class="sxs-lookup"><span data-stu-id="553f1-275">toodeploy this scenario, follow hello high level steps below.</span></span>

1. <span data-ttu-id="553f1-276">Tooyour входа подписки Azure.</span><span class="sxs-lookup"><span data-stu-id="553f1-276">Login tooyour Azure Subscription.</span></span>
2. <span data-ttu-id="553f1-277">Если требуется toodeploy hello toomimic виртуальной сети в локальной сети, подготовьте hello ресурсы, которые являются частью **ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="553f1-277">If you want toodeploy a VNet toomimic hello on-premises network, provision hello resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="553f1-278">Подготовить hello ресурсы, которые являются частью **AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="553f1-278">Provision hello resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="553f1-279">Туннель hello подготовки из **onpremvnet** слишком**azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="553f1-279">Provision hello tunnel from **onpremvnet** too**azurevnet**.</span></span>
5. <span data-ttu-id="553f1-280">После подготовки всех ресурсов, войдите на слишком**onpremvm2** и ping 10.0.3.101 tootest соединение между **onpremsn2** и **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="553f1-280">Once all resources are provisioned, log on too**onpremvm2** and ping 10.0.3.101 tootest connectivity between **onpremsn2** and **azsn3**.</span></span>


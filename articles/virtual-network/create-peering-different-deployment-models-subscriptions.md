---
title: "Создание пиринга виртуальных сетей Azure с разными моделями развертывания в разных подписках | Документация Майкрософт"
description: "Узнайте, как создать пиринг между виртуальными сетями, созданными с помощью разных моделей развертывания Azure, которые существуют в разных подписках Azure."
services: virtual-network
documentationcenter: 
author: jimdial
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/15/2017
ms.author: jdial;anavin
ms.openlocfilehash: 441bb0a269de400c82abc083118f5e0642523640
ms.sourcegitcommit: c25cf136aab5f082caaf93d598df78dc23e327b9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/15/2017
---
# <a name="create-a-virtual-network-peering---different-deployment-models-and-subscriptions"></a>Создание пиринга виртуальных сетей с разными моделями развертывания в разных подписках

В этом руководстве вы узнаете, как создать пиринг между виртуальными сетями, созданными с помощью разных моделей развертывания. Эти виртуальные сети находятся в разных подписках. Установление пиринга между двумя виртуальными сетями позволяет ресурсам в разных виртуальных сетях взаимодействовать друг с другом с такими же пропускной способностью и задержкой, как если бы эти ресурсы находились в одной виртуальной сети. Узнайте больше о [пиринге виртуальных сетей](virtual-network-peering-overview.md).

Действия по созданию пиринга виртуальных сетей зависят от того, находятся ли виртуальные сети в одной или разных подписках, и того, какая [модель развертывания Azure](../azure-resource-manager/resource-manager-deployment-model.md?toc=%2fazure%2fvirtual-network%2ftoc.json) использовалась для их создания. Узнайте, как создать пиринг виртуальных сетей в других сценариях, щелкнув сценарий в следующей таблице.

|Модель развертывания Azure  | Подписка Azure.  |
|--------- |---------|
|[Обе виртуальные сети Resource Manager](virtual-network-create-peering.md) |Аналогично|
|[Обе виртуальные сети Resource Manager](create-peering-different-subscriptions.md) |Разные|
|[Одна виртуальная сеть Resource Manager, одна классическая виртуальная сеть](create-peering-different-deployment-models.md) |Аналогично|

Невозможно создать пиринг между двумя виртуальными сетями, созданными с помощью классической модели развертывания. Возможность установления пиринговой связи между виртуальными сетями, созданными с помощью разных моделей развертывания в разных подписках, сейчас находится на этапе предварительной версии. Чтобы пройти это руководство, необходимо сначала [зарегистрироваться](#register) для использования данной возможности. В этом руководстве используются виртуальные сети, существующие в одном и том же регионе. Возможность установления пиринговой связи между виртуальными сетями в разных регионах также находится на этапе предварительной версии. Для использования этой возможности необходимо также [зарегистрироваться](#register). Эти две возможности независимы друг от друга. Чтобы пройти это руководство, необходимо зарегистрироваться только для использования функции создания пиринговой связи между виртуальными сетями, созданными с помощью разных моделей развертывания в разных подписках. 

При создании пиринга между виртуальными сетями, которые существуют в разных подписках, эти подписки должны быть связаны с одним клиентом Azure Active Directory. Если у вас еще нет клиента Azure Active Directory, можно быстро [создать его](../active-directory/develop/active-directory-howto-tenant.md?toc=%2fazure%2fvirtual-network%2ftoc.json#start-from-scratch). 

Возможность подключения виртуальных сетей, созданных с помощью любой модели развертывания, разных моделей развертывания, в разных регионах или подписках, связанных с одними и теми же или разными клиентами Azure Active Directory, использующими [VPN-шлюз](../vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json) Azure, находится на этапе предварительной версии и не требует регистрации.

Для создания пиринга виртуальных сетей можно использовать [портал Azure](#portal), [интерфейс командной строки](#cli) Azure (Azure CLI) или Azure [PowerShell](#powershell). Щелкните любую из предыдущих ссылок на инструмент, чтобы перейти непосредственно к инструкциям по созданию пиринга виртуальных сетей с помощью выбранного инструмента.

## <a name="portal"></a>Создание пиринга с помощью портала Azure

В этом руководстве используются разные учетные записи для каждой подписки. Если вы используете учетную запись, имеющую разрешения для обеих подписок, то можете использовать эту учетную запись для всех действий. Пропустите выход с портала и назначение разрешений еще одного пользователя для виртуальных сетей. Перед выполнением любого из следующих действий необходимо зарегистрироваться для использования предварительной версии. Чтобы зарегистрироваться, выполните действия в разделе [Регистрация для использования предварительной версии](#register) этой статьи. Выполнить оставшиеся шаги не удастся, если не зарегистрировать обе подписки для предварительного ознакомления.
 
1. Войдите на [портал Azure](https://portal.azure.com) как пользователь A. У учетной записи, используемой для входа, должны быть необходимые разрешения для создания пиринга виртуальных сетей. Дополнительные сведения см. в разделе [Разрешения](#permissions) этой статьи.
2. Щелкните **+ Создать**, выберите **Сети** и щелкните **Виртуальная сеть**.
3. В колонке **Создание виртуальной сети** введите или выберите значения для приведенных ниже параметров и щелкните **Создать**.
    - **Имя**: *myVnetA*.
    - **Адресное пространство**: *10.0.0.0/16*.
    - **Имя подсети**: *по умолчанию*.
    - **Диапазон адресов подсети**: *10.0.0.0/24*.
    - **Подписка**: выберите подписку A.
    - **Группа ресурсов**: установите флажок **Создать** и введите *myResourceGroupA*.
    - **Расположение**: *Восточная часть США*.
4. В поле **Поиск ресурсов**, находящемся в верхней части портала, введите *myVnetA*. Когда сеть **myVnetA** появится в результатах поиска, щелкните ее. Отобразится колонка для виртуальной сети **myVnetA**.
5. В вертикальном списке параметров в левой части отобразившейся колонки **myVnetA** щелкните **Управление доступом (IAM)**.
6. В открывшейся колонке **myVnetA — управление доступом (IAM)** щелкните **+ Добавить**.
7. В отобразившейся колонке **Добавление разрешений** в поле **Роль** выберите **Участник сетей**.
8. В поле **Выбор** выберите пользователя B или введите его адрес электронной почты для поиска. Отобразится список пользователей из того же клиента Azure Active Directory, с которым связана виртуальная сеть, с которой вы устанавливаете пиринг. Щелкните пользователя B, когда он появится в списке.
9. Щелкните **Сохранить**.
10. Выйдите с портала как пользователь A, а затем войдите как пользователь B.
11. Щелкните **+ Создать**, введите *Виртуальная сеть* в поле **Поиск по Marketplace**, а затем щелкните **Виртуальная сеть** в результатах поиска.
12. В открывшейся колонке **Виртуальная сеть** в поле **Выбор модели развертывания** выберите **Классический** и нажмите кнопку **Создать**.
13.   В отобразившейся колонке "Создание виртуальной сети (классической)" введите приведенные ниже значения.

    - **Имя**: *myVnetB*.
    - **Адресное пространство**: *10.1.0.0/16*.
    - **Имя подсети**: *по умолчанию*.
    - **Диапазон адресов подсети:** *10.1.0.0/24*.
    - **Подписка**: выберите подписку B.
    - **Группа ресурсов**: установите флажок **Создать** и введите *myResourceGroupB*.
    - **Расположение**: *Восточная часть США*.

14. В поле **Поиск ресурсов**, находящемся в верхней части портала, введите *myVnetB*. Когда сеть **myVnetB** появится в результатах поиска, щелкните ее. Отобразится колонка для виртуальной сети **myVnetB**.
15. В вертикальном списке параметров в левой части отобразившейся колонки **myVnetB** щелкните **Свойства**. Скопируйте **Идентификатор ресурса**, он понадобится нам позже. Идентификатор ресурса имеет следующий вид: /subscriptions/<Susbscription ID>/resourceGroups/myResoureGroupB/providers/Microsoft.ClassicNetwork/virtualNetworks/myVnetB.
16. Выполните шаги 5–9 для myVnetB, указав **пользователя A** на шаге 8.
17. Выйдите с портала как пользователь B, а затем войдите как пользователь A.
18. В поле **Поиск ресурсов**, находящемся в верхней части портала, введите *myVnetA*. Когда сеть **myVnetA** появится в результатах поиска, щелкните ее. Отобразится колонка для виртуальной сети **myVnetA**.
19. Щелкните **myVnetA**.
20. В вертикальном списке параметров в левой части отобразившейся колонки **myVnetA** щелкните **Пиринги**.
21. В открывшейся колонке **myVnetA — пиринги** щелкните **+ Добавить**.
22. В открывшейся колонке **Добавить пиринг** введите или выберите значения приведенных ниже параметров, после чего нажмите кнопку **ОК**.
     - **Имя**: *myVnetAToMyVnetB*.
     - **Модель развертывания виртуальной сети**: выберите **Классический**.
     - **Я знаю идентификатор ресурса**: установите этот флажок.
     - **Идентификатор ресурса**: введите идентификатор ресурса myVnetB, скопированный на шаге 15.
     - **Разрешить доступ к виртуальным сетям**: убедитесь, что выбрано значение **Включено**.
    Другие параметры в этом руководстве не используются. Чтобы узнать о всех параметрах пиринга, прочитайте раздел [Создание, изменение и удаление пиринга в виртуальной сети](virtual-network-manage-peering.md#create-a-peering).
23. После нажатия кнопки **ОК** на предыдущем шаге колонка **Добавить пиринг** закроется, и вы снова увидите колонку **myVnetA — пиринги**. Через несколько секунд созданный пиринг отобразится в этой колонке. В столбце **Состояние пиринга** для созданного пиринга **myVnetAToMyVnetB** указано состояние **Подключено**. Пиринг установлен. Нет необходимости создавать пиринг между классической виртуальной сетью и виртуальной сетью Resource Manager.

    Теперь все ресурсы Azure, созданные в любой из виртуальных сетей, могут взаимодействовать друг с другом, используя свои IP-адреса. Если вы используете разрешение имен Azure по умолчанию для виртуальных сетей, то ресурсы в этих виртуальных сетях не смогут разрешать имена между виртуальными сетями. Если требуется разрешение имен между виртуальными сетями в пиринге, необходимо создать собственный DNS-сервер. Узнайте, как настроить [разрешение имен с помощью собственного DNS-сервера](virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server).

24. **Необязательно**. Хотя в этом руководстве не рассматривается создание виртуальных машин, можно создать по виртуальной машине в каждой виртуальной сети и подключить их между собой, чтобы проверить связь.
25. **Необязательно**. Чтобы удалить ресурсы, созданные в этом руководстве, выполните инструкции в разделе [Удаление ресурсов](#delete-portal) этой статьи.

## <a name="cli"></a>Создание пиринга с помощью Azure CLI

В этом руководстве используются разные учетные записи для каждой подписки. Если вы используете учетную запись, имеющую разрешения для обеих подписок, то можете использовать эту учетную запись для всех действий. Пропустите выход из Azure и удалите строки сценария, назначающие роли пользователей. Замените UserA@azure.com и UserB@azure.com во всех следующих сценариях именами пользователей, которые вы используете для пользователей A и B. 

Перед выполнением любого из следующих действий необходимо зарегистрироваться для использования предварительной версии. Чтобы зарегистрироваться, выполните действия в разделе [Регистрация для использования предварительной версии](#register) этой статьи. Выполнить оставшиеся шаги не удастся, если не зарегистрировать обе подписки для предварительного ознакомления.

1. [Установите](../cli-install-nodejs.md?toc=%2fazure%2fvirtual-network%2ftoc.json) Azure CLI 1.0 для создания классической виртуальной сети.
2. Запустите сеанс интерфейса командной строки и войдите в Azure как пользователь B с помощью команды `azure login`.
3. Запустите интерфейс командной строки в режиме управления службами, введя команду `azure config mode asm`.
4. Чтобы создать классическую виртуальную сеть, введите приведенную ниже команду.
 
    ```azurecli
    azure network vnet create --vnet myVnetB --address-space 10.1.0.0 --cidr 16 --location "East US"
    ```
5. Остальные действия необходимо выполнить в оболочке Bash с помощью [установленного](/cli/azure/install-azure-cli?toc=%2fazure%2fvirtual-network%2ftoc.json) интерфейса командной строки Azure CLI 2.0.4 или более поздней версии или с помощью Azure Cloud Shell. Azure Cloud Shell — это бесплатная оболочка Bash, которую можно запускать непосредственно на портале Azure. Она включает предварительно установленный интерфейс Azure CLI и настроена для использования с вашей учетной записью. Нажмите кнопку **Попробовать** в приведенных ниже сценариях, чтобы запустить службу Cloud Shell, которая выполнит вход в вашу учетную запись Azure. Сведения о параметрах выполнения сценариев Bash для интерфейса командной строки в клиенте Windows см. в статье [Использование Azure CLI в Windows](../virtual-machines/windows/cli-options.md?toc=%2fazure%2fvirtual-network%2ftoc.json). 
6. Скопируйте следующий сценарий в текстовый редактор на своем компьютере. Замените `<SubscriptionB-Id>` идентификатором своей подписки. Если вам неизвестен идентификатор подписки, введите команду `az account show`. Значение **id** (Идентификатор) в выходных данных является идентификатором вашей подписки. Скопируйте измененный сценарий, вставьте его в сеанс Azure CLI 2.0 и нажмите клавишу `Enter`. 

    ```azurecli-interactive
    az role assignment create \
      --assignee UserA@azure.com \
      --role "Classic Network Contributor" \
      --scope /subscriptions/<SubscriptionB-Id>/resourceGroups/Default-Networking/providers/Microsoft.ClassicNetwork/virtualNetworks/myVnetB
    ```

    На шаге 4 платформа Azure создала классическую виртуальную сеть в группе ресурсов *Default-Networking*.
7. Выйдите из Azure как пользователь B, затем войдите в Azure CLI 2.0 как пользователь A.
8. Создайте группу ресурсов и виртуальную сеть Resource Manager. Скопируйте следующий сценарий, вставьте его в окно сеанса интерфейса командной строки и нажмите клавишу `Enter`. 

    ```azurecli-interactive
    #!/bin/bash

    # Variables for common values used throughout the script.
    rgName="myResourceGroupA"
    location="eastus"

    # Create a resource group.
    az group create \
      --name $rgName \
      --location $location

    # Create virtual network A (Resource Manager).
    az network vnet create \
      --name myVnetA \
      --resource-group $rgName \
      --location $location \
      --address-prefix 10.0.0.0/16

    # Get the id for myVnetA.
    vNetAId=$(az network vnet show \
      --resource-group $rgName \
      --name myVnetA \
      --query id --out tsv)

    # Assign UserB permissions to myVnetA.
    az role assignment create \
      --assignee UserB@azure.com \
      --role "Network Contributor" \
      --scope $vNetAId
    ```

9. Создайте пиринг между двумя виртуальными сетями, созданными с помощью разных моделей развертывания. Скопируйте следующий сценарий в текстовый редактор на своем компьютере. Замените `<SubscriptionB-id>` идентификатором своей подписки. Если вам неизвестен идентификатор подписки, введите команду `az account show`. Значение **id** (Идентификатор) в выходных данных является идентификатором вашей подписки. На шаге 4 платформа Azure создала вашу классическую виртуальную сеть в группе ресурсов *Default-Networking*. Вставьте измененный сценарий в окно сеанса интерфейса командной строки и нажмите клавишу `Enter`.

    ```azurecli-interactive
    # Peer VNet1 to VNet2.
    az network vnet peering create \
      --name myVnetAToMyVnetB \
      --resource-group $rgName \
      --vnet-name myVnetA \
      --remote-vnet-id  /subscriptions/<SubscriptionB-id>/resourceGroups/Default-Networking/providers/Microsoft.ClassicNetwork/virtualNetworks/myVnetB \
      --allow-vnet-access
    ```

10. После выполнения сценария просмотрите сведения о пиринге виртуальной сети Resource Manager. Скопируйте следующий сценарий и вставьте его в сеанс интерфейса командной строки.

    ```azurecli-interactive
    az network vnet peering list \
      --resource-group $rgName \
      --vnet-name myVnetA \
      --output table
    ```
    В выходных данных в столбце **PeeringState** (Состояние пиринга) указано состояние **Connected** (Подключен).

    Теперь все ресурсы Azure, созданные в любой из виртуальных сетей, могут взаимодействовать друг с другом, используя свои IP-адреса. Если вы используете разрешение имен Azure по умолчанию для виртуальных сетей, то ресурсы в этих виртуальных сетях не смогут разрешать имена между виртуальными сетями. Если требуется разрешение имен между виртуальными сетями в пиринге, необходимо создать собственный DNS-сервер. Узнайте, как настроить [разрешение имен с помощью собственного DNS-сервера](virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server).

11. **Необязательно**. Хотя в этом руководстве не рассматривается создание виртуальных машин, можно создать по виртуальной машине в каждой виртуальной сети и подключить их между собой, чтобы проверить связь.
12. **Необязательно**. Чтобы удалить ресурсы, созданные в этом руководстве, выполните инструкции, описанные в разделе [Удаление ресурсов](#delete-cli) этой статьи.

## <a name="powershell"></a>Создание пиринга с помощью PowerShell

В этом руководстве используются разные учетные записи для каждой подписки. Если вы используете учетную запись, имеющую разрешения для обеих подписок, то можете использовать эту учетную запись для всех действий. Пропустите выход из Azure и удалите строки сценария, назначающие роли пользователей. Замените UserA@azure.com и UserB@azure.com во всех следующих сценариях именами пользователей, которые вы используете для пользователей A и B. 

Перед выполнением любого из следующих действий необходимо зарегистрироваться для использования предварительной версии. Чтобы зарегистрироваться, выполните действия в разделе [Регистрация для использования предварительной версии](#register) этой статьи. Выполнить оставшиеся шаги не удастся, если не зарегистрировать обе подписки для предварительного ознакомления.

1. Установите последние версии модулей PowerShell [Azure](https://www.powershellgallery.com/packages/Azure) и [AzureRm](https://www.powershellgallery.com/packages/AzureRM/). Если вы еще не работали с Azure PowerShell, ознакомьтесь со статьей [Overview of Azure PowerShell](/powershell/azure/overview?toc=%2fazure%2fvirtual-network%2ftoc.json) (Общие сведения об Azure PowerShell).
2. Запустите сеанс PowerShell.
3. В PowerShell войдите в подписку пользователя B от имени этого пользователя, введя команду `Add-AzureAccount`.
4. Чтобы создать классическую виртуальную сеть с помощью PowerShell, необходимо создать новый или изменить существующий файл конфигурации сети. Узнайте, как [экспортировать, обновлять и импортировать файлы конфигурации сети](virtual-networks-using-network-configuration-file.md). Файл должен содержать приведенный ниже элемент **VirtualNetworkSite** для виртуальной сети, используемой в этом руководстве.

    ```xml
    <VirtualNetworkSite name="myVnetB" Location="East US">
      <AddressSpace>
        <AddressPrefix>10.1.0.0/16</AddressPrefix>
      </AddressSpace>
      <Subnets>
        <Subnet name="default">
          <AddressPrefix>10.1.0.0/24</AddressPrefix>
        </Subnet>
      </Subnets>
    </VirtualNetworkSite>
    ```

    > [!WARNING]
    > Импорт измененного файла конфигурации сети может привести к изменениям в классических виртуальных сетях в вашей подписке. Убедитесь, что вы добавили только указанную выше виртуальную сеть и не изменили или удалили имеющиеся в своей подписке виртуальные сети. 

5. Войдите в подписку пользователя B от имени этого пользователя для выполнения команд Resource Manager, введя команду `login-azurermaccount`.
6. Назначьте разрешения пользователя A виртуальной сети myVnetB. Скопируйте приведенный ниже сценарий в текстовый редактор на своем компьютере и замените `<SubscriptionB-id>` идентификатором подписки B. Если вам неизвестен этот идентификатор подписки, введите команду `Get-AzureRmSubscription`, чтобы просмотреть его. Значение **Id** (Идентификатор) в полученных выходных данных является идентификатором вашей подписки. На шаге 4 платформа Azure создала вашу классическую виртуальную сеть в группе ресурсов *Default-Networking*. Чтобы выполнить сценарий, скопируйте измененный сценарий, вставьте его в окно сеанса PowerShell и нажмите клавишу `Enter`.
    
    ```powershell 
    New-AzureRmRoleAssignment `
      -SignInName UserA@azure.com `
      -RoleDefinitionName "Classic Network Contributor" `
      -Scope /subscriptions/<SubscriptionB-id>/resourceGroups/Default-Networking/providers/Microsoft.ClassicNetwork/virtualNetworks/myVnetB
    ```

7. Выйдите из Azure как пользователь B и войдите в подписку пользователя A от имени пользователя A, введя команду `login-azurermaccount`. У учетной записи, используемой для входа, должны быть необходимые разрешения для создания пиринга виртуальных сетей. Дополнительные сведения см. в разделе [Разрешения](#permissions) этой статьи.
8. Создайте виртуальную сеть Resource Manager, скопировав следующий сценарий, вставив его PowerShell и нажав клавишу `Enter`.

    ```powershell
    # Variables for common values
      $rgName='MyResourceGroupA'
      $location='eastus'

    # Create a resource group.
    New-AzureRmResourceGroup `
      -Name $rgName `
      -Location $location

    # Create virtual network A.
    $vnetA = New-AzureRmVirtualNetwork `
      -ResourceGroupName $rgName `
      -Name 'myVnetA' `
      -AddressPrefix '10.0.0.0/16' `
      -Location $location
    ```

9. Назначьте разрешения пользователя B виртуальной сети myVnetA. Скопируйте приведенный ниже сценарий в текстовый редактор на своем компьютере и замените `<SubscriptionA-Id>` идентификатором подписки A. Если вам неизвестен этот идентификатор подписки, введите команду `Get-AzureRmSubscription`, чтобы просмотреть его. Значение **Id** (Идентификатор) в полученных выходных данных является идентификатором вашей подписки. Вставьте измененную версию сценарий в окно сеанса PowerShell и нажмите клавишу `Enter`, чтобы выполнить его.

    ```powershell
    New-AzureRmRoleAssignment `
      -SignInName UserB@azure.com `
      -RoleDefinitionName "Network Contributor" `
      -Scope /subscriptions/<SubscriptionA-Id>/resourceGroups/myResourceGroupA/providers/Microsoft.Network/VirtualNetworks/myVnetA
    ```

10. Скопируйте приведенный ниже сценарий в текстовый редактор на своем компьютере и замените `<SubscriptionB-id>` идентификатором подписки B. Чтобы создать пиринг между myVnetA и myVNetB, скопируйте измененный сценарий, вставьте его в PowerShell и нажмите клавишу `Enter`.

    ```powershell
    Add-AzureRmVirtualNetworkPeering `
      -Name 'myVnetAToMyVnetB' `
      -VirtualNetwork $vnetA `
      -RemoteVirtualNetworkId /subscriptions/<SubscriptionB-id>/resourceGroups/Default-Networking/providers/Microsoft.ClassicNetwork/virtualNetworks/myVnetB
    ```

11. Просмотрите состояние пиринга myVnetA, скопировав следующий сценарий в PowerShell и нажав клавишу `Enter`.

    ```powershell
    Get-AzureRmVirtualNetworkPeering `
      -ResourceGroupName $rgName `
      -VirtualNetworkName myVnetA `
      | Format-Table VirtualNetworkName, PeeringState
    ```

    Отображается состояние **Connected** (Подключено). Оно принимает значение **Connected** (Подключено) после настройки пиринга из myVnetB к myVnetA.

    Теперь все ресурсы Azure, созданные в любой из виртуальных сетей, могут взаимодействовать друг с другом, используя свои IP-адреса. Если вы используете разрешение имен Azure по умолчанию для виртуальных сетей, то ресурсы в этих виртуальных сетях не смогут разрешать имена между виртуальными сетями. Если требуется разрешение имен между виртуальными сетями в пиринге, необходимо создать собственный DNS-сервер. Узнайте, как настроить [разрешение имен с помощью собственного DNS-сервера](virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server).

12. **Необязательно**. Хотя в этом руководстве не рассматривается создание виртуальных машин, можно создать по виртуальной машине в каждой виртуальной сети и подключить их между собой, чтобы проверить связь.
13. **Необязательно**. Чтобы удалить ресурсы, созданные в этом руководстве, выполните инструкции, описанные в разделе [Удаление ресурсов](#delete-powershell) этой статьи.

## <a name="permissions"></a>Разрешения

У учетных записей, используемых для создания пиринга виртуальных сетей, должна быть необходимая роль или разрешения. Например, при создании пиринга между двумя виртуальными сетями myVnetA и myVnetB вашей учетной записи должны быть назначены следующие минимальные роли или разрешения для каждой виртуальной сети.
    
|Виртуальная сеть|Модель развертывания|Роль|Разрешения|
|---|---|---|---|
|myVnetA|Диспетчер ресурсов|[Участник сети](../active-directory/role-based-access-built-in-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json#network-contributor)|Microsoft.Network/virtualNetworks/virtualNetworkPeerings/write|
| |Классический|[Участник классической сети](../active-directory/role-based-access-built-in-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json#classic-network-contributor)|Недоступно|
|myVnetB|Диспетчер ресурсов|[Участник сети](../active-directory/role-based-access-built-in-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json#network-contributor)|Microsoft.Network/virtualNetworks/peer|
||Классический|[Участник классической сети](../active-directory/role-based-access-built-in-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json#classic-network-contributor)|Microsoft.ClassicNetwork/virtualNetworks/peer|

Узнайте больше о [встроенных ролях](../active-directory/role-based-access-built-in-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json#network-contributor) и назначении разрешений, определенных для [настраиваемых ролей](../active-directory/role-based-access-control-custom-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json) (только для Resource Manager).

## <a name="delete"></a>Удаление ресурсов
По завершении работы с этим руководством может потребоваться удалить созданные в его рамках ресурсы, чтобы за их использование не взималась плата. При удалении группы ресурсов будут также удалены все ресурсы, содержащиеся в ней.

### <a name="delete-portal"></a>Портал Azure

1. В поле поиска на портале введите **myResourceGroupA**. В результатах поиска щелкните **myResourceGroupA**.
2. В колонке **myResourceGroupA** щелкните значок **Удалить**.
3. Чтобы подтвердить удаление, введите **myResourceGroupA** в поле **Введите имя группы ресурсов**, а затем щелкните **Удалить**.
4. В поле **Поиск ресурсов**, находящемся в верхней части портала, введите *myVnetB*. Когда сеть **myVnetB** появится в результатах поиска, щелкните ее. Отобразится колонка для виртуальной сети **myVnetB**.
5. В колонке **myVnetB** щелкните **Удалить**.
6. В окне **Удалить виртуальную сеть** нажмите кнопку **Да**, чтобы подтвердить удаление.

### <a name="delete-cli"></a>Интерфейс командной строки Azure

1. Войдите в Azure с помощью Azure CLI 2.0, чтобы удалить виртуальную сеть Resource Manager с помощью приведенной ниже команды.

    ```azurecli-interactive
    az group delete --name myResourceGroupA --yes
    ```

2. Войдите в Azure с помощью Azure CLI 1.0, чтобы удалить классическую виртуальную сеть с помощью приведенных ниже команд.

    ```azurecli
    azure config mode asm 

    azure network vnet delete --vnet myVnetB --quiet
    ```

### <a name="delete-powershell"></a>PowerShell

1. В командной строке PowerShell введите приведенную ниже команду, чтобы удалить виртуальную сеть Resource Manager.

    ```powershell
    Remove-AzureRmResourceGroup -Name myResourceGroupA -Force
    ```

2. Чтобы удалить классическую виртуальную сеть с помощью PowerShell, необходимо изменить существующий файл конфигурации сети. Узнайте, как [экспортировать, обновлять и импортировать файлы конфигурации сети](virtual-networks-using-network-configuration-file.md). Удалите приведенный ниже элемент VirtualNetworkSite для виртуальной сети, используемой в этом руководстве.

    ```xml
    <VirtualNetworkSite name="myVnetB" Location="East US">
      <AddressSpace>
        <AddressPrefix>10.1.0.0/16</AddressPrefix>
      </AddressSpace>
      <Subnets>
        <Subnet name="default">
          <AddressPrefix>10.1.0.0/24</AddressPrefix>
        </Subnet>
      </Subnets>
    </VirtualNetworkSite>
    ```

    > [!WARNING]
    > Импорт измененного файла конфигурации сети может привести к изменениям в классических виртуальных сетях в вашей подписке. Убедитесь, что вы удалили только указанную выше виртуальную сеть и не изменили или удалили другие виртуальные сети в своей подписке. 

## <a name="register"></a>Регистрация для использования предварительной версии

Возможность установления пиринговой связи между виртуальными сетями, созданными с помощью разных моделей развертывания Azure в разных подписках, сейчас находится на этапе предварительной версии. Для функций предварительной версии не предусмотрен такой же уровень доступности и надежности, как для общедоступного выпуска. Актуальные сведения о доступности и состоянии этих функций см. на странице [обновлений виртуальной сети Azure](https://azure.microsoft.com/updates/?product=virtual-network). 

Чтобы использовать функцию перекрестной подписки и перекрестной модели развертывания, необходимо зарегистрироваться. Выполните следующие действия в подписке, содержащей каждую виртуальную сеть, с которой нужно установить пиринговую связь, используя Azure PowerShell или Azure CLI:

### <a name="powershell"></a>PowerShell

1. Установите последнюю версию модуля [AzureRm](https://www.powershellgallery.com/packages/AzureRM/) PowerShell. Если вы еще не работали с Azure PowerShell, ознакомьтесь со статьей [Overview of Azure PowerShell](/powershell/azure/overview?toc=%2fazure%2fvirtual-network%2ftoc.json) (Общие сведения об Azure PowerShell).
2. Запустите сеанс PowerShell и войдите в Azure с помощью команды `Login-AzureRmAccount`.
3. Зарегистрируйте подписку, в которой находится каждая виртуальная сеть, для которой нужно создать пиринг, чтобы использовать предварительную версию, введя следующие команды:

    ```powershell
    Register-AzureRmProviderFeature `
      -FeatureName AllowClassicCrossSubscriptionPeering `
      -ProviderNamespace Microsoft.Network
    
    Register-AzureRmResourceProvider `
      -ProviderNamespace Microsoft.Network
    ```
4. Убедитесь, что регистрация прошла успешно, выполнив следующую команду:

    ```powershell    
    Get-AzureRmProviderFeature `
      -FeatureName AllowClassicCrossSubscriptionPeering `
      -ProviderNamespace Microsoft.Network
    ```

    Не выполняйте инструкции в разделах о портале, PowerShell, Azure CLI или шаблоне Resource Manager в этой статье, пока для параметра **RegistrationState** (Состояние регистрации) в выходных данных приведенной выше команды не отобразится значение **Registered** (Зарегистрировано) для обеих подписок.

> [!NOTE]
> В этом руководстве используются виртуальные сети, существующие в одном и том же регионе. Возможность установления пиринговой связи между виртуальными сетями в разных регионах также находится на этапе предварительной версии. Для регистрации пиринговой связи между различными регионами (глобальной) выполните шаги 1–4 еще раз, используя `-FeatureName AllowGlobalVnetPeering` вместо `-FeatureName AllowClassicCrossSubscriptionPeering`. Эти две возможности независимы друг от друга. Регистрация для них обеих необязательна, если вы не планируете использовать обе возможности. Эта возможность доступна в ограниченном ряде регионов (изначально в центрально-западной части США, центральной Канаде и западной части США 2).

### <a name="azure-cli"></a>Инфраструктура CLI Azure

1. [Установить и настроить Azure CLI](/cli/azure/install-azure-cli?toc=%2Fazure%2Fvirtual-network%2Ftoc.json).
2. Убедитесь, вы используете Azure CLI версии 2.0.18 или более поздней, введя команду `az --version`. Если это не так, установите последнюю версию.
3. Войдите в Azure с помощью команды `az login`.
4. Зарегистрируйтесь для использования предварительной версии, выполнив следующие команды:

   ```azurecli-interactive
   az feature register --name AllowGlobalVnetPeering --namespace Microsoft.Network
   az provider register --name Microsoft.Network
   ```

5. Убедитесь, что регистрация прошла успешно, выполнив следующую команду:

    ```azurecli-interactive
    az feature show --name AllowGlobalVnetPeering --namespace Microsoft.Network
    ```

    Не выполняйте инструкции в разделах для портала, PowerShell, Azure CLI или шаблона Resource Manager в этой статье, пока значение **RegistrationState** (Состояние регистрации) в выходных данных приведенной выше команды не станет **Registered** (Зарегистрировано) для обеих подписок.

> [!NOTE]
> В этом руководстве используются виртуальные сети, существующие в одном и том же регионе. Возможность установления пиринговой связи между виртуальными сетями в разных регионах также находится на этапе предварительной версии. Для регистрации пиринговой связи между различными регионами (глобальной) выполните шаги 1–5 еще раз, используя `--name AllowGlobalVnetPeering` вместо `--name AllowClassicCrossSubscriptionPeering`. Эти две возможности независимы друг от друга. Регистрация для них обеих необязательна, если вы не планируете использовать обе возможности. Эта возможность доступна в ограниченном ряде регионов (изначально в центрально-западной части США, центральной Канаде и западной части США 2).

## <a name="next-steps"></a>Дальнейшие действия

- Внимательно ознакомьтесь с важными [ограничениями и особенностями работы пиринга виртуальных сетей](virtual-network-manage-peering.md#requirements-and-constraints), прежде чем создавать пиринг виртуальных сетей для рабочей среды.
- Узнайте о [параметрах пиринга виртуальных сетей](virtual-network-manage-peering.md#create-a-peering).
- Узнайте, как [создать звездообразную топологию сети](/azure/architecture/reference-architectures/hybrid-networking/hub-spoke?toc=%2fazure%2fvirtual-network%2ftoc.json#vnet-peering) с помощью пиринга виртуальных сетей.

---
title: "Настройка виртуальной сети для кэша Redis для Azure уровня \"Премиум\" | Документация Майкрософт"
description: "Узнайте, как настроить поддержку виртуальной сети и управлять ей для экземпляров кэша Redis для Azure уровня Премиум"
services: redis-cache
documentationcenter: 
author: steved0x
manager: douge
editor: 
ms.assetid: 8b1e43a0-a70e-41e6-8994-0ac246d8bf7f
ms.service: cache
ms.workload: tbd
ms.tgt_pltfrm: cache-redis
ms.devlang: na
ms.topic: article
ms.date: 05/15/2017
ms.author: sdanie
ms.openlocfilehash: 59d46990e02c0719d2b4df01e216a97fd649c509
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="how-to-configure-virtual-network-support-for-a-premium-azure-redis-cache"></a><span data-ttu-id="b0972-103">Настройка поддержки виртуальной сети для кэша Redis для Azure уровня Премиум</span><span class="sxs-lookup"><span data-stu-id="b0972-103">How to configure Virtual Network Support for a Premium Azure Redis Cache</span></span>
<span data-ttu-id="b0972-104">Кэш Redis для Azure предлагает разные варианты кэша, которые обеспечивают гибкость в выборе размера и функций кэша, включая функции уровня "Премиум", такие как кластеризация, постоянное хранение данных и поддержка виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="b0972-104">Azure Redis Cache has different cache offerings, which provide flexibility in the choice of cache size and features, including Premium tier features such as clustering, persistence, and virtual network support.</span></span> <span data-ttu-id="b0972-105">Виртуальная сеть — это частная сеть в облаке.</span><span class="sxs-lookup"><span data-stu-id="b0972-105">A VNet is a private network in the cloud.</span></span> <span data-ttu-id="b0972-106">В случае настройки экземпляра кэша Redis для Azure в виртуальной сети он не является общедоступным, а доступен только для виртуальных машин и приложений в этой виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="b0972-106">When an Azure Redis Cache instance is configured with a VNet, it is not publicly addressable and can only be accessed from virtual machines and applications within the VNet.</span></span> <span data-ttu-id="b0972-107">В этой статье описана настройка поддержки виртуальной сети для экземпляра кэша Redis для Azure уровня "Премиум".</span><span class="sxs-lookup"><span data-stu-id="b0972-107">This article describes how to configure virtual network support for a premium Azure Redis Cache instance.</span></span>

> [!NOTE]
> <span data-ttu-id="b0972-108">Кэш Redis для Azure поддерживает классические виртуальные сети и виртуальные сети Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="b0972-108">Azure Redis Cache supports both classic and Resource Manager VNets.</span></span>
> 
> 

<span data-ttu-id="b0972-109">Сведения о других функциях кэша уровня "Премиум" см. в статье [Знакомство с кэшем Redis для Azure уровня Премиум](cache-premium-tier-intro.md).</span><span class="sxs-lookup"><span data-stu-id="b0972-109">For information on other premium cache features, see [Introduction to the Azure Redis Cache Premium tier](cache-premium-tier-intro.md).</span></span>

## <a name="why-vnet"></a><span data-ttu-id="b0972-110">Зачем использовать виртуальные сети?</span><span class="sxs-lookup"><span data-stu-id="b0972-110">Why VNet?</span></span>
<span data-ttu-id="b0972-111">Развертывание [виртуальной сети Azure (VNet)](https://azure.microsoft.com/services/virtual-network/) обеспечивает улучшенную безопасность и изоляцию для кэша Redis для Azure. Такие развертывания позволяют определять подсети, настраивать политики контроля доступа и использовать другие функции ограничения доступа.</span><span class="sxs-lookup"><span data-stu-id="b0972-111">[Azure Virtual Network (VNet)](https://azure.microsoft.com/services/virtual-network/) deployment provides enhanced security and isolation for your Azure Redis Cache, as well as subnets, access control policies, and other features to further restrict access.</span></span>

## <a name="virtual-network-support"></a><span data-ttu-id="b0972-112">Поддержка виртуальной сети</span><span class="sxs-lookup"><span data-stu-id="b0972-112">Virtual network support</span></span>
<span data-ttu-id="b0972-113">Поддержка виртуальной сети настраивается во время создания кэша в колонке **Новый кэш Redis** .</span><span class="sxs-lookup"><span data-stu-id="b0972-113">Virtual Network (VNet) support is configured on the **New Redis Cache** blade during cache creation.</span></span> 

[!INCLUDE [redis-cache-create](../../includes/redis-cache-premium-create.md)]

<span data-ttu-id="b0972-114">После выбора ценовой категории "Премиум" можно настроить интеграцию виртуальной сети Redis, выбрав виртуальную сеть, которая находится в той же подписке и расположении, что и кэш.</span><span class="sxs-lookup"><span data-stu-id="b0972-114">Once you have selected a premium pricing tier, you can configure Redis VNet integration by selecting a VNet that is in the same subscription and location as your cache.</span></span> <span data-ttu-id="b0972-115">Чтобы использовать новую виртуальную сеть, сначала создайте ее, выполнив действия, описанные в статье [Создание виртуальной сети с помощью портала Azure](../virtual-network/virtual-networks-create-vnet-arm-pportal.md) или [Создание (классической) виртуальной сети с помощью портала Azure](../virtual-network/virtual-networks-create-vnet-classic-pportal.md), а затем вернитесь в колонку **Новый кэш Redis**, чтобы создать и настроить кэш уровня "Премиум".</span><span class="sxs-lookup"><span data-stu-id="b0972-115">To use a new VNet, create it first by following the steps in [Create a virtual network using the Azure portal](../virtual-network/virtual-networks-create-vnet-arm-pportal.md) or [Create a virtual network (classic) by using the Azure portal](../virtual-network/virtual-networks-create-vnet-classic-pportal.md) and then return to the **New Redis Cache** blade to create and configure your premium cache.</span></span>

<span data-ttu-id="b0972-116">Чтобы настроить виртуальную сеть для нового кэша, в колонке **Новый кэш Redis** щелкните **Виртуальная сеть** и в раскрывающемся списке выберите нужную виртуальную сеть.</span><span class="sxs-lookup"><span data-stu-id="b0972-116">To configure the VNet for your new cache, click **Virtual Network** on the **New Redis Cache** blade, and select the desired VNet from the drop-down list.</span></span>

![Виртуальная сеть][redis-cache-vnet]

<span data-ttu-id="b0972-118">Выберите нужную подсеть в раскрывающемся списке **Подсети** и укажите необходимый **статический IP-адрес**.</span><span class="sxs-lookup"><span data-stu-id="b0972-118">Select the desired subnet from the **Subnet** drop-down list, and specify the desired **Static IP address**.</span></span> <span data-ttu-id="b0972-119">При использовании классической виртуальной сети заполнять поле **Статический IP-адрес** не обязательно, а если этот адрес не задан, то он выбирается из указанной подсети.</span><span class="sxs-lookup"><span data-stu-id="b0972-119">If you are using a classic VNet the **Static IP address** field is optional, and if none is specified, one is chosen from the selected subnet.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="b0972-120">При развертывании кэша Redis для Azure в виртуальной сети Resource Manager он должен размещаться в выделенной подсети, которая не содержит других ресурсов, кроме экземпляров кэша Redis для Azure.</span><span class="sxs-lookup"><span data-stu-id="b0972-120">When deploying an Azure Redis Cache to a Resource Manager VNet, the cache must be in a dedicated subnet that contains no other resources except for Azure Redis Cache instances.</span></span> <span data-ttu-id="b0972-121">Если попытаться развернуть кэш Redis для Azure в подсети виртуальной сети Resource Manager, содержащей другие ресурсы, то это приведет к сбою операции.</span><span class="sxs-lookup"><span data-stu-id="b0972-121">If an attempt is made to deploy an Azure Redis Cache to a Resource Manager VNet to a subnet that contains other resources, the deployment fails.</span></span>
> 
> 

![Виртуальная сеть][redis-cache-vnet-ip]

> [!IMPORTANT]
> <span data-ttu-id="b0972-123">Azure резервирует некоторые IP-адреса в каждой подсети, которые нельзя использовать.</span><span class="sxs-lookup"><span data-stu-id="b0972-123">Azure reserves some IP addresses within each subnet, and these addresses can't be used.</span></span> <span data-ttu-id="b0972-124">Зарезервированы первый и последний IP-адреса подсетей (для соответствия требованиям протокола), а также еще три адреса, используемые для служб Azure.</span><span class="sxs-lookup"><span data-stu-id="b0972-124">The first and last IP addresses of the subnets are reserved for protocol conformance, along with three more addresses used for Azure services.</span></span> <span data-ttu-id="b0972-125">Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)</span><span class="sxs-lookup"><span data-stu-id="b0972-125">For more information, see [Are there any restrictions on using IP addresses within these subnets?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)</span></span>
> 
> <span data-ttu-id="b0972-126">Помимо IP-адресов, используемых инфраструктурой виртуальной сети Azure, каждый экземпляр Redis в подсети использует два IP-адреса на сегмент и еще один IP-адрес для балансировщика нагрузки.</span><span class="sxs-lookup"><span data-stu-id="b0972-126">In addition to the IP addresses used by the Azure VNET infrastructure, each Redis instance in the subnet uses two IP addresses per shard and one additional IP address for the load balancer.</span></span> <span data-ttu-id="b0972-127">Некластеризованный кэш считается имеющим один сегмент.</span><span class="sxs-lookup"><span data-stu-id="b0972-127">A non-clustered cache is considered to have one shard.</span></span>
> 
> 

<span data-ttu-id="b0972-128">Создав кэш, конфигурацию виртуальной сети можно просмотреть, щелкнув **Виртуальная сеть** в **меню ресурсов**.</span><span class="sxs-lookup"><span data-stu-id="b0972-128">After the cache is created, you can view the configuration for the VNet by clicking **Virtual Network** from the **Resource menu**.</span></span>

![Виртуальная сеть][redis-cache-vnet-info]

<span data-ttu-id="b0972-130">Чтобы подключиться к экземпляру кэша Redis для Azure при использовании виртуальной сети, укажите имя узла кэша в строке подключения, как показано в приведенном ниже примере.</span><span class="sxs-lookup"><span data-stu-id="b0972-130">To connect to your Azure Redis cache instance when using a VNet, specify the host name of your cache in the connection string as shown in the following example:</span></span>

    private static Lazy<ConnectionMultiplexer> lazyConnection = new Lazy<ConnectionMultiplexer>(() =>
    {
        return ConnectionMultiplexer.Connect("contoso5premium.redis.cache.windows.net,abortConnect=false,ssl=true,password=password");
    });

    public static ConnectionMultiplexer Connection
    {
        get
        {
            return lazyConnection.Value;
        }
    }

## <a name="azure-redis-cache-vnet-faq"></a><span data-ttu-id="b0972-131">Часто задаваемые вопросы о виртуальных сетях кэша Redis для Azure</span><span class="sxs-lookup"><span data-stu-id="b0972-131">Azure Redis Cache VNet FAQ</span></span>
<span data-ttu-id="b0972-132">Следующий список содержит ответы на часто задаваемые вопросы о виртуальных сетях кэша Redis для Azure.</span><span class="sxs-lookup"><span data-stu-id="b0972-132">The following list contains answers to commonly asked questions about the Azure Redis Cache scaling.</span></span>

* [<span data-ttu-id="b0972-133">Каковы распространенные ошибки конфигурации кэша Redis для Azure и виртуальных сетей?</span><span class="sxs-lookup"><span data-stu-id="b0972-133">What are some common misconfiguration issues with Azure Redis Cache and VNets?</span></span>](#what-are-some-common-misconfiguration-issues-with-azure-redis-cache-and-vnets)
* [<span data-ttu-id="b0972-134">Как проверить, что кэш работает в виртуальной сети?</span><span class="sxs-lookup"><span data-stu-id="b0972-134">How can I verify that my cache is working in a VNET?</span></span>](#how-can-i-verify-that-my-cache-is-working-in-a-vnet)
* [<span data-ttu-id="b0972-135">Можно ли использовать виртуальные сети в кэше уровня "Стандартный" или "Базовый"?</span><span class="sxs-lookup"><span data-stu-id="b0972-135">Can I use VNets with a standard or basic cache?</span></span>](#can-i-use-vnets-with-a-standard-or-basic-cache)
* [<span data-ttu-id="b0972-136">Почему в одних подсетях не удается создать кэш Redis, а в других удается?</span><span class="sxs-lookup"><span data-stu-id="b0972-136">Why does creating a Redis cache fail in some subnets but not others?</span></span>](#why-does-creating-a-redis-cache-fail-in-some-subnets-but-not-others)
* [<span data-ttu-id="b0972-137">Каковы требования к адресному пространству подсети?</span><span class="sxs-lookup"><span data-stu-id="b0972-137">What are the subnet address space requirements?</span></span>](#what-are-the-subnet-address-space-requirements)
* [<span data-ttu-id="b0972-138">Do all cache features work when hosting a cache in a VNET? (Все ли функции кэша работают, когда он размещен в виртуальной сети?)</span><span class="sxs-lookup"><span data-stu-id="b0972-138">Do all cache features work when hosting a cache in a VNET?</span></span>](#do-all-cache-features-work-when-hosting-a-cache-in-a-vnet)

## <a name="what-are-some-common-misconfiguration-issues-with-azure-redis-cache-and-vnets"></a><span data-ttu-id="b0972-139">Каковы распространенные ошибки конфигурации кэша Redis для Azure и виртуальных сетей?</span><span class="sxs-lookup"><span data-stu-id="b0972-139">What are some common misconfiguration issues with Azure Redis Cache and VNets?</span></span>
<span data-ttu-id="b0972-140">При размещении кэша Redis для Azure в виртуальной сети используются порты, указанные в следующих таблицах.</span><span class="sxs-lookup"><span data-stu-id="b0972-140">When Azure Redis Cache is hosted in a VNet, the ports in the following tables are used.</span></span> 

>[!IMPORTANT]
><span data-ttu-id="b0972-141">Если эти порты заблокированы, кэш может работать неправильно.</span><span class="sxs-lookup"><span data-stu-id="b0972-141">If the ports in the following tables are blocked, the cache may not function correctly.</span></span> <span data-ttu-id="b0972-142">Блокировка одного или нескольких из этих портов является самой распространенной проблемой неправильной настройки при использовании кэша Redis для Azure в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="b0972-142">Having one or more of these ports blocked is the most common misconfiguration issue when using Azure Redis Cache in a VNet.</span></span>
> 
> 

- [<span data-ttu-id="b0972-143">Обязательные порты для исходящего трафика</span><span class="sxs-lookup"><span data-stu-id="b0972-143">Outbound port requirements</span></span>](#outbound-port-requirements)
- [<span data-ttu-id="b0972-144">Обязательные порты для входящего трафика</span><span class="sxs-lookup"><span data-stu-id="b0972-144">Inbound port requirements</span></span>](#inbound-port-requirements)

### <a name="outbound-port-requirements"></a><span data-ttu-id="b0972-145">Обязательные порты для исходящего трафика</span><span class="sxs-lookup"><span data-stu-id="b0972-145">Outbound port requirements</span></span>

<span data-ttu-id="b0972-146">Существует семь обязательных портов для исходящего трафика.</span><span class="sxs-lookup"><span data-stu-id="b0972-146">There are seven outbound port requirements.</span></span>

- <span data-ttu-id="b0972-147">При необходимости все исходящие подключения к Интернету осуществляются через устройство аудита в локальной среде клиента.</span><span class="sxs-lookup"><span data-stu-id="b0972-147">If desired, all outbound connections to the internet can be made through a client's on-premises auditing device.</span></span>
- <span data-ttu-id="b0972-148">Три порта направляют трафик к конечным точкам Azure, обслуживающим службу хранилища Azure и Azure DNS.</span><span class="sxs-lookup"><span data-stu-id="b0972-148">Three of the ports route traffic to Azure endpoints servicing Azure Storage and Azure DNS.</span></span>
- <span data-ttu-id="b0972-149">Остальные диапазоны портов предназначены для внутреннего обмена данными в подсети Redis.</span><span class="sxs-lookup"><span data-stu-id="b0972-149">The remaining port ranges and for internal Redis subnet communications.</span></span> <span data-ttu-id="b0972-150">Для внутреннего обмена данными в подсети Redis не требуются правила группы безопасности сети в подсети.</span><span class="sxs-lookup"><span data-stu-id="b0972-150">No subnet NSG rules are required for internal Redis subnet communications.</span></span>

| <span data-ttu-id="b0972-151">Порты</span><span class="sxs-lookup"><span data-stu-id="b0972-151">Port(s)</span></span> | <span data-ttu-id="b0972-152">Направление</span><span class="sxs-lookup"><span data-stu-id="b0972-152">Direction</span></span> | <span data-ttu-id="b0972-153">Транспортный протокол</span><span class="sxs-lookup"><span data-stu-id="b0972-153">Transport Protocol</span></span> | <span data-ttu-id="b0972-154">Назначение</span><span class="sxs-lookup"><span data-stu-id="b0972-154">Purpose</span></span> | <span data-ttu-id="b0972-155">Локальный IP-адрес</span><span class="sxs-lookup"><span data-stu-id="b0972-155">Local IP</span></span> | <span data-ttu-id="b0972-156">Удаленный IP-адрес</span><span class="sxs-lookup"><span data-stu-id="b0972-156">Remote IP</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="b0972-157">80, 443</span><span class="sxs-lookup"><span data-stu-id="b0972-157">80, 443</span></span> |<span data-ttu-id="b0972-158">Исходящие</span><span class="sxs-lookup"><span data-stu-id="b0972-158">Outbound</span></span> |<span data-ttu-id="b0972-159">TCP</span><span class="sxs-lookup"><span data-stu-id="b0972-159">TCP</span></span> |<span data-ttu-id="b0972-160">Зависимости Redis в службе хранилища Azure или PKI (Интернет)</span><span class="sxs-lookup"><span data-stu-id="b0972-160">Redis dependencies on Azure Storage/PKI (Internet)</span></span> | <span data-ttu-id="b0972-161">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-161">(Redis subnet)</span></span> |* |
| <span data-ttu-id="b0972-162">53</span><span class="sxs-lookup"><span data-stu-id="b0972-162">53</span></span> |<span data-ttu-id="b0972-163">Исходящие</span><span class="sxs-lookup"><span data-stu-id="b0972-163">Outbound</span></span> |<span data-ttu-id="b0972-164">TCP/UDP</span><span class="sxs-lookup"><span data-stu-id="b0972-164">TCP/UDP</span></span> |<span data-ttu-id="b0972-165">Зависимости Redis в DNS (Интернет/виртуальная сеть)</span><span class="sxs-lookup"><span data-stu-id="b0972-165">Redis dependencies on DNS (Internet/VNet)</span></span> | <span data-ttu-id="b0972-166">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-166">(Redis subnet)</span></span> |* |
| <span data-ttu-id="b0972-167">8443</span><span class="sxs-lookup"><span data-stu-id="b0972-167">8443</span></span> |<span data-ttu-id="b0972-168">Исходящие</span><span class="sxs-lookup"><span data-stu-id="b0972-168">Outbound</span></span> |<span data-ttu-id="b0972-169">TCP</span><span class="sxs-lookup"><span data-stu-id="b0972-169">TCP</span></span> |<span data-ttu-id="b0972-170">Внутренний обмен данными для Redis</span><span class="sxs-lookup"><span data-stu-id="b0972-170">Internal communications for Redis</span></span> | <span data-ttu-id="b0972-171">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-171">(Redis subnet)</span></span> | <span data-ttu-id="b0972-172">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-172">(Redis subnet)</span></span> |
| <span data-ttu-id="b0972-173">10221-10231</span><span class="sxs-lookup"><span data-stu-id="b0972-173">10221-10231</span></span> |<span data-ttu-id="b0972-174">Исходящие</span><span class="sxs-lookup"><span data-stu-id="b0972-174">Outbound</span></span> |<span data-ttu-id="b0972-175">TCP</span><span class="sxs-lookup"><span data-stu-id="b0972-175">TCP</span></span> |<span data-ttu-id="b0972-176">Внутренний обмен данными для Redis</span><span class="sxs-lookup"><span data-stu-id="b0972-176">Internal communications for Redis</span></span> | <span data-ttu-id="b0972-177">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-177">(Redis subnet)</span></span> | <span data-ttu-id="b0972-178">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-178">(Redis subnet)</span></span> |
| <span data-ttu-id="b0972-179">20226</span><span class="sxs-lookup"><span data-stu-id="b0972-179">20226</span></span> |<span data-ttu-id="b0972-180">Исходящие</span><span class="sxs-lookup"><span data-stu-id="b0972-180">Outbound</span></span> |<span data-ttu-id="b0972-181">TCP</span><span class="sxs-lookup"><span data-stu-id="b0972-181">TCP</span></span> |<span data-ttu-id="b0972-182">Внутренний обмен данными для Redis</span><span class="sxs-lookup"><span data-stu-id="b0972-182">Internal communications for Redis</span></span> | <span data-ttu-id="b0972-183">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-183">(Redis subnet)</span></span> |<span data-ttu-id="b0972-184">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-184">(Redis subnet)</span></span> |
| <span data-ttu-id="b0972-185">13000-13999</span><span class="sxs-lookup"><span data-stu-id="b0972-185">13000-13999</span></span> |<span data-ttu-id="b0972-186">Исходящие</span><span class="sxs-lookup"><span data-stu-id="b0972-186">Outbound</span></span> |<span data-ttu-id="b0972-187">TCP</span><span class="sxs-lookup"><span data-stu-id="b0972-187">TCP</span></span> |<span data-ttu-id="b0972-188">Внутренний обмен данными для Redis</span><span class="sxs-lookup"><span data-stu-id="b0972-188">Internal communications for Redis</span></span> | <span data-ttu-id="b0972-189">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-189">(Redis subnet)</span></span> |<span data-ttu-id="b0972-190">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-190">(Redis subnet)</span></span> |
| <span data-ttu-id="b0972-191">15000-15999</span><span class="sxs-lookup"><span data-stu-id="b0972-191">15000-15999</span></span> |<span data-ttu-id="b0972-192">Исходящие</span><span class="sxs-lookup"><span data-stu-id="b0972-192">Outbound</span></span> |<span data-ttu-id="b0972-193">TCP</span><span class="sxs-lookup"><span data-stu-id="b0972-193">TCP</span></span> |<span data-ttu-id="b0972-194">Внутренний обмен данными для Redis</span><span class="sxs-lookup"><span data-stu-id="b0972-194">Internal communications for Redis</span></span> | <span data-ttu-id="b0972-195">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-195">(Redis subnet)</span></span> |<span data-ttu-id="b0972-196">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-196">(Redis subnet)</span></span> |


### <a name="inbound-port-requirements"></a><span data-ttu-id="b0972-197">Обязательные порты для входящего трафика</span><span class="sxs-lookup"><span data-stu-id="b0972-197">Inbound port requirements</span></span>

<span data-ttu-id="b0972-198">Существует восемь обязательных диапазонов портов для входящего трафика.</span><span class="sxs-lookup"><span data-stu-id="b0972-198">There are eight inbound port range requirements.</span></span> <span data-ttu-id="b0972-199">Входящие запросы в этих диапазонах исходят от других служб, размещенных в той же виртуальной сети, или являются результатом внутреннего обмена данными в подсети Redis.</span><span class="sxs-lookup"><span data-stu-id="b0972-199">Inbound requests in these ranges are either inbound from other services hosted in the same VNET or internal to the Redis subnet communications.</span></span>

| <span data-ttu-id="b0972-200">Порты</span><span class="sxs-lookup"><span data-stu-id="b0972-200">Port(s)</span></span> | <span data-ttu-id="b0972-201">Направление</span><span class="sxs-lookup"><span data-stu-id="b0972-201">Direction</span></span> | <span data-ttu-id="b0972-202">Транспортный протокол</span><span class="sxs-lookup"><span data-stu-id="b0972-202">Transport Protocol</span></span> | <span data-ttu-id="b0972-203">Назначение</span><span class="sxs-lookup"><span data-stu-id="b0972-203">Purpose</span></span> | <span data-ttu-id="b0972-204">Локальный IP-адрес</span><span class="sxs-lookup"><span data-stu-id="b0972-204">Local IP</span></span> | <span data-ttu-id="b0972-205">Удаленный IP-адрес</span><span class="sxs-lookup"><span data-stu-id="b0972-205">Remote IP</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="b0972-206">6379, 6380</span><span class="sxs-lookup"><span data-stu-id="b0972-206">6379, 6380</span></span> |<span data-ttu-id="b0972-207">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="b0972-207">Inbound</span></span> |<span data-ttu-id="b0972-208">TCP</span><span class="sxs-lookup"><span data-stu-id="b0972-208">TCP</span></span> |<span data-ttu-id="b0972-209">Обмен данными между клиентом и Redis, балансировка нагрузки Azure</span><span class="sxs-lookup"><span data-stu-id="b0972-209">Client communication to Redis, Azure load balancing</span></span> | <span data-ttu-id="b0972-210">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-210">(Redis subnet)</span></span> |<span data-ttu-id="b0972-211">Виртуальная сеть, Azure Load Balancer</span><span class="sxs-lookup"><span data-stu-id="b0972-211">Virtual Network, Azure Load Balancer</span></span> |
| <span data-ttu-id="b0972-212">8443</span><span class="sxs-lookup"><span data-stu-id="b0972-212">8443</span></span> |<span data-ttu-id="b0972-213">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="b0972-213">Inbound</span></span> |<span data-ttu-id="b0972-214">TCP</span><span class="sxs-lookup"><span data-stu-id="b0972-214">TCP</span></span> |<span data-ttu-id="b0972-215">Внутренний обмен данными для Redis</span><span class="sxs-lookup"><span data-stu-id="b0972-215">Internal communications for Redis</span></span> | <span data-ttu-id="b0972-216">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-216">(Redis subnet)</span></span> |<span data-ttu-id="b0972-217">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-217">(Redis subnet)</span></span> |
| <span data-ttu-id="b0972-218">8500</span><span class="sxs-lookup"><span data-stu-id="b0972-218">8500</span></span> |<span data-ttu-id="b0972-219">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="b0972-219">Inbound</span></span> |<span data-ttu-id="b0972-220">TCP/UDP</span><span class="sxs-lookup"><span data-stu-id="b0972-220">TCP/UDP</span></span> |<span data-ttu-id="b0972-221">Балансировка нагрузки Azure</span><span class="sxs-lookup"><span data-stu-id="b0972-221">Azure load balancing</span></span> | <span data-ttu-id="b0972-222">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-222">(Redis subnet)</span></span> |<span data-ttu-id="b0972-223">Azure Load Balancer</span><span class="sxs-lookup"><span data-stu-id="b0972-223">Azure Load Balancer</span></span> |
| <span data-ttu-id="b0972-224">10221-10231</span><span class="sxs-lookup"><span data-stu-id="b0972-224">10221-10231</span></span> |<span data-ttu-id="b0972-225">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="b0972-225">Inbound</span></span> |<span data-ttu-id="b0972-226">TCP</span><span class="sxs-lookup"><span data-stu-id="b0972-226">TCP</span></span> |<span data-ttu-id="b0972-227">Внутренний обмен данными для Redis</span><span class="sxs-lookup"><span data-stu-id="b0972-227">Internal communications for Redis</span></span> | <span data-ttu-id="b0972-228">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-228">(Redis subnet)</span></span> |<span data-ttu-id="b0972-229">(Подсеть Redis) Azure Load Balancer</span><span class="sxs-lookup"><span data-stu-id="b0972-229">(Redis subnet), Azure Load Balancer</span></span> |
| <span data-ttu-id="b0972-230">13000-13999</span><span class="sxs-lookup"><span data-stu-id="b0972-230">13000-13999</span></span> |<span data-ttu-id="b0972-231">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="b0972-231">Inbound</span></span> |<span data-ttu-id="b0972-232">TCP</span><span class="sxs-lookup"><span data-stu-id="b0972-232">TCP</span></span> |<span data-ttu-id="b0972-233">Обмен данными между клиентом и кластерами Redis, балансировка нагрузки Azure</span><span class="sxs-lookup"><span data-stu-id="b0972-233">Client communication to Redis Clusters, Azure load balancing</span></span> | <span data-ttu-id="b0972-234">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-234">(Redis subnet)</span></span> |<span data-ttu-id="b0972-235">Виртуальная сеть, Azure Load Balancer</span><span class="sxs-lookup"><span data-stu-id="b0972-235">Virtual Network, Azure Load Balancer</span></span> |
| <span data-ttu-id="b0972-236">15000-15999</span><span class="sxs-lookup"><span data-stu-id="b0972-236">15000-15999</span></span> |<span data-ttu-id="b0972-237">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="b0972-237">Inbound</span></span> |<span data-ttu-id="b0972-238">TCP</span><span class="sxs-lookup"><span data-stu-id="b0972-238">TCP</span></span> |<span data-ttu-id="b0972-239">Обмен данными между клиентом и кластерами Redis, балансировка нагрузки Azure</span><span class="sxs-lookup"><span data-stu-id="b0972-239">Client communication to Redis Clusters, Azure load Balancing</span></span> | <span data-ttu-id="b0972-240">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-240">(Redis subnet)</span></span> |<span data-ttu-id="b0972-241">Виртуальная сеть, Azure Load Balancer</span><span class="sxs-lookup"><span data-stu-id="b0972-241">Virtual Network, Azure Load Balancer</span></span> |
| <span data-ttu-id="b0972-242">16001</span><span class="sxs-lookup"><span data-stu-id="b0972-242">16001</span></span> |<span data-ttu-id="b0972-243">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="b0972-243">Inbound</span></span> |<span data-ttu-id="b0972-244">TCP/UDP</span><span class="sxs-lookup"><span data-stu-id="b0972-244">TCP/UDP</span></span> |<span data-ttu-id="b0972-245">Балансировка нагрузки Azure</span><span class="sxs-lookup"><span data-stu-id="b0972-245">Azure load balancing</span></span> | <span data-ttu-id="b0972-246">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-246">(Redis subnet)</span></span> |<span data-ttu-id="b0972-247">Azure Load Balancer</span><span class="sxs-lookup"><span data-stu-id="b0972-247">Azure Load Balancer</span></span> |
| <span data-ttu-id="b0972-248">20226</span><span class="sxs-lookup"><span data-stu-id="b0972-248">20226</span></span> |<span data-ttu-id="b0972-249">Входящий трафик</span><span class="sxs-lookup"><span data-stu-id="b0972-249">Inbound</span></span> |<span data-ttu-id="b0972-250">TCP</span><span class="sxs-lookup"><span data-stu-id="b0972-250">TCP</span></span> |<span data-ttu-id="b0972-251">Внутренний обмен данными для Redis</span><span class="sxs-lookup"><span data-stu-id="b0972-251">Internal communications for Redis</span></span> | <span data-ttu-id="b0972-252">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-252">(Redis subnet)</span></span> |<span data-ttu-id="b0972-253">(Подсеть Redis)</span><span class="sxs-lookup"><span data-stu-id="b0972-253">(Redis subnet)</span></span> |

### <a name="additional-vnet-network-connectivity-requirements"></a><span data-ttu-id="b0972-254">Дополнительные требования к подключению к виртуальной сети</span><span class="sxs-lookup"><span data-stu-id="b0972-254">Additional VNET network connectivity requirements</span></span>

<span data-ttu-id="b0972-255">Существуют требования к сетевому подключению кэша Redis для Azure, которым виртуальная сеть изначально может не соответствовать.</span><span class="sxs-lookup"><span data-stu-id="b0972-255">There are network connectivity requirements for Azure Redis Cache that may not be initially met in a virtual network.</span></span> <span data-ttu-id="b0972-256">Для правильной работы кэша Redis для Azure в виртуальной сети нужно выполнить все требования, перечисленные ниже.</span><span class="sxs-lookup"><span data-stu-id="b0972-256">Azure Redis Cache requires all the following items to function properly when used within a virtual network.</span></span>

* <span data-ttu-id="b0972-257">Исходящие сетевые подключения к конечным точкам хранилища Azure по всему миру.</span><span class="sxs-lookup"><span data-stu-id="b0972-257">Outbound network connectivity to Azure Storage endpoints worldwide.</span></span> <span data-ttu-id="b0972-258">Это относится к конечным точкам, находящимся в одном регионе с экземпляром кэша Redis для Azure, а также к конечным точкам хранилища, расположенным в **других** регионах Azure.</span><span class="sxs-lookup"><span data-stu-id="b0972-258">This includes endpoints located in the same region as the Azure Redis Cache instance, as well as storage endpoints located in **other** Azure regions.</span></span> <span data-ttu-id="b0972-259">Конечные точки службы хранилища Azure разрешаются в следующих DNS-доменах: *table.core.windows.net*, *blob.core.windows.net*, *queue.core.windows.net* и *file.core.windows.net*.</span><span class="sxs-lookup"><span data-stu-id="b0972-259">Azure Storage endpoints resolve under the following DNS domains: *table.core.windows.net*, *blob.core.windows.net*, *queue.core.windows.net*, and *file.core.windows.net*.</span></span> 
* <span data-ttu-id="b0972-260">Исходящие сетевые подключения к *ocsp.msocsp.com*, *mscrl.microsoft.com* и *crl.microsoft.com*. Такое подключение необходимо для поддержки функций протокола SSL.</span><span class="sxs-lookup"><span data-stu-id="b0972-260">Outbound network connectivity to *ocsp.msocsp.com*, *mscrl.microsoft.com*, and *crl.microsoft.com*. This connectivity is needed to support SSL functionality.</span></span>
* <span data-ttu-id="b0972-261">Конфигурация DNS для виртуальной сети должна поддерживать разрешение всех конечных точек и доменов, указанных в предыдущих точках.</span><span class="sxs-lookup"><span data-stu-id="b0972-261">The DNS configuration for the virtual network must be capable of resolving all of the endpoints and domains mentioned in the earlier points.</span></span> <span data-ttu-id="b0972-262">Эти требования DNS обеспечиваются за счет настройки допустимой инфраструктуры DNS и ее поддержания для виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="b0972-262">These DNS requirements can be met by ensuring a valid DNS infrastructure is configured and maintained for the virtual network.</span></span>
* <span data-ttu-id="b0972-263">Исходящие сетевые подключения к следующим конечным точкам мониторинга Azure, которые разрешаются в таких DNS-доменах: shoebox2-black.shoebox2.metrics.nsatc.net, north-prod2.prod2.metrics.nsatc.net, azglobal-black.azglobal.metrics.nsatc.net, shoebox2-red.shoebox2.metrics.nsatc.net, east-prod2.prod2.metrics.nsatc.net, azglobal-red.azglobal.metrics.nsatc.net.</span><span class="sxs-lookup"><span data-stu-id="b0972-263">Outbound network connectivity to the following Azure Monitoring endpoints, which resolve under the following DNS domains: shoebox2-black.shoebox2.metrics.nsatc.net, north-prod2.prod2.metrics.nsatc.net, azglobal-black.azglobal.metrics.nsatc.net, shoebox2-red.shoebox2.metrics.nsatc.net, east-prod2.prod2.metrics.nsatc.net, azglobal-red.azglobal.metrics.nsatc.net.</span></span>

### <a name="how-can-i-verify-that-my-cache-is-working-in-a-vnet"></a><span data-ttu-id="b0972-264">Как проверить, что кэш работает в виртуальной сети?</span><span class="sxs-lookup"><span data-stu-id="b0972-264">How can I verify that my cache is working in a VNET?</span></span>

>[!IMPORTANT]
><span data-ttu-id="b0972-265">При подключении к экземпляру кэша Redis для Azure, размещенному в виртуальной сети, клиенты кэша должны находиться в той же виртуальной сети, включая все тестовые приложения и средства диагностики для поверки связи.</span><span class="sxs-lookup"><span data-stu-id="b0972-265">When connecting to an Azure Redis Cache instance that is hosted in a VNET, your cache clients must be in the same VNET, including any test applications or diagnostic pinging tools.</span></span>
>
>

<span data-ttu-id="b0972-266">Когда обязательные порты настроены, как описано в предыдущем разделе, можно проверить работу кэша, выполнив следующие действия.</span><span class="sxs-lookup"><span data-stu-id="b0972-266">Once the port requirements are configured as described in the previous section, you can verify that your cache is working by performing the following steps.</span></span>

- <span data-ttu-id="b0972-267">[Перезагрузите](cache-administration.md#reboot) все узлы кэша.</span><span class="sxs-lookup"><span data-stu-id="b0972-267">[Reboot](cache-administration.md#reboot) all of the cache nodes.</span></span> <span data-ttu-id="b0972-268">Если не установить все необходимые зависимости кэша (как описано в разделах [Обязательные порты для входящего трафика](cache-how-to-premium-vnet.md#inbound-port-requirements) и [Обязательные порты для исходящего трафика](cache-how-to-premium-vnet.md#outbound-port-requirements)), то кэш не сможет перезапускаться.</span><span class="sxs-lookup"><span data-stu-id="b0972-268">If all of the required cache dependencies can't be reached (as documented in [Inbound port requirements](cache-how-to-premium-vnet.md#inbound-port-requirements) and [Outbound port requirements](cache-how-to-premium-vnet.md#outbound-port-requirements)), the cache won't be able to restart successfully.</span></span>
- <span data-ttu-id="b0972-269">После перезапуска узлов кэша (по данным о состоянии кэша на портале Azure) можно выполнить следующие поверки:</span><span class="sxs-lookup"><span data-stu-id="b0972-269">Once the cache nodes have restarted (as reported by the cache status in the Azure portal), you can perform the following tests:</span></span>
  - <span data-ttu-id="b0972-270">проверить связь с конечной точкой кэша (через порт 6380) с компьютера, который находится с кэшем в одной виртуальной сети, используя инструмент [tcping](https://www.elifulkerson.com/projects/tcping.php).</span><span class="sxs-lookup"><span data-stu-id="b0972-270">ping the cache endpoint (using port 6380) from a machine that is within the same VNET as the cache, using [tcping](https://www.elifulkerson.com/projects/tcping.php).</span></span> <span data-ttu-id="b0972-271">Например:</span><span class="sxs-lookup"><span data-stu-id="b0972-271">For example:</span></span>
    
    `tcping.exe contosocache.redis.cache.windows.net 6380`
    
    <span data-ttu-id="b0972-272">Если инструмент `tcping` сообщает, что порт открыт, то кэш доступен для подключения с клиентов в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="b0972-272">If the `tcping` tool reports that the port is open, the cache is available for connection from clients in the VNET.</span></span>

  - <span data-ttu-id="b0972-273">Другой способ проверки — создать тестовый клиент кэша (это может быть простое консольное приложение, использующее StackExchange.Redis), который подключается к кэшу и добавляет какие-то элементы в кэш или извлекает их из него.</span><span class="sxs-lookup"><span data-stu-id="b0972-273">Another way to test is to create a test cache client (which could be a simple console application using StackExchange.Redis) that connects to the cache and adds and retrieves some items from the cache.</span></span> <span data-ttu-id="b0972-274">Установите пример клиентского приложения на виртуальную машину, которая находится с кэшем в одной виртуальной сети, и запустите его, чтобы проверить подключение к кэшу.</span><span class="sxs-lookup"><span data-stu-id="b0972-274">Install the sample client application onto a VM that is in the same VNET as the cache and run it to verify connectivity to the cache.</span></span>


### <a name="can-i-use-vnets-with-a-standard-or-basic-cache"></a><span data-ttu-id="b0972-275">Можно ли использовать виртуальные сети в кэше уровня "Стандартный" или "Базовый"?</span><span class="sxs-lookup"><span data-stu-id="b0972-275">Can I use VNets with a standard or basic cache?</span></span>
<span data-ttu-id="b0972-276">Виртуальные сети доступны только для кэшей уровня "Премиум".</span><span class="sxs-lookup"><span data-stu-id="b0972-276">VNets can only be used with premium caches.</span></span>

### <a name="why-does-creating-a-redis-cache-fail-in-some-subnets-but-not-others"></a><span data-ttu-id="b0972-277">Почему в одних подсетях не удается создать кэш Redis, а в других удается?</span><span class="sxs-lookup"><span data-stu-id="b0972-277">Why does creating a Redis cache fail in some subnets but not others?</span></span>
<span data-ttu-id="b0972-278">При развертывании кэша Redis для Azure в виртуальной сети Resource Manager он должен размещаться в выделенной подсети, которая не содержит ресурсов другого типа.</span><span class="sxs-lookup"><span data-stu-id="b0972-278">If you are deploying an Azure Redis Cache to a Resource Manager VNet, the cache must be in a dedicated subnet that contains no other resource type.</span></span> <span data-ttu-id="b0972-279">Если попытаться развернуть кэш Redis для Azure в подсети виртуальной сети Resource Manager, содержащей другие ресурсы, то это приведет к сбою операции.</span><span class="sxs-lookup"><span data-stu-id="b0972-279">If an attempt is made to deploy an Azure Redis Cache to a Resource Manager VNet subnet that contains other resources, the deployment fails.</span></span> <span data-ttu-id="b0972-280">Прежде чем создать новый кэш Redis, необходимо удалить существующие ресурсы из подсети.</span><span class="sxs-lookup"><span data-stu-id="b0972-280">You must delete the existing resources inside the subnet before you can create a new Redis cache.</span></span>

<span data-ttu-id="b0972-281">В классической виртуальной сети можно развернуть ресурсы нескольких типов, пока для них имеется достаточно доступных IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="b0972-281">You can deploy multiple types of resources to a classic VNet as long as you have enough IP addresses available.</span></span>

### <a name="what-are-the-subnet-address-space-requirements"></a><span data-ttu-id="b0972-282">Каковы требования к адресному пространству подсети?</span><span class="sxs-lookup"><span data-stu-id="b0972-282">What are the subnet address space requirements?</span></span>
<span data-ttu-id="b0972-283">Azure резервирует некоторые IP-адреса в каждой подсети, которые нельзя использовать.</span><span class="sxs-lookup"><span data-stu-id="b0972-283">Azure reserves some IP addresses within each subnet, and these addresses can't be used.</span></span> <span data-ttu-id="b0972-284">Зарезервированы первый и последний IP-адреса подсетей (для соответствия требованиям протокола), а также еще три адреса, используемые для служб Azure.</span><span class="sxs-lookup"><span data-stu-id="b0972-284">The first and last IP addresses of the subnets are reserved for protocol conformance, along with three more addresses used for Azure services.</span></span> <span data-ttu-id="b0972-285">Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)</span><span class="sxs-lookup"><span data-stu-id="b0972-285">For more information, see [Are there any restrictions on using IP addresses within these subnets?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)</span></span>

<span data-ttu-id="b0972-286">Помимо IP-адресов, используемых инфраструктурой виртуальной сети Azure, каждый экземпляр Redis в подсети использует два IP-адреса на сегмент и еще один IP-адрес для балансировщика нагрузки.</span><span class="sxs-lookup"><span data-stu-id="b0972-286">In addition to the IP addresses used by the Azure VNET infrastructure, each Redis instance in the subnet uses two IP addresses per shard and one additional IP address for the load balancer.</span></span> <span data-ttu-id="b0972-287">Некластеризованный кэш считается имеющим один сегмент.</span><span class="sxs-lookup"><span data-stu-id="b0972-287">A non-clustered cache is considered to have one shard.</span></span>

### <a name="do-all-cache-features-work-when-hosting-a-cache-in-a-vnet"></a><span data-ttu-id="b0972-288">Do all cache features work when hosting a cache in a VNET? (Все ли функции кэша работают, когда он размещен в виртуальной сети?)</span><span class="sxs-lookup"><span data-stu-id="b0972-288">Do all cache features work when hosting a cache in a VNET?</span></span>
<span data-ttu-id="b0972-289">Если кэш является частью виртуальной сети, то к нему могут обращаться только клиенты в этой виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="b0972-289">When your cache is part of a VNET, only clients in the VNET can access the cache.</span></span> <span data-ttu-id="b0972-290">Поэтому следующие функции управления кэшем в данный момент не работают.</span><span class="sxs-lookup"><span data-stu-id="b0972-290">As a result, the following cache management features don't work at this time.</span></span>

* <span data-ttu-id="b0972-291">Консоль Redis. Так как консоль Redis работает в локальном браузере вне виртуальной сети, она не может подключиться к кэшу.</span><span class="sxs-lookup"><span data-stu-id="b0972-291">Redis Console - Because Redis Console runs in your local browser, which is outside the VNET, it can't connect to your cache.</span></span>

## <a name="use-expressroute-with-azure-redis-cache"></a><span data-ttu-id="b0972-292">Использование ExpressRoute с кэшем Redis для Azure</span><span class="sxs-lookup"><span data-stu-id="b0972-292">Use ExpressRoute with Azure Redis Cache</span></span>
<span data-ttu-id="b0972-293">Клиенты могут подключить канал [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/) к своей инфраструктуре виртуальной сети, расширяя таким образом свою локальную сеть в Azure.</span><span class="sxs-lookup"><span data-stu-id="b0972-293">Customers can connect an [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/) circuit to their virtual network infrastructure, thus extending their on-premises network to Azure.</span></span> 

<span data-ttu-id="b0972-294">По умолчанию только что созданный канал ExpressRoute не выполняет принудительное туннелирование (объявление маршрута по умолчанию, 0.0.0.0/0) в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="b0972-294">By default, a newly created ExpressRoute circuit does not perform forced tunneling (advertisement of a default route, 0.0.0.0/0) on a VNET.</span></span> <span data-ttu-id="b0972-295">В результате исходящие подключения к Интернету выполняются напрямую из виртуальной сети, а клиентские приложения могут подключаться к другим конечным точкам Azure, включая кэш Redis для Azure.</span><span class="sxs-lookup"><span data-stu-id="b0972-295">As a result, outbound Internet connectivity is allowed directly from the VNET and client applications are able to connect to other Azure endpoints including Azure Redis Cache.</span></span>

<span data-ttu-id="b0972-296">Тем не менее типовой клиентской конфигурацией является использование принудительного туннелирования (объявление маршрута по умолчанию), которое вместо этого направляет исходящий интернет-трафик в локальную среду.</span><span class="sxs-lookup"><span data-stu-id="b0972-296">However a common customer configuration is to use forced tunneling (advertise a default route) which forces outbound Internet traffic to instead flow on-premises.</span></span> <span data-ttu-id="b0972-297">Этот поток трафика прерывает подключение к кэшу Redis для Azure, если исходящий трафик затем блокируется локально, так что экземпляр кэша Redis для Azure не может связаться со своими зависимыми компонентами.</span><span class="sxs-lookup"><span data-stu-id="b0972-297">This traffic flow breaks connectivity with Azure Redis Cache if the outbound traffic is then blocked on-premises such that the Azure Redis Cache instance is not able to communicate with its dependencies.</span></span>

<span data-ttu-id="b0972-298">Чтобы устранить эту проблему, следует указать один (или несколько) определяемый пользователем маршрут в подсети, которая содержит кэш Redis для Azure.</span><span class="sxs-lookup"><span data-stu-id="b0972-298">The solution is to define one (or more) user-defined routes (UDRs) on the subnet that contains the Azure Redis Cache.</span></span> <span data-ttu-id="b0972-299">Определяемые пользователем маршруты задают маршруты для подсети, которые будут использоваться вместо основного маршрута.</span><span class="sxs-lookup"><span data-stu-id="b0972-299">A UDR defines subnet-specific routes that will be honored instead of the default route.</span></span>

<span data-ttu-id="b0972-300">При возможности рекомендуется использовать следующую конфигурацию:</span><span class="sxs-lookup"><span data-stu-id="b0972-300">If possible, it is recommended to use the following configuration:</span></span>

* <span data-ttu-id="b0972-301">Конфигурация ExpressRoute объявляет маршрут 0.0.0.0/0 и по умолчанию организует принудительное туннелирование всех исходящих подключений в локальную среду.</span><span class="sxs-lookup"><span data-stu-id="b0972-301">The ExpressRoute configuration advertises 0.0.0.0/0 and by default force tunnels all outbound traffic on-premises.</span></span>
* <span data-ttu-id="b0972-302">Определяемый пользователем маршрут, примененный к подсети, содержащей кэш Redis для Azure, задает рабочий маршрут 0.0.0.0/0 для трафика TCP/IP, направляемого в общедоступный Интернет. Для этого может задаваться, например, следующий переход типа "Интернет".</span><span class="sxs-lookup"><span data-stu-id="b0972-302">The UDR applied to the subnet containing the Azure Redis Cache defines 0.0.0.0/0 with a working route for TCP/IP traffic to the public internet; for example by setting the next hop type to 'Internet'.</span></span>

<span data-ttu-id="b0972-303">В результате этих действий определяемый пользователем маршрут уровня подсети получает приоритет над принудительным туннелированием ExpressRoute, обеспечивая исходящий интернет-доступ из кэша Redis для Azure.</span><span class="sxs-lookup"><span data-stu-id="b0972-303">The combined effect of these steps is that the subnet level UDR takes precedence over the ExpressRoute forced tunneling, thus ensuring outbound Internet access from the Azure Redis Cache.</span></span>

<span data-ttu-id="b0972-304">Подключение к экземпляру кэша Redis для Azure из локального приложения с помощью ExpressRoute — нетипичная ситуация по соображениям производительности (для повышения производительности клиенты кэша Redis для Azure должны быть в том же регионе, что и кэш Redis для Azure).</span><span class="sxs-lookup"><span data-stu-id="b0972-304">Connecting to an Azure Redis Cache instance from an on-premises application using ExpressRoute is not a typical usage scenario due to performance reasons (for best performance Azure Redis Cache clients should be in the same region as the Azure Redis Cache).</span></span>

>[!IMPORTANT] 
><span data-ttu-id="b0972-305">Маршруты, указанные в UDR, **должны** быть достаточно конкретными, чтобы иметь приоритет над всеми маршрутами, объявленными в конфигурации ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="b0972-305">The routes defined in a UDR **must** be specific enough to take precedence over any routes advertised by the ExpressRoute configuration.</span></span> <span data-ttu-id="b0972-306">В приведенном ниже примере используется широкий диапазон адресов 0.0.0.0/0, и, таким образом, он может быть случайно заменен объявлениями маршрутов с более узкими диапазонами адресов.</span><span class="sxs-lookup"><span data-stu-id="b0972-306">The following example uses the broad 0.0.0.0/0 address range, and as such can potentially be accidentally overridden by route advertisements using more specific address ranges.</span></span>

>[!WARNING]  
><span data-ttu-id="b0972-307">Кэш Redis для Azure не поддерживается с конфигурациями ExpressRoute, которые **неправильно осуществляют перекрестное объявление маршрутов из пути общедоступного пиринга в путь частного пиринга**.</span><span class="sxs-lookup"><span data-stu-id="b0972-307">Azure Redis Cache is not supported with ExpressRoute configurations that **incorrectly cross-advertise routes from the public peering path to the private peering path**.</span></span> <span data-ttu-id="b0972-308">Конфигурации ExpressRoute, для которых настроен общедоступный пиринг, будут получать объявления маршрутов от корпорации Майкрософт для большого набора диапазонов IP-адресов Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="b0972-308">ExpressRoute configurations that have public peering configured, receive route advertisements from Microsoft for a large set of Microsoft Azure IP address ranges.</span></span> <span data-ttu-id="b0972-309">Если эти диапазоны адресов неправильно перекрестно объявляются по пути частного пиринга, то все исходящие сетевые пакеты из подсети экземпляра кэша Redis для Azure неправильно принудительно туннелируются в локальную сетевую инфраструктуру клиента.</span><span class="sxs-lookup"><span data-stu-id="b0972-309">If these address ranges are incorrectly cross-advertised on the private peering path, the result is that all outbound network packets from the Azure Redis Cache instance's subnet are incorrectly force-tunneled to a customer's on-premises network infrastructure.</span></span> <span data-ttu-id="b0972-310">Этот сетевой поток нарушает работу кэша Redis для Azure.</span><span class="sxs-lookup"><span data-stu-id="b0972-310">This network flow breaks Azure Redis Cache.</span></span> <span data-ttu-id="b0972-311">Решением этой проблемы является остановка перекрестного объявления маршрутов между путем общедоступного и закрытого пиринга.</span><span class="sxs-lookup"><span data-stu-id="b0972-311">The solution to this problem is to stop cross-advertising routes from the public peering path to the private peering path.</span></span>


<span data-ttu-id="b0972-312">Справочные сведения об определяемых пользователем маршрутах см. в этом [обзоре](../virtual-network/virtual-networks-udr-overview.md).</span><span class="sxs-lookup"><span data-stu-id="b0972-312">Background information on user-defined routes is available in this [overview](../virtual-network/virtual-networks-udr-overview.md).</span></span>

<span data-ttu-id="b0972-313">Дополнительные сведения об ExpressRoute см. в статье [Технический обзор ExpressRoute](../expressroute/expressroute-introduction.md).</span><span class="sxs-lookup"><span data-stu-id="b0972-313">For more information about ExpressRoute, see [ExpressRoute technical overview](../expressroute/expressroute-introduction.md).</span></span>

## <a name="next-steps"></a><span data-ttu-id="b0972-314">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="b0972-314">Next steps</span></span>
<span data-ttu-id="b0972-315">Узнайте, как использовать расширенные функции кэша.</span><span class="sxs-lookup"><span data-stu-id="b0972-315">Learn how to use more premium cache features.</span></span>

* [<span data-ttu-id="b0972-316">Знакомство с кэшем Redis для Azure уровня Премиум</span><span class="sxs-lookup"><span data-stu-id="b0972-316">Introduction to the Azure Redis Cache Premium tier</span></span>](cache-premium-tier-intro.md)

<!-- IMAGES -->

[redis-cache-vnet]: ./media/cache-how-to-premium-vnet/redis-cache-vnet.png

[redis-cache-vnet-ip]: ./media/cache-how-to-premium-vnet/redis-cache-vnet-ip.png

[redis-cache-vnet-info]: ./media/cache-how-to-premium-vnet/redis-cache-vnet-info.png


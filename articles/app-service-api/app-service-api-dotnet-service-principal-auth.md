---
title: "Проверка подлинности с использованием субъекта-службы для приложений API в службе приложений Azure | Документация Майкрософт"
description: "Узнайте, как защитить приложение API в службе приложений Azure для сценариев взаимодействия служб."
services: app-service\api
documentationcenter: .net
author: alexkarcher-msft
manager: erikre
editor: 
ms.assetid: 7ca0bab2-1d29-4d51-b779-dce0edd34f8b
ms.service: app-service-api
ms.workload: na
ms.tgt_pltfrm: dotnet
ms.devlang: na
ms.topic: article
ms.date: 06/30/2016
ms.author: alkarche
ms.openlocfilehash: 95653287546bbe358111ed16af0c30a53caff2b5
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="service-principal-authentication-for-api-apps-in-azure-app-service"></a><span data-ttu-id="2bbd2-103">Проверка подлинности с использованием субъекта-службы для приложений API в службе приложений Azure</span><span class="sxs-lookup"><span data-stu-id="2bbd2-103">Service principal authentication for API Apps in Azure App Service</span></span>
## <a name="overview"></a><span data-ttu-id="2bbd2-104">Обзор</span><span class="sxs-lookup"><span data-stu-id="2bbd2-104">Overview</span></span>
<span data-ttu-id="2bbd2-105">В этой статье объясняется, как использовать проверку подлинности службы приложений для *внутреннего* доступа к приложениям API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-105">This article explains how to use App Service authentication for *internal* access to API apps.</span></span> <span data-ttu-id="2bbd2-106">Во внутреннем сценарии у вас есть приложение API, которое должно использоваться только в коде вашего приложения.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-106">An internal scenario is where you have an API app that you want to be consumable only by your own application code.</span></span> <span data-ttu-id="2bbd2-107">Рекомендуемый способ реализовать этот сценарий в службе приложений — использовать Azure AD для защиты вызываемого приложения API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-107">The recommended way to implement this scenario in App Service is to use Azure AD to protect the called API app.</span></span> <span data-ttu-id="2bbd2-108">Вызовите защищенное приложение API с токеном носителя, полученного из Azure AD, указав учетные данные удостоверения приложения (субъекта-службы).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-108">You call the protected API app with a bearer token that you get from Azure AD by providing application identity (service principal) credentials.</span></span> <span data-ttu-id="2bbd2-109">Альтернативные варианты использования Azure AD см. в разделе **Взаимодействие между службами** статьи [Проверка подлинности и авторизация в службе приложений Azure](../app-service/app-service-authentication-overview.md#service-to-service-authentication).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-109">For alternatives to using Azure AD, see the **Service-to-service authentication** section of the [Azure App Service authentication overview](../app-service/app-service-authentication-overview.md#service-to-service-authentication).</span></span>

<span data-ttu-id="2bbd2-110">Из этой статьи вы узнаете следующее.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-110">In this article, you'll learn:</span></span>

* <span data-ttu-id="2bbd2-111">Как использовать Azure Active Directory (Azure AD) для защиты приложения API от доступа без проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-111">How to use Azure Active Directory (Azure AD) to protect an API app from unauthenticated access.</span></span>
* <span data-ttu-id="2bbd2-112">Как использовать защищенное приложение API из приложения API, веб-приложения или мобильного приложения с помощью учетных данных субъекта-службы (удостоверения приложения).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-112">How to consume a protected API app from an API app, web app, or mobile app by using Azure AD service principal (app identity) credentials.</span></span> <span data-ttu-id="2bbd2-113">Сведения о том, как использовать защищенное приложение API из приложения логики, см. в статье [Использование настраиваемого интерфейса API, размещенного в службе приложений, с приложениями логики](../logic-apps/logic-apps-custom-hosted-api.md).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-113">For information about how to consume from a logic app, see [Using your custom API hosted on App Service with Logic apps](../logic-apps/logic-apps-custom-hosted-api.md).</span></span>
* <span data-ttu-id="2bbd2-114">Что нужно сделать, чтобы вошедшие в систему пользователи не могли вызывать защищенное приложение API из браузера.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-114">How to make sure that the protected API app can't be called from a browser by logged on users.</span></span>
* <span data-ttu-id="2bbd2-115">Что нужно сделать, чтобы защищенное приложение API мог вызывать только конкретный субъект-служба Azure AD.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-115">How to make sure that the protected API app can only be called by a specific Azure AD service principal.</span></span>

<span data-ttu-id="2bbd2-116">Статья содержит два раздела.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-116">The article contains two sections:</span></span>

* <span data-ttu-id="2bbd2-117">В разделе [Настройка проверки подлинности субъекта-службы в службе приложений Azure](#authconfig) объясняется в общих чертах, как настроить проверку подлинности для любого приложения API и как использовать защищенное приложение API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-117">The [How to configure service principal authentication in Azure App Service](#authconfig) section explains in general how to configure authentication for any API app, and how to consume the protected API app.</span></span> <span data-ttu-id="2bbd2-118">Инструкции из этого раздела применимы ко всем платформам, которые поддерживает служба приложений, в том числе .NET, Node.js и Java.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-118">This section applies equally to all frameworks supported by App Service, including .NET, Node.js, and Java.</span></span>
* <span data-ttu-id="2bbd2-119">Начиная с раздела [Продолжение учебников по началу работы с .NET](#tutorialstart) этой статьи вы найдете инструкции по настройке "внутреннего доступа" для примера приложения .NET, работающего в службе приложений.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-119">Starting with the [Continuing the .NET getting-started tutorials](#tutorialstart) section, the tutorial guides you through configuring an "internal access" scenario for a .NET sample application running in App Service.</span></span> 

## <span data-ttu-id="2bbd2-120"><a id="authconfig"></a> Настройка проверки подлинности субъекта-службы в службе приложений Azure</span><span class="sxs-lookup"><span data-stu-id="2bbd2-120"><a id="authconfig"></a> How to configure service principal authentication in Azure App Service</span></span>
<span data-ttu-id="2bbd2-121">Этот раздел содержит общие инструкции, которые применимы к любому приложению API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-121">This section provides general instructions that apply to any API app.</span></span> <span data-ttu-id="2bbd2-122">Конкретные инструкции для примера приложения .NET To Do List см. в разделе [Продолжение руководств по началу работы с .NET](#tutorialstart).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-122">For steps specific to the To Do List .NET sample application, go to [Continuing the .NET API Apps tutorial series](#tutorialstart).</span></span>

1. <span data-ttu-id="2bbd2-123">На [портале Azure](https://portal.azure.com/) перейдите к колонке **Параметры** приложения API, которое требуется защитить, найдите раздел **Функции** и щелкните **Проверка подлинности и авторизация**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-123">In the [Azure portal](https://portal.azure.com/), navigate to the **Settings** blade of the API app that you want to protect, and then find the **Features** section and click **Authentication/ Authorization**.</span></span>
   
    ![Проверка подлинности и авторизация на портале Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)
2. <span data-ttu-id="2bbd2-125">В колонке **Проверка подлинности и авторизация** щелкните **Вкл.**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-125">In the **Authentication / Authorization** blade, click **On**.</span></span>
3. <span data-ttu-id="2bbd2-126">В раскрывающемся списке **Предпринимаемое действие, если проверка подлинности для запроса не выполнена** выберите **Войти с использованием Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-126">In the **Action to take when request is not authenticated** drop-down list, select **Log in with Azure Active Directory** .</span></span>
4. <span data-ttu-id="2bbd2-127">В разделе **Поставщики проверки подлинности** выберите **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-127">Under **Authentication Providers**, select **Azure Active Directory**.</span></span>
   
    ![Колонка "Проверка подлинности и авторизация" на портале Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)
5. <span data-ttu-id="2bbd2-129">Настройте колонку **Параметры Azure Active Directory** , чтобы создать приложение Azure AD, или выберите существующее приложение Azure AD.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-129">Configure the **Azure Active Directory Settings** blade to create a new Azure AD application, or use an existing Azure AD application if you already have one that you want to use.</span></span>
   
    <span data-ttu-id="2bbd2-130">Во внутренних сценариях обычно участвует приложение API, которое вызывает приложение API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-130">Internal scenarios typically involve an API app calling an API app.</span></span> <span data-ttu-id="2bbd2-131">Вы можете использовать отдельные приложения Azure AD для каждого приложения API или только одно приложение Azure AD.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-131">You can use separate Azure AD applications for each API app or just one Azure AD application.</span></span>
   
    <span data-ttu-id="2bbd2-132">Подробные инструкции по настройке этой колонки см. в статье [Настройка приложения службы приложений для использования службы входа Azure Active Directory](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-132">For detailed instructions on this blade, see [How to configure your App Service application to use Azure Active Directory login](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md).</span></span>
6. <span data-ttu-id="2bbd2-133">Закончив настройку колонки поставщика проверки подлинности, нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-133">When you're done with the authentication provider configuration blade, click **OK**.</span></span>
7. <span data-ttu-id="2bbd2-134">В колонке **Проверка подлинности и авторизация** нажмите кнопку **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-134">In the **Authentication / Authorization** blade, click **Save**.</span></span>
   
    ![Щелкните Сохранить](./media/app-service-api-dotnet-service-principal-auth/authsave.png)

<span data-ttu-id="2bbd2-136">После этого служба приложений будет разрешать только запросы от вызывающих сторон в настроенном клиенте Azure AD.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-136">When this is done, App Service only allows requests from callers in the configured Azure AD tenant.</span></span> <span data-ttu-id="2bbd2-137">В защищенном приложении API код проверки подлинности или авторизации не требуется.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-137">No authentication or authorization code is required in the protected API app.</span></span> <span data-ttu-id="2bbd2-138">Токен носителя передается в приложение API вместе с часто используемыми утверждениями в заголовках HTTP. Эту информацию можно прочитать в коде для проверки запросов от определенной вызывающей стороны, например субъекта-службы.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-138">The bearer token is passed to the API app along with commonly used claims in HTTP headers, and you can read that information in code to validate that requests are from a particular caller, such as a service principal.</span></span>

<span data-ttu-id="2bbd2-139">Эта функция проверки подлинности работает одинаково для всех языков, которые поддерживает служба приложений, в том числе .NET, Node.js и Java.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-139">This authentication functionality works the same way for all languages that App service supports, including .NET, Node.js, and Java.</span></span> 

#### <a name="how-to-consume-the-protected-api-app"></a><span data-ttu-id="2bbd2-140">Использование защищенного приложения API</span><span class="sxs-lookup"><span data-stu-id="2bbd2-140">How to consume the protected API app</span></span>
<span data-ttu-id="2bbd2-141">Вызывающая сторона должна предоставить токен носителя Azure AD с вызовами API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-141">The caller must provide an Azure AD bearer token with API calls.</span></span> <span data-ttu-id="2bbd2-142">Чтобы получить токен носителя с помощью учетных данных субъекта-службы, вызывающая сторона использует библиотеку проверки подлинности Active Directory (ADAL для [.NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory), [Node.js](https://github.com/AzureAD/azure-activedirectory-library-for-nodejs) или [Java](https://github.com/AzureAD/azure-activedirectory-library-for-java)).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-142">To get a bearer token using service principal credentials, the caller uses Active Directory Authentication Library (ADAL for [.NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory), [Node.js](https://github.com/AzureAD/azure-activedirectory-library-for-nodejs), or [Java](https://github.com/AzureAD/azure-activedirectory-library-for-java)).</span></span> <span data-ttu-id="2bbd2-143">Чтобы получить токен, код, который вызывает библиотеку ADAL, предоставляет ей следующую информацию.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-143">To get a token, the code that calls ADAL provides to ADAL the following information:</span></span>

* <span data-ttu-id="2bbd2-144">Имя вашего клиента Azure AD.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-144">The name of your Azure AD tenant.</span></span>
* <span data-ttu-id="2bbd2-145">Идентификатор клиента и секрет клиента (ключ приложения) приложения Azure AD, связанного с вызывающей стороной.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-145">The client ID and client secret (app key) of the Azure AD app associated with the caller.</span></span>
* <span data-ttu-id="2bbd2-146">Идентификатор клиента приложения Azure AD, связанного с защищенным приложением API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-146">The client ID of the Azure AD application associated with the protected API app.</span></span> <span data-ttu-id="2bbd2-147">(Если используется только одно приложение Azure AD, это тот же идентификатор клиента, который указывается для вызывающей стороны.)</span><span class="sxs-lookup"><span data-stu-id="2bbd2-147">(If just one Azure AD application is used, this is the same client ID as the one for the caller.)</span></span>

<span data-ttu-id="2bbd2-148">Эти значения доступны на страницах Azure AD [классического портала Azure](https://manage.windowsazure.com/).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-148">These values are available in the Azure AD pages of the [Azure classic portal](https://manage.windowsazure.com/).</span></span>

<span data-ttu-id="2bbd2-149">Получив токен, вызывающая сторона включает его в HTTP-запросы в заголовке авторизации.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-149">Once the token has been acquired, the caller includes it with HTTP requests in the Authorization header.</span></span>  <span data-ttu-id="2bbd2-150">Служба приложений проверяет токен и разрешает запросам достигать защищенного приложения API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-150">App Service validates the token and allows the requests to reach the protected API app.</span></span>

#### <a name="how-to-protect-the-api-app-from-access-by-users-in-the-same-tenant"></a><span data-ttu-id="2bbd2-151">Как защитить приложение API от доступа пользователей в том же клиенте</span><span class="sxs-lookup"><span data-stu-id="2bbd2-151">How to protect the API app from access by users in the same tenant</span></span>
<span data-ttu-id="2bbd2-152">Токены носителя для пользователей в том же клиенте считаются допустимыми для защищенного приложения API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-152">Bearer tokens for users in the same tenant are considered valid for the protected API app.</span></span>  <span data-ttu-id="2bbd2-153">Если вы хотите, чтобы только субъект-служба мог вызывать защищенное приложение API, добавьте код в защищенное приложение API, чтобы проверить следующие утверждения из токена:</span><span class="sxs-lookup"><span data-stu-id="2bbd2-153">If you want to ensure that only a service principal can call the protected API app, add code in the protected API app to validate the following claims from the token:</span></span>

* <span data-ttu-id="2bbd2-154">`appid` должно быть идентификатором клиента приложения Azure AD, связанного с вызывающей стороной.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-154">`appid` should be the client ID of the Azure AD application that is associated with the caller.</span></span> 
* <span data-ttu-id="2bbd2-155">Значение `oid` (`objectidentifier`) должно быть идентификатором субъекта-службы вызывающей стороны.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-155">`oid` (`objectidentifier`) should be the service principal ID of the caller.</span></span> 

<span data-ttu-id="2bbd2-156">Служба приложений также указывает утверждение `objectidentifier` в заголовке X-MS-CLIENT-PRINCIPAL-ID.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-156">App Service also provides the `objectidentifier` claim in the X-MS-CLIENT-PRINCIPAL-ID header.</span></span>

### <a name="how-to-protect-the-api-app-from-browser-access"></a><span data-ttu-id="2bbd2-157">Защита приложения API от доступа из браузера</span><span class="sxs-lookup"><span data-stu-id="2bbd2-157">How to protect the API app from browser access</span></span>
<span data-ttu-id="2bbd2-158">Если вы не проверяете утверждения в коде защищенного приложения API и используете отдельное приложение Azure AD для защищенного приложения API, проследите за тем, чтобы URL-адрес ответа приложения Azure AD не совпадал с базовым URL-адресом приложения API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-158">If you don't validate claims in code in the protected API app, and if you use a separate Azure AD application for the protected API app, make sure that the Azure AD application's Reply URL is not the same as the API app's base URL.</span></span> <span data-ttu-id="2bbd2-159">Если URL-адрес ответа указывает непосредственно на защищенное приложение API, пользователь в том же клиенте Azure AD может перейти в приложение API, войти в систему и успешно вызвать API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-159">If the Reply URL points directly to the protected API app, a user in the same Azure AD tenant could browse to the API app, log on, and successfully call the API.</span></span>

## <span data-ttu-id="2bbd2-160"><a id="tutorialstart"></a> Продолжение руководств по началу работы с .NET</span><span class="sxs-lookup"><span data-stu-id="2bbd2-160"><a id="tutorialstart"></a> Continuing the .NET API Apps tutorial series</span></span>
<span data-ttu-id="2bbd2-161">Если вы изучаете серию учебников для приложений API по работе с Node.js или Java, перейдите к разделу [Дальнейшие действия](#next-steps) .</span><span class="sxs-lookup"><span data-stu-id="2bbd2-161">If you are following the Node.js or Java tutorial series for API apps, skip to the [Next steps](#next-steps) section.</span></span> 

<span data-ttu-id="2bbd2-162">В оставшейся части этой статьи продолжается серия руководств для приложений API по работе с .NET. В ней предполагается, что вы ознакомились с [руководством по проверке подлинности пользователей](app-service-api-dotnet-user-principal-auth.md) и создали пример приложения, работающего в Azure с включенной проверкой подлинности пользователей.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-162">The remainder of this article continues the .NET API Apps tutorial series and assumes that you have completed the [user authentication tutorial](app-service-api-dotnet-user-principal-auth.md) and have the sample application running in Azure with user authentication enabled.</span></span>

## <a name="set-up-authentication-in-azure"></a><span data-ttu-id="2bbd2-163">Настройка проверки подлинности в Azure</span><span class="sxs-lookup"><span data-stu-id="2bbd2-163">Set up authentication in Azure</span></span>
<span data-ttu-id="2bbd2-164">В этом разделе вы настроите службу приложений так, чтобы приложение API уровня данных было доступно только для HTTP-запросов, которые имеют допустимые токены носителя Azure AD.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-164">In this section you configure App Service so that the only HTTP requests it allows to reach the data tier API app are the ones that have valid Azure AD bearer tokens.</span></span> 

<span data-ttu-id="2bbd2-165">В следующем разделе вы настроите приложение API среднего уровня таким образом, чтобы оно передавало учетные данные приложения в Azure AD, возвращало токен носителя и отправляло токен носителя в приложение API уровня данных.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-165">In the following section, you configure the middle tier API app to send application credentials to Azure AD, get back a bearer token, and send the bearer token to the data tier API app.</span></span> <span data-ttu-id="2bbd2-166">Этот процесс показан на схеме.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-166">This process is illustrated in the diagram.</span></span>

![Схема проверки подлинности службы](./media/app-service-api-dotnet-service-principal-auth/appdiagram.png)

<span data-ttu-id="2bbd2-168">Если при выполнении указаний в руководстве у вас возникли проблемы, см. раздел [Устранение неполадок](#troubleshooting) в конце этого руководства.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-168">If you run into problems while following the tutorial directions, see the [Troubleshooting](#troubleshooting) section at the end of the tutorial.</span></span> 

1. <span data-ttu-id="2bbd2-169">На [портале Azure](https://portal.azure.com/) перейдите к колонке **Параметры** приложения API, созданного для приложения ToDoListDataAPI (уровень данных), и щелкните **Параметры**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-169">In the [Azure portal](https://portal.azure.com/), navigate to the **Settings** blade of the API app that you created for the ToDoListDataAPI (data tier) API app, and then click **Settings**.</span></span>
2. <span data-ttu-id="2bbd2-170">В колонке **Параметры** найдите раздел **Функции** и щелкните элемент **Проверка подлинности и авторизация**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-170">In the **Settings** blade, find the **Features** section, and then click **Authentication / Authorization**.</span></span>
   
    ![Проверка подлинности и авторизация на портале Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)
3. <span data-ttu-id="2bbd2-172">В колонке **Проверка подлинности и авторизация** щелкните **Вкл.**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-172">In the **Authentication / Authorization** blade, click **On**.</span></span>
4. <span data-ttu-id="2bbd2-173">В раскрывающемся списке **Действие, выполняемое, если запрос не прошел проверку подлинности** выберите **Войти с помощью Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-173">In the **Action to take when request is not authenticated** drop-down list, select **Log in with Azure Active Directory**.</span></span>
   
    <span data-ttu-id="2bbd2-174">Если этот параметр выбран, служба приложений следит за тем, чтобы только прошедшие проверку подлинности запросы достигали приложения API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-174">This is the setting that causes App Service to ensure that only authenticated requests reach the API app.</span></span> <span data-ttu-id="2bbd2-175">Если поступают запросы, имеющие допустимые токены носителя, служба приложений передает токены в приложение API и заполняет заголовки HTTP часто используемыми утверждениями, чтобы коду было легче получить эту информацию.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-175">For requests that have valid bearer tokens, App Service passes the tokens along to the API app and populates HTTP headers with commonly used claims to make that information more easily available to your code.</span></span>
5. <span data-ttu-id="2bbd2-176">В разделе **Поставщики проверки подлинности** щелкните **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-176">Under **Authentication Providers**, click **Azure Active Directory**.</span></span>
   
    ![Колонка "Проверка подлинности и авторизация" на портале Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)
6. <span data-ttu-id="2bbd2-178">В колонке **Параметры Azure Active Directory** щелкните **Экспресс**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-178">In the **Azure Active Directory Settings** blade, click **Express**.</span></span>
   
    <span data-ttu-id="2bbd2-179">Если выбран параметр **Экспресс**, Azure может автоматически создать приложение AAD в [клиенте](https://msdn.microsoft.com/en-us/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant) Azure AD.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-179">With the **Express** option Azure can automatically create an AAD application in your Azure AD [tenant](https://msdn.microsoft.com/en-us/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant).</span></span> 
   
    <span data-ttu-id="2bbd2-180">Вам не нужно создавать клиент, так как каждая учетная запись Azure автоматически содержит клиент.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-180">You don't have to create a tenant, because every Azure account automatically has one.</span></span>
7. <span data-ttu-id="2bbd2-181">В разделе **Режим управления** щелкните **Создать новое приложение AD**, если этот параметр еще не выбран.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-181">Under **Management mode**, click **Create New AD App** if it isn't already selected.</span></span>
   
    <span data-ttu-id="2bbd2-182">Портал заполняет поле ввода **Создание приложения** значением по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-182">The portal plugs the **Create App** input box with a default value.</span></span> <span data-ttu-id="2bbd2-183">По умолчанию приложение Azure AD называется так же, как приложение API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-183">By default, the Azure AD application is named the same as the API app.</span></span> <span data-ttu-id="2bbd2-184">Вы можете ввести другое имя.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-184">If you prefer, you can enter a different name.</span></span>
   
    ![параметры Azure AD](./media/app-service-api-dotnet-service-principal-auth/aadsettings.png)
   
    <span data-ttu-id="2bbd2-186">**Примечание.** Также можно использовать одно приложение Azure AD и для вызывающего приложения API, и для защищенного приложения API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-186">**Note**: As an alternative, you could use a single Azure AD application for both the calling API app and the protected API app.</span></span> <span data-ttu-id="2bbd2-187">Если вы выбрали этот вариант, вам не нужен параметр **Создать новое приложение AD**, так как вы уже создали приложение Azure AD ранее, следуя руководству по проверке подлинности пользователей.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-187">If you chose that alternative, you would not need the **Create New AD App** option here because you already created an Azure AD application earlier in the user authentication tutorial.</span></span> <span data-ttu-id="2bbd2-188">В этом руководстве вы будет использовать отдельные приложения Azure AD для вызывающего приложения API и защищенного приложения API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-188">For this tutorial, you'll use separate Azure AD applications for the calling API app and the protected API app.</span></span>
8. <span data-ttu-id="2bbd2-189">Запишите значение, которое находится в поле ввода **Создать приложение**. Это приложение AAD понадобится вам позже на классическом портале Azure.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-189">Make a note of the value that is in the **Create App** input box; you'll look up this AAD application in the Azure classic portal later.</span></span>
9. <span data-ttu-id="2bbd2-190">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-190">Click **OK**.</span></span>
10. <span data-ttu-id="2bbd2-191">В колонке **Проверка подлинности и авторизация** нажмите кнопку **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-191">In the **Authentication / Authorization** blade, click **Save**.</span></span>
    
    ![Щелкните Сохранить](./media/app-service-api-dotnet-service-principal-auth/saveauth.png)
    
    <span data-ttu-id="2bbd2-193">Служба приложений создает приложение Azure Active Directory, в котором для параметров **URL-адрес входа** и **URL-адрес ответа** автоматически указан URL-адрес вашего приложения API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-193">App Service creates an Azure Active Directory application with **Sign-on URL** and **Reply URL** automatically set to the URL of your API app.</span></span> <span data-ttu-id="2bbd2-194">С помощью URL-адреса вашего приложения API пользователи в клиенте AAD входят в приложение API и получают к нему доступ.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-194">The latter value enables users in your AAD tenant to log in and access the API app.</span></span>

### <a name="verify-that-the-api-app-is-protected"></a><span data-ttu-id="2bbd2-195">Проверка защиты приложения API</span><span class="sxs-lookup"><span data-stu-id="2bbd2-195">Verify that the API app is protected</span></span>
1. <span data-ttu-id="2bbd2-196">В браузере перейдите по URL-адресу приложения API. Для этого в колонке **Приложение API** на портале Azure щелкните ссылку в разделе **URL-адрес**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-196">In a browser go to the URL of the API app: in the **API app** blade in the Azure portal, click the link under **URL**.</span></span> 
   
    <span data-ttu-id="2bbd2-197">Вы будете перенаправлены на экран входа, так как запросы, не прошедшие проверку подлинности, не могут получать доступ к приложению API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-197">You are redirected to a login screen because unauthenticated requests are not allowed to reach the API app.</span></span> 
   
    <span data-ttu-id="2bbd2-198">Если браузер перенаправляет вас в пользовательский интерфейс Swagger, возможно, ваш браузер уже вошел в приложение. В таком случае откройте окно InPrivate или анонимное окно и перейдите по URL-адресу пользовательского интерфейса Swagger.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-198">If your browser does go to the Swagger UI, your browser might already be logged on -- in that case, open an InPrivate or Incognito window and go to the Swagger UI URL.</span></span>
2. <span data-ttu-id="2bbd2-199">Войдите с помощью учетных данных, используемых в клиенте AAD.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-199">Log in with credentials of a user in your AAD tenant.</span></span>
   
   <span data-ttu-id="2bbd2-200">Когда вы войдете, в браузере откроется страница с сообщением "Успешно создано".</span><span class="sxs-lookup"><span data-stu-id="2bbd2-200">When you're logged on, the "successfully created" page appears in the browser.</span></span>

## <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a><span data-ttu-id="2bbd2-201">Настройка проекта ToDoListAPI для получения и отправки токена Azure AD</span><span class="sxs-lookup"><span data-stu-id="2bbd2-201">Configure the ToDoListAPI project to acquire and send the Azure AD token</span></span>
<span data-ttu-id="2bbd2-202">В этом разделе вам нужно выполнить следующие задачи.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-202">In this section you do the following tasks:</span></span>

* <span data-ttu-id="2bbd2-203">Добавьте код в приложение API среднего уровня, которое использует учетные данные приложения Azure AD для получения токена и его отправки с помощью HTTP-запросов в приложение API уровня данных.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-203">Add code in the middle tier API app that uses Azure AD application credentials to acquire a token and send it with HTTP requests to the data tier API app.</span></span>
* <span data-ttu-id="2bbd2-204">Получите необходимые учетные данные из Azure AD.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-204">Get the credentials you need from Azure AD.</span></span>
* <span data-ttu-id="2bbd2-205">Введите учетные данные в параметры среды выполнения службы приложений Azure в приложении API среднего уровня.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-205">Enter the credentials into Azure App Service runtime environment settings in the middle tier API app.</span></span> 

### <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a><span data-ttu-id="2bbd2-206">Настройка проекта ToDoListAPI для получения и отправки токена Azure AD</span><span class="sxs-lookup"><span data-stu-id="2bbd2-206">Configure the ToDoListAPI project to acquire and send the Azure AD token</span></span>
<span data-ttu-id="2bbd2-207">Внесите следующие изменения в проект ToDoListAPI в Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-207">Make the following changes in the ToDoListAPI project in Visual Studio.</span></span>

1. <span data-ttu-id="2bbd2-208">Раскомментируйте весь код в файле *ServicePrincipal.cs* .</span><span class="sxs-lookup"><span data-stu-id="2bbd2-208">Uncomment all of the code in the *ServicePrincipal.cs* file.</span></span>
   
    <span data-ttu-id="2bbd2-209">Это код, который библиотека ADAL для .NET использует для получения токена носителя Azure AD.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-209">This is the code that uses ADAL for .NET to acquire the Azure AD bearer token.</span></span>  <span data-ttu-id="2bbd2-210">В нем используется несколько значений конфигурации, которые вы укажете в среде выполнения Azure позже.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-210">It uses several configuration values that you'll set in the Azure runtime environment later.</span></span> <span data-ttu-id="2bbd2-211">Вот этот код:</span><span class="sxs-lookup"><span data-stu-id="2bbd2-211">Here's the code:</span></span> 
   
        public static class ServicePrincipal
        {
            static string authority = ConfigurationManager.AppSettings["ida:Authority"];
            static string clientId = ConfigurationManager.AppSettings["ida:ClientId"];
            static string clientSecret = ConfigurationManager.AppSettings["ida:ClientSecret"];
            static string resource = ConfigurationManager.AppSettings["ida:Resource"];
   
            public static AuthenticationResult GetS2SAccessTokenForProdMSA()
            {
                return GetS2SAccessToken(authority, resource, clientId, clientSecret);
            }
   
            static AuthenticationResult GetS2SAccessToken(string authority, string resource, string clientId, string clientSecret)
            {
                var clientCredential = new ClientCredential(clientId, clientSecret);
                AuthenticationContext context = new AuthenticationContext(authority, false);
                AuthenticationResult authenticationResult = context.AcquireToken(
                    resource,
                    clientCredential);
                return authenticationResult;
            }
        }
   
    <span data-ttu-id="2bbd2-212">**Примечание.** Для этого кода требуется пакет NuGet библиотеки ADAL для .NET (Microsoft.IdentityModel.Clients.ActiveDirectory), который уже установлен в проекте.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-212">**Note:** This code requires the ADAL for .NET NuGet package (Microsoft.IdentityModel.Clients.ActiveDirectory), which is already installed in the project.</span></span> <span data-ttu-id="2bbd2-213">Если проект создан с нуля, необходимо установить этот пакет.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-213">If you were creating this project from scratch, you would have to install this package.</span></span> <span data-ttu-id="2bbd2-214">Этот пакет не устанавливается автоматически с помощью шаблона нового проекта приложения API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-214">This package is not automatically installed by the API app new-project template.</span></span>
2. <span data-ttu-id="2bbd2-215">В *Controllers/ToDoListController* раскомментируйте код в методе `NewDataAPIClient`, который добавляет маркер в HTTP-запросы в заголовке авторизации.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-215">In *Controllers/ToDoListController*, uncomment the code in the `NewDataAPIClient` method that adds the token to HTTP requests in the authorization header.</span></span>
   
        client.HttpClient.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", ServicePrincipal.GetS2SAccessTokenForProdMSA().AccessToken);
3. <span data-ttu-id="2bbd2-216">Разверните проект ToDoListAPI.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-216">Deploy the ToDoListAPI project.</span></span> <span data-ttu-id="2bbd2-217">(Щелкните проект правой кнопкой мыши и выберите **Публикация > Опубликовать**.)</span><span class="sxs-lookup"><span data-stu-id="2bbd2-217">(Right-click the project, then click **Publish > Publish**.)</span></span>
   
    <span data-ttu-id="2bbd2-218">Visual Studio развернет проект и откроет в браузере базовый URL-адрес веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-218">Visual Studio deploys the project and opens a browser to the web app's base URL.</span></span> <span data-ttu-id="2bbd2-219">Откроется страница с ошибкой 403. Это обычная ситуация при попытке перехода к базовому URL-адресу веб-API из браузера.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-219">This will show a 403 error page, which is normal for an attempt to go to a Web API base URL from a browser.</span></span>
4. <span data-ttu-id="2bbd2-220">Закройте браузер.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-220">Close the browser.</span></span>

### <a name="get-azure-ad-configuration-values"></a><span data-ttu-id="2bbd2-221">Получение значений конфигурации Azure AD</span><span class="sxs-lookup"><span data-stu-id="2bbd2-221">Get Azure AD configuration values</span></span>
1. <span data-ttu-id="2bbd2-222">На [классическом портале Azure](https://manage.windowsazure.com/)перейдите в раздел **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-222">In the [Azure classic portal](https://manage.windowsazure.com/), go to **Azure Active Directory**.</span></span>
2. <span data-ttu-id="2bbd2-223">На вкладке **Каталог** щелкните свой клиент AAD.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-223">On the **Directory** tab, click your AAD tenant.</span></span>
3. <span data-ttu-id="2bbd2-224">Щелкните **Приложения > Приложения, которыми владеет моя компания**, а затем установите флажок.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-224">Click **Applications > Applications my company owns**, and then click the check mark.</span></span>
4. <span data-ttu-id="2bbd2-225">В списке приложений щелкните имя приложения, созданного в Azure после того, как вы активировали проверку подлинности для приложения API ToDoListDataAPI (уровень данных).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-225">In the list of applications, click the name of the one that Azure created for you when you enabled authentication for the ToDoListDataAPI (data tier) API app.</span></span>
5. <span data-ttu-id="2bbd2-226">Выберите вкладку **Настройка** .</span><span class="sxs-lookup"><span data-stu-id="2bbd2-226">Click the **Configure** tab.</span></span>
6. <span data-ttu-id="2bbd2-227">Скопируйте значение в поле **Идентификатор клиента** и сохраните его, чтобы использовать позже.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-227">Copy the **Client ID** value and save it someplace you can get it from later.</span></span> 
7. <span data-ttu-id="2bbd2-228">На классическом портале Azure вернитесь в список **Приложения, которыми владеет моя компания**и выберите приложение AAD, которое вы создали для приложения API среднего уровня ToDoListAPI (приложение, созданное в предыдущем учебнике).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-228">In the Azure classic portal go back to the list of **Applications my company owns**, and click the AAD application that you created for the middle tier ToDoListAPI API app (the one you created in the previous tutorial, not the one you created in this tutorial).</span></span>
8. <span data-ttu-id="2bbd2-229">Выберите вкладку **Настройка** .</span><span class="sxs-lookup"><span data-stu-id="2bbd2-229">Click the **Configure** tab.</span></span>
9. <span data-ttu-id="2bbd2-230">Скопируйте значение в поле **Идентификатор клиента** и сохраните его, чтобы использовать позже.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-230">Copy the **Client ID** value and save it someplace you can get it from later.</span></span>
10. <span data-ttu-id="2bbd2-231">В разделе **ключей** в раскрывающемся списке **Выбрать длительность** выберите **1 год**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-231">Under **keys**, select **1 year** from the **Select duration** drop-down list.</span></span>
11. <span data-ttu-id="2bbd2-232">Щелкните **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-232">Click **Save**.</span></span>
    
     ![Создать ключ приложения](./media/app-service-api-dotnet-service-principal-auth/genkey.png)
12. <span data-ttu-id="2bbd2-234">Скопируйте значение ключа и сохраните его, чтобы использовать позже.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-234">Copy the key value and save it someplace you can get it from later.</span></span>
    
     ![Скопировать новый ключ приложения](./media/app-service-api-dotnet-service-principal-auth/genkeycopy.png)

### <a name="configure-azure-ad-settings-in-the-middle-tier-api-apps-runtime-environment"></a><span data-ttu-id="2bbd2-236">Настройка параметров Azure AD в среде выполнения приложения среднего уровня API</span><span class="sxs-lookup"><span data-stu-id="2bbd2-236">Configure Azure AD settings in the middle tier API app's runtime environment</span></span>
1. <span data-ttu-id="2bbd2-237">Перейдите на [портал Azure](https://portal.azure.com/)и откройте колонку **Приложение API** для приложения API, в котором размещается проект TodoListAPI (средний уровень).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-237">Go to the [Azure portal](https://portal.azure.com/), and then navigate to the **API App** blade for the API app that hosts the TodoListAPI (middle tier) project.</span></span>
2. <span data-ttu-id="2bbd2-238">Щелкните элементы **Параметры > Параметры приложения**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-238">Click **Settings > Application Settings**.</span></span>
3. <span data-ttu-id="2bbd2-239">В разделе **Параметры приложения** добавьте указанные ниже ключи и значения.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-239">In the **App settings** section, add the following keys and values:</span></span>
   
   | <span data-ttu-id="2bbd2-240">**Ключ**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-240">**Key**</span></span> | <span data-ttu-id="2bbd2-241">ida:Authority</span><span class="sxs-lookup"><span data-stu-id="2bbd2-241">ida:Authority</span></span> |
   | --- | --- |
   | <span data-ttu-id="2bbd2-242">**Значение**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-242">**Value**</span></span> |<span data-ttu-id="2bbd2-243">https://login.microsoftonline.com/{имя клиента Azure AD}</span><span class="sxs-lookup"><span data-stu-id="2bbd2-243">https://login.microsoftonline.com/{your Azure AD tenant name}</span></span> |
   | <span data-ttu-id="2bbd2-244">**Пример**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-244">**Example**</span></span> |<span data-ttu-id="2bbd2-245">https://login.microsoftonline.com/contoso.onmicrosoft.com</span><span class="sxs-lookup"><span data-stu-id="2bbd2-245">https://login.microsoftonline.com/contoso.onmicrosoft.com</span></span> |
   
   | <span data-ttu-id="2bbd2-246">**Ключ**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-246">**Key**</span></span> | <span data-ttu-id="2bbd2-247">ida:ClientId</span><span class="sxs-lookup"><span data-stu-id="2bbd2-247">ida:ClientId</span></span> |
   | --- | --- |
   | <span data-ttu-id="2bbd2-248">**Значение**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-248">**Value**</span></span> |<span data-ttu-id="2bbd2-249">Идентификатор клиента вызывающего приложения (средний уровень — ToDoListAPI)</span><span class="sxs-lookup"><span data-stu-id="2bbd2-249">Client ID of the calling application (middle tier - ToDoListAPI)</span></span> |
   | <span data-ttu-id="2bbd2-250">**Пример**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-250">**Example**</span></span> |<span data-ttu-id="2bbd2-251">960adec2-b74a-484a-960adec2-b74a-484a</span><span class="sxs-lookup"><span data-stu-id="2bbd2-251">960adec2-b74a-484a-960adec2-b74a-484a</span></span> |
   
   | <span data-ttu-id="2bbd2-252">**Ключ**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-252">**Key**</span></span> | <span data-ttu-id="2bbd2-253">ida:ClientSecret</span><span class="sxs-lookup"><span data-stu-id="2bbd2-253">ida:ClientSecret</span></span> |
   | --- | --- |
   | <span data-ttu-id="2bbd2-254">**Значение**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-254">**Value**</span></span> |<span data-ttu-id="2bbd2-255">Ключ приложения вызывающего приложения (средний уровень — ToDoListAPI)</span><span class="sxs-lookup"><span data-stu-id="2bbd2-255">App key of the calling application (middle tier - ToDoListAPI)</span></span> |
   | <span data-ttu-id="2bbd2-256">**Пример**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-256">**Example**</span></span> |<span data-ttu-id="2bbd2-257">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span><span class="sxs-lookup"><span data-stu-id="2bbd2-257">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span></span> |
   
   | <span data-ttu-id="2bbd2-258">**Ключ**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-258">**Key**</span></span> | <span data-ttu-id="2bbd2-259">ida:Resource</span><span class="sxs-lookup"><span data-stu-id="2bbd2-259">ida:Resource</span></span> |
   | --- | --- |
   | <span data-ttu-id="2bbd2-260">**Значение**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-260">**Value**</span></span> |<span data-ttu-id="2bbd2-261">Идентификатор клиента вызываемого приложения (уровень данных — ToDoListDataAPI)</span><span class="sxs-lookup"><span data-stu-id="2bbd2-261">Client ID of the called application (data tier - ToDoListDataAPI)</span></span> |
   | <span data-ttu-id="2bbd2-262">**Пример**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-262">**Example**</span></span> |<span data-ttu-id="2bbd2-263">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span><span class="sxs-lookup"><span data-stu-id="2bbd2-263">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span></span> |
   
    <span data-ttu-id="2bbd2-264">**Примечание.** Для `ida:Resource` убедитесь, что используется **идентификатор клиента** вызываемого приложения, а не его **URI идентификатора приложения**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-264">**Note**: For `ida:Resource`, make sure you use the called application's **client ID** and not its **App ID URI**.</span></span>
   
    <span data-ttu-id="2bbd2-265">`ida:ClientId` и `ida:Resource` являются разными значениями в рамках этого руководства, так как вы используете отдельные приложения Azure AD для среднего уровня и уровня данных.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-265">`ida:ClientId` and `ida:Resource` are different values for this tutorial because you're using separate Azure AD applicaations for the middle tier and data tier.</span></span> <span data-ttu-id="2bbd2-266">Если вы использовали одно приложение Azure AD для вызывающего приложения API и защищенного приложения API, вам нужно использовать одно и то же значение для `ida:ClientId` и `ida:Resource`.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-266">If you were using a single Azure AD application for the calling API app and the protected API app, you would use the same value in both `ida:ClientId` and `ida:Resource`.</span></span>
   
    <span data-ttu-id="2bbd2-267">Код получает эти значения с помощью диспетчера конфигураций, поэтому они могут храниться в файле Web.config проекта или в среде выполнения Azure.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-267">The code uses ConfigurationManager to get these values, so they could be stored in the project's Web.config file or in the Azure runtime environment.</span></span> <span data-ttu-id="2bbd2-268">Пока приложение ASP.NET работает в службе приложений Azure, параметры среды автоматически переопределяют параметры в файле Web.config.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-268">While an ASP.NET application is running in Azure App Service, environment settings automatically override settings from Web.config.</span></span> <span data-ttu-id="2bbd2-269">Параметры среды — это [более безопасный способ хранения конфиденциальной информации по сравнению с файлом Web.config](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-269">Environment settings are generally a [more secure way to store sensitive information compared to a Web.config file](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure).</span></span>
4. <span data-ttu-id="2bbd2-270">Щелкните **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-270">Click **Save**.</span></span>
   
    ![Щелкните Сохранить](./media/app-service-api-dotnet-service-principal-auth/appsettings.png)

### <a name="test-the-application"></a><span data-ttu-id="2bbd2-272">Тестирование приложения</span><span class="sxs-lookup"><span data-stu-id="2bbd2-272">Test the application</span></span>
1. <span data-ttu-id="2bbd2-273">В браузере перейдите по URL-адресу HTTPS внешнего веб-приложения AngularJS.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-273">In a browser go to the HTTPS URL of the AngularJS front end web app.</span></span>
2. <span data-ttu-id="2bbd2-274">Откройте вкладку **To Do List** и войдите в клиент Azure AD с помощью учетных данных пользователя.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-274">Click the **To Do List** tab and log in with credentials for a user in your Azure AD tenant.</span></span> 
3. <span data-ttu-id="2bbd2-275">Добавьте элементы списка дел, чтобы убедиться, что приложение работает.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-275">Add to-do items to verify that the application is working.</span></span>
   
    ![Страница "Список дел"](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)
   
    <span data-ttu-id="2bbd2-277">Если приложение не работает правильно, повторно проверьте все параметры, введенные на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-277">If the application doesn't work as expected, double-check all of the settings you entered in the Azure portal.</span></span> <span data-ttu-id="2bbd2-278">Если все параметры указаны правильно, см. раздел [Устранение неполадок](#troubleshooting) далее в этом руководстве.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-278">If all of the settings appear to be correct, see the [Troubleshooting](#troubleshooting) section later in this tutorial.</span></span>

## <a name="protect-the-api-app-from-browser-access"></a><span data-ttu-id="2bbd2-279">Защита приложения API от доступа браузера</span><span class="sxs-lookup"><span data-stu-id="2bbd2-279">Protect the API app from browser access</span></span>
<span data-ttu-id="2bbd2-280">Следуя инструкциям этого руководства, вы создали отдельное приложение Azure AD для приложения API ToDoListDataAPI (уровень данных).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-280">For this tutorial you created a separate Azure AD application for the ToDoListDataAPI (data tier) API app.</span></span> <span data-ttu-id="2bbd2-281">Как вы могли убедиться, при создании приложения AAD служба приложений настраивает приложение AAD так, чтобы пользователь мог использовать URL-адрес приложения API для перехода на страницу входа в браузере.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-281">As you've seen, when App Service creates an AAD application, it configures the AAD application in a way that enables a user to go to the API app's URL in a browser and log on.</span></span> <span data-ttu-id="2bbd2-282">Это означает, что доступ к API может осуществлять не только субъект-служба, но и пользователь в клиенте Azure AD.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-282">That means it's possible for an end user in your Azure AD tenant, not just a service principal, to access the API.</span></span> 

<span data-ttu-id="2bbd2-283">Если требуется, чтобы браузер не мог получать доступ без записи кода в защищенное приложение API, вы можете изменить в приложении AAD **URL-адрес ответа** , чтобы он отличался от базового URL-адреса приложения API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-283">If you want to prevent browser access without writing any code in the protected API app, you can change the **Reply URL** in the AAD application so that it's different from the API app's base URL.</span></span> 

### <a name="disable-browser-access"></a><span data-ttu-id="2bbd2-284">Отключение доступа через браузер</span><span class="sxs-lookup"><span data-stu-id="2bbd2-284">Disable browser access</span></span>
1. <span data-ttu-id="2bbd2-285">На классическом портале на вкладке **Настройка** приложения AAD, которое было создано для проекта TodoListService, измените значение в поле **URL-адрес ответа**, чтобы оно являлось действительным URL-адресом, но не URL-адресом приложения API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-285">In the classic portal's **Configure** tab for the AAD application that was created for the TodoListService, change the value in the **Reply URL** field so that it is a valid URL but not the API app's URL.</span></span>
2. <span data-ttu-id="2bbd2-286">Щелкните **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-286">Click **Save**.</span></span>

### <a name="verify-browser-access-no-longer-works"></a><span data-ttu-id="2bbd2-287">Проверка отсутствия доступа через браузер</span><span class="sxs-lookup"><span data-stu-id="2bbd2-287">Verify browser access no longer works</span></span>
<span data-ttu-id="2bbd2-288">Ранее вы убедились, что URL-адрес приложения API можно открыть в браузере, если ввести учетные данные отдельного пользователя.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-288">Earlier you verified that you can go to the API app URL from a browser by logging on with an individual user's credentials.</span></span> <span data-ttu-id="2bbd2-289">В этом разделе вы убедитесь, что это больше нельзя сделать.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-289">In this section, you verify that this is no longer possible.</span></span> 

1. <span data-ttu-id="2bbd2-290">В новом окне браузера еще раз перейдите по URL-адресу приложения API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-290">In a new browser window, go to the URL of the API app again.</span></span>
2. <span data-ttu-id="2bbd2-291">Войдите в систему по запросу.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-291">Log in when prompted to do so.</span></span>
3. <span data-ttu-id="2bbd2-292">Операция входа завершится отображением страницы ошибки.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-292">Login succeeds but leads to an error page.</span></span>
   
    <span data-ttu-id="2bbd2-293">Вы настроили приложение AAD, чтобы пользователи в клиенте AAD не могли входить в API и получать к нему доступ с помощью браузера.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-293">You've configured the AAD app so that users in the AAD tenant cannot log in and access the API from a browser.</span></span> <span data-ttu-id="2bbd2-294">Вы все еще можете открывать приложение API с помощью токена субъекта-службы, который можно проверить, открыв URL-адрес веб-приложения и добавив дополнительные элементы списка дел.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-294">You can still access the API app by using a service principal token, which you can verify by going to the web app's URL and adding more to-do items.</span></span>

## <a name="restrict-access-to-a-particular-service-principal"></a><span data-ttu-id="2bbd2-295">Ограничение доступа к конкретному субъекту-службе</span><span class="sxs-lookup"><span data-stu-id="2bbd2-295">Restrict access to a particular service principal</span></span>
<span data-ttu-id="2bbd2-296">Сейчас любая вызывающая сторона, которая может получить токен для пользователя или субъекта-службы в клиенте Azure AD, может вызвать приложение API TodoListDataAPI (уровень данных).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-296">Right now, any caller that can get a token for a user or service principal in your Azure AD tenant can call the TodoListDataAPI (data tier) API app.</span></span> <span data-ttu-id="2bbd2-297">Возможно, вам нужно убедиться, что приложение API уровня данных принимает только вызовы из приложения API TodoListAPI (средний уровень) и только от конкретного субъекта-службы.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-297">You might want to make sure that the data tier API app only accepts calls from the TodoListAPI (middle tier) API app, and only from a particular service principal.</span></span> 

<span data-ttu-id="2bbd2-298">Вы можете добавить эти ограничения, добавив код проверки, чтобы проверить утверждения `appid` и `objectidentifier` на входящих вызовах.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-298">You can add these restrictions by adding code to validate the `appid` and `objectidentifier` claims on incoming calls.</span></span>

<span data-ttu-id="2bbd2-299">Для целей этого руководства добавьте код, который проверяет идентификатор приложения и идентификатор субъекта-службы непосредственно в действиях контроллера.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-299">For this tutorial you put the code that validates app ID and service principal ID directly in your controller actions.</span></span>  <span data-ttu-id="2bbd2-300">В качестве альтернативы используйте пользовательский атрибут `Authorize` или выполните эту проверку в последовательностях запуска (например, ПО промежуточного слоя OWIN).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-300">Alternatives are to use a custom `Authorize` attribute or to do this validation in your startup sequences (e.g. OWIN middleware).</span></span> <span data-ttu-id="2bbd2-301">Пример такой последовательности см. в [этом примере приложения](https://github.com/mohitsriv/EasyAuthMultiTierSample/blob/master/MyDashDataAPI/Startup.cs).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-301">For an example of the latter, see [this sample application](https://github.com/mohitsriv/EasyAuthMultiTierSample/blob/master/MyDashDataAPI/Startup.cs).</span></span> 

<span data-ttu-id="2bbd2-302">Внесите следующие изменения в проект TodoListDataAPI.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-302">Make the following changes to the TodoListDataAPI project.</span></span>

1. <span data-ttu-id="2bbd2-303">Откройте файл *Controllers/TodoListController.cs* .</span><span class="sxs-lookup"><span data-stu-id="2bbd2-303">Open the *Controllers/TodoListController.cs* file.</span></span>
2. <span data-ttu-id="2bbd2-304">Раскомментируйте строки, в которых задаются значения `trustedCallerClientId` и `trustedCallerServicePrincipalId`.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-304">Uncomment the lines that set `trustedCallerClientId` and `trustedCallerServicePrincipalId`.</span></span>
   
        private static string trustedCallerClientId = ConfigurationManager.AppSettings["todo:TrustedCallerClientId"];
        private static string trustedCallerServicePrincipalId = ConfigurationManager.AppSettings["todo:TrustedCallerServicePrincipalId"];
3. <span data-ttu-id="2bbd2-305">Раскомментируйте следующий код в метод CheckCallerId.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-305">Uncomment the code in the CheckCallerId method.</span></span> <span data-ttu-id="2bbd2-306">Этот метод вызывается в начале каждого метода действия в контроллере.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-306">This method is called at the start of every action method in the controller.</span></span> 
   
        private static void CheckCallerId()
        {
            string currentCallerClientId = ClaimsPrincipal.Current.FindFirst("appid").Value;
            string currentCallerServicePrincipalId = ClaimsPrincipal.Current.FindFirst("http://schemas.microsoft.com/identity/claims/objectidentifier").Value;
            if (currentCallerClientId != trustedCallerClientId || currentCallerServicePrincipalId != trustedCallerServicePrincipalId)
            {
                throw new HttpResponseException(new HttpResponseMessage { StatusCode = HttpStatusCode.Unauthorized, ReasonPhrase = "The appID or service principal ID is not the expected value." });
            }
        }
4. <span data-ttu-id="2bbd2-307">Повторно разверните проект ToDoListDataAPI в службе приложений Azure.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-307">Redeploy the ToDoListDataAPI project to Azure App Service.</span></span>
5. <span data-ttu-id="2bbd2-308">В браузере откройте URL-адрес HTTPS внешнего веб-приложения AngularJS и на домашней странице откройте вкладку **To Do List** .</span><span class="sxs-lookup"><span data-stu-id="2bbd2-308">In your browser, go to the AngularJS front end web app's HTTPS URL, and in the home page click the **To Do List** tab.</span></span>
   
    <span data-ttu-id="2bbd2-309">Приложение не работает из-за сбоя при выполнении вызовов к серверной части.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-309">The application doesn't work because calls to the back end are failing.</span></span> <span data-ttu-id="2bbd2-310">Новый код проверяет фактические значения appid и objectidentifier, но он еще не содержит правильные значения, чтобы сравнить их.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-310">The new code is checking actual appid and objectidentifier but it doesn't yet have the correct values to check them against.</span></span> <span data-ttu-id="2bbd2-311">На консоли средств разработчика в браузере появляется сообщение о том, что сервер возвращает ошибку HTTP 401.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-311">The browser Developer Tools Console reports that the server is returning an HTTP 401 error.</span></span>
   
    ![Ошибка в консоли инструментов для разработчиков](./media/app-service-api-dotnet-service-principal-auth/webapperror.png)
   
    <span data-ttu-id="2bbd2-313">На следующих шагах вы настроите ожидаемые значения.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-313">In the following steps you configure the expected values.</span></span>
6. <span data-ttu-id="2bbd2-314">С помощью Azure AD PowerShell получите значение субъекта-службы для приложения Azure AD, которое вы создали для проекта TodoListWebApp.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-314">Using Azure AD PowerShell, get the value of the service principal for the Azure AD application that you created for the TodoListWebApp project.</span></span>
   
    <span data-ttu-id="2bbd2-315">а.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-315">a.</span></span> <span data-ttu-id="2bbd2-316">Инструкции по установке и использованию Azure PowerShell см. в статье [Установка и настройка Azure PowerShell](../powershell-azure-resource-manager.md).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-316">For instructions on how to install Azure PowerShell and connect to your subscription, see [Using Azure PowerShell with Azure Resource Manager](../powershell-azure-resource-manager.md).</span></span>
   
    <span data-ttu-id="2bbd2-317">b.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-317">b.</span></span> <span data-ttu-id="2bbd2-318">Чтобы получить список субъектов-служб, выполните команду `Login-AzureRmAccount`, а затем — команду `Get-AzureRmADServicePrincipal`.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-318">To get a list of service principals, execute the `Login-AzureRmAccount` command and then the `Get-AzureRmADServicePrincipal` command.</span></span>
   
    <span data-ttu-id="2bbd2-319">В.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-319">c.</span></span> <span data-ttu-id="2bbd2-320">Найдите значение objectid для субъекта-службы приложения TodoListAPI и сохраните его в расположении, из которого сможете скопировать его позже.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-320">Find the objectid for the service principal of the TodoListAPI application, and save it in a location you can copy from later.</span></span>
7. <span data-ttu-id="2bbd2-321">На портале Azure перейдите к колонке приложения API, в которое был развернут проект ToDoListDataAPI.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-321">In the Azure portal, navigate to the API app blade for the API app that you deployed the ToDoListDataAPI project to.</span></span>
8. <span data-ttu-id="2bbd2-322">Щелкните элементы **Параметры > Параметры приложения**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-322">Click **Settings > Application settings**.</span></span>
9. <span data-ttu-id="2bbd2-323">В разделе **Параметры приложения** добавьте указанные ниже ключи и значения.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-323">In the **App settings** section, add the following keys and values:</span></span>
   
   | <span data-ttu-id="2bbd2-324">**Ключ**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-324">**Key**</span></span> | <span data-ttu-id="2bbd2-325">todo:TrustedCallerServicePrincipalId</span><span class="sxs-lookup"><span data-stu-id="2bbd2-325">todo:TrustedCallerServicePrincipalId</span></span> |
   | --- | --- |
   | <span data-ttu-id="2bbd2-326">**Значение**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-326">**Value**</span></span> |<span data-ttu-id="2bbd2-327">Идентификатор субъекта-службы вызывающего приложения</span><span class="sxs-lookup"><span data-stu-id="2bbd2-327">Service principal id of calling application</span></span> |
   | <span data-ttu-id="2bbd2-328">**Пример**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-328">**Example**</span></span> |<span data-ttu-id="2bbd2-329">4f4a94a4-6f0d-4072-4f4a94a4-6f0d-4072</span><span class="sxs-lookup"><span data-stu-id="2bbd2-329">4f4a94a4-6f0d-4072-4f4a94a4-6f0d-4072</span></span> |
   
   | <span data-ttu-id="2bbd2-330">**Ключ**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-330">**Key**</span></span> | <span data-ttu-id="2bbd2-331">todo:TrustedCallerClientId</span><span class="sxs-lookup"><span data-stu-id="2bbd2-331">todo:TrustedCallerClientId</span></span> |
   | --- | --- |
   | <span data-ttu-id="2bbd2-332">**Значение**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-332">**Value**</span></span> |<span data-ttu-id="2bbd2-333">Идентификатор клиента вызывающего приложения, скопированный из приложения AAD TodoListAPI</span><span class="sxs-lookup"><span data-stu-id="2bbd2-333">Client ID of calling application - copied from the TodoListAPI Azure AD application</span></span> |
   | <span data-ttu-id="2bbd2-334">**Пример**</span><span class="sxs-lookup"><span data-stu-id="2bbd2-334">**Example**</span></span> |<span data-ttu-id="2bbd2-335">960adec2-b74a-484a-960adec2-b74a-484a</span><span class="sxs-lookup"><span data-stu-id="2bbd2-335">960adec2-b74a-484a-960adec2-b74a-484a</span></span> |
10. <span data-ttu-id="2bbd2-336">Щелкните **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-336">Click **Save**.</span></span>
    
     ![Щелкните Сохранить](./media/app-service-api-dotnet-service-principal-auth/trustedcaller.png)
11. <span data-ttu-id="2bbd2-338">В браузере еще раз откройте URL-адрес веб-приложения и на домашней странице щелкните вкладку **To Do List** .</span><span class="sxs-lookup"><span data-stu-id="2bbd2-338">In your browser, return to the web app's URL, and in the home page click the **To Do List** tab.</span></span>
    
     <span data-ttu-id="2bbd2-339">На этот раз приложение работает правильно, так как идентификатор доверенного вызывающего приложения и идентификатор субъекта-службы являются ожидаемыми значениями.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-339">This time the application works as expected because the trusted caller app ID and service principal ID are the expected values.</span></span>
    
     ![Страница "Список дел"](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)

## <a name="building-the-projects-from-scratch"></a><span data-ttu-id="2bbd2-341">Построение проектов с нуля</span><span class="sxs-lookup"><span data-stu-id="2bbd2-341">Building the projects from scratch</span></span>
<span data-ttu-id="2bbd2-342">Эти два проекта веб-API созданы с помощью шаблона проекта **Приложение API Azure** и путем замены контроллера значений по умолчанию контроллером ToDoList.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-342">The two Web API projects were created by using the **Azure API App** project template and replacing the default Values controller with a ToDoList controller.</span></span> <span data-ttu-id="2bbd2-343">Для получения токенов субъекта-службы Azure AD в проекте ToDoListAPI был установлен пакет NuGet [Библиотека проверки подлинности Active Directory (ADAL) для .NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory/)</span><span class="sxs-lookup"><span data-stu-id="2bbd2-343">For acquiring Azure AD service principal tokens in the ToDoListAPI project, the [Active Directory Authentication Library (ADAL) for .NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory/) NuGet package was installed.</span></span>

<span data-ttu-id="2bbd2-344">Сведения о том, как создать одностраничное приложение AngularJS с внутренним веб-API, таким как ToDoListAngular, см. в статье [Hands On Lab: Build a Single Page Application (SPA) with ASP.NET Web API and Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs) (Практикум. Создание одностраничного приложения (SPA) с веб-API ASP.NET и Angular.js).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-344">For information about how to  create an AngularJS single-page application with a Web API back end like ToDoListAngular, see  [Hands On Lab: Build a Single Page Application (SPA) with ASP.NET Web API and Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs).</span></span> <span data-ttu-id="2bbd2-345">Сведения о том, как добавить код проверки подлинности Azure AD, см. в статье [Защита одностраничных приложений AngularJS с помощью Azure AD](../active-directory/active-directory-devquickstarts-angular.md).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-345">For information about how to add Azure AD authentication code, see [Securing AngularJS Single Page Apps with Azure AD](../active-directory/active-directory-devquickstarts-angular.md).</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="2bbd2-346">Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="2bbd2-346">Troubleshooting</span></span>
[!INCLUDE [troubleshooting](../../includes/app-service-api-auth-troubleshooting.md)]

* <span data-ttu-id="2bbd2-347">Убедитесь, что вы не путаете ToDoListAPI (средний уровень) и ToDoListDataAPI (уровень данных).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-347">Make sure that you don't confuse ToDoListAPI (middle tier) and ToDoListDataAPI (data tier).</span></span> <span data-ttu-id="2bbd2-348">Например, в этом учебнике вы добавляете проверку подлинности в приложение API уровня данных, **но ключ приложения следует взять в приложении Azure AD, созданном для приложения API среднего уровня**.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-348">For example, in this tutorial you add authentication to the data tier API app, **but the app key must come from the Azure AD application that you created for the middle tier API app**.</span></span>

## <a name="next-steps"></a><span data-ttu-id="2bbd2-349">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="2bbd2-349">Next steps</span></span>
<span data-ttu-id="2bbd2-350">Это последний учебник в серии учебных материалов для работы с приложениями API.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-350">This is the last tutorial in the API Apps series.</span></span> 

<span data-ttu-id="2bbd2-351">Дополнительные сведения об Azure Active Directory см. в следующих статьях.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-351">For more information about Azure Active Directory, see the following resources.</span></span>

* [<span data-ttu-id="2bbd2-352">Руководство разработчика по Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="2bbd2-352">Azure AD developers' guide</span></span>](http://aka.ms/aaddev)
* [<span data-ttu-id="2bbd2-353">Сценарии проверки подлинности в Azure AD</span><span class="sxs-lookup"><span data-stu-id="2bbd2-353">Azure AD scenarios</span></span>](http://aka.ms/aadscenarios)
* [<span data-ttu-id="2bbd2-354">Azure Samples (Примеры для Azure)</span><span class="sxs-lookup"><span data-stu-id="2bbd2-354">Azure AD samples</span></span>](http://aka.ms/aadsamples)
  
    <span data-ttu-id="2bbd2-355">Пример [WebApp-WebAPI-OAuth2-AppIdentity-DotNet](http://github.com/AzureADSamples/WebApp-WebAPI-OAuth2-AppIdentity-DotNet) аналогичен показанному в этом учебнике, но без использования проверки подлинности службы приложений.</span><span class="sxs-lookup"><span data-stu-id="2bbd2-355">The [WebApp-WebAPI-OAuth2-AppIdentity-DotNet](http://github.com/AzureADSamples/WebApp-WebAPI-OAuth2-AppIdentity-DotNet) sample is similar to what is shown in this tutorial, but without using App Service authentication.</span></span>

<span data-ttu-id="2bbd2-356">Сведения о других способах развертывания проектов Visual Studio в приложениях API с помощью Visual Studio или функции [автоматизации развертывания](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) из [системы управления версиями](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) см. в статье [Развертывание приложения в службе приложений Azure](../app-service-web/web-sites-deploy.md).</span><span class="sxs-lookup"><span data-stu-id="2bbd2-356">For information about other ways to deploy Visual Studio projects to API apps, by using Visual Studio or by [automating deployment](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) from a [source control system](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control), see [How to deploy an Azure App Service app](../app-service-web/web-sites-deploy.md).</span></span>


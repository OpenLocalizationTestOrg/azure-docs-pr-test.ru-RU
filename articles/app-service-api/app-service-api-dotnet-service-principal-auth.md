---
title: "Проверка подлинности с использованием субъекта-службы для приложений API в службе приложений Azure | Документация Майкрософт"
description: "Узнайте, как защитить приложение API в службе приложений Azure для сценариев взаимодействия служб."
services: app-service\api
documentationcenter: .net
author: alexkarcher-msft
manager: erikre
editor: 
ms.assetid: 7ca0bab2-1d29-4d51-b779-dce0edd34f8b
ms.service: app-service-api
ms.workload: na
ms.tgt_pltfrm: dotnet
ms.devlang: na
ms.topic: article
ms.date: 06/30/2016
ms.author: alkarche
ms.openlocfilehash: 95653287546bbe358111ed16af0c30a53caff2b5
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="service-principal-authentication-for-api-apps-in-azure-app-service"></a>Проверка подлинности с использованием субъекта-службы для приложений API в службе приложений Azure
## <a name="overview"></a>Обзор
В этой статье объясняется, как использовать проверку подлинности службы приложений для *внутреннего* доступа к приложениям API. Во внутреннем сценарии у вас есть приложение API, которое должно использоваться только в коде вашего приложения. Рекомендуемый способ реализовать этот сценарий в службе приложений — использовать Azure AD для защиты вызываемого приложения API. Вызовите защищенное приложение API с токеном носителя, полученного из Azure AD, указав учетные данные удостоверения приложения (субъекта-службы). Альтернативные варианты использования Azure AD см. в разделе **Взаимодействие между службами** статьи [Проверка подлинности и авторизация в службе приложений Azure](../app-service/app-service-authentication-overview.md#service-to-service-authentication).

Из этой статьи вы узнаете следующее.

* Как использовать Azure Active Directory (Azure AD) для защиты приложения API от доступа без проверки подлинности.
* Как использовать защищенное приложение API из приложения API, веб-приложения или мобильного приложения с помощью учетных данных субъекта-службы (удостоверения приложения). Сведения о том, как использовать защищенное приложение API из приложения логики, см. в статье [Использование настраиваемого интерфейса API, размещенного в службе приложений, с приложениями логики](../logic-apps/logic-apps-custom-hosted-api.md).
* Что нужно сделать, чтобы вошедшие в систему пользователи не могли вызывать защищенное приложение API из браузера.
* Что нужно сделать, чтобы защищенное приложение API мог вызывать только конкретный субъект-служба Azure AD.

Статья содержит два раздела.

* В разделе [Настройка проверки подлинности субъекта-службы в службе приложений Azure](#authconfig) объясняется в общих чертах, как настроить проверку подлинности для любого приложения API и как использовать защищенное приложение API. Инструкции из этого раздела применимы ко всем платформам, которые поддерживает служба приложений, в том числе .NET, Node.js и Java.
* Начиная с раздела [Продолжение учебников по началу работы с .NET](#tutorialstart) этой статьи вы найдете инструкции по настройке "внутреннего доступа" для примера приложения .NET, работающего в службе приложений. 

## <a id="authconfig"></a> Настройка проверки подлинности субъекта-службы в службе приложений Azure
Этот раздел содержит общие инструкции, которые применимы к любому приложению API. Конкретные инструкции для примера приложения .NET To Do List см. в разделе [Продолжение руководств по началу работы с .NET](#tutorialstart).

1. На [портале Azure](https://portal.azure.com/) перейдите к колонке **Параметры** приложения API, которое требуется защитить, найдите раздел **Функции** и щелкните **Проверка подлинности и авторизация**.
   
    ![Проверка подлинности и авторизация на портале Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)
2. В колонке **Проверка подлинности и авторизация** щелкните **Вкл.**
3. В раскрывающемся списке **Предпринимаемое действие, если проверка подлинности для запроса не выполнена** выберите **Войти с использованием Azure Active Directory**.
4. В разделе **Поставщики проверки подлинности** выберите **Azure Active Directory**.
   
    ![Колонка "Проверка подлинности и авторизация" на портале Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)
5. Настройте колонку **Параметры Azure Active Directory** , чтобы создать приложение Azure AD, или выберите существующее приложение Azure AD.
   
    Во внутренних сценариях обычно участвует приложение API, которое вызывает приложение API. Вы можете использовать отдельные приложения Azure AD для каждого приложения API или только одно приложение Azure AD.
   
    Подробные инструкции по настройке этой колонки см. в статье [Настройка приложения службы приложений для использования службы входа Azure Active Directory](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md).
6. Закончив настройку колонки поставщика проверки подлинности, нажмите кнопку **ОК**.
7. В колонке **Проверка подлинности и авторизация** нажмите кнопку **Сохранить**.
   
    ![Щелкните Сохранить](./media/app-service-api-dotnet-service-principal-auth/authsave.png)

После этого служба приложений будет разрешать только запросы от вызывающих сторон в настроенном клиенте Azure AD. В защищенном приложении API код проверки подлинности или авторизации не требуется. Токен носителя передается в приложение API вместе с часто используемыми утверждениями в заголовках HTTP. Эту информацию можно прочитать в коде для проверки запросов от определенной вызывающей стороны, например субъекта-службы.

Эта функция проверки подлинности работает одинаково для всех языков, которые поддерживает служба приложений, в том числе .NET, Node.js и Java. 

#### <a name="how-to-consume-the-protected-api-app"></a>Использование защищенного приложения API
Вызывающая сторона должна предоставить токен носителя Azure AD с вызовами API. Чтобы получить токен носителя с помощью учетных данных субъекта-службы, вызывающая сторона использует библиотеку проверки подлинности Active Directory (ADAL для [.NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory), [Node.js](https://github.com/AzureAD/azure-activedirectory-library-for-nodejs) или [Java](https://github.com/AzureAD/azure-activedirectory-library-for-java)). Чтобы получить токен, код, который вызывает библиотеку ADAL, предоставляет ей следующую информацию.

* Имя вашего клиента Azure AD.
* Идентификатор клиента и секрет клиента (ключ приложения) приложения Azure AD, связанного с вызывающей стороной.
* Идентификатор клиента приложения Azure AD, связанного с защищенным приложением API. (Если используется только одно приложение Azure AD, это тот же идентификатор клиента, который указывается для вызывающей стороны.)

Эти значения доступны на страницах Azure AD [классического портала Azure](https://manage.windowsazure.com/).

Получив токен, вызывающая сторона включает его в HTTP-запросы в заголовке авторизации.  Служба приложений проверяет токен и разрешает запросам достигать защищенного приложения API.

#### <a name="how-to-protect-the-api-app-from-access-by-users-in-the-same-tenant"></a>Как защитить приложение API от доступа пользователей в том же клиенте
Токены носителя для пользователей в том же клиенте считаются допустимыми для защищенного приложения API.  Если вы хотите, чтобы только субъект-служба мог вызывать защищенное приложение API, добавьте код в защищенное приложение API, чтобы проверить следующие утверждения из токена:

* `appid` должно быть идентификатором клиента приложения Azure AD, связанного с вызывающей стороной. 
* Значение `oid` (`objectidentifier`) должно быть идентификатором субъекта-службы вызывающей стороны. 

Служба приложений также указывает утверждение `objectidentifier` в заголовке X-MS-CLIENT-PRINCIPAL-ID.

### <a name="how-to-protect-the-api-app-from-browser-access"></a>Защита приложения API от доступа из браузера
Если вы не проверяете утверждения в коде защищенного приложения API и используете отдельное приложение Azure AD для защищенного приложения API, проследите за тем, чтобы URL-адрес ответа приложения Azure AD не совпадал с базовым URL-адресом приложения API. Если URL-адрес ответа указывает непосредственно на защищенное приложение API, пользователь в том же клиенте Azure AD может перейти в приложение API, войти в систему и успешно вызвать API.

## <a id="tutorialstart"></a> Продолжение руководств по началу работы с .NET
Если вы изучаете серию учебников для приложений API по работе с Node.js или Java, перейдите к разделу [Дальнейшие действия](#next-steps) . 

В оставшейся части этой статьи продолжается серия руководств для приложений API по работе с .NET. В ней предполагается, что вы ознакомились с [руководством по проверке подлинности пользователей](app-service-api-dotnet-user-principal-auth.md) и создали пример приложения, работающего в Azure с включенной проверкой подлинности пользователей.

## <a name="set-up-authentication-in-azure"></a>Настройка проверки подлинности в Azure
В этом разделе вы настроите службу приложений так, чтобы приложение API уровня данных было доступно только для HTTP-запросов, которые имеют допустимые токены носителя Azure AD. 

В следующем разделе вы настроите приложение API среднего уровня таким образом, чтобы оно передавало учетные данные приложения в Azure AD, возвращало токен носителя и отправляло токен носителя в приложение API уровня данных. Этот процесс показан на схеме.

![Схема проверки подлинности службы](./media/app-service-api-dotnet-service-principal-auth/appdiagram.png)

Если при выполнении указаний в руководстве у вас возникли проблемы, см. раздел [Устранение неполадок](#troubleshooting) в конце этого руководства. 

1. На [портале Azure](https://portal.azure.com/) перейдите к колонке **Параметры** приложения API, созданного для приложения ToDoListDataAPI (уровень данных), и щелкните **Параметры**.
2. В колонке **Параметры** найдите раздел **Функции** и щелкните элемент **Проверка подлинности и авторизация**.
   
    ![Проверка подлинности и авторизация на портале Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)
3. В колонке **Проверка подлинности и авторизация** щелкните **Вкл.**
4. В раскрывающемся списке **Действие, выполняемое, если запрос не прошел проверку подлинности** выберите **Войти с помощью Azure Active Directory**.
   
    Если этот параметр выбран, служба приложений следит за тем, чтобы только прошедшие проверку подлинности запросы достигали приложения API. Если поступают запросы, имеющие допустимые токены носителя, служба приложений передает токены в приложение API и заполняет заголовки HTTP часто используемыми утверждениями, чтобы коду было легче получить эту информацию.
5. В разделе **Поставщики проверки подлинности** щелкните **Azure Active Directory**.
   
    ![Колонка "Проверка подлинности и авторизация" на портале Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)
6. В колонке **Параметры Azure Active Directory** щелкните **Экспресс**.
   
    Если выбран параметр **Экспресс**, Azure может автоматически создать приложение AAD в [клиенте](https://msdn.microsoft.com/en-us/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant) Azure AD. 
   
    Вам не нужно создавать клиент, так как каждая учетная запись Azure автоматически содержит клиент.
7. В разделе **Режим управления** щелкните **Создать новое приложение AD**, если этот параметр еще не выбран.
   
    Портал заполняет поле ввода **Создание приложения** значением по умолчанию. По умолчанию приложение Azure AD называется так же, как приложение API. Вы можете ввести другое имя.
   
    ![параметры Azure AD](./media/app-service-api-dotnet-service-principal-auth/aadsettings.png)
   
    **Примечание.** Также можно использовать одно приложение Azure AD и для вызывающего приложения API, и для защищенного приложения API. Если вы выбрали этот вариант, вам не нужен параметр **Создать новое приложение AD**, так как вы уже создали приложение Azure AD ранее, следуя руководству по проверке подлинности пользователей. В этом руководстве вы будет использовать отдельные приложения Azure AD для вызывающего приложения API и защищенного приложения API.
8. Запишите значение, которое находится в поле ввода **Создать приложение**. Это приложение AAD понадобится вам позже на классическом портале Azure.
9. Нажмите кнопку **ОК**.
10. В колонке **Проверка подлинности и авторизация** нажмите кнопку **Сохранить**.
    
    ![Щелкните Сохранить](./media/app-service-api-dotnet-service-principal-auth/saveauth.png)
    
    Служба приложений создает приложение Azure Active Directory, в котором для параметров **URL-адрес входа** и **URL-адрес ответа** автоматически указан URL-адрес вашего приложения API. С помощью URL-адреса вашего приложения API пользователи в клиенте AAD входят в приложение API и получают к нему доступ.

### <a name="verify-that-the-api-app-is-protected"></a>Проверка защиты приложения API
1. В браузере перейдите по URL-адресу приложения API. Для этого в колонке **Приложение API** на портале Azure щелкните ссылку в разделе **URL-адрес**. 
   
    Вы будете перенаправлены на экран входа, так как запросы, не прошедшие проверку подлинности, не могут получать доступ к приложению API. 
   
    Если браузер перенаправляет вас в пользовательский интерфейс Swagger, возможно, ваш браузер уже вошел в приложение. В таком случае откройте окно InPrivate или анонимное окно и перейдите по URL-адресу пользовательского интерфейса Swagger.
2. Войдите с помощью учетных данных, используемых в клиенте AAD.
   
   Когда вы войдете, в браузере откроется страница с сообщением "Успешно создано".

## <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a>Настройка проекта ToDoListAPI для получения и отправки токена Azure AD
В этом разделе вам нужно выполнить следующие задачи.

* Добавьте код в приложение API среднего уровня, которое использует учетные данные приложения Azure AD для получения токена и его отправки с помощью HTTP-запросов в приложение API уровня данных.
* Получите необходимые учетные данные из Azure AD.
* Введите учетные данные в параметры среды выполнения службы приложений Azure в приложении API среднего уровня. 

### <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a>Настройка проекта ToDoListAPI для получения и отправки токена Azure AD
Внесите следующие изменения в проект ToDoListAPI в Visual Studio.

1. Раскомментируйте весь код в файле *ServicePrincipal.cs* .
   
    Это код, который библиотека ADAL для .NET использует для получения токена носителя Azure AD.  В нем используется несколько значений конфигурации, которые вы укажете в среде выполнения Azure позже. Вот этот код: 
   
        public static class ServicePrincipal
        {
            static string authority = ConfigurationManager.AppSettings["ida:Authority"];
            static string clientId = ConfigurationManager.AppSettings["ida:ClientId"];
            static string clientSecret = ConfigurationManager.AppSettings["ida:ClientSecret"];
            static string resource = ConfigurationManager.AppSettings["ida:Resource"];
   
            public static AuthenticationResult GetS2SAccessTokenForProdMSA()
            {
                return GetS2SAccessToken(authority, resource, clientId, clientSecret);
            }
   
            static AuthenticationResult GetS2SAccessToken(string authority, string resource, string clientId, string clientSecret)
            {
                var clientCredential = new ClientCredential(clientId, clientSecret);
                AuthenticationContext context = new AuthenticationContext(authority, false);
                AuthenticationResult authenticationResult = context.AcquireToken(
                    resource,
                    clientCredential);
                return authenticationResult;
            }
        }
   
    **Примечание.** Для этого кода требуется пакет NuGet библиотеки ADAL для .NET (Microsoft.IdentityModel.Clients.ActiveDirectory), который уже установлен в проекте. Если проект создан с нуля, необходимо установить этот пакет. Этот пакет не устанавливается автоматически с помощью шаблона нового проекта приложения API.
2. В *Controllers/ToDoListController* раскомментируйте код в методе `NewDataAPIClient`, который добавляет маркер в HTTP-запросы в заголовке авторизации.
   
        client.HttpClient.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", ServicePrincipal.GetS2SAccessTokenForProdMSA().AccessToken);
3. Разверните проект ToDoListAPI. (Щелкните проект правой кнопкой мыши и выберите **Публикация > Опубликовать**.)
   
    Visual Studio развернет проект и откроет в браузере базовый URL-адрес веб-приложения. Откроется страница с ошибкой 403. Это обычная ситуация при попытке перехода к базовому URL-адресу веб-API из браузера.
4. Закройте браузер.

### <a name="get-azure-ad-configuration-values"></a>Получение значений конфигурации Azure AD
1. На [классическом портале Azure](https://manage.windowsazure.com/)перейдите в раздел **Azure Active Directory**.
2. На вкладке **Каталог** щелкните свой клиент AAD.
3. Щелкните **Приложения > Приложения, которыми владеет моя компания**, а затем установите флажок.
4. В списке приложений щелкните имя приложения, созданного в Azure после того, как вы активировали проверку подлинности для приложения API ToDoListDataAPI (уровень данных).
5. Выберите вкладку **Настройка** .
6. Скопируйте значение в поле **Идентификатор клиента** и сохраните его, чтобы использовать позже. 
7. На классическом портале Azure вернитесь в список **Приложения, которыми владеет моя компания**и выберите приложение AAD, которое вы создали для приложения API среднего уровня ToDoListAPI (приложение, созданное в предыдущем учебнике).
8. Выберите вкладку **Настройка** .
9. Скопируйте значение в поле **Идентификатор клиента** и сохраните его, чтобы использовать позже.
10. В разделе **ключей** в раскрывающемся списке **Выбрать длительность** выберите **1 год**.
11. Щелкните **Сохранить**.
    
     ![Создать ключ приложения](./media/app-service-api-dotnet-service-principal-auth/genkey.png)
12. Скопируйте значение ключа и сохраните его, чтобы использовать позже.
    
     ![Скопировать новый ключ приложения](./media/app-service-api-dotnet-service-principal-auth/genkeycopy.png)

### <a name="configure-azure-ad-settings-in-the-middle-tier-api-apps-runtime-environment"></a>Настройка параметров Azure AD в среде выполнения приложения среднего уровня API
1. Перейдите на [портал Azure](https://portal.azure.com/)и откройте колонку **Приложение API** для приложения API, в котором размещается проект TodoListAPI (средний уровень).
2. Щелкните элементы **Параметры > Параметры приложения**.
3. В разделе **Параметры приложения** добавьте указанные ниже ключи и значения.
   
   | **Ключ** | ida:Authority |
   | --- | --- |
   | **Значение** |https://login.microsoftonline.com/{имя клиента Azure AD} |
   | **Пример** |https://login.microsoftonline.com/contoso.onmicrosoft.com |
   
   | **Ключ** | ida:ClientId |
   | --- | --- |
   | **Значение** |Идентификатор клиента вызывающего приложения (средний уровень — ToDoListAPI) |
   | **Пример** |960adec2-b74a-484a-960adec2-b74a-484a |
   
   | **Ключ** | ida:ClientSecret |
   | --- | --- |
   | **Значение** |Ключ приложения вызывающего приложения (средний уровень — ToDoListAPI) |
   | **Пример** |e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8 |
   
   | **Ключ** | ida:Resource |
   | --- | --- |
   | **Значение** |Идентификатор клиента вызываемого приложения (уровень данных — ToDoListDataAPI) |
   | **Пример** |e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8 |
   
    **Примечание.** Для `ida:Resource` убедитесь, что используется **идентификатор клиента** вызываемого приложения, а не его **URI идентификатора приложения**.
   
    `ida:ClientId` и `ida:Resource` являются разными значениями в рамках этого руководства, так как вы используете отдельные приложения Azure AD для среднего уровня и уровня данных. Если вы использовали одно приложение Azure AD для вызывающего приложения API и защищенного приложения API, вам нужно использовать одно и то же значение для `ida:ClientId` и `ida:Resource`.
   
    Код получает эти значения с помощью диспетчера конфигураций, поэтому они могут храниться в файле Web.config проекта или в среде выполнения Azure. Пока приложение ASP.NET работает в службе приложений Azure, параметры среды автоматически переопределяют параметры в файле Web.config. Параметры среды — это [более безопасный способ хранения конфиденциальной информации по сравнению с файлом Web.config](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure).
4. Щелкните **Сохранить**.
   
    ![Щелкните Сохранить](./media/app-service-api-dotnet-service-principal-auth/appsettings.png)

### <a name="test-the-application"></a>Тестирование приложения
1. В браузере перейдите по URL-адресу HTTPS внешнего веб-приложения AngularJS.
2. Откройте вкладку **To Do List** и войдите в клиент Azure AD с помощью учетных данных пользователя. 
3. Добавьте элементы списка дел, чтобы убедиться, что приложение работает.
   
    ![Страница "Список дел"](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)
   
    Если приложение не работает правильно, повторно проверьте все параметры, введенные на портале Azure. Если все параметры указаны правильно, см. раздел [Устранение неполадок](#troubleshooting) далее в этом руководстве.

## <a name="protect-the-api-app-from-browser-access"></a>Защита приложения API от доступа браузера
Следуя инструкциям этого руководства, вы создали отдельное приложение Azure AD для приложения API ToDoListDataAPI (уровень данных). Как вы могли убедиться, при создании приложения AAD служба приложений настраивает приложение AAD так, чтобы пользователь мог использовать URL-адрес приложения API для перехода на страницу входа в браузере. Это означает, что доступ к API может осуществлять не только субъект-служба, но и пользователь в клиенте Azure AD. 

Если требуется, чтобы браузер не мог получать доступ без записи кода в защищенное приложение API, вы можете изменить в приложении AAD **URL-адрес ответа** , чтобы он отличался от базового URL-адреса приложения API. 

### <a name="disable-browser-access"></a>Отключение доступа через браузер
1. На классическом портале на вкладке **Настройка** приложения AAD, которое было создано для проекта TodoListService, измените значение в поле **URL-адрес ответа**, чтобы оно являлось действительным URL-адресом, но не URL-адресом приложения API.
2. Щелкните **Сохранить**.

### <a name="verify-browser-access-no-longer-works"></a>Проверка отсутствия доступа через браузер
Ранее вы убедились, что URL-адрес приложения API можно открыть в браузере, если ввести учетные данные отдельного пользователя. В этом разделе вы убедитесь, что это больше нельзя сделать. 

1. В новом окне браузера еще раз перейдите по URL-адресу приложения API.
2. Войдите в систему по запросу.
3. Операция входа завершится отображением страницы ошибки.
   
    Вы настроили приложение AAD, чтобы пользователи в клиенте AAD не могли входить в API и получать к нему доступ с помощью браузера. Вы все еще можете открывать приложение API с помощью токена субъекта-службы, который можно проверить, открыв URL-адрес веб-приложения и добавив дополнительные элементы списка дел.

## <a name="restrict-access-to-a-particular-service-principal"></a>Ограничение доступа к конкретному субъекту-службе
Сейчас любая вызывающая сторона, которая может получить токен для пользователя или субъекта-службы в клиенте Azure AD, может вызвать приложение API TodoListDataAPI (уровень данных). Возможно, вам нужно убедиться, что приложение API уровня данных принимает только вызовы из приложения API TodoListAPI (средний уровень) и только от конкретного субъекта-службы. 

Вы можете добавить эти ограничения, добавив код проверки, чтобы проверить утверждения `appid` и `objectidentifier` на входящих вызовах.

Для целей этого руководства добавьте код, который проверяет идентификатор приложения и идентификатор субъекта-службы непосредственно в действиях контроллера.  В качестве альтернативы используйте пользовательский атрибут `Authorize` или выполните эту проверку в последовательностях запуска (например, ПО промежуточного слоя OWIN). Пример такой последовательности см. в [этом примере приложения](https://github.com/mohitsriv/EasyAuthMultiTierSample/blob/master/MyDashDataAPI/Startup.cs). 

Внесите следующие изменения в проект TodoListDataAPI.

1. Откройте файл *Controllers/TodoListController.cs* .
2. Раскомментируйте строки, в которых задаются значения `trustedCallerClientId` и `trustedCallerServicePrincipalId`.
   
        private static string trustedCallerClientId = ConfigurationManager.AppSettings["todo:TrustedCallerClientId"];
        private static string trustedCallerServicePrincipalId = ConfigurationManager.AppSettings["todo:TrustedCallerServicePrincipalId"];
3. Раскомментируйте следующий код в метод CheckCallerId. Этот метод вызывается в начале каждого метода действия в контроллере. 
   
        private static void CheckCallerId()
        {
            string currentCallerClientId = ClaimsPrincipal.Current.FindFirst("appid").Value;
            string currentCallerServicePrincipalId = ClaimsPrincipal.Current.FindFirst("http://schemas.microsoft.com/identity/claims/objectidentifier").Value;
            if (currentCallerClientId != trustedCallerClientId || currentCallerServicePrincipalId != trustedCallerServicePrincipalId)
            {
                throw new HttpResponseException(new HttpResponseMessage { StatusCode = HttpStatusCode.Unauthorized, ReasonPhrase = "The appID or service principal ID is not the expected value." });
            }
        }
4. Повторно разверните проект ToDoListDataAPI в службе приложений Azure.
5. В браузере откройте URL-адрес HTTPS внешнего веб-приложения AngularJS и на домашней странице откройте вкладку **To Do List** .
   
    Приложение не работает из-за сбоя при выполнении вызовов к серверной части. Новый код проверяет фактические значения appid и objectidentifier, но он еще не содержит правильные значения, чтобы сравнить их. На консоли средств разработчика в браузере появляется сообщение о том, что сервер возвращает ошибку HTTP 401.
   
    ![Ошибка в консоли инструментов для разработчиков](./media/app-service-api-dotnet-service-principal-auth/webapperror.png)
   
    На следующих шагах вы настроите ожидаемые значения.
6. С помощью Azure AD PowerShell получите значение субъекта-службы для приложения Azure AD, которое вы создали для проекта TodoListWebApp.
   
    а. Инструкции по установке и использованию Azure PowerShell см. в статье [Установка и настройка Azure PowerShell](../powershell-azure-resource-manager.md).
   
    b. Чтобы получить список субъектов-служб, выполните команду `Login-AzureRmAccount`, а затем — команду `Get-AzureRmADServicePrincipal`.
   
    В. Найдите значение objectid для субъекта-службы приложения TodoListAPI и сохраните его в расположении, из которого сможете скопировать его позже.
7. На портале Azure перейдите к колонке приложения API, в которое был развернут проект ToDoListDataAPI.
8. Щелкните элементы **Параметры > Параметры приложения**.
9. В разделе **Параметры приложения** добавьте указанные ниже ключи и значения.
   
   | **Ключ** | todo:TrustedCallerServicePrincipalId |
   | --- | --- |
   | **Значение** |Идентификатор субъекта-службы вызывающего приложения |
   | **Пример** |4f4a94a4-6f0d-4072-4f4a94a4-6f0d-4072 |
   
   | **Ключ** | todo:TrustedCallerClientId |
   | --- | --- |
   | **Значение** |Идентификатор клиента вызывающего приложения, скопированный из приложения AAD TodoListAPI |
   | **Пример** |960adec2-b74a-484a-960adec2-b74a-484a |
10. Щелкните **Сохранить**.
    
     ![Щелкните Сохранить](./media/app-service-api-dotnet-service-principal-auth/trustedcaller.png)
11. В браузере еще раз откройте URL-адрес веб-приложения и на домашней странице щелкните вкладку **To Do List** .
    
     На этот раз приложение работает правильно, так как идентификатор доверенного вызывающего приложения и идентификатор субъекта-службы являются ожидаемыми значениями.
    
     ![Страница "Список дел"](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)

## <a name="building-the-projects-from-scratch"></a>Построение проектов с нуля
Эти два проекта веб-API созданы с помощью шаблона проекта **Приложение API Azure** и путем замены контроллера значений по умолчанию контроллером ToDoList. Для получения токенов субъекта-службы Azure AD в проекте ToDoListAPI был установлен пакет NuGet [Библиотека проверки подлинности Active Directory (ADAL) для .NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory/)

Сведения о том, как создать одностраничное приложение AngularJS с внутренним веб-API, таким как ToDoListAngular, см. в статье [Hands On Lab: Build a Single Page Application (SPA) with ASP.NET Web API and Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs) (Практикум. Создание одностраничного приложения (SPA) с веб-API ASP.NET и Angular.js). Сведения о том, как добавить код проверки подлинности Azure AD, см. в статье [Защита одностраничных приложений AngularJS с помощью Azure AD](../active-directory/active-directory-devquickstarts-angular.md).

## <a name="troubleshooting"></a>Устранение неполадок
[!INCLUDE [troubleshooting](../../includes/app-service-api-auth-troubleshooting.md)]

* Убедитесь, что вы не путаете ToDoListAPI (средний уровень) и ToDoListDataAPI (уровень данных). Например, в этом учебнике вы добавляете проверку подлинности в приложение API уровня данных, **но ключ приложения следует взять в приложении Azure AD, созданном для приложения API среднего уровня**.

## <a name="next-steps"></a>Дальнейшие действия
Это последний учебник в серии учебных материалов для работы с приложениями API. 

Дополнительные сведения об Azure Active Directory см. в следующих статьях.

* [Руководство разработчика по Azure Active Directory](http://aka.ms/aaddev)
* [Сценарии проверки подлинности в Azure AD](http://aka.ms/aadscenarios)
* [Azure Samples (Примеры для Azure)](http://aka.ms/aadsamples)
  
    Пример [WebApp-WebAPI-OAuth2-AppIdentity-DotNet](http://github.com/AzureADSamples/WebApp-WebAPI-OAuth2-AppIdentity-DotNet) аналогичен показанному в этом учебнике, но без использования проверки подлинности службы приложений.

Сведения о других способах развертывания проектов Visual Studio в приложениях API с помощью Visual Studio или функции [автоматизации развертывания](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) из [системы управления версиями](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) см. в статье [Развертывание приложения в службе приложений Azure](../app-service-web/web-sites-deploy.md).


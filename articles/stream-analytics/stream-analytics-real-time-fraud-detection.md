# <a name="get-started-using-azure-stream-analytics-real-time-fraud-detection"></a>Приступая к работе с Azure Stream Analytics: выявление мошенничества в режиме реального времени

В этом руководстве содержится комплексное описание использования Azure Stream Analytics. Вы узнаете, как выполнять следующие задачи: 

* Перенести события потоковой передачи в экземпляр концентраторов событий Azure. В рамках этого руководства вы будете использовать соответствующее приложение, имитирующее поток записей метаданных мобильного устройства.

* Написать запросы Stream Analytics, похожие на SQL, чтобы преобразовать данные, которые агрегируют сведения или выполняют поиск шаблонов. Вы узнаете, как использовать запрос для проверки входящего потока, а также как выполнить поиск вызовов, которые могут оказаться мошенническими.

* Отправить результаты в приемник выходных данных (хранилище), где можно анализировать дополнительные сведения. В этом случае вы отправите подозрительные данные вызова в хранилище BLOB-объектов Azure.

В рамках этого руководства мы будем использовать пример выявления мошенничества в реальном времени на основе данных вызовов. Способ, с которым вы ознакомитесь, также подходит для других типов обнаружения мошенничества, например мошеннического использования кредитной карты или кражи личных данных. 

## <a name="scenario-telecommunications-and-sim-fraud-detection-in-real-time"></a>Сценарий. Выявление мошенничества в отношении телекоммуникаций и SIM-карт в режиме реального времени

У поставщика телекоммуникационных услуг есть большой объем данных для входящих вызовов. Компания хочет определить мошеннические вызовы в режиме реального времени, чтобы уведомить клиентов или завершить обслуживание для определенного номера. Один тип мошенничества в отношении SIM-карт включает несколько вызовов из одного удостоверения приблизительно в одно время, но из различных географических расположений. Чтобы обнаружить этот тип мошенничества, компания должна проверить входящие записи телефона и выполнить поиск специальных шаблонов — в этом случае для вызовов, сделанных в одно время из разных стран. Любые записи телефона, соответствующие этой категории, записываются в хранилище для последующего анализа.

## <a name="prerequisites"></a>Технические условия

В рамках этого руководства вы смоделируете данные вызовов с помощью клиентского приложения, которое создает пример метаданных вызова. Некоторые из записей, которые создает приложение, выглядят, как мошеннические вызовы. 

Чтобы начать, у вас должны быть следующие компоненты:

* Учетная запись Azure.
* Приложение генератора событий вызовов. Вы можете получить его, загрузив [файл TelcoGenerator.zip](http://download.microsoft.com/download/8/B/D/8BD50991-8D54-4F59-AB83-3354B69C8A7E/TelcoGenerator.zip) из Центра загрузки Майкрософт. Распакуйте этот пакет в папку на компьютере. Если нужно просмотреть исходный код и запустить приложение в отладчике, можно получить исходный код на [GitHub](https://aka.ms/azure-stream-analytics-telcogenerator). 

    >[!NOTE]
    >Windows может заблокировать загруженный ZIP-файл. Если вам не удается распаковать его, щелкните файл правой кнопкой мыши и выберите **Свойства**. Если появляется сообщение "Этот файл получен с другого компьютера и, возможно, был заблокирован с целью защиты компьютера", выберите параметр **Разблокировать**, а затем щелкните **Применить**.

Если вы хотите проанализировать результаты задания Streaming Analytics, вам также необходимо средство просмотра содержимого контейнера хранилища BLOB-объектов Azure. Если вы используете Visual Studio, можно использовать [инструменты Azure для Visual Studio](https://docs.microsoft.com/azure/vs-azure-tools-storage-resources-server-explorer-browse-manage) или [Visual Studio Cloud Explorer](https://docs.microsoft.com/azure/vs-azure-tools-resources-managing-with-cloud-explorer). Кроме того, можно установить автономные средства, например [обозреватель хранилищ Azure](http://storageexplorer.com/) или [Azure Explorer](http://www.cerebrata.com/products/azure-explorer/introduction). 

## <a name="create-an-azure-event-hubs-to-ingest-events"></a>Создание концентраторов событий Azure для приема событий

Чтобы проанализировать поток данных, необходимо *принять* его в Azure. Стандартный способ принять данные — использовать [концентраторы событий Azure](../event-hubs/event-hubs-what-is-event-hubs.md). Они позволяют принимать миллионы событий в секунду, а затем обрабатывают и сохраняют сведения о событиях. В рамках этого руководства вы создадите концентратор событий, а затем приложение генератора событий вызовов отправит данные вызовов в этот концентратор событий. Дополнительные сведения о концентраторах событий см. на странице [Документация по служебной шине](https://docs.microsoft.com/azure/service-bus/).

>[!NOTE]
>Ознакомьтесь со статьей [Создание пространства имен концентраторов событий и концентратора событий с помощью портала Azure](../event-hubs/event-hubs-create.md), чтобы получить более подробные сведения об этой процедуре. 

### <a name="create-a-namespace-and-event-hub"></a>Создание пространства имен и концентратора событий
В этой процедуре сначала создается пространство имен концентратора событий, а затем в это пространство имен добавляется концентратор событий. Пространства имен концентратора событий используются для логической группировки связанных экземпляров шины событий. 

1. Войдите на портал Azure, выберите **Создать** > **"Интернет вещей"** > **Концентратор событий**. 

2. В области **Создать пространство имен** укажите имя пространства имен, например `<yourname>-eh-ns-demo`. Для пространства имен можно использовать любое уникальное в Azure имя с допустимым URL-адресом. 
    
3. Выберите подписку, создайте или выберите группу ресурсов, а затем щелкните **Создать**. 

    ![Создание пространства имен концентратора событий](./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-eventhub-namespace-new-portal.png)
 
4. После завершения развертывания пространства имен найдите пространство имен концентратора событий в списке ресурсов Azure. 

5. Щелкните новое пространство имен, а затем в открывшейся области щелкните **Концентратор событий**.

    ![Кнопка "Добавить концентратор событий" для создания нового концентратора событий ](./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-eventhub-button-new-portal.png)    
 
6. Назовите новый концентратор событий `sa-eh-frauddetection-demo`. Вы можете использовать другое имя. В таком случае запишите его, так как это имя понадобится вам позже. На этом этапе этих параметров концентратора событий достаточно.

    ![Колонка создания нового концентратора событий](./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-eventhub-new-portal.png)
    
 
7. Нажмите кнопку **Создать**.
### <a name="grant-access-to-the-event-hub-and-get-a-connection-string"></a>Предоставление доступа к концентратору событий и получение строки подключения

Для того чтобы процесс смог отправлять данные в концентратор событий, концентратор должен иметь политику, разрешающую соответствующий доступ. Политика доступа создает строку подключения, которая включает сведения об авторизации.

1.  В области пространства имен событий щелкните **Концентраторы событий**, а затем щелкните имя нового концентратора событий.

2.  В области концентратора событий щелкните **Политики общего доступа**, а затем выберите **+&nbsp;Добавить**.

    >[!NOTE]
    >Вы должны работать с концентратором событий, а не пространством имен концентратора.

3.  Добавьте политику с именем `sa-policy-manage-demo`, а для параметра **Утверждение** выберите **Управление**.

    ![Колонка создания политики доступа для нового концентратора событий](./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-shared-access-policy-manage-new-portal.png)
 
4.  Нажмите кнопку **Создать**.

5.  После развертывания политики щелкните ее в списке политик общего доступа.

6.  Найдите текстовое поле с пометкой **Строка подключения — первичный ключ** и нажмите кнопку копирования рядом со строкой подключения. 
    
    ![Копирование первичного ключа строки подключения из политики доступа](./media/stream-analytics-real-time-fraud-detection/stream-analytics-shared-access-policy-copy-connection-string-new-portal.png)
 
7.  Вставьте строку подключения в текстовый редактор. Эта строка подключения понадобится в следующем разделе после внесения в нее небольших изменений.

    Строка подключения выглядит следующим образом:

        Endpoint=sb://YOURNAME-eh-ns-demo.servicebus.windows.net/;SharedAccessKeyName=sa-policy-manage-demo;SharedAccessKey=Gw2NFZwU1Di+rxA2T+6hJYAtFExKRXaC2oSQa0ZsPkI=;EntityPath=sa-eh-frauddetection-demo

    Обратите внимание, что строка подключения содержит несколько пар "ключ — значение", которые разделены точкой с запятой: `Endpoint`, `SharedAccessKeyName`, `SharedAccessKey` и `EntityPath`.  

## <a name="configure-and-start-the-event-generator-application"></a>Настройка и запуск приложения генератора событий

Прежде чем запускать приложение TelcoGenerator, необходимо его настроить, чтобы оно могло отправлять записи вызовов в созданный концентратор событий.

### <a name="configure-the-telcogeneratorapp"></a>Настройка приложения TelcoGenerator

1.  В редакторе, куда вы скопировали строку подключения, запишите значение `EntityPath`, а затем удалите пару `EntityPath` (не забудьте удалить точку с запятой, предшествующую ей). 

2.  В папке, где вы распаковали файл TelcoGenerator.zip, откройте в редакторе файл telcodatagen.exe.config. (Если имеется более одного CONFIG-файла, проверьте, что вы открыли нужный.)

3.  В элементе `<appSettings>` сделайте следующее:

    * Задайте для ключа `EventHubName` значение имени концентратора событий (то есть значение пути к сущности).
    * Задайте для ключа `Microsoft.ServiceBus.ConnectionString` значение строки подключения. 

    Раздел `<appSettings>` будет выглядеть, как показано в примере ниже. (Чтобы было более понятно, мы добавили отступы для строк и удалили некоторые знаки из маркера проверки подлинности.)

    ![Файл конфигурации приложения TelcoGenerator, отображающий имя концентратора событий и строку подключения](./media/stream-analytics-real-time-fraud-detection/stream-analytics-telcogenerator-config-file-app-settings.png)
 
4.  Сохраните файл. 

### <a name="start-the-app"></a>Запуск приложения
1.  Откройте окно командной строки и перейдите в папку, в которой было распаковано приложение TelcoGenerator.
2.  Введите следующую команду:

        telcodatagen.exe 1000 .2 2

    Используются следующие параметры: 

    * Число записей подробных сведений о звонках за час. 
    * Вероятность мошенничества с SIM-картами: частота моделирования приложением мошеннических вызовов, выраженная в процентном соотношении ко всем вызовам. Значение .2 означает, что около 20 % записей вызовов будут мошенническими.
    * Продолжительность в часах. Количество часов, на протяжении которых должно выполняться приложение. Вы также можете остановить выполнение приложения, использовав Ctrl+C в командной строке.

    Через несколько секунд приложение запустит отображение записей вызовов на экране, так как будет отправлять их в концентратор событий.

Ниже определены некоторые ключевые поля, которые будут использоваться в этом приложении для выявления мошенничества в реальном времени:

|**Запись**|**Определение**|
|----------|--------------|
|`CallrecTime`|Метка времени начала вызова. |
|`SwitchNum`|Телефонный переключатель, используемый для совершения вызова. В этом примере переключатели выражены строками, представляющими страну происхождения (США, Китай, Великобритания, Германия или Австралия). |
|`CallingNum`|Номер телефона звонящего. |
|`CallingIMSI`|Идентификатор абонента международной мобильной связи (IMSI). Это уникальный идентификатор звонящего. |
|`CalledNum`|Номер телефона получателя. |
|`CalledIMSI`|Идентификатор IMSI. Это уникальный идентификатор получателя. |


## <a name="create-a-stream-analytics-job-to-manage-streaming-data"></a>Создание задания Stream Analytics для управления потоковой передачей данных

Теперь, когда у вас есть поток событий вызовов, вы можете настроить задание Stream Analytics. Задание будет считывать данные из настроенного концентратора событий. 

### <a name="create-the-job"></a>Создание задания 

1. На портале Azure щелкните **Создать** > **"Интернет вещей"** > **Задание Stream Analytics**.

2. Назовите задание `sa_frauddetection_job_demo` и укажите подписку, группу ресурсов и расположение.

    Мы рекомендуем поместить задание и концентратор событий в одном регионе, чтобы достичь оптимальной производительности и не оплачивать передачу данных между регионами.

    ![Создание нового задания Stream Analytics](./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-sa-job-new-portal.png)

3. Нажмите кнопку **Создать**.

    Будет создано задание, и на портале отобразятся сведения о нем. Теперь, чтобы запустить задание, необходимо его настроить.

### <a name="configure-job-input"></a>Настройка входных данных для задания

1. На панели мониторинга или в области **Все ресурсы** найдите и выберите задание Stream Analytics `sa_frauddetection_job_demo`. 
2. В разделе **Топология задания** колонки задания Stream Analytics щелкните область **Входные данные**.

    ![Поле входных данных в разделе топологии задания в области задания Streaming Analytics](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-input-box-new-portal.png)
 
3. Щелкните **+&nbsp;Добавить**, а затем заполните область следующими значениями:

    * **Входной псевдоним**: используйте имя `CallStream`. Если используется другое имя, запишите его, так как оно понадобится позже.
    * **Тип источника**: выберите **Поток данных**. (**Справочные данные** относятся к статическим данным подстановки, которые не требуются для работы с этим руководством.)
    * **Источник**: выберите **Концентратор событий**.
    * **Вариант импорта**: выберите **Использовать концентратор событий из текущей подписки**. 
    * **Пространство имен служебной шины**: выберите созданное ранее пространство имен концентратора событий (`<yourname>-eh-ns-demo`).
    * **Концентратор событий**: выберите ранее созданный концентратор событий (`sa-eh-frauddetection-demo`).
    * **Имя политики концентратора событий**: выберите ранее созданную политику доступа (`sa-policy-manage-demo`).

    ![Создание новых входных данных для задания Streaming Analytics](./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-sa-input-new-portal.png)

4. Нажмите кнопку **Создать**.

## <a name="create-queries-to-transform-real-time-data"></a>Создание запросов для преобразования данных в режиме реального времени

На этом этапе задание Stream Analytics настроено на считывание входящего потока данных. Далее необходимо создать преобразование, анализирующее данные в режиме реального времени. Сделаем это с помощью создания запроса. Stream Analytics поддерживает простую декларативную модель запроса для описания преобразований для обработки в режиме реального времени. Запросы используют язык на основе SQL, который содержит некоторые расширения, характерные для анализа потока. 

Простой запрос считывает все входящие данные. Тем не менее часто создаются запросы, которые выполняют поиск конкретных данных или связей в данных. В этом разделе руководства вы создадите и проверите несколько запросов, чтобы ознакомиться с несколькими способами преобразования входного потока для анализа. 

Запросы, созданные в рамках этого руководства, выведут преобразованные данные на экран. В следующем разделе вы настроите приемник выходных данных и запрос, записывающий преобразованные данные в этот приемник.

Дополнительные сведения о языке см. в разделе [Справочник по языку запросов Azure Stream Analytics](https://msdn.microsoft.com/library/dn834998.aspx).

### <a name="get-sample-data-for-testing-queries"></a>Получение образца данных для запросов для тестирования

Приложение TelcoGenerator отправляет записи вызовов в концентратор событий, а задание Stream Analytics настроено на считывание записей из концентратора событий. Вы можете использовать запрос для проверки задания, чтобы убедиться, что считывание выполняется соответствующим образом. Чтобы проверить запрос в консоли Azure, вам необходим образец данных. В рамках этого пошагового руководства вы извлечете образец данных из потока, поступающего в концентратор событий.

1. Проверьте, чтобы приложение TelcoGenerator работало и создавало записи вызовов.
2. Вернитесь в область задания Streaming Analytics на портале. (Если вы закрыли область, найдите `sa_frauddetection_job_demo` в области **Все ресурсы**.)
3. Щелкните поле **Запрос**. Azure перечислит входные и выходные данные, настроенные для задания, и позволит создать запрос, с помощью которого можно преобразовать входной поток, отправляемый на выход.
4. В области **Запрос** щелкните точки рядом с входными данными `CallStream`, а затем выберите **Образец данных со входа**.

    ![Параметры меню для использования примера данных для записи задания Streaming Analytics с выбранным параметром "Образец данных со входа"](./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-sample-data-from-input.png)

    Откроется область, в которой можно указать количество образцов данных для получения на основе того, как долго нужно считывать входной поток.

5. Для параметра **Минуты** задайте значение 3 и нажмите кнопку **ОК**. 
    
    ![Параметры выборки входного потока с выбранным значением "3 минуты".](./media/stream-analytics-real-time-fraud-detection/stream-analytics-input-create-sample-data.png)

    Azure обработает данные из входного потока, накопленные за 3 минуты, и сообщит о готовности образца данных. (Это займет некоторое время.) 

Образец данных хранится временно и доступен, пока открыто окно запроса. Если закрыть окно запроса, образец данных будет удален и придется создать новый набор образцов данных. 

В качестве альтернативы можно получить JSON-файл, содержащий образец данных, с помощью [GitHub](https://github.com/Azure/azure-stream-analytics/blob/master/Sample%20Data/telco.json), а затем отправить этот файл для использования в качестве образца данных для входного псевдонима `CallStream`. 

### <a name="test-using-a-pass-through-query"></a>Проверка с помощью запроса к серверу

Чтобы архивировать все события, вы можете использовать запрос к серверу для считывания всех полей в полезных данных события.

1. В окне запроса введите следующий запрос:

        SELECT 
            *
        FROM 
            CallStream

    >[!NOTE]
    >Как и при использовании SQL, регистр ключевых слов не учитывается, пробел не имеет значения.

    В этом запросе `CallStream` — это входной псевдоним, указанный при создании входных данных для задания. Если вы использовали другой псевдоним, используйте его, соответственно.

2. Нажмите **Проверить**.

    Задание Stream Analytics выполняет запрос образцов данных и отображает выходные данные в нижней области окна. Это говорит о том, что концентратор событий и задание Streaming Analytics настроены правильно. (Как уже отмечалось выше, позже вы создадите приемник выходных данных, в который запрос может записывать данные.)

    ![Выходные данные задания Stream Analytics, отображающие 73 созданные записи.](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-sample-output.png)

    Точное число отображаемых записей будет зависеть от числа записей, собранных за 3 минуты.
 
### <a name="reduce-the-number-of-fields-using-a-column-projection"></a>Уменьшение числа полей с помощью заполнения столбцов

Во многих случаях анализу не требуются все столбцы из входного потока. Вы можете использовать запрос, чтобы создать меньший набор возвращаемых полей по сравнению с набором в запросе к серверу.

1. Измените запрос в редакторе кода, используя следующие значения:

        SELECT CallRecTime, SwitchNum, CallingIMSI, CallingNum, CalledNum 
        FROM 
            CallStream

2. Снова щелкните **Проверка**. 

    ![Выходные данные задания Stream Analytics для заполнения столбцов, отображающие 25 созданных записей](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-sample-output-projection.png)
 
### <a name="count-incoming-calls-by-region-tumbling-window-with-aggregation"></a>Количество входящих вызовов по региону: "переворачивающееся" окно с агрегированием

Предположим, вам нужно посчитать число входящих вызовов на регион. В потоковой передаче данных, если вы хотите использовать статистические функции, например подсчет, вам нужно сегментировать поток на временные единицы (так как сам поток данных является цельным). Это можно сделать с помощью [функции окна](stream-analytics-window-functions.md) Streaming Analytics. Затем вы сможете работать с данными в этом окне как с отдельными единицами.

Для такого преобразования нужна последовательность временных окон, которые не перекрываются. У каждого окна будет дискретный набор данных, которые можно группировать и статистически обрабатывать. Такой тип окна называется *"переворачивающимся" окном*. В "переворачивающемся" окне вы можете получить число входящих вызовов, сгруппированных `SwitchNum` — переключателем, который представляет страну (расположение) вызова. 

1. Измените запрос в редакторе кода, используя следующие значения:

        SELECT 
            System.Timestamp as WindowEnd, SwitchNum, COUNT(*) as CallCount 
        FROM
            CallStream TIMESTAMP BY CallRecTime 
        GROUP BY TUMBLINGWINDOW(s, 5), SwitchNum

    Этот запрос использует ключевое слово `Timestamp By` в предложении `FROM`, чтобы указать, какое поле метки времени использовать во входном потоке для определения "переворачивающегося" окна. В этом случае окно делит данные на сегменты по полю `CallRecTime` в каждой записи. Если поле не указано, при выполнении операций с окнами будет использоваться время поступления каждого события в концентратор событий. Дополнительные сведения см. в разделе о времени поступления и времени приложения в [справочнике по языку запросов Stream Analytics](https://msdn.microsoft.com/library/azure/dn834998.aspx). 

    Проектирование включает запрос `System.Timestamp`, возвращающий метку времени конца каждого окна. 

    Чтобы указать, что вы хотите использовать "переворачивающееся" окно, используйте функцию [TUMBLINGWINDOW](https://msdn.microsoft.com/library/dn835055.aspx) в предложении `GROUP BY `. В функции укажите единицу времени (от микросекунд до 24 часов) и размер окна (количество единиц). В этом примере "переворачивающееся" окно состоит из пятисекундных интервалов, поэтому вы получите количество вызовов по странам за 5 секунд.

2. Снова щелкните **Проверка**. В результатах обратите внимание на то, что метки времени в **WindowEnd** формируются с шагом приращения в 5 секунд.

    ![Выходные данные задания Stream Analytics для статистической обработки, отображающие 13 созданных записей](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-sample-output-aggregation.png)
 
### <a name="detect-sim-fraud-using-a-self-join"></a>Выявление мошенничества в отношении SIM-карт с помощью самосоединения

В этом примере мы рассмотрим мошеннические вызовы, выполненные одним пользователем, но из различных регионов с интервалом в 5 секунд. Например, один и тот же пользователь не может законным путем сделать звонок из США и Австралии одновременно. 

Чтобы проверить такие случаи, вы можете использовать самосоединение потоковой передачи данных, чтобы выполнить самосоединение потока на основе значения `CallRecTime`. Затем вы можете найти записи вызовов, в которых значение `CallingIMSI` (исходящий номер) остается неизменным, а значение `SwitchNum` (страна происхождения) — изменяется.

При использовании соединения с потоковой передачей данных соединение должно предоставить некоторые ограничения в отношении того, насколько совпадающие строки могут быть разделены по времени. (Как уже отмечалось выше, потоковая передача данных является цельной.) Пределы времени для связи задаются в предложении соединения `ON` с помощью функции `DATEDIFF`. В этом случае соединение основано на 5-секундном интервале данных вызова.

1. Измените запрос в редакторе кода, используя следующие значения: 

        SELECT  System.Timestamp as Time, 
            CS1.CallingIMSI, 
            CS1.CallingNum as CallingNum1, 
            CS2.CallingNum as CallingNum2, 
            CS1.SwitchNum as Switch1, 
            CS2.SwitchNum as Switch2 
        FROM CallStream CS1 TIMESTAMP BY CallRecTime 
            JOIN CallStream CS2 TIMESTAMP BY CallRecTime 
            ON CS1.CallingIMSI = CS2.CallingIMSI 
            AND DATEDIFF(ss, CS1, CS2) BETWEEN 1 AND 5 
        WHERE CS1.SwitchNum != CS2.SwitchNum

    Этот запрос напоминает любое другое соединение SQL за исключением функции в соединении `DATEDIFF`. Эта версия функции `DATEDIFF` предназначена для Streaming Analytics и должна появиться в предложении `ON...BETWEEN`. Параметры представлены единицей времени (в этом примере — секундами) и псевдонимами двух источников для соединения. (В этом отличие от стандартной функции SQL `DATEDIFF`.) 

    Предложение `WHERE` содержит условие, которое помечает мошеннический вызов — исходящие переключатели не совпадают. 

2. Снова щелкните **Проверка**. 

    ![Выходные данные задания Stream Analytics для самосоединения, отображающие 6 созданных записей](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-sample-output-self-join.png)

3. Выберите команду **Сохранить**. После этого запрос на самосоединение сохранится как часть задания Streaming Analytics. (Образец данных не сохраняется.)

    ![Сохранение задания Stream Analytics](./media/stream-analytics-real-time-fraud-detection/stream-analytics-query-editor-save-button-new-portal.png)

## <a name="create-an-output-sink-to-store-transformed-data"></a>Создание приемника выходных данных для хранения преобразованных данных

Вы определили поток событий, входные данные концентратора событий для приема событий и запрос для выполнения преобразования потока. Осталось определить приемник выходных данных для задания, т. е. место для записи преобразованного потока. 

Вы можете использовать многие ресурсы в качестве приемников выходных данных — базу данных SQL Server, хранилище таблиц, хранилище озера данных, Power BI и даже другой концентратор событий. В рамках этого руководства вы запишете поток в хранилище BLOB-объектов Azure. Это стандартный вариант для сбора сведений о событиях для последующего анализа, так как его можно использовать для неструктурированных данных.

Если у вас есть учетная запись хранения BLOB-объектов, вы можете ее использовать. В рамках этого руководства мы покажем, как создать учетную запись хранения для работы только с этим руководством.

### <a name="create-an-azure-blob-storage-account"></a>Создание учетной записи хранения BLOB-объектов Azure

1. Вернитесь в область задания Streaming Analytics на портале Azure. (Если вы закрыли область, найдите `sa_frauddetection_job_demo` в области **Все ресурсы**.)
2. В разделе **Топологии задания** щелкните поле **Выходные данные**. 
3. В области **Выходные данные** щелкните **+&nbsp;Добавить**, а затем заполните область следующими значениями:

    * **Выходной псевдоним**: используйте имя `CallStream-FraudulentCalls`. 
    * **Приемник.** Выберите **хранилище BLOB-объектов**.
    * **Параметры импорта**: выберите **Использовать хранилище BLOB-объектов из текущей подписки**.
    * **Учетная запись хранения**. Выберите **Создать новую учетную запись хранения.**
    * **Учетная запись хранения** (второе диалоговое окно). Введите `YOURNAMEsademo`, где `YOURNAME` — ваше имя или другая уникальная строка. Имя должно быть уникальным в Azure и может содержать только строчные буквы и цифры. 
    * **Контейнер**. Укажите `sa-fraudulentcalls-demo`.
    Имя учетной записи хранения и имя контейнера используются совместно для предоставления URI для хранилища BLOB-объектов следующим образом: 

    `http://yournamesademo.blob.core.windows.net/sa-fraudulentcalls-demo/...`
    
    ![Область "Новые выходные данные" для задания Stream Analytics](./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-output-blob-storage-new-console.png)
    
4. Нажмите кнопку **Создать**. 

    Azure создаст учетную запись хранения и ключ автоматически. 

5. Закройте область **Выходные данные**. 

## <a name="start-the-streaming-analytics-job"></a>Запуск задания Streaming Analytics

Вы настроили задание. Вы указали входные данные (концентратор событий), преобразование (запрос для поиска мошеннических вызовов) и выходные данные (хранилище BLOB-объектов). Теперь вы можете запустить задание. 

1. Проверьте, чтобы приложение TelcoGenerator работало.

2. В области задания щелкните **Запуск**.

    ![Запуск задания Stream Analytics](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-start-output.png)

3. В области **Запуск задания** для параметра "Время запуска создания выходных данных задания" выберите **Сейчас**. 

4. Нажмите **Запуск**. 

    ![Область "Запуск задания" для задания Stream Analytics](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-start-job-blade.png)

    Azure сообщит о запуске задания, а в области задания отобразится состояние **Выполняется**.

    ![Состояние задания Stream Analytics, отображающее состояние "Выполнение"](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-running-status.png)
    

## <a name="examine-the-transformed-data"></a>Проверка преобразованных данных

Теперь у вас есть готовое задание Streaming Analytics. Задание проверяет поток метаданных телефонных вызовов, выполняет поиск мошеннических вызовов в режиме реального времени, а также записывает сведения об этих мошеннических вызовах в хранилище. 

Чтобы завершить работу с этим руководством, просмотрите данные, собранные заданием Streaming Analytics. Данные записываются в хранилище BLOB-объектов Azure в блоки (файлы). Вы можете использовать любое средство, считывающее хранилище BLOB-объектов Azure. Как упоминалось в разделе предварительных требований, вы можете использовать расширения Azure в Visual Studio или средства [обозреватель хранилищ Azure](http://storageexplorer.com/) или [Azure Explorer](http://www.cerebrata.com/products/azure-explorer/introduction). 

При проверке содержимого файла в хранилище BLOB-объектов вы должны увидеть примерно следующее:

![Хранилище BLOB-объектов Azure с выходными данными Streaming Analytics](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-blob-storage-view.png)
 

## <a name="clean-up-resources"></a>Очистка ресурсов

У нас есть и другие статьи, в которых рассматриваются сценарии обнаружения мошенничества и используются ресурсы, созданные при работе с этим руководством. Если вы хотите ознакомиться с этими статьями, перейдите к разделу **Следующие шаги** ниже.

Если же этого руководства вам достаточно и созданные ресурсы вам больше не нужны, вы можете их удалить, чтобы за их использование не взималась плата. Чтобы удалить ресурсы, сделайте следующее:

1. Завершите задание Streaming Analytics. В области **Задания** в верхней области щелкните **Остановить**.
2. Завершите работу приложения TelcoGenerator. В командной строке, где вы запустили приложение, нажмите Ctrl+C.
3. Если вы создали новую учетную запись хранения BLOB-объектов только для работы с этим руководством, удалите ее. 
4. Удалите задание Streaming Analytics.
5. Удалите концентратор событий.
6. Удалите пространство имен концентратора событий.

## <a name="get-support"></a>Получение поддержки

За дополнительной помощью обращайтесь на наш [форум Azure Stream Analytics](https://social.msdn.microsoft.com/Forums/en-US/home?forum=AzureStreamAnalytics).

## <a name="next-steps"></a>Дальнейшие действия

Вы можете ознакомиться со следующей статьей, связанной с этим руководством:

* [Stream Analytics и Power BI. Панель мониторинга для анализа потоковой передачи данных](stream-analytics-power-bi-dashboard.md). В этой статье описывается, как отправить выходные данные TelCo задания Stream Analytics в Power BI для визуализации и анализа в режиме реального времени.

Узнать больше о Stream Analytics в целом вы можете с помощью следующих ресурсов:

* [Введение в Azure Stream Analytics](stream-analytics-introduction.md)
* [Масштабирование заданий в службе Azure Stream Analytics](stream-analytics-scale-jobs.md)
* [Справочник по языку запросов Azure Stream Analytics](https://msdn.microsoft.com/library/azure/dn834998.aspx)
* [Справочник по API-интерфейсу REST управления Stream Analytics](https://msdn.microsoft.com/library/azure/dn835031.aspx)

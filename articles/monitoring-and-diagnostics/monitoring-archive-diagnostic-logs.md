---
title: "Архивация журналов диагностики Azure | Документация Майкрософт"
description: "Узнайте, как выполнить архивацию журналов диагностики Azure для долгосрочного хранения в учетной записи хранения."
author: johnkemnetz
manager: orenr
editor: 
services: monitoring-and-diagnostics
documentationcenter: monitoring-and-diagnostics
ms.assetid: 3a55c73f-2ef3-45f3-8956-bcf9c0cb7e05
ms.service: monitoring-and-diagnostics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/21/2017
ms.author: johnkem
ms.openlocfilehash: dbc5f89001dcb6cd1ab061cb0a9632e4e5d2c1c7
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="archive-azure-diagnostic-logs"></a>Архивация журналов диагностики Azure
В этой статье описано, как настроить архивацию [журналов диагностики Azure](monitoring-overview-of-diagnostic-logs.md) в учетной записи хранения с помощью портала Azure, командлетов PowerShell, интерфейса командной строки или REST API. Архивацию целесообразно применять, если вам нужно хранить журналы диагностики с использованием необязательной политики хранения для аудита, статического анализа или резервного копирования. Учетная запись хранения не обязательно должна находиться в той самой подписке, в которой находится ресурс, выдающий журналы, если у пользователя, настраивающего параметр, имеется соответствующий доступ RBAC к обеим подпискам.

## <a name="prerequisites"></a>Предварительные требования
Перед началом работы необходимо [создать учетную запись хранения](../storage/storage-create-storage-account.md) для архивации журналов диагностики. Настоятельно рекомендуется не использовать имеющуюся учетную запись хранения, в которой содержатся другие данные (не данные мониторинга), чтобы лучше контролировать доступ к данным мониторинга. Но если в учетную запись хранения вы архивируете журнал действий и метрики диагностики, целесообразно использовать эту учетную запись и для хранения журналов диагностики. Так все данные мониторинга будут храниться в одном расположении. Используйте учетную запись хранения общего назначения, а не учетную запись хранения больших двоичных объектов.

## <a name="diagnostic-settings"></a>Параметры диагностики
Чтобы архивировать журналы диагностики с помощью любого из описанных ниже методов, укажите **параметр диагностики** для конкретного ресурса. Параметр диагностики для ресурса определяет категории журналов и данные метрик, отправляемых в целевое расположение (учетная запись хранения, пространство имен концентраторов событий или Log Analytics). Он также определяет политику хранения событий (продолжительность хранения в днях) для событий каждой категории журналов и данных метрик, содержащихся в учетной записи хранения. Если для политики хранения задано значение 0, события для такой категории журналов хранятся неограниченное время, то есть они сохраняются навсегда. Для политики хранения можно задать любое значение от 1 до 2 147 483 647. [Подробные сведения о параметрах диагностики см. здесь](monitoring-overview-of-diagnostic-logs.md#resource-diagnostic-settings). Политики хранения применяются по дням, поэтому в конце дня (по времени в формате UTC) журналы, срок которых теперь превышает период хранения, будут удалены. Например, если настроена политика хранения в течение одного дня, то в начале текущего дня журналы за вчерашний день будет удалены.

## <a name="archive-diagnostic-logs-using-the-portal"></a>Архивация журналов диагностики с помощью портала
1. На портале перейдите к Azure Monitor и щелкните **Параметры диагностики**.

    ![Раздел мониторинга Azure Monitor](media/monitoring-archive-diagnostic-logs/diagnostic-settings-blade.png)

2. При необходимости отфильтруйте список по группе или типу ресурса, а затем щелкните ресурс, для которого необходимо задать параметр диагностики.

3. Если параметров для выбранного ресурса не существует, вам будет предложено создать параметр. Щелкните Turn on diagnostics (Включить диагностику).

   ![Добавление параметра диагностики — имеющиеся параметры отсутствуют](media/monitoring-archive-diagnostic-logs/diagnostic-settings-none.png)

   Если в ресурсе имеются параметры, для него отобразится список настроенных параметров. Нажмите Add diagnostic setting (Добавить параметр диагностики).

   ![Добавление параметра диагностики — имеющиеся параметры](media/monitoring-archive-diagnostic-logs/diagnostic-settings-multiple.png)

3. Задайте имя параметра и установите флажок **Export to Storage Account** (Экспорт в учетную запись хранения), а затем выберите учетную запись хранения. При необходимости с помощью ползунков **Хранение (дни)** укажите продолжительность хранения этих журналов в днях. Нулевое значение означает, что журналы будут храниться неограниченно долго.
   
   ![Добавление параметра диагностики — имеющиеся параметры](media/monitoring-archive-diagnostic-logs/diagnostic-settings-configure.png)
    
4. Щелкните **Сохранить**.

Через несколько секунд появится новый параметр в списке параметров для данного ресурса, и сразу же после создания данных о событии журналы диагностики заархивируются в необходимую учетную запись хранения.

## <a name="archive-diagnostic-logs-via-azure-powershell"></a>Архивация журналов диагностики с помощью Azure PowerShell
```
Set-AzureRmDiagnosticSetting -ResourceId /subscriptions/s1id1234-5679-0123-4567-890123456789/resourceGroups/testresourcegroup/providers/Microsoft.Network/networkSecurityGroups/testnsg -StorageAccountId /subscriptions/s1id1234-5679-0123-4567-890123456789/resourceGroups/myrg1/providers/Microsoft.Storage/storageAccounts/my_storage -Categories networksecuritygroupevent,networksecuritygrouprulecounter -Enabled $true -RetentionEnabled $true -RetentionInDays 90
```

| Свойство | Обязательно | Описание |
| --- | --- | --- |
| ResourceId |Да |Идентификатор ресурса, для которого будет указан параметр диагностики. |
| StorageAccountId |Нет |Идентификатор учетной записи хранения, в которую будут сохранены журналы диагностики. |
| Категории |Нет |Разделенный запятыми список категорий журналов, которые будут включены. |
| Включено |Да |Логическое значение, определяющее включение и отключение диагностики на этом ресурсе. |
| RetentionEnabled |Нет |Логическое значение, определяющее включение политики хранения на этом ресурсе. |
| RetentionInDays |Нет |Количество дней, в течение которых будут храниться события: от 1 до 2 147 483 647. Нулевое значение означает, что журналы хранятся неограниченно долго. |

## <a name="archive-diagnostic-logs-via-the-cross-platform-cli"></a>Архивация журналов диагностики с помощью кроссплатформенного интерфейса командной строки
```
azure insights diagnostic set --resourceId /subscriptions/s1id1234-5679-0123-4567-890123456789/resourceGroups/testresourcegroup/providers/Microsoft.Network/networkSecurityGroups/testnsg --storageId /subscriptions/s1id1234-5679-0123-4567-890123456789/resourceGroups/myrg1/providers/Microsoft.Storage/storageAccounts/my_storage –categories networksecuritygroupevent,networksecuritygrouprulecounter --enabled true
```

| Свойство | Обязательно | Описание |
| --- | --- | --- |
| ResourceId |Да |Идентификатор ресурса, для которого будет указан параметр диагностики. |
| storageId |Нет |Идентификатор учетной записи хранения, в которую необходимо сохранить журналы диагностики. |
| Категории |Нет |Разделенный запятыми список категорий журналов, которые будут включены. |
| Включено |Да |Логическое значение, определяющее включение и отключение диагностики на этом ресурсе. |

## <a name="archive-diagnostic-logs-via-the-rest-api"></a>Архивация журналов диагностики с помощью REST API
Подробные сведения о настройке параметра диагностики с помощью REST API Azure Monitor см. [здесь](https://docs.microsoft.com/rest/api/monitor/servicediagnosticsettings).

## <a name="schema-of-diagnostic-logs-in-the-storage-account"></a>Схема журналов диагностики в учетной записи хранилища
Когда вы настроите архивацию, в учетной записи хранения будет создан контейнер хранилища, как только в одной из включенных категорий журналов возникнет событие журнала. Большие двоичные объекты, содержащиеся в контейнере, имеют одинаковый формат в журналах диагностики и действий. Вот как выглядит структура большого двоичного объекта:

> insights-logs-{имя категории журнала}/resourceId=/SUBSCRIPTIONS/{код подписки}/RESOURCEGROUPS/{имя группы ресурсов}/PROVIDERS/{имя поставщика ресурсов}/{тип ресурса}/{имя ресурса}/y={год цифрами, 4 цифры}/m={месяц цифрами, 2 цифры}/d={день цифрами, 2 цифры}/h={время цифрами, 2 цифры, 24-часовой формат}/m=00/PT1H.json
> 
> 

Или даже еще проще:

> insights-logs-{имя категории журнала}/resourceId=/{resource Id}/y={год цифрами, 4 цифры}/m={месяц цифрами, 2 цифры}/d={день цифрами, 2 цифры}/h={время цифрами, 2 цифры, 24-часовой формат}/m=00/PT1H.json
> 
> 

Например, большой двоичный объект может иметь такое имя:

> insights-logs-networksecuritygrouprulecounter/resourceId=/SUBSCRIPTIONS/s1id1234-5679-0123-4567-890123456789/RESOURCEGROUPS/TESTRESOURCEGROUP/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUP/TESTNSG/y=2016/m=08/d=22/h=18/m=00/PT1H.json
> 
> 

Каждый большой двоичный объект PT1H.json содержит большой двоичный объект JSON с событиями, произошедшими в течение часа, указанного в URL-адресе этого объекта (например, h=12). В течение заданного часа события добавляются в файл PT1H.json по мере возникновения. Значение минуты (m=00) всегда равно 00, так как события журнала диагностики разбиваются на отдельные большие двоичные объекты каждый час.

В файле PT1H.json каждое событие сохраняется в массиве records в следующем формате:

```
{
    "records": [
        {
            "time": "2016-07-01T00:00:37.2040000Z",
            "systemId": "46cdbb41-cb9c-4f3d-a5b4-1d458d827ff1",
            "category": "NetworkSecurityGroupRuleCounter",
            "resourceId": "/SUBSCRIPTIONS/s1id1234-5679-0123-4567-890123456789/RESOURCEGROUPS/TESTRESOURCEGROUP/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/TESTNSG",
            "operationName": "NetworkSecurityGroupCounters",
            "properties": {
                "vnetResourceGuid": "{12345678-9012-3456-7890-123456789012}",
                "subnetPrefix": "10.3.0.0/24",
                "macAddress": "000123456789",
                "ruleName": "/subscriptions/ s1id1234-5679-0123-4567-890123456789/resourceGroups/testresourcegroup/providers/Microsoft.Network/networkSecurityGroups/testnsg/securityRules/default-allow-rdp",
                "direction": "In",
                "type": "allow",
                "matchedConnections": 1988
            }
        }
    ]
}
```

| Имя элемента | Описание |
| --- | --- |
| Twitter в режиме реального |Метка времени, когда служба Azure создала событие при обработке соответствующего этому событию запроса. |
| ResourceId |Идентификатор ресурса для затронутого ресурса. |
| operationName |Имя операции. |
| category |Категория журналов для события. |
| properties |Набор пар `<Key, Value>` (например, Dictionary) c подробным описанием события. |

> [!NOTE]
> Свойства и их использование зависят от ресурса.
> 
> 

## <a name="next-steps"></a>Дальнейшие действия
* [Скачивание больших двоичных объектов для анализа](../storage/storage-dotnet-how-to-use-blobs.md)
* [Потоковая передача журналов диагностики Azure в пространство имен концентраторов событий](monitoring-stream-diagnostic-logs-to-event-hubs.md)
* [Сбор и использование данных журнала из ресурсов Azure](monitoring-overview-of-diagnostic-logs.md)

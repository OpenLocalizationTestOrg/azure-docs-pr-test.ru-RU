---
title: "Рекомендации по автомасштабированию | Документы Майкрософт"
description: "Шаблоны автоматического масштабирования в веб-приложениях службы приложений Azure, масштабируемых наборах виртуальных машин и облачных службах"
author: anirudhcavale
manager: orenr
editor: 
services: monitoring-and-diagnostics
documentationcenter: monitoring-and-diagnostics
ms.assetid: 9fa2b94b-dfa5-4106-96ff-74fd1fba4657
ms.service: monitoring-and-diagnostics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/07/2017
ms.author: ancav
ms.openlocfilehash: 54dad831287376db7fb2dc46e4591be1499dc072
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="best-practices-for-autoscale"></a><span data-ttu-id="50af5-103">Рекомендации по автомасштабированию</span><span class="sxs-lookup"><span data-stu-id="50af5-103">Best practices for Autoscale</span></span>
<span data-ttu-id="50af5-104">В этой статье даны рекомендации по автомасштабированию в Azure.</span><span class="sxs-lookup"><span data-stu-id="50af5-104">This article teaches best practices to autoscale in Azure.</span></span> <span data-ttu-id="50af5-105">Автомасштабирование Azure Monitor используется только с [масштабируемыми наборами виртуальных машин](https://azure.microsoft.com/services/virtual-machine-scale-sets/), [облачными службами](https://azure.microsoft.com/services/cloud-services/) и [веб-приложениями службы приложений](https://azure.microsoft.com/services/app-service/web/).</span><span class="sxs-lookup"><span data-stu-id="50af5-105">Azure Monitor autoscale applies only to [Virtual Machine Scale Sets](https://azure.microsoft.com/services/virtual-machine-scale-sets/), [Cloud Services](https://azure.microsoft.com/services/cloud-services/), and [App Service - Web Apps](https://azure.microsoft.com/services/app-service/web/).</span></span> <span data-ttu-id="50af5-106">Прочие службы Azure используют другие методы масштабирования.</span><span class="sxs-lookup"><span data-stu-id="50af5-106">Other Azure services use different scaling methods.</span></span>

## <a name="autoscale-concepts"></a><span data-ttu-id="50af5-107">Основные понятия автомасштабирования</span><span class="sxs-lookup"><span data-stu-id="50af5-107">Autoscale concepts</span></span>
* <span data-ttu-id="50af5-108">У ресурса может быть только *один* параметр автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="50af5-108">A resource can have only *one* autoscale setting</span></span>
* <span data-ttu-id="50af5-109">У параметра автомасштабирования может быть один или несколько профилей, и каждый профиль может содержать одно или несколько правил автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="50af5-109">An autoscale setting can have one or more profiles and each profile can have one or more autoscale rules.</span></span>
* <span data-ttu-id="50af5-110">Параметр автомасштабирования обеспечивает горизонтальное масштабирование экземпляров, то есть *развертывает* их, увеличивая количество экземпляров, или *свертывает*, уменьшая их количество.</span><span class="sxs-lookup"><span data-stu-id="50af5-110">An autoscale setting scales instances horizontally, which is *out* by increasing the instances and *in* by decreasing the number of instances.</span></span>
  <span data-ttu-id="50af5-111">Параметр автомасштабирования определяет максимальное, минимальное и используемое по умолчанию число экземпляров.</span><span class="sxs-lookup"><span data-stu-id="50af5-111">An autoscale setting has a maximum, minimum, and default value of instances.</span></span>
* <span data-ttu-id="50af5-112">Задание автомасштабирования всегда считывает связанную метрику для масштабирования по ней, проверяя, превышено ли пороговое значение для развертывания или свертывания.</span><span class="sxs-lookup"><span data-stu-id="50af5-112">An autoscale job always reads the associated metric to scale by, checking if it has crossed the configured threshold for scale-out or scale-in.</span></span> <span data-ttu-id="50af5-113">Список метрик для автомасштабирования можно просмотреть в статье, посвященной [общим метрикам автомасштабирования Azure Monitor](insights-autoscale-common-metrics.md).</span><span class="sxs-lookup"><span data-stu-id="50af5-113">You can view a list of metrics that autoscale can scale by at [Azure Monitor autoscaling common metrics](insights-autoscale-common-metrics.md).</span></span>
* <span data-ttu-id="50af5-114">Все пороговые значения вычисляются на уровне экземпляров.</span><span class="sxs-lookup"><span data-stu-id="50af5-114">All thresholds are calculated at an instance level.</span></span> <span data-ttu-id="50af5-115">Например, инструкция "развернуть еще один экземпляр, если средняя загрузка ЦП > 80 % и количество экземпляров равно 2" означает, что развертывание выполняется, когда средняя загрузка ЦП во всех экземплярах превышает 80 %.</span><span class="sxs-lookup"><span data-stu-id="50af5-115">For example, "scale out by 1 instance when average CPU > 80% when instance count is 2", means scale-out when the average CPU across all instances is greater than 80%.</span></span>
* <span data-ttu-id="50af5-116">Уведомления о сбоях всегда приходят по электронной почте.</span><span class="sxs-lookup"><span data-stu-id="50af5-116">You always receive failure notifications via email.</span></span> <span data-ttu-id="50af5-117">В частности, их получают владелец, участник и читатели электронной почты целевого ресурса.</span><span class="sxs-lookup"><span data-stu-id="50af5-117">Specifically, the owner, contributor, and readers of the target resource receive email.</span></span> <span data-ttu-id="50af5-118">Кроме того, вы всегда получаете сообщение о *восстановлении*, когда работа службы автомасштабирования восстанавливается после сбоя и она начинает нормально функционировать.</span><span class="sxs-lookup"><span data-stu-id="50af5-118">You also always receive a *recovery* email when autoscale recovers from a failure and starts functioning normally.</span></span>
* <span data-ttu-id="50af5-119">Вы может согласиться на получение уведомлений об успешных операциях масштабирования по электронной почте и через веб-перехватчики.</span><span class="sxs-lookup"><span data-stu-id="50af5-119">You can opt-in to receive a successful scale action notification via email and webhooks.</span></span>

## <a name="autoscale-best-practices"></a><span data-ttu-id="50af5-120">Рекомендации по автомасштабированию</span><span class="sxs-lookup"><span data-stu-id="50af5-120">Autoscale best practices</span></span>
<span data-ttu-id="50af5-121">Используйте следующие рекомендации для автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="50af5-121">Use the following best practices as you use autoscale.</span></span>

### <a name="ensure-the-maximum-and-minimum-values-are-different-and-have-an-adequate-margin-between-them"></a><span data-ttu-id="50af5-122">Обязательно используйте разные минимальное и максимальное значения с соответствующим интервалом между ними</span><span class="sxs-lookup"><span data-stu-id="50af5-122">Ensure the maximum and minimum values are different and have an adequate margin between them</span></span>
<span data-ttu-id="50af5-123">Если у вас есть параметр, у которого максимальное и минимальное значения равны 2, и текущее количество экземпляров равно 2, масштабирование будет невозможно.</span><span class="sxs-lookup"><span data-stu-id="50af5-123">If you have a setting that has minimum=2, maximum=2 and the current instance count is 2, no scale action can occur.</span></span> <span data-ttu-id="50af5-124">Обеспечьте достаточный интервал между минимальным и максимальным количеством экземпляров, включая их предельное количество.</span><span class="sxs-lookup"><span data-stu-id="50af5-124">Keep an adequate margin between the maximum and minimum instance counts, which are inclusive.</span></span> <span data-ttu-id="50af5-125">Служба автомасштабирования всегда масштабирует экземпляры в этих границах.</span><span class="sxs-lookup"><span data-stu-id="50af5-125">Autoscale always scales between these limits.</span></span>

### <a name="manual-scaling-is-reset-by-autoscale-min-and-max"></a><span data-ttu-id="50af5-126">Параметры масштабирования вручную будут сброшены заданными для автомасштабирования минимальным и максимальным значениями.</span><span class="sxs-lookup"><span data-stu-id="50af5-126">Manual scaling is reset by autoscale min and max</span></span>
<span data-ttu-id="50af5-127">Если вы вручную обновляете количество экземпляров и устанавливаете значение, которое превышает или не превышает максимальное, параметр автомасштабирования автоматически масштабирует значение до минимального (если оно было меньше) или до максимального (если оно было больше).</span><span class="sxs-lookup"><span data-stu-id="50af5-127">If you manually update the instance count to a value above or below the maximum, the autoscale engine automatically scales back to the minimum (if below) or the maximum (if above).</span></span> <span data-ttu-id="50af5-128">Например, вы задаете диапазон от 3 до 6.</span><span class="sxs-lookup"><span data-stu-id="50af5-128">For example, you set the range between 3 and 6.</span></span> <span data-ttu-id="50af5-129">При наличии одного запущенного экземпляра при следующем запуске параметр автомасштабирования развернет количество экземпляров до 3 .</span><span class="sxs-lookup"><span data-stu-id="50af5-129">If you have one running instance, the autoscale engine scales to 3 instances on its next run.</span></span> <span data-ttu-id="50af5-130">Точно так же он свернет заданное количество с 8 до 6 при следующем запуске.</span><span class="sxs-lookup"><span data-stu-id="50af5-130">Likewise, it would scale-in 8 instances back to 6 on its next run.</span></span>  <span data-ttu-id="50af5-131">Масштабирование вручную — очень временное, если только не сбросить также правила автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="50af5-131">Manual scaling is very temporary unless you reset the autoscale rules as well.</span></span>

### <a name="always-use-a-scale-out-and-scale-in-rule-combination-that-performs-an-increase-and-decrease"></a><span data-ttu-id="50af5-132">Всегда используйте сочетание правил развертывания и свертывания, которые обеспечивают увеличение и уменьшение количества экземпляров.</span><span class="sxs-lookup"><span data-stu-id="50af5-132">Always use a scale-out and scale-in rule combination that performs an increase and decrease</span></span>
<span data-ttu-id="50af5-133">Если использовать только одну часть сочетания, то служба автомасштабирования будет свертывать (или развертывать) экземпляры, пока не достигнет максимального (или минимального) количества.</span><span class="sxs-lookup"><span data-stu-id="50af5-133">If you use only one part of the combination, autoscale scale-in that single out, or in, until the maximum, or minimum, is reached.</span></span>

### <a name="do-not-switch-between-the-azure-portal-and-the-azure-classic-portal-when-managing-autoscale"></a><span data-ttu-id="50af5-134">Не переключайтесь между порталом Azure и классическим порталом Azure при управлении автомасштабированием</span><span class="sxs-lookup"><span data-stu-id="50af5-134">Do not switch between the Azure portal and the Azure classic portal when managing Autoscale</span></span>
<span data-ttu-id="50af5-135">Для облачных служб и служб приложений (веб-приложений) используйте портал Azure (portal.azure.com), чтобы создавать параметры автомасштабирования и управлять ими.</span><span class="sxs-lookup"><span data-stu-id="50af5-135">For Cloud Services and App Services (Web Apps), use the Azure portal (portal.azure.com) to create and manage autoscale settings.</span></span> <span data-ttu-id="50af5-136">Для масштабируемых наборов виртуальных машин используйте PowerShell, интерфейс командной строки или REST API, чтобы создавать параметры автомасштабирования и управлять ими.</span><span class="sxs-lookup"><span data-stu-id="50af5-136">For Virtual Machine Scale Sets use PowerShell, CLI or REST API to create and manage autoscale setting.</span></span> <span data-ttu-id="50af5-137">Не переключайтесь между классическим порталом Azure (manage.windowsazure.com) и порталом Azure (portal.azure.com) при управлении конфигурациями автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="50af5-137">Do not switch between the Azure classic portal (manage.windowsazure.com) and the Azure portal (portal.azure.com) when managing autoscale configurations.</span></span> <span data-ttu-id="50af5-138">У классического портала Azure и его серверной базы есть ограничения.</span><span class="sxs-lookup"><span data-stu-id="50af5-138">The Azure classic portal and its underlying backend has limitations.</span></span> <span data-ttu-id="50af5-139">Перейдите на портал Azure, чтобы управлять автомасштабированием с помощью графического пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="50af5-139">Move to the Azure portal to manage autoscale using a graphical user interface.</span></span> <span data-ttu-id="50af5-140">Вы можете использовать автомасштабирование с помощью PowerShell, интерфейса командной строки или REST API (через обозреватель ресурсов Azure).</span><span class="sxs-lookup"><span data-stu-id="50af5-140">The options are to use the autoscale PowerShell, CLI or REST API (via Azure Resource Explorer).</span></span>

### <a name="choose-the-appropriate-statistic-for-your-diagnostics-metric"></a><span data-ttu-id="50af5-141">Выберите соответствующий статистический показатель для диагностической метрики</span><span class="sxs-lookup"><span data-stu-id="50af5-141">Choose the appropriate statistic for your diagnostics metric</span></span>
<span data-ttu-id="50af5-142">Для диагностических метрик можно выбрать одно из следующих опорных значений для масштабирования: *Средний*, *Минимальный*, *Максимальный* и *Общий*.</span><span class="sxs-lookup"><span data-stu-id="50af5-142">For diagnostics metrics, you can choose among *Average*, *Minimum*, *Maximum* and *Total* as a metric to scale by.</span></span> <span data-ttu-id="50af5-143">Наиболее распространенные статистический показатель — *Средний*.</span><span class="sxs-lookup"><span data-stu-id="50af5-143">The most common statistic is *Average*.</span></span>

### <a name="choose-the-thresholds-carefully-for-all-metric-types"></a><span data-ttu-id="50af5-144">Внимательно выберите пороговые значения для всех типов метрик</span><span class="sxs-lookup"><span data-stu-id="50af5-144">Choose the thresholds carefully for all metric types</span></span>
<span data-ttu-id="50af5-145">Рекомендуется тщательно выбирать различные пороговые значения для развертывания и свертывания в зависимости от практических ситуаций.</span><span class="sxs-lookup"><span data-stu-id="50af5-145">We recommend carefully choosing different thresholds for scale-out and scale-in based on practical situations.</span></span>

<span data-ttu-id="50af5-146">Мы *не рекомендуем* приведенные ниже примеры автомасштабирования с одинаковыми или достаточно близкими пороговыми значениями в условиях разворачивания и сворачивания.</span><span class="sxs-lookup"><span data-stu-id="50af5-146">We *do not recommend* autoscale settings like the examples below with the same or very similar threshold values for out and in conditions:</span></span>

* <span data-ttu-id="50af5-147">Увеличение числа экземпляров на 1, если число потоков ≤ 600</span><span class="sxs-lookup"><span data-stu-id="50af5-147">Increase instances by 1 count when Thread Count <= 600</span></span>
* <span data-ttu-id="50af5-148">Уменьшение числа экземпляров на 1, если число потоков ≥ 600</span><span class="sxs-lookup"><span data-stu-id="50af5-148">Decrease instances by 1 count when Thread Count >= 600</span></span>

<span data-ttu-id="50af5-149">Рассмотрим пример того, что может привести к противоречивому поведению.</span><span class="sxs-lookup"><span data-stu-id="50af5-149">Let's look at an example of what can lead to a behavior that may seem confusing.</span></span> <span data-ttu-id="50af5-150">Рассмотрим следующую последовательность.</span><span class="sxs-lookup"><span data-stu-id="50af5-150">Consider the following sequence.</span></span>

1. <span data-ttu-id="50af5-151">Предположим, что сначала было два экземпляра, и затем среднее число потоков на один экземпляр увеличилось до 625.</span><span class="sxs-lookup"><span data-stu-id="50af5-151">Assume there are 2 instances to begin with and then the average number of threads per instance grows to 625.</span></span>
2. <span data-ttu-id="50af5-152">Служба автомасштабирования разворачивает третий экземпляр.</span><span class="sxs-lookup"><span data-stu-id="50af5-152">Autoscale scales out adding a 3rd instance.</span></span>
3. <span data-ttu-id="50af5-153">Затем предположим, что среднее число потоков на экземпляр уменьшилось до 575.</span><span class="sxs-lookup"><span data-stu-id="50af5-153">Next, assume that the average thread count across instance falls to 575.</span></span>
4. <span data-ttu-id="50af5-154">Перед уменьшением масштаба служба автомасштабирования пытается оценить, какое конечное состояние будет после сворачивания.</span><span class="sxs-lookup"><span data-stu-id="50af5-154">Before scaling down, autoscale tries to estimate what the final state will be if it scaled in.</span></span> <span data-ttu-id="50af5-155">Например, 575 x 3 (текущее количество экземпляров) = 1725 / 2 (итоговое количество экземпляров после уменьшения масштаба) = 862,5 потока.</span><span class="sxs-lookup"><span data-stu-id="50af5-155">For example, 575 x  3 (current instance count) = 1,725 / 2 (final number of instances when scaled down) = 862.5 threads.</span></span> <span data-ttu-id="50af5-156">Это означает, что если среднее количество потоков не меняется или даже немного уменьшается, службе автомасштабирования сразу после свертывания придется опять развертывать новый экземпляр.</span><span class="sxs-lookup"><span data-stu-id="50af5-156">This means autoscale would have to immediately scale-out again even after it scaled in, if the average thread count remains the same or even falls only a small amount.</span></span> <span data-ttu-id="50af5-157">Однако после повторного разворачивания весь опять процесс повторится, что приведет к бесконечному циклу.</span><span class="sxs-lookup"><span data-stu-id="50af5-157">However, if it scaled up again, the whole process would repeat, leading to an infinite loop.</span></span>
5. <span data-ttu-id="50af5-158">Чтобы избежать такой нестабильности, параметр автомасштабирования вообще не уменьшает масштаб.</span><span class="sxs-lookup"><span data-stu-id="50af5-158">To avoid this situation (termed "flapping"), autoscale does not scale down at all.</span></span> <span data-ttu-id="50af5-159">Вместо этого она пропускает, а затем повторно оценивает условие при следующем выполнении задания службы.</span><span class="sxs-lookup"><span data-stu-id="50af5-159">Instead, it skips and reevaluates the condition again the next time the service's job executes.</span></span> <span data-ttu-id="50af5-160">Это многих может сбить с толку, ведь все выглядело так, будто автомасштабирование не работало, когда среднее число потоков было равно 575.</span><span class="sxs-lookup"><span data-stu-id="50af5-160">This could confuse many people because autoscale wouldn't appear to work when the average thread count was 575.</span></span>

<span data-ttu-id="50af5-161">Оценка во время свертывания направлена на то, чтобы избежать нестабильности, при которой действия свертывания и развертывания постоянно колеблются.</span><span class="sxs-lookup"><span data-stu-id="50af5-161">Estimation during a scale-in is intended to avoid "flapping" situations, where scale-in and scale-out actions continually go back and forth.</span></span> <span data-ttu-id="50af5-162">Следует помнить об этом механизме, выбирая одинаковые пороговые значения для развертывания и свертывания.</span><span class="sxs-lookup"><span data-stu-id="50af5-162">Keep this behavior in mind when you choose the same thresholds for scale-out and in.</span></span>

<span data-ttu-id="50af5-163">Рекомендуется выбирать достаточный интервал между пороговыми значениями для развертывания и свертывания.</span><span class="sxs-lookup"><span data-stu-id="50af5-163">We recommend choosing an adequate margin between the scale-out and in thresholds.</span></span> <span data-ttu-id="50af5-164">Например, рассмотрим более удачное сочетание правил.</span><span class="sxs-lookup"><span data-stu-id="50af5-164">As an example, consider the following better rule combination.</span></span>

* <span data-ttu-id="50af5-165">Увеличивать количество экземпляров на 1, если загрузка ЦП ≥ 80.</span><span class="sxs-lookup"><span data-stu-id="50af5-165">Increase instances by 1 count when CPU%  >= 80</span></span>
* <span data-ttu-id="50af5-166">Уменьшение числа экземпляров на 1, если загрузка ЦП ≤ 60</span><span class="sxs-lookup"><span data-stu-id="50af5-166">Decrease instances by 1 count when CPU% <= 60</span></span>

<span data-ttu-id="50af5-167">В данном случае:</span><span class="sxs-lookup"><span data-stu-id="50af5-167">In this case</span></span>  

1. <span data-ttu-id="50af5-168">Предположим, что с самого начала существуют два экземпляра.</span><span class="sxs-lookup"><span data-stu-id="50af5-168">Assume there are 2 instances to start with.</span></span>
2. <span data-ttu-id="50af5-169">Если средняя загрузка ЦП во всех экземплярах достигает 80 %, то служба автомасштабирования добавляет третий экземпляр.</span><span class="sxs-lookup"><span data-stu-id="50af5-169">If the average CPU% across instances goes to 80, autoscale scales out adding a third instance.</span></span>
3. <span data-ttu-id="50af5-170">Теперь предположим, что со временем загрузка ЦП снижается до 60 %.</span><span class="sxs-lookup"><span data-stu-id="50af5-170">Now assume that over time the CPU% falls to 60.</span></span>
4. <span data-ttu-id="50af5-171">Правило свертывания службы автомасштабирования оценивает конечное состояние, которое будет после свертывания.</span><span class="sxs-lookup"><span data-stu-id="50af5-171">Autoscale's scale-in rule estimates the final state if it were to scale-in.</span></span> <span data-ttu-id="50af5-172">Например, 60 x 3 (текущее число экземпляров) = 180 / 2 (итоговое число экземпляров после уменьшения масштаба) = 90.</span><span class="sxs-lookup"><span data-stu-id="50af5-172">For example, 60 x 3 (current instance count) = 180 / 2 (final number of instances when scaled down) = 90.</span></span> <span data-ttu-id="50af5-173">Поэтому служба автомасштабирования не свертывает экземпляр, так как после этого ей пришлось бы тут же развернуть его.</span><span class="sxs-lookup"><span data-stu-id="50af5-173">So autoscale does not scale-in because it would have to scale-out again immediately.</span></span> <span data-ttu-id="50af5-174">Вместо этого она пропускает уменьшение масштаба.</span><span class="sxs-lookup"><span data-stu-id="50af5-174">Instead, it skips scaling down.</span></span>
5. <span data-ttu-id="50af5-175">При следующей проверке автомасштабирования нагрузка ЦП продолжает снижаться до 50.</span><span class="sxs-lookup"><span data-stu-id="50af5-175">The next time autoscale checks, the CPU continues to fall to 50.</span></span> <span data-ttu-id="50af5-176">Служба снова оценивает ее: 50 х 3 экземпляра = 150 / 2 экземпляра = 75. Это значение меньше порогового значения развертывания, равного 80, поэтому служба успешно свертывает масштабирование до 2 экземпляров.</span><span class="sxs-lookup"><span data-stu-id="50af5-176">It estimates again -  50 x 3 instance = 150 / 2 instances = 75, which is below the scale-out threshold of 80, so it scales in successfully to 2 instances.</span></span>

### <a name="considerations-for-scaling-threshold-values-for-special-metrics"></a><span data-ttu-id="50af5-177">Рекомендации по пороговым значениям масштабирования для специальных метрик</span><span class="sxs-lookup"><span data-stu-id="50af5-177">Considerations for scaling threshold values for special metrics</span></span>
 <span data-ttu-id="50af5-178">Для специальных метрик, таких как метрика длины очереди хранилища или длины очереди служебной шины, пороговое значение — это среднее число сообщений, доступных для текущего числа экземпляров.</span><span class="sxs-lookup"><span data-stu-id="50af5-178">For special metrics such as Storage or Service Bus Queue length metric, the threshold is the average number of messages available per current number of instances.</span></span> <span data-ttu-id="50af5-179">Тщательно выбирайте пороговое значение этой метрики.</span><span class="sxs-lookup"><span data-stu-id="50af5-179">Carefully choose the choose the threshold value for this metric.</span></span>

<span data-ttu-id="50af5-180">Проиллюстрируем пример, чтобы вы лучше поняли, как это работает.</span><span class="sxs-lookup"><span data-stu-id="50af5-180">Let's illustrate it with an example to ensure you understand the behavior better.</span></span>

* <span data-ttu-id="50af5-181">Увеличение числа экземпляров на 1, когда число сообщений в очереди хранилища ≥ 50</span><span class="sxs-lookup"><span data-stu-id="50af5-181">Increase instances by 1 count when Storage Queue message count >= 50</span></span>
* <span data-ttu-id="50af5-182">Уменьшение числа экземпляров на 1, когда число сообщений в очереди хранилища ≤ 10</span><span class="sxs-lookup"><span data-stu-id="50af5-182">Decrease instances by 1 count when Storage Queue message count <= 10</span></span>

<span data-ttu-id="50af5-183">Рассмотрим следующую последовательность:</span><span class="sxs-lookup"><span data-stu-id="50af5-183">Consider the following sequence:</span></span>

1. <span data-ttu-id="50af5-184">Существует 2 экземпляра очереди хранилища.</span><span class="sxs-lookup"><span data-stu-id="50af5-184">There are 2 storage queue instances.</span></span>
2. <span data-ttu-id="50af5-185">Сообщения продолжают поступать, и когда вы просматриваете очередь хранилища, их общее количество достигает 50.</span><span class="sxs-lookup"><span data-stu-id="50af5-185">Messages keep coming and when you review the storage queue, the total count reads 50.</span></span> <span data-ttu-id="50af5-186">Вы можете предположить, что служба автомасштабирования должна начать развертывание.</span><span class="sxs-lookup"><span data-stu-id="50af5-186">You might assume that autoscale should start a scale-out action.</span></span> <span data-ttu-id="50af5-187">Однако обратите внимание, что число сообщений для каждого экземпляра по-прежнему 50 / 2 = 25.</span><span class="sxs-lookup"><span data-stu-id="50af5-187">However, note that it is still 50/2 = 25 messages per instance.</span></span> <span data-ttu-id="50af5-188">Поэтому развертывание не происходит.</span><span class="sxs-lookup"><span data-stu-id="50af5-188">So, scale-out does not occur.</span></span> <span data-ttu-id="50af5-189">Чтобы произошло первое развертывание, общее количество сообщений в очереди хранилища должно достичь 100.</span><span class="sxs-lookup"><span data-stu-id="50af5-189">For the first scale-out to happen, the total message count in the storage queue should be 100.</span></span>
3. <span data-ttu-id="50af5-190">Далее предположим, что общее количество сообщений достигло 100.</span><span class="sxs-lookup"><span data-stu-id="50af5-190">Next, assume that the total message count reaches 100.</span></span>
4. <span data-ttu-id="50af5-191">После развертывания добавляется третий экземпляр очереди хранилища.</span><span class="sxs-lookup"><span data-stu-id="50af5-191">A 3rd storage queue instance is added due to a scale-out action.</span></span>  <span data-ttu-id="50af5-192">Следующее развертывание не будет выполнено, пока общее количество сообщений в очереди не достигнет 150, так как 150/3 = 50.</span><span class="sxs-lookup"><span data-stu-id="50af5-192">The next scale-out action will not happen until the total message count in the queue reaches 150 because 150/3 = 50.</span></span>
5. <span data-ttu-id="50af5-193">Теперь количество сообщений в очереди уменьшится.</span><span class="sxs-lookup"><span data-stu-id="50af5-193">Now the number of messages in the queue gets smaller.</span></span> <span data-ttu-id="50af5-194">С тремя экземплярами первое свертывание происходит, когда общее количество сообщений во всех очередях достигает 30, так как 30/3 = 10 сообщений на экземпляр. А это и есть пороговое значение свертывания.</span><span class="sxs-lookup"><span data-stu-id="50af5-194">With 3 instances, the first scale-in action happens when the total messages in all queues add up to 30 because 30/3 = 10 messages per instance, which is the scale-in threshold.</span></span>

### <a name="considerations-for-scaling-when-multiple-profiles-are-configured-in-an-autoscale-setting"></a><span data-ttu-id="50af5-195">Рекомендации по масштабированию при настройке нескольких профилей в параметре автомасштабирования</span><span class="sxs-lookup"><span data-stu-id="50af5-195">Considerations for scaling when multiple profiles are configured in an autoscale setting</span></span>
<span data-ttu-id="50af5-196">В параметре автомасштабирования можно выбрать профиль по умолчанию, который применяется всегда, вне зависимости от расписания или времени. Также можно выбрать профиль повторения или профиль для фиксированного периода с диапазоном дат и времени.</span><span class="sxs-lookup"><span data-stu-id="50af5-196">In an autoscale setting, you can choose a default profile, which is always applied without any dependency on schedule or time, or you can choose a recurring profile or a profile for a fixed period with a date and time range.</span></span>

<span data-ttu-id="50af5-197">При их обработке служба автомасштабирования всегда выполняет проверку в следующем порядке:</span><span class="sxs-lookup"><span data-stu-id="50af5-197">When autoscale service processes them, it always checks in the following order:</span></span>

1. <span data-ttu-id="50af5-198">профиль с фиксированной датой;</span><span class="sxs-lookup"><span data-stu-id="50af5-198">Fixed Date profile</span></span>
2. <span data-ttu-id="50af5-199">профиль повторения;</span><span class="sxs-lookup"><span data-stu-id="50af5-199">Recurring profile</span></span>
3. <span data-ttu-id="50af5-200">профиль по умолчанию ("Всегда").</span><span class="sxs-lookup"><span data-stu-id="50af5-200">Default ("Always") profile</span></span>

<span data-ttu-id="50af5-201">Если соблюдено какое-либо условие профиля, служба автомасштабирования не проверяет следующее за ним условие профиля.</span><span class="sxs-lookup"><span data-stu-id="50af5-201">If a profile condition is met, autoscale does not check the next profile condition below it.</span></span> <span data-ttu-id="50af5-202">Служба автомасштабирования обрабатывает только один профиль за раз.</span><span class="sxs-lookup"><span data-stu-id="50af5-202">Autoscale only processes one profile at a time.</span></span> <span data-ttu-id="50af5-203">Это означает, что если требуется добавить условие обработки из профиля нижнего уровня, то необходимо включить соответствующие правила в текущий профиль.</span><span class="sxs-lookup"><span data-stu-id="50af5-203">This means if you want to also include a processing condition from a lower-tier profile, you must include those rules as well in the current profile.</span></span>

<span data-ttu-id="50af5-204">Рассмотрим это на примере.</span><span class="sxs-lookup"><span data-stu-id="50af5-204">Let's review this using an example:</span></span>

<span data-ttu-id="50af5-205">На следующем рисунке показан параметр автомасштабирования с профилем по умолчанию с минимальным числом экземпляров, равным 2, и максимальным числом экземпляров, равным 10.</span><span class="sxs-lookup"><span data-stu-id="50af5-205">The image below shows an autoscale setting with a default profile of minimum instances = 2 and maximum instances = 10.</span></span> <span data-ttu-id="50af5-206">В этом примере настроены правила для развертывания в случае, когда количество сообщений в очереди превышает 10, и свертывания, когда это количество меньше 3.</span><span class="sxs-lookup"><span data-stu-id="50af5-206">In this example, rules are configured to scale-out when the message count in the queue is greater than 10 and scale-in when the message count in the queue is less than 3.</span></span> <span data-ttu-id="50af5-207">Итак, теперь ресурс может масштабироваться в пределах 2–10 экземпляров.</span><span class="sxs-lookup"><span data-stu-id="50af5-207">So now the resource can scale between 2 and 10 instances.</span></span>

<span data-ttu-id="50af5-208">Кроме того, имеется профиль повторения, настроенный на "Понедельник".</span><span class="sxs-lookup"><span data-stu-id="50af5-208">In addition, there is a recurring profile set for Monday.</span></span> <span data-ttu-id="50af5-209">В нем задано минимальное число экземпляров, равное 2, и максимальное число экземпляров, равное 12.</span><span class="sxs-lookup"><span data-stu-id="50af5-209">It is set for minimum instances = 2 and maximum instances = 12.</span></span> <span data-ttu-id="50af5-210">Это означает, что в понедельник, когда служба автомасштабирования впервые проверит это условие при количестве экземпляров 2, она масштабирует их до нового минимального значения, т. е. до 3.</span><span class="sxs-lookup"><span data-stu-id="50af5-210">This means on Monday, the first time autoscale checks for this condition, if the instance count is 2, it scales to the new minimum of 3.</span></span> <span data-ttu-id="50af5-211">Пока служба автомасштабирования продолжает считать, что это условие профиля соблюдено (для понедельника), она обрабатывает только настроенные для этого профиля правила развертывания и свертывания на основе использования ресурсов ЦП.</span><span class="sxs-lookup"><span data-stu-id="50af5-211">As long as autoscale continues to find this profile condition matched (Monday), it only processes the CPU-based scale-out/in rules configured for this profile.</span></span> <span data-ttu-id="50af5-212">На данный момент она не проверяет длину очереди.</span><span class="sxs-lookup"><span data-stu-id="50af5-212">At this time, it does not check for the queue length.</span></span> <span data-ttu-id="50af5-213">Тем не менее, если также требуется проверять условие длины очереди, необходимо добавить эти правила из профиля по умолчанию в профиль для понедельника.</span><span class="sxs-lookup"><span data-stu-id="50af5-213">However, if you also want the queue length condition to be checked, you should include those rules from the default profile as well in your Monday profile.</span></span>

<span data-ttu-id="50af5-214">Аналогичным образом, когда служба автомасштабирования переключится обратно на профиль по умолчанию, сначала она проверит, соблюдены ли условия минимального и максимального количества экземпляров.</span><span class="sxs-lookup"><span data-stu-id="50af5-214">Similarly, when autoscale switches back to the default profile, it first checks if the minimum and maximum conditions are met.</span></span> <span data-ttu-id="50af5-215">Если на тот момент число экземпляров будет равно 12, служба свернет два из них, оставив 10, т. е. максимальное число для профиля по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="50af5-215">If the number of instances at the time is 12, it scales in to 10, the maximum allowed for the default profile.</span></span>

![Параметры автомасштабирования](./media/insights-autoscale-best-practices/insights-autoscale-best-practices-2.png)

### <a name="considerations-for-scaling-when-multiple-rules-are-configured-in-a-profile"></a><span data-ttu-id="50af5-217">Рекомендации по масштабированию при настройке нескольких правил в профиле</span><span class="sxs-lookup"><span data-stu-id="50af5-217">Considerations for scaling when multiple rules are configured in a profile</span></span>
<span data-ttu-id="50af5-218">Бывают случаи, когда требуется задать несколько правил в профиле.</span><span class="sxs-lookup"><span data-stu-id="50af5-218">There are cases where you may have to set multiple rules in a profile.</span></span> <span data-ttu-id="50af5-219">Ниже приведен набор правил автомасштабирования, используемых при настройке нескольких правил.</span><span class="sxs-lookup"><span data-stu-id="50af5-219">The following set of autoscale rules are used by services use when multiple rules are set.</span></span>

<span data-ttu-id="50af5-220">Для запуска *развертывания* службе автомасштабирования достаточно, чтобы выполнялось любое из правил.</span><span class="sxs-lookup"><span data-stu-id="50af5-220">On *scale out*, autoscale runs if any rule is met.</span></span>
<span data-ttu-id="50af5-221">Для запуска *свертывания* службе автомасштабирования требуется, чтобы выполнялись все правила.</span><span class="sxs-lookup"><span data-stu-id="50af5-221">On *scale-in*, autoscale require all rules to be met.</span></span>

<span data-ttu-id="50af5-222">Чтобы проиллюстрировать это, предположим, что заданы следующие 4 правила автомасштабирования:</span><span class="sxs-lookup"><span data-stu-id="50af5-222">To illustrate, assume that you have the following 4 autoscale rules:</span></span>

* <span data-ttu-id="50af5-223">если загрузка ЦП < 30 %, свернуть 1 экземпляр;</span><span class="sxs-lookup"><span data-stu-id="50af5-223">If CPU < 30 %, scale-in by 1</span></span>
* <span data-ttu-id="50af5-224">если объем используемой памяти < 50 %, свернуть 1 экземпляр;</span><span class="sxs-lookup"><span data-stu-id="50af5-224">If Memory < 50%, scale-in by 1</span></span>
* <span data-ttu-id="50af5-225">если загрузка ЦП > 75 %, развернуть 1 экземпляр;</span><span class="sxs-lookup"><span data-stu-id="50af5-225">If CPU > 75%, scale-out by 1</span></span>
* <span data-ttu-id="50af5-226">если объем используемой памяти > 75 %, развернуть 1 экземпляр.</span><span class="sxs-lookup"><span data-stu-id="50af5-226">If Memory > 75%, scale-out by 1</span></span>

<span data-ttu-id="50af5-227">Затем происходит следующее.</span><span class="sxs-lookup"><span data-stu-id="50af5-227">Then the follow occurs:</span></span>

* <span data-ttu-id="50af5-228">Если ресурсы ЦП загружены на 76 % и занято 50 % памяти, будет выполнено развертывание.</span><span class="sxs-lookup"><span data-stu-id="50af5-228">If CPU is 76% and Memory is 50%, we scale-out.</span></span>
* <span data-ttu-id="50af5-229">Если ресурсы ЦП загружены на 50 % и занято 76 % памяти, будет выполнено развертывание.</span><span class="sxs-lookup"><span data-stu-id="50af5-229">If CPU is 50% and Memory is 76% we scale-out.</span></span>

<span data-ttu-id="50af5-230">С другой стороны, если нагрузка ЦП составляет 25 %, а память занята на 51 %, автомасштабирование **не** выполняет развертывание.</span><span class="sxs-lookup"><span data-stu-id="50af5-230">On the other hand, if CPU is 25% and memory is 51% autoscale does **not** scale-in.</span></span> <span data-ttu-id="50af5-231">Для этого ресурсы ЦП должны быть загружены на 29 %, а память занята на 49 %.</span><span class="sxs-lookup"><span data-stu-id="50af5-231">In order to scale-in, CPU must be 29% and Memory 49%.</span></span>

### <a name="always-select-a-safe-default-instance-count"></a><span data-ttu-id="50af5-232">Всегда выбирайте безопасное число экземпляров по умолчанию</span><span class="sxs-lookup"><span data-stu-id="50af5-232">Always select a safe default instance count</span></span>
<span data-ttu-id="50af5-233">Количество экземпляров по умолчанию важно, так как оно устанавливается службой автомасштабирования, когда метрики недоступны.</span><span class="sxs-lookup"><span data-stu-id="50af5-233">The default instance count is important autoscale scales your service to that count when metrics are not available.</span></span> <span data-ttu-id="50af5-234">Поэтому выберите число экземпляров по умолчанию, являющееся безопасным для рабочих нагрузок.</span><span class="sxs-lookup"><span data-stu-id="50af5-234">Therefore, select a default instance count that's safe for your workloads.</span></span>

### <a name="configure-autoscale-notifications"></a><span data-ttu-id="50af5-235">Настройка уведомлений об автомасштабировании</span><span class="sxs-lookup"><span data-stu-id="50af5-235">Configure autoscale notifications</span></span>
<span data-ttu-id="50af5-236">Служба автомасштабирования уведомляет администраторов и участников по электронной почте при возникновении любого из следующих условий:</span><span class="sxs-lookup"><span data-stu-id="50af5-236">Autoscale notifies the administrators and contributors of the resource by email if any of the following conditions occur:</span></span>

* <span data-ttu-id="50af5-237">Службе автомасштабирования не удается выполнить действие.</span><span class="sxs-lookup"><span data-stu-id="50af5-237">autoscale service fails to take an action.</span></span>
* <span data-ttu-id="50af5-238">Службе автомасштабирования не доступны метрики для принятия решения по масштабированию.</span><span class="sxs-lookup"><span data-stu-id="50af5-238">Metrics are not available for autoscale service to make a scale decision.</span></span>
* <span data-ttu-id="50af5-239">Метрики для принятия решения по масштабированию стали доступны (восстановились).</span><span class="sxs-lookup"><span data-stu-id="50af5-239">Metrics are available (recovery) again to make a scale decision.</span></span>
  <span data-ttu-id="50af5-240">Помимо приведенных условий можно настроить уведомления по электронной почте или через веб-перехватчики, чтобы узнавать об успешных действиях масштабирования.</span><span class="sxs-lookup"><span data-stu-id="50af5-240">In addition to the conditions above, you can configure email or webhook notifications to get notified for successful scale actions.</span></span>
  
<span data-ttu-id="50af5-241">С помощью оповещений журнала действий также можно отслеживать работоспособность системы автоматического масштабирования.</span><span class="sxs-lookup"><span data-stu-id="50af5-241">You can also use an Activity Log alert to monitor the health of the autoscale engine.</span></span> <span data-ttu-id="50af5-242">Ниже приведены примеры [создания оповещения журнала действий для отслеживания всех операций системы автомасштабирования в подписке](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-alert) или [создания оповещения журнала действий для отслеживания всех неудачных операций свертывания и развертывания автомасштабирования в подписке](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-failed-alert).</span><span class="sxs-lookup"><span data-stu-id="50af5-242">Here are examples to [create an Activity Log Alert to monitor all autoscale engine operations on your subscription](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-alert) or to [create an Activity Log Alert to monitor all failed autoscale scale in/scale out operations on your subscription](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-failed-alert).</span></span>

## <a name="next-steps"></a><span data-ttu-id="50af5-243">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="50af5-243">Next Steps</span></span>
- <span data-ttu-id="50af5-244">[Создайте оповещение журнала действий, чтобы отслеживать все операции системы автомасштабирования в своей подписке](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-alert).</span><span class="sxs-lookup"><span data-stu-id="50af5-244">[Create an Activity Log Alert to monitor all autoscale engine operations on your subscription.](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-alert)</span></span>
- <span data-ttu-id="50af5-245">[Создайте оповещение журнала действий, чтобы отслеживать все ошибки автомасштабирования в своей подписке](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-failed-alert).</span><span class="sxs-lookup"><span data-stu-id="50af5-245">[Create an Activity Log Alert to monitor all failed autoscale scale in/scale out operations on your subscription](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-failed-alert)</span></span>

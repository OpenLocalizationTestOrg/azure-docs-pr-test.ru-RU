---
title: "Обзор журналов диагностики Azure | Документация Майкрософт"
description: "Узнайте, что такое журналы диагностики Azure и как их использовать для просмотра событий, происходящих в ресурсе Azure."
author: johnkemnetz
manager: orenr
editor: 
services: monitoring-and-diagnostics
documentationcenter: monitoring-and-diagnostics
ms.assetid: fe8887df-b0e6-46f8-b2c0-11994d28e44f
ms.service: monitoring-and-diagnostics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/21/2017
ms.author: johnkem; magoedte
ms.openlocfilehash: d59abde29fc7b73a799e5bf3659b02f824b693de
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="collect-and-consume-log-data-from-your-azure-resources"></a>Сбор и использование данных журнала из ресурсов Azure

## <a name="what-are-azure-resource-diagnostic-logs"></a>Что такое журналы диагностики ресурсов Azure
**Журналы диагностики уровня ресурсов Azure** генерируются ресурсом. Они содержат подробные и своевременные данные об операциях этого ресурса. Содержимое этих журналов зависит от типа ресурса. Например, счетчики правила группы безопасности сети и аудит Key Vault представляют две категории журналов ресурсов.

Журналы диагностики уровня ресурса отличаются от [журнала действий](monitoring-overview-activity-logs.md). Журнал действий содержит информацию об операциях, которые были выполнены с ресурсами в вашей подписке с помощью Resource Manager, например о создании виртуальной машины или удалении приложения логики. Журнал действий — это журнал уровня подписки. Журналы диагностики уровня ресурса дают представление об операциях, которые были выполнены в рамках этого ресурса, например о получении секрета из Key Vault.

Журналы диагностики уровня ресурса также отличаются от журналов диагностики уровня гостевой ОС. Журналы диагностики гостевой ОС собирает агент, работающий на виртуальной машине или поддерживаемом ресурсе другого типа. Для сбора журналов диагностики уровня ресурса не требуется агент. В них записываются данные ресурсов из платформы Azure, тогда как в журналы диагностики уровня гостевой ОС записываются данные из операционной системы и приложений, выполняющихся на виртуальной машине.

Не все ресурсы поддерживают описанный здесь новый тип журналов диагностики ресурсов. Эта статья содержит раздел со списком типов ресурсов, поддерживающих новые журналы диагностики уровня ресурса.

![Журналы диагностики ресурсов и другие типы журналов ](./media/monitoring-overview-of-diagnostic-logs/Diagnostics_Logs_vs_other_logs_v5.png)

## <a name="what-you-can-do-with-resource-level-diagnostic-logs"></a>Что можно делать с журналами диагностики уровня ресурса
Ниже описано несколько доступных операций с журналами диагностики ресурсов.

![Логическое размещение журналов диагностики ресурсов](./media/monitoring-overview-of-diagnostic-logs/Diagnostics_Logs_Actions.png)


* Сохранение журналов в [**учетную запись хранения**](monitoring-archive-diagnostic-logs.md) для аудита или проверки вручную. В **параметрах диагностики ресурсов** можно задать время хранения (в днях).
* [Потоковая передача журналов в **концентраторы событий**](monitoring-stream-diagnostic-logs-to-event-hubs.md) для обработки в сторонней службе или пользовательском аналитическом решении, например в PowerBI.
* Анализ журналов с помощью [OMS Log Analytics](../log-analytics/log-analytics-azure-storage.md)

Вы можете использовать учетную запись хранения или пространство имен концентраторов событий, не входящее в подписку, в которой создаются журналы. Пользователю, который настраивает этот параметр, должен быть предоставлен соответствующий уровень доступа RBAC к обеим подпискам.

## <a name="resource-diagnostic-settings"></a>Параметры диагностики ресурсов
Журналы диагностики для всех ресурсов, кроме вычислительных, настраиваются с помощью параметров диагностики ресурсов. **Параметры диагностики ресурсов** для управления ресурсами:

* Куда отправляются журналы диагностики ресурсов и метрики (учетная запись хранения, концентраторы событий и/или OMS Log Analytics).
* Какие категории журнала отправляются и следует ли отправлять данные метрики.
* Как долго должны храниться журналы каждой категории в учетной записи хранения.
    - Срок хранения 0 дней означает, что журналы хранятся неограниченно долго. В противном случае укажите количество дней в диапазоне от 1 до 2 147 483 647.
    - Если политики хранения заданы, но хранение журналов в учетной записи хранения отключено (например, выбраны только варианты концентраторов событий или OMS), политики хранения не будут применены.
    - Политики хранения применяются по дням, поэтому в конце дня (по времени в формате UTC) журналы, срок которых теперь превышает период хранения, будут удалены. Например, если настроена политика хранения в течение одного дня, то в начале текущего дня журналы за вчерашний день будет удалены.

Эти параметры легко настраиваются в параметрах диагностики для ресурса на портале Azure, а также с помощью Azure PowerShell, команд интерфейса командной строки или с помощью статьи [REST API Azure Monitor](https://msdn.microsoft.com/library/azure/dn931943.aspx).

> [!WARNING]
> В журналах диагностики и метрик с уровня гостевой ОС для вычислительных ресурсов (например, виртуальных машин или Service Fabric) доступен [отдельный механизм настройки и выбора выходных данных](../azure-diagnostics.md).
>
>

## <a name="how-to-enable-collection-of-resource-diagnostic-logs"></a>Как включить сбор журналов диагностики ресурсов
Сбор журналов диагностики ресурсов можно включить [во время создания ресурса с помощью шаблона Resource Manager](./monitoring-enable-diagnostic-logs-using-template.md) или после его создания на странице ресурса на портале. Сбор этих журналов можно также включить в любой момент с помощью Azure PowerShell, команд интерфейса командной строки или REST API Azure Monitor.

> [!TIP]
> При работе с некоторыми ресурсами эти инструкции могут требовать корректировки. Изучите связи на схеме, представленной в конце этой страницы, чтобы разобраться в дополнительных действиях, которые могут потребоваться при использовании некоторых типов ресурсов.
>
>

### <a name="enable-collection-of-resource-diagnostic-logs-in-the-portal"></a>Включение сбора журналов диагностики ресурсов на портале
Сбор журналов диагностики ресурсов на портале Azure после создания ресурса можно включить, перейдя к конкретному ресурсу или к Azure Monitor. Чтобы выполнить это с помощью Azure Monitor, сделайте следующее:

1. На [портале Azure](http://portal.azure.com) перейдите к Azure Monitor и щелкните **Параметры диагностики**

    ![Раздел мониторинга Azure Monitor](media/monitoring-overview-of-diagnostic-logs/diagnostic-settings-blade.png)

2. При необходимости отфильтруйте список по группе или типу ресурса, а затем щелкните ресурс, для которого необходимо задать параметр диагностики.

3. Если параметров для выбранного ресурса не существует, вам будет предложено создать параметр. Щелкните Turn on diagnostics (Включить диагностику).

   ![Добавление параметра диагностики — имеющиеся параметры отсутствуют](media/monitoring-overview-of-diagnostic-logs/diagnostic-settings-none.png)

   Если в ресурсе имеются параметры, для него отобразится список настроенных параметров. Нажмите Add diagnostic setting (Добавить параметр диагностики).

   ![Добавление параметра диагностики — имеющиеся параметры](media/monitoring-overview-of-diagnostic-logs/diagnostic-settings-multiple.png)

3. Задайте имя параметра, установите флажки для каждого целевого расположения, в которое необходимо отправить данные, и укажите ресурс, используемый для каждого назначения. При необходимости с помощью ползунков **Хранение (дни)** укажите продолжительность хранения этих журналов в днях (применимо только к целевому расположению учетной записи хранения). Нулевое значение означает, что журналы будут храниться неограниченно долго.
   
   ![Добавление параметра диагностики — имеющиеся параметры](media/monitoring-overview-of-diagnostic-logs/diagnostic-settings-configure.png)
    
4. Щелкните **Сохранить**.

Через несколько секунд появится новый параметр в списке параметров для данного ресурса, и сразу же после создания данных о событии журналы диагностики отправятся по указанным назначениям.

### <a name="enable-collection-of-resource-diagnostic-logs-via-powershell"></a>Включение сбора журналов диагностики ресурсов с помощью PowerShell
Чтобы включить сбор журналов диагностики ресурсов с помощью Azure PowerShell, используйте следующие команды.

Выполните приведенную ниже команду, чтобы включить отправку журналов диагностики в учетную запись хранения.

```powershell
Set-AzureRmDiagnosticSetting -ResourceId [your resource id] -StorageAccountId [your storage account id] -Enabled $true
```

StorageAccountId — это идентификатор ресурса учетной записи хранения, в которую будут отправляться журналы.

Чтобы включить потоковую передачу журналов диагностики в концентратор событий, используйте следующую команду.

```powershell
Set-AzureRmDiagnosticSetting -ResourceId [your resource id] -ServiceBusRuleId [your Service Bus rule id] -Enabled $true
```

ServiceBusRuleID — это строка в формате `{Service Bus resource ID}/authorizationrules/{key name}`.

Чтобы включить отправку журналов диагностики в рабочую область Log Analytics, используйте следующую команду.

```powershell
Set-AzureRmDiagnosticSetting -ResourceId [your resource id] -WorkspaceId [resource id of the log analytics workspace] -Enabled $true
```

Идентификатор ресурса рабочей области Log Analytics можно получить с помощью следующей команды.

```powershell
(Get-AzureRmOperationalInsightsWorkspace).ResourceId
```

Можно объединять эти параметры, чтобы получить несколько вариантов вывода.

### <a name="enable-collection-of-resource-diagnostic-logs-via-cli"></a>Включение сбора журналов диагностики ресурсов с помощью интерфейса командной строки
Чтобы включить сбор журналов диагностики ресурсов с помощью Azure CLI, используйте следующие команды.

Выполните приведенную ниже команду, чтобы включить отправку журналов диагностики в учетную запись хранения.

```azurecli
azure insights diagnostic set --resourceId <resourceId> --storageId <storageAccountId> --enabled true
```

StorageAccountId — это идентификатор ресурса учетной записи хранения, в которую будут отправляться журналы.

Чтобы включить потоковую передачу журналов диагностики в концентратор событий, используйте следующую команду.

```azurecli
azure insights diagnostic set --resourceId <resourceId> --serviceBusRuleId <serviceBusRuleId> --enabled true
```

ServiceBusRuleID — это строка в формате `{Service Bus resource ID}/authorizationrules/{key name}`.

Чтобы включить отправку журналов диагностики в рабочую область Log Analytics, используйте следующую команду.

```azurecli
azure insights diagnostic set --resourceId <resourceId> --workspaceId <resource id of the log analytics workspace> --enabled true
```

Можно объединять эти параметры, чтобы получить несколько вариантов вывода.

### <a name="enable-collection-of-resource-diagnostic-logs-via-rest-api"></a>Включение сбора журналов диагностики ресурсов с помощью REST API
Изменение параметров диагностики с помощью REST API Azure Monitor описано в [этом документе](https://msdn.microsoft.com/library/azure/dn931931.aspx).

## <a name="manage-resource-diagnostic-settings-in-the-portal"></a>Управление параметрами диагностики ресурсов на портале
Убедитесь, что все ресурсы настроены с помощью параметров диагностики. Перейдите к разделу **Монитор** на портале и откройте **Параметры диагностики**.

![Колонка "Журналы диагностики" на портале](./media/monitoring-overview-of-diagnostic-logs/diagnostic-settings-nav.png)

Чтобы найти раздел "Мониторинг", может понадобиться щелкнуть "Больше служб".

Здесь можно просматривать и фильтровать все ресурсы, поддерживающие журналы диагностики. Таким образом можно проверить, включена ли для них диагностика. Вы также можете детально просмотреть сведения, чтобы проверить, задано ли для ресурса несколько параметров, в какую учетную запись хранения, пространство имен концентраторов событий и/или рабочую область Log Analytics передаются данные.

![Журналы диагностики на портале](./media/monitoring-overview-of-diagnostic-logs/diagnostic-settings-blade.png)

При добавлении параметра диагностики открывается колонка "Параметры диагностики", в которой можно включить, отключить или изменить параметры диагностики для выбранного ресурса.

## <a name="supported-services-categories-and-schemas-for-resource-diagnostic-logs"></a>Поддерживаемые службы, категории и схемы для журналов диагностики ресурсов
С полным списком поддерживаемых служб, категорий и схем журнала, используемых этими службами, ознакомьтесь в [этой статье](monitoring-diagnostic-logs-schema.md).

## <a name="next-steps"></a>Дальнейшие действия

* [Потоковая передача журналов диагностики Azure в **концентраторы событий**](monitoring-stream-diagnostic-logs-to-event-hubs.md)
* [Создание или обновление диагностического параметра](https://msdn.microsoft.com/library/azure/dn931931.aspx)
* [Сбор журналов и метрик для служб Azure для использования в Log Analytics](../log-analytics/log-analytics-azure-storage.md)

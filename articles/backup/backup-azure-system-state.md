---
title: "Резервное копирование состояния системы Windows в Azure | Документация Майкрософт"
description: "Узнайте, как выполнить резервное копирование состояния системы компьютеров Windows Server и/или Windows в Azure."
services: backup
documentationcenter: 
author: saurabhsensharma
manager: carmonm
editor: 
keywords: "как выполнять резервное копирование, резервное копирование файлов и папок"
ms.assetid: 5b15ebf1-2214-4722-b937-96e2be8872bb
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/31/2017
ms.author: saurse;markgal
ms.openlocfilehash: 6fbd96935f444d8b0c6d068ebd0d28e612f19816
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="back-up-windows-system-state-in-resource-manager-deployment"></a>Резервное копирование состояния системы Windows с использованием модели развертывания Resource Manager
В этой статье описано, как выполнить резервное копирование состояния системы Windows Server в Azure. В этом руководстве приведены общие сведения,

Дополнительные сведения о службе архивации Azure см. в этом [обзоре](backup-introduction-to-azure-backup.md).

Если у вас нет подписки Azure, вы можете создать [бесплатную учетную запись](https://azure.microsoft.com/free/), предоставляющую доступ ко всем службам Azure.

## <a name="create-a-recovery-services-vault"></a>Создание хранилища служб восстановления
Для резервного копирования файлов и папок нужно создать хранилище служб восстановления в том регионе, в котором планируется хранить данные. Кроме того, необходимо определить способ репликации хранилища.

### <a name="to-create-a-recovery-services-vault"></a>Создание хранилища служб восстановления
1. Используя подписку Azure, войдите на [портал Azure](https://portal.azure.com/) (если вы еще этого не сделали).
2. В главном меню щелкните **Другие службы**, а затем в списке ресурсов введите **Службы восстановления** и щелкните **Хранилища служб восстановления**.

    ![Создание хранилища служб восстановления — шаг 1](./media/backup-try-azure-backup-in-10-mins/open-rs-vault-list.png) <br/>

    Если в подписке есть хранилища служб восстановления, они отобразятся в списке.
3. В меню **Хранилища служб восстановления** щелкните **Добавить**.

    ![Создание хранилища служб восстановления — шаг 2](./media/backup-try-azure-backup-in-10-mins/rs-vault-menu.png)

    Откроется колонка хранилища служб восстановления, в которой нужно указать **имя**, **подписку**, **группу ресурсов** и **расположение**.

    ![Создание хранилища служб восстановления — шаг 3](./media/backup-try-azure-backup-in-10-mins/rs-vault-step-3.png)

4. В поле **Имя**введите понятное имя хранилища. Имя должно быть уникальным в пределах подписки Azure. Введите имя длиной от 2 до 50 знаков. Имя должно начинаться с буквы, оно может содержать только буквы, цифры и дефисы.

5. В разделе **Подписка** в раскрывающемся меню выберите подписку Azure. Если вы используете только одну подписку, она уже отображается и вы можете перейти к следующему шагу. Если неизвестно, какую подписку нужно использовать, оставьте подписку по умолчанию (или предлагаемую подписку). Вариантов будет несколько только в том случае, если учетная запись вашей организации связана с несколькими подписками Azure.

6. В разделе **Группа ресурсов** сделайте следующее:

    * выберите **Создать**, если вы хотите создать группу ресурсов;
    Или
    * выберите **Использовать существующий** и просмотрите список доступных групп ресурсов в раскрывающемся меню.

  Дополнительные сведения о группах ресурсов см. в статье [Общие сведения об Azure Resource Manager](../azure-resource-manager/resource-group-overview.md).

7. В поле **Расположение** выберите географический регион, в котором будет находиться хранилище. Этот выбор определяет географический регион, в который будут отправляться данные архивации.

8. В нижней части колонки "Хранилище служб восстановления" нажмите кнопку **Создать**.

    Создание хранилища служб восстановления может занять несколько минут. Следите за уведомлениями о состоянии на портале в верхней правой области. После создания хранилище появится в списке хранилищ служб восстановления. Если через несколько минут хранилище не отобразилось, нажмите кнопку **Обновить**.

    ![Кнопка "Обновить"](./media/backup-try-azure-backup-in-10-mins/refresh-button.png)</br>

    Как только хранилище отобразится в списке хранилищ служб восстановления, для него можно определить избыточность.

### <a name="set-storage-redundancy-for-the-vault"></a>Настройка избыточности хранилища
При создании хранилища служб восстановления настройте его избыточность в соответствии со своими потребностями.

1. В колонке **Хранилища служб восстановления** щелкните новое хранилище.

    ![Выбор нового хранилища в списке хранилищ служб восстановления](./media/backup-try-azure-backup-in-10-mins/rs-vault-list.png)

    При выборе хранилища колонка **Хранилище служб восстановления** сужается и открывается колонка параметров (*с именем хранилища вверху*), а также колонка со сведениями о хранилище.

    ![Просмотр конфигурации нового хранилища](./media/backup-try-azure-backup-in-10-mins/set-storage-configuration-2.png)
2. В колонке параметров нового хранилища прокрутите с помощью вертикального ползунка вниз к разделу "Управление" и щелкните **Инфраструктура резервного копирования**.
    Откроется колонка инфраструктуры резервного копирования.
3. В этой колонке выберите **Инфраструктура резервного копирования**, чтобы открыть колонку **Конфигурация архивации**.

    ![Настройка конфигурации для нового хранилища](./media/backup-try-azure-backup-in-10-mins/set-storage-configuration.png)
4. Выберите нужный тип репликации для хранилища.

    ![Варианты конфигурации хранилища](./media/backup-try-azure-backup-in-10-mins/choose-storage-configuration.png)

    По умолчанию это геоизбыточное хранилище. Если в качестве конечной точки основного хранилища службы архивации используется Azure, выберите **геоизбыточное хранилище**, а если нет, — **локально избыточное** (это позволит снизить плату за хранилище Azure). Дополнительные сведения о [геоизбыточном](../storage/common/storage-redundancy.md#geo-redundant-storage) и [локально избыточном](../storage/common/storage-redundancy.md#locally-redundant-storage) хранилищах см. в статье [Репликация службы хранилища Azure](../storage/common/storage-redundancy.md).

Теперь, когда вы создали хранилище, настройте в нем резервное копирование состояния системы Windows.

## <a name="configure-the-vault"></a>Настройка хранилища
1. В колонке хранилища служб восстановления (хранилища, которое вы только что создали) в разделе "Начало работы" выберите **Резервное копирование**. Затем в колонке **Начало работы с резервным копированием** выберите **Цель резервного копирования**.

    ![Открытая колонка цели резервного копирования](./media/backup-try-azure-backup-in-10-mins/open-backup-settings.png)

    Откроется колонка **Цель резервного копирования**.

    ![Открытая колонка цели резервного копирования](./media/backup-try-azure-backup-in-10-mins/backup-goal-blade.png)

2. В раскрывающемся меню **Где выполняется рабочая нагрузка?** выберите **Локально**.

    Вы выбираете параметр **Локально**, потому что ваш компьютер Windows Server или Windows — это физический компьютер, которые не находится в Azure.

3. В меню **Что вы хотите резервировать?** выберите **Состояние системы** и нажмите кнопку **ОК**.

    ![Настройка резервного копирования файлов и папок](./media/backup-azure-system-state/backup-goal-system-state.png)

    После того как вы нажмете кнопку "ОК", рядом с параметром **Цель резервного копирования** появится флажок и откроется колонка **Подготовка инфраструктуры**.

    ![Цель резервного копирования настроена, на очереди подготовка инфраструктуры](./media/backup-try-azure-backup-in-10-mins/backup-goal-configed.png)

4. В колонке **Подготовка инфраструктуры** щелкните **Скачать агент для Windows Server или Windows Client**.

    ![Download Agent for Windows Server or Windows Client](./media/backup-try-azure-backup-in-10-mins/choose-agent-for-server-client.png)

    Если вы используете Windows Server Essential, выберите загрузку агента для Windows Server Essential. Во всплывающем меню появится запрос на запуск или сохранение файла MARSAgentInstaller.exe.

    ![Диалоговое окно MARSAgentInstaller](./media/backup-try-azure-backup-in-10-mins/mars-installer-run-save.png)

5. Во всплывающем окне скачивания нажмите кнопку **Сохранить**.

    По умолчанию файл **MARSagentinstaller.exe** сохраняется в папке для скачивания. После завершения установки появится всплывающее окно с двумя вариантами действий: запустить установщик или открыть папку.

    ![Download Agent for Windows Server or Windows Client](./media/backup-try-azure-backup-in-10-mins/mars-installer-complete.png)

    Пока не нужно устанавливать агент. Его можно установить после скачивания учетных данных хранилища.

6. В колонке **Подготовка инфраструктуры** щелкните **Скачать**.

    ![Скачивание учетных данных хранилища](./media/backup-try-azure-backup-in-10-mins/download-vault-credentials.png)

    Учетные данные хранилища будут сохранены в папке "Загрузки". После этого вы увидите всплывающее окно с двумя вариантами действий: открыть или сохранить учетные данные. Щелкните **Сохранить**. Если вы случайно нажали кнопку **Открыть**, подождите, пока попытка открыть учетные данные хранилища закончится ошибкой. Вы не можете открыть учетные данные хранилища. Перейдите к следующему шагу. Учетные данные хранилища находятся в папке "Загрузки".   

    ![Загрузка учетных данных хранилища завершена](./media/backup-try-azure-backup-in-10-mins/vault-credentials-downloaded.png)

## <a name="install-and-register-the-agent"></a>Установка и регистрация агента

> [!NOTE]
> Параметр для включения резервного копирования на портале Azure пока недоступен. Используйте агент служб восстановления Microsoft Azure для резервного копирования состояния системы Windows Server.
>

1. Найдите и дважды щелкните файл **MARSagentinstaller.exe** в папке "Загрузки" (или в другом расположении).

    В установщике будут отображаться соответствующие сообщения по мере извлечения, установки и регистрации агента служб восстановления.

    ![Запуск установщика агента служб восстановления](./media/backup-try-azure-backup-in-10-mins/mars-installer-registration.png)

2. Выполните шаги мастера настройки агента служб восстановления Microsoft Azure. Для завершения работы с мастерам вам нужно:

   * Выбрать папку установки и папку кэша.
   * Если для подключения к Интернету используется прокси-сервер, указать данные прокси-сервера.
   * Если используется прокси-сервер, прошедший проверку подлинности, ввести имя пользователя и пароль.
   * Указать скачанные учетные данные хранилища.
   * Сохранить парольную фразу шифрования в безопасном месте.

     > [!NOTE]
     > Если вы потеряли или забыли парольную фразу, корпорация Майкрософт не сможет помочь вам восстановить резервную копию данных. Сохраните файл в безопасном месте, так как он потребуется для восстановления резервной копии.
     >
     >

Теперь, когда агент установлен и компьютер зарегистрирован в хранилище, вы можете настроить параметры резервного копирования, в том числе расписание.

## <a name="back-up-windows-server-system-state-preview"></a>Состояние резервного копирования системы Windows Server (предварительная версия)
Начальное резервное копирование включает в себя три задачи:

* включение резервного копирования состояния системы с помощью агента службы Azure Backup;
* Планирование архивации
* архивация файлов и папок впервые.

Чтобы выполнить первоначальное резервное копирование, используйте агент служб восстановления Microsoft Azure.

### <a name="to-enable-system-state-backup-using-the-azure-backup-agent"></a>Включение резервного копирования состояния системы с помощью агента службы Azure Backup

1. В сеансе PowerShell выполните указанную ниже команду, чтобы остановить работу модуля резервного копирования Azure.

  ```
  PS C:\> Net stop obengine
  ```

2. Откройте реестр Windows.

  ```
  PS C:\> regedit.exe
  ```

3. Добавьте следующий раздел реестра с заданным значением DWORD.

  | Путь к элементу реестра | Раздел реестра | Значение DWORD |
  |---------------|--------------|-------------|
  | HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Config\CloudBackupProvider | TurnOffSSBFeature | 2 |

4. Перезапустите модуль резервного копирования, выполнив следующую команду в командной строке с повышенными привилегиями:

  ```
  PS C:\> Net start obengine
  ```

### <a name="to-schedule-the-backup-job"></a>Планирование задания резервного копирования

1. Откройте агент служб восстановления Microsoft Azure. Его можно найти, выполнив поиск строки **служба архивации Microsoft Azure**на компьютере.

    ![Запуск агента служб восстановления Azure](./media/backup-try-azure-backup-in-10-mins/snap-in-search.png)

2. В агенте служб восстановления щелкните **Создать расписание архивации**.

    ![Планирование архивации Windows Server](./media/backup-try-azure-backup-in-10-mins/schedule-first-backup.png)

3. На странице "Приступая к работе" в мастере планирования архивации нажмите кнопку **Далее**.

4. На странице "Выбор элементов для архивации" щелкните **Добавить элементы**.

5. Выберите **Состояние системы** и нажмите кнопку **ОК**.

6. Щелкните **Далее**.

7. Резервное копирование и сохранение состояния системы автоматически выполняется каждое воскресенье в 21:00 по местному времени. Срок хранения составляет 60 дней.

   > [!NOTE]
   > Политики резервного копирования и хранения состояния системы настраиваются автоматически. Если кроме состояния системы Windows Server вы выполняете резервное копирование файлов и папок, укажите только политику резервного копирования и хранения для резервных копий файлов из мастера. 
   >

8. Проверьте сведения на странице подтверждения и нажмите кнопку **Готово**.

9. Когда мастер завершит создание расписания архивации, нажмите кнопку **Закрыть**.

### <a name="to-back-up-windows-server-system-state-for-the-first-time"></a>Первое резервное копирование состояния системы Windows Server

1. Убедитесь, что для Windows Server нет незавершенных обновлений, которые требуют перезагрузки.

2. В агенте служб восстановления щелкните **Выполнить моментальную архивацию**, чтобы завершить начальное заполнение по сети.

    ![Моментальная архивация Windows Server](./media/backup-try-azure-backup-in-10-mins/backup-now.png)

3. На странице "Подтверждение" проверьте параметры, которые мастер будет использовать для архивации данных на компьютере. Затем нажмите кнопку **Архивировать**.

4. Нажмите кнопку **Закрыть**, чтобы закрыть мастер. Если сделать это до завершения архивации, мастер продолжит работу в фоновом режиме.

5. Если кроме резервного копирования состояния системы Windows Server вы выполняете резервное копирование файлов и папок на сервере, мастер моментальной архивации будет создавать только резервные копии файлов. Для выполнения нерегламентированного резервного копирования состояния системы выполните следующую команду PowerShell:

    ```
    PS C:\> Start-OBSystemStateBackup
    ```

  После завершения начальной архивации в консоли службы архивации отобразится состояние **Задание выполнено**.

  ![Первоначальное восстановление завершено](./media/backup-try-azure-backup-in-10-mins/ircomplete.png)

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

Чтобы получить дополнительные сведения, ознакомьтесь с указанными ниже вопросами и ответами.

### <a name="what-is-the-staging-volume"></a>Что такое промежуточный том?

Промежуточный том предоставляет промежуточное расположение, в котором изначально доступная система архивации данных Windows Server размещает резервные копии состояния системы. Затем агент службы Azure Backup сжимает и шифрует эту промежуточную резервную копию и отправляет ее через защищенный протокол HTTPS в настроенное хранилище служб восстановления. **Мы настоятельно рекомендуем установить промежуточный том в томе операционной системы, отличной от Windows. Если возникнут проблемы с резервным копированием состояния системы, для устранения неполадок сначала необходимо проверить расположение промежуточного тома.** 

### <a name="how-can-i-change-the-staging-volume-path-specified-in-the-azure-backup-agent"></a>Как изменить путь промежуточного тома, указанный в агенте службы Azure Backup?

По умолчанию промежуточный том расположен в папке кэша. 

1. Чтобы изменить это расположение, выполните следующую команду (в командной строке с повышенными привилегиями):
  ```
  PS C:\> Net stop obengine
  ```

2. Затем обновите следующие записи реестра, указав путь к новой папке промежуточного тома.

  |Путь к элементу реестра|Раздел реестра|Значение|
  |-------------|------------|-----|
  |HKEY_LOCAL_MACHINE\Software\Microsoft\Windows Azure Backup\Config\CloudBackupProvider | SSBStagingPath | новое расположение промежуточного тома |

В промежуточном пути учитывается регистр. Он должен точно соответствовать регистру на сервере. 

3. Изменив путь промежуточного тома, перезапустите модуль резервного копирования:
  ```
  PS C:\> Net start obengine
  ```
4. Чтобы использовать измененный путь, откройте агент служб восстановления Microsoft Azure и активируйте нерегламентированное резервное копирование состояния системы.

### <a name="why-is-the-system-state-default-retention-set-to-60-days"></a>Почему срок хранения состояния системы по умолчанию составляет 60 дней?

Срок эксплуатации резервных копий состояния системы равен времени существования отметки полного удаления для роли Windows Server Active Directory. Значение по умолчанию для записи времени существования отметки полного удаления составляет 60 дней. Это значение можно задать в объекте конфигурации службы каталогов (NTDS).

### <a name="how-do-i-change-the-default-backup-and-retention-policy-for-system-state"></a>Как изменить стандартную политику резервного копирования и хранения состояния системы?

Для этого сделайте следующее:
1. Остановите работу модуля резервного копирования. Выполните следующую команду в командной строке с повышенными привилегиями:

  ```
  PS C:\> Net stop obengine
  ```

2. Добавьте или обновите следующие записи раздела реестра в HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Config\CloudBackupProvider.

  |Имя реестра|Описание|Значение|
  |-------------|-----------|-----|
  |SSBScheduleTime|Используется для настройки времени резервного копирования. Значение по умолчанию — 21:00 по местному времени.|DWORD: формат ЧЧММ (десятичное число), например 2130 для 21:30 по местному времени.|
  |SSBScheduleDays|Используется для настройки дней, когда необходимо выполнить резервное копирование состояния системы в определенный промежуток времени. Дни недели указываются с помощью отдельных цифр. 0 означает воскресенье, 1 — понедельник и т. д. Стандартным днем для резервного копирования является воскресенье.|DWORD: дни недели для выполнения резервного копирования (десятичное число), например 1230 планирует резервное копирование на понедельник, вторник, среду и воскресенье.|
  |SSBRetentionDays|Используется для настройки дней для хранения резервной копии. Значение по умолчанию — 60. Допустимое значение не должно превышать 180.|DWORD: дни для хранения резервных копий (десятичное число).|

3. Выполните следующую команду, чтобы перезапустить модуль резервного копирования:
    ```
    PS C:\> Net start obengine
    ```

4. Откройте агент служб восстановления Microsoft.

5. Выберите **Создать расписание архивации** и нажимайте кнопку **Далее** пока не увидите изменения.

6. Нажмите кнопку **Готово**, чтобы применить изменения.


## <a name="questions"></a>Вопросы?
Если вы хотите задать вопрос или предложить добавить какие-либо функции, [отправьте нам свой отзыв](http://aka.ms/azurebackup_feedback).

## <a name="next-steps"></a>Дальнейшие действия
* См. дополнительные сведения об [архивации компьютеров Windows](backup-configure-vault.md).
* Теперь, когда вы выполнили резервное копирование файлов и папок, вы можете [управлять хранилищами и серверами](backup-azure-manage-windows-server.md).
* Если необходимо восстановить резервную копию, см. статью о [восстановлении файлов на компьютере Windows](backup-azure-restore-windows-server.md).

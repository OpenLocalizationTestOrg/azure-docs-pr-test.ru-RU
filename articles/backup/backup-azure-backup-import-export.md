---
title: "Служба архивации Azure: автономная архивация и начальное заполнение с помощью службы импорта и экспорта Azure | Документация Майкрософт"
description: "Узнайте, как служба архивации Azure позволяет отправлять данные с помощью службы импорта и экспорта Azure без использования сети. В этой статье описывается автономное заполнение начальных резервных копий данных с помощью службы импорта и экспорта Azure."
services: backup
documentationcenter: 
author: saurabhsensharma
manager: shivamg
editor: 
ms.assetid: ada19c12-3e60-457b-8a6e-cf21b9553b97
ms.service: backup
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 12/18/2017
ms.author: saurse;nkolli;trinadhk
ms.openlocfilehash: 32a48a34711a7f053a74e103deb6853150de3903
ms.sourcegitcommit: 176c575aea7602682afd6214880aad0be6167c52
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/09/2018
---
# <a name="offline-backup-workflow-in-azure-backup"></a>Автономное резервное копирование в службе архивации Azure
В службу архивации Azure встроено несколько эффективных методов, которые позволяют экономить затраты на сеть и хранилище во время передачи начальных полных резервных копий данных в Azure. Обычно при этом выполняется передача больших объемов данных. Следовательно, для первой архивации требуется более высокая пропускная способность по сравнению с последующими операциями архивации, в ходе которых передаются только изменения или добавочные резервные копии. Служба архивации Azure сжимает начальные резервные копии, а также предоставляет механизм передачи сжатых копий данных в Azure с помощью дисков за счет процесса автономного заполнения.  

Этот предоставленный службой архивации Azure процесс тесно интегрирован со [службой импорта и экспорта Azure](../storage/common/storage-import-export-service.md) , что позволяет передавать данные в Azure, используя диски. Процесс автономного заполнения можно использовать для отправки начальных резервных копий на одном или нескольких жестких дисках в центр обработки данных Azure, когда размер начальных резервных копий, которые нужно передать по сети с большой задержкой и низкой пропускной способностью, составляет несколько терабайт. В этой статье описаны действия, необходимые для выполнения этого процесса.

## <a name="overview"></a>Обзор
Благодаря процессу автономного заполнения, предоставленному службой архивации Azure, и службе импорта и экспорта Azure автономная передача данных в хранилище Azure с помощью дисков не вызывает проблем. Вместо передачи начальной полной копии по сети, резервные копии данных записываются в *промежуточное расположение*. После записи копии в промежуточное расположение с помощью средства импорта и экспорта Azure эти данные записываются на один или несколько дисков SATA. Количество используемых дисков зависит от объема данных. Со временем эти диски отправляются в ближайший центр обработки данных Azure.

В [обновлении службы архивации Azure от августа 2016 года (и более позднего)](http://go.microsoft.com/fwlink/?LinkID=229525) представлено *средство подготовки дисков Azure*, которое называется AzureOfflineBackupDiskPrep. Это средство предоставляет следующие возможности:

* Помогает в подготовке дисков для импорта в Azure с помощью средства импорта и экспорта Azure.
* Автоматически создает задание импорта Azure для службы импорта и экспорта Azure на [портале Azure](https://ms.portal.azure.com).

После передачи резервной копии данных в Azure служба архивации Azure копирует эти данные в хранилище службы архивации, после чего планируется добавочное резервное копирование.

> [!NOTE]
> Средство подготовки дисков Azure доступно в обновлении службы архивации Azure от августа 2016 г. (или более позднем). Чтобы использовать его, убедитесь, что нужное обновление установлено, и выполните с его помощью все необходимые действия рабочего процесса. Если используется предыдущая версия службы архивации Azure, для подготовки диска SATA можно воспользоваться средством импорта и экспорта Azure, как описано в следующих разделах этой статьи.
>
>

## <a name="prerequisites"></a>Необходимые компоненты
* [Ознакомьтесь с процессом экспорта и импорта Azure](../storage/common/storage-import-export-service.md).
* Перед началом этого процесса выполните следующее:
  * Создайте хранилище службы архивации Azure.
  * Скачайте учетные данные хранилища.
  * Установите агент службы архивации Azure на сервер Windows Server, клиент Windows или сервер System Center Data Protection Manager и зарегистрируйте компьютер в хранилище службы архивации Azure.
* [Скачайте файл с параметрами публикации Azure](https://portal.azure.com/#blade/Microsoft_Azure_ClassicResources/PublishingProfileBlade) на компьютер, где планируете создать резервную копию данных.
* Подготовьте промежуточное расположение, в роли которого может выступать сетевая папка или дополнительный диск компьютера. Промежуточное расположение — это "промежуточное хранилище", которое используется временно. Убедитесь, что в промежуточном расположении есть достаточно места для хранения начальной копии. Например, если нужно создать резервную копию файлового сервера размером 500 ГБ, убедитесь, что промежуточное расположение имеет не менее 500 ГБ свободного места. (Хотя фактически использованный объем будет меньшим.)
* Убедитесь, что используется поддерживаемый диск. Служба импорта и экспорта поддерживает только 2,5-дюймовые твердотельные накопители и 2,5- или 3,5-дюймовые внутренние жесткие диски SATA II или III. Можно использовать жесткие диски емкостью до 10 ТБ. Список поддерживаемых дисков см. в [документации по службе импорта и экспорта Azure](../storage/common/storage-import-export-service.md#hard-disk-drives).
* На компьютере, к которому подключено устройство записи дисков SATA, активируйте BitLocker.
* [Скачайте средство импорта и экспорта Azure](http://go.microsoft.com/fwlink/?LinkID=301900&clcid=0x409) на компьютер, к которому подключено устройство записи дисков SATA. Если используется обновление службы архивации от августа 2016 г. (или более позднее), это действие выполнять не обязательно.

## <a name="workflow"></a>Рабочий процесс
Сведения в этом разделе помогут выполнить автономное резервное копирование с целью отправки данных в центр обработки данных Azure и передачи в службу хранилища Azure. Ответы на вопросы о службе импорта или о любом аспекте этого процесса см. в статье [Использование службы импорта и экспорта Azure для передачи данных в хранилище BLOB-объектов](../storage/common/storage-import-export-service.md).

### <a name="initiate-offline-backup"></a>Запуск автономного резервного копирования
1. В процессе планирования резервного копирования отобразится следующая страница (на сервере Windows Server, в клиенте Windows или System Center Data Protection Manager).

    ![Экран импорта](./media/backup-azure-backup-import-export/offlineBackupscreenInputs.png)

    Соответствующая страница на сервере System Center Data Protection Manager выглядит так:  <br/>
    ![Экран импорта DPM](./media/backup-azure-backup-import-export/dpmoffline.png)

    Ниже приведено описание входных данных.

    * **Промежуточное расположение**— временное хранилище, куда записывается начальная резервная копия. Это может быть сетевая папка или локальный компьютер. Если целевой компьютер и исходный компьютер разные, мы советуем указывать полный сетевой путь к промежуточному расположению.
    * **Имя задания импорта Azure**— уникальное имя, по которому служба импорта Azure и служба архивации Azure отслеживают процесс передачи данных в Azure с помощью дисков.
    * **Параметры публикации Azure**— XML-файл со сведениями о профиле подписки. В нем также содержатся защищенные учетные данные, связанные с вашей подпиской. Вы можете [скачать файл](https://portal.azure.com/#blade/Microsoft_Azure_ClassicResources/PublishingProfileBlade). Укажите локальный путь к файлу параметров публикации.
    * **Идентификатор подписки Azure**— идентификатор той подписки Azure, в которой вы планируете запустить задание импорта Azure. Если у вас несколько подписок Azure, используйте идентификатор подписки, которую необходимо связать с заданием импорта.
    * **Учетная запись хранения Azure** — учетная запись хранения в подписке Azure, связанная с заданием импорта Azure.
    * **Контейнер службы хранилища Azure**— имя хранилища BLOB-объектов в учетной записи хранения Azure, куда импортируются данные этого задания.

    > [!NOTE]
    > Если сервер для резервных копий зарегистрирован в хранилище служб восстановления Azure на [портале Azure](https://portal.azure.com), а не в подписке поставщика облачных решений, по-прежнему можно создать на портале Azure учетную запись хранения и использовать ее для выполнения автономного резервного копирования.
    >
    >

     Сохраните эти сведения отдельно, так как они понадобятся в ходе выполнения следующих действий. Если подготовка дисков осуществляется с помощью средства подготовки дисков Azure, требуется только *промежуточное расположение* .    
2. Завершите процесс и в консоли управления службы архивации Azure выберите **Выполнить моментальную архивацию**. Начнется создание автономной резервной копии. На этом этапе начальная резервная копия записывается в промежуточное расположение.

    ![Команда «Выполнить моментальную архивацию»](./media/backup-azure-backup-import-export/backupnow.png)

    Чтобы выполнить соответствующий процесс на сервере System Center Data Protection Manager, щелкните правой кнопкой мыши **Группа защиты** и выберите параметр **Создать точку восстановления**. После этого выберите параметр **Защита в сети** .

    ![Резервное копирование DPM](./media/backup-azure-backup-import-export/dpmbackupnow.png)

    После завершения операции промежуточное расположение можно использовать для подготовки дисков.

    ![Ход выполнения резервного копирования](./media/backup-azure-backup-import-export/opbackupnow.png)

### <a name="prepare-a-sata-drive-and-create-an-azure-import-job-by-using-the-azure-disk-preparation-tool"></a>Подготовка диска SATA и создание задания импорта Azure с помощью средства подготовки дисков Azure
Средство подготовки дисков Azure доступно в каталоге установки агента служб восстановления (обновление от августа 2016 г. и более позднее) по следующему пути:

   *\Microsoft* *Azure* *Recovery* *Services* *Agent\Utils\*

1. Перейдите по этому пути и скопируйте каталог **AzureOfflineBackupDiskPrep** на целевой компьютер, к которому присоединены подготавливаемые диски. Убедитесь, что целевой компьютер соответствует следующим требованиям:

    * Промежуточное расположение, используемое для рабочего процесса автономного заполнения, доступно на целевом компьютере по тому же сетевому пути, который был задан во время **запуска автономного резервного копирования** .
    * На компьютере активировано средство BitLocker.
    * Компьютер имеет доступ к порталу Azure.

    При необходимости целевым компьютером может быть исходный компьютер.
2. На целевом компьютере, где находится каталог средства подготовки дисков Azure, откройте командную строку с повышенными привилегиями и выполните следующую команду:

    `*.\AzureOfflineBackupDiskPrep.exe*   s:<*Staging Location Path*>   [p:<*Path to PublishSettingsFile*>]`

    | Параметр | ОПИСАНИЕ |
    | --- | --- |
    | s:&lt;*путь_к_промежуточному_расположению*&gt; |Обязательный параметр. Используется для предоставления пути к промежуточному расположению, заданному в процессе **запуска автономной архивации**. |
    | p:&lt;*путь_к_файлу_параметров_публикации*&gt; |Необязательный параметр. Используется для предоставления пути к **файлу параметров публикации**, заданному в процессе **запуска автономной архивации**. |

    > [!NOTE]
    > Если целевой компьютер и исходный компьютер разные, то нужно обязательно указать значение &lt;Path to PublishSettingFile&gt; (Путь к файлу параметров публикации).
    >
    >

    При выполнении команды средство запрашивает выбор задания импорта Azure, связанного с подготавливаемыми дисками. Если с предоставленным промежуточным расположением связано только одно задание импорта, отобразится следующее окно.

    ![Входные данные средства подготовки дисков Azure](./media/backup-azure-backup-import-export/azureDiskPreparationToolDriveInput.png) <br/>
3. Введите букву подключенного диска (без двоеточия), который нужно подготовить для передачи в Azure. При появлении запроса подтвердите форматирование диска.

    После этого средство начнет подготовку диска с резервными копиями данных. Когда в средстве отобразится соответствующий запрос, может потребоваться подключить дополнительные диски. Это связано с тем, что на выбранном диске недостаточно памяти для хранения резервных копий данных. <br/>

    После завершения процесса диски, подготовленные с помощью средства, можно использовать для передачи в Azure. Кроме того, на портале Azure будет создано задание импорта с именем, заданным во время **запуска автономного резервного копирования**. Наконец, в средстве отображается адрес центра обработки данных Azure, в который необходимо передать диски, а также ссылка на задание импорта на портале Azure.

    ![Завершение подготовки дисков Azure](./media/backup-azure-backup-import-export/azureDiskPreparationToolSuccess.png)<br/>

4. Перешлите диски на адрес, указанный в средстве, и сохраните номер отслеживания для использования в будущем.<br/>

5. После перехода по ссылке, приведенной в средстве, откроется учетная запись хранения Azure, указанная в процессе **автономного резервного копирования** . Здесь на вкладке **Импорт или экспорт** учетной записи хранения можно просмотреть созданное задание импорта.

    ![Созданное задание импорта](./media/backup-azure-backup-import-export/ImportJobCreated.png)<br/>

6. В нижней части страницы щелкните **Данные об отправке** , чтобы обновить контактные сведения, как показано на следующем снимке экрана. Корпорация Майкрософт использует эти сведения, чтобы вернуть диски после завершения задания импорта.

    ![Контактные данные](./media/backup-azure-backup-import-export/contactInfoAddition.PNG)<br/>

7. На следующей странице введите сведения об отправке. Укажите сведения о **поставщике почтовых услуг**, который использовался для отправки дисков в центр обработки данных Azure, и **номер отслеживания**.

    ![Данные об отправке](./media/backup-azure-backup-import-export/shippingInfoAddition.PNG)<br/>

### <a name="complete-the-workflow"></a>Завершение процесса
После завершения задания импорта начальные резервные копии данных появятся в вашей учетной записи хранения. Агент служб восстановления скопирует из нее данные в хранилище архивации или хранилище служб восстановления (в зависимости от того, что используется). При следующем запланированном резервном копировании агент службы архивации Azure выполняет добавочное резервное копирование поверх начальной резервной копии.

> [!NOTE]
> Следующие разделы предназначены для пользователей, у которых нет доступа к средству подготовки дисков Azure (то есть они используют более раннюю версию службы архивации Azure).
>
>

### <a name="prepare-a-sata-drive"></a>Подготовка диска SATA
1. Скачайте [средство импорта и экспорта Microsoft Azure](http://go.microsoft.com/fwlink/?linkid=301900&clcid=0x409) на целевой компьютер. Убедитесь, что компьютер, на котором вы планируете выполнить следующий набор команд, имеет доступ к промежуточному расположению. При необходимости целевым компьютером может быть исходный компьютер.

2. Распакуйте файл WAImportExport.zip. Запустите средство WAImportExport, которое отформатирует диск SATA, запишет резервные копии данных на этот диск и зашифрует его. Перед выполнением следующей команды убедитесь, что на компьютере активировано средство BitLocker. <br/>

    `*.\WAImportExport.exe PrepImport /j:<*JournalFile*>.jrn /id: <*SessionId*> /sk:<*StorageAccountKey*> /BlobType:**PageBlob** /t:<*TargetDriveLetter*> /format /encrypt /srcdir:<*staging location*> /dstdir: <*DestinationBlobVirtualDirectory*>/*`

    > [!NOTE]
    > После установки обновления службы архивации от августа 2016 года (или более позднего) убедитесь, что используется то же промежуточное расположение, что и указанное на странице **Выполнить моментальную архивацию**, а также в наличии AIB-файла и файла базового большого двоичного объекта.
    >
    >

| Параметр | ОПИСАНИЕ |
| --- | --- |
| /j:<*файл_журнала*> |Путь к файлу журнала. У каждого диска должен быть только один файл журнала. Файл журнала не может находиться на целевом диске. Файла журнала имеет расширение JRN и создается в процессе выполнения этой команды. |
| /id:<*ИД_сеанса*> |Идентификатор сеанса определяет сеанс копирования. и используется для обеспечения точного восстановления прерванного сеанса копирования. Файлы, копируемые во время сеанса копирования, хранятся в каталоге с именем, соответствующем идентификатору сеанса на целевом диске. |
| /sk:<*ключ_учетной_записи_хранения*> |Ключ учетной записи хранения, в которую будут импортированы данные. Он должен совпадать с ключом, введенным при создании политики резервного копирования или группы защиты. |
| /BlobType |Тип большого двоичного объекта. Этот рабочий процесс завершится успешно, только если указан параметр **PageBlob** . Этот параметр не является параметром по умолчанию, поэтому его нужно указывать вручную. |
| /t:<*буква_целевого_диска*> |Буква целевого жесткого диска для текущего сеанса копирования без двоеточия в конце. |
| /format |Параметр, используемый для форматирования диска. Укажите этот параметр, если диск нужно отформатировать. В противном случае не используйте его. Прежде чем средство отформатирует диск, оно выдаст в консоли запрос на подтверждение. Чтобы запрос не выдавался, укажите параметр /silentmode. |
| /encrypt |Параметр, используемый для шифрования диска. Укажите этот параметр, если диск еще не зашифрован с помощью BitLocker и должен быть зашифрован сейчас. Если диск уже зашифрован средством BitLocker, не используйте этот параметр. Вместо него укажите параметр /bk и введите имеющийся ключ BitLocker. Если вы задаете параметр /format, также необходимо указать параметр /encrypt. |
| /srcdir:<*исходный_каталог*> |Исходный каталог, содержащий файлы для копирования на целевой диск. Убедитесь, что указанное имя каталога представляет собой полный путь, а не относительный. |
| /dstdir:<*целевой_виртуальный_каталог_больших_двоичных_объектов*> |Путь к целевому виртуальному каталогу в учетной записи хранения Azure. Указывая целевые виртуальные каталоги и большие двоичные объекты, используйте правильные имена контейнеров. Обратите внимание, что имена каталогов пишутся строчными буквами.  Имя контейнера должно совпадать с именем, введенным при создании политики резервного копирования или группы защиты. |

> [!NOTE]
> В папке WAImportExport создается файл журнала, в который записывается вся информация о процессе. Этот файл понадобится при создании задания импорта на портале Azure.
>
>

  ![Вывод PowerShell](./media/backup-azure-backup-import-export/psoutput.png)

### <a name="create-an-import-job-in-the-azure-portal"></a>Создание задания импорта на портале Azure
1. Перейдите в учетную запись хранения на [портале Azure](https://ms.portal.azure.com/), щелкните вкладку **Импорт или экспорт**, а затем в области задач выберите **Создать задание импорта**.

    ![Вкладка "Импорт или экспорт" на портале Azure](./media/backup-azure-backup-import-export/azureportal.png)

2. На шаге 1 мастера укажите, что вы подготовили диск и уже есть доступный файл журнала.

3. На шаге 2 мастера укажите контактные данные пользователя, ответственного за это задание импорта.

4. На шаге 3 передайте файлы журналов дисков, полученные на предыдущем этапе (см. предыдущий раздел).

5. На шаге 4 введите описательное имя для задания импорта, введенное при создании политики резервного копирования или группы защиты. Обратите внимание,что вводимое имя может содержать только строчные буквы, цифры, дефисы и подчеркивания. Кроме того, оно должно начинаться с буквы и не содержать пробелов. Выбранное имя будет использоваться для отслеживания заданий, пока они выполняются, а также после их завершения.

6. Далее выберите регион своего центра обработки данных из списка. Регион центра обработки данных означает центр обработки данных, куда следует направить пакет.

    ![Выбор региона центра обработки данных](./media/backup-azure-backup-import-export/dc.png)

7. На шаге 5 выберите поставщик почтовых услуг из списка и введите его номер учетной записи. Корпорация Майкрософт использует эту учетную запись, чтобы вернуть диски после завершения задания импорта.

8. Отправьте диск и введите номер отслеживания, чтобы иметь возможность следить за состоянием доставки. Когда диск будет доставлен в центр обработки данных, его скопируют в учетную запись хранения, после чего состояние процесса изменится.

    ![Состояние "Завершено"](./media/backup-azure-backup-import-export/complete.png)

### <a name="complete-the-workflow"></a>Завершение процесса
Когда начальные резервные копии данных появятся в вашей учетной записи хранения, агент служб восстановления Microsoft Azure скопирует из нее данные в хранилище архивации или хранилище служб восстановления (в зависимости от того, что используется). При следующем запланированном резервном копировании агент службы архивации Azure выполняет добавочное резервное копирование поверх начальной резервной копии.

## <a name="next-steps"></a>Дополнительная информация
* Дополнительные сведения о рабочем процессе службы импорта и экспорта см. в статье [Использование службы импорта и экспорта Azure для передачи данных в хранилище BLOB-объектов](../storage/common/storage-import-export-service.md).
* Дополнительные сведения об автономной архивации см. в статье [Служба архивации Azure: часто задаваемые вопросы](backup-azure-backup-faq.md).

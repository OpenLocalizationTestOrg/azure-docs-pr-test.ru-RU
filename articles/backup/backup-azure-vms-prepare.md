---
title: "aaaPreparing вашей среды tooback копирование виртуальных машин Azure | Документы Microsoft"
description: "Убедитесь, что ваша среда подготовлена для резервного копирования виртуальных машин в Azure."
services: backup
documentationcenter: 
author: markgalioto
manager: carmonn
editor: 
keywords: "резервные копии; резервное копирование;"
ms.assetid: 238ab93b-8acc-4262-81b7-ce930f76a662
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 4/25/2017
ms.author: markgal;trinadhk;
ms.openlocfilehash: 3b914c507dd6ad703ea799115ae84ac229e27787
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="prepare-your-environment-tooback-up-azure-virtual-machines"></a><span data-ttu-id="c0511-104">Подготовка к среде tooback копирование виртуальных машин Azure</span><span class="sxs-lookup"><span data-stu-id="c0511-104">Prepare your environment tooback up Azure virtual machines</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="c0511-105">Модель Resource Manager</span><span class="sxs-lookup"><span data-stu-id="c0511-105">Resource Manager model</span></span>](backup-azure-arm-vms-prepare.md)
> * [<span data-ttu-id="c0511-106">Классическая модель</span><span class="sxs-lookup"><span data-stu-id="c0511-106">Classic model</span></span>](backup-azure-vms-prepare.md)
>
>

<span data-ttu-id="c0511-107">Прежде чем можно будет выполнять резервное копирование виртуальной машины Azure, необходимо обеспечить выполнение трех условий:</span><span class="sxs-lookup"><span data-stu-id="c0511-107">Before you can back up an Azure virtual machine (VM), there are three conditions that must exist.</span></span>

* <span data-ttu-id="c0511-108">Требуется toocreate резервное хранилище или определите существующий резервного хранилища *в hello же регионе, что ВМ*.</span><span class="sxs-lookup"><span data-stu-id="c0511-108">You need toocreate a backup vault or identify an existing backup vault *in hello same region as your VM*.</span></span>
* <span data-ttu-id="c0511-109">Установите сетевое соединение между hello Azure общедоступный Интернет адреса и hello конечные точки хранилища Azure.</span><span class="sxs-lookup"><span data-stu-id="c0511-109">Establish network connectivity between hello Azure public Internet addresses and hello Azure storage endpoints.</span></span>
* <span data-ttu-id="c0511-110">Установите агент VM hello на hello виртуальной Машины.</span><span class="sxs-lookup"><span data-stu-id="c0511-110">Install hello VM agent on hello VM.</span></span>

<span data-ttu-id="c0511-111">Если известно, что эти условия уже существуют в вашей среде, то продолжить toohello [резервное копирование виртуальных машин статью](backup-azure-vms.md).</span><span class="sxs-lookup"><span data-stu-id="c0511-111">If you know these conditions already exist in your environment then proceed toohello [Back up your VMs article](backup-azure-vms.md).</span></span> <span data-ttu-id="c0511-112">В противном случае чтение, в этой статье поможет hello действия tooprepare вашей среды tooback копирование виртуальной Машины Azure.</span><span class="sxs-lookup"><span data-stu-id="c0511-112">Otherwise, read on, this article will lead you through hello steps tooprepare your environment tooback up an Azure VM.</span></span>

##<a name="supported-operating-system-for-backup"></a><span data-ttu-id="c0511-113">Поддерживаемые версии операционных систем для архивации</span><span class="sxs-lookup"><span data-stu-id="c0511-113">Supported operating system for backup</span></span>
 * <span data-ttu-id="c0511-114">**Linux**: служба архивации Azure поддерживает весь [список дистрибутивов, рекомендуемых для использования в Azure](../virtual-machines/linux/endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) , за исключением CoreOS Linux.</span><span class="sxs-lookup"><span data-stu-id="c0511-114">**Linux**: Azure Backup supports [a list of distributions that are endorsed by Azure](../virtual-machines/linux/endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) except Core OS Linux.</span></span> <span data-ttu-id="c0511-115">_Также другие перевести-Your-владельцем-дистрибутивы Linux могут работать, пока агент ВМ hello доступен на виртуальной машине hello и поддержку существует Python. Тем не менее мы не поддерживаем использование этих дистрибутивов для архивации._</span><span class="sxs-lookup"><span data-stu-id="c0511-115">_Other Bring-Your-Own-Linux distributions also might work as long as hello VM agent is available on hello virtual machine and support for Python exists. However, we do not endorse those distributions for backup._</span></span>
 * <span data-ttu-id="c0511-116">**Windows Server**: версии до Windows Server 2008 R2 не поддерживаются.</span><span class="sxs-lookup"><span data-stu-id="c0511-116">**Windows Server**:  Versions older than Windows Server 2008 R2 are not supported.</span></span>


## <a name="limitations-when-backing-up-and-restoring-a-vm"></a><span data-ttu-id="c0511-117">Ограничения при резервном копировании и восстановлении виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="c0511-117">Limitations when backing up and restoring a VM</span></span>
> [!NOTE]
> <span data-ttu-id="c0511-118">В Azure предусмотрены две модели развертывания, позволяющие создавать ресурсы и работать с ними: [модель Resource Manager и классическая модель](../azure-resource-manager/resource-manager-deployment-model.md).</span><span class="sxs-lookup"><span data-stu-id="c0511-118">Azure has two deployment models for creating and working with resources: [Resource Manager and classic](../azure-resource-manager/resource-manager-deployment-model.md).</span></span> <span data-ttu-id="c0511-119">Hello ниже приведены ограничения hello при развертывании в классической модели hello.</span><span class="sxs-lookup"><span data-stu-id="c0511-119">hello following list provides hello limitations when deploying in hello classic model.</span></span>
>
>

* <span data-ttu-id="c0511-120">Архивация виртуальных машин, к которым подключено более 16 дисков данных, не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="c0511-120">Backing up virtual machines with more than 16 data disks is not supported.</span></span>
* <span data-ttu-id="c0511-121">Архивация виртуальных машин с зарезервированным IP-адресом и без заданной конечной точки не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="c0511-121">Backing up virtual machines with a reserved IP address and no defined endpoint is not supported.</span></span>
* <span data-ttu-id="c0511-122">Резервных копий данных не содержит tooVM диски, подключенные сети подключены.</span><span class="sxs-lookup"><span data-stu-id="c0511-122">Backup data doesn't include network mounted drives attached tooVM.</span></span>
* <span data-ttu-id="c0511-123">Замена существующей виртуальной машины во время восстановления не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="c0511-123">Replacing an existing virtual machine during restore is not supported.</span></span> <span data-ttu-id="c0511-124">Сначала удалите существующую виртуальную машину hello и любые связанные диски, а затем восстановите hello данных из резервной копии.</span><span class="sxs-lookup"><span data-stu-id="c0511-124">First delete hello existing virtual machine and any associated disks, and then restore hello data from backup.</span></span>
* <span data-ttu-id="c0511-125">Резервное копирования и восстановление между регионами не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="c0511-125">Cross-region backup and restore is not supported.</span></span>
* <span data-ttu-id="c0511-126">Резервное копирование виртуальных машин с помощью службы архивации Azure hello поддерживается во всех регионах общих служб Azure (в разделе hello [контрольный список](https://azure.microsoft.com/regions/#services) поддерживаемых регионов).</span><span class="sxs-lookup"><span data-stu-id="c0511-126">Backing up virtual machines by using hello Azure Backup service is supported in all public regions of Azure (see hello [checklist](https://azure.microsoft.com/regions/#services) of supported regions).</span></span> <span data-ttu-id="c0511-127">Если сегодня не поддерживается hello региона, который вы ищете, его не появятся в раскрывающемся списке hello во время создания хранилища.</span><span class="sxs-lookup"><span data-stu-id="c0511-127">If hello region that you are looking for is unsupported today, it will not appear in hello dropdown list during vault creation.</span></span>
* <span data-ttu-id="c0511-128">Резервное копирование виртуальных машин с помощью службы архивации Azure hello поддерживается только для выбора версий операционной системы:</span><span class="sxs-lookup"><span data-stu-id="c0511-128">Backing up virtual machines by using hello Azure Backup service is supported only for select operating system versions:</span></span>
* <span data-ttu-id="c0511-129">Восстановление контроллера домена виртуальной машины, которая входит в конфигурацию с несколькими контроллерами домена, поддерживается только с помощью PowerShell.</span><span class="sxs-lookup"><span data-stu-id="c0511-129">Restoring a domain controller (DC) VM that is part of a multi-DC configuration is supported only through PowerShell.</span></span> <span data-ttu-id="c0511-130">Дополнительные сведения о [восстановлении контроллера домена в конфигурации с несколькими контроллерами домена](backup-azure-restore-vms.md#restoring-domain-controller-vms).</span><span class="sxs-lookup"><span data-stu-id="c0511-130">Read more about [restoring a multi-DC domain controller](backup-azure-restore-vms.md#restoring-domain-controller-vms).</span></span>
* <span data-ttu-id="c0511-131">Восстановление виртуальных машин, которые имеют специальные сетевые конфигурации hello поддерживается только с помощью PowerShell.</span><span class="sxs-lookup"><span data-stu-id="c0511-131">Restoring virtual machines that have hello following special network configurations is supported only through PowerShell.</span></span> <span data-ttu-id="c0511-132">Виртуальные машины, созданные с помощью рабочего процесса восстановления hello в hello пользовательского интерфейса не будет иметь эти конфигурации сети после завершения операции восстановления hello.</span><span class="sxs-lookup"><span data-stu-id="c0511-132">VMs that you create by using hello restore workflow in hello UI will not have these network configurations after hello restore operation is complete.</span></span> <span data-ttu-id="c0511-133">toolearn более, в разделе [восстановление виртуальных машин с конфигурацией сети специальные](backup-azure-restore-vms.md#restoring-vms-with-special-network-configurations).</span><span class="sxs-lookup"><span data-stu-id="c0511-133">toolearn more, see [Restoring VMs with special network configurations](backup-azure-restore-vms.md#restoring-vms-with-special-network-configurations).</span></span>
  * <span data-ttu-id="c0511-134">Виртуальные машины в конфигурации балансировщика нагрузки (внутренняя и внешняя)</span><span class="sxs-lookup"><span data-stu-id="c0511-134">Virtual machines under load balancer configuration (internal and external)</span></span>
  * <span data-ttu-id="c0511-135">Виртуальные машины с несколькими зарезервированными IP-адресами</span><span class="sxs-lookup"><span data-stu-id="c0511-135">Virtual machines with multiple reserved IP addresses</span></span>
  * <span data-ttu-id="c0511-136">Виртуальные машины с несколькими сетевыми адаптерами</span><span class="sxs-lookup"><span data-stu-id="c0511-136">Virtual machines with multiple network adapters</span></span>

## <a name="create-a-backup-vault-for-a-vm"></a><span data-ttu-id="c0511-137">Создание хранилища архивации для виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="c0511-137">Create a backup vault for a VM</span></span>
<span data-ttu-id="c0511-138">Резервное хранилище — это сущность, которой хранятся все резервные копии hello и точек восстановления, которые были созданы со временем.</span><span class="sxs-lookup"><span data-stu-id="c0511-138">A backup vault is an entity that stores all hello backups and recovery points that have been created over time.</span></span> <span data-ttu-id="c0511-139">резервное хранилище Hello также содержит hello политики резервного копирования, которые будут применяться toohello виртуальных машин, резервная копия.</span><span class="sxs-lookup"><span data-stu-id="c0511-139">hello backup vault also contains hello backup policies that will be applied toohello virtual machines being backed up.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="c0511-140">Запуск марта 2017 г., можно использовать больше не hello классического портала toocreate резервное копирование хранилищ.</span><span class="sxs-lookup"><span data-stu-id="c0511-140">Starting March 2017, you can no longer use hello classic portal toocreate Backup vaults.</span></span> <span data-ttu-id="c0511-141">Существующие хранилища резервной копии по-прежнему поддерживаются, и пользователь может слишком[использовать хранилищах службы архивации Azure PowerShell toocreate](./backup-client-automation-classic.md#create-a-backup-vault).</span><span class="sxs-lookup"><span data-stu-id="c0511-141">Existing Backup vaults are still supported, and it is possible too[use Azure PowerShell toocreate Backup vaults](./backup-client-automation-classic.md#create-a-backup-vault).</span></span> <span data-ttu-id="c0511-142">Тем не менее, корпорация Майкрософт рекомендует создать хранилищами служб восстановления для всех развертываний, поскольку в будущем применить хранилищами служб tooRecovery, только.</span><span class="sxs-lookup"><span data-stu-id="c0511-142">However, Microsoft recommends you create Recovery Services vaults for all deployments because future enhancements apply tooRecovery Services vaults, only.</span></span>


<span data-ttu-id="c0511-143">На данном рисунке показан hello связи между hello различных сущностей резервного копирования Azure: ![резервного копирования Azure сущностей и связей](./media/backup-azure-vms-prepare/vault-policy-vm.png)</span><span class="sxs-lookup"><span data-stu-id="c0511-143">This image shows hello relationships between hello various Azure Backup entities: ![Azure Backup entities and relationships](./media/backup-azure-vms-prepare/vault-policy-vm.png)</span></span>



## <a name="network-connectivity"></a><span data-ttu-id="c0511-144">Сетевое подключение</span><span class="sxs-lookup"><span data-stu-id="c0511-144">Network connectivity</span></span>
<span data-ttu-id="c0511-145">Моментальные снимки виртуальной Машины hello toomanage заказа, расширение резервного копирования hello должен toohello подключения к Azure общих IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="c0511-145">In order toomanage hello VM snapshots, hello backup extension needs connectivity toohello Azure public IP addresses.</span></span> <span data-ttu-id="c0511-146">Без hello правой подключение к Интернету, hello виртуальной машины HTTP запросов время ожидания и hello, произойдет сбой архивации.</span><span class="sxs-lookup"><span data-stu-id="c0511-146">Without hello right Internet connectivity, hello virtual machine's HTTP requests time out and hello backup operation fails.</span></span> <span data-ttu-id="c0511-147">Если для развертывания установлены ограничения доступа на месте, например, через группу безопасности сети (NSG), выберите один из следующих вариантов, чтобы открыть путь для трафика архивации:</span><span class="sxs-lookup"><span data-stu-id="c0511-147">If your deployment has access restrictions in place (through a network security group (NSG), for example), then choose one of these options for providing a clear path for backup traffic:</span></span>

* <span data-ttu-id="c0511-148">[Диапазоны IP-адресов белого списка hello центра обработки данных Azure](http://www.microsoft.com/en-us/download/details.aspx?id=41653) -см. в статье hello инструкции на как toowhitelist hello IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="c0511-148">[Whitelist hello Azure datacenter IP ranges](http://www.microsoft.com/en-us/download/details.aspx?id=41653) - see hello article for instructions on how toowhitelist hello IP addresses.</span></span>
* <span data-ttu-id="c0511-149">Разверните прокси-сервер HTTP для маршрутизации трафика.</span><span class="sxs-lookup"><span data-stu-id="c0511-149">Deploy an HTTP proxy server for routing traffic.</span></span>

<span data-ttu-id="c0511-150">При определении того, какой параметр toouse, компромиссы hello находятся в диапазоне от управляемость, высокий уровень контроля и затрат.</span><span class="sxs-lookup"><span data-stu-id="c0511-150">When deciding which option toouse, hello trade-offs are between manageability, granular control, and cost.</span></span>

| <span data-ttu-id="c0511-151">Параметр</span><span class="sxs-lookup"><span data-stu-id="c0511-151">Option</span></span> | <span data-ttu-id="c0511-152">Преимущества</span><span class="sxs-lookup"><span data-stu-id="c0511-152">Advantages</span></span> | <span data-ttu-id="c0511-153">Недостатки</span><span class="sxs-lookup"><span data-stu-id="c0511-153">Disadvantages</span></span> |
| --- | --- | --- |
| <span data-ttu-id="c0511-154">Разрешенные диапазоны IP-адресов</span><span class="sxs-lookup"><span data-stu-id="c0511-154">Whitelist IP ranges</span></span> |<span data-ttu-id="c0511-155">Нет дополнительных затрат.</span><span class="sxs-lookup"><span data-stu-id="c0511-155">No additional costs.</span></span><br><br><span data-ttu-id="c0511-156">Для открытия доступа в NSG, используйте hello <i>AzureNetworkSecurityRule набор</i> командлета.</span><span class="sxs-lookup"><span data-stu-id="c0511-156">For opening access in an NSG, use hello <i>Set-AzureNetworkSecurityRule</i> cmdlet.</span></span> |<span data-ttu-id="c0511-157">Сложные toomanage как диапазоны IP hello затронутые изменяются с течением времени.</span><span class="sxs-lookup"><span data-stu-id="c0511-157">Complex toomanage as hello impacted IP ranges change over time.</span></span><br><br><span data-ttu-id="c0511-158">Предоставляет доступ целиком toohello Azure, а не только хранения.</span><span class="sxs-lookup"><span data-stu-id="c0511-158">Provides access toohello whole of Azure, and not just Storage.</span></span> |
| <span data-ttu-id="c0511-159">Прокси-сервер HTTP</span><span class="sxs-lookup"><span data-stu-id="c0511-159">HTTP proxy</span></span> |<span data-ttu-id="c0511-160">Четко контролировать в прокси hello hello хранилища допускается URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="c0511-160">Granular control in hello proxy over hello storage URLs allowed.</span></span> <span data-ttu-id="c0511-161">детальный контроль toosetup в прокси hello https://\*.blob.core.windows.net/\* toobe входят требуется шаблон URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="c0511-161">toosetup granular control in hello proxy, https://\*.blob.core.windows.net/\* URL Pattern needs toobe whitelisted.</span></span> <span data-ttu-id="c0511-162">toowhitelist только hello учетной записи хранения, используемые hello виртуальной Машины, https://\<storageAccount\>.blob.core.windows.net/\* toobe входят требуется шаблон URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="c0511-162">toowhitelist only hello storage account used by hello VM, https://\<storageAccount\>.blob.core.windows.net/\* URL pattern needs toobe whitelisted.</span></span> <br><span data-ttu-id="c0511-163">Точка Интернет tooVMs доступа.</span><span class="sxs-lookup"><span data-stu-id="c0511-163">Single point of Internet access tooVMs.</span></span><br><span data-ttu-id="c0511-164">Не субъекта tooAzure изменения IP-адреса.</span><span class="sxs-lookup"><span data-stu-id="c0511-164">Not subject tooAzure IP address changes.</span></span> |<span data-ttu-id="c0511-165">Дополнительные затраты для запуска виртуальной Машины с программным обеспечением hello прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="c0511-165">Additional costs for running a VM with hello proxy software.</span></span> |

### <a name="whitelist-hello-azure-datacenter-ip-ranges"></a><span data-ttu-id="c0511-166">Диапазоны IP-адресов белого списка hello центра обработки данных Azure</span><span class="sxs-lookup"><span data-stu-id="c0511-166">Whitelist hello Azure datacenter IP ranges</span></span>
<span data-ttu-id="c0511-167">диапазоны IP-toowhitelist hello центра обработки данных Azure, см. в разделе hello [веб-сайте Azure](http://www.microsoft.com/en-us/download/details.aspx?id=41653) подробные сведения о диапазоны IP-адресов hello и инструкции.</span><span class="sxs-lookup"><span data-stu-id="c0511-167">toowhitelist hello Azure datacenter IP ranges, please see hello [Azure website](http://www.microsoft.com/en-us/download/details.aspx?id=41653) for details on hello IP ranges, and instructions.</span></span>

### <a name="using-an-http-proxy-for-vm-backups"></a><span data-ttu-id="c0511-168">Использование прокси-сервера HTTP для архивации виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="c0511-168">Using an HTTP proxy for VM backups</span></span>
<span data-ttu-id="c0511-169">При резервном копировании виртуальной Машины, hello расширение резервного копирования на hello ВМ отправляет команды управления tooAzure хранилища с помощью HTTPS API для hello моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="c0511-169">When backing up a VM, hello backup extension on hello VM sends hello snapshot management commands tooAzure Storage using an HTTPS API.</span></span> <span data-ttu-id="c0511-170">Маршрутизации трафика hello расширение резервного копирования через прокси-сервер hello HTTP, так как она является единственным компонентом hello настроен для доступа к toohello общедоступный Интернет.</span><span class="sxs-lookup"><span data-stu-id="c0511-170">Route hello backup extension traffic through hello HTTP proxy since it is hello only component configured for access toohello public Internet.</span></span>

> [!NOTE]
> <span data-ttu-id="c0511-171">Нет рекомендаций для прокси-сервера hello программного обеспечения, который следует использовать.</span><span class="sxs-lookup"><span data-stu-id="c0511-171">There is no recommendation for hello proxy software that should be used.</span></span> <span data-ttu-id="c0511-172">Убедитесь, Выбор учетной записи-посредника, имеющий исходящих stickiness и совместимый с ниже действия по настройке hello.</span><span class="sxs-lookup"><span data-stu-id="c0511-172">Ensure that you pick a proxy that has outbound stickiness and which is compatible with hello configuration steps below.</span></span> <span data-ttu-id="c0511-173">Убедитесь, что программное обеспечение сторонних производителей, не изменяйте параметры прокси-сервера hello</span><span class="sxs-lookup"><span data-stu-id="c0511-173">Make sure third party softwares do not modify hello proxy settings</span></span>
>
>

<span data-ttu-id="c0511-174">Изображение примера Hello ниже показаны шаги три конфигурации hello необходимые toouse HTTP прокси-сервера:</span><span class="sxs-lookup"><span data-stu-id="c0511-174">hello example image below shows hello three configuration steps necessary toouse an HTTP proxy:</span></span>

* <span data-ttu-id="c0511-175">Маршруты ВМ приложения привязаны весь трафик HTTP для hello общедоступный Интернет через прокси-сервера виртуальной Машины.</span><span class="sxs-lookup"><span data-stu-id="c0511-175">App VM routes all HTTP traffic bound for hello public Internet through Proxy VM.</span></span>
* <span data-ttu-id="c0511-176">Прокси-сервера виртуальной Машины позволяет входящий трафик из виртуальных машин в виртуальной сети hello.</span><span class="sxs-lookup"><span data-stu-id="c0511-176">Proxy VM allows incoming traffic from VMs in hello virtual network.</span></span>
* <span data-ttu-id="c0511-177">Hello сетевой безопасности группы (NSG) с именем денежным Покрытием блокировки должен безопасности правило разрешает исходящий Интернет-трафик от виртуальной Машины прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="c0511-177">hello Network Security Group (NSG) named NSF-lockdown needs a security rule allowing outbound Internet traffic from Proxy VM.</span></span>

![Диаграмма развертывания NSG с прокси-сервером HTTP](./media/backup-azure-vms-prepare/nsg-with-http-proxy.png)

<span data-ttu-id="c0511-179">toohello toocommunicating прокси-сервера toouse HTTP общедоступный Интернет, выполните следующие действия:</span><span class="sxs-lookup"><span data-stu-id="c0511-179">toouse an HTTP proxy toocommunicating toohello public Internet, follow these steps:</span></span>

#### <a name="step-1-configure-outgoing-network-connections"></a><span data-ttu-id="c0511-180">Шаг 1.</span><span class="sxs-lookup"><span data-stu-id="c0511-180">Step 1.</span></span> <span data-ttu-id="c0511-181">Настройка исходящих сетевых подключений</span><span class="sxs-lookup"><span data-stu-id="c0511-181">Configure outgoing network connections</span></span>
###### <a name="for-windows-machines"></a><span data-ttu-id="c0511-182">Для компьютеров Windows</span><span class="sxs-lookup"><span data-stu-id="c0511-182">For Windows machines</span></span>
<span data-ttu-id="c0511-183">Следующая процедура позволяет настроить конфигурацию прокси-сервера для учетной записи Local System.</span><span class="sxs-lookup"><span data-stu-id="c0511-183">This will setup proxy server configuration for Local System Account.</span></span>

1. <span data-ttu-id="c0511-184">Скачайте программу [PsExec](https://technet.microsoft.com/sysinternals/bb897553)</span><span class="sxs-lookup"><span data-stu-id="c0511-184">Download [PsExec](https://technet.microsoft.com/sysinternals/bb897553)</span></span>
2. <span data-ttu-id="c0511-185">Выполните следующую команду из командной строки с повышенными привилегиями:</span><span class="sxs-lookup"><span data-stu-id="c0511-185">Run following command from elevated prompt,</span></span>

     ```
     psexec -i -s "c:\Program Files\Internet Explorer\iexplore.exe"
     ```
     <span data-ttu-id="c0511-186">Откроется окно Internet Explorer.</span><span class="sxs-lookup"><span data-stu-id="c0511-186">It will open internet explorer window.</span></span>
3. <span data-ttu-id="c0511-187">Go tooTools -> Параметры Интернета -> соединения -> Параметры локальной сети.</span><span class="sxs-lookup"><span data-stu-id="c0511-187">Go tooTools -> Internet Options -> Connections -> LAN settings.</span></span>
4. <span data-ttu-id="c0511-188">Проверьте параметры прокси-сервера для системной учетной записи.</span><span class="sxs-lookup"><span data-stu-id="c0511-188">Verify proxy settings for System account.</span></span> <span data-ttu-id="c0511-189">Задайте IP-адрес прокси-сервера и порт.</span><span class="sxs-lookup"><span data-stu-id="c0511-189">Set Proxy IP and port.</span></span>
5. <span data-ttu-id="c0511-190">Закройте Internet Explorer.</span><span class="sxs-lookup"><span data-stu-id="c0511-190">Close Internet Explorer.</span></span>

<span data-ttu-id="c0511-191">В результате для компьютера будет настроен прокси-сервер, который будет использоваться для любого исходящего трафика HTTP или HTTPS.</span><span class="sxs-lookup"><span data-stu-id="c0511-191">This will set up a machine-wide proxy configuration, and will be used for any outgoing HTTP/HTTPS traffic.</span></span>

<span data-ttu-id="c0511-192">Если вы настроили прокси-сервер для текущей учетной записи пользователя (не учетной записи Local System), используйте hello следующий скрипт tooapply их tooSYSTEMACCOUNT:</span><span class="sxs-lookup"><span data-stu-id="c0511-192">If you have setup a proxy server on a current user account(not a Local System Account), use hello following script tooapply them tooSYSTEMACCOUNT:</span></span>

```
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name DefaultConnectionSettings -Value $obj.DefaultConnectionSettings
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name SavedLegacySettings -Value $obj.SavedLegacySettings
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyEnable -Value $obj.ProxyEnable
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name Proxyserver -Value $obj.Proxyserver
```

> [!NOTE]
> <span data-ttu-id="c0511-193">Если в журнале прокси-сервера отобразится сообщение "407 — Требуется проверка подлинности прокси", проверьте правильность настройки аутентификации.</span><span class="sxs-lookup"><span data-stu-id="c0511-193">If you observe "(407)Proxy Authentication Required" in proxy server log, check your authentication is setup correctly.</span></span>
>
>

###### <a name="for-linux-machines"></a><span data-ttu-id="c0511-194">Для компьютеров Linux</span><span class="sxs-lookup"><span data-stu-id="c0511-194">For Linux machines</span></span>
<span data-ttu-id="c0511-195">Добавьте следующие строки toohello hello ```/etc/environment``` файла:</span><span class="sxs-lookup"><span data-stu-id="c0511-195">Add hello following line toohello ```/etc/environment``` file:</span></span>

```
http_proxy=http://<proxy IP>:<proxy port>
```

<span data-ttu-id="c0511-196">Добавьте следующие строки toohello hello ```/etc/waagent.conf``` файла:</span><span class="sxs-lookup"><span data-stu-id="c0511-196">Add hello following lines toohello ```/etc/waagent.conf``` file:</span></span>

```
HttpProxy.Host=<proxy IP>
HttpProxy.Port=<proxy port>
```

#### <a name="step-2-allow-incoming-connections-on-hello-proxy-server"></a><span data-ttu-id="c0511-197">Шаг 2.</span><span class="sxs-lookup"><span data-stu-id="c0511-197">Step 2.</span></span> <span data-ttu-id="c0511-198">Разрешить входящие подключения на hello прокси-сервера:</span><span class="sxs-lookup"><span data-stu-id="c0511-198">Allow incoming connections on hello proxy server:</span></span>
1. <span data-ttu-id="c0511-199">На hello прокси-сервера откройте брандмауэр Windows.</span><span class="sxs-lookup"><span data-stu-id="c0511-199">On hello proxy server, open Windows Firewall.</span></span> <span data-ttu-id="c0511-200">Hello простым способом tooaccess hello брандмауэр — toosearch для брандмауэра Windows в режиме повышенной безопасности.</span><span class="sxs-lookup"><span data-stu-id="c0511-200">hello easiest way tooaccess hello firewall is toosearch for Windows Firewall with Advanced Security.</span></span>

    ![Откройте брандмауэр hello](./media/backup-azure-vms-prepare/firewall-01.png)
2. <span data-ttu-id="c0511-202">В диалоговом окне брандмауэра Windows hello, щелкните правой кнопкой мыши **правила для входящих подключений** и нажмите кнопку **новое правило...** .</span><span class="sxs-lookup"><span data-stu-id="c0511-202">In hello Windows Firewall dialog, right-click  **Inbound Rules** and click **New Rule...**.</span></span>

    ![Создание нового правила](./media/backup-azure-vms-prepare/firewall-02.png)
3. <span data-ttu-id="c0511-204">В hello **правило мастера**, выберите hello **настраиваемый** параметр для hello **тип правила** и нажмите кнопку **Далее**.</span><span class="sxs-lookup"><span data-stu-id="c0511-204">In hello **New Inbound Rule Wizard**, choose hello **Custom** option for hello **Rule Type** and click **Next**.</span></span>
4. <span data-ttu-id="c0511-205">На hello tooselect страницы приветствия **программы**, выберите **все программы** и нажмите кнопку **Далее**.</span><span class="sxs-lookup"><span data-stu-id="c0511-205">On hello page tooselect hello **Program**, choose **All Programs** and click **Next**.</span></span>
5. <span data-ttu-id="c0511-206">На hello **протокол и порты** введите hello следующую информацию и нажмите кнопку **Далее**:</span><span class="sxs-lookup"><span data-stu-id="c0511-206">On hello **Protocol and Ports** page, enter hello following information and click **Next**:</span></span>

    ![Создание нового правила](./media/backup-azure-vms-prepare/firewall-03.png)

   * <span data-ttu-id="c0511-208">Для параметра *Тип протокола* выберите *TCP*.</span><span class="sxs-lookup"><span data-stu-id="c0511-208">for *Protocol type* choose *TCP*</span></span>
   * <span data-ttu-id="c0511-209">для *локальный порт* выберите *определенные порты*, в следующее поле hello укажите hello ```<Proxy Port>``` был настроен.</span><span class="sxs-lookup"><span data-stu-id="c0511-209">for *Local port* choose *Specific Ports*, in hello field below specify hello ```<Proxy Port>``` that has been configured.</span></span>
   * <span data-ttu-id="c0511-210">В поле *Удаленный порт* выберите *Все порты*.</span><span class="sxs-lookup"><span data-stu-id="c0511-210">for *Remote port* select *All Ports*</span></span>

     <span data-ttu-id="c0511-211">REST hello приветствия мастера щелкните все завершаются toohello способом hello и укажите имя правила.</span><span class="sxs-lookup"><span data-stu-id="c0511-211">For hello rest of hello wizard, click all hello way toohello end and give this rule a name.</span></span>

#### <a name="step-3-add-an-exception-rule-toohello-nsg"></a><span data-ttu-id="c0511-212">Шаг 3.</span><span class="sxs-lookup"><span data-stu-id="c0511-212">Step 3.</span></span> <span data-ttu-id="c0511-213">Добавьте toohello правило исключения NSG.</span><span class="sxs-lookup"><span data-stu-id="c0511-213">Add an exception rule toohello NSG:</span></span>
<span data-ttu-id="c0511-214">В командной строке Azure PowerShell введите следующую команду hello:</span><span class="sxs-lookup"><span data-stu-id="c0511-214">In an Azure PowerShell command prompt, enter hello following command:</span></span>

<span data-ttu-id="c0511-215">Привет, следующая команда добавляет исключение toohello NSG.</span><span class="sxs-lookup"><span data-stu-id="c0511-215">hello following command adds an exception toohello NSG.</span></span> <span data-ttu-id="c0511-216">Это исключение позволяет входящий TCP-трафик с любого порта на 10.0.0.5 tooany Интернет-адрес для порта 80 (HTTP) или 443 (HTTPS).</span><span class="sxs-lookup"><span data-stu-id="c0511-216">This exception allows TCP traffic from any port on 10.0.0.5 tooany Internet address on port 80 (HTTP) or 443 (HTTPS).</span></span> <span data-ttu-id="c0511-217">Если требуется определенный порт в hello общедоступный Интернет быть убедиться, что tooadd, порт toohello ```-DestinationPortRange``` также.</span><span class="sxs-lookup"><span data-stu-id="c0511-217">If you require a specific port in hello public Internet, be sure tooadd that port toohello ```-DestinationPortRange``` as well.</span></span>

```
Get-AzureNetworkSecurityGroup -Name "NSG-lockdown" |
Set-AzureNetworkSecurityRule -Name "allow-proxy " -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix "10.0.0.5/32" -SourcePortRange "*" -DestinationAddressPrefix Internet -DestinationPortRange "80-443"
```

<span data-ttu-id="c0511-218">*Убедитесь, замените имена hello в примере hello hello сведения о соответствующих tooyour развертывания.*</span><span class="sxs-lookup"><span data-stu-id="c0511-218">*Ensure that you replace hello names in hello example with hello details appropriate tooyour deployment.*</span></span>

## <a name="vm-agent"></a><span data-ttu-id="c0511-219">Агент виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="c0511-219">VM agent</span></span>
<span data-ttu-id="c0511-220">Перед тем как можно архивировать hello виртуальной машины Azure, необходимо убедиться, что агент ВМ Azure, hello на виртуальной машине hello установлен правильно.</span><span class="sxs-lookup"><span data-stu-id="c0511-220">Before you can back up hello Azure virtual machine, you should ensure that hello Azure VM agent is correctly installed on hello virtual machine.</span></span> <span data-ttu-id="c0511-221">Так как агент виртуальной Машины hello созданных дополнительного компонента во время hello, hello виртуальной машины, убедитесь, установить его hello агент виртуальной Машины hello выбрано до подготовки hello виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="c0511-221">Since hello VM agent is an optional component at hello time that hello virtual machine is created, ensure that hello check box for hello VM agent is selected before hello virtual machine is provisioned.</span></span>

### <a name="manual-installation-and-update"></a><span data-ttu-id="c0511-222">Ручная установка и обновление</span><span class="sxs-lookup"><span data-stu-id="c0511-222">Manual installation and update</span></span>
<span data-ttu-id="c0511-223">агент виртуальной Машины Hello уже присутствует в виртуальных машинах, созданных на основе hello коллекции Azure.</span><span class="sxs-lookup"><span data-stu-id="c0511-223">hello VM agent is already present in VMs that are created from hello Azure gallery.</span></span> <span data-ttu-id="c0511-224">Однако виртуальные машины, которые переносятся с локальными центрами обработки данных не должны иметь установленного агента виртуальной Машины hello.</span><span class="sxs-lookup"><span data-stu-id="c0511-224">However, virtual machines that are migrated from on-premises datacenters would not have hello VM agent installed.</span></span> <span data-ttu-id="c0511-225">Для таких виртуальных машин агент ВМ hello должен toobe установлен явным образом.</span><span class="sxs-lookup"><span data-stu-id="c0511-225">For such VMs, hello VM agent needs toobe installed explicitly.</span></span> <span data-ttu-id="c0511-226">Дополнительные сведения о [Установка агента ВМ hello на существующей виртуальной Машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).</span><span class="sxs-lookup"><span data-stu-id="c0511-226">Read more about [installing hello VM agent on an existing VM](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).</span></span>

| <span data-ttu-id="c0511-227">**Операция**</span><span class="sxs-lookup"><span data-stu-id="c0511-227">**Operation**</span></span> | <span data-ttu-id="c0511-228">**Windows**</span><span class="sxs-lookup"><span data-stu-id="c0511-228">**Windows**</span></span> | <span data-ttu-id="c0511-229">**Linux**</span><span class="sxs-lookup"><span data-stu-id="c0511-229">**Linux**</span></span> |
| --- | --- | --- |
| <span data-ttu-id="c0511-230">Установка агента ВМ hello</span><span class="sxs-lookup"><span data-stu-id="c0511-230">Installing hello VM agent</span></span> |<li><span data-ttu-id="c0511-231">Загрузите и установите hello [MSI агента](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span><span class="sxs-lookup"><span data-stu-id="c0511-231">Download and install hello [agent MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span></span> <span data-ttu-id="c0511-232">Вам потребуется установки hello toocomplete права администратора.</span><span class="sxs-lookup"><span data-stu-id="c0511-232">You will need Administrator privileges toocomplete hello installation.</span></span> <li><span data-ttu-id="c0511-233">[Обновить свойства виртуальной Машины hello](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) tooindicate, hello агент установлен.</span><span class="sxs-lookup"><span data-stu-id="c0511-233">[Update hello VM property](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) tooindicate that hello agent is installed.</span></span> |<li> <span data-ttu-id="c0511-234">Установить последние hello [агент Linux](https://github.com/Azure/WALinuxAgent) из GitHub.</span><span class="sxs-lookup"><span data-stu-id="c0511-234">Install hello latest [Linux agent](https://github.com/Azure/WALinuxAgent) from GitHub.</span></span> <span data-ttu-id="c0511-235">Вам потребуется установки hello toocomplete права администратора.</span><span class="sxs-lookup"><span data-stu-id="c0511-235">You will need Administrator privileges toocomplete hello installation.</span></span> <li> <span data-ttu-id="c0511-236">[Обновить свойства виртуальной Машины hello](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) tooindicate, hello агент установлен.</span><span class="sxs-lookup"><span data-stu-id="c0511-236">[Update hello VM property](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) tooindicate that hello agent is installed.</span></span> |
| <span data-ttu-id="c0511-237">Обновление агента ВМ hello</span><span class="sxs-lookup"><span data-stu-id="c0511-237">Updating hello VM agent</span></span> |<span data-ttu-id="c0511-238">Обновление агента ВМ hello сводится переустановку hello [двоичные файлы агента виртуальной Машины](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span><span class="sxs-lookup"><span data-stu-id="c0511-238">Updating hello VM agent is as simple as reinstalling hello [VM agent binaries](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span></span> <br><br><span data-ttu-id="c0511-239">Убедитесь, что операция резервного копирования, не запущен агент виртуальной Машины hello в процессе обновления.</span><span class="sxs-lookup"><span data-stu-id="c0511-239">Ensure that no backup operation is running while hello VM agent is being updated.</span></span> |<span data-ttu-id="c0511-240">Следуйте инструкциям hello на [обновление hello агент виртуальной Машины Linux ](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="c0511-240">Follow hello instructions on [updating hello Linux VM agent ](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span></span> <br><br><span data-ttu-id="c0511-241">Убедитесь, что операция резервного копирования, не запущен агент виртуальной Машины hello в процессе обновления.</span><span class="sxs-lookup"><span data-stu-id="c0511-241">Ensure that no backup operation is running while hello VM agent is being updated.</span></span> |
| <span data-ttu-id="c0511-242">Проверка установки агента виртуальной Машины hello</span><span class="sxs-lookup"><span data-stu-id="c0511-242">Validating hello VM agent installation</span></span> |<li><span data-ttu-id="c0511-243">Перейдите toohello *C:\WindowsAzure\Packages* папки в hello виртуальной Машине Azure.</span><span class="sxs-lookup"><span data-stu-id="c0511-243">Navigate toohello *C:\WindowsAzure\Packages* folder in hello Azure VM.</span></span> <li><span data-ttu-id="c0511-244">Должен находиться файл WaAppAgent.exe hello присутствует.</span><span class="sxs-lookup"><span data-stu-id="c0511-244">You should find hello WaAppAgent.exe file present.</span></span><li> <span data-ttu-id="c0511-245">Щелкните правой кнопкой мыши файл hello, перейдите в слишком**свойства**и затем выберите hello **сведения** версия продукта hello. поле должно быть 2.6.1198.718 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="c0511-245">Right-click hello file, go too**Properties**, and then select hello **Details** tab. hello Product Version field should be 2.6.1198.718 or higher.</span></span> |<span data-ttu-id="c0511-246">Недоступно</span><span class="sxs-lookup"><span data-stu-id="c0511-246">N/A</span></span> |

<span data-ttu-id="c0511-247">Дополнительные сведения о hello [агент виртуальной Машины](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) и [как tooinstall его](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/).</span><span class="sxs-lookup"><span data-stu-id="c0511-247">Learn about hello [VM agent](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) and [how tooinstall it](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/).</span></span>

### <a name="backup-extension"></a><span data-ttu-id="c0511-248">Расширение резервного копирования</span><span class="sxs-lookup"><span data-stu-id="c0511-248">Backup extension</span></span>
<span data-ttu-id="c0511-249">tooback hello виртуальной машины hello службы архивации Azure устанавливает агент ВМ toohello расширения.</span><span class="sxs-lookup"><span data-stu-id="c0511-249">tooback up hello virtual machine, hello Azure Backup service installs an extension toohello VM agent.</span></span> <span data-ttu-id="c0511-250">Hello службы резервного копирования Azure легко обновления и исправления hello расширение резервного копирования без дополнительного вмешательства пользователя.</span><span class="sxs-lookup"><span data-stu-id="c0511-250">hello Azure Backup service seamlessly upgrades and patches hello backup extension without additional user intervention.</span></span>

<span data-ttu-id="c0511-251">расширение резервного копирования Hello устанавливается в том случае, если выполняется hello виртуальной Машины.</span><span class="sxs-lookup"><span data-stu-id="c0511-251">hello backup extension is installed if hello VM is running.</span></span> <span data-ttu-id="c0511-252">Работающей виртуальной Машины также предоставляет hello наибольшую вероятность нахождения точки восстановления, согласованные с приложениями.</span><span class="sxs-lookup"><span data-stu-id="c0511-252">A running VM also provides hello greatest chance of getting an application-consistent recovery point.</span></span> <span data-ttu-id="c0511-253">Однако hello Azure Backup будет продолжать работу службы tooback копирование hello виртуальной Машины — даже в том случае, если он был отключен, и расширение hello не может быть установлен (также называемого автономной виртуальной Машины).</span><span class="sxs-lookup"><span data-stu-id="c0511-253">However, hello Azure Backup service will continue tooback up hello VM--even if it is turned off, and hello extension could not be installed (aka Offline VM).</span></span> <span data-ttu-id="c0511-254">В этом случае hello точка восстановления будет *сбоям* как описано выше.</span><span class="sxs-lookup"><span data-stu-id="c0511-254">In this case, hello recovery point will be *crash consistent* as discussed above.</span></span>

## <a name="questions"></a><span data-ttu-id="c0511-255">Вопросы?</span><span class="sxs-lookup"><span data-stu-id="c0511-255">Questions?</span></span>
<span data-ttu-id="c0511-256">Если у вас есть вопросы или при наличии любой возможности, хотелось бы включены, toosee [отправить отзыв](http://aka.ms/azurebackup_feedback).</span><span class="sxs-lookup"><span data-stu-id="c0511-256">If you have questions, or if there is any feature that you would like toosee included, [send us feedback](http://aka.ms/azurebackup_feedback).</span></span>

## <a name="next-steps"></a><span data-ttu-id="c0511-257">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="c0511-257">Next steps</span></span>
<span data-ttu-id="c0511-258">Теперь, когда вы подготовили среду для резервного копирования виртуальной Машины, логические следующим шагом является toocreate резервной копии.</span><span class="sxs-lookup"><span data-stu-id="c0511-258">Now that you have prepared your environment for backing up your VM, your next logical step is toocreate a backup.</span></span> <span data-ttu-id="c0511-259">Планирование статьи Hello содержатся более подробные сведения о резервном копировании виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="c0511-259">hello planning article provides more detailed information about backing up VMs.</span></span>

* [<span data-ttu-id="c0511-260">Настройка виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="c0511-260">Back up virtual machines</span></span>](backup-azure-vms.md)
* [<span data-ttu-id="c0511-261">Планирование инфраструктуры резервного копирования виртуальных машин в Azure</span><span class="sxs-lookup"><span data-stu-id="c0511-261">Plan your VM backup infrastructure</span></span>](backup-azure-vms-introduction.md)
* [<span data-ttu-id="c0511-262">Управление резервными копиями виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="c0511-262">Manage virtual machine backups</span></span>](backup-azure-manage-vms.md)

---
title: "Подготовка среды для архивации виртуальных машин Azure | Документация Майкрософт"
description: "Убедитесь, что ваша среда подготовлена для резервного копирования виртуальных машин в Azure."
services: backup
documentationcenter: 
author: markgalioto
manager: carmonn
editor: 
keywords: "резервные копии; резервное копирование;"
ms.assetid: 238ab93b-8acc-4262-81b7-ce930f76a662
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 4/25/2017
ms.author: markgal;trinadhk;
ms.openlocfilehash: 072efdccaa8df5d430314d753a437b524986b53c
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="prepare-your-environment-to-back-up-azure-virtual-machines"></a><span data-ttu-id="97c5a-104">Подготовка среды для резервного копирования виртуальных машин Azure</span><span class="sxs-lookup"><span data-stu-id="97c5a-104">Prepare your environment to back up Azure virtual machines</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="97c5a-105">Модель Resource Manager</span><span class="sxs-lookup"><span data-stu-id="97c5a-105">Resource Manager model</span></span>](backup-azure-arm-vms-prepare.md)
> * [<span data-ttu-id="97c5a-106">Классическая модель</span><span class="sxs-lookup"><span data-stu-id="97c5a-106">Classic model</span></span>](backup-azure-vms-prepare.md)
>
>

<span data-ttu-id="97c5a-107">Прежде чем можно будет выполнять резервное копирование виртуальной машины Azure, необходимо обеспечить выполнение трех условий:</span><span class="sxs-lookup"><span data-stu-id="97c5a-107">Before you can back up an Azure virtual machine (VM), there are three conditions that must exist.</span></span>

* <span data-ttu-id="97c5a-108">Создайте хранилище архивации или найдите имеющееся хранилище архивации *в том же регионе, что и виртуальная машина*.</span><span class="sxs-lookup"><span data-stu-id="97c5a-108">You need to create a backup vault or identify an existing backup vault *in the same region as your VM*.</span></span>
* <span data-ttu-id="97c5a-109">Установить сетевое подключение между общедоступными IP-адресами Azure и конечными точками хранилища Azure.</span><span class="sxs-lookup"><span data-stu-id="97c5a-109">Establish network connectivity between the Azure public Internet addresses and the Azure storage endpoints.</span></span>
* <span data-ttu-id="97c5a-110">Установить агент виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="97c5a-110">Install the VM agent on the VM.</span></span>

<span data-ttu-id="97c5a-111">Если вы знаете, что эти условия в вашей среде уже выполнены, переходите к статье [Резервное копирование виртуальных машин](backup-azure-vms.md).</span><span class="sxs-lookup"><span data-stu-id="97c5a-111">If you know these conditions already exist in your environment then proceed to the [Back up your VMs article](backup-azure-vms.md).</span></span> <span data-ttu-id="97c5a-112">Если это не так, подготовьте среду к резервному копированию виртуальной машины Azure, как описано в этой статье.</span><span class="sxs-lookup"><span data-stu-id="97c5a-112">Otherwise, read on, this article will lead you through the steps to prepare your environment to back up an Azure VM.</span></span>

##<a name="supported-operating-system-for-backup"></a><span data-ttu-id="97c5a-113">Поддерживаемые версии операционных систем для архивации</span><span class="sxs-lookup"><span data-stu-id="97c5a-113">Supported operating system for backup</span></span>
 * <span data-ttu-id="97c5a-114">**Linux**: служба архивации Azure поддерживает весь [список дистрибутивов, рекомендуемых для использования в Azure](../virtual-machines/linux/endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) , за исключением CoreOS Linux.</span><span class="sxs-lookup"><span data-stu-id="97c5a-114">**Linux**: Azure Backup supports [a list of distributions that are endorsed by Azure](../virtual-machines/linux/endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) except Core OS Linux.</span></span> <span data-ttu-id="97c5a-115">_Другие собственные дистрибутивы Linux также должны работать, если агент виртуальной машины доступен на виртуальной машине и есть поддержка Python. Тем не менее мы не поддерживаем использование этих дистрибутивов для архивации._</span><span class="sxs-lookup"><span data-stu-id="97c5a-115">_Other Bring-Your-Own-Linux distributions also might work as long as the VM agent is available on the virtual machine and support for Python exists. However, we do not endorse those distributions for backup._</span></span>
 * <span data-ttu-id="97c5a-116">**Windows Server**: версии до Windows Server 2008 R2 не поддерживаются.</span><span class="sxs-lookup"><span data-stu-id="97c5a-116">**Windows Server**:  Versions older than Windows Server 2008 R2 are not supported.</span></span>


## <a name="limitations-when-backing-up-and-restoring-a-vm"></a><span data-ttu-id="97c5a-117">Ограничения при резервном копировании и восстановлении виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="97c5a-117">Limitations when backing up and restoring a VM</span></span>
> [!NOTE]
> <span data-ttu-id="97c5a-118">В Azure предусмотрены две модели развертывания, позволяющие создавать ресурсы и работать с ними: [модель Resource Manager и классическая модель](../azure-resource-manager/resource-manager-deployment-model.md).</span><span class="sxs-lookup"><span data-stu-id="97c5a-118">Azure has two deployment models for creating and working with resources: [Resource Manager and classic](../azure-resource-manager/resource-manager-deployment-model.md).</span></span> <span data-ttu-id="97c5a-119">При развертывании по классической модели действуют следующие ограничения.</span><span class="sxs-lookup"><span data-stu-id="97c5a-119">The following list provides the limitations when deploying in the classic model.</span></span>
>
>

* <span data-ttu-id="97c5a-120">Архивация виртуальных машин, к которым подключено более 16 дисков данных, не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="97c5a-120">Backing up virtual machines with more than 16 data disks is not supported.</span></span>
* <span data-ttu-id="97c5a-121">Архивация виртуальных машин с зарезервированным IP-адресом и без заданной конечной точки не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="97c5a-121">Backing up virtual machines with a reserved IP address and no defined endpoint is not supported.</span></span>
* <span data-ttu-id="97c5a-122">Данные архивации не содержат установленные в сети диски, подключенные к виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="97c5a-122">Backup data doesn't include network mounted drives attached to VM.</span></span>
* <span data-ttu-id="97c5a-123">Замена существующей виртуальной машины во время восстановления не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="97c5a-123">Replacing an existing virtual machine during restore is not supported.</span></span> <span data-ttu-id="97c5a-124">Сначала необходимо удалить существующую виртуальную машину и все связанные диски, а затем восстановить данные из резервной копии.</span><span class="sxs-lookup"><span data-stu-id="97c5a-124">First delete the existing virtual machine and any associated disks, and then restore the data from backup.</span></span>
* <span data-ttu-id="97c5a-125">Резервное копирования и восстановление между регионами не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="97c5a-125">Cross-region backup and restore is not supported.</span></span>
* <span data-ttu-id="97c5a-126">Архивация виртуальных машин с помощью службы архивации Azure поддерживается во всех областях, общих для Azure (см. [контрольный список](https://azure.microsoft.com/regions/#services) поддерживаемых регионов).</span><span class="sxs-lookup"><span data-stu-id="97c5a-126">Backing up virtual machines by using the Azure Backup service is supported in all public regions of Azure (see the [checklist](https://azure.microsoft.com/regions/#services) of supported regions).</span></span> <span data-ttu-id="97c5a-127">Если искомый регион в настоящее время не поддерживается, он будет отсутствовать в раскрывающемся списке при создании хранилища.</span><span class="sxs-lookup"><span data-stu-id="97c5a-127">If the region that you are looking for is unsupported today, it will not appear in the dropdown list during vault creation.</span></span>
* <span data-ttu-id="97c5a-128">Архивация виртуальных машин с помощью службы архивации Azure поддерживается только в определенных версиях операционных систем:</span><span class="sxs-lookup"><span data-stu-id="97c5a-128">Backing up virtual machines by using the Azure Backup service is supported only for select operating system versions:</span></span>
* <span data-ttu-id="97c5a-129">Восстановление контроллера домена виртуальной машины, которая входит в конфигурацию с несколькими контроллерами домена, поддерживается только с помощью PowerShell.</span><span class="sxs-lookup"><span data-stu-id="97c5a-129">Restoring a domain controller (DC) VM that is part of a multi-DC configuration is supported only through PowerShell.</span></span> <span data-ttu-id="97c5a-130">Дополнительные сведения о [восстановлении контроллера домена в конфигурации с несколькими контроллерами домена](backup-azure-restore-vms.md#restoring-domain-controller-vms).</span><span class="sxs-lookup"><span data-stu-id="97c5a-130">Read more about [restoring a multi-DC domain controller](backup-azure-restore-vms.md#restoring-domain-controller-vms).</span></span>
* <span data-ttu-id="97c5a-131">Восстановление виртуальных машин с описанными ниже особыми конфигурациями сети поддерживается только в PowerShell.</span><span class="sxs-lookup"><span data-stu-id="97c5a-131">Restoring virtual machines that have the following special network configurations is supported only through PowerShell.</span></span> <span data-ttu-id="97c5a-132">Когда процедура восстановления будет завершена, виртуальные машины, созданные в пользовательском интерфейсе с помощью рабочего процесса восстановления, не будут включать эти конфигурации сети.</span><span class="sxs-lookup"><span data-stu-id="97c5a-132">VMs that you create by using the restore workflow in the UI will not have these network configurations after the restore operation is complete.</span></span> <span data-ttu-id="97c5a-133">Дополнительные сведения см. в разделе [Восстановление виртуальных машин с помощью специальных конфигураций сети](backup-azure-restore-vms.md#restoring-vms-with-special-network-configurations).</span><span class="sxs-lookup"><span data-stu-id="97c5a-133">To learn more, see [Restoring VMs with special network configurations](backup-azure-restore-vms.md#restoring-vms-with-special-network-configurations).</span></span>
  * <span data-ttu-id="97c5a-134">Виртуальные машины в конфигурации балансировщика нагрузки (внутренняя и внешняя)</span><span class="sxs-lookup"><span data-stu-id="97c5a-134">Virtual machines under load balancer configuration (internal and external)</span></span>
  * <span data-ttu-id="97c5a-135">Виртуальные машины с несколькими зарезервированными IP-адресами</span><span class="sxs-lookup"><span data-stu-id="97c5a-135">Virtual machines with multiple reserved IP addresses</span></span>
  * <span data-ttu-id="97c5a-136">Виртуальные машины с несколькими сетевыми адаптерами</span><span class="sxs-lookup"><span data-stu-id="97c5a-136">Virtual machines with multiple network adapters</span></span>

## <a name="create-a-backup-vault-for-a-vm"></a><span data-ttu-id="97c5a-137">Создание хранилища архивации для виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="97c5a-137">Create a backup vault for a VM</span></span>
<span data-ttu-id="97c5a-138">Хранилище архивации — это сущность, в которой хранятся созданные резервные копии и точки восстановления.</span><span class="sxs-lookup"><span data-stu-id="97c5a-138">A backup vault is an entity that stores all the backups and recovery points that have been created over time.</span></span> <span data-ttu-id="97c5a-139">Хранилище архивации также содержит политики резервного копирования, применяемые к виртуальным машинам, для которых настроена архивация.</span><span class="sxs-lookup"><span data-stu-id="97c5a-139">The backup vault also contains the backup policies that will be applied to the virtual machines being backed up.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="97c5a-140">Начиная с марта 2017 года классический портал больше нельзя использовать для создания хранилищ службы архивации.</span><span class="sxs-lookup"><span data-stu-id="97c5a-140">Starting March 2017, you can no longer use the classic portal to create Backup vaults.</span></span> <span data-ttu-id="97c5a-141">Имеющиеся хранилища службы архивации по-прежнему поддерживаются. Вы также [можете использовать Azure PowerShell, чтобы создать новые](./backup-client-automation-classic.md#create-a-backup-vault).</span><span class="sxs-lookup"><span data-stu-id="97c5a-141">Existing Backup vaults are still supported, and it is possible to [use Azure PowerShell to create Backup vaults](./backup-client-automation-classic.md#create-a-backup-vault).</span></span> <span data-ttu-id="97c5a-142">Однако мы советуем создавать хранилища служб восстановления для всех развертываний, так как все новые улучшения будут применяться только к этим хранилищам.</span><span class="sxs-lookup"><span data-stu-id="97c5a-142">However, Microsoft recommends you create Recovery Services vaults for all deployments because future enhancements apply to Recovery Services vaults, only.</span></span>


<span data-ttu-id="97c5a-143">На рисунке ниже показаны связи между разными сущностями службы архивации Azure: ![Сущности и связи службы архивации Azure](./media/backup-azure-vms-prepare/vault-policy-vm.png).</span><span class="sxs-lookup"><span data-stu-id="97c5a-143">This image shows the relationships between the various Azure Backup entities: ![Azure Backup entities and relationships](./media/backup-azure-vms-prepare/vault-policy-vm.png)</span></span>



## <a name="network-connectivity"></a><span data-ttu-id="97c5a-144">Сетевое подключение</span><span class="sxs-lookup"><span data-stu-id="97c5a-144">Network connectivity</span></span>
<span data-ttu-id="97c5a-145">Чтобы управлять моментальными снимками виртуальной машины, для расширения архивации требуется подключение к общедоступным IP-адресам Azure.</span><span class="sxs-lookup"><span data-stu-id="97c5a-145">In order to manage the VM snapshots, the backup extension needs connectivity to the Azure public IP addresses.</span></span> <span data-ttu-id="97c5a-146">Без правильного подключения к Интернету время ожидания HTTP-запросов от виртуальной машины истекает, а архивация завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="97c5a-146">Without the right Internet connectivity, the virtual machine's HTTP requests time out and the backup operation fails.</span></span> <span data-ttu-id="97c5a-147">Если для развертывания установлены ограничения доступа на месте, например, через группу безопасности сети (NSG), выберите один из следующих вариантов, чтобы открыть путь для трафика архивации:</span><span class="sxs-lookup"><span data-stu-id="97c5a-147">If your deployment has access restrictions in place (through a network security group (NSG), for example), then choose one of these options for providing a clear path for backup traffic:</span></span>

* <span data-ttu-id="97c5a-148">[Добавьте диапазоны IP-адресов центра обработки данных Azure в список разрешений](http://www.microsoft.com/en-us/download/details.aspx?id=41653). В статье вы найдете указания по добавлению IP-адресов в список разрешений.</span><span class="sxs-lookup"><span data-stu-id="97c5a-148">[Whitelist the Azure datacenter IP ranges](http://www.microsoft.com/en-us/download/details.aspx?id=41653) - see the article for instructions on how to whitelist the IP addresses.</span></span>
* <span data-ttu-id="97c5a-149">Разверните прокси-сервер HTTP для маршрутизации трафика.</span><span class="sxs-lookup"><span data-stu-id="97c5a-149">Deploy an HTTP proxy server for routing traffic.</span></span>

<span data-ttu-id="97c5a-150">Решая, какой вариант использовать, обратите внимание на соотношение управляемости, детального управления и затрат.</span><span class="sxs-lookup"><span data-stu-id="97c5a-150">When deciding which option to use, the trade-offs are between manageability, granular control, and cost.</span></span>

| <span data-ttu-id="97c5a-151">Параметр</span><span class="sxs-lookup"><span data-stu-id="97c5a-151">Option</span></span> | <span data-ttu-id="97c5a-152">Преимущества</span><span class="sxs-lookup"><span data-stu-id="97c5a-152">Advantages</span></span> | <span data-ttu-id="97c5a-153">Недостатки</span><span class="sxs-lookup"><span data-stu-id="97c5a-153">Disadvantages</span></span> |
| --- | --- | --- |
| <span data-ttu-id="97c5a-154">Разрешенные диапазоны IP-адресов</span><span class="sxs-lookup"><span data-stu-id="97c5a-154">Whitelist IP ranges</span></span> |<span data-ttu-id="97c5a-155">Нет дополнительных затрат.</span><span class="sxs-lookup"><span data-stu-id="97c5a-155">No additional costs.</span></span><br><br><span data-ttu-id="97c5a-156">Нет дополнительных затрат. Открыть доступ в NSG можно с помощью командлета <i>Set-AzureNetworkSecurityRule</i>.</span><span class="sxs-lookup"><span data-stu-id="97c5a-156">For opening access in an NSG, use the <i>Set-AzureNetworkSecurityRule</i> cmdlet.</span></span> |<span data-ttu-id="97c5a-157">Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются.</span><span class="sxs-lookup"><span data-stu-id="97c5a-157">Complex to manage as the impacted IP ranges change over time.</span></span><br><br><span data-ttu-id="97c5a-158">Доступ ко всей службе Azure, а не только к хранилищу.</span><span class="sxs-lookup"><span data-stu-id="97c5a-158">Provides access to the whole of Azure, and not just Storage.</span></span> |
| <span data-ttu-id="97c5a-159">Прокси-сервер HTTP</span><span class="sxs-lookup"><span data-stu-id="97c5a-159">HTTP proxy</span></span> |<span data-ttu-id="97c5a-160">Точное управление разрешенными URL-адресами хранилища в прокси-сервере.</span><span class="sxs-lookup"><span data-stu-id="97c5a-160">Granular control in the proxy over the storage URLs allowed.</span></span> <span data-ttu-id="97c5a-161">Чтобы настроить детальное управление на прокси-сервере, нужно внести шаблон URL-адреса https://\*.blob.core.windows.net/\* в список разрешений.</span><span class="sxs-lookup"><span data-stu-id="97c5a-161">To setup granular control in the proxy, https://\*.blob.core.windows.net/\* URL Pattern needs to be whitelisted.</span></span> <span data-ttu-id="97c5a-162">Чтобы разрешить только учетную запись, используемую виртуальной машиной, нужно внести шаблон URL-адреса https://\<storageAccount\>.blob.core.windows.net/\* в список разрешений.</span><span class="sxs-lookup"><span data-stu-id="97c5a-162">To whitelist only the storage account used by the VM, https://\<storageAccount\>.blob.core.windows.net/\* URL pattern needs to be whitelisted.</span></span> <br><span data-ttu-id="97c5a-163">Единая точка доступа к виртуальным машинам через Интернет.</span><span class="sxs-lookup"><span data-stu-id="97c5a-163">Single point of Internet access to VMs.</span></span><br><span data-ttu-id="97c5a-164">Не подвергается влиянию изменений IP-адресов Azure.</span><span class="sxs-lookup"><span data-stu-id="97c5a-164">Not subject to Azure IP address changes.</span></span> |<span data-ttu-id="97c5a-165">Дополнительные затраты для работы виртуальной машины с программным обеспечением прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="97c5a-165">Additional costs for running a VM with the proxy software.</span></span> |

### <a name="whitelist-the-azure-datacenter-ip-ranges"></a><span data-ttu-id="97c5a-166">Добавьте диапазоны IP-адресов центра обработки данных Azure в список разрешений.</span><span class="sxs-lookup"><span data-stu-id="97c5a-166">Whitelist the Azure datacenter IP ranges</span></span>
<span data-ttu-id="97c5a-167">Чтобы добавить диапазоны IP-адресов центра обработки данных Azure в список разрешений, ознакомьтесь с дополнительными сведениями о диапазонах IP-адресов и указаниями на [веб-сайте Azure](http://www.microsoft.com/en-us/download/details.aspx?id=41653) .</span><span class="sxs-lookup"><span data-stu-id="97c5a-167">To whitelist the Azure datacenter IP ranges, please see the [Azure website](http://www.microsoft.com/en-us/download/details.aspx?id=41653) for details on the IP ranges, and instructions.</span></span>

### <a name="using-an-http-proxy-for-vm-backups"></a><span data-ttu-id="97c5a-168">Использование прокси-сервера HTTP для архивации виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="97c5a-168">Using an HTTP proxy for VM backups</span></span>
<span data-ttu-id="97c5a-169">Во время архивации виртуальных машин команды управления моментальными снимками отправляются из расширения архивации в службу хранилища Azure с помощью API HTTPS.</span><span class="sxs-lookup"><span data-stu-id="97c5a-169">When backing up a VM, the backup extension on the VM sends the snapshot management commands to Azure Storage using an HTTPS API.</span></span> <span data-ttu-id="97c5a-170">Направьте трафик расширения архивации через прокси-сервер HTTP, потому что это единственный компонент, который настроен для общего доступа в Интернете.</span><span class="sxs-lookup"><span data-stu-id="97c5a-170">Route the backup extension traffic through the HTTP proxy since it is the only component configured for access to the public Internet.</span></span>

> [!NOTE]
> <span data-ttu-id="97c5a-171">Особых требований к программному обеспечению нет.</span><span class="sxs-lookup"><span data-stu-id="97c5a-171">There is no recommendation for the proxy software that should be used.</span></span> <span data-ttu-id="97c5a-172">Убедитесь, что вы выбрали прокси-сервер с закреплением исходящего трафика, который можно использовать в приведенных ниже шагах конфигурации.</span><span class="sxs-lookup"><span data-stu-id="97c5a-172">Ensure that you pick a proxy that has outbound stickiness and which is compatible with the configuration steps below.</span></span> <span data-ttu-id="97c5a-173">Убедитесь, что сторонние программы не изменяют настройки прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="97c5a-173">Make sure third party softwares do not modify the proxy settings</span></span>
>
>

<span data-ttu-id="97c5a-174">На приведенном ниже изображении показан пример трех этапов настройки, которые необходимо выполнить, чтобы использовать прокси-сервер HTTP:</span><span class="sxs-lookup"><span data-stu-id="97c5a-174">The example image below shows the three configuration steps necessary to use an HTTP proxy:</span></span>

* <span data-ttu-id="97c5a-175">Виртуальная машина приложения направляет весь HTTP-трафик для общего доступа в Интернете через виртуальную машину прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="97c5a-175">App VM routes all HTTP traffic bound for the public Internet through Proxy VM.</span></span>
* <span data-ttu-id="97c5a-176">В виртуальной машине прокси-сервера разрешен входящий трафик от виртуальных машин в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="97c5a-176">Proxy VM allows incoming traffic from VMs in the virtual network.</span></span>
* <span data-ttu-id="97c5a-177">Для группы безопасности сети с именем NSF-lockdown требуется правило безопасности, которое разрешает передачу интернет-трафика из виртуальной машины прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="97c5a-177">The Network Security Group (NSG) named NSF-lockdown needs a security rule allowing outbound Internet traffic from Proxy VM.</span></span>

![Диаграмма развертывания NSG с прокси-сервером HTTP](./media/backup-azure-vms-prepare/nsg-with-http-proxy.png)

<span data-ttu-id="97c5a-179">Чтобы использовать прокси-сервер HTTP для обмена данными для общего доступа в Интернете, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="97c5a-179">To use an HTTP proxy to communicating to the public Internet, follow these steps:</span></span>

#### <a name="step-1-configure-outgoing-network-connections"></a><span data-ttu-id="97c5a-180">Шаг 1.</span><span class="sxs-lookup"><span data-stu-id="97c5a-180">Step 1.</span></span> <span data-ttu-id="97c5a-181">Настройка исходящих сетевых подключений</span><span class="sxs-lookup"><span data-stu-id="97c5a-181">Configure outgoing network connections</span></span>
###### <a name="for-windows-machines"></a><span data-ttu-id="97c5a-182">Для компьютеров Windows</span><span class="sxs-lookup"><span data-stu-id="97c5a-182">For Windows machines</span></span>
<span data-ttu-id="97c5a-183">Следующая процедура позволяет настроить конфигурацию прокси-сервера для учетной записи Local System.</span><span class="sxs-lookup"><span data-stu-id="97c5a-183">This will setup proxy server configuration for Local System Account.</span></span>

1. <span data-ttu-id="97c5a-184">Скачайте программу [PsExec](https://technet.microsoft.com/sysinternals/bb897553)</span><span class="sxs-lookup"><span data-stu-id="97c5a-184">Download [PsExec](https://technet.microsoft.com/sysinternals/bb897553)</span></span>
2. <span data-ttu-id="97c5a-185">Выполните следующую команду из командной строки с повышенными привилегиями:</span><span class="sxs-lookup"><span data-stu-id="97c5a-185">Run following command from elevated prompt,</span></span>

     ```
     psexec -i -s "c:\Program Files\Internet Explorer\iexplore.exe"
     ```
     <span data-ttu-id="97c5a-186">Откроется окно Internet Explorer.</span><span class="sxs-lookup"><span data-stu-id="97c5a-186">It will open internet explorer window.</span></span>
3. <span data-ttu-id="97c5a-187">Последовательно выберите "Сервис -> Свойства обозревателя -> Подключения -> Настройка сети".</span><span class="sxs-lookup"><span data-stu-id="97c5a-187">Go to Tools -> Internet Options -> Connections -> LAN settings.</span></span>
4. <span data-ttu-id="97c5a-188">Проверьте параметры прокси-сервера для системной учетной записи.</span><span class="sxs-lookup"><span data-stu-id="97c5a-188">Verify proxy settings for System account.</span></span> <span data-ttu-id="97c5a-189">Задайте IP-адрес прокси-сервера и порт.</span><span class="sxs-lookup"><span data-stu-id="97c5a-189">Set Proxy IP and port.</span></span>
5. <span data-ttu-id="97c5a-190">Закройте Internet Explorer.</span><span class="sxs-lookup"><span data-stu-id="97c5a-190">Close Internet Explorer.</span></span>

<span data-ttu-id="97c5a-191">В результате для компьютера будет настроен прокси-сервер, который будет использоваться для любого исходящего трафика HTTP или HTTPS.</span><span class="sxs-lookup"><span data-stu-id="97c5a-191">This will set up a machine-wide proxy configuration, and will be used for any outgoing HTTP/HTTPS traffic.</span></span>

<span data-ttu-id="97c5a-192">Если вы настроили прокси-сервер из текущей учетной записи пользователя, а не учетной записи Local System, используйте следующий сценарий для применения к SYSTEMACCOUNT:</span><span class="sxs-lookup"><span data-stu-id="97c5a-192">If you have setup a proxy server on a current user account(not a Local System Account), use the following script to apply them to SYSTEMACCOUNT:</span></span>

```
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name DefaultConnectionSettings -Value $obj.DefaultConnectionSettings
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name SavedLegacySettings -Value $obj.SavedLegacySettings
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyEnable -Value $obj.ProxyEnable
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name Proxyserver -Value $obj.Proxyserver
```

> [!NOTE]
> <span data-ttu-id="97c5a-193">Если в журнале прокси-сервера отобразится сообщение "407 — Требуется проверка подлинности прокси", проверьте правильность настройки аутентификации.</span><span class="sxs-lookup"><span data-stu-id="97c5a-193">If you observe "(407)Proxy Authentication Required" in proxy server log, check your authentication is setup correctly.</span></span>
>
>

###### <a name="for-linux-machines"></a><span data-ttu-id="97c5a-194">Для компьютеров Linux</span><span class="sxs-lookup"><span data-stu-id="97c5a-194">For Linux machines</span></span>
<span data-ttu-id="97c5a-195">Добавьте следующую строку в файл ```/etc/environment``` :</span><span class="sxs-lookup"><span data-stu-id="97c5a-195">Add the following line to the ```/etc/environment``` file:</span></span>

```
http_proxy=http://<proxy IP>:<proxy port>
```

<span data-ttu-id="97c5a-196">Добавьте следующие строки в файл ```/etc/waagent.conf``` :</span><span class="sxs-lookup"><span data-stu-id="97c5a-196">Add the following lines to the ```/etc/waagent.conf``` file:</span></span>

```
HttpProxy.Host=<proxy IP>
HttpProxy.Port=<proxy port>
```

#### <a name="step-2-allow-incoming-connections-on-the-proxy-server"></a><span data-ttu-id="97c5a-197">Шаг 2.</span><span class="sxs-lookup"><span data-stu-id="97c5a-197">Step 2.</span></span> <span data-ttu-id="97c5a-198">Разрешение входящих подключений на прокси-сервере</span><span class="sxs-lookup"><span data-stu-id="97c5a-198">Allow incoming connections on the proxy server:</span></span>
1. <span data-ttu-id="97c5a-199">Откройте брандмауэр Windows на прокси-сервере.</span><span class="sxs-lookup"><span data-stu-id="97c5a-199">On the proxy server, open Windows Firewall.</span></span> <span data-ttu-id="97c5a-200">Самый простой способ доступа к брандмауэру — это поиск брандмауэра Windows в режиме повышенной безопасности.</span><span class="sxs-lookup"><span data-stu-id="97c5a-200">The easiest way to access the firewall is to search for Windows Firewall with Advanced Security.</span></span>

    ![Открытие брандмауэра](./media/backup-azure-vms-prepare/firewall-01.png)
2. <span data-ttu-id="97c5a-202">В диалоговом окне брандмауэра Windows щелкните правой кнопкой мыши **Правила для входящих подключений** и выберите **Создать правило**.</span><span class="sxs-lookup"><span data-stu-id="97c5a-202">In the Windows Firewall dialog, right-click  **Inbound Rules** and click **New Rule...**.</span></span>

    ![Создание нового правила](./media/backup-azure-vms-prepare/firewall-02.png)
3. <span data-ttu-id="97c5a-204">В **мастере создания правила для нового входящего подключения** выберите значение **Настраиваемое** для параметра **Тип правила** и нажмите кнопку **Далее**.</span><span class="sxs-lookup"><span data-stu-id="97c5a-204">In the **New Inbound Rule Wizard**, choose the **Custom** option for the **Rule Type** and click **Next**.</span></span>
4. <span data-ttu-id="97c5a-205">Чтобы выбрать **программу**, щелкните элемент **Все программы** и нажмите кнопку **Далее**.</span><span class="sxs-lookup"><span data-stu-id="97c5a-205">On the page to select the **Program**, choose **All Programs** and click **Next**.</span></span>
5. <span data-ttu-id="97c5a-206">На странице **Протокол и порты** введите следующие сведения и нажмите кнопку **Далее**.</span><span class="sxs-lookup"><span data-stu-id="97c5a-206">On the **Protocol and Ports** page, enter the following information and click **Next**:</span></span>

    ![Создание нового правила](./media/backup-azure-vms-prepare/firewall-03.png)

   * <span data-ttu-id="97c5a-208">Для параметра *Тип протокола* выберите *TCP*.</span><span class="sxs-lookup"><span data-stu-id="97c5a-208">for *Protocol type* choose *TCP*</span></span>
   * <span data-ttu-id="97c5a-209">В поле *Локальный порт* выберите *Определенные порты*, а в поле под ним укажите уже настроенный порт ```<Proxy Port>```.</span><span class="sxs-lookup"><span data-stu-id="97c5a-209">for *Local port* choose *Specific Ports*, in the field below specify the ```<Proxy Port>``` that has been configured.</span></span>
   * <span data-ttu-id="97c5a-210">В поле *Удаленный порт* выберите *Все порты*.</span><span class="sxs-lookup"><span data-stu-id="97c5a-210">for *Remote port* select *All Ports*</span></span>

     <span data-ttu-id="97c5a-211">Выполните все инструкции мастера и укажите имя правила.</span><span class="sxs-lookup"><span data-stu-id="97c5a-211">For the rest of the wizard, click all the way to the end and give this rule a name.</span></span>

#### <a name="step-3-add-an-exception-rule-to-the-nsg"></a><span data-ttu-id="97c5a-212">Шаг 3.</span><span class="sxs-lookup"><span data-stu-id="97c5a-212">Step 3.</span></span> <span data-ttu-id="97c5a-213">Добавление правила исключения к группе NSG</span><span class="sxs-lookup"><span data-stu-id="97c5a-213">Add an exception rule to the NSG:</span></span>
<span data-ttu-id="97c5a-214">Введите следующую команду в командной строке Azure PowerShell:</span><span class="sxs-lookup"><span data-stu-id="97c5a-214">In an Azure PowerShell command prompt, enter the following command:</span></span>

<span data-ttu-id="97c5a-215">Она добавляет исключение к группе NSG.</span><span class="sxs-lookup"><span data-stu-id="97c5a-215">The following command adds an exception to the NSG.</span></span> <span data-ttu-id="97c5a-216">Это исключение разрешает TCP-трафик из любого порта на сервере 10.0.0.5 на любой адрес в Интернете по порту 80 (HTTP) или 443 (HTTPS).</span><span class="sxs-lookup"><span data-stu-id="97c5a-216">This exception allows TCP traffic from any port on 10.0.0.5 to any Internet address on port 80 (HTTP) or 443 (HTTPS).</span></span> <span data-ttu-id="97c5a-217">Если вам необходимо разрешить общий доступ из Интернета к какому-либо порту, добавьте этот порт в параметр ```-DestinationPortRange``` .</span><span class="sxs-lookup"><span data-stu-id="97c5a-217">If you require a specific port in the public Internet, be sure to add that port to the ```-DestinationPortRange``` as well.</span></span>

```
Get-AzureNetworkSecurityGroup -Name "NSG-lockdown" |
Set-AzureNetworkSecurityRule -Name "allow-proxy " -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix "10.0.0.5/32" -SourcePortRange "*" -DestinationAddressPrefix Internet -DestinationPortRange "80-443"
```

<span data-ttu-id="97c5a-218">*Не забудьте заменить имена из примера данными, соответствующими вашему развертыванию.*</span><span class="sxs-lookup"><span data-stu-id="97c5a-218">*Ensure that you replace the names in the example with the details appropriate to your deployment.*</span></span>

## <a name="vm-agent"></a><span data-ttu-id="97c5a-219">Агент виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="97c5a-219">VM agent</span></span>
<span data-ttu-id="97c5a-220">Перед началом архивации виртуальной машины Azure убедитесь, что на ней правильно установлен агент виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="97c5a-220">Before you can back up the Azure virtual machine, you should ensure that the Azure VM agent is correctly installed on the virtual machine.</span></span> <span data-ttu-id="97c5a-221">Так как агент виртуальной машины является необязательным компонентом при создании виртуальной машины, убедитесь, что флажок агента виртуальной машины установлен до ее подготовки.</span><span class="sxs-lookup"><span data-stu-id="97c5a-221">Since the VM agent is an optional component at the time that the virtual machine is created, ensure that the check box for the VM agent is selected before the virtual machine is provisioned.</span></span>

### <a name="manual-installation-and-update"></a><span data-ttu-id="97c5a-222">Ручная установка и обновление</span><span class="sxs-lookup"><span data-stu-id="97c5a-222">Manual installation and update</span></span>
<span data-ttu-id="97c5a-223">Как правило, агент виртуальной машины уже имеется на виртуальных машинах, которые созданы с помощью коллекции Azure.</span><span class="sxs-lookup"><span data-stu-id="97c5a-223">The VM agent is already present in VMs that are created from the Azure gallery.</span></span> <span data-ttu-id="97c5a-224">Однако на виртуальных машинах, которые переносятся из локальных центров обработки данных, агент виртуальной машины отсутствует.</span><span class="sxs-lookup"><span data-stu-id="97c5a-224">However, virtual machines that are migrated from on-premises datacenters would not have the VM agent installed.</span></span> <span data-ttu-id="97c5a-225">Для таких виртуальных машин агент VM необходимо установить явным образом.</span><span class="sxs-lookup"><span data-stu-id="97c5a-225">For such VMs, the VM agent needs to be installed explicitly.</span></span> <span data-ttu-id="97c5a-226">Подробности об [установке агента ВМ на существующей виртуальной машине](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).</span><span class="sxs-lookup"><span data-stu-id="97c5a-226">Read more about [installing the VM agent on an existing VM](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).</span></span>

| <span data-ttu-id="97c5a-227">**Операция**</span><span class="sxs-lookup"><span data-stu-id="97c5a-227">**Operation**</span></span> | <span data-ttu-id="97c5a-228">**Windows**</span><span class="sxs-lookup"><span data-stu-id="97c5a-228">**Windows**</span></span> | <span data-ttu-id="97c5a-229">**Linux**</span><span class="sxs-lookup"><span data-stu-id="97c5a-229">**Linux**</span></span> |
| --- | --- | --- |
| <span data-ttu-id="97c5a-230">Установка агента виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="97c5a-230">Installing the VM agent</span></span> |<li><span data-ttu-id="97c5a-231">Скачайте и установите [MSI-файл агента](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span><span class="sxs-lookup"><span data-stu-id="97c5a-231">Download and install the [agent MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span></span> <span data-ttu-id="97c5a-232">Чтобы выполнить установку, необходимо иметь права администратора.</span><span class="sxs-lookup"><span data-stu-id="97c5a-232">You will need Administrator privileges to complete the installation.</span></span> <li><span data-ttu-id="97c5a-233">[Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) , чтобы указать, что агент установлен.</span><span class="sxs-lookup"><span data-stu-id="97c5a-233">[Update the VM property](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) to indicate that the agent is installed.</span></span> |<li> <span data-ttu-id="97c5a-234">Установите последнюю версию [агента Linux](https://github.com/Azure/WALinuxAgent) с сайта GitHub.</span><span class="sxs-lookup"><span data-stu-id="97c5a-234">Install the latest [Linux agent](https://github.com/Azure/WALinuxAgent) from GitHub.</span></span> <span data-ttu-id="97c5a-235">Чтобы выполнить установку, необходимо иметь права администратора.</span><span class="sxs-lookup"><span data-stu-id="97c5a-235">You will need Administrator privileges to complete the installation.</span></span> <li> <span data-ttu-id="97c5a-236">[Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) , чтобы указать, что агент установлен.</span><span class="sxs-lookup"><span data-stu-id="97c5a-236">[Update the VM property](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) to indicate that the agent is installed.</span></span> |
| <span data-ttu-id="97c5a-237">Обновление агента виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="97c5a-237">Updating the VM agent</span></span> |<span data-ttu-id="97c5a-238">Обновление агента виртуальной машины — это простая процедура, схожая с переустановкой [двоичных файлов агента виртуальной машины](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span><span class="sxs-lookup"><span data-stu-id="97c5a-238">Updating the VM agent is as simple as reinstalling the [VM agent binaries](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span></span> <br><br><span data-ttu-id="97c5a-239">Необходимо убедиться, что во время обновления агента виртуальной машины не выполняются операции архивации.</span><span class="sxs-lookup"><span data-stu-id="97c5a-239">Ensure that no backup operation is running while the VM agent is being updated.</span></span> |<span data-ttu-id="97c5a-240">Следуйте указаниям по [обновлению агента виртуальной машины Linux](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="97c5a-240">Follow the instructions on [updating the Linux VM agent ](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span></span> <br><br><span data-ttu-id="97c5a-241">Необходимо убедиться, что во время обновления агента виртуальной машины не выполняются операции архивации.</span><span class="sxs-lookup"><span data-stu-id="97c5a-241">Ensure that no backup operation is running while the VM agent is being updated.</span></span> |
| <span data-ttu-id="97c5a-242">Проверка установки агента виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="97c5a-242">Validating the VM agent installation</span></span> |<li><span data-ttu-id="97c5a-243">На виртуальной машине Azure перейдите в папку *C:\WindowsAzure\Packages*.</span><span class="sxs-lookup"><span data-stu-id="97c5a-243">Navigate to the *C:\WindowsAzure\Packages* folder in the Azure VM.</span></span> <li><span data-ttu-id="97c5a-244">В ней должен находиться файл WaAppAgent.exe.</span><span class="sxs-lookup"><span data-stu-id="97c5a-244">You should find the WaAppAgent.exe file present.</span></span><li> <span data-ttu-id="97c5a-245">Щелкните правой кнопкой мыши этот файл, выберите пункт **Свойства** и перейдите на вкладку **Подробно**.</span><span class="sxs-lookup"><span data-stu-id="97c5a-245">Right-click the file, go to **Properties**, and then select the **Details** tab.</span></span> <span data-ttu-id="97c5a-246">В поле "Версия продукта" должно отображаться значение 2.6.1198.718 или выше.</span><span class="sxs-lookup"><span data-stu-id="97c5a-246">The Product Version field should be 2.6.1198.718 or higher.</span></span> |<span data-ttu-id="97c5a-247">Недоступно</span><span class="sxs-lookup"><span data-stu-id="97c5a-247">N/A</span></span> |

<span data-ttu-id="97c5a-248">Ознакомьтесь с дополнительными сведениями об [агенте виртуальной машины](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) и [его установке](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/).</span><span class="sxs-lookup"><span data-stu-id="97c5a-248">Learn about the [VM agent](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) and [how to install it](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/).</span></span>

### <a name="backup-extension"></a><span data-ttu-id="97c5a-249">Расширение резервного копирования</span><span class="sxs-lookup"><span data-stu-id="97c5a-249">Backup extension</span></span>
<span data-ttu-id="97c5a-250">Чтобы выполнить архивацию виртуальной машины, служба архивации Azure устанавливает расширение для агента виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="97c5a-250">To back up the virtual machine, the Azure Backup service installs an extension to the VM agent.</span></span> <span data-ttu-id="97c5a-251">Служба резервного копирования Azure легко обновляет и применяет исправления к расширению резервного копирования без дополнительного вмешательства пользователя.</span><span class="sxs-lookup"><span data-stu-id="97c5a-251">The Azure Backup service seamlessly upgrades and patches the backup extension without additional user intervention.</span></span>

<span data-ttu-id="97c5a-252">Расширение резервного копирования устанавливается, если виртуальная машина запущена.</span><span class="sxs-lookup"><span data-stu-id="97c5a-252">The backup extension is installed if the VM is running.</span></span> <span data-ttu-id="97c5a-253">Кроме того, на запущенной виртуальной машине проще всего получить точку восстановления, согласованную с приложениями.</span><span class="sxs-lookup"><span data-stu-id="97c5a-253">A running VM also provides the greatest chance of getting an application-consistent recovery point.</span></span> <span data-ttu-id="97c5a-254">Тем не менее, служба архивации Azure будет продолжать архивацию виртуальной машины, даже если она выключена и установить расширение невозможно (автономная виртуальная машина).</span><span class="sxs-lookup"><span data-stu-id="97c5a-254">However, the Azure Backup service will continue to back up the VM--even if it is turned off, and the extension could not be installed (aka Offline VM).</span></span> <span data-ttu-id="97c5a-255">В этом случае точка восстановления будет *отказоустойчивой* , как обсуждалось выше.</span><span class="sxs-lookup"><span data-stu-id="97c5a-255">In this case, the recovery point will be *crash consistent* as discussed above.</span></span>

## <a name="questions"></a><span data-ttu-id="97c5a-256">Вопросы?</span><span class="sxs-lookup"><span data-stu-id="97c5a-256">Questions?</span></span>
<span data-ttu-id="97c5a-257">Если вы хотите задать вопрос или предложить добавить какие-либо функции, [отправьте нам свой отзыв](http://aka.ms/azurebackup_feedback).</span><span class="sxs-lookup"><span data-stu-id="97c5a-257">If you have questions, or if there is any feature that you would like to see included, [send us feedback](http://aka.ms/azurebackup_feedback).</span></span>

## <a name="next-steps"></a><span data-ttu-id="97c5a-258">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="97c5a-258">Next steps</span></span>
<span data-ttu-id="97c5a-259">Следующий шаг после подготовки среды для резервного копирования виртуальной машины — это создание резервной копии.</span><span class="sxs-lookup"><span data-stu-id="97c5a-259">Now that you have prepared your environment for backing up your VM, your next logical step is to create a backup.</span></span> <span data-ttu-id="97c5a-260">Более подробные сведения о резервном копировании виртуальных машин см. в статье по планированию.</span><span class="sxs-lookup"><span data-stu-id="97c5a-260">The planning article provides more detailed information about backing up VMs.</span></span>

* [<span data-ttu-id="97c5a-261">Настройка виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="97c5a-261">Back up virtual machines</span></span>](backup-azure-vms.md)
* [<span data-ttu-id="97c5a-262">Планирование инфраструктуры резервного копирования виртуальных машин в Azure</span><span class="sxs-lookup"><span data-stu-id="97c5a-262">Plan your VM backup infrastructure</span></span>](backup-azure-vms-introduction.md)
* [<span data-ttu-id="97c5a-263">Управление резервными копиями виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="97c5a-263">Manage virtual machine backups</span></span>](backup-azure-manage-vms.md)

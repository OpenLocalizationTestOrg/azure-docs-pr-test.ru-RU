---
title: "Служба архивации Azure: согласованное с приложениями резервное копирование виртуальных машин Linux | Документы Майкрософт"
description: "Используйте скрипты для резервного копирования виртуальных машин в Azure с согласованием приложений. Эти скрипты применимы только к виртуальным машинам Linux в развертываниях Resource Manager. Они не применимы к виртуальным машинам Windows или развертываниям Service Manager. В этой статье описываются действия по настройке скриптов, включая устранение неполадок."
services: backup
documentationcenter: dev-center-name
author: anuragmehrotra
manager: shivamg
keywords: "согласованное с приложениями резервное копирование; согласованное с приложениями резервное копирование виртуальных машин Azure; резервное копирование виртуальных машин Linux; служба архивации Azure"
ms.assetid: bbb99cf2-d8c7-4b3d-8b29-eadc0fed3bef
ms.service: backup
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 4/12/2017
ms.author: anuragm;markgal
ms.openlocfilehash: 378c65bec8fd1f880ed459e76f5e4b5d85e49d2a
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="application-consistent-backup-of-azure-linux-vms-preview"></a>Согласованное с приложениями резервное копирование виртуальных машин Azure Linux (предварительная версия)

В этой статье описана платформа Linux с поддержкой скриптов предварительного и последующего выполнения. Также рассмотрены способы ее использования при согласованном с приложениями резервном копировании виртуальных машин Azure Linux.

> [!Note]
> Платформа предварительных и последующих скриптов поддерживается только для виртуальных машин Linux, развернутых с помощью Azure Resource Manager. Скрипты для обеспечения согласованности приложений не поддерживаются для виртуальных машин, развернутых с помощью Service Manager, и виртуальных машин Windows.
>

## <a name="how-the-framework-works"></a>Принцип работы платформы

Эта платформа позволяет запускать пользовательские скрипты предварительного и последующего выполнения во время создания моментальных снимков виртуальной машины. Скрипты предварительного выполнения запускаются непосредственно перед созданием моментального снимка виртуальной машины, а скрипты последующего выполнения — сразу после создания такого снимка. Благодаря этому вы можете гибко управлять приложением и средой во время создания моментального снимка виртуальной машины.

При использовании этого сценария важно обеспечить согласованное с приложениями резервное копирование виртуальной машины. Скрипт предварительного выполнения может вызывать собственные API-интерфейсы приложения, которые замораживают операции ввода вывода и высвобождают содержимое памяти на диск. Это обеспечивает согласованность моментального снимка с приложением (то есть приложение открывается после загрузки виртуальной машины после восстановления). Для разморозки операций ввода и вывода можно использовать скрипт последующего выполнения. Он выполняет эту задачу с помощью собственных API-интерфейсов, чтобы приложение могло возобновить нормальную работу после создания снимка виртуальной машины.

## <a name="steps-to-configure-pre-script-and-post-script"></a>Действия по настройке скриптов предварительного и последующего выполнения

1. Войдите как привилегированный пользователь на виртуальную машину Linux, резервную копию которой нужно создать.

2. Скачайте файл **VMSnapshotScriptPluginConfig.json** из репозитория [GitHub](https://github.com/MicrosoftAzureBackup/VMSnapshotPluginConfig) и скопируйте его в каталог **/etc/azure** на всех виртуальных машинах, резервную копию которых нужно создать. Если каталога **/etc/azure** нет, создайте его.

3. Скопируйте скрипты предварительного и последующего выполнения для приложения на все виртуальные машины, резервную копию которых нужно создать. Скрипты можно скопировать в любое расположение на виртуальной машине. Не забудьте обновить полный путь к файлам скрипта в файле **VMSnapshotScriptPluginConfig.json**.

4. Обеспечьте следующие разрешения для файлов.

   - **VMSnapshotScriptPluginConfig.json**: разрешение "600". Например, только у привилегированных пользователей есть разрешения на чтение и запись этого файла. Разрешений на выполнение нет ни у кого.

   - **Файл скрипта предварительного выполнения**: разрешение "700".  Только у привилегированных пользователей есть разрешения на чтение, запись и выполнение этого файла.
  
   - **Файл скрипта последующего выполнения**: разрешение "700". Только у привилегированных пользователей есть разрешения на чтение, запись и выполнение этого файла.

   > [!Important]
   > Платформа предоставляет пользователям широкие возможности. Главное, что она полностью безопасна и только у привилегированных пользователей есть доступ к важным файлам JSON и файлам скриптов.
   > Если предыдущие требования не соблюдены, скрипт не запустится. В результате будет создана резервная копия, согласованная с состоянием файловой системы на момент сбоя.
   >

5. Настройте файл **VMSnapshotScriptPluginConfig.json**, как описано далее.
    - **pluginName** — оставьте значение без изменения. Иначе скрипты могут выполняться неправильно.

    - **preScriptLocation** — укажите полный путь к скрипту предварительного выполнения на архивируемой виртуальной машине.

    - **postScriptLocation** — укажите полный путь к скрипту последующего выполнения на архивируемой виртуальной машине.

    - **preScriptParams** — укажите необязательные параметры, которые должны передаваться в скрипт предварительного выполнения. Все параметры должны быть заключены в кавычки и разделены запятыми, если их несколько.

    - **postScriptParams** — укажите необязательные параметры, которые должны передаваться в скрипт последующего выполнения. Все параметры должны быть заключены в кавычки и разделены запятыми, если их несколько.

    - **preScriptNoOfRetries** — укажите число попыток запуска, совершаемых скриптом предварительного выполнения в случае сбоя перед завершением работы. "0" означает один запуск без повторных попыток в случае сбоя.

    - **postScriptNoOfRetries** — укажите число попыток запуска, совершаемых скриптом последующего выполнения в случае сбоя перед завершением работы. "0" означает один запуск без повторных попыток в случае сбоя.
    
    - **timeoutInSeconds** — укажите разное время ожидания для скриптов предварительного и последующего выполнения.

    - **continueBackupOnFailure** — присвойте значение **true**, чтобы при сбое скриптов предварительного и последующего выполнения служба архивации Azure выполнила резервное копирование, согласованное с файловой системой и сбоем. Если присвоить значение **false**, при сбое скриптов резервное копирование также завершится сбоем (только если не используется виртуальная машина с одним диском, для которой резервное копирование состояния системы на момент сбоя будет выполнено независимо от этого параметра).

    - **fsFreezeEnabled** — укажите, будет ли во время создания моментального снимка виртуальной машины Linux вызываться fsfreeze для обеспечения согласованности с файловой системой. Рекомендуется присвоить этому параметру значение **true**, если отключение fsfreeze может повлиять на состояние приложения.

6. Платформа скриптов теперь настроена. Если резервное копирование виртуальной машины уже настроено, следующая операция резервного копирования вызовет скрипты и активирует резервное копирование, согласованное с приложениями. В противном случае выполните настройку в соответствии с инструкциями для [резервного копирования виртуальных машин Azure в хранилища служб восстановления.](https://docs.microsoft.com/azure/backup/backup-azure-vms-first-look-arm)

## <a name="troubleshooting"></a>Устранение неполадок

Убедитесь, что при записи скриптов предварительного и последующего выполнения вы включили ведение соответствующих журналов. Так вы сможете просматривать и исправлять возможные ошибки, связанные с запуском скриптов. Если скрипты по-прежнему не удается запустить, см. таблицу ниже.

| Ошибка | Сообщение об ошибке | Рекомендуемое действие |
| ------------------------ | -------------- | ------------------ |
| Pre-ScriptExecutionFailed |Скрипт предварительного выполнения вернул ошибку, и резервная копия может быть несогласованной с приложениями.   | Чтобы устранить проблему, проверьте соответствующие журналы ошибок.|  
|   Post-ScriptExecutionFailed |    Скрипт последующего выполнения вернул ошибку, которая может влиять на состояние приложения. |    Чтобы устранить проблему, проверьте соответствующие журналы ошибок и состояние приложений. |
| Pre-ScriptNotFound |  Сценарий предварительного выполнения не найден в расположении, указанном в файле конфигурации **VMSnapshotScriptPluginConfig.json**. |   Чтобы обеспечить согласованное с приложениями резервное копирование приложений, убедитесь, что скрипт предварительного выполнения находится в расположении, указанном в файле конфигурации.|
| Post-ScriptNotFound | Сценарий предварительного выполнения не найден в расположении, указанном в файле конфигурации **VMSnapshotScriptPluginConfig.json**. |   Чтобы обеспечить согласованное с приложениями резервное копирование приложений, убедитесь, что скрипт последующего выполнения находится в расположении, указанном в файле конфигурации.|
| IncorrectPluginhostFile | Файл **Pluginhost**, который поставляется вместе с расширением VmSnapshotLinux, поврежден, поэтому скрипты предварительного и последующего выполнения не могут быть выполнены, а резервная копия будет несогласованной с приложениями. | Чтобы устранить проблему, удалите расширение **VmSnapshotLinux**. Оно будет автоматически переустановлено при следующем резервном копировании. |
| IncorrectJSONConfigFile | Файл **VMSnapshotScriptPluginConfig.json** является недопустимым, поэтому сценарии предварительного и последующего выполнения невозможно выполнить. Резервная копия будет несогласованной с приложениями. | Скачайте копию файла из репозитория [GitHub](https://github.com/MicrosoftAzureBackup/VMSnapshotPluginConfig) и выполните повторную настройку. |
| InsufficientPermissionforPre-Script | Чтобы выполнить скрипты, привилегированный пользователь (root) должен быть владельцем файла, а сам файл должен иметь разрешения "700" (то есть только владелец имеет разрешения на его чтение, запись и выполнение). | Убедитесь, что владельцем файла скрипта является привилегированный пользователь (root) и что только владелец имеет разрешения на его чтение, запись и выполнение. |
| InsufficientPermissionforPost-Script | Чтобы выполнить скрипты, привилегированный пользователь (root) должен быть владельцем файла, а сам файл должен иметь разрешения "700" (то есть только владелец имеет разрешения на его чтение, запись и выполнение). | Убедитесь, что владельцем файла скрипта является привилегированный пользователь (root) и что только владелец имеет разрешения на его чтение, запись и выполнение. |
| Pre-ScriptTimeout | Истекло время запуска скрипта предварительного выполнения для согласованного с приложениями резервного копирования. | Проверьте скрипт в файле **VMSnapshotScriptPluginConfig.json** (расположен в каталоге **/etc/azure**) и увеличьте время ожидания. |
| Post-ScriptTimeout | Истекло время запуска скрипта последующего выполнения для согласованного с приложениями резервного копирования. | Проверьте скрипт в файле **VMSnapshotScriptPluginConfig.json** (расположен в каталоге **/etc/azure**) и увеличьте время ожидания. |

## <a name="next-steps"></a>Дальнейшие действия
[Резервное копирование виртуальных машин Azure в хранилище служб восстановления](https://docs.microsoft.com/azure/backup/backup-azure-arm-vms)

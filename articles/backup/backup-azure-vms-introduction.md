---
title: "aaaPlanning инфраструктуру резервного копирования виртуальной Машины в Azure | Документы Microsoft"
description: "Важные вопросы при планировании tooback копирование виртуальных машин в Azure"
services: backup
documentationcenter: 
author: markgalioto
manager: carmonm
editor: 
keywords: "архивация ВМ, архивация виртуальных машин"
ms.assetid: 19d2cf82-1f60-43e1-b089-9238042887a9
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 7/18/2017
ms.author: markgal;trinadhk
ms.openlocfilehash: d11982431610000293038ee6aa7df8e7bc2d8b70
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="plan-your-vm-backup-infrastructure-in-azure"></a>Планирование инфраструктуры резервного копирования виртуальных машин в Azure
Эта статья содержит производительности и ресурсов предложения toohelp планирование инфраструктуры резервного копирования виртуальной Машины. Он также определяет ключевые аспекты hello службы резервного копирования; Эти аспекты может быть вызвана для определения архитектуры, Планирование производительности и планирования. Если вы уже [подготовки среды](backup-azure-vms-prepare.md), планирование, стало hello следующий шаг перед началом [tooback виртуальных машин](backup-azure-vms.md). Если требуются дополнительные сведения о виртуальных машинах Azure, см. раздел hello [документация по виртуальным машинам](https://azure.microsoft.com/documentation/services/virtual-machines/).

## <a name="how-does-azure-back-up-virtual-machines"></a>Как Azure выполняет резервное копирование виртуальных машин
Когда служба резервного копирования Azure hello инициирует задание резервного копирования во время запланированного hello, оно активирует tootake hello расширение резервного копирования моментального снимка на момент. Hello службы архивации Azure использует hello _VMSnapshot_ расширения в Windows и hello _VMSnapshotLinux_ расширения в Linux. расширение Hello устанавливается во время hello первая резервная копия виртуальной Машины. расширение tooinstall hello, hello виртуальная машина должна быть запущена. Если hello Виртуальная машина не запущена, hello службы резервного копирования снимок hello базовое хранилище (так как не записывайте возникать при hello остановки виртуальной Машины).

При создании моментального снимка ВМ Windows, служба резервного копирования hello координирует с помощью службы теневого копирования томов (VSS) tooget hello согласованный моментальный снимок диски hello виртуальной машины. Если выполняется резервное копирование виртуальных машин Linux, можно написать собственные пользовательские сценарии tooensure согласованности при создании моментального снимка виртуальной Машины. Подробные сведения о вызове таких скриптов приводятся далее в этой статье.

Hello службы архивации Azure делает снимок hello, hello данных после переносятся toohello хранилища. эффективность toomaximize hello служба определяет и передает только hello блоков данных, которые были изменены с момента предыдущего резервного копирования hello.

![Архитектура резервного копирования виртуальных машин Azure](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

После завершения передачи данных hello hello снимок удаляется и создается точка восстановления.

> [!NOTE]
> 1. Во время процесса резервного копирования hello Azure Backup не содержит hello временный диск, подключенный toohello виртуальной машины. Дополнительные сведения см. в статье блога hello на [временного хранилища](https://blogs.msdn.microsoft.com/mast/2013/12/06/understanding-the-temporary-drive-on-windows-azure-virtual-machines/).
> 2. Поскольку моментальный снимок уровня хранилища и передачи, моментальный снимок toovault берет резервного копирования Azure, не изменяйте hello ключи учетной записи хранения до завершения задания резервного копирования hello.
> 3. Для виртуальных машин premium Мы копируем счет toostorage hello моментального снимка. Это, чтобы убедиться, что службы архивации Azure получает достаточно операций ввода-ВЫВОДА для передачи данных toovault toomake. Этой дополнительной копии хранилища оплачивается согласно hello выделенный размер виртуальной Машины. 
>

### <a name="data-consistency"></a>Согласованность данных
Резервное копирование и восстановление важных деловых данных осложняется hello факт, что необходимо архивировать важных деловых данных во время приложения hello, производящих hello данных работают. tooaddress, резервного копирования Azure поддерживает согласованных с приложением резервного копирования для Windows и виртуальных машин Linux
#### <a name="windows-vm"></a>Виртуальная машина Windows
Служба архивации Azure принимает полные резервные копии VSS на виртуальных машинах Windows (дополнительные сведения см. в записи блога о [полном резервном копировании VSS](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx)). резервного копирования VSS tooenable, hello после набора toobe потребностей ключей реестра на hello виртуальной Машины.

```
[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
"USEVSSCOPYBACKUP"="TRUE"
```

#### <a name="linux-vms"></a>Виртуальные машины Linux
Служба архивации Azure предоставляет платформу скриптов. согласованность приложения tooensure при резервном копировании виртуальных машин Linux, создайте пользовательские сценарии перед и после скриптов, которые управляют рабочего процесса резервного копирования hello и среды. Резервное копирование Azure вызывает hello предварительной скрипт перед созданием моментального снимка виртуальной Машины hello и вызывает скрипт, выполняемый после hello после завершения задания моментального снимка виртуальной Машины hello. Подробные сведения см. в разделе [Согласованное с приложениями резервное копирование виртуальных машин Azure Linux](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent).
> [!NOTE]
> Резервного копирования Azure только вызывает hello записи клиента до и после сценариев. Если скрипт предварительной hello и скрипты, выполняемые после успешного выполнения, резервного копирования Azure помечает hello точку восстановления как приложение согласованной. Однако клиент hello отвечает в итоге для обеспечения согласованности приложения hello при использовании пользовательских сценариев.
>


В этой таблице описываются типы hello согласованности и hello условия, проводить во время резервного копирования виртуальной Машины Azure и восстановления.

| Целостность | На основе VSS | Подробное объяснение |
| --- | --- | --- |
| Целостность на уровне приложения |Да для Windows.|Согласованность приложений идеально подходит для рабочих нагрузок, так как гарантирует следующее:<ol><li> Hello ВМ *загружается*. <li>*Нет повреждений данных*. <li>*Нет потерь данных*.<li> Hello данных — согласованного toohello приложение, которое использует данные hello, включающих приложения hello во время hello резервного копирования — с помощью скрипта VSS или pre и post.</ol> <li>*Виртуальные машины Windows*-рабочих нагрузок наиболее Майкрософт имеют модули записи VSS, выполните действия конкретных рабочих нагрузок связанные toodata согласованности. Например Microsoft SQL Server имеется модуль записи VSS, гарантирует правильной реализации файла журнала транзакций toohello записи hello и hello базы данных. Для резервного копирования виртуальной Машины Windows Azure, toocreate точки восстановления, согласованной приложения hello расширение резервного копирования вызова рабочего процесса VSS hello и завершить ее перед созданием моментального снимка виртуальной Машины hello. Для toobe моментальный снимок виртуальной Машины Azure hello точные модули записи VSS hello всех приложений на виртуальной Машине Azure, необходимо выполнить также. (Дополнительные сведения hello [основы VSS](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx) и углубиться в hello подробные сведения о [принцип работы](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx)). </li> <li> *Виртуальные машины Linux*-клиенты могут выполнять [согласованность приложения пользовательских сценариев до и после tooensure](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent). </li> |
| Согласованность файловой системы |Да — для компьютеров под управлением Windows |Существует два сценария, где может быть точка восстановления hello *файловой системы согласованного*:<ul><li>резервные копии виртуальных машин Linux в Azure, для которых предварительный и последующий сценарии не запускались либо завершились ошибкой; <li>сбой VSS во время резервного копирования виртуальных машин Windows в Azure.</li></ul> В обоих этих случаях hello рекомендации, можно сделать — tooensure: <ol><li> Hello ВМ *загружается*. <li>*Нет повреждений данных*.<li>*Нет потерь данных*.</ol> Приложения должны hello восстановить данные с помощью механизма tooimplement собственные «исправление вверх». |
| Отказоустойчивость |Нет |Такая ситуация встречается эквивалентные tooa виртуальной машины, возникают «сбой» (с помощью программным или аппаратным reset). На случай сбоя обычно происходит при выключении hello виртуальной машины Azure во время hello резервного копирования. Точка восстановления на момент аварийного завершения предоставляет никаких гарантий вокруг hello согласованность данных hello на носителе hello — либо с точки зрения hello hello операционной системы или приложения hello. Только данные hello, уже существует на диске hello во время hello резервного копирования, собираются и резервного копирования. <br/> <br/> Здравствуйте загрузки операционной системы, следуют проверки диска, пока нет гарантий, как правило, процедура, как chkdsk, toofix ошибки повреждения. Любые данные в памяти или операций записи, которые не были переносятся toohello диска будут потеряны. в случае, если данные отката должен сделать toobe приложения Hello обычно соответствует с собственный механизм проверки. <br><br>Например, если журнал транзакций hello записей, которые отсутствуют в базе данных hello, затем hello базы данных программное обеспечение выполняет откат до hello согласовывается. Когда данные распределяются на несколько виртуальных дисков (например составные тома), точку восстановления на момент аварийного завершения предоставляет никаких гарантий для hello правильность данных hello. |

## <a name="performance-and-resource-utilization"></a>Производительность и использование ресурсов
Как и при локальном резервном копировании, при резервном копировании виртуальных машин в Azure важно учитывать ограничения по производительности и использованию ресурсов. Hello [ограничения хранилища Azure](../azure-subscription-service-limits.md#storage-limits) определить влияние toostructure ВМ развертываний tooget максимальную производительность с минимальной toorunning рабочих нагрузок.

Обратите внимание toohello, который ограничивает следующие хранилища Azure при планировании производительности резервного копирования:

* Максимальный объем исходящих данных на учетную запись хранения.
* Общая частота запросов на учетную запись хранения.

### <a name="storage-account-limits"></a>Ограничения учетной записи хранения
Резервные данные копируются из учетной записи хранилища, добавляет toohello операций ввода вывода в секунду (IOPS) и исходящие данные (или пропускной способности) метрики учетной записи хранения hello. AT hello же времени, виртуальные машины также потребляют операций ввода-ВЫВОДА и пропускной способности. Цель Hello — tooensure резервного копирования и трафик виртуальной машины не превышает дискового пространства учетной записи.

### <a name="number-of-disks"></a>Количество дисков
процесс резервного копирования Hello предпринимает toocomplete задание резервного копирования как можно быстрее. Поэтому она потребляет все доступные ресурсы. Тем не менее, все операции ввода-вывода ограничиваются hello *целевая пропускная способность для одного большого двоичного объекта*, который имеет ограничение на 60 МБ в секунду. В toomaximize попытки его скорости hello процесс резервного копирования пытается подключиться tooback копии всех дисков виртуальной Машины hello *параллельно*. Если виртуальная машина имеет четыре жестких диска, hello служба пытается tooback все четыре диски в параллельном режиме. Hello **номера дисков** создается резервная копия является важным фактором hello в определении трафика резервного копирования учетной записи хранилища.

### <a name="backup-schedule"></a>Расписание резервного копирования
Дополнительный фактор, который влияет на производительность — hello **расписание резервного копирования**. При настройке политики hello, чтобы все виртуальные машины резервная копия в hello же время запланировано застряла трафика. процесс резервного копирования Hello попыток tooback все диски в параллельном режиме. tooreduce hello резервного копирования трафик от учетной записи хранилища, создайте резервную копию разных ВМ в другое время hello, без перекрытия.

## <a name="capacity-planning"></a>Планирование загрузки
Совместное размещение выше факторов hello необходима tooplan hello потребностями в учетной записи хранилища. Загрузите hello [электронную таблицу Excel для планирования резервного копирования емкость виртуальной Машины](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33) влияние hello toosee диска и параметры расписания резервного копирования.

### <a name="backup-throughput"></a>Пропускная способность при резервном копировании
Для каждого диска, резервная копия резервного копирования Azure считывает hello блоков на диске hello и сохраняет только hello измененных данных (добавочное резервное копирование). Hello следующей таблице показаны средние значения в пропускной способности резервной копии службы hello. С помощью hello следующие данные, можно оценить hello количество времени, нужен tooback копии диска заданного размера.

| Операция резервного копирования | Пропускная способность в лучшем случае |
| --- | --- |
| Начальное резервное копирование |160 Мбит/с |
| Добавочное резервное копирование (аварийное восстановление) |640 Мбит/с  <br><br> Удаляет пропускной способности значительно изменился hello (который должен toobe резервное копирование) данные распределена по hello диска.|

## <a name="total-vm-backup-time"></a>Общее время резервного копирования виртуальной машины
Хотя большая часть времени создания резервной копии hello затрачивается на чтение и копирование данных, другие операции contribute tooback общее время, необходимое toohello ВМ:

* Время, необходимое слишком[установить или обновить расширение резервного копирования hello](backup-azure-vms.md).
* Моментальный снимок время — время, затраченное hello tootrigger моментального снимка. Моментальные снимки, инициируемых закрыть toohello запланированное время резервного копирования.
* Время ожидания в очереди. Так как служба резервного копирования hello обрабатывает резервные копии из нескольких клиентов, копирование резервного копирования данных из резервной копии моментального снимка toohello или служб восстановления хранилище может не запускаться немедленно. В время пиковой нагрузки hello ожидания можно растянуть tooeight часов из-за toohello количество обрабатываемых резервных копий. Тем не менее общее время резервного копирования hello ВМ составляет менее 24 часов для ежедневной политики резервного копирования.
* Время передачи данных, время, необходимое для резервного копирования toocompute hello добавочные изменения от предыдущей резервной копии служб и передачи этих изменений toovault хранилища.

### <a name="why-am-i-observing-longer12-hours-backup-time"></a>Почему архивация выполняется дольше (более 12 ч)?
Резервная копия состоит из двух этапов: создание моментальных снимков и передаче hello toohello хранилище моментальных снимков. для хранения оптимизирует Hello службы резервного копирования. При передаче данных tooa hello моментального снимка хранилища, служба hello перемещает только добавочные изменения из предыдущего снимка hello.  toodetermine hello добавочные изменения, службы hello вычисляет контрольную сумму hello hello блоков. При изменении блок hello блока определяется как блок toobe, отправляемых toohello хранилища. Затем Детализирует службы hello дальнейшей в каждый hello идентифицировать блоки, поиск tootransfer данных hello toominimize возможности. После вычисления всех измененных блоков, hello службы объединяет изменения hello и отправляет их toohello хранилища. В некоторых старых приложениях операции записи не оптимальны с точки зрения хранилища, так как они малого размера и фрагментированы. Если моментальный снимок hello содержит большое число операций записи небольших, степень фрагментации, служба hello тратит дополнительное время обработки hello данные, записанные в приложения hello. Привет, рекомендуется использовать блок приложения для записи из Azure, для приложений, выполняющихся внутри hello виртуальной Машины, является как минимум 8 КБ. Если приложение использует блок объемом менее 8 КБ, то это негативно влияет на производительность резервного копирования. Справку по настройке производительность резервного копирования tooimprove приложений см. в разделе [настройки приложений для достижения оптимальной производительности хранилища Azure](../storage/common/storage-premium-storage-performance.md). Хотя hello статьи на производительность резервного копирования используются примеры хранилища Premium, руководство hello применяется для стандартных дисков.

## <a name="total-restore-time"></a>Общее время восстановления
Операция восстановления состоит из двух основных sub задач: копирование данных из hello хранилище toohello выбранной пользовательской учетной записи хранения и создание виртуальной машины hello. Копирование данных из хранилища hello зависит от где hello резервные копии предназначены для внутреннего хранения в Azure, и место хранения hello пользовательской учетной записи хранения. Время, затраченное toocopy данных зависит от условий:
* Ожидания в очереди, время - с момента обработки службой hello задания восстановления от нескольких клиентов в hello одновременно, запросов на восстановление, помещена в очередь.
* Время - копирования данных данные копируются из hello хранилище toohello пользовательской учетной записи хранения. Восстановление время зависит от операций ввода-ВЫВОДА и пропускную способность службы архивации Azure возвращает hello выбранной пользовательской учетной записи хранения. tooreduce hello копирование времени в процессе восстановления hello, выберите учетную запись хранения не загружен с других приложений записи и чтения.

## <a name="best-practices"></a>Рекомендации
Ниже приведены рекомендации, которые следует учитывать при настройке резервного копирования виртуальных машин.

* Не планировать более 10 классических виртуальных машин из hello же облако службы tooback в hello то же время. Если вы хотите tooback нескольких виртуальных машин из одной облачной службе, управлять временем hello начала резервного копирования на час.
* Не назначайте более 40 tooback ВМ вверх в hello то же время.
* Планируйте резервное копирование виртуальных машин на периоды низкой нагрузки. Этот способ hello службы резервного копирования операций ввода-ВЫВОДА использует для передачи данных из hello клиента учетной записи toohello хранилища.
* Убедитесь, что политика применяется к виртуальным машинам, распределенным по нескольким учетным записям хранения. Мы советуем использовать не более 20 общее дисков из одной учетной записи хранения защищена с помощью hello же расписание резервного копирования. При наличии более 20 дисков в учетной записи хранения распространения этих виртуальных машин между несколькими политиками tooget hello необходимое значение IOPS во время фазы передачи hello hello процесс резервного копирования.
* Не восстанавливайте виртуальная машина, работающая в учетной записи хранилища toosame хранения Premium. Если процесс восстановления hello совпадает с hello операции резервного копирования, он уменьшает hello операций ввода-ВЫВОДА, доступные для резервного копирования.
* Для успешной архивации виртуальных машин уровня "Премиум" убедитесь, что в учетной записи хранения, в которой размещены диски уровня "Премиум", свободно как минимум 50 % места для промежуточного хранения моментального снимка. 
* Убедитесь, что на виртуальных машинах Linux с поддержкой архивации используется Python 2.7

## <a name="data-encryption"></a>Шифрование данных
Служба архивации Azure не производит шифрование данных как часть процесса резервного копирования hello. Тем не менее, можно шифровать данные в пределах hello виртуальной Машины и создайте резервную копию hello защищенных данных легко (Дополнительные сведения о [резервного копирования зашифрованных данных](backup-azure-vms-encryption.md)).

## <a name="calculating-hello-cost-of-protected-instances"></a>Расчет себестоимости hello защищенные экземпляры
Azure виртуальные машины, резервное копирование копии Azure с помощью подчиняются слишком[цены на Azure Backup](https://azure.microsoft.com/pricing/details/backup/). Hello защищенных экземпляров вычислений основана на hello *фактическое* размер hello виртуальной машины — hello сумма всех данных hello в hello виртуальной машины — за исключением hello «disk ресурсов».

Цены для резервного копирования виртуальных машин — *не* на основе размера максимальное hello поддерживается для каждого диска данных вложенного toohello виртуальной машины. Цены основан на hello фактические данные хранятся на диске данных hello. Аналогичным образом счета hello хранения резервных копий зависит от hello объем данных, хранящихся в службе архивации Azure, которая представляет сумму hello hello фактических данных в каждой точке восстановления.

Например, возьмем виртуальную машину стандартного размера A2 с двумя дополнительными дисками максимальным объемом 1 ТБ каждый. Hello следующей таблице приведены hello фактические данные хранятся на каждом из этих дисков:

| Тип диска | Максимальный размер | Фактические данные |
| --- | --- | --- |
| Диск операционной системы |1023 ГБ |17 ГБ |
| Локальный диск или диск ресурсов |135 ГБ |5 ГБ (не учитывается для архивации) |
| Диск данных 1 |1023 ГБ |30 ГБ |
| Диск данных 2 |1023 ГБ |0 ГБ |

Hello *фактическое* размера hello виртуальной машины в данном случае является 17 ГБ + 30 ГБ + 0 = 47 ГБ. Этот размер защищенного экземпляра (47 ГБ) становится основой hello hello ежемесячный счет. Как hello увеличения объема данных на виртуальной машине hello, размер защищенного экземпляра hello, используемый для изменения в выставление счетов, соответствующим образом.

Выставление счетов не запускается до завершения первой успешной архивации hello. На этом этапе начинает hello выставления счетов для хранилища и защищенных экземпляров. Выставление счетов продолжается до тех пор, пока существует *любой резервной копии данных, хранящихся в хранилище* для hello виртуальной машины. Если остановить защиту на виртуальной машине hello, но данные резервного копирования виртуальных машин в хранилище, выставление счетов продолжается.

Выставление счетов для указанной виртуальной машины останавливает только в том случае, если остановить защиту hello *и* удалены все данные резервного копирования. При остановке защиты и нет активных заданий резервного копирования, размер hello hello последней успешной архивации виртуальных Машин становится размер защищенного экземпляра hello, используемый для hello ежемесячный счет.

## <a name="questions"></a>Вопросы?
Если у вас есть вопросы или при наличии любой возможности, хотелось бы включены, toosee [отправить отзыв](http://aka.ms/azurebackup_feedback).

## <a name="next-steps"></a>Дальнейшие действия
* [Настройка виртуальных машин](backup-azure-vms.md)
* [Управление резервными копиями виртуальной машины](backup-azure-manage-vms.md)
* [Восстановление виртуальных машин](backup-azure-restore-vms.md)
* [Устранение проблем с резервным копированием виртуальных машин](backup-azure-vms-troubleshoot.md)

---
title: "Планирование инфраструктуры архивации виртуальных машин | Документация Майкрософт"
description: "Важные вопросы при планировании резервного копирования виртуальных машин в Azure"
services: backup
documentationcenter: 
author: markgalioto
manager: carmonm
editor: 
keywords: "архивация ВМ, архивация виртуальных машин"
ms.assetid: 19d2cf82-1f60-43e1-b089-9238042887a9
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 7/18/2017
ms.author: markgal;trinadhk
ms.openlocfilehash: 0c930c7413b24a811707c3a1ff3d7d70585bc528
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="plan-your-vm-backup-infrastructure-in-azure"></a><span data-ttu-id="ccd34-104">Планирование инфраструктуры резервного копирования виртуальных машин в Azure</span><span class="sxs-lookup"><span data-stu-id="ccd34-104">Plan your VM backup infrastructure in Azure</span></span>
<span data-ttu-id="ccd34-105">Эта статья содержит рекомендации по производительности и ресурсам, которые помогут спроектировать инфраструктуру резервного копирования виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="ccd34-105">This article provides performance and resource suggestions to help you plan your VM backup infrastructure.</span></span> <span data-ttu-id="ccd34-106">Также здесь приводятся ключевые определения службы архивации; эти аспекты могут быть критически важными при определении архитектуры, планировании и распределении мощностей.</span><span class="sxs-lookup"><span data-stu-id="ccd34-106">It also defines key aspects of the Backup service; these aspects can be critical in determining your architecture, capacity planning, and scheduling.</span></span> <span data-ttu-id="ccd34-107">Если вы уже [подготовили среду](backup-azure-vms-prepare.md), то следующий шаг (планирование) позволит начать [архивацию виртуальных машин](backup-azure-vms.md).</span><span class="sxs-lookup"><span data-stu-id="ccd34-107">If you've [prepared your environment](backup-azure-vms-prepare.md), planning is the next step before you begin [to back up VMs](backup-azure-vms.md).</span></span> <span data-ttu-id="ccd34-108">Дополнительные сведения о виртуальных машинах Azure содержатся в [документации по виртуальным машинам](https://azure.microsoft.com/documentation/services/virtual-machines/).</span><span class="sxs-lookup"><span data-stu-id="ccd34-108">If you need more information about Azure virtual machines, see the [Virtual Machines documentation](https://azure.microsoft.com/documentation/services/virtual-machines/).</span></span>

## <a name="how-does-azure-back-up-virtual-machines"></a><span data-ttu-id="ccd34-109">Как Azure выполняет резервное копирование виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="ccd34-109">How does Azure back up virtual machines?</span></span>
<span data-ttu-id="ccd34-110">Служба архивации Azure по установленному расписанию запускает задание резервного копирования. При этом модуль резервного копирования создает снимок текущего состояния.</span><span class="sxs-lookup"><span data-stu-id="ccd34-110">When the Azure Backup service initiates a backup job at the scheduled time, it triggers the backup extension to take a point-in-time snapshot.</span></span> <span data-ttu-id="ccd34-111">Служба архивации Azure использует расширение _VMSnapshot_ в Windows и расширение _VMSnapshotLinux_ в Linux.</span><span class="sxs-lookup"><span data-stu-id="ccd34-111">The Azure Backup service uses the _VMSnapshot_ extension in Windows, and the _VMSnapshotLinux_ extension in Linux.</span></span> <span data-ttu-id="ccd34-112">Расширение устанавливается во время первого резервного копирования виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="ccd34-112">The extension is installed during the first VM backup.</span></span> <span data-ttu-id="ccd34-113">Для установки расширения виртуальная машина должна быть запущена.</span><span class="sxs-lookup"><span data-stu-id="ccd34-113">To install the extension, the VM must be running.</span></span> <span data-ttu-id="ccd34-114">Если виртуальная машина не запущена, служба резервного копирования создает моментальный снимок базового хранилища (так как операции записи в приложении не выполняются, пока виртуальная машина остановлена).</span><span class="sxs-lookup"><span data-stu-id="ccd34-114">If the VM is not running, the Backup service takes a snapshot of the underlying storage (since no application writes occur while the VM is stopped).</span></span>

<span data-ttu-id="ccd34-115">Во время создания моментального снимка виртуальных машин Windows служба архивации координируется со службой теневого копирования томов (VSS), что позволяет создать согласованный моментальный снимок дисков виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="ccd34-115">When taking a snapshot of Windows VMs, the Backup service coordinates with the Volume Shadow Copy Service (VSS) to get a consistent snapshot of the virtual machine's disks.</span></span> <span data-ttu-id="ccd34-116">Если вы создаете резервные копии виртуальных машин Linux, то можете создать собственный скрипт для обеспечения согласованности при создании моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="ccd34-116">If you're backing up Linux VMs, you can write your own custom scripts to ensure consistency when taking a VM snapshot.</span></span> <span data-ttu-id="ccd34-117">Подробные сведения о вызове таких скриптов приводятся далее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="ccd34-117">Details on invoking these scripts are provided later in this article.</span></span>

<span data-ttu-id="ccd34-118">После создания моментального снимка службой архивации Azure данные передаются в хранилище.</span><span class="sxs-lookup"><span data-stu-id="ccd34-118">Once the Azure Backup service takes the snapshot, the data is transferred to the vault.</span></span> <span data-ttu-id="ccd34-119">Для повышения эффективности служба анализирует блоки данных и передает только те из них, которые были изменены с момента предыдущего резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="ccd34-119">To maximize efficiency, the service identifies and transfers only the blocks of data that have changed since the previous backup.</span></span>

![Архитектура резервного копирования виртуальных машин Azure](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

<span data-ttu-id="ccd34-121">После передачи данных служба удаляет моментальный снимок и создает точку восстановления.</span><span class="sxs-lookup"><span data-stu-id="ccd34-121">When the data transfer is complete, the snapshot is removed and a recovery point is created.</span></span>

> [!NOTE]
> 1. <span data-ttu-id="ccd34-122">Во время резервного копирования служба архивации Azure не использует временный диск, подключенный к виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="ccd34-122">During the backup process, Azure Backup doesn't include the temporary disk attached to the virtual machine.</span></span> <span data-ttu-id="ccd34-123">Дополнительные сведения см. в записи блога о [временном хранилище](https://blogs.msdn.microsoft.com/mast/2013/12/06/understanding-the-temporary-drive-on-windows-azure-virtual-machines/).</span><span class="sxs-lookup"><span data-stu-id="ccd34-123">For more information, see the blog on [temporary storage](https://blogs.msdn.microsoft.com/mast/2013/12/06/understanding-the-temporary-drive-on-windows-azure-virtual-machines/).</span></span>
> 2. <span data-ttu-id="ccd34-124">Так как служба архивации Azure создает моментальный снимок на уровне хранилища и передает его в хранилище, не меняйте ключи учетной записи хранения, пока задание резервного копирования не завершится.</span><span class="sxs-lookup"><span data-stu-id="ccd34-124">Since Azure Backup takes a storage-level snapshot and transfers that snapshot to vault, do not change the storage account keys until the backup job finishes.</span></span>
> 3. <span data-ttu-id="ccd34-125">Для виртуальных машин из ценовой категории "Премиум" мы копируем моментальный снимок для учетной записи хранилища.</span><span class="sxs-lookup"><span data-stu-id="ccd34-125">For premium VMs, we copy the snapshot to storage account.</span></span> <span data-ttu-id="ccd34-126">Это позволяет гарантировать, что служба Microsoft Azure Backup получает достаточно операций ввода-вывода для передачи данных в хранилище.</span><span class="sxs-lookup"><span data-stu-id="ccd34-126">This is to make sure that Azure Backup service gets sufficient IOPS for transferring data to vault.</span></span> <span data-ttu-id="ccd34-127">Такая дополнительная копия хранилища оплачивается согласно выделенному размеру виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="ccd34-127">This additional copy of storage is charged as per the VM allocated size.</span></span> 
>

### <a name="data-consistency"></a><span data-ttu-id="ccd34-128">Согласованность данных</span><span class="sxs-lookup"><span data-stu-id="ccd34-128">Data consistency</span></span>
<span data-ttu-id="ccd34-129">Резервное копирование и восстановление критически важных для бизнеса данных осложняются тем, что копирование этих данных должно выполняться во время работы приложений, которые создают эти данные.</span><span class="sxs-lookup"><span data-stu-id="ccd34-129">Backing up and restoring business critical data is complicated by the fact that business critical data must be backed up while the applications that produce the data are running.</span></span> <span data-ttu-id="ccd34-130">Для решения этой задачи служба архивации Azure поддерживает резервные копии с согласованием приложений для виртуальных машин Windows и Linux.</span><span class="sxs-lookup"><span data-stu-id="ccd34-130">To address this, Azure Backup supports application-consistent backups for both Windows and Linux VMs</span></span>
#### <a name="windows-vm"></a><span data-ttu-id="ccd34-131">Виртуальная машина Windows</span><span class="sxs-lookup"><span data-stu-id="ccd34-131">Windows VM</span></span>
<span data-ttu-id="ccd34-132">Служба архивации Azure принимает полные резервные копии VSS на виртуальных машинах Windows (дополнительные сведения см. в записи блога о [полном резервном копировании VSS](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx)).</span><span class="sxs-lookup"><span data-stu-id="ccd34-132">Azure Backup takes VSS full backups on Windows VMs (read more about [VSS full backup](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx)).</span></span> <span data-ttu-id="ccd34-133">Чтобы включить копирующую архивацию VSS, для виртуальной машины необходимо задать приведенный ниже раздел реестра.</span><span class="sxs-lookup"><span data-stu-id="ccd34-133">To enable VSS copy backups, the following registry key needs to be set on the VM.</span></span>

```
[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
"USEVSSCOPYBACKUP"="TRUE"
```

#### <a name="linux-vms"></a><span data-ttu-id="ccd34-134">Виртуальные машины Linux</span><span class="sxs-lookup"><span data-stu-id="ccd34-134">Linux VMs</span></span>
<span data-ttu-id="ccd34-135">Служба архивации Azure предоставляет платформу скриптов.</span><span class="sxs-lookup"><span data-stu-id="ccd34-135">Azure Backup provides a scripting framework.</span></span> <span data-ttu-id="ccd34-136">Для обеспечения согласованности приложений при резервном копировании виртуальных машин Linux создайте скрипты, выполняемые до и после резервного копирования, с целью контроля рабочего процесса резервного копирования и среды.</span><span class="sxs-lookup"><span data-stu-id="ccd34-136">To ensure application consistency when backing up Linux VMs, create custom pre-scripts and post-scripts that control the backup workflow and environment.</span></span> <span data-ttu-id="ccd34-137">Служба архивации Azure вызывает предварительный скрипт перед созданием моментального снимка виртуальной машины, а последующий скрипт — после того, как задание создания моментального снимка виртуальной машины завершится.</span><span class="sxs-lookup"><span data-stu-id="ccd34-137">Azure Backup invokes the pre-script before taking the VM snapshot and invokes the post-script once the VM snapshot job completes.</span></span> <span data-ttu-id="ccd34-138">Подробные сведения см. в разделе [Согласованное с приложениями резервное копирование виртуальных машин Azure Linux](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent).</span><span class="sxs-lookup"><span data-stu-id="ccd34-138">For more details, see [application consistent VM backups using pre-script and post-script](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent).</span></span>
> [!NOTE]
> <span data-ttu-id="ccd34-139">Служба архивации Azure вызывает только созданные клиентом скрипты, выполняемые до и после резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="ccd34-139">Azure Backup only invokes the customer-written pre- and post-scripts.</span></span> <span data-ttu-id="ccd34-140">Если предварительный и последующий скрипты будут успешно выполнены, служба архивации Azure пометит точку восстановления как согласованную по приложениям.</span><span class="sxs-lookup"><span data-stu-id="ccd34-140">If the pre-script and post-scripts execute successfully, Azure Backup marks the recovery point as application consistent.</span></span> <span data-ttu-id="ccd34-141">Однако при использовании пользовательских скриптов ответственность за согласованность приложений в конечном итоге несет клиент.</span><span class="sxs-lookup"><span data-stu-id="ccd34-141">However, the customer is ultimately responsible for the application consistency when using custom scripts.</span></span>
>


<span data-ttu-id="ccd34-142">Следующая таблица содержит типы целостности информации, их описания и условия соблюдения при архивации и восстановлении виртуальных машин Azure.</span><span class="sxs-lookup"><span data-stu-id="ccd34-142">This table explains the types of consistency and the conditions that they occur under during Azure VM backup and restore procedures.</span></span>

| <span data-ttu-id="ccd34-143">Целостность</span><span class="sxs-lookup"><span data-stu-id="ccd34-143">Consistency</span></span> | <span data-ttu-id="ccd34-144">На основе VSS</span><span class="sxs-lookup"><span data-stu-id="ccd34-144">VSS-based</span></span> | <span data-ttu-id="ccd34-145">Подробное объяснение</span><span class="sxs-lookup"><span data-stu-id="ccd34-145">Explanation and details</span></span> |
| --- | --- | --- |
| <span data-ttu-id="ccd34-146">Целостность на уровне приложения</span><span class="sxs-lookup"><span data-stu-id="ccd34-146">Application consistency</span></span> |<span data-ttu-id="ccd34-147">Да для Windows.</span><span class="sxs-lookup"><span data-stu-id="ccd34-147">Yes for Windows</span></span>|<span data-ttu-id="ccd34-148">Согласованность приложений идеально подходит для рабочих нагрузок, так как гарантирует следующее:</span><span class="sxs-lookup"><span data-stu-id="ccd34-148">Application consistency is ideal for workloads as it ensures that:</span></span><ol><li> <span data-ttu-id="ccd34-149">Виртуальная машина *загружается*.</span><span class="sxs-lookup"><span data-stu-id="ccd34-149">The VM *boots up*.</span></span> <li><span data-ttu-id="ccd34-150">*Нет повреждений данных*.</span><span class="sxs-lookup"><span data-stu-id="ccd34-150">There is *no corruption*.</span></span> <li><span data-ttu-id="ccd34-151">*Нет потерь данных*.</span><span class="sxs-lookup"><span data-stu-id="ccd34-151">There is *no data loss*.</span></span><li> <span data-ttu-id="ccd34-152">Данные согласованы с приложением, которое их использует, за счет привлечения приложения во время архивации (с помощью VSS или предварительного и последующего сценариев).</span><span class="sxs-lookup"><span data-stu-id="ccd34-152">The data is consistent to the application that uses the data, by involving the application at the time of backup--using VSS or pre/post script.</span></span></ol> <li><span data-ttu-id="ccd34-153">*Виртуальные машины Windows*. Большинство рабочих нагрузок Майкрософт имеют модули записи VSS, которые выполняют специальные действия, обеспечивающие согласованность данных.</span><span class="sxs-lookup"><span data-stu-id="ccd34-153">*Windows VMs*- Most Microsoft workloads have VSS writers that do workload-specific actions related to data consistency.</span></span> <span data-ttu-id="ccd34-154">Например, Microsoft SQL Server содержит модуль записи VSS, обеспечивающий правильное выполнение операций записи в файл журнала транзакций и базы данных.</span><span class="sxs-lookup"><span data-stu-id="ccd34-154">For example, Microsoft SQL Server has a VSS writer that ensures that the writes to the transaction log file and the database are done correctly.</span></span> <span data-ttu-id="ccd34-155">Для архивации виртуальных машин Windows в Azure создание точки восстановления, согласованной по приложениям, означает, что расширение архивации должно вызвать рабочий процесс VSS и завершить его до создания моментального снимка виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="ccd34-155">For Azure Windows VM backups, to create an application-consistent recovery point, the backup extension must invoke the VSS workflow and complete it before taking the VM snapshot.</span></span> <span data-ttu-id="ccd34-156">Чтобы моментальный снимок виртуальной машины Azure был точным, должны быть также завершены модули записи VSS всех приложений на виртуальной машине Azure.</span><span class="sxs-lookup"><span data-stu-id="ccd34-156">For the Azure VM snapshot to be accurate, the VSS writers of all Azure VM applications must complete as well.</span></span> <span data-ttu-id="ccd34-157">(Ознакомьтесь с [основными сведениями о службе VSS](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx) и подробными сведениями о [принципах ее работы](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx)).</span><span class="sxs-lookup"><span data-stu-id="ccd34-157">(Learn the [basics of VSS](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx) and dive deep into the details of [how it works](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx)).</span></span> </li> <li> <span data-ttu-id="ccd34-158">*Виртуальные машины Linux*. Клиенты могут выполнять [пользовательские предварительный и последующий скрипты, чтобы обеспечить согласованность приложений](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent).</span><span class="sxs-lookup"><span data-stu-id="ccd34-158">*Linux VMs*- Customers can execute [custom pre-script and post-script to ensure application consistency](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent).</span></span> </li> |
| <span data-ttu-id="ccd34-159">Согласованность файловой системы</span><span class="sxs-lookup"><span data-stu-id="ccd34-159">File-system consistency</span></span> |<span data-ttu-id="ccd34-160">Да — для компьютеров под управлением Windows</span><span class="sxs-lookup"><span data-stu-id="ccd34-160">Yes - for Windows-based computers</span></span> |<span data-ttu-id="ccd34-161">Существует два сценария, где точка восстановления может быть *согласованной с файловой системой*:</span><span class="sxs-lookup"><span data-stu-id="ccd34-161">There are two scenarios where the recovery point can be *file-system consistent*:</span></span><ul><li><span data-ttu-id="ccd34-162">резервные копии виртуальных машин Linux в Azure, для которых предварительный и последующий сценарии не запускались либо завершились ошибкой;</span><span class="sxs-lookup"><span data-stu-id="ccd34-162">Backups of Linux VMs in Azure, without pre-script/post-script or if pre-script/post-script failed.</span></span> <li><span data-ttu-id="ccd34-163">сбой VSS во время резервного копирования виртуальных машин Windows в Azure.</span><span class="sxs-lookup"><span data-stu-id="ccd34-163">VSS failure during backup for Windows VMs in Azure.</span></span></li></ul> <span data-ttu-id="ccd34-164">В обоих случаях система делает все возможное, чтобы обеспечить следующее.</span><span class="sxs-lookup"><span data-stu-id="ccd34-164">In both these cases, the best that can be done is to ensure that:</span></span> <ol><li> <span data-ttu-id="ccd34-165">Виртуальная машина *загружается*.</span><span class="sxs-lookup"><span data-stu-id="ccd34-165">The VM *boots up*.</span></span> <li><span data-ttu-id="ccd34-166">*Нет повреждений данных*.</span><span class="sxs-lookup"><span data-stu-id="ccd34-166">There is *no corruption*.</span></span><li><span data-ttu-id="ccd34-167">*Нет потерь данных*.</span><span class="sxs-lookup"><span data-stu-id="ccd34-167">There is *no data loss*.</span></span></ol> <span data-ttu-id="ccd34-168">Приложения должны реализовывать собственный механизм исправления восстановленных из архива данных.</span><span class="sxs-lookup"><span data-stu-id="ccd34-168">Applications need to implement their own "fix-up" mechanism on the restored data.</span></span> |
| <span data-ttu-id="ccd34-169">Отказоустойчивость</span><span class="sxs-lookup"><span data-stu-id="ccd34-169">Crash consistency</span></span> |<span data-ttu-id="ccd34-170">Нет</span><span class="sxs-lookup"><span data-stu-id="ccd34-170">No</span></span> |<span data-ttu-id="ccd34-171">Такая ситуация аналогична сбою виртуальной машины (приводит к программной или аппаратной перезагрузке).</span><span class="sxs-lookup"><span data-stu-id="ccd34-171">This situation is equivalent to a virtual machine experiencing a "crash" (through either a soft or hard reset).</span></span> <span data-ttu-id="ccd34-172">Отказоустойчивость обычно происходит при завершении работы виртуальной машины Azure во время архивации.</span><span class="sxs-lookup"><span data-stu-id="ccd34-172">Crash consistency typically happens when the Azure virtual machine is shut down at the time of backup.</span></span> <span data-ttu-id="ccd34-173">Отказоустойчивая точка восстановления не дает никаких гарантий в отношении согласованности данных на носителе (как с позиции операционной системы, так и с позиции приложения).</span><span class="sxs-lookup"><span data-stu-id="ccd34-173">A crash-consistent recovery point provides no guarantees around the consistency of the data on the storage medium--either from the perspective of the operating system or the application.</span></span> <span data-ttu-id="ccd34-174">Во время архивации создается резервная копия только тех данных, которые уже существуют на диске.</span><span class="sxs-lookup"><span data-stu-id="ccd34-174">Only the data that already exists on the disk at the time of backup is captured and backed up.</span></span> <br/> <br/> <span data-ttu-id="ccd34-175">Нет никаких гарантий, однако в большинстве случаев операционная система загружается, после чего выполняется процедура проверки диска (например, chkdsk) для исправления любых ошибок, связанных с его повреждением.</span><span class="sxs-lookup"><span data-stu-id="ccd34-175">While there are no guarantees, usually, the operating system boots, followed by disk-checking procedure, like chkdsk, to fix any corruption errors.</span></span> <span data-ttu-id="ccd34-176">Будут потеряны все данные, которые не были перенесены на диск.</span><span class="sxs-lookup"><span data-stu-id="ccd34-176">Any in-memory data or writes that have not been transferred to the disk are lost.</span></span> <span data-ttu-id="ccd34-177">В случае необходимости отката данных приложение обычно отслеживает его с помощью собственного механизма проверки.</span><span class="sxs-lookup"><span data-stu-id="ccd34-177">The application typically follows with its own verification mechanism in case data rollback needs to be done.</span></span> <br><br><span data-ttu-id="ccd34-178">Например, если журнал транзакций содержит записи, которых нет в базе данных, программное обеспечение базы данных выполняет откат до согласованных данных.</span><span class="sxs-lookup"><span data-stu-id="ccd34-178">As an example, if the transaction log has entries that are not present in the database, then the database software does a rollback until the data is consistent.</span></span> <span data-ttu-id="ccd34-179">Если данные распределены между несколькими виртуальными дисками (например составные тома), отказоустойчивые точки восстановления не гарантируют правильность данных.</span><span class="sxs-lookup"><span data-stu-id="ccd34-179">When data is spread across multiple virtual disks (like spanned volumes), a crash-consistent recovery point provides no guarantees for the correctness of the data.</span></span> |

## <a name="performance-and-resource-utilization"></a><span data-ttu-id="ccd34-180">Производительность и использование ресурсов</span><span class="sxs-lookup"><span data-stu-id="ccd34-180">Performance and resource utilization</span></span>
<span data-ttu-id="ccd34-181">Как и при локальном резервном копировании, при резервном копировании виртуальных машин в Azure важно учитывать ограничения по производительности и использованию ресурсов.</span><span class="sxs-lookup"><span data-stu-id="ccd34-181">Like backup software that is deployed on-premises, you should plan for capacity and resource utilization needs when backing up VMs in Azure.</span></span> <span data-ttu-id="ccd34-182">[Ограничения службы хранилища Azure](../azure-subscription-service-limits.md#storage-limits) определяют структуру развертывания виртуальных машин, обеспечивающую максимальную производительность и минимальное влияние на рабочие нагрузки.</span><span class="sxs-lookup"><span data-stu-id="ccd34-182">The [Azure Storage limits](../azure-subscription-service-limits.md#storage-limits) define how to structure VM deployments to get maximum performance with minimum impact to running workloads.</span></span>

<span data-ttu-id="ccd34-183">При планировании производительности резервного копирования обратите внимание на следующие ограничения службы хранилища Azure.</span><span class="sxs-lookup"><span data-stu-id="ccd34-183">Pay attention to the following Azure Storage limits when planning backup performance:</span></span>

* <span data-ttu-id="ccd34-184">Максимальный объем исходящих данных на учетную запись хранения.</span><span class="sxs-lookup"><span data-stu-id="ccd34-184">Max egress per storage account</span></span>
* <span data-ttu-id="ccd34-185">Общая частота запросов на учетную запись хранения.</span><span class="sxs-lookup"><span data-stu-id="ccd34-185">Total request rate per storage account</span></span>

### <a name="storage-account-limits"></a><span data-ttu-id="ccd34-186">Ограничения учетной записи хранения</span><span class="sxs-lookup"><span data-stu-id="ccd34-186">Storage account limits</span></span>
<span data-ttu-id="ccd34-187">Данные резервного копирования, которые копируются из учетной записи хранения, учитываются в метриках числа операций ввода-вывода в секунду и исходящего трафика (пропускной способности хранилища) для этой учетной записи хранения.</span><span class="sxs-lookup"><span data-stu-id="ccd34-187">Backup data copied from a storage account, adds to the input/output operations per second (IOPS) and egress (or throughput) metrics of the storage account.</span></span> <span data-ttu-id="ccd34-188">В то же время виртуальные машины также используют операции ввода-вывода и пропускную способность.</span><span class="sxs-lookup"><span data-stu-id="ccd34-188">At the same time, virtual machines are also consuming IOPS and throughput.</span></span> <span data-ttu-id="ccd34-189">Важно, чтобы объем трафика резервного копирования и трафика виртуальных машин не превышал ограничений для учетной записи хранения.</span><span class="sxs-lookup"><span data-stu-id="ccd34-189">The goal is to ensure Backup and virtual machine traffic don't exceed your storage account limits.</span></span>

### <a name="number-of-disks"></a><span data-ttu-id="ccd34-190">Количество дисков</span><span class="sxs-lookup"><span data-stu-id="ccd34-190">Number of disks</span></span>
<span data-ttu-id="ccd34-191">Операция резервного копирования пытается выполнить соответствующее задание как можно быстрее.</span><span class="sxs-lookup"><span data-stu-id="ccd34-191">The backup process tries to complete a backup job as quickly as possible.</span></span> <span data-ttu-id="ccd34-192">Поэтому она потребляет все доступные ресурсы.</span><span class="sxs-lookup"><span data-stu-id="ccd34-192">In doing so, it consumes as many resources as it can.</span></span> <span data-ttu-id="ccd34-193">Тем не менее все операции ввода-вывода ограничены *целевой пропускной способностью для одного большого двоичного объекта*. Предельное значение пропускной способности составляет 60 МБ в секунду.</span><span class="sxs-lookup"><span data-stu-id="ccd34-193">However, all I/O operations are limited by the *Target Throughput for Single Blob*, which has a limit of 60 MB per second.</span></span> <span data-ttu-id="ccd34-194">Чтобы максимально ускорить процесс, операция резервного копирования пытается *параллельно* создавать резервные копии всех дисков виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="ccd34-194">In an attempt to maximize its speed, the backup process tries to back up each of the VM's disks *in parallel*.</span></span> <span data-ttu-id="ccd34-195">Например, если у виртуальной машины четыре диска, то служба попытается архивировать все четыре диска одновременно.</span><span class="sxs-lookup"><span data-stu-id="ccd34-195">If a VM has four disks, the service attempts to back up all four disks in parallel.</span></span> <span data-ttu-id="ccd34-196">**Количество дисков**, для которых выполняется резервное копирование, — это основной фактор, определяющий объем трафика резервного копирования для этой учетной записи хранения.</span><span class="sxs-lookup"><span data-stu-id="ccd34-196">The **number of disks** being backed up, is the most important factor in determining storage account backup traffic.</span></span>

### <a name="backup-schedule"></a><span data-ttu-id="ccd34-197">Расписание резервного копирования</span><span class="sxs-lookup"><span data-stu-id="ccd34-197">Backup schedule</span></span>
<span data-ttu-id="ccd34-198">На производительность влияет также **расписание архивации**.</span><span class="sxs-lookup"><span data-stu-id="ccd34-198">An additional factor that impacts performance is the **backup schedule**.</span></span> <span data-ttu-id="ccd34-199">Если вы настроите политики так, чтобы резервное копирование всех виртуальных машин выполнялось в одно и то же время, это приведет к перегрузке.</span><span class="sxs-lookup"><span data-stu-id="ccd34-199">If you configure the policies so all VMs are backed up at the same time, you have scheduled a traffic jam.</span></span> <span data-ttu-id="ccd34-200">Операция резервного копирования пытается одновременно создать резервные копии всех дисков сразу.</span><span class="sxs-lookup"><span data-stu-id="ccd34-200">The backup process attempts to back up all disks in parallel.</span></span> <span data-ttu-id="ccd34-201">Чтобы уменьшить трафик резервного копирования от учетной записи хранения, резервное копирование разных виртуальных машин следует полностью разнести во времени.</span><span class="sxs-lookup"><span data-stu-id="ccd34-201">To reduce the backup traffic from a storage account, back up different VMs at different time of the day, with no overlap.</span></span>

## <a name="capacity-planning"></a><span data-ttu-id="ccd34-202">Планирование загрузки</span><span class="sxs-lookup"><span data-stu-id="ccd34-202">Capacity planning</span></span>
<span data-ttu-id="ccd34-203">Сложив все эти факторы, становится очевидным, что использование учетной записи хранения необходимо планировать должным образом.</span><span class="sxs-lookup"><span data-stu-id="ccd34-203">Putting the previous factors together, you need to plan for the storage account usage needs.</span></span> <span data-ttu-id="ccd34-204">Скачайте [лист Excel по планированию производительности архивации виртуальных машин](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33) , который позволит оценить влияние выбранного количества дисков и расписания архивации.</span><span class="sxs-lookup"><span data-stu-id="ccd34-204">Download the [VM backup capacity planning Excel spreadsheet](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33) to see the impact of your disk and backup schedule choices.</span></span>

### <a name="backup-throughput"></a><span data-ttu-id="ccd34-205">Пропускная способность при резервном копировании</span><span class="sxs-lookup"><span data-stu-id="ccd34-205">Backup throughput</span></span>
<span data-ttu-id="ccd34-206">Для каждого диска, для которого создается резервная копия, служба архивации Azure считывает блоки на диске и сохраняет только измененные данные (добавочное резервное копирование).</span><span class="sxs-lookup"><span data-stu-id="ccd34-206">For each disk being backed up, Azure Backup reads the blocks on the disk and stores only the changed data (incremental backup).</span></span> <span data-ttu-id="ccd34-207">В следующей таблице приведены средние значения пропускной способности службы архивации.</span><span class="sxs-lookup"><span data-stu-id="ccd34-207">The following table shows the average Backup service throughput values.</span></span> <span data-ttu-id="ccd34-208">Используя эти данные, можно рассчитать время архивации для диска заданного размера.</span><span class="sxs-lookup"><span data-stu-id="ccd34-208">Using the following data, you can estimate the amount of time needed to back up a disk of a given size.</span></span>

| <span data-ttu-id="ccd34-209">Операция резервного копирования</span><span class="sxs-lookup"><span data-stu-id="ccd34-209">Backup operation</span></span> | <span data-ttu-id="ccd34-210">Пропускная способность в лучшем случае</span><span class="sxs-lookup"><span data-stu-id="ccd34-210">Best-case throughput</span></span> |
| --- | --- |
| <span data-ttu-id="ccd34-211">Начальное резервное копирование</span><span class="sxs-lookup"><span data-stu-id="ccd34-211">Initial backup</span></span> |<span data-ttu-id="ccd34-212">160 Мбит/с</span><span class="sxs-lookup"><span data-stu-id="ccd34-212">160 Mbps</span></span> |
| <span data-ttu-id="ccd34-213">Добавочное резервное копирование (аварийное восстановление)</span><span class="sxs-lookup"><span data-stu-id="ccd34-213">Incremental backup (DR)</span></span> |<span data-ttu-id="ccd34-214">640 Мбит/с </span><span class="sxs-lookup"><span data-stu-id="ccd34-214">640 Mbps</span></span> <br><br> <span data-ttu-id="ccd34-215">Пропускная способность существенно снижается, если нужно выполнить архивацию разрозненных данных.</span><span class="sxs-lookup"><span data-stu-id="ccd34-215">Throughput drops significantly if the changed data (that needs to be backed up) is dispersed across the disk.</span></span>|

## <a name="total-vm-backup-time"></a><span data-ttu-id="ccd34-216">Общее время резервного копирования виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="ccd34-216">Total VM backup time</span></span>
<span data-ttu-id="ccd34-217">Больше всего времени занимают операции чтения и копирования данных, но есть и другие операции, которые влияют на общее время архивации виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="ccd34-217">While most of the backup time is spent reading and copying data, other operations contribute to the total time needed to back up a VM:</span></span>

* <span data-ttu-id="ccd34-218">Время на [установку или обновление расширения архивации](backup-azure-vms.md).</span><span class="sxs-lookup"><span data-stu-id="ccd34-218">Time needed to [install or update the backup extension](backup-azure-vms.md).</span></span>
* <span data-ttu-id="ccd34-219">Время создания моментального снимка, то есть время, необходимое для активации моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="ccd34-219">Snapshot time, which is the time taken to trigger a snapshot.</span></span> <span data-ttu-id="ccd34-220">Моментальные снимки активируются при приближении времени запланированной архивации.</span><span class="sxs-lookup"><span data-stu-id="ccd34-220">Snapshots are triggered close to the scheduled backup time.</span></span>
* <span data-ttu-id="ccd34-221">Время ожидания в очереди.</span><span class="sxs-lookup"><span data-stu-id="ccd34-221">Queue wait time.</span></span> <span data-ttu-id="ccd34-222">Так как служба архивации обрабатывает резервные копии от нескольких пользователей, копирование резервных данных из моментального снимка в службу архивации или службу восстановления может начаться не сразу.</span><span class="sxs-lookup"><span data-stu-id="ccd34-222">Since the Backup service is processing backups from multiple customers, copying backup data from snapshot to the backup or Recovery Services vault might not start immediately.</span></span> <span data-ttu-id="ccd34-223">В часы пиковой нагрузки время ожидания может достигать восьми часов из-за большого количества обрабатываемых резервных копий.</span><span class="sxs-lookup"><span data-stu-id="ccd34-223">In times of peak load, the wait can stretch up to eight hours due to the number of backups being processed.</span></span> <span data-ttu-id="ccd34-224">Тем не менее общее время архивации виртуальной машины не превышает 24 часов для политик ежедневной архивации.</span><span class="sxs-lookup"><span data-stu-id="ccd34-224">However, the total VM backup time is less than 24 hours for daily backup policies.</span></span>
* <span data-ttu-id="ccd34-225">Время переноса данных — это время, необходимое службе архивации для вычисления добавочных изменений из предыдущей резервной копии и переноса этих изменений в хранилище.</span><span class="sxs-lookup"><span data-stu-id="ccd34-225">Data transfer time, time needed for backup service to compute the incremental changes from previous backup and transfer those changes to vault storage.</span></span>

### <a name="why-am-i-observing-longer12-hours-backup-time"></a><span data-ttu-id="ccd34-226">Почему архивация выполняется дольше (более 12 ч)?</span><span class="sxs-lookup"><span data-stu-id="ccd34-226">Why am I observing longer(>12 hours) backup time?</span></span>
<span data-ttu-id="ccd34-227">Архивация состоит из двух этапов: создание моментальных снимков и перенос этих снимков в хранилище.</span><span class="sxs-lookup"><span data-stu-id="ccd34-227">Backup consists of two phases: taking snapshots and transferring the snapshots to the vault.</span></span> <span data-ttu-id="ccd34-228">Служба архивации выполняет оптимизацию для хранилища.</span><span class="sxs-lookup"><span data-stu-id="ccd34-228">The Backup service optimizes for storage.</span></span> <span data-ttu-id="ccd34-229">При передаче данных моментальных снимков в хранилище служба передает только добавочные изменения к предыдущему снимку.</span><span class="sxs-lookup"><span data-stu-id="ccd34-229">When transferring the snapshot data to a vault, the service only transfers incremental changes from the previous snapshot.</span></span>  <span data-ttu-id="ccd34-230">Чтобы определить добавочные изменения, служба вычисляет контрольную сумму блоков.</span><span class="sxs-lookup"><span data-stu-id="ccd34-230">To determine the incremental changes, the service computes the checksum of the blocks.</span></span> <span data-ttu-id="ccd34-231">Если блок изменился, то он определяется как блок, который необходимо отправить в хранилище.</span><span class="sxs-lookup"><span data-stu-id="ccd34-231">If a block is changed, the block is identified as a block to be sent to the vault.</span></span> <span data-ttu-id="ccd34-232">Затем служба глубже анализирует каждый из этих блоков и ищет возможности дальнейшего сокращения объема данных для передачи.</span><span class="sxs-lookup"><span data-stu-id="ccd34-232">Then the service drills further into each of the identified blocks, looking for opportunities to minimize the data to transfer.</span></span> <span data-ttu-id="ccd34-233">После оценки всех измененных блоков служба объединяет изменения и отправляет их в хранилище.</span><span class="sxs-lookup"><span data-stu-id="ccd34-233">After evaluating all changed blocks, the service coalesces the changes and sends them to the vault.</span></span> <span data-ttu-id="ccd34-234">В некоторых старых приложениях операции записи не оптимальны с точки зрения хранилища, так как они малого размера и фрагментированы.</span><span class="sxs-lookup"><span data-stu-id="ccd34-234">In some legacy applications, small, fragmented writes are not optimal for storage.</span></span> <span data-ttu-id="ccd34-235">Если моментальный снимок содержит много фрагментированных операций записи малого размера, то службе требуется дополнительное время на обработку данных, записанных приложениями.</span><span class="sxs-lookup"><span data-stu-id="ccd34-235">If the snapshot contains many small, fragmented writes, the service spends additional time processing the data written by the applications.</span></span> <span data-ttu-id="ccd34-236">Для приложений, выполняемых на виртуальной машине, рекомендуется использовать блоки записи из Azure объемом не менее 8 КБ.</span><span class="sxs-lookup"><span data-stu-id="ccd34-236">The recommended application write block from Azure, for applications running inside the VM, is a minimum of 8 KB.</span></span> <span data-ttu-id="ccd34-237">Если приложение использует блок объемом менее 8 КБ, то это негативно влияет на производительность резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="ccd34-237">If your application uses a block of less than 8 KB, backup performance is effected.</span></span> <span data-ttu-id="ccd34-238">Ознакомьтесь со статьей [Хранилище Azure класса "Премиум": разработка, обеспечивающая повышенную производительность](../storage/common/storage-premium-storage-performance.md), чтобы настроить приложение для повышения производительности резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="ccd34-238">For help with tuning your application to improve backup performance, see [Tuning applications for optimal performance with Azure storage](../storage/common/storage-premium-storage-performance.md).</span></span> <span data-ttu-id="ccd34-239">Хотя в этой статье рассматриваются примеры, использующие хранилище уровня "Премиум", инструкции также применимы к дискам хранилища уровня "Стандартный".</span><span class="sxs-lookup"><span data-stu-id="ccd34-239">Though the article on backup performance uses Premium storage examples, the guidance is applicable for Standard storage disks.</span></span>

## <a name="total-restore-time"></a><span data-ttu-id="ccd34-240">Общее время восстановления</span><span class="sxs-lookup"><span data-stu-id="ccd34-240">Total restore time</span></span>
<span data-ttu-id="ccd34-241">Операция восстановления состоит из двух основных подзадач: копирования данных из хранилища в выбранную клиентскую учетную запись хранения и создания виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="ccd34-241">A restore operation consists of two main sub tasks: Copying data back from the vault to the chosen customer storage account, and creating the virtual machine.</span></span> <span data-ttu-id="ccd34-242">Копирование данных из хранилища зависит от расположения, в котором хранятся резервные копии в Azure, и от расположения, в котором хранится клиентская учетная запись хранения.</span><span class="sxs-lookup"><span data-stu-id="ccd34-242">Copying data back from the vault depends on where the backups are stored internally in Azure, and where the customer storage account is stored.</span></span> <span data-ttu-id="ccd34-243">Время, необходимое для копирования данных, зависит от следующих факторов:</span><span class="sxs-lookup"><span data-stu-id="ccd34-243">Time taken to copy data depends upon:</span></span>
* <span data-ttu-id="ccd34-244">Время ожидания в очереди. Так как служба обрабатывает задания восстановления от нескольких клиентов одновременно, запросы на восстановление помещаются в очередь.</span><span class="sxs-lookup"><span data-stu-id="ccd34-244">Queue wait time - Since the service processes restore jobs from multiple customers at the same time, restore requests are put in a queue.</span></span>
* <span data-ttu-id="ccd34-245">Время копирования данных. Данные копируются из хранилища в учетную запись хранения клиента.</span><span class="sxs-lookup"><span data-stu-id="ccd34-245">Data copy time - Data is copied from the vault to the customer storage account.</span></span> <span data-ttu-id="ccd34-246">Время восстановления зависит от скорости ввода-вывода и пропускной способности, которую служба архивации Azure получает для выбранной учетной записи хранения клиента.</span><span class="sxs-lookup"><span data-stu-id="ccd34-246">Restore time depends on IOPS and throughput Azure Backup service gets on the selected customer storage account.</span></span> <span data-ttu-id="ccd34-247">Чтобы сократить время копирования в процессе восстановления, выберите учетную запись хранения, которая не загружена другими операциями чтения и записи приложений.</span><span class="sxs-lookup"><span data-stu-id="ccd34-247">To reduce the copying time during the restore process, select a storage account not loaded with other application writes and reads.</span></span>

## <a name="best-practices"></a><span data-ttu-id="ccd34-248">Рекомендации</span><span class="sxs-lookup"><span data-stu-id="ccd34-248">Best practices</span></span>
<span data-ttu-id="ccd34-249">Ниже приведены рекомендации, которые следует учитывать при настройке резервного копирования виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="ccd34-249">We suggest following these practices while configuring backups for virtual machines:</span></span>

* <span data-ttu-id="ccd34-250">Не планируйте одновременную архивацию более 10 классических виртуальных машин из одной облачной службы.</span><span class="sxs-lookup"><span data-stu-id="ccd34-250">Don't schedule more than 10 classic VMs from the same cloud service to back up at the same time.</span></span> <span data-ttu-id="ccd34-251">Если необходимо выполнять резервное копирование большого количества виртуальных машин из одной облачной службы, запускайте такие задания с промежутком в один час.</span><span class="sxs-lookup"><span data-stu-id="ccd34-251">If you want to back up multiple VMs from same cloud service, stagger the backup start times by an hour.</span></span>
* <span data-ttu-id="ccd34-252">Не планируйте одновременную архивацию более 40 виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="ccd34-252">Do not schedule more than 40 VMs to back up at the same time.</span></span>
* <span data-ttu-id="ccd34-253">Планируйте резервное копирование виртуальных машин на периоды низкой нагрузки.</span><span class="sxs-lookup"><span data-stu-id="ccd34-253">Schedule VM backups during non-peak hours.</span></span> <span data-ttu-id="ccd34-254">Таким образом, служба архивации получает достаточную скорость ввода-вывода для передачи данных из учетной записи хранения клиента в хранилище.</span><span class="sxs-lookup"><span data-stu-id="ccd34-254">This way the Backup service uses IOPS for transferring data from the customer storage account to the vault.</span></span>
* <span data-ttu-id="ccd34-255">Убедитесь, что политика применяется к виртуальным машинам, распределенным по нескольким учетным записям хранения.</span><span class="sxs-lookup"><span data-stu-id="ccd34-255">Make sure that a policy is applied on VMs spread across different storage accounts.</span></span> <span data-ttu-id="ccd34-256">Мы рекомендуем не включать в одно расписание архивации более 20 дисков из одной учетной записи хранения.</span><span class="sxs-lookup"><span data-stu-id="ccd34-256">We suggest no more than 20 total disks from a single storage account be protected by the same backup schedule.</span></span> <span data-ttu-id="ccd34-257">Если в вашей учетной записи хранения больше 20 дисков, разделите эти виртуальные машины между несколькими политиками. Так вы обеспечите достаточное количество операций ввода-вывода для этапа передачи данных при резервном копировании.</span><span class="sxs-lookup"><span data-stu-id="ccd34-257">If you have greater than 20 disks in a storage account, spread those VMs across multiple policies to get the required IOPS during the transfer phase of the backup process.</span></span>
* <span data-ttu-id="ccd34-258">Не выполняйте восстановление виртуальных машин, запущенных в хранилище класса Premium, в эту же учетную запись хранения.</span><span class="sxs-lookup"><span data-stu-id="ccd34-258">Do not restore a VM running on Premium storage to same storage account.</span></span> <span data-ttu-id="ccd34-259">Если процесс восстановления совпадет по времени с операцией резервного копирования, это снизит количество операций ввода-вывода, доступных для резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="ccd34-259">If the restore operation process coincides with the backup operation, it reduces the available IOPS for backup.</span></span>
* <span data-ttu-id="ccd34-260">Для успешной архивации виртуальных машин уровня "Премиум" убедитесь, что в учетной записи хранения, в которой размещены диски уровня "Премиум", свободно как минимум 50 % места для промежуточного хранения моментального снимка.</span><span class="sxs-lookup"><span data-stu-id="ccd34-260">For Premium VM backup, ensure that storage account that hosts premium disks has atleast 50% free space for staging snapshot for a successful backup.</span></span> 
* <span data-ttu-id="ccd34-261">Убедитесь, что на виртуальных машинах Linux с поддержкой архивации используется Python 2.7</span><span class="sxs-lookup"><span data-stu-id="ccd34-261">Make sure that python version on Linux VMs enabled for backup is 2.7</span></span>

## <a name="data-encryption"></a><span data-ttu-id="ccd34-262">Шифрование данных</span><span class="sxs-lookup"><span data-stu-id="ccd34-262">Data encryption</span></span>
<span data-ttu-id="ccd34-263">Служба архивации Azure не шифрует данные при архивации.</span><span class="sxs-lookup"><span data-stu-id="ccd34-263">Azure Backup does not encrypt data as a part of the backup process.</span></span> <span data-ttu-id="ccd34-264">Однако вы можете шифровать данные в виртуальной машине и легко архивировать защищенные данные (узнайте больше об [архивации зашифрованных данных](backup-azure-vms-encryption.md)).</span><span class="sxs-lookup"><span data-stu-id="ccd34-264">However, you can encrypt data within the VM and back up the protected data seamlessly (read more about [backup of encrypted data](backup-azure-vms-encryption.md)).</span></span>

## <a name="calculating-the-cost-of-protected-instances"></a><span data-ttu-id="ccd34-265">Вычисление стоимости защищенных экземпляров</span><span class="sxs-lookup"><span data-stu-id="ccd34-265">Calculating the cost of protected instances</span></span>
<span data-ttu-id="ccd34-266">Оплата архивации виртуальных машин с помощью службы архивации Azure выполняется в соответствии с [ценами на службу архивации Azure](https://azure.microsoft.com/pricing/details/backup/).</span><span class="sxs-lookup"><span data-stu-id="ccd34-266">Azure virtual machines that are backed up through Azure Backup are subject to [Azure Backup pricing](https://azure.microsoft.com/pricing/details/backup/).</span></span> <span data-ttu-id="ccd34-267">Вычисление защищенных экземпляров основано на *фактическом* размере виртуальной машины, который представляет собой сумму всех данных на виртуальной машине за исключением "диска ресурсов".</span><span class="sxs-lookup"><span data-stu-id="ccd34-267">The Protected Instances calculation is based on the *actual* size of the virtual machine, which is the sum of all the data in the virtual machine--excluding the “resource disk.”</span></span>

<span data-ttu-id="ccd34-268">Стоимость резервного копирования виртуальных машин *не* зависит от максимальных размеров всех дисков данных, которые подключены к виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="ccd34-268">Pricing for backing up VMs is *not* based on the maximum supported size for each data disk attached to the virtual machine.</span></span> <span data-ttu-id="ccd34-269">Она основана на фактических данных, хранящихся на диске данных.</span><span class="sxs-lookup"><span data-stu-id="ccd34-269">Pricing is based on the actual data stored in the data disk.</span></span> <span data-ttu-id="ccd34-270">Аналогичным образом счет за хранилище службы архивации основан на объеме данных, хранящихся в службе архивации Azure, который представляет собой сумму фактических данных в каждой точке восстановления.</span><span class="sxs-lookup"><span data-stu-id="ccd34-270">Similarly, the backup storage bill is based on the amount of data that is stored in Azure Backup, which is the sum of the actual data in each recovery point.</span></span>

<span data-ttu-id="ccd34-271">Например, возьмем виртуальную машину стандартного размера A2 с двумя дополнительными дисками максимальным объемом 1 ТБ каждый.</span><span class="sxs-lookup"><span data-stu-id="ccd34-271">For example, take an A2 Standard-sized virtual machine that has two additional data disks with a maximum size of 1 TB each.</span></span> <span data-ttu-id="ccd34-272">В следующей таблице приводятся фактические данные, хранящиеся на каждом из этих дисков:</span><span class="sxs-lookup"><span data-stu-id="ccd34-272">The following table gives the actual data stored on each of these disks:</span></span>

| <span data-ttu-id="ccd34-273">Тип диска</span><span class="sxs-lookup"><span data-stu-id="ccd34-273">Disk type</span></span> | <span data-ttu-id="ccd34-274">Максимальный размер</span><span class="sxs-lookup"><span data-stu-id="ccd34-274">Max size</span></span> | <span data-ttu-id="ccd34-275">Фактические данные</span><span class="sxs-lookup"><span data-stu-id="ccd34-275">Actual data present</span></span> |
| --- | --- | --- |
| <span data-ttu-id="ccd34-276">Диск операционной системы</span><span class="sxs-lookup"><span data-stu-id="ccd34-276">Operating system disk</span></span> |<span data-ttu-id="ccd34-277">1023 ГБ</span><span class="sxs-lookup"><span data-stu-id="ccd34-277">1023 GB</span></span> |<span data-ttu-id="ccd34-278">17 ГБ</span><span class="sxs-lookup"><span data-stu-id="ccd34-278">17 GB</span></span> |
| <span data-ttu-id="ccd34-279">Локальный диск или диск ресурсов</span><span class="sxs-lookup"><span data-stu-id="ccd34-279">Local disk / Resource disk</span></span> |<span data-ttu-id="ccd34-280">135 ГБ</span><span class="sxs-lookup"><span data-stu-id="ccd34-280">135 GB</span></span> |<span data-ttu-id="ccd34-281">5 ГБ (не учитывается для архивации)</span><span class="sxs-lookup"><span data-stu-id="ccd34-281">5 GB (not included for backup)</span></span> |
| <span data-ttu-id="ccd34-282">Диск данных 1</span><span class="sxs-lookup"><span data-stu-id="ccd34-282">Data disk 1</span></span> |<span data-ttu-id="ccd34-283">1023 ГБ</span><span class="sxs-lookup"><span data-stu-id="ccd34-283">1023 GB</span></span> |<span data-ttu-id="ccd34-284">30 ГБ</span><span class="sxs-lookup"><span data-stu-id="ccd34-284">30 GB</span></span> |
| <span data-ttu-id="ccd34-285">Диск данных 2</span><span class="sxs-lookup"><span data-stu-id="ccd34-285">Data disk 2</span></span> |<span data-ttu-id="ccd34-286">1023 ГБ</span><span class="sxs-lookup"><span data-stu-id="ccd34-286">1023 GB</span></span> |<span data-ttu-id="ccd34-287">0 ГБ</span><span class="sxs-lookup"><span data-stu-id="ccd34-287">0 GB</span></span> |

<span data-ttu-id="ccd34-288">*Фактический* размер виртуальной машины в данном случае равен 17 ГБ + 30 ГБ + 0 ГБ = 47 ГБ.</span><span class="sxs-lookup"><span data-stu-id="ccd34-288">The *actual* size of the virtual machine in this case is 17 GB + 30 GB + 0 GB = 47 GB.</span></span> <span data-ttu-id="ccd34-289">Этот размер защищенного экземпляра (47 ГБ) служит основой для ежемесячного счета.</span><span class="sxs-lookup"><span data-stu-id="ccd34-289">This Protected Instance size (47 GB) becomes the basis for the monthly bill.</span></span> <span data-ttu-id="ccd34-290">Если объем данных на виртуальной машине увеличивается, соответствующим образом изменяется размер защищенного экземпляра, используемый для тарификации услуг.</span><span class="sxs-lookup"><span data-stu-id="ccd34-290">As the amount of data in the virtual machine grows, the Protected Instance size used for billing changes accordingly.</span></span>

<span data-ttu-id="ccd34-291">Оплачиваемый период начинается только после завершения первой успешной архивации.</span><span class="sxs-lookup"><span data-stu-id="ccd34-291">Billing does not start until the first successful backup completes.</span></span> <span data-ttu-id="ccd34-292">На этом этапе начинается выставление счетов за службу хранилища и защищенные экземпляры.</span><span class="sxs-lookup"><span data-stu-id="ccd34-292">At this point, the billing for both Storage and Protected Instances begins.</span></span> <span data-ttu-id="ccd34-293">Оплачиваемый период длится до тех пор, пока *в хранилище есть резервные копии данных* для виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="ccd34-293">Billing continues as long as there is *any backup data stored in a vault* for the virtual machine.</span></span> <span data-ttu-id="ccd34-294">Остановка защиты для виртуальной машины не останавливает выставление счетов, если резервная копия данных остается в хранилище.</span><span class="sxs-lookup"><span data-stu-id="ccd34-294">If you stop protection on the virtual machine, but virtual machine backup data exists in a vault, billing continues.</span></span>

<span data-ttu-id="ccd34-295">Выставление счетов для определенной виртуальной машины прекращается, только если останавливается защита *и* удаляются все данные резервных копий.</span><span class="sxs-lookup"><span data-stu-id="ccd34-295">Billing for a specified virtual machine stops only if the protection is stopped *and* all backup data is deleted.</span></span> <span data-ttu-id="ccd34-296">Когда защита останавливается и нет активных заданий резервного копирования, размер виртуальной машины во время последнего успешного резервного копирования становится размером защищенного экземпляра, на основе которого выставляется ежемесячный счет.</span><span class="sxs-lookup"><span data-stu-id="ccd34-296">When protection stops and there are no active backup jobs, the size of the last successful VM backup becomes the Protected Instance size used for the monthly bill.</span></span>

## <a name="questions"></a><span data-ttu-id="ccd34-297">Вопросы?</span><span class="sxs-lookup"><span data-stu-id="ccd34-297">Questions?</span></span>
<span data-ttu-id="ccd34-298">Если вы хотите задать вопрос или предложить добавить какие-либо функции, [отправьте нам свой отзыв](http://aka.ms/azurebackup_feedback).</span><span class="sxs-lookup"><span data-stu-id="ccd34-298">If you have questions, or if there is any feature that you would like to see included, [send us feedback](http://aka.ms/azurebackup_feedback).</span></span>

## <a name="next-steps"></a><span data-ttu-id="ccd34-299">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="ccd34-299">Next steps</span></span>
* [<span data-ttu-id="ccd34-300">Настройка виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="ccd34-300">Back up virtual machines</span></span>](backup-azure-vms.md)
* [<span data-ttu-id="ccd34-301">Управление резервными копиями виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="ccd34-301">Manage virtual machine backup</span></span>](backup-azure-manage-vms.md)
* [<span data-ttu-id="ccd34-302">Восстановление виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="ccd34-302">Restore virtual machines</span></span>](backup-azure-restore-vms.md)
* [<span data-ttu-id="ccd34-303">Устранение проблем с резервным копированием виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="ccd34-303">Troubleshoot VM backup issues</span></span>](backup-azure-vms-troubleshoot.md)

---
title: "Планирование инфраструктуры архивации виртуальных машин | Документация Майкрософт"
description: "Важные вопросы при планировании резервного копирования виртуальных машин в Azure"
services: backup
documentationcenter: 
author: markgalioto
manager: carmonm
editor: 
keywords: "архивация ВМ, архивация виртуальных машин"
ms.assetid: 19d2cf82-1f60-43e1-b089-9238042887a9
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 7/18/2017
ms.author: markgal;trinadhk
ms.openlocfilehash: 0c930c7413b24a811707c3a1ff3d7d70585bc528
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="plan-your-vm-backup-infrastructure-in-azure"></a>Планирование инфраструктуры резервного копирования виртуальных машин в Azure
Эта статья содержит рекомендации по производительности и ресурсам, которые помогут спроектировать инфраструктуру резервного копирования виртуальных машин. Также здесь приводятся ключевые определения службы архивации; эти аспекты могут быть критически важными при определении архитектуры, планировании и распределении мощностей. Если вы уже [подготовили среду](backup-azure-vms-prepare.md), то следующий шаг (планирование) позволит начать [архивацию виртуальных машин](backup-azure-vms.md). Дополнительные сведения о виртуальных машинах Azure содержатся в [документации по виртуальным машинам](https://azure.microsoft.com/documentation/services/virtual-machines/).

## <a name="how-does-azure-back-up-virtual-machines"></a>Как Azure выполняет резервное копирование виртуальных машин
Служба архивации Azure по установленному расписанию запускает задание резервного копирования. При этом модуль резервного копирования создает снимок текущего состояния. Служба архивации Azure использует расширение _VMSnapshot_ в Windows и расширение _VMSnapshotLinux_ в Linux. Расширение устанавливается во время первого резервного копирования виртуальной машины. Для установки расширения виртуальная машина должна быть запущена. Если виртуальная машина не запущена, служба резервного копирования создает моментальный снимок базового хранилища (так как операции записи в приложении не выполняются, пока виртуальная машина остановлена).

Во время создания моментального снимка виртуальных машин Windows служба архивации координируется со службой теневого копирования томов (VSS), что позволяет создать согласованный моментальный снимок дисков виртуальной машины. Если вы создаете резервные копии виртуальных машин Linux, то можете создать собственный скрипт для обеспечения согласованности при создании моментального снимка. Подробные сведения о вызове таких скриптов приводятся далее в этой статье.

После создания моментального снимка службой архивации Azure данные передаются в хранилище. Для повышения эффективности служба анализирует блоки данных и передает только те из них, которые были изменены с момента предыдущего резервного копирования.

![Архитектура резервного копирования виртуальных машин Azure](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

После передачи данных служба удаляет моментальный снимок и создает точку восстановления.

> [!NOTE]
> 1. Во время резервного копирования служба архивации Azure не использует временный диск, подключенный к виртуальной машине. Дополнительные сведения см. в записи блога о [временном хранилище](https://blogs.msdn.microsoft.com/mast/2013/12/06/understanding-the-temporary-drive-on-windows-azure-virtual-machines/).
> 2. Так как служба архивации Azure создает моментальный снимок на уровне хранилища и передает его в хранилище, не меняйте ключи учетной записи хранения, пока задание резервного копирования не завершится.
> 3. Для виртуальных машин из ценовой категории "Премиум" мы копируем моментальный снимок для учетной записи хранилища. Это позволяет гарантировать, что служба Microsoft Azure Backup получает достаточно операций ввода-вывода для передачи данных в хранилище. Такая дополнительная копия хранилища оплачивается согласно выделенному размеру виртуальной машины. 
>

### <a name="data-consistency"></a>Согласованность данных
Резервное копирование и восстановление критически важных для бизнеса данных осложняются тем, что копирование этих данных должно выполняться во время работы приложений, которые создают эти данные. Для решения этой задачи служба архивации Azure поддерживает резервные копии с согласованием приложений для виртуальных машин Windows и Linux.
#### <a name="windows-vm"></a>Виртуальная машина Windows
Служба архивации Azure принимает полные резервные копии VSS на виртуальных машинах Windows (дополнительные сведения см. в записи блога о [полном резервном копировании VSS](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx)). Чтобы включить копирующую архивацию VSS, для виртуальной машины необходимо задать приведенный ниже раздел реестра.

```
[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
"USEVSSCOPYBACKUP"="TRUE"
```

#### <a name="linux-vms"></a>Виртуальные машины Linux
Служба архивации Azure предоставляет платформу скриптов. Для обеспечения согласованности приложений при резервном копировании виртуальных машин Linux создайте скрипты, выполняемые до и после резервного копирования, с целью контроля рабочего процесса резервного копирования и среды. Служба архивации Azure вызывает предварительный скрипт перед созданием моментального снимка виртуальной машины, а последующий скрипт — после того, как задание создания моментального снимка виртуальной машины завершится. Подробные сведения см. в разделе [Согласованное с приложениями резервное копирование виртуальных машин Azure Linux](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent).
> [!NOTE]
> Служба архивации Azure вызывает только созданные клиентом скрипты, выполняемые до и после резервного копирования. Если предварительный и последующий скрипты будут успешно выполнены, служба архивации Azure пометит точку восстановления как согласованную по приложениям. Однако при использовании пользовательских скриптов ответственность за согласованность приложений в конечном итоге несет клиент.
>


Следующая таблица содержит типы целостности информации, их описания и условия соблюдения при архивации и восстановлении виртуальных машин Azure.

| Целостность | На основе VSS | Подробное объяснение |
| --- | --- | --- |
| Целостность на уровне приложения |Да для Windows.|Согласованность приложений идеально подходит для рабочих нагрузок, так как гарантирует следующее:<ol><li> Виртуальная машина *загружается*. <li>*Нет повреждений данных*. <li>*Нет потерь данных*.<li> Данные согласованы с приложением, которое их использует, за счет привлечения приложения во время архивации (с помощью VSS или предварительного и последующего сценариев).</ol> <li>*Виртуальные машины Windows*. Большинство рабочих нагрузок Майкрософт имеют модули записи VSS, которые выполняют специальные действия, обеспечивающие согласованность данных. Например, Microsoft SQL Server содержит модуль записи VSS, обеспечивающий правильное выполнение операций записи в файл журнала транзакций и базы данных. Для архивации виртуальных машин Windows в Azure создание точки восстановления, согласованной по приложениям, означает, что расширение архивации должно вызвать рабочий процесс VSS и завершить его до создания моментального снимка виртуальной машины. Чтобы моментальный снимок виртуальной машины Azure был точным, должны быть также завершены модули записи VSS всех приложений на виртуальной машине Azure. (Ознакомьтесь с [основными сведениями о службе VSS](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx) и подробными сведениями о [принципах ее работы](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx)). </li> <li> *Виртуальные машины Linux*. Клиенты могут выполнять [пользовательские предварительный и последующий скрипты, чтобы обеспечить согласованность приложений](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent). </li> |
| Согласованность файловой системы |Да — для компьютеров под управлением Windows |Существует два сценария, где точка восстановления может быть *согласованной с файловой системой*:<ul><li>резервные копии виртуальных машин Linux в Azure, для которых предварительный и последующий сценарии не запускались либо завершились ошибкой; <li>сбой VSS во время резервного копирования виртуальных машин Windows в Azure.</li></ul> В обоих случаях система делает все возможное, чтобы обеспечить следующее. <ol><li> Виртуальная машина *загружается*. <li>*Нет повреждений данных*.<li>*Нет потерь данных*.</ol> Приложения должны реализовывать собственный механизм исправления восстановленных из архива данных. |
| Отказоустойчивость |Нет |Такая ситуация аналогична сбою виртуальной машины (приводит к программной или аппаратной перезагрузке). Отказоустойчивость обычно происходит при завершении работы виртуальной машины Azure во время архивации. Отказоустойчивая точка восстановления не дает никаких гарантий в отношении согласованности данных на носителе (как с позиции операционной системы, так и с позиции приложения). Во время архивации создается резервная копия только тех данных, которые уже существуют на диске. <br/> <br/> Нет никаких гарантий, однако в большинстве случаев операционная система загружается, после чего выполняется процедура проверки диска (например, chkdsk) для исправления любых ошибок, связанных с его повреждением. Будут потеряны все данные, которые не были перенесены на диск. В случае необходимости отката данных приложение обычно отслеживает его с помощью собственного механизма проверки. <br><br>Например, если журнал транзакций содержит записи, которых нет в базе данных, программное обеспечение базы данных выполняет откат до согласованных данных. Если данные распределены между несколькими виртуальными дисками (например составные тома), отказоустойчивые точки восстановления не гарантируют правильность данных. |

## <a name="performance-and-resource-utilization"></a>Производительность и использование ресурсов
Как и при локальном резервном копировании, при резервном копировании виртуальных машин в Azure важно учитывать ограничения по производительности и использованию ресурсов. [Ограничения службы хранилища Azure](../azure-subscription-service-limits.md#storage-limits) определяют структуру развертывания виртуальных машин, обеспечивающую максимальную производительность и минимальное влияние на рабочие нагрузки.

При планировании производительности резервного копирования обратите внимание на следующие ограничения службы хранилища Azure.

* Максимальный объем исходящих данных на учетную запись хранения.
* Общая частота запросов на учетную запись хранения.

### <a name="storage-account-limits"></a>Ограничения учетной записи хранения
Данные резервного копирования, которые копируются из учетной записи хранения, учитываются в метриках числа операций ввода-вывода в секунду и исходящего трафика (пропускной способности хранилища) для этой учетной записи хранения. В то же время виртуальные машины также используют операции ввода-вывода и пропускную способность. Важно, чтобы объем трафика резервного копирования и трафика виртуальных машин не превышал ограничений для учетной записи хранения.

### <a name="number-of-disks"></a>Количество дисков
Операция резервного копирования пытается выполнить соответствующее задание как можно быстрее. Поэтому она потребляет все доступные ресурсы. Тем не менее все операции ввода-вывода ограничены *целевой пропускной способностью для одного большого двоичного объекта*. Предельное значение пропускной способности составляет 60 МБ в секунду. Чтобы максимально ускорить процесс, операция резервного копирования пытается *параллельно* создавать резервные копии всех дисков виртуальной машины. Например, если у виртуальной машины четыре диска, то служба попытается архивировать все четыре диска одновременно. **Количество дисков**, для которых выполняется резервное копирование, — это основной фактор, определяющий объем трафика резервного копирования для этой учетной записи хранения.

### <a name="backup-schedule"></a>Расписание резервного копирования
На производительность влияет также **расписание архивации**. Если вы настроите политики так, чтобы резервное копирование всех виртуальных машин выполнялось в одно и то же время, это приведет к перегрузке. Операция резервного копирования пытается одновременно создать резервные копии всех дисков сразу. Чтобы уменьшить трафик резервного копирования от учетной записи хранения, резервное копирование разных виртуальных машин следует полностью разнести во времени.

## <a name="capacity-planning"></a>Планирование загрузки
Сложив все эти факторы, становится очевидным, что использование учетной записи хранения необходимо планировать должным образом. Скачайте [лист Excel по планированию производительности архивации виртуальных машин](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33) , который позволит оценить влияние выбранного количества дисков и расписания архивации.

### <a name="backup-throughput"></a>Пропускная способность при резервном копировании
Для каждого диска, для которого создается резервная копия, служба архивации Azure считывает блоки на диске и сохраняет только измененные данные (добавочное резервное копирование). В следующей таблице приведены средние значения пропускной способности службы архивации. Используя эти данные, можно рассчитать время архивации для диска заданного размера.

| Операция резервного копирования | Пропускная способность в лучшем случае |
| --- | --- |
| Начальное резервное копирование |160 Мбит/с |
| Добавочное резервное копирование (аварийное восстановление) |640 Мбит/с  <br><br> Пропускная способность существенно снижается, если нужно выполнить архивацию разрозненных данных.|

## <a name="total-vm-backup-time"></a>Общее время резервного копирования виртуальной машины
Больше всего времени занимают операции чтения и копирования данных, но есть и другие операции, которые влияют на общее время архивации виртуальной машины.

* Время на [установку или обновление расширения архивации](backup-azure-vms.md).
* Время создания моментального снимка, то есть время, необходимое для активации моментального снимка. Моментальные снимки активируются при приближении времени запланированной архивации.
* Время ожидания в очереди. Так как служба архивации обрабатывает резервные копии от нескольких пользователей, копирование резервных данных из моментального снимка в службу архивации или службу восстановления может начаться не сразу. В часы пиковой нагрузки время ожидания может достигать восьми часов из-за большого количества обрабатываемых резервных копий. Тем не менее общее время архивации виртуальной машины не превышает 24 часов для политик ежедневной архивации.
* Время переноса данных — это время, необходимое службе архивации для вычисления добавочных изменений из предыдущей резервной копии и переноса этих изменений в хранилище.

### <a name="why-am-i-observing-longer12-hours-backup-time"></a>Почему архивация выполняется дольше (более 12 ч)?
Архивация состоит из двух этапов: создание моментальных снимков и перенос этих снимков в хранилище. Служба архивации выполняет оптимизацию для хранилища. При передаче данных моментальных снимков в хранилище служба передает только добавочные изменения к предыдущему снимку.  Чтобы определить добавочные изменения, служба вычисляет контрольную сумму блоков. Если блок изменился, то он определяется как блок, который необходимо отправить в хранилище. Затем служба глубже анализирует каждый из этих блоков и ищет возможности дальнейшего сокращения объема данных для передачи. После оценки всех измененных блоков служба объединяет изменения и отправляет их в хранилище. В некоторых старых приложениях операции записи не оптимальны с точки зрения хранилища, так как они малого размера и фрагментированы. Если моментальный снимок содержит много фрагментированных операций записи малого размера, то службе требуется дополнительное время на обработку данных, записанных приложениями. Для приложений, выполняемых на виртуальной машине, рекомендуется использовать блоки записи из Azure объемом не менее 8 КБ. Если приложение использует блок объемом менее 8 КБ, то это негативно влияет на производительность резервного копирования. Ознакомьтесь со статьей [Хранилище Azure класса "Премиум": разработка, обеспечивающая повышенную производительность](../storage/common/storage-premium-storage-performance.md), чтобы настроить приложение для повышения производительности резервного копирования. Хотя в этой статье рассматриваются примеры, использующие хранилище уровня "Премиум", инструкции также применимы к дискам хранилища уровня "Стандартный".

## <a name="total-restore-time"></a>Общее время восстановления
Операция восстановления состоит из двух основных подзадач: копирования данных из хранилища в выбранную клиентскую учетную запись хранения и создания виртуальной машины. Копирование данных из хранилища зависит от расположения, в котором хранятся резервные копии в Azure, и от расположения, в котором хранится клиентская учетная запись хранения. Время, необходимое для копирования данных, зависит от следующих факторов:
* Время ожидания в очереди. Так как служба обрабатывает задания восстановления от нескольких клиентов одновременно, запросы на восстановление помещаются в очередь.
* Время копирования данных. Данные копируются из хранилища в учетную запись хранения клиента. Время восстановления зависит от скорости ввода-вывода и пропускной способности, которую служба архивации Azure получает для выбранной учетной записи хранения клиента. Чтобы сократить время копирования в процессе восстановления, выберите учетную запись хранения, которая не загружена другими операциями чтения и записи приложений.

## <a name="best-practices"></a>Рекомендации
Ниже приведены рекомендации, которые следует учитывать при настройке резервного копирования виртуальных машин.

* Не планируйте одновременную архивацию более 10 классических виртуальных машин из одной облачной службы. Если необходимо выполнять резервное копирование большого количества виртуальных машин из одной облачной службы, запускайте такие задания с промежутком в один час.
* Не планируйте одновременную архивацию более 40 виртуальных машин.
* Планируйте резервное копирование виртуальных машин на периоды низкой нагрузки. Таким образом, служба архивации получает достаточную скорость ввода-вывода для передачи данных из учетной записи хранения клиента в хранилище.
* Убедитесь, что политика применяется к виртуальным машинам, распределенным по нескольким учетным записям хранения. Мы рекомендуем не включать в одно расписание архивации более 20 дисков из одной учетной записи хранения. Если в вашей учетной записи хранения больше 20 дисков, разделите эти виртуальные машины между несколькими политиками. Так вы обеспечите достаточное количество операций ввода-вывода для этапа передачи данных при резервном копировании.
* Не выполняйте восстановление виртуальных машин, запущенных в хранилище класса Premium, в эту же учетную запись хранения. Если процесс восстановления совпадет по времени с операцией резервного копирования, это снизит количество операций ввода-вывода, доступных для резервного копирования.
* Для успешной архивации виртуальных машин уровня "Премиум" убедитесь, что в учетной записи хранения, в которой размещены диски уровня "Премиум", свободно как минимум 50 % места для промежуточного хранения моментального снимка. 
* Убедитесь, что на виртуальных машинах Linux с поддержкой архивации используется Python 2.7

## <a name="data-encryption"></a>Шифрование данных
Служба архивации Azure не шифрует данные при архивации. Однако вы можете шифровать данные в виртуальной машине и легко архивировать защищенные данные (узнайте больше об [архивации зашифрованных данных](backup-azure-vms-encryption.md)).

## <a name="calculating-the-cost-of-protected-instances"></a>Вычисление стоимости защищенных экземпляров
Оплата архивации виртуальных машин с помощью службы архивации Azure выполняется в соответствии с [ценами на службу архивации Azure](https://azure.microsoft.com/pricing/details/backup/). Вычисление защищенных экземпляров основано на *фактическом* размере виртуальной машины, который представляет собой сумму всех данных на виртуальной машине за исключением "диска ресурсов".

Стоимость резервного копирования виртуальных машин *не* зависит от максимальных размеров всех дисков данных, которые подключены к виртуальной машине. Она основана на фактических данных, хранящихся на диске данных. Аналогичным образом счет за хранилище службы архивации основан на объеме данных, хранящихся в службе архивации Azure, который представляет собой сумму фактических данных в каждой точке восстановления.

Например, возьмем виртуальную машину стандартного размера A2 с двумя дополнительными дисками максимальным объемом 1 ТБ каждый. В следующей таблице приводятся фактические данные, хранящиеся на каждом из этих дисков:

| Тип диска | Максимальный размер | Фактические данные |
| --- | --- | --- |
| Диск операционной системы |1023 ГБ |17 ГБ |
| Локальный диск или диск ресурсов |135 ГБ |5 ГБ (не учитывается для архивации) |
| Диск данных 1 |1023 ГБ |30 ГБ |
| Диск данных 2 |1023 ГБ |0 ГБ |

*Фактический* размер виртуальной машины в данном случае равен 17 ГБ + 30 ГБ + 0 ГБ = 47 ГБ. Этот размер защищенного экземпляра (47 ГБ) служит основой для ежемесячного счета. Если объем данных на виртуальной машине увеличивается, соответствующим образом изменяется размер защищенного экземпляра, используемый для тарификации услуг.

Оплачиваемый период начинается только после завершения первой успешной архивации. На этом этапе начинается выставление счетов за службу хранилища и защищенные экземпляры. Оплачиваемый период длится до тех пор, пока *в хранилище есть резервные копии данных* для виртуальной машины. Остановка защиты для виртуальной машины не останавливает выставление счетов, если резервная копия данных остается в хранилище.

Выставление счетов для определенной виртуальной машины прекращается, только если останавливается защита *и* удаляются все данные резервных копий. Когда защита останавливается и нет активных заданий резервного копирования, размер виртуальной машины во время последнего успешного резервного копирования становится размером защищенного экземпляра, на основе которого выставляется ежемесячный счет.

## <a name="questions"></a>Вопросы?
Если вы хотите задать вопрос или предложить добавить какие-либо функции, [отправьте нам свой отзыв](http://aka.ms/azurebackup_feedback).

## <a name="next-steps"></a>Дальнейшие действия
* [Настройка виртуальных машин](backup-azure-vms.md)
* [Управление резервными копиями виртуальной машины](backup-azure-manage-vms.md)
* [Восстановление виртуальных машин](backup-azure-restore-vms.md)
* [Устранение проблем с резервным копированием виртуальных машин](backup-azure-vms-troubleshoot.md)

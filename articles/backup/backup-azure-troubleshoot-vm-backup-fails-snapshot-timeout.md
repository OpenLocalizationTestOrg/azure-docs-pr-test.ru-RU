---
title: "Устранение сбоя службы Azure Backup: состояние гостевого агента \"Недоступно\" | Документация Майкрософт"
description: "Симптомы, причины и способы устранения проблем в работе службы Azure Backup, связанных с ошибкой: Could not communicate with the VM agent (Не удалось связаться с агентом виртуальной машины)"
services: backup
documentationcenter: 
author: genlin
manager: cshepard
editor: 
keywords: Azure backup; VM agent; Network connectivity;
ms.assetid: 4b02ffa4-c48e-45f6-8363-73d536be4639
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/17/2017
ms.author: genli;markgal;
ms.openlocfilehash: 6ed651bb8caafd18cec93e68ac70e27f92133e5c
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="troubleshoot-azure-backup-failure-issues-with-agent-andor-extension"></a><span data-ttu-id="8f840-104">Устранение неполадок службы Azure Backup: проблемы с агентом и/или расширением</span><span class="sxs-lookup"><span data-stu-id="8f840-104">Troubleshoot Azure Backup failure: Issues with agent and/or extension</span></span>

<span data-ttu-id="8f840-105">В этой статье описано, как устранять неполадки службы архивации, связанные с ошибками связи с агентом виртуальной машины и расширением.</span><span class="sxs-lookup"><span data-stu-id="8f840-105">This article provides troubleshooting steps to help you resolve Backup failures related to problems in communication with VM agent and extension.</span></span>

[!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]

## <a name="vm-agent-unable-to-communicate-with-azure-backup"></a><span data-ttu-id="8f840-106">Агенту виртуальной машины не удается установить связь со службой Azure Backup</span><span class="sxs-lookup"><span data-stu-id="8f840-106">VM Agent unable to communicate with Azure Backup</span></span>
<span data-ttu-id="8f840-107">После регистрации виртуальной машины в службе Azure Backup и добавления ее в расписание служба архивации инициирует задание, взаимодействуя с агентом виртуальной машины, чтобы создать моментальный снимок.</span><span class="sxs-lookup"><span data-stu-id="8f840-107">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM agent to take a point-in-time snapshot.</span></span> <span data-ttu-id="8f840-108">Любое из следующих условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup.</span><span class="sxs-lookup"><span data-stu-id="8f840-108">Any of the following conditions might prevent the snapshot from being triggered, which in turn can lead to Backup failure.</span></span> <span data-ttu-id="8f840-109">Выполните инструкции по устранению неполадок в указанном порядке и повторите операцию.</span><span class="sxs-lookup"><span data-stu-id="8f840-109">Follow below troubleshooting steps in the given order and retry your operation.</span></span>
##### <a name="cause-1-the-vm-has-no-internet-accessthe-vm-has-no-internet-access"></a><span data-ttu-id="8f840-110">Причина 1. [У виртуальной машины нет доступа к Интернету](#the-vm-has-no-internet-access)</span><span class="sxs-lookup"><span data-stu-id="8f840-110">Cause 1: [The VM has no Internet access](#the-vm-has-no-internet-access)</span></span>
##### <a name="cause-2-the-agent-is-installed-in-the-vm-but-is-unresponsive-for-windows-vmsthe-agent-installed-in-the-vm-but-unresponsive-for-windows-vms"></a><span data-ttu-id="8f840-111">Причина 2. [Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span><span class="sxs-lookup"><span data-stu-id="8f840-111">Cause 2: [The agent is installed in the VM but is unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span></span>
##### <a name="cause-3-the-agent-installed-in-the-vm-is-out-of-date-for-linux-vmsthe-agent-installed-in-the-vm-is-out-of-date-for-linux-vms"></a><span data-ttu-id="8f840-112">Причина 3. [Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span><span class="sxs-lookup"><span data-stu-id="8f840-112">Cause 3: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span></span>
##### <a name="cause-4-the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-takenthe-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken"></a><span data-ttu-id="8f840-113">Причина 4. [Не удалось получить состояние моментального снимка или создать моментальный снимок](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span><span class="sxs-lookup"><span data-stu-id="8f840-113">Cause 4: [The snapshot status cannot be retrieved or a snapshot cannot be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span></span>
##### <a name="cause-5-the-backup-extension-fails-to-update-or-loadthe-backup-extension-fails-to-update-or-load"></a><span data-ttu-id="8f840-114">Причина 5. [Не удалось обновить или загрузить расширение резервного копирования](#the-backup-extension-fails-to-update-or-load)</span><span class="sxs-lookup"><span data-stu-id="8f840-114">Cause 5: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)</span></span>

## <a name="snapshot-operation-failed-due-to-no-network-connectivity-on-the-virtual-machine"></a><span data-ttu-id="8f840-115">Сбой операции моментального снимка, отсутствует сетевое подключение у виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="8f840-115">Snapshot operation failed due to no network connectivity on the virtual machine</span></span>
<span data-ttu-id="8f840-116">После регистрации виртуальной машины в службе архивации Azure и добавления ее в расписание служба архивации инициирует задание, взаимодействуя с расширением виртуальной машины, чтобы создать моментальный снимок.</span><span class="sxs-lookup"><span data-stu-id="8f840-116">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span></span> <span data-ttu-id="8f840-117">Любое из следующих условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup.</span><span class="sxs-lookup"><span data-stu-id="8f840-117">Any of the following conditions might prevent the snapshot from being triggered, which in turn can lead to Backup failure.</span></span> <span data-ttu-id="8f840-118">Выполните инструкции по устранению неполадок в указанном порядке и повторите операцию.</span><span class="sxs-lookup"><span data-stu-id="8f840-118">Follow below troubleshooting steps in the given order and retry your operation.</span></span>
##### <a name="cause-1-the-vm-has-no-internet-accessthe-vm-has-no-internet-access"></a><span data-ttu-id="8f840-119">Причина 1. [У виртуальной машины нет доступа к Интернету](#the-vm-has-no-internet-access)</span><span class="sxs-lookup"><span data-stu-id="8f840-119">Cause 1: [The VM has no Internet access](#the-vm-has-no-internet-access)</span></span>
##### <a name="cause-2-the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-takenthe-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken"></a><span data-ttu-id="8f840-120">Причина 2. [Не удалось получить состояние моментального снимка или создать моментальный снимок](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span><span class="sxs-lookup"><span data-stu-id="8f840-120">Cause 2: [The snapshot status cannot be retrieved or a snapshot cannot be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span></span>
##### <a name="cause-3-the-backup-extension-fails-to-update-or-loadthe-backup-extension-fails-to-update-or-load"></a><span data-ttu-id="8f840-121">Причина 3. [Не удалось обновить или загрузить расширение резервного копирования](#the-backup-extension-fails-to-update-or-load)</span><span class="sxs-lookup"><span data-stu-id="8f840-121">Cause 3: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)</span></span>

## <a name="vmsnapshot-extension-operation-failed"></a><span data-ttu-id="8f840-122">Не удалось выполнить операцию с расширением моментального снимка виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="8f840-122">VMSnapshot extension operation failed</span></span>

<span data-ttu-id="8f840-123">После регистрации виртуальной машины в службе архивации Azure и добавления ее в расписание служба архивации инициирует задание, взаимодействуя с расширением виртуальной машины, чтобы создать моментальный снимок.</span><span class="sxs-lookup"><span data-stu-id="8f840-123">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span></span> <span data-ttu-id="8f840-124">Любое из следующих условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup.</span><span class="sxs-lookup"><span data-stu-id="8f840-124">Any of the following conditions might prevent the snapshot from being triggered, which in turn can lead to Backup failure.</span></span> <span data-ttu-id="8f840-125">Выполните инструкции по устранению неполадок в указанном порядке и повторите операцию.</span><span class="sxs-lookup"><span data-stu-id="8f840-125">Follow below troubleshooting steps in the given order and retry your operation.</span></span>
##### <a name="cause-1-the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-takenthe-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken"></a><span data-ttu-id="8f840-126">Причина 1. [Не удалось получить состояние моментального снимка или создать моментальный снимок](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span><span class="sxs-lookup"><span data-stu-id="8f840-126">Cause 1: [The snapshot status cannot be retrieved or a snapshot cannot be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span></span>
##### <a name="cause-2-the-backup-extension-fails-to-update-or-loadthe-backup-extension-fails-to-update-or-load"></a><span data-ttu-id="8f840-127">Причина 2. [Не удалось обновить или загрузить расширение резервного копирования](#the-backup-extension-fails-to-update-or-load)</span><span class="sxs-lookup"><span data-stu-id="8f840-127">Cause 2: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)</span></span>
##### <a name="cause-3-the-vm-has-no-internet-accessthe-vm-has-no-internet-access"></a><span data-ttu-id="8f840-128">Причина 3. [У виртуальной машины нет доступа к Интернету](#the-vm-has-no-internet-access)</span><span class="sxs-lookup"><span data-stu-id="8f840-128">Cause 3: [The VM has no Internet access](#the-vm-has-no-internet-access)</span></span>
##### <a name="cause-4-the-agent-is-installed-in-the-vm-but-is-unresponsive-for-windows-vmsthe-agent-installed-in-the-vm-but-unresponsive-for-windows-vms"></a><span data-ttu-id="8f840-129">Причина 4. [Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span><span class="sxs-lookup"><span data-stu-id="8f840-129">Cause 4: [The agent is installed in the VM but is unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span></span>
##### <a name="cause-5-the-agent-installed-in-the-vm-is-out-of-date-for-linux-vmsthe-agent-installed-in-the-vm-is-out-of-date-for-linux-vms"></a><span data-ttu-id="8f840-130">Причина 5. [Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span><span class="sxs-lookup"><span data-stu-id="8f840-130">Cause 5: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span></span>

## <a name="unable-to-perform-the-operation-as-the-vm-agent-is-not-responsive"></a><span data-ttu-id="8f840-131">Не удалось выполнить операцию, так как агент виртуальной машины не отвечает</span><span class="sxs-lookup"><span data-stu-id="8f840-131">Unable to perform the operation as the VM Agent is not responsive</span></span>

<span data-ttu-id="8f840-132">После регистрации виртуальной машины в службе архивации Azure и добавления ее в расписание служба архивации инициирует задание, взаимодействуя с расширением виртуальной машины, чтобы создать моментальный снимок.</span><span class="sxs-lookup"><span data-stu-id="8f840-132">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span></span> <span data-ttu-id="8f840-133">Любое из следующих условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup.</span><span class="sxs-lookup"><span data-stu-id="8f840-133">Any of the following conditions might prevent the snapshot from being triggered, which in turn can lead to Backup failure.</span></span> <span data-ttu-id="8f840-134">Выполните инструкции по устранению неполадок в указанном порядке и повторите операцию.</span><span class="sxs-lookup"><span data-stu-id="8f840-134">Follow below troubleshooting steps in the given order and retry your operation.</span></span>
##### <a name="cause-1-the-agent-is-installed-in-the-vm-but-is-unresponsive-for-windows-vmsthe-agent-installed-in-the-vm-but-unresponsive-for-windows-vms"></a><span data-ttu-id="8f840-135">Причина 1. [Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span><span class="sxs-lookup"><span data-stu-id="8f840-135">Cause 1: [The agent is installed in the VM but is unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span></span>
##### <a name="cause-2-the-agent-installed-in-the-vm-is-out-of-date-for-linux-vmsthe-agent-installed-in-the-vm-is-out-of-date-for-linux-vms"></a><span data-ttu-id="8f840-136">Причина 2. [Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span><span class="sxs-lookup"><span data-stu-id="8f840-136">Cause 2: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span></span>
##### <a name="cause-3-the-vm-has-no-internet-accessthe-vm-has-no-internet-access"></a><span data-ttu-id="8f840-137">Причина 3. [У виртуальной машины нет доступа к Интернету](#the-vm-has-no-internet-access)</span><span class="sxs-lookup"><span data-stu-id="8f840-137">Cause 3: [The VM has no Internet access](#the-vm-has-no-internet-access)</span></span>

## <a name="backup-failed-with-an-internal-error---please-retry-the-operation-in-a-few-minutes"></a><span data-ttu-id="8f840-138">Произошла внутренняя ошибка службы Backup. Повторите операцию через несколько минут</span><span class="sxs-lookup"><span data-stu-id="8f840-138">Backup failed with an internal error - Please retry the operation in a few minutes</span></span>

<span data-ttu-id="8f840-139">После регистрации виртуальной машины в службе архивации Azure и добавления ее в расписание служба архивации инициирует задание, взаимодействуя с расширением виртуальной машины, чтобы создать моментальный снимок.</span><span class="sxs-lookup"><span data-stu-id="8f840-139">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span></span> <span data-ttu-id="8f840-140">Любое из следующих условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup.</span><span class="sxs-lookup"><span data-stu-id="8f840-140">Any of the following conditions might prevent the snapshot from being triggered, which in turn can lead to Backup failure.</span></span> <span data-ttu-id="8f840-141">Выполните инструкции по устранению неполадок в указанном порядке и повторите операцию.</span><span class="sxs-lookup"><span data-stu-id="8f840-141">Follow below troubleshooting steps in the given order and retry your operation.</span></span>
##### <a name="cause-1-the-vm-has-no-internet-accessthe-vm-has-no-internet-access"></a><span data-ttu-id="8f840-142">Причина 1. [У виртуальной машины нет доступа к Интернету](#the-vm-has-no-internet-access)</span><span class="sxs-lookup"><span data-stu-id="8f840-142">Cause 1: [The VM has no Internet access](#the-vm-has-no-internet-access)</span></span>
##### <a name="cause-2-the-agent-installed-in-the-vm-but-unresponsive-for-windows-vmsthe-agent-installed-in-the-vm-but-unresponsive-for-windows-vms"></a><span data-ttu-id="8f840-143">Причина 2. [Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span><span class="sxs-lookup"><span data-stu-id="8f840-143">Cause 2: [The agent installed in the VM but unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span></span>
##### <a name="cause-3-the-agent-installed-in-the-vm-is-out-of-date-for-linux-vmsthe-agent-installed-in-the-vm-is-out-of-date-for-linux-vms"></a><span data-ttu-id="8f840-144">Причина 3. [Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span><span class="sxs-lookup"><span data-stu-id="8f840-144">Cause 3: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span></span>
##### <a name="cause-4-the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-takenthe-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken"></a><span data-ttu-id="8f840-145">Причина 4. [Не удалось получить состояние моментального снимка или создать моментальный снимок](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span><span class="sxs-lookup"><span data-stu-id="8f840-145">Cause 4: [The snapshot status cannot be retrieved or a snapshot cannot be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span></span>
##### <a name="cause-5-the-backup-extension-fails-to-update-or-loadthe-backup-extension-fails-to-update-or-load"></a><span data-ttu-id="8f840-146">Причина 5. [Не удалось обновить или загрузить расширение резервного копирования](#the-backup-extension-fails-to-update-or-load)</span><span class="sxs-lookup"><span data-stu-id="8f840-146">Cause 5: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)</span></span>


## <a name="causes-and-solutions"></a><span data-ttu-id="8f840-147">Причины и решения</span><span class="sxs-lookup"><span data-stu-id="8f840-147">Causes and Solutions</span></span>

### <a name="the-vm-has-no-internet-access"></a><span data-ttu-id="8f840-148">У виртуальной машины нет доступа к Интернету</span><span class="sxs-lookup"><span data-stu-id="8f840-148">The VM has no Internet access</span></span>
<span data-ttu-id="8f840-149">Согласно требованиям к развертыванию виртуальная машина не имеет доступа к Интернету или существуют ограничения на доступ к инфраструктуре Azure.</span><span class="sxs-lookup"><span data-stu-id="8f840-149">Per the deployment requirement, the VM has no Internet access, or it has restrictions in place that prevent access to the Azure infrastructure.</span></span>

<span data-ttu-id="8f840-150">Для правильной работы расширения службы архивации требуется возможность подключения к общедоступным IP-адресам Azure.</span><span class="sxs-lookup"><span data-stu-id="8f840-150">To function correctly, the backup extension requires connectivity to the Azure public IP addresses.</span></span> <span data-ttu-id="8f840-151">Для управления моментальными снимками виртуальной машины это расширение отправляет команды к конечной точке службы хранилища Azure (URL-адрес HTTP).</span><span class="sxs-lookup"><span data-stu-id="8f840-151">The extension sends commands to an Azure Storage endpoint (HTTP URL) to manage the snapshots of the VM.</span></span> <span data-ttu-id="8f840-152">Если расширение не имеет доступа к общедоступному Интернету, архивация завершится сбоем.</span><span class="sxs-lookup"><span data-stu-id="8f840-152">If the extension has no access to the public Internet, Backup eventually fails.</span></span>

####  <a name="solution"></a><span data-ttu-id="8f840-153">Решение</span><span class="sxs-lookup"><span data-stu-id="8f840-153">Solution</span></span>
<span data-ttu-id="8f840-154">Для устранения этой проблемы воспользуйтесь одним из указанных ниже способов.</span><span class="sxs-lookup"><span data-stu-id="8f840-154">To resolve the issue, try one of the methods listed here.</span></span>
##### <a name="allow-access-to-the-azure-datacenter-ip-ranges"></a><span data-ttu-id="8f840-155">Разрешение доступа к диапазонам IP-адресов центра обработки данных Azure</span><span class="sxs-lookup"><span data-stu-id="8f840-155">Allow access to the Azure datacenter IP ranges</span></span>

1. <span data-ttu-id="8f840-156">Получите [список IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653), чтобы разрешить доступ к ним.</span><span class="sxs-lookup"><span data-stu-id="8f840-156">Obtain the [list of Azure datacenter IPs](https://www.microsoft.com/download/details.aspx?id=41653) to allow access to.</span></span>
2. <span data-ttu-id="8f840-157">Разблокируйте IP-адреса, выполнив командлет **New-NetRoute** на виртуальной машине Azure в окне PowerShell с повышенными привилегиями.</span><span class="sxs-lookup"><span data-stu-id="8f840-157">Unblock the IPs by running the **New-NetRoute** cmdlet in the Azure VM in an elevated PowerShell window.</span></span> <span data-ttu-id="8f840-158">Выполните этот командлет с привилегиями администратора.</span><span class="sxs-lookup"><span data-stu-id="8f840-158">Run the cmdlet as an administrator.</span></span>
3. <span data-ttu-id="8f840-159">Чтобы разрешить доступ к этим IP-адресам, добавьте соответствующие правила в группу безопасности сети (если она настроена).</span><span class="sxs-lookup"><span data-stu-id="8f840-159">To allow access to the IPs, add rules to the network security group, if you have one.</span></span>

##### <a name="create-a-path-for-http-traffic-to-flow"></a><span data-ttu-id="8f840-160">Создание пути для прохождения трафика HTTP</span><span class="sxs-lookup"><span data-stu-id="8f840-160">Create a path for HTTP traffic to flow</span></span>

1. <span data-ttu-id="8f840-161">При наличии каких-либо ограничений сети (например, группы безопасности сети) разверните прокси-сервер HTTP для маршрутизации трафика.</span><span class="sxs-lookup"><span data-stu-id="8f840-161">If you have network restrictions in place (for example, a network security group), deploy an HTTP proxy server to route the traffic.</span></span>
2. <span data-ttu-id="8f840-162">Если вы используете группу безопасности сети, добавьте в нее правила, чтобы разрешить доступ к Интернету с прокси-сервера HTTP.</span><span class="sxs-lookup"><span data-stu-id="8f840-162">To allow access to the Internet from the HTTP proxy server, add rules to the network security group, if you have one.</span></span>

<span data-ttu-id="8f840-163">Чтобы узнать, как настроить прокси-сервер HTTP для архивации виртуальных машин, ознакомьтесь с разделом [Подготовка среды для резервного копирования виртуальных машин Azure](backup-azure-vms-prepare.md#using-an-http-proxy-for-vm-backups).</span><span class="sxs-lookup"><span data-stu-id="8f840-163">To learn how to set up an HTTP proxy for VM backups, see [Prepare your environment to back up Azure virtual machines](backup-azure-vms-prepare.md#using-an-http-proxy-for-vm-backups).</span></span>

<span data-ttu-id="8f840-164">В случае если вы используете управляемые диски, может потребоваться открыть в брандмауэрах дополнительный порт (8443).</span><span class="sxs-lookup"><span data-stu-id="8f840-164">In case you are using Managed Disks, you may need an additional port (8443) opening up on the firewalls.</span></span>

### <a name="the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms"></a><span data-ttu-id="8f840-165">Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)</span><span class="sxs-lookup"><span data-stu-id="8f840-165">The agent installed in the VM but unresponsive (for Windows VMs)</span></span>

#### <a name="solution"></a><span data-ttu-id="8f840-166">Решение</span><span class="sxs-lookup"><span data-stu-id="8f840-166">Solution</span></span>
<span data-ttu-id="8f840-167">Возможно, агент виртуальной машины может быть поврежден или служба остановлена.</span><span class="sxs-lookup"><span data-stu-id="8f840-167">The VM Agent might have been corrupted or the service might have been stopped.</span></span> <span data-ttu-id="8f840-168">Повторная установка агента виртуальной машины поможет получить последнюю версию и возобновить обмен данными.</span><span class="sxs-lookup"><span data-stu-id="8f840-168">Re-installing the VM agent would help get the latest version and restart the communication.</span></span>

1. <span data-ttu-id="8f840-169">Проверьте, запущена ли служба гостевого агента Windows в службах компьютера (services.msc) на виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="8f840-169">Verify whether Windows Guest Agent service running in services (services.msc) of the Virtual Machine.</span></span> <span data-ttu-id="8f840-170">Попробуйте перезапустить службу гостевого агента Windows и запустите резервное копирование</span><span class="sxs-lookup"><span data-stu-id="8f840-170">Try restart the Windows Guest Agent service and initiate the Backup</span></span><br>
2. <span data-ttu-id="8f840-171">Если она не отображается в списке служб, проверьте в разделе "Программы и компоненты", установлена ли служба гостевого агента Windows.</span><span class="sxs-lookup"><span data-stu-id="8f840-171">if it is not visible in services, verify in Programs and Features whether Windows Guest agent service is installed.</span></span>
4. <span data-ttu-id="8f840-172">Если вы можете просматривать раздел "Программы и компоненты", удалите гостевой агент Windows.</span><span class="sxs-lookup"><span data-stu-id="8f840-172">If you are able to view in programs and features uninstall the Windows Guest Agent.</span></span>
5. <span data-ttu-id="8f840-173">Скачайте и установите [последнюю версию файла MSI агента](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span><span class="sxs-lookup"><span data-stu-id="8f840-173">Download and install the [latest version of agent MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span></span> <span data-ttu-id="8f840-174">Чтобы выполнить установку, необходимо иметь права администратора.</span><span class="sxs-lookup"><span data-stu-id="8f840-174">You need Administrator privileges to complete the installation.</span></span>
6. <span data-ttu-id="8f840-175">Затем можно будет просмотреть службу гостевого агента Windows в службах.</span><span class="sxs-lookup"><span data-stu-id="8f840-175">Then you should be able to view Windows Guest Agent services in services</span></span>
7. <span data-ttu-id="8f840-176">Попробуйте выполнить резервное копирование по запросу или нерегламентированное резервное копирование, щелкнув "Моментальная архивация" на портале.</span><span class="sxs-lookup"><span data-stu-id="8f840-176">Try running an on-demand/adhoc backup by clicking "Backup Now" in the portal.</span></span>

<span data-ttu-id="8f840-177">Также проверьте, установлен ли на виртуальной машине компонент **[.NET 4.5](https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed)**.</span><span class="sxs-lookup"><span data-stu-id="8f840-177">Also verify your Virtual Machine has **[.NET 4.5 installed in the system](https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed)**.</span></span> <span data-ttu-id="8f840-178">Он необходим для взаимодействия агента виртуальной машины со службой.</span><span class="sxs-lookup"><span data-stu-id="8f840-178">It is required for the VM agent to communicate with the service</span></span>

### <a name="the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms"></a><span data-ttu-id="8f840-179">Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)</span><span class="sxs-lookup"><span data-stu-id="8f840-179">The agent installed in the VM is out of date (for Linux VMs)</span></span>

#### <a name="solution"></a><span data-ttu-id="8f840-180">Решение</span><span class="sxs-lookup"><span data-stu-id="8f840-180">Solution</span></span>
<span data-ttu-id="8f840-181">Большая часть неполадок, связанных с агентом или расширением на виртуальных машинах Linux, вызваны проблемами с устаревшим агентом виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="8f840-181">Most agent-related or extension-related failures for Linux VMs are caused by issues that affect an outdated VM agent.</span></span> <span data-ttu-id="8f840-182">Чтобы устранить эту проблему, следуйте приведенным ниже общим рекомендациям.</span><span class="sxs-lookup"><span data-stu-id="8f840-182">To troubleshoot this issue, follow these general guidelines:</span></span>

1. <span data-ttu-id="8f840-183">Выполните указания по [обновлению агента виртуальной машины Linux ](../virtual-machines/linux/update-agent.md).</span><span class="sxs-lookup"><span data-stu-id="8f840-183">Follow the instructions for [updating the Linux VM agent](../virtual-machines/linux/update-agent.md).</span></span>

 >[!NOTE]
 ><span data-ttu-id="8f840-184">Мы *настоятельно рекомендуем* обновлять агент только посредством репозитория дистрибутивов.</span><span class="sxs-lookup"><span data-stu-id="8f840-184">We *strongly recommend* that you update the agent only through a distribution repository.</span></span> <span data-ttu-id="8f840-185">Мы не рекомендуем скачивать код агента непосредственно с портала GitHub и обновлять его.</span><span class="sxs-lookup"><span data-stu-id="8f840-185">We do not recommend downloading the agent code directly from GitHub and updating it.</span></span> <span data-ttu-id="8f840-186">Если последняя версия агента для вашего дистрибутива недоступна, обратитесь в службу поддержки дистрибутива, чтобы получить инструкции по установке последней версии агента.</span><span class="sxs-lookup"><span data-stu-id="8f840-186">If the latest agent is unavailable for your distribution, contact distribution support for instructions on how to install it.</span></span> <span data-ttu-id="8f840-187">Чтобы проверить наличие последней версии агента, перейдите на страницу [агента Linux для Microsoft Azure](https://github.com/Azure/WALinuxAgent/releases) в репозитории GitHub.</span><span class="sxs-lookup"><span data-stu-id="8f840-187">To check for the most recent agent, go to the [Windows Azure Linux agent](https://github.com/Azure/WALinuxAgent/releases) page in the GitHub repository.</span></span>

2. <span data-ttu-id="8f840-188">Убедитесь, что на виртуальной машине запущен агент Azure, выполнив команду `ps -e`.</span><span class="sxs-lookup"><span data-stu-id="8f840-188">Make sure that the Azure agent is running on the VM by running the following command: `ps -e`</span></span>

 <span data-ttu-id="8f840-189">Если нужный процесс не запущен, используйте следующие команды для его перезапуска.</span><span class="sxs-lookup"><span data-stu-id="8f840-189">If the process is not running, restart it by using the following commands:</span></span>

 * <span data-ttu-id="8f840-190">Для Ubuntu: `service walinuxagent start`.</span><span class="sxs-lookup"><span data-stu-id="8f840-190">For Ubuntu: `service walinuxagent start`</span></span>
 * <span data-ttu-id="8f840-191">Для других дистрибутивов: `service waagent start`.</span><span class="sxs-lookup"><span data-stu-id="8f840-191">For other distributions: `service waagent start`</span></span>

3. <span data-ttu-id="8f840-192">[Настройте автоматический перезапуск агента](https://github.com/Azure/WALinuxAgent/wiki/Known-Issues#mitigate_agent_crash).</span><span class="sxs-lookup"><span data-stu-id="8f840-192">[Configure the auto restart agent](https://github.com/Azure/WALinuxAgent/wiki/Known-Issues#mitigate_agent_crash).</span></span>
4. <span data-ttu-id="8f840-193">Снова запустите резервное копирование для проверки.</span><span class="sxs-lookup"><span data-stu-id="8f840-193">Run a new test backup.</span></span> <span data-ttu-id="8f840-194">Если ошибка не исчезла, извлеките следующие журналы из виртуальной машины клиента:</span><span class="sxs-lookup"><span data-stu-id="8f840-194">If the failure persists, please collect the following logs from the customer’s VM:</span></span>

   * <span data-ttu-id="8f840-195">/var/lib/waagent/*.xml</span><span class="sxs-lookup"><span data-stu-id="8f840-195">/var/lib/waagent/*.xml</span></span>
   * <span data-ttu-id="8f840-196">/var/log/waagent.log</span><span class="sxs-lookup"><span data-stu-id="8f840-196">/var/log/waagent.log</span></span>
   * <span data-ttu-id="8f840-197">/var/log/azure/*</span><span class="sxs-lookup"><span data-stu-id="8f840-197">/var/log/azure/*</span></span>

<span data-ttu-id="8f840-198">Если нам потребуется подробное ведение журнала для waagent, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="8f840-198">If we require verbose logging for waagent, follow these steps:</span></span>

1. <span data-ttu-id="8f840-199">В файле /etc/waagent.conf найдите такую строку: **Enable verbose logging (y|n)**.</span><span class="sxs-lookup"><span data-stu-id="8f840-199">In the /etc/waagent.conf file, locate the following line: **Enable verbose logging (y|n)**</span></span>
2. <span data-ttu-id="8f840-200">Для параметра **Logs.Verbose** измените значение с *n* на *y*.</span><span class="sxs-lookup"><span data-stu-id="8f840-200">Change the **Logs.Verbose** value from *n* to *y*.</span></span>
3. <span data-ttu-id="8f840-201">Сохраните изменения и перезапустите waagent, как описано выше в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="8f840-201">Save the change, and then restart waagent by following the previous steps in this section.</span></span>

### <a name="the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken"></a><span data-ttu-id="8f840-202">Не удалось получить состояние моментального снимка или создать моментальный снимок</span><span class="sxs-lookup"><span data-stu-id="8f840-202">The snapshot status cannot be retrieved or a snapshot cannot be taken</span></span>
<span data-ttu-id="8f840-203">Архивация виртуальных машин зависит от команды создания моментального снимка в базовой учетной записи хранения.</span><span class="sxs-lookup"><span data-stu-id="8f840-203">The VM backup relies on issuing a snapshot command to the underlying storage account.</span></span> <span data-ttu-id="8f840-204">Сбой службы архивации может произойти, если она не имеет доступа к учетной записи хранения или выполнение задачи создания моментального снимка задерживается.</span><span class="sxs-lookup"><span data-stu-id="8f840-204">Backup can fail either because it has no access to the storage account or because the execution of the snapshot task is delayed.</span></span>

#### <a name="solution"></a><span data-ttu-id="8f840-205">Решение</span><span class="sxs-lookup"><span data-stu-id="8f840-205">Solution</span></span>
<span data-ttu-id="8f840-206">Сбой задачи создания снимка может быть вызван следующими условиями.</span><span class="sxs-lookup"><span data-stu-id="8f840-206">The following conditions can cause snapshot task failure:</span></span>

| <span data-ttu-id="8f840-207">Причина:</span><span class="sxs-lookup"><span data-stu-id="8f840-207">Cause</span></span> | <span data-ttu-id="8f840-208">Решение</span><span class="sxs-lookup"><span data-stu-id="8f840-208">Solution</span></span> |
| --- | --- |
| <span data-ttu-id="8f840-209">Для виртуальной машины настроена архивация SQL Server.</span><span class="sxs-lookup"><span data-stu-id="8f840-209">The VM has SQL Server backup configured.</span></span> | <span data-ttu-id="8f840-210">По умолчанию при архивации виртуальной машины выполняется полная архивация VSS на виртуальных машинах Windows.</span><span class="sxs-lookup"><span data-stu-id="8f840-210">By default, the VM backup runs a VSS full backup on Windows VMs.</span></span> <span data-ttu-id="8f840-211">Если на виртуальной машине запущен сервер на основе SQL Server и настроена архивация SQL Server, то при создании моментального снимка может возникнуть задержка.</span><span class="sxs-lookup"><span data-stu-id="8f840-211">On VMs that are running SQL Server-based servers and on which SQL Server backup is configured, snapshot execution delays may occur.</span></span><br><br><span data-ttu-id="8f840-212">Если у вас возникают ошибки архивации из-за проблемы с моментальными снимками, настройте приведенный ниже ключ реестра.</span><span class="sxs-lookup"><span data-stu-id="8f840-212">If you are experiencing a Backup failure because of a snapshot issue, set the following registry key:</span></span><br><br><span data-ttu-id="8f840-213">**[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT] "USEVSSCOPYBACKUP"="TRUE"**</span><span class="sxs-lookup"><span data-stu-id="8f840-213">**[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT] "USEVSSCOPYBACKUP"="TRUE"**</span></span> |
| <span data-ttu-id="8f840-214">Состояние виртуальной машины отображается неправильно из-за того, что работа виртуальной машины была завершена в сеансе удаленного рабочего стола.</span><span class="sxs-lookup"><span data-stu-id="8f840-214">The VM status is reported incorrectly because the VM is shut down in RDP.</span></span> | <span data-ttu-id="8f840-215">Когда вы завершаете работу виртуальной машины в сеансе удаленного рабочего стола (RDP), проверьте, правильно ли отображается состояние виртуальной машины на портале.</span><span class="sxs-lookup"><span data-stu-id="8f840-215">If you shut down the VM in Remote Desktop Protocol (RDP), check the portal to determine whether the VM status is correct.</span></span> <span data-ttu-id="8f840-216">Если это не так, завершите работу виртуальной машины на портале с помощью операции **Завершение работы** на панели мониторинга виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="8f840-216">If it’s not correct, shut down the VM in the portal by using the **Shutdown** option on the VM dashboard.</span></span> |
| <span data-ttu-id="8f840-217">Для нескольких виртуальных машин из одной облачной службы резервное копирование выполняется в одно и то же время.</span><span class="sxs-lookup"><span data-stu-id="8f840-217">Many VMs from the same cloud service are configured to back up at the same time.</span></span> | <span data-ttu-id="8f840-218">Рекомендуется распределить архивацию виртуальных машин из одной облачной службы так, чтобы она выполнялась в разное время.</span><span class="sxs-lookup"><span data-stu-id="8f840-218">It’s a best practice to spread out the backup schedules for VMs from the same cloud service.</span></span> |
| <span data-ttu-id="8f840-219">Виртуальная машина использует большие ресурсы процессора или памяти.</span><span class="sxs-lookup"><span data-stu-id="8f840-219">The VM is running at high CPU or memory usage.</span></span> | <span data-ttu-id="8f840-220">Если виртуальная машина работает с высоким уровнем загрузки ЦП (более 90 %) или использует большой объем памяти, задача создания моментального снимка помещается в очередь и время ее ожидания истекает. В таких ситуациях попробуйте использовать архивацию по запросу.</span><span class="sxs-lookup"><span data-stu-id="8f840-220">If the VM is running at high CPU usage (more than 90 percent) or high memory usage, the snapshot task is queued and delayed, and it eventually times out. In this situation, try an on-demand backup.</span></span> |
| <span data-ttu-id="8f840-221">Виртуальная машина не может получить адрес узла или структуры по протоколу DHCP.</span><span class="sxs-lookup"><span data-stu-id="8f840-221">The VM cannot get the host/fabric address from DHCP.</span></span> | <span data-ttu-id="8f840-222">Чтобы архивация виртуальной машины IaaS работала, в гостевой учетной записи нужно включить протокол DHCP.</span><span class="sxs-lookup"><span data-stu-id="8f840-222">DHCP must be enabled inside the guest for the IaaS VM backup to work.</span></span>  <span data-ttu-id="8f840-223">Если виртуальная машина не может получить адрес узла или структуры в виде ответа DHCP 245, то она не сможет скачать или запустить какие-либо расширения.</span><span class="sxs-lookup"><span data-stu-id="8f840-223">If the VM cannot get the host/fabric address from DHCP response 245, it cannot download or run any extensions.</span></span> <span data-ttu-id="8f840-224">Если вам нужен статический частный IP-адрес, следует настроить его через платформу.</span><span class="sxs-lookup"><span data-stu-id="8f840-224">If you need a static private IP, you should configure it through the platform.</span></span> <span data-ttu-id="8f840-225">DHCP для виртуальной машины следует оставить включенным.</span><span class="sxs-lookup"><span data-stu-id="8f840-225">The DHCP option inside the VM should be left enabled.</span></span> <span data-ttu-id="8f840-226">Дополнительные сведения см. в статье [Как задать статический внутренний частный IP-адрес с помощью PowerShell (классическая модель)](../virtual-network/virtual-networks-reserved-private-ip.md).</span><span class="sxs-lookup"><span data-stu-id="8f840-226">For more information, see [Setting a Static Internal Private IP](../virtual-network/virtual-networks-reserved-private-ip.md).</span></span> |

### <a name="the-backup-extension-fails-to-update-or-load"></a><span data-ttu-id="8f840-227">Не удалось обновить или загрузить расширение резервного копирования</span><span class="sxs-lookup"><span data-stu-id="8f840-227">The backup extension fails to update or load</span></span>
<span data-ttu-id="8f840-228">Если не удается загрузить расширения, получить моментальный снимок состояния невозможно, и архивация завершится сбоем.</span><span class="sxs-lookup"><span data-stu-id="8f840-228">If extensions cannot be loaded, Backup fails because a snapshot cannot be taken.</span></span>

#### <a name="solution"></a><span data-ttu-id="8f840-229">Решение</span><span class="sxs-lookup"><span data-stu-id="8f840-229">Solution</span></span>

<span data-ttu-id="8f840-230">**Для гостевых систем Windows:** убедитесь, что служба iaasvmprovider включена и для нее установлен *автоматический* тип запуска.</span><span class="sxs-lookup"><span data-stu-id="8f840-230">**For Windows guests:** Verify that the iaasvmprovider service is enabled and has a startup type of *automatic*.</span></span> <span data-ttu-id="8f840-231">Если это не так, включите эту службу и проверьте, будет ли успешно выполнена следующая архивация.</span><span class="sxs-lookup"><span data-stu-id="8f840-231">If the service is not configured in this way, enable it to determine whether the next backup succeeds.</span></span>

<span data-ttu-id="8f840-232">**Для гостевых систем Linux:** убедитесь, что последняя версия Linux VMSnapshot (расширение, используемое службой архивации) — 1.0.91.0.</span><span class="sxs-lookup"><span data-stu-id="8f840-232">**For Linux guests:** Verify the latest version of VMSnapshot for Linux (the extension used by Backup) is 1.0.91.0.</span></span><br>


<span data-ttu-id="8f840-233">Если расширение резервной копии по-прежнему не удается обновить или загрузить, попробуйте принудительно перезагрузить расширение VMSnapshot, удалив это расширение.</span><span class="sxs-lookup"><span data-stu-id="8f840-233">If the backup extension still fails to update or load, you can force the VMSnapshot extension to be reloaded by uninstalling the extension.</span></span> <span data-ttu-id="8f840-234">Расширение будет перезагружено при следующей попытке резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="8f840-234">The next backup attempt will reload the extension.</span></span>

<span data-ttu-id="8f840-235">Чтобы удаление расширение, выполните следующее.</span><span class="sxs-lookup"><span data-stu-id="8f840-235">To uninstall the extension, do the following:</span></span>

1. <span data-ttu-id="8f840-236">Перейдите на [портал Azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="8f840-236">Go to the [Azure portal](https://portal.azure.com/).</span></span>
2. <span data-ttu-id="8f840-237">Найдите виртуальную машину, с архивацией которой возникли проблемы.</span><span class="sxs-lookup"><span data-stu-id="8f840-237">Locate the VM that has backup problems.</span></span>
3. <span data-ttu-id="8f840-238">Щелкните **Параметры**.</span><span class="sxs-lookup"><span data-stu-id="8f840-238">Click **Settings**.</span></span>
4. <span data-ttu-id="8f840-239">Щелкните **Расширения**.</span><span class="sxs-lookup"><span data-stu-id="8f840-239">Click **Extensions**.</span></span>
5. <span data-ttu-id="8f840-240">Щелкните **Vmsnapshot Extension** (Расширение Vmsnapshot).</span><span class="sxs-lookup"><span data-stu-id="8f840-240">Click **Vmsnapshot Extension**.</span></span>
6. <span data-ttu-id="8f840-241">Нажмите кнопку **Удалить**.</span><span class="sxs-lookup"><span data-stu-id="8f840-241">Click **Uninstall**.</span></span>

<span data-ttu-id="8f840-242">После этого расширение будет повторно установлено при следующей архивации.</span><span class="sxs-lookup"><span data-stu-id="8f840-242">This procedure causes the extension to be reinstalled during the next backup.</span></span>


---
title: "Обновление хранилища архивации в хранилище служб восстановления | Документы Microsoft"
description: "Инструкции и сведения о поддержке для обновления резервного хранилища Azure до хранилища служб восстановления."
services: backup
documentationcenter: dev-center-name
author: markgalioto
manager: carmonm
ms.assetid: 228fef19-2f6b-4067-acc3-fb6e501afb88
ms.service: backup
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 1/4/2018
ms.author: sogup;markgal;arunak
ms.openlocfilehash: 8396a7276fde10eb95a22ed07fa61625acfdd77f
ms.sourcegitcommit: d6984ef8cc057423ff81efb4645af9d0b902f843
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/05/2018
---
# <a name="upgrade-a-backup-vault-to-a-recovery-services-vault"></a>Обновление резервного хранилища до хранилища служб восстановления

В этой статье описывается, как обновить резервное хранилище до хранилища служб восстановления. Процесс обновления не влияет на какие-либо выполняемые задания архивации и не приводит к потере данных. Ниже перечислены основные причины для обновления резервного хранилища до хранилища служб восстановления.
- Все функции резервного хранилища сохраняются в хранилище служб восстановления.
- Хранилища служб восстановления предлагают больше возможностей, чем резервные хранилища, в том числе более высокий уровень безопасности, интегрированный мониторинг, ускоренное восстановление и восстановление на уровне элемента.
- Управление архивируемыми элементами с помощью улучшенного и упрощенного портала.
- Новые функции будут применяться только для хранилищ служб восстановления.

## <a name="impact-to-operations-during-upgrade"></a>Влияние операции во время обновления

Обновление резервного хранилища до хранилищ служб восстановления никак не отражается на операциях уровня данных. Все задания архивации продолжают выполняться в обычном режиме, а все активные задания восстановления продолжают работу без перерыва. Во время обновления происходит кратковременный простой операций управления и невозможно защитить новые элементы или создать задания нерегламентированного резервного копирования. Во время обновления не выполняются задания восстановления для виртуальных машин IaaS. Обновление хранилища длится до часа. По завершении хранилище служб восстановления заменяет резервное хранилище.

## <a name="changes-to-your-automation-and-tool-after-upgrading"></a>Изменение службы автоматизации и инструментов после обновления

При подготовке инфраструктуры к обновлению хранилища необходимо обновить существующую службу автоматизации или инструменты, чтобы обеспечить их работу после обновления.
Можно найти в книгах командлеты PowerShell для [модели развертывания диспетчера ресурсов](backup-client-automation.md).


## <a name="before-you-upgrade"></a>Подготовка к обновлению

Перед обновлением резервных хранилищ до хранилищ служб восстановления проверьте соблюдение следующих условий.

- **Минимальная версия агента**. Для обновления хранилища должен использоваться агент служб восстановления Microsoft Azure (MARS) не ниже версии 2.0.9083.0. Если используется агент MARS версии, предшествующей версии 2.0.9083.0, обновите агент, прежде чем начать процесс обновления.
- **Модель выставления счетов на основе экземпляра**. Хранилища служб восстановления поддерживают только модель выставления счетов на основе экземпляра. Если имеется резервное хранилище, использующее более старую модель выставления счетов на основе хранилища, преобразуйте эту модель во время обновления.
- **Отсутствуют текущие операции настройки архивации**. Во время обновления доступ к плоскости управления ограничен. Завершите все действия плоскости управления, а затем начните обновление.

## <a name="using-powershell-scripts-to-upgrade-your-vaults"></a>Использование сценариев PowerShell для обновления хранилищ

Для обновления резервных хранилищ до хранилищ служб восстановления можно использовать сценарии PowerShell. Убедитесь в наличии необходимых компонентов PowerShell для активации обновления хранилища. Сценарии PowerShell, предназначенные для резервных хранилищ, не подходят для хранилищ служб восстановления. Подготовьте среду к обновлению хранилищ.

1. Установите компонент [Windows Management Framework (WMF) версии 5](https://www.microsoft.com/download/details.aspx?id=50395) или более поздней версии (либо выполните обновление имеющегося компонента до этой или более поздней версии).
2. [Установите Azure PowerShell MSI](https://github.com/Azure/azure-powershell/releases/download/v3.8.0-April2017/azure-powershell.3.8.0.msi).
3. Скачайте [сценарий PowerShell](https://aka.ms/vaultupgradescript2) для обновления хранилищ.

### <a name="run-the-powershell-script"></a>Запуск сценария PowerShell

Используйте следующий сценарий для обновления своих хранилищ. Приведенный ниже пример сценария содержит описания параметров.

RecoveryServicesVaultUpgrade-1.0.2.ps1 **-SubscriptionID** `<subscriptionID>` **-VaultName** `<vaultname>` **-Location** `<location>` **-ResourceType** `BackupVault` **-TargetResourceGroupName** `<rgname>`

**SubscriptionID.** Идентификатор подписки хранилища, которое обновляется.<br/>
**VaultName** -имя в хранилище службы архивации, которая обновляется.<br/>
**Расположение** -расположение хранилища обновляется.<br/>
**ResourceType** -использовать BackupVault.<br/>
**TargetResourceGroupName** — так, как вы обновляете хранилища для развертывания на основе диспетчера ресурсов, укажите группу ресурсов. Вы можете выбрать существующую группу ресурсов или создать новую, указав ее имя. Если указать имя существующей группы ресурсов с ошибкой, можно создать новую группу ресурсов. Чтобы узнать больше о группах ресурсов, прочитайте этот [обзор групп ресурсов](../azure-resource-manager/resource-group-overview.md#resource-groups).

>[!NOTE]
> Имена групп ресурсов имеют ограничения. Обязательно следуйте рекомендациям. Их несоблюдение может привести к сбою обновления хранилищ.
>
>При выполнении сценария клиентам **Azure для государственных организаций США** требуется задать для среды значение AzureUSGovernment.
>При выполнении сценария клиенты **Azure Китай** должны задать для среды значение AzureChinaCloud.

В следующем фрагменте кода приведен пример команды PowerShell.

```
RecoveryServicesVaultUpgrade.ps1 -SubscriptionID 53a3c692-5283-4f0a-baf6-49412f5ebefe -VaultName "TestVault" -Location "Australia East" -ResourceType BackupVault -TargetResourceGroupName "ContosoRG"
```

Можно также запустить сценарий без параметров, и вам будет предложено указать значения для всех обязательных параметров.

Сценарий PowerShell предложит ввести учетные данные. Введите свои учетные данные дважды: для учетной записи диспетчера служба и для учетной записи Resource Manager.

### <a name="pre-requisites-checking"></a>Проверка готовности
После ввода учетных данных Azure платформа Azure проверяет, соответствует ли ваша среда приведенным ниже требованиям.

- **Минимальная версия агента**. Для обновления резервных хранилищ до хранилищ служб восстановления требуется агент MARS версии не ниже 2.0.9083.0. При наличии элементов, зарегистрированных в резервном хранилище с помощью агента, версия которого ниже 2.0.9083.0, проверка готовности завершится ошибкой. Если проверка завершилась ошибкой, обновите агент и повторите попытку обновить хранилище. Последнюю версию агента можно скачать отсюда: [http://download.microsoft.com/download/F/4/B/F4B06356-150F-4DB0-8AD8-95B4DB4BBF7C/MARSAgentInstaller.exe](http://download.microsoft.com/download/F/4/B/F4B06356-150F-4DB0-8AD8-95B4DB4BBF7C/MARSAgentInstaller.exe).
- **Текущие задания настройки**. Если кто-либо настраивает задание для резервного хранилища, которое должно быть обновлено, или регистрирует в нем элемент, проверка готовности завершится ошибкой. Завершите настройку или регистрацию элемента, после чего начните процесс обновления хранилища.
- **Модель выставления счетов на основе хранилища**. Хранилища служб восстановления поддерживают модель выставления счетов на основе экземпляра. Если выполняется обновление резервного хранилища, использующего модель выставления счетов на основе хранилища, то будет предложено обновить эту модели вместе с хранилищем. В качестве альтернативы можно сначала обновить модель выставления счетов, а затем начать обновление хранилища.
- Определите группу ресурсов для хранилища служб восстановления. Чтобы воспользоваться преимуществами развертывания Resource Manager, необходимо поместить хранилище служб восстановления в группу ресурсов. Если вы не знаете, какую группу ресурсов использовать, укажите новое имя, и процесс обновления создаст группу ресурсов автоматически. Процесс обновления также свяжет хранилище с новой группой ресурсов.

После того, как процесс обновления завершит проверку готовности, вам будет предложено начать обновление хранилища. После вашего подтверждения начнется процесс обновления. Обычно он длится около 15–20 минут, в зависимости от размера хранилища. Если хранилище большое, обновление может занять до 90 минут.

## <a name="managing-your-recovery-services-vaults"></a>Управление хранилищами служб восстановления

На следующих снимках экрана показано новое хранилище служб восстановления, полученное путем обновления резервного хранилища на портале Azure. На первом снимке экрана показана панель мониторинга хранилища, на которой отображены сущности ключа для хранилища.

![Пример резервного хранилища, обновленного до хранилища служб восстановления](./media/backup-azure-upgrade-backup-to-recovery-services/upgraded-rs-vault-in-dashboard.png)

На втором снимке экрана показаны ссылки на разделы справки, которые помогут приступить к использованию хранилища служб восстановления.

![Ссылки на разделы справки в колонке "Быстрый запуск"](./media/backup-azure-upgrade-backup-to-recovery-services/quick-start-w-help-links.png)

## <a name="post-upgrade-steps"></a>Действия после обновления
Хранилище служб восстановления поддерживает указание сведений о часовом поясе в политике резервного копирования. После успешного обновления хранилища перейдите к политикам резервного копирования из меню параметров хранилища и обновите сведения о часовом поясе для каждой политики, настроенной в хранилище. На этом экране показано расписание резервного копирования, указанное согласно местному часовом поясу, использованному при создании политики. 

## <a name="enhanced-security"></a>Повышенная безопасность

Когда резервное хранилище будет обновлено до хранилища служб восстановления, для него будут автоматически включены параметры безопасности. Если параметры безопасности включены, для выполнения некоторых операций, таких как удаление резервных копий или изменение парольной фразы, будет необходимо ввести PIN-код [Многофакторной идентификации Azure](../multi-factor-authentication/multi-factor-authentication.md). Дополнительные сведения о повышенной безопасности см. в статье [Функции безопасности для защиты гибридных резервных копий, использующих службу архивации Azure](backup-azure-security-feature.md). 

Если включена повышенная безопасность, данные будут храниться до 14 дней после удаления сведений о точке восстановления из хранилища. Клиентам выставляется счет за хранение этих данных безопасности. Функция хранения данных безопасности применяется к точкам восстановления, созданных для агента службы Azure Backup, Azure Backup Server и System Center Data Protection Manager. 

## <a name="gather-data-on-your-vault"></a>Сбор данных в хранилище

После обновления до хранилища служб восстановления настройте отчеты для службы Azure Backup (для виртуальных машин IaaS и служб восстановления Microsoft Azure (MARS)) и используйте Power BI, чтобы получить к ним доступ. Дополнительные сведения о сборе данных см. в статье [Настройка отчетов службы Azure Backup](backup-azure-configure-reports.md).

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

**Затронет ли план обновления мои текущие операции архивации?**</br>
Нет. Текущие операции архивации будут выполняться без прерывания как во время, так и после обновления.

**Что произойдет с моими хранилищами, если я не планирую обновление в ближайшем будущем?**</br>
Так как все функции применяются только к хранилищам служб восстановления, мы настоятельно рекомендуем вам обновить хранилища. Начиная с 1 сентября 2017 г. корпорация Майкрософт начнет автоматически обновлять резервные хранилища до хранилищ служб восстановления. После 30 ноября 2017 г. вы не сможете создавать резервные хранилища с помощью PowerShell. Ваше хранилище может быть автоматически обновлено в любой момент в течение этого промежуточного периода. Корпорация Майкрософт рекомендует обновить свое хранилище как можно скорее.

**Как это обновление отразится на моих имеющихся инструментах?**</br>
Обновите свои инструменты до модели развертывания с помощью Resource Manager. Хранилища служб восстановления созданы для использования в модели развертывания с помощью Resource Manager. Очень важно запланировать обновление до модели развертывания с помощью Resource Manager и учитывать различия в хранилищах. 

**Долго ли длится простой во время обновления?**</br>
Это зависит от числа обновляемых ресурсов. Для небольших развертываний (с несколькими десятками защищенных экземпляров) обновление займет не более 20 минут. Для обновления более крупных развертываний может потребоваться до часа.

**Возможен ли откат после обновления?**</br>
Нет. Откат после успешного обновления ресурсов не поддерживается.

**Можно ли проверить подписку или ресурсы, чтобы узнать, подходят ли они для обновления?**</br>
Да. На первом этапе процесс обновления проверяет, поддерживают ли ресурсы обновление. В случае сбоя проверки готовности вы получите сообщения о всех причинах, из-за которых невозможно выполнить обновление.

**Можно обновить резервное хранилище на основе CSP?**</br>
Нет. Сейчас обновить резервные хранилища на основе CSP невозможно. Мы добавим поддержку для обновления резервных хранилищ на основе CSP в следующих выпусках.

**Можно ли будет просмотреть мое классическое хранилище после обновления?**</br>
Нет. После обновления невозможно будет просмотреть классическое хранилище или управлять им. Для всех операций управления хранилищем можно будет использовать только новый портал Azure.

**Мне не удалось обновить хранилище, однако компьютер, на котором был установлен агент, требующий обновления, больше не существует. Что делать в этом случае?**</br>
Если необходимо длительное хранение резервных копий этого компьютера, то вы не сможете обновить хранилище. Мы добавим поддержку для обновления этих хранилищ в будущих выпусках.
Если хранить резервные копии этого компьютера больше не требуется, отмените его регистрацию в хранилище и повторите обновление.

**Почему после обновления не отображаются сведения о заданиях для моих ресурсов?**</br>
Мониторинг резервных копий (агент MARS и IaaS) — это новая функция, которая предоставляется при обновлении резервного хранилища до хранилища служб восстановления. Для синхронизации данных мониторинга со службой может потребоваться до 12 часов.

**Как сообщить о проблеме?**</br>
Если вы столкнулись с какими-либо сбоями во время обновления, запишите идентификатор операции, указанный в сообщении об ошибке. Служба поддержки Майкрософт постарается устранить эту проблему. Вы можете обратиться в службу поддержки или написать нам на электронный адрес rsvaultupgrade@service.microsoft.com, указав идентификатор подписки, имя хранилища и идентификатор операции. Мы попробуем устранить проблему как можно быстрее. Не повторяйте операцию, если это явно не указано в инструкциях корпорации Майкрософт.


## <a name="next-steps"></a>Дальнейшие действия
Ознакомьтесь со следующими темами, прочитав соответствующие статьи:</br>
[Подготовка среды к архивации виртуальных машин, развернутых с помощью Resource Manager](backup-azure-arm-vms-prepare.md)</br>
[Подготовка к резервному копированию рабочих нагрузок с использованием сервера службы архивации Azure](backup-azure-microsoft-azure-backup.md)</br>
[Резервное копирование Windows Server](backup-configure-vault.md).

---
title: "Защита фермы SharePoint в Azure с помощью DPM или сервера службы архивации Azure | Документация Майкрософт"
description: "В этой статье описывается защита фермы SharePoint в Azure с помощью DPM или сервера службы архивации Azure"
services: backup
documentationcenter: 
author: adigan
manager: Nkolli1
editor: 
ms.assetid: e0c0c252-dc1d-4072-b777-7222c13950b0
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 09/29/2016
ms.author: adigan;giridham;jimpark;trinadhk;markgal
ms.openlocfilehash: 1bbf3233169fa9966e3dd0fac18ee448f26caa6b
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="back-up-a-sharepoint-farm-to-azure"></a>Архивация фермы SharePoint в Azure
Архивация SharePoint в Microsoft Azure с помощью System Center Data Protection Manager (DPM) во многом напоминает архивацию других источников данных. Служба архивации Azure позволяет гибко планировать архивацию, задавая ежедневные, еженедельные, ежемесячные или ежегодные точки архивации, и предоставляет параметры политики хранения для любой из этих точек. DPM дает возможность сохранять копии локальных дисков для краткосрочных целей времени восстановления, а также сохранять копии в Azure для экономичного и длительного хранения.

## <a name="sharepoint-supported-versions-and-related-protection-scenarios"></a>Поддерживаемые версии SharePoint и соответствующие сценарии защиты
Служба архивации Azure для DPM поддерживает следующие сценарии:

| Рабочая нагрузка | Версия | Развертывание SharePoint | Тип развертывания DPM | DPM – System Center 2012 R2 | Защита и восстановление |
| --- | --- | --- | --- | --- | --- |
| SharePoint |SharePoint 2013, SharePoint 2010, SharePoint 2007, SharePoint 3.0 |SharePoint разворачивается как физический сервер или виртуальная машина Hyper-V/VMware  <br> -------------- <br> SQL AlwaysOn |Физический сервер или локальная виртуальная машина Hyper-V |Поддерживает архивацию в Azure, начиная с накопительного пакета обновления 5 |Параметры восстановления фермы SharePoint: ферма, база данных, файл или элемент списка для восстановления из точек восстановления диска.  Восстановление фермы и базы данных из точек восстановления Azure. |

## <a name="before-you-start"></a>Перед началом работы
Перед архивацией фермы SharePoint в Azure необходимо выполнить некоторые действия.

### <a name="prerequisites"></a>Предварительные требования
Прежде чем продолжить, выполните все [предварительные требования по использованию службы архивации Microsoft Azure](backup-azure-dpm-introduction.md#prerequisites) для защиты рабочих нагрузок. В частности, необходимо создать хранилище архивации, скачать учетные данные хранилища, установить агент службы архивации Azure и зарегистрировать DPM и сервер службы архивации Azure в хранилище.

### <a name="dpm-agent"></a>Агент DPM
Агент DPM необходимо установить на сервер под управлением SharePoint, серверы под управлением SQL Server и другие серверы, составляющие ферму SharePoint. Дополнительные сведения о настройке агента защиты см. в статье [Настройка защиты для SharePoint](https://technet.microsoft.com/library/hh758034\(v=sc.12\).aspx).  Единственное исключение состоит в том, что агент устанавливается только на один интерфейсный веб-сервер. DPM требует установки агента только на один интерфейсный веб-сервер, который будет служить точкой входа для защиты.

### <a name="sharepoint-farm"></a>Ферма SharePoint
На каждые 10 млн элементов в ферме требуется не меньше 2 ГБ памяти в томе, где находится папка DPM. Эта память нужна для создания каталога. Для восстановления конкретных элементов (семейств веб-сайтов, сайтов, списков, библиотек документов, папок, отдельных документов и элементов списков) через DPM операция создания каталога формирует список URL-адресов, содержащихся в каждой базе данных контента. Список URL-адресов можно просмотреть в консоли администратора DPM, открыв панель восстанавливаемых элементов в области задач **Восстановление** .

### <a name="sql-server"></a>SQL Server
DPM выполняется как учетная запись LocalSystem. Чтобы создать резервные копии баз данных SQL Server, DPM требует наличия прав системного администратора в учетной записи сервера под управлением SQL Server. Установите для параметра NT AUTHORITY\SYSTEM значение *sysadmin* на сервере под управлением SQL Server, для которого нужно создать резервную копию.

При наличии баз данных SQL Server, настроенных с псевдонимами SQL Server, в ферме SharePoint установите клиентские компоненты SQL Server на интерфейсный веб-сервер, который DPM будет защищать.

### <a name="sharepoint-server"></a>SharePoint Server
Производительность системы зависит от многих факторов, включая размер фермы SharePoint. Как правило, для защиты фермы SharePoint объемом 25 ТБ используется один сервер DPM.

### <a name="dpm-update-rollup-5"></a>Накопительный пакет обновления DPM 5
Прежде чем начать защиту фермы SharePoint в Azure, необходимо установить накопительный пакет обновления DPM 5 или более поздней версии. Накопительный пакет обновления 5 позволяет защитить ферму SharePoint в Azure, настроенную с помощью SQL AlwaysOn.
Дополнительные сведения см. в записи блога, посвященной [накопительному пакету обновления DPM 5](http://blogs.technet.com/b/dpm/archive/2015/02/11/update-rollup-5-for-system-center-2012-r2-data-protection-manager-is-now-available.aspx).

### <a name="whats-not-supported"></a>Что не поддерживается
* Защита фермы SharePoint с помощью DPM не охватывает индексы поиска или базы данных службы приложений. Защиту этих баз данных необходимо настраивать отдельно.
* DPM не поддерживает архивацию баз данных SharePoint SQL Server, размещенных в общих хранилищах на масштабируемом файловом сервере.

## <a name="configure-sharepoint-protection"></a>Настройка защиты SharePoint
Перед использованием DPM для защиты SharePoint необходимо настроить службу модуля записи VSS SharePoint (службу модуля записи WSS) с помощью файла **ConfigureSharePoint.exe**.

Файл **ConfigureSharePoint.exe** находится в папке [путь_установки_DPM]\bin на интерфейсном веб-сервере. Он позволяет установить агент защиты с учетными данными для фермы SharePoint. Файл нужно распаковать на одном интерфейсном веб-сервере. Если у вас таких серверов несколько, выберите один из них для настройки группы защиты.

### <a name="to-configure-the-sharepoint-vss-writer-service"></a>Настройка службы модуля записи VSS SharePoint
1. На интерфейсном веб-сервере перейдите через командную строку в папку [путь установки DPM]\bin\.
2. Введите ConfigureSharePoint -EnableSharePointProtection.
3. Введите учетные данные администратора фермы. Эта учетная запись должна быть членом локальной группы администраторов на интерфейсном веб-сервере. Если администратор фермы не является локальным администратором, предоставьте на интерфейсном веб-сервере следующие разрешения:
   * Предоставьте группе WSS_Admin_WPG полный доступ к папке DPM (%Program Files%\Microsoft Data Protection Manager\DPM).
   * Предоставьте группе WSS_Admin_WPG право чтения реестра DPM (HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft Data Protection Manager).

> [!NOTE]
> После каждого изменения в учетных данных администратора фермы SharePoint файл ConfigureSharePoint.exe необходимо перезапускать.
> 
> 

## <a name="back-up-a-sharepoint-farm-by-using-dpm"></a>Архивация фермы SharePoint с помощью DPM
После настройки DPM и фермы SharePoint согласно приведенным ранее указаниям можно развернуть защиту SharePoint с помощью DPM.

### <a name="to-protect-a-sharepoint-farm"></a>Защита фермы SharePoint
1. На вкладке **Защита** консоли администратора DPM нажмите кнопку **Создать**.
    ![Вкладка создания защиты](./media/backup-azure-backup-sharepoint/dpm-new-protection-tab.png)
2. На странице **Выбор типа группы защиты** мастера **создания группы защиты** выберите **Серверы** и нажмите кнопку **Далее**.
   
    ![Выберите тип группы защиты](./media/backup-azure-backup-sharepoint/select-protection-group-type.png)
3. На экране **Выбор элементов группы** установите флажок для сервера SharePoint, который нужно защитить, и нажмите кнопку **Далее**.
   
    ![Выберите членов группы](./media/backup-azure-backup-sharepoint/select-group-members2.png)
   
   > [!NOTE]
   > Если агент DPM установлен, сервер отображается в мастере. DPM демонстрирует также его структуру. Так как файл ConfigureSharePoint.exe запущен, DPM обменивается данными со службой модуля записи VSS SharePoint и его соответствующими базами данных SQL Server, а также распознает структуру фермы SharePoint, связанные базы данных контента и все соответствующие элементы.
   > 
   > 
4. На странице **Выбор метода защиты данных** введите имя группы защиты в поле **Имя группы защиты** и выберите желаемые *методы защиты*. Щелкните **Далее**.
   
    ![Выберите метод защиты данных](./media/backup-azure-backup-sharepoint/select-data-protection-method1.png)
   
   > [!NOTE]
   > С помощью метода защиты диска можно удовлетворить краткосрочные цели времени восстановления. Azure — это экономичное средство долгосрочной защиты по сравнению с магнитными лентами. Дополнительные сведения см. в статье [Использование службы архивации Azure для замены ленточной инфраструктуры](https://azure.microsoft.com/documentation/articles/backup-azure-backup-cloud-as-tape/).
   > 
   > 
5. На странице **Выбор краткосрочных целей** выберите желаемый диапазон хранения в поле **Диапазон хранения** и укажите время создания резервных копий.
   
    ![Выберите краткосрочные цели](./media/backup-azure-backup-sharepoint/specify-short-term-goals2.png)
   
   > [!NOTE]
   > Так как восстановления обычно требуют данные менее чем за пять последних дней, в данном примере выбран пятидневный диапазон хранения на диске и назначена архивация на нерабочее время.
   > 
   > 
6. Проверьте, какой объем дискового пространства в пуле носителей выделен для группы защиты, и нажмите кнопку **Далее**.
7. Для каждой группы защиты DPM выделяет дисковую память для хранения и администрирования реплик. На этом этапе DPM должен создать копию выбранных данных. Выберите способ и время создания реплики и нажмите кнопку **Далее**.
   
    ![Выберите метод создания реплики](./media/backup-azure-backup-sharepoint/choose-replica-creation-method.png)
   
   > [!NOTE]
   > Чтобы не мешать сетевому трафику, выбирайте нерабочее время.
   > 
   > 
8. DPM обеспечивает целостность данных за счет проверки реплик на согласованность. Доступны два параметра. Вы можете установить расписание проверок согласованности или DPM может выполнять такие проверки в реплике автоматически, как только она становится несогласованной. Выберите желаемый параметр и нажмите кнопку **Далее**.
   
    ![Проверка согласованности](./media/backup-azure-backup-sharepoint/consistency-check.png)
9. На странице **Указание данных для оперативной защиты** выберите ферму SharePoint, которую нужно защитить, и нажмите кнопку **Далее**.
   
    ![DPM SharePoint Protection1](./media/backup-azure-backup-sharepoint/select-online-protection1.png)
10. На странице **Указание данных для оперативной защиты** выберите желаемое расписание и нажмите кнопку **Далее**.
    
    ![Online_backup_schedule](./media/backup-azure-backup-sharepoint/specify-online-backup-schedule.png)
    
    > [!NOTE]
    > DPM выполняет не более двух ежедневных операций архивации в Azure в разное время. Служба архивации Azure также может контролировать объем пропускной способности глобальной сети, который может использоваться для архивации в пиковые и непиковые часы, с помощью [регулирования сети службы архивации Azure](https://azure.microsoft.com/en-in/documentation/articles/backup-configure-vault/#enable-network-throttling).
    > 
    > 
11. В зависимости от выбранного расписания архивации на странице **Укажите политику хранения в сети** выберите политику хранения для ежедневных, еженедельных, ежемесячных и ежегодных точек архивации.
    
    ![Online_retention_policy](./media/backup-azure-backup-sharepoint/specify-online-retention.png)
    
    > [!NOTE]
    > DPM использует трехуровневую схему хранения, позволяющую выбирать разную политику хранения для разных точек архивации.
    > 
    > 
12. Как и диск, реплика начальной контрольной точки должна быть создана в Azure. Выберите желаемый параметр для создания начальной резервной копии в Azure и нажмите кнопку **Далее**.
    
    ![Online_replica](./media/backup-azure-backup-sharepoint/online-replication.png)
13. Просмотрите выбранные параметры на странице **Сводка** и нажмите кнопку **Создать группу**. После создания группы защиты появится сообщение об успешном выполнении операции.
    
    ![Сводка](./media/backup-azure-backup-sharepoint/summary.png)

## <a name="restore-a-sharepoint-item-from-disk-by-using-dpm"></a>Восстановление элемента SharePoint с диска с помощью DPM
В приведенном ниже примере *элемент восстановления SharePoint* был случайно удален и должен быть восстановлен.
![DPM SharePoint Protection4](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection5.png)

1. Откройте **консоль администратора DPM**. На вкладке **Защита** отображаются все фермы SharePoint, защищаемые DPM.
   
    ![DPM SharePoint Protection3](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection4.png)
2. Чтобы начать восстановление элемента, откройте вкладку **Восстановление** .
   
    ![DPM SharePoint Protection5](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection6.png)
3. Чтобы найти *элемент восстановления SharePoint* , можно использовать поиск на основе подстановки в пределах диапазона точек восстановления.
   
    ![DPM SharePoint Protection6](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection7.png)
4. Найдите в результатах поиска нужную точку восстановления, щелкните элемент правой кнопкой мыши и выберите пункт **Восстановить**.
5. Вы можете просмотреть разные точки восстановления и выбрать базу данных или элементы для восстановления. Выберите **дату и время восстановления**, а затем выберите **базу данных, ферму SharePoint, точку восстановления и элемент** в соответствующих полях.
   
    ![DPM SharePoint Protection7](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection8.png)
6. Щелкните элемент правой кнопкой мыши и выберите параметр **Восстановить**, чтобы открыть **мастер восстановления**. Щелкните **Далее**.
   
    ![Просмотр выбранных параметров восстановления](./media/backup-azure-backup-sharepoint/review-recovery-selection.png)
7. Выберите желаемый тип восстановления и нажмите кнопку **Далее**.
   
    ![Тип восстановления](./media/backup-azure-backup-sharepoint/select-recovery-type.png)
   
   > [!NOTE]
   > Выбранный в примере параметр **Восстановить в исходное местоположение** восстанавливает элемент на исходный сайт SharePoint.
   > 
   > 
8. Выберите желаемый **процесс восстановления** на соответствующей странице мастера.
   
   * Если ферма SharePoint не изменилась и находится в том же состоянии, что и в указанной точке восстановления, выберите **Восстановить без фермы восстановления** .
   * Если с момента создания точки восстановления ферма SharePoint изменилась, выберите вариант **Восстановление с использованием фермы восстановления** .
     
     ![процесс восстановления](./media/backup-azure-backup-sharepoint/recovery-process.png)
9. Укажите размещение экземпляра SQL Server для временного восстановления базы данных и промежуточную общую папку на сервере DPM и на сервере под управлением SharePoint для восстановления элемента.
   
    ![Расположение промежуточного хранения 1](./media/backup-azure-backup-sharepoint/staging-location1.png)
   
    DPM присоединяет базу данных контента, в которой размещается элемент SharePoint, к временному экземпляру SQL Server. Сервер DPM восстанавливает элемент из базы данных контента и помещает его в промежуточную папку на сервере DPM. Теперь элемент, восстановленный в папке промежуточного хранения на сервере DPM, нужно экспортировать в папку промежуточного хранения на ферме SharePoint.
   
    ![Расположение промежуточного хранения 2](./media/backup-azure-backup-sharepoint/staging-location2.png)
10. Откройте страницу **Указание параметров восстановления**и примените параметры безопасности к ферме SharePoint или к точке восстановления. Щелкните **Далее**.
    
    ![Варианты восстановления](./media/backup-azure-backup-sharepoint/recovery-options.png)
    
    > [!NOTE]
    > Здесь же можно отрегулировать использование пропускной способности сети. Это позволит сократить нежелательную нагрузку на сервер в рабочие часы.
    > 
    > 
11. Просмотрите сводные данные и нажмите кнопку **Восстановить** , чтобы начать восстановление файла.
    
    ![Сводка параметров восстановления](./media/backup-azure-backup-sharepoint/recovery-summary.png)
12. Теперь откройте вкладку **Мониторинг** в **консоли администратора DPM** и проверьте **состояние** восстановления.
    
    ![Состояние восстановления](./media/backup-azure-backup-sharepoint/recovery-monitoring.png)
    
    > [!NOTE]
    > Файл восстановлен. Обновите сайт SharePoint, чтобы проверить восстановленный файл.
    > 
    > 

## <a name="restore-a-sharepoint-database-from-azure-by-using-dpm"></a>Восстановление базы данных SharePoint из Azure с помощью DPM
1. Чтобы восстановить базу данных контента SharePoint, просмотрите различные точки восстановления (как было показано ранее) и выберите желаемую точку восстановления.
   
    ![DPM SharePoint Protection8](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection9.png)
2. Дважды щелкните точку восстановления SharePoint, чтобы отобразить доступные регистрационные сведения SharePoint.
   
   > [!NOTE]
   > Так как для фермы SharePoint предусмотрен длительный срок хранения в Azure, на сервере DPM нет доступных сведений о каталоге (метаданных). В результате каждый раз, когда базу данных контента SharePoint требуется вернуть в состояние на определенный момент, необходимо каталогизировать ферму SharePoint заново.
   > 
   > 
3. Нажмите кнопку **Повторить каталогизацию**.
   
    ![DPM SharePoint Protection10](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection12.png)
   
    Откроется окно состояния **Повторная каталогизация облака** .
   
    ![DPM SharePoint Protection11](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection13.png)
   
    После завершения каталогизации состояние изменится на *Успешно*. Нажмите кнопку **Закрыть**
   
    ![DPM SharePoint Protection12](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection14.png)
4. Щелкните объект SharePoint на вкладке DPM **Восстановление** , чтобы получить структуру базы данных контента. Щелкните элемент правой кнопкой мыши и выберите **Восстановить**.
   
    ![DPM SharePoint Protection13](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection15.png)
5. Выполните [процедуру восстановления, описанную ранее в этой статье](#restore-a-sharepoint-item-from-disk-using-dpm) , чтобы восстановить базу данных контента SharePoint с диска.

## <a name="faqs"></a>Часто задаваемые вопросы
Вопрос (В.). Какие версии DPM поддерживаются в SQL Server 2014 и SQL Server 2012 (SP2)?<br>
Ответ (О.). DPM 2012 R2 с накопительным пакетом обновления 4 поддерживает обе версии.

В. Можно ли восстановить элемент SharePoint в исходное расположение, если SharePoint настроен с использованием SQL AlwaysOn (с защитой на диске)?<br>
О. Да, элемент можно восстановить на исходный сайт SharePoint.

В. Можно ли восстановить базу данных SharePoint в исходное расположение, если SharePoint настроен с использованием SQL AlwaysOn?<br>
О. Так как базы данных SharePoint настраиваются в SQL AlwaysOn, их нельзя изменить, не удалив группу доступности. В связи с этим DPM не может восстанавливать базы данных в исходное расположение. Вы можете восстановить базу данных SQL Server в другой экземпляр SQL Server.

## <a name="next-steps"></a>Дальнейшие действия
* Дополнительные сведения о защите SharePoint с помощью DPM см. в [этих видеоматериалах](http://channel9.msdn.com/Series/Azure-Backup/Microsoft-SCDPM-Protection-of-SharePoint-1-of-2-How-to-create-a-SharePoint-Protection-Group).
* Ознакомьтесь со статьей [Заметки о выпуске System Center 2012 — Data Protection Manager](https://technet.microsoft.com/library/jj860415.aspx).
* Ознакомьтесь со статьей [Заметки о выпуске Data Protection Manager в составе System Center 2012 с пакетом обновления 1 (SP1)](https://technet.microsoft.com/library/jj860394.aspx).


---
title: "Служба архивации Azure: восстановление файлов и папок из резервной копии виртуальной машины Azure | Документация Майкрософт"
description: "Восстановление файлов из точки восстановления виртуальной машины Azure"
services: backup
documentationcenter: dev-center-name
author: pvrk
manager: shivamg
keywords: "восстановление на уровне элементов; восстановление файлов из резервной копии виртуальной машины Azure; восстановление файлов виртуальной машины Azure"
ms.assetid: f1c067a2-4826-4da4-b97a-c5fd6c189a77
ms.service: backup
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 09/27/2017
ms.author: pullabhk;markgal
ms.openlocfilehash: 46cc2737c23b02c6542320e355607f83042bd058
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="recover-files-from-azure-virtual-machine-backup"></a>Восстановление файлов из резервной копии виртуальной машины Azure

Azure Backup предоставляет возможность восстановления [виртуальных машин и дисков Azure](./backup-azure-arm-restore-vms.md) из резервных копий виртуальной машины Azure, также известных как точки восстановления. В этой статье описывается восстановление файлов и папок из резервной копии виртуальной машины Azure. Восстановление файлов и папок доступно для всех виртуальных машин Azure, развернутых по модели с помощью Resource Manager и защищенных в хранилище служб восстановления.

> [!Note]
> Восстановление файлов из зашифрованной резервной копии виртуальной машины не поддерживается.
>

## <a name="mount-the-volume-and-copy-files"></a>Подключение тома и копирование файлов

Чтобы восстановить файлы и папки из точки восстановления, перейдите к виртуальной машине и выбрать точку восстановления. 

1. Войдите на [портал Azure](http://portal.Azure.com) и в левом меню щелкните **Виртуальные машины**. В списке виртуальных машин выберите виртуальную машину, чтобы открыть ее панель мониторинга. 

2. В меню виртуальной машины щелкните **Архивация**, чтобы открыть панель мониторинга архивации.

    ![Открытие архивируемого элемента в хранилище служб восстановления](./media/backup-azure-restore-files-from-vm/open-vault-from-vm.png)

3. В меню панели мониторинга архивации щелкните **Восстановление файлов**, чтобы открыть соответствующее меню.

    ![Меню восстановления файлов](./media/backup-azure-restore-files-from-vm/file-recovery-blade.png)

4. В раскрывающемся меню **Выберите точку восстановления** найдите и выберите точку восстановления, которая содержит требуемые файлы. По умолчанию здесь выбрана последняя из созданных точек восстановления.

5. Щелкните **Download Executable** (Скачать исполняемый файл) (для виртуальной машины Windows в Azure) или **Скачать скрипт** (для виртуальной машины Linux в Azure), чтобы скачать программное обеспечение для копирования файлов из точки восстановления. 

    ![Созданный пароль](./media/backup-azure-restore-files-from-vm/download-executable.png)

    Azure скачает исполняемый файл или сценарий на локальный компьютер.

    ![сообщение о скачивании исполняемого файла или сценария](./media/backup-azure-restore-files-from-vm/run-the-script.png)

    Чтобы запустить исполняемый файл или сценарий с правами администратора, мы рекомендуем сохранить скачанный файл на компьютере.

6. Исполняемый файл или сценарий защищен и требует пароля. В меню **Восстановление файла** нажмите кнопку "Копировать" для загрузки пароля в память.

    ![Созданный пароль](./media/backup-azure-restore-files-from-vm/generated-pswd.png)

7. Из расположения скачивания (обычно папка "Загрузки") щелкните исполняемый файл или сценарий правой кнопкой мыши и запустите его с учетными данными администратора. При появлении запроса введите пароль или вставьте его из памяти и нажмите клавишу ВВОД. После ввода пароля сценарии подключаются к точке восстановления.

    ![Меню восстановления файлов](./media/backup-azure-restore-files-from-vm/executable-output.png)

    Если скрипт выполняется на компьютере с ограниченным доступом, убедитесь в наличии доступа к следующим ресурсам:

    - download.microsoft.com
    - конечные точки Azure, которые использовались для резервного копирования этой виртуальной машины Azure;
    - исходящий порт 3260.

   Для Linux сценарию требуются компоненты open-iscsi и lshw для подключения к точке восстановления. Если на компьютере, где выполняется сценарий, отсутствуют компоненты, сценарий запрашивает разрешение на их установку. Согласитесь на установку необходимых компонентов.  
         
   Сценарий можно запустить на любом компьютере, операционная система на котором совпадает или совместима с операционной системой архивной виртуальной машины. Условия совместимости можно проверить в [таблице совместимых ОС](backup-azure-restore-files-from-vm.md#compatible-os). Если на защищенной виртуальной машине Azure используются дисковые пространства Windows (для виртуальных машин Windows в Azure) либо LVM или RAID-массивы (для виртуальных машин Linux), то запустить на ней исполняемый файл или сценарий не удастся. Вместо этого запустите его на другом компьютере с совместимой операционной системой.

### <a name="compatible-os"></a>Совместимые операционные системы

#### <a name="for-windows"></a>Для Windows

Следующая таблица содержит информацию о совместимости операционных систем сервера и компьютера. Нельзя восстановить файлы до предыдущей или будущей версии операционной системы. Например, нельзя восстановить файл с виртуальной машины Windows Server 2016 на компьютер Windows Server 2012 или Windows 8. Файлы можно восстановить с виртуальной машины в ту же серверную операционную систему или в совместимую клиентскую операционную систему.   

|ОС сервера | Совместимые ОС клиента  |
| --------------- | ---- |
| Windows Server 2016    | Windows 10 |
| Windows Server 2012 R2 | Windows 8.1 |
| Windows Server 2012    | Windows 8  |
| Windows Server 2008 R2 | Windows 7   |

#### <a name="for-linux"></a>Для Linux

В Linux операционная система компьютера, используемого для восстановления файлов, должна поддерживать файловую систему защищенной виртуальной машины. При выборе компьютера для выполнения сценария убедитесь, что он имеет совместимую ОС и использует одну из версий, приведенных в следующей таблице:

|ОС Linux | Версии  |
| --------------- | ---- |
| Ubuntu | 12.04 и выше |
| CentOS | 6.5 и выше  |
| RHEL | 6.7 и выше |
| Debian | 7 и выше |
| Oracle Linux | 6.4 и выше |

Сценарию также требуется компоненты python и bash для выполнения операций и безопасного подключения к точке восстановления.

|Компонент | Версия  |
| --------------- | ---- |
| bash | 4 и выше |
| python | 2.6.6 и выше  |


### <a name="identifying-volumes"></a>Определение томов

#### <a name="for-windows"></a>Для Windows

При выполнении исполняемого файла операционная система подключает новые тома и назначает им буквы дисков. Для просмотра этих дисков вы можете использовать проводник Windows или проводник. Этим томам могут быть назначены не те буквы дисков, которые использовались на исходной виртуальной машине. Имена томов сохраняются. Например, если на исходной виртуальной машине том назывался "Диск данных (E:`\`)", на локальном компьютере он будет подключен как "Диск данных (любая буква:`\`)". Просмотрите все тома, которые упоминаются в выходных данных скрипта, пока не найдете нужные файлы или папки.  
       
   ![Меню восстановления файлов](./media/backup-azure-restore-files-from-vm/volumes-attached.png)
           
#### <a name="for-linux"></a>Для Linux

В Linux тома точки восстановления подключаются к папке, в которой выполняет сценарий. Отображаются подключенные диски, тома и соответствующие пути подключения. Эти пути подключения видимы для пользователей с доступом на корневом уровне. Просмотрите тома, указанные в выходных данных сценария.

  ![Меню восстановления файлов Linux](./media/backup-azure-restore-files-from-vm/linux-mount-paths.png)
  

## <a name="closing-the-connection"></a>Закрытие подключения

Когда вы найдете все нужные файлы и скопируете их в локальное хранилище, удалите или отключите дополнительные диски. Чтобы отключить диски, щелкните **Unmount Disks** (Отключить диски) в меню **Восстановление файлов** на портале Azure.

![Отключение дисков](./media/backup-azure-restore-files-from-vm/unmount-disks3.png)

Когда диски будут отключены, появится сообщение об успешном завершении операции. На обновление состояния подключения может потребоваться несколько минут, после чего диски можно удалить.

В Linux после разрыва подключения к точке восстановления операционная система не удаляет соответствующие пути подключения автоматически. Они существуют в виде потерянных томов и видимы, но при обращении к ним или записи в них файлов происходит ошибка. Их можно удалить вручную. При запуске сценарий определяет такие тома, оставшиеся от любой предыдущей точки восстановления, и очищает их после согласия пользователя.

## <a name="special-configurations"></a>Специальные конфигурации

### <a name="dynamic-disks"></a>Динамические диски

Если на защищенной виртуальной машине Azure есть тома, обладающие одной или всеми следующими характеристиками, то запустить на ней исполняемый сценарий не удастся. 

  - Тома, охватывающие несколько дисков (составные и чередующиеся тома)
  - Отказоустойчивые тома (зеркальные тома и тома RAID-5) на динамических дисках 

Вместо этого запустите исполняемый сценарий на другом компьютере с совместимой операционной системой.

### <a name="windows-storage-spaces"></a>Дисковое пространство Windows

Дисковые пространства Windows — это технология Windows, которая позволяет виртуализировать хранилище. С помощью дисковых пространств Windows можно сгруппировать стандартные отраслевые диски в пулы носителей. Затем доступное пространство в этих пулах носителей можно использовать для создания виртуальных дисков, называемых дисковыми пространствами.

Если защищенная виртуальная машина Azure использует дисковые пространства Windows, то запустить на ней исполняемый сценарий не удастся. Вместо этого запустите его на другом компьютере с совместимой операционной системой.

### <a name="lvmraid-arrays"></a>LVM или RAID-массивы

В Linux для управления логическими томами на нескольких дисках используется диспетчер логических томов (LVM) и (или) программные RAID-массивы. Если защищенная виртуальная машина Linux использует LVM и/или RAID-массивы, на ней нельзя запустить сценарий. Вместо этого запустите сценарий на любом другом компьютере с совместимой операционной системы, поддерживающей файловую систему защищенной виртуальной машины.

В следующих выходных данных сценария отображаются диски и тома LVM или RAID-массивов с типом раздела.

   ![Меню выходных данных для LVM в Linux](./media/backup-azure-restore-files-from-vm/linux-LVMOutput.png)
   
Чтобы подключить эти разделы, выполните команды в следующих разделах. 

**Для разделов LVM**

Эта команда выводит имена групп томов в физическом томе.
```
$ pvs <volume name as shown above in the script output> 
```
Эта команда выводит все логические тома, имена и их пути в группе томов.

```
$ lvdisplay <volume-group-name from the pvs command’s results> 
```

Эта команда подключает логические тома по указанному пути.

```
$ mount <LV path> </mountpath>
```



**Для RAID-массивов**

Эта команда выводит сведения обо всех дисках RAID.

```
$ mdadm –detail –scan
```
 Соответствующий диск RAID будет отображен как `/dev/mdm/<RAID array name in the protected VM>`.

Если диск RAID содержит физические тома, используйте команду mount.
```
$ mount [RAID Disk Path] [/mountpath]
```

Если для этого диска RAID настроен другой LVM, то выполните приведенную выше процедуру для разделов LVM, указав имя тома в качестве имени диска RAID.

## <a name="troubleshooting"></a>Устранение неполадок

Если при восстановлении файлов из виртуальных машин у вас возникнут проблемы, проверьте сведения, приведенные в следующей таблице.

| Сообщение об ошибке или ситуация | Возможные причины | Рекомендуемое действие |
| ------------------------ | -------------- | ------------------ |
| Исполняемый файл возвращает ошибку *Exception connecting to the target* (исключение при подключении к целевому объекту) |Скрипт не может получить доступ к точке восстановления | Проверьте, соответствует ли компьютер всем перечисленным выше требованиям. |  
|   Исполняемый файл возвращает ошибку *The target has already been logged in via an ISCSI session* (Вход на целевое устройство уже выполнен через сеанс iSCSI). | Этот скрипт уже запущен на этом компьютере и диски уже подключены | Тома точки восстановления уже подключены. Их НЕЛЬЗЯ подключить с теми же буквами дисков, что и на исходной виртуальной машине. Просмотрите все доступные тома в проводнике, чтобы найти нужный файл. |
| Исполняемый файл возвращает ошибку *This script is invalid because the disks have been dismounted via portal/exceeded the 12-hr limit. Please download a new script from the portal.* (Этот сценарий недействителен, так как диски отключены через портал или превышено ограничение в 12 часов. Скачайте с портала новый сценарий). | Диски отключены через портал или превышено 12-часовое ограничение. |    Эта копия исполняемого файла больше недействительна, и использовать ее нельзя. Если вам еще нужен доступ к файлам этой точки восстановления на определенный момент времени, зайдите на портал и скачайте новый EXE-файл.|
| На компьютере, где выполняется EXE-файл, новые тома не отключаются кнопкой отключения |    Инициатор iSCSI на компьютере не отвечает на запросы или не обновляет подключение к целевому объекту, сохраняя состояние кэша |    Подождите несколько минут после нажатия кнопки отключения. Если новые тома по-прежнему не отключаются, откройте в проводнике каждый из них. Инициатор принудительно обновит соединение, и диски будут отключены с сообщением об ошибке "Диск недоступен".|
| Скрипт выполняется успешно, но в его выходных данных нет сообщения "New volumes attached" (Новые тома подключены). | Это временная проблема   | Тома, скорее всего, уже подключены. Попробуйте открыть их через проводник. Если вы несколько раз запускали скрипт на одном и том же компьютере, попробуйте перезагрузить компьютер. Список будет отображаться при последующих запусках EXE-файла. |
| В Linux: не удается просмотреть нужные тома. | Операционная система компьютера, на котором выполняется сценарий, не может распознать базовую файловую систему защищенной виртуальной машины. | Проверьте, является ли точка восстановления отказоустойчивой или обеспечивающей целостность файлов. Если это конечная точка, обеспечивающая целостность файлов, выполните сценарий на другом компьютере, ОС которого распознает файловую систему защищенной виртуальной машины. |
| В Windows: не удается просмотреть нужные тома | Диски присоединены, но тома не настроены | На экране управления дисками определите дополнительные диски, относящиеся к точке восстановления. Если любой из этих дисков не подключен к сети, попробуйте подключить их, щелкнув правой кнопкой мыши диск и выбрав "В сети".|

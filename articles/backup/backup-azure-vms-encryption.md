---
title: "Резервное копирование и восстановление зашифрованных виртуальных машин с помощью службы Azure Backup"
description: "В этой статье приведены сведения о резервном копировании и восстановлении виртуальных машин, зашифрованных с помощью шифрования дисков Azure."
services: backup
documentationcenter: 
author: JPallavi
manager: vijayts
editor: 
ms.assetid: 8387f186-7d7b-400a-8fc3-88a85403ea63
ms.service: backup
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 10/13/2017
ms.author: pajosh;markgal;trinadhk; sogup
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 509e891207d1469ed244eab4512ec66420284fd5
ms.sourcegitcommit: 901a3ad293669093e3964ed3e717227946f0af96
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/21/2017
---
# <a name="back-up-and-restore-encrypted-virtual-machines-with-azure-backup"></a>Резервное копирование и восстановление зашифрованных виртуальных машин с помощью службы Azure Backup
В этой статье рассказывается о действиях по резервному копированию и восстановлению виртуальных машин с помощью службы Azure Backup. Кроме того, здесь приведены поддерживаемые сценарии, предварительные требования и сведения об устранении неполадок при возникновении ошибок.

## <a name="supported-scenarios"></a>Поддерживаемые сценарии использования.

 * Резервное копирование и восстановление зашифрованных виртуальных машин поддерживается только для виртуальных машин, использующих модель развертывания с помощью Azure Resource Manager, и не поддерживается для виртуальных машин, использующих классическую модель развертывания. <br>
 * Резервное копирование и восстановление зашифрованных виртуальных машин поддерживается для виртуальных машин как Windows, так и Linux, использующих шифрование дисков Azure. Шифрование дисков использует стандартный для отрасли компонент BitLocker в Windows и DM-Crypt в Linux. <br>
 
 В приведенной ниже таблице показаны поддерживаемые сценарии только для виртуальных машин, зашифрованных только с помощью ключа шифрования BitLocker (BEK) или ключа шифрования ключей (KEK).
 
 
   |  | Виртуальные машины BEK + KEK | Виртуальные машины, зашифрованные только с помощью BEK |
   | --- | --- | --- |
   | **Неуправляемые виртуальные машины**  | Yes | Yes  |
   | **Управляемые виртуальные машины**  | Yes | Yes  |

## <a name="prerequisites"></a>Технические условия
* Виртуальная машина была зашифрована с помощью [шифрования дисков Azure](../security/azure-security-disk-encryption.md).

* Хранилище служб восстановления создано и репликация хранилища установлена согласно инструкциям в статье [Подготовка среды к архивации виртуальных машин, развернутых с помощью Resource Manager](backup-azure-arm-vms-prepare.md).

* Службе Azure Backup предоставлены [разрешения для доступа к хранилищу ключей](#provide-permissions-to-azure-backup), содержащему ключи и секреты для зашифрованных виртуальных машин.

## <a name="backup-encrypted-vm"></a>Резервное копирование зашифрованной виртуальной машины
Выполните приведенные ниже действия, чтобы выбрать цель резервного копирования, определить политику, настроить элементы и активировать резервное копирование.

### <a name="configure-backup"></a>Настройка резервного копирования
1. Если хранилище служб восстановления уже открыто, перейдите к следующему шагу. Если хранилище служб восстановления не открыто, на портале Azure в меню **Концентратор** выберите **Обзор**.

   a. В списке ресурсов введите **Службы восстановления**.

   Б. Как только вы начнете вводить символы, список отфильтруется соответствующим образом. Когда вы увидите пункт **Хранилища служб восстановления**, щелкните его.

      ![Хранилище служб восстановления](./media/backup-azure-vms-encryption/browse-to-rs-vaults.png) <br/>

    c. После этого отобразится список хранилищ служб восстановления, Выберите хранилище из списка.

     Затем откроется панель мониторинга выбранного хранилища.
2. В открывшемся списке элементов хранилища щелкните **Резервное копирование**, чтобы начать резервное копирование зашифрованной виртуальной машины.

      ![Колонка резервного копирования](./media/backup-azure-vms-encryption/select-backup.png)
3. В элементе **Резервное копирование** выберите **Backup goal** (Цель резервного копирования).

      ![Колонка сценариев](./media/backup-azure-vms-encryption/select-backup-goal-one.png)
4. В раскрывающемся списке **Where is your workload running?** (Где выполняется рабочая нагрузка?) выберите **Azure**. В раскрывающемся списке **What do you want to backup?** (Что необходимо архивировать?) выберите **Виртуальная машина**. Нажмите кнопку **ОК**.

   ![Открытие колонки сценария](./media/backup-azure-vms-encryption/select-backup-goal-two.png)
5. В раскрывающемся списке **Choose backup policy** (Выберите политику резервного копирования) выберите политику резервного копирования для своего хранилища. Нажмите кнопку **ОК**.

      ![Выбор политики резервного копирования](./media/backup-azure-vms-encryption/setting-rs-backup-policy-new.png)

    Указаны сведения о политике по умолчанию. Если вы хотите создать политику, в раскрывающемся списке выберите **Создать**. Как только вы нажмете кнопку **ОК**, политика резервного копирования будет связана с хранилищем.

6. Выберите зашифрованные виртуальные машины, чтобы связать их с указанной политикой, и нажмите кнопку **OК**.

      ![Выбор зашифрованных виртуальных машин](./media/backup-azure-vms-encryption/selected-encrypted-vms.png)
7. На этой странице приведены сведения о хранилище ключей, связанном с выбранными зашифрованными виртуальными машинами. Для резервного копирования требуется доступ только для чтения к ключам и секретам в хранилище ключей. Эти разрешения используются, чтобы создать резервную копию ключа и секрета, а также связанных виртуальных машин.<br>
Если вы являетесь **пользователя элемента**, включить архивацию процесс будет легко получить доступ к хранилищу ключей, чтобы резервная копия, зашифрованная виртуальные машины без вмешательства пользователя.

   ![Сообщение для зашифрованных виртуальных машин](./media/backup-azure-vms-encryption/member-user-encrypted-vm-warning-message.png)

   Для **пользователя Guest**, необходимо предоставить разрешения к службе резервного копирования для доступа к хранилище для резервных копий для работы. Эти разрешения можно предоставить, следуя [шаги, описанные в следующем разделе](#provide-permissions-to-backup)

   ![Сообщение для зашифрованных виртуальных машин](./media/backup-azure-vms-encryption/guest-user-encrypted-vm-warning-message.png)
 
    Теперь, когда все параметры для хранилища заданы, в нижней части страницы нажмите кнопку **Включить резервное копирование**. **Включить архивацию** выполняется развертывание политики в хранилище и виртуальные машины.
  
8. На следующем шаге подготовки нужно установить агент виртуальной машины или убедиться, что он установлен. Для этого выполните действия, указанные в статье [Подготовка среды к архивации виртуальных машин, развернутых с помощью Resource Manager](backup-azure-arm-vms-prepare.md).

### <a name="trigger-a-backup-job"></a>активация задания архивации;
Следуйте указаниям в статье [Архивация виртуальных машин Azure в хранилище служб восстановления](backup-azure-arm-vms.md), чтобы активировать задание резервного копирования.

### <a name="continue-backups-of-already-backed-up-vms-with-encryption-enabled"></a>Продолжение резервного копирования уже архивированных виртуальных машин с включенным шифрованием  
Если у вас есть виртуальные машины, которые уже архивируются в хранилище служб восстановления и разрешены для дальнейшего шифрования, нужно предоставить службе резервного копирования разрешения на доступ к хранилищу ключей, чтобы архивация продолжилась. Эти разрешения можно предоставить, следуя [действиям, описанным в следующем разделе](#provide-permissions-to-azure-backup). Или можно выполнить действия PowerShell из раздела о включении резервного копирования в [документации по PowerShell](backup-azure-vms-automation.md). 

## <a name="provide-permissions-to-backup"></a>Предоставление разрешений для службы резервного копирования
Чтобы предоставить службе резервного копирования соответствующие разрешения для доступа к хранилищу ключей и архивации зашифрованных виртуальных машин, выполните следующие действия:
1. Выберите **Больше служб** и найдите **Хранилища ключей**.

    ![Хранилища ключей](./media/backup-azure-vms-encryption/search-key-vault.png)
    
2. В списке хранилищ ключей выберите хранилище ключей, связанное с зашифрованной виртуальной машиной, которую требуется архивировать.

     ![Выбор хранилища ключей](./media/backup-azure-vms-encryption/select-key-vault.png)
     
3. Выберите **Политики доступа**, а затем щелкните **Добавить**.

    ![Добавить](./media/backup-azure-vms-encryption/select-key-vault-access-policy.png)
    
4. Выберите **Выбор субъекта** и в поле поиска введите **Служба управления резервным копированием**. 

    ![Поиск службы резервного копирования](./media/backup-azure-vms-encryption/search-backup-service.png)
    
5. Выберите **службу управления резервным копированием**, а затем нажмите кнопку **Выбрать**.

    ![Выбор службы резервного копирования](./media/backup-azure-vms-encryption/select-backup-service.png)
    
6. В раскрывающемся списке **Настроить при помощи шаблона (необязательно)** выберите **Служба архивации Azure**. Необходимые разрешения автоматически заполняются в раскрывающихся списках **Разрешения ключей** и **Разрешения секретов**. Если виртуальная машина зашифрована с использованием **только BEK**, необходимо отменить выбор **разрешений для ключей**, так как разрешения требуются только для секретов.

    ![Выбор службы Azure Backup](./media/backup-azure-vms-encryption/select-backup-template.png)
    
7. Нажмите кнопку **ОК**. Обратите внимание, что в колонке **Политики доступа** добавлена **служба управления резервным копированием**. 

    ![Политики доступа](./media/backup-azure-vms-encryption/backup-service-access-policy.png)
    
8. Выберите **Сохранить**, чтобы предоставить необходимые разрешения для службы резервного копирования.

    ![Политика доступа для службы резервного копирования](./media/backup-azure-vms-encryption/save-access-policy.png)

После предоставления разрешений можно приступить к включению резервного копирования для зашифрованных виртуальных машин.

## <a name="restore-an-encrypted-vm"></a>Восстановление зашифрованной виртуальной машины
Для восстановления зашифрованной виртуальной машины сначала необходимо восстановить диски, выполнив инструкции по восстановлению заархивированных дисков в разделе [Выбор конфигурации восстановления для виртуальной машины](backup-azure-arm-restore-vms.md#choose-a-vm-restore-configuration). После этого можно выбрать один из следующих вариантов:

* Выполните команды PowerShell, описанные в разделе [Создание виртуальной машины с восстановленного диска](backup-azure-vms-automation.md#create-a-vm-from-restored-disks), чтобы создать полную виртуальную машину из восстановленных дисков.
* Или [используйте шаблоны для настройки восстановленной виртуальной машины](backup-azure-arm-restore-vms.md#use-templates-to-customize-a-restored-vm), чтобы создать виртуальные машины из восстановленных дисков. Шаблоны можно использовать только для точек восстановления, созданных после 26 апреля 2017 года.

## <a name="troubleshooting-errors"></a>Устранение ошибок
| Операция | Сведения об ошибке | Способы устранения: |
| --- | --- | --- |
|Архивация | Служба резервного копирования не имеет достаточных разрешений к хранилищу ключей для резервного копирования зашифрованных виртуальных машин. | Службе необходимо предоставить эти разрешения, следуя [действиям в предыдущем разделе](#provide-permissions-to-azure-backup). Или можно выполнить действия с PowerShell в подразделе о включении защиты документации PowerShell из раздела [Резервное копирование виртуальных машин Azure](backup-azure-vms-automation.md#back-up-azure-vms). |  
| восстановление; |Вы не можете восстановить эту зашифрованную виртуальную машину, так как с ней связано хранилище ключей. |Создайте хранилище ключей с помощью действий, описанных в статье [Приступая к работе с хранилищем ключей Azure](../key-vault/key-vault-get-started.md). Сведения о том, как восстановить ключ и секрет, если они отсутствуют, см. в статье [Восстановление ключа и секрета в хранилище ключей для зашифрованных виртуальных машин с помощью службы архивации Azure](backup-azure-restore-key-secret.md). |
| восстановление; |Вы не можете восстановить эту зашифрованную виртуальную машину, так как с ней не связаны ключ и секрет. |Сведения о том, как восстановить ключ и секрет, если они отсутствуют, см. в статье [Восстановление ключа и секрета в хранилище ключей для зашифрованных виртуальных машин с помощью службы архивации Azure](backup-azure-restore-key-secret.md). |
| восстановление; |У службы резервного копирования нет разрешения на доступ к ресурсам в вашей подписке. |Как упоминалось ранее, сначала восстановите диски, выполнив инструкции по восстановлению заархивированных дисков в разделе [Выбор конфигурации восстановления для виртуальной машины](backup-azure-arm-restore-vms.md#choose-a-vm-restore-configuration). После этого с помощью PowerShell [создайте виртуальную машину из восстановленного диска](backup-azure-vms-automation.md#create-a-vm-from-restored-disks). |

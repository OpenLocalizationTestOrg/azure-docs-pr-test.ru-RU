---
title: "Мониторинг резервных копий виртуальных машин, развернутых с помощью Resource Manager | Документация Майкрософт"
description: "Мониторинг событий и предупреждений в виртуальных машинах, развернутых с помощью Resource Manager. Отправка электронной почты на основе предупреждений."
services: backup
documentationcenter: dev-center-name
author: markgalioto
manager: carmonm
editor: 
ms.assetid: fed32015-2db2-44f8-b204-d89f6fd1bea2
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/21/2016
ms.author: markgal;trinadhk;giridham;
ms.openlocfilehash: ebd7a886f5853ec3fa9b6e816083e9edd868ef76
ms.sourcegitcommit: b7adce69c06b6e70493d13bc02bd31e06f291a91
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/19/2017
---
# <a name="monitor-alerts-for-azure-virtual-machine-backups"></a>Мониторинг предупреждений в резервных копиях виртуальных машин Azure
Предупреждения — это ответы службы о том, что пороговое значение события достигнуто или превышено. Знания о времени возникновения проблем могут сыграть очень важную роль для экономии средств предприятия. Как правило, предупреждения не приходят по расписанию. Поэтому целесообразно узнавать о времени их возникновения как можно раньше. Например, когда задание резервного копирования или восстановления завершается сбоем, предупреждение появляется в течение 5 минут после сбоя. На панели мониторинга хранилища на плитке "Оповещения, связанные с архивацией" отображаются критические события и события уровня предупреждения. В параметрах оповещений, связанных с архивацией, можно просмотреть все события. Но что делать, если предупреждение возникает во время решения другой проблемы? Если время возникновения предупреждения неизвестно, это может причинить незначительные неудобства или привести к компрометации данных. Чтобы нужные люди получали предупреждение, настройте в службе отправку уведомлений по электронной почте при их возникновении. Дополнительные сведения о настройке уведомлений по электронной почте см. в разделе [Настройка уведомлений](backup-azure-monitor-vms.md#configure-notifications).

## <a name="how-do-i-find-information-about-the-alerts"></a>Как найти сведения о предупреждениях
Чтобы просмотреть сведения о событии, вызвавшем предупреждение, необходимо открыть колонку "Оповещения, связанные с архивацией". Это можно сделать двумя способами: на панели мониторинга хранилища на плитке "Оповещения, связанные с архивацией" или в колонке "Предупреждения и события".

Чтобы открыть колонку "Оповещения, связанные с архивацией" на плитке "Оповещения, связанные с архивацией" выполните следующее:

* На панели мониторинга хранилища на плитке **Оповещения, связанные с архивацией** щелкните **Критическое** или **Предупреждение**, чтобы просмотреть операционные события этой степени серьезности.

    ![Плитка "Оповещения, связанные с архивацией"](./media/backup-azure-monitor-vms/backup-alerts-tile.png)

Чтобы открыть колонку "Оповещения, связанные с архивацией" в колонке "Предупреждения и события", выполните следующее:

1. На панели мониторинга хранилища щелкните **Все параметры**. ![Кнопка "Все параметры"](./media/backup-azure-monitor-vms/all-settings-button.png)
2. В колонке **Параметры** щелкните **Предупреждения и события**. ![Кнопка "Предупреждения и события"](./media/backup-azure-monitor-vms/alerts-and-events-button.png)
3. В колонке **Предупреждения и события** щелкните **Оповещения, связанные с архивацией**. ![Кнопка "Оповещения, связанные с архивацией"](./media/backup-azure-monitor-vms/backup-alerts.png)

    Откроется колонка **Оповещения, связанные с архивацией** с отфильтрованными предупреждениями.

    ![Плитка "Оповещения, связанные с архивацией"](./media/backup-azure-monitor-vms/backup-alerts-critical.png)
4. Чтобы просмотреть подробные сведения об определенном предупреждении, щелкните его в списке событий. После этого откроется колонка **Сведения** для этого предупреждения.

    ![Сведения о событии](./media/backup-azure-monitor-vms/audit-logs-event-detail.png)

    Чтобы настроить атрибуты, отображаемые в списке, см. раздел [Просмотр дополнительных атрибутов событий](backup-azure-monitor-vms.md#view-additional-event-attributes).

## <a name="configure-notifications"></a>Настройка уведомлений
 В службе можно настроить отправку уведомлений по электронной почте относительно оповещений, произошедших за последний час, или при возникновении определенных типов событий.

Чтобы настроить уведомления по электронной почте для оповещений, выполните следующее:

1. В меню "Оповещения, связанные с архивацией" щелкните **Настройка уведомлений**

    ![Меню "Оповещения, связанные с архивацией"](./media/backup-azure-monitor-vms/backup-alerts-menu.png)

    Откроется колонка "Настройка уведомлений".

    ![Колонка "Настройка уведомлений"](./media/backup-azure-monitor-vms/configure-notifications.png)
2. В колонке "Настройка уведомлений" выберите **Вкл.**под пунктом "Уведомления по электронной почте".

    Возле пунктов "Получатели" и "Серьезность" стоят звездочки, так как эти сведения являются обязательными. Укажите хотя бы один адрес электронной почты и выберите по крайней мере один уровень серьезности.
3. В поле **Получатели (электронная почта)** введите адреса электронной почты получателей уведомлений. Используйте формат username@domainname.com. Разделите несколько адресов электронной почты с помощью точки с запятой (;).
4. В области **Уведомлять** выберите **Каждое оповещение** для отправки уведомления при возникновении конкретного предупреждения или **Почасовой дайджест** для отправки сводки за последний час.
5. В списке **Серьезность** выберите один или несколько уровней, по которым нужно активировать уведомления по электронной почте.
6. Выберите команду **Сохранить**.

   ### <a name="what-alert-types-are-available-for-azure-iaas-vm-backup"></a>Какие типы оповещений доступны для резервного копирования виртуальных машин IaaS Azure?
   | Уровень оповещения | Отправляемые оповещения |
   | --- | --- |
   | критические ошибки. |Сбой резервного копирования, сбой восстановления |
   | Предупреждение |Нет |
   | Информация |Нет |

### <a name="are-there-situations-where-email-isnt-sent-even-if-notifications-are-configured"></a>Бывает ли, что электронная почта не отправляется, даже если уведомления настроены?
Иногда оповещения не отправляются, даже если уведомления настроены правильно. Уведомления по электронной почте не отправляются в таких случаях (во избежание чрезмерного количества оповещений):

* настроен почасовой дайджест, а предупреждение возникает и устраняется в течение часа;
* задание отменено;
* задание резервного копирования активируется, а затем происходит сбой; кроме того, выполняется еще одно задание резервного копирования;
* запускается запланированное задание резервного копирования для виртуальной машины, на которой включен Resource Manager, при этом сама машина больше не существует.

## <a name="customize-your-view-of-events"></a>Настройка представления событий
В параметрах **журналов аудита** представлен набор предварительно определенных фильтров и столбцы со сведениями об операционных событиях. Представление можно настроить таким образом, чтобы при открытии в колонке **События** отображались нужные данные.

1. На [панели мониторинга хранилища](backup-azure-manage-vms.md#open-a-recovery-services-vault-in-the-dashboard) найдите и щелкните **Журналы аудита**, чтобы открыть колонку **События**.

    ![Журналы аудита](./media/backup-azure-monitor-vms/audit-logs-1606-1.png)

    После этого откроется колонка **События** со сведениями об операциях только для текущего хранилища.

    ![Фильтр "Журналы аудита"](./media/backup-azure-monitor-vms/audit-logs-filter.png)

    В колонке отображаются критические события, события ошибок, предупреждения и информационные события за последнюю неделю. Значение интервала времени соответствует значению по умолчанию в колонке **Фильтр**. В колонке **События** также отображается линейчатая диаграмма, которая позволяет отслеживать время возникновения событий. Если отображать линейчатую диаграмму не требуется, в меню **События** щелкните **Скрыть диаграмму**. В представлении по умолчанию в меню "События" содержатся сведения об операциях, уровне, состоянии, ресурсах и времени. Сведения о предоставлении дополнительных атрибутов событий см. в разделе о [получении дополнительных сведений о событиях](backup-azure-monitor-vms.md#view-additional-event-attributes).
2. Чтобы получить дополнительные сведения об операционном событии, щелкните его в столбце **Операция**. После этого откроется соответствующая колонка. В ней содержатся подробные сведения о событиях. События сгруппированы по идентификатору корреляции и списку событий, произошедших за определенный промежуток времени.

    ![Сведения об операции](./media/backup-azure-monitor-vms/audit-logs-details-window.png)
3. Чтобы просмотреть подробные сведения об определенном событии, щелкните его. После этого откроется колонка **Сведения** для этого события.

    ![Сведения о событии](./media/backup-azure-monitor-vms/audit-logs-details-window-deep.png)

    Информация о событиях зависит от количества полученных сведений. Если нужно, чтобы для каждого события отображался большой объем информации, которую можно добавить в колонку **События**, см. раздел о [получении дополнительных сведений о событиях](backup-azure-monitor-vms.md#view-additional-event-attributes).

## <a name="customize-the-event-filter"></a>Настройка фильтра событий
С помощью **фильтра** можно настроить или выбрать сведения, которые будут отображаться в конкретной колонке. Чтобы отфильтровать сведения о событии, выполните следующее:

1. На [панели мониторинга хранилища](backup-azure-manage-vms.md#open-a-recovery-services-vault-in-the-dashboard) найдите и щелкните **Журналы аудита**, чтобы открыть колонку **События**.

    ![Журналы аудита](./media/backup-azure-monitor-vms/audit-logs-1606-1.png)

    После этого откроется колонка **События** со сведениями об операциях только для текущего хранилища.

    ![Фильтр "Журналы аудита"](./media/backup-azure-monitor-vms/audit-logs-filter.png)
2. В меню **События** щелкните **Фильтр**, чтобы открыть эту колонку.

    ![Открытие колонки "Фильтр"](./media/backup-azure-monitor-vms/audit-logs-filter-button.png)
3. В колонке **Фильтр** можно настроить значения фильтров **Уровень**, **Интервал времени** и **Вызывающий объект**. Другие фильтры недоступны, так как они используются для предоставления текущих сведений для хранилища служб восстановления.

    ![Сведения о запросе журнала аудита](./media/backup-azure-monitor-vms/filter-blade.png)

    Вы можете указать следующие **уровни** события: "Критическое", "Ошибка", "Предупреждение" и "Информационное". Вы можете выбрать любую комбинацию типов событий. Необходимо выбрать по крайней мере один уровень. Кроме того, уровни событий можно включить или отключить. В фильтре **Интервал времени** можно указать время, в течение которого будут записываться события. а также время начала и окончания записи.
4. Чтобы отправить запрос к журналу операций, выбрав условия фильтра, нажмите кнопку **Обновить**. Результаты отобразятся в колонке **События** .

    ![Сведения об операции](./media/backup-azure-monitor-vms/edited-list-of-events.png)

### <a name="view-additional-event-attributes"></a>Просмотр дополнительных атрибутов событий
С помощью кнопки **Столбцы** можно включить дополнительные атрибуты событий, которые будут отображаться в списке в колонке **События**. В списке событий по умолчанию содержатся сведения об операциях, уровне, состоянии, ресурсах и времени. Чтобы включить дополнительные атрибуты, сделайте следующее:

1. В колонке **События** щелкните **Столбцы**.

    ![Открыть столбцы](./media/backup-azure-monitor-vms/audi-logs-column-button.png)

    Откроется колонка **Выбор столбцов** .

    ![Колонка "Столбцы"](./media/backup-azure-monitor-vms/columns-blade.png)
2. Чтобы выбрать атрибут, установите соответствующий флажок. Флажок атрибута можно установить и снять.
3. Нажмите кнопку **Сбросить**, чтобы сбросить список атрибутов в колонке **События**. Добавив или удалив атрибуты в списке, щелкните **Сбросить** , чтобы просмотреть новый список атрибутов событий.
4. Нажмите кнопку **Обновить** , чтобы обновить данные в атрибутах событий. В таблице ниже приведены сведения о каждом атрибуте.

| Имя столбца | ОПИСАНИЕ |
| --- | --- |
| Операция |Имя операции |
| Уровень |Для уровня операции можно задать такие значения: "Информационное", "Предупреждение", "Ошибка" или "Критическое". |
| Status |Описательное состояние операции |
| Ресурс |URL-адрес, идентифицирующий ресурс, также известный как идентификатор ресурса |
| Время |Время возникновения события, измеряющееся от текущего времени |
| Вызывающий объект |Объект, вызвавший или активировавший событие (система или пользователь) |
| Timestamp |Время активации события |
| Группа ресурсов |Связанная группа ресурсов |
| Тип ресурса |Внутренний тип ресурсов, используемый Resource Manager |
| Идентификатор подписки |Связанный идентификатор подписки |
| Категория |Категория события |
| Идентификатор корреляции |Общий идентификатор связанных событий |

## <a name="use-powershell-to-customize-alerts"></a>Использование PowerShell для настройки предупреждений
Вы можете получать настраиваемые оповещения о заданиях на портале. Для этого в PowerShell нужно определить правила оповещений для событий журналов операций. Рекомендуется использовать PowerShell версии *1.3.0 или более поздней*.

Чтобы настроить пользовательское оповещение об ошибках резервного копирования, используйте команду, подобную следующему скрипту:

```
PS C:\> $actionEmail = New-AzureRmAlertRuleEmail -CustomEmail contoso@microsoft.com
PS C:\> Add-AzureRmLogAlertRule -Name backupFailedAlert -Location "East US" -ResourceGroup RecoveryServices-DP2RCXUGWS3MLJF4LKPI3A3OMJ2DI4SRJK6HIJH22HFIHZVVELRQ-East-US -OperationName Microsoft.RecoveryServices/recoveryServicesVault/Backup -Status Failed -TargetResourceId /subscriptions/86eeac34-eth9a-4de3-84db-7a27d121967e/resourceGroups/RecoveryServices-DP2RCXUGWS3MLJF4LKPI3A3OMJ2DI4SRJK6HIJH22HFIHZVVELRQ-East-US/providers/Microsoft.RecoveryServices/vaults/trinadhVault -Actions $actionEmail
```

**ResourceId**. Значение этого параметра можно получить в журналах аудита. Это URL-адрес, указанный в столбце "Ресурс" в журналах аудита.

**OperationName**. Этот параметр указывается в формате Microsoft.RecoveryServices/recoveryServicesVault/*EventName*, где *EventName* могут быть присвоены следующие значения.<br/>

* Зарегистрировать <br/>
* Unregister;  <br/>
* ConfigureProtection;  <br/>
* Backup;  <br/>
* восстановление; <br/>
* StopProtection;  <br/>
* DeleteBackupData;  <br/>
* CreateProtectionPolicy;  <br/>
* DeleteProtectionPolicy;  <br/>
* UpdateProtectionPolicy <br/>

**Status**. Поддерживаемые значения: Started, Succeeded или Failed.

**ResourceGroup**. Группа ресурсов, к которой принадлежит ресурс. В созданные журналы можно добавить столбец "Группа ресурсов". Группа ресурсов — это один из доступных типов сведений о событиях.

**Name**. Имя правила оповещения.

**CustomEmail**. Это адрес электронной почты для отправки оповещений.

**SendToServiceOwners**. Этот параметр отправляет оповещения всем администраторам и соадминистраторам подписки. Кроме того, его можно использовать в командлете **New-AzureRmAlertRuleEmail**.

### <a name="limitations-on-alerts"></a>Связанные с оповещениями ограничения
К оповещениям на основе событий применяются следующие ограничения:

1. Оповещения активируются на всех виртуальных машинах в хранилище служб восстановления. Оповещения нельзя настроить для подмножества виртуальных машин в хранилище служб восстановления.
2. Эта функция предоставляется в предварительной версии. [Подробнее](../monitoring-and-diagnostics/insights-powershell-samples.md#create-metric-alerts)
3. Оповещения отправляются с адреса "alerts-noreply@mail.windowsazure.com". В настоящее время невозможно изменить отправителя электронной почты.

## <a name="next-steps"></a>Дальнейшие действия
Журналы событий позволяют проводить эффективный анализ и аудит операций резервного копирования. В журналы записываются следующие операции:

* Register; 
* Unregister; 
* настройка защиты;
* резервное копирование (как запланированное, так и запущенное по запросу);
* Restore; 
* остановка защиты;
* удаление резервных копий;
* добавление политики;
* удаление политики;
* изменение политики;
* отмена задания.

Более подробное описание событий, операций и журналов аудита в службах Azure см. в статье [View events and activity logs](../monitoring-and-diagnostics/insights-debugging-with-events.md) (Просмотр журналов событий и аудита).

Сведения о восстановлении виртуальных машин из точки восстановления см. в статье [Восстановление виртуальных машин в Azure](backup-azure-arm-restore-vms.md). Сведения о защите виртуальных машин см. в статье [Первое знакомство. Защита виртуальных машин Azure в хранилище служб восстановления](backup-azure-vms-first-look-arm.md). Дополнительные сведения о задачах управления для резервных копий виртуальных машин см. в статье [Управление резервными копиями виртуальных машин Azure и их мониторинг](backup-azure-manage-vms.md).

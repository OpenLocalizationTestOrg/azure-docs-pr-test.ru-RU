---
title: "Устранение ошибок при архивации виртуальных машин Azure | Документация Майкрософт"
description: "Устранение неполадок при резервном копировании и восстановлении виртуальных машин Azure"
services: backup
documentationcenter: 
author: trinadhk
manager: shreeshd
editor: 
ms.assetid: 73214212-57a4-4b57-a2e2-eaf9d7fde67f
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/17/2017
ms.author: trinadhk;markgal;jpallavi;
ms.openlocfilehash: dbd70bdbb17d99c5025018e76ea756b1b1528a3e
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="troubleshoot-azure-virtual-machine-backup"></a>Устранение неполадок при архивации виртуальных машин Azure
> [!div class="op_single_selector"]
> * [Хранилище служб восстановления](backup-azure-vms-troubleshoot.md)
> * [Хранилище службы архивации](backup-azure-vms-troubleshoot-classic.md)
>
>

Для устранения ошибок, обнаруженных в ходе применения службы архивации Azure, можно использовать информацию из следующей таблицы.

## <a name="backup"></a>Резервное копирование
| Сведения об ошибке | Возможное решение |
| --- | --- |
| Не удалось выполнить операцию, так как виртуальная машина больше не существует. Отключите защиту виртуальной машины, не удаляя данные архивации. Дополнительные сведения см. по адресу http://go.microsoft.com/fwlink/?LinkId=808124. |Это происходит, когда основная виртуальная машина удалена, но политика резервного копирования продолжает ее поиск, чтобы выполнить резервное копирование. Чтобы исправить эту проблему, сделайте следующее: <ol><li> Повторно создайте виртуальную машину с тем же именем и тем же именем группы ресурсов [имя облачной службы].<br>(ИЛИ)</li><li> Отключите защиту виртуальной машины, удаляя или не удаляя данные архивации. [Дополнительные сведения](http://go.microsoft.com/fwlink/?LinkId=808124)</li></ol> |
| Сбой операции моментального снимка, отсутствует сетевое подключение у виртуальной машины. Убедитесь, что у виртуальной машины есть доступ к сети. Чтобы сделать моментальный снимок, добавьте диапазоны IP-адресов центра данных Azure в список разрешений или настройте прокси-сервер для доступа к сети. Дополнительные сведения: http://go.microsoft.com/fwlink/?LinkId=800034. Если вы уже используете прокси-сервер, убедитесь, что указаны правильные параметры. | Эта ошибка возникает, когда на виртуальной машине запрещается исходящее подключение к Интернету. Подключение к Интернету требуется для расширения моментальных снимков виртуальной машины, чтобы создать моментальный снимок базовых дисков виртуальной машины. Ознакомьтесь с [дополнительными сведениями](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#snapshot-operation-failed-due-to-no-network-connectivity-on-the-virtual-machine) об устранении неполадок при создании моментальных снимков из-за блокировки доступа к сети. |
| Агенту виртуальной машины не удается установить связь со службой Azure Backup. Убедитесь, что виртуальная машина подключена к сети, а также запущен агент виртуальной машины последней версии. Дополнительные сведения: http://go.microsoft.com/fwlink/?LinkId=800034. |Данная ошибка возникает, если существует проблема с агентом виртуальной машины, или каким-то образом заблокирован сетевой доступ к инфраструктуре Azure. [Узнайте больше](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#vm-agent-unable-to-communicate-with-azure-backup) об отладке проблем с моментальными снимками виртуальной машины.<br> Если агент виртуальной машины не вызывает проблем, перезапустите виртуальную машину. Иногда проблемы возникают из-за неправильного состояния виртуальной машины. Его можно сбросить, перезапустив виртуальную машину. |
| Виртуальная машина находится в состоянии "Сбой подготовки". Перезапустите виртуальную машину и убедитесь, что она находится в запущенном или остановленном состоянии для резервного копирования. | Это происходит, когда неполадка расширения приводит к тому, что виртуальная машина переходит в состояние "Сбой подготовки". Перейдите к списку расширений и проверьте, нет ли сбоев в работе расширений. Удалите соответствующее расширение и попробуйте перезапустить виртуальную машину. Если все расширения находятся в рабочем состоянии, проверьте, запущена ли служба агента виртуальной машины. Если нет, то перезапустите службу агента виртуальной машины. | 
| Произошел сбой операции расширения VMSnapshot для управляемых дисков. Повторите резервное копирование. Если проблема будет повторяться, следуйте инструкциям по ссылке http://go.microsoft.com/fwlink/?LinkId=800034. Если проблему не удастся устранить, обратитесь в службу поддержки Майкрософт. | Эта ошибка возникает, когда службе Azure Backup не удается активировать моментальный снимок. [Узнайте больше](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#vmsnapshot-extension-operation-failed) об отладке проблем с моментальными снимками виртуальной машины. |
| Не удалось скопировать снимок виртуальной машины, не хватает свободного места в учетной записи хранения. Убедитесь, что в учетной записи хранения хватает места для данных на дисках хранилища "Премиум", подключенных к виртуальной машине. | В случае виртуальных машин ценовой категории "Премиум" мы копируем моментальный снимок в учетную запись хранения. Это необходимо, чтобы трафик управления резервным копированием, который возникает при работе с моментальным снимком, не ограничивал число операций ввода-вывода, доступных для приложения, использующего диски уровня "Премиум". Корпорация Майкрософт рекомендует выделять только 50 % от общего объема хранилища учетной записи хранения, чтобы служба Azure Backup могла скопировать моментальный снимок в учетную запись хранения и перенести данные из этого скопированного расположения в учетной записи хранения в хранилище. | 
| Не удалось выполнить операцию, так как агент виртуальной машины не отвечает. |Данная ошибка возникает, если существует проблема с агентом виртуальной машины, или каким-то образом заблокирован сетевой доступ к инфраструктуре Azure. На виртуальных машинах Windows проверьте состояние агента виртуальной машины в службах и укажите, отображается ли агент в программах на панели управления. Попробуйте удалить программу с панели управления и установить агент еще раз, как это описано [ниже](#vm-agent). После повторной установки агента активируйте нерегламентированное резервное копирование для проверки. |
| Не удалось выполнить операцию с расширением служб восстановления. Убедитесь, что на виртуальной машине установлена последняя версия агента виртуальной машины и что служба агента запущена. Повторите операцию резервного копирования. В случае сбоя обратитесь в службу поддержки Майкрософт. |Эта ошибка возникает, если версия агента виртуальной машины устаревшая. См. раздел "Обновление агента виртуальной машины" ниже. |
| Виртуальная машина не существует. Убедитесь, что виртуальная машина существует, или выберите другую виртуальную машину. |Это происходит, когда основная виртуальная машина удаляется, но политика резервного копирования продолжает поиск виртуальной машины, чтобы выполнить резервное копирование. Чтобы исправить эту проблему, сделайте следующее: <ol><li> Повторно создайте виртуальную машину с тем же именем и тем же именем группы ресурсов [имя облачной службы].<br>(ИЛИ)<br></li><li>Отключите защиту виртуальной машины, не удаляя данные архивации. [Дополнительные сведения](http://go.microsoft.com/fwlink/?LinkId=808124)</li></ol> |
| Не удалось выполнить команду. С этим элементом выполняется другая операция. Дождитесь завершения предыдущей операции и повторите попытку. |Выполняется текущее задание архивации виртуальной машины. В это время запуск нового задания невозможен. |
| Время ожидания копирования виртуальных жестких дисков из архивного хранилища истекло. Повторите операцию через несколько минут. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт. | Это происходит, если на стороне хранилища произошла временная ошибка или учетная запись хранения, в которой размещена виртуальная машина, предоставляет службе архивации недостаточно операций ввода-вывода в секунду для передачи данных в хранилище в течение времени ожидания. Убедитесь, что вы выполнили [рекомендации](backup-azure-vms-introduction.md#best-practices) при настройке архивации. Попробуйте переместить виртуальную машину в другу учетную запись хранения, которая не так нагружена, и повторите попытку архивации.|
| Произошла внутренняя ошибка архивации. Повторите операцию через несколько минут. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт |Эта ошибка может возникнуть по двум причинам: <ol><li> При доступе к хранилищу виртуальной машины возникает временная проблема. Проверьте [состояние Azure](https://azure.microsoft.com/en-us/status/), чтобы определить, имеются ли в настоящее время проблемы, связанные с вычислительными, сетевыми ресурсами или ресурсами хранилища в регионе. После устранения неполадки повторите задание архивации. <li>Исходная виртуальная машина удалена, поэтому точка восстановления не может быть создана. Чтобы сохранить данные архивации удаленной виртуальной машины и прекратить появление ошибок при архивации, снимите защиту с виртуальной машины и выберите вариант, при котором данные сохраняются. После этого запланированное задание архивации перестанет выполняться, а повторяющиеся сообщения об ошибках не будут появляться. |
| Не удалось установить расширение служб восстановления Azure для выбранного элемента. Необходимым условием для расширения служб восстановления Azure является наличие агента виртуальной машины. Установите агент виртуальной машины Azure и перезапустите операцию регистрации. |<ol> <li>Убедитесь, что агент виртуальной машины установлен правильно. <li>Убедитесь, что для флажка в конфигурации виртуальной машины установлено правильное значение.</ol> [Дополнительные сведения](#validating-vm-agent-installation) об установке агента виртуальной машины и проверке правильности ее выполнения. |
| Во время установки расширения произошла ошибка «Отсутствует связь COM+ с координатором распределенных транзакций». |Обычно это означает, что служба COM+ не запущена. Чтобы устранить эту проблему, обратитесь в службу поддержки Майкрософт. |
| Во время операции создания снимка возникла ошибка операции VSS «Этот диск заблокирован программой шифрования диска BitLocker. Вернитесь к панели управления, чтобы разблокировать диск. |Отключите BitLocker для всех дисков на виртуальной машине и проверьте, устранена ли проблема с VSS. |
| Виртуальная машина не находится в состоянии, которое позволяет выполнить ее архивацию. |<ul><li>Проверьте, не находится ли виртуальная машина в состоянии перехода из рабочего состояния в состояние завершения работы. Если это так, дождитесь, пока состояние виртуальной машины не установится, и еще раз активируйте архивацию. <li> Если это виртуальная машина Linux, которая использует модуль ядра [Security Enhanced Linux], то необходимо исключить путь агента Linux (_/var/lib/waagent_) из политики безопасности, чтобы обеспечить установку расширения архивации.  |
| Виртуальная машина Azure не найдена. |Это происходит, когда основная виртуальная машина удалена, но политика архивации продолжает ее поиск, чтобы выполнить архивацию. Чтобы исправить эту проблему, сделайте следующее: <ol><li>Повторно создайте виртуальную машину с тем же именем и тем же именем группы ресурсов [имя облачной службы]. <br>(ИЛИ) <li> Отключите защиту этой виртуальной машины, чтобы задания резервного копирования не создавались. </ol> |
| На виртуальной машине отсутствует агент виртуальной машины. Установите необходимые компоненты, агент виртуальной машины и перезапустите операцию. |[Дополнительные сведения](#vm-agent) об установке агента виртуальной машины и проверке установки агента виртуальной машины. |
| Во время операции создания возникла ошибка из-за неисправного состояния модулей записи VSS |Перезапустите модули записи VSS (служба теневого копирования томов), которые находятся в неисправном состоянии. Для этого из командной строки с повышенными привилегиями выполните команду _vssadmin list writers_. В выходных данных содержатся все модули записи VSS и их состояние. Перезапустите каждый модуль записи VSS, состояние которого отличается от "[1] Стабильный", выполнив следующие команды из командной строки с повышенными привилегиями:<br> _net stop serviceName_ <br> _net start serviceName_|
| Во время операции создания моментального снимка возникла ошибка из-за сбоя анализа конфигурации |Это происходит из-за изменения разрешений в каталоге MachineKeys: _%systemdrive%\programdata\microsoft\crypto\rsa\machinekeys_. <br>Выполните следующую команду и убедитесь, что для каталога MachineKeys назначены разрешения по умолчанию:<br>_icacls %systemdrive%\programdata\microsoft\crypto\rsa\machinekeys_ <br><br> Разрешения по умолчанию:<br>Everyone:(R,W); <br>BUILTIN\Administrators:(F).<br><br>Если для каталога MachineKeys назначены другие разрешения, выполните следующие действия, чтобы изменить разрешения, удалить сертификат и активировать архивацию.<ol><li>Исправьте разрешения для каталога MachineKeys.<br>С помощью свойств безопасности обозревателя и дополнительных параметров безопасности в каталоге сбросьте разрешения к значениям по умолчанию, удалите дополнительные пользовательские объекты (отличные от объектов по умолчанию) из каталога и убедитесь, что разрешения Everyone имеют доступ к таким операциям:<br>— вывод списка папок, чтение данных; <br>— чтение атрибутов; <br>— чтение дополнительных атрибутов; <br>— создание файлов, запись данных; <br>— создание папок, добавление данных;<br>— запись атрибутов;<br>— запись дополнительных атрибутов;<br>— чтение разрешений.<br><br><li>Удалите все сертификаты с полем "Получатель сертификата", имеющим значение "Windows Azure Service Management for Extensions" или "Windows Azure CRP Certificate Generator".<ul><li>[Откройте консоль "Сертификаты (локальный компьютер)"](https://msdn.microsoft.com/library/ms788967(v=vs.110).aspx).<li>Удалите все сертификаты ("Личные" > "Сертификаты") с полем "Получатель сертификата", имеющим значение "Windows Azure Service Management for Extensions" или "Windows Azure CRP Certificate Generator".</ul><li>Активируйте архивацию виртуальной машины. </ol>|
| Проверка не пройдена, так как виртуальная машина зашифрована только с помощью BEK. Резервное копирование поддерживается только для виртуальных машин, зашифрованных с использованием BEK и KEK. |При этом виртуальная машина должна быть зашифрована с помощью как ключа шифрования BitLocker, так и ключа шифрования ключей. После этого резервное копирование должно выполняться. |
| У службы архивации Azure недостаточно прав для Key Vault, чтобы архивировать зашифрованные виртуальные машины. |Для выполнения действий из раздела о **включении архивации** в [документации по PowerShell](backup-azure-vms-automation.md) нужно предоставить службе архивации подобные разрешения в PowerShell. |
|Во время установки расширения моментальных снимков произошла ошибка: компоненту COM+ не удалось связаться с координатором распределенных транзакций (Майкрософт). | Попробуйте запустить службу Windows "Системное приложение COM+" (в командной строке с повышенными привилегиями выполните команду _net start COMSysApp_). <br>Если при ее запуске произойдет сбой, сделайте следующее.<ol><li> Убедитесь, что учетной записью входа службы "Координатор распределенных транзакций" является "Сетевая служба". Если это не так, измените ее на "Сетевая служба", перезапустите эту службу и попытайтесь запустить службу "Системное приложение COM+".<li>Если она по-прежнему не запускается, удалите, а затем установите службу "Координатор распределенных транзакций", выполнив следующее.<br> Остановите службу MSDTC.<br> Откройте окно командной строки (cmd). <br> Выполните команду msdtc -uninstall. <br> Выполните команду msdtc -install. <br> Запустите службу MSDTC.<li>Запустите службу Windows "Системное приложение COM+". После ее запуска активируйте архивацию на портале.</ol> |
|  Сбой операции создания моментального снимка из-за ошибки COM+ | Рекомендуется перезапустить службу "Системное приложение COM+" (в командной строке с повышенными привилегиями выполните команду _net start COMSysApp_). Если проблема повторится, перезапустите виртуальную машину. Если перезапуск виртуальной машины не помог, то попробуйте [удалить расширение VMSnapshot](https://docs.microsoft.com/en-us/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#cause-3-the-backup-extension-fails-to-update-or-load) и активировать резервное копирование вручную. |
| Не удалось закрепить одну или несколько точек подключения виртуальной машины для создания моментального снимка, согласованного с файловой системой. | Выполните следующие действия. <ol><li>Проверьте состояние файловой системы на всех подключенных устройствах с помощью команды _tune2fs_.<br> Пример: tune2fs -l /dev/sdb1 \| grep "Filesystem state" <li>Отключите устройства с некорректным состоянием файловой системы с помощью команды _umount_. <li> Проверьте целостность файловой системы на этих устройствах с помощью команды _fsck_. <li> Повторно подключите эти устройства и повторите попытку архивации.</ol> |
| Сбой при создании моментального снимка из-за ошибки при создании защищенного канала связи. | <ol><Li> Откройте редактор реестра, запустив файл regedit.exe в режиме с повышенными правами. <li> Определите все версии платформы .NET Framework, установленные в системе. Они находятся в иерархии раздела реестра HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft. <li> Для каждой платформы .NET Framework в этом разделе реестра добавьте следующий раздел: <br> "SchUseStrongCrypto"=dword:00000001 </ol>|
| Сбой при создании моментального снимка из-за ошибки при установке распространяемого пакета Visual C++ для Visual Studio 2012. | Перейдите в папку C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot\agentVersion и установите компонент vcredist2012_x64. Убедитесь, что задано правильное значение раздела реестра, разрешающее установку этой службы, т. е. раздел реестра _HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Msiserver_ должен иметь значение 3, а не 4. Если проблемы с установкой не исчезли, перезапустите службу установки, последовательно выполнив команды _MSIEXEC/UNREGISTER_ и _MSIEXEC /REGISTER_ в командной строке с повышенными привилегиями.  |


## <a name="jobs"></a>Задания
| Сведения об ошибке | Возможное решение |
| --- | --- |
| Для этого типа задания отмена не поддерживается. Дождитесь завершения задания. |Нет |
| Состояние задания не позволяет его отменить. Дождитесь завершения задания. <br>ИЛИ<br> Состояние выбранного задания не позволяет его отменить. Дождитесь завершения задания. |Скорее всего, задание почти завершено. Дождитесь завершения задания.|
| Нельзя отменить задание, так как оно не выполняется. Задания можно отменять только в процессе выполнения. Попытайтесь отменить выполняющееся задание. |Это происходит из-за переходного состояния. Подождите минуту и повторите отмену. |
| Не удалось отменить задание. Дождитесь завершения задания. |None |

## <a name="restore"></a>Восстановление
| Сведения об ошибке | Возможное решение |
| --- | --- |
| Сбой восстановления из-за внутренней ошибки облака |<ol><li>В облачной службе, в которую вы пытаетесь выполнить восстановление, настроены параметры DNS. Проверьте параметр <br>$deployment = Get-AzureDeployment -ServiceName "ServiceName" -Slot "Production"     Get-AzureDns -DnsSettings $deployment.DnsSettings.<br>Если настроен адрес, это означает, что настроены параметры DNS.<br> <li>В облачной службе, в которую вы пытаетесь выполнить восстановление, настроен параметр ReservedIP, а существующие в ней виртуальные машины находятся в остановленном состоянии.<br>Проверьте, есть ли в облачной службе зарезервированный IP-адрес, используя следующие командлеты PowerShell:<br>$deployment = Get-AzureDeployment -ServiceName "servicename" -Slot "Production" $dep.ReservedIPName. <br><li>Вы пытаетесь восстановить виртуальную машину со следующими специальными конфигурациями сети в ту же облачную службу. <br>— Виртуальные машины в конфигурации подсистемы балансировки нагрузки (внутренняя и внешняя).<br>— Виртуальные машины с несколькими зарезервированными IP-адресами.<br>— Виртуальные машины с несколькими сетевыми адаптерами.<br>Выберите новую облачную службу в пользовательском интерфейсе или просмотрите [рекомендации по восстановлению](backup-azure-arm-restore-vms.md#restoring-vms-with-special-network-configurations) для виртуальных машин со специальными конфигурациями сети.</ol> |
| Выбранное DNS-имя уже занято. Укажите другое DNS-имя и повторите попытку. |Указанное здесь DNS-имя ссылается на имя облачной службы (обычно с расширением CLOUDAPP.NET). Это имя должно быть уникальным. Если возникает эта ошибка, во время восстановления необходимо выбрать другое имя виртуальной машины. <br><br> Эта ошибка отображается только для пользователей портала Azure. Восстановление с помощью PowerShell будет выполнено успешно, так как восстанавливаются только диски, а виртуальная машина не создается. Ошибка возникнет, если вы явно создадите виртуальную машину после восстановления дисков. |
| Указана неправильная конфигурация виртуальной сети. Укажите другую конфигурацию виртуальной сети и повторите попытку. |Нет |
| Указанная облачная служба использует зарезервированный IP-адрес, который не совпадает с конфигурацией восстанавливаемой виртуальной машины. Укажите другую облачную службу, которая не использует зарезервированный IP-адрес, или выберите другую точку восстановления. |Нет |
| Облачная служба достигла ограничения на количество входных конечных точек. Повторите операцию, указав другую облачную службу или используя существующую конечную точку. |Нет |
| Хранилище службы архивации и целевая учетная запись хранения находятся в двух разных регионах. Убедитесь, что учетная запись хранения, указанная в операции восстановления, находится в том же регионе Azure, что и хранилище службы архивации. |Нет |
| Учетная запись хранения, указанная для операции восстановления, не поддерживается. Поддерживаются только базовые или стандартные учетные записи хранения с локально избыточными или геоизбыточными параметрами репликации. Выберите поддерживаемую учетную запись хранения. |Нет |
| Тип учетной записи хранения, указанной для операции восстановления, не подключен к сети. Убедитесь, что учетная запись хранения, указанная в операции восстановления, подключена к сети. |Это может произойти из-за временных ошибок в службе хранилища Azure или из-за сбоя. Выберите другую учетную запись хранения. |
| Достигнута квота группы ресурсов. Удалите некоторые группы ресурсов с портала Azure или обратитесь в службу поддержки Azure, чтобы увеличить пределы. |Нет |
| Выбранная подсеть не существует. Выберите существующую подсеть. |None |
| У службы архивации нет разрешения на доступ к ресурсам в вашей подписке. |Чтобы исправить это, сначала восстановите диски, выполнив инструкции по **восстановлению заархивированных дисков** в разделе [Выбор конфигурации восстановления для виртуальной машины](backup-azure-arm-restore-vms.md#choosing-a-vm-restore-configuration). После этого выполните команды PowerShell, описанные в разделе [Создание виртуальной машины с восстановленного диска](backup-azure-vms-automation.md#create-a-vm-from-restored-disks), чтобы создать полную виртуальную машину из восстановленной дисков. |

## <a name="backup-or-restore-taking-time"></a>Архивация или восстановление занимает много времени
Если продолжительность резервного копирования или восстановления (больше 12 и 6 часов соответственно) слишком велика:
* Изучите [факторы, влияющие на продолжительность резервного копирования](backup-azure-vms-introduction.md#total-vm-backup-time), и [факторы, увеличивающие время восстановления](backup-azure-vms-introduction.md#total-restore-time).
* Убедитесь в том, что вы придерживаетесь [рекомендаций по резервному копированию](backup-azure-vms-introduction.md#best-practices). 

## <a name="vm-agent"></a>Агент виртуальной машины
### <a name="setting-up-the-vm-agent"></a>Настройка агента виртуальной машины
Как правило, агент виртуальной машины уже имеется на виртуальных машинах, которые созданы с помощью коллекции Azure. Однако на виртуальных машинах, которые переносятся из локальных центров обработки данных, агента виртуальной машины не будет. Для таких виртуальных машин агент ВМ необходимо установить явным образом.

Для виртуальных машин Windows:

* Скачайте и установите [MSI-файл агента](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора.
* [Обновите свойство классических виртуальных машин](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен. Этот шаг не является обязательным для виртуальных машин Resource Manager.

Для виртуальных машин Linux:

* Установите последнюю из репозитория дистрибутива. Мы **настоятельно рекомендуем** устанавливать агент только через репозиторий дистрибутива. Сведения об имени пакета см. в [репозитории агента Linux](https://github.com/Azure/WALinuxAgent). 
* [Обновите свойство классических виртуальных машин](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен. Этот шаг не является обязательным для виртуальных машин Resource Manager.

### <a name="updating-the-vm-agent"></a>Обновление агента виртуальной машины
Для виртуальных машин Windows:

* Обновление агента виртуальной машины — это простая процедура, схожая с переустановкой [двоичных файлов агента виртуальной машины](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Тем не менее, необходимо убедиться, что во время обновления агента виртуальной машины никакие операции резервного копирования не выполняются.

Для виртуальных машин Linux:

* Следуйте инструкциям по [обновлению агента виртуальной машины Linux](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).
Мы **настоятельно рекомендуем** обновлять агент только через репозиторий дистрибутива. Мы не рекомендуем скачивать код агента непосредственно с портала GitHub и обновлять его. Если последняя версия агента не доступна для дистрибутива, обратитесь в службу поддержки дистрибутива, чтобы получить инструкции по установке последней версии агента. Последние сведения об [агенте Windows Azure Linux](https://github.com/Azure/WALinuxAgent/releases) см. в репозитории GitHub.

### <a name="validating-vm-agent-installation"></a>Проверка установки агента виртуальной машины
Для проверки версии агента ВМ на виртуальных машинах Windows выполните следующие действия:

1. Войдите в систему виртуальной машины Azure и перейдите в папку *C:\WindowsAzure\Packages*. В ней должен находиться файл WaAppAgent.exe.
2. Щелкните правой кнопкой мыши этот файл, выберите пункт **Свойства** и перейдите на вкладку **Подробно**. В поле "Версия продукта" должно отображаться значение 2.6.1198.718 или выше.

## <a name="troubleshoot-vm-snapshot-issues"></a>Решение проблем со снимками виртуальных машин
Архивация виртуальных машин зависит от команды моментального снимка в базовом хранилище. Отсутствие доступа к хранилищу или задержка в выполнении задачи создания моментального снимка может привести к неудачному завершению задания архивации. Неудачное завершение задачи создания снимка может быть вызвано следующими факторами.

1. Сетевой доступ к хранилищу блокируется при помощи групп NSG.<br>
    Узнайте о том, как [включить сетевой доступ](backup-azure-vms-prepare.md#network-connectivity) к хранилищу с помощью списка разрешенных IP-адресов или прокси-сервера.
2. Виртуальные машины с настроенной архивацией SQL Server могут вызвать задержку задачи создания моментальных снимков. <br>
   По умолчанию при архивации виртуальной машины выполняется полная архивация VSS на виртуальных машинах Windows. На виртуальных машинах, на которых запускается SQL Server и настроена архивация SQL Server, это может привести к задержке в выполнении моментального снимка. При возникновении ошибок резервного копирования из-за проблем моментальных снимков, пожалуйста, установите следующий ключ реестра.

   ```
   [HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
   "USEVSSCOPYBACKUP"="TRUE"
   ```
3. Состояние виртуальной машины отображается неправильно из-за того, что ее работа была завершена в сеансе удаленного рабочего стола.  <br>
   При завершении работы виртуальной машины в сеансе RDP проверьте, правильно ли отображается на портале состояние виртуальной машины. Если это не так, завершите работу виртуальной машины на портале с помощью команды "Завершение работы" на панели мониторинга виртуальной машины.
4. Если больше четырех виртуальных машин используют одну облачную службу, настройте несколько политик архивации, задав время архивации таким образом, чтобы выполнялась архивация не более четырех виртуальных машин одновременно. Задайте время начала архивации в разных политиках так, чтобы между ними был один час разницы.
5. Виртуальная машина использует много ресурсов ЦП или памяти.<br>
   Если виртуальная машина работает при большой загрузке процессора (более 90 %) или памяти, задача создания моментального снимка помещается в очередь, задерживается, и в конце концов время ожидания истекает. В таких ситуациях попробуйте резервное копирование по требованию.

<br>

## <a name="networking"></a>Сеть
Как и в случае со всеми другими расширениями, для нормальной работы расширению резервного копирования требуется доступ к общедоступному Интернету. Отсутствие доступа к общедоступному Интернету может приводить к различным проблемам:

* Операция установки расширения может завершаться с ошибкой.
* Операции резервного копирования (например, создание моментального снимка диска) могут завершаться с ошибкой.
* Операция отображения состояния процесса резервного копирования может завершаться с ошибкой.

Потребность в разрешении общедоступных IP-адресов более подробно разъяснена [здесь](http://blogs.msdn.com/b/mast/archive/2014/06/18/azure-vm-provisioning-stuck-on-quot-installing-extensions-on-virtual-machine-quot.aspx). Вам нужно проверить конфигурации DNS для виртуальной сети и убедиться, что URI Azure можно разрешить.

После правильного разрешения имен также требуется предоставить доступ к IP-адресам Azure. Чтобы разблокировать доступ к инфраструктуре Azure, выполните одно из следующих действий.

1. Добавьте в список разрешений диапазоны IP-адресов центра обработки данных Azure.
   * Получите список [IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653) для добавления в разрешенный список.
   * Разблокируйте IP-адреса с помощью командлета [New-NetRoute](https://technet.microsoft.com/library/hh826148.aspx) . Запустите этот командлет на виртуальной машине Azure в окне PowerShell с повышенными привилегиями (запустите от имени администратора).
   * Добавьте правила в группу безопасности сети (если она настроена) для доступа к IP-адресам.
2. Создание пути для прохождения трафика HTTP
   * При наличии каких-либо ограничений сети (например, группы безопасности сети) разверните прокси-сервер HTTP для перенаправления трафика. Описание развертывания прокси-сервера HTTP можно найти [здесь](backup-azure-vms-prepare.md#network-connectivity).
   * Добавьте правила в группу безопасности сети (если она настроена), чтобы разрешить доступ к Интернету из прокси-сервера HTTP.

> [!NOTE]
> Для работы резервного копирования службы архивации на виртуальной машине IaaS DHCP должна быть включена для учетной записи гостя.  Если вам нужен статический частный IP-адрес, следует настроить его через платформу. DHCP для виртуальной машины следует оставить включенным.
> Дополнительные сведения см. в статье [Как задать статический внутренний частный IP-адрес с помощью PowerShell (классическая модель)](../virtual-network/virtual-networks-reserved-private-ip.md).
>
>

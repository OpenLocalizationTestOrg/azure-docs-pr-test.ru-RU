---
title: "Создание настраиваемого образа шаблона для Azure RemoteApp | Документация Майкрософт"
description: "Узнайте о том, как создать настраиваемый образ шаблона для Azure RemoteApp. Этот шаблон можно использовать для гибридной или облачной коллекции."
services: remoteapp
documentationcenter: 
author: msmbaldwin
manager: mbaldwin
editor: 
ms.assetid: b9ec5b51-f7cd-470b-8545-d0fd714c5982
ms.service: remoteapp
ms.workload: compute
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/26/2017
ms.author: mbaldwin
ms.openlocfilehash: f529a5526f266c7dbac3c719b244d05ab7705941
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="how-to-create-a-custom-template-image-for-azure-remoteapp"></a>Создание настраиваемого образа шаблона для Azure RemoteApp
> [!IMPORTANT]
> Мы выводим службу Azure RemoteApp из эксплуатации 31 августа 2017 года. Дополнительные сведения см. в [объявлении](https://go.microsoft.com/fwlink/?linkid=821148).
> 
> 

Azure RemoteApp использует образ шаблона Windows Server 2012 R2 для размещения всех программ, которыми вы планируете делиться с пользователями. Чтобы создать образ шаблона RemoteApp, можно использовать существующий образ или создать новый. 

> [!TIP]
> Вы знаете, что можно создать образ из виртуальной машины Azure? Это факт, и теперь импорт образа занимает меньше времени. Узнайте [здесь](remoteapp-image-on-azurevm.md), как это сделать.
> 
> 

К образу, который может быть передан для использования с Azure RemoteApp, предъявляются следующие требования:

* Размер образа должен быть кратен 1 МБ. В противном случае при попытке отправить образ произойдет сбой.
* Размер образа не должен превышать 127 ГБ.
* Он должен быть помещен в VHD-файл (файлы VHDX [виртуальные жесткие диски Hyper-V] в настоящее время не поддерживаются).
* Виртуальный жесткий диск VHD не должен быть виртуальной машиной 2 поколения.
* виртуальный жесткий диск VHD должен быть либо фиксированного размера, либо иметь возможность динамического расширения. Рекомендуется использовать VHD с динамическим расширением, поскольку на его передачу в Azure уходит меньше времени, чем на передачу VHD-файла с фиксированным размером.
* Диск должен быть инициализирован с использованием стиля разделов основной загрузочной записи (MBR). Стиль разделов (GPT) таблицы разделов GUID не поддерживается.
* VHD должен содержать одну установку Windows Server 2012 R2. Он может содержать несколько томов, но только один из них может содержать установку Windows.
* Должны быть установлены роль узла сеансов удаленных рабочих столов (RDSH) и компонент «Возможности рабочего стола».
* Роль посредника подключений к удаленному рабочему столу *не* должна быть установлена.
* Шифрующая файловая система (EFS) должна быть выключена.
* Образ должен быть обработан командой SYSPREP с использованием параметров **/oobe /generalize /shutdown** (запуск при первом включении компьютера/ обобщить/ выключить). (Не используйте параметр **/mode:vm**.)
* Отправка VHD из цепочки моментальных снимков не поддерживается.

**Перед началом работы**

Перед созданием службы необходимо выполнить следующие действия.

* [Зарегистрироваться](https://azure.microsoft.com/services/remoteapp/) в RemoteApp.
* Создайте учетную запись пользователя в Active Directory для использования в качестве учетной записи службы RemoteApp. Ограничьте разрешения для этой учетной записи, чтобы она могла только присоединять машины к домену. Дополнительные сведения см. в статье [Требования Azure AD + Active Directory для Azure RemoteApp](remoteapp-ad.md).
* Соберите сведения о локальной сети, а именно получить информацию об IP-адресе и VPN-устройстве.
* установить модуль [Azure PowerShell](/powershell/azure/overview) .
* Соберите сведения о пользователях, которым нужно предоставить доступ. Это могут быть либо данные учетной записи Майкрософт, либо данные рабочей учетной записи Active Directory пользователя.

## <a name="create-a-template-image"></a>Создание образа шаблона
Ниже приведены шаги высокого уровня по созданию образа шаблона с самого начала.

1. найти DVD или ISO-образ с Windows Server 2012 R2 Update;
2. создать VHD-файл;
3. установить Windows Server 2012 R2;
4. установить роль узла сеансов удаленных рабочих столов (RDSH) и компонент «Возможности рабочего стола»;
5. установить дополнительные функции, необходимые для приложений;
6. установить и настроить ваши приложения; Чтобы упростить совместное использование приложений, добавьте соответствующие приложения или программы в меню **Пуск** образа, в частности в раздел **%systemdrive%\ProgramData\Microsoft\Windows\Start Menu\Programs.
7. Выполните любые дополнительные настройки Windows, необходимые для приложений.
8. Выключите шифрующую файловую систему (EFS).
9. **ОБЯЗАТЕЛЬНО.** Перейдите в Центр обновления Windows и установите все важные обновления.
10. Обработайте образ командой SYSPREP.

Ниже приводится подробное описание шагов для создания нового образа:

1. найти DVD или ISO-образ с Windows Server 2012 R2 Update;
2. создайте VHD-файл с помощью управления дисками;
   
   1. запустите управление дисками (diskmgmt.msc);
   2. создайте динамически расширяющийся VHD размером 40 ГБ или более; (Оцените объем дискового пространства, необходимый для Windows, ваших приложений и настроек. Установленный Windows Server с ролью RDSH и компонент «Возможности рабочего стола» требуют приблизительно 10 ГБ дискового пространства.)
      
      1. Щелкните **Действие > Создать виртуальный жесткий диск**.
      2. определите местоположение, размер и формат VHD; Выберите **Динамически расширяемый** и щелкните **ОК**.
      
      Процесс создания диска занимает несколько секунд. После окончания создания VHD вы должны увидеть новый диск без буквы диска в состоянии Not initialized (Не инициализирован) на консоли управления дисками.
      
      * Щелкните диск правой кнопкой мыши (а не свободное место) и нажмите **Initialize Disk**(Инициализировать диск). Выберите **MBR** (Основная загрузочная запись) в качестве стиля разделов и щелкните **ОК**.
      * Создайте том. Для этого щелкните правой кнопкой мыши незанятое пространство, а затем выберите **Создать простой том**. В мастере можно принять параметры по умолчанию, однако не забудьте присвоить букву диска, чтобы избежать возможных проблем при передаче образа шаблона.
      * Щелкните диск правой кнопкой мыши, а затем нажмите **Detach VHD**(Отсоединить VHD).
3. Установите Windows Server 2012 R2.
   
   1. Создайте новую виртуальную машину. Используйте Мастер новой виртуальной машины в диспетчере Hyper-V или клиент Hyper-V.
      1. На странице "Укажите поколение" выберите **Поколение 1**.
      2. На странице «Подключить виртуальный жесткий диск» выберите параметр **Use an existing virtual hard disk**(Использовать существующий виртуальный жесткий диск) и перейдите к VHD, который был создан на предыдущем шаге.
      3. На странице "Параметры установки" выберите **Установить операционную систему с загрузочного CD или DVD-диска**, а затем выберите расположение установочного носителя Windows Server 2012 R2.
      4. Выберите другие параметры в мастере, которые необходимы для установки Windows и ваших приложений. Завершите работу мастера.
   2. После завершения работы мастера измените параметры виртуальной машины и внесите другие необходимые изменения для установки Windows и ваших программ (например, количество виртуальных машин), а затем нажмите **OK**.
   3. Подключитесь к виртуальной машине и установите Windows Server 2012 R2.
4. Установите роль узла сеансов удаленных рабочих столов (RDSH) и компонент «Возможности рабочего стола»:
   1. Запустите диспетчер сервера.
   2. Щелкните **Добавить роли и компоненты** на экране приветствия или в меню **Управление**.
   3. Нажмите **Next** (Далее) на странице «Перед началом работы».
   4. Выберите **Установка ролей или компонентов**, а затем нажмите кнопку **Далее**.
   5. Выберите локальный компьютер из списка и нажмите **Next**.
   6. Выберите **Службы удаленных рабочих столов**, а затем щелкните **Далее**.
   7. Разверните список **Пользовательские интерфейсы и инфраструктура** и выберите **Возможности рабочего стола**.
   8. Щелкните **Добавить компоненты**, а затем — **Далее**.
   9. На странице служб удаленных рабочих столов нажмите **Next**.
   10. Нажмите **Remote Desktop Session Host**(Узел сеансов удаленных рабочих столов).
   11. Щелкните **Добавить компоненты**, а затем — **Далее**.
   12. На странице "Подтверждение установки компонентов" выберите **Автоматический перезапуск конечного сервера, если требуется**, а затем щелкните **Да** в предупреждении о перезапуске.
   13. Щелкните **Install**(Установить). Компьютер перезапустится.
5. Установите такие необходимые для приложений дополнительные компоненты, как .NET Framework 3.5. Чтобы установить компоненты, запустите мастер добавления ролей и компонентов.
6. Установите и настройте программы и приложения, которые будут публиковаться через RemoteApp.

> [!IMPORTANT]
> Установите роль RDSH перед началом установки приложений, чтобы обнаружить все проблемы с совместимостью приложений до передачи образа в RemoteApp.
> 
> Убедитесь, что ярлык приложения (файл **LNK**) отображается в меню **Пуск** для всех пользователей (%systemdrive%\ProgramData\Microsoft\Windows\Start Menu\Programs). Кроме того, убедитесь, что в меню **Пуск** отображается тот значок, который должны видеть пользователи. Если это не так, измените значок. (Добавлять приложения в меню "Пуск" *необязательно* , но это упростит публикацию приложения в RemoteApp. В противном случае при публикации приложения потребуется указать путь установки.)
> 
> 

1. Выполните любые дополнительные настройки Windows, необходимые для приложений.
2. Выключите шифрующую файловую систему (EFS). Выполните следующую команду в окне команд с повышенными привилегиями:
   
     Fsutil behavior set disableencryption 1
   
   Вместо этого можно задать или добавить следующее значение DWORD в реестре:
   
     HKLM\System\CurrentControlSet\Control\FileSystem\NtfsDisableEncryption = 1
3. Если сборка образа выполняется внутри виртуальной машины Azure, переименуйте файл **\%windir%\Panther\Unattend.xml**, так как он будет блокировать скрипт отправки, который используется позже во время работы. Измените имя этого файла на Unattend.old, чтобы его можно было найти в случае, если потребуется вернуться к предыдущему развертыванию.
4. Перейдите в Центр обновления Windows и установите все важные обновления. Центр обновления Windows может потребоваться запустить несколько раз, чтобы скачать все обновления. (Иногда после установки само обновление необходимо обновить.)
5. Обработайте образ командой SYSPREP. В командной строке с повышенными привилегиями выполните следующую команду:
   
   **C:\Windows\System32\sysprep\sysprep.exe /generalize /oobe /shutdown**.
   
   **Примечание.** Не используйте параметр команды SYSPREP **/mode:vm**, несмотря на то что это виртуальная машина.

## <a name="next-steps"></a>Дальнейшие действия
Созданный настраиваемый образ шаблона необходимо добавить в коллекцию RemoteApp. Чтобы создать коллекцию, воспользуйтесь информацией в следующих статьях:

* [Создание гибридной коллекции RemoteApp](remoteapp-create-hybrid-deployment.md)
* [Создание облачной коллекции RemoteApp](remoteapp-create-cloud-deployment.md)


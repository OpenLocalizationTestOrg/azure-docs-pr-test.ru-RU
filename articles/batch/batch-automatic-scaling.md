---
title: "Автомасштабирование вычислительных узлов в пуле пакетной службы Azure | Документация Майкрософт"
description: "Включение автоматического масштабирования в облачном пуле для динамического изменения количества вычислительных узлов в пуле."
services: batch
documentationcenter: 
author: tamram
manager: timlt
editor: tysonn
ms.assetid: c624cdfc-c5f2-4d13-a7d7-ae080833b779
ms.service: batch
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: multiple
ms.date: 06/20/2017
ms.author: tamram
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: f0e49cd8a64a48c53f5b6104703164a597c797f0
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="create-an-automatic-scaling-formula-for-scaling-compute-nodes-in-a-batch-pool"></a><span data-ttu-id="9573c-103">Создание формулы автоматического масштабирования для масштабирования вычислительных узлов в пуле пакетной службы</span><span class="sxs-lookup"><span data-stu-id="9573c-103">Create an automatic scaling formula for scaling compute nodes in a Batch pool</span></span>

<span data-ttu-id="9573c-104">Пакетная служба Azure может автоматически масштабировать пулы в зависимости от определенных вами параметров.</span><span class="sxs-lookup"><span data-stu-id="9573c-104">Azure Batch can automatically scale pools based on parameters that you define.</span></span> <span data-ttu-id="9573c-105">Автоматическое масштабирование позволяет пакетной службе динамически добавлять узлы в пул при росте потребностей задачи, а также удалять вычислительные узлы при снижении нагрузки.</span><span class="sxs-lookup"><span data-stu-id="9573c-105">With automatic scaling, Batch dynamically adds nodes to a pool as task demands increase, and removes compute nodes as they decrease.</span></span> <span data-ttu-id="9573c-106">Вы можете сэкономить время и деньги, используя автоматическую корректировку количества вычислительных узлов, используемых приложением пакетной службы.</span><span class="sxs-lookup"><span data-stu-id="9573c-106">You can save both time and money by automatically adjusting the number of compute nodes used by your Batch application.</span></span> 

<span data-ttu-id="9573c-107">Чтобы включить автоматическое масштабирование для пула вычислительных узлов, определите и установите для него *формулу автомасштабирования*.</span><span class="sxs-lookup"><span data-stu-id="9573c-107">You enable automatic scaling on a pool of compute nodes by associating with it an *autoscale formula* that you define.</span></span> <span data-ttu-id="9573c-108">Пакетная служба использует эту формулу автомасштабирования, чтобы определить количество вычислительных узлов, необходимых для выполнения рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="9573c-108">The Batch service uses the autoscale formula to determine the number of compute nodes that are needed to execute your workload.</span></span> <span data-ttu-id="9573c-109">Вычислительные узлы могут быть выделенными узлами или [узлами с низким приоритетом](batch-low-pri-vms.md).</span><span class="sxs-lookup"><span data-stu-id="9573c-109">Compute nodes may be dedicated nodes or [low-priority nodes](batch-low-pri-vms.md).</span></span> <span data-ttu-id="9573c-110">Пакетная служба реагирует на изменения метрик службы, данные о которых она регулярно собирает.</span><span class="sxs-lookup"><span data-stu-id="9573c-110">Batch responds to service metrics data that is collected periodically.</span></span> <span data-ttu-id="9573c-111">Используя эти данные метрик, заданную вами формулу и настроенный период масштабирования, пакетная служба изменяет количество вычислительных узлов в пуле.</span><span class="sxs-lookup"><span data-stu-id="9573c-111">Using this metrics data, Batch adjusts the number of compute nodes in the pool based on your formula and at a configurable interval.</span></span>

<span data-ttu-id="9573c-112">Автоматическое масштабирование можно включить во время создания пула или для существующего пула.</span><span class="sxs-lookup"><span data-stu-id="9573c-112">You can enable automatic scaling either when a pool is created, or on an existing pool.</span></span> <span data-ttu-id="9573c-113">Также можно изменить назначенную формулу для пула с настроенным автоматическим масштабированием.</span><span class="sxs-lookup"><span data-stu-id="9573c-113">You can also change an existing formula on a pool that is configured for autoscaling.</span></span> <span data-ttu-id="9573c-114">С помощью пакетной службы можно контролировать работу формул перед их применением к пулам, а также отслеживать состояние автоматического масштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-114">Batch enables you to evaluate your formulas before assigning them to pools and to monitor the status of automatic scaling runs.</span></span>

<span data-ttu-id="9573c-115">В этой статье рассматриваются различные сущности, которые входят в формулы автоматического масштабирования, такие как переменные, операторы, операции и функции.</span><span class="sxs-lookup"><span data-stu-id="9573c-115">This article discusses the various entities that make up your autoscale formulas, including variables, operators, operations, and functions.</span></span> <span data-ttu-id="9573c-116">Вы узнаете, как получить различные вычислительные ресурсы и метрики задач в пакетной службе.</span><span class="sxs-lookup"><span data-stu-id="9573c-116">We discuss how to obtain various compute resource and task metrics within Batch.</span></span> <span data-ttu-id="9573c-117">Эти метрики можно использовать для корректировки количества узлов в пуле на основе использования ресурсов и состояния задач.</span><span class="sxs-lookup"><span data-stu-id="9573c-117">You can use these metrics to adjust your pool's node count based on resource usage and task status.</span></span> <span data-ttu-id="9573c-118">Затем описывается, как составлять формулы и включать автоматическое масштабирование в пуле с помощью REST API пакетной службы и API .NET.</span><span class="sxs-lookup"><span data-stu-id="9573c-118">We then describe how to construct a formula and enable automatic scaling on a pool by using both the Batch REST and .NET APIs.</span></span> <span data-ttu-id="9573c-119">Наконец, мы рассмотрим несколько примеров формул.</span><span class="sxs-lookup"><span data-stu-id="9573c-119">Finally, we finish up with a few example formulas.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="9573c-120">При создании учетной записи пакетной службы можно задать [конфигурацию учетной записи](batch-api-basics.md#account), которая определяет, выделяются ли пулы в подписке на пакетную службу (по умолчанию) или в вашей пользовательской подписке.</span><span class="sxs-lookup"><span data-stu-id="9573c-120">When you create a Batch account, you can specify the [account configuration](batch-api-basics.md#account), which determines whether pools are allocated in a Batch service subscription (the default), or in your user subscription.</span></span> <span data-ttu-id="9573c-121">Если учетная запись пакетной службы была создана с конфигурацией пакетной службы по умолчанию, то она имеет ограничение на максимальное количество ядер, которые могут использоваться для обработки.</span><span class="sxs-lookup"><span data-stu-id="9573c-121">If you created your Batch account with the default Batch Service configuration, then your account is limited to a maximum number of cores that can be used for processing.</span></span> <span data-ttu-id="9573c-122">Пакетная служба будет создавать вычислительные узлы только до достижения этого предельного количества ядер.</span><span class="sxs-lookup"><span data-stu-id="9573c-122">The Batch service scales compute nodes only up to that core limit.</span></span> <span data-ttu-id="9573c-123">По этой причине пакетная служба может не достигать требуемого количества вычислительных узлов, определенного формулой автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-123">For this reason, the Batch service may not reach the target number of compute nodes specified by an autoscale formula.</span></span> <span data-ttu-id="9573c-124">Сведения о просмотре и увеличении квот для учетной записи приведены в статье [Квоты и ограничения пакетной службы Azure](batch-quota-limit.md) .</span><span class="sxs-lookup"><span data-stu-id="9573c-124">See [Quotas and limits for the Azure Batch service](batch-quota-limit.md) for information on viewing and increasing your account quotas.</span></span>
>
><span data-ttu-id="9573c-125">Если вы создали учетную запись с конфигурацией пользовательской подписки, то она использует квоту ядер по подписке.</span><span class="sxs-lookup"><span data-stu-id="9573c-125">If you created your account with the User Subscription configuration, then your account shares in the core quota for the subscription.</span></span> <span data-ttu-id="9573c-126">Дополнительные сведения см. в разделе [Ограничения виртуальных машин](../azure-subscription-service-limits.md#virtual-machines-limits) в статье [Подписка Azure, границы, квоты и ограничения службы](../azure-subscription-service-limits.md).</span><span class="sxs-lookup"><span data-stu-id="9573c-126">For more information, see [Virtual Machines limits](../azure-subscription-service-limits.md#virtual-machines-limits) in [Azure subscription and service limits, quotas, and constraints](../azure-subscription-service-limits.md).</span></span>
>
>

## <a name="automatic-scaling-formulas"></a><span data-ttu-id="9573c-127">Формулы автоматического масштабирования</span><span class="sxs-lookup"><span data-stu-id="9573c-127">Automatic scaling formulas</span></span>
<span data-ttu-id="9573c-128">Формула автоматического масштабирования представляет собой определяемое пользователем строковое значение, которое содержит один или несколько операторов.</span><span class="sxs-lookup"><span data-stu-id="9573c-128">An automatic scaling formula is a string value that you define that contains one or more statements.</span></span> <span data-ttu-id="9573c-129">Формула автоматического масштабирования назначается элементу пула [autoScaleFormula][rest_autoscaleformula] (в REST пакетной службы) или свойству [CloudPool.AutoScaleFormula] [ net_cloudpool_autoscaleformula] (.NET пакетной службы).</span><span class="sxs-lookup"><span data-stu-id="9573c-129">The autoscale formula is assigned to a pool's [autoScaleFormula][rest_autoscaleformula] element (Batch REST) or [CloudPool.AutoScaleFormula][net_cloudpool_autoscaleformula] property (Batch .NET).</span></span> <span data-ttu-id="9573c-130">С помощью этой формулы пакетная служба определяет целевое количество вычислительных узлов в пуле для следующего интервала обработки.</span><span class="sxs-lookup"><span data-stu-id="9573c-130">The Batch service uses your formula to determine the target number of compute nodes in the pool for the next interval of processing.</span></span> <span data-ttu-id="9573c-131">Размер строки формулы не может превышать 8 КБ, а сама строка может содержать до 100 операторов, разделенных точкой с запятой, а также разрывы строк и комментарии.</span><span class="sxs-lookup"><span data-stu-id="9573c-131">The formula string cannot exceed 8 KB, can include up to 100 statements that are separated by semicolons, and can include line breaks and comments.</span></span>

<span data-ttu-id="9573c-132">Вы можете представить, что формулы автоматического масштабирования — это язык автомасштабирования пакетной службы.</span><span class="sxs-lookup"><span data-stu-id="9573c-132">You can think of automatic scaling formulas as a Batch autoscale "language."</span></span> <span data-ttu-id="9573c-133">Инструкции в формуле представляют собой выражения свободной формы, которые могут включать служебные (определяемые службой пакетной обработки) и пользовательские переменные (определяемые пользователем).</span><span class="sxs-lookup"><span data-stu-id="9573c-133">Formula statements are free-formed expressions that can include both service-defined variables (variables defined by the Batch service) and user-defined variables (variables that you define).</span></span> <span data-ttu-id="9573c-134">С этими переменными могут выполняться различные операции с помощью встроенных типов, операторов и функций.</span><span class="sxs-lookup"><span data-stu-id="9573c-134">They can perform various operations on these values by using built-in types, operators, and functions.</span></span> <span data-ttu-id="9573c-135">Например, инструкция может принимать следующую форму:</span><span class="sxs-lookup"><span data-stu-id="9573c-135">For example, a statement might take the following form:</span></span>

```
$myNewVariable = function($ServiceDefinedVariable, $myCustomVariable);
```

<span data-ttu-id="9573c-136">Обычно формулы содержат несколько инструкций, выполняющих операции со значениями, полученными в предыдущих инструкциях.</span><span class="sxs-lookup"><span data-stu-id="9573c-136">Formulas generally contain multiple statements that perform operations on values that are obtained in previous statements.</span></span> <span data-ttu-id="9573c-137">Например, сначала получим значение для `variable1`, а затем передадим его функции для заполнения `variable2`:</span><span class="sxs-lookup"><span data-stu-id="9573c-137">For example, first we obtain a value for `variable1`, then pass it to a function to populate `variable2`:</span></span>

```
$variable1 = function1($ServiceDefinedVariable);
$variable2 = function2($OtherServiceDefinedVariable, $variable1);
```

<span data-ttu-id="9573c-138">Добавьте эти операторы в формулу автомасштабирования, чтобы получить целевое количество вычислительных узлов.</span><span class="sxs-lookup"><span data-stu-id="9573c-138">Include these statements in your autoscale formula to arrive at a target number of compute nodes.</span></span> <span data-ttu-id="9573c-139">Выделенные узлы и узлы с низким приоритетом имеют свои собственные целевые показатели, что позволяет определять целевое количество для каждого типа узла.</span><span class="sxs-lookup"><span data-stu-id="9573c-139">Dedicated nodes and low-priority nodes each have their own target settings, so that you can define a target for each type of node.</span></span> <span data-ttu-id="9573c-140">Формула автомасштабирования может включать в себя целевое значение для выделенных узлов, целевое значение для узлов с низким приоритетом или и то, и другое.</span><span class="sxs-lookup"><span data-stu-id="9573c-140">An autoscale formula can include a target value for dedicated nodes, a target value for low-priority nodes, or both.</span></span>

<span data-ttu-id="9573c-141">Целевое количество узлов может быть меньше или больше текущего количества узлов данного типа в пуле либо быть равным ему.</span><span class="sxs-lookup"><span data-stu-id="9573c-141">The target number of nodes may be higher, lower, or the same as the current number of nodes of that type in the pool.</span></span> <span data-ttu-id="9573c-142">Пакетная служба вычисляет формулу автомасштабирования пула с указанным интервалом (см. раздел, посвященный [интервалам автоматического масштабирования](#automatic-scaling-interval)).</span><span class="sxs-lookup"><span data-stu-id="9573c-142">Batch evaluates a pool's autoscale formula at a specific interval (see [automatic scaling intervals](#automatic-scaling-interval)).</span></span> <span data-ttu-id="9573c-143">Затем она изменяет целевое количество узлов каждого типа в пуле на новое значение, полученное по формуле автомасштабирования на момент оценки.</span><span class="sxs-lookup"><span data-stu-id="9573c-143">Batch adjusts the target number of each type of node in the pool to the number that your autoscale formula specifies at the time of evaluation.</span></span>

### <a name="sample-autoscale-formula"></a><span data-ttu-id="9573c-144">Пример формулы автоматического масштабирования</span><span class="sxs-lookup"><span data-stu-id="9573c-144">Sample autoscale formula</span></span>

<span data-ttu-id="9573c-145">Здесь представлен пример формулы автоматического масштабирования, который можно с некоторой корректировкой применить для большинства случаев.</span><span class="sxs-lookup"><span data-stu-id="9573c-145">Here is an example of an autoscale formula that can be adjusted to work for most scenarios.</span></span> <span data-ttu-id="9573c-146">Переменные `startingNumberOfVMs` и `maxNumberofVMs` в этом примере формулы можно изменять так, как вам удобно.</span><span class="sxs-lookup"><span data-stu-id="9573c-146">The variables `startingNumberOfVMs` and `maxNumberofVMs` in the example formula can be adjusted to your needs.</span></span> <span data-ttu-id="9573c-147">Эта формула масштабирует выделенные узлы, но ее можно изменить для масштабирования узлов с низким приоритетом.</span><span class="sxs-lookup"><span data-stu-id="9573c-147">This formula scales dedicated nodes, but can be modified to apply to scale low-priority nodes as well.</span></span> 

```
startingNumberOfVMs = 1;
maxNumberofVMs = 25;
pendingTaskSamplePercent = $PendingTasks.GetSamplePercent(180 * TimeInterval_Second);
pendingTaskSamples = pendingTaskSamplePercent < 70 ? startingNumberOfVMs : avg($PendingTasks.GetSample(180 * TimeInterval_Second));
$TargetDedicatedNodes=min(maxNumberofVMs, pendingTaskSamples);
```

<span data-ttu-id="9573c-148">Если используется эта формула автоматического масштабирования, пул создается с одной виртуальной машиной.</span><span class="sxs-lookup"><span data-stu-id="9573c-148">With this autoscale formula, the pool is initially created with a single VM.</span></span> <span data-ttu-id="9573c-149">Метрика `$PendingTasks` обозначает количество задач, находящихся в очереди или в состоянии выполнения.</span><span class="sxs-lookup"><span data-stu-id="9573c-149">The `$PendingTasks` metric defines the number of tasks that are running or queued.</span></span> <span data-ttu-id="9573c-150">Формула находит среднее число ожидающих выполнения задач за последние 180 секунд и соответствующим образом задает значение переменной `$TargetDedicatedNodes`.</span><span class="sxs-lookup"><span data-stu-id="9573c-150">The formula finds the average number of pending tasks in the last 180 seconds and sets the `$TargetDedicatedNodes` variable accordingly.</span></span> <span data-ttu-id="9573c-151">Формула гарантирует, что целевое число выделенных узлов никогда не превысит значение 25.</span><span class="sxs-lookup"><span data-stu-id="9573c-151">The formula ensures that the target number of dedicated nodes never exceeds 25 VMs.</span></span> <span data-ttu-id="9573c-152">По мере добавления новых задач пул автоматически расширяется.</span><span class="sxs-lookup"><span data-stu-id="9573c-152">As new tasks are submitted, the pool automatically grows.</span></span> <span data-ttu-id="9573c-153">При завершении задач виртуальные машины поочередно высвобождаются, и формула автомасштабирования сжимает размер пула.</span><span class="sxs-lookup"><span data-stu-id="9573c-153">As tasks complete, VMs become free one by one and the autoscaling formula shrinks the pool.</span></span>

## <a name="variables"></a><span data-ttu-id="9573c-154">Переменные</span><span class="sxs-lookup"><span data-stu-id="9573c-154">Variables</span></span>
<span data-ttu-id="9573c-155">В формуле автоматического масштабирования можно использовать как **служебные**, так и **пользовательские** переменные.</span><span class="sxs-lookup"><span data-stu-id="9573c-155">You can use both **service-defined** and **user-defined** variables in your autoscale formulas.</span></span> <span data-ttu-id="9573c-156">Служебные переменные встроены в пакетную службу.</span><span class="sxs-lookup"><span data-stu-id="9573c-156">The service-defined variables are built in to the Batch service.</span></span> <span data-ttu-id="9573c-157">Некоторые из них доступны для чтения и записи, а некоторые — только для чтения.</span><span class="sxs-lookup"><span data-stu-id="9573c-157">Some service-defined variables are read-write, and some are read-only.</span></span> <span data-ttu-id="9573c-158">Пользовательские переменные — это переменные, которые определяете вы.</span><span class="sxs-lookup"><span data-stu-id="9573c-158">User-defined variables are variables that you define.</span></span> <span data-ttu-id="9573c-159">Формула, представленная в примере предыдущего раздела, содержит определяемые службой переменные `$TargetDedicatedNodes` и `$PendingTasks`.</span><span class="sxs-lookup"><span data-stu-id="9573c-159">In the example formula shown in the previous section, `$TargetDedicatedNodes` and `$PendingTasks` are service-defined variables.</span></span> <span data-ttu-id="9573c-160">Переменные `startingNumberOfVMs` и `maxNumberofVMs` — это переменные, определяемые пользователем.</span><span class="sxs-lookup"><span data-stu-id="9573c-160">Variables `startingNumberOfVMs` and `maxNumberofVMs` are user-defined variables.</span></span>

> [!NOTE]
> <span data-ttu-id="9573c-161">Служебные переменные всегда начинаются с символа доллара ($).</span><span class="sxs-lookup"><span data-stu-id="9573c-161">Service-defined variables are always preceded by a dollar sign ($).</span></span> <span data-ttu-id="9573c-162">Для определяемых пользователем переменных знак доллара является необязательным.</span><span class="sxs-lookup"><span data-stu-id="9573c-162">For user-defined variables, the dollar sign is optional.</span></span>
>
>

<span data-ttu-id="9573c-163">В таблицах ниже показаны переменные для чтения и записи и переменные только для чтения, определенные пакетной службой.</span><span class="sxs-lookup"><span data-stu-id="9573c-163">The following tables show both read-write and read-only variables that are defined by the Batch service.</span></span>

<span data-ttu-id="9573c-164">Вы можете получить и установить значения этих служебных переменных для управления количеством вычислительных узлов в пуле.</span><span class="sxs-lookup"><span data-stu-id="9573c-164">You can get and set the values of these service-defined variables to manage the number of compute nodes in a pool:</span></span>

| <span data-ttu-id="9573c-165">Определяемые службой переменные для чтения и записи</span><span class="sxs-lookup"><span data-stu-id="9573c-165">Read-write service-defined variables</span></span> | <span data-ttu-id="9573c-166">Описание</span><span class="sxs-lookup"><span data-stu-id="9573c-166">Description</span></span> |
| --- | --- |
| <span data-ttu-id="9573c-167">$TargetDedicatedNodes</span><span class="sxs-lookup"><span data-stu-id="9573c-167">$TargetDedicatedNodes</span></span> |<span data-ttu-id="9573c-168">Целевое количество выделенных вычислительных узлов для пула.</span><span class="sxs-lookup"><span data-stu-id="9573c-168">The target number of dedicated compute nodes for the pool.</span></span> <span data-ttu-id="9573c-169">Количество выделенных узлов указывается как целевое, так как оно может остаться недостижимым для пула.</span><span class="sxs-lookup"><span data-stu-id="9573c-169">The number of dedicated nodes is specified as a target because a pool may not always achieve the desired number of nodes.</span></span> <span data-ttu-id="9573c-170">Например, это может произойти, если целевое количество выделенных узлов изменяется после вычисления формулы автоматического масштабирования до того, как пул достигнет изначального целевого количества.</span><span class="sxs-lookup"><span data-stu-id="9573c-170">For example, if the target number of dedicated nodes is modified by an autoscale evaluation before the pool has reached the initial target, then the pool may not reach the target.</span></span> <br /><br /> <span data-ttu-id="9573c-171">Целевое значение может оказаться недостижимым для пула в учетной записи, созданной с конфигурацией пакетной службы, если оно превышает квоту узлов или ядер в учетной записи пакетной службы.</span><span class="sxs-lookup"><span data-stu-id="9573c-171">A pool in an account created with the Batch Service configuration may not achieve its target if the target exceeds a Batch account node or core quota.</span></span> <span data-ttu-id="9573c-172">Целевое значение может оказаться недостижимым для пула в учетной записи, созданной с конфигурацией пользовательской подписки, если оно превышает общую квоту ядер по подписке.</span><span class="sxs-lookup"><span data-stu-id="9573c-172">A pool in an account created with the User Subscription configuration may not achieve its target if the target exceeds the shared core quota for the subscription.</span></span>|
| <span data-ttu-id="9573c-173">$TargetLowPriorityNodes</span><span class="sxs-lookup"><span data-stu-id="9573c-173">$TargetLowPriorityNodes</span></span> |<span data-ttu-id="9573c-174">Целевое количество вычислительных узлов с низким приоритетом для пула.</span><span class="sxs-lookup"><span data-stu-id="9573c-174">The target number of low-priority compute nodes for the pool.</span></span> <span data-ttu-id="9573c-175">Количество узлов с низким приоритетом указывается как целевое, так как оно может остаться недостижимым для пула.</span><span class="sxs-lookup"><span data-stu-id="9573c-175">The number of low-priority nodes is specified as a target because a pool may not always achieve the desired number of nodes.</span></span> <span data-ttu-id="9573c-176">Например, это может произойти, если целевое количество узлов с низким приоритетом изменяется после вычисления формулы автоматического масштабирования до того, как пул достигнет изначального целевого количества.</span><span class="sxs-lookup"><span data-stu-id="9573c-176">For example, if the target number of low-priority nodes is modified by an autoscale evaluation before the pool has reached the initial target, then the pool may not reach the target.</span></span> <span data-ttu-id="9573c-177">Это также может произойти, если целевое количество превышает квоту узлов или ядер в учетной записи пакетной службы.</span><span class="sxs-lookup"><span data-stu-id="9573c-177">A pool may also not achieve its target if the target exceeds a Batch account node or core quota.</span></span> <br /><br /> <span data-ttu-id="9573c-178">Дополнительные сведения о вычислительных узлах с низким приоритетом см. в статье [Использование низкоприоритетных виртуальных машин в пакетной службе (предварительная версия)](batch-low-pri-vms.md).</span><span class="sxs-lookup"><span data-stu-id="9573c-178">For more information on low-priority compute nodes, see [Use low-priority VMs with Batch (Preview)](batch-low-pri-vms.md).</span></span> |
| <span data-ttu-id="9573c-179">$NodeDeallocationOption</span><span class="sxs-lookup"><span data-stu-id="9573c-179">$NodeDeallocationOption</span></span> |<span data-ttu-id="9573c-180">Действие, выполняемое после удаления вычислительных узлов из пула.</span><span class="sxs-lookup"><span data-stu-id="9573c-180">The action that occurs when compute nodes are removed from a pool.</span></span> <span data-ttu-id="9573c-181">Возможные значения:</span><span class="sxs-lookup"><span data-stu-id="9573c-181">Possible values are:</span></span><ul><li><span data-ttu-id="9573c-182">**requeue** — немедленное завершение задач с перемещением в очередь заданий, чтобы запланировать их выполнение заново;</span><span class="sxs-lookup"><span data-stu-id="9573c-182">**requeue**--Terminates tasks immediately and puts them back on the job queue so that they are rescheduled.</span></span><li><span data-ttu-id="9573c-183">**terminate** — немедленное завершение задач с удалением из очереди заданий;</span><span class="sxs-lookup"><span data-stu-id="9573c-183">**terminate**--Terminates tasks immediately and removes them from the job queue.</span></span><li><span data-ttu-id="9573c-184">**taskcompletion** — ожидание завершения выполнения текущих задач с удалением узла из пула;</span><span class="sxs-lookup"><span data-stu-id="9573c-184">**taskcompletion**--Waits for currently running tasks to finish and then removes the node from the pool.</span></span><li><span data-ttu-id="9573c-185">**retaineddata** — ожидание очистки всех сохраненных в узле данных локальных задач перед удалением узла из пула.</span><span class="sxs-lookup"><span data-stu-id="9573c-185">**retaineddata**--Waits for all the local task-retained data on the node to be cleaned up before removing the node from the pool.</span></span></ul> |

<span data-ttu-id="9573c-186">Можно получить значения этих определяемых службой переменных, чтобы вносить изменения с учетом метрик из пакетной службы.</span><span class="sxs-lookup"><span data-stu-id="9573c-186">You can get the value of these service-defined variables to make adjustments that are based on metrics from the Batch service:</span></span>

| <span data-ttu-id="9573c-187">Определяемые службой переменные только для чтения</span><span class="sxs-lookup"><span data-stu-id="9573c-187">Read-only service-defined variables</span></span> | <span data-ttu-id="9573c-188">Описание</span><span class="sxs-lookup"><span data-stu-id="9573c-188">Description</span></span> |
| --- | --- |
| <span data-ttu-id="9573c-189">$CPUPercent</span><span class="sxs-lookup"><span data-stu-id="9573c-189">$CPUPercent</span></span> |<span data-ttu-id="9573c-190">Средний объем использования ЦП в процентах.</span><span class="sxs-lookup"><span data-stu-id="9573c-190">The average percentage of CPU usage.</span></span> |
| <span data-ttu-id="9573c-191">$WallClockSeconds</span><span class="sxs-lookup"><span data-stu-id="9573c-191">$WallClockSeconds</span></span> |<span data-ttu-id="9573c-192">Затраченное время в секундах.</span><span class="sxs-lookup"><span data-stu-id="9573c-192">The number of seconds consumed.</span></span> |
| <span data-ttu-id="9573c-193">$MemoryBytes</span><span class="sxs-lookup"><span data-stu-id="9573c-193">$MemoryBytes</span></span> |<span data-ttu-id="9573c-194">Среднее количество используемых мегабайт.</span><span class="sxs-lookup"><span data-stu-id="9573c-194">The average number of megabytes used.</span></span> |
| <span data-ttu-id="9573c-195">$DiskBytes</span><span class="sxs-lookup"><span data-stu-id="9573c-195">$DiskBytes</span></span> |<span data-ttu-id="9573c-196">Среднее количество гигабайт, используемых на локальных дисках.</span><span class="sxs-lookup"><span data-stu-id="9573c-196">The average number of gigabytes used on the local disks.</span></span> |
| <span data-ttu-id="9573c-197">$DiskReadBytes</span><span class="sxs-lookup"><span data-stu-id="9573c-197">$DiskReadBytes</span></span> |<span data-ttu-id="9573c-198">Количество считанных байт.</span><span class="sxs-lookup"><span data-stu-id="9573c-198">The number of bytes read.</span></span> |
| <span data-ttu-id="9573c-199">$DiskWriteBytes</span><span class="sxs-lookup"><span data-stu-id="9573c-199">$DiskWriteBytes</span></span> |<span data-ttu-id="9573c-200">Количество записанных байт.</span><span class="sxs-lookup"><span data-stu-id="9573c-200">The number of bytes written.</span></span> |
| <span data-ttu-id="9573c-201">$DiskReadOps</span><span class="sxs-lookup"><span data-stu-id="9573c-201">$DiskReadOps</span></span> |<span data-ttu-id="9573c-202">Количество операций чтения с диска.</span><span class="sxs-lookup"><span data-stu-id="9573c-202">The count of read disk operations performed.</span></span> |
| <span data-ttu-id="9573c-203">$DiskWriteOps</span><span class="sxs-lookup"><span data-stu-id="9573c-203">$DiskWriteOps</span></span> |<span data-ttu-id="9573c-204">Количество операций записи на диск.</span><span class="sxs-lookup"><span data-stu-id="9573c-204">The count of write disk operations performed.</span></span> |
| <span data-ttu-id="9573c-205">$NetworkInBytes</span><span class="sxs-lookup"><span data-stu-id="9573c-205">$NetworkInBytes</span></span> |<span data-ttu-id="9573c-206">Количество входящих байт.</span><span class="sxs-lookup"><span data-stu-id="9573c-206">The number of inbound bytes.</span></span> |
| <span data-ttu-id="9573c-207">$NetworkOutBytes</span><span class="sxs-lookup"><span data-stu-id="9573c-207">$NetworkOutBytes</span></span> |<span data-ttu-id="9573c-208">Количество исходящих байт.</span><span class="sxs-lookup"><span data-stu-id="9573c-208">The number of outbound bytes.</span></span> |
| <span data-ttu-id="9573c-209">$SampleNodeCount</span><span class="sxs-lookup"><span data-stu-id="9573c-209">$SampleNodeCount</span></span> |<span data-ttu-id="9573c-210">Количество вычислительных узлов.</span><span class="sxs-lookup"><span data-stu-id="9573c-210">The count of compute nodes.</span></span> |
| <span data-ttu-id="9573c-211">$ActiveTasks</span><span class="sxs-lookup"><span data-stu-id="9573c-211">$ActiveTasks</span></span> |<span data-ttu-id="9573c-212">Количество задач, готовых к выполнению, но еще не выполняющихся.</span><span class="sxs-lookup"><span data-stu-id="9573c-212">The number of tasks that are ready to execute but are not yet executing.</span></span> <span data-ttu-id="9573c-213">Значение $ActiveTasks включает все задачи в активном состоянии, зависимости которых выполнены.</span><span class="sxs-lookup"><span data-stu-id="9573c-213">The $ActiveTasks count includes all tasks that are in the active state and whose dependencies have been satisfied.</span></span> <span data-ttu-id="9573c-214">Задачи в активном состоянии, зависимости которых не выполнены, не включаются в значение $ActiveTasks.</span><span class="sxs-lookup"><span data-stu-id="9573c-214">Any tasks that are in the active state but whose dependencies have not been satisfied are excluded from the $ActiveTasks count.</span></span>|
| <span data-ttu-id="9573c-215">$RunningTasks</span><span class="sxs-lookup"><span data-stu-id="9573c-215">$RunningTasks</span></span> |<span data-ttu-id="9573c-216">Количество задач в состоянии выполнения.</span><span class="sxs-lookup"><span data-stu-id="9573c-216">The number of tasks in a running state.</span></span> |
| <span data-ttu-id="9573c-217">$PendingTasks</span><span class="sxs-lookup"><span data-stu-id="9573c-217">$PendingTasks</span></span> |<span data-ttu-id="9573c-218">Сумма $ActiveTasks и $RunningTasks.</span><span class="sxs-lookup"><span data-stu-id="9573c-218">The sum of $ActiveTasks and $RunningTasks.</span></span> |
| <span data-ttu-id="9573c-219">$SucceededTasks</span><span class="sxs-lookup"><span data-stu-id="9573c-219">$SucceededTasks</span></span> |<span data-ttu-id="9573c-220">Количество успешно выполненных задач.</span><span class="sxs-lookup"><span data-stu-id="9573c-220">The number of tasks that finished successfully.</span></span> |
| <span data-ttu-id="9573c-221">$FailedTasks</span><span class="sxs-lookup"><span data-stu-id="9573c-221">$FailedTasks</span></span> |<span data-ttu-id="9573c-222">Количество задач, которые не удалось выполнить.</span><span class="sxs-lookup"><span data-stu-id="9573c-222">The number of tasks that failed.</span></span> |
| <span data-ttu-id="9573c-223">$CurrentDedicatedNodes</span><span class="sxs-lookup"><span data-stu-id="9573c-223">$CurrentDedicatedNodes</span></span> |<span data-ttu-id="9573c-224">Текущее количество выделенных вычислительных узлов.</span><span class="sxs-lookup"><span data-stu-id="9573c-224">The current number of dedicated compute nodes.</span></span> |
| <span data-ttu-id="9573c-225">$CurrentLowPriorityNodes</span><span class="sxs-lookup"><span data-stu-id="9573c-225">$CurrentLowPriorityNodes</span></span> |<span data-ttu-id="9573c-226">Текущее количество вычислительных узлов с низким приоритетом, включая все узлы, которые были замещены.</span><span class="sxs-lookup"><span data-stu-id="9573c-226">The current number of low-priority compute nodes, including any nodes that have been pre-empted.</span></span> |
| <span data-ttu-id="9573c-227">$PreemptedNodeCount</span><span class="sxs-lookup"><span data-stu-id="9573c-227">$PreemptedNodeCount</span></span> | <span data-ttu-id="9573c-228">Количество узлов в пуле, которые находятся в замещенном состоянии.</span><span class="sxs-lookup"><span data-stu-id="9573c-228">The number of nodes in the pool that are in a pre-empted state.</span></span> |

> [!TIP]
> <span data-ttu-id="9573c-229">Приведенные в предыдущей таблице определяемые службой переменные только для чтения — это *объекты*, предоставляющие различные методы доступа к данным, связанным с каждым объектом.</span><span class="sxs-lookup"><span data-stu-id="9573c-229">The read-only, service-defined variables that are shown in the previous table are *objects* that provide various methods to access data associated with each.</span></span> <span data-ttu-id="9573c-230">Дополнительные сведения см. в разделе [Получение выборки данных](#getsampledata) далее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="9573c-230">For more information, see [Obtain sample data](#getsampledata) later in this article.</span></span>
>
>

## <a name="types"></a><span data-ttu-id="9573c-231">Типы</span><span class="sxs-lookup"><span data-stu-id="9573c-231">Types</span></span>
<span data-ttu-id="9573c-232">В формуле поддерживаются следующие типы:</span><span class="sxs-lookup"><span data-stu-id="9573c-232">These types are supported in a formula:</span></span>

* <span data-ttu-id="9573c-233">double</span><span class="sxs-lookup"><span data-stu-id="9573c-233">double</span></span>
* <span data-ttu-id="9573c-234">doubleVec</span><span class="sxs-lookup"><span data-stu-id="9573c-234">doubleVec</span></span>
* <span data-ttu-id="9573c-235">doubleVecList</span><span class="sxs-lookup"><span data-stu-id="9573c-235">doubleVecList</span></span>
* <span data-ttu-id="9573c-236">string</span><span class="sxs-lookup"><span data-stu-id="9573c-236">string</span></span>
* <span data-ttu-id="9573c-237">timestamp. timestamp является комплексной структурой, которая содержит следующие элементы:</span><span class="sxs-lookup"><span data-stu-id="9573c-237">timestamp--timestamp is a compound structure that contains the following members:</span></span>

  * <span data-ttu-id="9573c-238">year</span><span class="sxs-lookup"><span data-stu-id="9573c-238">year</span></span>
  * <span data-ttu-id="9573c-239">month (1-12)</span><span class="sxs-lookup"><span data-stu-id="9573c-239">month (1-12)</span></span>
  * <span data-ttu-id="9573c-240">day (1-31)</span><span class="sxs-lookup"><span data-stu-id="9573c-240">day (1-31)</span></span>
  * <span data-ttu-id="9573c-241">weekday (в формате числа, например 1 — понедельник)</span><span class="sxs-lookup"><span data-stu-id="9573c-241">weekday (in the format of number; for example, 1 for Monday)</span></span>
  * <span data-ttu-id="9573c-242">hour (час в 24-часовом формате, например 13 соответствует 13:00)</span><span class="sxs-lookup"><span data-stu-id="9573c-242">hour (in 24-hour number format; for example, 13 means 1 PM)</span></span>
  * <span data-ttu-id="9573c-243">minute (00–59)</span><span class="sxs-lookup"><span data-stu-id="9573c-243">minute (00-59)</span></span>
  * <span data-ttu-id="9573c-244">second (00–59)</span><span class="sxs-lookup"><span data-stu-id="9573c-244">second (00-59)</span></span>
* <span data-ttu-id="9573c-245">timeInterval</span><span class="sxs-lookup"><span data-stu-id="9573c-245">timeinterval</span></span>

  * <span data-ttu-id="9573c-246">TimeInterval_Zero</span><span class="sxs-lookup"><span data-stu-id="9573c-246">TimeInterval_Zero</span></span>
  * <span data-ttu-id="9573c-247">TimeInterval_100ns</span><span class="sxs-lookup"><span data-stu-id="9573c-247">TimeInterval_100ns</span></span>
  * <span data-ttu-id="9573c-248">TimeInterval_Microsecond</span><span class="sxs-lookup"><span data-stu-id="9573c-248">TimeInterval_Microsecond</span></span>
  * <span data-ttu-id="9573c-249">TimeInterval_Millisecond</span><span class="sxs-lookup"><span data-stu-id="9573c-249">TimeInterval_Millisecond</span></span>
  * <span data-ttu-id="9573c-250">TimeInterval_Second</span><span class="sxs-lookup"><span data-stu-id="9573c-250">TimeInterval_Second</span></span>
  * <span data-ttu-id="9573c-251">TimeInterval_Minute</span><span class="sxs-lookup"><span data-stu-id="9573c-251">TimeInterval_Minute</span></span>
  * <span data-ttu-id="9573c-252">TimeInterval_Hour</span><span class="sxs-lookup"><span data-stu-id="9573c-252">TimeInterval_Hour</span></span>
  * <span data-ttu-id="9573c-253">TimeInterval_Day</span><span class="sxs-lookup"><span data-stu-id="9573c-253">TimeInterval_Day</span></span>
  * <span data-ttu-id="9573c-254">TimeInterval_Week</span><span class="sxs-lookup"><span data-stu-id="9573c-254">TimeInterval_Week</span></span>
  * <span data-ttu-id="9573c-255">TimeInterval_Year</span><span class="sxs-lookup"><span data-stu-id="9573c-255">TimeInterval_Year</span></span>

## <a name="operations"></a><span data-ttu-id="9573c-256">Операции</span><span class="sxs-lookup"><span data-stu-id="9573c-256">Operations</span></span>
<span data-ttu-id="9573c-257">Для перечисленных в предыдущем разделе типов разрешены перечисленные ниже операции.</span><span class="sxs-lookup"><span data-stu-id="9573c-257">These operations are allowed on the types that are listed in the previous section.</span></span>

| <span data-ttu-id="9573c-258">Операция</span><span class="sxs-lookup"><span data-stu-id="9573c-258">Operation</span></span> | <span data-ttu-id="9573c-259">Поддерживаемые операторы</span><span class="sxs-lookup"><span data-stu-id="9573c-259">Supported operators</span></span> | <span data-ttu-id="9573c-260">Тип результата</span><span class="sxs-lookup"><span data-stu-id="9573c-260">Result type</span></span> |
| --- | --- | --- |
| <span data-ttu-id="9573c-261">double *оператор* double</span><span class="sxs-lookup"><span data-stu-id="9573c-261">double *operator* double</span></span> |<span data-ttu-id="9573c-262">+, -, *, /</span><span class="sxs-lookup"><span data-stu-id="9573c-262">+, -, *, /</span></span> |<span data-ttu-id="9573c-263">double</span><span class="sxs-lookup"><span data-stu-id="9573c-263">double</span></span> |
| <span data-ttu-id="9573c-264">double *оператор* timeinterval</span><span class="sxs-lookup"><span data-stu-id="9573c-264">double *operator* timeinterval</span></span> |* |<span data-ttu-id="9573c-265">timeInterval</span><span class="sxs-lookup"><span data-stu-id="9573c-265">timeinterval</span></span> |
| <span data-ttu-id="9573c-266">doubleVec *оператор* double</span><span class="sxs-lookup"><span data-stu-id="9573c-266">doubleVec *operator* double</span></span> |<span data-ttu-id="9573c-267">+, -, *, /</span><span class="sxs-lookup"><span data-stu-id="9573c-267">+, -, *, /</span></span> |<span data-ttu-id="9573c-268">doubleVec</span><span class="sxs-lookup"><span data-stu-id="9573c-268">doubleVec</span></span> |
| <span data-ttu-id="9573c-269">doubleVec *оператор* doubleVec</span><span class="sxs-lookup"><span data-stu-id="9573c-269">doubleVec *operator* doubleVec</span></span> |<span data-ttu-id="9573c-270">+, -, *, /</span><span class="sxs-lookup"><span data-stu-id="9573c-270">+, -, *, /</span></span> |<span data-ttu-id="9573c-271">doubleVec</span><span class="sxs-lookup"><span data-stu-id="9573c-271">doubleVec</span></span> |
| <span data-ttu-id="9573c-272">timeinterval *оператор* double</span><span class="sxs-lookup"><span data-stu-id="9573c-272">timeinterval *operator* double</span></span> |<span data-ttu-id="9573c-273">*, /</span><span class="sxs-lookup"><span data-stu-id="9573c-273">*, /</span></span> |<span data-ttu-id="9573c-274">timeInterval</span><span class="sxs-lookup"><span data-stu-id="9573c-274">timeinterval</span></span> |
| <span data-ttu-id="9573c-275">timeinterval *оператор* timeinterval</span><span class="sxs-lookup"><span data-stu-id="9573c-275">timeinterval *operator* timeinterval</span></span> |<span data-ttu-id="9573c-276">+, -</span><span class="sxs-lookup"><span data-stu-id="9573c-276">+, -</span></span> |<span data-ttu-id="9573c-277">timeInterval</span><span class="sxs-lookup"><span data-stu-id="9573c-277">timeinterval</span></span> |
| <span data-ttu-id="9573c-278">timeinterval *оператор* timestamp</span><span class="sxs-lookup"><span data-stu-id="9573c-278">timeinterval *operator* timestamp</span></span> |+ |<span data-ttu-id="9573c-279">timestamp</span><span class="sxs-lookup"><span data-stu-id="9573c-279">timestamp</span></span> |
| <span data-ttu-id="9573c-280">timestamp *оператор* timeinterval</span><span class="sxs-lookup"><span data-stu-id="9573c-280">timestamp *operator* timeinterval</span></span> |+ |<span data-ttu-id="9573c-281">timestamp</span><span class="sxs-lookup"><span data-stu-id="9573c-281">timestamp</span></span> |
| <span data-ttu-id="9573c-282">timestamp *оператор* timestamp</span><span class="sxs-lookup"><span data-stu-id="9573c-282">timestamp *operator* timestamp</span></span> |- |<span data-ttu-id="9573c-283">timeInterval</span><span class="sxs-lookup"><span data-stu-id="9573c-283">timeinterval</span></span> |
| <span data-ttu-id="9573c-284">*оператор*double</span><span class="sxs-lookup"><span data-stu-id="9573c-284">*operator*double</span></span> |<span data-ttu-id="9573c-285">-, !</span><span class="sxs-lookup"><span data-stu-id="9573c-285">-, !</span></span> |<span data-ttu-id="9573c-286">double</span><span class="sxs-lookup"><span data-stu-id="9573c-286">double</span></span> |
| <span data-ttu-id="9573c-287">*оператор*timeInterval</span><span class="sxs-lookup"><span data-stu-id="9573c-287">*operator*timeinterval</span></span> |- |<span data-ttu-id="9573c-288">timeInterval</span><span class="sxs-lookup"><span data-stu-id="9573c-288">timeinterval</span></span> |
| <span data-ttu-id="9573c-289">double *оператор* double</span><span class="sxs-lookup"><span data-stu-id="9573c-289">double *operator* double</span></span> |<span data-ttu-id="9573c-290"><, <=, ==, >=, >, !=</span><span class="sxs-lookup"><span data-stu-id="9573c-290"><, <=, ==, >=, >, !=</span></span> |<span data-ttu-id="9573c-291">double</span><span class="sxs-lookup"><span data-stu-id="9573c-291">double</span></span> |
| <span data-ttu-id="9573c-292">string *оператор* string</span><span class="sxs-lookup"><span data-stu-id="9573c-292">string *operator* string</span></span> |<span data-ttu-id="9573c-293"><, <=, ==, >=, >, !=</span><span class="sxs-lookup"><span data-stu-id="9573c-293"><, <=, ==, >=, >, !=</span></span> |<span data-ttu-id="9573c-294">double</span><span class="sxs-lookup"><span data-stu-id="9573c-294">double</span></span> |
| <span data-ttu-id="9573c-295">timestamp *оператор* timestamp</span><span class="sxs-lookup"><span data-stu-id="9573c-295">timestamp *operator* timestamp</span></span> |<span data-ttu-id="9573c-296"><, <=, ==, >=, >, !=</span><span class="sxs-lookup"><span data-stu-id="9573c-296"><, <=, ==, >=, >, !=</span></span> |<span data-ttu-id="9573c-297">double</span><span class="sxs-lookup"><span data-stu-id="9573c-297">double</span></span> |
| <span data-ttu-id="9573c-298">timeinterval *оператор* timeinterval</span><span class="sxs-lookup"><span data-stu-id="9573c-298">timeinterval *operator* timeinterval</span></span> |<span data-ttu-id="9573c-299"><, <=, ==, >=, >, !=</span><span class="sxs-lookup"><span data-stu-id="9573c-299"><, <=, ==, >=, >, !=</span></span> |<span data-ttu-id="9573c-300">double</span><span class="sxs-lookup"><span data-stu-id="9573c-300">double</span></span> |
| <span data-ttu-id="9573c-301">double *оператор* double</span><span class="sxs-lookup"><span data-stu-id="9573c-301">double *operator* double</span></span> |<span data-ttu-id="9573c-302">&&, &#124;&#124;</span><span class="sxs-lookup"><span data-stu-id="9573c-302">&&, &#124;&#124;</span></span> |<span data-ttu-id="9573c-303">double</span><span class="sxs-lookup"><span data-stu-id="9573c-303">double</span></span> |

<span data-ttu-id="9573c-304">При тестировании double с тернарным оператором (`double ? statement1 : statement2`) ненулевое значение равно **true**, а нулевое — **false**.</span><span class="sxs-lookup"><span data-stu-id="9573c-304">When testing a double with a ternary operator (`double ? statement1 : statement2`), nonzero is **true**, and zero is **false**.</span></span>

## <a name="functions"></a><span data-ttu-id="9573c-305">Функции</span><span class="sxs-lookup"><span data-stu-id="9573c-305">Functions</span></span>
<span data-ttu-id="9573c-306">Для определения формулы автомасштабирования доступны следующие предопределенные **функции** .</span><span class="sxs-lookup"><span data-stu-id="9573c-306">These predefined **functions** are available for you to use in defining an automatic scaling formula.</span></span>

| <span data-ttu-id="9573c-307">Функция</span><span class="sxs-lookup"><span data-stu-id="9573c-307">Function</span></span> | <span data-ttu-id="9573c-308">Тип возвращаемого значения</span><span class="sxs-lookup"><span data-stu-id="9573c-308">Return type</span></span> | <span data-ttu-id="9573c-309">Описание</span><span class="sxs-lookup"><span data-stu-id="9573c-309">Description</span></span> |
| --- | --- | --- |
| <span data-ttu-id="9573c-310">avg(doubleVecList)</span><span class="sxs-lookup"><span data-stu-id="9573c-310">avg(doubleVecList)</span></span> |<span data-ttu-id="9573c-311">double</span><span class="sxs-lookup"><span data-stu-id="9573c-311">double</span></span> |<span data-ttu-id="9573c-312">Среднее значение для всех значений в doubleVecList.</span><span class="sxs-lookup"><span data-stu-id="9573c-312">Returns the average value for all values in the doubleVecList.</span></span> |
| <span data-ttu-id="9573c-313">len(doubleVecList)</span><span class="sxs-lookup"><span data-stu-id="9573c-313">len(doubleVecList)</span></span> |<span data-ttu-id="9573c-314">double</span><span class="sxs-lookup"><span data-stu-id="9573c-314">double</span></span> |<span data-ttu-id="9573c-315">Возвращает длину вектора, созданного из doubleVecList.</span><span class="sxs-lookup"><span data-stu-id="9573c-315">Returns the length of the vector that is created from the doubleVecList.</span></span> |
| <span data-ttu-id="9573c-316">lg(double)</span><span class="sxs-lookup"><span data-stu-id="9573c-316">lg(double)</span></span> |<span data-ttu-id="9573c-317">double</span><span class="sxs-lookup"><span data-stu-id="9573c-317">double</span></span> |<span data-ttu-id="9573c-318">Возвращает логарифм double по основанию 2.</span><span class="sxs-lookup"><span data-stu-id="9573c-318">Returns the log base 2 of the double.</span></span> |
| <span data-ttu-id="9573c-319">lg(doubleVecList)</span><span class="sxs-lookup"><span data-stu-id="9573c-319">lg(doubleVecList)</span></span> |<span data-ttu-id="9573c-320">doubleVec</span><span class="sxs-lookup"><span data-stu-id="9573c-320">doubleVec</span></span> |<span data-ttu-id="9573c-321">Возвращает покомпонентный логарифм по основанию 2 от значения doubleVecList.</span><span class="sxs-lookup"><span data-stu-id="9573c-321">Returns the component-wise log base 2 of the doubleVecList.</span></span> <span data-ttu-id="9573c-322">В качестве параметра необходимо явно передать vec(double).</span><span class="sxs-lookup"><span data-stu-id="9573c-322">A vec(double) must be explicitly passed for the parameter.</span></span> <span data-ttu-id="9573c-323">В противном случае предполагается использование версии lg(double).</span><span class="sxs-lookup"><span data-stu-id="9573c-323">Otherwise, the double lg(double) version is assumed.</span></span> |
| <span data-ttu-id="9573c-324">ln(double)</span><span class="sxs-lookup"><span data-stu-id="9573c-324">ln(double)</span></span> |<span data-ttu-id="9573c-325">double</span><span class="sxs-lookup"><span data-stu-id="9573c-325">double</span></span> |<span data-ttu-id="9573c-326">Возвращает натуральный логарифм double.</span><span class="sxs-lookup"><span data-stu-id="9573c-326">Returns the natural log of the double.</span></span> |
| <span data-ttu-id="9573c-327">ln(doubleVecList)</span><span class="sxs-lookup"><span data-stu-id="9573c-327">ln(doubleVecList)</span></span> |<span data-ttu-id="9573c-328">doubleVec</span><span class="sxs-lookup"><span data-stu-id="9573c-328">doubleVec</span></span> |<span data-ttu-id="9573c-329">Возвращает покомпонентный логарифм по основанию 2 от значения doubleVecList.</span><span class="sxs-lookup"><span data-stu-id="9573c-329">Returns the component-wise log base 2 of the doubleVecList.</span></span> <span data-ttu-id="9573c-330">В качестве параметра необходимо явно передать vec(double).</span><span class="sxs-lookup"><span data-stu-id="9573c-330">A vec(double) must be explicitly passed for the parameter.</span></span> <span data-ttu-id="9573c-331">В противном случае предполагается использование версии lg(double).</span><span class="sxs-lookup"><span data-stu-id="9573c-331">Otherwise, the double lg(double) version is assumed.</span></span> |
| <span data-ttu-id="9573c-332">log(double)</span><span class="sxs-lookup"><span data-stu-id="9573c-332">log(double)</span></span> |<span data-ttu-id="9573c-333">double</span><span class="sxs-lookup"><span data-stu-id="9573c-333">double</span></span> |<span data-ttu-id="9573c-334">Возвращает логарифм double по основанию 10.</span><span class="sxs-lookup"><span data-stu-id="9573c-334">Returns the log base 10 of the double.</span></span> |
| <span data-ttu-id="9573c-335">log(doubleVecList)</span><span class="sxs-lookup"><span data-stu-id="9573c-335">log(doubleVecList)</span></span> |<span data-ttu-id="9573c-336">doubleVec</span><span class="sxs-lookup"><span data-stu-id="9573c-336">doubleVec</span></span> |<span data-ttu-id="9573c-337">Возвращает покомпонентный логарифм по основанию 10 от значения doubleVecList.</span><span class="sxs-lookup"><span data-stu-id="9573c-337">Returns the component-wise log base 10 of the doubleVecList.</span></span> <span data-ttu-id="9573c-338">В качестве одного параметра double необходимо явно передать vec(double).</span><span class="sxs-lookup"><span data-stu-id="9573c-338">A vec(double) must be explicitly passed for the single double parameter.</span></span> <span data-ttu-id="9573c-339">В противном случае предполагается использование версии log(double).</span><span class="sxs-lookup"><span data-stu-id="9573c-339">Otherwise, the double log(double) version is assumed.</span></span> |
| <span data-ttu-id="9573c-340">max(doubleVecList)</span><span class="sxs-lookup"><span data-stu-id="9573c-340">max(doubleVecList)</span></span> |<span data-ttu-id="9573c-341">double</span><span class="sxs-lookup"><span data-stu-id="9573c-341">double</span></span> |<span data-ttu-id="9573c-342">Возвращает максимальное значение в doubleVecList.</span><span class="sxs-lookup"><span data-stu-id="9573c-342">Returns the maximum value in the doubleVecList.</span></span> |
| <span data-ttu-id="9573c-343">min(doubleVecList)</span><span class="sxs-lookup"><span data-stu-id="9573c-343">min(doubleVecList)</span></span> |<span data-ttu-id="9573c-344">double</span><span class="sxs-lookup"><span data-stu-id="9573c-344">double</span></span> |<span data-ttu-id="9573c-345">Возвращает минимальное значение в doubleVecList.</span><span class="sxs-lookup"><span data-stu-id="9573c-345">Returns the minimum value in the doubleVecList.</span></span> |
| <span data-ttu-id="9573c-346">norm(doubleVecList)</span><span class="sxs-lookup"><span data-stu-id="9573c-346">norm(doubleVecList)</span></span> |<span data-ttu-id="9573c-347">double</span><span class="sxs-lookup"><span data-stu-id="9573c-347">double</span></span> |<span data-ttu-id="9573c-348">Возвращает 2-норму вектора, созданного из doubleVecList.</span><span class="sxs-lookup"><span data-stu-id="9573c-348">Returns the two-norm of the vector that is created from the doubleVecList.</span></span> |
| <span data-ttu-id="9573c-349">percentile(doubleVec v, double p)</span><span class="sxs-lookup"><span data-stu-id="9573c-349">percentile(doubleVec v, double p)</span></span> |<span data-ttu-id="9573c-350">double</span><span class="sxs-lookup"><span data-stu-id="9573c-350">double</span></span> |<span data-ttu-id="9573c-351">Возвращает элемент процентиля вектора v.</span><span class="sxs-lookup"><span data-stu-id="9573c-351">Returns the percentile element of the vector v.</span></span> |
| <span data-ttu-id="9573c-352">rand()</span><span class="sxs-lookup"><span data-stu-id="9573c-352">rand()</span></span> |<span data-ttu-id="9573c-353">double</span><span class="sxs-lookup"><span data-stu-id="9573c-353">double</span></span> |<span data-ttu-id="9573c-354">Возвращает случайное значение от 0,0 до 1,0.</span><span class="sxs-lookup"><span data-stu-id="9573c-354">Returns a random value between 0.0 and 1.0.</span></span> |
| <span data-ttu-id="9573c-355">range(doubleVecList)</span><span class="sxs-lookup"><span data-stu-id="9573c-355">range(doubleVecList)</span></span> |<span data-ttu-id="9573c-356">double</span><span class="sxs-lookup"><span data-stu-id="9573c-356">double</span></span> |<span data-ttu-id="9573c-357">Возвращает разницу между минимальным и максимальным значениями в doubleVecList.</span><span class="sxs-lookup"><span data-stu-id="9573c-357">Returns the difference between the min and max values in the doubleVecList.</span></span> |
| <span data-ttu-id="9573c-358">std(doubleVecList)</span><span class="sxs-lookup"><span data-stu-id="9573c-358">std(doubleVecList)</span></span> |<span data-ttu-id="9573c-359">double</span><span class="sxs-lookup"><span data-stu-id="9573c-359">double</span></span> |<span data-ttu-id="9573c-360">Возвращает среднеквадратичное отклонение выборки для значений в doubleVecList.</span><span class="sxs-lookup"><span data-stu-id="9573c-360">Returns the sample standard deviation of the values in the doubleVecList.</span></span> |
| <span data-ttu-id="9573c-361">stop()</span><span class="sxs-lookup"><span data-stu-id="9573c-361">stop()</span></span> | |<span data-ttu-id="9573c-362">Останавливает вычисление выражения автоматического масштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-362">Stops evaluation of the autoscaling expression.</span></span> |
| <span data-ttu-id="9573c-363">sum(doubleVecList)</span><span class="sxs-lookup"><span data-stu-id="9573c-363">sum(doubleVecList)</span></span> |<span data-ttu-id="9573c-364">double</span><span class="sxs-lookup"><span data-stu-id="9573c-364">double</span></span> |<span data-ttu-id="9573c-365">Возвращает сумму всех компонентов doubleVecList.</span><span class="sxs-lookup"><span data-stu-id="9573c-365">Returns the sum of all the components of the doubleVecList.</span></span> |
| <span data-ttu-id="9573c-366">time(string dateTime="")</span><span class="sxs-lookup"><span data-stu-id="9573c-366">time(string dateTime="")</span></span> |<span data-ttu-id="9573c-367">Timestamp</span><span class="sxs-lookup"><span data-stu-id="9573c-367">timestamp</span></span> |<span data-ttu-id="9573c-368">Возвращает отметку времени для текущего времени, если параметр не передан, и отметку времени для строки dateTime, если параметр передан.</span><span class="sxs-lookup"><span data-stu-id="9573c-368">Returns the time stamp of the current time if no parameters are passed, or the time stamp of the dateTime string if it is passed.</span></span> <span data-ttu-id="9573c-369">Поддерживаемые форматы даты и времени: W3C-DTF и RFC 1123.</span><span class="sxs-lookup"><span data-stu-id="9573c-369">Supported dateTime formats are W3C-DTF and RFC 1123.</span></span> |
| <span data-ttu-id="9573c-370">val(doubleVec v, double i)</span><span class="sxs-lookup"><span data-stu-id="9573c-370">val(doubleVec v, double i)</span></span> |<span data-ttu-id="9573c-371">double</span><span class="sxs-lookup"><span data-stu-id="9573c-371">double</span></span> |<span data-ttu-id="9573c-372">Возвращает значение элемента с индексом i в векторе v с начальным индексом 0.</span><span class="sxs-lookup"><span data-stu-id="9573c-372">Returns the value of the element that is at location i in vector v, with a starting index of zero.</span></span> |

<span data-ttu-id="9573c-373">Некоторые функции, описанные в предыдущей таблице, могут принимать список в качестве аргумента.</span><span class="sxs-lookup"><span data-stu-id="9573c-373">Some of the functions that are described in the previous table can accept a list as an argument.</span></span> <span data-ttu-id="9573c-374">Список значений, разделенных запятыми, — это любая комбинация типов *double* и *doubleVec*.</span><span class="sxs-lookup"><span data-stu-id="9573c-374">The comma-separated list is any combination of *double* and *doubleVec*.</span></span> <span data-ttu-id="9573c-375">Например:</span><span class="sxs-lookup"><span data-stu-id="9573c-375">For example:</span></span>

`doubleVecList := ( (double | doubleVec)+(, (double | doubleVec) )* )?`

<span data-ttu-id="9573c-376">Значение *doubleVecList* перед оценкой преобразуется в одно значение *doubleVec*.</span><span class="sxs-lookup"><span data-stu-id="9573c-376">The *doubleVecList* value is converted to a single *doubleVec* before evaluation.</span></span> <span data-ttu-id="9573c-377">Например, если `v = [1,2,3]`, то вызов `avg(v)` эквивалентен вызову `avg(1,2,3)`.</span><span class="sxs-lookup"><span data-stu-id="9573c-377">For example, if `v = [1,2,3]`, then calling `avg(v)` is equivalent to calling `avg(1,2,3)`.</span></span> <span data-ttu-id="9573c-378">Вызов `avg(v, 7)` эквивалентен вызову `avg(1,2,3,7)`.</span><span class="sxs-lookup"><span data-stu-id="9573c-378">Calling `avg(v, 7)` is equivalent to calling `avg(1,2,3,7)`.</span></span>

## <span data-ttu-id="9573c-379"><a name="getsampledata"></a>Получение выборки данных</span><span class="sxs-lookup"><span data-stu-id="9573c-379"><a name="getsampledata"></a>Obtain sample data</span></span>
<span data-ttu-id="9573c-380">Формулы автоматического масштабирования работают с данными метрик (выборками), предоставленными пакетной службой.</span><span class="sxs-lookup"><span data-stu-id="9573c-380">Autoscale formulas act on metrics data (samples) that is provided by the Batch service.</span></span> <span data-ttu-id="9573c-381">Формула увеличивает или уменьшает размер пула на основе значений, полученных от службы.</span><span class="sxs-lookup"><span data-stu-id="9573c-381">A formula grows or shrinks pool size based on the values that it obtains from the service.</span></span> <span data-ttu-id="9573c-382">Описанные выше служебные переменные только для чтения — это объекты, предоставляющие разные методы доступа к данным, связанным с объектом.</span><span class="sxs-lookup"><span data-stu-id="9573c-382">The service-defined variables that were described previously are objects that provide various methods to access data that is associated with that object.</span></span> <span data-ttu-id="9573c-383">Например, следующее выражение иллюстрирует запрос для получения данных об использовании ЦП за последние пять минут.</span><span class="sxs-lookup"><span data-stu-id="9573c-383">For example, the following expression shows a request to get the last five minutes of CPU usage:</span></span>

```
$CPUPercent.GetSample(TimeInterval_Minute * 5)
```

| <span data-ttu-id="9573c-384">Метод</span><span class="sxs-lookup"><span data-stu-id="9573c-384">Method</span></span> | <span data-ttu-id="9573c-385">Описание</span><span class="sxs-lookup"><span data-stu-id="9573c-385">Description</span></span> |
| --- | --- |
| <span data-ttu-id="9573c-386">GetSample()</span><span class="sxs-lookup"><span data-stu-id="9573c-386">GetSample()</span></span> |<span data-ttu-id="9573c-387">Метод `GetSample()` возвращает вектор выборок данных.</span><span class="sxs-lookup"><span data-stu-id="9573c-387">The `GetSample()` method returns a vector of data samples.</span></span><br/><br/><span data-ttu-id="9573c-388">Выборка — это данные метрики за 30 секунд.</span><span class="sxs-lookup"><span data-stu-id="9573c-388">A sample is 30 seconds worth of metrics data.</span></span> <span data-ttu-id="9573c-389">Другими словами, выборки делаются каждые 30 секунд.</span><span class="sxs-lookup"><span data-stu-id="9573c-389">In other words, samples are obtained every 30 seconds.</span></span> <span data-ttu-id="9573c-390">Но, как описано ниже, существует задержка между получением выборки и моментом, когда выборка станет доступна формуле.</span><span class="sxs-lookup"><span data-stu-id="9573c-390">But as noted below, there is a delay between when a sample is collected and when it is available to a formula.</span></span> <span data-ttu-id="9573c-391">Таким образом, не все выборки за заданный период времени могут быть доступны для оценки формулой.</span><span class="sxs-lookup"><span data-stu-id="9573c-391">As such, not all samples for a given time period may be available for evaluation by a formula.</span></span><ul><li>`doubleVec GetSample(double count)`<br/><span data-ttu-id="9573c-392">Указывает нужное количество выборок из числа самых свежих.</span><span class="sxs-lookup"><span data-stu-id="9573c-392">Specifies the number of samples to obtain from the most recent samples that were collected.</span></span><br/><br/><span data-ttu-id="9573c-393">`GetSample(1)` возвращает последнюю доступную выборку.</span><span class="sxs-lookup"><span data-stu-id="9573c-393">`GetSample(1)` returns the last available sample.</span></span> <span data-ttu-id="9573c-394">Этот метод не следует использовать для таких метрик, как `$CPUPercent`, так как нет возможности узнать, *когда* была получена эта выборка.</span><span class="sxs-lookup"><span data-stu-id="9573c-394">For metrics like `$CPUPercent`, however, this should not be used because it is impossible to know *when* the sample was collected.</span></span> <span data-ttu-id="9573c-395">Она может оказаться свежей, но может и устареть, если в системе возникли проблемы.</span><span class="sxs-lookup"><span data-stu-id="9573c-395">It might be recent, or, because of system issues, it might be much older.</span></span> <span data-ttu-id="9573c-396">Для таких параметров лучше использовать интервалы, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="9573c-396">It is better in such cases to use a time interval as shown below.</span></span><li>`doubleVec GetSample((timestamp or timeinterval) startTime [, double samplePercent])`<br/><span data-ttu-id="9573c-397">Задает интервал времени для данных выборки.</span><span class="sxs-lookup"><span data-stu-id="9573c-397">Specifies a time frame for gathering sample data.</span></span> <span data-ttu-id="9573c-398">Также можно указать долю выборок, которые должны быть доступны в течение запрошенного интервала времени.</span><span class="sxs-lookup"><span data-stu-id="9573c-398">Optionally, it also specifies the percentage of samples that must be available in the requested time frame.</span></span><br/><br/><span data-ttu-id="9573c-399">`$CPUPercent.GetSample(TimeInterval_Minute * 10)` вернет 20 выборок, если в журнале CPUPercent присутствуют все выборки за последние 10 минут.</span><span class="sxs-lookup"><span data-stu-id="9573c-399">`$CPUPercent.GetSample(TimeInterval_Minute * 10)` would return 20 samples if all samples for the last 10 minutes are present in the CPUPercent history.</span></span> <span data-ttu-id="9573c-400">Но если данные за последнюю минуту еще недоступны, этот метод вернет только 18 выборок.</span><span class="sxs-lookup"><span data-stu-id="9573c-400">If the last minute of history was not available, however, only 18 samples would be returned.</span></span> <span data-ttu-id="9573c-401">В данном случае:</span><span class="sxs-lookup"><span data-stu-id="9573c-401">In this case:</span></span><br/><br/><span data-ttu-id="9573c-402">Метод `$CPUPercent.GetSample(TimeInterval_Minute * 10, 95)` завершится сбоем, так как доступно только 90 процентов выборок.</span><span class="sxs-lookup"><span data-stu-id="9573c-402">`$CPUPercent.GetSample(TimeInterval_Minute * 10, 95)` would fail because only 90 percent of the samples are available.</span></span><br/><br/><span data-ttu-id="9573c-403">Метод `$CPUPercent.GetSample(TimeInterval_Minute * 10, 80)` будет выполнен успешно.</span><span class="sxs-lookup"><span data-stu-id="9573c-403">`$CPUPercent.GetSample(TimeInterval_Minute * 10, 80)` would succeed.</span></span><li>`doubleVec GetSample((timestamp or timeinterval) startTime, (timestamp or timeinterval) endTime [, double samplePercent])`<br/><span data-ttu-id="9573c-404">Задает интервал времени для сбора данных, т. е. начало и конец сбора.</span><span class="sxs-lookup"><span data-stu-id="9573c-404">Specifies a time frame for gathering data, with both a start time and an end time.</span></span><br/><br/><span data-ttu-id="9573c-405">Как упоминалось выше, полученный образец становится доступным для формулы с задержкой.</span><span class="sxs-lookup"><span data-stu-id="9573c-405">As mentioned above, there is a delay between when a sample is collected and when it is available to a formula.</span></span> <span data-ttu-id="9573c-406">Эту задержку следует учитывать при использовании метода `GetSample`.</span><span class="sxs-lookup"><span data-stu-id="9573c-406">Consider this delay when you use the `GetSample` method.</span></span> <span data-ttu-id="9573c-407">Ознакомьтесь с `GetSamplePercent` ниже.</span><span class="sxs-lookup"><span data-stu-id="9573c-407">See `GetSamplePercent` below.</span></span> |
| <span data-ttu-id="9573c-408">GetSamplePeriod()</span><span class="sxs-lookup"><span data-stu-id="9573c-408">GetSamplePeriod()</span></span> |<span data-ttu-id="9573c-409">Возвращает период выборок, которые были получены в историческом наборе данных выборок.</span><span class="sxs-lookup"><span data-stu-id="9573c-409">Returns the period of samples that were taken in a historical sample data set.</span></span> |
| <span data-ttu-id="9573c-410">Count()</span><span class="sxs-lookup"><span data-stu-id="9573c-410">Count()</span></span> |<span data-ttu-id="9573c-411">Возвращает общее количество выборок в журнале метрик.</span><span class="sxs-lookup"><span data-stu-id="9573c-411">Returns the total number of samples in the metric history.</span></span> |
| <span data-ttu-id="9573c-412">HistoryBeginTime()</span><span class="sxs-lookup"><span data-stu-id="9573c-412">HistoryBeginTime()</span></span> |<span data-ttu-id="9573c-413">Возвращает метку времени самой старой доступной выборки данных метрики.</span><span class="sxs-lookup"><span data-stu-id="9573c-413">Returns the time stamp of the oldest available data sample for the metric.</span></span> |
| <span data-ttu-id="9573c-414">GetSamplePercent()</span><span class="sxs-lookup"><span data-stu-id="9573c-414">GetSamplePercent()</span></span> |<span data-ttu-id="9573c-415">Возвращает процент выборок, которые доступны для заданного интервала времени.</span><span class="sxs-lookup"><span data-stu-id="9573c-415">Returns the percentage of samples that are available for a given time interval.</span></span> <span data-ttu-id="9573c-416">Например:</span><span class="sxs-lookup"><span data-stu-id="9573c-416">For example:</span></span><br/><br/>`doubleVec GetSamplePercent( (timestamp or timeinterval) startTime [, (timestamp or timeinterval) endTime] )`<br/><br/><span data-ttu-id="9573c-417">Так как метод `GetSample` завершается сбоем, то если процент возвращаемых выборок меньше указанного в параметре `samplePercent`, можно сначала воспользоваться методом `GetSamplePercent` для проверки.</span><span class="sxs-lookup"><span data-stu-id="9573c-417">Because the `GetSample` method fails if the percentage of samples returned is less than the `samplePercent` specified, you can use the `GetSamplePercent` method to check first.</span></span> <span data-ttu-id="9573c-418">Затем при недостаточном количестве выборок можно выполнить другое действие без прерывания оценки автоматического масштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-418">Then you can perform an alternate action if insufficient samples are present, without halting the automatic scaling evaluation.</span></span> |

### <a name="samples-sample-percentage-and-the-getsample-method"></a><span data-ttu-id="9573c-419">Выборки, процент выборок и метод *GetSample()*</span><span class="sxs-lookup"><span data-stu-id="9573c-419">Samples, sample percentage, and the *GetSample()* method</span></span>
<span data-ttu-id="9573c-420">Основной операцией формулы автоматического масштабирования является получение данных метрик для задач и ресурсов и изменение размера пула на основе этих данных.</span><span class="sxs-lookup"><span data-stu-id="9573c-420">The core operation of an autoscale formula is to obtain task and resource metric data and then adjust pool size based on that data.</span></span> <span data-ttu-id="9573c-421">Поэтому важно иметь четкое представление о том, как формулы автоматического масштабирования взаимодействуют с данными метрик (выборками).</span><span class="sxs-lookup"><span data-stu-id="9573c-421">As such, it is important to have a clear understanding of how autoscale formulas interact with metrics data (samples).</span></span>

<span data-ttu-id="9573c-422">**Примеры**</span><span class="sxs-lookup"><span data-stu-id="9573c-422">**Samples**</span></span>

<span data-ttu-id="9573c-423">Пакетная служба периодически принимает выборки метрик задач и ресурсов, делая их доступными для формул автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-423">The Batch service periodically takes samples of task and resource metrics and makes them available to your autoscale formulas.</span></span> <span data-ttu-id="9573c-424">Эти выборки записываются пакетной службой каждые 30 секунд.</span><span class="sxs-lookup"><span data-stu-id="9573c-424">These samples are recorded every 30 seconds by the Batch service.</span></span> <span data-ttu-id="9573c-425">Однако обычно имеется задержка между временем записи этих выборок и временем, когда формулы автоматического масштабирования получают к ним доступ (и могут прочесть их).</span><span class="sxs-lookup"><span data-stu-id="9573c-425">However, there is typically a delay between when those samples were recorded and when they are made available to (and can be read by) your autoscale formulas.</span></span> <span data-ttu-id="9573c-426">Кроме того, по тем или иным причинам (включая проблемы с сетью или другие проблемы инфраструктуры) для некоторых интервалов выборки могут не записаться.</span><span class="sxs-lookup"><span data-stu-id="9573c-426">Additionally, due to various factors such as network or other infrastructure issues, samples may not be recorded for a particular interval.</span></span>

<span data-ttu-id="9573c-427">**Процент выборок**</span><span class="sxs-lookup"><span data-stu-id="9573c-427">**Sample percentage**</span></span>

<span data-ttu-id="9573c-428">При передаче `samplePercent` в метод `GetSample()` или при вызове метода `GetSamplePercent()` знак _процента_ означает сравнение общего возможного количества выборок, записанных пакетной службой, и количества выборок, которые доступны для формулы автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-428">When `samplePercent` is passed to the `GetSample()` method or the `GetSamplePercent()` method is called, _percent_ refers to a comparison between the total possible number of samples that are recorded by the Batch service and the number of samples that are available to your autoscale formula.</span></span>

<span data-ttu-id="9573c-429">Для примера рассмотрим промежуток времени в 10 минут.</span><span class="sxs-lookup"><span data-stu-id="9573c-429">Let's look at a 10-minute timespan as an example.</span></span> <span data-ttu-id="9573c-430">Так как выборки записываются каждые 30 секунд, максимальное общее количество выборок, записанных пакетной службой в течение 10 минут, должно равняться 20 (по 2 в минуту).</span><span class="sxs-lookup"><span data-stu-id="9573c-430">Because samples are recorded every 30 seconds within a 10-minute timespan, the maximum total number of samples that are recorded by Batch would be 20 samples (2 per minute).</span></span> <span data-ttu-id="9573c-431">Однако из-за задержек, присущих механизму отчетности, или других проблем в Azure возможна ситуация, когда только 15 выборок будут доступны для формулы автоматического масштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-431">However, due to the inherent latency of the reporting mechanism and other issues within Azure, there may be only 15 samples that are available to your autoscale formula for reading.</span></span> <span data-ttu-id="9573c-432">Поэтому, например, за этот 10-минутный период для формулы может быть доступно только 75 % от общего количества записанных выборок.</span><span class="sxs-lookup"><span data-stu-id="9573c-432">So, for example, for that 10-minute period, only 75% of the total number of samples recorded may be available to your formula.</span></span>

<span data-ttu-id="9573c-433">**Метод GetSample() и диапазоны выборок**</span><span class="sxs-lookup"><span data-stu-id="9573c-433">**GetSample() and sample ranges**</span></span>

<span data-ttu-id="9573c-434">Формулы автоматического масштабирования будут увеличивать и уменьшать размер пулов &mdash;, добавляя или удаляя узлы.</span><span class="sxs-lookup"><span data-stu-id="9573c-434">Your autoscale formulas are going to be growing and shrinking your pools &mdash; adding nodes or removing nodes.</span></span> <span data-ttu-id="9573c-435">Поскольку узлы стоят денег, нужно гарантировать, что формулы используют метод интеллектуального анализа, который основан на достаточном объеме данных.</span><span class="sxs-lookup"><span data-stu-id="9573c-435">Because nodes cost you money, you want to ensure that your formulas use an intelligent method of analysis that is based on sufficient data.</span></span> <span data-ttu-id="9573c-436">Поэтому в формулах рекомендуется использовать анализ тенденций.</span><span class="sxs-lookup"><span data-stu-id="9573c-436">Therefore, we recommend that you use a trending-type analysis in your formulas.</span></span> <span data-ttu-id="9573c-437">С таким анализом пулы увеличиваются и уменьшаются на основе диапазона собранных выборок.</span><span class="sxs-lookup"><span data-stu-id="9573c-437">This type grows and shrinks your pools based on a range of collected samples.</span></span>

<span data-ttu-id="9573c-438">С этой целью используйте метод `GetSample(interval look-back start, interval look-back end)` для возврата вектора выборок.</span><span class="sxs-lookup"><span data-stu-id="9573c-438">To do so, use `GetSample(interval look-back start, interval look-back end)` to return a vector of samples:</span></span>

```
$runningTasksSample = $RunningTasks.GetSample(1 * TimeInterval_Minute, 6 * TimeInterval_Minute);
```

<span data-ttu-id="9573c-439">Когда пакетная служба вычисляет приведенную выше строку, она возвращает диапазон выборок в виде вектора значений.</span><span class="sxs-lookup"><span data-stu-id="9573c-439">When the above line is evaluated by Batch, it returns a range of samples as a vector of values.</span></span> <span data-ttu-id="9573c-440">Например:</span><span class="sxs-lookup"><span data-stu-id="9573c-440">For example:</span></span>

```
$runningTasksSample=[1,1,1,1,1,1,1,1,1,1];
```

<span data-ttu-id="9573c-441">Собрав вектор выборок, можно использовать функции, например `min()`, `max()` и `avg()`, чтобы извлечь из собранного диапазона информативные значения.</span><span class="sxs-lookup"><span data-stu-id="9573c-441">Once you've collected the vector of samples, you can then use functions like `min()`, `max()`, and `avg()` to derive meaningful values from the collected range.</span></span>

<span data-ttu-id="9573c-442">Для повышения безопасности можно настроить сбой вычисления формулы в случае, если процент выборок за определенный период окажется меньше заданного значения.</span><span class="sxs-lookup"><span data-stu-id="9573c-442">For additional security, you can force a formula evaluation to fail if less than a certain sample percentage is available for a particular time period.</span></span> <span data-ttu-id="9573c-443">Если для формулы настроен принудительный сбой вычисления, пакетная служба прекращает выполнение расчетов по формуле, когда недоступен заданный процент выборок.</span><span class="sxs-lookup"><span data-stu-id="9573c-443">When you force a formula evaluation to fail, you instruct Batch to cease further evaluation of the formula if the specified percentage of samples is not available.</span></span> <span data-ttu-id="9573c-444">Размер пула при этом изменяться не будет.</span><span class="sxs-lookup"><span data-stu-id="9573c-444">In this case, no change is made to the pool size.</span></span> <span data-ttu-id="9573c-445">Чтобы указать необходимый процент выборок для успешного вычисления, укажите его как третий параметр в методе `GetSample()`.</span><span class="sxs-lookup"><span data-stu-id="9573c-445">To specify a required percentage of samples for the evaluation to succeed, specify it as the third parameter to `GetSample()`.</span></span> <span data-ttu-id="9573c-446">Здесь указано, что обязательный процент выборок равен 75 %:</span><span class="sxs-lookup"><span data-stu-id="9573c-446">Here, a requirement of 75 percent of samples is specified:</span></span>

```
$runningTasksSample = $RunningTasks.GetSample(60 * TimeInterval_Second, 120 * TimeInterval_Second, 75);
```

<span data-ttu-id="9573c-447">Поскольку иногда могут происходить задержки доступности выборок, для любого диапазона времени следует устанавливать время для предварительной оценки не меньше одной минуты.</span><span class="sxs-lookup"><span data-stu-id="9573c-447">Because there may be a delay in sample availability, it is important to always specify a time range with a look-back start time that is older than one minute.</span></span> <span data-ttu-id="9573c-448">Передача выборок через систему занимает около минуты, поэтому примеры в диапазоне `(0 * TimeInterval_Second, 60 * TimeInterval_Second)` могут быть недоступны.</span><span class="sxs-lookup"><span data-stu-id="9573c-448">It takes approximately one minute for samples to propagate through the system, so samples in the range `(0 * TimeInterval_Second, 60 * TimeInterval_Second)` may not be available.</span></span> <span data-ttu-id="9573c-449">Опять же, можно использовать параметр процента `GetSample()` для принудительного требования определенного процента выборок.</span><span class="sxs-lookup"><span data-stu-id="9573c-449">Again, you can use the percentage parameter of `GetSample()` to force a particular sample percentage requirement.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="9573c-450">Мы **настоятельно рекомендуем** **не полагаться *только* на метод `GetSample(1)` в формулах автомасштабирования**.</span><span class="sxs-lookup"><span data-stu-id="9573c-450">We **strongly recommend** that you **avoid relying *only* on `GetSample(1)` in your autoscale formulas**.</span></span> <span data-ttu-id="9573c-451">Это объясняется тем, что метод `GetSample(1)` запрашивает у пакетной службы последнюю доступную выборку независимо от того, как давно она была получена.</span><span class="sxs-lookup"><span data-stu-id="9573c-451">This is because `GetSample(1)` essentially says to the Batch service, "Give me the last sample you have, no matter how long ago you retrieved it."</span></span> <span data-ttu-id="9573c-452">Поскольку это только одна выборка, которая к тому же может быть устаревшей, она может не давать общее представление о последнем состоянии задачи или ресурса.</span><span class="sxs-lookup"><span data-stu-id="9573c-452">Since it is only a single sample, and it may be an older sample, it may not be representative of the larger picture of recent task or resource state.</span></span> <span data-ttu-id="9573c-453">Если метод `GetSample(1)`все же используется, убедитесь, что он является частью большей инструкции, а не единственной точкой данных, от которой зависит ваша формула.</span><span class="sxs-lookup"><span data-stu-id="9573c-453">If you do use `GetSample(1)`, make sure that it's part of a larger statement and not the only data point that your formula relies on.</span></span>
>
>

## <a name="metrics"></a><span data-ttu-id="9573c-454">Метрики</span><span class="sxs-lookup"><span data-stu-id="9573c-454">Metrics</span></span>
<span data-ttu-id="9573c-455">При определении формулы можно использовать метрики ресурсов и задач.</span><span class="sxs-lookup"><span data-stu-id="9573c-455">You can use both resource and task metrics when you're defining a formula.</span></span> <span data-ttu-id="9573c-456">Целевое количество выделенных узлов в пуле определяется на основе данных метрики, которые были получены и оценены.</span><span class="sxs-lookup"><span data-stu-id="9573c-456">You adjust the target number of dedicated nodes in the pool based on the metrics data that you obtain and evaluate.</span></span> <span data-ttu-id="9573c-457">Дополнительные сведения о каждой метрике см. в разделе [Переменные](#variables) выше.</span><span class="sxs-lookup"><span data-stu-id="9573c-457">See the [Variables](#variables) section above for more information on each metric.</span></span>

<table>
  <tr>
    <th><span data-ttu-id="9573c-458">Метрика</span><span class="sxs-lookup"><span data-stu-id="9573c-458">Metric</span></span></th>
    <th><span data-ttu-id="9573c-459">Описание</span><span class="sxs-lookup"><span data-stu-id="9573c-459">Description</span></span></th>
  </tr>
  <tr>
    <td><span data-ttu-id="9573c-460"><b>Ресурс</b></span><span class="sxs-lookup"><span data-stu-id="9573c-460"><b>Resource</b></span></span></td>
    <td><p><span data-ttu-id="9573c-461">Метрики ресурсов основаны на использовании ресурсов ЦП, памяти и пропускной способности вычислительных узлов, а также количестве узлов.</span><span class="sxs-lookup"><span data-stu-id="9573c-461">Resource metrics are based on the CPU, the bandwidth, the memory usage of compute nodes, and the number of nodes.</span></span></p>
        <p> <span data-ttu-id="9573c-462">Для внесения изменений с учетом количества узлов используются следующие служебные переменные:</span><span class="sxs-lookup"><span data-stu-id="9573c-462">These service-defined variables are useful for making adjustments based on node count:</span></span></p>
    <p><ul>
            <li><span data-ttu-id="9573c-463">$TargetDedicatedNodes</span><span class="sxs-lookup"><span data-stu-id="9573c-463">$TargetDedicatedNodes</span></span></li>
            <li><span data-ttu-id="9573c-464">$TargetLowPriorityNodes</span><span class="sxs-lookup"><span data-stu-id="9573c-464">$TargetLowPriorityNodes</span></span></li>
            <li><span data-ttu-id="9573c-465">$CurrentDedicatedNodes</span><span class="sxs-lookup"><span data-stu-id="9573c-465">$CurrentDedicatedNodes</span></span></li>
            <li><span data-ttu-id="9573c-466">$CurrentLowPriorityNodes</span><span class="sxs-lookup"><span data-stu-id="9573c-466">$CurrentLowPriorityNodes</span></span></li>
            <li><span data-ttu-id="9573c-467">$preemptedNodeCount</span><span class="sxs-lookup"><span data-stu-id="9573c-467">$preemptedNodeCount</span></span></li>
            <li><span data-ttu-id="9573c-468">$SampleNodeCount</span><span class="sxs-lookup"><span data-stu-id="9573c-468">$SampleNodeCount</span></span></li>
    </ul></p>
    <p><span data-ttu-id="9573c-469">Для внесения изменений с учетом потребляемых ресурсов используются следующие служебные переменные:</span><span class="sxs-lookup"><span data-stu-id="9573c-469">These service-defined variables are useful for making adjustments based on node resource usage:</span></span></p>
    <p><ul>
      <li><span data-ttu-id="9573c-470">$CPUPercent</span><span class="sxs-lookup"><span data-stu-id="9573c-470">$CPUPercent</span></span></li>
      <li><span data-ttu-id="9573c-471">$WallClockSeconds</span><span class="sxs-lookup"><span data-stu-id="9573c-471">$WallClockSeconds</span></span></li>
      <li><span data-ttu-id="9573c-472">$MemoryBytes</span><span class="sxs-lookup"><span data-stu-id="9573c-472">$MemoryBytes</span></span></li>
      <li><span data-ttu-id="9573c-473">$DiskBytes</span><span class="sxs-lookup"><span data-stu-id="9573c-473">$DiskBytes</span></span></li>
      <li><span data-ttu-id="9573c-474">$DiskReadBytes</span><span class="sxs-lookup"><span data-stu-id="9573c-474">$DiskReadBytes</span></span></li>
      <li><span data-ttu-id="9573c-475">$DiskWriteBytes</span><span class="sxs-lookup"><span data-stu-id="9573c-475">$DiskWriteBytes</span></span></li>
      <li><span data-ttu-id="9573c-476">$DiskReadOps</span><span class="sxs-lookup"><span data-stu-id="9573c-476">$DiskReadOps</span></span></li>
      <li><span data-ttu-id="9573c-477">$DiskWriteOps</span><span class="sxs-lookup"><span data-stu-id="9573c-477">$DiskWriteOps</span></span></li>
      <li><span data-ttu-id="9573c-478">$NetworkInBytes</span><span class="sxs-lookup"><span data-stu-id="9573c-478">$NetworkInBytes</span></span></li>
      <li><span data-ttu-id="9573c-479">$NetworkOutBytes</span><span class="sxs-lookup"><span data-stu-id="9573c-479">$NetworkOutBytes</span></span></li></ul></p>
  </tr>
  <tr>
    <td><span data-ttu-id="9573c-480"><b>Task</b></span><span class="sxs-lookup"><span data-stu-id="9573c-480"><b>Task</b></span></span></td>
    <td><p><span data-ttu-id="9573c-481">Метрики задач основаны на состоянии задач (активные, ожидающие и завершенные).</span><span class="sxs-lookup"><span data-stu-id="9573c-481">Task metrics are based on the status of tasks, such as Active, Pending, and Completed.</span></span> <span data-ttu-id="9573c-482">Для внесения изменений в размер пула с учетом метрик задач используются следующие служебные переменные:</span><span class="sxs-lookup"><span data-stu-id="9573c-482">The following service-defined variables are useful for making pool-size adjustments based on task metrics:</span></span></p>
    <p><ul>
      <li><span data-ttu-id="9573c-483">$ActiveTasks</span><span class="sxs-lookup"><span data-stu-id="9573c-483">$ActiveTasks</span></span></li>
      <li><span data-ttu-id="9573c-484">$RunningTasks</span><span class="sxs-lookup"><span data-stu-id="9573c-484">$RunningTasks</span></span></li>
      <li><span data-ttu-id="9573c-485">$PendingTasks</span><span class="sxs-lookup"><span data-stu-id="9573c-485">$PendingTasks</span></span></li>
      <li><span data-ttu-id="9573c-486">$SucceededTasks</span><span class="sxs-lookup"><span data-stu-id="9573c-486">$SucceededTasks</span></span></li>
            <li><span data-ttu-id="9573c-487">$FailedTasks</span><span class="sxs-lookup"><span data-stu-id="9573c-487">$FailedTasks</span></span></li></ul></p>
        </td>
  </tr>
</table>

## <a name="write-an-autoscale-formula"></a><span data-ttu-id="9573c-488">Написание формулы автомасштабирования</span><span class="sxs-lookup"><span data-stu-id="9573c-488">Write an autoscale formula</span></span>
<span data-ttu-id="9573c-489">Формула автомасштабирования создается путем формирования инструкций с помощью указанных выше компонентов и объединения этих инструкций в полную формулу.</span><span class="sxs-lookup"><span data-stu-id="9573c-489">You build an autoscale formula by forming statements that use the above components, then combine those statements into a complete formula.</span></span> <span data-ttu-id="9573c-490">В этом разделе мы создадим пример формулы автомасштабирования, с помощью которой можно выполнять некоторые задачи масштабирования из реальной жизни.</span><span class="sxs-lookup"><span data-stu-id="9573c-490">In this section, we create an example autoscale formula that can perform some real-world scaling decisions.</span></span>

<span data-ttu-id="9573c-491">Сначала определим требования к новой формуле автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-491">First, let's define the requirements for our new autoscale formula.</span></span> <span data-ttu-id="9573c-492">Формула должна выполнять следующее:</span><span class="sxs-lookup"><span data-stu-id="9573c-492">The formula should:</span></span>

1. <span data-ttu-id="9573c-493">Увеличивать целевое количество выделенных вычислительных узлов в пуле при высокой загрузке ЦП.</span><span class="sxs-lookup"><span data-stu-id="9573c-493">Increase the target number of dedicated compute nodes in a pool if CPU usage is high.</span></span>
2. <span data-ttu-id="9573c-494">Уменьшать целевое количество выделенных вычислительных узлов в пуле при низкой загрузке ЦП.</span><span class="sxs-lookup"><span data-stu-id="9573c-494">Decrease the target number of dedicated compute nodes in a pool when CPU usage is low.</span></span>
3. <span data-ttu-id="9573c-495">Всегда ограничивать максимальное количество выделенных узлов на уровне 400.</span><span class="sxs-lookup"><span data-stu-id="9573c-495">Always restrict the maximum number of dedicated nodes to 400.</span></span>

<span data-ttu-id="9573c-496">Для увеличения количества узлов в периоды высокой загрузки ЦП определите оператор, который присваивает пользовательской переменной (`$totalDedicatedNodes`) значение, равное 110 % от текущего целевого количества выделенных узлов, если минимальная средняя загрузка ЦП за последние 10 минут превышала 70 %.</span><span class="sxs-lookup"><span data-stu-id="9573c-496">To increase the number of nodes during high CPU usage, define the statement that populates a user-defined variable (`$totalDedicatedNodes`) with a value that is 110 percent of the current target number of dedicated nodes, but only if the minimum average CPU usage during the last 10 minutes was above 70 percent.</span></span> <span data-ttu-id="9573c-497">В противном случае используйте значение текущего количества выделенных узлов.</span><span class="sxs-lookup"><span data-stu-id="9573c-497">Otherwise, use the value for the current number of dedicated nodes.</span></span>

```
$totalDedicatedNodes =
    (min($CPUPercent.GetSample(TimeInterval_Minute * 10)) > 0.7) ?
    ($CurrentDedicatedNodes * 1.1) : $CurrentDedicatedNodes;
```

<span data-ttu-id="9573c-498">Для *уменьшения* количества выделенных узлов в периоды низкой загрузки ЦП следующий оператор в формуле присваивает той же переменной `$totalDedicatedNodes` значение, равное 90 % от текущего целевого количества выделенных узлов, если средняя загрузка ЦП за последние 60 минут была ниже 20 %.</span><span class="sxs-lookup"><span data-stu-id="9573c-498">To *decrease* the number of dedicated nodes during low CPU usage, the next statement in our formula sets the same `$totalDedicatedNodes` variable to 90 percent of the current target number of dedicated nodes if the average CPU usage in the past 60 minutes was under 20 percent.</span></span> <span data-ttu-id="9573c-499">В противном случае будет использоваться текущее значение переменной `$totalDedicatedNodes`, заполненное в приведенной выше инструкции.</span><span class="sxs-lookup"><span data-stu-id="9573c-499">Otherwise, use the current value of `$totalDedicatedNodes` that we populated in the statement above.</span></span>

```
$totalDedicatedNodes =
    (avg($CPUPercent.GetSample(TimeInterval_Minute * 60)) < 0.2) ?
    ($CurrentDedicatedNodes * 0.9) : $totalDedicatedNodes;
```

<span data-ttu-id="9573c-500">Теперь мы ограничим целевое количество выделенных вычислительных узлов максимальным значением 400:</span><span class="sxs-lookup"><span data-stu-id="9573c-500">Now limit the target number of dedicated compute nodes to a maximum of 400:</span></span>

```
$TargetDedicatedNodes = min(400, $totalDedicatedNodes)
```

<span data-ttu-id="9573c-501">Вот полная формула:</span><span class="sxs-lookup"><span data-stu-id="9573c-501">Here's the complete formula:</span></span>

```
$totalDedicatedNodes =
    (min($CPUPercent.GetSample(TimeInterval_Minute * 10)) > 0.7) ?
    ($CurrentDedicatedNodes * 1.1) : $CurrentDedicatedNodes;
$totalDedicatedNodes =
    (avg($CPUPercent.GetSample(TimeInterval_Minute * 60)) < 0.2) ?
    ($CurrentDedicatedNodes * 0.9) : $totalDedicatedNodes;
$TargetDedicatedNodes = min(400, $totalDedicatedNodes)
```

## <a name="create-an-autoscale-enabled-pool-with-net"></a><span data-ttu-id="9573c-502">Создание пула с поддержкой автомасштабирования с помощью .NET</span><span class="sxs-lookup"><span data-stu-id="9573c-502">Create an autoscale-enabled pool with .NET</span></span>

<span data-ttu-id="9573c-503">Чтобы создать пул с поддержкой автомасштабирования в .NET, выполните указанные ниже действия.</span><span class="sxs-lookup"><span data-stu-id="9573c-503">To create a pool with autoscaling enabled in .NET, follow these steps:</span></span>

1. <span data-ttu-id="9573c-504">Создайте пул с помощью метода [BatchClient.PoolOperations.CreatePool](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.pooloperations.createpool).</span><span class="sxs-lookup"><span data-stu-id="9573c-504">Create the pool with [BatchClient.PoolOperations.CreatePool](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.pooloperations.createpool).</span></span>
2. <span data-ttu-id="9573c-505">Задайте для свойства [CloudPool.AutoScaleEnabled](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.autoscaleenabled) значение `true`.</span><span class="sxs-lookup"><span data-stu-id="9573c-505">Set the [CloudPool.AutoScaleEnabled](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.autoscaleenabled) property to `true`.</span></span>
3. <span data-ttu-id="9573c-506">Задайте свойство [CloudPool.AutoScaleFormula](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.autoscaleformula) с помощью формулы автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-506">Set the [CloudPool.AutoScaleFormula](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.autoscaleformula) property with your autoscale formula.</span></span>
4. <span data-ttu-id="9573c-507">(Необязательно.) Задайте свойство [CloudPool.AutoScaleEvaluationInterval](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.autoscaleevaluationinterval) (значение по умолчанию — 15 минут).</span><span class="sxs-lookup"><span data-stu-id="9573c-507">(Optional) Set the [CloudPool.AutoScaleEvaluationInterval](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.autoscaleevaluationinterval) property (default is 15 minutes).</span></span>
5. <span data-ttu-id="9573c-508">Зафиксируйте пул с помощью метода [CloudPool.Commit](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.commit) или [CommitAsync](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.commitasync).</span><span class="sxs-lookup"><span data-stu-id="9573c-508">Commit the pool with [CloudPool.Commit](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.commit) or [CommitAsync](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.commitasync).</span></span>

<span data-ttu-id="9573c-509">В следующем фрагменте кода создается пул с поддержкой автомасштабирования в .NET.</span><span class="sxs-lookup"><span data-stu-id="9573c-509">The following code snippet creates an autoscale-enabled pool in .NET.</span></span> <span data-ttu-id="9573c-510">Формула автомасштабирования пула устанавливает целевое количество выделенных узлов равным 5 по понедельникам и равным 1 в остальные дни недели.</span><span class="sxs-lookup"><span data-stu-id="9573c-510">The pool's autoscale formula sets the target number of dedicated nodes to 5 on Mondays, and 1 on every other day of the week.</span></span> <span data-ttu-id="9573c-511">[Интервал автомасштабирования](#automatic-scaling-interval) составляет 30 минут.</span><span class="sxs-lookup"><span data-stu-id="9573c-511">The [automatic scaling interval](#automatic-scaling-interval) is set to 30 minutes.</span></span> <span data-ttu-id="9573c-512">В этом и других фрагментах кода C#, приведенных в этой статье, `myBatchClient` представляет собой правильно инициализированный экземпляр класса [BatchClient][net_batchclient].</span><span class="sxs-lookup"><span data-stu-id="9573c-512">In this and the other C# snippets in this article, `myBatchClient` is a properly initialized instance of the [BatchClient][net_batchclient] class.</span></span>

```csharp
CloudPool pool = myBatchClient.PoolOperations.CreatePool(
                    poolId: "mypool",
                    virtualMachineSize: "small", // single-core, 1.75 GB memory, 225 GB disk
                    cloudServiceConfiguration: new CloudServiceConfiguration(osFamily: "5"));    
pool.AutoScaleEnabled = true;
pool.AutoScaleFormula = "$TargetDedicatedNodes = (time().weekday == 1 ? 5:1);";
pool.AutoScaleEvaluationInterval = TimeSpan.FromMinutes(30);
await pool.CommitAsync();
```

> [!IMPORTANT]
> <span data-ttu-id="9573c-513">При создании пула с поддержкой автомасштабирования не указывайте параметр _targetDedicatedComputeNodes_ или _targetLowPriorityComputeNodes_ в вызове **CreatePool**.</span><span class="sxs-lookup"><span data-stu-id="9573c-513">When you create an autoscale-enabled pool, do not specify the _targetDedicatedComputeNodes_ parameter or the _targetLowPriorityComputeNodes_ parameter on the call to **CreatePool**.</span></span> <span data-ttu-id="9573c-514">Вместо этого укажите свойства **AutoScaleEnabled** и **AutoScaleFormula** для пула.</span><span class="sxs-lookup"><span data-stu-id="9573c-514">Instead, specify the **AutoScaleEnabled** and **AutoScaleFormula** properties on the pool.</span></span> <span data-ttu-id="9573c-515">Значения этих свойств определяют целевое количество каждого типа узлов.</span><span class="sxs-lookup"><span data-stu-id="9573c-515">The values for these properties determine the target number of each type of node.</span></span> <span data-ttu-id="9573c-516">Кроме того, чтобы вручную изменить размер пула с включенным автомасштабированием (например, с помощью [BatchClient.PoolOperations.ResizePoolAsync][net_poolops_resizepoolasync]), сначала **отключите** автомасштабирование пула, а затем измените его размер.</span><span class="sxs-lookup"><span data-stu-id="9573c-516">Also, to manually resize an autoscale-enabled pool (for example, with [BatchClient.PoolOperations.ResizePoolAsync][net_poolops_resizepoolasync]), first **disable** automatic scaling on the pool, then resize it.</span></span>
>
>

<span data-ttu-id="9573c-517">Кроме библиотеки .NET пакетной службы, для настройки автомасштабирования можно использовать любые другие [пакеты SDK пакетной службы](batch-apis-tools.md#azure-accounts-for-batch-development), [Batch REST](https://docs.microsoft.com/rest/api/batchservice/), [командлеты PowerShell пакетной службы](batch-powershell-cmdlets-get-started.md) и [интерфейс командной строки пакетной службы](batch-cli-get-started.md).</span><span class="sxs-lookup"><span data-stu-id="9573c-517">In addition to Batch .NET, you can use any of the other [Batch SDKs](batch-apis-tools.md#azure-accounts-for-batch-development), [Batch REST](https://docs.microsoft.com/rest/api/batchservice/), [Batch PowerShell cmdlets](batch-powershell-cmdlets-get-started.md), and the [Batch CLI](batch-cli-get-started.md) to configure autoscaling.</span></span>


### <a name="automatic-scaling-interval"></a><span data-ttu-id="9573c-518">Интервал автоматического масштабирования</span><span class="sxs-lookup"><span data-stu-id="9573c-518">Automatic scaling interval</span></span>
<span data-ttu-id="9573c-519">По умолчанию пакетная служба изменяет размер пула по указанной формуле автомасштабирования каждые 15 минут.</span><span class="sxs-lookup"><span data-stu-id="9573c-519">By default, the Batch service adjusts a pool's size according to its autoscale formula every 15 minutes.</span></span> <span data-ttu-id="9573c-520">Этот интервал можно настроить с помощью следующих свойств пула:</span><span class="sxs-lookup"><span data-stu-id="9573c-520">This interval is configurable by using the following pool properties:</span></span>

* <span data-ttu-id="9573c-521">[CloudPool.AutoScaleEvaluationInterval][net_cloudpool_autoscaleevalinterval] (.NET пакетной службы)</span><span class="sxs-lookup"><span data-stu-id="9573c-521">[CloudPool.AutoScaleEvaluationInterval][net_cloudpool_autoscaleevalinterval] (Batch .NET)</span></span>
* <span data-ttu-id="9573c-522">[autoScaleEvaluationInterval][rest_autoscaleinterval] (REST API)</span><span class="sxs-lookup"><span data-stu-id="9573c-522">[autoScaleEvaluationInterval][rest_autoscaleinterval] (REST API)</span></span>

<span data-ttu-id="9573c-523">Минимальный интервал составляет пять минут, а максимальный — 168 часов.</span><span class="sxs-lookup"><span data-stu-id="9573c-523">The minimum interval is five minutes, and the maximum is 168 hours.</span></span> <span data-ttu-id="9573c-524">Если указан интервал за пределами этого диапазона, пакетная служба возвращает ошибку "Неправильный запрос (400)".</span><span class="sxs-lookup"><span data-stu-id="9573c-524">If an interval outside this range is specified, the Batch service returns a Bad Request (400) error.</span></span>

> [!NOTE]
> <span data-ttu-id="9573c-525">В настоящее время автоматическое масштабирование предназначено не для реагирования на изменения в течение нескольких секунд, а для постепенного изменения размера пула в ходе выполнения рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="9573c-525">Autoscaling is not currently intended to respond to changes in less than a minute, but rather is intended to adjust the size of your pool gradually as you run a workload.</span></span>
>
>

## <a name="enable-autoscaling-on-an-existing-pool"></a><span data-ttu-id="9573c-526">Включение автомасштабирования в имеющемся пуле</span><span class="sxs-lookup"><span data-stu-id="9573c-526">Enable autoscaling on an existing pool</span></span>

<span data-ttu-id="9573c-527">Каждый пакет SDK пакетной службы предоставляет способ включения автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-527">Each Batch SDK provides a way to enable autoscaling.</span></span> <span data-ttu-id="9573c-528">Например:</span><span class="sxs-lookup"><span data-stu-id="9573c-528">For example:</span></span>

* <span data-ttu-id="9573c-529">[BatchClient.PoolOperations.EnableAutoScaleAsync][net_enableautoscaleasync] (библиотека .NET пакетной службы)</span><span class="sxs-lookup"><span data-stu-id="9573c-529">[BatchClient.PoolOperations.EnableAutoScaleAsync][net_enableautoscaleasync] (Batch .NET)</span></span>
* <span data-ttu-id="9573c-530">[Включение автомасштабирования пула][rest_enableautoscale] (REST API)</span><span class="sxs-lookup"><span data-stu-id="9573c-530">[Enable automatic scaling on a pool][rest_enableautoscale] (REST API)</span></span>

<span data-ttu-id="9573c-531">При включении автомасштабирования в имеющемся пуле учитывайте указанные ниже условия.</span><span class="sxs-lookup"><span data-stu-id="9573c-531">When you enable autoscaling on an existing pool, keep in mind the following points:</span></span>

* <span data-ttu-id="9573c-532">Если автомасштабирование в пуле отключено при выполнении запроса на включение автомасштабирования, необходимо указать допустимую формулу автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-532">If automatic scaling is currently disabled on the pool when you issue the request to enable autoscaling, you must specify a valid autoscale formula when you issue the request.</span></span> <span data-ttu-id="9573c-533">При необходимости можно указать интервал оценки автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-533">You can optionally specify an autoscale evaluation interval.</span></span> <span data-ttu-id="9573c-534">Если интервал не указан, используется значение по умолчанию, равное 15 минутам.</span><span class="sxs-lookup"><span data-stu-id="9573c-534">If you do not specify an interval, the default value of 15 minutes is used.</span></span>
* <span data-ttu-id="9573c-535">Если в пуле включено автомасштабирование, можно указать формулу автомасштабирования, интервал оценки либо и то, и другое.</span><span class="sxs-lookup"><span data-stu-id="9573c-535">If autoscale is currently enabled on the pool, you can specify an autoscale formula, an evaluation interval, or both.</span></span> <span data-ttu-id="9573c-536">Необходимо указать по крайней мере одно из этих свойств.</span><span class="sxs-lookup"><span data-stu-id="9573c-536">You must specify at least one of these properties.</span></span>

  * <span data-ttu-id="9573c-537">Если указать новый интервал оценки автомасштабирования, имеющееся расписание оценки будет остановлено и запустится новое.</span><span class="sxs-lookup"><span data-stu-id="9573c-537">If you specify a new autoscale evaluation interval, then the existing evaluation schedule is stopped and a new schedule is started.</span></span> <span data-ttu-id="9573c-538">Время начала нового расписания — это время подачи запроса на включение автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-538">The new schedule's start time is the time at which the request to enable autoscaling was issued.</span></span>
  * <span data-ttu-id="9573c-539">Если опустить формулу автомасштабирования или интервал оценки, в пакетной службе и далее будет использоваться текущее значение этого параметра.</span><span class="sxs-lookup"><span data-stu-id="9573c-539">If you omit either the autoscale formula or evaluation interval, the Batch service continues to use the current value of that setting.</span></span>

> [!NOTE]
> <span data-ttu-id="9573c-540">Если во время создания пула в .NET было указано значение параметра *targetDedicatedComputeNodes* или *targetLowPriorityComputeNodes* метода **CreatePool** либо аналогичных параметров в другом языке, эти значения игнорируются во время вычисления формулы автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-540">If you specified values for the *targetDedicatedComputeNodes* or *targetLowPriorityComputeNodes* parameters of the **CreatePool** method when you created the pool in .NET, or for the comparable parameters in another language, then those values are ignored when the automatic scaling formula is evaluated.</span></span>
>
>

<span data-ttu-id="9573c-541">В этом фрагменте кода C# для включения автомасштабирования в имеющемся пуле используется библиотека [.NET пакетной службы][net_api].</span><span class="sxs-lookup"><span data-stu-id="9573c-541">This C# code snippet uses the [Batch .NET][net_api] library to enable autoscaling on an existing pool:</span></span>

```csharp
// Define the autoscaling formula. This formula sets the target number of nodes
// to 5 on Mondays, and 1 on every other day of the week
string myAutoScaleFormula = "$TargetDedicatedNodes = (time().weekday == 1 ? 5:1);";

// Set the autoscale formula on the existing pool
await myBatchClient.PoolOperations.EnableAutoScaleAsync(
    "myexistingpool",
    autoscaleFormula: myAutoScaleFormula);
```

### <a name="update-an-autoscale-formula"></a><span data-ttu-id="9573c-542">Обновление формулы автомасштабирования</span><span class="sxs-lookup"><span data-stu-id="9573c-542">Update an autoscale formula</span></span>

<span data-ttu-id="9573c-543">Чтобы обновить формулу для существующего пула с поддержкой автомасштабирования, вызовите операцию для включения автомасштабирования еще раз с новой формулой.</span><span class="sxs-lookup"><span data-stu-id="9573c-543">To update the formula on an existing autoscale-enabled pool, call the operation to enable autoscaling again with the new formula.</span></span> <span data-ttu-id="9573c-544">Например, если при выполнении приведенного ниже кода .NET автомасштабирование уже включено в `myexistingpool`, формула автомасштабирования заменяется содержимым `myNewFormula`.</span><span class="sxs-lookup"><span data-stu-id="9573c-544">For example, if autoscaling is already enabled on `myexistingpool` when the following .NET code is executed, its autoscale formula is replaced with the contents of `myNewFormula`.</span></span>

```csharp
await myBatchClient.PoolOperations.EnableAutoScaleAsync(
    "myexistingpool",
    autoscaleFormula: myNewFormula);
```

### <a name="update-the-autoscale-interval"></a><span data-ttu-id="9573c-545">Обновление интервала автомасштабирования</span><span class="sxs-lookup"><span data-stu-id="9573c-545">Update the autoscale interval</span></span>

<span data-ttu-id="9573c-546">Чтобы обновить интервал оценки автомасштабирования для существующего пула с поддержкой автомасштабирования, вызовите операцию для включения автомасштабирования еще раз с новым интервалом.</span><span class="sxs-lookup"><span data-stu-id="9573c-546">To update the autoscale evaluation interval of an existing autoscale-enabled pool, call the operation to enable autoscaling again with the new interval.</span></span> <span data-ttu-id="9573c-547">Например, чтобы задать для интервала оценки автомасштабирования значение 60 минут в пуле с уже включенным автомасштабированием, необходимо сделать следующее:</span><span class="sxs-lookup"><span data-stu-id="9573c-547">For example, to set the autoscale evaluation interval to 60 minutes for a pool that's already autoscale-enabled in .NET:</span></span>

```csharp
await myBatchClient.PoolOperations.EnableAutoScaleAsync(
    "myexistingpool",
    autoscaleEvaluationInterval: TimeSpan.FromMinutes(60));
```

## <a name="evaluate-an-autoscale-formula"></a><span data-ttu-id="9573c-548">Оценка формулы автомасштабирования</span><span class="sxs-lookup"><span data-stu-id="9573c-548">Evaluate an autoscale formula</span></span>

<span data-ttu-id="9573c-549">Прежде чем применить формулу к пулу, ее можно оценить.</span><span class="sxs-lookup"><span data-stu-id="9573c-549">You can evaluate a formula before applying it to a pool.</span></span> <span data-ttu-id="9573c-550">Таким образом, можно протестировать формулу, чтобы увидеть, как ее операторы выполняют вычисления, до запуска формулы в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="9573c-550">In this way, you can test the formula to see how its statements evaluate before you put the formula into production.</span></span>

<span data-ttu-id="9573c-551">Чтобы вычислить формулу автомасштабирования, сначала необходимо включить автомасштабирование в пуле с помощью допустимой формулы.</span><span class="sxs-lookup"><span data-stu-id="9573c-551">To evaluate an autoscale formula, you must first enable autoscaling on the pool with a valid formula.</span></span> <span data-ttu-id="9573c-552">Чтобы протестировать формулу в пуле, в котором еще не включено автомасштабирование, используйте формулу с одной строкой `$TargetDedicatedNodes = 0` при первом включении автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-552">To test a formula on a pool that doesn't yet have autoscaling enabled, use the one-line formula `$TargetDedicatedNodes = 0` when you first enable autoscaling.</span></span> <span data-ttu-id="9573c-553">Затем для оценки формулы, которую требуется протестировать, выполните одно из следующих действий:</span><span class="sxs-lookup"><span data-stu-id="9573c-553">Then, use one of the following to evaluate the formula you want to test:</span></span>

* <span data-ttu-id="9573c-554">Вызовите метод [BatchClient.PoolOperations.EvaluateAutoScale](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.pooloperations.evaluateautoscale) или [EvaluateAutoScaleAsync](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.pooloperations.evaluateautoscaleasync).</span><span class="sxs-lookup"><span data-stu-id="9573c-554">[BatchClient.PoolOperations.EvaluateAutoScale](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.pooloperations.evaluateautoscale) or [EvaluateAutoScaleAsync](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.pooloperations.evaluateautoscaleasync)</span></span>

    <span data-ttu-id="9573c-555">Для выполнения оценки этим методам .NET пакетной службы требуется идентификатор имеющегося пула и строка, содержащая формулу автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-555">These Batch .NET methods require the ID of an existing pool and a string containing the autoscale formula to evaluate.</span></span>

* [<span data-ttu-id="9573c-556">Оцените формулу автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-556">Evaluate an automatic scaling formula</span></span>](https://docs.microsoft.com/rest/api/batchservice/evaluate-an-automatic-scaling-formula)

    <span data-ttu-id="9573c-557">В этом запросе REST API укажите идентификатор пула в универсальном коде ресурса и формулу автомасштабирования в элементе *autoScaleFormula* текста запроса.</span><span class="sxs-lookup"><span data-stu-id="9573c-557">In this REST API request, specify the pool ID in the URI, and the autoscale formula in the *autoScaleFormula* element of the request body.</span></span> <span data-ttu-id="9573c-558">Ответ операции содержит все сведения об ошибках, которые могут быть связаны с формулой.</span><span class="sxs-lookup"><span data-stu-id="9573c-558">The response of the operation contains any error information that might be related to the formula.</span></span>

<span data-ttu-id="9573c-559">В этом фрагменте кода [.NET пакетной службы][net_api] вычисляется формула автомасштабирования.</span><span class="sxs-lookup"><span data-stu-id="9573c-559">In this [Batch .NET][net_api] code snippet, we evaluate an autoscale formula.</span></span> <span data-ttu-id="9573c-560">Если в пуле не включено автомасштабирование, сначала необходимо его включить.</span><span class="sxs-lookup"><span data-stu-id="9573c-560">If the pool does not have autoscaling enabled, we enable it first.</span></span>

```csharp
// First obtain a reference to an existing pool
CloudPool pool = await batchClient.PoolOperations.GetPoolAsync("myExistingPool");

// If autoscaling isn't already enabled on the pool, enable it.
// You can't evaluate an autoscale formula on non-autoscale-enabled pool.
if (pool.AutoScaleEnabled == false)
{
    // We need a valid autoscale formula to enable autoscaling on the
    // pool. This formula is valid, but won't resize the pool:
    await pool.EnableAutoScaleAsync(
        autoscaleFormula: "$TargetDedicatedNodes = {pool.CurrentDedicatedNodes};",
        autoscaleEvaluationInterval: TimeSpan.FromMinutes(5));

    // Batch limits EnableAutoScaleAsync calls to once every 30 seconds.
    // Because we want to apply our new autoscale formula below if it
    // evaluates successfully, and we *just* enabled autoscaling on
    // this pool, we pause here to ensure we pass that threshold.
    Thread.Sleep(TimeSpan.FromSeconds(31));

    // Refresh the properties of the pool so that we've got the
    // latest value for AutoScaleEnabled
    await pool.RefreshAsync();
}

// We must ensure that autoscaling is enabled on the pool prior to
// evaluating a formula
if (pool.AutoScaleEnabled == true)
{
    // The formula to evaluate - adjusts target number of nodes based on
    // day of week and time of day
    string myFormula = @"
        $curTime = time();
        $workHours = $curTime.hour >= 8 && $curTime.hour < 18;
        $isWeekday = $curTime.weekday >= 1 && $curTime.weekday <= 5;
        $isWorkingWeekdayHour = $workHours && $isWeekday;
        $TargetDedicatedNodes = $isWorkingWeekdayHour ? 20:10;
    ";

    // Perform the autoscale formula evaluation. Note that this code does not
    // actually apply the formula to the pool.
    AutoScaleRun eval =
        await batchClient.PoolOperations.EvaluateAutoScaleAsync(pool.Id, myFormula);

    if (eval.Error == null)
    {
        // Evaluation success - print the results of the AutoScaleRun.
        // This will display the values of each variable as evaluated by the
        // autoscale formula.
        Console.WriteLine("AutoScaleRun.Results: " +
            eval.Results.Replace("$", "\n    $"));

        // Apply the formula to the pool since it evaluated successfully
        await batchClient.PoolOperations.EnableAutoScaleAsync(pool.Id, myFormula);
    }
    else
    {
        // Evaluation failed, output the message associated with the error
        Console.WriteLine("AutoScaleRun.Error.Message: " +
            eval.Error.Message);
    }
}
```

<span data-ttu-id="9573c-561">В случае успешного вычисления формулы, показанной в этом фрагменте, будет получен результат, подобный следующему:</span><span class="sxs-lookup"><span data-stu-id="9573c-561">Successful evaluation of the formula shown in this code snippet produces results similar to:</span></span>

```
AutoScaleRun.Results:
    $TargetDedicatedNodes=10;
    $NodeDeallocationOption=requeue;
    $curTime=2016-10-13T19:18:47.805Z;
    $isWeekday=1;
    $isWorkingWeekdayHour=0;
    $workHours=0
```

## <a name="get-information-about-autoscale-runs"></a><span data-ttu-id="9573c-562">Получение сведений о выполнениях автомасштабирования</span><span class="sxs-lookup"><span data-stu-id="9573c-562">Get information about autoscale runs</span></span>

<span data-ttu-id="9573c-563">Чтобы убедиться в том, что формула работает правильно, мы рекомендуем периодически проверять результаты автомасштабирования, которое пакетная служба выполняет в пуле.</span><span class="sxs-lookup"><span data-stu-id="9573c-563">To ensure that your formula is performing as expected, we recommend that you periodically check the results of the autoscaling runs that Batch performs on your pool.</span></span> <span data-ttu-id="9573c-564">Чтобы сделать это, получите (или обновите) ссылку на пул и проверьте свойства последнего выполнения автомасштабирования в этом пуле.</span><span class="sxs-lookup"><span data-stu-id="9573c-564">To do so, get (or refresh) a reference to the pool, and examine the properties of its last autoscale run.</span></span>

<span data-ttu-id="9573c-565">В .NET пакетной службы свойство [CloudPool.AutoScaleRun](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.autoscalerun) обладает несколькими свойствами, которые предоставляют сведения о последнем выполнении автомасштабирования в пуле.</span><span class="sxs-lookup"><span data-stu-id="9573c-565">In Batch .NET, the [CloudPool.AutoScaleRun](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.autoscalerun) property has several properties that provide information about the latest automatic scaling run performed on the pool:</span></span>

* [<span data-ttu-id="9573c-566">AutoScaleRun.Timestamp.</span><span class="sxs-lookup"><span data-stu-id="9573c-566">AutoScaleRun.Timestamp</span></span>](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.autoscalerun.timestamp)
* [<span data-ttu-id="9573c-567">AutoScaleRun.Results;</span><span class="sxs-lookup"><span data-stu-id="9573c-567">AutoScaleRun.Results</span></span>](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.autoscalerun.results)
* [<span data-ttu-id="9573c-568">AutoScaleRun.Error;</span><span class="sxs-lookup"><span data-stu-id="9573c-568">AutoScaleRun.Error</span></span>](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.autoscalerun.error)

<span data-ttu-id="9573c-569">В REST API запрос [Получение сведений о пуле](https://docs.microsoft.com/rest/api/batchservice/get-information-about-a-pool) возвращает сведения о пуле, в том числе результаты последнего выполнения автомасштабирования, в свойстве [autoScaleRun](https://docs.microsoft.com/rest/api/batchservice/get-information-about-a-pool#bk_autrun).</span><span class="sxs-lookup"><span data-stu-id="9573c-569">In the REST API, the [Get information about a pool](https://docs.microsoft.com/rest/api/batchservice/get-information-about-a-pool) request returns information about the pool, which includes the latest automatic scaling run information in the [autoScaleRun](https://docs.microsoft.com/rest/api/batchservice/get-information-about-a-pool#bk_autrun) property.</span></span>

<span data-ttu-id="9573c-570">В следующем фрагменте кода C# для вывода сведений о последнем выполнении автомасштабирования в пуле _myPool_ используется библиотека .NET пакетной службы:</span><span class="sxs-lookup"><span data-stu-id="9573c-570">The following C# code snippet uses the Batch .NET library to print information about the last autoscaling run on pool _myPool_:</span></span>

```csharp
await Cloud pool = myBatchClient.PoolOperations.GetPoolAsync("myPool");
Console.WriteLine("Last execution: " + pool.AutoScaleRun.Timestamp);
Console.WriteLine("Result:" + pool.AutoScaleRun.Results.Replace("$", "\n  $"));
Console.WriteLine("Error: " + pool.AutoScaleRun.Error);
```

<span data-ttu-id="9573c-571">Пример выходных данных в результате выполнения предыдущего фрагмента:</span><span class="sxs-lookup"><span data-stu-id="9573c-571">Sample output of the preceding snippet:</span></span>

```
Last execution: 10/14/2016 18:36:43
Result:
  $TargetDedicatedNodes=10;
  $NodeDeallocationOption=requeue;
  $curTime=2016-10-14T18:36:43.282Z;
  $isWeekday=1;
  $isWorkingWeekdayHour=0;
  $workHours=0
Error:
```

## <a name="example-autoscale-formulas"></a><span data-ttu-id="9573c-572">Примеры формул автомасштабирования</span><span class="sxs-lookup"><span data-stu-id="9573c-572">Example autoscale formulas</span></span>
<span data-ttu-id="9573c-573">Давайте рассмотрим некоторые формулы, которые демонстрируют различные способы настройки количества вычислительных ресурсов в пуле.</span><span class="sxs-lookup"><span data-stu-id="9573c-573">Let's look at a few formulas that show different ways to adjust the amount of compute resources in a pool.</span></span>

### <a name="example-1-time-based-adjustment"></a><span data-ttu-id="9573c-574">Пример 1. Изменение с учетом времени</span><span class="sxs-lookup"><span data-stu-id="9573c-574">Example 1: Time-based adjustment</span></span>
<span data-ttu-id="9573c-575">Предположим, вы хотите изменять размер пула в зависимости от дня недели и времени дня.</span><span class="sxs-lookup"><span data-stu-id="9573c-575">Suppose you want to adjust the pool size based on the day of the week and time of day.</span></span> <span data-ttu-id="9573c-576">В этом примере показано, как уменьшать и увеличивать количество узлов в пуле соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="9573c-576">This example shows how to increase or decrease the number of nodes in the pool accordingly.</span></span>

<span data-ttu-id="9573c-577">Формула сначала получает значение текущего времени.</span><span class="sxs-lookup"><span data-stu-id="9573c-577">The formula first obtains the current time.</span></span> <span data-ttu-id="9573c-578">В рабочие дни (1–5) и часы (8:00–18:00) целевой размер пула равен 20 узлам.</span><span class="sxs-lookup"><span data-stu-id="9573c-578">If it's a weekday (1-5) and within working hours (8 AM to 6 PM), the target pool size is set to 20 nodes.</span></span> <span data-ttu-id="9573c-579">В противном случае он равен 10 узлам.</span><span class="sxs-lookup"><span data-stu-id="9573c-579">Otherwise, it's set to 10 nodes.</span></span>

```
$curTime = time();
$workHours = $curTime.hour >= 8 && $curTime.hour < 18;
$isWeekday = $curTime.weekday >= 1 && $curTime.weekday <= 5;
$isWorkingWeekdayHour = $workHours && $isWeekday;
$TargetDedicatedNodes = $isWorkingWeekdayHour ? 20:10;
```

### <a name="example-2-task-based-adjustment"></a><span data-ttu-id="9573c-580">Пример 2. Изменение с учетом задачи</span><span class="sxs-lookup"><span data-stu-id="9573c-580">Example 2: Task-based adjustment</span></span>
<span data-ttu-id="9573c-581">В этом примере размер пула настраивается в зависимости от количества задач в очереди.</span><span class="sxs-lookup"><span data-stu-id="9573c-581">In this example, the pool size is adjusted based on the number of tasks in the queue.</span></span> <span data-ttu-id="9573c-582">В строках формул допускаются как комментарии, так и разрывы строк.</span><span class="sxs-lookup"><span data-stu-id="9573c-582">Both comments and line breaks are acceptable in formula strings.</span></span>

```csharp
// Get pending tasks for the past 15 minutes.
$samples = $ActiveTasks.GetSamplePercent(TimeInterval_Minute * 15);
// If we have fewer than 70 percent data points, we use the last sample point,
// otherwise we use the maximum of last sample point and the history average.
$tasks = $samples < 70 ? max(0,$ActiveTasks.GetSample(1)) : max( $ActiveTasks.GetSample(1), avg($ActiveTasks.GetSample(TimeInterval_Minute * 15)));
// If number of pending tasks is not 0, set targetVM to pending tasks, otherwise
// half of current dedicated.
$targetVMs = $tasks > 0? $tasks:max(0, $TargetDedicatedNodes/2);
// The pool size is capped at 20, if target VM value is more than that, set it
// to 20. This value should be adjusted according to your use case.
$TargetDedicatedNodes = max(0, min($targetVMs, 20));
// Set node deallocation mode - keep nodes active only until tasks finish
$NodeDeallocationOption = taskcompletion;
```

### <a name="example-3-accounting-for-parallel-tasks"></a><span data-ttu-id="9573c-583">Пример 3. Параллельные задачи</span><span class="sxs-lookup"><span data-stu-id="9573c-583">Example 3: Accounting for parallel tasks</span></span>
<span data-ttu-id="9573c-584">В этом примере размер пула изменяется на основе числа задач.</span><span class="sxs-lookup"><span data-stu-id="9573c-584">This example adjusts the pool size based on the number of tasks.</span></span> <span data-ttu-id="9573c-585">В этой формуле также учитывается значение [MaxTasksPerComputeNode][net_maxtasks], которое было задано для пула.</span><span class="sxs-lookup"><span data-stu-id="9573c-585">This formula also takes into account the [MaxTasksPerComputeNode][net_maxtasks] value that has been set for the pool.</span></span> <span data-ttu-id="9573c-586">Такой подход полезен, если в пуле поддерживается [параллельное выполнение задач](batch-parallel-node-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="9573c-586">This approach is useful in situations where [parallel task execution](batch-parallel-node-tasks.md) has been enabled on your pool.</span></span>

```csharp
// Determine whether 70 percent of the samples have been recorded in the past
// 15 minutes; if not, use last sample
$samples = $ActiveTasks.GetSamplePercent(TimeInterval_Minute * 15);
$tasks = $samples < 70 ? max(0,$ActiveTasks.GetSample(1)) : max( $ActiveTasks.GetSample(1),avg($ActiveTasks.GetSample(TimeInterval_Minute * 15)));
// Set the number of nodes to add to one-fourth the number of active tasks (the
// MaxTasksPerComputeNode property on this pool is set to 4, adjust this number
// for your use case)
$cores = $TargetDedicatedNodes * 4;
$extraVMs = (($tasks - $cores) + 3) / 4;
$targetVMs = ($TargetDedicatedNodes + $extraVMs);
// Attempt to grow the number of compute nodes to match the number of active
// tasks, with a maximum of 3
$TargetDedicatedNodes = max(0,min($targetVMs,3));
// Keep the nodes active until the tasks finish
$NodeDeallocationOption = taskcompletion;
```

### <a name="example-4-setting-an-initial-pool-size"></a><span data-ttu-id="9573c-587">Пример 4. Настройка исходного размера пула</span><span class="sxs-lookup"><span data-stu-id="9573c-587">Example 4: Setting an initial pool size</span></span>
<span data-ttu-id="9573c-588">В этом примере показан фрагмент кода C# с формулой автомасштабирования, которая задает в качестве размера пула определенное число узлов на начальный период времени.</span><span class="sxs-lookup"><span data-stu-id="9573c-588">This example shows a C# code snippet with an autoscale formula that sets the pool size to a specified number of nodes for an initial time period.</span></span> <span data-ttu-id="9573c-589">Затем он корректирует размер пула на основе количества запущенных и активных задач по истечению начального периода времени.</span><span class="sxs-lookup"><span data-stu-id="9573c-589">Then it adjusts the pool size based on the number of running and active tasks after the initial time period has elapsed.</span></span>

<span data-ttu-id="9573c-590">Формула в приведенном ниже фрагменте кода выполняет следующие действия.</span><span class="sxs-lookup"><span data-stu-id="9573c-590">The formula in the following code snippet:</span></span>

* <span data-ttu-id="9573c-591">Она задает исходный размер пула в 4 узла.</span><span class="sxs-lookup"><span data-stu-id="9573c-591">Sets the initial pool size to four nodes.</span></span>
* <span data-ttu-id="9573c-592">Не изменяет размер пула в течение первых 10 минут его жизненного цикла.</span><span class="sxs-lookup"><span data-stu-id="9573c-592">Does not adjust the pool size within the first 10 minutes of the pool's lifecycle.</span></span>
* <span data-ttu-id="9573c-593">После первых 10 минут она получает максимальное количество запущенных и активных задач за последние 60 минут.</span><span class="sxs-lookup"><span data-stu-id="9573c-593">After 10 minutes, obtains the max value of the number of running and active tasks within the past 60 minutes.</span></span>
  * <span data-ttu-id="9573c-594">Если оба значения равны 0 (то есть за 60 минут не было ни активных, ни запущенных задач), то размер пула устанавливается в 0.</span><span class="sxs-lookup"><span data-stu-id="9573c-594">If both values are 0 (indicating that no tasks were running or active in the last 60 minutes), the pool size is set to 0.</span></span>
  * <span data-ttu-id="9573c-595">Если любое из значений больше нуля, изменений не производится.</span><span class="sxs-lookup"><span data-stu-id="9573c-595">If either value is greater than zero, no change is made.</span></span>

```csharp
string now = DateTime.UtcNow.ToString("r");
string formula = string.Format(@"
    $TargetDedicatedNodes = {1};
    lifespan         = time() - time(""{0}"");
    span             = TimeInterval_Minute * 60;
    startup          = TimeInterval_Minute * 10;
    ratio            = 50;

    $TargetDedicatedNodes = (lifespan > startup ? (max($RunningTasks.GetSample(span, ratio), $ActiveTasks.GetSample(span, ratio)) == 0 ? 0 : $TargetDedicatedNodes) : {1});
    ", now, 4);
```

## <a name="next-steps"></a><span data-ttu-id="9573c-596">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="9573c-596">Next steps</span></span>
* <span data-ttu-id="9573c-597">[Повышение эффективности вычислительных ресурсов в пакетной службе Azure благодаря параллельному выполнению задач на узлах](batch-parallel-node-tasks.md) содержит сведения о том, как можно одновременно выполнять несколько задач на вычислительных узлах пула.</span><span class="sxs-lookup"><span data-stu-id="9573c-597">[Maximize Azure Batch compute resource usage with concurrent node tasks](batch-parallel-node-tasks.md) contains details about how you can execute multiple tasks simultaneously on the compute nodes in your pool.</span></span> <span data-ttu-id="9573c-598">Помимо автоматического масштабирования, эта функция позволяет уменьшить длительность выполнения заданий для некоторых рабочих нагрузок, тем самым обеспечивая сокращение затрат.</span><span class="sxs-lookup"><span data-stu-id="9573c-598">In addition to autoscaling, this feature may help to lower job duration for some workloads, saving you money.</span></span>
* <span data-ttu-id="9573c-599">Еще одна возможность повысить эффективность — гарантировать, что приложение пакетной службы отправляет запросы в пакетную службу наиболее оптимальным способом.</span><span class="sxs-lookup"><span data-stu-id="9573c-599">For another efficiency booster, ensure that your Batch application queries the Batch service in the most optimal way.</span></span> <span data-ttu-id="9573c-600">Чтобы узнать, как ограничить объем данных, передаваемых по сети при потенциальном запросе состояния тысяч вычислительных узлов или задач, см. статью [Эффективные запросы к пакетной службе Azure](batch-efficient-list-queries.md).</span><span class="sxs-lookup"><span data-stu-id="9573c-600">See [Query the Azure Batch service efficiently](batch-efficient-list-queries.md) to learn how to limit the amount of data that crosses the wire when you query the status of potentially thousands of compute nodes or tasks.</span></span>

[net_api]: https://docs.microsoft.com/dotnet/api/microsoft.azure.batch
[net_batchclient]: https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.batchclient
[net_cloudpool_autoscaleformula]: https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.autoscaleformula
[net_cloudpool_autoscaleevalinterval]: https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.autoscaleevaluationinterval
[net_enableautoscaleasync]: https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.pooloperations.enableautoscaleasync
[net_maxtasks]: https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudpool.maxtaskspercomputenode
[net_poolops_resizepoolasync]: https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.pooloperations.resizepoolasync

[rest_api]: https://docs.microsoft.com/rest/api/batchservice/
[rest_autoscaleformula]: https://docs.microsoft.com/rest/api/batchservice/enable-automatic-scaling-on-a-pool
[rest_autoscaleinterval]: https://docs.microsoft.com/rest/api/batchservice/enable-automatic-scaling-on-a-pool
[rest_enableautoscale]: https://docs.microsoft.com/rest/api/batchservice/enable-automatic-scaling-on-a-pool

---
title: "Приступая к созданию решений пакетной службы с помощью шаблонов проектов Visual Studio в Azure | Документация Майкрософт"
description: "Узнайте, как шаблоны проектов Visual Studio помогут реализовать и выполнить ресурсоемкие рабочие нагрузки в пакетной службе Azure."
services: batch
documentationcenter: .net
author: fayora
manager: timlt
editor: 
ms.assetid: 5e041ae2-25af-4882-a79e-3aa63c4bfb20
ms.service: batch
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: big-compute
ms.date: 02/27/2017
ms.author: tamram
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: da77ce827c65deb18d9d84ce5cf768d89788e205
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="use-visual-studio-project-templates-to-jump-start-batch-solutions"></a><span data-ttu-id="15092-103">Использование шаблонов проектов Visual Studio для быстрого начала работы с решениями пакетной службы</span><span class="sxs-lookup"><span data-stu-id="15092-103">Use Visual Studio project templates to jump-start Batch solutions</span></span>

<span data-ttu-id="15092-104">Шаблоны Visual Studio **Диспетчер заданий** и **Обработчик задач** для пакетной службы содержат код, позволяющий максимально упростить внедрение и выполнение ресурсоемких рабочих нагрузок в пакетной службе.</span><span class="sxs-lookup"><span data-stu-id="15092-104">The **Job Manager** and **Task Processor Visual Studio templates** for Batch provide code to help you to implement and run your compute-intensive workloads on Batch with the least amount of effort.</span></span> <span data-ttu-id="15092-105">Здесь представлено описание этих шаблонов, а также рекомендации по их использованию.</span><span class="sxs-lookup"><span data-stu-id="15092-105">This document describes these templates and provides guidance for how to use them.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="15092-106">В этой статье приведены сведения, применимые только к этим двум шаблонам. Здесь предполагается, что вы уже знакомы с пакетной службой и основными связанными с ней понятиями: пулы, вычислительные узлы, задания и задачи, задачи диспетчера заданий, переменные среды и другая важная информация.</span><span class="sxs-lookup"><span data-stu-id="15092-106">This article discusses only information applicable to these two templates, and assumes that you are familiar with the Batch service and key concepts related to it: pools, compute nodes, jobs and tasks, job manager tasks, environment variables, and other relevant information.</span></span> <span data-ttu-id="15092-107">Дополнительные сведения см. в статье [Основные сведения о пакетной службе Azure](batch-technical-overview.md), [Обзор функций пакетной службы для разработчиков](batch-api-basics.md) и [Начало работы с библиотекой пакетной службы Azure для .NET](batch-dotnet-get-started.md).</span><span class="sxs-lookup"><span data-stu-id="15092-107">You can find more information in [Basics of Azure Batch](batch-technical-overview.md), [Batch feature overview for developers](batch-api-basics.md), and [Get started with the Azure Batch library for .NET](batch-dotnet-get-started.md).</span></span>
> 
> 

## <a name="high-level-overview"></a><span data-ttu-id="15092-108">Общий обзор</span><span class="sxs-lookup"><span data-stu-id="15092-108">High-level overview</span></span>
<span data-ttu-id="15092-109">С помощью шаблонов "Диспетчер заданий" и "Обработчик задач" можно создать два полезных компонента:</span><span class="sxs-lookup"><span data-stu-id="15092-109">The Job Manager and Task Processor templates can be used to create two useful components:</span></span>

* <span data-ttu-id="15092-110">Задачу диспетчера заданий, позволяющую внедрить разделитель заданий. Благодаря ему можно разбить задание на несколько задач, которые могут выполняться независимо в параллельном режиме.</span><span class="sxs-lookup"><span data-stu-id="15092-110">A job manager task that implements a job splitter that can break a job down into multiple tasks that can run independently, in parallel.</span></span>
* <span data-ttu-id="15092-111">Обработчик задач, использующийся для предварительной обработки и постобработки приложения в командной строке.</span><span class="sxs-lookup"><span data-stu-id="15092-111">A task processor that can be used to perform pre-processing and post-processing around an application command line.</span></span>

<span data-ttu-id="15092-112">Например, при отрисовке фильма разделитель заданий разделяет одно задание на сотни и тысячи отдельных задач, каждая из которых будет обрабатывать отдельные кадры.</span><span class="sxs-lookup"><span data-stu-id="15092-112">For example, in a movie rendering scenario, the job splitter would turn a single movie job into hundreds or thousands of separate tasks that would process individual frames separately.</span></span> <span data-ttu-id="15092-113">Соответственно, обработчик задач вызывает приложение для отрисовки и все зависимые процессы, необходимые для отрисовки каждого кадра и выполнения дополнительных действий (например, копирование отрисованного кадра в хранилище).</span><span class="sxs-lookup"><span data-stu-id="15092-113">Correspondingly, the task processor would invoke the rendering application and all dependent processes that are needed to render each frame, as well as perform any additional actions (for example, copying the rendered frame to a storage location).</span></span>

> [!NOTE]
> <span data-ttu-id="15092-114">Шаблоны "Диспетчер заданий" и "Обработчик задач" независимы друг от друга, поэтому в зависимости от требований вычислительного задания и предпочтений можно использовать оба шаблона или только один из них.</span><span class="sxs-lookup"><span data-stu-id="15092-114">The Job Manager and Task Processor templates are independent of each other, so you can choose to use both, or only one of them, depending on the requirements of your compute job and on your preferences.</span></span>
> 
> 

<span data-ttu-id="15092-115">Как показано на схеме ниже, вычислительное задание, в котором используются эти шаблоны, проходит через три этапа:</span><span class="sxs-lookup"><span data-stu-id="15092-115">As shown in the diagram below, a compute job that uses these templates will go through three stages:</span></span>

1. <span data-ttu-id="15092-116">Код клиента (например, приложения, веб-службы и т. д.) отправляет задание в пакетную службу в Azure, указывая в качестве задачи диспетчера заданий программу диспетчера заданий.</span><span class="sxs-lookup"><span data-stu-id="15092-116">The client code (e.g., application, web service, etc.) submits a job to the Batch service on Azure, specifying as its job manager task the job manager program.</span></span>
2. <span data-ttu-id="15092-117">Пакетная служба выполняет задание диспетчера заданий на вычислительном узле, а разделитель заданий запускает указанное количество задач обработчика задач на необходимом количестве вычислительных узлов с учетом параметров и спецификаций в коде разделителя заданий.</span><span class="sxs-lookup"><span data-stu-id="15092-117">The Batch service runs the job manager task on a compute node and the job splitter launches the specified number of task processor tasks, on as many compute nodes as required, based on the parameters and specifications in the job splitter code.</span></span>
3. <span data-ttu-id="15092-118">Задачи обработчика задач выполняются независимо в параллельном режиме. При этом обрабатываются входные данные и создаются выходные данные.</span><span class="sxs-lookup"><span data-stu-id="15092-118">The task processor tasks run independently, in parallel, to process the input data and generate the output data.</span></span>

![Схема взаимодействия клиентского кода с пакетной службой][diagram01]

## <a name="prerequisites"></a><span data-ttu-id="15092-120">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="15092-120">Prerequisites</span></span>
<span data-ttu-id="15092-121">Для использования шаблонов пакетной службы вам потребуется:</span><span class="sxs-lookup"><span data-stu-id="15092-121">To use the Batch templates, you will need the following:</span></span>

* <span data-ttu-id="15092-122">Компьютер, на который установлено программное обеспечение Visual Studio 2015.</span><span class="sxs-lookup"><span data-stu-id="15092-122">A computer with Visual Studio 2015 installed.</span></span> <span data-ttu-id="15092-123">В настоящее время поддерживаются только шаблоны пакетной службы для Visual Studio 2015.</span><span class="sxs-lookup"><span data-stu-id="15092-123">Batch templates are currently only supported for Visual Studio 2015.</span></span>
* <span data-ttu-id="15092-124">Шаблоны пакетной службы, доступные в [коллекции Visual Studio][vs_gallery] в качестве расширений Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="15092-124">The Batch templates, which are available from the [Visual Studio Gallery][vs_gallery] as Visual Studio extensions.</span></span> <span data-ttu-id="15092-125">Получить шаблоны можно двумя способами:</span><span class="sxs-lookup"><span data-stu-id="15092-125">There are two ways to get the templates:</span></span>
  
  * <span data-ttu-id="15092-126">Установите шаблоны, используя диалоговое окно **Расширения и обновления** в Visual Studio (дополнительные сведения см. в статье [Поиск и использование расширений Visual Studio][vs_find_use_ext]).</span><span class="sxs-lookup"><span data-stu-id="15092-126">Install the templates using the **Extensions and Updates** dialog box in Visual Studio (for more information, see [Finding and Using Visual Studio Extensions][vs_find_use_ext]).</span></span> <span data-ttu-id="15092-127">С помощью диалогового окна **Расширения и обновления** найдите и скачайте следующие два модуля:</span><span class="sxs-lookup"><span data-stu-id="15092-127">In the **Extensions and Updates** dialog box, search and download the following two extensions:</span></span>
    
    * <span data-ttu-id="15092-128">диспетчер заданий пакетной службы Azure с разделителем заданий;</span><span class="sxs-lookup"><span data-stu-id="15092-128">Azure Batch Job Manager with Job Splitter</span></span>
    * <span data-ttu-id="15092-129">обработчик задач пакетной службы Azure.</span><span class="sxs-lookup"><span data-stu-id="15092-129">Azure Batch Task Processor</span></span>
  * <span data-ttu-id="15092-130">Скачайте шаблоны из коллекции в Интернете для Visual Studio: [Microsoft Azure Batch Project Templates][vs_gallery_templates] (Шаблоны проектов пакетной службы Microsoft Azure).</span><span class="sxs-lookup"><span data-stu-id="15092-130">Download the templates from the online gallery for Visual Studio: [Microsoft Azure Batch Project Templates][vs_gallery_templates]</span></span>
* <span data-ttu-id="15092-131">Если планируется развернуть диспетчер заданий и обработчик задач на вычислительных узлах пакетной службы с помощью [пакетов приложений](batch-application-packages.md) , необходимо связать учетную запись хранения с учетной записью пакетной службы.</span><span class="sxs-lookup"><span data-stu-id="15092-131">If you plan to use the [Application Packages](batch-application-packages.md) feature to deploy the job manager and task processor to the Batch compute nodes, you need to link a storage account to your Batch account.</span></span>

## <a name="preparation"></a><span data-ttu-id="15092-132">Подготовка</span><span class="sxs-lookup"><span data-stu-id="15092-132">Preparation</span></span>
<span data-ttu-id="15092-133">Мы советуем создать решение, содержащее диспетчер заданий и обработчик задач, так как таким образом можно упростить совместное использование кода в диспетчере заданий и обработчике задач.</span><span class="sxs-lookup"><span data-stu-id="15092-133">We recommend creating a solution that can contain your job manager as well as your task processor, because this can make it easier to share code between your job manager and task processor programs.</span></span> <span data-ttu-id="15092-134">Чтобы создать это решение, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="15092-134">To create this solution, follow these steps:</span></span>

1. <span data-ttu-id="15092-135">Откройте Visual Studio и выберите **Файл** > **Создать** > **Проект**.</span><span class="sxs-lookup"><span data-stu-id="15092-135">Open Visual Studio and select **File** > **New** > **Project**.</span></span>
2. <span data-ttu-id="15092-136">В разделе **Шаблоны** разверните список **Другие типы проектов**, щелкните **Решения Visual Studio** и выберите **Новое решение**.</span><span class="sxs-lookup"><span data-stu-id="15092-136">Under **Templates**, expand **Other Project Types**, click **Visual Studio Solutions**, and then select **Blank Solution**.</span></span>
3. <span data-ttu-id="15092-137">Введите имя, описывающее приложение, и назначение этого решения (например, LitwareBatchTaskPrograms).</span><span class="sxs-lookup"><span data-stu-id="15092-137">Type a name that describes your application and the purpose of this solution (e.g., "LitwareBatchTaskPrograms").</span></span>
4. <span data-ttu-id="15092-138">Чтобы создать решение, нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="15092-138">To create the new solution, click **OK**.</span></span>

## <a name="job-manager-template"></a><span data-ttu-id="15092-139">Шаблон "Диспетчер заданий"</span><span class="sxs-lookup"><span data-stu-id="15092-139">Job Manager template</span></span>
<span data-ttu-id="15092-140">Шаблон "Диспетчер заданий" позволяет внедрить задачу диспетчера заданий, выполняющую следующие действия:</span><span class="sxs-lookup"><span data-stu-id="15092-140">The Job Manager template helps you to implement a job manager task that can perform the following actions:</span></span>

* <span data-ttu-id="15092-141">разделение задания на несколько задач;</span><span class="sxs-lookup"><span data-stu-id="15092-141">Split a job into multiple tasks.</span></span>
* <span data-ttu-id="15092-142">отправка этих задач для выполнения в пакетной службе.</span><span class="sxs-lookup"><span data-stu-id="15092-142">Submit those tasks to run on Batch.</span></span>

> [!NOTE]
> <span data-ttu-id="15092-143">Дополнительные сведения о задачах диспетчера заданий см. в статье [Обзор функций пакетной службы для разработчиков](batch-api-basics.md#job-manager-task).</span><span class="sxs-lookup"><span data-stu-id="15092-143">For more information about job manager tasks, see [Batch feature overview for developers](batch-api-basics.md#job-manager-task).</span></span>
> 
> 

### <a name="create-a-job-manager-using-the-template"></a><span data-ttu-id="15092-144">Создание диспетчера заданий с помощью шаблона</span><span class="sxs-lookup"><span data-stu-id="15092-144">Create a Job Manager using the template</span></span>
<span data-ttu-id="15092-145">Чтобы добавить в созданное ранее решение диспетчер заданий, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="15092-145">To add a job manager to the solution that you created earlier, follow these steps:</span></span>

1. <span data-ttu-id="15092-146">Откройте имеющееся решение в Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="15092-146">Open your existing solution in Visual Studio.</span></span>
2. <span data-ttu-id="15092-147">В обозревателе решений щелкните решение правой кнопкой мыши и выберите **Добавить** > **Новый проект**.</span><span class="sxs-lookup"><span data-stu-id="15092-147">In Solution Explorer, right-click the solution, click **Add** > **New Project**.</span></span>
3. <span data-ttu-id="15092-148">В разделе **Visual C#** щелкните **Облако**, а затем — **Azure Batch Job Manager with Job Splitter** (Диспетчер заданий пакетной службы Azure с разделителем заданий).</span><span class="sxs-lookup"><span data-stu-id="15092-148">Under **Visual C#**, click **Cloud**, and then click **Azure Batch Job Manager with Job Splitter**.</span></span>
4. <span data-ttu-id="15092-149">Введите имя, описывающее приложение и определяющее этот проект в качестве диспетчера заданий (например, LitwareJobManager).</span><span class="sxs-lookup"><span data-stu-id="15092-149">Type a name that describes your application and identifies this project as the job manager (e.g. "LitwareJobManager").</span></span>
5. <span data-ttu-id="15092-150">Чтобы создать проект, нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="15092-150">To create the project, click **OK**.</span></span>
6. <span data-ttu-id="15092-151">Наконец, создайте проект, чтобы принудительно загрузить в среде Visual Studio все указанные пакеты NuGet, а также чтобы убедиться, что проект допустимый, прежде чем начать изменять его.</span><span class="sxs-lookup"><span data-stu-id="15092-151">Finally, build the project to force Visual Studio to load all referenced NuGet packages and to verify that the project is valid before you start modifying it.</span></span>

### <a name="job-manager-template-files-and-their-purpose"></a><span data-ttu-id="15092-152">Файлы шаблона "Диспетчер заданий" и их назначение</span><span class="sxs-lookup"><span data-stu-id="15092-152">Job Manager template files and their purpose</span></span>
<span data-ttu-id="15092-153">При создании проекта с помощью шаблона "Диспетчер заданий" создается три группы файлов кода:</span><span class="sxs-lookup"><span data-stu-id="15092-153">When you create a project using the Job Manager template, it generates three groups of code files:</span></span>

* <span data-ttu-id="15092-154">Файл основной программы (Program.cs).</span><span class="sxs-lookup"><span data-stu-id="15092-154">The main program file (Program.cs).</span></span> <span data-ttu-id="15092-155">Он содержит точку входа программы и расширенные средства обработки исключений.</span><span class="sxs-lookup"><span data-stu-id="15092-155">This contains the program entry point and top-level exception handling.</span></span> <span data-ttu-id="15092-156">Обычно не требуется изменять этот файл.</span><span class="sxs-lookup"><span data-stu-id="15092-156">You shouldn't normally need to modify this.</span></span>
* <span data-ttu-id="15092-157">Каталог платформы.</span><span class="sxs-lookup"><span data-stu-id="15092-157">The Framework directory.</span></span> <span data-ttu-id="15092-158">Здесь содержатся файлы, отвечающие за стандартные операции программы диспетчера заданий: распаковка параметров, добавление задач в задание пакетной службы и т. д. Обычно не требуется изменять эти файлы.</span><span class="sxs-lookup"><span data-stu-id="15092-158">This contains the files responsible for the 'boilerplate' work done by the job manager program – unpacking parameters, adding tasks to the Batch job, etc. You shouldn't normally need to modify these files.</span></span>
* <span data-ttu-id="15092-159">Файл разделителя заданий (JobSplitter.cs).</span><span class="sxs-lookup"><span data-stu-id="15092-159">The job splitter file (JobSplitter.cs).</span></span> <span data-ttu-id="15092-160">Именно в него помещается логика приложения для разделения задания на задачи.</span><span class="sxs-lookup"><span data-stu-id="15092-160">This is where you will put your application-specific logic for splitting a job into tasks.</span></span>

<span data-ttu-id="15092-161">Конечно, при необходимости для поддержки кода разделителя заданий можно добавить дополнительные файлы в зависимости от сложности логики разделителя заданий.</span><span class="sxs-lookup"><span data-stu-id="15092-161">Of course you can add additional files as required to support your job splitter code, depending on the complexity of the job splitting logic.</span></span>

<span data-ttu-id="15092-162">Шаблон также создает стандартные проектные файлы .NET, например CSPROJ-файл, app.config, packages.config и т. д.</span><span class="sxs-lookup"><span data-stu-id="15092-162">The template also generates standard .NET project files such as a .csproj file, app.config, packages.config, etc.</span></span>

<span data-ttu-id="15092-163">В остальной части этого раздела представлено описание различных файлов и структуры кода в них, а также объяснение назначения каждого класса.</span><span class="sxs-lookup"><span data-stu-id="15092-163">The rest of this section describes the different files and their code structure, and explains what each class does.</span></span>

![Обозреватель решений Visual Studio, в котором отображается решение шаблона "Диспетчер заданий"][solution_explorer01]

<span data-ttu-id="15092-165">**Файлы платформы**</span><span class="sxs-lookup"><span data-stu-id="15092-165">**Framework files**</span></span>

* <span data-ttu-id="15092-166">`Configuration.cs` инкапсулирует загрузку данных конфигурации задания, например сведения об учетной записи пакетной службы, учетные данные связанной учетной записи хранения, сведения о задании и задаче, а также параметры задания.</span><span class="sxs-lookup"><span data-stu-id="15092-166">`Configuration.cs`: Encapsulates the loading of job configuration data such as Batch account details, linked storage account credentials, job and task information, and job parameters.</span></span> <span data-ttu-id="15092-167">Он также предоставляет доступ к переменным среды, определяемым пакетной службой (см. параметры среды для задач в документации пакетной службы), в классе Configuration.EnvironmentVariable.</span><span class="sxs-lookup"><span data-stu-id="15092-167">It also provides access to Batch-defined environment variables (see Environment settings for tasks, in the Batch documentation) via the Configuration.EnvironmentVariable class.</span></span>
* <span data-ttu-id="15092-168">`IConfiguration.cs` абстрагирует реализацию класса конфигурации, чтобы пользователь мог выполнить модульный тест с разделителем заданий, используя фиктивный или ложный объект конфигурации.</span><span class="sxs-lookup"><span data-stu-id="15092-168">`IConfiguration.cs`: Abstracts the implementation of the Configuration class, so that you can unit test your job splitter using a fake or mock configuration object.</span></span>
* <span data-ttu-id="15092-169">`JobManager.cs` управляет компонентами программы диспетчера заданий.</span><span class="sxs-lookup"><span data-stu-id="15092-169">`JobManager.cs`: Orchestrates the components of the job manager program.</span></span> <span data-ttu-id="15092-170">Он отвечает за инициализацию разделителя заданий, вызов разделителя заданий и подготовку задач, возвращаемых разделителем заданий, к пересылке отравителю задач.</span><span class="sxs-lookup"><span data-stu-id="15092-170">It is responsible for the initializing the job splitter, invoking the job splitter, and dispatching the tasks returned by the job splitter to the task submitter.</span></span>
* <span data-ttu-id="15092-171">`JobManagerException.cs` представляет ошибку, требующую завершения работы диспетчера заданий.</span><span class="sxs-lookup"><span data-stu-id="15092-171">`JobManagerException.cs`: Represents an error that requires the job manager to terminate.</span></span> <span data-ttu-id="15092-172">JobManagerException используется для помещения ожидаемых ошибок в оболочку. При завершении работы могут указываться конкретные диагностические сведения.</span><span class="sxs-lookup"><span data-stu-id="15092-172">JobManagerException is used to wrap 'expected' errors where specific diagnostic information can be provided as part of termination.</span></span>
* <span data-ttu-id="15092-173">`TaskSubmitter.cs`. Этот класс отвечает за добавление задач, возвращаемых разделителем заданий, в пакетную службу.</span><span class="sxs-lookup"><span data-stu-id="15092-173">`TaskSubmitter.cs`: This class is responsible to adding tasks returned by the job splitter to the Batch job.</span></span> <span data-ttu-id="15092-174">Класс JobManager объединяет последовательность задач в пакеты для эффективного и своевременного добавления в задание, а затем вызывает TaskSubmitter.SubmitTasks в фоновом потоке для каждого пакета.</span><span class="sxs-lookup"><span data-stu-id="15092-174">The JobManager class aggregates the sequence of tasks into batches for efficient but timely addition to the job, then calls TaskSubmitter.SubmitTasks on a background thread for each batch.</span></span>

<span data-ttu-id="15092-175">**Разделитель заданий**</span><span class="sxs-lookup"><span data-stu-id="15092-175">**Job Splitter**</span></span>

<span data-ttu-id="15092-176">`JobSplitter.cs`. Этот класс содержит логику приложения для разделения задания на задачи.</span><span class="sxs-lookup"><span data-stu-id="15092-176">`JobSplitter.cs`: This class contains application-specific logic for splitting the job into tasks.</span></span> <span data-ttu-id="15092-177">Платформа вызывает метод JobSplitter.Split для получения последовательности задач, которые она добавляет в задание, когда метод возвращает их.</span><span class="sxs-lookup"><span data-stu-id="15092-177">The framework invokes the JobSplitter.Split method to obtain a sequence of tasks, which it adds to the job as the method returns them.</span></span> <span data-ttu-id="15092-178">В этот класс встраивается логика задания.</span><span class="sxs-lookup"><span data-stu-id="15092-178">This is the class where you will inject the logic of your job.</span></span> <span data-ttu-id="15092-179">Реализуйте метод Split, чтобы вернуть последовательность экземпляров CloudTask, представляющих задачи, на которые требуется разбить задание.</span><span class="sxs-lookup"><span data-stu-id="15092-179">Implement the Split method to return a sequence of CloudTask instances representing the tasks into which you want to partition the job.</span></span>

<span data-ttu-id="15092-180">**Стандартные файлы проекта .NET командной строки**</span><span class="sxs-lookup"><span data-stu-id="15092-180">**Standard .NET command line project files**</span></span>

* <span data-ttu-id="15092-181">`App.config`— стандартный файл конфигурации приложения .NET.</span><span class="sxs-lookup"><span data-stu-id="15092-181">`App.config`: Standard .NET application configuration file.</span></span>
* <span data-ttu-id="15092-182">`Packages.config` — стандартный файл зависимостей пакета NuGet.</span><span class="sxs-lookup"><span data-stu-id="15092-182">`Packages.config`: Standard NuGet package dependency file.</span></span>
* <span data-ttu-id="15092-183">`Program.cs` содержит точку входа программы и расширенные средства обработки исключений.</span><span class="sxs-lookup"><span data-stu-id="15092-183">`Program.cs`: Contains the program entry point and top-level exception handling.</span></span>

### <a name="implementing-the-job-splitter"></a><span data-ttu-id="15092-184">Внедрение разделителя заданий</span><span class="sxs-lookup"><span data-stu-id="15092-184">Implementing the job splitter</span></span>
<span data-ttu-id="15092-185">При открытии проекта шаблона "Диспетчер заданий" файл JobSplitter.cs откроется по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="15092-185">When you open the Job Manager template project, the project will have the JobSplitter.cs file open by default.</span></span> <span data-ttu-id="15092-186">Вы можете внедрить логику разделения для выполнения задач в рабочей нагрузке, используя метод Split() из следующего примера:</span><span class="sxs-lookup"><span data-stu-id="15092-186">You can implement the split logic for the tasks in your workload by using the Split() method show below:</span></span>

```csharp
/// <summary>
/// Gets the tasks into which to split the job. This is where you inject
/// your application-specific logic for decomposing the job into tasks.
///
/// The job manager framework invokes the Split method for you; you need
/// only to implement it, not to call it yourself. Typically, your
/// implementation should return tasks lazily, for example using a C#
/// iterator and the "yield return" statement; this allows tasks to be added
/// and to start running while splitting is still in progress.
/// </summary>
/// <returns>The tasks to be added to the job. Tasks are added automatically
/// by the job manager framework as they are returned by this method.</returns>
public IEnumerable<CloudTask> Split()
{
    // Your code for the split logic goes here.
    int startFrame = Convert.ToInt32(_parameters["StartFrame"]);
    int endFrame = Convert.ToInt32(_parameters["EndFrame"]);

    for (int i = startFrame; i <= endFrame; i++)
    {
        yield return new CloudTask("myTask" + i, "cmd /c dir");
    }
}
```

> [!NOTE]
> <span data-ttu-id="15092-187">Раздел с заметками в методе `Split()` — единственная часть кода шаблона "Диспетчер заданий", которую нужно изменить, добавив логику для разделения заданий на различные задачи.</span><span class="sxs-lookup"><span data-stu-id="15092-187">The annotated section in the `Split()` method is the only section of the Job Manager template code that is intended for you to modify by adding the logic to split your jobs into different tasks.</span></span> <span data-ttu-id="15092-188">Чтобы изменить другой раздел шаблона, нужно ознакомиться с принципами работы пакетной службы и опробовать некоторые из [примеров кода этой службы][github_samples].</span><span class="sxs-lookup"><span data-stu-id="15092-188">If you want to modify a different section of the template, please ensure you are familiarized with how Batch works, and try out a few of the [Batch code samples][github_samples].</span></span>
> 
> 

<span data-ttu-id="15092-189">Для реализации метода Split() доступны такие компоненты:</span><span class="sxs-lookup"><span data-stu-id="15092-189">Your Split() implementation has access to:</span></span>

* <span data-ttu-id="15092-190">параметры задания (в поле `_parameters`);</span><span class="sxs-lookup"><span data-stu-id="15092-190">The job parameters, via the `_parameters` field.</span></span>
* <span data-ttu-id="15092-191">объект CloudJob, представляющий задание (в поле `_job`);</span><span class="sxs-lookup"><span data-stu-id="15092-191">The CloudJob object representing the job, via the `_job` field.</span></span>
* <span data-ttu-id="15092-192">объект CloudTask, представляющий задание диспетчера заданий (в поле `_jobManagerTask`).</span><span class="sxs-lookup"><span data-stu-id="15092-192">The CloudTask object representing the job manager task, via the `_jobManagerTask` field.</span></span>

<span data-ttu-id="15092-193">При реализации `Split()` не нужно добавлять задачи в задание напрямую.</span><span class="sxs-lookup"><span data-stu-id="15092-193">Your `Split()` implementation does not need to add tasks to the job directly.</span></span> <span data-ttu-id="15092-194">Код должен возвращать последовательность объектов CloudTask, а классы платформы, вызывающие разделитель заданий, добавят задачи в задание автоматически.</span><span class="sxs-lookup"><span data-stu-id="15092-194">Instead, your code should return a sequence of CloudTask objects, and these will be added to the job automatically by the framework classes that invoke the job splitter.</span></span> <span data-ttu-id="15092-195">Как правило, для внедрения разделителей заданий используется итератор для C# (`yield return`), так как таким образом можно начать выполнение задач как можно быстрее, а не дожидаться обработки всех задач.</span><span class="sxs-lookup"><span data-stu-id="15092-195">It's common to use C#'s iterator (`yield return`) feature to implement job splitters as this allows the tasks to start running as soon as possible rather than waiting for all tasks to be calculated.</span></span>

<span data-ttu-id="15092-196">**Сбой разделителя заданий**</span><span class="sxs-lookup"><span data-stu-id="15092-196">**Job splitter failure**</span></span>

<span data-ttu-id="15092-197">При сбое разделитель заданий делает следующее:</span><span class="sxs-lookup"><span data-stu-id="15092-197">If your job splitter encounters an error, it should either:</span></span>

* <span data-ttu-id="15092-198">Завершает последовательность с помощью утверждения C# `yield break`. В этом случае диспетчер заданий будет считаться таким, который совершил выполнение успешно.</span><span class="sxs-lookup"><span data-stu-id="15092-198">Terminate the sequence using the C# `yield break` statement, in which case the job manager will be treated as successful; or</span></span>
* <span data-ttu-id="15092-199">Выдает исключение. В этом случае диспетчер заданий рассматривается как такой, в котором произошел сбой. Он может запускаться повторно в зависимости от конфигурации клиента.</span><span class="sxs-lookup"><span data-stu-id="15092-199">Throw an exception, in which case the job manager will be treated as failed and may be retried depending on how the client has configured it).</span></span>

<span data-ttu-id="15092-200">В обоих случаях любые задачи, возвращенные разделителем заданий и добавленные в пакетную службу, можно запускать.</span><span class="sxs-lookup"><span data-stu-id="15092-200">In both cases, any tasks already returned by the job splitter and added to the Batch job will be eligible to run.</span></span> <span data-ttu-id="15092-201">Чтобы этого не произошло, можно сделать следующее:</span><span class="sxs-lookup"><span data-stu-id="15092-201">If you don't want this to happen, then you could:</span></span>

* <span data-ttu-id="15092-202">Завершить выполнение задания перед возвратом из разделителя заданий.</span><span class="sxs-lookup"><span data-stu-id="15092-202">Terminate the job before returning from the job splitter</span></span>
* <span data-ttu-id="15092-203">Создать коллекцию задач перед возвратом (то есть необходимо вернуть `ICollection<CloudTask>` или `IList<CloudTask>`, а не внедрять разделитель заданий с помощью итераторов для C#).</span><span class="sxs-lookup"><span data-stu-id="15092-203">Formulate the entire task collection before returning it (that is, return an `ICollection<CloudTask>` or `IList<CloudTask>` instead of implementing your job splitter using a C# iterator)</span></span>
* <span data-ttu-id="15092-204">Создать зависимость заданий от успешного завершения работы диспетчера заданий.</span><span class="sxs-lookup"><span data-stu-id="15092-204">Use task dependencies to make all tasks depend on the successful completion of the job manager</span></span>

<span data-ttu-id="15092-205">**Повторная попытка запуска диспетчера заданий**</span><span class="sxs-lookup"><span data-stu-id="15092-205">**Job manager retries**</span></span>

<span data-ttu-id="15092-206">При сбое пакетная служба может предпринять попытку повторного запуска диспетчера заданий в зависимости от параметров повторных попыток клиента.</span><span class="sxs-lookup"><span data-stu-id="15092-206">If the job manager fails, it may be retried by the Batch service depending on the client retry settings.</span></span> <span data-ttu-id="15092-207">Как правило, это безопасно, так как при добавлении задачи в задание платформа игнорирует любые имеющиеся задачи.</span><span class="sxs-lookup"><span data-stu-id="15092-207">In general, this is safe, because when the framework adds tasks to the job, it ignores any tasks that already exist.</span></span> <span data-ttu-id="15092-208">Тем не менее если вычисление задач требует значительных затрат, вам не захочется тратить дополнительные средства на выполнение повторного вычисления задач, добавленных в задание. Напротив, если при повторном вычислении не будут получены те же идентификаторы задач, игнорирование повторяющихся элементов не принесет пользу.</span><span class="sxs-lookup"><span data-stu-id="15092-208">However, if calculating tasks is expensive, you may not wish to incur the cost of recalculating tasks that have already been added to the job; conversely, if the re-run is not guaranteed to generate the same task IDs then the 'ignore duplicates' behavior will not kick in.</span></span> <span data-ttu-id="15092-209">В таких случаях следует настроить разделитель заданий таким образом, чтобы он определял выполненные задания и не выполнял их снова, например, выполняя CloudJob.ListTasks перед выдачей задач.</span><span class="sxs-lookup"><span data-stu-id="15092-209">In these cases you should design your job splitter to detect the work that has already been done and not repeat it, for example by performing a CloudJob.ListTasks before starting to yield tasks.</span></span>

### <a name="exit-codes-and-exceptions-in-the-job-manager-template"></a><span data-ttu-id="15092-210">Коды выхода и исключения в шаблоне "Диспетчер заданий"</span><span class="sxs-lookup"><span data-stu-id="15092-210">Exit codes and exceptions in the Job Manager template</span></span>
<span data-ttu-id="15092-211">Коды выхода и исключения позволяют определить результат выполнения программы, а также выявить проблемы при ее выполнении.</span><span class="sxs-lookup"><span data-stu-id="15092-211">Exit codes and exceptions provide a mechanism to determine the outcome of running a program, and they can help to identify any problems with the execution of the program.</span></span> <span data-ttu-id="15092-212">Шаблон "Диспетчер заданий" реализует коды выхода и исключения, описанные в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="15092-212">The Job Manager template implements the exit codes and exceptions described in this section.</span></span>

<span data-ttu-id="15092-213">Задача диспетчера заданий, реализующаяся с помощью шаблона "Диспетчер заданий", может вернуть три возможных кода выхода:</span><span class="sxs-lookup"><span data-stu-id="15092-213">A job manager task that is implemented with the Job Manager template can return three possible exit codes:</span></span>

| <span data-ttu-id="15092-214">Код</span><span class="sxs-lookup"><span data-stu-id="15092-214">Code</span></span> | <span data-ttu-id="15092-215">Описание</span><span class="sxs-lookup"><span data-stu-id="15092-215">Description</span></span> |
| --- | --- |
| <span data-ttu-id="15092-216">0</span><span class="sxs-lookup"><span data-stu-id="15092-216">0</span></span> |<span data-ttu-id="15092-217">Задание диспетчера заданий выполнено успешно.</span><span class="sxs-lookup"><span data-stu-id="15092-217">The job manager completed successfully.</span></span> <span data-ttu-id="15092-218">Код разделителя заданий выполнен. Все задачи добавлены в задание.</span><span class="sxs-lookup"><span data-stu-id="15092-218">Your job splitter code ran to completion, and all tasks were added to the job.</span></span> |
| <span data-ttu-id="15092-219">1</span><span class="sxs-lookup"><span data-stu-id="15092-219">1</span></span> |<span data-ttu-id="15092-220">Произошел сбой задания диспетчера заданий с исключением в ожидаемых результатах программы.</span><span class="sxs-lookup"><span data-stu-id="15092-220">The job manager task failed with an exception in an 'expected' part of the program.</span></span> <span data-ttu-id="15092-221">Исключение преобразовано в JobManagerException с диагностическими сведениями и рекомендациями по устранению ошибки, где это возможно.</span><span class="sxs-lookup"><span data-stu-id="15092-221">The exception was translated to a JobManagerException with diagnostic information and, where possible, suggestions for resolving the failure.</span></span> |
| <span data-ttu-id="15092-222">2</span><span class="sxs-lookup"><span data-stu-id="15092-222">2</span></span> |<span data-ttu-id="15092-223">Произошел сбой задания диспетчера заданий с непредвиденным исключением.</span><span class="sxs-lookup"><span data-stu-id="15092-223">The job manager task failed with an 'unexpected' exception.</span></span> <span data-ttu-id="15092-224">Исключение зарегистрировано в стандартный вывод, но диспетчеру заданий не удалось добавить дополнительные диагностические сведения или рекомендации по исправлению.</span><span class="sxs-lookup"><span data-stu-id="15092-224">The exception was logged to standard output, but the job manager was unable to add any additional diagnostic or remediation information.</span></span> |

<span data-ttu-id="15092-225">При сбое задачи диспетчера заданий некоторые задачи могут быть добавлены в службу до возникновения ошибки.</span><span class="sxs-lookup"><span data-stu-id="15092-225">In the case of job manager task failure, some tasks may still have been added to the service before the error occurred.</span></span> <span data-ttu-id="15092-226">Эти задачи будут выполняться в обычном режиме.</span><span class="sxs-lookup"><span data-stu-id="15092-226">These tasks will run as normal.</span></span> <span data-ttu-id="15092-227">Обсуждение этого пути кода см. в разделе "Сбой разделителя заданий" выше.</span><span class="sxs-lookup"><span data-stu-id="15092-227">See "Job Splitter Failure" above for discussion of this code path.</span></span>

<span data-ttu-id="15092-228">Все сведения, возвращаемые исключением, записываются в файлы stdout.txt и stderr.txt.</span><span class="sxs-lookup"><span data-stu-id="15092-228">All the information returned by exceptions is written into stdout.txt and stderr.txt files.</span></span> <span data-ttu-id="15092-229">Дополнительные сведения см. в разделе [Обработка ошибок](batch-api-basics.md#error-handling).</span><span class="sxs-lookup"><span data-stu-id="15092-229">For more information, see [Error Handling](batch-api-basics.md#error-handling).</span></span>

### <a name="client-considerations"></a><span data-ttu-id="15092-230">Рекомендации для клиента</span><span class="sxs-lookup"><span data-stu-id="15092-230">Client considerations</span></span>
<span data-ttu-id="15092-231">В этом разделе описываются некоторые требования к реализации в клиенте при вызове диспетчера заданий с использованием этого шаблона.</span><span class="sxs-lookup"><span data-stu-id="15092-231">This section describes some client implementation requirements when invoking a job manager based on this template.</span></span> <span data-ttu-id="15092-232">Дополнительные сведения о передаче параметров и переменных среды из клиентского кода см. в [этом разделе](#pass-environment-settings).</span><span class="sxs-lookup"><span data-stu-id="15092-232">See [How to pass parameters and environment variables from the client code](#pass-environment-settings) for details on passing parameters and environment settings.</span></span>

<span data-ttu-id="15092-233">**Обязательные учетные данные**</span><span class="sxs-lookup"><span data-stu-id="15092-233">**Mandatory credentials**</span></span>

<span data-ttu-id="15092-234">Чтобы добавить задачи в задание пакетной службы Azure, задаче диспетчера заданий требуется URL-адрес и ключ учетной записи пакетной службы Azure.</span><span class="sxs-lookup"><span data-stu-id="15092-234">In order to add tasks to the Azure Batch job, the job manager task requires your Azure Batch account URL and key.</span></span> <span data-ttu-id="15092-235">Их необходимо передать в переменные среды YOUR_BATCH_URL и YOUR_BATCH_KEY.</span><span class="sxs-lookup"><span data-stu-id="15092-235">You must pass these in environment variables named YOUR_BATCH_URL and YOUR_BATCH_KEY.</span></span> <span data-ttu-id="15092-236">Их можно задать в параметрах среды задач диспетчера заданий.</span><span class="sxs-lookup"><span data-stu-id="15092-236">You can set these in the Job Manager task environment settings.</span></span> <span data-ttu-id="15092-237">Например, в клиенте C#:</span><span class="sxs-lookup"><span data-stu-id="15092-237">For example, in a C# client:</span></span>

```csharp
job.JobManagerTask.EnvironmentSettings = new [] {
    new EnvironmentSetting("YOUR_BATCH_URL", "https://account.region.batch.azure.com"),
    new EnvironmentSetting("YOUR_BATCH_KEY", "{your_base64_encoded_account_key}"),
};
```
<span data-ttu-id="15092-238">**Учетные данные хранилища**</span><span class="sxs-lookup"><span data-stu-id="15092-238">**Storage credentials**</span></span>

<span data-ttu-id="15092-239">Как правило, клиенту не требуется предоставлять учетные данные связанной учетной записи хранения для задачи диспетчера заданий, так как большинству диспетчеров заданий не требуется непосредственный доступ к связанной учетной записи хранения. Кроме того, связанная учетная запись хранения часто указывается для всех задач в качестве общего параметра среды для задания.</span><span class="sxs-lookup"><span data-stu-id="15092-239">Typically, the client does not need to provide the linked storage account credentials to the job manager task because (a) most job managers do not need to explicitly access the linked storage account and (b) the linked storage account is often provided to all tasks as a common environment setting for the job.</span></span> <span data-ttu-id="15092-240">Если связанная учетная запись хранения не указывается в общих параметрах среды, а диспетчеру заданий требуется доступ к связанному хранилищу, следует указать учетные данные связанного хранилища следующим образом:</span><span class="sxs-lookup"><span data-stu-id="15092-240">If you are not providing the linked storage account via the common environment settings, and the job manager requires access to linked storage, then you should supply the linked storage credentials as follows:</span></span>

```csharp
job.JobManagerTask.EnvironmentSettings = new [] {
    /* other environment settings */
    new EnvironmentSetting("LINKED_STORAGE_ACCOUNT", "{storageAccountName}"),
    new EnvironmentSetting("LINKED_STORAGE_KEY", "{storageAccountKey}"),
};
```

<span data-ttu-id="15092-241">**Параметры задачи диспетчера заданий**</span><span class="sxs-lookup"><span data-stu-id="15092-241">**Job manager task settings**</span></span>

<span data-ttu-id="15092-242">Клиент должен задать для флага диспетчера заданий *killJobOnCompletion* значение **false**.</span><span class="sxs-lookup"><span data-stu-id="15092-242">The client should set the job manager *killJobOnCompletion* flag to **false**.</span></span>

<span data-ttu-id="15092-243">Обычно клиенту можно задать для параметра *runExclusive* значение **false**.</span><span class="sxs-lookup"><span data-stu-id="15092-243">It is usually safe for the client to set *runExclusive* to **false**.</span></span>

<span data-ttu-id="15092-244">Клиент должен использовать коллекцию *resourceFiles* или *applicationPackageReferences*, чтобы развернуть исполняемый файл диспетчера заданий (и необходимые библиотеки DLL) на вычислительном узле.</span><span class="sxs-lookup"><span data-stu-id="15092-244">The client should use the *resourceFiles* or *applicationPackageReferences* collection to have the job manager executable (and its required DLLs) deployed to the compute node.</span></span>

<span data-ttu-id="15092-245">По умолчанию при сбое не будет выполняться повторный запуск диспетчера заданий.</span><span class="sxs-lookup"><span data-stu-id="15092-245">By default, the job manager will not be retried if it fails.</span></span> <span data-ttu-id="15092-246">В зависимости от логики диспетчера заданий клиенту может потребоваться выполнить повторную попытку через *constraints*/*maxTaskRetryCount*.</span><span class="sxs-lookup"><span data-stu-id="15092-246">Depending on your job manager logic, the client may want to enable retries via *constraints*/*maxTaskRetryCount*.</span></span>

<span data-ttu-id="15092-247">**Параметры задания**</span><span class="sxs-lookup"><span data-stu-id="15092-247">**Job settings**</span></span>

<span data-ttu-id="15092-248">Если разделитель заданий выдает задачи с зависимостями, клиенту требуется задать для параметра задания usesTaskDependencies значение true.</span><span class="sxs-lookup"><span data-stu-id="15092-248">If the job splitter emits tasks with dependencies, the client must set the job's usesTaskDependencies to true.</span></span>

<span data-ttu-id="15092-249">В модели разделителя заданий, как правило, клиенты не добавляют в задания больше задач, чем создает разделитель заданий.</span><span class="sxs-lookup"><span data-stu-id="15092-249">In the job splitter model, it is unusual for clients to wish to add tasks to jobs over and above what the job splitter creates.</span></span> <span data-ttu-id="15092-250">Поэтому обычно клиенту нужно задать для параметра задания *onAllTasksComplete* значение **terminatejob**.</span><span class="sxs-lookup"><span data-stu-id="15092-250">The client should therefore normally set the job's *onAllTasksComplete* to **terminatejob**.</span></span>

## <a name="task-processor-template"></a><span data-ttu-id="15092-251">Шаблон "Обработчик задач"</span><span class="sxs-lookup"><span data-stu-id="15092-251">Task Processor template</span></span>
<span data-ttu-id="15092-252">Шаблон "Обработчик задач" позволяет внедрить обработчик задач, выполняющий следующие действия:</span><span class="sxs-lookup"><span data-stu-id="15092-252">A Task Processor template helps you to implement a task processor that can perform the following actions:</span></span>

* <span data-ttu-id="15092-253">настройка сведений, необходимых для выполнения каждой задачи пакетной службы;</span><span class="sxs-lookup"><span data-stu-id="15092-253">Set up the information required by each Batch task to run.</span></span>
* <span data-ttu-id="15092-254">выполнение всех действий, необходимых для каждой задачи пакетной службы;</span><span class="sxs-lookup"><span data-stu-id="15092-254">Run all actions required by each Batch task.</span></span>
* <span data-ttu-id="15092-255">сохранение результатов задачи в постоянное хранилище.</span><span class="sxs-lookup"><span data-stu-id="15092-255">Save task outputs to persistent storage.</span></span>

<span data-ttu-id="15092-256">Хотя обработчик задач не является обязательным для выполнения задач в пакетной службе, он предоставляет оболочку для реализации всех действий по выполнению задач в одном месте. В этом заключается ключевое преимущество его использования.</span><span class="sxs-lookup"><span data-stu-id="15092-256">Although a task processor is not required to run tasks on Batch, the key advantage of using a task processor is that it provides a wrapper to implement all task execution actions in one location.</span></span> <span data-ttu-id="15092-257">Например, если в контексте каждой задачи необходимо выполнить несколько приложений или если после завершения каждой задачи необходимо скопировать данные в постоянное хранилище.</span><span class="sxs-lookup"><span data-stu-id="15092-257">For example, if you need to run several applications in the context of each task, or if you need to copy data to persistent storage after completing each task.</span></span>

<span data-ttu-id="15092-258">Сложность и количество действий, выполняемых обработчиком задач, зависит от требований рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="15092-258">The actions performed by the task processor can be as simple or complex, and as many or as few, as required by your workload.</span></span> <span data-ttu-id="15092-259">Кроме того, внедрив все действия задач в один обработчик задач, можно легко обновить или добавить действия с учетом изменений требований к приложениям или рабочей нагрузке.</span><span class="sxs-lookup"><span data-stu-id="15092-259">Additionally, by implementing all task actions into one task processor, you can readily update or add actions based on changes to applications or workload requirements.</span></span> <span data-ttu-id="15092-260">Однако в некоторых случаях обработчик задач может оказаться не самым оптимальным решением для внедрения, так как он может создать излишние сложности, например, при выполнении заданий, которые можно быстро запустить из простой командной строки.</span><span class="sxs-lookup"><span data-stu-id="15092-260">However, in some cases a task processor might not be the optimal solution for your implementation as it can add unnecessary complexity, for example when running jobs that can be quickly started from a simple command line.</span></span>

### <a name="create-a-task-processor-using-the-template"></a><span data-ttu-id="15092-261">Создание обработчика задач с помощью шаблона</span><span class="sxs-lookup"><span data-stu-id="15092-261">Create a Task Processor using the template</span></span>
<span data-ttu-id="15092-262">Чтобы добавить в созданное ранее решение обработчик задач, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="15092-262">To add a task processor to the solution that you created earlier, follow these steps:</span></span>

1. <span data-ttu-id="15092-263">Откройте имеющееся решение в Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="15092-263">Open your existing solution in Visual Studio.</span></span>
2. <span data-ttu-id="15092-264">В обозревателе решений щелкните правой кнопкой мыши проект, выберите пункт **Добавить**, а затем щелкните **Новый проект**.</span><span class="sxs-lookup"><span data-stu-id="15092-264">In Solution Explorer, right-click the solution, click **Add**, and then click **New Project**.</span></span>
3. <span data-ttu-id="15092-265">В разделе **Visual C#** щелкните **Облако**, а затем — **Azure Batch Task Processor** (Обработчик задач пакетной службы Azure).</span><span class="sxs-lookup"><span data-stu-id="15092-265">Under **Visual C#**, click **Cloud**, and then click **Azure Batch Task Processor**.</span></span>
4. <span data-ttu-id="15092-266">Введите имя, описывающее приложение и определяющее этот проект в качестве обработчика задач (например, LitwareTaskProcessor).</span><span class="sxs-lookup"><span data-stu-id="15092-266">Type a name that describes your application and identifies this project as the task processor (e.g. "LitwareTaskProcessor").</span></span>
5. <span data-ttu-id="15092-267">Чтобы создать проект, нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="15092-267">To create the project, click **OK**.</span></span>
6. <span data-ttu-id="15092-268">Наконец, создайте проект, чтобы принудительно загрузить в среде Visual Studio все указанные пакеты NuGet, а также чтобы убедиться, что проект допустимый, прежде чем начать изменять его.</span><span class="sxs-lookup"><span data-stu-id="15092-268">Finally, build the project to force Visual Studio to load all referenced NuGet packages and to verify that the project is valid before you start modifying it.</span></span>

### <a name="task-processor-template-files-and-their-purpose"></a><span data-ttu-id="15092-269">Файлы шаблона "Обработчик задач" и их назначение</span><span class="sxs-lookup"><span data-stu-id="15092-269">Task Processor template files and their purpose</span></span>
<span data-ttu-id="15092-270">При создании проекта с помощью шаблона "Обработчик задач" создается три группы файлов кода:</span><span class="sxs-lookup"><span data-stu-id="15092-270">When you create a project using the task processor template, it generates three groups of code files:</span></span>

* <span data-ttu-id="15092-271">Файл основной программы (Program.cs).</span><span class="sxs-lookup"><span data-stu-id="15092-271">The main program file (Program.cs).</span></span> <span data-ttu-id="15092-272">Он содержит точку входа программы и расширенные средства обработки исключений.</span><span class="sxs-lookup"><span data-stu-id="15092-272">This contains the program entry point and top-level exception handling.</span></span> <span data-ttu-id="15092-273">Обычно не требуется изменять этот файл.</span><span class="sxs-lookup"><span data-stu-id="15092-273">You shouldn't normally need to modify this.</span></span>
* <span data-ttu-id="15092-274">Каталог платформы.</span><span class="sxs-lookup"><span data-stu-id="15092-274">The Framework directory.</span></span> <span data-ttu-id="15092-275">Здесь содержатся файлы, отвечающие за стандартные операции программы диспетчера заданий: распаковка параметров, добавление задач в задание пакетной службы и т. д. Обычно не требуется изменять эти файлы.</span><span class="sxs-lookup"><span data-stu-id="15092-275">This contains the files responsible for the 'boilerplate' work done by the job manager program – unpacking parameters, adding tasks to the Batch job, etc. You shouldn't normally need to modify these files.</span></span>
* <span data-ttu-id="15092-276">Файл обработчика задач (TaskProcessor.cs).</span><span class="sxs-lookup"><span data-stu-id="15092-276">The task processor file (TaskProcessor.cs).</span></span> <span data-ttu-id="15092-277">Сюда помещается логика приложения для выполнения задачи (как правило, путем вызова имеющегося исполняемого файла).</span><span class="sxs-lookup"><span data-stu-id="15092-277">This is where you will put your application-specific logic for executing a task (typically by calling out to an existing executable).</span></span> <span data-ttu-id="15092-278">Сюда также помещается код предварительной обработки и постобработки, например для скачивания дополнительных данных или отправки файлов результатов.</span><span class="sxs-lookup"><span data-stu-id="15092-278">Pre- and post-processing code, such as downloading additional data or uploading result files, also goes here.</span></span>

<span data-ttu-id="15092-279">Конечно, при необходимости для поддержки кода обработчика задач можно добавить дополнительные файлы в зависимости от сложности логики разделителя заданий.</span><span class="sxs-lookup"><span data-stu-id="15092-279">Of course you can add additional files as required to support your task processor code, depending on the complexity of the job splitting logic.</span></span>

<span data-ttu-id="15092-280">Шаблон также создает стандартные проектные файлы .NET, например CSPROJ-файл, app.config, packages.config и т. д.</span><span class="sxs-lookup"><span data-stu-id="15092-280">The template also generates standard .NET project files such as a .csproj file, app.config, packages.config, etc.</span></span>

<span data-ttu-id="15092-281">В остальной части этого раздела представлено описание различных файлов и структуры кода в них, а также объяснение назначения каждого класса.</span><span class="sxs-lookup"><span data-stu-id="15092-281">The rest of this section describes the different files and their code structure, and explains what each class does.</span></span>

![Обозреватель решений Visual Studio, в котором отображается решение шаблона "Обработчик задач"][solution_explorer02]

<span data-ttu-id="15092-283">**Файлы платформы**</span><span class="sxs-lookup"><span data-stu-id="15092-283">**Framework files**</span></span>

* <span data-ttu-id="15092-284">`Configuration.cs` инкапсулирует загрузку данных конфигурации задания, например сведения об учетной записи пакетной службы, учетные данные связанной учетной записи хранения, сведения о задании и задаче, а также параметры задания.</span><span class="sxs-lookup"><span data-stu-id="15092-284">`Configuration.cs`: Encapsulates the loading of job configuration data such as Batch account details, linked storage account credentials, job and task information, and job parameters.</span></span> <span data-ttu-id="15092-285">Он также предоставляет доступ к переменным среды, определяемым пакетной службой (см. параметры среды для задач в документации пакетной службы), в классе Configuration.EnvironmentVariable.</span><span class="sxs-lookup"><span data-stu-id="15092-285">It also provides access to Batch-defined environment variables (see Environment settings for tasks, in the Batch documentation) via the Configuration.EnvironmentVariable class.</span></span>
* <span data-ttu-id="15092-286">`IConfiguration.cs` абстрагирует реализацию класса конфигурации, чтобы пользователь мог выполнить модульный тест с разделителем заданий, используя фиктивный или ложный объект конфигурации.</span><span class="sxs-lookup"><span data-stu-id="15092-286">`IConfiguration.cs`: Abstracts the implementation of the Configuration class, so that you can unit test your job splitter using a fake or mock configuration object.</span></span>
* <span data-ttu-id="15092-287">`TaskProcessorException.cs` представляет ошибку, требующую завершения работы диспетчера заданий.</span><span class="sxs-lookup"><span data-stu-id="15092-287">`TaskProcessorException.cs`: Represents an error that requires the job manager to terminate.</span></span> <span data-ttu-id="15092-288">TaskProcessorException используется для помещения ожидаемых ошибок в оболочку. При завершении работы могут указываться конкретные диагностические сведения.</span><span class="sxs-lookup"><span data-stu-id="15092-288">TaskProcessorException is used to wrap 'expected' errors where specific diagnostic information can be provided as part of termination.</span></span>

<span data-ttu-id="15092-289">**Обработчик задач**</span><span class="sxs-lookup"><span data-stu-id="15092-289">**Task Processor**</span></span>

* <span data-ttu-id="15092-290">`TaskProcessor.cs`выполняет задачу.</span><span class="sxs-lookup"><span data-stu-id="15092-290">`TaskProcessor.cs`: Runs the task.</span></span> <span data-ttu-id="15092-291">Платформа вызывает метод TaskProcessor.Run.</span><span class="sxs-lookup"><span data-stu-id="15092-291">The framework invokes the TaskProcessor.Run method.</span></span> <span data-ttu-id="15092-292">В этот класс вставляется логика задачи для приложения.</span><span class="sxs-lookup"><span data-stu-id="15092-292">This is the class where you will inject the application-specific logic of your task.</span></span> <span data-ttu-id="15092-293">Реализуйте метод Run, чтобы выполнить следующее:</span><span class="sxs-lookup"><span data-stu-id="15092-293">Implement the Run method to:</span></span>
  * <span data-ttu-id="15092-294">проанализировать и проверить все параметры задачи;</span><span class="sxs-lookup"><span data-stu-id="15092-294">Parse and validate any task parameters</span></span>
  * <span data-ttu-id="15092-295">создать командную строку для любой внешней программы, которую нужно вызвать;</span><span class="sxs-lookup"><span data-stu-id="15092-295">Compose the command line for any external program you want to invoke</span></span>
  * <span data-ttu-id="15092-296">зарегистрировать любые диагностические сведения, которые могут потребоваться для отладки;</span><span class="sxs-lookup"><span data-stu-id="15092-296">Log any diagnostic information you may require for debugging purposes</span></span>
  * <span data-ttu-id="15092-297">запустить процесс с помощью созданной командной строки;</span><span class="sxs-lookup"><span data-stu-id="15092-297">Start a process using that command line</span></span>
  * <span data-ttu-id="15092-298">дождаться завершения процесса;</span><span class="sxs-lookup"><span data-stu-id="15092-298">Wait for the process to exit</span></span>
  * <span data-ttu-id="15092-299">записать код выхода процесса, чтобы определить, насколько успешно он выполнен;</span><span class="sxs-lookup"><span data-stu-id="15092-299">Capture the exit code of the process to determine if it succeeded or failed</span></span>
  * <span data-ttu-id="15092-300">сохранить выходные файлы, которые нужно сохранить в постоянном хранилище.</span><span class="sxs-lookup"><span data-stu-id="15092-300">Save any output files you want to keep to persistent storage</span></span>

<span data-ttu-id="15092-301">**Стандартные файлы проекта .NET командной строки**</span><span class="sxs-lookup"><span data-stu-id="15092-301">**Standard .NET command line project files**</span></span>

* <span data-ttu-id="15092-302">`App.config`— стандартный файл конфигурации приложения .NET.</span><span class="sxs-lookup"><span data-stu-id="15092-302">`App.config`: Standard .NET application configuration file.</span></span>
* <span data-ttu-id="15092-303">`Packages.config` — стандартный файл зависимостей пакета NuGet.</span><span class="sxs-lookup"><span data-stu-id="15092-303">`Packages.config`: Standard NuGet package dependency file.</span></span>
* <span data-ttu-id="15092-304">`Program.cs` содержит точку входа программы и расширенные средства обработки исключений.</span><span class="sxs-lookup"><span data-stu-id="15092-304">`Program.cs`: Contains the program entry point and top-level exception handling.</span></span>

## <a name="implementing-the-task-processor"></a><span data-ttu-id="15092-305">Реализация обработчика задач</span><span class="sxs-lookup"><span data-stu-id="15092-305">Implementing the task processor</span></span>
<span data-ttu-id="15092-306">При открытии проекта шаблона "Обработчик задач" файл TaskProcessor.cs откроется по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="15092-306">When you open the Task Processor template project, the project will have the TaskProcessor.cs file open by default.</span></span> <span data-ttu-id="15092-307">Логику выполнения для задач в рабочей нагрузке можно внедрить, используя метод Run() из следующего примера:</span><span class="sxs-lookup"><span data-stu-id="15092-307">You can implement the run logic for the tasks in your workload by using the Run() method shown below:</span></span>

```csharp
/// <summary>
/// Runs the task processing logic. This is where you inject
/// your application-specific logic for decomposing the job into tasks.
///
/// The task processor framework invokes the Run method for you; you need
/// only to implement it, not to call it yourself. Typically, your
/// implementation will execute an external program (from resource files or
/// an application package), check the exit code of that program and
/// save output files to persistent storage.
/// </summary>
public async Task<int> Run()

{
    try
    {
        //Your code for the task processor goes here.
        var command = $"compare {_parameters["Frame1"]} {_parameters["Frame2"]} compare.gif";
        using (var process = Process.Start($"cmd /c {command}"))
        {
            process.WaitForExit();
            var taskOutputStorage = new TaskOutputStorage(
            _configuration.StorageAccount,
            _configuration.JobId,
            _configuration.TaskId
            );
            await taskOutputStorage.SaveAsync(
            TaskOutputKind.TaskOutput,
            @"..\stdout.txt",
            @"stdout.txt"
            );
            return process.ExitCode;
        }
    }
    catch (Exception ex)
    {
        throw new TaskProcessorException(
        $"{ex.GetType().Name} exception in run task processor: {ex.Message}",
        ex
        );
    }
}
```
> [!NOTE]
> <span data-ttu-id="15092-308">Раздел с заметками в методе Run() — единственная часть кода шаблона "Обработчик задач", которую нужно изменить, добавив логику выполнения для задач в рабочей нагрузке.</span><span class="sxs-lookup"><span data-stu-id="15092-308">The annotated section in the Run() method is the only section of the Task Processor template code that is intended for you to modify by adding the run logic for the tasks in your workload.</span></span> <span data-ttu-id="15092-309">Если требуется изменить другой раздел шаблона, ознакомьтесь с принципами работы пакетной службы, просмотрев соответствующую документацию и опробовав некоторые из примеров кода пакетной службы.</span><span class="sxs-lookup"><span data-stu-id="15092-309">If you want to modify a different section of the template, please first familiarize yourself with how Batch works by reviewing the Batch documentation and trying out a few of the Batch code samples.</span></span>
> 
> 

<span data-ttu-id="15092-310">Метод Run() отвечает за запуск командной строки, запуск одного или нескольких процессов, ожидание завершения всех процессов, сохранение результатов и возврат с кодом выхода.</span><span class="sxs-lookup"><span data-stu-id="15092-310">The Run() method is responsible for launching the command line, starting one or more processes, waiting for all process to complete, saving the results, and finally returning with an exit code.</span></span> <span data-ttu-id="15092-311">В методе Run() выполняется реализация логики обработки для задач.</span><span class="sxs-lookup"><span data-stu-id="15092-311">The Run() method is where you implement the processing logic for your tasks.</span></span> <span data-ttu-id="15092-312">Платформа обработчика задач вызывает метод Run() автоматически. Поэтому не нужно делать это вручную.</span><span class="sxs-lookup"><span data-stu-id="15092-312">The task processor framework invokes the Run() method for you; you do not need to call it yourself.</span></span>

<span data-ttu-id="15092-313">Для реализации метода Run() доступны такие компоненты:</span><span class="sxs-lookup"><span data-stu-id="15092-313">Your Run() implementation has access to:</span></span>

* <span data-ttu-id="15092-314">параметры задачи (в поле `_parameters`);</span><span class="sxs-lookup"><span data-stu-id="15092-314">The task parameters, via the `_parameters` field.</span></span>
* <span data-ttu-id="15092-315">идентификаторы задания и задачи (в полях `_jobId` и `_taskId`);</span><span class="sxs-lookup"><span data-stu-id="15092-315">The job and task ids, via the `_jobId` and `_taskId` fields.</span></span>
* <span data-ttu-id="15092-316">конфигурация задачи (в поле `_configuration` ).</span><span class="sxs-lookup"><span data-stu-id="15092-316">The task configuration, via the `_configuration` field.</span></span>

<span data-ttu-id="15092-317">**Сбой выполнения задачи**</span><span class="sxs-lookup"><span data-stu-id="15092-317">**Task failure**</span></span>

<span data-ttu-id="15092-318">При сбое можно выйти из метода Run() путем создания исключения. Однако в таком случае кодом выхода управляет главный обработчик исключений.</span><span class="sxs-lookup"><span data-stu-id="15092-318">In case of failure, you can exit the Run() method by throwing an exception, but this leaves the top level exception handler in control of the task exit code.</span></span> <span data-ttu-id="15092-319">Если необходимо управлять кодом выхода, чтобы отличать различные типы сбоев (например, в целях диагностики или потому что в некоторых режимах сбоя нужно завершать выполнение задание, а в других — нет), нужно выйти из метода Run() путем возврата ненулевого кода выхода.</span><span class="sxs-lookup"><span data-stu-id="15092-319">If you need to control the exit code so that you can distinguish different types of failure, for example for diagnostic purposes or because some failure modes should terminate the job and others should not, then you should exit the Run() method by returning a non-zero exit code.</span></span> <span data-ttu-id="15092-320">Он становится кодом выхода задачи.</span><span class="sxs-lookup"><span data-stu-id="15092-320">This becomes the task exit code.</span></span>

### <a name="exit-codes-and-exceptions-in-the-task-processor-template"></a><span data-ttu-id="15092-321">Коды выхода и исключения в шаблоне "Обработчик задач"</span><span class="sxs-lookup"><span data-stu-id="15092-321">Exit codes and exceptions in the Task Processor template</span></span>
<span data-ttu-id="15092-322">Коды выхода и исключения позволяют определить результат выполнения программы, а также выявить проблемы при ее выполнении.</span><span class="sxs-lookup"><span data-stu-id="15092-322">Exit codes and exceptions provide a mechanism to determine the outcome of running a program, and they can help identify any problems with the execution of the program.</span></span> <span data-ttu-id="15092-323">Шаблон "Обработчик задач" реализует коды выхода и исключения, описанные в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="15092-323">The Task Processor template implements the exit codes and exceptions described in this section.</span></span>

<span data-ttu-id="15092-324">Задача обработчика задач, реализующаяся с помощью шаблона "Обработчик задач", может вернуть три возможных кода выхода:</span><span class="sxs-lookup"><span data-stu-id="15092-324">A task processor task that is implemented with the Task Processor template can return three possible exit codes:</span></span>

| <span data-ttu-id="15092-325">Код</span><span class="sxs-lookup"><span data-stu-id="15092-325">Code</span></span> | <span data-ttu-id="15092-326">Описание</span><span class="sxs-lookup"><span data-stu-id="15092-326">Description</span></span> |
| --- | --- |
| <span data-ttu-id="15092-327">[Process.ExitCode][process_exitcode]</span><span class="sxs-lookup"><span data-stu-id="15092-327">[Process.ExitCode][process_exitcode]</span></span> |<span data-ttu-id="15092-328">Обработчик задач выполнен.</span><span class="sxs-lookup"><span data-stu-id="15092-328">The task processor ran to completion.</span></span> <span data-ttu-id="15092-329">Обратите внимание, что это не означает, что при вызове программы ее выполнение успешно завершилось. Это означает, что обработчик задач успешно вызвал ее и выполнил любые операции постобработки без исключений.</span><span class="sxs-lookup"><span data-stu-id="15092-329">Note that this does not imply that the program you invoked was successful – only that the task processor invoked it successfully and performed any post-processing without exceptions.</span></span> <span data-ttu-id="15092-330">Значение кода выхода зависит от вызванной программы. Обычно код выхода 0 означает, что программа выполнена успешно, а любой другой код выхода означает, что произошел сбой.</span><span class="sxs-lookup"><span data-stu-id="15092-330">The meaning of the exit code depends on the invoked program – typically exit code 0 means the program succeeded and any other exit code means the program failed.</span></span> |
| <span data-ttu-id="15092-331">1</span><span class="sxs-lookup"><span data-stu-id="15092-331">1</span></span> |<span data-ttu-id="15092-332">Произошел сбой обработчика задач с исключением в ожидаемых результатах программы.</span><span class="sxs-lookup"><span data-stu-id="15092-332">The task processor failed with an exception in an 'expected' part of the program.</span></span> <span data-ttu-id="15092-333">Исключение преобразовано в `TaskProcessorException` с диагностическими сведениями и рекомендациями по устранению ошибки, где это возможно.</span><span class="sxs-lookup"><span data-stu-id="15092-333">The exception was translated to a `TaskProcessorException` with diagnostic information and, where possible, suggestions for resolving the failure.</span></span> |
| <span data-ttu-id="15092-334">2</span><span class="sxs-lookup"><span data-stu-id="15092-334">2</span></span> |<span data-ttu-id="15092-335">Произошел сбой обработчика задач с непредвиденным исключением.</span><span class="sxs-lookup"><span data-stu-id="15092-335">The task processor failed with an 'unexpected' exception.</span></span> <span data-ttu-id="15092-336">Исключение зарегистрировано в стандартный вывод, но обработчику задач не удалось добавить дополнительные диагностические сведения или рекомендации по исправлению.</span><span class="sxs-lookup"><span data-stu-id="15092-336">The exception was logged to standard output, but the task processor was unable to add any additional diagnostic or remediation information.</span></span> |

> [!NOTE]
> <span data-ttu-id="15092-337">Если вызываемая программа использует коды выхода 1 и 2 для указания конкретных режимов сбоя, использование кодов выхода 1 и 2 для ошибок обработчика задач приведет к неоднозначности.</span><span class="sxs-lookup"><span data-stu-id="15092-337">If the program you invoke uses exit codes 1 and 2 to indicate specific failure modes, then using exit codes 1 and 2 for task processor errors is ambiguous.</span></span> <span data-ttu-id="15092-338">Эти коды ошибок обработчика задач можно изменить на отличающиеся коды выхода, изменив исключения в файле Program.cs.</span><span class="sxs-lookup"><span data-stu-id="15092-338">You can change these task processor error codes to distinctive exit codes by editing the exception cases in the Program.cs file.</span></span>
> 
> 

<span data-ttu-id="15092-339">Все сведения, возвращаемые исключением, записываются в файлы stdout.txt и stderr.txt.</span><span class="sxs-lookup"><span data-stu-id="15092-339">All the information returned by exceptions is written into stdout.txt and stderr.txt files.</span></span> <span data-ttu-id="15092-340">Дополнительные сведения см. в разделе об обработке ошибок в документации по пакетной службе.</span><span class="sxs-lookup"><span data-stu-id="15092-340">For more information, see Error Handling, in the Batch documentation.</span></span>

### <a name="client-considerations"></a><span data-ttu-id="15092-341">Рекомендации для клиента</span><span class="sxs-lookup"><span data-stu-id="15092-341">Client considerations</span></span>
<span data-ttu-id="15092-342">**Учетные данные хранилища**</span><span class="sxs-lookup"><span data-stu-id="15092-342">**Storage credentials**</span></span>

<span data-ttu-id="15092-343">Если обработчик задач сохраняет результаты в хранилище BLOB-объектов Azure, например с использованием вспомогательной библиотеки соглашений по именованию файлов, то ему требуется доступ *к* учетным данным облачной учетной записи хранения *или* URL-адресу контейнера больших двоичных объектов, включающего подписанный URL-адрес (SAS).</span><span class="sxs-lookup"><span data-stu-id="15092-343">If your task processor uses Azure blob storage to persist outputs, for example using the file conventions helper library, then it needs access to *either* the cloud storage account credentials *or* a blob container URL that includes a shared access signature (SAS).</span></span> <span data-ttu-id="15092-344">Шаблон поддерживает предоставление учетных данных через общие переменные среды.</span><span class="sxs-lookup"><span data-stu-id="15092-344">The template includes support for providing credentials via common environment variables.</span></span> <span data-ttu-id="15092-345">Клиент может передать учетные данные хранилища следующим образом:</span><span class="sxs-lookup"><span data-stu-id="15092-345">Your client can pass the storage credentials as follows:</span></span>

```csharp
job.CommonEnvironmentSettings = new [] {
    new EnvironmentSetting("LINKED_STORAGE_ACCOUNT", "{storageAccountName}"),
    new EnvironmentSetting("LINKED_STORAGE_KEY", "{storageAccountKey}"),
};
```

<span data-ttu-id="15092-346">Затем учетная запись хранения становится доступной в свойстве `_configuration.StorageAccount` класса TaskProcessor.</span><span class="sxs-lookup"><span data-stu-id="15092-346">The storage account is then available in the TaskProcessor class via the `_configuration.StorageAccount` property.</span></span>

<span data-ttu-id="15092-347">Если вы предпочитаете использовать URL-адрес контейнера с SAS, их также можно передать в общих параметрах среды задания. Однако в настоящее время в шаблон "Обработчик задач" не встроена поддержка этой возможности.</span><span class="sxs-lookup"><span data-stu-id="15092-347">If you prefer to use a container URL with SAS, you can also pass this via an job common environment setting, but the task processor template does not currently include built-in support for this.</span></span>

<span data-ttu-id="15092-348">**Настройка хранилища**</span><span class="sxs-lookup"><span data-stu-id="15092-348">**Storage setup**</span></span>

<span data-ttu-id="15092-349">Рекомендуется, чтобы клиент или задание обработчика заданий создавали контейнеры, необходимые задачам, прежде чем добавлять задачи в задание.</span><span class="sxs-lookup"><span data-stu-id="15092-349">It is recommended that the client or job manager task create any containers required by tasks before adding the tasks to the job.</span></span> <span data-ttu-id="15092-350">Это обязательно, если URL-адрес контейнера используется с SAS, так как такой URL-адрес не включает разрешение на создание контейнера.</span><span class="sxs-lookup"><span data-stu-id="15092-350">This is mandatory if you use a container URL with SAS, as such a URL does not include permission to create the container.</span></span> <span data-ttu-id="15092-351">Это рекомендуется сделать даже при передаче учетных данных учетной записи хранения, так как при вызове CloudBlobContainer.CreateIfNotExistsAsync для контейнера сохраняются все задачи.</span><span class="sxs-lookup"><span data-stu-id="15092-351">It is recommended even if you pass storage account credentials, as it saves every task having to call CloudBlobContainer.CreateIfNotExistsAsync on the container.</span></span>

## <a name="pass-parameters-and-environment-variables"></a><span data-ttu-id="15092-352">Передача параметров и переменных среды</span><span class="sxs-lookup"><span data-stu-id="15092-352">Pass parameters and environment variables</span></span>
### <a name="pass-environment-settings"></a><span data-ttu-id="15092-353">Передача параметров среды</span><span class="sxs-lookup"><span data-stu-id="15092-353">Pass environment settings</span></span>
<span data-ttu-id="15092-354">Клиент может передать сведения задаче диспетчера заданий в виде параметров среды.</span><span class="sxs-lookup"><span data-stu-id="15092-354">A client can pass information to the job manager task in the form of environment settings.</span></span> <span data-ttu-id="15092-355">Затем эти сведения может использовать задача диспетчера заданий при создании задач соответствующего обработчика, которые будут выполняться как часть вычислительного задания.</span><span class="sxs-lookup"><span data-stu-id="15092-355">This information can then be used by the job manager task when generating the task processor tasks that will run as part of the compute job.</span></span> <span data-ttu-id="15092-356">Ниже приведены примеры сведений, которые можно передать в качестве параметров среды:</span><span class="sxs-lookup"><span data-stu-id="15092-356">Examples of the information that you can pass as environment settings are:</span></span>

* <span data-ttu-id="15092-357">имя учетной записи хранения и ключ учетной записи;</span><span class="sxs-lookup"><span data-stu-id="15092-357">Storage account name and account keys</span></span>
* <span data-ttu-id="15092-358">URL-адрес учетной записи пакетной службы;</span><span class="sxs-lookup"><span data-stu-id="15092-358">Batch account URL</span></span>
* <span data-ttu-id="15092-359">ключ учетной записи пакетной службы.</span><span class="sxs-lookup"><span data-stu-id="15092-359">Batch account key</span></span>

<span data-ttu-id="15092-360">В пакетной службе предусмотрен простой механизм передачи параметров среды в задаче диспетчера заданий. Для этого нужно использовать свойство `EnvironmentSettings` в [Microsoft.Azure.Batch.JobManagerTask][net_jobmanagertask].</span><span class="sxs-lookup"><span data-stu-id="15092-360">The Batch service has a simple mechanism to pass environment settings to a job manager task by using the `EnvironmentSettings` property in [Microsoft.Azure.Batch.JobManagerTask][net_jobmanagertask].</span></span>

<span data-ttu-id="15092-361">Например, чтобы получить экземпляр `BatchClient` для учетной записи пакетной службы, в качестве переменных среды из клиентского кода можно передать URL-адрес и учетные данные общего ключа для учетной записи пакетной службы.</span><span class="sxs-lookup"><span data-stu-id="15092-361">For example, to get the `BatchClient` instance for a Batch account, you can pass as environment variables from the client code the URL and shared key credentials for the Batch account.</span></span> <span data-ttu-id="15092-362">Аналогично для получения доступа к учетной записи хранения, связанной с учетной записью пакетной службы, в качестве переменных среды можно передать имя и ключ учетной записи хранения.</span><span class="sxs-lookup"><span data-stu-id="15092-362">Likewise, to access the storage account that is linked to the Batch account, you can pass the storage account name and the storage account key as environment variables.</span></span>

### <a name="pass-parameters-to-the-job-manager-template"></a><span data-ttu-id="15092-363">Передача параметров в шаблон "Диспетчер заданий"</span><span class="sxs-lookup"><span data-stu-id="15092-363">Pass parameters to the Job Manager template</span></span>
<span data-ttu-id="15092-364">Во многих случаях полезно передать параметры конкретного задания в задачу диспетчера заданий, чтобы управлять процессом разделения заданий или настроить задачи для задания.</span><span class="sxs-lookup"><span data-stu-id="15092-364">In many cases, it's useful to pass per-job parameters to the job manager task, either to control the job splitting process or to configure the tasks for the job.</span></span> <span data-ttu-id="15092-365">Это можно сделать, загрузив JSON-файл с именем parameters.json в качестве файла ресурсов для задачи диспетчера заданий.</span><span class="sxs-lookup"><span data-stu-id="15092-365">You can do this by uploading a JSON file named parameters.json as a resource file for the job manager task.</span></span> <span data-ttu-id="15092-366">После этого параметры станут доступными в поле `JobSplitter._parameters` шаблона "Диспетчер заданий".</span><span class="sxs-lookup"><span data-stu-id="15092-366">The parameters can then become available in the `JobSplitter._parameters` field in the Job Manager template.</span></span>

> [!NOTE]
> <span data-ttu-id="15092-367">Встроенный обработчик параметров поддерживает только строчные словари.</span><span class="sxs-lookup"><span data-stu-id="15092-367">The built-in parameter handler supports only string-to-string dictionaries.</span></span> <span data-ttu-id="15092-368">Если требуется передать сложные значения JSON в качестве значений параметров, их необходимо передать в качестве строки и проанализировать в разделителе заданий или изменить метод платформы `Configuration.GetJobParameters`.</span><span class="sxs-lookup"><span data-stu-id="15092-368">If you want to pass complex JSON values as parameter values, you will need to pass these as strings and parse them in the job splitter, or modify the framework's `Configuration.GetJobParameters` method.</span></span>
> 
> 

### <a name="pass-parameters-to-the-task-processor-template"></a><span data-ttu-id="15092-369">Передача параметров в шаблон "Обработчик задач"</span><span class="sxs-lookup"><span data-stu-id="15092-369">Pass parameters to the Task Processor template</span></span>
<span data-ttu-id="15092-370">Параметры можно также передавать в отдельные задачи, реализованные с помощью шаблона "Обработчик задач".</span><span class="sxs-lookup"><span data-stu-id="15092-370">You can also pass parameters to individual tasks implemented using the Task Processor template.</span></span> <span data-ttu-id="15092-371">Так же как и в случае с шаблоном "Диспетчер заданий", шаблон "Обработчик задач" выполняет поиск файла ресурсов с именем</span><span class="sxs-lookup"><span data-stu-id="15092-371">Just as with the job manager template, the task processor template looks for a resource file named</span></span>

<span data-ttu-id="15092-372">parameters.json. Если он найден, он загружается в качестве словаря параметров.</span><span class="sxs-lookup"><span data-stu-id="15092-372">parameters.json, and if found it loads it as the parameters dictionary.</span></span> <span data-ttu-id="15092-373">Существует несколько способов передачи параметров задачам обработчика задач:</span><span class="sxs-lookup"><span data-stu-id="15092-373">There are a couple of options for how to pass parameters to the task processor tasks:</span></span>

* <span data-ttu-id="15092-374">Повторное использование параметров задания JSON.</span><span class="sxs-lookup"><span data-stu-id="15092-374">Reuse the job parameters JSON.</span></span> <span data-ttu-id="15092-375">Это подходит, если представлены только параметры уровня задания (например, высота и ширина отрисовки).</span><span class="sxs-lookup"><span data-stu-id="15092-375">This works well if the only parameters are job-wide ones (for example, a render height and width).</span></span> <span data-ttu-id="15092-376">Для этого при создании CloudTask в разделителе заданий нужно добавить ссылку на объект файла ресурсов parameters.json из коллекции ResourceFiles задачи диспетчера заданий (`JobSplitter._jobManagerTask.ResourceFiles`) в коллекцию ResourceFiles объекта CloudTask.</span><span class="sxs-lookup"><span data-stu-id="15092-376">To do this, when creating a CloudTask in the job splitter, add a reference to the parameters.json resource file object from the job manager task's ResourceFiles (`JobSplitter._jobManagerTask.ResourceFiles`) to the CloudTask's ResourceFiles collection.</span></span>
* <span data-ttu-id="15092-377">Создание и отправка документа parameters.json конкретной задачи при выполнении разделителя заданий и создание ссылки на большой двоичный объект в коллекции файлов ресурсов задачи.</span><span class="sxs-lookup"><span data-stu-id="15092-377">Generate and upload a task-specific parameters.json document as part of job splitter execution, and reference that blob in the task's resource files collection.</span></span> <span data-ttu-id="15092-378">Это необходимо, если в разных задачах используются разные параметры.</span><span class="sxs-lookup"><span data-stu-id="15092-378">This is necessary if different tasks have different parameters.</span></span> <span data-ttu-id="15092-379">Примером может служить сценарий отрисовки 3D-данных, где индекс кадра передается задаче в качестве параметра.</span><span class="sxs-lookup"><span data-stu-id="15092-379">An example might be a 3D rendering scenario where the frame index is passed to the task as a parameter.</span></span>

> [!NOTE]
> <span data-ttu-id="15092-380">Встроенный обработчик параметров поддерживает только строчные словари.</span><span class="sxs-lookup"><span data-stu-id="15092-380">The built-in parameter handler supports only string-to-string dictionaries.</span></span> <span data-ttu-id="15092-381">Если требуется передать сложные значения JSON в качестве значений параметров, их необходимо передать в качестве строки и проанализировать в обработчике задач или изменить метод платформы `Configuration.GetTaskParameters`.</span><span class="sxs-lookup"><span data-stu-id="15092-381">If you want to pass complex JSON values as parameter values, you will need to pass these as strings and parse them in the task processor, or modify the framework's `Configuration.GetTaskParameters` method.</span></span>
> 
> 

## <a name="next-steps"></a><span data-ttu-id="15092-382">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="15092-382">Next steps</span></span>
### <a name="persist-job-and-task-output-to-azure-storage"></a><span data-ttu-id="15092-383">Сохранение выходных данных заданий и задач в службе хранилища Azure</span><span class="sxs-lookup"><span data-stu-id="15092-383">Persist job and task output to Azure Storage</span></span>
<span data-ttu-id="15092-384">Еще одно полезное средство в разработке решений пакетной службы — [Azure Batch File Conventions][nuget_package].</span><span class="sxs-lookup"><span data-stu-id="15092-384">Another helpful tool in Batch solution development is [Azure Batch File Conventions][nuget_package].</span></span> <span data-ttu-id="15092-385">Эта библиотека классов .NET (сейчас доступна предварительная версия) позволяет приложениям .NET пакетной службы легко сохранять выходные данные задач в службе хранилища Azure и извлекать их из нее.</span><span class="sxs-lookup"><span data-stu-id="15092-385">Use this .NET class library (currently in preview) in your Batch .NET applications to easily store and retrieve task outputs to and from Azure Storage.</span></span> <span data-ttu-id="15092-386">[Сохранение выходных данных заданий и задач пакетной службы Azure](batch-task-output.md) содержится полное описание библиотеки и сведения о ее использовании.</span><span class="sxs-lookup"><span data-stu-id="15092-386">[Persist Azure Batch job and task output](batch-task-output.md) contains a full discussion of the library and its usage.</span></span>

### <a name="batch-forum"></a><span data-ttu-id="15092-387">Форум по Пакетной службе</span><span class="sxs-lookup"><span data-stu-id="15092-387">Batch Forum</span></span>
<span data-ttu-id="15092-388">На [форуме по пакетной службе Azure][forum] на сайте MSDN можно обсудить пакетную службу и задать вопросы о ней.</span><span class="sxs-lookup"><span data-stu-id="15092-388">The [Azure Batch Forum][forum] on MSDN is a great place to discuss Batch and ask questions about the service.</span></span> <span data-ttu-id="15092-389">Изучайте полезные «прикрепленные» сообщения и задавайте вопросы, возникающие во время сборки пакетных решений.</span><span class="sxs-lookup"><span data-stu-id="15092-389">Head on over for helpful "sticky" posts, and post your questions as they arise while you build your Batch solutions.</span></span>

[forum]: https://social.msdn.microsoft.com/forums/azure/en-US/home?forum=azurebatch
[net_jobmanagertask]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.jobmanagertask.aspx
[github_samples]: https://github.com/Azure/azure-batch-samples
[nuget_package]: https://www.nuget.org/packages/Microsoft.Azure.Batch.Conventions.Files
[process_exitcode]: https://msdn.microsoft.com/library/system.diagnostics.process.exitcode.aspx
[vs_gallery]: https://visualstudiogallery.msdn.microsoft.com/
[vs_gallery_templates]: https://go.microsoft.com/fwlink/?linkid=820714
[vs_find_use_ext]: https://msdn.microsoft.com/library/dd293638.aspx

[diagram01]: ./media/batch-visual-studio-templates/diagram01.png
[solution_explorer01]: ./media/batch-visual-studio-templates/solution_explorer01.png
[solution_explorer02]: ./media/batch-visual-studio-templates/solution_explorer02.png

---
title: "Использование ресурсоемких виртуальных машин Azure в пакетной службе | Документация Майкрософт"
description: "Узнайте, как воспользоваться преимуществами размеров виртуальных машин с поддержкой RDMA или графического процессора (GPU) в пулах пакетной службы Azure."
services: batch
documentationcenter: 
author: dlepow
manager: timlt
editor: 
ms.assetid: 
ms.service: batch
ms.workload: big-compute
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/31/2017
ms.author: danlep
ms.openlocfilehash: 26cab5ba892d892e035bd94c52cacabd23eebd0c
ms.sourcegitcommit: 2a70752d0987585d480f374c3e2dba0cd5097880
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/19/2018
---
# <a name="use-rdma-capable-or-gpu-enabled-instances-in-batch-pools"></a>Использование экземпляров с поддержкой RDMA или графического процессора (GPU) в пулах пакетной службы

Для выполнения некоторых пакетных заданий можно воспользоваться размерами виртуальных машин Azure, предназначенными для крупномасштабных вычислений. Например, для запуска [рабочих нагрузок MPI](batch-mpi.md) с несколькими экземплярами можно выбрать размеры A8, A9 или серии H, имеющие сетевой интерфейс для удаленного доступа к памяти (RDMA). Эти размеры подключаются к сети InfiniBand для обмена данными между узлами, что может ускорить приложения MPI. Для приложений CUDA можно выбрать размеры серии N, которые включают карты графического процессора (GPU) NVIDIA Tesla.

Эта статья содержит рекомендации и примеры для использования некоторых специализированных размеров Azure в пулах пакетной службы. Спецификации и общие сведения см. по следующим ссылкам:

* размеры виртуальных машин, оптимизированных для высокопроизводительных вычислений ([Linux](../virtual-machines/linux/sizes-hpc.md), [Windows](../virtual-machines/windows/sizes-hpc.md)); 

* размеры виртуальных машин с поддержкой графического процессора (GPU) ([Linux](../virtual-machines/linux/sizes-gpu.md), [Windows](../virtual-machines/windows/sizes-gpu.md)). 


## <a name="subscription-and-account-limits"></a>Ограничения подписки и учетной записи

* **Квоты**. [Выделенная квота на ядра на одну учетную запись пакетной службы](batch-quota-limit.md#resource-quotas) может ограничить количество и тип узлов, которые можно добавить в пул пакетной службы. Скорее всего, вы достигнете квоты при выборе размеров многоядерных виртуальных машин с поддержкой RDMA, графического процессора (GPU) и т. п. По умолчанию задана квота в 20 ядер. Отдельная квота применяется к [виртуальным машинам с низким приоритетом](batch-low-pri-vms.md) (если они используются). 

Если нужно увеличить квоту, [отправьте запрос в службу поддержки](../azure-supportability/how-to-create-azure-support-request.md). Это бесплатная услуга.

* **Доступность в регионах.** Виртуальные машины для ресурсоемких вычислений могут быть недоступны в регионах, где вы создаете учетные записи пакетной службы. Чтобы убедиться, что размер доступен, перейдите на страницу [Доступность продуктов по регионам](https://azure.microsoft.com/regions/services/).


## <a name="dependencies"></a>Зависимости

Возможности RDMA и GPU размеров для ресурсоемких вычислений поддерживаются только в некоторых операционных системах. Вам может потребоваться установить или настроить дополнительный драйвер или другое программное обеспечение в зависимости от операционной системы. В указанной ниже таблице представлены сведения об этих зависимостях. Перейдите по ссылке, чтобы просмотреть дополнительные сведения. Варианты настройки пулов пакетной службы см. далее в этой статье.


### <a name="linux-pools---virtual-machine-configuration"></a>Пулы Linux — конфигурация виртуальной машины

| Размер | Функция | Операционные системы | Необходимое программное обеспечение | Параметры пула |
| -------- | -------- | ----- |  -------- | ----- |
| [H16r, H16mr, A8, A9](../virtual-machines/linux/sizes-hpc.md#rdma-capable-instances) | RDMA | Ubuntu 16.04 LTS<br/>SUSE Linux Enterprise Server 12 HPC или<br/>Экземпляр HPC на платформе CentOS<br/>(Microsoft Azure Marketplace) | Intel MPI 5 | Включение связи между узлами, отключение параллельного выполнения задач |
| [Серия NC*](../virtual-machines/linux/n-series-driver-setup.md#install-cuda-drivers-for-nc-ncv2-and-nd-vms) | Графический процессор NVIDIA Tesla K80 | Ubuntu 16.04 LTS<br/>Red Hat Enterprise Linux 7.3 или<br/>Версия 7.3 на основе CentOS<br/>(Microsoft Azure Marketplace) | Драйверы для набора средств NVIDIA CUDA Toolkit 9.0 | Недоступно | 
| [Серия NV](../virtual-machines/linux/n-series-driver-setup.md#install-grid-drivers-for-nv-vms) | Графический процессор NVIDIA Tesla M60 | Ubuntu 16.04 LTS<br/>Red Hat Enterprise Linux 7.3 или<br/>Версия 7.3 на основе CentOS<br/>(Microsoft Azure Marketplace) | Драйверы для NVIDIA GRID 4.3 | Недоступно |

* Подключение RDMA на виртуальных машинах NC24r поддерживается в экземпляре HPC на платформе Ubuntu 16.04 LTS или CentOS-based 7.3 (из Azure Marketplace) с Intel MPI.



### <a name="windows-pools---virtual-machine-configuration"></a>Пулы Windows — конфигурация виртуальной машины

| Размер | Функция | Операционные системы | Необходимое программное обеспечение | Параметры пула |
| -------- | ------ | -------- | -------- | ----- |
| [H16r, H16mr, A8, A9](../virtual-machines/windows/sizes-hpc.md#rdma-capable-instances) | RDMA | Windows Server 2012 R2 или<br/>Windows Server 2012 (Microsoft Azure Marketplace) | Microsoft MPI 2012 R2 или более поздней версии либо<br/> Intel MPI 5<br/><br/>Расширение виртуальных машин Azure HpcVMDrivers | Включение связи между узлами, отключение параллельного выполнения задач |
| [Серия NC*](../virtual-machines/windows/n-series-driver-setup.md) | Графический процессор NVIDIA Tesla K80 | Windows Server 2016 или <br/>Windows Server 2012 R2 (Microsoft Azure Marketplace) | Драйверы NVIDIA Tesla или драйверы набора средств CUDA Toolkit 9.0| Недоступно | 
| [Серия NV](../virtual-machines/windows/n-series-driver-setup.md) | Графический процессор NVIDIA Tesla M60 | Windows Server 2016 или<br/>Windows Server 2012 R2 (Microsoft Azure Marketplace) | Драйверы для NVIDIA GRID 4.3 | Недоступно |

* Подключение RDMA на виртуальных машинах NC24r поддерживается на Windows Server 2012 R2 (из Azure Marketplace) с расширением HpcVMDrivers и Microsoft MPI или Intel MPI.

### <a name="windows-pools---cloud-services-configuration"></a>Пулы Windows — конфигурация облачных служб

> [!NOTE]
> Размеры серии N не поддерживаются в пулах пакетной службы с использованием конфигурации облачных служб.
>

| Размер | Функция | Операционные системы | Необходимое программное обеспечение | Параметры пула |
| -------- | ------- | -------- | -------- | ----- |
| [H16r, H16mr, A8, A9](../virtual-machines/windows/sizes-hpc.md#rdma-capable-instances) | RDMA | Windows Server 2012 R2,<br/>Windows Server 2012 или<br/>Windows Server 2008 R2 (семейство версий гостевой ОС) | Microsoft MPI 2012 R2 или более поздней версии либо<br/>Intel MPI 5<br/><br/>Расширение виртуальных машин Azure HpcVMDrivers | Включение связи между узлами,<br/> отключение параллельного выполнения задач |





## <a name="pool-configuration-options"></a>Варианты настройки пула

Для настройки специализированного размера виртуальной машины для пула пакетной службы интерфейсы API и средства пакетной службы предоставляют несколько вариантов для установки необходимого программного обеспечения или драйверов, включая следующее:

* [Задача запуска](batch-api-basics.md#start-task) — отправка пакета установки в качестве файла ресурса в учетную запись хранения Azure в тот же регион, где находится учетная запись пакетной службы. Создайте командную строку задачи запуска, чтобы автоматически установить файл ресурса во время запуска пула. Дополнительные сведения см. в [документации по REST API](/rest/api/batchservice/add-a-pool-to-an-account#bk_starttask).

  > [!NOTE] 
  > Задача запуска должна выполняться с повышенным уровнем разрешений (администратора) и должна дождаться успешного выполнения.
  >

* [Пакет приложения](batch-application-packages.md) — добавление сжатого ZIP-пакета установки в учетную запись пакетной службы и настройка ссылки на пакет в пуле. Этот параметр отправляет и распаковывает пакет на всех узлах в пуле. Если это пакет установки, создайте командную строку задачи запуска, чтобы автоматически установить приложение на всех узлах пула. При необходимости установите пакет, если на узле запланировано выполнение задачи.

* [Пользовательский образ пула](batch-custom-images.md) — создание пользовательского образа виртуальной машины Windows или Linux, содержащего драйверы, программное обеспечение и другие настройки, необходимые для размера виртуальной сети. 

* [Batch Shipyard](https://github.com/Azure/batch-shipyard) автоматически настраивает графический процессор и RDMA для прозрачной работы с контейнерными рабочими нагрузками в пакетной службе Azure. Для выполнения действий Batch Shipyard полностью полагается на файлы конфигурации. Существует много примеров шаблонов конфигураций, поддерживающих рабочие нагрузки GPU и RDMA, например [шаблон CNTK GPU](https://github.com/Azure/batch-shipyard/tree/master/recipes/CNTK-GPU-OpenMPI), с помощью которого можно предварительно настроить драйверы GPU на виртуальных машинах серии N и загрузить программное обеспечение набора средств Microsoft Cognitive Toolkit как образ Docker.


## <a name="example-microsoft-mpi-on-an-a8-vm-pool"></a>Пример: Microsoft MPI в пуле виртуальной машины A8

Чтобы запустить приложения Windows MPI в пуле узлов Azure A8, необходимо установить поддерживающую реализацию MPI. Ниже приведены примеры действий для установки [Microsoft MPI](https://msdn.microsoft.com/library/bb524831(v=vs.85).aspx) в пуле Windows с помощью пакета приложения пакетной службы.

1. Скачайте [пакет установки](http://go.microsoft.com/FWLink/p/?LinkID=389556) (MSMpiSetup.exe) для последней версии Microsoft MPI.
2. Создайте ZIP-файл пакета.
3. Отправьте пакет в учетную запись пакетной службы. Пошаговые инструкции см. в руководстве для [пакетов приложений](batch-application-packages.md). Укажите идентификатор приложения, например *MSMPI*, и его версию, например *8.1*. 
4. Используйте API пакетной службы или портал Azure для создания пула в конфигурации облачных служб с нужным количеством узлов и необходимым масштабом. В следующей таблице приведены примеры параметров для настройки MPI в автоматическом режиме с помощью задачи запуска:

| Параметр | Значение |
| ---- | ----- | 
| **Тип образа** | Облачные службы |
| **Семейство ОС** | Windows Server 2012 R2 (семейство ОС 4) |
| **Размер узла** | A8 уровня "Стандартный" |
| **Включена связь между узлами** | Истина |
| **Максимальное число заданий на узел** | 1 |
| **Ссылки на пакет приложения** | MSMPI |
| **Start task enabled** (Включена задача запуска) | Истина<br>**Командная строка** - `"cmd /c %AZ_BATCH_APP_PACKAGE_MSMPI#8.1%\\MSMpiSetup.exe -unattend -force"`<br/>**Удостоверение пользователя.** Автоматический пользователь пула, администратор<br/>**Ожидать успешное выполнение.** True

## <a name="example-nvidia-tesla-drivers-on-nc-vm-pool"></a>Пример: драйверы NVIDIA Tesla в пуле виртуальных машин NC

Чтобы запустить приложения CUDA в пуле узлов NC под управлением Linux, необходимо установить на узлах набор средств CUDA Toolkit 9.0. Этот набор средств позволяет установить необходимые драйверы графического процессора NVIDIA Tesla. Далее приведены примеры действий для развертывания пользовательского образа Ubuntu 16.04 LTS с драйверами графического процессора.

1. Разверните виртуальную машину Azure NC6 под управлением Ubuntu 16.04 LTS. Например, создайте виртуальную машину в юго-центральном регионе США. Виртуальная машина должна быть создана с помощью управляемого диска.
2. Выполните соответствующие инструкции, чтобы подключить виртуальную машину и [установить драйверы CUDA](../virtual-machines/linux/n-series-driver-setup.md#install-cuda-drivers-for-nc-ncv2-and-nd-vms).
3. Отмените подготовку агента Linux, а затем [запишите образ виртуальной машины Linux](../virtual-machines/linux/capture-image.md).
4. Создайте учетную запись пакетной службы в регионе, поддерживающем виртуальные машины NC.
5. Используйте API пакетной службы или портал Azure для создания пула [с помощью пользовательского образа](batch-custom-images.md) с нужным числом узлов и в нужном масштабе. В следующей таблице приведены примеры параметров пула для образа:

| Параметр | Значение |
| ---- | ---- |
| **Тип образа** | Пользовательский образ |
| **Пользовательский образ** | Имя образа |
| **Номер SKU агента узла** | batch.node.ubuntu 16.04 |
| **Размер узла** | NC6 уровня "Стандартный" |



## <a name="next-steps"></a>Дополнительная информация

* Для выполнения заданий MPI в пуле пакетной службы Azure ознакомьтесь с примерами для [Windows](batch-mpi.md) или [Linux](https://blogs.technet.microsoft.com/windowshpc/2016/07/20/introducing-mpi-support-for-linux-on-azure-batch/).

* Примеры рабочих нагрузок графического процессора в пакетной службе см. в инструкциях для [Batch Shipyard](https://github.com/Azure/batch-shipyard/).
---
title: "Устранение неполадок шифрования дисков Azure | Документация Майкрософт"
description: "В этой статье приведены советы по устранению неполадок в шифровании дисков Microsoft Azure для виртуальных машин IaaS под управлением Windows и Linux."
services: security
documentationcenter: na
author: deventiwari
manager: avibm
editor: yuridio
ms.assetid: ce0e23bd-07eb-43af-a56c-aa1a73bdb747
ms.service: security
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/27/2017
ms.author: devtiw
ms.openlocfilehash: 5f482a92b8fcd71a1b767fcc5741bc57605997ea
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="azure-disk-encryption-troubleshooting-guide"></a>Руководство по устранению неполадок шифрования дисков Azure

Это руководство предназначено для ИТ-специалистов, аналитиков в сфере информационной безопасности и администраторов облака, организации которых используют шифрование дисков Azure и которым нужно руководство по устранению неполадок, связанных с шифрованием дисков.

## <a name="troubleshooting-linux-os-disk-encryption"></a>Устранение неполадок шифрования диска ОС Linux

Для шифрования диска операционной системы Linux диск нужно отсоединить перед запуском процесса полного шифрования.   Если это невозможно, отобразится сообщение об ошибке "не удалось отключить после...".

Это наиболее вероятно при попытке шифрования диска ОС в целевой среде виртуальной машины, чей готовый образ из коллекции был изменен.  Примеры отклонения от поддерживаемого образа, которые могут мешать предоставляемой расширением возможности отключать диск ОС, включают:
- Настраиваемые образы, которые больше не соответствуют поддерживаемой файловой системе или схеме секционирования.
- Настраиваемые образы с приложениями, такими как Docker, SAP, MongoDB или Apache Cassandra, которые выполняются в ОС перед шифрованием.  Работу этих приложений трудно завершить. Если они сохраняют открытые дескрипторы файлов на диске операционной системы, то диск невозможно отключить, что приводит к сбою.
- Пользовательские сценарии, которые выполняются практически одновременно с шифрованием, могут мешать отключению диска и привести к сбою. Это может произойти, если шаблон Resource Manager определяет несколько расширений для одновременного выполнения или когда пользовательское расширение скрипта или другое действие выполняется одновременно с шифрованием диска.   Сериализация и изоляция таких шагов может решить проблему.
- Если SELinux не был отключен перед включением шифрования, шаг отключения диска завершается ошибкой.  SELinux можно будет снова включить после завершения шифрования.
- Если диск операционной системы использует схему LVM (при этом доступна ограниченная поддержка диска данных LVM, но диск операционной системы LVM не поддерживается).
- Если минимальные требования к памяти не выполняются (для шифрования диска операционной системы рекомендуется 7 ГБ памяти).
- Когда диски данных рекурсивно подключены в каталоге /mnt/ или любом другом (например, /mnt/data1, /mnt/data2, /data3 + /data3/data4 и т. д.).
- Если другие [предварительные требования](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption) к шифрованию дисков Azure для ОС Linux не выполнены.

## <a name="unable-to-encrypt"></a>Сбой шифрования

В некоторых случаях шифрование диска зависает на этапе "OS disk encryption started" (Начато шифрование диска ОС) и SSH отключается. При выполнении в готовом образе из коллекции процесс может занять от 3 до 16 часов.  Если добавляется диск данных объемом в несколько ТБ, процесс может занять несколько дней. При шифровании диска ОС Linux он временно отключается. Выполняется полное поблочное шифрование диска, а затем он переподключается в зашифрованном состоянии.   В отличие от шифрования дисков Azure в Windows во время шифрования диска в Linux нельзя использовать виртуальную машину.  Характеристики производительности виртуальной машины, включая размер диска и хранилище, связанное с учетной записью хранения (класса Standard или Premium (SSD)), могут оказать значительное влияние на время, необходимое для выполнения шифрования.

Чтобы проверить состояние, можно запросить поле ProgressMessage, возвращаемое из команды [Get-AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus).   Во время шифрования диска ОС виртуальная машина входит в состояние обслуживания, а также отключается SSH, чтобы предотвратить нарушение текущего процесса.  Во время выполнения шифрования большую часть времени будет отображаться сообщение EncryptionInProgress. Через несколько часов оно сменится сообщением VMRestartPending с предложением перезагрузить виртуальную машину.  Например:


```
PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : EncryptionInProgress
DataVolumesEncrypted       : EncryptionInProgress
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk encryption started

PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : VMRestartPending
DataVolumesEncrypted       : Encrypted
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk successfully encrypted, please reboot the VM
```

После появления запроса на перезагрузку виртуальной машины, ее перезагрузки и выполнения последних шагов по отношению к целевому объекту в течение 2–3 минут в сообщении состояния будет указано, что шифрование завершено.   Когда это сообщение появится, предполагается, что зашифрованный диск ОС готов к использованию, и виртуальную машину можно также снова использовать.

В случаях, когда эта последовательность не наблюдалась или сведения о загрузке, сообщение о ходе выполнения или другие индикаторы ошибок указывают на то, что произошел сбой во время процесса шифрования ОС (например, если вы видите ошибку "не удалось отключить", описанную в этом руководстве), рекомендуется восстановить виртуальную машину до состояния моментального снимка или резервной копии, сделанных перед шифрованием.  До следующей попытки рекомендуется еще раз оценить характеристики виртуальной машины и убедиться, что выполнены все необходимые предварительные требования.

## <a name="troubleshooting-azure-disk-encryption-behind-a-firewall"></a>Устранение неполадок шифрования диска Azure в связи с брандмауэром
Если подключение ограничивается брандмауэром, требованиями прокси-сервера или параметрами группы безопасности сети (NGS), возможности расширения выполнять необходимые задачи могут быть нарушены.   В результате могут возникнуть такие сообщения состояния, как Extension status not available on the VM (Состояние расширения не доступно на виртуальной машине), и произойти сбой предполагаемых сценариев.  В следующих разделах содержатся некоторые распространенные проблемы с брандмауэром.

### <a name="network-security-groups"></a>Группы безопасности сети
Любые применяемые параметры группы безопасности сети должны позволять конечной точке соответствовать предусмотренным [предварительным требованиям](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) к конфигурации сети для шифрования диска.

### <a name="azure-keyvault-behind-firewall"></a>Azure Key Vault под защитой брандмауэра
Виртуальная машина должна иметь доступ к хранилищу ключей. Дополнительные сведения о получении доступа к хранилищу ключей под защитой брандмауэра см. в статье [Доступ к хранилищу ключей Azure из-за брандмауэра](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall).

### <a name="linux-package-management-behind-firewall"></a>Управление пакетами Linux из-за брандмауэра
Во время шифрования диска Azure для Linux используется система управления пакетами целевого дистрибутива, которая устанавливает необходимые компоненты перед включением шифрования.  Если параметры брандмауэра не позволяют виртуальной машине скачивать и устанавливать эти компоненты, в дальнейшем могут произойти ошибки.    Действия по настройке этих параметров могут отличаться в разных дистрибутивах.  В Red Hat, когда требуется прокси-сервер, необходимо обеспечить правильную настройку диспетчера подписок и yum.  Дополнительные сведения о поддержке Red Hat см. в [этой статье](https://access.redhat.com/solutions/189533).  

## <a name="troubleshooting-windows-server-2016-server-core"></a>Устранение неполадок в основных серверных компонентах Windows Server 2016

По умолчанию компонент bdehdcfg недоступен в основных серверных компонентах Windows Server 2016. Этот компонент требуется для шифрования дисков Azure.

Чтобы решить эту проблему, скопируйте указанные ниже 4 файла из виртуальной машины центра обработки данных Windows Server 2016 в папку c:\windows\system32 образа основных серверных компонентов.

```
bdehdcfg.exe
bdehdcfglib.dll
bdehdcfglib.dll.mui
bdehdcfg.exe.mui
```

Затем выполните следующую команду:

```
bdehdcfg.exe -target default
```

Будет создан системный раздел размером 550 МБ. Затем после перезагрузки вы можете проверить тома с помощью DiskPart и продолжить работу.  

Например:

```
DISKPART> list vol

  Volume ###  Ltr  Label        Fs     Type        Size     Status     Info
  ----------  ---  -----------  -----  ----------  -------  ---------  --------
  Volume 0     C                NTFS   Partition    126 GB  Healthy    Boot
  Volume 1                      NTFS   Partition    550 MB  Healthy    System
  Volume 2     D   Temporary S  NTFS   Partition     13 GB  Healthy    Pagefile
```
## <a name="see-also"></a>См. также
В этом документе вы узнали о некоторых распространенных проблемах в шифровании дисков Azure и их устранении. Дополнительные сведения об этой службе и ее возможностях см. в статьях:

- [Шифрование диска в центре безопасности Azure](https://docs.microsoft.com/azure/security-center/security-center-apply-disk-encryption)
- [Шифрование виртуальной машины Azure](https://docs.microsoft.com/azure/security-center/security-center-disk-encryption)
- [Шифрование неактивных данных в Azure](https://docs.microsoft.com/azure/security/azure-security-encryption-atrest)

---
title: "Устранение неполадок шифрования дисков Azure | Документация Майкрософт"
description: "В этой статье приведены советы по устранению неполадок в шифровании дисков Microsoft Azure для виртуальных машин IaaS под управлением Windows и Linux."
services: security
documentationcenter: na
author: deventiwari
manager: avibm
editor: yuridio
ms.assetid: ce0e23bd-07eb-43af-a56c-aa1a73bdb747
ms.service: security
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/27/2017
ms.author: devtiw
ms.openlocfilehash: 5f482a92b8fcd71a1b767fcc5741bc57605997ea
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="azure-disk-encryption-troubleshooting-guide"></a><span data-ttu-id="3c829-103">Руководство по устранению неполадок шифрования дисков Azure</span><span class="sxs-lookup"><span data-stu-id="3c829-103">Azure Disk Encryption Troubleshooting Guide</span></span>

<span data-ttu-id="3c829-104">Это руководство предназначено для ИТ-специалистов, аналитиков в сфере информационной безопасности и администраторов облака, организации которых используют шифрование дисков Azure и которым нужно руководство по устранению неполадок, связанных с шифрованием дисков.</span><span class="sxs-lookup"><span data-stu-id="3c829-104">This guide is for information technology (IT) professionals, information security analysts, and cloud administrators whose organizations are using Azure disk encryption and need guidance to troubleshoot disk-encryption related issues.</span></span>

## <a name="troubleshooting-linux-os-disk-encryption"></a><span data-ttu-id="3c829-105">Устранение неполадок шифрования диска ОС Linux</span><span class="sxs-lookup"><span data-stu-id="3c829-105">Troubleshooting Linux OS disk encryption</span></span>

<span data-ttu-id="3c829-106">Для шифрования диска операционной системы Linux диск нужно отсоединить перед запуском процесса полного шифрования.</span><span class="sxs-lookup"><span data-stu-id="3c829-106">Linux OS disk encryption must unmount the OS drive prior to running it through the full disk encryption process.</span></span>   <span data-ttu-id="3c829-107">Если это невозможно, отобразится сообщение об ошибке</span><span class="sxs-lookup"><span data-stu-id="3c829-107">If it cannot, an error message of "failed to unmount after…"</span></span> <span data-ttu-id="3c829-108">"не удалось отключить после...".</span><span class="sxs-lookup"><span data-stu-id="3c829-108">error message is likely to occur.</span></span>

<span data-ttu-id="3c829-109">Это наиболее вероятно при попытке шифрования диска ОС в целевой среде виртуальной машины, чей готовый образ из коллекции был изменен.</span><span class="sxs-lookup"><span data-stu-id="3c829-109">This is most likely when OS disk encryption is attempted on a target VM environment that has been modified or changed from its supported stock gallery image.</span></span>  <span data-ttu-id="3c829-110">Примеры отклонения от поддерживаемого образа, которые могут мешать предоставляемой расширением возможности отключать диск ОС, включают:</span><span class="sxs-lookup"><span data-stu-id="3c829-110">Examples of deviations from the supported image, which can interfere with the extension’s ability to unmount the OS drive include:</span></span>
- <span data-ttu-id="3c829-111">Настраиваемые образы, которые больше не соответствуют поддерживаемой файловой системе или схеме секционирования.</span><span class="sxs-lookup"><span data-stu-id="3c829-111">Customized images that no longer match a supported file system and/or partitioning scheme.</span></span>
- <span data-ttu-id="3c829-112">Настраиваемые образы с приложениями, такими как Docker, SAP, MongoDB или Apache Cassandra, которые выполняются в ОС перед шифрованием.</span><span class="sxs-lookup"><span data-stu-id="3c829-112">Customized images with applications such as antivirus, Docker, SAP, MongoDB, or Apache Cassandra running in the OS prior to encryption.</span></span>  <span data-ttu-id="3c829-113">Работу этих приложений трудно завершить. Если они сохраняют открытые дескрипторы файлов на диске операционной системы, то диск невозможно отключить, что приводит к сбою.</span><span class="sxs-lookup"><span data-stu-id="3c829-113">These applications are difficult to terminate, and when they retain open file handles to the OS drive, the drive cannot be unmounted, causing failure.</span></span>
- <span data-ttu-id="3c829-114">Пользовательские сценарии, которые выполняются практически одновременно с шифрованием, могут мешать отключению диска и привести к сбою.</span><span class="sxs-lookup"><span data-stu-id="3c829-114">Custom scripts that run in close time proximity to the encryption step can interfere and cause this failure.</span></span> <span data-ttu-id="3c829-115">Это может произойти, если шаблон Resource Manager определяет несколько расширений для одновременного выполнения или когда пользовательское расширение скрипта или другое действие выполняется одновременно с шифрованием диска.</span><span class="sxs-lookup"><span data-stu-id="3c829-115">This can happen when a Resource Manager template defines multiple extensions to execute simultaneously, or when a custom script extension or other action is run simultaneously to disk encryption.</span></span>   <span data-ttu-id="3c829-116">Сериализация и изоляция таких шагов может решить проблему.</span><span class="sxs-lookup"><span data-stu-id="3c829-116">Serializing and isolating such steps may resolve the issue.</span></span>
- <span data-ttu-id="3c829-117">Если SELinux не был отключен перед включением шифрования, шаг отключения диска завершается ошибкой.</span><span class="sxs-lookup"><span data-stu-id="3c829-117">When SELinux has not been disabled prior to enabling encryption, the unmount step fails.</span></span>  <span data-ttu-id="3c829-118">SELinux можно будет снова включить после завершения шифрования.</span><span class="sxs-lookup"><span data-stu-id="3c829-118">SELinux can be re-enabled after encryption has completed.</span></span>
- <span data-ttu-id="3c829-119">Если диск операционной системы использует схему LVM (при этом доступна ограниченная поддержка диска данных LVM, но диск операционной системы LVM не поддерживается).</span><span class="sxs-lookup"><span data-stu-id="3c829-119">When the OS disk is using an LVM scheme (although limited LVM data disk support is available, LVM OS disk is not)</span></span>
- <span data-ttu-id="3c829-120">Если минимальные требования к памяти не выполняются (для шифрования диска операционной системы рекомендуется 7 ГБ памяти).</span><span class="sxs-lookup"><span data-stu-id="3c829-120">When minimum memory requirements are not met (7GB is suggested for OS disk encryption)</span></span>
- <span data-ttu-id="3c829-121">Когда диски данных рекурсивно подключены в каталоге /mnt/ или любом другом (например, /mnt/data1, /mnt/data2, /data3 + /data3/data4 и т. д.).</span><span class="sxs-lookup"><span data-stu-id="3c829-121">When data drives have been recursively mounted under /mnt/ directory, or each other (for example, /mnt/data1, /mnt/data2, /data3 + /data3/data4, etc.)</span></span>
- <span data-ttu-id="3c829-122">Если другие [предварительные требования](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption) к шифрованию дисков Azure для ОС Linux не выполнены.</span><span class="sxs-lookup"><span data-stu-id="3c829-122">When other Azure Disk Encryption [prerequisites](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption) for Linux are not met</span></span>

## <a name="unable-to-encrypt"></a><span data-ttu-id="3c829-123">Сбой шифрования</span><span class="sxs-lookup"><span data-stu-id="3c829-123">Unable to encrypt</span></span>

<span data-ttu-id="3c829-124">В некоторых случаях шифрование диска зависает на этапе "OS disk encryption started" (Начато шифрование диска ОС) и SSH отключается.</span><span class="sxs-lookup"><span data-stu-id="3c829-124">In some cases, the Linux disk encryption appears to be stuck at "OS disk encryption started" and SSH is disabled.</span></span> <span data-ttu-id="3c829-125">При выполнении в готовом образе из коллекции процесс может занять от 3 до 16 часов.</span><span class="sxs-lookup"><span data-stu-id="3c829-125">This process can take between 3-16 hours to complete on a stock gallery image.</span></span>  <span data-ttu-id="3c829-126">Если добавляется диск данных объемом в несколько ТБ, процесс может занять несколько дней.</span><span class="sxs-lookup"><span data-stu-id="3c829-126">If multi-TB size data disks are added, the process may take days.</span></span> <span data-ttu-id="3c829-127">При шифровании диска ОС Linux он временно отключается. Выполняется полное поблочное шифрование диска, а затем он переподключается в зашифрованном состоянии.</span><span class="sxs-lookup"><span data-stu-id="3c829-127">The Linux OS disk encryption sequence unmounts the OS drive temporarily, and performs block by block encryption of the entire OS disk, before remounting it in its encrypted state.</span></span>   <span data-ttu-id="3c829-128">В отличие от шифрования дисков Azure в Windows во время шифрования диска в Linux нельзя использовать виртуальную машину.</span><span class="sxs-lookup"><span data-stu-id="3c829-128">Unlike Azure Disk Encryption on Windows, Linux Disk Encryption does not allow concurrent use of the VM while the encryption is in progress.</span></span>  <span data-ttu-id="3c829-129">Характеристики производительности виртуальной машины, включая размер диска и хранилище, связанное с учетной записью хранения (класса Standard или Premium (SSD)), могут оказать значительное влияние на время, необходимое для выполнения шифрования.</span><span class="sxs-lookup"><span data-stu-id="3c829-129">The performance characteristics of the VM, including the size of the disk and whether the storage account is backed by standard or premium (SSD) storage, can greatly influence the time required to complete encryption.</span></span>

<span data-ttu-id="3c829-130">Чтобы проверить состояние, можно запросить поле ProgressMessage, возвращаемое из команды [Get-AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus).</span><span class="sxs-lookup"><span data-stu-id="3c829-130">To check status, the ProgressMessage field returned from the [Get-AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus) command can be polled.</span></span>   <span data-ttu-id="3c829-131">Во время шифрования диска ОС виртуальная машина входит в состояние обслуживания, а также отключается SSH, чтобы предотвратить нарушение текущего процесса.</span><span class="sxs-lookup"><span data-stu-id="3c829-131">While the OS drive is being encrypted, the VM enters a servicing state, and SSH is also disabled to prevent any disruption to the ongoing process.</span></span>  <span data-ttu-id="3c829-132">Во время выполнения шифрования большую часть времени будет отображаться сообщение EncryptionInProgress. Через несколько часов оно сменится сообщением VMRestartPending с предложением перезагрузить виртуальную машину.</span><span class="sxs-lookup"><span data-stu-id="3c829-132">EncryptionInProgress will be reported for the majority of the time while encryption is in progress, followed several hours later with a VMRestartPending message prompting to restart the VM.</span></span>  <span data-ttu-id="3c829-133">Например:</span><span class="sxs-lookup"><span data-stu-id="3c829-133">For example:</span></span>


```
PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : EncryptionInProgress
DataVolumesEncrypted       : EncryptionInProgress
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk encryption started

PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : VMRestartPending
DataVolumesEncrypted       : Encrypted
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk successfully encrypted, please reboot the VM
```

<span data-ttu-id="3c829-134">После появления запроса на перезагрузку виртуальной машины, ее перезагрузки и выполнения последних шагов по отношению к целевому объекту в течение 2–3 минут в сообщении состояния будет указано, что шифрование завершено.</span><span class="sxs-lookup"><span data-stu-id="3c829-134">Once prompted to reboot the VM, and after restarting the VM, and giving 2-3 minutes for the reboot and for final steps to be performed on the target, the status message will indicate that encryption has finally completed.</span></span>   <span data-ttu-id="3c829-135">Когда это сообщение появится, предполагается, что зашифрованный диск ОС готов к использованию, и виртуальную машину можно также снова использовать.</span><span class="sxs-lookup"><span data-stu-id="3c829-135">Once this message is available, the encrypted OS drive is expected to be ready for use and for the VM to be usable again.</span></span>

<span data-ttu-id="3c829-136">В случаях, когда эта последовательность не наблюдалась или сведения о загрузке, сообщение о ходе выполнения или другие индикаторы ошибок указывают на то, что произошел сбой во время процесса шифрования ОС (например, если вы видите ошибку "не удалось отключить", описанную в этом руководстве), рекомендуется восстановить виртуальную машину до состояния моментального снимка или резервной копии, сделанных перед шифрованием.</span><span class="sxs-lookup"><span data-stu-id="3c829-136">In cases where this sequence was not seen, or if boot information, progress message, or other error indicators report that OS encryption has failed in the middle of this process (for example if you are seeing the "failed to unmount" error described in this guide), it is recommended to restore the VM back to the snapshot or backup taken immediately prior to encryption.</span></span>  <span data-ttu-id="3c829-137">До следующей попытки рекомендуется еще раз оценить характеристики виртуальной машины и убедиться, что выполнены все необходимые предварительные требования.</span><span class="sxs-lookup"><span data-stu-id="3c829-137">Prior to the next attempt, it is suggested to re-evaluate the characteristics of the VM and ensure that all prerequisites are satisfied.</span></span>

## <a name="troubleshooting-azure-disk-encryption-behind-a-firewall"></a><span data-ttu-id="3c829-138">Устранение неполадок шифрования диска Azure в связи с брандмауэром</span><span class="sxs-lookup"><span data-stu-id="3c829-138">Troubleshooting Azure Disk Encryption behind a Firewall</span></span>
<span data-ttu-id="3c829-139">Если подключение ограничивается брандмауэром, требованиями прокси-сервера или параметрами группы безопасности сети (NGS), возможности расширения выполнять необходимые задачи могут быть нарушены.</span><span class="sxs-lookup"><span data-stu-id="3c829-139">When connectivity is restricted by a firewall, proxy requirement, or network security group (NSG) settings, the ability of the extension to perform needed tasks can be disrupted.</span></span>   <span data-ttu-id="3c829-140">В результате могут возникнуть такие сообщения состояния, как Extension status not available on the VM (Состояние расширения не доступно на виртуальной машине), и произойти сбой предполагаемых сценариев.</span><span class="sxs-lookup"><span data-stu-id="3c829-140">This can result in status messages such as "Extension status not available on the VM" and in expected scenarios failing to finish.</span></span>  <span data-ttu-id="3c829-141">В следующих разделах содержатся некоторые распространенные проблемы с брандмауэром.</span><span class="sxs-lookup"><span data-stu-id="3c829-141">The sections that follow has some common firewall issues that you may investigate.</span></span>

### <a name="network-security-groups"></a><span data-ttu-id="3c829-142">Группы безопасности сети</span><span class="sxs-lookup"><span data-stu-id="3c829-142">Network security groups</span></span>
<span data-ttu-id="3c829-143">Любые применяемые параметры группы безопасности сети должны позволять конечной точке соответствовать предусмотренным [предварительным требованиям](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) к конфигурации сети для шифрования диска.</span><span class="sxs-lookup"><span data-stu-id="3c829-143">Any network security group settings applied must still allow the endpoint to meet the documented network configuration [prerequisites](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) for disk encryption.</span></span>

### <a name="azure-keyvault-behind-firewall"></a><span data-ttu-id="3c829-144">Azure Key Vault под защитой брандмауэра</span><span class="sxs-lookup"><span data-stu-id="3c829-144">Azure Keyvault behind firewall</span></span>
<span data-ttu-id="3c829-145">Виртуальная машина должна иметь доступ к хранилищу ключей.</span><span class="sxs-lookup"><span data-stu-id="3c829-145">The VM must be able to access key vault.</span></span> <span data-ttu-id="3c829-146">Дополнительные сведения о получении доступа к хранилищу ключей под защитой брандмауэра см. в статье [Доступ к хранилищу ключей Azure из-за брандмауэра](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall).</span><span class="sxs-lookup"><span data-stu-id="3c829-146">Refer to guidance on access to key fault from behind a firewall that is maintained by the [Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall) team.</span></span>

### <a name="linux-package-management-behind-firewall"></a><span data-ttu-id="3c829-147">Управление пакетами Linux из-за брандмауэра</span><span class="sxs-lookup"><span data-stu-id="3c829-147">Linux package management behind firewall</span></span>
<span data-ttu-id="3c829-148">Во время шифрования диска Azure для Linux используется система управления пакетами целевого дистрибутива, которая устанавливает необходимые компоненты перед включением шифрования.</span><span class="sxs-lookup"><span data-stu-id="3c829-148">At run time, Azure Disk Encryption for Linux relies on the target distribution’s package management system to install needed prerequisite components prior to enabling encryption.</span></span>  <span data-ttu-id="3c829-149">Если параметры брандмауэра не позволяют виртуальной машине скачивать и устанавливать эти компоненты, в дальнейшем могут произойти ошибки.</span><span class="sxs-lookup"><span data-stu-id="3c829-149">If firewall settings prevent the VM from being able to download and install these components, then subsequent failures are expected.</span></span>    <span data-ttu-id="3c829-150">Действия по настройке этих параметров могут отличаться в разных дистрибутивах.</span><span class="sxs-lookup"><span data-stu-id="3c829-150">The steps to configure this may vary by distribution.</span></span>  <span data-ttu-id="3c829-151">В Red Hat, когда требуется прокси-сервер, необходимо обеспечить правильную настройку диспетчера подписок и yum.</span><span class="sxs-lookup"><span data-stu-id="3c829-151">On Red Hat, when a proxy is required, ensuring that subscription-manager and yum are set up properly is vital.</span></span>  <span data-ttu-id="3c829-152">Дополнительные сведения о поддержке Red Hat см. в [этой статье](https://access.redhat.com/solutions/189533).</span><span class="sxs-lookup"><span data-stu-id="3c829-152">See [this](https://access.redhat.com/solutions/189533) Red Hat support article on this topic.</span></span>  

## <a name="troubleshooting-windows-server-2016-server-core"></a><span data-ttu-id="3c829-153">Устранение неполадок в основных серверных компонентах Windows Server 2016</span><span class="sxs-lookup"><span data-stu-id="3c829-153">Troubleshooting Windows Server 2016 Server Core</span></span>

<span data-ttu-id="3c829-154">По умолчанию компонент bdehdcfg недоступен в основных серверных компонентах Windows Server 2016.</span><span class="sxs-lookup"><span data-stu-id="3c829-154">On Windows Server 2016 Server Core, the bdehdcfg component is not available by default.</span></span> <span data-ttu-id="3c829-155">Этот компонент требуется для шифрования дисков Azure.</span><span class="sxs-lookup"><span data-stu-id="3c829-155">This component is required by Azure Disk Encryption.</span></span>

<span data-ttu-id="3c829-156">Чтобы решить эту проблему, скопируйте указанные ниже 4 файла из виртуальной машины центра обработки данных Windows Server 2016 в папку c:\windows\system32 образа основных серверных компонентов.</span><span class="sxs-lookup"><span data-stu-id="3c829-156">To workaround this issue, copy the following 4 files from a Windows Server 2016 Data Center VM to the c:\windows\system32 folder of the Server Core image:</span></span>

```
bdehdcfg.exe
bdehdcfglib.dll
bdehdcfglib.dll.mui
bdehdcfg.exe.mui
```

<span data-ttu-id="3c829-157">Затем выполните следующую команду:</span><span class="sxs-lookup"><span data-stu-id="3c829-157">Then, run the following command:</span></span>

```
bdehdcfg.exe -target default
```

<span data-ttu-id="3c829-158">Будет создан системный раздел размером 550 МБ. Затем после перезагрузки вы можете проверить тома с помощью DiskPart и продолжить работу.</span><span class="sxs-lookup"><span data-stu-id="3c829-158">This will create a 550MB system partition and then after a reboot, you can use Diskpart to check the volumes, and proceed.</span></span>  

<span data-ttu-id="3c829-159">Например:</span><span class="sxs-lookup"><span data-stu-id="3c829-159">For example:</span></span>

```
DISKPART> list vol

  Volume ###  Ltr  Label        Fs     Type        Size     Status     Info
  ----------  ---  -----------  -----  ----------  -------  ---------  --------
  Volume 0     C                NTFS   Partition    126 GB  Healthy    Boot
  Volume 1                      NTFS   Partition    550 MB  Healthy    System
  Volume 2     D   Temporary S  NTFS   Partition     13 GB  Healthy    Pagefile
```
## <a name="see-also"></a><span data-ttu-id="3c829-160">См. также</span><span class="sxs-lookup"><span data-stu-id="3c829-160">See also</span></span>
<span data-ttu-id="3c829-161">В этом документе вы узнали о некоторых распространенных проблемах в шифровании дисков Azure и их устранении.</span><span class="sxs-lookup"><span data-stu-id="3c829-161">In this document, you learned more about some common issues in Azure disk encryption, and how to troubleshoot.</span></span> <span data-ttu-id="3c829-162">Дополнительные сведения об этой службе и ее возможностях см. в статьях:</span><span class="sxs-lookup"><span data-stu-id="3c829-162">For more information about this service and its capability read:</span></span>

- [<span data-ttu-id="3c829-163">Шифрование диска в центре безопасности Azure</span><span class="sxs-lookup"><span data-stu-id="3c829-163">Apply disk encryption in Azure Security Center</span></span>](https://docs.microsoft.com/azure/security-center/security-center-apply-disk-encryption)
- [<span data-ttu-id="3c829-164">Шифрование виртуальной машины Azure</span><span class="sxs-lookup"><span data-stu-id="3c829-164">Encrypt an Azure Virtual Machine</span></span>](https://docs.microsoft.com/azure/security-center/security-center-disk-encryption)
- [<span data-ttu-id="3c829-165">Шифрование неактивных данных в Azure</span><span class="sxs-lookup"><span data-stu-id="3c829-165">Azure Data Encryption-at-Rest</span></span>](https://docs.microsoft.com/azure/security/azure-security-encryption-atrest)

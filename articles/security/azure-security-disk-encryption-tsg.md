---
title: "Устранение неполадок шифрования диска aaaAzure | Документы Microsoft"
description: "В этой статье приведены советы по устранению неполадок в шифровании дисков Microsoft Azure для виртуальных машин IaaS под управлением Windows и Linux."
services: security
documentationcenter: na
author: deventiwari
manager: avibm
editor: yuridio
ms.assetid: ce0e23bd-07eb-43af-a56c-aa1a73bdb747
ms.service: security
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/27/2017
ms.author: devtiw
ms.openlocfilehash: 2ecb8df1fb869e3bf8f3be4be4494e6485e75695
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="azure-disk-encryption-troubleshooting-guide"></a><span data-ttu-id="f5004-103">Руководство по устранению неполадок шифрования дисков Azure</span><span class="sxs-lookup"><span data-stu-id="f5004-103">Azure Disk Encryption Troubleshooting Guide</span></span>

<span data-ttu-id="f5004-104">Это руководство предназначено для ИТ-специалистов, сведения аналитикам в области безопасности и проблем, связанных с администраторов облака, организации которых шифрования диска Azure и требуется руководство tootroubleshoot-шифрование диска.</span><span class="sxs-lookup"><span data-stu-id="f5004-104">This guide is for information technology (IT) professionals, information security analysts, and cloud administrators whose organizations are using Azure disk encryption and need guidance tootroubleshoot disk-encryption related issues.</span></span>

## <a name="troubleshooting-linux-os-disk-encryption"></a><span data-ttu-id="f5004-105">Устранение неполадок шифрования диска ОС Linux</span><span class="sxs-lookup"><span data-stu-id="f5004-105">Troubleshooting Linux OS disk encryption</span></span>

<span data-ttu-id="f5004-106">Шифрование диска операционной системы Linux необходимо отключить toorunning предыдущего диска hello ОС через процесс шифрование всего диска hello.</span><span class="sxs-lookup"><span data-stu-id="f5004-106">Linux OS disk encryption must unmount hello OS drive prior toorunning it through hello full disk encryption process.</span></span>   <span data-ttu-id="f5004-107">Если это невозможно, сообщение об ошибке «Ошибка toounmount после...»</span><span class="sxs-lookup"><span data-stu-id="f5004-107">If it cannot, an error message of "failed toounmount after…"</span></span> <span data-ttu-id="f5004-108">сообщение об ошибке: вероятно, toooccur.</span><span class="sxs-lookup"><span data-stu-id="f5004-108">error message is likely toooccur.</span></span>

<span data-ttu-id="f5004-109">Это наиболее вероятно при попытке шифрования диска ОС в целевой среде виртуальной машины, чей готовый образ из коллекции был изменен.</span><span class="sxs-lookup"><span data-stu-id="f5004-109">This is most likely when OS disk encryption is attempted on a target VM environment that has been modified or changed from its supported stock gallery image.</span></span>  <span data-ttu-id="f5004-110">Примеры отклонения от hello поддерживается изображения, которое может мешать hello расширение возможности toounmount hello ОС диска.</span><span class="sxs-lookup"><span data-stu-id="f5004-110">Examples of deviations from hello supported image, which can interfere with hello extension’s ability toounmount hello OS drive include:</span></span>
- <span data-ttu-id="f5004-111">Настраиваемые образы, которые больше не соответствуют поддерживаемой файловой системе или схеме секционирования.</span><span class="sxs-lookup"><span data-stu-id="f5004-111">Customized images that no longer match a supported file system and/or partitioning scheme.</span></span>
- <span data-ttu-id="f5004-112">Настроенных образов с приложений, таких как антивирусная программа, Docker, SAP, MongoDB или Cassandra Apache, работающих в предыдущих tooencryption hello ОС.</span><span class="sxs-lookup"><span data-stu-id="f5004-112">Customized images with applications such as antivirus, Docker, SAP, MongoDB, or Apache Cassandra running in hello OS prior tooencryption.</span></span>  <span data-ttu-id="f5004-113">Эти приложения является сложным tooterminate, и они сохраняют диск toohello ОС дескрипторов открытых файлов, hello диск не может быть отключены, которая привела к отказу.</span><span class="sxs-lookup"><span data-stu-id="f5004-113">These applications are difficult tooterminate, and when they retain open file handles toohello OS drive, hello drive cannot be unmounted, causing failure.</span></span>
- <span data-ttu-id="f5004-114">Пользовательские скрипты, выполняемые в закройте время шага шифрования toohello близости может повлиять и вызывает эту ошибку.</span><span class="sxs-lookup"><span data-stu-id="f5004-114">Custom scripts that run in close time proximity toohello encryption step can interfere and cause this failure.</span></span> <span data-ttu-id="f5004-115">Это может произойти, когда шаблона диспетчера ресурсов одновременно задает несколько расширений tooexecute или расширение пользовательского скрипта или другое действие выполняется одновременно toodisk шифрования.</span><span class="sxs-lookup"><span data-stu-id="f5004-115">This can happen when a Resource Manager template defines multiple extensions tooexecute simultaneously, or when a custom script extension or other action is run simultaneously toodisk encryption.</span></span>   <span data-ttu-id="f5004-116">Hello проблему может решить сериализации и изоляции такого действия.</span><span class="sxs-lookup"><span data-stu-id="f5004-116">Serializing and isolating such steps may resolve hello issue.</span></span>
- <span data-ttu-id="f5004-117">Если SELinux не было отключено предыдущих tooenabling шифрования, hello отключите шаг завершается ошибкой.</span><span class="sxs-lookup"><span data-stu-id="f5004-117">When SELinux has not been disabled prior tooenabling encryption, hello unmount step fails.</span></span>  <span data-ttu-id="f5004-118">SELinux можно будет снова включить после завершения шифрования.</span><span class="sxs-lookup"><span data-stu-id="f5004-118">SELinux can be re-enabled after encryption has completed.</span></span>
- <span data-ttu-id="f5004-119">Если диск hello ОС использует схему LVM (несмотря на то, что доступна ограниченная поддержка диск данных LVM, диска ОС LVM не)</span><span class="sxs-lookup"><span data-stu-id="f5004-119">When hello OS disk is using an LVM scheme (although limited LVM data disk support is available, LVM OS disk is not)</span></span>
- <span data-ttu-id="f5004-120">Если минимальные требования к памяти не выполняются (для шифрования диска операционной системы рекомендуется 7 ГБ памяти).</span><span class="sxs-lookup"><span data-stu-id="f5004-120">When minimum memory requirements are not met (7GB is suggested for OS disk encryption)</span></span>
- <span data-ttu-id="f5004-121">Когда диски данных рекурсивно подключены в каталоге /mnt/ или любом другом (например, /mnt/data1, /mnt/data2, /data3 + /data3/data4 и т. д.).</span><span class="sxs-lookup"><span data-stu-id="f5004-121">When data drives have been recursively mounted under /mnt/ directory, or each other (for example, /mnt/data1, /mnt/data2, /data3 + /data3/data4, etc.)</span></span>
- <span data-ttu-id="f5004-122">Если другие [предварительные требования](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption) к шифрованию дисков Azure для ОС Linux не выполнены.</span><span class="sxs-lookup"><span data-stu-id="f5004-122">When other Azure Disk Encryption [prerequisites](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption) for Linux are not met</span></span>

## <a name="unable-tooencrypt"></a><span data-ttu-id="f5004-123">Не удается tooencrypt</span><span class="sxs-lookup"><span data-stu-id="f5004-123">Unable tooencrypt</span></span>

<span data-ttu-id="f5004-124">В некоторых случаях шифрование диска Linux hello появляется toobe застрявшее в «Шифрование диска операционной системы к работе» и SSH отключена.</span><span class="sxs-lookup"><span data-stu-id="f5004-124">In some cases, hello Linux disk encryption appears toobe stuck at "OS disk encryption started" and SSH is disabled.</span></span> <span data-ttu-id="f5004-125">Этот процесс может занять от toocomplete 3-16 часов на стандартных коллекции образов.</span><span class="sxs-lookup"><span data-stu-id="f5004-125">This process can take between 3-16 hours toocomplete on a stock gallery image.</span></span>  <span data-ttu-id="f5004-126">При добавлении дисков данных несколькими ТБ размер hello может занять дни.</span><span class="sxs-lookup"><span data-stu-id="f5004-126">If multi-TB size data disks are added, hello process may take days.</span></span> <span data-ttu-id="f5004-127">Hello последовательности шифрования диска операционной системы Linux временное отключение диска ОС hello и выполняет шифрование поблочно hello всего диска операционной системы, прежде чем снова подключать его в зашифрованный состоянии.</span><span class="sxs-lookup"><span data-stu-id="f5004-127">hello Linux OS disk encryption sequence unmounts hello OS drive temporarily, and performs block by block encryption of hello entire OS disk, before remounting it in its encrypted state.</span></span>   <span data-ttu-id="f5004-128">В отличие от шифрования диска Azure в Windows шифрование диска Linux запрещается совместное использование виртуальных Машин hello hello шифрования во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="f5004-128">Unlike Azure Disk Encryption on Windows, Linux Disk Encryption does not allow concurrent use of hello VM while hello encryption is in progress.</span></span>  <span data-ttu-id="f5004-129">характеристики производительности Hello hello виртуальной Машины, включая размер hello диска hello и ли учетная запись хранения hello поддерживаемый стандартного или расширенного хранилище (SSD), значительно может влиять на шифрование toocomplete время, необходимое для hello.</span><span class="sxs-lookup"><span data-stu-id="f5004-129">hello performance characteristics of hello VM, including hello size of hello disk and whether hello storage account is backed by standard or premium (SSD) storage, can greatly influence hello time required toocomplete encryption.</span></span>

<span data-ttu-id="f5004-130">состояние toocheck hello ProgressMessage поля, возвращаемые hello [Get AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus) команда может быть запрошено.</span><span class="sxs-lookup"><span data-stu-id="f5004-130">toocheck status, hello ProgressMessage field returned from hello [Get-AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus) command can be polled.</span></span>   <span data-ttu-id="f5004-131">Хотя шифруется диск с ОС hello, hello виртуальная машина переходит в состояние обслуживания и SSH также является отключено tooprevent toohello непрерывный процесс любые прерывания в работе.</span><span class="sxs-lookup"><span data-stu-id="f5004-131">While hello OS drive is being encrypted, hello VM enters a servicing state, and SSH is also disabled tooprevent any disruption toohello ongoing process.</span></span>  <span data-ttu-id="f5004-132">EncryptionInProgress будет отмечено для hello большую часть времени hello шифрования во время выполнения, следует несколько часов в более поздней версии VMRestartPending сообщение с предложением toorestart hello виртуальной Машины.</span><span class="sxs-lookup"><span data-stu-id="f5004-132">EncryptionInProgress will be reported for hello majority of hello time while encryption is in progress, followed several hours later with a VMRestartPending message prompting toorestart hello VM.</span></span>  <span data-ttu-id="f5004-133">Например:</span><span class="sxs-lookup"><span data-stu-id="f5004-133">For example:</span></span>


```
PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : EncryptionInProgress
DataVolumesEncrypted       : EncryptionInProgress
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk encryption started

PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : VMRestartPending
DataVolumesEncrypted       : Encrypted
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk successfully encrypted, please reboot hello VM
```

<span data-ttu-id="f5004-134">Один раз на запрос tooreboot hello виртуальной Машины и после перезапуска виртуальной Машины hello и предоставляя 2-3 минуты для hello перезагрузка и выполнена на целевом сервере hello toobe заключительные действия, hello сообщение о состоянии сообщит, что наконец завершено, шифрование.</span><span class="sxs-lookup"><span data-stu-id="f5004-134">Once prompted tooreboot hello VM, and after restarting hello VM, and giving 2-3 minutes for hello reboot and for final steps toobe performed on hello target, hello status message will indicate that encryption has finally completed.</span></span>   <span data-ttu-id="f5004-135">Это сообщение доступно, hello шифрования диска операционной системы после ожидаемого toobe готова для использования, а также для hello ВМ toobe можно использовать снова.</span><span class="sxs-lookup"><span data-stu-id="f5004-135">Once this message is available, hello encrypted OS drive is expected toobe ready for use and for hello VM toobe usable again.</span></span>

<span data-ttu-id="f5004-136">В случаях, где эта последовательность не найдена или если отчет сбой шифрования ОС в середине hello данного процесса (например, если отображается ошибка «сбой toounmount» hello, описанные в этом руководстве), сведения о загрузке сообщение о ходе выполнения и другие показатели ошибок Рекомендуется моментального снимка обратной toohello toorestore hello ВМ или резервная копия немедленно предыдущих tooencryption.</span><span class="sxs-lookup"><span data-stu-id="f5004-136">In cases where this sequence was not seen, or if boot information, progress message, or other error indicators report that OS encryption has failed in hello middle of this process (for example if you are seeing hello "failed toounmount" error described in this guide), it is recommended toorestore hello VM back toohello snapshot or backup taken immediately prior tooencryption.</span></span>  <span data-ttu-id="f5004-137">Предыдущий toohello при следующей попытке, это предлагаемое toore-оценить характеристики hello hello виртуальной Машины и убедитесь, что выполнены все необходимые компоненты.</span><span class="sxs-lookup"><span data-stu-id="f5004-137">Prior toohello next attempt, it is suggested toore-evaluate hello characteristics of hello VM and ensure that all prerequisites are satisfied.</span></span>

## <a name="troubleshooting-azure-disk-encryption-behind-a-firewall"></a><span data-ttu-id="f5004-138">Устранение неполадок шифрования диска Azure в связи с брандмауэром</span><span class="sxs-lookup"><span data-stu-id="f5004-138">Troubleshooting Azure Disk Encryption behind a Firewall</span></span>
<span data-ttu-id="f5004-139">Когда подключение ограничен брандмауэра, требования прокси-сервера или группы (NSG) безопасность сети, hello возможность расширения tooperform hello необходимые задачи может оказаться невозможным.</span><span class="sxs-lookup"><span data-stu-id="f5004-139">When connectivity is restricted by a firewall, proxy requirement, or network security group (NSG) settings, hello ability of hello extension tooperform needed tasks can be disrupted.</span></span>   <span data-ttu-id="f5004-140">Это может привести к состояние сообщения, такие как «Состояние расширения доступно не для виртуальной Машины hello» и в планируемых сценариях сбоя toofinish.</span><span class="sxs-lookup"><span data-stu-id="f5004-140">This can result in status messages such as "Extension status not available on hello VM" and in expected scenarios failing toofinish.</span></span>  <span data-ttu-id="f5004-141">Hello разделах имеет некоторые распространенные проблемы брандмауэра, которые может изучить.</span><span class="sxs-lookup"><span data-stu-id="f5004-141">hello sections that follow has some common firewall issues that you may investigate.</span></span>

### <a name="network-security-groups"></a><span data-ttu-id="f5004-142">Группы безопасности сети</span><span class="sxs-lookup"><span data-stu-id="f5004-142">Network security groups</span></span>
<span data-ttu-id="f5004-143">Применения параметров группы безопасности сети по-прежнему необходимо разрешить hello конечной точки toomeet hello задокументированы сетевая конфигурация [необходимые компоненты](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) для шифрования диска.</span><span class="sxs-lookup"><span data-stu-id="f5004-143">Any network security group settings applied must still allow hello endpoint toomeet hello documented network configuration [prerequisites](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) for disk encryption.</span></span>

### <a name="azure-keyvault-behind-firewall"></a><span data-ttu-id="f5004-144">Azure Key Vault под защитой брандмауэра</span><span class="sxs-lookup"><span data-stu-id="f5004-144">Azure Keyvault behind firewall</span></span>
<span data-ttu-id="f5004-145">Hello виртуальной Машины должно быть возможности tooaccess хранилища ключей.</span><span class="sxs-lookup"><span data-stu-id="f5004-145">hello VM must be able tooaccess key vault.</span></span> <span data-ttu-id="f5004-146">Ссылки tooguidance при сбое tookey доступ через брандмауэр, который обслуживается hello [хранилище ключей](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall) команды.</span><span class="sxs-lookup"><span data-stu-id="f5004-146">Refer tooguidance on access tookey fault from behind a firewall that is maintained by hello [Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall) team.</span></span>

### <a name="linux-package-management-behind-firewall"></a><span data-ttu-id="f5004-147">Управление пакетами Linux из-за брандмауэра</span><span class="sxs-lookup"><span data-stu-id="f5004-147">Linux package management behind firewall</span></span>
<span data-ttu-id="f5004-148">Во время выполнения шифрование диска Azure для Linux использует hello целевой рассылки пакета управления система tooinstall необходимые необходимых компонентов предыдущих tooenabling шифрования.</span><span class="sxs-lookup"><span data-stu-id="f5004-148">At run time, Azure Disk Encryption for Linux relies on hello target distribution’s package management system tooinstall needed prerequisite components prior tooenabling encryption.</span></span>  <span data-ttu-id="f5004-149">Если параметры брандмауэра препятствует возможности toodownload hello ВМ и установить эти компоненты, последующие ошибки ожидаются.</span><span class="sxs-lookup"><span data-stu-id="f5004-149">If firewall settings prevent hello VM from being able toodownload and install these components, then subsequent failures are expected.</span></span>    <span data-ttu-id="f5004-150">tooconfigure действия Hello, это зависит от распространителя.</span><span class="sxs-lookup"><span data-stu-id="f5004-150">hello steps tooconfigure this may vary by distribution.</span></span>  <span data-ttu-id="f5004-151">В Red Hat, когда требуется прокси-сервер, необходимо обеспечить правильную настройку диспетчера подписок и yum.</span><span class="sxs-lookup"><span data-stu-id="f5004-151">On Red Hat, when a proxy is required, ensuring that subscription-manager and yum are set up properly is vital.</span></span>  <span data-ttu-id="f5004-152">Дополнительные сведения о поддержке Red Hat см. в [этой статье](https://access.redhat.com/solutions/189533).</span><span class="sxs-lookup"><span data-stu-id="f5004-152">See [this](https://access.redhat.com/solutions/189533) Red Hat support article on this topic.</span></span>  

## <a name="troubleshooting-windows-server-2016-server-core"></a><span data-ttu-id="f5004-153">Устранение неполадок в основных серверных компонентах Windows Server 2016</span><span class="sxs-lookup"><span data-stu-id="f5004-153">Troubleshooting Windows Server 2016 Server Core</span></span>

<span data-ttu-id="f5004-154">В Windows Server 2016 Server Core hello bdehdcfg компонент недоступен по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="f5004-154">On Windows Server 2016 Server Core, hello bdehdcfg component is not available by default.</span></span> <span data-ttu-id="f5004-155">Этот компонент требуется для шифрования дисков Azure.</span><span class="sxs-lookup"><span data-stu-id="f5004-155">This component is required by Azure Disk Encryption.</span></span>

<span data-ttu-id="f5004-156">tooworkaround этой проблемы, hello копирования следующие 4 файлы из папки c:\windows\system32 toohello ВМ Windows Server 2016 данных центра изображения hello Server Core:</span><span class="sxs-lookup"><span data-stu-id="f5004-156">tooworkaround this issue, copy hello following 4 files from a Windows Server 2016 Data Center VM toohello c:\windows\system32 folder of hello Server Core image:</span></span>

```
bdehdcfg.exe
bdehdcfglib.dll
bdehdcfglib.dll.mui
bdehdcfg.exe.mui
```

<span data-ttu-id="f5004-157">Затем выполните следующую команду hello:</span><span class="sxs-lookup"><span data-stu-id="f5004-157">Then, run hello following command:</span></span>

```
bdehdcfg.exe -target default
```

<span data-ttu-id="f5004-158">Это создаст системный раздел 550 МБ, а затем после перезагрузки, можно использовать Diskpart toocheck hello тома и продолжить.</span><span class="sxs-lookup"><span data-stu-id="f5004-158">This will create a 550MB system partition and then after a reboot, you can use Diskpart toocheck hello volumes, and proceed.</span></span>  

<span data-ttu-id="f5004-159">Например:</span><span class="sxs-lookup"><span data-stu-id="f5004-159">For example:</span></span>

```
DISKPART> list vol

  Volume ###  Ltr  Label        Fs     Type        Size     Status     Info
  ----------  ---  -----------  -----  ----------  -------  ---------  --------
  Volume 0     C                NTFS   Partition    126 GB  Healthy    Boot
  Volume 1                      NTFS   Partition    550 MB  Healthy    System
  Volume 2     D   Temporary S  NTFS   Partition     13 GB  Healthy    Pagefile
```
## <a name="see-also"></a><span data-ttu-id="f5004-160">См. также</span><span class="sxs-lookup"><span data-stu-id="f5004-160">See also</span></span>
<span data-ttu-id="f5004-161">В этом документе вы узнали, Дополнительные сведения о некоторых распространенных проблем при шифровании диска Azure и как tootroubleshoot.</span><span class="sxs-lookup"><span data-stu-id="f5004-161">In this document, you learned more about some common issues in Azure disk encryption, and how tootroubleshoot.</span></span> <span data-ttu-id="f5004-162">Дополнительные сведения об этой службе и ее возможностях см. в статьях:</span><span class="sxs-lookup"><span data-stu-id="f5004-162">For more information about this service and its capability read:</span></span>

- [<span data-ttu-id="f5004-163">Шифрование диска в центре безопасности Azure</span><span class="sxs-lookup"><span data-stu-id="f5004-163">Apply disk encryption in Azure Security Center</span></span>](https://docs.microsoft.com/azure/security-center/security-center-apply-disk-encryption)
- [<span data-ttu-id="f5004-164">Шифрование виртуальной машины Azure</span><span class="sxs-lookup"><span data-stu-id="f5004-164">Encrypt an Azure Virtual Machine</span></span>](https://docs.microsoft.com/azure/security-center/security-center-disk-encryption)
- [<span data-ttu-id="f5004-165">Шифрование неактивных данных в Azure</span><span class="sxs-lookup"><span data-stu-id="f5004-165">Azure Data Encryption-at-Rest</span></span>](https://docs.microsoft.com/azure/security/azure-security-encryption-atrest)

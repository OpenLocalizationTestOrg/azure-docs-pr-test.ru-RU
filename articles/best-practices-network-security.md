---
title: "Рекомендации по обеспечению безопасности в сети Azure | Документация Майкрософт"
description: "Сведения о некоторых ключевых функциях, доступных в Azure для создания безопасных сетевых сред"
services: virtual-network
documentationcenter: na
author: tracsman
manager: rossort
editor: 
ms.assetid: d169387a-1243-4867-a602-01d6f2d8a2a1
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/03/2017
ms.author: jonor
ms.openlocfilehash: fb5e399d4ab02a7f2805cc280b213bf5b44f6993
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="microsoft-cloud-services-and-network-security"></a>Облачные службы Microsoft Cloud и сетевая безопасность
Облачные службы (Майкрософт) позволяют пользоваться масштабируемыми службами и инфраструктурой, возможностями корпоративного класса и множеством вариантов гибридных подключений. Клиенты могут обращаться к этим службам через Интернет или с помощью службы Azure ExpressRoute, которая позволяет создавать подключения к частной сети. Платформа Microsoft Azure позволяет клиентам легко добавлять в свою инфраструктуру облачные решения и создавать многоуровневую архитектуру. Кроме того, сторонние производители могут получить дополнительные возможности путем предоставления служб безопасности и виртуальных устройств. В этом техническом документе мы предлагаем обзор вопросов, касающихся безопасности и архитектуры, которые необходимо учитывать при использовании облачных служб Microsoft Cloud с помощью ExpressRoute. В нем также рассматриваются более безопасные службы в виртуальных сетях Azure.

## <a name="fast-start"></a>Выбор решения
Следующая диаграмма поможет вам выбрать конкретный пример из множества методов обеспечения безопасности, доступных на платформе Azure. Найдите пример, который лучше всего соответствует вашей ситуации, по краткому описанию. Для получения более подробных сведений продолжите чтение документа.
[![0]][0]

[Пример 1. Создание сети периметра (также называемой промежуточной подсетью) для защиты приложений с помощью групп безопасности сети (NSG).](#example-1-build-a-perimeter-network-to-help-protect-applications-with-nsgs)</br>
[Пример 2. Создание сети периметра для защиты приложений с помощью брандмауэра и групп безопасности сети (NSG).](#example-2-build-a-perimeter-network-to-help-protect-applications-with-a-firewall-and-nsgs)</br>
[Пример 3. Создание сети периметра для защиты сетей с помощью брандмауэра, определяемого пользователем маршрута (UDR) и группы безопасности сети (NSG).](#example-3-build-a-perimeter-network-to-help-protect-networks-with-a-firewall-and-udr-and-nsg)</br>
[Пример 4. Добавление гибридного подключения типа "сеть — сеть" с виртуальным устройством и виртуальной частной сетью (VPN).](#example-4-add-a-hybrid-connection-with-a-site-to-site-virtual-appliance-vpn)</br>
[Пример 5. Добавление гибридного подключения типа "сеть — сеть" с VPN-шлюзом Azure.](#example-5-add-a-hybrid-connection-with-a-site-to-site-azure-vpn-gateway)</br>
[Пример 6. Добавление гибридного подключения с использованием ExpressRoute.](#example-6-add-a-hybrid-connection-with-expressroute)</br>
Примеры добавления подключений между виртуальными сетями, а также примеры высокой доступности и объединения служб в цепочки будут добавлены в этот документ в течение следующих нескольких месяцев.

## <a name="microsoft-compliance-and-infrastructure-protection"></a>Соответствие нормативным требованиям и защита инфраструктуры Майкрософт
Чтобы помочь организациям соблюдать государственные, региональные и отраслевые требования, регулирующие сбор и использование пользовательских данных, мы предлагаем более 40 сертификатов и аттестатов. Это наиболее полный набор, предоставляемый поставщиком облачных служб.

Дополнительные сведения см. в разделе о соответствии нормативным требованиям в [центре управления безопасностью Azure][TrustCenter].

Корпорация Майкрософт использует комплексную защиту облачной инфраструктуры, на базе которой работают глобальные масштабируемые службы. В облачную инфраструктуру Microsoft Cloud входят аппаратное и программное обеспечение, сети, административный и эксплуатационный персонал, а также физические центры обработки данных.

![2]

Этот подход гарантирует клиентам надежный фундамент для развертывания служб на платформе Microsoft Cloud. На его основе клиентам следует разработать и создать системы безопасности для защиты этих служб.

## <a name="traditional-security-architectures-and-perimeter-networks"></a>Традиционные архитектуры для систем безопасности и сетей периметра
Корпорация Майкрософт вкладывает большие средства в защиту облачной инфраструктуры. Пользователи тоже должны принимать меры для защиты облачных служб и групп ресурсов. Лучшим подходом к обеспечению безопасности является многоуровневый подход к безопасности. Зона безопасности сети периметра защищает внутренние сетевые ресурсы от ненадежных сетей. К сети периметра относятся те края или части сети, которые находятся между Интернетом и защищенной корпоративной ИТ-инфраструктурой.

В обычной корпоративной сети базовая инфраструктура хорошо защищена по всему периметру несколькими уровнями устройств безопасности. Граница каждого уровня состоит из устройств и точек реализации политики. Каждый уровень может включать сочетание следующих сетевых устройств безопасности: брандмауэры, устройства предотвращения атак типа "отказ в обслуживании" (DoS), системы обнаружения или предотвращения вторжений (IDS/IPS) и VPN-устройства. Реализация политики выполняется в форме политик брандмауэра, списков управления доступом (ACL) или правил маршрутизации. Первый уровень защиты сети, напрямую взаимодействующий с входящим трафиком из Интернета, представляет собой определенное сочетание таких механизмов. Его задача — блокировать атаки и вредоносный трафик и пропускать допустимые запросы далее по сети. Этот трафик направляется непосредственно к ресурсам в сети периметра. Этот ресурс может "общаться" с ресурсами, размещенными более глубоко в локальной сети, проходя при этом проверку на следующей границе сети. Самый внешний уровень называется сетью периметра, поскольку он напрямую открыт для Интернета. С обеих сторон от сети периметра обычно располагаются какие-либо системы защиты. На следующем рисунке показан пример одиночной подсети для сети периметра в корпоративной сети, с двумя границами безопасности.

![3]

Существует много вариантов архитектуры сети периметра. Они могут варьироваться от простого балансировщика нагрузки до нескольких подсетей сети периметра с различными механизмами блокировки трафика и защиты более глубоких слоев корпоративной сети на каждой границе. Структура сети периметра зависит от конкретных потребностей организации и общих допустимых уровней риска.

По мере того как пользователи переносят свои рабочие нагрузки в общедоступные облака, важно поддерживать аналогичные возможности для архитектуры сети периметра в Azure, чтобы соблюдать требования безопасности и соответствия стандартам. В этом документе приведены рекомендации по построению безопасной сетевой среды в Azure. Основное внимание в нем уделяется сети периметра, но также подробно обсуждаются многие аспекты безопасности сети. Это обсуждение включает следующие вопросы:

* Как построить сеть периметра в Azure?
* Какие функции для создания сети периметра есть в Azure?
* Как защитить серверную часть рабочей нагрузки?
* Как в Azure контролируется взаимодействие рабочих нагрузок с Интернетом?
* Как защитить локальные сети от развертывания в Azure?
* Когда лучше использовать собственные функции безопасности Azure, а когда — устройства или службы сторонних производителей?

На следующей диаграмме показаны различные уровни безопасности, которые Azure предоставляет клиентам. Эти уровни представляют собой как уровни безопасности самой платформы Azure, так и пользовательские функции:

![4]

На входе из Интернета действует защита Azure от атак DDoS, которая отслеживает масштабные атаки на систему Azure. Следующий уровень защиты — определяемые пользователем общедоступные IP-адреса (конечные точки), которые выявляют, какой трафик можно передать через облачную службу в виртуальную сеть. Виртуальная сеть Azure имеет встроенную систему изоляции от всех остальных сетей, и этот трафик может проходить только теми путями и методами, которые настроены пользователем. Эти пути и методы формируют следующий уровень защиты, на котором с помощью сетевых групп безопасности (NSG), определяемого пользователем маршрута (UDR) и виртуальных сетевых устройств создаются границы безопасности для защиты развернутых приложений в защищаемой сети.

В следующем разделе приводится обзор виртуальных сетей Azure. Эти виртуальные сети создаются пользователями и используются для подключения развернутых рабочих нагрузок. Виртуальные сети являются основой всех функций сетевой безопасности, используемых для создания сети периметра для защиты клиентских развертываний в Azure.

## <a name="overview-of-azure-virtual-networks"></a>Общие сведения о виртуальных сетях Azure
Прежде чем интернет-трафик поступит в виртуальные сети Azure, он проходит два встроенных уровня безопасности платформы Azure:

1.    **Защита от атак DDoS.** Защита от атак DDoS — это уровень физической сети Azure, который защищает саму платформу Azure от крупномасштабных атак через Интернет. Эти атаки используют множество "узлов-ботов", чтобы попытаться вызвать перегрузку интернет-службы. Платформа Azure надежно защищена от атак DDoS на всех интерфейсах, принимающих входящий, исходящий и межрегиональный трафик. Защита от атак DDoS не имеет параметров, настраиваемых пользователем, и этот уровень недоступен для клиентов. Этот уровень защищает Azure как платформу от DDoS-атак и крупномасштабных атак. Он также отслеживает исходящий и межрегиональный трафик Azure. Используя виртуальные сетевые устройства, клиент может настроить дополнительные уровни устойчивости для защиты от небольших атак, не относящихся к уровню защиты платформы. Пример защиты от DDoS-атак в действии. Если IP-адрес с выходом в Интернет подвергся крупномасштабной атаке DDoS, Azure может определить источники атак и удалить нежелательный трафик, прежде чем он достигнет своего места назначения. Почти во всех случаях атаки не влияют на конечную точку. В редких случаях атака распространяется на конечную точку, однако зараженный трафик не передается на другие конечные точки. Кроме того, такая атака не повлияет на других клиентов и другие службы. Важно отметить, что защита Azure от атак DDoS отслеживает только крупномасштабные атаки. Не исключается и тот случай, что конкретная служба может быть перегружена, прежде чем пороговые значения защиты уровня платформы превысятся. Например, атака DDoS может перевести веб-сайт на одном сервере A0 IIS в автономный режим, прежде чем уровень защиты Azure от атак DDoS зарегистрирует угрозу.

2.  **Общедоступные IP-адреса.** Общедоступные IP-адреса (включенные с помощью конечных точек службы, общедоступных IP-адресов, шлюза приложений и других функций Azure, представляющих общедоступный IP-адрес для маршрутизации через Интернет к ресурсу) позволяют облачным службам и группам ресурсов иметь общедоступные IP-адреса и порты, открытые для доступа через Интернет. Конечная точка использует преобразование сетевых адресов (NAT) для маршрутизации трафика на внутренний адрес и порт в виртуальной сети Azure. Это основной путь передачи внешнего трафика в виртуальную сеть. Общедоступные IP-адреса можно настроить, чтобы определить, какой трафик следует пропускать в виртуальную сеть, а также как и где его следует пропускать.

При достижении трафиком виртуальной сети существует множество аспектов, которые вступают в действие. Виртуальные сети Azure являются фундаментом, к которому клиенты подключают свои рабочие нагрузки и на котором реализуется базовая безопасность на уровне сети. Они предоставляют клиенту Azure частную сеть (наложение виртуальной сети) со следующими функциями и характеристиками.

* **Изоляция трафика.** Виртуальная сеть на платформе Azure выступает в качестве границы изоляции трафика. Виртуальные машины в одной виртуальной сети не могут напрямую обращаться к виртуальным машинам в другой виртуальной сети, даже если обе виртуальные сети созданы одним клиентом. Это критически важное свойство, которое гарантирует, что виртуальные машины и все коммуникации клиента останутся закрытыми в пределах виртуальной сети.

>[!NOTE]
>Изоляция трафика относится только к *входящему* трафику виртуальной сети. По умолчанию исходящий трафик из виртуальной сети к Интернету разрешен, но его можно предотвратить, настроив группы безопасности сети.
>
>

* **Многоуровневая топология.** Виртуальные сети позволяют клиентам сформировать многоуровневую топологию путем выделения подсетей и отдельных адресных пространств для различных элементов или "уровней" рабочих нагрузок. Эти логические группы и топологии позволяют определить различные политики доступа для разных типов рабочей нагрузки, а также контролировать потоки трафика между уровнями.
* **Распределенное подключение.** Клиенты могут установить подключение между виртуальной сетью и несколькими локальными сайтами или другими виртуальными сетями в Azure. Чтобы создать подключение, клиенты могут использовать пиринг виртуальных сетей, VPN-шлюзы Azure, виртуальные сетевые устройства сторонних производителей или ExpressRoute. Azure поддерживает VPN типа "сеть — сеть" со стандартными протоколами IPsec/IKE, а также службу частного соединения ExpressRoute.
* **Сетевая группа безопасности** позволяет клиентам создавать правила (ACL) на разных уровнях детализации: сетевые интерфейсы, отдельные виртуальные машины или виртуальные подсети. Пользователи могут управлять доступом, разрешая или запрещая взаимодействие рабочих нагрузок друг с другом в пределах виртуальной сети, с клиентских систем в сетях клиента с помощью подключений между сетями, а также напрямую через Интернет.
* **Определяемые пользователем маршруты** (UDR) и **IP-пересылка** позволяют клиентам определять пути взаимодействия между разными уровнями виртуальной сети. Клиенты могут развернуть брандмауэр, устройство IDS/IPS или другие виртуальные устройства и направить сетевой трафик через эти устройства безопасности, что позволяет применять, контролировать и проверять политики границ безопасности.
* **Виртуальные сетевые устройства** в Azure Marketplace. В Azure Marketplace и в коллекции образов виртуальных машин доступны устройства защиты, такие как брандмауэры,подсистемы балансировки нагрузки и службы обнаружения и предотвращения вторжений (IDS/IPS). Клиенты могут развернуть эти устройства в своих виртуальных сетях, в частности на границах безопасности (в том числе в подсетях сети периметра), для получения многоуровневой защищенной сетевой среды.

Рассмотрим пример создания архитектуры сети периметра в Azure с использованием этих функций и возможностей.

![5]

## <a name="perimeter-network-characteristics-and-requirements"></a>Характеристики сети периметра и требования к ней
Сеть периметра представляет собой передний край сети (интерфейсная сеть), который напрямую взаимодействует с Интернетом. Прежде чем попасть на внутренние серверы, входящие пакеты должны пройти через устройства безопасности, такие как брандмауэры, IDS и IPS. Пакеты, направленные в Интернет рабочими нагрузками, также могут проходить через защитные устройства сети периметра перед выходом из сети. Это удобно для применения политик, выполнения проверок и аудита. Кроме того, сети периметра могут использоваться для размещения VPN-шлюзов, соединяющих виртуальные сети клиента с локальными сетями.

### <a name="perimeter-network-characteristics"></a>Характеристики сети периметра
Обратившись к предыдущему рисунку, можно выделить некоторые характеристики хорошей сети периметра:

* Выход в Интернет:
  * Подсеть периметра имеет прямой выход в Интернет и взаимодействует с ним напрямую.
  * Общедоступные IP-адреса, виртуальные IP-адреса и (или) конечные точки службы передают интернет-трафик на интерфейсные сети и устройства.
  * Входящий трафик из Интернета проходит через устройства безопасности, прежде чем попасть на другие ресурсы интерфейсной сети.
  * Если включена политика безопасности для исходящих подключений, трафик проходит через устройства безопасности на последнем шаге перед выходом в Интернет.
* Защищенная сеть:
  * Прямого пути из Интернета к базовой инфраструктуре не существует.
  * Каналы связи с базовой инфраструктурой обязательно проходят через устройства безопасности, такие как группы безопасности сети, брандмауэры и VPN-устройства.
  * Другие устройства не могут выступать в качестве моста между Интернетом и базовой инфраструктурой.
  * Устройства безопасности для обеих границ сети периметра (границы, открытой для Интернета, и границы, обращенной к защищенной сети), например, два брандмауэра, показанные на предыдущем рисунке, на самом деле могут представлять собой одно виртуальное устройство с различными правилами или интерфейсами для каждой границы. Например, одно логически разделенное физическое устройство обрабатывает нагрузку для обеих границ сети периметра.
* Другие общие рекомендации и ограничения:
  * В рабочих нагрузках не может храниться критически важная информация.
  * Доступ для просмотра и обновления конфигураций и развертываний сети периметра имеют только авторизованные администраторы.

### <a name="perimeter-network-requirements"></a>Требования к сети периметра
Чтобы создать успешную сеть периметра, которая будет обладать описанными выше характеристиками, следуйте рекомендациям к созданию виртуальной сети, приведенным ниже:

* **Архитектура подсети.** Определите виртуальную сеть таким образом, чтобы вся подсеть была выделена для сети периметра и отделена от других подсетей в той же виртуальной сети. Это позволит гарантировать, что трафик между сетью периметра и другими уровнями внутренних или частных подсетей будет проходить через брандмауэры или виртуальные устройства IDS и IPS.  Определяемые пользователем маршруты, расположенные на границах подсетей, должны перенаправить трафик в виртуальное устройство.
* **Группы безопасности сети (NSG).** Сама подсеть сети периметра должна быть открытой для взаимодействия с Интернетом, но это не означает, что не должны применяться группы безопасности сети. Следуйте общим рекомендациям по безопасности для минимизации участков сети, открытых для доступа через Интернет. Ограничьте диапазон удаленных адресов, с которых разрешен доступ к развернутым службам, а также диапазон используемых протоколов приложений и открытых портов. При этом могут возникнуть обстоятельства, в которых полная блокировка невозможна. Например, если в Azure размещен внешний веб-сайт клиента, сеть периметра должна пропускать входящие веб-запросы от любого общедоступного IP-адреса, но только на порты веб-приложения TCP:80 и (или) TCP:443.
* **Таблица маршрутизации.** Подсеть сети периметра должна иметь возможность взаимодействовать с Интернетом напрямую, но не должна допускать прямой обмен данными с серверной частью или с локальными сетями в обход брандмауэра или устройства безопасности.
* **Конфигурация устройств безопасности.** Для маршрутизации и проверки пакетов между сетью периметра и другими защищенными сетями устройства безопасности сети (например, брандмауэры, устройства IDS и IPS) могут настраиваться как многоадресные. То есть они могут иметь отдельные сетевые адаптеры для сети периметра и внутренних подсетей. Сетевые адаптеры в сети периметра взаимодействуют с Интернетом напрямую. В них будут использоваться соответствующие сетевые группы безопасности и таблица маршрутизации сети периметра. Сетевые адаптеры, подключенные к внутренним подсетям, имеют более ограниченные сетевые группы безопасности и таблицы маршрутизации этих внутренних подсетей.
* **Функциональные возможности устройств безопасности сети.** Устройства безопасности, развернутые в сети периметра, обычно выполняют следующие функции.
  * Брандмауэр — применение правил брандмауэра и политик контроля доступа к входящим запросам.
  * Выявление и предотвращение угроз — обнаружение вредоносных атак из Интернета и их устранение.
  * Аудит и ведение журнала — ведение подробных журналов аудита и анализа.
  * Обратный прокси — перенаправление входящих запросов на соответствующие тыловые серверы. Оно включает в себя сопоставление и преобразование адресов назначения на интерфейсных устройствах, обычно брандмауэрах, в адреса тыловых серверов.
  * Прокси-сервер переадресации — преобразование сетевых адресов и аудит обмена данными между виртуальной сетью и Интернетом.
  * Маршрутизатор — перенаправление входящего трафика и трафика между подсетями в виртуальной сети.
  * VPN-устройство — выполнение функций межсетевых VPN-шлюзов для подключений VPN между локальными сетями клиента и виртуальными сетями Azure.
  * VPN-сервер — прием подключений VPN-клиентов к виртуальным сетям Azure.

> [!TIP]
> Разделите две следующие группы пользователей: пользователи, которым разрешен доступ к инфраструктуре безопасности сети периметра, и пользователи, имеющие права администраторов по разработке, развертыванию и эксплуатации приложений. Разделение этих групп обеспечивает распределение обязанностей и не позволит одному человеку обойти одновременно систему безопасности приложений и систему безопасности сети.
>
>

### <a name="questions-to-be-asked-when-building-network-boundaries"></a>Важные вопросы при создании границ сети
В этом разделе термин "сети", если не указано иное, относится к частным виртуальным сетям Azure, созданным администратором подписки. Этот термин не относится к базовым физическим сетям в Azure.

Кроме того, виртуальные сети Azure часто используются для расширения традиционных локальных сетей. В архитектуры сетей периметра можно интегрировать гибридные сетевые решения "сеть-сеть" или ExpressRoute. Это важно учитывать при создании границ безопасности сети.

При построении сети с сетью периметра и несколькими границами безопасности важнейшее значение имеют следующие три вопроса.

#### <a name="1-how-many-boundaries-are-needed"></a>1) Сколько границ необходимо?
Первым делом важно определить, сколько нужно периметров безопасности в каждом конкретном случае.

* Одна граница: одна сеть периметра, используемая в качестве интерфейса между виртуальной сетью и Интернетом.
* Две границы: одна между Интернетом и сетью периметра и другая между подсетью сети периметра и внутренними подсетями в виртуальных сетях Azure.
* Три границы: одна между Интернетом и сетью периметра, другая между сетью периметра и внутренними подсетями и третья между внутренними подсетями и локальной сетью.
* N границ: переменное количество. В зависимости от требований безопасности для конкретной сети может применяться любое количество границ безопасности.

Количество и тип периметров зависят от допустимого уровня риска для предприятия и характеристик конкретного сценария. Часто это решение совместно принимают несколько групп внутри организации. В их число часто входят отдел управления рисками и стандартами, отдел эксплуатации сети и платформы и команда разработчиков приложений. Важно привлечь к принятию этого решения людей с хорошим пониманием требований безопасности, используемых данных и технологий. Это позволит выбрать правильный подход к безопасности для каждого элемента инфраструктуры.

> [!TIP]
> Для каждого сценария лучшим решением будет наименьшее количество периметров, соответствующее требованиям безопасности. Чем больше периметров, тем сложнее будет эксплуатация и отладка системы. Кроме того, управление большим количеством периметров потребует более высоких административных расходов. При этом недостаточное количество периметров повышает риск. Важно найти идеальный баланс.
>
>

![6]

На предыдущем рисунке показано высокоуровневое представление сети с тремя границами безопасности. Эти границы расположены между сетью периметра и Интернетом, между частными интерфейсными и внутренними подсетями Azure и между внутренними подсетями Azure и локальной корпоративной сетью.

#### <a name="2-where-are-the-boundaries-located"></a>2) Где должны быть расположены границы?
После выбора количества периметров следует решить, где они будут расположены. Обычно существует три варианта расположения:

* С помощью промежуточной интернет-службы (например облачного брандмауэра веб-приложения; этот вариант не рассматривается в данном документе).
* С помощью встроенных функций или виртуальных сетевых устройств в Azure.
* С помощью физических устройств в локальной сети.

В сетях Azure возможны два варианта: собственные функции Azure (например балансировщики нагрузки Azure) и виртуальные сетевые устройства из экосистемы партнеров Azure (например брандмауэры Check Point).

Если необходима граница между Azure и локальной сетью, устройства безопасности могут находиться на любой стороне подключения (или на обеих сразу). Таким образом, нужно принять решение о месте размещения инфраструктуры безопасности.

На приведенном выше рисунке границы между Интернетом и сетью и между интерфейсными и внутренними сегментами располагаются полностью внутри Azure и поэтому это должны быть собственные функции Azure или виртуальные сетевые устройства. Устройства безопасности на границе между внутренней подсетью Azure и корпоративной сетью предприятия могут располагаться на стороне Azure или на стороне локальной сети. Возможно размещение устройств на обеих сторонах. Каждое из решений может иметь существенные преимущества и недостатки, которые следует тщательно взвесить.

Например, преимущество при использовании существующей физической инфраструктуры безопасности на стороне локальной сети состоит в том, что новой инфраструктуры безопасности создавать не нужно. Достаточно ее перенастроить. Недостатком такой схемы является то, что весь трафик должен вернуться обратно из Azure в локальную сеть, чтобы он стал доступным для инфраструктуры безопасности. Необходимость передачи трафика между разными сегментами сети Azure обратно в локальную сеть для применения политик безопасности может привести к значительным задержкам трафика и отрицательно повлиять на производительность приложения и на качество взаимодействия с пользователем.

#### <a name="3-how-are-the-boundaries-implemented"></a>3) Как будут реализованы границы?
К каждой границе безопасности могут применяться различные функциональные требования (например: на интернет-границе сети периметра могут потребоваться устройства IDS и правила брандмауэра, а между внутренней подсетью и сетью периметра — только списки управления доступом). Выбор используемого устройства (или устройств) зависит от конкретного сценария и требований безопасности. В примерах 1, 2 и 3 в следующем разделе обсуждаются некоторые варианты, которыми можно воспользоваться. Изучив встроенные функции сети Azure и возможности доступных для Azure устройств экосистемы партнеров, вы найдете множество других вариантов, которые позволят подобрать решение практически для любого сценария.

Еще одним важным вопросом является метод подключения локальной сети к Azure. Нужно ли использовать виртуальный шлюз или виртуальное сетевое устройство Azure? Эти варианты подробно описываются в следующем разделе (в примерах 4, 5 и 6).

Кроме того, может потребоваться трафик между виртуальными сетями в Azure. Эти сценарии будут добавлены в будущем.

Когда будут готовы ответы на эти вопросы, обратитесь к разделу [Выбор решения](#fast-start) , чтобы убедиться, какие примеры лучше всего подходят для вашего сценария.

## <a name="examples-building-security-boundaries-with-azure-virtual-networks"></a>Примеры. Создание границ безопасности для виртуальных сетей Azure
### <a name="example-1-build-a-perimeter-network-to-help-protect-applications-with-nsgs"></a>Пример 1. Создание сети периметра для защиты приложений с помощью групп безопасности сети
[Вернуться к выбору решения](#fast-start) | [Подробные инструкции по сборке для этого примера][Example1]

[![7]][7]

#### <a name="environment-description"></a>Описание среды
В этом примере используется подписка, которая содержит такие ресурсы:

- одну группу ресурсов.
- виртуальную сеть с двумя подсетями (интерфейсной и внутренней);
- одна группа безопасности сети, которая применяется к обеим подсетям;
- сервер Windows Server, который представляет веб-сервер приложений (IIS01);
- два сервера Windows Server, представляющих тыловые серверы приложений (AppVM01, AppVM02);
- сервер Windows Server, который представляет DNS-сервер (DNS01).
- общедоступный IP-адрес, связанный с веб-сервером приложения.

Сценарии и шаблон Azure Resource Manager Azure доступны в [подробных инструкциях по сборке][Example1].

#### <a name="nsg-description"></a>Описание группы безопасности сети
В этом примере создается группа безопасности сети, после чего в нее загружаются шесть правил.

> [!TIP]
> Сначала необходимо создать более конкретные правила разрешения, а затем более общие правила запрета. Порядок выполнения правил задается назначенным приоритетом. Когда система находит правило, применимое к пакету трафика, остальные правила игнорируются. Правила группы безопасности сети могут применяться во входящем или исходящем направлении (относительно подсети).
>
>

Декларативно для входящего трафика определяются следующие правила.

1. Внутренний трафик DNS (порт 53) разрешается.
2. Трафик RDP (порт 3389) из Интернета к любой виртуальной машине разрешается.
3. Трафик HTTP (порт 80) из Интернета к веб-серверу (IIS01) разрешается.
4. Весь трафик (все порты) от сервера IIS01 к серверу AppVM1 разрешается.
5. Весь трафик (все порты) из Интернета ко всей виртуальной сети (обе подсети) запрещается.
6. Весь трафик (все порты) из подсети FrontEnd в подсеть BackEnd запрещается.

С учетом этих правил, связанных с каждой подсетью, для входящего запроса HTTP из Интернета на веб-сервер должны быть применены оба правила 3 (разрешить) и 5 (запретить). Но поскольку правило 3 имеет более высокий приоритет, то будет применено только оно, а правило 5 не будет использовано. Таким образом, HTTP-запрос сможет достичь веб-сервера. Если тот же трафик будет направлен к серверу DNS01, то сначала будет применено правило 5 (запретить), поэтому трафик не достигнет сервера. Правило 6 (запретить) блокирует взаимодействие подсети FrontEnd с подсетью BackEnd (за исключением разрешенного трафика в правилах 1 и 4). Этот набор правил обеспечивает защиту внутренней сети при компрометации веб-приложения на сервере. Злоумышленник будет иметь ограниченный доступ к "защищенной" внутренней сети (только к ресурсам, доступным на сервере AppVM01).

Стандартное правило по умолчанию разрешает любой исходящий трафик в Интернет. В этом примере мы разрешаем исходящий трафик и не меняем никаких исходящих правил. Для блокировки трафика в обоих направлениях требуется определяемая пользователем маршрутизация (см. пример 3).

#### <a name="conclusion"></a>Заключение
Этот пример — относительно простой и эффективный способ изоляции внутренней подсети от входящего трафика. Дополнительные сведения см. в [подробных инструкциях по сборке][Example1]. Эти инструкции включают:

* Способы создания этой сети периметра с помощью классических скриптов PowerShell.
* Способы создания этой сети периметра с помощью шаблона Azure Resource Manager.
* Подробное описание каждой команды NSG.
* Подробные сценарии прохождения трафика с демонстрацией разрешений и запретов на каждом уровне.


### <a name="example-2-build-a-perimeter-network-to-help-protect-applications-with-a-firewall-and-nsgs"></a>Пример 2. Создание сети периметра для защиты приложений с помощью брандмауэра и групп безопасности сети (NSG)
[Вернуться к выбору решения](#fast-start) | [Подробные инструкции по сборке для этого примера][Example2]

[![8]][8]

#### <a name="environment-description"></a>Описание среды
В этом примере используется подписка, которая содержит такие ресурсы:

* одну группу ресурсов.
* виртуальную сеть с двумя подсетями (интерфейсной и внутренней);
* одна группа безопасности сети, которая применяется к обеим подсетям;
* виртуальное сетевое устройство, в данном случае брандмауэр, подключенный к подсети FrontNet;
* сервер Windows Server, который представляет веб-сервер приложений (IIS01);
* два сервера Windows Server, представляющих тыловые серверы приложений (AppVM01, AppVM02);
* сервер Windows Server, который представляет DNS-сервер (DNS01).

Сценарии и шаблон Azure Resource Manager Azure доступны в [подробных инструкциях по сборке][Example2].

#### <a name="nsg-description"></a>Описание группы безопасности сети
В этом примере создается группа безопасности сети, после чего в нее загружаются шесть правил.

> [!TIP]
> Сначала необходимо создать более конкретные правила разрешения, а затем более общие правила запрета. Порядок выполнения правил задается назначенным приоритетом. Когда система находит правило, применимое к пакету трафика, остальные правила игнорируются. Правила группы безопасности сети могут применяться во входящем или исходящем направлении (относительно подсети).
>
>

Декларативно для входящего трафика определяются следующие правила.

1. Внутренний трафик DNS (порт 53) разрешается.
2. Трафик RDP (порт 3389) из Интернета к любой виртуальной машине разрешается.
3. Весь трафик (все порты) из Интернета к серверу сетевого виртуального устройства (брандмауэр) разрешается.
4. Весь трафик (все порты) от сервера IIS01 к серверу AppVM1 разрешается.
5. Весь трафик (все порты) из Интернета ко всей виртуальной сети (обе подсети) запрещается.
6. Весь трафик (все порты) из подсети FrontEnd в подсеть BackEnd запрещается.

С учетом этих правил, связанных с каждой подсетью, для входящего запроса HTTP из Интернета на брандмауэр должны быть применены оба правила 3 (разрешить) и 5 (запретить). Но поскольку правило 3 имеет более высокий приоритет, то будет применено только оно, а правило 5 не будет использовано. Таким образом, запрос HTTP сможет достичь брандмауэра. Если такой же трафик будет направлен к серверу IIS01, расположенному в подсети FrontEnd, будет применено правило 5 (запретить), поэтому трафик не сможет достичь сервера. Правило 6 (запретить) блокирует взаимодействие подсети FrontEnd с подсетью BackEnd (за исключением разрешенного трафика в правилах 1 и 4). Этот набор правил обеспечивает защиту внутренней сети при компрометации веб-приложения на сервере. Злоумышленник будет иметь ограниченный доступ к "защищенной" внутренней сети (только к ресурсам, доступным на сервере AppVM01).

Стандартное правило по умолчанию разрешает любой исходящий трафик в Интернет. В этом примере мы разрешаем исходящий трафик и не меняем никаких исходящих правил. Для блокировки трафика в обоих направлениях требуется определяемая пользователем маршрутизация (см. пример 3).

#### <a name="firewall-rule-description"></a>Описание правил брандмауэра
В брандмауэре необходимо создать правила пересылки. Поскольку в этом примере входящий трафик пересылается только на брандмауэр, а затем на веб-сервер, потребуется только одно правило перенаправления для преобразования сетевых адресов (NAT).

Правило пересылки принимает входящий запрос с любого адреса источника, который отправляется на брандмауэр при попытке обращения к HTTP (порт 80) или к HTTPS (порт 443). Этот запрос отправляется из локального интерфейса брандмауэра и перенаправляется на веб-сервер с IP-адресом 10.0.1.5.

#### <a name="conclusion"></a>Заключение
Этот пример — относительно простой способ защиты приложения с помощью брандмауэра и изоляции внутренней подсети от входящего трафика. Дополнительные сведения см. в [подробных инструкциях по сборке][Example2]. Эти инструкции включают:

* Способы создания этой сети периметра с помощью классических скриптов PowerShell.
* Построение сети для этого примера с помощью шаблона Azure Resource Manager.
* Подробное описание каждой команды группы безопасности сети и каждого правила брандмауэра.
* Подробные сценарии прохождения трафика с демонстрацией разрешений и запретов на каждом уровне.

### <a name="example-3-build-a-perimeter-network-to-help-protect-networks-with-a-firewall-and-udr-and-nsg"></a>Пример 3. Создание сети периметра для защиты сетей с помощью брандмауэра, определяемого пользователем маршрута (UDR) и группы безопасности сети (NSG).
[Вернуться к выбору решения](#fast-start) | [Подробные инструкции по сборке для этого примера][Example3]

[![9]][9]

#### <a name="environment-description"></a>Описание среды
В этом примере используется подписка, которая содержит такие ресурсы:

* одну группу ресурсов.
* виртуальную сеть с тремя подсетями (SecNet, FrontEnd и BackEnd);
* виртуальное сетевое устройство, в данном случае брандмауэр, подключенный к подсети SecNet;
* сервер Windows Server, который представляет веб-сервер приложений (IIS01);
* два сервера Windows Server, представляющих тыловые серверы приложений (AppVM01, AppVM02);
* сервер Windows Server, который представляет DNS-сервер (DNS01).

Сценарии и шаблон Azure Resource Manager Azure доступны в [подробных инструкциях по сборке][Example3].

#### <a name="udr-description"></a>Описание определяемого пользователем маршрута
По умолчанию следующие системные маршруты определяются так:

        Effective routes :
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.0.0/16}     VNETLocal                            Active   Default    
         {0.0.0.0/0}       Internet                             Active   Default    
         {10.0.0.0/8}      Null                                 Active   Default    
         {100.64.0.0/10}   Null                                 Active   Default    
         {172.16.0.0/12}   Null                                 Active   Default    
         {192.168.0.0/16}  Null                                 Active   Default

Определенным префиксом (или префиксами) адреса для этой сети всегда является VNETLocal (то есть он меняется от одной виртуальной сети к другой в зависимости от того, как определяется каждая конкретная виртуальная сеть). Остальные системные маршруты — статические и заданы по умолчанию, как указано в таблице.

В этом примере создаются две таблицы маршрутизации, одна для подсети FrontEnd и другая для подсети BackEnd. В каждую таблицу загружены статические маршруты для данной подсети. В данном примере в каждой таблице есть три маршрута, которые направляют весь трафик (0.0.0.0/0) через брандмауэр (следующий прыжок = IP-адрес виртуального устройства):

1. Для трафика локальной подсети значение следующего прыжка не указано, что позволяет трафику локальной подсети обходить брандмауэр.
2. Для трафика виртуальной сети значением следующего прыжка установлен адрес брандмауэра. Это значение переопределяет правило по умолчанию, которое разрешает прямое прохождение трафика виртуальной локальной сети.
3. Для всего остального трафика (0/0) в качестве значения следующего прыжка задан адрес брандмауэра.

> [!TIP]
> Отсутствие записи локальной подсети в UDR приведет к разрыву подключений локальной подсети.
>
> * В нашем примере адрес 10.0.1.0/24, указывающий на VNETLocal, является критически важным! При его отсутствии пакет, отправляемый с веб-сервера (10.0.1.4) на другой локальный сервер (например, 10.0.1.25), будет вместо этого отправлен на виртуальное сетевое устройство (NVA). NVA отправит его в подсеть, а подсеть снова отправит его на NVA, что приводит к возникновению бесконечного цикла.
> * Вероятность зацикливания маршрутизации обычно выше в устройствах с несколькими сетевыми адаптерами, подключенных к отдельным подсетям. Часто это традиционные локальные устройства.
>
>

После создания таблиц маршрутизации они должны быть привязаны к соответствующим подсетям. После создания и привязки таблица маршрутизации подсети FrontEnd будет выглядеть так:

        Effective routes :
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.1.0/24}     VNETLocal                            Active
         {10.0.0.0/16}     VirtualAppliance 10.0.0.4            Active    
         {0.0.0.0/0}       VirtualAppliance 10.0.0.4            Active

> [!NOTE]
> UDR теперь можно применять к подсети шлюза, к которой подключен канал ExpressRoute.
>
> Примеры включения сети периметра с помощью ExpressRoute или подключением типа "сеть-сеть" показаны в примерах 3 и 4.
>
>

#### <a name="ip-forwarding-description"></a>Описание IP-пересылки
IP-пересылка всегда используется вместе с определяемым пользователем маршрутом. Это параметр для виртуального устройства, который позволяет принимать не адресованный устройству трафик и пересылать его конечному получателю.

Например, при поступлении трафика от AppVM01 с запросом к серверу DNS01 определяемый пользователем маршрут направит такой трафик брандмауэру. При включенной IP-пересылке трафик с указанным назначением DNS01 (10.0.2.4) будет принят устройством (10.0.0.4) и затем передан конечному получателю (10.0.2.4). Если IP-пересылка на брандмауэре не разрешена, такой трафик не будет принят устройством, даже если в качестве следующего прыжка в таблице маршрутизации указан брандмауэр. Для использования виртуального устройства важно не забыть включить IP-пересылку и определяемые пользователем маршруты.

#### <a name="nsg-description"></a>Описание группы безопасности сети
В этом примере создается группа безопасности сети, после чего в нее загружается одно правило. Затем эта группа привязывается только к подсетям Frontend и Backend (не SecNet). Декларативно создается следующее правило:

* Весь трафик (все порты) из Интернета ко всей виртуальной сети (все подсети) запрещается.

В этом примере используются группы безопасности сети, но его основной целью является создание дополнительного уровня защиты от неправильной настройки вручную. Целью этого примера является блокировка всего входящего трафика из Интернета в подсети FrontEnd и BackEnd. Трафик должен проходить только через подсеть SecNet на брандмауэр (и затем при необходимости в подсети FrontEnd и BackEnd). Кроме того, если установлены правила определяемых пользователем маршрутов, любой трафик, поступивший в подсети FrontEnd и BackEnd, будет направляться на брандмауэр (благодаря наличию определяемых пользователем маршрутов). Брандмауэр воспримет это как асимметричный поток и отбросит исходящий трафик. Таким образом, существует три уровня безопасности для защиты подсетей:

* На сетевых адаптерах подсети FrontEnd или BackEnd нет общедоступных IP-адресов.
* Группы безопасности сети отклоняют трафик из Интернета.
* Брандмауэр отбрасывает асимметричный трафик.

В этом примере есть интересная особенность, касающаяся сетевой группы безопасности. В нем содержится только одно правило, которое запрещает трафик из Интернета ко всей виртуальной сети, включая подсеть безопасности. Однако, так как сетевая группа безопасности привязана только к подсетям FrontEnd и BackEnd, это правило не применяется к входящему трафику подсети безопасности. В результате трафик будет проходить в подсеть безопасности.

#### <a name="firewall-rules"></a>Правила файрволла
В брандмауэре необходимо создать правила пересылки. Так как брандмауэр блокирует или пересылает весь входящий, исходящий и внутренний трафик виртуальной сети, необходимо задать большое количество правил брандмауэра. Кроме того, весь входящий трафик будет попадать на общедоступный IP-адрес службы безопасности (на разных портах) для последующей обработки брандмауэром. Прежде чем настраивать подсети и правила брандмауэра, рекомендуем составить схему логических потоков, чтобы позже не пришлось все переделывать. Следующий рисунок является логическим представлением правил брандмауэра для этого примера.

![10]

> [!NOTE]
> Порты управления будут различными в зависимости от используемого виртуального сетевого устройства. В этом примере брандмауэр Barracuda NextGen Firewall использует порты 22, 801 и 807. Обратитесь к документации поставщика устройства, чтобы точно знать, какие порты используются для управления устройством.
>
>

#### <a name="firewall-rules-description"></a>Описание правила брандмауэра
На приведенной выше логической схеме не отображена подсеть безопасности, так как брандмауэр является единственным ресурсом в этой подсети. Кроме того, вместо фактического пути маршрутизации на схеме показаны правила брандмауэра и логика разрешения или запрета трафика. Также внешние порты, выбранные для трафика RDP, являются портами более высокого диапазона (8014–8026) и были выделены для совмещения с последними двумя октетами локального IP-адреса, чтобы адреса было удобнее читать (например, адрес локального сервера 10.0.1.4 связан с внешним портом 8014). Тем не менее можно использовать любые неконфликтующие порты более высокого диапазона.

В этом примере нам нужно семь типов правил:

* Внешние правила (для входящего трафика).
  1. Правило управления брандмауэром. Это правило перенаправления приложения разрешает пересылать трафик на порты управления виртуального сетевого устройства.
  2. Правила RDP (для каждого сервера Windows Server). Эти четыре правила (по одному для каждого сервера) позволяют управлять серверами через RDP. Четыре правила RDP можно объединить в одно, если виртуальное сетевое устройство поддерживает такую возможность.
  3. Правила трафика приложений. Существует два правила трафика приложений: первое — для веб-трафика подсети FrontEnd, а второе — для трафика подсети BackEnd (например, от веб-сервера к уровню данных). Параметры этих правил будут зависеть от архитектуры сети размещения серверов и характеристик потоков трафика (направление потока и используемые порты).
     * Первое правило позволяет фактическому трафику приложения достичь сервера приложений. Если другие правила необходимы для безопасности и управления, то правила трафика приложений позволяют внешним пользователям и службам взаимодействовать с приложениями. В этом примере используется один веб-сервер с портом 80. Поэтому на брандмауэре потребуется одно правило приложения, которое принимает входящий трафик на внешний IP-адрес и переправляет его на внутренний IP-адрес веб-серверов. Затем этот трафик обрабатывается службой NAT (преобразование сетевых адресов) и передается на внутренний сервер.
     * Второе правило трафика приложения используется для подсети BackEnd. Оно разрешает веб-серверу обращаться к серверу AppVM01 (но не AppVM02) через любой порт.
* Внутренние правила (для трафика внутри виртуальной сети)
  1. Правило для исходящего трафика в Интернет. Это правило разрешает передачу трафика из любой сети в указанные сети. Обычно это правило является заданным в брандмауэре по умолчанию и при этом отключенным. В нашем примере это правило следует активировать.
  2. Правило DNS. Это правило разрешает передавать на DNS-сервер только трафик DNS (порт 53). Для этой среды блокируется большая часть трафика от интерфейсной подсети к серверной части. В частности, это правило явно разрешает трафик DNS из любой локальной подсети.
  3. Правило трафика между подсетями. Это правило позволяет любому серверу внутренней подсети подключаться к любому серверу в подсети переднего плана (но не наоборот).
* Резервное правило (для трафика, который не соответствует указанным выше правилам).
  1. Правило запрета любого трафика. Это правило всегда должно быть последним (по приоритету). Если трафик не соответствует ни одному из предыдущих правил, он будет отклонен этим правилом. Это правило по умолчанию обычно уже установлено и активировано. Поэтому оно не требует дополнительных действий.

> [!TIP]
> Для второго приложения это правило трафика упрощается, разрешая трафик для всех портов. В реальном сценарии следует использовать максимально узкие диапазоны адресов и номеров портов, чтобы снизить возможность потенциальной атаки.
>
>

После создания приведенных выше правил обязательно проверьте приоритет каждого правила, чтобы разрешения и запреты трафика выполнялись надлежащим образом. В нашем примере правила расположены в порядке приоритета.

#### <a name="conclusion"></a>Заключение
Это более сложный, но и более полноценный способ защиты и изоляции сети по сравнению с предыдущими примерами. (Пример 2 защищает только приложение, а пример 1 лишь изолирует подсети.) Такая схема позволяет контролировать трафик, идущий в обоих направлениях. Она не только защищает сервер приложений от входящего трафика, но и применяет политику сетевой безопасности для всех серверов в сети. Кроме того, если позволяет используемое устройство, может осуществляться полный аудит и контроль трафика. Дополнительные сведения см. в [подробных инструкциях по сборке][Example3]. Эти инструкции включают:

* Создание сети периметра для этого примера с помощью классических скриптов PowerShell.
* Построение сети для этого примера с помощью шаблона Azure Resource Manager.
* Подробное описание каждой команды UDR, NSG и правил брандмауэра.
* Подробные сценарии прохождения трафика с демонстрацией разрешений и запретов на каждом уровне.

### <a name="example-4-add-a-hybrid-connection-with-a-site-to-site-virtual-appliance-vpn"></a>Пример 4. Добавление гибридного подключения типа "сеть — сеть" и виртуального VPN-устройства
[Вернуться к выбору решения](#fast-start) | Подробные инструкции по сборке ожидаются в ближайшее время

[![11]][11]

#### <a name="environment-description"></a>Описание среды
Гибридную сеть, использующую виртуальное сетевое устройство (NVA), можно добавить к сети периметра в любом из предыдущих примеров (1, 2 или 3).

Как показано на приведенном выше рисунке, для подключения локальной сети к виртуальной сети Azure через виртуальное сетевое устройство используется VPN-подключение через Интернет (типа "сеть-сеть").

> [!NOTE]
> При использовании ExpressRoute с включенным общедоступным пирингом Azure необходимо создать статический маршрут. Он должен выполнять маршрутизацию на IP-адрес VPN виртуального сетевого устройства за пределами корпоративной сети и не использовать подключение ExpressRoute. Преобразование сетевых адресов (NAT), которое необходимо для общедоступного пиринга Azure в ExpressRoute, может привести к разрыву сеанса VPN.
>
>

После подключения VPN виртуальное сетевое устройство становится центральным "концентратором" для всех сетей и подсетей. Правила пересылки брандмауэра определяют, какие потоки трафика пропускаются, какие преобразуются с помощью NAT и какие — перенаправляются или отбрасываются (даже для потоков трафика между локальной сетью и Azure).

Потоки трафика следует тщательно планировать, так как такая схема сети может оптимизировать или ухудшить их в зависимости от конкретного сценария использования.

Взяв среду, созданную в примере 3, и добавив к ней гибридное сетевое VPN-подключение типа "сеть-сеть", мы получим следующую схему:

[![12]][12]

Роль VPN-клиента будет играть локальный маршрутизатор или любое другое сетевое устройство, совместимое с виртуальным сетевым устройством для VPN. Это физическое устройство будет выполнять запуск и поддержание VPN-подключения с вашим виртуальным сетевым устройством.

С точки зрения виртуального сетевого устройства сеть логически разделена на четыре отдельные "зоны безопасности", а трафик между этими зонами контролируется правилами, установленными на виртуальном сетевом устройстве.

![13]

#### <a name="conclusion"></a>Заключение
Добавление гибридного сетевого VPN-подключения типа "сеть-сеть" к виртуальной сети Azure позволяет безопасно расширить локальную сеть в Azure. При использовании VPN-подключения трафик шифруется и передается через Интернет. Виртуальное сетевое устройство в этом примере представляет собой централизованное расположение для применения и управления политикой безопасности. Дополнительные сведения см. в подробных инструкциях по построению (будут добавлены позже). Эти инструкции включают:

* Создание сети периметра для этого примера с помощью сценариев PowerShell.
* Построение сети для этого примера с помощью шаблона Azure Resource Manager.
* Подробные сценарии потоков трафика, демонстрирующие прохождение трафика через эту схему сети.

### <a name="example-5-add-a-hybrid-connection-with-a-site-to-site-azure-vpn-gateway"></a>Пример 5. Добавление гибридного подключения типа "сеть — сеть" с VPN-шлюзом Azure
[Вернуться к выбору решения](#fast-start) | Подробные инструкции по сборке ожидаются в ближайшее время

[![14]][14]

#### <a name="environment-description"></a>Описание среды
К сети периметра любого типа, описанной в примерах 1 и 2, можно добавить гибридную сеть с VPN-шлюзом Azure.

Как показано на приведенном выше рисунке, для подключения локальной сети к виртуальной сети Azure через VPN-шлюз Azure используется VPN-подключение через Интернет (типа "сеть-сеть").

> [!NOTE]
> При использовании ExpressRoute с включенным общедоступным пирингом Azure необходимо создать статический маршрут. Он должен выполнять маршрутизацию на IP-адрес VPN виртуального сетевого устройства за пределами корпоративной сети и не использовать глобальную сеть ExpressRoute. Преобразование сетевых адресов (NAT), которое необходимо для общедоступного пиринга Azure в ExpressRoute, может привести к разрыву сеанса VPN.
>
>

На следующем рисунке показаны две границы сети в этом варианте. На первой границе виртуальное сетевое устройство и группы безопасности сети управляют потоками трафика во внутренних сетях Azure и между Azure и Интернетом. Второй границей является VPN-шлюз Azure, который представляет собой отдельную и изолированную границу сети между локальной сетью и Azure.

Потоки трафика следует тщательно планировать, так как такая схема сети может оптимизировать или ухудшить их в зависимости от конкретного сценария использования.

Взяв среду, созданную в примере 1, и добавив к ней гибридное сетевое VPN-подключение типа "сеть-сеть", мы получим следующую схему.

[![15]][15]

#### <a name="conclusion"></a>Заключение
Добавление гибридного сетевого VPN-подключения типа "сеть-сеть" к виртуальной сети Azure позволяет безопасно расширить локальную сеть в Azure. Встроенный VPN-шлюз Azure шифрует весь трафик по протоколу IPSec и передает его через Интернет. Кроме того, VPN-шлюз Azure может оказаться более бюджетным решением (не требует дополнительных затрат на лицензии для виртуальных сетевых устройств сторонних производителей). Для примера 1, в котором не используются виртуальные сетевые устройства, этот вариант будет самым экономичным. Дополнительные сведения см. в подробных инструкциях по построению (будут добавлены позже). Эти инструкции включают:

* Создание сети периметра для этого примера с помощью сценариев PowerShell.
* Построение сети для этого примера с помощью шаблона Azure Resource Manager.
* Подробные сценарии потоков трафика, демонстрирующие прохождение трафика через эту схему сети.

### <a name="example-6-add-a-hybrid-connection-with-expressroute"></a>Пример 6. Добавление гибридного подключения с использованием ExpressRoute
[Вернуться к выбору решения](#fast-start) | Подробные инструкции по сборке ожидаются в ближайшее время

[![16]][16]

#### <a name="environment-description"></a>Описание среды
Гибридную сеть, использующую подключение с частным пирингом ExpressRoute, можно добавить к сети периметра любого типа, описанной в примере 1 или 2.

Как показано на рисунке выше, частный пиринг ExpressRoute позволяет создавать прямое подключение между локальной сетью и виртуальной сетью Azure. Трафик проходит только через сеть поставщика службы и сеть Microsoft Azure, не выходя в Интернет.

> [!TIP]
> При использовании ExpressRoute корпоративный трафик не передается через Интернет. Это также позволяет использовать соглашения об уровне обслуживания поставщика службы ExpressRoute. При использовании ExpressRoute шлюз Azure может передавать данные со скоростью до 10 Гбит/с, тогда как при использовании VPN типа "сеть — сеть" максимальная пропускная способность шлюза Azure составляет 200 Мбит/с.
>
>

Как показано на следующей схеме, в этом варианте среда имеет две границы сети. Виртуальное сетевое устройство и группа безопасности сети управляют потоками трафика для внутренних сетей Azure и между Azure и Интернетом, а шлюз представляет собой отделенную и изолированную границу сети между локальной сетью и Azure.

Потоки трафика следует тщательно планировать, так как такая схема сети может оптимизировать или ухудшить их в зависимости от конкретного сценария использования.

Взяв среду, созданную в примере 1, и добавив к ней гибридное сетевое подключение ExpressRoute, мы получим следующую схему.

[![17]][17]

#### <a name="conclusion"></a>Заключение
Добавив сетевое подключение частного пиринга ExpressRoute, вы можете безопасно расширить локальную сеть в Azure. Этот метод снижает задержки и повышает производительность подключения. Встроенный VPN-шлюз Azure, как и в нашем примере, также позволяет снизить расходы (так как не потребуется дополнительных затрат на лицензии для виртуальных сетевых устройств сторонних производителей). Дополнительные сведения см. в подробных инструкциях по построению (будут добавлены позже). Эти инструкции включают:

* Создание сети периметра для этого примера с помощью сценариев PowerShell.
* Построение сети для этого примера с помощью шаблона Azure Resource Manager.
* Подробные сценарии потоков трафика, демонстрирующие прохождение трафика через эту схему сети.

## <a name="references"></a>Ссылки
### <a name="helpful-websites-and-documentation"></a>Полезные веб-сайты и документация
* Доступ к Azure с Azure Resource Manager:
* Доступ к Azure с помощью PowerShell: [https://docs.microsoft.com/powershell/azureps-cmdlets-docs/](/powershell/azure/overview)
* Документация по виртуальным сетям: [https://docs.microsoft.com/azure/virtual-network/](https://docs.microsoft.com/azure/virtual-network/)
* Документация по группам безопасности сети: [https://docs.microsoft.com/azure/virtual-network/virtual-networks-nsg](virtual-network/virtual-networks-nsg.md)
* Документация по определяемым пользователем маршрутам: [https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview](virtual-network/virtual-networks-udr-overview.md)
* Виртуальные шлюзы Azure: [https://docs.microsoft.com/azure/vpn-gateway/](https://docs.microsoft.com/azure/vpn-gateway/)
* VPN типа "сеть — сеть": [https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell](vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell.md)
* Документация ExpressRoute (обязательно ознакомьтесь с разделами о начале работы и инструкциями): [https://docs.microsoft.com/azure/expressroute/](https://docs.microsoft.com/azure/expressroute/)

<!--Image References-->
[0]: ./media/best-practices-network-security/flowchart.png "Блок-схема вариантов системы безопасности"
[2]: ./media/best-practices-network-security/azuresecurityfeatures.png "Функции безопасности Azure"
[3]: ./media/best-practices-network-security/dmzcorporate.png "Сеть периметра в корпоративной сети"
[4]: ./media/best-practices-network-security/azuresecurityarchitecture.png "Архитектура безопасности Azure"
[5]: ./media/best-practices-network-security/dmzazure.png "Сеть периметра в виртуальной сети Azure"
[6]: ./media/best-practices-network-security/dmzhybrid.png "Гибридная сеть с тремя границами безопасности"
[7]: ./media/best-practices-network-security/example1design.png "Входящая сеть периметра с группой безопасности сети"
[8]: ./media/best-practices-network-security/example2design.png "Входящая сеть периметра с виртуальным сетевым устройством и группой безопасности сети"
[9]: ./media/best-practices-network-security/example3design.png "Двунаправленная сеть периметра с виртуальным сетевым устройством, группой безопасности сети и определяемыми пользователем маршрутами"
[10]: ./media/best-practices-network-security/example3firewalllogical.png "Логическое представление правил брандмауэра"
[11]: ./media/best-practices-network-security/example3designoptions.png "Сеть периметра с гибридной сетью, подключенной через виртуальное сетевое устройство"
[12]: ./media/best-practices-network-security/example4designs2s.png "Сеть периметра с виртуальным сетевым устройством и VPN-подключением типа "сеть — сеть""
[13]: ./media/best-practices-network-security/example4networklogical.png "Логическая сеть с точки зрения виртуального сетевого устройства"
[14]: ./media/best-practices-network-security/example5designoptions.png "Сеть периметра с гибридным сетевым подключением типа "сеть — сеть" через шлюз Azure"
[15]: ./media/best-practices-network-security/example5designs2s.png "Сеть периметра со шлюзом Azure и VPN-подключением типа "сеть — сеть""
[16]: ./media/best-practices-network-security/example6designoptions.png "Сеть периметра с гибридным сетевым подключением ExpressRoute через шлюз Azure"
[17]: ./media/best-practices-network-security/example6designexpressroute.png "Сеть периметра со шлюзом Azure и подключением ExpressRoute"

<!--Link References-->
[TrustCenter]: https://azure.microsoft.com/support/trust-center/compliance/
[Example1]: ./virtual-network/virtual-networks-dmz-nsg.md
[Example2]: ./virtual-network/virtual-networks-dmz-nsg-fw-asm.md
[Example3]: ./virtual-network/virtual-networks-dmz-nsg-fw-udr-asm.md
[Example4]: ./virtual-network/virtual-networks-hybrid-s2s-nva-asm.md
[Example5]: ./virtual-network/virtual-networks-hybrid-s2s-agw-asm.md
[Example6]: ./virtual-network/virtual-networks-hybrid-expressroute-asm.md
[Example7]: ./virtual-network/virtual-networks-vnet2vnet-direct-asm.md
[Example8]: ./virtual-network/virtual-networks-vnet2vnet-transit-asm.md

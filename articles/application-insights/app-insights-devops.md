---
title: "Мониторинг производительности веб-приложения в Azure Application Insights | Документация Майкрософт"
description: "Как Application Insights встраивается в цикл разработки и операций (DevOps)"
services: application-insights
documentationcenter: 
author: CFreemanwa
manager: carmonm
ms.assetid: 479522a9-ff5c-471e-a405-b8fa221aedb3
ms.service: application-insights
ms.workload: tbd
ms.tgt_pltfrm: ibiza
ms.devlang: multiple
ms.topic: article
ms.date: 03/14/2017
ms.author: bwren
ms.openlocfilehash: de94633cabaa7a1562a5a4839a8a8924da91a283
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="deep-diagnostics-for-web-apps-and-services-with-application-insights"></a>Углубленная диагностика для веб-приложений и служб с помощью Application Insights
## <a name="why-do-i-need-application-insights"></a>Зачем мне Application Insights?
Служба Application Insights отслеживает работу веб-приложения. Она сообщает о сбоях и проблемах производительности, а также помогает анализировать использование приложения пользователями. Она работает с приложениями, выполняемыми на различных платформах (ASP.NET, J2EE, Node.js и др.), и размещается в облаке или локально. 

![Аспекты сложности доставки веб-приложений](./media/app-insights-devops/010.png)

Очень важно отслеживать процесс выполнения современного приложения. Самое главное, вам необходимо обнаружить сбои в его работе прежде, чем это сделает большинство ваших клиентов. Кроме того, требуется обнаружить и устранить проблемы с производительностью, которые, даже если не являются масштабными, могут привести к замедлению работы или стать причиной неудобств для пользователей. А когда система работает надлежащим образом, полезно знать, что с ней делают пользователи, используют ли они новейшие функции и добиваются ли они успеха?

Современные веб-приложения разрабатываются с соблюдением цикла непрерывной поставки: выпуск новой функции или улучшения; наблюдение за тем, как с этим работают пользователи; планирование следующего шага разработки на основе полученных знаний. Ключевой частью этого цикла является этап наблюдения. Application Insights предоставляет набор инструментов для отслеживания производительности и использования веб-приложения.

В этом процессе наиболее важный аспект — проведение диагностики и постановка диагноза. Если приложение перестает работать, бизнес теряется. Поэтому основная роль функций мониторинга — четко выявить проблему, немедленно сообщить об этом вам и представить всю необходимую информацию для диагностики проблемы. Именно это и делает Application Insights.

### <a name="where-do-bugs-come-from"></a>Откуда берутся ошибки?
Ошибки в веб-системах обычно возникают из-за проблем с конфигурацией или из-за нечеткого взаимодействия между многочисленными компонентами. Поэтому первая задача при возникновении инцидента — определение источника (очага) проблемы: какой компонент или какая связь является причиной?

Некоторые из нас помнят то время, когда компьютерная программа выполнялась на одном компьютере. Разработчики тщательно тестировали ее перед сдачей, а затем, после отправки заказчику, практически не вспоминали и не беспокоились о ней. После этого пользователям приходилось мириться с остаточными ошибками в течение многих лет. 

В наши дни все по-другому. Теперь приложение должно работать с множеством различных устройств, и сложно гарантировать, что оно будет вести себя одинаково на каждом из них. Размещение приложений в облаке позволяет быстро исправлять ошибки, но это также означает постоянную конкуренцию и ожидание новых функций, которые должны появляться через короткие промежутки времени. 

В этих условиях единственным способом четкого контроля над количеством ошибок является автоматизированное модульное тестирование. Невозможно все перепроверить вручную при каждой поставке. Модульное тестирование теперь является обычной частью процесса сборки приложения. Инструменты, такие как Xamarin Test Cloud, выполняют автоматизированное тестирование пользовательского интерфейса на нескольких версиях браузеров. Эти режимы тестирования позволяют надеяться, что число ошибок, обнаруженных в приложении, будет сведено к минимуму.

Обычные веб-приложения содержат множество динамических компонентов. Кроме клиента (в браузере или приложении для устройства) и веб-сервера, возможна также основательная обработка в серверной части. Вероятно, серверная часть является конвейером компонентов или коллекцией взаимодействующих элементов, связанных между собой в меньшей степени. И многие из них вы не сможете контролировать, так как это внешние службы, от которых вы зависите.

В подобных конфигурациях может быть сложно и экономически невыгодно выполнять тестирование или прогнозировать все возможные режимы сбоя не в самой действующей системе. 

### <a name="questions-"></a>Вопросы...
Некоторые вопросы возникают при разработке веб-системы.

* В моем приложении происходит аварийное завершение работы? 
* Что именно произошло? — Если не удалось выполнить запрос, необходимо знать, как это случилось. Нам нужно отследить последовательность событий...
* Мое приложение достаточно быстро работает? Сколько времени требуется для ответа на стандартный запрос?
* Может ли сервер справиться с нагрузкой? Когда частота запросов возрастет, будет ли время отклика стабильным?
* Насколько быстро отвечают на запросы мои зависимости — интерфейсы REST API, базы данных и другие компоненты, вызываемые приложением? В частности, если система работает медленно, это из-за моего компонента, или я получаю медленные ответы от кого-то другого?
* Работает мое приложение или нет? Его видно из других частей мира? Сообщите мне, если оно остановится...
* Что является основной причиной? Сбой произошел в моем компоненте или в зависимости? Это проблема связи?
* Сколько пользователей было затронуто? Если необходимо решить несколько проблем, какая из них наиболее критична?

## <a name="what-is-application-insights"></a>Что такое Azure Application Insights?
![Базовый рабочий процесс Application Insights](./media/app-insights-devops/020.png)

1. Application Insights снабжает ваше приложение инструментами и отправляет данные телеметрии во время выполнения приложения. Либо встройте пакет SDK Application Insights в приложение, либо применяйте его инструменты во время выполнения. Первый метод является более гибким, так как вы можете добавлять собственную телеметрию в стандартные модули.
2. Данные телеметрии отправляются на портал Application Insights, где они сохраняются и обрабатываются. (Несмотря на то, что служба Application Insights размещается в Microsoft Azure, она позволяет отслеживать любые веб-приложения, а не только приложения Azure.)
3. Данные телеметрии представляются в виде диаграмм и таблиц событий.

Существует два основных типа телеметрии: статистически обработанные и необработанные экземпляры. 

* Данные экземпляра включают в себя, например, отчет о запросе, который был получен веб-приложением. С помощью инструмента поиска на портале Application Insights можно найти и просмотреть сведения о запросе. Экземпляр содержит следующие данные: сколько времени потребовалось приложению для ответа на запрос, запрашиваемый URL-адрес, приблизительное расположение клиента и другие.
* Статистически обработанные данные включают в себя количество событий за единицу времени, что позволяет сравнить частоту запросов со временем откликов. Они также содержат средние значения метрик, таких как время отклика на запрос.

Вот основные категории данных.

* Запросы к приложению (обычно HTTP-запросы) с данными URL-адреса, временем отклика и результатом (успешный или неудачный).
* Зависимости — вызовы REST и SQL, совершенные приложением, а также данные URI, время отклика и результат (успешный или неудачный).
* Исключения, включая трассировки стека.
* Данные о просмотре страниц, которые поступают из браузеров пользователей.
* Метрики, такие как счетчики производительности, а также созданные вами метрики. 
* Пользовательские события, которые можно использовать для отслеживания бизнес-событий.
* Трассировки журналов, используемые для отладки.

## <a name="case-study-real-madrid-fc"></a>Пример использования: футбольный клуб "Реал" (Мадрид)
Веб-служба [футбольного клуба "Реал" (Мадрид)](http://www.realmadrid.com/) обслуживает около 450 миллионов болельщиков по всему миру. Болельщики получают к нему доступ как через веб-браузеры, так и через мобильные приложения, предлагаемые клубом. Они могут не только бронировать билеты, но и имеют доступ к видеоматериалам, результатам игр, сведениям об игроках и следующих матчах. При поиске можно использовать фильтры, например по количеству забитых голов. Также имеются ссылки на социальные сети. Взаимодействие с пользователем очень персонализировано и разработано как двусторонний обмен данными, что очень привлекает болельщиков.

Используемое решение — [это система служб и приложений на платформе Microsoft Azure](https://www.microsoft.com/en-us/enterprise/microsoftcloud/realmadrid.aspx). Масштабируемость является ключевым требованием: объем трафика переменчив и может особенно возрастать во время матчей, а также до и после матчей.

Для клуба "Реал" (Мадрид) крайне важно отслеживать производительность системы. Azure Application Insights предоставляет всесторонний обзор системы, обеспечивая надежную работу и высокий уровень обслуживания. 

Клуб также получает полезные сведения о своих болельщиках, чтобы хорошо понимать их потребности: откуда они (всего 3 % болельщиков находится в Испании), что им интересно знать об игроках, исторические результаты и будущие матчи, а также их реакция на результаты завершившихся матчей.

Большая часть этих данных телеметрии собирается автоматически и не требует добавления кода, что упрощает решение и оптимизирует его эксплуатацию.  Для клуба "Реал" (Мадрид) Application Insights ежемесячно обрабатывает 3,8 миллиарда точек телеметрических данных.

Для просмотра своих данных телеметрии клуб использует модуль Power BI.

![Представление телеметрии Application Insights в Power BI](./media/app-insights-devops/080.png)

## <a name="smart-detection"></a>Интеллектуальное обнаружение
[Упреждающая диагностика](app-insights-proactive-diagnostics.md) — это одна из новых функций. Без каких-либо специальных настроек Application Insights автоматически обнаруживает необычное возрастание числа сбоев в приложении и оповещает вас о нем. Она достаточно умна, чтобы пропускать фоновые случайные сбои, а также простое пропорциональное возрастание, вызванное ростом числа запросов. Например, если в одной из служб, от которых зависит ваша работа, происходит сбой, или если только что развернутая новая сборка не работает надлежащим образом, вы узнаете об этом, как только проверите свою электронную почту. (Также есть веб-перехватчики, которые позволяют приводить в действие другие приложения.)

Другим аспектом этой функции является выполнение ежедневного глубокого анализа телеметрии и поиск необычных отклонений показателей производительности, которые трудно обнаружить. Например, она может выявить снижение производительности в определенном географическом регионе или в отдельной версии браузера.

В обоих случаях вы получите оповещение, в котором будут содержаться не только обнаруженные симптомы, но и данные, необходимые для диагностики проблемы, такие как соответствующие отчеты об исключениях.

![Сообщение электронной почты от компонента упреждающей диагностики](./media/app-insights-devops/030.png)

Пользователь Samtec сообщил следующее: "Во время последнего переключения функции мы выявили базу данных с некорректным масштабированием, в которой достигались ограничения ресурсов, вызывая превышение времени ожидания. Оповещение упреждающего обнаружения пришло буквально в тот момент, когда мы столкнулись с этой проблемой, очень близко к реальному времени, как и было заявлено. Это оповещение, которое сопровождалось оповещениями платформы Azure, помогло нам устранить проблему практически мгновенно. Общее время простоя — не более 10 минут".

## <a name="live-metrics-stream"></a>Динамический поток метрик
Развертывание последней сборки может быть любопытным процессом. Если возникнут проблемы, необходимо знать о них немедленно, чтобы была возможность при необходимости вернуться на шаг назад. Динамический поток метрик предоставляет ключевые данные метрик с задержкой около одной секунды.

![Динамические метрики](./media/app-insights-devops/040.png)

Кроме того, решение позволяет незамедлительно проверить образец любых ошибок или исключений.

![Динамические события сбоев](./media/app-insights-devops/live-stream-failures.png)

## <a name="application-map"></a>Схема сопоставления приложений
Схема сопоставления приложений автоматически определяет топологию приложения, размещая в верхней части сведения о производительности, чтобы было легче определить узкие места производительности и проблемные потоки в распределенной среде. Она позволяет обнаружить зависимости приложений в службах Azure. Можно рассмотреть проблему и понять, связана она с кодом или с зависимостями. Затем можно централизованно получить детальную информацию и соответствующие результаты диагностики. Например, в приложения может происходить сбой из-за снижения производительности на уровне SQL. С помощью схемы сопоставления приложений вы можете сразу это увидеть и перейти в помощник по построению индексов SQL или просмотреть подробные сведения о запросе.

![Схема сопоставления приложений](./media/app-insights-devops/050.png)

## <a name="application-insights-analytics"></a>Аналитика Application Insights
Используя [аналитику](app-insights-analytics.md), можно создавать произвольные запросы с помощью мощного языка, подобного SQL.  Выполнение диагностики по всему стеку приложений становится простым процессом, так как аналитика объединяет различные ракурсы и позволяет задавать правильные вопросы для сопоставления производительности служб с бизнес-метриками и качеством обслуживания. 

Можно запросить любые необработанные данные экземпляра телеметрии и метрик, хранящиеся на портале. Язык поддерживает фильтрацию, объединение, агрегирование и другие операции. Можно выполнять вычисление полей и статистический анализ. Имеются как табличные, так и графические визуализации.

![Запрос аналитики и диаграмма результатов](./media/app-insights-devops/025.png)

Например, можно с легкостью выполнить следующие действия.

* Разбить на сегменты данные о производительности запросов приложения по уровням пользователей для лучшего понимания процесса.
* Найти конкретные коды ошибок или имена пользовательских событий, исследуя рабочие сайты.
* Выполнить детализацию использования приложения конкретными пользователями, чтобы понять, как происходит получение и внедрение функций.
* Отследить длительность сеансов и время отклика для определенных пользователей, что позволяет службе поддержки и операционной группе оказывать немедленную помощь пользователям.
* Определить часто используемые функции приложения, чтобы правильно выполнить расстановку приоритетов для компонентов.

Пользователь DNN сообщил следующее: "Благодаря Application Insights мы получили недостающую часть уравнения и теперь можем комбинировать, сортировать, запрашивать и фильтровать данные так, как нам требуется. Это дает нашей команде возможность полагаться на собственную изобретательность и опыт при поиске данных. А мощный язык запросов позволяет нам получать подробные сведения и решать проблемы, о которых мы раньше даже не знали. Много интересных решений появляются во время поиска ответов на вопросы, которые начинаются с *Интересно знать...*.

## <a name="development-tools-integration"></a>Интеграция средств разработки
### <a name="configuring-application-insights"></a>Настройка Application Insights
Visual Studio и Eclipse оснащены инструментами для настройки правильных пакетов SDK для разрабатываемого проекта. Есть и команда меню, которая позволяет добавить Application Insights.

Если используется платформа ведения журналов трассировки, например Log4N, NLog или System.Diagnostics.Trace, у вас будет возможность отправлять журналы в Application Insights вместе с другими данными телеметрии. Таким образом, вы сможете легко сопоставлять данные трассировки с запросами, вызовами зависимостей и исключениями.

### <a name="search-telemetry-in-visual-studio"></a>Поиск данных телеметрии в Visual Studio
В процессе разработки и отладки функции можно просматривать и выполнять поиск данных телеметрии непосредственно в Visual Studio, используя те же средства поиска, что и веб-портал.

И когда Application Insights регистрирует исключение, можно просмотреть точку данных в Visual Studio и сразу перейти к соответствующему коду.

![Поиск в Visual Studio](./media/app-insights-devops/060.png)

Во время отладки у вас есть возможность сохранять данные телеметрии на компьютере разработки, просматривая их в Visual Studio, но не отправляя на портал. Этот локальный параметр позволяет не смешивать отладку с рабочей телеметрией.

### <a name="build-annotations"></a>Аннотации к сборке
При использовании Visual Studio Team Services для сборки и развертывания приложения на диаграммах, просматриваемых на портале, отображаются заметки к развертыванию. Если последний выпуск оказал какое-либо влияние на метрики, это будет заметно.

![Аннотации к сборке](./media/app-insights-devops/070.png)

### <a name="work-items"></a>Рабочие элементы
При появлении оповещения Application Insights может автоматически создавать в системе отслеживания работы рабочий элемент.

## <a name="but-what-about"></a>А как насчет...?
* [Конфиденциальность и хранение](app-insights-data-retention-privacy.md) — данные телеметрии хранятся на защищенных серверах Azure.
* Производительность — влияние очень незначительно. Данные телеметрии передаются в пакетном режиме.
* [Цены](app-insights-pricing.md) — начать работу можно бесплатно, и при небольших объемах такой режим сохраняется.


## <a name="video"></a>Видео

> [!VIDEO https://channel9.msdn.com/events/Connect/2016/112/player]

## <a name="next-steps"></a>Дальнейшие действия
Начать работу с Application Insights легко. Ниже перечислены основные возможности.

* Инструментирование уже работающего веб-приложения. При этом вы получаете всю встроенную телеметрию производительности. Эта функция доступна для [Java](app-insights-java-live.md) и [серверов IIS](app-insights-monitor-performance-live-website-now.md), а также для [веб-приложений Azure](app-insights-azure.md).
* Инструментирование проекта во время разработки. Это можно сделать для приложений [ASP.NET](app-insights-asp-net.md) или [Java](app-insights-java-get-started.md), а также для [Node.js](app-insights-nodejs.md) и узлов [других типов](app-insights-platforms.md). 
* Инструментирование [любой веб-страницы](app-insights-javascript.md) с помощью добавления небольшого фрагмента кода.


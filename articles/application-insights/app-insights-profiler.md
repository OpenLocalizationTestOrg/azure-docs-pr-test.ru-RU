---
title: "aaaProfiling динамических веб-приложений в Azure с помощью Application Insights | Документы Microsoft"
description: "Определите hello Горячий путь в код веб-сервера с помощью профилировщика небольшого размера."
services: application-insights
documentationcenter: 
author: CFreemanwa
manager: carmonm
ms.service: application-insights
ms.workload: tbd
ms.tgt_pltfrm: ibiza
ms.devlang: na
ms.topic: article
ms.date: 05/04/2017
ms.author: bwren
ms.openlocfilehash: 3c7f21076f19335e0f006327932e13623ec9526b
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="profiling-live-azure-web-apps-with-application-insights"></a>Профилирование динамических веб-приложений Azure с помощью Application Insights

*Общедоступная версия этой функции Application Insights доступна для служб приложений, а предварительная — для вычислений.*

Узнайте, сколько время, затраченное на каждый метод в реальном времени веб-приложения с помощью средства для профилирования hello [Azure Application Insights](app-insights-overview.md). Он показывает подробные профили динамических запросов, которые были получены в приложении и выделяет hello «Горячий путь», используемого hello большая часть времени. Это средство автоматически выбирает примеры с разным временем ответа. Hello профилировщик использует различные методы toominimize издержки.

Hello профилировщика в настоящее время работает для ASP.NET веб-приложения, работающие на службы приложений Azure, в ценовой категории Basic по крайней мере hello. 

<a id="installation"></a>
## <a name="enable-hello-profiler"></a>Включить профилировщик hello

[Установите Application Insights](app-insights-asp-net.md) в коде. Если он уже установлен, убедитесь, что у вас есть последняя версия hello. (toodo это, щелкните правой кнопкой мыши проект в обозревателе решений и выберите Управление пакетами NuGet. Выберите "Обновления" и обновите все пакеты.) Повторно разверните приложение.

*Используете ASP.NET Core? [Ознакомьтесь с этим разделом](#aspnetcore).*

В [https://portal.azure.com](https://portal.azure.com), открытие hello ресурса Application Insights для веб-приложения. Откройте **Производительность** и щелкните **Включить профилировщик Application Insights**.

![Нажмите кнопку в заголовке профилировщик enable hello][enable-profiler-banner]

Кроме того, всегда можно щелкнуть **Настройка** tooview состояние, включение и отключение hello профилировщика.

![В колонке производительности hello нажмите кнопку настроить][performance-blade]

Веб-приложения, для которых настроено использование Application Insights, перечислены в колонке "Настройка". Выполните профилировщик инструкции tooinstall hello агент при необходимости. Если у вас пока нет веб-приложений, для которых настроено использование Application Insights, щелкните *Add Linked Apps* (Добавить связанные приложения).

Используйте hello *включить профилировщик* или *отключение профилировщика* кнопки в колонке toocontrol hello Настройка hello Profiler на всех связанных веб-приложения.



![Колонка «Настройка»][linked app services]

перезапуск или toostop профилировщик hello для отдельного экземпляра службы приложений, вы найдете его **в ресурс службы приложения hello**в **веб-задания**. toodelete его раскройте категорию **расширения**.

![Отключение профилировщика для веб-заданий][disable-profiler-webjob]

Корпорация Майкрософт рекомендует наличие hello профилировщик включен на всех вашей веб приложения toodiscover любой производительностью, как можно быстрее.

Если вы используете WebDeploy toodeploy изменения tooyour веб-приложения, убедитесь, исключить hello **App_Data** папки от удаления во время развертывания. В противном случае hello профилировщик расширения файлы будут удалены при следующем развертывании tooAzure приложения hello web.

### <a name="using-profiler-with-azure-vms-and-compute-resources-preview"></a>Использование профилировщика с виртуальными машинами и вычислительных ресурсами Azure (предварительная версия)

После [включения Application Insights для служб приложений Azure во время выполнения](app-insights-azure-web-apps.md#run-time-instrumentation-with-application-insights) профилировщик автоматически становится доступным. (Если вы включили Application Insights для ресурса hello, необходима версия lates toohello tooupdate через hello **Настройка** мастера.)

Отсутствует [предварительную версию hello профилировщика для вычисления Azure ресурсов](https://go.microsoft.com/fwlink/?linkid=848155).


## <a name="limits"></a>Ограничения

хранение данных по умолчанию Hello — 5 дней. В день может быть принято до 10 ГБ.

Является бесплатной службы профилировщик hello. Веб-приложения должна быть размещена в по крайней мере hello базового уровня службы приложений.

## <a name="viewing-profiler-data"></a>Просмотр данных профилировщика

Откройте колонку производительности hello и прокрутите вниз список toohello операции.




![Столбец примеров в колонке "Производительность" Application Insights][performance-blade-examples]

содержит столбцы таблицы hello Hello.

* **Счетчик** -Здравствуйте, количество этих запросов в диапазоне времени hello колонка hello.
* **Медиана** -hello типичные время приложения toorespond tooa запроса. Половина всех ответов была получена быстрее, чем сейчас.
* **95th percentile** (95-й процентиль). 95 % ответов были получены быстрее, чем сейчас. Если этот рисунок сильно отличается от hello Медиана, может возникнуть временная проблема с вашим приложением. (Или это можно объяснить с помощью такой конструктивной функции, как кэширование.)
* **Примеры** — значок указывает этот профилировщик hello захватил трассировок стека для этой операции.

Пункт hello примеры значок tooopen hello трассировки. Hello проводника отображается было найдено несколько примеров, которые hello профилировщика, классифицируются по времени ответа.

Выберите образец tooshow уровне кода декомпозиция время, затраченное на запрос, выполняющийся hello.

![Обозреватель трассировки Application Insights][trace-explorer]

**Показать критический путь** открывает hello крупнейших конечный узел, или что-нибудь по крайней мере закрыть. В большинстве случаев этот узел будет узким местом смежные tooa производительности.



* **Метка**: hello имя функции hello или события. Hello дерева показано сочетание кода и события, имевшие место (таких как события SQL и http). Hello top событие представляет hello общую длительность запроса.
* **Затраченное**: hello временной интервал между hello операции hello взаимном hello.
* **Когда**: показано, когда событие функции hello был запущен в рамках функции tooother отношения.

## <a name="how-tooread-performance-data"></a>Как tooread данные о производительности

Профилировщик службы Microsoft использует сочетание выборки метод инструментирования tooanalyze hello производительности и приложения.
Когда идет подробные коллекции, служба профилировщик hello указатель инструкции для каждого ЦП компьютера hello в каждую миллисекунду.
В каждом примере захватывает hello полный стек вызовов потока hello в настоящее время выполнения, предоставляя подробные и полезные сведения о том, что что потоком в это оба высокой и низкой уровнях абстракции. Профилировщик службы также собирает другие события, например события переключения контекста, TPL события и корреляция действия tootrack событий пула потоков и причинно-следственных связей.

Hello стек вызовов, отображаемый в представлении временной шкалы hello является результатом hello hello выше выборки и инструментирования. Поскольку в каждом примере захватывает hello полный стек вызовов потока hello, он включает код из hello .NET framework, а также другие платформы, на которую ссылается.

### <a id="jitnewobj"></a>Выделение объектов (`clr!JIT\_New or clr!JIT\_Newarr1`)
`clr!JIT\_New and clr!JIT\_Newarr1` — это вспомогательные функции в .NET Framework, выделяющие память из управляемой кучи. `clr!JIT\_New` вызывается при выделении объекта. `clr!JIT\_Newarr1` вызывается при выделении массива объектов. Обычно эти две функции выполняются очень быстро за относительно небольшое время. Если вы видите `clr!JIT\_New` или `clr!JIT\_Newarr1` занять много времени на временной шкале, это означает, что кода hello может распределения много объектов и потребляет значительный объем памяти.

### <a id="theprestub"></a>Код загрузки (`clr!ThePreStub`)
`clr!ThePreStub`— это вспомогательная функция внутри платформы .NET framework, подготавливающее tooexecute кода hello hello первый раз. Как правило, она включает в себя JIT-компиляцию (но не ограничивается ей). Для каждого метода C# `clr!ThePreStub` должны вызываться только один раз во время существования процесса hello.

Если вы видите `clr!ThePreStub` занимает много времени для запроса, значит этот запрос используется Здравствуйте, первая из них выполняет этот метод, а также время hello для tooload среды выполнения .NET framework, что метод является существенным. Можно рассмотреть прогрева процесс, выполняемый фрагмент кода hello, прежде чем пользователи к нему доступ, или попробуйте запустить на ваши сборки NGen.

### <a id="lockcontention"></a>Конфликт блокировки (`clr!JITutil\_MonContention` или `clr!JITutil\_MonEnterWorker`)
`clr!JITutil\_MonContention`или `clr!JITutil\_MonEnterWorker` указывают hello текущий поток ожидает блокировки toobe выпуска. Обычно это отображается при выполнении команды lock языка C# путем вызова метода Monitor.Enter или метода с атрибутом MethodImplOptions.Synchronized. Конфликт блокировки обычно происходит, когда блокировку потока A и B поток пытается hello tooacquire же блокировки перед ее отпусканием потока A.

### <a id="ngencold"></a>Код загрузки (`[COLD]`)
Если имя метода hello содержит `[COLD]`, такие как `mscorlib.ni![COLD]System.Reflection.CustomAttribute.IsDefined`, значит среды выполнения .NET framework hello выполняет код, который не оптимизирован по <a href="https://msdn.microsoft.com/library/e7k32f4k.aspx">профильной оптимизации</a> для hello первый раз. Для каждого метода он должен отображаться более одного раза в течение времени существования hello hello процесса.

При загрузке кода занимает значительное количество времени для запроса, значит этот запрос используется hello первую один tooexecute hello неоптимизированном часть метода hello. Можно рассмотреть нагревается процесс, который выполняет этот фрагмент кода hello, прежде чем пользователи к нему доступ.

### <a id="httpclientsend"></a>Отправка HTTP-запроса
Такие методы, как `HttpClient.Send` указания кода hello ожидает toocomplete запроса HTTP.

### <a id="sqlcommand"></a>Операция с базой данных
Метод, например SqlCommand.Execute указывает, что код hello ожидает toocomplete операции базы данных.

### <a id="await"></a>Ожидание (`AWAIT\_TIME`)
`AWAIT\_TIME`Указывает, что код hello ожидает toocomplete другой задачи. Обычно это осуществляется с помощью команды await языка C#. При делает hello код на языке C# «await», hello поток освобождает управления toohello потоков и возвращает нет потока, который ожидает toofinish «await» hello. Однако логически hello потока, что было hello await «заблокировано» ожидание toocomplete операции hello. `AWAIT\_TIME` Указывает, заблокирован hello времени ожидания toocomplete задача hello.

### <a id="block"></a>Время блокировки
`BLOCKED_TIME`Указывает, что другой toobe ресурсов, доступных, например, ожидает объекта синхронизации, Ожидание toobe потока, доступного и ожидает toofinish запрос ожидает кода hello.

### <a id="cpu"></a>Время ЦП
Hello ЦП занят выполнением инструкций hello.

### <a id="disk"></a>Время работы диска
приложение Hello выполняет дисковые операции.

### <a id="network"></a>Сетевое время
приложение Hello выполнение сетевых операций.

### <a id="when"></a>Столбец "Время"
Это визуализацию как со временем меняться hello ИНКЛЮЗИВНЫЕ выборки, собранные для узла. полный диапазон Hello hello запрос состоит из 32 сегментами времени и hello инклюзивными выборками для этого узла будут накапливаться в этих 32 сегментами. Затем каждый период представляется в виде полосы, высота которой обозначает масштабированное значение. Для узлу, помеченному `CPU_TIME` или `BLOCKED_TIME`, или там, где есть очевидным отношения о потреблении ресурсов (ЦП, диска, поток), hello строке представляет использует один из этих ресурсов в течение периода hello времени этого сегмента. Для этих метрик можно получить показатель, превышающий 100 %, за счет потребления нескольких ресурсов. Например, если в среднем за определенный интервал времени используется два процессора, показатель достигнет 200 %.


## <a id="troubleshooting"></a>Устранение неполадок

### <a name="how-can-i-know-whether-application-insights-profiler-is-running"></a>Как узнать, работает ли профилировщик Application Insights?

Профилировщик Hello выполняется как непрерывные веб-задание в веб-приложения. Можно открыть ресурс веб-приложения hello в https://portal.azure.com и проверьте состояние «ApplicationInsightsProfiler» в колонке hello веб-заданий. Если она не запущена, откройте **журналы** toofind дополнительных сведений.

### <a name="why-cant-i-find-any-stack-examples-even-though-hello-profiler-is-running"></a>Почему не удается найти все примеры стека даже при выполнении профилировщик hello?

Вот несколько моментов, которые можно проверить.

1. Убедитесь, что вы используете план службы веб-приложений уровня "Базовый" и выше.
2. Проверьте, содержит ли веб-приложение пакет SDK Application Insights бета-версии 2.2 и более поздней.
3. Убедитесь, что веб-приложение имеет APPINSIGHTS_INSTRUMENTATIONKEY приветствия с hello использовать же ключ инструментирования, пакет SDK Application Insights.
4. Проверьте, работает ли веб-приложение на платформе .Net Framework 4.6.
5. Если приложения ASP.NET Core, также проверьте [hello необходимым требованиям](#aspnetcore).

После запуска профилировщика hello нет периода прогрева короткий при профилировщик hello активно собирает несколько трассировки производительности. После этого hello Профилировщик собирает трассировки производительности для двух минут в каждый час.  

### <a name="i-was-using-azure-service-profiler-what-happened-tooit"></a>Я включил профилировщик службы Azure. Какая ошибка tooit?  

При включении профилировщика Application Insights агент профилировщика службы Azure отключается.

### <a id="double-counting"></a>Двойной подсчет в параллельных потоках

В некоторых случаях hello метрика общее время в средстве просмотра стека hello больше hello Фактическая длительность запроса hello.

Это может произойти при наличии нескольких потоков, связанных с запросом и работающих в параллельном режиме. Hello поток общее время превышает затем hello затраченного времени. Во многих случаях один поток может ожидает hello других toocomplete. Это Hello toodetect попытки просмотра и исключить ненужные ожидания hello, но errs со стороны hello отображение слишком большого объема вместо пропуск, что может быть критически важной информации.  

При появлении параллельных потоков в ваши трассировки необходимо toodetermine которой потоки ожидают, поэтому можно определить hello критический путь для запроса hello. В большинстве случаев поток hello, быстро переход в состояние ожидания просто ожидающий hello других потоков. Сосредоточиться на других hello и игнорировать время hello в hello ожидающих потоков.

### <a id="issue-loading-trace-in-viewer"></a>Нет данных профилирования

1. При данных hello tooview старее, чем на пару недель, попробуйте ограничить время фильтра и повторите попытку.

2. Проверьте, что прокси-серверы или межсетевой экран не заблокирован toohttps://gateway.azureserviceprofiler.net доступа.

3. Убедитесь, что hello Application Insights, ключ инструментирования, используемого в приложении является hello же, как hello ресурс Application Insights, которое было включено профилирование с. ключ Hello обычно находится в ApplicationInsights.config, но также можно найти в файле web.config или app.config.

### <a name="error-report-in-hello-profiling-viewer"></a>Отчет об ошибках в средство просмотра профилирования hello

Файл запрос в службу поддержки с портала hello. Пожалуйста, включите hello идентификатора корреляции из сообщение hello.

## <a name="manual-installation"></a>Ручная установка

При настройке профилировщик hello hello следующие обновления выполняются параметры toohello веб-приложения. Если требуется, их можно внести вручную, например, если приложение выполняется в среде службы приложений Azure (ASE):

1. В колонке управления приложения hello web откройте параметры.
2. Значение «.net Framework версии» toov4.6.
3. Задать tooOn «Always On».
4. Добавить параметр приложения «__APPINSIGHTS_INSTRUMENTATIONKEY__» и набор hello значение toohello же ключ инструментирования используемые hello SDK.
5. Откройте дополнительные инструменты.
6. Нажмите кнопку «Go» tooopen hello Kudu веб-сайта.
7. Веб-сайте Kudu hello выберите «Расширения сайта».
8. __Установите Application Insights__ из коллекции.
9. Перезапустите веб-приложение hello.

## <a id="aspnetcore"></a>Поддержка ASP.NET Core

Приложению tooinstall 2.1.0-beta6 пакета Microsoft.ApplicationInsights.AspNetCore Nuget или выше toowork с hello профилировщика ASP.NET Core. Мы больше не поддерживают более ранние версии hello после 6/27/2017 г.

## <a name="next-steps"></a>Дальнейшие действия

* [Работа с Azure Application Insights в Visual Studio](https://docs.microsoft.com/azure/application-insights/app-insights-visual-studio)

[performance-blade]: ./media/app-insights-profiler/performance-blade.png
[performance-blade-examples]: ./media/app-insights-profiler/performance-blade-examples.png
[trace-explorer]: ./media/app-insights-profiler/trace-explorer.png
[trace-explorer-toolbar]: ./media/app-insights-profiler/trace-explorer-toolbar.png
[trace-explorer-hint-tip]: ./media/app-insights-profiler/trace-explorer-hint-tip.png
[trace-explorer-hot-path]: ./media/app-insights-profiler/trace-explorer-hot-path.png
[enable-profiler-banner]: ./media/app-insights-profiler/enable-profiler-banner.png
[disable-profiler-webjob]: ./media/app-insights-profiler/disable-profiler-webjob.png
[linked app services]: ./media/app-insights-profiler/linked-app-services.png

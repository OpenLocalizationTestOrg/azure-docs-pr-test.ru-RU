---
title: "Профилирование динамических веб-приложений в Azure с помощью Application Insights | Документация Майкрософт"
description: "Определите критический путь в коде веб-сервера с помощью профилировщика небольшого размера."
services: application-insights
documentationcenter: 
author: CFreemanwa
manager: carmonm
ms.service: application-insights
ms.workload: tbd
ms.tgt_pltfrm: ibiza
ms.devlang: na
ms.topic: article
ms.date: 05/04/2017
ms.author: bwren
ms.openlocfilehash: ff39f9a84b86c14859aaee50ee368643fb2848ea
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="profiling-live-azure-web-apps-with-application-insights"></a><span data-ttu-id="02c4f-103">Профилирование динамических веб-приложений Azure с помощью Application Insights</span><span class="sxs-lookup"><span data-stu-id="02c4f-103">Profiling live Azure web apps with Application Insights</span></span>

<span data-ttu-id="02c4f-104">*Общедоступная версия этой функции Application Insights доступна для служб приложений, а предварительная — для вычислений.*</span><span class="sxs-lookup"><span data-stu-id="02c4f-104">*This feature of Application Insights is GA for App Services and in preview for Compute.*</span></span>

<span data-ttu-id="02c4f-105">Узнайте, сколько времени выполняется каждый метод в динамическом веб-приложении с помощью средства профилирования [Azure Application Insights](app-insights-overview.md).</span><span class="sxs-lookup"><span data-stu-id="02c4f-105">Find out how much time is spent in each method in your live web application by using the profiling tool of [Azure Application Insights](app-insights-overview.md).</span></span> <span data-ttu-id="02c4f-106">Оно отображает подробные данные профилей динамических запросов, обработанные приложением, а также выделяет "критический путь", на использование которого уходит большая часть времени.</span><span class="sxs-lookup"><span data-stu-id="02c4f-106">It shows you detailed profiles of live requests that were served by your app, and highlights the 'hot path' that is using the most time.</span></span> <span data-ttu-id="02c4f-107">Это средство автоматически выбирает примеры с разным временем ответа.</span><span class="sxs-lookup"><span data-stu-id="02c4f-107">It automatically selects examples that have different response times.</span></span> <span data-ttu-id="02c4f-108">Профилировщик использует различные методы для минимизации затрат.</span><span class="sxs-lookup"><span data-stu-id="02c4f-108">The profiler uses various techniques to minimize overhead.</span></span>

<span data-ttu-id="02c4f-109">Сейчас он работает для веб-приложений ASP.NET, запущенных в службах приложений Azure, по крайней мере с ценовой категорией "Базовый".</span><span class="sxs-lookup"><span data-stu-id="02c4f-109">The profiler currently works for ASP.NET web apps running on Azure App Services, in at least the Basic pricing tier.</span></span> 

<a id="installation"></a>
## <a name="enable-the-profiler"></a><span data-ttu-id="02c4f-110">Включение профилировщика</span><span class="sxs-lookup"><span data-stu-id="02c4f-110">Enable the profiler</span></span>

<span data-ttu-id="02c4f-111">[Установите Application Insights](app-insights-asp-net.md) в коде.</span><span class="sxs-lookup"><span data-stu-id="02c4f-111">[Install Application Insights](app-insights-asp-net.md) in your code.</span></span> <span data-ttu-id="02c4f-112">Если эта среда уже установлена, убедитесь, что вы используете последнюю версию.</span><span class="sxs-lookup"><span data-stu-id="02c4f-112">If it's already installed, make sure you have the latest version.</span></span> <span data-ttu-id="02c4f-113">(Щелкните правой кнопкой мыши проект в обозревателе решений и выберите "Управление пакетами NuGet".</span><span class="sxs-lookup"><span data-stu-id="02c4f-113">(To do this, right-click your project in Solution Explorer, and choose Manage NuGet packages.</span></span> <span data-ttu-id="02c4f-114">Выберите "Обновления" и обновите все пакеты.) Повторно разверните приложение.</span><span class="sxs-lookup"><span data-stu-id="02c4f-114">Select Updates and update all packages.) Re-deploy your app.</span></span>

<span data-ttu-id="02c4f-115">*Используете ASP.NET Core? [Ознакомьтесь с этим разделом](#aspnetcore).*</span><span class="sxs-lookup"><span data-stu-id="02c4f-115">*Using ASP.NET Core? [Check here](#aspnetcore).*</span></span>

<span data-ttu-id="02c4f-116">На сайте [https://portal.azure.com](https://portal.azure.com) откройте ресурс Application Insights для своего веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="02c4f-116">In [https://portal.azure.com](https://portal.azure.com), open the Application Insights resource for your web app.</span></span> <span data-ttu-id="02c4f-117">Откройте **Производительность** и щелкните **Включить профилировщик Application Insights**.</span><span class="sxs-lookup"><span data-stu-id="02c4f-117">Open **Performance** and click **Enable Application Insights Profiler...**.</span></span>

![Щелкните на баннер включения профилировщика.][enable-profiler-banner]

<span data-ttu-id="02c4f-119">Кроме того, всегда можно щелкнуть **Настройка**, чтобы просмотреть состояние профилировщика, а также включить или отключить его.</span><span class="sxs-lookup"><span data-stu-id="02c4f-119">Alternatively, you can always click **Configure** to view status, enable, or disable the Profiler.</span></span>

![Колонка "Производительность", кнопка "Настроить"][performance-blade]

<span data-ttu-id="02c4f-121">Веб-приложения, для которых настроено использование Application Insights, перечислены в колонке "Настройка".</span><span class="sxs-lookup"><span data-stu-id="02c4f-121">Web apps that are configured with Application Insights are listed on Configure blade.</span></span> <span data-ttu-id="02c4f-122">Следуйте инструкциям, чтобы при необходимости установить агент профилировщика.</span><span class="sxs-lookup"><span data-stu-id="02c4f-122">Follow instructions to install the Profiler agent if needed.</span></span> <span data-ttu-id="02c4f-123">Если у вас пока нет веб-приложений, для которых настроено использование Application Insights, щелкните *Add Linked Apps* (Добавить связанные приложения).</span><span class="sxs-lookup"><span data-stu-id="02c4f-123">If no web app is configured with Application Insights yet, click *Add Linked Apps*.</span></span>

<span data-ttu-id="02c4f-124">Используйте кнопки *Enable Profiler* (Включить профилировщик) и *Disable Profiler* (Отключить профилировщик) в колонке "Настройка", чтобы управлять профилировщиком для всех связанных веб-приложений.</span><span class="sxs-lookup"><span data-stu-id="02c4f-124">Use the *Enable Profiler* or *Disable Profiler* buttons in the Configure blade to control the Profiler on all your linked web apps.</span></span>



![Колонка «Настройка»][linked app services]

<span data-ttu-id="02c4f-126">Чтобы остановить или перезапустить профилировщик для отдельного экземпляра службы приложений, его можно найти **в ресурсе службы приложений** в области **Веб-задания**.</span><span class="sxs-lookup"><span data-stu-id="02c4f-126">To stop or restart the profiler for an individual App Service instance, you'll find it **in the App Service resource**, in **Web Jobs**.</span></span> <span data-ttu-id="02c4f-127">Чтобы его удалить, найдите раздел **Расширения**.</span><span class="sxs-lookup"><span data-stu-id="02c4f-127">To delete it, look under **Extensions**.</span></span>

![Отключение профилировщика для веб-заданий][disable-profiler-webjob]

<span data-ttu-id="02c4f-129">Мы рекомендуем включить профилировщик для всех веб-приложений, чтобы обеспечить максимально быстрое обнаружение проблем производительности.</span><span class="sxs-lookup"><span data-stu-id="02c4f-129">We recommend that you have the Profiler enabled on all your web apps to discover any performance issues as soon as possible.</span></span>

<span data-ttu-id="02c4f-130">Если вы используете WebDeploy для развертывания изменений в веб-приложении, убедитесь, что папка **App_Data** не удалилась во время развертывания.</span><span class="sxs-lookup"><span data-stu-id="02c4f-130">If you use WebDeploy to deploy changes to your web application, ensure that you exclude the **App_Data** folder from being deleted during deployment.</span></span> <span data-ttu-id="02c4f-131">В противном случае файлы с расширением профилировщика будут удалены при следующем развертывании веб-приложения в Azure.</span><span class="sxs-lookup"><span data-stu-id="02c4f-131">Otherwise, the profiler extension's files will be deleted when you next deploy the web application to Azure.</span></span>

### <a name="using-profiler-with-azure-vms-and-compute-resources-preview"></a><span data-ttu-id="02c4f-132">Использование профилировщика с виртуальными машинами и вычислительных ресурсами Azure (предварительная версия)</span><span class="sxs-lookup"><span data-stu-id="02c4f-132">Using profiler with Azure VMs and Compute resources (preview)</span></span>

<span data-ttu-id="02c4f-133">После [включения Application Insights для служб приложений Azure во время выполнения](app-insights-azure-web-apps.md#run-time-instrumentation-with-application-insights) профилировщик автоматически становится доступным.</span><span class="sxs-lookup"><span data-stu-id="02c4f-133">When you [enable Application Insights for Azure app services at run time](app-insights-azure-web-apps.md#run-time-instrumentation-with-application-insights), Profiler is automatically available.</span></span> <span data-ttu-id="02c4f-134">(Если вы уже включили Application Insights для ресурса, может потребоваться выполнить обновление до последней версии с помощью мастера **настройки**.)</span><span class="sxs-lookup"><span data-stu-id="02c4f-134">(If you already enabled Application Insights for the resource, you might need to update to the lates version through the **Configure** wizard.)</span></span>

<span data-ttu-id="02c4f-135">Существует [предварительная версия профилировщика для вычислительных ресурсов Azure](https://go.microsoft.com/fwlink/?linkid=848155).</span><span class="sxs-lookup"><span data-stu-id="02c4f-135">There is a [preview version of the Profiler for Azure Compute resources](https://go.microsoft.com/fwlink/?linkid=848155).</span></span>


## <a name="limits"></a><span data-ttu-id="02c4f-136">Ограничения</span><span class="sxs-lookup"><span data-stu-id="02c4f-136">Limits</span></span>

<span data-ttu-id="02c4f-137">Срок хранения данных по умолчанию — 5 дней.</span><span class="sxs-lookup"><span data-stu-id="02c4f-137">The default data retention is 5 days.</span></span> <span data-ttu-id="02c4f-138">В день может быть принято до 10 ГБ.</span><span class="sxs-lookup"><span data-stu-id="02c4f-138">Maximum 10 GB ingested per day.</span></span>

<span data-ttu-id="02c4f-139">За использование службы профилировщика плата не взимается.</span><span class="sxs-lookup"><span data-stu-id="02c4f-139">There is no charge for the profiler service.</span></span> <span data-ttu-id="02c4f-140">Веб-приложение должно быть размещено по крайней мере на уровне "Базовый" служб приложений.</span><span class="sxs-lookup"><span data-stu-id="02c4f-140">Your web app must be hosted in at least the Basic tier of App Services.</span></span>

## <a name="viewing-profiler-data"></a><span data-ttu-id="02c4f-141">Просмотр данных профилировщика</span><span class="sxs-lookup"><span data-stu-id="02c4f-141">Viewing profiler data</span></span>

<span data-ttu-id="02c4f-142">Откройте колонку "Производительность" и прокрутите вниз до списка операций.</span><span class="sxs-lookup"><span data-stu-id="02c4f-142">Open the Performance blade and scroll down to the operation list.</span></span>




![Столбец примеров в колонке "Производительность" Application Insights][performance-blade-examples]

<span data-ttu-id="02c4f-144">Ниже приведены столбцы в таблице.</span><span class="sxs-lookup"><span data-stu-id="02c4f-144">The columns in the table are:</span></span>

* <span data-ttu-id="02c4f-145">**Число.** Количество запросов в диапазоне времени колонки.</span><span class="sxs-lookup"><span data-stu-id="02c4f-145">**Count** - The number of these requests in the time range of the blade.</span></span>
* <span data-ttu-id="02c4f-146">**Median** (Медиана). Стандартное время, требуемое приложению для ответа на запрос.</span><span class="sxs-lookup"><span data-stu-id="02c4f-146">**Median** - The typical time your app takes to respond to a request.</span></span> <span data-ttu-id="02c4f-147">Половина всех ответов была получена быстрее, чем сейчас.</span><span class="sxs-lookup"><span data-stu-id="02c4f-147">Half of all responses were faster than this.</span></span>
* <span data-ttu-id="02c4f-148">**95th percentile** (95-й процентиль). 95 % ответов были получены быстрее, чем сейчас.</span><span class="sxs-lookup"><span data-stu-id="02c4f-148">**95th percentile** 95% of responses were faster than this.</span></span> <span data-ttu-id="02c4f-149">Если это число существенно отличается от медианы, возможно, в приложении периодически возникают неполадки.</span><span class="sxs-lookup"><span data-stu-id="02c4f-149">If this figure is very different from the median, there might be an intermittent problem with your app.</span></span> <span data-ttu-id="02c4f-150">(Или это можно объяснить с помощью такой конструктивной функции, как кэширование.)</span><span class="sxs-lookup"><span data-stu-id="02c4f-150">(Or it might be explained by a design feature such as caching.)</span></span>
* <span data-ttu-id="02c4f-151">**Примеры.** Значок указывает, что профилировщик получил трассировки стека для этой операции.</span><span class="sxs-lookup"><span data-stu-id="02c4f-151">**Examples** - an icon indicates that the profiler has captured stack traces for this operation.</span></span>

<span data-ttu-id="02c4f-152">Щелкните значок "Примеры", чтобы открыть обозреватель трассировки.</span><span class="sxs-lookup"><span data-stu-id="02c4f-152">Click the Examples icon to open the trace explorer.</span></span> <span data-ttu-id="02c4f-153">В обозревателе находится несколько примеров, записанных профилировщиком, которые классифицируются по времени ответа.</span><span class="sxs-lookup"><span data-stu-id="02c4f-153">The explorer shows several samples that the profiler has captured, classified by response time.</span></span>

<span data-ttu-id="02c4f-154">Выберите пример, чтобы отобразить классификацию на уровне кода по времени, затраченному на выполнение запроса.</span><span class="sxs-lookup"><span data-stu-id="02c4f-154">Select a sample to show a code-level breakdown of time spent executing the request.</span></span>

![Обозреватель трассировки Application Insights][trace-explorer]

<span data-ttu-id="02c4f-156">С помощью флажка **Show hot path** (Показывать критический путь) можно открыть основной листовой узел или хотя бы что-то с ним связанное.</span><span class="sxs-lookup"><span data-stu-id="02c4f-156">**Show hot path** opens the biggest leaf node, or at least something close.</span></span> <span data-ttu-id="02c4f-157">В большинстве случаев этот узел будет размещаться рядом с узким местом производительности.</span><span class="sxs-lookup"><span data-stu-id="02c4f-157">In most cases this node will be adjacent to a performance bottleneck.</span></span>



* <span data-ttu-id="02c4f-158">**Метка** — имя функции или события.</span><span class="sxs-lookup"><span data-stu-id="02c4f-158">**Label**: The name of the function or event.</span></span> <span data-ttu-id="02c4f-159">В дереве отображается сочетание кода и возникающих событий (например, события SQL и HTTP).</span><span class="sxs-lookup"><span data-stu-id="02c4f-159">The tree shows a mix of code and events that occurred (such as SQL and http events).</span></span> <span data-ttu-id="02c4f-160">Основное событие предоставляет общую длительность запроса.</span><span class="sxs-lookup"><span data-stu-id="02c4f-160">The top event represents the overall request duration.</span></span>
* <span data-ttu-id="02c4f-161">**Прошло**: интервал времени между началом и завершением операции.</span><span class="sxs-lookup"><span data-stu-id="02c4f-161">**Elapsed**: The time interval between the start of the operation and the end.</span></span>
* <span data-ttu-id="02c4f-162">**Когда** — отображает время запуска функции или события по отношению к другим функциям.</span><span class="sxs-lookup"><span data-stu-id="02c4f-162">**When**: Shows when the function/event was running in relation to other functions.</span></span>

## <a name="how-to-read-performance-data"></a><span data-ttu-id="02c4f-163">Чтение данных о производительности</span><span class="sxs-lookup"><span data-stu-id="02c4f-163">How to read performance data</span></span>

<span data-ttu-id="02c4f-164">Профилировщик службы Майкрософт использует метод выборки и инструментирование для анализа производительности приложения.</span><span class="sxs-lookup"><span data-stu-id="02c4f-164">Microsoft service profiler uses a combination of sampling method and instrumentation to analyze the performance of your application.</span></span>
<span data-ttu-id="02c4f-165">Во время подробной сборки профилировщик службы каждую миллисекунду проводит выборку указателя инструкций для всех ЦП компьютера.</span><span class="sxs-lookup"><span data-stu-id="02c4f-165">When detailed collection is in progress, service profiler samples the instruction pointer of each of the machine's CPU in every millisecond.</span></span>
<span data-ttu-id="02c4f-166">Каждый пример записывает полный стек вызовов выполняющегося потока, предоставляя подробные и полезные сведения о нем на высоком и низком уровне абстракции.</span><span class="sxs-lookup"><span data-stu-id="02c4f-166">Each sample captures the complete call stack of the thread currently executing, giving detailed and useful information about what that thread was doing at both high and low levels of abstraction.</span></span> <span data-ttu-id="02c4f-167">Профилировщик службы также собирает сведения о других событиях, например о событиях переключения контекста, библиотеки параллельных задач (TPL) и пула потоков для отслеживания корреляции действий и причинно-следственных связей.</span><span class="sxs-lookup"><span data-stu-id="02c4f-167">Service profiler also collects other events such as context switching events, TPL events, and thread-pool events to track activity correlation and causality.</span></span>

<span data-ttu-id="02c4f-168">Стек вызовов, отображаемый в представлении временной шкалы, является результатом приведенной выше выборки и инструментирования.</span><span class="sxs-lookup"><span data-stu-id="02c4f-168">The call stack shown in the timeline view is the result of the above sampling and instrumentation.</span></span> <span data-ttu-id="02c4f-169">Так как каждый пример записывает полный стек вызовов потока, он содержит код из .NET Framework, а также из других указанных платформ.</span><span class="sxs-lookup"><span data-stu-id="02c4f-169">Because each sample captures the complete call stack of the thread, it includes code from the .NET framework, as well as other frameworks you reference.</span></span>

### <span data-ttu-id="02c4f-170"><a id="jitnewobj"></a>Выделение объектов (`clr!JIT\_New or clr!JIT\_Newarr1`)</span><span class="sxs-lookup"><span data-stu-id="02c4f-170"><a id="jitnewobj"></a>Object Allocation (`clr!JIT\_New or clr!JIT\_Newarr1`)</span></span>
<span data-ttu-id="02c4f-171">`clr!JIT\_New and clr!JIT\_Newarr1` — это вспомогательные функции в .NET Framework, выделяющие память из управляемой кучи.</span><span class="sxs-lookup"><span data-stu-id="02c4f-171">`clr!JIT\_New and clr!JIT\_Newarr1` are helper functions inside .NET framework that allocates memory from managed heap.</span></span> <span data-ttu-id="02c4f-172">`clr!JIT\_New` вызывается при выделении объекта.</span><span class="sxs-lookup"><span data-stu-id="02c4f-172">`clr!JIT\_New` is invoked when an object is allocated.</span></span> <span data-ttu-id="02c4f-173">`clr!JIT\_Newarr1` вызывается при выделении массива объектов.</span><span class="sxs-lookup"><span data-stu-id="02c4f-173">`clr!JIT\_Newarr1` is invoked when an object array is allocated.</span></span> <span data-ttu-id="02c4f-174">Обычно эти две функции выполняются очень быстро за относительно небольшое время.</span><span class="sxs-lookup"><span data-stu-id="02c4f-174">These two functions are typically very fast and should take relatively small amount of time.</span></span> <span data-ttu-id="02c4f-175">Если функции `clr!JIT\_New` или `clr!JIT\_Newarr1` занимают довольно много времени во временной шкале, это указывает на то, что код, возможно, выделяет несколько объектов и потребляет значительный объем памяти.</span><span class="sxs-lookup"><span data-stu-id="02c4f-175">If you see `clr!JIT\_New` or `clr!JIT\_Newarr1` take a substantial amount of time in your timeline, it's an indication that the code may be allocating many objects and consuming significant amount of memory.</span></span>

### <span data-ttu-id="02c4f-176"><a id="theprestub"></a>Код загрузки (`clr!ThePreStub`)</span><span class="sxs-lookup"><span data-stu-id="02c4f-176"><a id="theprestub"></a>Loading Code (`clr!ThePreStub`)</span></span>
<span data-ttu-id="02c4f-177">`clr!ThePreStub` — это вспомогательная функция в .NET Framework, подготавливающая код к первому выполнению.</span><span class="sxs-lookup"><span data-stu-id="02c4f-177">`clr!ThePreStub` is a helper function inside .NET framework that prepares the code to execute for the first time.</span></span> <span data-ttu-id="02c4f-178">Как правило, она включает в себя JIT-компиляцию (но не ограничивается ей).</span><span class="sxs-lookup"><span data-stu-id="02c4f-178">This typically includes, but not limited to, JIT (Just In Time) compilation.</span></span> <span data-ttu-id="02c4f-179">Для каждого метода C# `clr!ThePreStub` должна вызываться только один раз в течение всего времени существования процесса.</span><span class="sxs-lookup"><span data-stu-id="02c4f-179">For each C# method, `clr!ThePreStub` should be invoked at most once during the lifetime of a process.</span></span>

<span data-ttu-id="02c4f-180">Если `clr!ThePreStub` требуется много времени для запроса, это значит, что запрос впервые выполняет метод, на загрузку которого требуется значительное время работы среды выполнения .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="02c4f-180">If you see `clr!ThePreStub` takes significant amount of time for a request, it indicates that request is the first one that executes that method, and the time for .NET framework runtime to load that method is significant.</span></span> <span data-ttu-id="02c4f-181">Вы можете использовать процесс прогрева, выполняющий эту часть кода до предоставления к нему доступа пользователям, или запустить NGen в сборках.</span><span class="sxs-lookup"><span data-stu-id="02c4f-181">You can consider a warm-up process that executes that portion of the code before your users access it, or consider running NGen on your assemblies.</span></span>

### <span data-ttu-id="02c4f-182"><a id="lockcontention"></a>Конфликт блокировки (`clr!JITutil\_MonContention` или `clr!JITutil\_MonEnterWorker`)</span><span class="sxs-lookup"><span data-stu-id="02c4f-182"><a id="lockcontention"></a>Lock Contention (`clr!JITutil\_MonContention` or `clr!JITutil\_MonEnterWorker`)</span></span>
<span data-ttu-id="02c4f-183">`clr!JITutil\_MonContention` или `clr!JITutil\_MonEnterWorker` указывают текущий поток, ожидающий снятия блокировки.</span><span class="sxs-lookup"><span data-stu-id="02c4f-183">`clr!JITutil\_MonContention` or `clr!JITutil\_MonEnterWorker` indicate the current thread is waiting for a lock to be released.</span></span> <span data-ttu-id="02c4f-184">Обычно это отображается при выполнении команды lock языка C# путем вызова метода Monitor.Enter или метода с атрибутом MethodImplOptions.Synchronized.</span><span class="sxs-lookup"><span data-stu-id="02c4f-184">This typically shows up when executing a C# lock statement, invoking Monitor.Enter method, or invoking a method with MethodImplOptions.Synchronized attribute.</span></span> <span data-ttu-id="02c4f-185">Конфликт блокировки обычно происходит при получении блокировки потоком A, а также при попытке получить ту же блокировку потоком Б до ее снятия потоком A.</span><span class="sxs-lookup"><span data-stu-id="02c4f-185">Lock contention typically happens when thread A acquires a lock, and thread B tries to acquire the same lock before thread A releases it.</span></span>

### <span data-ttu-id="02c4f-186"><a id="ngencold"></a>Код загрузки (`[COLD]`)</span><span class="sxs-lookup"><span data-stu-id="02c4f-186"><a id="ngencold"></a>Loading code (`[COLD]`)</span></span>
<span data-ttu-id="02c4f-187">Если имя метода содержит `[COLD]`, например `mscorlib.ni![COLD]System.Reflection.CustomAttribute.IsDefined`, это значит, что в среде выполнения .NET Framework выполняется код, оптимизация которого впервые не осуществилась <a href="https://msdn.microsoft.com/library/e7k32f4k.aspx">с использованием профиля</a>.</span><span class="sxs-lookup"><span data-stu-id="02c4f-187">If the method name contains `[COLD]`, such as `mscorlib.ni![COLD]System.Reflection.CustomAttribute.IsDefined`, it means that the .NET framework runtime is executing code that is not optimized by <a href="https://msdn.microsoft.com/library/e7k32f4k.aspx">profile-guided optimization</a> for the first time.</span></span> <span data-ttu-id="02c4f-188">Для каждого метода он должен отображаться только один раз в течение всего времени существования процесса.</span><span class="sxs-lookup"><span data-stu-id="02c4f-188">For each method, it should show up at most once during the lifetime of the process.</span></span>

<span data-ttu-id="02c4f-189">Если коду загрузки требуется значительное время на запрос, это значит, что запрос впервые выполняет неоптимизированную часть метода.</span><span class="sxs-lookup"><span data-stu-id="02c4f-189">If loading code takes significant amount of time for a request, it indicates that request is the first one to execute the unoptimized portion of the method.</span></span> <span data-ttu-id="02c4f-190">Вы можете использовать процесс прогрева, который выполняет эту часть кода до предоставления к нему доступа пользователям.</span><span class="sxs-lookup"><span data-stu-id="02c4f-190">You can consider a warm up process that executes that portion of the code before your users access it.</span></span>

### <span data-ttu-id="02c4f-191"><a id="httpclientsend"></a>Отправка HTTP-запроса</span><span class="sxs-lookup"><span data-stu-id="02c4f-191"><a id="httpclientsend"></a>Send HTTP Request</span></span>
<span data-ttu-id="02c4f-192">Методы (например, `HttpClient.Send`) указывают код, ожидающий завершения HTTP-запроса.</span><span class="sxs-lookup"><span data-stu-id="02c4f-192">Methods such as `HttpClient.Send` indicate the code is waiting for a HTTP request to complete.</span></span>

### <span data-ttu-id="02c4f-193"><a id="sqlcommand"></a>Операция с базой данных</span><span class="sxs-lookup"><span data-stu-id="02c4f-193"><a id="sqlcommand"></a>Database Operation</span></span>
<span data-ttu-id="02c4f-194">Метод (например, SqlCommand.Execute) указывает код, ожидающий завершения операции с базой данных.</span><span class="sxs-lookup"><span data-stu-id="02c4f-194">Method such as SqlCommand.Execute indicates the code is waiting for a database operation to complete.</span></span>

### <span data-ttu-id="02c4f-195"><a id="await"></a>Ожидание (`AWAIT\_TIME`)</span><span class="sxs-lookup"><span data-stu-id="02c4f-195"><a id="await"></a>Waiting (`AWAIT\_TIME`)</span></span>
<span data-ttu-id="02c4f-196">`AWAIT\_TIME` указывает код, ожидающий завершения другой задачи.</span><span class="sxs-lookup"><span data-stu-id="02c4f-196">`AWAIT\_TIME` indicates the code is waiting for another task to complete.</span></span> <span data-ttu-id="02c4f-197">Обычно это осуществляется с помощью команды await языка C#.</span><span class="sxs-lookup"><span data-stu-id="02c4f-197">This typically happens with C# 'await' statement.</span></span> <span data-ttu-id="02c4f-198">Когда код выполняет эту команду, поток освобождает и возвращает элемент управления в пул потоков, а поток, блокирующийся при ожидании завершения await, отсутствует.</span><span class="sxs-lookup"><span data-stu-id="02c4f-198">When the code does a C# 'await', the thread unwinds and returns control to the thread-pool, and there is no thread that is blocked waiting for the 'await' to finish.</span></span> <span data-ttu-id="02c4f-199">Однако если рассуждать логически, поток, который "заблокировал" await, ожидает завершения операции.</span><span class="sxs-lookup"><span data-stu-id="02c4f-199">However, logically the thread that did the await is 'blocked' waiting for the operation to complete.</span></span> <span data-ttu-id="02c4f-200">`AWAIT\_TIME` указывает время блокировки в ожидании завершения задачи.</span><span class="sxs-lookup"><span data-stu-id="02c4f-200">The `AWAIT\_TIME` indicates the blocked time waiting for the task to complete.</span></span>

### <span data-ttu-id="02c4f-201"><a id="block"></a>Время блокировки</span><span class="sxs-lookup"><span data-stu-id="02c4f-201"><a id="block"></a>Blocked Time</span></span>
<span data-ttu-id="02c4f-202">`BLOCKED_TIME` указывает, что код ожидает, пока другой ресурс станет доступным, например, ожидает объект синхронизации, ожидает, пока поток станет доступным, или ожидает завершения запроса.</span><span class="sxs-lookup"><span data-stu-id="02c4f-202">`BLOCKED_TIME` indicates the code is waiting for another resource to be available, such as waiting for a synchronization object, waiting for a thread to be available, or waiting for a request to finish.</span></span>

### <span data-ttu-id="02c4f-203"><a id="cpu"></a>Время ЦП</span><span class="sxs-lookup"><span data-stu-id="02c4f-203"><a id="cpu"></a>CPU Time</span></span>
<span data-ttu-id="02c4f-204">ЦП занят выполнением инструкций.</span><span class="sxs-lookup"><span data-stu-id="02c4f-204">The CPU is busy executing the instructions.</span></span>

### <span data-ttu-id="02c4f-205"><a id="disk"></a>Время работы диска</span><span class="sxs-lookup"><span data-stu-id="02c4f-205"><a id="disk"></a>Disk Time</span></span>
<span data-ttu-id="02c4f-206">Приложение выполняет операции с диском.</span><span class="sxs-lookup"><span data-stu-id="02c4f-206">The application is performing disk operations.</span></span>

### <span data-ttu-id="02c4f-207"><a id="network"></a>Сетевое время</span><span class="sxs-lookup"><span data-stu-id="02c4f-207"><a id="network"></a>Network Time</span></span>
<span data-ttu-id="02c4f-208">Приложение выполняет сетевые операции.</span><span class="sxs-lookup"><span data-stu-id="02c4f-208">The application is performing network operations.</span></span>

### <span data-ttu-id="02c4f-209"><a id="when"></a>Столбец "Время"</span><span class="sxs-lookup"><span data-stu-id="02c4f-209"><a id="when"></a>When column</span></span>
<span data-ttu-id="02c4f-210">Это визуальное представление того, как со временем изменяются выборки INCLUSIVE, собранные для узла.</span><span class="sxs-lookup"><span data-stu-id="02c4f-210">This is a visualization of how the INCLUSIVE samples collected for a node vary over time.</span></span> <span data-ttu-id="02c4f-211">Общий диапазон запроса состоит из 32 временных периодов, в которых накапливаются включающие выборки для данного узла.</span><span class="sxs-lookup"><span data-stu-id="02c4f-211">The total range of the request is divided into 32 time buckets and the inclusive samples for that node are accumulated into those 32 buckets.</span></span> <span data-ttu-id="02c4f-212">Затем каждый период представляется в виде полосы, высота которой обозначает масштабированное значение.</span><span class="sxs-lookup"><span data-stu-id="02c4f-212">Each bucket is then represented as a bar whose height represents a scaled value.</span></span> <span data-ttu-id="02c4f-213">Для узлов, помеченных как `CPU_TIME` или `BLOCKED_TIME`, или когда существует очевидная связь с потреблением ресурсов (ЦП, диск, поток), в полосе представлено использование одного из этих ресурсов за определенный период времени.</span><span class="sxs-lookup"><span data-stu-id="02c4f-213">For nodes marked `CPU_TIME` or `BLOCKED_TIME`, or where there is an obvious relationship of consuming a resource (cpu, disk, thread), the bar represents consuming one of those resources for the period of time of that bucket.</span></span> <span data-ttu-id="02c4f-214">Для этих метрик можно получить показатель, превышающий 100 %, за счет потребления нескольких ресурсов.</span><span class="sxs-lookup"><span data-stu-id="02c4f-214">For these metrics you can get greater than 100% by consuming multiple resources.</span></span> <span data-ttu-id="02c4f-215">Например, если в среднем за определенный интервал времени используется два процессора, показатель достигнет 200 %.</span><span class="sxs-lookup"><span data-stu-id="02c4f-215">For example, if on average you use two CPUs over an interval then you get 200%.</span></span>


## <span data-ttu-id="02c4f-216"><a id="troubleshooting"></a>Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="02c4f-216"><a id="troubleshooting"></a>Troubleshooting</span></span>

### <a name="how-can-i-know-whether-application-insights-profiler-is-running"></a><span data-ttu-id="02c4f-217">Как узнать, работает ли профилировщик Application Insights?</span><span class="sxs-lookup"><span data-stu-id="02c4f-217">How can I know whether Application Insights profiler is running?</span></span>

<span data-ttu-id="02c4f-218">Профилировщик запускается в качестве непрерывного веб-задания в веб-приложении.</span><span class="sxs-lookup"><span data-stu-id="02c4f-218">The profiler runs as a continuous web job in Web App.</span></span> <span data-ttu-id="02c4f-219">Вы можете открыть ресурс веб-приложения на сайте https://portal.azure.com и проверить состояние ApplicationInsightsProfiler в колонке веб-заданий.</span><span class="sxs-lookup"><span data-stu-id="02c4f-219">You can open the Web App resource in https://portal.azure.com and check "ApplicationInsightsProfiler" status in the WebJobs blade.</span></span> <span data-ttu-id="02c4f-220">Если он не работает, щелкните **Журналы**, чтобы узнать об этом побольше.</span><span class="sxs-lookup"><span data-stu-id="02c4f-220">If it isn't running, open **Logs** to find out more.</span></span>

### <a name="why-cant-i-find-any-stack-examples-even-though-the-profiler-is-running"></a><span data-ttu-id="02c4f-221">Почему не удается найти все примеры стека даже при работе профилировщика?</span><span class="sxs-lookup"><span data-stu-id="02c4f-221">Why can't I find any stack examples even though the profiler is running?</span></span>

<span data-ttu-id="02c4f-222">Вот несколько моментов, которые можно проверить.</span><span class="sxs-lookup"><span data-stu-id="02c4f-222">Here are a few things you can check.</span></span>

1. <span data-ttu-id="02c4f-223">Убедитесь, что вы используете план службы веб-приложений уровня "Базовый" и выше.</span><span class="sxs-lookup"><span data-stu-id="02c4f-223">Make sure your Web App Service Plan is Basic tier and above.</span></span>
2. <span data-ttu-id="02c4f-224">Проверьте, содержит ли веб-приложение пакет SDK Application Insights бета-версии 2.2 и более поздней.</span><span class="sxs-lookup"><span data-stu-id="02c4f-224">Make sure your Web App has Application Insights SDK 2.2 Beta and above enabled.</span></span>
3. <span data-ttu-id="02c4f-225">Убедитесь, что веб-приложение содержит параметр APPINSIGHTS_INSTRUMENTATIONKEY с тем же ключом инструментирования, который использует пакет SDK Application Insights.</span><span class="sxs-lookup"><span data-stu-id="02c4f-225">Make sure your Web App has the APPINSIGHTS_INSTRUMENTATIONKEY setting with the same instrumentation key used by Application Insights SDK.</span></span>
4. <span data-ttu-id="02c4f-226">Проверьте, работает ли веб-приложение на платформе .Net Framework 4.6.</span><span class="sxs-lookup"><span data-stu-id="02c4f-226">Make sure your Web App is running on .Net Framework 4.6.</span></span>
5. <span data-ttu-id="02c4f-227">Если это приложение ASP.NET Core, также проверьте [необходимые зависимости](#aspnetcore).</span><span class="sxs-lookup"><span data-stu-id="02c4f-227">If it's an ASP.NET Core application, please also check [the required dependencies](#aspnetcore).</span></span>

<span data-ttu-id="02c4f-228">После запуска профилировщика наблюдается короткий период прогрева, во время которого профилировщик активно собирает несколько трассировок производительности.</span><span class="sxs-lookup"><span data-stu-id="02c4f-228">After the profiler is started, there is a short warm-up period when the profiler actively collects several performance traces.</span></span> <span data-ttu-id="02c4f-229">Он выполняет это действие в течение двух минут каждый час.</span><span class="sxs-lookup"><span data-stu-id="02c4f-229">After that, the profiler collects performance traces for two minutes in every hour.</span></span>  

### <a name="i-was-using-azure-service-profiler-what-happened-to-it"></a><span data-ttu-id="02c4f-230">Я включил профилировщик службы Azure.</span><span class="sxs-lookup"><span data-stu-id="02c4f-230">I was using Azure Service Profiler.</span></span> <span data-ttu-id="02c4f-231">Что с ним произошло?</span><span class="sxs-lookup"><span data-stu-id="02c4f-231">What happened to it?</span></span>  

<span data-ttu-id="02c4f-232">При включении профилировщика Application Insights агент профилировщика службы Azure отключается.</span><span class="sxs-lookup"><span data-stu-id="02c4f-232">When you enable Application Insights Profiler, Azure Service Profiler agent is disabled.</span></span>

### <span data-ttu-id="02c4f-233"><a id="double-counting"></a>Двойной подсчет в параллельных потоках</span><span class="sxs-lookup"><span data-stu-id="02c4f-233"><a id="double-counting"></a>Double counting in parallel threads</span></span>

<span data-ttu-id="02c4f-234">В некоторых случаях значение метрики общего времени в средстве просмотра стека больше, чем фактическая длительность запроса.</span><span class="sxs-lookup"><span data-stu-id="02c4f-234">In some cases the total time metric in the stack viewer is more than the actual duration of the request.</span></span>

<span data-ttu-id="02c4f-235">Это может произойти при наличии нескольких потоков, связанных с запросом и работающих в параллельном режиме.</span><span class="sxs-lookup"><span data-stu-id="02c4f-235">This can happen when there are two or more threads associated with a request, operating in parallel.</span></span> <span data-ttu-id="02c4f-236">Поэтому общее время потока будет больше затраченного времени.</span><span class="sxs-lookup"><span data-stu-id="02c4f-236">The total thread time is then more than the elapsed time.</span></span> <span data-ttu-id="02c4f-237">Во многих случаях один поток может ожидать завершения другого.</span><span class="sxs-lookup"><span data-stu-id="02c4f-237">In many cases one thread may be waiting on the other to complete.</span></span> <span data-ttu-id="02c4f-238">Средство просмотра пытается это обнаружить и исключить ненужное ожидание, но при этом вместо исключения возникает слишком много ошибок. Это могут быть критически важные сведения.</span><span class="sxs-lookup"><span data-stu-id="02c4f-238">The viewer tries to detect this and omit the uninteresting wait, but errs on the side of showing too much rather than omitting what may be critical information.</span></span>  

<span data-ttu-id="02c4f-239">Обнаружив параллельные потоки в трассировках, необходимо указать, какие потоки находятся в состоянии ожидания, чтобы можно было определить критический путь к запросу.</span><span class="sxs-lookup"><span data-stu-id="02c4f-239">When you see parallel threads in your traces, you need to determine which threads are waiting so you can determine the critical path for the request.</span></span> <span data-ttu-id="02c4f-240">В большинстве случаев поток, который быстро переходит в состояние ожидания, просто ожидает другие потоки.</span><span class="sxs-lookup"><span data-stu-id="02c4f-240">In most cases, the thread that quickly goes into a wait state is simply waiting on the other threads.</span></span> <span data-ttu-id="02c4f-241">Сосредоточьтесь на других потоках и игнорируйте время ожидания потоков.</span><span class="sxs-lookup"><span data-stu-id="02c4f-241">Concentrate on the others and ignore the time in the waiting threads.</span></span>

### <span data-ttu-id="02c4f-242"><a id="issue-loading-trace-in-viewer"></a>Нет данных профилирования</span><span class="sxs-lookup"><span data-stu-id="02c4f-242"><a id="issue-loading-trace-in-viewer"></a>No profiling data</span></span>

1. <span data-ttu-id="02c4f-243">Если данные, которые вы пытаетесь просмотреть, хранятся дольше нескольких недель, попробуйте ограничить фильтр времени и повторите попытку.</span><span class="sxs-lookup"><span data-stu-id="02c4f-243">If the data you are trying to view is older than a couple of weeks, try limiting your time filter and try again.</span></span>

2. <span data-ttu-id="02c4f-244">Проверьте, не заблокирован ли доступ к https://gateway.azureserviceprofiler.net для прокси-серверов или брандмауэра.</span><span class="sxs-lookup"><span data-stu-id="02c4f-244">Check that proxies or a firewall have not blocked access to https://gateway.azureserviceprofiler.net.</span></span>

3. <span data-ttu-id="02c4f-245">Убедитесь, что ключ инструментирования Application Insights, используемый в приложении, совпадает с ресурсом Application Insights с включенным профилированием.</span><span class="sxs-lookup"><span data-stu-id="02c4f-245">Check that the Application Insights instrumentation key you are using in your app is the same as the Application Insights resource you've enabled profiling with.</span></span> <span data-ttu-id="02c4f-246">Обычно ключ находится в файле ApplicationInsights.config, но его также можно найти в файле web.config или app.config.</span><span class="sxs-lookup"><span data-stu-id="02c4f-246">The key is usually in ApplicationInsights.config but can also be found in web.config or app.config.</span></span>

### <a name="error-report-in-the-profiling-viewer"></a><span data-ttu-id="02c4f-247">Отчет об ошибках в средстве просмотра профилирования</span><span class="sxs-lookup"><span data-stu-id="02c4f-247">Error report in the profiling viewer</span></span>

<span data-ttu-id="02c4f-248">Отправьте запрос в службу поддержки с портала.</span><span class="sxs-lookup"><span data-stu-id="02c4f-248">File a support ticket from the portal.</span></span> <span data-ttu-id="02c4f-249">Укажите идентификатор корреляции из сообщения об ошибке.</span><span class="sxs-lookup"><span data-stu-id="02c4f-249">Please include the correlation ID from the error message.</span></span>

## <a name="manual-installation"></a><span data-ttu-id="02c4f-250">Ручная установка</span><span class="sxs-lookup"><span data-stu-id="02c4f-250">Manual installation</span></span>

<span data-ttu-id="02c4f-251">При настройке профилировщика в параметры веб-приложения вносятся следующие обновления.</span><span class="sxs-lookup"><span data-stu-id="02c4f-251">When you configure the profiler, the following updates are made to the Web App's settings.</span></span> <span data-ttu-id="02c4f-252">Если требуется, их можно внести вручную, например, если приложение выполняется в среде службы приложений Azure (ASE):</span><span class="sxs-lookup"><span data-stu-id="02c4f-252">You can do them yourself manually if your environment requires, for example, if your application runs in Azure App Service Environment (ASE):</span></span>

1. <span data-ttu-id="02c4f-253">В колонке управления веб-приложением выберите "Параметры".</span><span class="sxs-lookup"><span data-stu-id="02c4f-253">In the web app control blade, open Settings.</span></span>
2. <span data-ttu-id="02c4f-254">Для платформы .NET Framework установите версию 4.6.</span><span class="sxs-lookup"><span data-stu-id="02c4f-254">Set ".Net Framework version" to v4.6.</span></span>
3. <span data-ttu-id="02c4f-255">Установите для параметра "Всегда включено" значение "Включено".</span><span class="sxs-lookup"><span data-stu-id="02c4f-255">Set "Always On" to On.</span></span>
4. <span data-ttu-id="02c4f-256">Добавьте параметр приложения __APPINSIGHTS_INSTRUMENTATIONKEY__ и задайте для него значение с тем же ключом инструментирования, используемым пакетом SDK.</span><span class="sxs-lookup"><span data-stu-id="02c4f-256">Add app setting "__APPINSIGHTS_INSTRUMENTATIONKEY__" and set the value to the same instrumentation key used by the SDK.</span></span>
5. <span data-ttu-id="02c4f-257">Откройте дополнительные инструменты.</span><span class="sxs-lookup"><span data-stu-id="02c4f-257">Open Advanced Tools.</span></span>
6. <span data-ttu-id="02c4f-258">Щелкните "Перейти", чтобы открыть веб-сайт Kudu.</span><span class="sxs-lookup"><span data-stu-id="02c4f-258">Click "Go" to open the Kudu website.</span></span>
7. <span data-ttu-id="02c4f-259">На веб-сайте Kudu, выберите "Расширения сайта".</span><span class="sxs-lookup"><span data-stu-id="02c4f-259">In the Kudu website, select "Site extensions".</span></span>
8. <span data-ttu-id="02c4f-260">__Установите Application Insights__ из коллекции.</span><span class="sxs-lookup"><span data-stu-id="02c4f-260">Install "__Application Insights__" from Gallery.</span></span>
9. <span data-ttu-id="02c4f-261">Перезапустите веб-приложение.</span><span class="sxs-lookup"><span data-stu-id="02c4f-261">Restart the web app.</span></span>

## <span data-ttu-id="02c4f-262"><a id="aspnetcore"></a>Поддержка ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="02c4f-262"><a id="aspnetcore"></a>ASP.NET Core Support</span></span>

<span data-ttu-id="02c4f-263">Приложению ASP.NET Core необходимо установить пакет NuGet Microsoft.ApplicationInsights.AspNetCore версии 2.1.0-beta6 или более поздней версии для работы с профилировщиком.</span><span class="sxs-lookup"><span data-stu-id="02c4f-263">ASP.NET Core application needs to install Microsoft.ApplicationInsights.AspNetCore Nuget package 2.1.0-beta6 or higher to work with the Profiler.</span></span> <span data-ttu-id="02c4f-264">Начиная с 27.06.2017 более ранние версии больше не поддерживаются.</span><span class="sxs-lookup"><span data-stu-id="02c4f-264">We no longer support the lower versions after 6/27/2017.</span></span>

## <a name="next-steps"></a><span data-ttu-id="02c4f-265">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="02c4f-265">Next steps</span></span>

* [<span data-ttu-id="02c4f-266">Работа с Azure Application Insights в Visual Studio</span><span class="sxs-lookup"><span data-stu-id="02c4f-266">Working with Application Insights in Visual Studio</span></span>](https://docs.microsoft.com/azure/application-insights/app-insights-visual-studio)

[performance-blade]: ./media/app-insights-profiler/performance-blade.png
[performance-blade-examples]: ./media/app-insights-profiler/performance-blade-examples.png
[trace-explorer]: ./media/app-insights-profiler/trace-explorer.png
[trace-explorer-toolbar]: ./media/app-insights-profiler/trace-explorer-toolbar.png
[trace-explorer-hint-tip]: ./media/app-insights-profiler/trace-explorer-hint-tip.png
[trace-explorer-hot-path]: ./media/app-insights-profiler/trace-explorer-hot-path.png
[enable-profiler-banner]: ./media/app-insights-profiler/enable-profiler-banner.png
[disable-profiler-webjob]: ./media/app-insights-profiler/disable-profiler-webjob.png
[linked app services]: ./media/app-insights-profiler/linked-app-services.png

---
title: "Профилирование динамических веб-приложений в Azure с помощью Application Insights | Документация Майкрософт"
description: "Определите критический путь в коде веб-сервера с помощью профилировщика небольшого размера."
services: application-insights
documentationcenter: 
author: CFreemanwa
manager: carmonm
ms.service: application-insights
ms.workload: tbd
ms.tgt_pltfrm: ibiza
ms.devlang: na
ms.topic: article
ms.date: 05/04/2017
ms.author: bwren
ms.openlocfilehash: ff39f9a84b86c14859aaee50ee368643fb2848ea
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="profiling-live-azure-web-apps-with-application-insights"></a>Профилирование динамических веб-приложений Azure с помощью Application Insights

*Общедоступная версия этой функции Application Insights доступна для служб приложений, а предварительная — для вычислений.*

Узнайте, сколько времени выполняется каждый метод в динамическом веб-приложении с помощью средства профилирования [Azure Application Insights](app-insights-overview.md). Оно отображает подробные данные профилей динамических запросов, обработанные приложением, а также выделяет "критический путь", на использование которого уходит большая часть времени. Это средство автоматически выбирает примеры с разным временем ответа. Профилировщик использует различные методы для минимизации затрат.

Сейчас он работает для веб-приложений ASP.NET, запущенных в службах приложений Azure, по крайней мере с ценовой категорией "Базовый". 

<a id="installation"></a>
## <a name="enable-the-profiler"></a>Включение профилировщика

[Установите Application Insights](app-insights-asp-net.md) в коде. Если эта среда уже установлена, убедитесь, что вы используете последнюю версию. (Щелкните правой кнопкой мыши проект в обозревателе решений и выберите "Управление пакетами NuGet". Выберите "Обновления" и обновите все пакеты.) Повторно разверните приложение.

*Используете ASP.NET Core? [Ознакомьтесь с этим разделом](#aspnetcore).*

На сайте [https://portal.azure.com](https://portal.azure.com) откройте ресурс Application Insights для своего веб-приложения. Откройте **Производительность** и щелкните **Включить профилировщик Application Insights**.

![Щелкните на баннер включения профилировщика.][enable-profiler-banner]

Кроме того, всегда можно щелкнуть **Настройка**, чтобы просмотреть состояние профилировщика, а также включить или отключить его.

![Колонка "Производительность", кнопка "Настроить"][performance-blade]

Веб-приложения, для которых настроено использование Application Insights, перечислены в колонке "Настройка". Следуйте инструкциям, чтобы при необходимости установить агент профилировщика. Если у вас пока нет веб-приложений, для которых настроено использование Application Insights, щелкните *Add Linked Apps* (Добавить связанные приложения).

Используйте кнопки *Enable Profiler* (Включить профилировщик) и *Disable Profiler* (Отключить профилировщик) в колонке "Настройка", чтобы управлять профилировщиком для всех связанных веб-приложений.



![Колонка «Настройка»][linked app services]

Чтобы остановить или перезапустить профилировщик для отдельного экземпляра службы приложений, его можно найти **в ресурсе службы приложений** в области **Веб-задания**. Чтобы его удалить, найдите раздел **Расширения**.

![Отключение профилировщика для веб-заданий][disable-profiler-webjob]

Мы рекомендуем включить профилировщик для всех веб-приложений, чтобы обеспечить максимально быстрое обнаружение проблем производительности.

Если вы используете WebDeploy для развертывания изменений в веб-приложении, убедитесь, что папка **App_Data** не удалилась во время развертывания. В противном случае файлы с расширением профилировщика будут удалены при следующем развертывании веб-приложения в Azure.

### <a name="using-profiler-with-azure-vms-and-compute-resources-preview"></a>Использование профилировщика с виртуальными машинами и вычислительных ресурсами Azure (предварительная версия)

После [включения Application Insights для служб приложений Azure во время выполнения](app-insights-azure-web-apps.md#run-time-instrumentation-with-application-insights) профилировщик автоматически становится доступным. (Если вы уже включили Application Insights для ресурса, может потребоваться выполнить обновление до последней версии с помощью мастера **настройки**.)

Существует [предварительная версия профилировщика для вычислительных ресурсов Azure](https://go.microsoft.com/fwlink/?linkid=848155).


## <a name="limits"></a>Ограничения

Срок хранения данных по умолчанию — 5 дней. В день может быть принято до 10 ГБ.

За использование службы профилировщика плата не взимается. Веб-приложение должно быть размещено по крайней мере на уровне "Базовый" служб приложений.

## <a name="viewing-profiler-data"></a>Просмотр данных профилировщика

Откройте колонку "Производительность" и прокрутите вниз до списка операций.




![Столбец примеров в колонке "Производительность" Application Insights][performance-blade-examples]

Ниже приведены столбцы в таблице.

* **Число.** Количество запросов в диапазоне времени колонки.
* **Median** (Медиана). Стандартное время, требуемое приложению для ответа на запрос. Половина всех ответов была получена быстрее, чем сейчас.
* **95th percentile** (95-й процентиль). 95 % ответов были получены быстрее, чем сейчас. Если это число существенно отличается от медианы, возможно, в приложении периодически возникают неполадки. (Или это можно объяснить с помощью такой конструктивной функции, как кэширование.)
* **Примеры.** Значок указывает, что профилировщик получил трассировки стека для этой операции.

Щелкните значок "Примеры", чтобы открыть обозреватель трассировки. В обозревателе находится несколько примеров, записанных профилировщиком, которые классифицируются по времени ответа.

Выберите пример, чтобы отобразить классификацию на уровне кода по времени, затраченному на выполнение запроса.

![Обозреватель трассировки Application Insights][trace-explorer]

С помощью флажка **Show hot path** (Показывать критический путь) можно открыть основной листовой узел или хотя бы что-то с ним связанное. В большинстве случаев этот узел будет размещаться рядом с узким местом производительности.



* **Метка** — имя функции или события. В дереве отображается сочетание кода и возникающих событий (например, события SQL и HTTP). Основное событие предоставляет общую длительность запроса.
* **Прошло**: интервал времени между началом и завершением операции.
* **Когда** — отображает время запуска функции или события по отношению к другим функциям.

## <a name="how-to-read-performance-data"></a>Чтение данных о производительности

Профилировщик службы Майкрософт использует метод выборки и инструментирование для анализа производительности приложения.
Во время подробной сборки профилировщик службы каждую миллисекунду проводит выборку указателя инструкций для всех ЦП компьютера.
Каждый пример записывает полный стек вызовов выполняющегося потока, предоставляя подробные и полезные сведения о нем на высоком и низком уровне абстракции. Профилировщик службы также собирает сведения о других событиях, например о событиях переключения контекста, библиотеки параллельных задач (TPL) и пула потоков для отслеживания корреляции действий и причинно-следственных связей.

Стек вызовов, отображаемый в представлении временной шкалы, является результатом приведенной выше выборки и инструментирования. Так как каждый пример записывает полный стек вызовов потока, он содержит код из .NET Framework, а также из других указанных платформ.

### <a id="jitnewobj"></a>Выделение объектов (`clr!JIT\_New or clr!JIT\_Newarr1`)
`clr!JIT\_New and clr!JIT\_Newarr1` — это вспомогательные функции в .NET Framework, выделяющие память из управляемой кучи. `clr!JIT\_New` вызывается при выделении объекта. `clr!JIT\_Newarr1` вызывается при выделении массива объектов. Обычно эти две функции выполняются очень быстро за относительно небольшое время. Если функции `clr!JIT\_New` или `clr!JIT\_Newarr1` занимают довольно много времени во временной шкале, это указывает на то, что код, возможно, выделяет несколько объектов и потребляет значительный объем памяти.

### <a id="theprestub"></a>Код загрузки (`clr!ThePreStub`)
`clr!ThePreStub` — это вспомогательная функция в .NET Framework, подготавливающая код к первому выполнению. Как правило, она включает в себя JIT-компиляцию (но не ограничивается ей). Для каждого метода C# `clr!ThePreStub` должна вызываться только один раз в течение всего времени существования процесса.

Если `clr!ThePreStub` требуется много времени для запроса, это значит, что запрос впервые выполняет метод, на загрузку которого требуется значительное время работы среды выполнения .NET Framework. Вы можете использовать процесс прогрева, выполняющий эту часть кода до предоставления к нему доступа пользователям, или запустить NGen в сборках.

### <a id="lockcontention"></a>Конфликт блокировки (`clr!JITutil\_MonContention` или `clr!JITutil\_MonEnterWorker`)
`clr!JITutil\_MonContention` или `clr!JITutil\_MonEnterWorker` указывают текущий поток, ожидающий снятия блокировки. Обычно это отображается при выполнении команды lock языка C# путем вызова метода Monitor.Enter или метода с атрибутом MethodImplOptions.Synchronized. Конфликт блокировки обычно происходит при получении блокировки потоком A, а также при попытке получить ту же блокировку потоком Б до ее снятия потоком A.

### <a id="ngencold"></a>Код загрузки (`[COLD]`)
Если имя метода содержит `[COLD]`, например `mscorlib.ni![COLD]System.Reflection.CustomAttribute.IsDefined`, это значит, что в среде выполнения .NET Framework выполняется код, оптимизация которого впервые не осуществилась <a href="https://msdn.microsoft.com/library/e7k32f4k.aspx">с использованием профиля</a>. Для каждого метода он должен отображаться только один раз в течение всего времени существования процесса.

Если коду загрузки требуется значительное время на запрос, это значит, что запрос впервые выполняет неоптимизированную часть метода. Вы можете использовать процесс прогрева, который выполняет эту часть кода до предоставления к нему доступа пользователям.

### <a id="httpclientsend"></a>Отправка HTTP-запроса
Методы (например, `HttpClient.Send`) указывают код, ожидающий завершения HTTP-запроса.

### <a id="sqlcommand"></a>Операция с базой данных
Метод (например, SqlCommand.Execute) указывает код, ожидающий завершения операции с базой данных.

### <a id="await"></a>Ожидание (`AWAIT\_TIME`)
`AWAIT\_TIME` указывает код, ожидающий завершения другой задачи. Обычно это осуществляется с помощью команды await языка C#. Когда код выполняет эту команду, поток освобождает и возвращает элемент управления в пул потоков, а поток, блокирующийся при ожидании завершения await, отсутствует. Однако если рассуждать логически, поток, который "заблокировал" await, ожидает завершения операции. `AWAIT\_TIME` указывает время блокировки в ожидании завершения задачи.

### <a id="block"></a>Время блокировки
`BLOCKED_TIME` указывает, что код ожидает, пока другой ресурс станет доступным, например, ожидает объект синхронизации, ожидает, пока поток станет доступным, или ожидает завершения запроса.

### <a id="cpu"></a>Время ЦП
ЦП занят выполнением инструкций.

### <a id="disk"></a>Время работы диска
Приложение выполняет операции с диском.

### <a id="network"></a>Сетевое время
Приложение выполняет сетевые операции.

### <a id="when"></a>Столбец "Время"
Это визуальное представление того, как со временем изменяются выборки INCLUSIVE, собранные для узла. Общий диапазон запроса состоит из 32 временных периодов, в которых накапливаются включающие выборки для данного узла. Затем каждый период представляется в виде полосы, высота которой обозначает масштабированное значение. Для узлов, помеченных как `CPU_TIME` или `BLOCKED_TIME`, или когда существует очевидная связь с потреблением ресурсов (ЦП, диск, поток), в полосе представлено использование одного из этих ресурсов за определенный период времени. Для этих метрик можно получить показатель, превышающий 100 %, за счет потребления нескольких ресурсов. Например, если в среднем за определенный интервал времени используется два процессора, показатель достигнет 200 %.


## <a id="troubleshooting"></a>Устранение неполадок

### <a name="how-can-i-know-whether-application-insights-profiler-is-running"></a>Как узнать, работает ли профилировщик Application Insights?

Профилировщик запускается в качестве непрерывного веб-задания в веб-приложении. Вы можете открыть ресурс веб-приложения на сайте https://portal.azure.com и проверить состояние ApplicationInsightsProfiler в колонке веб-заданий. Если он не работает, щелкните **Журналы**, чтобы узнать об этом побольше.

### <a name="why-cant-i-find-any-stack-examples-even-though-the-profiler-is-running"></a>Почему не удается найти все примеры стека даже при работе профилировщика?

Вот несколько моментов, которые можно проверить.

1. Убедитесь, что вы используете план службы веб-приложений уровня "Базовый" и выше.
2. Проверьте, содержит ли веб-приложение пакет SDK Application Insights бета-версии 2.2 и более поздней.
3. Убедитесь, что веб-приложение содержит параметр APPINSIGHTS_INSTRUMENTATIONKEY с тем же ключом инструментирования, который использует пакет SDK Application Insights.
4. Проверьте, работает ли веб-приложение на платформе .Net Framework 4.6.
5. Если это приложение ASP.NET Core, также проверьте [необходимые зависимости](#aspnetcore).

После запуска профилировщика наблюдается короткий период прогрева, во время которого профилировщик активно собирает несколько трассировок производительности. Он выполняет это действие в течение двух минут каждый час.  

### <a name="i-was-using-azure-service-profiler-what-happened-to-it"></a>Я включил профилировщик службы Azure. Что с ним произошло?  

При включении профилировщика Application Insights агент профилировщика службы Azure отключается.

### <a id="double-counting"></a>Двойной подсчет в параллельных потоках

В некоторых случаях значение метрики общего времени в средстве просмотра стека больше, чем фактическая длительность запроса.

Это может произойти при наличии нескольких потоков, связанных с запросом и работающих в параллельном режиме. Поэтому общее время потока будет больше затраченного времени. Во многих случаях один поток может ожидать завершения другого. Средство просмотра пытается это обнаружить и исключить ненужное ожидание, но при этом вместо исключения возникает слишком много ошибок. Это могут быть критически важные сведения.  

Обнаружив параллельные потоки в трассировках, необходимо указать, какие потоки находятся в состоянии ожидания, чтобы можно было определить критический путь к запросу. В большинстве случаев поток, который быстро переходит в состояние ожидания, просто ожидает другие потоки. Сосредоточьтесь на других потоках и игнорируйте время ожидания потоков.

### <a id="issue-loading-trace-in-viewer"></a>Нет данных профилирования

1. Если данные, которые вы пытаетесь просмотреть, хранятся дольше нескольких недель, попробуйте ограничить фильтр времени и повторите попытку.

2. Проверьте, не заблокирован ли доступ к https://gateway.azureserviceprofiler.net для прокси-серверов или брандмауэра.

3. Убедитесь, что ключ инструментирования Application Insights, используемый в приложении, совпадает с ресурсом Application Insights с включенным профилированием. Обычно ключ находится в файле ApplicationInsights.config, но его также можно найти в файле web.config или app.config.

### <a name="error-report-in-the-profiling-viewer"></a>Отчет об ошибках в средстве просмотра профилирования

Отправьте запрос в службу поддержки с портала. Укажите идентификатор корреляции из сообщения об ошибке.

## <a name="manual-installation"></a>Ручная установка

При настройке профилировщика в параметры веб-приложения вносятся следующие обновления. Если требуется, их можно внести вручную, например, если приложение выполняется в среде службы приложений Azure (ASE):

1. В колонке управления веб-приложением выберите "Параметры".
2. Для платформы .NET Framework установите версию 4.6.
3. Установите для параметра "Всегда включено" значение "Включено".
4. Добавьте параметр приложения __APPINSIGHTS_INSTRUMENTATIONKEY__ и задайте для него значение с тем же ключом инструментирования, используемым пакетом SDK.
5. Откройте дополнительные инструменты.
6. Щелкните "Перейти", чтобы открыть веб-сайт Kudu.
7. На веб-сайте Kudu, выберите "Расширения сайта".
8. __Установите Application Insights__ из коллекции.
9. Перезапустите веб-приложение.

## <a id="aspnetcore"></a>Поддержка ASP.NET Core

Приложению ASP.NET Core необходимо установить пакет NuGet Microsoft.ApplicationInsights.AspNetCore версии 2.1.0-beta6 или более поздней версии для работы с профилировщиком. Начиная с 27.06.2017 более ранние версии больше не поддерживаются.

## <a name="next-steps"></a>Дальнейшие действия

* [Работа с Azure Application Insights в Visual Studio](https://docs.microsoft.com/azure/application-insights/app-insights-visual-studio)

[performance-blade]: ./media/app-insights-profiler/performance-blade.png
[performance-blade-examples]: ./media/app-insights-profiler/performance-blade-examples.png
[trace-explorer]: ./media/app-insights-profiler/trace-explorer.png
[trace-explorer-toolbar]: ./media/app-insights-profiler/trace-explorer-toolbar.png
[trace-explorer-hint-tip]: ./media/app-insights-profiler/trace-explorer-hint-tip.png
[trace-explorer-hot-path]: ./media/app-insights-profiler/trace-explorer-hot-path.png
[enable-profiler-banner]: ./media/app-insights-profiler/enable-profiler-banner.png
[disable-profiler-webjob]: ./media/app-insights-profiler/disable-profiler-webjob.png
[linked app services]: ./media/app-insights-profiler/linked-app-services.png

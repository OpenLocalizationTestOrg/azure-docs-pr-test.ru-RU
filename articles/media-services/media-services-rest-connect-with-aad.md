---
title: "Использование аутентификации Azure AD для доступа к API служб мультимедиа Azure с помощью REST | Документация Майкрософт"
description: "Узнайте, как обращаться к API служб мультимедиа Azure с помощью аутентификации Azure Active Directory, используя REST."
services: media-services
documentationcenter: 
author: willzhan
manager: cfowler
editor: 
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/17/2017
ms.author: willzhan;juliako
ms.openlocfilehash: 1c62857699fb29b3583363e1c6f2dc7874635f40
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="use-azure-ad-authentication-to-access-the-azure-media-services-api-with-rest"></a>Использование аутентификации Azure AD для доступа к API служб мультимедиа Azure с помощью REST

Команда разработчиков служб мультимедиа Azure реализовала поддержку аутентификации Azure Active Directory (Azure AD) для доступа к службам мультимедиа Azure. Она также анонсировала намерение объявить устаревшей аутентификацию на основе службы контроля доступа Azure, используемую для доступа к службам мультимедиа. Так как каждая подписка Azure и каждая учетная запись служб мультимедиа подключена к клиенту Azure AD, поддержка аутентификации Azure AD дает много преимуществ с точки зрения безопасности. Дополнительные сведения об этом изменении и миграции (если вы используете пакет SDK служб мультимедиа для .NET для своего приложения) можно получить в приведенных ниже записях блога и статьях.

- [Azure Media Services announces support for Azure AD and deprecation of Access Control authentication](https://azure.microsoft.com/blog/azure%20media%20service%20aad%20auth%20and%20acs%20deprecation) (Команда разработчиков служб мультимедиа Azure анонсирует поддержку аутентификации AAD и объявление устаревшей аутентификацию ACS)
- [Access Azure Media Services API by using Azure AD authentication](media-services-use-aad-auth-to-access-ams-api.md) (Доступ к API служб мультимедиа Azure с помощью аутентификации Azure AD)
- [Use Azure AD authentication to access Azure Media Services API by using Microsoft .NET](media-services-dotnet-get-started-with-aad.md) (Использование аутентификации Azure AD для доступа к API служб мультимедиа Azure с помощью Microsoft .NET)
- [Приступая к работе с аутентификацией Azure AD с помощью портала Azure](media-services-portal-get-started-with-aad.md)

Некоторым клиентам приходится разрабатывать свои решения служб мультимедиа с учетом следующих ограничений:

*   Они используют язык программирования, отличный от Microsoft .NET или C#, или среду выполнения, отличную от Windows.
*   Библиотеки Azure AD, такие как библиотеки аутентификации Active Directory, недоступны для их языка программирования или не могут использоваться в среде выполнения.

Некоторые клиенты разработали приложения с помощью REST API для аутентификации ACS и доступа к службам мультимедиа Azure. Таким клиентам необходим способ использования REST API для аутентификации Azure AD и последующего доступа к службам мультимедиа Azure. Не нужно полагаться на какую-либо из библиотек Azure AD или пакет SDK служб мультимедиа для .NET. В этой статье описывается решение и рассматриваются примеры кода для такого сценария. Так как весь код построен на вызовах REST API и не зависит от библиотек Azure AD или служб мультимедиа Azure, его можно легко преобразовать в код на любом другом языке программирования.

> [!IMPORTANT]
> Службы мультимедиа в настоящее время поддерживают модель аутентификации с помощью службы контроля доступа Azure. Тем не менее авторизация посредством службы контроля доступа будет объявлена устаревшей 1 июня 2018 года. Мы рекомендуем как можно быстрее перейти на использование модели аутентификации Azure AD.


## <a name="design"></a>Проектирование

В этой статье мы используем следующую структуру аутентификации и авторизации.

*  Протокол авторизации: OAuth 2.0. OAuth 2.0 — это стандарт безопасности Интернета, включающий в себя аутентификацию и авторизацию. Он поддерживается Google, корпорацией Майкрософт, Facebook и PayPal. Он был ратифицирован в октябре 2012 года. Корпорация Майкрософт твердо поддерживает OAuth 2.0 и OpenID Connect. Оба эти стандарта поддерживаются во множестве служб и клиентских библиотек, включая Azure Active Directory, Open Web Interface for .NET (OWIN) Katana и библиотеки Azure AD.
*  Тип предоставления разрешения: предоставление учетных данных клиента. Учетные данные клиента — один из четырех типов предоставления разрешения в OAuth 2.0. Они часто используются для доступа к API Microsoft Graph для Azure AD.
*  Режим аутентификации: субъект-служба. К другим режимам относятся аутентификация пользователя и интерактивная аутентификация.

В последовательности аутентификации и авторизации Azure AD для использования служб мультимедиа участвуют четыре приложения или службы. Эти приложения и службы, а также сама последовательность описаны в следующей таблице.

|Тип приложения |Приложение |Поток|
|---|---|---|
|Клиент | Приложение или решение клиента | Это приложение (на самом деле это прокси-сервер), зарегистрированное в клиенте Azure AD, в котором размещены подписка Azure и учетная запись служб мультимедиа. Субъекту-службе зарегистрированного приложения предоставляется роль владельца или участника в службе контроля доступа (IAM) для учетной записи служб мультимедиа. Имя субъекта-службы представляется посредством идентификатора клиента и секрет клиента приложения. |
|Поставщик удостоверений (IdP) | Azure AD в качестве поставщика удостоверений | При аутентификации субъекта-службы зарегистрированного приложения (посредством идентификатора клиента и секрета клиента) Azure AD выступает в роли поставщика удостоверений. Это внутренняя аутентификация, которая выполняется неявно. Как и в последовательности предоставления учетных данных клиента, аутентификацию проходит клиент, а не пользователь. |
|Служба токенов безопасности (STS) или сервер OAuth | Azure AD в качестве службы токенов безопасности | После выполнения аутентификации поставщиком удостоверений (или сервером OAuth в терминологии OAuth 2.0) служба Azure AD, выступая в роли службы токенов безопасности (STS) или сервера OAuth, выпускает маркер доступа или JSON Web Token (JWT) для доступа к ресурсу среднего уровня. В нашем случае это конечная точка REST API служб мультимедиа. |
|Ресурс | REST API для службы мультимедиа | Каждый вызов REST API служб мультимедиа авторизуется посредством маркера доступа, выданного Azure AD в роли службы токенов безопасности или сервера OAuth. |

Если запустить пример кода и записать JWT или маркер доступа, то он будет иметь приведенные ниже атрибуты.

    aud: "https://rest.media.azure.net",

    iss: "https://sts.windows.net/72f988bf-86f1-41af-91ab-2d7cd011db47/",

    iat: 1497146280,

    nbf: 1497146280,
    exp: 1497150180,

    aio: "Y2ZgYDjuy7SptPzO/muf+uRu1B+ZDQA=",

    appid: "02ed1e8e-af8b-477e-af3d-7e7219a99ac6",

    appidacr: "1",

    idp: "https://sts.windows.net/72f988bf-86f1-41af-91ab-2d7cd011db47/",

    oid: "a938cfcc-d3de-479c-b0dd-d4ffe6f50f7c",

    sub: "a938cfcc-d3de-479c-b0dd-d4ffe6f50f7c",

    tid: "72f988bf-86f1-41af-91ab-2d7cd011db47",

Ниже приведено сопоставление между атрибутами в JWT и четырьмя приложениями или службами из предыдущей таблицы.

|Тип приложения |Приложение |Атрибут JWT |
|---|---|---|
|Клиент |Приложение или решение клиента |appid: "02ed1e8e-af8b-477e-af3d-7e7219a99ac6". Идентификатор клиента приложения, которое вы зарегистрируете в Azure AD в следующем разделе. |
|Поставщик удостоверений (IdP) | Azure AD в качестве поставщика удостоверений |idp: "https://sts.windows.net/72f988bf-86f1-41af-91ab-2d7cd011db47/".  GUID — это идентификатор клиента Майкрософт (microsoft.onmicrosoft.com). У каждого клиента есть уникальный идентификатор. |
|Служба токенов безопасности (STS) или сервер OAuth |Azure AD в качестве службы токенов безопасности | iss: "https://sts.windows.net/72f988bf-86f1-41af-91ab-2d7cd011db47/". GUID — это идентификатор клиента Майкрософт (microsoft.onmicrosoft.com). |
|Ресурс | REST API для службы мультимедиа |aud: "https://rest.media.azure.net". Получатель или аудитория маркера доступа. |

## <a name="steps-for-setup"></a>Настройка

Чтобы зарегистрировать и настроить приложение Azure AD для аутентификации Azure AD и получить маркер доступа для вызова конечной точки REST API служб мультимедиа Azure, выполните следующее.

1.  На [классическом портале Azure](http://go.microsoft.com/fwlink/?LinkID=213885) зарегистрируйте приложение Azure AD (например, wzmediaservice) в клиенте Azure AD (например, microsoft.onmicrosoft.com). Не важно, регистрируете вы собственное приложение или веб-приложение. Кроме того, вы можете выбрать любой URL-адрес входа и URL-адрес ответа (например, http://wzmediaservice.com для обоих параметров).
2. На [классическом портале Azure](http://go.microsoft.com/fwlink/?LinkID=213885) откройте вкладку **Конфигурация** приложения. Запишите **идентификатор клиента**. После этого в разделе **Ключи** создайте **ключ клиента** (секрет клиента). 

    > [!NOTE] 
    > Запишите секрет клиента. Он больше не будет отображаться.
    
3.  На [портале Azure](http://ms.portal.azure.com) перейдите к учетной записи служб мультимедиа. Выберите область **Управление доступом (IAM)**. Добавьте новый элемент с ролью владельца или участника. Найдите для субъекта имя приложения, зарегистрированного на шаге 1 (в данном примере — wzmediaservice).

## <a name="info-to-collect"></a>Собираемые сведения

Чтобы подготовить программирование REST, соберите данные приведенных точек данных для добавления в код.

*   Конечная точка Azure AD в роли службы токенов безопасности: https://login.microsoftonline.com/microsoft.onmicrosoft.com/oauth2/token. У этой конечной точки запрашивается маркер доступа JWT. Помимо роли поставщика удостоверений служба Azure AD выступает также в роли службы токенов безопасности. Azure AD выдает маркер JWT для доступа к ресурсам (маркер доступа). Маркер JWT содержит различные утверждения.
*   REST API служб мультимедиа Azure как ресурс или аудитория: https://rest.media.azure.net.
*   Идентификатор клиента: см. шаг 2 в [инструкциях по настройке](#steps-for-setup).
*   Секрет клиента: см. шаг 2 в [инструкциях по настройке](#steps-for-setup).
*   Ваша конечная точка API учетной записи служб мультимедиа в следующем формате:

    https://[учетная_запись_служб_мультимедиа].restv2.[центр_обработки_данных].media.azure.net/API 

    Это конечная точка, к которой отправляются все вызовы REST API служб мультимедиа в вашем приложении. Например, https://willzhanmswjapan.restv2.japanwest.media.azure.net/API.

Затем можно будет поместить эти пять параметров в файл web.config или app.config, чтобы использовать в коде.

## <a name="sample-code"></a>Пример кода

Пример кода доступен в разделе [Azure AD Authentication for Azure Media Services Access: Both via REST API](https://github.com/willzhan/WAMSRESTSoln) (Аутентификация Azure AD для доступа к службам мультимедиа Azure с помощью REST API).

Пример кода состоит из двух частей:

*   Проект библиотеки DLL, который содержит весь код REST API для аутентификации и авторизации Azure AD. Он также содержит метод для выполнения вызовов REST API к конечной точке REST API служб мультимедиа с маркером доступа.
*   Тестовый консольный клиент, который инициирует аутентификацию Azure AD и вызывает другой REST API служб мультимедиа.

Пример проекта содержит три компонента:

*   компонент аутентификации Azure AD посредством предоставления учетных данных клиента только с помощью REST API;
*   компонент доступа к службам мультимедиа Azure с помощью REST API;
*   компонент доступа к службе хранилища Azure только с помощью REST API (как и при создании учетной записи служб мультимедиа с помощью REST API).


## <a name="where-is-the-refresh-token"></a>Где же маркер обновления?

Некоторые читатели могут задаться вопросом: где же маркер обновления? Почему здесь не используется маркер обновления?

Маркер обновления предназначен не для обновления маркера доступа. Он позволяет обойти аутентификацию пользователя или взаимодействие с ним и все равно получить действительный маркер доступа, когда срок предыдущего маркера истечет. Более понятным названием маркера обновления может быть что-то вроде "маркер обхода повторного входа пользователя".

При использовании последовательности предоставления авторизации OAuth 2.0 (имя пользователя и пароль, предоставляемые от имени пользователя) маркер обновления помогает продлить срок действия маркера доступа без необходимости вмешательства пользователя. Тем не менее в последовательности предоставления учетных данных клиента OAuth 2.0, который рассматривается в этой статье, клиент действует от собственного имени. Никакое вмешательство пользователя не требуется, и серверу авторизации не требуется (и он не будет) выдавать вам маркер обновления. Если выполнить отладку метода **GetUrlEncodedJWT** то вы заметите, что ответ конечной точки выдачи маркеров содержит маркер доступа, но не маркер обновления.

## <a name="next-steps"></a>Дальнейшие действия

Приступите к [передаче файлов в учетную запись](media-services-dotnet-upload-files.md).

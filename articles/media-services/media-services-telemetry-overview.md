---
title: "Телеметрия служб мультимедиа Azure | Документация Майкрософт"
description: "В этой статье приводится обзор телеметрии служб мультимедиа Azure."
services: media-services
documentationcenter: 
author: Juliako
manager: cfowler
editor: 
ms.assetid: 95c20ec4-c782-4063-8042-b79f95741d28
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/29/2017
ms.author: juliako
ms.openlocfilehash: 1b26d7925fe5bd39905d9f51d22433b1eea43af6
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="azure-media-services-telemetry"></a>Телеметрия служб мультимедиа Azure

Службы мультимедиа Azure (AMS) позволяют получить доступ к данным телеметрии и метрик для служб. Текущая версия AMS позволяет собирать данные телеметрии для работающих сущностей **Channel**, **StreamingEndpoint** и **Archive**. 

Данные телеметрии записывается в таблицу хранилища в учетной записи хранения Azure (как правило, используется учетная запись хранения, связанная с вашей учетной записью AMS). 

Система телеметрии не управляет периодом хранения данных. Вы можете удалить устаревшие данные телеметрии, удалив таблицы хранилища.

В этом разделе описывается настройка и использование телеметрии AMS.

## <a name="configuring-telemetry"></a>Настройка телеметрии

Телеметрию можно настроить на уровне компонента. Существует два уровня детализации: "Обычный" и "Подробный". В настоящее время оба уровня возвращают одинаковую информацию. Мы рекомендуем использовать уровень "Обычный". 

В приведенных ниже разделах описывается включение телеметрии.

[Включение телеметрии с помощью .NET](media-services-dotnet-telemetry.md) 

[Включение телеметрии с помощью REST](media-services-rest-telemetry.md)

## <a name="consuming-telemetry-information"></a>Использование данных телеметрии

Данные телеметрии записываются в таблицу службы хранилища Azure в учетной записи хранения, указанной при настройке телеметрии для учетной записи служб мультимедиа. В этом разделе описываются таблицы хранилища, используемые для метрик.

Данные телеметрии можно использовать одним из следующих способов.

- Можно считывать данные непосредственно из хранилища таблиц Azure (например, с помощью пакета SDK для хранилища). Описание таблиц хранилища телеметрии см. в подразделе **Использование данных телеметрии** [этого](https://msdn.microsoft.com/library/mt742089.aspx) раздела.

Или

- Для чтения данных из хранилища можно использовать поддержку, реализованную в пакете SDK служб мультимедиа для .NET, как описано в [этом](media-services-dotnet-telemetry.md) разделе. 


Схема телеметрии, описанная ниже, предназначена обеспечить высокую производительность в рамках возможностей хранилища таблиц Azure.

- Данные секционируются по идентификатору учетной записи и идентификатору службы. Это позволяет независимо выполнять запросы данных телеметрии из каждой службы.
- Секции содержат дату, которая определяет разумный максимальный размер секции.
- Ключи строк хранятся в обратном хронологическом порядке, что позволяет запрашивать самые последние элементы телеметрии для заданной службы.

Это позволит эффективно выполнять многие распространенные запросы:

- Параллельное, независимое скачивание данных для разных служб.
- Получение всех данных для заданной службы в диапазоне дат.
- Получение последних данных для службы.

### <a name="telemetry-table-storage-output-schema"></a>Схема вывода данных телеметрии хранилища таблиц

Данные телеметрии хранятся в одной таблице, TelemetryMetrics20160321, где 20160321 — дата ее создания. Система телеметрии создает отдельную таблицу для данных по каждому новому дню в 00:00 (UTC). Таблица используется для хранения повторяющихся значений, например скорости приема в пределах заданного периода времени, количества отправленных байтов и т. д. 

Свойство|Значение|Примеры и примечания
---|---|---
PartitionKey|{ИД_учетной_записи}_{ИД_сущности}|e49bef329c29495f9b9570989682069d_64435281c50a4dd8ab7011cb0f4cdf66<br/<br/>Идентификатор учетной записи добавляется в ключ секции для упрощения рабочих процессов, в которых несколько учетных записей служб мультимедиа записывают данные в одну учетную запись хранения.
RowKey|{число секунд до полуночи}_{случайное значение}|01688_00199<br/><br/>Ключ строки начинается с числа секунд до полуночи, чтобы сделать возможным выполнение запросов получения N первых элементов в секции. Дополнительные сведения см. в [этой статье](../cosmos-db/table-storage-design-guide.md#log-tail-pattern). 
Timestamp|Дата и время|Создаваемая автоматически метка времени из таблицы Azure: 2016-Auto-09-09T22:43:42.241Z.
Тип|Тип сущности, предоставляющей данные телеметрии.|Channel, StreamingEndpoint, Archive.<br/><br/>Тип события — это просто строковое значение.
Имя|Имя события телеметрии.|ChannelHeartbeat, StreamingEndpointRequestLog.
ObservedTime|Время возникновения события телеметрии (UTC).|2016-09-09T22:42:36.924Z<br/><br/>Наблюдаемое время предоставляется сущностью, отправляющей данные телеметрии (например, сущностью Channel). Возможны проблемы синхронизации между компонентами, поэтому данное значение является приблизительным.
ServiceID|{ИД_службы}|f70bd731-691d-41c6-8f2d-671d0bdc9c7e
Свойства, относящиеся к сущности|Определяются событием.|StreamName: stream1, Bitrate 10123…<br/><br/>Остальные свойства определены для конкретного типа события. Таблица Azure содержит пары "ключ-значение".  (То есть различные строки в таблице имеют разные наборы свойств.)

### <a name="entity-specific-schema"></a>Схемы сущности

Существуют три типа записей данных телеметрии для сущности, которые передаются со следующей частотой:

- конечные точки потоковой передачи: каждые 30 секунд;
- динамические каналы: каждую минуту;
- динамический архив: каждую минуту.

**Конечная точка потоковой передачи**

Свойство|Значение|Примеры
---|---|---
PartitionKey|PartitionKey|e49bef329c29495f9b9570989682069d_64435281c50a4dd8ab7011cb0f4cdf66
RowKey|RowKey|01688_00199
Timestamp|Timestamp|Создаваемая автоматически метка времени из таблицы Azure: 2016-Auto-09-09T22:43:42.241Z.
Тип|Тип|StreamingEndpoint
Имя|Имя|StreamingEndpointRequestLog
ObservedTime|ObservedTime|2016-09-09T22:42:36.924Z
ServiceID|Идентификатор службы.|f70bd731-691d-41c6-8f2d-671d0bdc9c7e
HostName|Имя узла конечной точки.|builddemoserver.origin.mediaservices.windows.net
StatusCode|Состояние HTTP.|200
ResultCode|Сведения о коде результата.|S_OK
RequestCount|Общее число запросов в совокупности.|3
Передано байт|Совокупное число отправленных байтов.|2987358
ServerLatency|Средняя задержка сервера (включая хранилище).|129
E2ELatency|Средняя совокупная задержка.|250

**Динамический канал**

Свойство|Значение|Примеры и примечания
---|---|---
PartitionKey|PartitionKey|e49bef329c29495f9b9570989682069d_64435281c50a4dd8ab7011cb0f4cdf66
RowKey|RowKey|01688_00199
Timestamp|Timestamp|Создаваемая автоматически метка времени из таблицы Azure: 2016-Auto-09-09T22:43:42.241Z.
Тип|Тип|Канал
Имя|Имя|ChannelHeartbeat
ObservedTime|ObservedTime|2016-09-09T22:42:36.924Z
ServiceID|Идентификатор службы.|f70bd731-691d-41c6-8f2d-671d0bdc9c7e
TrackType|Тип дорожки: видео, звук или текст.|video/audio
TrackName|Имя дорожки.|video/audio_1
Bitrate|Скорость дорожки.|785000
CustomAttributes||   
IncomingBitrate|Фактическая входящая скорость.|784548
OverlapCount|Перекрытие при приеме.|0
DiscontinuityCount|Прерывание дорожки.|0
LastTimestamp|Метка времени последнего получения данных.|1800488800
NonincreasingCount|Число фрагментов, отклоненных из-за невозрастающей метки времени.|2
UnalignedKeyFrames|Получены ли фрагменты (для уровней качества), в которых ключевые кадры не выровнены. |Да
UnalignedPresentationTime|Получены ли фрагменты (для уровней качества или дорожек), в которых время презентации не согласовано.|Да
UnexpectedBitrate|Значение True, если расчетная или фактическая скорость для аудио- или видеодорожки превышает 40 000 бит/с и значение IncomingBitrate равно 0 ЛИБО значения IncomingBitrate и actualBitrate отличаются на 50 %. |Да
Healthy|Значение True, если значения <br/>overlapCount, <br/>DiscontinuityCount, <br/>NonIncreasingCount, <br/>UnalignedKeyFrames, <br/>UnalignedPresentationTime и <br/>UnexpectedBitrate<br/> равны 0.|Да<br/><br/>Healthy — это составная функция, которая возвращает значение false, если выполнено любое из следующих условий:<br/><br/>- OverlapCount > 0<br/>- DiscontinuityCount > 0<br/>- NonincreasingCount > 0<br/>- UnalignedKeyFrames = True<br/>- UnalignedPresentationTime = True<br/>- UnexpectedBitrate = True

**Динамический архив**

Свойство|Значение|Примеры и примечания
---|---|---
PartitionKey|PartitionKey|e49bef329c29495f9b9570989682069d_64435281c50a4dd8ab7011cb0f4cdf66
RowKey|RowKey|01688_00199
Timestamp|Timestamp|Создаваемая автоматически метка времени из таблицы Azure: 2016-Auto-09-09T22:43:42.241Z.
Тип|Тип|Архив
Имя|Имя|ArchiveHeartbeat
ObservedTime|ObservedTime|2016-09-09T22:42:36.924Z
ServiceID|Идентификатор службы.|f70bd731-691d-41c6-8f2d-671d0bdc9c7e
ManifestName|URL-адрес программы.|asset-eb149703-ed0a-483c-91c4-e4066e72cce3/a0a5cfbf-71ec-4bd2-8c01-a92a2b38c9ba.ism
TrackName|Имя дорожки.|audio_1
TrackType|Тип дорожки.|Audio/video
CustomAttribute|Шестнадцатеричная строка, позволяющая различать разные дорожки с одинаковым именем и скоростью (при многокамерной съемке).|
Bitrate|Скорость дорожки.|785000
Healthy|Значение True, если FragmentDiscardedCount = 0 и ArchiveAcquisitionError = False.|Значение True (эти два значения отсутствуют в метрике, но присутствуют в исходном событии).<br/><br/>Healthy — это составная функция, которая возвращает значение false, если выполнено любое из следующих условий:<br/><br/>- FragmentDiscardedCount > 0<br/>- ArchiveAcquisitionError = True

## <a name="general-qa"></a>Общие вопросы и ответы

### <a name="how-to-consume-metrics-data"></a>Как использовать данные метрик?

Данные метрик хранятся в виде ряда таблиц Azure в учетной записи хранения клиента. Эти данные могут использовать с помощью следующих инструментов:

- пакет SDK для AMS;
- Microsoft Azure Storage Explorer (поддерживает экспорт в файл данных с разделителями-запятыми и обработку в Excel).
- Интерфейс REST API

### <a name="how-to-find-average-bandwidth-consumption"></a>Как узнать среднее использование пропускной способности?

Среднее использование пропускной способности — это среднее значение BytesSent за период времени.

### <a name="how-to-define-streaming-unit-count"></a>Как определить количество единиц потоковой передачи?

Количество единиц потоковой передачи можно определить как пиковую пропускную способность трафика, передаваемого из конечных точек потоковой передачи службы, деленную на пиковую пропускную способность одной конечной точки потоковой передачи. Приемлемая пиковая пропускная способность одной конечной точки потоковой передачи составляет 160 Мбит/с.
Например предположим, что пиковая пропускная способность трафика из клиента службы равна 40 Мбит/с (максимальное значение BytesSent за период времени). Тогда число единиц потоковой передачи равно (40 Мбит/с) * (8 битов на байт) /(160 Мбит/с) = 2 единицы потоковой передачи.

### <a name="how-to-find-average-requestssecond"></a>Как найти среднее число запросов в секунду?

Чтобы найти среднее число запросов в секунду, следует вычислить среднее количество запросов (RequestCount) за период времени.

### <a name="how-to-define-channel-health"></a>Как определить работоспособность канала?

Работоспособность канала можно определить как составную логическую функцию, которая выдает значение false, если выполнено любое из следующих условий:

- OverlapCount > 0
- DiscontinuityCount > 0
- NonincreasingCount > 0
- UnalignedKeyFrames = True 
- UnalignedPresentationTime = True 
- UnexpectedBitrate = True


### <a name="how-to-detect-discontinuities"></a>Как выявлять прерывания?

Чтобы обнаружить прерывания, найдите все записи данных канала, в которых DiscontinuityCount > 0. Соответствующая метка времени ObservedTime указывает время, когда произошло прерывание.

### <a name="how-to-detect-timestamp-overlaps"></a>Как выявить перекрытия меток времени?

Чтобы выявить перекрытия меток времени, найдите все записи данных канала, в которых OverlapCount > 0. Соответствующая метка времени ObservedTime указывает время, когда произошло перекрытие метки времени.

### <a name="how-to-find-streaming-request-failures-and-reasons"></a>Как найти сведения о сбоях запросов потоковой передачи и их причинах?

Чтобы найти сведения о сбоях запросов потоковой передачи и их причинах, найдите все записи данных потоковой передачи конечной точки, в которых значение ResultCode не равно S_OK. Соответствующее поле StatusCode указывает причину сбоя запроса.

### <a name="how-to-consume-data-with-external-tools"></a>Как использовать данные с помощью внешних инструментов?

Данные телеметрии можно обработать и визуализировать с помощью следующих инструментов:

- PowerBI
- Application Insights
- Azure Monitor (прежнее название — Shoebox);
- динамическая панель мониторинга AMS;
- портал Azure (ожидается выпуск).

### <a name="how-to-manage-data-retention"></a>Как управлять хранением данных?

Система телеметрии не предоставляет инструментов управления хранением данных или автоматического удаления устаревших записей. Таким образом необходимо вручную управлять данными и удалять устаревшие записей из таблицы хранилища. Узнать о том, как это сделать, можно в документации по пакету SDK для хранилища.

## <a name="next-steps"></a>Дальнейшие действия

[!INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a>Отзывы

[!INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]

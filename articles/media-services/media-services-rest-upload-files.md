---
title: "Отправка файлов в учетную запись служб мультимедиа Azure с помощью REST | Документация Майкрософт"
description: "Узнайте, как включить мультимедийное содержимое в службы мультимедиа, создав и отправив ресурс."
services: media-services
documentationcenter: 
author: Juliako
manager: cfowler
editor: 
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/07/2017
ms.author: juliako
ms.openlocfilehash: 4ba6fdcec8d71326b02d71dbad429be8c2052171
ms.sourcegitcommit: 71fa59e97b01b65f25bcae318d834358fea5224a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/11/2018
---
# <a name="upload-files-into-a-media-services-account-using-rest"></a>Передача файлов в учетную запись служб мультимедиа с помощью REST
> [!div class="op_single_selector"]
> * [.NET](media-services-dotnet-upload-files.md)
> * [REST](media-services-rest-upload-files.md)
> * [Портал](media-services-portal-upload-files.md)
> 

В службах мультимедиа цифровые файлы отправляются в актив. Сущность [Asset](https://docs.microsoft.com/rest/api/media/operations/asset) может содержать видео, аудио, изображения, коллекции эскизов, текстовые дорожки и файлы скрытых субтитров (а также метаданные этих файлов).  После отправки этих файлов в ресурс содержимое сохраняется в безопасном расположении в облаке для дальнейшей обработки и потоковой передачи. 

Из этого руководства вы узнаете, как отправить файл и выполнить другие операции из следующего списка.

> [!div class="checklist"]
> * Настройка Postman для всех операций отправки файлов.
> * Подключение к службам мультимедиа 
> * Создание политики доступа с разрешением на запись.
> * Создание ресурса
> * Создание указателя SAS и URL-адреса отправки
> * Отправка файла в хранилище больших двоичных объектов с помощью URL-адреса отправки.
> * Создание в ресурсе метаданных для переданного файла мультимедиа.

## <a name="prerequisites"></a>Необходимые компоненты

- Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?ref=microsoft.com&utm_source=microsoft.com&utm_medium=docs&utm_campaign=visualstudio), прежде чем начинать работу.
- [Создание учетной записи служб мультимедиа Azure с помощью портала Azure](media-services-portal-create-account.md).
- Ознакомьтесь со статьей [Доступ к API служб мультимедиа Azure с помощью аутентификации Azure AD](media-services-use-aad-auth-to-access-ams-api.md).
- Настройте **Postman**, как описано в статье [Configure Postman for Media Services REST API calls](media-rest-apis-with-postman.md) (Настройка Postman для вызовов к API REST служб мультимедиа).

## <a name="considerations"></a>Рекомендации

При работе с REST API служб мультимедиа соблюдайте следующие рекомендации.
 
* При доступе к сущностям через REST API служб мультимедиа необходимо использовать в HTTP-запросах определенные поля и значения заголовков. Дополнительную информацию см. в статье [Обзор интерфейса REST API служб мультимедиа](media-services-rest-how-to-use.md). <br/>Коллекция Postman, используемая в этом руководстве, правильно устанавливает все необходимые заголовки.
* Службы мультимедиа используют значение свойства IAssetFile.Name при создании URL-адресов для потоковой передачи содержимого (например, http://{AMSAccount}.origin.mediaservices.windows.net/{GUID}/{IAssetFile.Name}/streamingParameters.) По этой причине кодирование с помощью знака процента не допускается. Значение свойства **Name** не может содержать такие [зарезервированные знаки, используемые для кодировки URL-адресов](http://en.wikipedia.org/wiki/Percent-encoding#Percent-encoding_reserved_characters): !*'();:@&=+$,/?%#[]". Кроме того, может использоваться только один знак "." для расширения имени файла.
* Длина имени не должна превышать 260 знаков.
* Существует ограничение на максимальный размер файла, который могут обработать службы мультимедиа. Подробные сведения об этих ограничениях см. [здесь](media-services-quotas-and-limitations.md).

## <a name="set-up-postman"></a>Настройка Postman

Инструкции по настройке Postman для этого руководства см. [здесь](media-rest-apis-with-postman.md).

## <a name="connect-to-media-services"></a>Подключение к службам мультимедиа

1. Добавьте в среду параметры подключения. 

    Некоторые переменные, которые являются частью [среды](postman-environment.md) **MediaServices**, необходимо установить вручную перед выполнением описанных в [коллекции](postman-collection.md) операций.

    Значения для первых пяти из этих переменных вы найдете в статье [Доступ к API служб мультимедиа Azure с помощью аутентификации Azure AD](media-services-use-aad-auth-to-access-ams-api.md). 

    ![Отправить файл.](./media/media-services-rest-upload-files/postman-import-env.png)
2. Укажите значение для переменной среды **MediaFileName**.

    Укажите имя файла мультимедиа, который вы собираетесь передать. В нашем примере это файл BigBuckBunny.mp4. 
3. Изучите файл **AzureMediaServices.postman_environment.json**. Здесь вы увидите, что почти все операции в коллекции выполняют скрипт test. Эти скрипты принимают некоторые значения, полученные в ответе, и устанавливают соответствующие переменные среды.

    Например, первая операция получает маркер доступа и сохраняет его значение в переменной среды **AccessToken**, которая используется в других операциях.

    ```    
    "listen": "test",
    "script": {
        "type": "text/javascript",
        "exec": [
            "var json = JSON.parse(responseBody);",
            "postman.setEnvironmentVariable(\"AccessToken\", json.access_token);"
        ]
    }
    ```
4. В левой части окна **Postman** щелкните **1. Get AAD Auth token** (Получить маркер безопасности AAD) -> **Get Azure AD Token for Service Principal** (Получить маркер безопасности Azure AD для субъекта-службы).

    Часть URL-адреса заполняется значением из переменной среды **AzureADSTSEndpoint** (которое мы установили ранее в этом учебнике).
    
5. Нажмите кнопку **Отправить**.

    ![Отправить файл.](./media/media-services-rest-upload-files/postment-get-token.png)

    Как видите, ответ содержит параметр "access_token". Скрипт test принимает это значение и присваивает его переменной среды **AccessToken** (как описано выше). Изучив значения переменных среды, вы заметите, что теперь в этой переменной сохранен маркер безопасности (маркер носителя), который будет применяться в остальных операциях. 

    Когда истечет срок действия маркера, повторно выполните действие "Получить маркер безопасности Azure AD для субъекта-службы". 

## <a name="create-an-access-policy-with-write-permission"></a>Создание политики доступа с разрешением на запись

### <a name="overview"></a>Обзор 

>[!NOTE]
>Действует ограничение в 1 000 000 записей для разных политик AMS (например, для политики Locator или ContentKeyAuthorizationPolicy). Следует указывать один и тот же идентификатор политики, если вы используете те же дни, разрешения доступа и т. д. Например, политики для указателей, которые должны оставаться на месте в течение длительного времени (не политики передачи). Дополнительные сведения см. в [этой статье](media-services-dotnet-manage-entities.md#limit-access-policies).

Перед отправкой файлов в хранилище больших двоичных объектов настройте для политики доступа права на запись в ресурс. Для этого отправьте запрос HTTP POST в набор сущностей AccessPolicy. При создании сущности необходимо задать значение DurationInMinutes. В противном случае вы получите сообщение 500 (внутренняя ошибка сервера). Дополнительную информацию о сущностях AccessPolicy см. в разделе [AccessPolicy](https://docs.microsoft.com/rest/api/media/operations/accesspolicy).

### <a name="create-an-access-policy"></a>Создание политики доступа

1. Выберите **AccessPolicy** -> **Create AccessPolicy for Upload** (Создать AccessPolicy для отправки).
2. Нажмите кнопку **Отправить**.

    ![Отправить файл.](./media/media-services-rest-upload-files/postman-access-policy.png)

    Скрипт test получает идентификатор AccessPolicy и сохраняет его в соответствующей переменной среды.

## <a name="create-an-asset"></a>Создание ресурса

### <a name="overview"></a>Обзор

[Ресурс](https://docs.microsoft.com/rest/api/media/operations/asset) — это контейнер, содержащий объекты служб мультимедиа разного типа, в том числе видео, аудио, изображения, коллекции эскизов, текстовые каналы и файлы скрытых субтитров. Для создания ресурса в REST API нужно отправить запрос POST службам мультимедиа и разместить любую информацию о свойствах ресурса в тексте запроса.

При создании ресурса можно добавить некоторые свойства, в том числе **Options**. Вы можете указать один из следующих методов шифрования: **None** (без шифрования — используется по умолчанию), **StorageEncrypted** (для содержимого, которое зашифровано с помощью шифрования хранилища на стороне клиента), **CommonEncryptionProtected** или **EnvelopeEncryptionProtected**. Для каждого зашифрованного актива нужно настроить политику доставки. Дополнительные сведения см. в статье о [настройке политик доставки ресурсов](media-services-rest-configure-asset-delivery-policy.md).

Если для ресурса вы используете шифрование, следует создать сущность **ContentKey** и связать ее с ресурсом, как описано в статье [о создании ключей содержимого](media-services-rest-create-contentkey.md). Обратите внимание, что после передачи файлов в ресурс нужно обновить свойства шифрования для сущности **AssetFile**, используя значения, полученные во время шифрования ресурса **Asset**. Сделать это можно с помощью HTTP-запроса **MERGE** . 

В этом примере мы создаем незашифрованный ресурс. 

### <a name="create-an-asset"></a>Создание ресурса

1. Выберите **Ресурсы** -> **Создать ресурс**.
2. Нажмите кнопку **Отправить**.

    ![Отправить файл.](./media/media-services-rest-upload-files/postman-create-asset.png)

    Скрипт test получает идентификатор ресурса и сохраняет его в соответствующей переменной среды.

## <a name="create-a-sas-locator-and-create-the-upload-url"></a>Создание указателя SAS и URL-адреса отправки

### <a name="overview"></a>Обзор

Когда сущности AccessPolicy и Locator будут заданы, фактические файлы отправляются в контейнер хранилища больших двоичных объектов Azure с помощью интерфейсов REST API службы хранилища Azure. Файлы необходимо отправить в виде блочных BLOB-объектов. Страничные BLOB-объекты не поддерживаются службами мультимедиа Azure.  

Дополнительную информацию о работе с большими двоичными объектами службы хранилища Azure см. в статье [API-интерфейс REST службы BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/Blob-Service-REST-API).

Чтобы получить фактический URL-адрес отправки, создайте указатель SAS (представлен ниже). Указатели определяют время начала и тип конечной точки подключения для клиентов, которым требуется доступ к файлам в ресурсе. Для обработки разных запросов клиентов и удовлетворения их потребностей можно создать несколько сущностей Locator для заданной пары AccessPolicy и Asset. Каждый из этих указателей использует значения StartTime и DurationInMinutes сущности AccessPolicy, чтобы определить время, в течение которого можно использовать URL-адрес. Дополнительную информацию см. в разделе [Указатель](https://docs.microsoft.com/rest/api/media/operations/locator).

Ниже приведен формат URL-адреса SAS:

    {https://myaccount.blob.core.windows.net}/{asset name}/{video file name}?{SAS signature}

### <a name="considerations"></a>Рекомендации

Важные особенности

* С определенным ресурсом нельзя связать более пяти уникальных указателей одновременно. Дополнительную информацию см. в разделе "Указатель".
* Если вам необходимо незамедлительно передать файлы, следует задать для StartTime значение, на пять минут предшествующее текущему моменту времени. Это необходимо из-за возможного расхождения в показаниях часов на клиентском компьютере и в службах мультимедиа. Кроме того, значение StartTime должно быть задано в следующем формате даты и времени: ГГГГ-ММ-ДДТЧЧ:мм:ссZ (например, "2014-05-23T17:53:50Z").    
* Задержка между моментом создания сущности Locator и моментом, когда ее можно начинать использовать, может составлять 30-40 секунд.

### <a name="create-a-sas-locator"></a>Создание указателя SAS

1. Выберите **Указатель** -> **Создать указатель SAS**.
2. Нажмите кнопку **Отправить**.

    Скрипт test создает URL-адрес отправки, используя указанное вами имя файла мультимедиа и сведения о локаторе SAS, а затем сохраняет его в соответствующей переменной среды.

    ![Отправить файл.](./media/media-services-rest-upload-files/postman-create-sas-locator.png)

## <a name="upload-a-file-to-blob-storage-using-the-upload-url"></a>Отправка файла в хранилище больших двоичных объектов с помощью URL-адреса отправки.

### <a name="overview"></a>Обзор

Теперь у вас есть URL-адрес отправки и вы можете создать код, который напрямую вызывает API-интерфейсы больших двоичных объектов Azure и отправляет файл в контейнер SAS. Дополнительные сведения см. в следующих статьях:

- [Использование REST API службы хранилища Azure](https://docs.microsoft.com/azure/storage/common/storage-rest-api-auth?toc=%2fazure%2fstorage%2fblobs%2ftoc.json)
- [PUT Blob](https://docs.microsoft.com/rest/api/storageservices/put-blob)
- [Upload blobs to Blob storage](https://docs.microsoft.com/azure/storage/common/storage-use-azcopy#upload-blobs-to-blob-storage) (Отправка больших двоичных объектов в хранилище BLOB-объектов)

### <a name="upload-a-file-with-postman"></a>Отправка файла с помощью Postman

В этом примере мы применим Postman для отправки небольшого MP4-файла. К отправке двоичных файлов через Postman могут применяться ограничения на размер файла.

Запрос на отправку не входит в коллекцию **AzureMedia**. 

Создайте и настройте новый запрос.
1. Нажмите **+**, чтобы создать новую вкладку запроса.
2. Выберите операцию **PUT** и скопируйте в URL-адрес значение **{{UploadURL}}**.
2. Оставьте вкладку **Авторизация** без изменений (не устанавливайте значение **маркера носителя**).
3. На вкладке **Заголовки** укажите следующие значения: **Key**: "x-ms-blob-type" и **Value**: "BlockBlob".
2. На вкладке **Текст** выберите вариант **двоичный**.
4. Выберите файл с именем, которое сохранено в переменной среды **MediaFileName**.
5. Нажмите кнопку **Отправить**.

    ![Отправить файл.](./media/media-services-rest-upload-files/postman-upload-file.png)

##  <a name="create-a-metadata-in-the-asset"></a>Создание метаданных в ресурсе

После отправки файла необходимо создать в ресурсе метаданные для файла мультимедиа, который вы передали в хранилище больших двоичных объектов, связанное с этим ресурсом.

1. Выберите **AssetFiles** -> **CreateFileInfos**.
2. Нажмите кнопку **Отправить**.

    ![Отправить файл.](./media/media-services-rest-upload-files/postman-create-file-info.png)

Это действие запускает отправку файла и создание метаданных.

## <a name="validate"></a>Проверка

Чтобы убедиться, что файл успешно отправлен, получите значение [AssetFile](https://docs.microsoft.com/rest/api/media/operations/assetfile) и сравните его параметры (например, **ContentFileSize**) с теми значениями, которые соответствуют свойствам нового ресурса. 

Например, следующая операция **GET** возвращает данные о файле ресурса (в нашем примере это файл BigBuckBunny.mp4). В запросе используются установленные ранее [переменные среды](postman-environment.md).

    {{RESTAPIEndpoint}}/Assets('{{LastAssetId}}')/Files

Ответ будет содержать размер, имя и другие сведения.

    "Id": "nb:cid:UUID:69e72ede-2886-4f2a-8d36-80a59da09913",
    "Name": "BigBuckBunny.mp4",
    "ContentFileSize": "3186542",
    "ParentAssetId": "nb:cid:UUID:0b8f3b04-72fb-4f38-8e7b-d7dd78888938",
            
## <a name="next-steps"></a>Дополнительная информация

Теперь можно закодировать отправленные ресурсы. Дополнительную информацию см. в статье, посвященной [кодированию ресурсов](media-services-portal-encode.md).

Можно также использовать функции Azure для запуска задания кодирования на основе файла, поступающего в настроенный контейнер. Дополнительные сведения см. в [этом примере](https://azure.microsoft.com/resources/samples/media-services-dotnet-functions-integration/ ).


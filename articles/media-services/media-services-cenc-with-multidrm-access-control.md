---
title: "CENC с несколькими DRM и контроль доступа: Справочник по проектированию и реализации на Azure и Azure Media Services | Документы Microsoft"
description: "Дополнительные сведения о лицензии Microsoft Smooth Streaming Client Porting Kit."
services: media-services
documentationcenter: 
author: willzhan
manager: cfowler
editor: 
ms.assetid: 7814739b-cea9-4b9b-8370-538702e5c615
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/19/2017
ms.author: willzhan;kilroyh;yanmf;juliako
ms.openlocfilehash: cac1513d805e01f2c9633b3b318ad6808027904e
ms.sourcegitcommit: 6f33adc568931edf91bfa96abbccf3719aa32041
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/22/2017
---
# <a name="cenc-with-multi-drm-and-access-control-a-reference-design-and-implementation-on-azure-and-azure-media-services"></a>CENC с несколькими DRM и контроль доступа: Справочник по проектированию и реализации на Azure и Azure Media Services
 
## <a name="introduction"></a>Общие сведения
Разработка и построение подсистемы управления Цифровыми правами цифровыми правами для over--top (OTT) или сети потоковой передачи решения является сложной задачей. Операторы и оперативного видео поставщики обычно передачи выполнения этой задачи специализированные поставщики служб управления правами. В этом документе предназначена для того, чтобы предоставить реализацию подсистемы DRM конца в конец OTT или интерактивной потоковой передачи решения и схема.

Целевые средства чтения для этого документа являются инженеров, работающих в подсистемах DRM OTT или online решений потоковой передачи или (несколько экранов) или средства чтения, заинтересованных в подсистемах DRM. Предполагается, что читатели знакомы с по крайней мере одной из технологий управления цифровыми правами на рынке, например, PlayReady, Widevine, FairPlay или Adobe Access.

В данном контексте DRM мы также включать общее шифрование (CENC) с несколькими DRM. Основные тенденции в интерактивной потоковой передачи и индустрии OTT заключается в использовании CENC с несколькими собственного DRM на различных платформах клиента. Эта тенденция тенденция от предыдущего, используется один DRM и клиентского пакета SDK для различных клиентских платформ. При использовании CENC с несколькими собственного DRM PlayReady и Widevine шифруются на [общее шифрование (CENC ISO/IEC 23001-7)](http://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm?csnumber=65271/) спецификации.

Преимущества CENC с несколькими DRM, что он:

* Снижает стоимость шифрования, так как процесс единого шифрования используется для различных платформ с его собственного DRMs.
* Уменьшает затраты на управление зашифрованные активы, поскольку требуется только одна копия зашифрованные активы.
* Исключает DRM клиент лицензирования затрат, поскольку собственный клиент DRM обычно свободного места на его собственной платформы.

Корпорация Майкрософт считает active активатором ШТРИХОВ и CENC, а также некоторые проигрыватели основных отраслевой. Службы мультимедиа Azure обеспечивает поддержку ТИРЕ и CENC. Для последних объявлений см. в следующих блогах:

*  [Анонс служб доставки лицензий Google Widevine в службах мультимедиа Azure](https://azure.microsoft.com/blog/announcing-general-availability-of-google-widevine-license-services/)
* [Службы мультимедиа Azure добавляет Google Widevine упаковку для доставки поток multi DRM](https://azure.microsoft.com/blog/azure-media-services-adds-google-widevine-packaging-for-delivering-multi-drm-stream/)  

### <a name="overview-of-this-article"></a>Описание раздела
Цели этой статьи:

* Справочник по конструировать подсистемы управления цифровыми правами, использует CENC с несколькими DRM.
* Предоставить реализацию ссылки на платформе Azure или Media Services.
* Обсудите некоторые вопросы проектирования и реализации.

В статье термин «multi-DRM» охватывает следующие продукты:

* Microsoft PlayReady
* Google Widevine
* Apple FairPlay 

В следующей таблице перечислены собственные платформы нативном приложении и браузеров, поддерживаемых каждой DRM.

| **Платформа клиента** | **Собственная поддержка управления цифровыми правами** | **Приложение веб-браузера** | **Форматы потоковой передачи** |
| --- | --- | --- | --- |
| **Смарт-ТВ, операторские STB, OTT STB** |В основном PlayReady и (или) Widevine и (или) другие |Linux, Opera, WebKit, другие |Различные форматы |
| **Устройства Windows 10 (Windows ПК, планшетах Windows, Windows Phone, Xbox)** |PlayReady |MS Edge/IE11/EME<br/><br/><br/>Универсальные приложения Windows |ТИРЕ (для HLS не поддерживается PlayReady)<br/><br/>DASH, Smooth Streaming (HLS, PlayReady не поддерживаемые) |
| **Устройства Android (телефон, планшет, ТВ)** |Widevine |Chrome или EME |DASH, HLS |
| **iOS (iPhone, iPad), клиенты OS X и Apple TV** |FairPlay |Safari 8+ или EME |HLS |


Учитывая текущее состояние развертывания для каждого DRM службы обычно желает реализовать два или три DRMs для убедитесь, что все типы конечных точек адрес в лучше всего.

Существует компромиссное решение, позволяющее справиться со сложностями логики службы и сложностями на стороне клиента по достижению определенного уровня работы пользователей на различных клиентах.

Чтобы сделать выбор, необходимо учитывать.

* PlayReady изначально имеет реализацию каждого устройства Windows, на некоторых устройствах и с помощью пакетов SDK программного обеспечения на практически на любой платформе.
* Widevine реализуется изначально в каждое устройство Android, Chrome и некоторые другие устройства.
* Технология FairPlay доступна только на клиентах iOS и Mac OS или через iTunes.

Существует два варианта Типичные multi-DRM.

* PlayReady и Widevine
* PlayReady, Widevine и FairPlay

## <a name="a-reference-design"></a>Справочное проектирование
В этом разделе описываются схема ссылку, которая не зависит от технологии, используемые для его реализации.

Подсистема DRM может содержать следующие компоненты:

* Управление ключами
* Упаковка DRM
* Доставка лицензий DRM
* Проверка прав
* Проверка подлинности и авторизация
* Проигрыватель
* Сеть доставки происхождения или содержимого (CDN)

На следующей схеме показана высокого уровня взаимодействия между компонентами в подсистеме управления цифровыми правами:

![Подсистема DRM с CENC](./media/media-services-cenc-with-multidrm-access-control/media-services-generic-drm-subsystem-with-cenc.png)

Структура имеет три основных слоя:

* Слой отдела (черный) не предоставляется извне.
* Слой сети Периметра (Темно-синий) содержит все конечные точки, с которыми сталкиваются открытый.
* Открытый Интернет слой (светло-синий) содержит CDN и проигрыватели трафик через общедоступный Интернет.

Должен существовать средство управления содержимым к элементу управления защиты DRM, даже если он является статическим или динамическим шифрования. Следующие входные данные для шифрования управления цифровыми правами.

* Основная загрузочная запись видео-контента
* Ключ содержимого
* URL-адреса приобретения лицензии

Ниже приведен высокоуровневый поток во время воспроизведения:

* Пользователь проходит проверку подлинности.
* Для пользователя создается маркер авторизации.
* Содержимое защищенного DRM (манифест) загружается проигрыватель.
* Проигрыватель отправляет запрос приобретения лицензий на серверы лицензирования вместе с ключ идентификатора и маркер авторизации.

В следующем разделе описываются структуры управления ключами.

| **ContentKey для ресурса** | **Сценарий** |
| --- | --- |
| 1-1 |Простейший случай. Он предоставляет самый лучший контроль. Однако такой подход обычно приводит к Максимальная стоимость доставки лицензий. По меньшей мере один запрос лицензии является обязательным для каждого защищенного ресурса. |
| 1-ко многим |Можно использовать тот же ключ содержимого для нескольких ресурсов. Например для всех ресурсов в логические группы, например жанра или подмножество жанра (или фильма Созд), можно использовать один ключ содержимого. |
| Многие к одному |Несколько ключей содержимого необходимы для каждого ресурса. <br/><br/>Например если необходимо применить динамическую защиту CENC с несколькими DRM для MPEG-DASH и динамического шифрования AES-128 для HLS, необходимо два отдельных ключей контента. Каждый ключ содержимого должен ContentKeyType свой собственный. (Для содержимого ключ, используемый для защиты динамические CENC, использование ContentKeyType.CommonEncryption. Для ключа контента, используемый для динамического шифрования AES-128 используйте ContentKeyType.EnvelopeEncryption.)<br/><br/>Еще один пример CENC защиту содержимого ТИРЕ, теоретически можно использовать один ключ содержимого для защиты поток видео и другого содержимого ключа для защиты звуковой поток. |
| Многие ко многим |Сочетание двух предыдущих скриптах. Для каждого из нескольких средств в той же группе активов используется один набор ключей контента. |

Другим важным вопросом является использование постоянных и несохраненные лицензий.

Почему эти вопросы важны?

При использовании общедоступного облака для доставки лицензий, постоянный и несохраненные лицензии имеют прямое влияние на стоимость доставки лицензий. Для иллюстрации используются для следующих двух случаях другую структуру.

* Ежемесячная подписка: использовать постоянные лицензии и 1-ко многим содержимого сопоставления ключа для актива. Например все детский фильмов, использовать один ключ содержимого для шифрования. В данном случае:

    Общее число лицензий, запрошенный для всех детей фильмов или устройству = 1

* Ежемесячная подписка: использовать несохраненные лицензию и сопоставление 1 к 1 ключа контента и активов. В данном случае:

    Общее число лицензий, запрошенный для всех детей фильмов или устройства = [число смотрели фильмы] x [число сеансов]

Двумя различными вариантами привести к совершенно разные лицензии шаблонов запроса. Различные шаблоны привести к разным лицензионным доставки затрат в общедоступном облаке, таких как службы мультимедиа Если службы доставки лицензий.

## <a name="map-design-to-technology-for-implementation"></a>Сопоставить разработки технологии для реализации
После этого универсального конструктора сопоставляется с технологий на платформе Azure или Media Services, указав какую технологию использовать для каждого стандартного блока.

В следующей таблице показаны сопоставления.

| **Стандартный блок** | **Технология** |
| --- | --- |
| **Проигрыватель** |[Проигрыватель мультимедиа Azure](https://azure.microsoft.com/services/media-services/media-player/) |
| **Поставщик удостоверений (IDP)** |Azure Active Directory (Azure AD) |
| **Служба маркеров безопасности (STS)** |Azure AD |
| **Рабочий процесс защиты DRM** |Динамическую защиту служб мультимедиа |
| **Доставка лицензий DRM** |* Доставки лицензий служб мультимедиа (PlayReady, Widevine, FairPlay) <br/>* Сервер лицензирования Axinom <br/>* Настраиваемые сервера лицензирования PlayReady |
| **Исходный домен** |Конечную точку потоковой передачи служб мультимедиа |
| **Управление ключами** |Не требуется для справочной реализации |
| **Управление содержимым** |Консольное приложение C# |

Другими словами Удостоверений и STS используются с Azure AD. [Azure Media Player API](http://amp.azure.net/libs/amp/latest/docs/) используется для проигрывателя. Службы мультимедиа и проигрыватель поддерживают ТИРЕ и CENC с несколькими DRM.

В примере ниже показан общую структуру и поток с предыдущей технологии сопоставления:

![CENC служб мультимедиа](./media/media-services-cenc-with-multidrm-access-control/media-services-cenc-subsystem-on-AMS-platform.png)

Настройка динамического шифрования CENC, средство управления содержимым использует следующие входные данные:

* Открытие содержимого
* Ключ содержимого из ключа создания и управления.
* URL-адреса приобретения лицензии
* Список сведений из Azure AD

Вот выходные данные средства управления содержимым.

* ContentKeyAuthorizationPolicy содержит спецификацию на способ доставки лицензий проверяет JSON Web Token (JWT) и спецификации лицензии DRM.
* AssetDeliveryPolicy содержит спецификации потоковую передачу формат защиты DRM и URL-адреса приобретения лицензий.

Ниже приведена последовательность действий во время выполнения:

* После проверки подлинности пользователя создается маркер JWT.
* Одно из утверждений, содержащихся в JWT является групп утверждение, содержащее EntitledUserGroup идентификатор объекта группы. Это утверждение используется для прошедших проверку прав.
* Проигрыватель загружает манифест клиента содержимого, защищенного с помощью CENC и определяет следующее:
   * Идентификатор ключа.
   * Содержимое является защищенных CENC.
   * URL-адреса для приобретения лицензии.
* Проигрыватель делает запрос приобретения лицензии, исходя из браузера или DRM поддерживаются. В лицензии приобретения запроса ключ, также отправленные идентификатор и JWT. Служба доставки лицензий проверяет JWT и утверждений, содержащихся, прежде чем она выдает лицензию, необходимые.

## <a name="implementation"></a>Реализация
### <a name="implementation-procedures"></a>Процедуры реализации
Реализация включает следующие шаги:

1. Подготовка средств тестирования. Кодирования или упаковки теста, видео, чтобы многоскоростной фрагментированным MP4 в службах мультимедиа. Это средство *не* защищенного DRM. Защиты DRM выполняется путем динамического защиту позже.

2. Создание ключа идентификатор и ключ содержимого (при необходимости из начальное значение ключа). В этом случае системой управления ключами не требуется, поскольку только один ключ для нескольких средств тестирования требуются идентификатор и ключ содержимого.

3. Используйте API служб мультимедиа для настройки службы доставки лицензий multi DRM для средств тестирования. При использовании серверов пользовательских лицензий вашей компании или организации поставщиков вместо службы лицензирования в службах мультимедиа, этот шаг можно пропустить. При настройке доставки лицензий, можно указать URL-адреса приобретения лицензий на шаге. Требуется указать некоторые подробные конфигурации, например ограничения политики авторизации и шаблонов лицензий ответа для разных служб лицензии DRM API служб мультимедиа. В настоящее время портал Azure не предоставляет необходимые пользовательского интерфейса для этой конфигурации. Уровень API сведения и пример кода см. в разделе [используйте PlayReady и/или Widevine динамического общее шифрование](media-services-protect-with-playready-widevine.md).

4. Используйте API служб мультимедиа для настройки политики доставки активов для средств тестирования. Уровень API сведения и пример кода см. в разделе [используйте PlayReady и/или Widevine динамического общее шифрование](media-services-protect-with-playready-widevine.md).

5. Создайте и настройте клиент Azure AD в Azure.

6. Создайте несколько учетных записей пользователей и групп в клиенте Azure AD. Создайте по крайней мере к группе «Право пользователя» и Добавление пользователя в эту группу. Пользователи в этой группе прошел проверку прав в приобретение лицензий. Пользователи не в этой группе не прошел проверку подлинности и не может получить лицензию. Членство в этой группе «Право пользователя» — это утверждение требуемые группы в JWT, выданного Azure AD. Это требование утверждения в шаге задаются при настройке служб доставки лицензий multi DRM.

7. Создание приложения ASP.NET MVC для размещения вашего видеопроигрыватель. Это приложение ASP.NET защищен с помощью проверки подлинности пользователей в клиенте Azure AD. Утверждения, соответствующие включаются в токены доступа, полученный после проверки подлинности пользователя. Корпорация Майкрософт рекомендует OpenID подключение API для выполнения этого шага. Установите следующие пакеты NuGet:

   * Install-Package Microsoft.Azure.ActiveDirectory.GraphClient
   * Install-Package Microsoft.Owin.Security.OpenIdConnect
   * Install-Package Microsoft.Owin.Security.Cookies
   * Install-Package Microsoft.Owin.Host.SystemWeb
   * Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory

8. Создание воспроизведения с помощью [Azure Media Player API](http://amp.azure.net/libs/amp/latest/docs/). Используйте [Azure Media Player ProtectionInfo API](http://amp.azure.net/libs/amp/latest/docs/) для указания технологии управления цифровыми правами на различных платформах DRM.

9. В следующей таблице показаны матрицы тестирования.

    | **DRM** | **"Обзор"** | **Результат для право пользователя** | **Результат для unentitled пользователя** |
    | --- | --- | --- | --- |
    | **PlayReady** |Microsoft Edge или Internet Explorer 11 в Windows 10 |Успешно |Fail; |
    | **Widevine** |Chrome на Windows 10 |Успешно |Fail; |
    | **FairPlay** |ПОДЛЕЖИТ УТОЧНЕНИЮ | | |

Сведения о том, как настроить Azure AD для приложения ASP.NET MVC проигрывателя. в разделе [интегрировать приложения на основе MVC OWIN служб мультимедиа Azure и Azure Active Directory и ограничить содержимого доставки ключей на основе утверждений JWT](http://gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/).

Дополнительные сведения см. в разделе [проверки подлинности маркера JWT в службы мультимедиа Azure и динамического шифрования](http://gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/).  

Сведения о Azure AD.

* Можно найти сведения о разработке в [руководство разработчика Azure Active Directory](../active-directory/active-directory-developers-guide.md).
* Можно найти сведения о них в [администрирования клиента каталога Azure AD](../active-directory/active-directory-administer.md).

### <a name="some-issues-in-implementation"></a>Некоторые проблемы при реализации
Используйте следующие сведения по устранению неполадок по вопросам реализации.

* Издатель, URL-адрес должен заканчиваться «/». Аудитория должен быть идентификатор клиента приложения проигрывателя. Кроме того, добавить «/» в конце URL-адрес издателя.

        <add key="ida:audience" value="[Application Client ID GUID]" />
        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/" />

    В [декодер JWT](http://jwt.calebb.net/), вы видите **aud** и **iss**, как показано в JWT:

    ![JWT](./media/media-services-cenc-with-multidrm-access-control/media-services-1st-gotcha.png)

* Добавить разрешения для приложения в Azure AD на **Настройка** приложения. Разрешений не требуется для каждого приложения, локальные и развернутой версии.

    ![Разрешения](./media/media-services-cenc-with-multidrm-access-control/media-services-perms-to-other-apps.png)

* Используйте правильный издателя при настройке защиты динамические CENC.

        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/"/>

    Не работает следующее:

        <add key="ida:issuer" value="https://willzhanad.onmicrosoft.com/" />

    Идентификатор GUID — идентификатора клиента Azure AD. Идентификатор GUID можно найти в **конечные точки** всплывающего меню на портале Azure.

* Предоставление привилегий утверждения членства в группе. Убедитесь, что ниже приведен в файле манифеста приложения Azure AD. 

    «groupMembershipClaims»: «Все» (значение по умолчанию имеет значение null)

* Задайте правильную TokenType при создании требования к ограничениям.

        objTokenRestrictionTemplate.TokenType = TokenType.JWT;

    Поскольку добавлена поддержка JWT (Azure AD) в дополнение к SWT (ACS), значение по умолчанию TokenType — TokenType.JWT. Если вы используете SWT и ACS, необходимо присвоить TokenType.SWT маркер.

## <a name="additional-topics-for-implementation"></a>Дополнительные статьи о реализации
В этом разделе рассматриваются некоторые дополнительные разделы для проектирования и реализации.

### <a name="http-or-https"></a>HTTP или HTTPS?
Приложение ASP.NET MVC проигрывателя должна поддерживать следующее:

* Проверка подлинности пользователя через Azure AD, которая находится под HTTPS.
* JWT обмена данными между клиентом и Azure AD, которая находится под HTTPS.
* Получение лицензии DRM клиентом, который должен находиться в HTTPS, если предоставляет доставки лицензий Media Services. Для доставки лицензий PlayReady набора продуктов не требует HTTPS. Если сервер лицензирования PlayReady находится за пределами служб мультимедиа, можно использовать HTTP или HTTPS.

Приложение проигрывателя ASP.NET использует протокол HTTPS рекомендуется, чтобы проигрыватель находится на странице в разделе HTTPS. Однако HTTP является предпочтительным для потоковой передачи, поэтому необходимо учитывать проблемы смешанное содержимое.

* Браузер не разрешает смешанное содержимое. Но разрешить подключаемые модули, как Silverlight и подключаемый модуль OSMF smooth и ТИРЕ. Смешанное содержимое существует угроза безопасности из-за угрозы возможность вставить вредоносные JavaScript, который может привести к риску данных клиента. Браузеры блокируют эта возможность по умолчанию. Единственный способ ее решения находится на стороне сервера (источник), позволяя всем доменам (независимо от того, протокол HTTPS или HTTP). Это, скорее всего, тоже не самая лучшая идея.
* Избегайте смешанное содержимое. Приложение проигрывателя и проигрыватель следует использовать HTTP или HTTPS. При воспроизведении смешанное содержимое, Технический silverlightSS необходимо снять предупреждение со смешанным содержимым. Технический flashSS обрабатывает смешанное содержимое без предупреждения со смешанным содержимым.
* Если вашей конечной точки потоковой передачи был создан до августа 2014 г., она не будет поддерживать HTTPS. В этом случае создать и использовать новую конечную точку потоковой передачи для HTTPS.

В реализации защищенное содержимое, приложения и потоковой передачи используются в разделе HTTPS. Для открытых содержимое проигрыватель не требует проверки подлинности или лицензии, чтобы можно было использовать HTTP или HTTPS.

### <a name="azure-active-directory-signing-key-rollover"></a>Смена ключей подписывания Azure Active Directory
Подписывание смены ключей — важно учитывать в реализации. Если пропустить его готовой системы со временем прекращает работать полностью, в течение 6 месяцев на самом.

Azure AD используются отраслевые стандарты для установления доверия между собой и приложений, использующих Azure AD. В частности, Azure AD использует ключ подписывания, состоящий из пары открытого и закрытого ключей. Когда Azure AD создает маркер безопасности, который содержит сведения о пользователе, он подписан с помощью Azure AD с закрытого ключа перед его отправкой в приложение. Чтобы убедиться, что маркер является недопустимым и было произведено из Azure AD, приложение должно проверить подписи токена. Приложение использует открытый ключ, предоставляемые Azure AD, который содержится в документе метаданных федерации клиента. Этот открытый ключ и ключ подписывания, из которого он является производным, совпадает с тем, используется для всех клиентов в Azure AD.

Дополнительные сведения о смене ключей Azure AD см. в разделе [важные сведения о смене ключей подписывания в Azure AD](../active-directory/active-directory-signing-key-rollover.md).

Между [пары открытого и закрытого ключей](https://login.microsoftonline.com/common/discovery/keys/):

* Закрытый ключ используется Azure AD для формирования JWT.
* Открытый ключ используется приложением, такие как службы доставки лицензий DRM в службах мультимедиа для проверки маркера JWT.

В целях безопасности Azure AD поворачивает сертификат периодически (каждые шесть недель). В случае нарушения безопасности смены ключей может возникать любое время. Таким образом служб доставки лицензий служб мультимедиа необходимо обновить открытый ключ, используемый как Azure AD поворачивает пару ключей. В противном случае произойдет сбой токена проверки подлинности в службах мультимедиа и лицензия не выдается.

Чтобы настроить эту службу, TokenRestrictionTemplate.OpenIdConnectDiscoveryDocument задается при настройке служб доставки лицензий DRM.

Ниже приведена последовательность JWT:

* Azure AD выдает JWT текущего закрытым ключом для прошедшего проверку подлинности.
* Когда проигрыватель видит CENC с содержимым multi защищенного DRM, сначала находит JWT, выданного Azure AD.
* Проигрыватель отправляет запрос приобретения лицензии с JWT служб доставки лицензий в службах мультимедиа.
* Службы доставки лицензий в службах мультимедиа использовать текущего или допустимый открытый ключ из Azure AD для проверки перед выдачей лицензий JWT.

Всегда проверяйте служб доставки лицензий DRM текущего или допустимый открытый ключ из Azure AD. Открытый ключ, предоставленный Azure AD является ключом, используемым для проверки JWT, выданного Azure AD.

Что делать, если изменения ключа происходит после Azure AD создает маркер JWT, но перед отправкой маркера JWT игроками DRM служб доставки лицензий в службах мультимедиа для проверки?

Так как ключ может быть выполнен в любой момент, более одного допустимого открытого ключа всегда доступен в документе метаданных федерации. Доставки лицензий Media Services можно использовать любой из ключей, указанных в документе. Поскольку один ключ может быть сменен раньше, другой может оказаться его заменой и так далее.

### <a name="where-is-the-access-token"></a>Где — это токен доступа?
Просмотрите как веб-приложение вызывает приложение API в разделе [удостоверение приложения с предоставления учетных данных клиента OAuth 2.0](../active-directory/develop/active-directory-authentication-scenarios.md#web-application-to-web-api), поток проверки подлинности выглядит следующим:

* Пользователь входит Azure AD в веб-приложения. Дополнительные сведения см. в разделе [веб-браузер на веб-приложение](../active-directory/develop/active-directory-authentication-scenarios.md#web-browser-to-web-application).
* Конечная точка авторизации Azure AD перенаправляет агента пользователя в клиентское приложение с кодом авторизации. Агент пользователя возвращает код авторизации URI перенаправления клиентского приложения.
* Чтобы веб-приложение могло выполнить проверку подлинности для веб-интерфейса API и получить нужный ресурс, это приложение должно получить маркер доступа. Он отправляет запрос в конечную точку токена Azure AD и предоставляет учетные данные, идентификатор клиента и URI идентификатора приложения веб-API. Представляет код авторизации, чтобы доказать, что пользователь свое согласие.
* Azure AD проверяет подлинность приложения и возвращает токен доступа JWT, который используется для вызова веб-API.
* По протоколу HTTPS веб-приложение использует возвращенный токен доступа JWT, чтобы добавить строку JWT с назначением «bearer» в заголовке «Authorization» запроса веб-API. Затем веб-API проверяет JWT. Если проверка прошла успешно, он возвращает нужный ресурс.

В этом потоке удостоверения приложения веб-API доверяет проверку подлинности пользователя, что веб-приложения. По этой причине данная схема называется доверенной (надежной) подсистемой. [Схема потока authorization](https://docs.microsoft.com/azure/active-directory/active-directory-protocols-oauth-code) описывается поток как-предоставления кода авторизации-works.

Приобретение лицензий с ограничением токенов следует той же доверенной подсистемы. Служба доставки лицензий в службах мультимедиа является «внутренний ресурс», требуется доступ к веб-приложения или веб-API ресурса. Так где же маркер доступа?

Маркер доступа, полученный из Azure AD. После успешной проверки подлинности пользователя возвращается код авторизации. Код авторизации затем используется, а также идентификатор клиента и ключ приложения, для обмена на токен доступа. Токен доступа используется для доступа к приложению «указатель», что указывает на или представляет службу доставки лицензий Media Services.

Для регистрации и настройки приложения указатель в Azure AD, выполните следующие действия:

1. В клиенте Azure AD:

   * Добавление приложения с URL-адрес входа https://[resource_name].azurewebsites.net/ (ресурс). 
   * Добавьте идентификатор приложения с URL-адрес https://[aad_tenant_name].onmicrosoft.com/[resource_name].

2. Добавьте новый раздел для ресурсов приложения.

3. Обновить файл манифеста приложения, чтобы свойство groupMembershipClaims имеет значение «groupMembershipClaims»: «Все».

4. В приложении Azure AD, указывающий на веб-приложения проигрывателя, в разделе **разрешения для других приложений**, добавление ресурсов приложения, добавленного на шаге 1. В разделе **делегировать разрешения**выберите **доступа [resource_name]**. Данный параметр предоставляет web app разрешение на создание маркеры доступа, доступ к приложению ресурса. При разработке в Visual Studio и веб-приложение Azure, сделайте это для локальных и развернутой версии веб-приложения.

JWT, выданного Azure AD является маркер доступа, используемый для доступа к ресурсу указателя.

### <a name="what-about-live-streaming"></a>Как насчет динамической потоковой передачи?
Предыдущего обсуждения основное внимание уделено активы по требованию. Как насчет динамической потоковой передачи?

Для защиты потоковой трансляции в службах мультимедиа, рассматривая актив, связанный с программой как VOD средство можно использовать точно того же проектирования и реализации.

В частности для динамической потоковой передачи в службах мультимедиа, необходимо создать канал, а затем создать программу в канал. Чтобы создать программу, необходимо создать актив, содержащий динамического архива для программы. Чтобы предоставить CENC с несколькими DRM защиты содержимого в реальном времени, примените же обработки и установки средства, как если бы он был активов VOD перед запуском программы.

### <a name="what-about-license-servers-outside-media-services"></a>Как насчет серверы лицензирования за пределами служб мультимедиа?
Часто пользователи затрачено на ферме серверов лицензирования в собственном центре обработки данных или один размещенных поставщиками служб управления правами. С защитой содержимого служб мультимедиа могут работать в гибридном режиме. Содержимое можно размещенных и защищенные в службах мультимедиа динамически во время доставки лицензии DRM серверами за пределами служб мультимедиа. В этом случае рассмотрите следующие изменения:

* STS должна выдавать маркеры, которые являются допустимыми и могут быть проверены на ферме серверов лицензирования. Например серверы лицензирования Widevine, предоставляемые Axinom требуют определенного JWT, содержащую сообщение правах. Таким образом необходимо иметь STS для выдачи таких JWT. Сведения о реализации этого типа см. в [центр документации Azure](https://azure.microsoft.com/documentation/) и в разделе [Axinom используется для доставки служб мультимедиа Azure лицензии Widevine](media-services-axinom-integration.md).
* Настройки службы доставки лицензий (ContentKeyAuthorizationPolicy) служб мультимедиа больше не требуется. Необходимо указать URL-адреса приобретения лицензии (для PlayReady, Widevine и FairPlay) при настройке AssetDeliveryPolicy Настройка CENC с несколькими DRM.

### <a name="what-if-i-want-to-use-a-custom-sts"></a>Что делать, если нужно использовать пользовательскую службу STS?
Клиент может выбрать для использования собственной STS для предоставления маркеров JWT. По следующим причинам:

* Поставщика Удостоверений, используемых клиентом не поддерживает службы маркеров безопасности. В этом случае вариантом может быть настраиваемой службы STS.
* Клиент может потребоваться более гибкие или более строгого управления для интеграции службы маркеров безопасности с клиента подписчиков, выставления счетов системы. Например оператор MVPD может предложить несколько пакетов OTT подписчика, например premium, basic и спорта. Оператор может потребоваться сопоставить утверждения в маркер с подписчика пакета, чтобы только содержимое в указанном пакете, становятся доступными. В этом случае пользовательская STS предоставляет необходимую гибкость и контроль.

При использовании собственной STS, необходимо внести два изменения:

* При настройке службы доставки лицензий для актива, необходимо указать ключ безопасности, используемый для проверки собственной STS, а не текущий ключ из Azure AD. (Дополнительные сведения см.). 
* При формировании маркер JTW вместо закрытого ключа текущей X509 указан ключ безопасности сертификата в Azure AD.

Существует два типа ключей безопасности:

* Симметричный ключ: тот же ключ используется для создания и проверки JWT.
* Асимметричный ключ: пару открытого и закрытого ключей в X509 используется сертификат с закрытым ключом для шифрования и создания JWT и с помощью открытого ключа для проверки токена.

> [!NOTE]
> При использовании .NET Framework и C# как платформу разработки, X509 сертификат, используемый для асимметричный ключ должен иметь длину ключа по крайней мере 2048. Это требование класса System.IdentityModel.Tokens.X509AsymmetricSecurityKey в .NET Framework. В противном случае возникает следующее исключение:

> IDX10630: System.IdentityModel.Tokens.X509AsymmetricSecurityKey не может быть менее 2048 бит.

## <a name="the-completed-system-and-test"></a>Завершенная система и тестирование
Этот раздел поможет выполнить следующие сценарии в системе завершенного начала до конца, чтобы мог иметь общее представление о поведение, прежде чем получить учетную запись входа:

* Если необходимые сценарии, не связанных между собой.

    * Видео активов размещаются в службах мультимедиа, которые либо незащищенными или защищенного DRM, но без проверки подлинности маркера (лицензию на выдачу кто запросил), можно проверить его без выполнения входа. Перейдите в HTTP, если видео потоковой передачи по протоколу HTTP.

* При необходимости сценарий интеграции конца в конец:

    * Для средств видео в динамических защиты DRM в службах мультимедиа с помощью маркера проверки подлинности и JWT, созданного Azure AD необходимо выполнить вход.

Проигрыватель веб-приложения и его входе в систему, в разделе [этот веб-сайт](https://openidconnectweb.azurewebsites.net/).

### <a name="user-sign-in"></a>Вход пользователя
Чтобы протестировать интегрированной системой управления цифровыми правами начала до конца, необходимо иметь учетную запись либо добавленный.

Какую учетную запись?

Хотя изначально служба Azure разрешала доступ только пользователям учетной записи Майкрософт, теперь разрешен доступ пользователям обеих систем. Все свойства Azure теперь доверия Azure AD для проверки подлинности и Azure AD проверяет подлинность пользователей организации. Отношения федерации была создана, где Azure AD доверяет система идентификаторов клиента учетной записи Майкрософт для проверки подлинности пользователей клиента. В результате Azure AD может проверить подлинность учетной записи гостя Microsoft Azure AD, а также как собственные учетные записи.

Поскольку Azure AD доверяет домену учетной записи Майкрософт, можно добавить все учетные записи из любого из следующих доменов в пользовательских Azure AD клиента и использовать учетную запись для входа:

| **Имя домена** | **Домен** |
| --- | --- |
| **Домен пользовательского клиента Azure AD** |somename.onmicrosoft.com |
| **Домен организации** |microsoft.com |
| **Домен учетной записи Майкрософт** |outlook.com, live.com, hotmail.com |

Вы можете обратиться в любой из авторов, создания или добавлена учетная запись.

Следующих снимках экрана показано различные страницы входа, используемые разными учетными записями домена.

**Учетная запись домена для клиента пользовательские Azure AD**: пользовательские страницы входа из пользовательских Azure AD для клиента домена.

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain1.png)

**Учетная запись домена Microsoft с помощью смарт-карт**:-странице входа настройки с помощью Microsoft корпоративных ИТ с двухфакторной проверки подлинности.

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain2.png)

**Учетная запись Майкрософт**: страница входа в учетную запись Майкрософт для потребителей.

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain3.png)

### <a name="use-encrypted-media-extensions-for-playready"></a>Используют расширения мультимедиа зашифрованных PlayReady
PlayReady является базовой DRM для EME современного браузера зашифрованные мультимедиа расширения (EME) для поддержки PlayReady, например Internet Explorer 11 в Windows 8.1 или более поздней версии и браузер Microsoft Edge в Windows 10.

![Используйте EME для PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready1.png)

Область темной player — поскольку защиты PlayReady предотвращает внесение снимок экрана защищенного видео.

На следующем рисунке показан проигрывателя подключаемых модулей и Essentials безопасности Microsoft (MSE) / EME поддерживает:

![Подключаемые модули проигрывателя для PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready2.png)

EME в Microsoft Edge и Internet Explorer 11 в Windows 10 позволяет [PlayReady SL3000](https://www.microsoft.com/playready/features/EnhancedContentProtection.aspx/) вызываемого на устройствах Windows 10, которые ее поддерживают. PlayReady SL3000 снимает блокировку потока содержимого улучшенные premium (4 КБ, HDR) и для новых содержимого модели доставки (для расширенного содержимого).

Чтобы сосредоточиться на устройствах Windows, PlayReady является единственным DRM в оборудовании, доступное на устройствах Windows (PlayReady SL3000). Службу потоковой передачи с помощью PlayReady через EME или через приложения универсальной платформы Windows и обеспечивает более высокое качество видео с помощью PlayReady SL3000, чем другой DRM. Как правило содержимое до 2 КБ проходит через Chrome или Firefox и содержимое вверх на 4 КБ не проходит через Microsoft Edge и Internet Explorer 11 или приложения универсальной платформы Windows на одном устройстве. Объем зависит от параметров службы и реализация.

#### <a name="use-eme-for-widevine"></a>Используйте EME для Widevine
В современных браузерах с поддержкой EME и Widevine, таких как Chrome 41+ в Windows 10, Windows 8.1, Mac OSX Yosemite и Chrome в Android 4.4.4, Google Widevine является DRM в основе EME.

![Используйте EME для Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine1.png)

Widevine не запрещает сделать снимок экрана защищенного видео.

![Подключаемые модули проигрывателя для Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine2.png)

### <a name="unentitled-users"></a>Unentitled пользователей
Если пользователь не является членом группы «Пользователи под названием», пользователь не прошел проверку прав. Служба лицензий multi DRM отказывается выполнить запрошенную лицензию, как показано. — Подробное описание «получить лицензию не удалось,» которой является, как было задумано.

![Unentitled пользователей](./media/media-services-cenc-with-multidrm-access-control/media-services-unentitledusers.png)

### <a name="run-a-custom-security-token-service"></a>Запустите пользовательской службы маркеров безопасности
При выполнении собственной STS JWT выдается службой пользовательских маркеров безопасности с помощью симметричный или асимметричный ключ.

На следующем рисунке показан сценарий, который использует симметричный ключ (с помощью Chrome):

![Пользовательские службы маркеров безопасности с помощью симметричного ключа](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts1.png)

На следующем рисунке показан сценарий, использующий асимметричный ключ через X509 сертификат (с помощью современного браузера Microsoft):

![Пользовательские службы маркеров безопасности с помощью асимметричного ключа](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts2.png)

В обоих случаях предыдущей проверки подлинности пользователя остается неизменным. Она происходит через Azure AD. Единственное отличие заключается в издания JWT с собственной STS вместо Azure AD. При настройке защиты динамические CENC ограничения службы доставки лицензий указывает тип JWT симметричный или асимметричный ключ.

## <a name="summary"></a>Сводка
В этом документе рассматривается CENC с несколькими собственного DRM и контроля доступа посредством проверки подлинности маркера, ее структуру и его реализации с помощью Azure Media Services и проигрыватель.

* Схема был предоставлен, содержащий все необходимые компоненты в подсистеме управления цифровыми правами/CENC.
* Эталонная реализация состоялась Azure Media Services и проигрыватель.
* Также были описаны некоторые разделы непосредственно участвующими в разработке и реализации.

## <a name="media-services-learning-paths"></a>Схемы обучения работе со службами мультимедиа
[!INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a>Отзывы
[!INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]
 

---
title: "CENC с несколькими DRM и контролем доступа: справочное проектирование и реализация в Azure и службах мультимедиа Azure | Документация Майкрософт"
description: "Дополнительные сведения о том, как toolicensing hello Microsoft® Smooth Streaming Client Porting Kit."
services: media-services
documentationcenter: 
author: willzhan
manager: cfowler
editor: 
ms.assetid: 7814739b-cea9-4b9b-8370-538702e5c615
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/19/2017
ms.author: willzhan;kilroyh;yanmf;juliako
ms.openlocfilehash: 033fb618650c4fbe9069d467159a8734da759bba
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="cenc-with-multi-drm-and-access-control-a-reference-design-and-implementation-on-azure-and-azure-media-services"></a><span data-ttu-id="14a4b-103">CENC с несколькими DRM и управление доступом: справочное проектирование и реализация в Azure и Azure Media Services</span><span class="sxs-lookup"><span data-stu-id="14a4b-103">CENC with Multi-DRM and Access Control: A Reference Design and Implementation on Azure and Azure Media Services</span></span>
 
## <a name="introduction"></a><span data-ttu-id="14a4b-104">Введение</span><span class="sxs-lookup"><span data-stu-id="14a4b-104">Introduction</span></span>
<span data-ttu-id="14a4b-105">Это хорошо известен, что он toodesign сложной задачей и построить подсистемы управления цифровыми правами для OTT или online решений потоковой передачи.</span><span class="sxs-lookup"><span data-stu-id="14a4b-105">It is well known that it is a complex task toodesign and build a DRM subsystem for an OTT or online streaming solution.</span></span> <span data-ttu-id="14a4b-106">И обычное практики для операторов и оперативного toooutsource видео поставщиков этой части toospecialized DRM поставщиков.</span><span class="sxs-lookup"><span data-stu-id="14a4b-106">And it is a common practice for operators/online video providers toooutsource this part toospecialized DRM service providers.</span></span> <span data-ttu-id="14a4b-107">Hello цель данного документа — toopresent конструктора ссылки и реализации подсистемы DRM конца в конец OTT или интерактивной потоковой передачи решения.</span><span class="sxs-lookup"><span data-stu-id="14a4b-107">hello goal of this document is toopresent a reference design and implementation of end-to-end DRM subsystem in OTT or online streaming solution.</span></span>

<span data-ttu-id="14a4b-108">целевые Hello чтения этого документа являются инженеров, работа в подсистеме управления цифровыми правами OTT или интерактивной потоковой передачи или несколькими-экрана решений, или любые средства чтения, заинтересованных в подсистеме управления цифровыми правами.</span><span class="sxs-lookup"><span data-stu-id="14a4b-108">hello targeted readers of this document are engineers working in DRM subsystem of OTT or online streaming/multi-screen solutions, or any readers interested in DRM subsystem.</span></span> <span data-ttu-id="14a4b-109">Hello предполагается, что читатели знакомы с по крайней мере один из технологии DRM hello на рынок hello, например PlayReady, Widevine, FairPlay или Adobe Access.</span><span class="sxs-lookup"><span data-stu-id="14a4b-109">hello assumption is that readers are familiar with at least one of hello DRM technologies on hello market, such as PlayReady, Widevine, FairPlay or Adobe Access.</span></span>

<span data-ttu-id="14a4b-110">Под DRM также понимается CENC (стандартное шифрование) с несколькими DRM.</span><span class="sxs-lookup"><span data-stu-id="14a4b-110">By DRM, we also include CENC (Common Encryption) with multi-DRM.</span></span> <span data-ttu-id="14a4b-111">Основные тенденции в интерактивной потоковой передачи и отраслевыми OTT имеет toouse CENC с несколькими-native-DRM на различных платформах клиента, переход от предыдущего тренда hello использования единого управления цифровыми правами и клиентского пакета SDK для различных клиентских платформ;</span><span class="sxs-lookup"><span data-stu-id="14a4b-111">A major trend in online streaming and OTT industry is toouse CENC with multi-native-DRM on various client platforms, which is a shift from hello previous trend of using a single DRM and its client SDK for various client platforms.</span></span> <span data-ttu-id="14a4b-112">При использовании CENC с несколькими native DRM, шифрование PlayReady и Widevine каждого hello [общее шифрование (CENC ISO/IEC 23001-7)](http://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm?csnumber=65271/) спецификации.</span><span class="sxs-lookup"><span data-stu-id="14a4b-112">When using CENC with multi-native-DRM, both PlayReady and Widevine are encrypted per hello [Common Encryption (ISO/IEC 23001-7 CENC)](http://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm?csnumber=65271/) specification.</span></span>

<span data-ttu-id="14a4b-113">Ниже приведены преимущества Hello CENC с несколькими DRM.</span><span class="sxs-lookup"><span data-stu-id="14a4b-113">hello benefits of CENC with multi-DRM are as follows:</span></span>

1. <span data-ttu-id="14a4b-114">Снижается стоимость шифрования, так как используется единая обработка шифрования для разных платформ с собственными DRM.</span><span class="sxs-lookup"><span data-stu-id="14a4b-114">Reduces encryption cost since a single encryption processing is used targeting different platforms with its native DRMs;</span></span>
2. <span data-ttu-id="14a4b-115">Уменьшает hello затраты на управление зашифрованные активы, поскольку требуется только одна копия зашифрованные активы;</span><span class="sxs-lookup"><span data-stu-id="14a4b-115">Reduces hello cost of managing encrypted assets since only a single copy of encrypted assets is needed;</span></span>
3. <span data-ttu-id="14a4b-116">Исключает DRM клиент лицензирования затрат, поскольку собственный клиент DRM hello обычно свободного места на его собственной платформы.</span><span class="sxs-lookup"><span data-stu-id="14a4b-116">Eliminates DRM client licensing cost since hello native DRM client is usually free on its native platform.</span></span>

<span data-ttu-id="14a4b-117">Майкрософт является активным распространителем DASH и CENC вместе с некоторыми крупнейшими компаниями отрасли.</span><span class="sxs-lookup"><span data-stu-id="14a4b-117">Microsoft has been an active promoter of DASH and CENC together with some major industry players.</span></span> <span data-ttu-id="14a4b-118">Службы мультимедиа Microsoft Azure предлагают поддержку DASH и CENC.</span><span class="sxs-lookup"><span data-stu-id="14a4b-118">Microsoft Azure Media Services has been providing support of DASH and CENC.</span></span> <span data-ttu-id="14a4b-119">Последние объявления см. в блогах Мингфея: [Представление служб доставки лицензий Google Widevine в службах мультимедиа Azure](https://azure.microsoft.com/blog/announcing-general-availability-of-google-widevine-license-services/) и [Службы мультимедиа Azure добавляют пакет Google Widevine для предоставления потока с несколькими DRM](https://azure.microsoft.com/blog/azure-media-services-adds-google-widevine-packaging-for-delivering-multi-drm-stream/).</span><span class="sxs-lookup"><span data-stu-id="14a4b-119">For recent announcements, please see Mingfei’s blogs: [Announcing Google Widevine license delivery services in Azure Media Services](https://azure.microsoft.com/blog/announcing-general-availability-of-google-widevine-license-services/), and [Azure Media Services adds Google Widevine packaging for delivering multi-DRM stream](https://azure.microsoft.com/blog/azure-media-services-adds-google-widevine-packaging-for-delivering-multi-drm-stream/).</span></span>  

### <a name="overview-of-this-article"></a><span data-ttu-id="14a4b-120">Описание раздела</span><span class="sxs-lookup"><span data-stu-id="14a4b-120">Overview of this article</span></span>
<span data-ttu-id="14a4b-121">Hello цель этой статьи включает следующие hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-121">hello goal of this article includes hello following:</span></span>

1. <span data-ttu-id="14a4b-122">Предоставляет справочное проектирование подсистемы DRM с помощью CENC с несколькими DRM.</span><span class="sxs-lookup"><span data-stu-id="14a4b-122">Provides a reference design of DRM subsystem using CENC with multi-DRM;</span></span>
2. <span data-ttu-id="14a4b-123">Предоставляет справочную реализацию на платформе Microsoft Azure или служб мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="14a4b-123">Provides a reference implementation on Microsoft Azure/Azure Media Services platform;</span></span>
3. <span data-ttu-id="14a4b-124">Рассматривает некоторые вопросы проектирования и реализации.</span><span class="sxs-lookup"><span data-stu-id="14a4b-124">Discusses some design and implementation topics.</span></span>

<span data-ttu-id="14a4b-125">В статье hello «multi-DRM» рассматриваются hello следующее:</span><span class="sxs-lookup"><span data-stu-id="14a4b-125">In hello article, “multi-DRM” covers hello following:</span></span>

1. <span data-ttu-id="14a4b-126">Microsoft PlayReady</span><span class="sxs-lookup"><span data-stu-id="14a4b-126">Microsoft PlayReady</span></span>
2. <span data-ttu-id="14a4b-127">Google Widevine</span><span class="sxs-lookup"><span data-stu-id="14a4b-127">Google Widevine</span></span>
3. <span data-ttu-id="14a4b-128">Apple FairPlay</span><span class="sxs-lookup"><span data-stu-id="14a4b-128">Apple FairPlay</span></span> 

<span data-ttu-id="14a4b-129">Hello следующей таблице перечислены собственного платформы/собственное приложение hello и браузеров, поддерживаемых каждой DRM.</span><span class="sxs-lookup"><span data-stu-id="14a4b-129">hello following table summarizes hello native platform/native app, and browsers supported by each DRM.</span></span>

| <span data-ttu-id="14a4b-130">**Платформа клиента**</span><span class="sxs-lookup"><span data-stu-id="14a4b-130">**Client Platform**</span></span> | <span data-ttu-id="14a4b-131">**Поддержка собственного DRM**</span><span class="sxs-lookup"><span data-stu-id="14a4b-131">**Native DRM Support**</span></span> | <span data-ttu-id="14a4b-132">**Браузер или приложение**</span><span class="sxs-lookup"><span data-stu-id="14a4b-132">**Browser/App**</span></span> | <span data-ttu-id="14a4b-133">**Форматы потоковой передачи**</span><span class="sxs-lookup"><span data-stu-id="14a4b-133">**Streaming Formats**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="14a4b-134">**Смарт-ТВ, операторские STB, OTT STB**</span><span class="sxs-lookup"><span data-stu-id="14a4b-134">**Smart TVs, operator STBs, OTT STBs**</span></span> |<span data-ttu-id="14a4b-135">В основном PlayReady и (или) Widevine и (или) другие</span><span class="sxs-lookup"><span data-stu-id="14a4b-135">PlayReady primarily, and/or Widevine, and/or other</span></span> |<span data-ttu-id="14a4b-136">Linux, Opera и WebKit, другие</span><span class="sxs-lookup"><span data-stu-id="14a4b-136">Linux, Opera, WebKit, Other</span></span> |<span data-ttu-id="14a4b-137">Различные форматы</span><span class="sxs-lookup"><span data-stu-id="14a4b-137">Various formats</span></span> |
| <span data-ttu-id="14a4b-138">**Устройства Windows 10 (ПК Windows, планшеты Windows, Windows Phone, Xbox)**</span><span class="sxs-lookup"><span data-stu-id="14a4b-138">**Windows 10 devices (Windows PC, Windows Tablets, Windows Phone, Xbox)**</span></span> |<span data-ttu-id="14a4b-139">PlayReady</span><span class="sxs-lookup"><span data-stu-id="14a4b-139">PlayReady</span></span> |<span data-ttu-id="14a4b-140">MS Edge/IE11/EME</span><span class="sxs-lookup"><span data-stu-id="14a4b-140">MS Edge/IE11/EME</span></span><br/><br/><br/><span data-ttu-id="14a4b-141">UWP</span><span class="sxs-lookup"><span data-stu-id="14a4b-141">UWP</span></span> |<span data-ttu-id="14a4b-142">DASH (PlayReady не поддерживается для HLS)</span><span class="sxs-lookup"><span data-stu-id="14a4b-142">DASH (For HLS, PlayReady is not supported)</span></span><br/><br/><span data-ttu-id="14a4b-143">DASH, Smooth Streaming (PlayReady не поддерживается для HLS)</span><span class="sxs-lookup"><span data-stu-id="14a4b-143">DASH, Smooth Streaming (For HLS, PlayReady is not supported)</span></span> |
| <span data-ttu-id="14a4b-144">**Устройства Android (телефоны, планшеты, телевизоры)**</span><span class="sxs-lookup"><span data-stu-id="14a4b-144">**Android devices (Phone, Tablet, TV)**</span></span> |<span data-ttu-id="14a4b-145">Widevine</span><span class="sxs-lookup"><span data-stu-id="14a4b-145">Widevine</span></span> |<span data-ttu-id="14a4b-146">Chrome или EME</span><span class="sxs-lookup"><span data-stu-id="14a4b-146">Chrome/EME</span></span> |<span data-ttu-id="14a4b-147">DASH, HLS</span><span class="sxs-lookup"><span data-stu-id="14a4b-147">DASH,HLS</span></span> |
| <span data-ttu-id="14a4b-148">**iOS (iPhone, iPad), клиенты OS X и Apple TV**</span><span class="sxs-lookup"><span data-stu-id="14a4b-148">**iOS (iPhone, iPad), OS X clients and Apple TV**</span></span> |<span data-ttu-id="14a4b-149">FairPlay</span><span class="sxs-lookup"><span data-stu-id="14a4b-149">FairPlay</span></span> |<span data-ttu-id="14a4b-150">Safari 8+ или EME</span><span class="sxs-lookup"><span data-stu-id="14a4b-150">Safari 8+/EME</span></span> |<span data-ttu-id="14a4b-151">HLS</span><span class="sxs-lookup"><span data-stu-id="14a4b-151">HLS</span></span> |


<span data-ttu-id="14a4b-152">Учитывая hello текущее состояние развертывания для каждого DRM, службы обычно требуется убедиться, что адреса всех типов конечных точек в наиболее hello hello toomake DRMs tooimplement 2 или 3 способом.</span><span class="sxs-lookup"><span data-stu-id="14a4b-152">Considering hello current state of deployment for each DRM, a service will typically want tooimplement 2 or 3 DRMs toomake sure you address all hello types of endpoints in hello best way.</span></span>

<span data-ttu-id="14a4b-153">Обеспечивает компромисс между hello сложности hello логики служб и сложности hello на приветствия клиента стороне tooreach уровня пользователя взаимодействие hello различных клиентов.</span><span class="sxs-lookup"><span data-stu-id="14a4b-153">There is a tradeoff between hello complexity of hello service logic and hello complexity on hello client side tooreach a certain level of user experience on hello various clients.</span></span>

<span data-ttu-id="14a4b-154">toomake сделанного выбора, имейте в виду следующие факты:</span><span class="sxs-lookup"><span data-stu-id="14a4b-154">toomake your selection, keep in mind these facts:</span></span>

* <span data-ttu-id="14a4b-155">Технология PlayReady изначально реализована на всех устройствах Windows, на некоторых устройствах Android и доступна в пакетах SDK программ практически на любой платформе.</span><span class="sxs-lookup"><span data-stu-id="14a4b-155">PlayReady is natively implemented in every Windows device, on some Android devices, and available through software SDKs on virtually any platform</span></span>
* <span data-ttu-id="14a4b-156">Widevine изначально реализована на каждом устройстве Android, Chrome и некоторых других устройствах.</span><span class="sxs-lookup"><span data-stu-id="14a4b-156">Widevine is natively implemented in every Android device, in Chrome, and in some other devices</span></span>
* <span data-ttu-id="14a4b-157">Технология FairPlay доступна только на клиентах iOS и Mac OS или через iTunes.</span><span class="sxs-lookup"><span data-stu-id="14a4b-157">FairPlay is available only on iOS and Mac OS clients or through iTunes.</span></span>

<span data-ttu-id="14a4b-158">Поэтому обычные несколько DRM будут выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="14a4b-158">So a typical multi-DRM would be:</span></span>

* <span data-ttu-id="14a4b-159">Вариант 1. PlayReady и Widevine</span><span class="sxs-lookup"><span data-stu-id="14a4b-159">Option 1: PlayReady and Widevine</span></span>
* <span data-ttu-id="14a4b-160">Вариант 2. PlayReady, Widevine и FairPlay</span><span class="sxs-lookup"><span data-stu-id="14a4b-160">Option 2: PlayReady, Widevine and FairPlay</span></span>

## <a name="a-reference-design"></a><span data-ttu-id="14a4b-161">Справочное проектирование</span><span class="sxs-lookup"><span data-stu-id="14a4b-161">A reference design</span></span>
<span data-ttu-id="14a4b-162">В этом разделе мы представим ссылки проект, который является tooimplement независимые tootechnologies использовать его.</span><span class="sxs-lookup"><span data-stu-id="14a4b-162">In this section, we will present a reference design which is agnostic tootechnologies used tooimplement it.</span></span>

<span data-ttu-id="14a4b-163">Подсистема DRM может содержать hello следующие компоненты:</span><span class="sxs-lookup"><span data-stu-id="14a4b-163">A DRM subsystem may contain hello following components:</span></span>

1. <span data-ttu-id="14a4b-164">Управление ключами</span><span class="sxs-lookup"><span data-stu-id="14a4b-164">Key management</span></span>
2. <span data-ttu-id="14a4b-165">Упаковка DRM</span><span class="sxs-lookup"><span data-stu-id="14a4b-165">DRM packaging</span></span>
3. <span data-ttu-id="14a4b-166">Доставка лицензий DRM</span><span class="sxs-lookup"><span data-stu-id="14a4b-166">DRM license delivery</span></span>
4. <span data-ttu-id="14a4b-167">Проверка прав</span><span class="sxs-lookup"><span data-stu-id="14a4b-167">Entitlement check</span></span>
5. <span data-ttu-id="14a4b-168">Проверка подлинности и авторизация</span><span class="sxs-lookup"><span data-stu-id="14a4b-168">Authentication/authorization</span></span>
6. <span data-ttu-id="14a4b-169">Проигрыватель</span><span class="sxs-lookup"><span data-stu-id="14a4b-169">Player</span></span>
7. <span data-ttu-id="14a4b-170">Происхождение и CDN</span><span class="sxs-lookup"><span data-stu-id="14a4b-170">Origin/CDN</span></span>

<span data-ttu-id="14a4b-171">Hello следующая диаграмма иллюстрирует hello высокий уровень взаимодействием между компонентами hello в подсистеме управления цифровыми правами.</span><span class="sxs-lookup"><span data-stu-id="14a4b-171">hello following diagram illustrates hello high level interaction among hello components in a DRM subsystem.</span></span>

![Подсистема DRM с CENC](./media/media-services-cenc-with-multidrm-access-control/media-services-generic-drm-subsystem-with-cenc.png)

<span data-ttu-id="14a4b-173">Существует три основных» уровня» hello разработки:</span><span class="sxs-lookup"><span data-stu-id="14a4b-173">There are three basic “layers” in hello design:</span></span>

1. <span data-ttu-id="14a4b-174">Уровень главного офиса (обозначен черным цветом), который не предоставляется внешним объектам.</span><span class="sxs-lookup"><span data-stu-id="14a4b-174">Back office layer (in black) which are not exposed externally;</span></span>
2. <span data-ttu-id="14a4b-175">Слой «DMZ» (синий), содержащий все конечные точки hello, расположенных лицевой стороной открытый;</span><span class="sxs-lookup"><span data-stu-id="14a4b-175">“DMZ” layer (blue) containing all hello endpoints facing public;</span></span>
3. <span data-ttu-id="14a4b-176">Уровень общедоступного Интернета (светло-синий), содержащий CDN и проигрыватели с трафиком через общедоступный Интернет.</span><span class="sxs-lookup"><span data-stu-id="14a4b-176">Public Internet layer (light blue) containing CDN and players with traffic across public Internet.</span></span>

<span data-ttu-id="14a4b-177">Должно быть средство управления содержимым для контроля защиты DRM независимо от используемого шифрования (статического или динамического).</span><span class="sxs-lookup"><span data-stu-id="14a4b-177">There should be a content management tool for controlling DRM protection, regardless it is static or dynamic encryption.</span></span> <span data-ttu-id="14a4b-178">Hello входных данных для управления цифровыми правами шифрования должен содержать:</span><span class="sxs-lookup"><span data-stu-id="14a4b-178">hello inputs for DRM encryption should include:</span></span>

1. <span data-ttu-id="14a4b-179">видеосодержимое MBR;</span><span class="sxs-lookup"><span data-stu-id="14a4b-179">MBR video content;</span></span>
2. <span data-ttu-id="14a4b-180">ключ содержимого;</span><span class="sxs-lookup"><span data-stu-id="14a4b-180">Content key;</span></span>
3. <span data-ttu-id="14a4b-181">URL-адреса для приобретения лицензии.</span><span class="sxs-lookup"><span data-stu-id="14a4b-181">License acquisition URLs.</span></span>

<span data-ttu-id="14a4b-182">Во время воспроизведения имеет высокий уровень потока hello:</span><span class="sxs-lookup"><span data-stu-id="14a4b-182">During playback time, hello high level flow is:</span></span>

1. <span data-ttu-id="14a4b-183">проверку подлинности пользователя;</span><span class="sxs-lookup"><span data-stu-id="14a4b-183">User is authenticated;</span></span>
2. <span data-ttu-id="14a4b-184">Создается маркер авторизации для пользователя hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-184">Authorization token is created for hello user;</span></span>
3. <span data-ttu-id="14a4b-185">Содержимое защищенного DRM (манифест) является загруженный tooplayer;</span><span class="sxs-lookup"><span data-stu-id="14a4b-185">DRM protected content (manifest) is downloaded tooplayer;</span></span>
4. <span data-ttu-id="14a4b-186">Игрок дает серверы toolicense запрос приобретения лицензий вместе с ключом идентификатор и авторизации маркера.</span><span class="sxs-lookup"><span data-stu-id="14a4b-186">Player submits license acquisition request toolicense servers together with key ID and authorization token.</span></span>

<span data-ttu-id="14a4b-187">До перемещения следующего раздела toohello несколько слов о hello разработки управления ключами.</span><span class="sxs-lookup"><span data-stu-id="14a4b-187">Before moving toohello next topic, a few words about hello design of key management.</span></span>

| <span data-ttu-id="14a4b-188">**Ключ содержимого/ресурс**</span><span class="sxs-lookup"><span data-stu-id="14a4b-188">**ContentKey–to-Asset**</span></span> | <span data-ttu-id="14a4b-189">**Сценарий**</span><span class="sxs-lookup"><span data-stu-id="14a4b-189">**Scenario**</span></span> |
| --- | --- |
| <span data-ttu-id="14a4b-190">1 ключ/1 ресурс</span><span class="sxs-lookup"><span data-stu-id="14a4b-190">1–to-1</span></span> |<span data-ttu-id="14a4b-191">простейшем случае Hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-191">hello simplest case.</span></span> <span data-ttu-id="14a4b-192">Он предоставляет точного контроля hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-192">It provides hello finest control.</span></span> <span data-ttu-id="14a4b-193">Однако обычно это приводит к hello Максимальная стоимость доставки лицензий.</span><span class="sxs-lookup"><span data-stu-id="14a4b-193">But this generally results in hello highest license delivery cost.</span></span> <span data-ttu-id="14a4b-194">Для каждого защищенного ресурса требуется минимум один запрос лицензии.</span><span class="sxs-lookup"><span data-stu-id="14a4b-194">At minimum one license request is required for each protected asset.</span></span> |
| <span data-ttu-id="14a4b-195">1 ключ/несколько ресурсов</span><span class="sxs-lookup"><span data-stu-id="14a4b-195">1–to-Many</span></span> |<span data-ttu-id="14a4b-196">Можно использовать hello содержимого ключ для нескольких средств.</span><span class="sxs-lookup"><span data-stu-id="14a4b-196">You could use hello same content key for multiple assets.</span></span> <span data-ttu-id="14a4b-197">Например для всех средств hello в логическую группу, например жанр или подмножество жанра (или фильма Созд), можно использовать один ключ содержимого.</span><span class="sxs-lookup"><span data-stu-id="14a4b-197">For example, for all hello assets in a logical group such as a genre or subset of genre (or Movie Gene), you could use a single content key.</span></span> |
| <span data-ttu-id="14a4b-198">Несколько ключей/1 ресурс</span><span class="sxs-lookup"><span data-stu-id="14a4b-198">Many–to-1</span></span> |<span data-ttu-id="14a4b-199">Несколько ключей содержимого необходимы для каждого ресурса.</span><span class="sxs-lookup"><span data-stu-id="14a4b-199">Multiple content keys are needed for each asset.</span></span> <br/><br/><span data-ttu-id="14a4b-200">Например если требуется защиты динамические CENC tooapply с несколькими DRM для динамического шифрования AES-128 для HLS и MPEG-DASH, необходимо два отдельных ключей контента, каждый из которых свой собственный ContentKeyType.</span><span class="sxs-lookup"><span data-stu-id="14a4b-200">For example, if you need tooapply dynamic CENC protection with multi-DRM for MPEG-DASH, and dynamic AES-128 encryption for HLS, you need two separate content keys, each with its own ContentKeyType.</span></span> <span data-ttu-id="14a4b-201">(Для hello содержимого ключ, используемый для защиты динамические CENC, ContentKeyType.CommonEncryption должен использоваться, пока для содержимого, что ключ, используемый для динамического шифрования AES-128, ContentKeyType.EnvelopeEncryption должен использоваться hello.)</span><span class="sxs-lookup"><span data-stu-id="14a4b-201">(For hello content key used for dynamic CENC protection, ContentKeyType.CommonEncryption should be used, while for hello content key used for dynamic AES-128 encryption, ContentKeyType.EnvelopeEncryption should be used.)</span></span><br/><br/><span data-ttu-id="14a4b-202">Еще один пример, в защите CENC штриха содержимого в теории, один ключ содержимого могут быть используется tooprotect потока видео и другого содержимого ключа tooprotect звуковой поток.</span><span class="sxs-lookup"><span data-stu-id="14a4b-202">Another example, in CENC protection of DASH content, in theory, one content key can be used tooprotect video stream and another content key tooprotect audio stream.</span></span> |
| <span data-ttu-id="14a4b-203">Многие — слишком многим</span><span class="sxs-lookup"><span data-stu-id="14a4b-203">Many – too- Many</span></span> |<span data-ttu-id="14a4b-204">Сочетание hello выше два сценария: один набор содержимого, ключи используются для каждого из hello нескольких средств в hello же средства «группа».</span><span class="sxs-lookup"><span data-stu-id="14a4b-204">Combination of hello above two scenarios: one set of content keys are used for each of hello multiple assets in hello same asset “group”.</span></span> |

<span data-ttu-id="14a4b-205">Другим важным фактором tooconsider — использование hello постоянных и временных лицензий.</span><span class="sxs-lookup"><span data-stu-id="14a4b-205">Another important factor tooconsider is hello use of persistent and non-persistent licenses.</span></span>

<span data-ttu-id="14a4b-206">Почему эти вопросы важны?</span><span class="sxs-lookup"><span data-stu-id="14a4b-206">Why are these considerations important?</span></span>

<span data-ttu-id="14a4b-207">Они имеют прямое влияние toolicense доставки затрат при использовании общедоступного облака для доставки лицензий.</span><span class="sxs-lookup"><span data-stu-id="14a4b-207">They have direct impact toolicense delivery cost if you use public cloud for license delivery.</span></span> <span data-ttu-id="14a4b-208">Рассмотрим следующие два tooillustrate случаях другую структуру hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-208">Let’s consider hello following two different design cases tooillustrate:</span></span>

1. <span data-ttu-id="14a4b-209">Ежемесячная подписка: используйте постоянную лицензию и 1 ключ содержимого для нескольких ресурсов.</span><span class="sxs-lookup"><span data-stu-id="14a4b-209">Monthly subscription: Use persistent license, and 1-to-many content key-to-asset mapping.</span></span> <span data-ttu-id="14a4b-210">Например: </span><span class="sxs-lookup"><span data-stu-id="14a4b-210">E.g.</span></span> <span data-ttu-id="14a4b-211">все hello детей фильмов мы используем один ключ содержимого для шифрования.</span><span class="sxs-lookup"><span data-stu-id="14a4b-211">for all hello kids movies, we use a single content key for encryption.</span></span> <span data-ttu-id="14a4b-212">В данном случае:</span><span class="sxs-lookup"><span data-stu-id="14a4b-212">In this case:</span></span>

    <span data-ttu-id="14a4b-213">Общее число лицензий, запрашиваемых для всех детских фильмов или устройств = 1</span><span class="sxs-lookup"><span data-stu-id="14a4b-213">Total # licenses requested for all kids movies/device = 1</span></span>
2. <span data-ttu-id="14a4b-214">Ежемесячная подписка: используйте временную лицензию и 1 ключ содержимого для 1 ресурса.</span><span class="sxs-lookup"><span data-stu-id="14a4b-214">Monthly subscription: Use non-persistent license, and 1-to-1 mapping between content key and asset.</span></span> <span data-ttu-id="14a4b-215">В данном случае:</span><span class="sxs-lookup"><span data-stu-id="14a4b-215">In this case:</span></span>

    <span data-ttu-id="14a4b-216">Общее число лицензий, запрашиваемых для всех детских фильмов или устройств = [число просмотренных фильмов] x [число сеансов]</span><span class="sxs-lookup"><span data-stu-id="14a4b-216">Total # licenses requested for all kids movies/device = [# movies watched] x [# sessions]</span></span>

<span data-ttu-id="14a4b-217">Как можно легко увидеть, hello двумя различными вариантами привести к совершенно разные лицензии запрос таким образом шаблонов затрат в общедоступном облаке, такие как службы мультимедиа Azure Если службы доставки лицензий служб доставки лицензий.</span><span class="sxs-lookup"><span data-stu-id="14a4b-217">As you can easily see, hello two different designs result in very different license request patterns hence license delivery cost if license delivery service is provided by a public cloud such as Azure Media Services.</span></span>

## <a name="mapping-design-tootechnology-for-implementation"></a><span data-ttu-id="14a4b-218">Сопоставление tootechnology проектирования для реализации</span><span class="sxs-lookup"><span data-stu-id="14a4b-218">Mapping design tootechnology for implementation</span></span>
<span data-ttu-id="14a4b-219">Далее мы сопоставим нашей tootechnologies универсального разработки на платформе Microsoft Azure и Azure Media Services, указав, какие технологии toouse для каждого стандартного блока.</span><span class="sxs-lookup"><span data-stu-id="14a4b-219">Next, we map our generic design tootechnologies on Microsoft Azure/Azure Media Services platform, by specifying which technology toouse for each building block.</span></span>

<span data-ttu-id="14a4b-220">Hello следующей таблице показано сопоставление hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-220">hello following table shows hello mapping:</span></span>

| <span data-ttu-id="14a4b-221">**Стандартный блок**</span><span class="sxs-lookup"><span data-stu-id="14a4b-221">**Building Block**</span></span> | <span data-ttu-id="14a4b-222">**Технология**</span><span class="sxs-lookup"><span data-stu-id="14a4b-222">**Technology**</span></span> |
| --- | --- |
| <span data-ttu-id="14a4b-223">**Проигрыватель**</span><span class="sxs-lookup"><span data-stu-id="14a4b-223">**Player**</span></span> |[<span data-ttu-id="14a4b-224">Проигрыватель мультимедиа Azure</span><span class="sxs-lookup"><span data-stu-id="14a4b-224">Azure Media Player</span></span>](https://azure.microsoft.com/services/media-services/media-player/) |
| <span data-ttu-id="14a4b-225">**Поставщик удостоверений (IDP)**</span><span class="sxs-lookup"><span data-stu-id="14a4b-225">**Identity Provider (IDP)**</span></span> |<span data-ttu-id="14a4b-226">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="14a4b-226">Azure Active Directory</span></span> |
| <span data-ttu-id="14a4b-227">**Служба маркеров безопасности (STS)**</span><span class="sxs-lookup"><span data-stu-id="14a4b-227">**Secure Token Service (STS)**</span></span> |<span data-ttu-id="14a4b-228">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="14a4b-228">Azure Active Directory</span></span> |
| <span data-ttu-id="14a4b-229">**Рабочий процесс защиты DRM**</span><span class="sxs-lookup"><span data-stu-id="14a4b-229">**DRM Protection Workflow**</span></span> |<span data-ttu-id="14a4b-230">Динамическая защита служб мультимедиа Azure</span><span class="sxs-lookup"><span data-stu-id="14a4b-230">Azure Media Services Dynamic Protection</span></span> |
| <span data-ttu-id="14a4b-231">**Доставка лицензий DRM**</span><span class="sxs-lookup"><span data-stu-id="14a4b-231">**DRM License Delivery**</span></span> |<span data-ttu-id="14a4b-232">1. Доставка лицензий служб мультимедиа Azure (PlayReady, Widevine, FairPlay), или</span><span class="sxs-lookup"><span data-stu-id="14a4b-232">1. Azure Media Services License Delivery (PlayReady, Widevine, FairPlay), or</span></span> <br/><span data-ttu-id="14a4b-233">2. Axinom License Server,</span><span class="sxs-lookup"><span data-stu-id="14a4b-233">2. Axinom License Server,</span></span> <br/><span data-ttu-id="14a4b-234">3. Пользовательский сервер лицензирования PlayReady</span><span class="sxs-lookup"><span data-stu-id="14a4b-234">3. Custom PlayReady License Server</span></span> |
| <span data-ttu-id="14a4b-235">**Исходный домен**</span><span class="sxs-lookup"><span data-stu-id="14a4b-235">**Origin**</span></span> |<span data-ttu-id="14a4b-236">Конечная точка потоковой передачи служб мультимедиа Azure</span><span class="sxs-lookup"><span data-stu-id="14a4b-236">Azure Media Services Streaming Endpoint</span></span> |
| <span data-ttu-id="14a4b-237">**Управление ключами**</span><span class="sxs-lookup"><span data-stu-id="14a4b-237">**Key Management**</span></span> |<span data-ttu-id="14a4b-238">Не требуется для справочной реализации</span><span class="sxs-lookup"><span data-stu-id="14a4b-238">Not needed for reference implementation</span></span> |
| <span data-ttu-id="14a4b-239">**Управление содержимым**</span><span class="sxs-lookup"><span data-stu-id="14a4b-239">**Content Management**</span></span> |<span data-ttu-id="14a4b-240">Консольное приложение C#</span><span class="sxs-lookup"><span data-stu-id="14a4b-240">A C# console application</span></span> |

<span data-ttu-id="14a4b-241">Другими словами, и поставщиком удостоверений (IDP), и службой маркеров безопасности (STS) будет Azure AD.</span><span class="sxs-lookup"><span data-stu-id="14a4b-241">In other words, both Identity Provider (IDP) and Secure Token Service (STS) will be Azure AD.</span></span> <span data-ttu-id="14a4b-242">Для проигрывателя мы будем использовать [API Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/).</span><span class="sxs-lookup"><span data-stu-id="14a4b-242">For player, we will use [Azure Media Player API](http://amp.azure.net/libs/amp/latest/docs/).</span></span> <span data-ttu-id="14a4b-243">Службы мультимедиа Azure и Проигрыватель Мультимедиа Azure поддерживают DASH и CENC с несколькими DRM.</span><span class="sxs-lookup"><span data-stu-id="14a4b-243">Both Azure Media Services and Azure Media Player support DASH and CENC with multi-DRM.</span></span>

<span data-ttu-id="14a4b-244">Следующая схема показывает Hello hello общую структуру и потока с hello выше технологии сопоставления.</span><span class="sxs-lookup"><span data-stu-id="14a4b-244">hello following diagram shows hello overall structure and flow with hello above technology mapping.</span></span>

![CENC на AMS](./media/media-services-cenc-with-multidrm-access-control/media-services-cenc-subsystem-on-AMS-platform.png)

<span data-ttu-id="14a4b-246">В порядке tooset динамическое шифрование CENC средство управления содержимым hello будет использовать hello следующие входные данные:</span><span class="sxs-lookup"><span data-stu-id="14a4b-246">In order tooset up dynamic CENC encryption, hello content management tool will use hello following inputs:</span></span>

1. <span data-ttu-id="14a4b-247">открывание содержимого;</span><span class="sxs-lookup"><span data-stu-id="14a4b-247">Open content;</span></span>
2. <span data-ttu-id="14a4b-248">ключ содержимого из раздела создания и управления ключом;</span><span class="sxs-lookup"><span data-stu-id="14a4b-248">Content key from key generation/management;</span></span>
3. <span data-ttu-id="14a4b-249">URL-адреса для приобретения лицензии;</span><span class="sxs-lookup"><span data-stu-id="14a4b-249">License acquisition URLs;</span></span>
4. <span data-ttu-id="14a4b-250">список сведений из Azure AD.</span><span class="sxs-lookup"><span data-stu-id="14a4b-250">A list of information from Azure AD.</span></span>

<span data-ttu-id="14a4b-251">Hello выходные данные средства управления содержимым hello будет:</span><span class="sxs-lookup"><span data-stu-id="14a4b-251">hello output of hello content management tool will be:</span></span>

1. <span data-ttu-id="14a4b-252">ContentKeyAuthorizationPolicy, содержащих спецификацию hello на способ доставки лицензий проверяет маркер JWT и спецификации лицензии DRM;</span><span class="sxs-lookup"><span data-stu-id="14a4b-252">ContentKeyAuthorizationPolicy containing hello specification on how license delivery verifies a JWT token and DRM license specifications;</span></span>
2. <span data-ttu-id="14a4b-253">AssetDeliveryPolicy, содержащая спецификации потоковых форматов, защиту DRM и URL-адреса приобретения лицензий.</span><span class="sxs-lookup"><span data-stu-id="14a4b-253">AssetDeliveryPolicy containing specifications on streaming format, DRM protection and license acquisition URLs.</span></span>

<span data-ttu-id="14a4b-254">Во время выполнения, hello поток выглядит как ниже:</span><span class="sxs-lookup"><span data-stu-id="14a4b-254">During runtime, hello flow is as below:</span></span>

1. <span data-ttu-id="14a4b-255">После проверки подлинности пользователя создается маркер JWT.</span><span class="sxs-lookup"><span data-stu-id="14a4b-255">Upon user authentication, a JWT token is generated;</span></span>
2. <span data-ttu-id="14a4b-256">Одним из hello утверждений, содержащихся в токене JWT hello является утверждение «groups», содержащая идентификатор группы hello объекта «EntitledUserGroup».</span><span class="sxs-lookup"><span data-stu-id="14a4b-256">One of hello claims contained in hello JWT token is “groups” claim containing hello group object ID of “EntitledUserGroup”.</span></span> <span data-ttu-id="14a4b-257">Это утверждение будет использоваться для передачи "проверка права".</span><span class="sxs-lookup"><span data-stu-id="14a4b-257">This claim will be used for passing “entitlement check”.</span></span>
3. <span data-ttu-id="14a4b-258">Проигрыватель загрузки клиента манифест CENC защищенного содержимого и «видит» hello следующее:</span><span class="sxs-lookup"><span data-stu-id="14a4b-258">Player downloads client manifest of a CENC protected content and “sees” hello following:</span></span>

   1. <span data-ttu-id="14a4b-259">идентификатор ключа;</span><span class="sxs-lookup"><span data-stu-id="14a4b-259">key ID,</span></span>
   2. <span data-ttu-id="14a4b-260">Hello содержимое будет защищен, CENC</span><span class="sxs-lookup"><span data-stu-id="14a4b-260">hello content is CENC protected,</span></span>
   3. <span data-ttu-id="14a4b-261">URL-адреса для приобретения лицензии.</span><span class="sxs-lookup"><span data-stu-id="14a4b-261">License acquisition URLs.</span></span>
4. <span data-ttu-id="14a4b-262">Проигрыватель делает запрос приобретения лицензии, зависимости от браузера hello/поддерживается DRM.</span><span class="sxs-lookup"><span data-stu-id="14a4b-262">Player makes a license acquisition request based on hello browser/DRM supported.</span></span> <span data-ttu-id="14a4b-263">В запрос приобретения лицензии hello, ключа идентификатора и hello JWT будут также отправлены маркер.</span><span class="sxs-lookup"><span data-stu-id="14a4b-263">In hello license acquisition request, key ID and hello JWT token will also be submitted.</span></span> <span data-ttu-id="14a4b-264">Служба доставки лицензий проверит маркер JWT hello и hello утверждения перед выдачи hello необходимых лицензий.</span><span class="sxs-lookup"><span data-stu-id="14a4b-264">License delivery service will verify hello JWT token and hello claims contained before issuing hello needed license.</span></span>

## <a name="implementation"></a><span data-ttu-id="14a4b-265">Реализация</span><span class="sxs-lookup"><span data-stu-id="14a4b-265">Implementation</span></span>
### <a name="implementation-procedures"></a><span data-ttu-id="14a4b-266">Процедуры реализации</span><span class="sxs-lookup"><span data-stu-id="14a4b-266">Implementation procedures</span></span>
<span data-ttu-id="14a4b-267">Реализация Hello содержит hello следующие шаги:</span><span class="sxs-lookup"><span data-stu-id="14a4b-267">hello implementation will include hello following steps:</span></span>

1. <span data-ttu-id="14a4b-268">Подготовка средства тестирования: кодирования или упаковки теста toomulti скорость видео фрагментированном формате MP4 в службах мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="14a4b-268">Prepare test asset(s): encode/package a test video toomulti-bitrate fragmented MP4 in Azure Media Services.</span></span> <span data-ttu-id="14a4b-269">Этот ресурс НЕ защищен DRM.</span><span class="sxs-lookup"><span data-stu-id="14a4b-269">This asset is NOT DRM protected.</span></span> <span data-ttu-id="14a4b-270">Защита DRM будет реализована позже с помощью динамической защиты.</span><span class="sxs-lookup"><span data-stu-id="14a4b-270">DRM protection will be done by dynamic protection later.</span></span>
2. <span data-ttu-id="14a4b-271">Создание идентификатора ключа и ключа содержимого (при необходимости из начального значения).</span><span class="sxs-lookup"><span data-stu-id="14a4b-271">Create key ID and content key (optionally from key seed).</span></span> <span data-ttu-id="14a4b-272">Для наших целей система управления ключами не требуется, поскольку мы имеем дело только с одним набором идентификатора ключа и ключа содержимого для нескольких тестовых ресурсов.</span><span class="sxs-lookup"><span data-stu-id="14a4b-272">For our purpose, key management system is not needed since we are dealing with only a single set of key ID and content key for a couple of test assets;</span></span>
3. <span data-ttu-id="14a4b-273">Использование служб доставки лицензий DRM несколькими tooconfigure AMS API для средств тестирования hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-273">Use AMS API tooconfigure multi-DRM license delivery services for hello test asset.</span></span> <span data-ttu-id="14a4b-274">При использовании серверов пользовательских лицензий вашей компании или организации поставщиков вместо лицензии служб в Azure Media Services можно пропустить этот шаг и указать URL-адреса приобретения лицензий в hello шаг по настройке служб доставки лицензий.</span><span class="sxs-lookup"><span data-stu-id="14a4b-274">If you are using custom license servers by your company or your company’s vendors instead of license services in Azure Media Services, you can skip this step and specify license acquisition URLs in hello step for configuring license delivery.</span></span> <span data-ttu-id="14a4b-275">AMS API — необходимые toospecify некоторые подробные конфигураций, например ограничений политики авторизации, лицензии ответа шаблоны для различных служб управления правами лицензии и т. д. В настоящее время hello портал Azure не поддерживает еще предоставляют hello требуется пользовательский Интерфейс для этой конфигурации.</span><span class="sxs-lookup"><span data-stu-id="14a4b-275">AMS API is needed toospecify some detailed configurations, such as authorization policy restriction, license response templates for different DRM license services, etc. At this time, hello Azure portal does not yet provide hello needed UI for this configuration.</span></span> <span data-ttu-id="14a4b-276">Сведения об уровне API и образец кода см. в статье Юлии Корнич (Julia Kornich): [Использование общего динамического шифрования PlayReady и (или) Widevine DRM](media-services-protect-with-drm.md).</span><span class="sxs-lookup"><span data-stu-id="14a4b-276">You can find API level info and sample code in Julia Kornich’s document: [Using PlayReady and/or Widevine Dynamic Common Encryption](media-services-protect-with-drm.md).</span></span>
4. <span data-ttu-id="14a4b-277">Используйте политики доставки активов tooconfigure AMS API для средств тестирования hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-277">Use AMS API tooconfigure asset delivery policy for hello test asset.</span></span> <span data-ttu-id="14a4b-278">Сведения об уровне API и образец кода см. в статье Юлии Корнич (Julia Kornich): [Использование общего динамического шифрования PlayReady и (или) Widevine DRM](media-services-protect-with-drm.md).</span><span class="sxs-lookup"><span data-stu-id="14a4b-278">You can find API level info and sample code in Julia Kornich’s document: [Using PlayReady and/or Widevine Dynamic Common Encryption](media-services-protect-with-drm.md).</span></span>
5. <span data-ttu-id="14a4b-279">Создание и настройка клиента Azure Active Directory в Azure</span><span class="sxs-lookup"><span data-stu-id="14a4b-279">Create and configure an Azure Active Directory tenant in Azure;</span></span>
6. <span data-ttu-id="14a4b-280">Создать несколько учетных записей пользователей и групп в клиенте Azure Active Directory: необходимо создать по крайней мере «EntitledUser» и добавить группу пользователей toothis.</span><span class="sxs-lookup"><span data-stu-id="14a4b-280">Create a few user accounts and groups in your Azure Active Directory tenant: you should create at least “EntitledUser” group and add a user toothis group.</span></span> <span data-ttu-id="14a4b-281">Пользователи в этой группе пройдет проверку правах приобретение лицензий и пользователи этой группы не сможет выполнить проверку подлинности toopass и не будет возможности tooacquire лицензии.</span><span class="sxs-lookup"><span data-stu-id="14a4b-281">Users in this group will pass entitlement check in license acquisition and users not in this group will fail toopass authentication check and will not be able tooacquire any license.</span></span> <span data-ttu-id="14a4b-282">Не является членом этой группы «EntitledUser» — это утверждение обязательным «groups» в hello маркера JWT, выданного Azure AD.</span><span class="sxs-lookup"><span data-stu-id="14a4b-282">Being a member of this “EntitledUser” group is a required “groups” claim in hello JWT token issued by Azure AD.</span></span> <span data-ttu-id="14a4b-283">Это требование утверждения должно быть указано при настройке служб доставки лицензий с несколькими DRM.</span><span class="sxs-lookup"><span data-stu-id="14a4b-283">This claim requirement should be specified in configuring multi-DRM license delivery services step.</span></span>
7. <span data-ttu-id="14a4b-284">Создайте приложение ASP.NET MVC, в котором будет размещен видеопроигрыватель.</span><span class="sxs-lookup"><span data-stu-id="14a4b-284">Create an ASP.NET MVC app which will be hosting your video player.</span></span> <span data-ttu-id="14a4b-285">Это приложение ASP.NET будут защищены с помощью проверки подлинности пользователей в клиент Azure Active Directory hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-285">This ASP.NET app will be protected with user authentication against hello Azure Active Directory tenant.</span></span> <span data-ttu-id="14a4b-286">Утверждения, соответствующие будет включаться в токены доступа hello, полученный после проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="14a4b-286">Proper claims will be included in hello access tokens obtained after user authentication.</span></span> <span data-ttu-id="14a4b-287">В этом шаге рекомендуется использовать API OpenID Connect.</span><span class="sxs-lookup"><span data-stu-id="14a4b-287">OpenID Connect API is recommended for this step.</span></span> <span data-ttu-id="14a4b-288">Необходимы следующие пакеты NuGet hello tooinstall:</span><span class="sxs-lookup"><span data-stu-id="14a4b-288">You need tooinstall hello following NuGet packages:</span></span>
   * <span data-ttu-id="14a4b-289">Install-Package Microsoft.Azure.ActiveDirectory.GraphClient</span><span class="sxs-lookup"><span data-stu-id="14a4b-289">Install-Package Microsoft.Azure.ActiveDirectory.GraphClient</span></span>
   * <span data-ttu-id="14a4b-290">Install-Package Microsoft.Owin.Security.OpenIdConnect</span><span class="sxs-lookup"><span data-stu-id="14a4b-290">Install-Package Microsoft.Owin.Security.OpenIdConnect</span></span>
   * <span data-ttu-id="14a4b-291">Install-Package Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="14a4b-291">Install-Package Microsoft.Owin.Security.Cookies</span></span>
   * <span data-ttu-id="14a4b-292">Install-Package Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="14a4b-292">Install-Package Microsoft.Owin.Host.SystemWeb</span></span>
   * <span data-ttu-id="14a4b-293">Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory</span><span class="sxs-lookup"><span data-stu-id="14a4b-293">Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory</span></span>
8. <span data-ttu-id="14a4b-294">Создайте проигрыватель с помощью [API Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/).</span><span class="sxs-lookup"><span data-stu-id="14a4b-294">Create a player using [Azure Media Player API](http://amp.azure.net/libs/amp/latest/docs/).</span></span> <span data-ttu-id="14a4b-295">[Azure Media Player ProtectionInfo API](http://amp.azure.net/libs/amp/latest/docs/) позволяет toospecify какие toouse технологии управления цифровыми правами на другой платформе управления цифровыми правами.</span><span class="sxs-lookup"><span data-stu-id="14a4b-295">[Azure Media Player’s ProtectionInfo API](http://amp.azure.net/libs/amp/latest/docs/) allows you toospecify which DRM technology toouse on different DRM platform.</span></span>
9. <span data-ttu-id="14a4b-296">Тестовая матрица:</span><span class="sxs-lookup"><span data-stu-id="14a4b-296">Test matrix:</span></span>

| <span data-ttu-id="14a4b-297">**DRM**</span><span class="sxs-lookup"><span data-stu-id="14a4b-297">**DRM**</span></span> | <span data-ttu-id="14a4b-298">**"Обзор"**</span><span class="sxs-lookup"><span data-stu-id="14a4b-298">**Browser**</span></span> | <span data-ttu-id="14a4b-299">**Результат для соответствующего пользователя**</span><span class="sxs-lookup"><span data-stu-id="14a4b-299">**Result for Entitled User**</span></span> | <span data-ttu-id="14a4b-300">**Результат для не соответствующего пользователя**</span><span class="sxs-lookup"><span data-stu-id="14a4b-300">**Result for Un-entitled User**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="14a4b-301">**PlayReady**</span><span class="sxs-lookup"><span data-stu-id="14a4b-301">**PlayReady**</span></span> |<span data-ttu-id="14a4b-302">MS Edge или IE11 на Windows 10</span><span class="sxs-lookup"><span data-stu-id="14a4b-302">MS Edge or IE11 on Windows 10</span></span> |<span data-ttu-id="14a4b-303">Успешно</span><span class="sxs-lookup"><span data-stu-id="14a4b-303">Succeed</span></span> |<span data-ttu-id="14a4b-304">Fail;</span><span class="sxs-lookup"><span data-stu-id="14a4b-304">Fail</span></span> |
| <span data-ttu-id="14a4b-305">**Widevine**</span><span class="sxs-lookup"><span data-stu-id="14a4b-305">**Widevine**</span></span> |<span data-ttu-id="14a4b-306">Chrome на Windows 10</span><span class="sxs-lookup"><span data-stu-id="14a4b-306">Chrome on Windows 10</span></span> |<span data-ttu-id="14a4b-307">Успешно</span><span class="sxs-lookup"><span data-stu-id="14a4b-307">Succeed</span></span> |<span data-ttu-id="14a4b-308">Fail;</span><span class="sxs-lookup"><span data-stu-id="14a4b-308">Fail</span></span> |
| <span data-ttu-id="14a4b-309">**FairPlay**</span><span class="sxs-lookup"><span data-stu-id="14a4b-309">**FairPlay**</span></span> |<span data-ttu-id="14a4b-310">ПОДЛЕЖИТ УТОЧНЕНИЮ</span><span class="sxs-lookup"><span data-stu-id="14a4b-310">TBD</span></span> | | |

<span data-ttu-id="14a4b-311">Джордж Трифонов (George Trifonov) из команды служб мультимедиа Azure ведет блог, где вы найдете подробное описание шагов для настройки Azure Active Directory для приложения проигрывателя ASP.NET MVC, — [Интеграция приложения на основе OWIN MVC служб мультимедиа Azure с Azure Active Directory и ограничение доставки ключей содержимого на основе утверждений JWT](http://gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/).</span><span class="sxs-lookup"><span data-stu-id="14a4b-311">George Trifonov of Azure Media Services Team has written a blog providing detailed steps in setting up Azure Active Directory for an ASP.NET MVC player app: [Integrate Azure Media Services OWIN MVC based app with Azure Active Directory and restrict content key delivery based on JWT claims](http://gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/).</span></span>

<span data-ttu-id="14a4b-312">Джордж также ведет блог о [проверке подлинности маркера JWT в службах мультимедиа Azure и динамическом шифровании](http://gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/).</span><span class="sxs-lookup"><span data-stu-id="14a4b-312">George has also written a blog on [JWT token Authentication in Azure Media Services and Dynamic Encryption](http://gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/).</span></span> <span data-ttu-id="14a4b-313">А вот его [пример интеграции Azure AD с доставкой ключей служб мультимедиа Azure](https://github.com/AzureMediaServicesSamples/Key-delivery-with-AAD-integration/).</span><span class="sxs-lookup"><span data-stu-id="14a4b-313">And here is his [sample on Azure AD integration with Azure Media Services key delivery](https://github.com/AzureMediaServicesSamples/Key-delivery-with-AAD-integration/).</span></span>

<span data-ttu-id="14a4b-314">Дополнительные сведения об Azure Active Directory:</span><span class="sxs-lookup"><span data-stu-id="14a4b-314">For information on Azure Active Directory:</span></span>

* <span data-ttu-id="14a4b-315">Сведения для разработчиков см. в [руководстве разработчика по Azure Active Directory](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="14a4b-315">You can find developer information in [Azure Active Directory Developer’s Guide](../active-directory/active-directory-developers-guide.md).</span></span>
* <span data-ttu-id="14a4b-316">Сведения для администраторов см. в статье [Администрирование каталога Azure AD](../active-directory/active-directory-administer.md).</span><span class="sxs-lookup"><span data-stu-id="14a4b-316">You can find administrator information in [Administer Your Azure AD Directory](../active-directory/active-directory-administer.md).</span></span>

### <a name="some-gotchas-in-implementation"></a><span data-ttu-id="14a4b-317">Некоторые проблемы в реализации</span><span class="sxs-lookup"><span data-stu-id="14a4b-317">Some gotchas in implementation</span></span>
<span data-ttu-id="14a4b-318">В реализации hello есть некоторые «проблемы».</span><span class="sxs-lookup"><span data-stu-id="14a4b-318">There are some “gotchas” in hello implementation.</span></span> <span data-ttu-id="14a4b-319">Надеемся, у hello следующий список «рекомендации» может помочь Устранение неполадок в случае, если возникнут проблемы.</span><span class="sxs-lookup"><span data-stu-id="14a4b-319">Hopefully hello following list of “gotchas” can help you troubleshooting in case you run into issues.</span></span>

1. <span data-ttu-id="14a4b-320">URL-адрес **издателя** должен заканчиваться на **"/"**.</span><span class="sxs-lookup"><span data-stu-id="14a4b-320">**Issuer** URL should end with **"/"**.</span></span>  

    <span data-ttu-id="14a4b-321">**Аудитория** должен быть hello идентификатор клиента приложения проигрывателя, а также следует добавить **«/»** конце hello URL-адрес издателя hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-321">**Audience** should be hello player application client ID and you should also add **"/"** at hello end of hello issuer URL.</span></span>

        <add key="ida:audience" value="[Application Client ID GUID]" />
        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/" />

    <span data-ttu-id="14a4b-322">В [декодер JWT](http://jwt.calebb.net/), вы увидите **aud** и **iss** как показано ниже в токене JWT hello:</span><span class="sxs-lookup"><span data-stu-id="14a4b-322">In [JWT Decoder](http://jwt.calebb.net/), you should see **aud** and **iss** as below in hello JWT token:</span></span>

    ![1-я проблема](./media/media-services-cenc-with-multidrm-access-control/media-services-1st-gotcha.png)
2. <span data-ttu-id="14a4b-324">Добавьте разрешения toohello приложение в Azure Active Directory (на вкладке Настройка приложения hello).</span><span class="sxs-lookup"><span data-stu-id="14a4b-324">Add Permissions toohello application in AAD (on Configure tab of hello application).</span></span> <span data-ttu-id="14a4b-325">Это необходимо для каждого приложения (локальной и развернутой версий).</span><span class="sxs-lookup"><span data-stu-id="14a4b-325">This is required for each application (local and deployed versions).</span></span>

    ![2-я проблема](./media/media-services-cenc-with-multidrm-access-control/media-services-perms-to-other-apps.png)
3. <span data-ttu-id="14a4b-327">Используйте hello правильного поставщика в настройке динамического CENC защиты:</span><span class="sxs-lookup"><span data-stu-id="14a4b-327">Use hello right issuer in setting up dynamic CENC protection:</span></span>

        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/"/>

    <span data-ttu-id="14a4b-328">следующие Hello не будет работать:</span><span class="sxs-lookup"><span data-stu-id="14a4b-328">hello following will not work:</span></span>

        <add key="ida:issuer" value="https://willzhanad.onmicrosoft.com/" />

    <span data-ttu-id="14a4b-329">Hello GUID является идентификатором hello AAD клиента.</span><span class="sxs-lookup"><span data-stu-id="14a4b-329">hello GUID is hello AAD tenant ID.</span></span> <span data-ttu-id="14a4b-330">Hello GUID можно найти во всплывающем конечные точки на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="14a4b-330">hello GUID can be found in Endpoints popup in Azure portal.</span></span>
4. <span data-ttu-id="14a4b-331">Предоставление привилегий утверждения членства в группе.</span><span class="sxs-lookup"><span data-stu-id="14a4b-331">Grant group membership claims privileges.</span></span> <span data-ttu-id="14a4b-332">Убедитесь, что в файле манифеста приложения AAD, у нас есть следующие hello</span><span class="sxs-lookup"><span data-stu-id="14a4b-332">Make sure in AAD application manifest file, we have hello following</span></span>

    <span data-ttu-id="14a4b-333">«groupMembershipClaims»: «Все» (значение по умолчанию hello имеет значение null)</span><span class="sxs-lookup"><span data-stu-id="14a4b-333">"groupMembershipClaims": "All",    (hello default value is null)</span></span>
5. <span data-ttu-id="14a4b-334">Установка правильного TokenType при создании требования к ограничениям.</span><span class="sxs-lookup"><span data-stu-id="14a4b-334">Setting proper TokenType when creating restriction requirements.</span></span>

        objTokenRestrictionTemplate.TokenType = TokenType.JWT;

    <span data-ttu-id="14a4b-335">Так как добавление поддерживает из JWT (AAD) в дополнение к этому tooSWT (ACS), по умолчанию hello TokenType — TokenType.JWT.</span><span class="sxs-lookup"><span data-stu-id="14a4b-335">Since adding support of JWT (AAD) in addition tooSWT (ACS), hello default TokenType is TokenType.JWT.</span></span> <span data-ttu-id="14a4b-336">Если вы используете SWT и ACS, необходимо задать tooTokenType.SWT.</span><span class="sxs-lookup"><span data-stu-id="14a4b-336">If you use SWT/ACS, you must set tooTokenType.SWT.</span></span>

## <a name="additional-topics-for-implementation"></a><span data-ttu-id="14a4b-337">Дополнительные разделы по реализации</span><span class="sxs-lookup"><span data-stu-id="14a4b-337">Additional Topics for Implementation</span></span>
<span data-ttu-id="14a4b-338">Далее мы рассмотрим некоторые дополнительные вопросы в нашей теме о проектировании и реализации.</span><span class="sxs-lookup"><span data-stu-id="14a4b-338">Next we will disc uss some additional topics in our design and implementation.</span></span>

### <a name="http-or-https"></a><span data-ttu-id="14a4b-339">HTTP или HTTPS?</span><span class="sxs-lookup"><span data-stu-id="14a4b-339">HTTP or HTTPS?</span></span>
<span data-ttu-id="14a4b-340">приложение ASP.NET MVC проигрывателя нами Hello должен поддерживать hello следующее:</span><span class="sxs-lookup"><span data-stu-id="14a4b-340">hello ASP.NET MVC player application we built must support hello following:</span></span>

1. <span data-ttu-id="14a4b-341">Проверку подлинности пользователя через Azure AD, которого требуется toobe под HTTPS;</span><span class="sxs-lookup"><span data-stu-id="14a4b-341">User authentication through Azure AD which needs toobe under HTTPS;</span></span>
2. <span data-ttu-id="14a4b-342">JWT маркера обмен между клиентом и Azure AD, которого требуется toobe под HTTPS;</span><span class="sxs-lookup"><span data-stu-id="14a4b-342">JWT token exchange between client and Azure AD which needs toobe under HTTPS;</span></span>
3. <span data-ttu-id="14a4b-343">Получение лицензии DRM клиентом hello, который является обязательным toobe в HTTPS, если предоставлен доставки лицензий службами мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="14a4b-343">DRM license acquisition by hello client which is required toobe under HTTPS if license delivery is provided by Azure Media Services.</span></span> <span data-ttu-id="14a4b-344">Конечно, набор продуктов PlayReady не требует HTTPS для доставки лицензий.</span><span class="sxs-lookup"><span data-stu-id="14a4b-344">Of course, PlayReady product suite does not mandate HTTPS for license delivery.</span></span> <span data-ttu-id="14a4b-345">Если ваш сервер лицензирования PlayReady находится за пределами служб мультимедиа Azure, можно использовать HTTP или HTTPS.</span><span class="sxs-lookup"><span data-stu-id="14a4b-345">If your PlayReady license server is outside of Azure Media Services, either HTTP or HTTPS could be used.</span></span>

<span data-ttu-id="14a4b-346">Таким образом hello проигрывателя приложения ASP.NET будут использовать HTTPS рекомендуется.</span><span class="sxs-lookup"><span data-stu-id="14a4b-346">Therefore, hello ASP.NET player application will use HTTPS as a best practice.</span></span> <span data-ttu-id="14a4b-347">Это означает hello Azure Media Player будет на странице в разделе HTTPS.</span><span class="sxs-lookup"><span data-stu-id="14a4b-347">This means hello Azure Media Player will be on a page under HTTPS.</span></span> <span data-ttu-id="14a4b-348">Однако для потоковой передачи желательно HTTP, поэтому мы должны tooconsider смешанного содержимого проблему.</span><span class="sxs-lookup"><span data-stu-id="14a4b-348">However, for streaming we prefer HTTP, hence we need tooconsider mixed content issue.</span></span>

1. <span data-ttu-id="14a4b-349">Браузер не разрешает смешанное содержимое.</span><span class="sxs-lookup"><span data-stu-id="14a4b-349">Browser does not allow mixed content.</span></span> <span data-ttu-id="14a4b-350">Однако подключаемые модули, например Silverlight и OSMF для бесперебойной работы и DASH, разрешают.</span><span class="sxs-lookup"><span data-stu-id="14a4b-350">But plugins like Silverlight and OSMF plugin for smooth and DASH allow.</span></span> <span data-ttu-id="14a4b-351">Смешанное содержимое существует угроза безопасности - это из-за угрозы toohello из tooinject возможность hello вредоносных JS, что может привести к hello клиента toobe данные под угрозой.</span><span class="sxs-lookup"><span data-stu-id="14a4b-351">Mixed content is a security concern - This is due toohello threat of hello ability tooinject malicious JS which can cause hello customer data toobe at risk.</span></span>  <span data-ttu-id="14a4b-352">Браузеры блокировать это по умолчанию и на данный момент hello единственным способом toowork вокруг него равен на стороне сервера (источника) hello tooallow все домены (независимо от того, https или http).</span><span class="sxs-lookup"><span data-stu-id="14a4b-352">Browsers block this by default and so far hello only way toowork around it is on hello server (origin) side, tooallow all domains (regardless https or http).</span></span> <span data-ttu-id="14a4b-353">Это, скорее всего, тоже не самая лучшая идея.</span><span class="sxs-lookup"><span data-stu-id="14a4b-353">This is probably not a good idea either.</span></span>
2. <span data-ttu-id="14a4b-354">Следует избегать смешанного содержимого: всегда использовать либо протокол HTTP, либо HTTPS.</span><span class="sxs-lookup"><span data-stu-id="14a4b-354">We should avoid mixed content: either both use HTTP or both use HTTPS.</span></span> <span data-ttu-id="14a4b-355">При воспроизведении смешанного содержимого технология silverlightSS требует удаления предупреждения о смешанном содержимом.</span><span class="sxs-lookup"><span data-stu-id="14a4b-355">When playing mixed content, silverlightSS tech requires clearing a mixed content warning.</span></span> <span data-ttu-id="14a4b-356">Технология flashSS обрабатывает смешанное содержимое без предупреждения о смешанном содержимом.</span><span class="sxs-lookup"><span data-stu-id="14a4b-356">flashSS tech handles mixed content without mixed content warning.</span></span>
3. <span data-ttu-id="14a4b-357">Если конечная точка потоковой передачи была создана до августа 2014 г., она не будет поддерживать протокол HTTPS.</span><span class="sxs-lookup"><span data-stu-id="14a4b-357">If your streaming endpoint was created before August 2014, it will not support HTTPS.</span></span> <span data-ttu-id="14a4b-358">В этом случае создайте и используйте новую конечную точку потоковой передачи для использования протокола HTTPS.</span><span class="sxs-lookup"><span data-stu-id="14a4b-358">In this case, please create and use a new streaming endpoint for HTTPS.</span></span>

<span data-ttu-id="14a4b-359">В hello Эталонная реализация для защищенного DRM содержимое и приложение и потоковая передача будет HTTTPS.</span><span class="sxs-lookup"><span data-stu-id="14a4b-359">In hello reference implementation, for DRM protected contents, both application and streaming will be under HTTTPS.</span></span> <span data-ttu-id="14a4b-360">Для открытых содержимое проигрывателя hello не обязательно лицензия, или проверку подлинности их необходимо hello liberty toouse либо HTTP или HTTPS.</span><span class="sxs-lookup"><span data-stu-id="14a4b-360">For open contents, hello player does not need authentication or license, so you have hello liberty toouse either HTTP or HTTPS.</span></span>

### <a name="azure-active-directory-signing-key-rollover"></a><span data-ttu-id="14a4b-361">Смена ключей подписывания Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="14a4b-361">Azure Active Directory signing key rollover</span></span>
<span data-ttu-id="14a4b-362">Это важные tootake точки во внимание реализации.</span><span class="sxs-lookup"><span data-stu-id="14a4b-362">This is an important point tootake into consideration of your implementation.</span></span> <span data-ttu-id="14a4b-363">Если это не рекомендуется в реализации, система hello завершено со временем перестанут работать полностью в течение не более 6 недель.</span><span class="sxs-lookup"><span data-stu-id="14a4b-363">If you do not consider this in your implementation, hello completed system will eventually stop working completely within at most 6 weeks.</span></span>

<span data-ttu-id="14a4b-364">Azure AD использует отраслевых стандартных tooestablish доверия между собой и приложений с помощью Azure AD.</span><span class="sxs-lookup"><span data-stu-id="14a4b-364">Azure AD uses industry standard tooestablish trust between itself and applications using Azure AD.</span></span> <span data-ttu-id="14a4b-365">В частности, Azure AD использует ключ подписывания, состоящий из пары открытого и закрытого ключей.</span><span class="sxs-lookup"><span data-stu-id="14a4b-365">Specifically, Azure AD uses a signing key that consists of a public and private key pair.</span></span> <span data-ttu-id="14a4b-366">Когда Azure AD создает маркер безопасности, содержащий сведения о пользователе hello, этот маркер подписывается с помощью Azure AD, используя свой закрытый ключ, перед отправкой приложения toohello назад.</span><span class="sxs-lookup"><span data-stu-id="14a4b-366">When Azure AD creates a security token that contains information about hello user, this token is signed by Azure AD using its private key before it is sent back toohello application.</span></span> <span data-ttu-id="14a4b-367">tooverify, hello токен действителен и получен из Azure AD, hello приложение должно проверить токен hello подписи с помощью открытого ключа hello, предоставляемые Azure AD, который содержится в документе метаданных федерации клиента hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-367">tooverify that hello token is valid and actually originated from Azure AD, hello application must validate hello token’s signature using hello public key exposed by Azure AD that is contained in hello tenant’s federation metadata document.</span></span> <span data-ttu-id="14a4b-368">Этот открытый ключ — и hello производный ключ подписи — — hello же той, которая используется для всех клиентов в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="14a4b-368">This public key – and hello signing key from which it derives – is hello same one used for all tenants in Azure AD.</span></span>

<span data-ttu-id="14a4b-369">Подробные сведения о смене ключей Azure AD можно найти в документе hello: [важные сведения о подписи смене ключей в Azure AD](../active-directory/active-directory-signing-key-rollover.md).</span><span class="sxs-lookup"><span data-stu-id="14a4b-369">Detailed info on Azure AD key rollover can be found in hello document: [Important Information about Signing Key Rollover in Azure AD](../active-directory/active-directory-signing-key-rollover.md).</span></span>

<span data-ttu-id="14a4b-370">Между hello [пары открытого и закрытого ключей](https://login.microsoftonline.com/common/discovery/keys/),</span><span class="sxs-lookup"><span data-stu-id="14a4b-370">Between hello [public-private key pair](https://login.microsoftonline.com/common/discovery/keys/),</span></span>

* <span data-ttu-id="14a4b-371">Hello закрытый ключ используется с Azure Active Directory toogenerate маркера JWT;</span><span class="sxs-lookup"><span data-stu-id="14a4b-371">hello private key is used by Azure Active Directory toogenerate a JWT token;</span></span>
* <span data-ttu-id="14a4b-372">открытый ключ Hello используется приложением такие как службы доставки лицензий DRM в маркер JWT hello tooverify AMS;</span><span class="sxs-lookup"><span data-stu-id="14a4b-372">hello public key is used by an application such as DRM License Delivery Services in AMS tooverify hello JWT token;</span></span>

<span data-ttu-id="14a4b-373">В целях безопасности Azure Active Directory периодически проводит ротацию этого сертификата (каждые 6 недель).</span><span class="sxs-lookup"><span data-stu-id="14a4b-373">For security purpose, Azure Active Directory rotates this certificate periodically (every 6 weeks).</span></span> <span data-ttu-id="14a4b-374">В случае нарушения безопасности hello смены ключей может возникать любое время.</span><span class="sxs-lookup"><span data-stu-id="14a4b-374">In case of security breaches, hello key rollover can occur any time.</span></span> <span data-ttu-id="14a4b-375">Таким образом службы доставки лицензий hello в AMS должны tooupdate hello открытый ключ, используемый как Azure AD поворачивает hello пары ключей, в противном случае возникнет токена проверки подлинности в AMS и лицензия не будет выполняться.</span><span class="sxs-lookup"><span data-stu-id="14a4b-375">Therefore, hello license delivery services in AMS need tooupdate hello public key used as Azure AD rotates hello key pair, otherwise token authentication in AMS will fail and no license will be issued.</span></span>

<span data-ttu-id="14a4b-376">Это достигается путем установки TokenRestrictionTemplate.OpenIdConnectDiscoveryDocument при настройке службы доставки лицензий DRM.</span><span class="sxs-lookup"><span data-stu-id="14a4b-376">This is achieved by setting TokenRestrictionTemplate.OpenIdConnectDiscoveryDocument when configuring DRM license delivery services.</span></span>

<span data-ttu-id="14a4b-377">поток маркеров JWT Hello — как ниже:</span><span class="sxs-lookup"><span data-stu-id="14a4b-377">hello JWT token flow is as below:</span></span>

1. <span data-ttu-id="14a4b-378">Azure AD будет выдавать токен JWT hello hello текущего закрытым ключом для прошедшего проверку пользователя;</span><span class="sxs-lookup"><span data-stu-id="14a4b-378">Azure AD will issue hello JWT token with hello current private key for an authenticated user;</span></span>
2. <span data-ttu-id="14a4b-379">Когда проигрыватель видит CENC с несколькими защищенного DRM содержимым, он сначала будет находить hello маркера JWT, выданного Azure AD.</span><span class="sxs-lookup"><span data-stu-id="14a4b-379">When a player sees a CENC with multi-DRM protected content, it will first locate hello JWT token issued by Azure AD.</span></span>
3. <span data-ttu-id="14a4b-380">проигрыватель Hello отправляет запрос приобретения лицензии с помощью службы доставки toolicense маркера JWT hello в AMS;</span><span class="sxs-lookup"><span data-stu-id="14a4b-380">hello player sends license acquisition request with hello JWT token toolicense delivery services in AMS;</span></span>
4. <span data-ttu-id="14a4b-381">службы доставки лицензий Hello в AMS будет использовать hello текущего/допустимого открытого ключа из Azure AD токен JWT tooverify hello, перед выдачей лицензий.</span><span class="sxs-lookup"><span data-stu-id="14a4b-381">hello license delivery services in AMS will use hello current/valid public key from Azure AD tooverify hello JWT token, before issuing licenses.</span></span>

<span data-ttu-id="14a4b-382">Службы доставки лицензий DRM будет всегда проверяет наличие hello текущего/допустимого открытого ключа из Azure AD.</span><span class="sxs-lookup"><span data-stu-id="14a4b-382">DRM license delivery services will always be checking for hello current/valid public key from Azure AD.</span></span> <span data-ttu-id="14a4b-383">Hello открытый ключ, предоставленный Azure AD будет hello ключ, используемый для проверки маркера JWT, выданного Azure AD.</span><span class="sxs-lookup"><span data-stu-id="14a4b-383">hello public key presented by Azure AD will be hello key used for verifying a JWT token issued by Azure AD.</span></span>

<span data-ttu-id="14a4b-384">Что делать, если смены ключей hello происходит после AAD создает токен JWT, но перед hello JWT маркер отправляется проигрыватели tooDRM лицензии доставки службы, AMS для проверки?</span><span class="sxs-lookup"><span data-stu-id="14a4b-384">What if hello key rollover happens after AAD generates a JWT token but before hello JWT token is sent by players tooDRM license delivery services in AMS for verification?</span></span>

<span data-ttu-id="14a4b-385">Поскольку ключ может быть сменен в любой момент, всегда есть более одного допустимого открытого ключа в документе метаданных федерации hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-385">Because a key may be rolled at any moment, there is always more than one valid public key available in hello federation metadata document.</span></span> <span data-ttu-id="14a4b-386">Доставки лицензий Azure Media Services можно использовать любой из hello ключи указывать в документе hello, так как один ключ может быть сменен раньше, другой может оказаться его заменой и т. д.</span><span class="sxs-lookup"><span data-stu-id="14a4b-386">Azure Media Services license delivery can use any of hello keys specified in hello document, since one key may be rolled soon, another may be its replacement, and so forth.</span></span>

### <a name="where-is-hello-access-token"></a><span data-ttu-id="14a4b-387">Где hello токена доступа?</span><span class="sxs-lookup"><span data-stu-id="14a4b-387">Where is hello Access Token?</span></span>
<span data-ttu-id="14a4b-388">Просмотрите как веб-приложение вызывает приложение API в разделе [удостоверение приложения с предоставления учетных данных клиента OAuth 2.0](../active-directory/develop/active-directory-authentication-scenarios.md#web-application-to-web-api), hello порядок проверки подлинности состоит в том, как ниже:</span><span class="sxs-lookup"><span data-stu-id="14a4b-388">If you look at how a web app calls an API app under [Application Identity with OAuth 2.0 Client Credentials Grant](../active-directory/develop/active-directory-authentication-scenarios.md#web-application-to-web-api), hello authentication flow is as below:</span></span>

1. <span data-ttu-id="14a4b-389">Когда пользователь вошел в tooAzure AD в веб-приложение hello (hello в разделе [tooWeb веб-браузере приложений](../active-directory/develop/active-directory-authentication-scenarios.md#web-browser-to-web-application).</span><span class="sxs-lookup"><span data-stu-id="14a4b-389">A user is signed in tooAzure AD in hello web application (see hello [Web Browser tooWeb Application](../active-directory/develop/active-directory-authentication-scenarios.md#web-browser-to-web-application).</span></span>
2. <span data-ttu-id="14a4b-390">Конечная точка авторизации Hello Azure AD перенаправляет hello пользователя агента обратной toohello клиентское приложение с кодом авторизации.</span><span class="sxs-lookup"><span data-stu-id="14a4b-390">hello Azure AD authorization endpoint redirects hello user agent back toohello client application with an authorization code.</span></span> <span data-ttu-id="14a4b-391">агент пользователя Hello возвращает URI перенаправления toohello клиента авторизации кода приложения.</span><span class="sxs-lookup"><span data-stu-id="14a4b-391">hello user agent returns authorization code toohello client application’s redirect URI.</span></span>
3. <span data-ttu-id="14a4b-392">веб-приложение Hello должен tooacquire маркер доступа, чтобы она могла проверить подлинность веб-API toohello и получать hello требуемого ресурса.</span><span class="sxs-lookup"><span data-stu-id="14a4b-392">hello web application needs tooacquire an access token so that it can authenticate toohello web API and retrieve hello desired resource.</span></span> <span data-ttu-id="14a4b-393">Оно выполняет запрос tooAzure AD конечную точку токена, предоставляя hello учетных данных, идентификатора клиента и URI идентификатора приложения веб-API.</span><span class="sxs-lookup"><span data-stu-id="14a4b-393">It makes a request tooAzure AD’s token endpoint, providing hello credential, client ID, and web API’s application ID URI.</span></span> <span data-ttu-id="14a4b-394">Представляет tooprove код авторизации hello, hello пользователь дал свое согласие.</span><span class="sxs-lookup"><span data-stu-id="14a4b-394">It presents hello authorization code tooprove that hello user has consented.</span></span>
4. <span data-ttu-id="14a4b-395">Azure AD проверяет подлинность приложения hello и возвращает токен доступа JWT, используемые toocall hello веб-API.</span><span class="sxs-lookup"><span data-stu-id="14a4b-395">Azure AD authenticates hello application and returns a JWT access token that is used toocall hello web API.</span></span>
5. <span data-ttu-id="14a4b-396">По протоколу HTTPS hello веб-приложение использует hello hello tooadd токена доступа JWT строку JWT с назначением «bearer», возвращенная в заголовок авторизации hello hello запроса toohello веб-API.</span><span class="sxs-lookup"><span data-stu-id="14a4b-396">Over HTTPS, hello web application uses hello returned JWT access token tooadd hello JWT string with a “Bearer” designation in hello Authorization header of hello request toohello web API.</span></span> <span data-ttu-id="14a4b-397">Hello веб-API затем проверяет токен JWT hello, и если проверка прошла успешно, возвращает hello требуемого ресурса.</span><span class="sxs-lookup"><span data-stu-id="14a4b-397">hello web API then validates hello JWT token, and if validation is successful, returns hello desired resource.</span></span>

<span data-ttu-id="14a4b-398">В этой процедуре «удостоверение приложения» hello веб-API доверяет этой hello веб-приложения hello прошедшего проверку подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="14a4b-398">In this “application identity” flow, hello web API trusts that hello web application authenticated hello user.</span></span> <span data-ttu-id="14a4b-399">По этой причине данная схема называется доверенной (надежной) подсистемой.</span><span class="sxs-lookup"><span data-stu-id="14a4b-399">For this reason, this pattern is called a trusted subsystem.</span></span> <span data-ttu-id="14a4b-400">Hello [схемы на этой странице](https://docs.microsoft.com/azure/active-directory/active-directory-protocols-oauth-code) описывает, как работает поток разрешений кода авторизации.</span><span class="sxs-lookup"><span data-stu-id="14a4b-400">hello [diagram on this page](https://docs.microsoft.com/azure/active-directory/active-directory-protocols-oauth-code) describes how authorization code grant flow works.</span></span>

<span data-ttu-id="14a4b-401">При покупке лицензии с ограничения токенов, следуете hello подход и доверенной подсистемы.</span><span class="sxs-lookup"><span data-stu-id="14a4b-401">In license acquisition with token restriction, we are following hello same trusted subsystem pattern.</span></span> <span data-ttu-id="14a4b-402">И службы доставки лицензий hello в службах мультимедиа Azure является ресурсов веб-API hello, «внутренний ресурс» hello веб-приложению требуются tooaccess.</span><span class="sxs-lookup"><span data-stu-id="14a4b-402">And hello license delivery service in Azure Media Services is hello web API resource, hello “backend resource” a web application needs tooaccess.</span></span> <span data-ttu-id="14a4b-403">Таким образом, где маркер доступа hello?</span><span class="sxs-lookup"><span data-stu-id="14a4b-403">So where is hello access token?</span></span>

<span data-ttu-id="14a4b-404">В самом деле, мы получаем маркер доступа из Azure AD.</span><span class="sxs-lookup"><span data-stu-id="14a4b-404">Indeed, we are obtaining access token from Azure AD.</span></span> <span data-ttu-id="14a4b-405">После успешной проверки подлинности пользователя возвращается код авторизации.</span><span class="sxs-lookup"><span data-stu-id="14a4b-405">After successful user authentication, authorization code is returned.</span></span> <span data-ttu-id="14a4b-406">Код авторизации Hello затем используется вместе с ИД и приложения ключ клиента, tooexchange токена доступа.</span><span class="sxs-lookup"><span data-stu-id="14a4b-406">hello authorization code is then used, together with client ID and app key, tooexchange for access token.</span></span> <span data-ttu-id="14a4b-407">И hello маркер доступа для доступа приложения «указатель» выбрать команды и представляющий службы доставки лицензий служб мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="14a4b-407">And hello access token is for accessing a “pointer” application pointing or representing Azure Media Services license delivery service.</span></span>

<span data-ttu-id="14a4b-408">Нам нужна tooregister и настроить приложение hello «указатель» в Azure AD с помощью hello описанных ниже действий:</span><span class="sxs-lookup"><span data-stu-id="14a4b-408">We need tooregister and configure hello “pointer” app in Azure AD by following hello steps below:</span></span>

1. <span data-ttu-id="14a4b-409">В клиенте hello Azure AD</span><span class="sxs-lookup"><span data-stu-id="14a4b-409">In hello Azure AD tenant</span></span>

   * <span data-ttu-id="14a4b-410">добавьте приложение (ресурс) с URL-адресом входа:</span><span class="sxs-lookup"><span data-stu-id="14a4b-410">add an application (resource) with sign-on URL:</span></span>

   <span data-ttu-id="14a4b-411">https://[resource_name].azurewebsites.net/ и</span><span class="sxs-lookup"><span data-stu-id="14a4b-411">https://[resource_name].azurewebsites.net/ and</span></span>

   * <span data-ttu-id="14a4b-412">URL-адрес идентификатора приложения:</span><span class="sxs-lookup"><span data-stu-id="14a4b-412">app ID URL:</span></span>

   <span data-ttu-id="14a4b-413">https://[aad_tenant_name].onmicrosoft.com/[resource_name];</span><span class="sxs-lookup"><span data-stu-id="14a4b-413">https://[aad_tenant_name].onmicrosoft.com/[resource_name];</span></span>
2. <span data-ttu-id="14a4b-414">Добавьте новый раздел для приложения hello ресурсов;</span><span class="sxs-lookup"><span data-stu-id="14a4b-414">Add a new key for hello resource app;</span></span>
3. <span data-ttu-id="14a4b-415">Обновить файл манифеста приложения hello, чтобы свойства groupMembershipClaims hello hello следующие значения: «groupMembershipClaims»: «Все»</span><span class="sxs-lookup"><span data-stu-id="14a4b-415">Update hello app manifest file so that hello groupMembershipClaims property has hello following value: "groupMembershipClaims": "All",</span></span>  
4. <span data-ttu-id="14a4b-416">Добавьте в приложение hello Azure AD, указывающий toohello проигрывателя веб-приложения, в разделе "hello" «разрешения tooother приложений», приложение hello ресурсов, которая была добавлена в шаге 1 выше.</span><span class="sxs-lookup"><span data-stu-id="14a4b-416">In hello Azure AD app pointing toohello player web app, in hello section “permissions tooother applications”, add hello resource app which was added in step 1 above.</span></span> <span data-ttu-id="14a4b-417">В разделе "делегированные разрешения" проверьте флажок "Доступ [имя_ресурса]".</span><span class="sxs-lookup"><span data-stu-id="14a4b-417">Under “delegated permissions” check “Access [resource_name]” checkmark.</span></span> <span data-ttu-id="14a4b-418">Это дает hello веб-приложения разрешение toocreate токены доступа для доступа к ресурсу приложение hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-418">This gives hello web app permission toocreate access tokens for accessing hello resource app.</span></span> <span data-ttu-id="14a4b-419">Следует сделать для локальных и развернутой версии веб-приложения hello при разработке веб-приложения Visual Studio и Azure.</span><span class="sxs-lookup"><span data-stu-id="14a4b-419">You should do this for both local and deployed version of hello web app if you are developing with Visual Studio and Azure web app.</span></span>

<span data-ttu-id="14a4b-420">Таким образом hello маркера JWT, выданного Azure AD, на самом деле является hello маркер доступа для доступа к этому ресурсу «указатель».</span><span class="sxs-lookup"><span data-stu-id="14a4b-420">Therefore, hello JWT token issued by Azure AD is indeed hello access token for accessing this “pointer” resource.</span></span>

### <a name="what-about-live-streaming"></a><span data-ttu-id="14a4b-421">Как насчет динамической потоковой передачи?</span><span class="sxs-lookup"><span data-stu-id="14a4b-421">What about Live Streaming?</span></span>
<span data-ttu-id="14a4b-422">В приведенном выше hello нашего обсуждения сосредоточиться на активы по требованию.</span><span class="sxs-lookup"><span data-stu-id="14a4b-422">In hello above, our discussion has been focusing on on-demand assets.</span></span> <span data-ttu-id="14a4b-423">Как насчет динамической потоковой передачи?</span><span class="sxs-lookup"><span data-stu-id="14a4b-423">What about live streaming?</span></span>

<span data-ttu-id="14a4b-424">Hello хорошие новости состоит в том, что можно использовать точно hello же проектирования и реализации для защиты потоковой трансляции в службах мультимедиа Azure, рассматривая hello актив, связанный с программой как «актив VOD».</span><span class="sxs-lookup"><span data-stu-id="14a4b-424">hello good news is that you can use exactly hello same design and implementation for protecting live streaming in Azure Media Services, by treating hello asset associated with a program as a “VOD asset”.</span></span>

<span data-ttu-id="14a4b-425">В частности это хорошо известен, что toodo live streaming в службах мультимедиа Azure, необходимо toocreate канал, то программа hello канал.</span><span class="sxs-lookup"><span data-stu-id="14a4b-425">Specifically, it is well known that toodo live streaming in Azure Media Services, you need toocreate a channel, then a program under hello channel.</span></span> <span data-ttu-id="14a4b-426">Программа hello toocreate, необходимо toocreate актива, который будет содержать hello динамического архива для программы hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-426">toocreate hello program, you need toocreate an asset which will contain hello live archive for hello program.</span></span> <span data-ttu-id="14a4b-427">В порядке tooprovide CENC с несколькими DRM защиты hello содержимого в реальном времени, все, что нужно toodo, является tooapply hello одного средства обработки и установки toohello как если бы был «VOD активов», перед запуском программы hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-427">In order tooprovide CENC with multi-DRM protection of hello live content, all you need toodo, is tooapply hello same setup/processing toohello asset as if it was a “VOD asset” before you start hello program.</span></span>

### <a name="what-about-license-servers-outside-of-azure-media-services"></a><span data-ttu-id="14a4b-428">Как насчет серверов лицензирования за пределами служб мультимедиа Azure?</span><span class="sxs-lookup"><span data-stu-id="14a4b-428">What about license servers outside of Azure Media Services?</span></span>
<span data-ttu-id="14a4b-429">Часто пользователи могли вложить средства в ферму серверов лицензирования в собственном центре обработки данных или у поставщика услуг DRM.</span><span class="sxs-lookup"><span data-stu-id="14a4b-429">Often, customers may have invested in license server farm either in their own data center or hosted by DRM service providers.</span></span> <span data-ttu-id="14a4b-430">К счастью, Защита контента служб мультимедиа Azure позволяет вам toooperate в гибридном режиме: содержимое размещенных и динамически защищенные в Azure Media Services во время доставки лицензии DRM серверами за пределами Azure Media Services.</span><span class="sxs-lookup"><span data-stu-id="14a4b-430">Fortunately, Azure Media Services Content Protection allows you toooperate in hybrid mode: contents hosted and dynamically protected in Azure Media Services, while DRM licenses are delivered by servers outside Azure Media Services.</span></span> <span data-ttu-id="14a4b-431">В этом случае существует hello следующие вопросы об изменениях.</span><span class="sxs-lookup"><span data-stu-id="14a4b-431">In this case, there are hello following considerations of changes:</span></span>

1. <span data-ttu-id="14a4b-432">Hello службы токенов безопасности потребностей tooissue маркеров, которые являются допустимыми и могут быть проверены для фермы серверов лицензирования hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-432">hello Secure Token Service needs tooissue tokens which are acceptable and can be verified by hello license server farm.</span></span> <span data-ttu-id="14a4b-433">Например серверы лицензирования Widevine hello, предоставляемые Axinom требует определенного маркера JWT, содержащий «правах сообщение».</span><span class="sxs-lookup"><span data-stu-id="14a4b-433">For example, hello Widevine license servers provided by Axinom requires a specific JWT token which contains “entitlement message”.</span></span> <span data-ttu-id="14a4b-434">Поэтому необходимо toohave tooissue STS такой маркер JWT.</span><span class="sxs-lookup"><span data-stu-id="14a4b-434">Therefore, you need toohave an STS tooissue such JWT token.</span></span> <span data-ttu-id="14a4b-435">Авторы Hello завершены такой реализации и hello сведения можно найти в hello после документа в [центр документации Azure](https://azure.microsoft.com/documentation/): [toodeliver с помощью Axinom Widevine лицензий служб мультимедиа tooAzure](media-services-axinom-integration.md).</span><span class="sxs-lookup"><span data-stu-id="14a4b-435">hello authors have completed such an implementation and you can find hello details in hello following document in [Azure Documentation Center](https://azure.microsoft.com/documentation/): [Using Axinom toodeliver Widevine licenses tooAzure Media Services](media-services-axinom-integration.md).</span></span>
2. <span data-ttu-id="14a4b-436">Ненужные службы доставки лицензий tooconfigure (ContentKeyAuthorizationPolicy) в службах мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="14a4b-436">You no longer need tooconfigure license delivery service (ContentKeyAuthorizationPolicy) in Azure Media Services.</span></span> <span data-ttu-id="14a4b-437">Что необходимо toodo — tooprovide hello лицензии приобретения URL-адреса (PlayReady, Widevine и FairPlay) при настройке AssetDeliveryPolicy настройки CENC с несколькими DRM.</span><span class="sxs-lookup"><span data-stu-id="14a4b-437">What you need toodo is tooprovide hello license acquisition URLs (for PlayReady, Widevine and FairPlay) when you configure AssetDeliveryPolicy in setting up CENC with multi-DRM.</span></span>

### <a name="what-if-i-want-toouse-a-custom-sts"></a><span data-ttu-id="14a4b-438">Что делать, если требуется toouse собственной STS?</span><span class="sxs-lookup"><span data-stu-id="14a4b-438">What if I want toouse a custom STS?</span></span>
<span data-ttu-id="14a4b-439">Может быть несколько причин, которые клиент может выбрать toouse пользовательской службы маркеров безопасности (службы токенов безопасности) для предоставления токенов JWT.</span><span class="sxs-lookup"><span data-stu-id="14a4b-439">There could be a few reasons that a customer may choose toouse a custom STS (Secure Token Service) for providing JWT tokens.</span></span> <span data-ttu-id="14a4b-440">Ниже приведены некоторые из них.</span><span class="sxs-lookup"><span data-stu-id="14a4b-440">Some of them are:</span></span>

1. <span data-ttu-id="14a4b-441">Hello поставщика удостоверений (IDP) используется клиентом hello не поддерживает службы маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="14a4b-441">hello Identity Provider (IDP) used by hello customer does not support STS.</span></span> <span data-ttu-id="14a4b-442">В этом случае выходом может оказаться пользовательская STS.</span><span class="sxs-lookup"><span data-stu-id="14a4b-442">In this case a custom STS may be an option.</span></span>
2. <span data-ttu-id="14a4b-443">Hello клиента может потребоваться более гибкие или более строгого управления по интеграции службы маркеров безопасности с клиента подписчиков, выставления счетов системы.</span><span class="sxs-lookup"><span data-stu-id="14a4b-443">hello customer may need more flexible or tighter control in integrating STS with customer’s subscriber billing system.</span></span> <span data-ttu-id="14a4b-444">Например оператор MVPD может предложить несколько пакетов подписчик OTT, такие как спортивных premium, basic, оператор hello т. д. может потребоваться toomatch hello утверждений в токене с подписчика пакета, чтобы только содержимое в нужный пакет hello станет доступна.</span><span class="sxs-lookup"><span data-stu-id="14a4b-444">For example, an MVPD operator may offer multiple OTT subscriber packages such as premium, basic, sports, etc. hello operator may want toomatch hello claims in a token with a subscriber’s package so that only contents in hello right package is made available.</span></span> <span data-ttu-id="14a4b-445">В этом случае пользовательских маркеров безопасности предоставляет hello необходимости обеспечения гибкости и управляемости.</span><span class="sxs-lookup"><span data-stu-id="14a4b-445">In this case, a custom STS provides hello needed flexibility and control.</span></span>

<span data-ttu-id="14a4b-446">Два изменения необходимо учитывать при использовании собственной STS toobe:</span><span class="sxs-lookup"><span data-stu-id="14a4b-446">Two changes need toobe made when using a custom STS:</span></span>

1. <span data-ttu-id="14a4b-447">При настройке службы доставки лицензий для актива, необходимо toospecify hello безопасности ключ, используемый для проверки собственной STS hello (Подробнее см. ниже) вместо hello текущий ключ из Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="14a4b-447">When configuring license delivery service for an asset, you need toospecify hello security key used for verification by hello custom STS (more details below) instead of hello current key from Azure Active Directory.</span></span>
2. <span data-ttu-id="14a4b-448">Когда создается маркер JTW, ключ безопасности задается вместо hello закрытый ключ сертификата hello текущей X509 в Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="14a4b-448">When a JTW token is generated, a security key is specified instead of hello private key of hello current X509 certificate in Azure Active Directory.</span></span>

<span data-ttu-id="14a4b-449">Существует два типа ключей безопасности:</span><span class="sxs-lookup"><span data-stu-id="14a4b-449">There are two types of security keys:</span></span>

1. <span data-ttu-id="14a4b-450">Симметричный ключ: hello же ключ используется для создания и проверки маркера JWT;</span><span class="sxs-lookup"><span data-stu-id="14a4b-450">Symmetric key: hello same key is used for both generating and verifying a JWT token;</span></span>
2. <span data-ttu-id="14a4b-451">Асимметричный ключ: пару открытого и закрытого ключа в X509 используется сертификат с закрытым ключом для шифрования и создания JWT маркер и hello открытый ключ для проверки токена hello.</span><span class="sxs-lookup"><span data-stu-id="14a4b-451">Asymmetric key: a public-private key pair in an X509 certificate is used with private key for encrypting/generating a JWT token and hello public key for verifying hello token.</span></span>

#### <a name="tech-note"></a><span data-ttu-id="14a4b-452">Техническое примечание</span><span class="sxs-lookup"><span data-stu-id="14a4b-452">Tech note</span></span>
<span data-ttu-id="14a4b-453">При использовании .NET Framework и C# как платформу разработки, hello X509 сертификат, используемый для асимметричный ключ должен иметь длину ключа по крайней мере 2048.</span><span class="sxs-lookup"><span data-stu-id="14a4b-453">If you use .NET Framework/C# as your development platform, hello X509 certificate used for asymmetric security key must have key length at least 2048.</span></span> <span data-ttu-id="14a4b-454">Это требование hello класса System.IdentityModel.Tokens.X509AsymmetricSecurityKey в .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="14a4b-454">This is a requirement of hello class System.IdentityModel.Tokens.X509AsymmetricSecurityKey in .NET Framework.</span></span> <span data-ttu-id="14a4b-455">В противном случае будет создано hello следующие исключения:</span><span class="sxs-lookup"><span data-stu-id="14a4b-455">Otherwise, hello following exception will be thrown:</span></span>

<span data-ttu-id="14a4b-456">IDX10630: hello «System.IdentityModel.Tokens.X509AsymmetricSecurityKey» для подписи не может быть меньше, чем "2048" bits.</span><span class="sxs-lookup"><span data-stu-id="14a4b-456">IDX10630: hello 'System.IdentityModel.Tokens.X509AsymmetricSecurityKey' for signing cannot be smaller than '2048' bits.</span></span>

## <a name="hello-completed-system-and-test"></a><span data-ttu-id="14a4b-457">система Hello завершена и тестирования</span><span class="sxs-lookup"><span data-stu-id="14a4b-457">hello completed system and test</span></span>
<span data-ttu-id="14a4b-458">Мы рассмотрим несколько сценариев в системе hello завершения начала до конца, чтобы читатели могут иметь basic hello поведение «изображение» до получения учетной записи входа.</span><span class="sxs-lookup"><span data-stu-id="14a4b-458">We will walk through a few scenarios in hello completed end-to-end system so that readers can have a basic “picture” of hello behavior before getting a login account.</span></span>

<span data-ttu-id="14a4b-459">Hello проигрывателя веб-приложения и его имя входа можно найти [здесь](https://openidconnectweb.azurewebsites.net/).</span><span class="sxs-lookup"><span data-stu-id="14a4b-459">hello player web application and its login can be found [here](https://openidconnectweb.azurewebsites.net/).</span></span>

<span data-ttu-id="14a4b-460">Если необходим сценарий «неинтегрированному»: видео активы размещенного в службах мультимедиа Azure, являются либо незащищенными или защищенного DRM, но без проверки подлинности маркера (выдачи toowhoever лицензии, запрашивая его), можно проверить его без имени входа (путем переключения tooHTTP в случае видео потоковой передачи по протоколу HTTP).</span><span class="sxs-lookup"><span data-stu-id="14a4b-460">If what you need is “non-integrated” scenario: video assets hosted in Azure Media Services which are either unprotected, or DRM protected but without token authentication (issuing a license toowhoever requesting it), you can test it without login (by switching tooHTTP if your video streaming is over HTTP).</span></span>

<span data-ttu-id="14a4b-461">Если необходим сценарий интеграции конца в конец: видео активы находится под динамического защиты DRM в службах мультимедиа Azure с помощью маркера проверки подлинности и маркер JWT, создаваемый с помощью Azure AD, вы должны toologin.</span><span class="sxs-lookup"><span data-stu-id="14a4b-461">If what you need is end-to-end integrated scenario: video assets is under dynamic DRM protection in Azure Media Services, with token authentication and JWT token being generated by Azure AD, you need toologin.</span></span>

### <a name="user-login"></a><span data-ttu-id="14a4b-462">Вход пользователя</span><span class="sxs-lookup"><span data-stu-id="14a4b-462">User login</span></span>
<span data-ttu-id="14a4b-463">Порядок tootest hello конца в конец интегрированной системе DRM нужен toohave «учетная запись», либо добавленный.</span><span class="sxs-lookup"><span data-stu-id="14a4b-463">In order tootest hello end-to-end integrated DRM system, you need toohave an “account” created or added.</span></span>

<span data-ttu-id="14a4b-464">Какую учетную запись?</span><span class="sxs-lookup"><span data-stu-id="14a4b-464">What account?</span></span>

<span data-ttu-id="14a4b-465">Хотя изначально система Azure разрешала доступ только пользователям учетных записей Майкрософт, теперь она позволяет получать доступ пользователям обеих систем.</span><span class="sxs-lookup"><span data-stu-id="14a4b-465">Although Azure originally allowed access only by Microsoft account users, it now allows access by users from both systems.</span></span> <span data-ttu-id="14a4b-466">Это было сделано, задав свойства Azure доверяют все hello Azure AD для проверки подлинности, с Azure AD, выполняет проверку подлинности пользователей организации и создания отношения федерации где Azure AD доверяет система идентификаторов клиента учетных записей Microsoft hello Пользователи tooauthenticate потребителя.</span><span class="sxs-lookup"><span data-stu-id="14a4b-466">This was done by having all hello Azure properties trust Azure AD for authentication, having Azure AD authenticate organizational users, and by creating a federation relationship where Azure AD trusts hello Microsoft account consumer identity system tooauthenticate consumer users.</span></span> <span data-ttu-id="14a4b-467">В результате Azure AD — учетные записи Майкрософт может tooauthenticate «Гость», а также «собственные» учетные записи Azure AD.</span><span class="sxs-lookup"><span data-stu-id="14a4b-467">As a result, Azure AD is able tooauthenticate “guest” Microsoft accounts as well as “native” Azure AD accounts.</span></span>

<span data-ttu-id="14a4b-468">Поскольку Azure AD доверяет домену учетной записи Майкрософт (MSA), можно добавить все учетные записи из любого hello следующие домены toohello пользовательские Azure AD для клиента и использовать toologin hello учетной записи:</span><span class="sxs-lookup"><span data-stu-id="14a4b-468">Since Azure AD trusts Microsoft Account (MSA) domain, you can add any accounts from any of hello following domains toohello custom Azure AD tenant and use hello account toologin:</span></span>

| <span data-ttu-id="14a4b-469">**Доменное имя**</span><span class="sxs-lookup"><span data-stu-id="14a4b-469">**Domain Name**</span></span> | <span data-ttu-id="14a4b-470">**Домен**</span><span class="sxs-lookup"><span data-stu-id="14a4b-470">**Domain**</span></span> |
| --- | --- |
| <span data-ttu-id="14a4b-471">**Домен пользовательского клиента Azure AD**</span><span class="sxs-lookup"><span data-stu-id="14a4b-471">**Custom Azure AD tenant domain**</span></span> |<span data-ttu-id="14a4b-472">somename.onmicrosoft.com</span><span class="sxs-lookup"><span data-stu-id="14a4b-472">somename.onmicrosoft.com</span></span> |
| <span data-ttu-id="14a4b-473">**Домен организации**</span><span class="sxs-lookup"><span data-stu-id="14a4b-473">**Corporate domain**</span></span> |<span data-ttu-id="14a4b-474">microsoft.com</span><span class="sxs-lookup"><span data-stu-id="14a4b-474">microsoft.com</span></span> |
| <span data-ttu-id="14a4b-475">**Домен учетных записей Майкрософт (MSA)**</span><span class="sxs-lookup"><span data-stu-id="14a4b-475">**Microsoft Account (MSA) domain**</span></span> |<span data-ttu-id="14a4b-476">outlook.com, live.com, hotmail.com</span><span class="sxs-lookup"><span data-stu-id="14a4b-476">outlook.com, live.com, hotmail.com</span></span> |

<span data-ttu-id="14a4b-477">Вы можете связаться со всех авторов hello toohave создании или добавлено учетную запись.</span><span class="sxs-lookup"><span data-stu-id="14a4b-477">You may contact any of hello authors toohave an account created or added for you.</span></span>

<span data-ttu-id="14a4b-478">Ниже приведены снимки экрана приветствия страниц другого имени входа, используемые разными учетными записями домена.</span><span class="sxs-lookup"><span data-stu-id="14a4b-478">Below are hello screenshots of different login pages used by different domain accounts.</span></span>

<span data-ttu-id="14a4b-479">**Учетная запись домена для клиента пользовательские Azure AD**: В этом случае отображается страница hello пользовательское имя входа домена клиента hello пользовательских Azure AD.</span><span class="sxs-lookup"><span data-stu-id="14a4b-479">**Custom Azure AD tenant domain account**: In this case, you see hello customized login page of hello custom Azure AD tenant domain.</span></span>

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain1.png)

<span data-ttu-id="14a4b-481">**Учетная запись домена Microsoft с помощью смарт-карт**: В этом случае отображается страница входа hello настройки с помощью Microsoft корпоративных ИТ с двухфакторной проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="14a4b-481">**Microsoft domain account with smart card**: In this case you see hello login page customized by Microsoft corporate IT with two-factor authentication.</span></span>

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain2.png)

<span data-ttu-id="14a4b-483">**Учетная запись Майкрософт (MSA)**: В этом случае отображается страница входа hello учетной записи Майкрософт для потребителей.</span><span class="sxs-lookup"><span data-stu-id="14a4b-483">**Microsoft Account (MSA)**: In this case, you see hello login page of Microsoft Account for consumers.</span></span>

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain3.png)

### <a name="using-encrypted-media-extensions-for-playready"></a><span data-ttu-id="14a4b-485">Использование расширений зашифрованных носителей для PlayReady</span><span class="sxs-lookup"><span data-stu-id="14a4b-485">Using Encrypted Media Extensions for PlayReady</span></span>
<span data-ttu-id="14a4b-486">На современных браузера с зашифрованные мультимедиа расширения (EME) для поддержки, например браузер IE 11 на Windows 8.1 и выше, а также Microsoft Edge в Windows 10, PlayReady будет PlayReady hello базовой DRM для EME.</span><span class="sxs-lookup"><span data-stu-id="14a4b-486">On a modern browser with Encrypted Media Extensions (EME) for PlayReady support, such as IE 11 on Windows 8.1 and up, and Microsoft Edge browser on Windows 10, PlayReady will be hello underlying DRM for EME.</span></span>

![Использование EME для PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready1.png)

<span data-ttu-id="14a4b-488">область темной проигрывателя Hello, — из-за toohello фактов защиты PlayReady не допускает один делать снимки экрана защищенного видео.</span><span class="sxs-lookup"><span data-stu-id="14a4b-488">hello dark player area is due toohello fact that PlayReady protection prevents one from making screen capture of protected video.</span></span>

<span data-ttu-id="14a4b-489">Hello следующий экран показывает подключаемых модулей проигрывателя hello и поддержку MSE/EME.</span><span class="sxs-lookup"><span data-stu-id="14a4b-489">hello following screen shows hello player plugins and MSE/EME support.</span></span>

![Использование EME для PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready2.png)

<span data-ttu-id="14a4b-491">EME в Microsoft Edge и IE 11 в Windows 10 позволяет вызывать из [PlayReady SL3000](https://www.microsoft.com/playready/features/EnhancedContentProtection.aspx/) на устройствах Windows 10, которые ее поддерживают.</span><span class="sxs-lookup"><span data-stu-id="14a4b-491">EME in Microsoft Edge and IE 11 on Windows 10 allows invoking of [PlayReady SL3000](https://www.microsoft.com/playready/features/EnhancedContentProtection.aspx/) on Windows 10 devices which support it.</span></span> <span data-ttu-id="14a4b-492">PlayReady SL3000 разблокирует hello потока содержимого улучшенные premium (4 КБ, HDR, т. д.) и новые модели доставки содержимого (раннее окно расширенного содержимого).</span><span class="sxs-lookup"><span data-stu-id="14a4b-492">PlayReady SL3000 unlocks hello flow of enhanced premium content (4K, HDR, etc.) and new content delivery models (early window for Enhanced Content).</span></span>

<span data-ttu-id="14a4b-493">Сосредоточиться на устройствах Windows hello: PlayReady hello только DRM в HW hello, доступное на устройствах Windows (PlayReady SL3000).</span><span class="sxs-lookup"><span data-stu-id="14a4b-493">Focus on hello Windows devices: PlayReady is hello only DRM in hello HW available on Windows devices (PlayReady SL3000).</span></span> <span data-ttu-id="14a4b-494">Служба потоковой передачи может использовать PlayReady через EME или приложение UWP. Благодаря PlayReady SL3000 она предлагает более высокое качество видеоизображения, чем другие DRM.</span><span class="sxs-lookup"><span data-stu-id="14a4b-494">A streaming service can use PlayReady through EME or through a UWP application and offer a higher video quality using PlayReady SL3000 than another DRM.</span></span> <span data-ttu-id="14a4b-495">Как правило содержимое 2 КБ будет проходить через Chrome или Firefox и 4 K содержимого через Microsoft Edge/IE11 или в приложении UWP на hello одного устройства (в зависимости от параметров службы и реализация).</span><span class="sxs-lookup"><span data-stu-id="14a4b-495">Typically, 2K content will flow through Chrome or Firefox, and 4K content through Microsoft Edge/IE11 or a UWP application on hello same device (depending on service settings and implementation).</span></span>

#### <a name="using-eme-for-widevine"></a><span data-ttu-id="14a4b-496">Использование EME для Widevine</span><span class="sxs-lookup"><span data-stu-id="14a4b-496">Using EME for Widevine</span></span>
<span data-ttu-id="14a4b-497">На современных браузер с поддержкой EME/Widevine, такие как Chrome 41 + в Windows 10, Windows 8.1, Mac OS x Yosemite и хром на Android 4.4.4 Google Widevine — hello DRM за EME.</span><span class="sxs-lookup"><span data-stu-id="14a4b-497">On a modern browser with EME/Widevine support, such as Chrome 41+ on Windows 10, Windows 8.1, Mac OSX Yosemite, and Chrome on Android 4.4.4, Google Widevine is hello DRM behind EME.</span></span>

![Использование EME для Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine1.png)

<span data-ttu-id="14a4b-499">Обратите внимание, что Widevine не запрещает делать снимок экрана защищенного видео.</span><span class="sxs-lookup"><span data-stu-id="14a4b-499">Notice that Widevine does not prevent one from making screen capture of protected video.</span></span>

![Использование EME для Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine2.png)

### <a name="not-entitled-users"></a><span data-ttu-id="14a4b-501">Пользователи, не имеющие прав</span><span class="sxs-lookup"><span data-stu-id="14a4b-501">Not entitled users</span></span>
<span data-ttu-id="14a4b-502">Если пользователь не является членом группы «Пользователи под названием», hello пользователя не может toopass «проверка прав» и служба лицензий multi DRM hello откажут tooissue hello запрошенную лицензию, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="14a4b-502">If a user is not a member of "Entitled Users" group, hello user will not be able toopass “entitlement check” and hello multi-DRM license service will refuse tooissue hello requested license as shown below.</span></span> <span data-ttu-id="14a4b-503">Hello подробное описание — «получения лицензии не удалось выполнить», это, как было задумано.</span><span class="sxs-lookup"><span data-stu-id="14a4b-503">hello detailed description is “License acquire failed”, which is as designed.</span></span>

![Пользователи без прав](./media/media-services-cenc-with-multidrm-access-control/media-services-unentitledusers.png)

### <a name="running-custom-secure-token-service"></a><span data-ttu-id="14a4b-505">Использование пользовательской службы маркеров безопасности</span><span class="sxs-lookup"><span data-stu-id="14a4b-505">Running custom Secure Token Service</span></span>
<span data-ttu-id="14a4b-506">Для сценария hello выполнения пользовательских службу токенов безопасности (STS) токен JWT hello будет выданного службой маркеров безопасности пользовательских hello с помощью асимметричного или симметричного ключа.</span><span class="sxs-lookup"><span data-stu-id="14a4b-506">For hello scenario of running custom Secure Token Service (STS), hello JWT token will be issued by hello custom STS using either symmetric or asymmetric key.</span></span>

<span data-ttu-id="14a4b-507">Hello вариант использования симметричного ключа (с помощью Chrome).</span><span class="sxs-lookup"><span data-stu-id="14a4b-507">hello case of using symmetric key (using Chrome):</span></span>

![Выполнение пользовательской STS](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts1.png)

<span data-ttu-id="14a4b-509">Здравствуйте, регистр с помощью асимметричного ключа через X509 сертификат (с помощью Microsoft современного браузера).</span><span class="sxs-lookup"><span data-stu-id="14a4b-509">hello case of using asymmetric key via an X509 certificate (using Microsoft modern browser).</span></span>

![Выполнение пользовательской STS](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts2.png)

<span data-ttu-id="14a4b-511">В обоих hello выше вариантов проверки подлинности пользователь остается hello же — через Azure AD.</span><span class="sxs-lookup"><span data-stu-id="14a4b-511">In both of hello above cases, user authentication stays hello same – through Azure AD.</span></span> <span data-ttu-id="14a4b-512">Hello отличается только что маркеры JWT выдаются hello собственной STS вместо Azure AD.</span><span class="sxs-lookup"><span data-stu-id="14a4b-512">hello only difference is that JWT tokens are issued by hello custom STS instead of Azure AD.</span></span> <span data-ttu-id="14a4b-513">Конечно, при настройке защиты динамические CENC, ограничение hello службы доставки лицензий указывает тип hello маркера JWT симметричный или асимметричный ключ.</span><span class="sxs-lookup"><span data-stu-id="14a4b-513">Of course, when configuring dynamic CENC protection, hello restriction of license delivery service specifies hello type of JWT token, either symmetric or asymmetric key.</span></span>

## <a name="summary"></a><span data-ttu-id="14a4b-514">Сводка</span><span class="sxs-lookup"><span data-stu-id="14a4b-514">Summary</span></span>
<span data-ttu-id="14a4b-515">В этом документе мы обсуждали CENC с несколькими собственными DRM и контролем доступа через проверку подлинности маркера: проектирование и реализацию системы с помощью Azure, служб мультимедиа Azure и Проигрывателя мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="14a4b-515">In this document, we discussed CENC with multi-native-DRM and access control via token authentication: its design and its implementation using Azure, Azure Media Services and Azure Media Player.</span></span>

* <span data-ttu-id="14a4b-516">Схема представляется которого содержит все необходимые компоненты hello в подсистеме управления цифровыми правами/CENC;</span><span class="sxs-lookup"><span data-stu-id="14a4b-516">A reference design is presented which contains all hello necessary components in a DRM/CENC subsystem;</span></span>
* <span data-ttu-id="14a4b-517">справочную реализацию в Azure, службах мультимедиа Azure и Проигрывателе мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="14a4b-517">A reference implementation on Azure, Azure Media Services and Azure Media Player.</span></span>
* <span data-ttu-id="14a4b-518">Также рассматриваются некоторые вопросы, непосредственно участвующих в hello проектирования и реализации.</span><span class="sxs-lookup"><span data-stu-id="14a4b-518">Some topics directly involved in hello design and implementation are also discussed.</span></span>

## <a name="media-services-learning-paths"></a><span data-ttu-id="14a4b-519">Схемы обучения работе со службами мультимедиа</span><span class="sxs-lookup"><span data-stu-id="14a4b-519">Media Services learning paths</span></span>
[!INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a><span data-ttu-id="14a4b-520">Отзывы</span><span class="sxs-lookup"><span data-stu-id="14a4b-520">Provide feedback</span></span>
[!INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]
 

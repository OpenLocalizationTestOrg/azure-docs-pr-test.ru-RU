---
title: "CENC с несколькими DRM и контролем доступа: справочное проектирование и реализация в Azure и службах мультимедиа Azure | Документация Майкрософт"
description: "Дополнительные сведения о том, как toolicensing hello Microsoft® Smooth Streaming Client Porting Kit."
services: media-services
documentationcenter: 
author: willzhan
manager: cfowler
editor: 
ms.assetid: 7814739b-cea9-4b9b-8370-538702e5c615
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/19/2017
ms.author: willzhan;kilroyh;yanmf;juliako
ms.openlocfilehash: 033fb618650c4fbe9069d467159a8734da759bba
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="cenc-with-multi-drm-and-access-control-a-reference-design-and-implementation-on-azure-and-azure-media-services"></a>CENC с несколькими DRM и управление доступом: справочное проектирование и реализация в Azure и Azure Media Services
 
## <a name="introduction"></a>Введение
Это хорошо известен, что он toodesign сложной задачей и построить подсистемы управления цифровыми правами для OTT или online решений потоковой передачи. И обычное практики для операторов и оперативного toooutsource видео поставщиков этой части toospecialized DRM поставщиков. Hello цель данного документа — toopresent конструктора ссылки и реализации подсистемы DRM конца в конец OTT или интерактивной потоковой передачи решения.

целевые Hello чтения этого документа являются инженеров, работа в подсистеме управления цифровыми правами OTT или интерактивной потоковой передачи или несколькими-экрана решений, или любые средства чтения, заинтересованных в подсистеме управления цифровыми правами. Hello предполагается, что читатели знакомы с по крайней мере один из технологии DRM hello на рынок hello, например PlayReady, Widevine, FairPlay или Adobe Access.

Под DRM также понимается CENC (стандартное шифрование) с несколькими DRM. Основные тенденции в интерактивной потоковой передачи и отраслевыми OTT имеет toouse CENC с несколькими-native-DRM на различных платформах клиента, переход от предыдущего тренда hello использования единого управления цифровыми правами и клиентского пакета SDK для различных клиентских платформ; При использовании CENC с несколькими native DRM, шифрование PlayReady и Widevine каждого hello [общее шифрование (CENC ISO/IEC 23001-7)](http://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm?csnumber=65271/) спецификации.

Ниже приведены преимущества Hello CENC с несколькими DRM.

1. Снижается стоимость шифрования, так как используется единая обработка шифрования для разных платформ с собственными DRM.
2. Уменьшает hello затраты на управление зашифрованные активы, поскольку требуется только одна копия зашифрованные активы;
3. Исключает DRM клиент лицензирования затрат, поскольку собственный клиент DRM hello обычно свободного места на его собственной платформы.

Майкрософт является активным распространителем DASH и CENC вместе с некоторыми крупнейшими компаниями отрасли. Службы мультимедиа Microsoft Azure предлагают поддержку DASH и CENC. Последние объявления см. в блогах Мингфея: [Представление служб доставки лицензий Google Widevine в службах мультимедиа Azure](https://azure.microsoft.com/blog/announcing-general-availability-of-google-widevine-license-services/) и [Службы мультимедиа Azure добавляют пакет Google Widevine для предоставления потока с несколькими DRM](https://azure.microsoft.com/blog/azure-media-services-adds-google-widevine-packaging-for-delivering-multi-drm-stream/).  

### <a name="overview-of-this-article"></a>Описание раздела
Hello цель этой статьи включает следующие hello.

1. Предоставляет справочное проектирование подсистемы DRM с помощью CENC с несколькими DRM.
2. Предоставляет справочную реализацию на платформе Microsoft Azure или служб мультимедиа Azure.
3. Рассматривает некоторые вопросы проектирования и реализации.

В статье hello «multi-DRM» рассматриваются hello следующее:

1. Microsoft PlayReady
2. Google Widevine
3. Apple FairPlay 

Hello следующей таблице перечислены собственного платформы/собственное приложение hello и браузеров, поддерживаемых каждой DRM.

| **Платформа клиента** | **Поддержка собственного DRM** | **Браузер или приложение** | **Форматы потоковой передачи** |
| --- | --- | --- | --- |
| **Смарт-ТВ, операторские STB, OTT STB** |В основном PlayReady и (или) Widevine и (или) другие |Linux, Opera и WebKit, другие |Различные форматы |
| **Устройства Windows 10 (ПК Windows, планшеты Windows, Windows Phone, Xbox)** |PlayReady |MS Edge/IE11/EME<br/><br/><br/>UWP |DASH (PlayReady не поддерживается для HLS)<br/><br/>DASH, Smooth Streaming (PlayReady не поддерживается для HLS) |
| **Устройства Android (телефоны, планшеты, телевизоры)** |Widevine |Chrome или EME |DASH, HLS |
| **iOS (iPhone, iPad), клиенты OS X и Apple TV** |FairPlay |Safari 8+ или EME |HLS |


Учитывая hello текущее состояние развертывания для каждого DRM, службы обычно требуется убедиться, что адреса всех типов конечных точек в наиболее hello hello toomake DRMs tooimplement 2 или 3 способом.

Обеспечивает компромисс между hello сложности hello логики служб и сложности hello на приветствия клиента стороне tooreach уровня пользователя взаимодействие hello различных клиентов.

toomake сделанного выбора, имейте в виду следующие факты:

* Технология PlayReady изначально реализована на всех устройствах Windows, на некоторых устройствах Android и доступна в пакетах SDK программ практически на любой платформе.
* Widevine изначально реализована на каждом устройстве Android, Chrome и некоторых других устройствах.
* Технология FairPlay доступна только на клиентах iOS и Mac OS или через iTunes.

Поэтому обычные несколько DRM будут выглядеть следующим образом:

* Вариант 1. PlayReady и Widevine
* Вариант 2. PlayReady, Widevine и FairPlay

## <a name="a-reference-design"></a>Справочное проектирование
В этом разделе мы представим ссылки проект, который является tooimplement независимые tootechnologies использовать его.

Подсистема DRM может содержать hello следующие компоненты:

1. Управление ключами
2. Упаковка DRM
3. Доставка лицензий DRM
4. Проверка прав
5. Проверка подлинности и авторизация
6. Проигрыватель
7. Происхождение и CDN

Hello следующая диаграмма иллюстрирует hello высокий уровень взаимодействием между компонентами hello в подсистеме управления цифровыми правами.

![Подсистема DRM с CENC](./media/media-services-cenc-with-multidrm-access-control/media-services-generic-drm-subsystem-with-cenc.png)

Существует три основных» уровня» hello разработки:

1. Уровень главного офиса (обозначен черным цветом), который не предоставляется внешним объектам.
2. Слой «DMZ» (синий), содержащий все конечные точки hello, расположенных лицевой стороной открытый;
3. Уровень общедоступного Интернета (светло-синий), содержащий CDN и проигрыватели с трафиком через общедоступный Интернет.

Должно быть средство управления содержимым для контроля защиты DRM независимо от используемого шифрования (статического или динамического). Hello входных данных для управления цифровыми правами шифрования должен содержать:

1. видеосодержимое MBR;
2. ключ содержимого;
3. URL-адреса для приобретения лицензии.

Во время воспроизведения имеет высокий уровень потока hello:

1. проверку подлинности пользователя;
2. Создается маркер авторизации для пользователя hello.
3. Содержимое защищенного DRM (манифест) является загруженный tooplayer;
4. Игрок дает серверы toolicense запрос приобретения лицензий вместе с ключом идентификатор и авторизации маркера.

До перемещения следующего раздела toohello несколько слов о hello разработки управления ключами.

| **Ключ содержимого/ресурс** | **Сценарий** |
| --- | --- |
| 1 ключ/1 ресурс |простейшем случае Hello. Он предоставляет точного контроля hello. Однако обычно это приводит к hello Максимальная стоимость доставки лицензий. Для каждого защищенного ресурса требуется минимум один запрос лицензии. |
| 1 ключ/несколько ресурсов |Можно использовать hello содержимого ключ для нескольких средств. Например для всех средств hello в логическую группу, например жанр или подмножество жанра (или фильма Созд), можно использовать один ключ содержимого. |
| Несколько ключей/1 ресурс |Несколько ключей содержимого необходимы для каждого ресурса. <br/><br/>Например если требуется защиты динамические CENC tooapply с несколькими DRM для динамического шифрования AES-128 для HLS и MPEG-DASH, необходимо два отдельных ключей контента, каждый из которых свой собственный ContentKeyType. (Для hello содержимого ключ, используемый для защиты динамические CENC, ContentKeyType.CommonEncryption должен использоваться, пока для содержимого, что ключ, используемый для динамического шифрования AES-128, ContentKeyType.EnvelopeEncryption должен использоваться hello.)<br/><br/>Еще один пример, в защите CENC штриха содержимого в теории, один ключ содержимого могут быть используется tooprotect потока видео и другого содержимого ключа tooprotect звуковой поток. |
| Многие — слишком многим |Сочетание hello выше два сценария: один набор содержимого, ключи используются для каждого из hello нескольких средств в hello же средства «группа». |

Другим важным фактором tooconsider — использование hello постоянных и временных лицензий.

Почему эти вопросы важны?

Они имеют прямое влияние toolicense доставки затрат при использовании общедоступного облака для доставки лицензий. Рассмотрим следующие два tooillustrate случаях другую структуру hello.

1. Ежемесячная подписка: используйте постоянную лицензию и 1 ключ содержимого для нескольких ресурсов. Например:  все hello детей фильмов мы используем один ключ содержимого для шифрования. В данном случае:

    Общее число лицензий, запрашиваемых для всех детских фильмов или устройств = 1
2. Ежемесячная подписка: используйте временную лицензию и 1 ключ содержимого для 1 ресурса. В данном случае:

    Общее число лицензий, запрашиваемых для всех детских фильмов или устройств = [число просмотренных фильмов] x [число сеансов]

Как можно легко увидеть, hello двумя различными вариантами привести к совершенно разные лицензии запрос таким образом шаблонов затрат в общедоступном облаке, такие как службы мультимедиа Azure Если службы доставки лицензий служб доставки лицензий.

## <a name="mapping-design-tootechnology-for-implementation"></a>Сопоставление tootechnology проектирования для реализации
Далее мы сопоставим нашей tootechnologies универсального разработки на платформе Microsoft Azure и Azure Media Services, указав, какие технологии toouse для каждого стандартного блока.

Hello следующей таблице показано сопоставление hello.

| **Стандартный блок** | **Технология** |
| --- | --- |
| **Проигрыватель** |[Проигрыватель мультимедиа Azure](https://azure.microsoft.com/services/media-services/media-player/) |
| **Поставщик удостоверений (IDP)** |Azure Active Directory |
| **Служба маркеров безопасности (STS)** |Azure Active Directory |
| **Рабочий процесс защиты DRM** |Динамическая защита служб мультимедиа Azure |
| **Доставка лицензий DRM** |1. Доставка лицензий служб мультимедиа Azure (PlayReady, Widevine, FairPlay), или <br/>2. Axinom License Server, <br/>3. Пользовательский сервер лицензирования PlayReady |
| **Исходный домен** |Конечная точка потоковой передачи служб мультимедиа Azure |
| **Управление ключами** |Не требуется для справочной реализации |
| **Управление содержимым** |Консольное приложение C# |

Другими словами, и поставщиком удостоверений (IDP), и службой маркеров безопасности (STS) будет Azure AD. Для проигрывателя мы будем использовать [API Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/). Службы мультимедиа Azure и Проигрыватель Мультимедиа Azure поддерживают DASH и CENC с несколькими DRM.

Следующая схема показывает Hello hello общую структуру и потока с hello выше технологии сопоставления.

![CENC на AMS](./media/media-services-cenc-with-multidrm-access-control/media-services-cenc-subsystem-on-AMS-platform.png)

В порядке tooset динамическое шифрование CENC средство управления содержимым hello будет использовать hello следующие входные данные:

1. открывание содержимого;
2. ключ содержимого из раздела создания и управления ключом;
3. URL-адреса для приобретения лицензии;
4. список сведений из Azure AD.

Hello выходные данные средства управления содержимым hello будет:

1. ContentKeyAuthorizationPolicy, содержащих спецификацию hello на способ доставки лицензий проверяет маркер JWT и спецификации лицензии DRM;
2. AssetDeliveryPolicy, содержащая спецификации потоковых форматов, защиту DRM и URL-адреса приобретения лицензий.

Во время выполнения, hello поток выглядит как ниже:

1. После проверки подлинности пользователя создается маркер JWT.
2. Одним из hello утверждений, содержащихся в токене JWT hello является утверждение «groups», содержащая идентификатор группы hello объекта «EntitledUserGroup». Это утверждение будет использоваться для передачи "проверка права".
3. Проигрыватель загрузки клиента манифест CENC защищенного содержимого и «видит» hello следующее:

   1. идентификатор ключа;
   2. Hello содержимое будет защищен, CENC
   3. URL-адреса для приобретения лицензии.
4. Проигрыватель делает запрос приобретения лицензии, зависимости от браузера hello/поддерживается DRM. В запрос приобретения лицензии hello, ключа идентификатора и hello JWT будут также отправлены маркер. Служба доставки лицензий проверит маркер JWT hello и hello утверждения перед выдачи hello необходимых лицензий.

## <a name="implementation"></a>Реализация
### <a name="implementation-procedures"></a>Процедуры реализации
Реализация Hello содержит hello следующие шаги:

1. Подготовка средства тестирования: кодирования или упаковки теста toomulti скорость видео фрагментированном формате MP4 в службах мультимедиа Azure. Этот ресурс НЕ защищен DRM. Защита DRM будет реализована позже с помощью динамической защиты.
2. Создание идентификатора ключа и ключа содержимого (при необходимости из начального значения). Для наших целей система управления ключами не требуется, поскольку мы имеем дело только с одним набором идентификатора ключа и ключа содержимого для нескольких тестовых ресурсов.
3. Использование служб доставки лицензий DRM несколькими tooconfigure AMS API для средств тестирования hello. При использовании серверов пользовательских лицензий вашей компании или организации поставщиков вместо лицензии служб в Azure Media Services можно пропустить этот шаг и указать URL-адреса приобретения лицензий в hello шаг по настройке служб доставки лицензий. AMS API — необходимые toospecify некоторые подробные конфигураций, например ограничений политики авторизации, лицензии ответа шаблоны для различных служб управления правами лицензии и т. д. В настоящее время hello портал Azure не поддерживает еще предоставляют hello требуется пользовательский Интерфейс для этой конфигурации. Сведения об уровне API и образец кода см. в статье Юлии Корнич (Julia Kornich): [Использование общего динамического шифрования PlayReady и (или) Widevine DRM](media-services-protect-with-drm.md).
4. Используйте политики доставки активов tooconfigure AMS API для средств тестирования hello. Сведения об уровне API и образец кода см. в статье Юлии Корнич (Julia Kornich): [Использование общего динамического шифрования PlayReady и (или) Widevine DRM](media-services-protect-with-drm.md).
5. Создание и настройка клиента Azure Active Directory в Azure
6. Создать несколько учетных записей пользователей и групп в клиенте Azure Active Directory: необходимо создать по крайней мере «EntitledUser» и добавить группу пользователей toothis. Пользователи в этой группе пройдет проверку правах приобретение лицензий и пользователи этой группы не сможет выполнить проверку подлинности toopass и не будет возможности tooacquire лицензии. Не является членом этой группы «EntitledUser» — это утверждение обязательным «groups» в hello маркера JWT, выданного Azure AD. Это требование утверждения должно быть указано при настройке служб доставки лицензий с несколькими DRM.
7. Создайте приложение ASP.NET MVC, в котором будет размещен видеопроигрыватель. Это приложение ASP.NET будут защищены с помощью проверки подлинности пользователей в клиент Azure Active Directory hello. Утверждения, соответствующие будет включаться в токены доступа hello, полученный после проверки подлинности пользователя. В этом шаге рекомендуется использовать API OpenID Connect. Необходимы следующие пакеты NuGet hello tooinstall:
   * Install-Package Microsoft.Azure.ActiveDirectory.GraphClient
   * Install-Package Microsoft.Owin.Security.OpenIdConnect
   * Install-Package Microsoft.Owin.Security.Cookies
   * Install-Package Microsoft.Owin.Host.SystemWeb
   * Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory
8. Создайте проигрыватель с помощью [API Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/). [Azure Media Player ProtectionInfo API](http://amp.azure.net/libs/amp/latest/docs/) позволяет toospecify какие toouse технологии управления цифровыми правами на другой платформе управления цифровыми правами.
9. Тестовая матрица:

| **DRM** | **"Обзор"** | **Результат для соответствующего пользователя** | **Результат для не соответствующего пользователя** |
| --- | --- | --- | --- |
| **PlayReady** |MS Edge или IE11 на Windows 10 |Успешно |Fail; |
| **Widevine** |Chrome на Windows 10 |Успешно |Fail; |
| **FairPlay** |ПОДЛЕЖИТ УТОЧНЕНИЮ | | |

Джордж Трифонов (George Trifonov) из команды служб мультимедиа Azure ведет блог, где вы найдете подробное описание шагов для настройки Azure Active Directory для приложения проигрывателя ASP.NET MVC, — [Интеграция приложения на основе OWIN MVC служб мультимедиа Azure с Azure Active Directory и ограничение доставки ключей содержимого на основе утверждений JWT](http://gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/).

Джордж также ведет блог о [проверке подлинности маркера JWT в службах мультимедиа Azure и динамическом шифровании](http://gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/). А вот его [пример интеграции Azure AD с доставкой ключей служб мультимедиа Azure](https://github.com/AzureMediaServicesSamples/Key-delivery-with-AAD-integration/).

Дополнительные сведения об Azure Active Directory:

* Сведения для разработчиков см. в [руководстве разработчика по Azure Active Directory](../active-directory/active-directory-developers-guide.md).
* Сведения для администраторов см. в статье [Администрирование каталога Azure AD](../active-directory/active-directory-administer.md).

### <a name="some-gotchas-in-implementation"></a>Некоторые проблемы в реализации
В реализации hello есть некоторые «проблемы». Надеемся, у hello следующий список «рекомендации» может помочь Устранение неполадок в случае, если возникнут проблемы.

1. URL-адрес **издателя** должен заканчиваться на **"/"**.  

    **Аудитория** должен быть hello идентификатор клиента приложения проигрывателя, а также следует добавить **«/»** конце hello URL-адрес издателя hello.

        <add key="ida:audience" value="[Application Client ID GUID]" />
        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/" />

    В [декодер JWT](http://jwt.calebb.net/), вы увидите **aud** и **iss** как показано ниже в токене JWT hello:

    ![1-я проблема](./media/media-services-cenc-with-multidrm-access-control/media-services-1st-gotcha.png)
2. Добавьте разрешения toohello приложение в Azure Active Directory (на вкладке Настройка приложения hello). Это необходимо для каждого приложения (локальной и развернутой версий).

    ![2-я проблема](./media/media-services-cenc-with-multidrm-access-control/media-services-perms-to-other-apps.png)
3. Используйте hello правильного поставщика в настройке динамического CENC защиты:

        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/"/>

    следующие Hello не будет работать:

        <add key="ida:issuer" value="https://willzhanad.onmicrosoft.com/" />

    Hello GUID является идентификатором hello AAD клиента. Hello GUID можно найти во всплывающем конечные точки на портале Azure.
4. Предоставление привилегий утверждения членства в группе. Убедитесь, что в файле манифеста приложения AAD, у нас есть следующие hello

    «groupMembershipClaims»: «Все» (значение по умолчанию hello имеет значение null)
5. Установка правильного TokenType при создании требования к ограничениям.

        objTokenRestrictionTemplate.TokenType = TokenType.JWT;

    Так как добавление поддерживает из JWT (AAD) в дополнение к этому tooSWT (ACS), по умолчанию hello TokenType — TokenType.JWT. Если вы используете SWT и ACS, необходимо задать tooTokenType.SWT.

## <a name="additional-topics-for-implementation"></a>Дополнительные разделы по реализации
Далее мы рассмотрим некоторые дополнительные вопросы в нашей теме о проектировании и реализации.

### <a name="http-or-https"></a>HTTP или HTTPS?
приложение ASP.NET MVC проигрывателя нами Hello должен поддерживать hello следующее:

1. Проверку подлинности пользователя через Azure AD, которого требуется toobe под HTTPS;
2. JWT маркера обмен между клиентом и Azure AD, которого требуется toobe под HTTPS;
3. Получение лицензии DRM клиентом hello, который является обязательным toobe в HTTPS, если предоставлен доставки лицензий службами мультимедиа Azure. Конечно, набор продуктов PlayReady не требует HTTPS для доставки лицензий. Если ваш сервер лицензирования PlayReady находится за пределами служб мультимедиа Azure, можно использовать HTTP или HTTPS.

Таким образом hello проигрывателя приложения ASP.NET будут использовать HTTPS рекомендуется. Это означает hello Azure Media Player будет на странице в разделе HTTPS. Однако для потоковой передачи желательно HTTP, поэтому мы должны tooconsider смешанного содержимого проблему.

1. Браузер не разрешает смешанное содержимое. Однако подключаемые модули, например Silverlight и OSMF для бесперебойной работы и DASH, разрешают. Смешанное содержимое существует угроза безопасности - это из-за угрозы toohello из tooinject возможность hello вредоносных JS, что может привести к hello клиента toobe данные под угрозой.  Браузеры блокировать это по умолчанию и на данный момент hello единственным способом toowork вокруг него равен на стороне сервера (источника) hello tooallow все домены (независимо от того, https или http). Это, скорее всего, тоже не самая лучшая идея.
2. Следует избегать смешанного содержимого: всегда использовать либо протокол HTTP, либо HTTPS. При воспроизведении смешанного содержимого технология silverlightSS требует удаления предупреждения о смешанном содержимом. Технология flashSS обрабатывает смешанное содержимое без предупреждения о смешанном содержимом.
3. Если конечная точка потоковой передачи была создана до августа 2014 г., она не будет поддерживать протокол HTTPS. В этом случае создайте и используйте новую конечную точку потоковой передачи для использования протокола HTTPS.

В hello Эталонная реализация для защищенного DRM содержимое и приложение и потоковая передача будет HTTTPS. Для открытых содержимое проигрывателя hello не обязательно лицензия, или проверку подлинности их необходимо hello liberty toouse либо HTTP или HTTPS.

### <a name="azure-active-directory-signing-key-rollover"></a>Смена ключей подписывания Azure Active Directory
Это важные tootake точки во внимание реализации. Если это не рекомендуется в реализации, система hello завершено со временем перестанут работать полностью в течение не более 6 недель.

Azure AD использует отраслевых стандартных tooestablish доверия между собой и приложений с помощью Azure AD. В частности, Azure AD использует ключ подписывания, состоящий из пары открытого и закрытого ключей. Когда Azure AD создает маркер безопасности, содержащий сведения о пользователе hello, этот маркер подписывается с помощью Azure AD, используя свой закрытый ключ, перед отправкой приложения toohello назад. tooverify, hello токен действителен и получен из Azure AD, hello приложение должно проверить токен hello подписи с помощью открытого ключа hello, предоставляемые Azure AD, который содержится в документе метаданных федерации клиента hello. Этот открытый ключ — и hello производный ключ подписи — — hello же той, которая используется для всех клиентов в Azure AD.

Подробные сведения о смене ключей Azure AD можно найти в документе hello: [важные сведения о подписи смене ключей в Azure AD](../active-directory/active-directory-signing-key-rollover.md).

Между hello [пары открытого и закрытого ключей](https://login.microsoftonline.com/common/discovery/keys/),

* Hello закрытый ключ используется с Azure Active Directory toogenerate маркера JWT;
* открытый ключ Hello используется приложением такие как службы доставки лицензий DRM в маркер JWT hello tooverify AMS;

В целях безопасности Azure Active Directory периодически проводит ротацию этого сертификата (каждые 6 недель). В случае нарушения безопасности hello смены ключей может возникать любое время. Таким образом службы доставки лицензий hello в AMS должны tooupdate hello открытый ключ, используемый как Azure AD поворачивает hello пары ключей, в противном случае возникнет токена проверки подлинности в AMS и лицензия не будет выполняться.

Это достигается путем установки TokenRestrictionTemplate.OpenIdConnectDiscoveryDocument при настройке службы доставки лицензий DRM.

поток маркеров JWT Hello — как ниже:

1. Azure AD будет выдавать токен JWT hello hello текущего закрытым ключом для прошедшего проверку пользователя;
2. Когда проигрыватель видит CENC с несколькими защищенного DRM содержимым, он сначала будет находить hello маркера JWT, выданного Azure AD.
3. проигрыватель Hello отправляет запрос приобретения лицензии с помощью службы доставки toolicense маркера JWT hello в AMS;
4. службы доставки лицензий Hello в AMS будет использовать hello текущего/допустимого открытого ключа из Azure AD токен JWT tooverify hello, перед выдачей лицензий.

Службы доставки лицензий DRM будет всегда проверяет наличие hello текущего/допустимого открытого ключа из Azure AD. Hello открытый ключ, предоставленный Azure AD будет hello ключ, используемый для проверки маркера JWT, выданного Azure AD.

Что делать, если смены ключей hello происходит после AAD создает токен JWT, но перед hello JWT маркер отправляется проигрыватели tooDRM лицензии доставки службы, AMS для проверки?

Поскольку ключ может быть сменен в любой момент, всегда есть более одного допустимого открытого ключа в документе метаданных федерации hello. Доставки лицензий Azure Media Services можно использовать любой из hello ключи указывать в документе hello, так как один ключ может быть сменен раньше, другой может оказаться его заменой и т. д.

### <a name="where-is-hello-access-token"></a>Где hello токена доступа?
Просмотрите как веб-приложение вызывает приложение API в разделе [удостоверение приложения с предоставления учетных данных клиента OAuth 2.0](../active-directory/develop/active-directory-authentication-scenarios.md#web-application-to-web-api), hello порядок проверки подлинности состоит в том, как ниже:

1. Когда пользователь вошел в tooAzure AD в веб-приложение hello (hello в разделе [tooWeb веб-браузере приложений](../active-directory/develop/active-directory-authentication-scenarios.md#web-browser-to-web-application).
2. Конечная точка авторизации Hello Azure AD перенаправляет hello пользователя агента обратной toohello клиентское приложение с кодом авторизации. агент пользователя Hello возвращает URI перенаправления toohello клиента авторизации кода приложения.
3. веб-приложение Hello должен tooacquire маркер доступа, чтобы она могла проверить подлинность веб-API toohello и получать hello требуемого ресурса. Оно выполняет запрос tooAzure AD конечную точку токена, предоставляя hello учетных данных, идентификатора клиента и URI идентификатора приложения веб-API. Представляет tooprove код авторизации hello, hello пользователь дал свое согласие.
4. Azure AD проверяет подлинность приложения hello и возвращает токен доступа JWT, используемые toocall hello веб-API.
5. По протоколу HTTPS hello веб-приложение использует hello hello tooadd токена доступа JWT строку JWT с назначением «bearer», возвращенная в заголовок авторизации hello hello запроса toohello веб-API. Hello веб-API затем проверяет токен JWT hello, и если проверка прошла успешно, возвращает hello требуемого ресурса.

В этой процедуре «удостоверение приложения» hello веб-API доверяет этой hello веб-приложения hello прошедшего проверку подлинности пользователя. По этой причине данная схема называется доверенной (надежной) подсистемой. Hello [схемы на этой странице](https://docs.microsoft.com/azure/active-directory/active-directory-protocols-oauth-code) описывает, как работает поток разрешений кода авторизации.

При покупке лицензии с ограничения токенов, следуете hello подход и доверенной подсистемы. И службы доставки лицензий hello в службах мультимедиа Azure является ресурсов веб-API hello, «внутренний ресурс» hello веб-приложению требуются tooaccess. Таким образом, где маркер доступа hello?

В самом деле, мы получаем маркер доступа из Azure AD. После успешной проверки подлинности пользователя возвращается код авторизации. Код авторизации Hello затем используется вместе с ИД и приложения ключ клиента, tooexchange токена доступа. И hello маркер доступа для доступа приложения «указатель» выбрать команды и представляющий службы доставки лицензий служб мультимедиа Azure.

Нам нужна tooregister и настроить приложение hello «указатель» в Azure AD с помощью hello описанных ниже действий:

1. В клиенте hello Azure AD

   * добавьте приложение (ресурс) с URL-адресом входа:

   https://[resource_name].azurewebsites.net/ и

   * URL-адрес идентификатора приложения:

   https://[aad_tenant_name].onmicrosoft.com/[resource_name];
2. Добавьте новый раздел для приложения hello ресурсов;
3. Обновить файл манифеста приложения hello, чтобы свойства groupMembershipClaims hello hello следующие значения: «groupMembershipClaims»: «Все»  
4. Добавьте в приложение hello Azure AD, указывающий toohello проигрывателя веб-приложения, в разделе "hello" «разрешения tooother приложений», приложение hello ресурсов, которая была добавлена в шаге 1 выше. В разделе "делегированные разрешения" проверьте флажок "Доступ [имя_ресурса]". Это дает hello веб-приложения разрешение toocreate токены доступа для доступа к ресурсу приложение hello. Следует сделать для локальных и развернутой версии веб-приложения hello при разработке веб-приложения Visual Studio и Azure.

Таким образом hello маркера JWT, выданного Azure AD, на самом деле является hello маркер доступа для доступа к этому ресурсу «указатель».

### <a name="what-about-live-streaming"></a>Как насчет динамической потоковой передачи?
В приведенном выше hello нашего обсуждения сосредоточиться на активы по требованию. Как насчет динамической потоковой передачи?

Hello хорошие новости состоит в том, что можно использовать точно hello же проектирования и реализации для защиты потоковой трансляции в службах мультимедиа Azure, рассматривая hello актив, связанный с программой как «актив VOD».

В частности это хорошо известен, что toodo live streaming в службах мультимедиа Azure, необходимо toocreate канал, то программа hello канал. Программа hello toocreate, необходимо toocreate актива, который будет содержать hello динамического архива для программы hello. В порядке tooprovide CENC с несколькими DRM защиты hello содержимого в реальном времени, все, что нужно toodo, является tooapply hello одного средства обработки и установки toohello как если бы был «VOD активов», перед запуском программы hello.

### <a name="what-about-license-servers-outside-of-azure-media-services"></a>Как насчет серверов лицензирования за пределами служб мультимедиа Azure?
Часто пользователи могли вложить средства в ферму серверов лицензирования в собственном центре обработки данных или у поставщика услуг DRM. К счастью, Защита контента служб мультимедиа Azure позволяет вам toooperate в гибридном режиме: содержимое размещенных и динамически защищенные в Azure Media Services во время доставки лицензии DRM серверами за пределами Azure Media Services. В этом случае существует hello следующие вопросы об изменениях.

1. Hello службы токенов безопасности потребностей tooissue маркеров, которые являются допустимыми и могут быть проверены для фермы серверов лицензирования hello. Например серверы лицензирования Widevine hello, предоставляемые Axinom требует определенного маркера JWT, содержащий «правах сообщение». Поэтому необходимо toohave tooissue STS такой маркер JWT. Авторы Hello завершены такой реализации и hello сведения можно найти в hello после документа в [центр документации Azure](https://azure.microsoft.com/documentation/): [toodeliver с помощью Axinom Widevine лицензий служб мультимедиа tooAzure](media-services-axinom-integration.md).
2. Ненужные службы доставки лицензий tooconfigure (ContentKeyAuthorizationPolicy) в службах мультимедиа Azure. Что необходимо toodo — tooprovide hello лицензии приобретения URL-адреса (PlayReady, Widevine и FairPlay) при настройке AssetDeliveryPolicy настройки CENC с несколькими DRM.

### <a name="what-if-i-want-toouse-a-custom-sts"></a>Что делать, если требуется toouse собственной STS?
Может быть несколько причин, которые клиент может выбрать toouse пользовательской службы маркеров безопасности (службы токенов безопасности) для предоставления токенов JWT. Ниже приведены некоторые из них.

1. Hello поставщика удостоверений (IDP) используется клиентом hello не поддерживает службы маркеров безопасности. В этом случае выходом может оказаться пользовательская STS.
2. Hello клиента может потребоваться более гибкие или более строгого управления по интеграции службы маркеров безопасности с клиента подписчиков, выставления счетов системы. Например оператор MVPD может предложить несколько пакетов подписчик OTT, такие как спортивных premium, basic, оператор hello т. д. может потребоваться toomatch hello утверждений в токене с подписчика пакета, чтобы только содержимое в нужный пакет hello станет доступна. В этом случае пользовательских маркеров безопасности предоставляет hello необходимости обеспечения гибкости и управляемости.

Два изменения необходимо учитывать при использовании собственной STS toobe:

1. При настройке службы доставки лицензий для актива, необходимо toospecify hello безопасности ключ, используемый для проверки собственной STS hello (Подробнее см. ниже) вместо hello текущий ключ из Azure Active Directory.
2. Когда создается маркер JTW, ключ безопасности задается вместо hello закрытый ключ сертификата hello текущей X509 в Azure Active Directory.

Существует два типа ключей безопасности:

1. Симметричный ключ: hello же ключ используется для создания и проверки маркера JWT;
2. Асимметричный ключ: пару открытого и закрытого ключа в X509 используется сертификат с закрытым ключом для шифрования и создания JWT маркер и hello открытый ключ для проверки токена hello.

#### <a name="tech-note"></a>Техническое примечание
При использовании .NET Framework и C# как платформу разработки, hello X509 сертификат, используемый для асимметричный ключ должен иметь длину ключа по крайней мере 2048. Это требование hello класса System.IdentityModel.Tokens.X509AsymmetricSecurityKey в .NET Framework. В противном случае будет создано hello следующие исключения:

IDX10630: hello «System.IdentityModel.Tokens.X509AsymmetricSecurityKey» для подписи не может быть меньше, чем "2048" bits.

## <a name="hello-completed-system-and-test"></a>система Hello завершена и тестирования
Мы рассмотрим несколько сценариев в системе hello завершения начала до конца, чтобы читатели могут иметь basic hello поведение «изображение» до получения учетной записи входа.

Hello проигрывателя веб-приложения и его имя входа можно найти [здесь](https://openidconnectweb.azurewebsites.net/).

Если необходим сценарий «неинтегрированному»: видео активы размещенного в службах мультимедиа Azure, являются либо незащищенными или защищенного DRM, но без проверки подлинности маркера (выдачи toowhoever лицензии, запрашивая его), можно проверить его без имени входа (путем переключения tooHTTP в случае видео потоковой передачи по протоколу HTTP).

Если необходим сценарий интеграции конца в конец: видео активы находится под динамического защиты DRM в службах мультимедиа Azure с помощью маркера проверки подлинности и маркер JWT, создаваемый с помощью Azure AD, вы должны toologin.

### <a name="user-login"></a>Вход пользователя
Порядок tootest hello конца в конец интегрированной системе DRM нужен toohave «учетная запись», либо добавленный.

Какую учетную запись?

Хотя изначально система Azure разрешала доступ только пользователям учетных записей Майкрософт, теперь она позволяет получать доступ пользователям обеих систем. Это было сделано, задав свойства Azure доверяют все hello Azure AD для проверки подлинности, с Azure AD, выполняет проверку подлинности пользователей организации и создания отношения федерации где Azure AD доверяет система идентификаторов клиента учетных записей Microsoft hello Пользователи tooauthenticate потребителя. В результате Azure AD — учетные записи Майкрософт может tooauthenticate «Гость», а также «собственные» учетные записи Azure AD.

Поскольку Azure AD доверяет домену учетной записи Майкрософт (MSA), можно добавить все учетные записи из любого hello следующие домены toohello пользовательские Azure AD для клиента и использовать toologin hello учетной записи:

| **Доменное имя** | **Домен** |
| --- | --- |
| **Домен пользовательского клиента Azure AD** |somename.onmicrosoft.com |
| **Домен организации** |microsoft.com |
| **Домен учетных записей Майкрософт (MSA)** |outlook.com, live.com, hotmail.com |

Вы можете связаться со всех авторов hello toohave создании или добавлено учетную запись.

Ниже приведены снимки экрана приветствия страниц другого имени входа, используемые разными учетными записями домена.

**Учетная запись домена для клиента пользовательские Azure AD**: В этом случае отображается страница hello пользовательское имя входа домена клиента hello пользовательских Azure AD.

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain1.png)

**Учетная запись домена Microsoft с помощью смарт-карт**: В этом случае отображается страница входа hello настройки с помощью Microsoft корпоративных ИТ с двухфакторной проверки подлинности.

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain2.png)

**Учетная запись Майкрософт (MSA)**: В этом случае отображается страница входа hello учетной записи Майкрософт для потребителей.

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain3.png)

### <a name="using-encrypted-media-extensions-for-playready"></a>Использование расширений зашифрованных носителей для PlayReady
На современных браузера с зашифрованные мультимедиа расширения (EME) для поддержки, например браузер IE 11 на Windows 8.1 и выше, а также Microsoft Edge в Windows 10, PlayReady будет PlayReady hello базовой DRM для EME.

![Использование EME для PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready1.png)

область темной проигрывателя Hello, — из-за toohello фактов защиты PlayReady не допускает один делать снимки экрана защищенного видео.

Hello следующий экран показывает подключаемых модулей проигрывателя hello и поддержку MSE/EME.

![Использование EME для PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready2.png)

EME в Microsoft Edge и IE 11 в Windows 10 позволяет вызывать из [PlayReady SL3000](https://www.microsoft.com/playready/features/EnhancedContentProtection.aspx/) на устройствах Windows 10, которые ее поддерживают. PlayReady SL3000 разблокирует hello потока содержимого улучшенные premium (4 КБ, HDR, т. д.) и новые модели доставки содержимого (раннее окно расширенного содержимого).

Сосредоточиться на устройствах Windows hello: PlayReady hello только DRM в HW hello, доступное на устройствах Windows (PlayReady SL3000). Служба потоковой передачи может использовать PlayReady через EME или приложение UWP. Благодаря PlayReady SL3000 она предлагает более высокое качество видеоизображения, чем другие DRM. Как правило содержимое 2 КБ будет проходить через Chrome или Firefox и 4 K содержимого через Microsoft Edge/IE11 или в приложении UWP на hello одного устройства (в зависимости от параметров службы и реализация).

#### <a name="using-eme-for-widevine"></a>Использование EME для Widevine
На современных браузер с поддержкой EME/Widevine, такие как Chrome 41 + в Windows 10, Windows 8.1, Mac OS x Yosemite и хром на Android 4.4.4 Google Widevine — hello DRM за EME.

![Использование EME для Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine1.png)

Обратите внимание, что Widevine не запрещает делать снимок экрана защищенного видео.

![Использование EME для Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine2.png)

### <a name="not-entitled-users"></a>Пользователи, не имеющие прав
Если пользователь не является членом группы «Пользователи под названием», hello пользователя не может toopass «проверка прав» и служба лицензий multi DRM hello откажут tooissue hello запрошенную лицензию, как показано ниже. Hello подробное описание — «получения лицензии не удалось выполнить», это, как было задумано.

![Пользователи без прав](./media/media-services-cenc-with-multidrm-access-control/media-services-unentitledusers.png)

### <a name="running-custom-secure-token-service"></a>Использование пользовательской службы маркеров безопасности
Для сценария hello выполнения пользовательских службу токенов безопасности (STS) токен JWT hello будет выданного службой маркеров безопасности пользовательских hello с помощью асимметричного или симметричного ключа.

Hello вариант использования симметричного ключа (с помощью Chrome).

![Выполнение пользовательской STS](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts1.png)

Здравствуйте, регистр с помощью асимметричного ключа через X509 сертификат (с помощью Microsoft современного браузера).

![Выполнение пользовательской STS](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts2.png)

В обоих hello выше вариантов проверки подлинности пользователь остается hello же — через Azure AD. Hello отличается только что маркеры JWT выдаются hello собственной STS вместо Azure AD. Конечно, при настройке защиты динамические CENC, ограничение hello службы доставки лицензий указывает тип hello маркера JWT симметричный или асимметричный ключ.

## <a name="summary"></a>Сводка
В этом документе мы обсуждали CENC с несколькими собственными DRM и контролем доступа через проверку подлинности маркера: проектирование и реализацию системы с помощью Azure, служб мультимедиа Azure и Проигрывателя мультимедиа Azure.

* Схема представляется которого содержит все необходимые компоненты hello в подсистеме управления цифровыми правами/CENC;
* справочную реализацию в Azure, службах мультимедиа Azure и Проигрывателе мультимедиа Azure.
* Также рассматриваются некоторые вопросы, непосредственно участвующих в hello проектирования и реализации.

## <a name="media-services-learning-paths"></a>Схемы обучения работе со службами мультимедиа
[!INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a>Отзывы
[!INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]
 

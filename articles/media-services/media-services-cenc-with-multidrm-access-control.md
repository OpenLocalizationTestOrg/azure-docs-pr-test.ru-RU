---
title: "CENC с несколькими DRM и контролем доступа: справочное проектирование и реализация в Azure и службах мультимедиа Azure | Документация Майкрософт"
description: "Информация о лицензировании пакета для портирования клиента бесперебойной потоковой передачи Microsoft® Smooth Streaming"
services: media-services
documentationcenter: 
author: willzhan
manager: cfowler
editor: 
ms.assetid: 7814739b-cea9-4b9b-8370-538702e5c615
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/19/2017
ms.author: willzhan;kilroyh;yanmf;juliako
ms.openlocfilehash: 730917b6859f8dbd800ef2cb141062f45d7779ac
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="cenc-with-multi-drm-and-access-control-a-reference-design-and-implementation-on-azure-and-azure-media-services"></a>CENC с несколькими DRM и управление доступом: справочное проектирование и реализация в Azure и Azure Media Services
 
## <a name="introduction"></a>Введение
Хорошо известно, что проектирование и построение подсистемы DRM для OTT или веб-решений для потоковой передачи — непростая задача. Поэтому общепринятой практикой операторов и поставщиков веб-видео является передача этой части на реализацию специализированным поставщикам служб DRM. Цель данного документа — предоставить справочную разработку и реализацию готовой подсистемы DRM в OTT или веб-решении для потоковой передачи.

Этот документ предназначен для инженеров, работающих в подсистеме DRM OTT или с веб-решениями для потоковой передачи или с несколькими экранами, а также для всех читателей, заинтересованных в подсистеме DRM. Предполагается, что читатели знакомы по крайней мере с одной из технологий DRM на рынке, например PlayReady, Widevine, FairPlay или Adobe Access.

Под DRM также понимается CENC (стандартное шифрование) с несколькими DRM. Основной тенденцией в отрасли интерактивной потоковой передачи и OTT является использование CENC с несколькими собственными DRM на различных клиентских платформах, что является переходом от предыдущей тенденции использования единого DRM и клиентского пакета SDK для различных клиентских платформ. При использовании CENC с несколькими собственными DRM и PlayReady, и Widevine шифруются посредством спецификации [стандартного шифрования (ISO/IEC 23001-7 CENC)](http://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm?csnumber=65271/) .

Ниже приведены преимущества CENC с несколькими DRM.

1. Снижается стоимость шифрования, так как используется единая обработка шифрования для разных платформ с собственными DRM.
2. Снижаются расходы на управление зашифрованными ресурсами, поскольку требуется только одна копия зашифрованных ресурсов.
3. Исключаются расходы на лицензирование клиента DRM, поскольку собственный клиент DRM обычно предоставляется бесплатно на собственной платформе.

Майкрософт является активным распространителем DASH и CENC вместе с некоторыми крупнейшими компаниями отрасли. Службы мультимедиа Microsoft Azure предлагают поддержку DASH и CENC. Последние объявления см. в блогах Мингфея: [Представление служб доставки лицензий Google Widevine в службах мультимедиа Azure](https://azure.microsoft.com/blog/announcing-general-availability-of-google-widevine-license-services/) и [Службы мультимедиа Azure добавляют пакет Google Widevine для предоставления потока с несколькими DRM](https://azure.microsoft.com/blog/azure-media-services-adds-google-widevine-packaging-for-delivering-multi-drm-stream/).  

### <a name="overview-of-this-article"></a>Описание раздела
Эта статья преследует следующие цели:

1. Предоставляет справочное проектирование подсистемы DRM с помощью CENC с несколькими DRM.
2. Предоставляет справочную реализацию на платформе Microsoft Azure или служб мультимедиа Azure.
3. Рассматривает некоторые вопросы проектирования и реализации.

В этой статье термин "несколько DRM" распространяется на следующие технологии:

1. Microsoft PlayReady
2. Google Widevine
3. Apple FairPlay 

В следующей таблице перечислены собственные платформы, приложения и браузеры, поддерживаемые каждой службой DRM.

| **Платформа клиента** | **Поддержка собственного DRM** | **Браузер или приложение** | **Форматы потоковой передачи** |
| --- | --- | --- | --- |
| **Смарт-ТВ, операторские STB, OTT STB** |В основном PlayReady и (или) Widevine и (или) другие |Linux, Opera и WebKit, другие |Различные форматы |
| **Устройства Windows 10 (ПК Windows, планшеты Windows, Windows Phone, Xbox)** |PlayReady |MS Edge/IE11/EME<br/><br/><br/>UWP |DASH (PlayReady не поддерживается для HLS)<br/><br/>DASH, Smooth Streaming (PlayReady не поддерживается для HLS) |
| **Устройства Android (телефоны, планшеты, телевизоры)** |Widevine |Chrome или EME |DASH, HLS |
| **iOS (iPhone, iPad), клиенты OS X и Apple TV** |FairPlay |Safari 8+ или EME |HLS |


С учетом текущего состояния развертывания для каждого DRM службе обычно требуется реализовать 2 или 3 DRM, чтобы вы могли максимально эффективно использовать все типы конечных точек.

Существует компромиссное решение, позволяющее справиться со сложностями логики службы и сложностями на стороне клиента по достижению определенного уровня работы пользователей на различных клиентах.

Делая выбор, необходимо иметь в виду следующие факты:

* Технология PlayReady изначально реализована на всех устройствах Windows, на некоторых устройствах Android и доступна в пакетах SDK программ практически на любой платформе.
* Widevine изначально реализована на каждом устройстве Android, Chrome и некоторых других устройствах.
* Технология FairPlay доступна только на клиентах iOS и Mac OS или через iTunes.

Поэтому обычные несколько DRM будут выглядеть следующим образом:

* Вариант 1. PlayReady и Widevine
* Вариант 2. PlayReady, Widevine и FairPlay

## <a name="a-reference-design"></a>Справочное проектирование
В этом разделе мы представим справочное проектирование, которое не зависит от технологий, используемых для его реализации.

Подсистема DRM может содержать следующие компоненты:

1. Управление ключами
2. Упаковка DRM
3. Доставка лицензий DRM
4. Проверка прав
5. Проверка подлинности и авторизация
6. Проигрыватель
7. Происхождение и CDN

На следующей схеме представлено взаимодействие высокого уровня между компонентами в подсистеме DRM.

![Подсистема DRM с CENC](./media/media-services-cenc-with-multidrm-access-control/media-services-generic-drm-subsystem-with-cenc.png)

Существует три основных "уровня" в структуре.

1. Уровень главного офиса (обозначен черным цветом), который не предоставляется внешним объектам.
2. Уровень "DMZ" (синий), содержащий все общедоступные конечные точки.
3. Уровень общедоступного Интернета (светло-синий), содержащий CDN и проигрыватели с трафиком через общедоступный Интернет.

Должно быть средство управления содержимым для контроля защиты DRM независимо от используемого шифрования (статического или динамического). Входные данные для шифрования DRM должны включать:

1. видеосодержимое MBR;
2. ключ содержимого;
3. URL-адреса для приобретения лицензии.

Во время воспроизведения поток верхнего уровня включает:

1. проверку подлинности пользователя;
2. создание маркера авторизации пользователя;
3. загрузку защищенного DRM содержимого (манифест) в проигрыватель;
4. отправку проигрывателем запроса на приобретение лицензий на серверы лицензий вместе с идентификатором ключа и маркером авторизации.

Перед переходом к следующему разделу несколько слов о проектировании управления ключами.

| **Ключ содержимого/ресурс** | **Сценарий** |
| --- | --- |
| 1 ключ/1 ресурс |Простейший случай. Он предоставляет самый лучший контроль. Однако обычно это приводит к наибольшей стоимости доставки лицензий. Для каждого защищенного ресурса требуется минимум один запрос лицензии. |
| 1 ключ/несколько ресурсов |Можно использовать тот же ключ содержимого для нескольких ресурсов. Например, для всех ресурсов в логической группе, такой как жанр или подмножество жанров (или жанр фильма), можно использовать один ключ содержимого. |
| Несколько ключей/1 ресурс |Несколько ключей содержимого необходимы для каждого ресурса. <br/><br/>Например, если необходимо применить динамическую защиту CENC с несколькими DRM для MPEG-DASH и динамическое шифрование AES-128 для HLS, требуется два отдельных ключа содержимого, каждый из которых имеет свой собственный ContentKeyType. (Для ключа содержимого, используемого для динамической защиты CENC, следует применять ContentKeyType.CommonEncryption. А для ключа содержимого, применяемого для динамического шифрования AES-128, используйте ContentKeyType.EnvelopeEncryption).<br/><br/>Другой пример: в защите CENC содержимого DASH теоретически можно использовать один ключ содержимого для защиты видеопотока и другой ключ содержимого для защиты аудиопотока. |
| Несколько ключей/несколько ресурсов |Сочетание описанных выше двух сценариев: один набор ключей содержимого используется для каждого из нескольких ресурсов в одной группе ресурсов. |

Другим важным вопросом является использование постоянных и временных лицензий.

Почему эти вопросы важны?

Они имеют непосредственное влияние на стоимость доставки лицензий при использовании общедоступного облака для доставки лицензий. Рассмотрим следующие два случая разных структур для иллюстрации.

1. Ежемесячная подписка: используйте постоянную лицензию и 1 ключ содержимого для нескольких ресурсов. Например:  для всех детских фильмов мы используем один ключ содержимого для шифрования. В данном случае:

    Общее число лицензий, запрашиваемых для всех детских фильмов или устройств = 1
2. Ежемесячная подписка: используйте временную лицензию и 1 ключ содержимого для 1 ресурса. В данном случае:

    Общее число лицензий, запрашиваемых для всех детских фильмов или устройств = [число просмотренных фильмов] x [число сеансов]

Как видите, два различных варианта дают очень разные шаблоны запросов лицензий, а следовательно, и затраты на доставку лицензий, если доставка лицензий осуществляется через общедоступное облако, например через службы мультимедиа Azure.

## <a name="mapping-design-to-technology-for-implementation"></a>Сопоставление структуры и технологии для реализации
Далее мы сопоставим универсальную структуру и технологии на платформе Microsoft Azure и служб мультимедиа Azure, указав, какую технологию использовать для каждого стандартного блока.

Сопоставление показано в следующей таблице.

| **Стандартный блок** | **Технология** |
| --- | --- |
| **Проигрыватель** |[Проигрыватель мультимедиа Azure](https://azure.microsoft.com/services/media-services/media-player/) |
| **Поставщик удостоверений (IDP)** |Azure Active Directory |
| **Служба маркеров безопасности (STS)** |Azure Active Directory |
| **Рабочий процесс защиты DRM** |Динамическая защита служб мультимедиа Azure |
| **Доставка лицензий DRM** |1. Доставка лицензий служб мультимедиа Azure (PlayReady, Widevine, FairPlay), или <br/>2. Axinom License Server, <br/>3. Пользовательский сервер лицензирования PlayReady |
| **Исходный домен** |Конечная точка потоковой передачи служб мультимедиа Azure |
| **Управление ключами** |Не требуется для справочной реализации |
| **Управление содержимым** |Консольное приложение C# |

Другими словами, и поставщиком удостоверений (IDP), и службой маркеров безопасности (STS) будет Azure AD. Для проигрывателя мы будем использовать [API Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/). Службы мультимедиа Azure и Проигрыватель Мультимедиа Azure поддерживают DASH и CENC с несколькими DRM.

Следующая схема показывает общую структуру и поток с описанным выше сопоставлением технологии.

![CENC на AMS](./media/media-services-cenc-with-multidrm-access-control/media-services-cenc-subsystem-on-AMS-platform.png)

Чтобы настроить динамическое шифрование CENC, средство управления содержимым будет использовать следующие входные данные:

1. открывание содержимого;
2. ключ содержимого из раздела создания и управления ключом;
3. URL-адреса для приобретения лицензии;
4. список сведений из Azure AD.

Выходные данные средства управления содержимым будут выглядеть так:

1. ContentKeyAuthorizationPolicy, содержащая спецификацию на способ доставки лицензий, проверяет маркер JWT и спецификации лицензий DRM.
2. AssetDeliveryPolicy, содержащая спецификации потоковых форматов, защиту DRM и URL-адреса приобретения лицензий.

Во время выполнения поток выглядит так:

1. После проверки подлинности пользователя создается маркер JWT.
2. Одно из утверждений, содержащихся в маркере JWT, является утверждением "группы" и содержит идентификатор объекта группы "EntitledUserGroup". Это утверждение будет использоваться для передачи "проверка права".
3. Проигрыватель загружает манифест клиента защищенного CENC содержимого и "видит" следующее:

   1. идентификатор ключа;
   2. содержимое защищено CENC;
   3. URL-адреса для приобретения лицензии.
4. Проигрыватель делает запрос на приобретение лицензий на основании поддерживаемого браузера и DRM. Идентификатор ключа и маркер JWT также отправляются в запросе на приобретение лицензии. Служба доставки лицензий проверит маркер JWT и утверждения, содержащиеся перед выдачей необходимых лицензий.

## <a name="implementation"></a>Реализация
### <a name="implementation-procedures"></a>Процедуры реализации
Реализация будет включать следующие шаги.

1. Подготовка тестовых ресурсов: кодирование или упаковка тестового видео в формат MP4 с разными скоростями в службах мультимедиа Azure. Этот ресурс НЕ защищен DRM. Защита DRM будет реализована позже с помощью динамической защиты.
2. Создание идентификатора ключа и ключа содержимого (при необходимости из начального значения). Для наших целей система управления ключами не требуется, поскольку мы имеем дело только с одним набором идентификатора ключа и ключа содержимого для нескольких тестовых ресурсов.
3. Используйте API AMS для настройки службы доставки лицензий с несколькими DRM для тестовых ресурсов. Если ваша компания или поставщик компании использует пользовательские серверы лицензий вместо служб лицензирования в службах мультимедиа Azure, можно пропустить этот шаг и указать URL-адреса приобретения лицензий на этапе настройки доставки лицензий. API AMS необходим, чтобы указать подробные конфигурации, например ограничения политики авторизации, шаблоны ответов лицензий для различных лицензионных служб DRM и т. д. В настоящее время портал Azure пока не предоставляет необходимый пользовательский интерфейс для этой конфигурации. Сведения об уровне API и образец кода см. в статье Юлии Корнич (Julia Kornich): [Использование общего динамического шифрования PlayReady и (или) Widevine DRM](media-services-protect-with-drm.md).
4. Используйте API AMS для настройки политики доставки ресурсов для тестовых ресурсов. Сведения об уровне API и образец кода см. в статье Юлии Корнич (Julia Kornich): [Использование общего динамического шифрования PlayReady и (или) Widevine DRM](media-services-protect-with-drm.md).
5. Создание и настройка клиента Azure Active Directory в Azure
6. Создайте несколько учетных записей пользователей и групп в клиенте Azure Active Directory: необходимо создать, по крайней мере, группу "EntitledUser" и добавить пользователя в эту группу. Пользователи в этой группе будут проходить проверку прав при приобретении лицензий, и пользователи, не входящие в эту группу, не смогут пройти проверку подлинности и получить лицензии. Членство в этой группе "EntitledUser" является обязательным утверждением "группы" в маркере JWT, выданном Azure AD. Это требование утверждения должно быть указано при настройке служб доставки лицензий с несколькими DRM.
7. Создайте приложение ASP.NET MVC, в котором будет размещен видеопроигрыватель. Это приложение ASP.NET будет защищено с помощью проверки подлинности пользователей в клиенте Azure Active Directory. Соответствующие утверждения будут включены в маркеры доступа, получаемые после проверки подлинности пользователя. В этом шаге рекомендуется использовать API OpenID Connect. Необходимо установить следующие пакеты NuGet:
   * Install-Package Microsoft.Azure.ActiveDirectory.GraphClient
   * Install-Package Microsoft.Owin.Security.OpenIdConnect
   * Install-Package Microsoft.Owin.Security.Cookies
   * Install-Package Microsoft.Owin.Host.SystemWeb
   * Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory
8. Создайте проигрыватель с помощью [API Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/). [API ProtectionInfo Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/) позволяет указать, какие технологии DRM следует использовать на разных платформах DRM.
9. Тестовая матрица:

| **DRM** | **"Обзор"** | **Результат для соответствующего пользователя** | **Результат для не соответствующего пользователя** |
| --- | --- | --- | --- |
| **PlayReady** |MS Edge или IE11 на Windows 10 |Успешно |Fail; |
| **Widevine** |Chrome на Windows 10 |Успешно |Fail; |
| **FairPlay** |ПОДЛЕЖИТ УТОЧНЕНИЮ | | |

Джордж Трифонов (George Trifonov) из команды служб мультимедиа Azure ведет блог, где вы найдете подробное описание шагов для настройки Azure Active Directory для приложения проигрывателя ASP.NET MVC, — [Интеграция приложения на основе OWIN MVC служб мультимедиа Azure с Azure Active Directory и ограничение доставки ключей содержимого на основе утверждений JWT](http://gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/).

Джордж также ведет блог о [проверке подлинности маркера JWT в службах мультимедиа Azure и динамическом шифровании](http://gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/). А вот его [пример интеграции Azure AD с доставкой ключей служб мультимедиа Azure](https://github.com/AzureMediaServicesSamples/Key-delivery-with-AAD-integration/).

Дополнительные сведения об Azure Active Directory:

* Сведения для разработчиков см. в [руководстве разработчика по Azure Active Directory](../active-directory/active-directory-developers-guide.md).
* Сведения для администраторов см. в статье [Администрирование каталога Azure AD](../active-directory/active-directory-administer.md).

### <a name="some-gotchas-in-implementation"></a>Некоторые проблемы в реализации
В реализации есть некоторые "подводные камни". Будем надеяться, что перечисленные ниже "подводные камни" помогут вам устранить неполадки в случае, если возникнут проблемы.

1. URL-адрес **издателя** должен заканчиваться на **"/"**.  

    **Аудиторией** должен быть идентификатор клиента приложения проигрывателя, а также следует добавить **"/"** в конце URL-адреса издателя.

        <add key="ida:audience" value="[Application Client ID GUID]" />
        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/" />

    В [декодере JWT](http://jwt.calebb.net/) должны быть **aud** и **iss**, как показано ниже в маркере JWT:

    ![1-я проблема](./media/media-services-cenc-with-multidrm-access-control/media-services-1st-gotcha.png)
2. Добавьте разрешения для приложения в AAD (на вкладке "Настройка" приложения). Это необходимо для каждого приложения (локальной и развернутой версий).

    ![2-я проблема](./media/media-services-cenc-with-multidrm-access-control/media-services-perms-to-other-apps.png)
3. Использование издателя прав в настройке динамической защиты CENC:

        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/"/>

    Следующее работать не будет:

        <add key="ida:issuer" value="https://willzhanad.onmicrosoft.com/" />

    Идентификатор GUID — идентификатор клиента AAD. Идентификатор GUID можно найти во всплывающем окне конечных точек на портале Azure.
4. Предоставление привилегий утверждения членства в группе. Убедитесь, что в файле манифеста приложения AAD содержится следующее

    "groupMembershipClaims": "All", (значение по умолчанию: null)
5. Установка правильного TokenType при создании требования к ограничениям.

        objTokenRestrictionTemplate.TokenType = TokenType.JWT;

    После добавления поддержки для JWT (AAD) в дополнение к SWT (ACS) значение по умолчанию TokenType — TokenType.JWT. Если вы используете SWT и ACS, необходимо задать значение TokenType.SWT.

## <a name="additional-topics-for-implementation"></a>Дополнительные разделы по реализации
Далее мы рассмотрим некоторые дополнительные вопросы в нашей теме о проектировании и реализации.

### <a name="http-or-https"></a>HTTP или HTTPS?
Приложение проигрывателя ASP.NET MVC, которое мы разработали, должно поддерживать следующее:

1. проверку подлинности пользователя через Azure AD, который должен находиться в разделе HTTPS;
2. обмен маркерами JWT между клиентом и Azure AD, который должен находиться в разделе HTTPS;
3. приобретение лицензий DRM клиентом, который должен находиться в разделе HTTPS, если доставка лицензий осуществляется службами мультимедиа Azure. Конечно, набор продуктов PlayReady не требует HTTPS для доставки лицензий. Если ваш сервер лицензирования PlayReady находится за пределами служб мультимедиа Azure, можно использовать HTTP или HTTPS.

Поэтому приложение проигрывателя ASP.NET будет использовать HTTPS в качестве рекомендованной технологии. Это означает, что Проигрыватель Мультимедиа Azure будет на странице в разделе HTTPS. Тем не менее, для потоковой передачи мы предпочитаем HTTP, так как нам нужно учесть проблемы смешанного содержимого.

1. Браузер не разрешает смешанное содержимое. Однако подключаемые модули, например Silverlight и OSMF для бесперебойной работы и DASH, разрешают. Смешанное содержимое является угрозой безопасности — это происходит из-за возможности вставить вредоносные JS, что может подвергнуть риску данные клиента.  Браузеры по умолчанию блокирует эту возможность, и на данный момент единственным способом обойти это на стороне сервера (источника) — разрешить все домены (и https, и http). Это, скорее всего, тоже не самая лучшая идея.
2. Следует избегать смешанного содержимого: всегда использовать либо протокол HTTP, либо HTTPS. При воспроизведении смешанного содержимого технология silverlightSS требует удаления предупреждения о смешанном содержимом. Технология flashSS обрабатывает смешанное содержимое без предупреждения о смешанном содержимом.
3. Если конечная точка потоковой передачи была создана до августа 2014 г., она не будет поддерживать протокол HTTPS. В этом случае создайте и используйте новую конечную точку потоковой передачи для использования протокола HTTPS.

В справочной реализации в случае защищенного DRM содержимого и приложения, и потоковая передача будут в разделе HTTPS. Для открытого содержимого проигрывателю не требуется лицензия или проверка подлинности, и вы можете использовать протокол HTTP или HTTPS.

### <a name="azure-active-directory-signing-key-rollover"></a>Смена ключей подписывания Azure Active Directory
Это важно учитывать при реализации. Если не учитывать это при реализации, завершенная система полностью перестанет работать в течение не более 6 недель.

Azure AD использует отраслевой стандарт для установления доверительных отношений между собой и приложениями, использующими Azure AD. В частности, Azure AD использует ключ подписывания, состоящий из пары открытого и закрытого ключей. Когда Azure AD создает маркер безопасности, который содержит сведения о пользователе, этот маркер подписывается с помощью Azure AD, используя свой закрытый ключ перед отправкой в приложение. Чтобы убедиться, что маркер является допустимым и получен от Azure AD, приложение должно проверить его подпись с помощью открытого ключа, предоставленного Azure AD, который содержится в документе метаданных федерации клиента. Этот открытый ключ — и ключ подписывания, от которого он происходит, — аналогичен тому, который используется для всех клиентов в Azure AD.

Подробные сведения о смене ключей Azure AD можно найти в документе [Важные сведения о смене ключей подписи в Azure AD](../active-directory/active-directory-signing-key-rollover.md).

Между [парой открытого и закрытого ключей](https://login.microsoftonline.com/common/discovery/keys/)

* Закрытый ключ используется Azure Active Directory для создания маркера JWT.
* Открытый ключ используется приложением, таким как службы доставки лицензий DRM в AMS, для проверки маркера JWT.

В целях безопасности Azure Active Directory периодически проводит ротацию этого сертификата (каждые 6 недель). В случае нарушения безопасности смена ключей может произойти любое время. Таким образом, службам доставки лицензий в AMS необходимо обновить открытый ключ, используемый по мере ротации пары ключей Azure AD, иначе произойдет сбой проверки подлинности маркера в AMS, и лицензия не будет выдана.

Это достигается путем установки TokenRestrictionTemplate.OpenIdConnectDiscoveryDocument при настройке службы доставки лицензий DRM.

Поток маркеров JWT выглядит так:

1. Azure AD выдаст маркер JWT с текущим закрытым ключом для прошедшего проверку пользователя.
2. Когда проигрыватель обнаруживает CENC с защищенным несколькими DRM содержимым, он сначала ищет маркер JWT, выданный Azure AD.
3. Проигрыватель отправляет запрос на приобретение лицензии с маркером JWT в службы доставки лицензий в AMS.
4. Службы доставки лицензий AMS будут использовать текущий и допустимый открытый ключ из Azure AD для проверки маркера JWT перед выдачей лицензий.

Службы доставки лицензий DRM всегда будут проверять текущий и допустимый открытый ключ из Azure AD. Открытый ключ, предоставленный Azure AD, будет ключом, используемым для проверки маркера JWT, выданного Azure AD.

Что делать, если смена ключей происходит после того, как AAD создал маркер JWT, но перед тем, как маркер JWT отправляется проигрывателями в службы доставки лицензий DRM в AMS для проверки?

Поскольку ключ может быть сменен в любой момент, всегда существует более одного допустимого открытого ключа в документе метаданных федерации. Доставка лицензий служб мультимедиа Azure может использовать любой из ключей, указанных в документе, поскольку один ключ может быть сменен раньше, другой может оказаться его заменой и т. д.

### <a name="where-is-the-access-token"></a>Где маркер доступа?
Если взглянуть на то, как веб-приложение вызывает приложение API в разделе [Удостоверение приложения с предоставлением учетных данных клиента OAuth 2.0](../active-directory/develop/active-directory-authentication-scenarios.md#web-application-to-web-api), схема проверки подлинности выглядит следующим образом.

1. Пользователь входит в систему Azure AD в веб-приложении (см. раздел [Из веб-браузера в веб-приложение](../active-directory/develop/active-directory-authentication-scenarios.md#web-browser-to-web-application)).
2. Конечная точка авторизации Azure AD перенаправляет агента пользователя в клиентское приложение с кодом авторизации. Агент пользователя возвращает код авторизации в URI перенаправления клиентского приложения.
3. Чтобы веб-приложение могло выполнить проверку подлинности для веб-интерфейса API и получить нужный ресурс, это приложение должно получить маркер доступа. Оно отправляет запрос в конечную точку маркера Azure AD, предоставляя учетные данные, идентификатор клиента и URI идентификатора приложения веб-интерфейса API. Представляет код авторизации, чтобы доказать, что пользователь дал свое согласие.
4. Azure AD проверяет подлинность приложения и возвращает маркер доступа JWT, который используется для вызова веб-интерфейса API.
5. Веб-приложение использует возвращенный маркер доступа JWT, добавляя строку JWT с обозначением "Носитель" в заголовок авторизации запроса, отправляемого по протоколу HTTPS в веб-интерфейс API. Затем веб-интерфейс API проверяет этот маркер JWT, и, если проверка будет выполнена успешно, возвращает требуемый ресурс.

В этом потоке "удостоверения приложения" веб-интерфейс API доверяет тому, что веб-приложение проверило подлинность пользователя. По этой причине данная схема называется доверенной (надежной) подсистемой. В [схеме на этой странице](https://docs.microsoft.com/azure/active-directory/active-directory-protocols-oauth-code) описывается принцип действия предоставления кода авторизации.

При приобретении лицензий с ограничением маркера мы следуем тому же шаблону доверенной подсистемы. А служба доставки лицензий в службах мультимедиа Azure — это ресурс веб-API, "внутренний ресурс", доступ к которому требуется веб-приложению. Так где же маркер доступа?

В самом деле, мы получаем маркер доступа из Azure AD. После успешной проверки подлинности пользователя возвращается код авторизации. Код авторизации затем используется совместно с идентификатором клиента и ключом приложения для обмена на маркер доступа. И маркер доступа предназначен для доступа к приложению "указатель", которое представляет службу доставки лицензий служб мультимедиа Azure.

Необходимо зарегистрировать и настроить приложение "указатель" в Azure AD, выполнив следующие действия:

1. В клиенте Azure AD

   * добавьте приложение (ресурс) с URL-адресом входа:

   https://[resource_name].azurewebsites.net/ и

   * URL-адрес идентификатора приложения:

   https://[aad_tenant_name].onmicrosoft.com/[resource_name];
2. Добавьте новый ключ для приложения ресурса.
3. Обновите файл манифеста приложения, чтобы свойство groupMembershipClaims имело следующее значение: "groupMembershipClaims": "All".  
4. В приложении Azure AD, указывающем на веб-приложения проигрывателя в разделе "разрешения для других приложений", добавьте приложение ресурса, которое было добавлено на шаге 1 выше. В разделе "делегированные разрешения" проверьте флажок "Доступ [имя_ресурса]". Это дает разрешение веб-приложению создать маркеры доступа для доступа к приложению ресурса. Это следует сделать для локальной и развернутой версий веб-приложения при разработке с помощью веб-приложения Visual Studio и Azure.

Таким образом, маркер JWT, выданный Azure AD, действительно является маркером доступа для доступа к ресурсу "указатель".

### <a name="what-about-live-streaming"></a>Как насчет динамической потоковой передачи?
Выше мы сфокусировались на ресурсах по требованию. Как насчет динамической потоковой передачи?

Хорошая новость в том, что вы можете использовать точно такую же структуру и реализацию для защиты динамической потоковой передачи в службах мультимедиа Azure, рассматривая ресурс, связанный с программой, как "ресурс VOD".

В частности, хорошо известно, что для реализации динамической потоковой передачи в службах мультимедиа Azure необходимо создать канал, а затем программу в рамках канала. Чтобы создать программу, необходимо создать ресурс, который будет содержать текущий архив для программы. Чтобы предоставить защиту динамического содержимого CENC с несколькими DRM, необходимо всего лишь применить ту же программу установки и обработки к ресурсу, как если бы это был "ресурс VOD", прежде чем запустить программу.

### <a name="what-about-license-servers-outside-of-azure-media-services"></a>Как насчет серверов лицензирования за пределами служб мультимедиа Azure?
Часто пользователи могли вложить средства в ферму серверов лицензирования в собственном центре обработки данных или у поставщика услуг DRM. К счастью, защита содержимого служб мультимедиа Azure дает возможность работы в гибридном режиме: содержимое размещается и динамически защищается в службах мультимедиа Azure, в то же время лицензии DRM доставляются серверами за пределами служб мультимедиа Azure. В этом случае необходимо учитывать следующие изменения.

1. Служба маркеров безопасности должна выдавать маркеры, которые являются допустимыми и могут быть проверены на ферме серверов лицензий. Например, серверы лицензий Widevine, предоставляемые Axinom, требуют определенного маркера JWT, который содержит "сообщение о правах". Таким образом, необходимо иметь STS для издания такого маркера JWT. Авторы завершили такую реализацию. Подробные сведения см. в следующем документе в [центре документации Azure](https://azure.microsoft.com/documentation/): [Использование Axinom для доставки лицензий Widevine в службы мультимедиа Azure](media-services-axinom-integration.md).
2. Настройка службы доставки лицензий (ContentKeyAuthorizationPolicy) в службах мультимедиа больше не требуется. Вам просто нужно предоставить URL-адреса приобретения лицензии (для PlayReady, Widevine и FairPlay) при настройке AssetDeliveryPolicy в ходе настройки CENC с несколькими DRM.

### <a name="what-if-i-want-to-use-a-custom-sts"></a>Что делать, если нужно использовать пользовательскую службу STS?
Могут быть несколько причин, по которым клиент может использовать пользовательскую STS (службу маркеров безопасности) для предоставления маркеров JWT. Ниже приведены некоторые из них.

1. Поставщик удостоверений (IDP), используемый клиентом, не поддерживает STS. В этом случае выходом может оказаться пользовательская STS.
2. Клиенту может потребоваться более гибкий или более жесткий контроль при интеграции STS с системой выставления счетов подписчика клиента. Например, оператор MVPD может предлагать несколько пакетов подписчиков OTT, таких как Premium, Basic, Sports и т. д. Оператору может потребоваться сопоставить утверждения в маркере с пакетом подписчика, чтобы предоставлялось только содержимое в нужном пакете. В этом случае пользовательская STS предоставляет необходимую гибкость и контроль.

При использовании пользовательской STS необходимо сделать два изменения:

1. При настройке службы доставки лицензий для ресурса необходимо указать ключ безопасности, используемый для проверки пользовательской STS (более подробное описание ниже) вместо текущего ключа из Azure Active Directory.
2. Когда создается маркер JTW, вместо закрытого ключа текущего сертификата X509 в Azure Active Directory указан ключ безопасности.

Существует два типа ключей безопасности:

1. Симметричный ключ: тот же ключ используется для создания и проверки маркера JWT.
2. Асимметричный ключ: пара открытого и закрытого ключей в сертификате X509 используется с закрытым ключом для шифрования и создания маркера JWT и с открытым ключом для проверки маркера.

#### <a name="tech-note"></a>Техническое примечание
При использовании .NET Framework/C# в качестве платформы разработки сертификат X509, используемый для асимметричного ключа безопасности, должен иметь длину ключа минимум 2048 бит. Это требование класса System.IdentityModel.Tokens.X509AsymmetricSecurityKey в .NET Framework. В противном случае будет создано следующее исключение:

IDX10630: System.IdentityModel.Tokens.X509AsymmetricSecurityKey не может быть менее 2048 бит.

## <a name="the-completed-system-and-test"></a>Завершенная система и тестирование
Мы рассмотрим несколько сценариев в завершенной комплексной системе, чтобы читатели получили базовое представление о поведении до получения учетной записи для входа.

Веб-приложение проигрывателя и учетную запись для входа можно найти [здесь](https://openidconnectweb.azurewebsites.net/).

Если необходим "неинтегрированный" сценарий (видеоматериалы, размещенные в службах мультимедиа Azure либо не защищены, либо защищены DRM, но без проверки подлинности маркера; лицензия выдается тому, кто ее запрашивает), вы можете проверить его без входа в систему (путем переключения на HTTP, если ваше потоковое видео передается по протоколу HTTP).

Если необходим полностью интегрированный сценарий (видеоматериалы обеспечены динамической защитой DRM в службах мультимедиа с проверкой подлинности маркера и маркером JWT, создаваемым в Azure AD), необходимо войти в систему.

### <a name="user-login"></a>Вход пользователя
Чтобы протестировать полностью интегрированную систему DRM, необходимо создать или добавить учетную запись.

Какую учетную запись?

Хотя изначально система Azure разрешала доступ только пользователям учетных записей Майкрософт, теперь она позволяет получать доступ пользователям обеих систем. Для этого было сделано так, чтобы все свойства Azure стали доверять процессу проверки подлинности Azure AD, чтобы Azure AD стала выполнять проверку подлинности пользователей организации, а также путем создания федеративных отношений, при которых Azure AD доверяет системе идентификации Майкрософт для учетных записей потребителей выполнять проверку подлинности пользователей. В результате Azure AD может проверять подлинность "гостевых" учетных записей Майкрософт, а также "собственных" учетных записей Azure AD.

Поскольку Azure AD доверяет домену учетных записей Майкрософт (MSA), можно добавить любые учетные записи из любого из следующих доменов в пользовательский клиент Azure AD и использовать учетную запись для входа:

| **Доменное имя** | **Домен** |
| --- | --- |
| **Домен пользовательского клиента Azure AD** |somename.onmicrosoft.com |
| **Домен организации** |microsoft.com |
| **Домен учетных записей Майкрософт (MSA)** |outlook.com, live.com, hotmail.com |

Вы можете связаться со любым автором, чтобы получить созданную или добавленную учетную запись.

Ниже приведены снимки экранов различных страниц входа, используемых разными учетными записями домена.

**Учетная запись домена пользовательского клиента Azure AD**: в этом случае вы видите настраиваемую страницу входа домена пользовательского клиента Azure AD.

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain1.png)

**Учетная запись домена Майкрософт со смарт-картой**: в этом случае вы видите страницу входа, настроенную ИТ-специалистами корпорации Майкрософт, с двухфакторной проверкой подлинности.

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain2.png)

**Учетная запись Майкрософт (MSA)**: в этом случае вы видите страницу входа учетной записи Майкрософт для потребителей.

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain3.png)

### <a name="using-encrypted-media-extensions-for-playready"></a>Использование расширений зашифрованных носителей для PlayReady
В современных браузерах с поддержкой расширений зашифрованных носителей (EME) или PlayReady, таких как IE 11 в Windows 8.1 и выше и Microsoft Edge в Windows 10, PlayReady будет базовой DRM для EME.

![Использование EME для PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready1.png)

Темная область проигрывателя возникает из-за того, что защита PlayReady не позволяет сделать снимок экрана защищенного видео.

На следующем снимке экрана представлены подключаемые модули проигрывателя и поддержка MSE или EME.

![Использование EME для PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready2.png)

EME в Microsoft Edge и IE 11 в Windows 10 позволяет вызывать из [PlayReady SL3000](https://www.microsoft.com/playready/features/EnhancedContentProtection.aspx/) на устройствах Windows 10, которые ее поддерживают. PlayReady SL3000 разблокирует поток улучшенного содержимого премиум-класса (4K, HDR и т. д.) и новые модели доставки содержимого (раннее окно для улучшенного содержимого).

Если брать во внимание устройства Windows, PlayReady является единственной технологией DRM, доступной на устройствах Windows (PlayReady SL3000). Служба потоковой передачи может использовать PlayReady через EME или приложение UWP. Благодаря PlayReady SL3000 она предлагает более высокое качество видеоизображения, чем другие DRM. Как правило, содержимое 2K будет передаваться через Chrome или Firefox, а содержимое 4K — через Microsoft Edge и IE11 или приложение UWP на том же устройстве (в зависимости от реализации и параметров службы).

#### <a name="using-eme-for-widevine"></a>Использование EME для Widevine
В современных браузерах с поддержкой EME и Widevine, таких как Chrome 41+ в Windows 10, Windows 8.1, Mac OSX Yosemite и Chrome в Android 4.4.4, Google Widevine является DRM в основе EME.

![Использование EME для Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine1.png)

Обратите внимание, что Widevine не запрещает делать снимок экрана защищенного видео.

![Использование EME для Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine2.png)

### <a name="not-entitled-users"></a>Пользователи, не имеющие прав
Если пользователь не является участником группы "Соответствующие пользователи", то он не сможет пройти "проверку прав", и служба лицензий с несколькими DRM откажется выдать запрошенную лицензию, как показано ниже. Подробное описание звучит "Не удалось получить лицензию", как это и было задумано.

![Пользователи без прав](./media/media-services-cenc-with-multidrm-access-control/media-services-unentitledusers.png)

### <a name="running-custom-secure-token-service"></a>Использование пользовательской службы маркеров безопасности
В сценариях с использованием настраиваемой службы STS маркер JWT будет выдаваться настраиваемой службой STS с использованием симметричного или асимметричного ключа.

Случай использования симметричного ключа (в Chrome):

![Выполнение пользовательской STS](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts1.png)

Случай использования асимметричного ключа через сертификат X509 (в современных браузерах Майкрософт).

![Выполнение пользовательской STS](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts2.png)

В обоих указанных случаях проверка подлинности пользователя остается неизменной — через Azure AD. Единственное различие состоит в том, что маркеры JWT выдаются пользовательской STS вместо Azure AD. Конечно, при настройке динамической защиты CENC ограничение службы доставки лицензий указывает тип маркера JWT, симметричный или асимметричный ключ.

## <a name="summary"></a>Сводка
В этом документе мы обсуждали CENC с несколькими собственными DRM и контролем доступа через проверку подлинности маркера: проектирование и реализацию системы с помощью Azure, служб мультимедиа Azure и Проигрывателя мультимедиа Azure.

* Мы представили справочную структуру, содержащую все необходимые компоненты в подсистеме DRM и CENC, а также
* справочную реализацию в Azure, службах мультимедиа Azure и Проигрывателе мультимедиа Azure.
* Мы также обсудили некоторые вопросы, напрямую связанные с проектированием и реализацией.

## <a name="media-services-learning-paths"></a>Схемы обучения работе со службами мультимедиа
[!INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a>Отзывы
[!INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]
 

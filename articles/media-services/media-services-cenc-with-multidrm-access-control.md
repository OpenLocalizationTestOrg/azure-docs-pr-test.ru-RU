---
title: "CENC с несколькими DRM и контролем доступа: справочное проектирование и реализация в Azure и службах мультимедиа Azure | Документация Майкрософт"
description: "Информация о лицензировании пакета для портирования клиента бесперебойной потоковой передачи Microsoft® Smooth Streaming"
services: media-services
documentationcenter: 
author: willzhan
manager: cfowler
editor: 
ms.assetid: 7814739b-cea9-4b9b-8370-538702e5c615
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/19/2017
ms.author: willzhan;kilroyh;yanmf;juliako
ms.openlocfilehash: 730917b6859f8dbd800ef2cb141062f45d7779ac
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="cenc-with-multi-drm-and-access-control-a-reference-design-and-implementation-on-azure-and-azure-media-services"></a><span data-ttu-id="e66e9-103">CENC с несколькими DRM и управление доступом: справочное проектирование и реализация в Azure и Azure Media Services</span><span class="sxs-lookup"><span data-stu-id="e66e9-103">CENC with Multi-DRM and Access Control: A Reference Design and Implementation on Azure and Azure Media Services</span></span>
 
## <a name="introduction"></a><span data-ttu-id="e66e9-104">Введение</span><span class="sxs-lookup"><span data-stu-id="e66e9-104">Introduction</span></span>
<span data-ttu-id="e66e9-105">Хорошо известно, что проектирование и построение подсистемы DRM для OTT или веб-решений для потоковой передачи — непростая задача.</span><span class="sxs-lookup"><span data-stu-id="e66e9-105">It is well known that it is a complex task to design and build a DRM subsystem for an OTT or online streaming solution.</span></span> <span data-ttu-id="e66e9-106">Поэтому общепринятой практикой операторов и поставщиков веб-видео является передача этой части на реализацию специализированным поставщикам служб DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-106">And it is a common practice for operators/online video providers to outsource this part to specialized DRM service providers.</span></span> <span data-ttu-id="e66e9-107">Цель данного документа — предоставить справочную разработку и реализацию готовой подсистемы DRM в OTT или веб-решении для потоковой передачи.</span><span class="sxs-lookup"><span data-stu-id="e66e9-107">The goal of this document is to present a reference design and implementation of end-to-end DRM subsystem in OTT or online streaming solution.</span></span>

<span data-ttu-id="e66e9-108">Этот документ предназначен для инженеров, работающих в подсистеме DRM OTT или с веб-решениями для потоковой передачи или с несколькими экранами, а также для всех читателей, заинтересованных в подсистеме DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-108">The targeted readers of this document are engineers working in DRM subsystem of OTT or online streaming/multi-screen solutions, or any readers interested in DRM subsystem.</span></span> <span data-ttu-id="e66e9-109">Предполагается, что читатели знакомы по крайней мере с одной из технологий DRM на рынке, например PlayReady, Widevine, FairPlay или Adobe Access.</span><span class="sxs-lookup"><span data-stu-id="e66e9-109">The assumption is that readers are familiar with at least one of the DRM technologies on the market, such as PlayReady, Widevine, FairPlay or Adobe Access.</span></span>

<span data-ttu-id="e66e9-110">Под DRM также понимается CENC (стандартное шифрование) с несколькими DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-110">By DRM, we also include CENC (Common Encryption) with multi-DRM.</span></span> <span data-ttu-id="e66e9-111">Основной тенденцией в отрасли интерактивной потоковой передачи и OTT является использование CENC с несколькими собственными DRM на различных клиентских платформах, что является переходом от предыдущей тенденции использования единого DRM и клиентского пакета SDK для различных клиентских платформ.</span><span class="sxs-lookup"><span data-stu-id="e66e9-111">A major trend in online streaming and OTT industry is to use CENC with multi-native-DRM on various client platforms, which is a shift from the previous trend of using a single DRM and its client SDK for various client platforms.</span></span> <span data-ttu-id="e66e9-112">При использовании CENC с несколькими собственными DRM и PlayReady, и Widevine шифруются посредством спецификации [стандартного шифрования (ISO/IEC 23001-7 CENC)](http://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm?csnumber=65271/) .</span><span class="sxs-lookup"><span data-stu-id="e66e9-112">When using CENC with multi-native-DRM, both PlayReady and Widevine are encrypted per the [Common Encryption (ISO/IEC 23001-7 CENC)](http://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm?csnumber=65271/) specification.</span></span>

<span data-ttu-id="e66e9-113">Ниже приведены преимущества CENC с несколькими DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-113">The benefits of CENC with multi-DRM are as follows:</span></span>

1. <span data-ttu-id="e66e9-114">Снижается стоимость шифрования, так как используется единая обработка шифрования для разных платформ с собственными DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-114">Reduces encryption cost since a single encryption processing is used targeting different platforms with its native DRMs;</span></span>
2. <span data-ttu-id="e66e9-115">Снижаются расходы на управление зашифрованными ресурсами, поскольку требуется только одна копия зашифрованных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="e66e9-115">Reduces the cost of managing encrypted assets since only a single copy of encrypted assets is needed;</span></span>
3. <span data-ttu-id="e66e9-116">Исключаются расходы на лицензирование клиента DRM, поскольку собственный клиент DRM обычно предоставляется бесплатно на собственной платформе.</span><span class="sxs-lookup"><span data-stu-id="e66e9-116">Eliminates DRM client licensing cost since the native DRM client is usually free on its native platform.</span></span>

<span data-ttu-id="e66e9-117">Майкрософт является активным распространителем DASH и CENC вместе с некоторыми крупнейшими компаниями отрасли.</span><span class="sxs-lookup"><span data-stu-id="e66e9-117">Microsoft has been an active promoter of DASH and CENC together with some major industry players.</span></span> <span data-ttu-id="e66e9-118">Службы мультимедиа Microsoft Azure предлагают поддержку DASH и CENC.</span><span class="sxs-lookup"><span data-stu-id="e66e9-118">Microsoft Azure Media Services has been providing support of DASH and CENC.</span></span> <span data-ttu-id="e66e9-119">Последние объявления см. в блогах Мингфея: [Представление служб доставки лицензий Google Widevine в службах мультимедиа Azure](https://azure.microsoft.com/blog/announcing-general-availability-of-google-widevine-license-services/) и [Службы мультимедиа Azure добавляют пакет Google Widevine для предоставления потока с несколькими DRM](https://azure.microsoft.com/blog/azure-media-services-adds-google-widevine-packaging-for-delivering-multi-drm-stream/).</span><span class="sxs-lookup"><span data-stu-id="e66e9-119">For recent announcements, please see Mingfei’s blogs: [Announcing Google Widevine license delivery services in Azure Media Services](https://azure.microsoft.com/blog/announcing-general-availability-of-google-widevine-license-services/), and [Azure Media Services adds Google Widevine packaging for delivering multi-DRM stream](https://azure.microsoft.com/blog/azure-media-services-adds-google-widevine-packaging-for-delivering-multi-drm-stream/).</span></span>  

### <a name="overview-of-this-article"></a><span data-ttu-id="e66e9-120">Описание раздела</span><span class="sxs-lookup"><span data-stu-id="e66e9-120">Overview of this article</span></span>
<span data-ttu-id="e66e9-121">Эта статья преследует следующие цели:</span><span class="sxs-lookup"><span data-stu-id="e66e9-121">The goal of this article includes the following:</span></span>

1. <span data-ttu-id="e66e9-122">Предоставляет справочное проектирование подсистемы DRM с помощью CENC с несколькими DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-122">Provides a reference design of DRM subsystem using CENC with multi-DRM;</span></span>
2. <span data-ttu-id="e66e9-123">Предоставляет справочную реализацию на платформе Microsoft Azure или служб мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="e66e9-123">Provides a reference implementation on Microsoft Azure/Azure Media Services platform;</span></span>
3. <span data-ttu-id="e66e9-124">Рассматривает некоторые вопросы проектирования и реализации.</span><span class="sxs-lookup"><span data-stu-id="e66e9-124">Discusses some design and implementation topics.</span></span>

<span data-ttu-id="e66e9-125">В этой статье термин "несколько DRM" распространяется на следующие технологии:</span><span class="sxs-lookup"><span data-stu-id="e66e9-125">In the article, “multi-DRM” covers the following:</span></span>

1. <span data-ttu-id="e66e9-126">Microsoft PlayReady</span><span class="sxs-lookup"><span data-stu-id="e66e9-126">Microsoft PlayReady</span></span>
2. <span data-ttu-id="e66e9-127">Google Widevine</span><span class="sxs-lookup"><span data-stu-id="e66e9-127">Google Widevine</span></span>
3. <span data-ttu-id="e66e9-128">Apple FairPlay</span><span class="sxs-lookup"><span data-stu-id="e66e9-128">Apple FairPlay</span></span> 

<span data-ttu-id="e66e9-129">В следующей таблице перечислены собственные платформы, приложения и браузеры, поддерживаемые каждой службой DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-129">The following table summarizes the native platform/native app, and browsers supported by each DRM.</span></span>

| <span data-ttu-id="e66e9-130">**Платформа клиента**</span><span class="sxs-lookup"><span data-stu-id="e66e9-130">**Client Platform**</span></span> | <span data-ttu-id="e66e9-131">**Поддержка собственного DRM**</span><span class="sxs-lookup"><span data-stu-id="e66e9-131">**Native DRM Support**</span></span> | <span data-ttu-id="e66e9-132">**Браузер или приложение**</span><span class="sxs-lookup"><span data-stu-id="e66e9-132">**Browser/App**</span></span> | <span data-ttu-id="e66e9-133">**Форматы потоковой передачи**</span><span class="sxs-lookup"><span data-stu-id="e66e9-133">**Streaming Formats**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="e66e9-134">**Смарт-ТВ, операторские STB, OTT STB**</span><span class="sxs-lookup"><span data-stu-id="e66e9-134">**Smart TVs, operator STBs, OTT STBs**</span></span> |<span data-ttu-id="e66e9-135">В основном PlayReady и (или) Widevine и (или) другие</span><span class="sxs-lookup"><span data-stu-id="e66e9-135">PlayReady primarily, and/or Widevine, and/or other</span></span> |<span data-ttu-id="e66e9-136">Linux, Opera и WebKit, другие</span><span class="sxs-lookup"><span data-stu-id="e66e9-136">Linux, Opera, WebKit, Other</span></span> |<span data-ttu-id="e66e9-137">Различные форматы</span><span class="sxs-lookup"><span data-stu-id="e66e9-137">Various formats</span></span> |
| <span data-ttu-id="e66e9-138">**Устройства Windows 10 (ПК Windows, планшеты Windows, Windows Phone, Xbox)**</span><span class="sxs-lookup"><span data-stu-id="e66e9-138">**Windows 10 devices (Windows PC, Windows Tablets, Windows Phone, Xbox)**</span></span> |<span data-ttu-id="e66e9-139">PlayReady</span><span class="sxs-lookup"><span data-stu-id="e66e9-139">PlayReady</span></span> |<span data-ttu-id="e66e9-140">MS Edge/IE11/EME</span><span class="sxs-lookup"><span data-stu-id="e66e9-140">MS Edge/IE11/EME</span></span><br/><br/><br/><span data-ttu-id="e66e9-141">UWP</span><span class="sxs-lookup"><span data-stu-id="e66e9-141">UWP</span></span> |<span data-ttu-id="e66e9-142">DASH (PlayReady не поддерживается для HLS)</span><span class="sxs-lookup"><span data-stu-id="e66e9-142">DASH (For HLS, PlayReady is not supported)</span></span><br/><br/><span data-ttu-id="e66e9-143">DASH, Smooth Streaming (PlayReady не поддерживается для HLS)</span><span class="sxs-lookup"><span data-stu-id="e66e9-143">DASH, Smooth Streaming (For HLS, PlayReady is not supported)</span></span> |
| <span data-ttu-id="e66e9-144">**Устройства Android (телефоны, планшеты, телевизоры)**</span><span class="sxs-lookup"><span data-stu-id="e66e9-144">**Android devices (Phone, Tablet, TV)**</span></span> |<span data-ttu-id="e66e9-145">Widevine</span><span class="sxs-lookup"><span data-stu-id="e66e9-145">Widevine</span></span> |<span data-ttu-id="e66e9-146">Chrome или EME</span><span class="sxs-lookup"><span data-stu-id="e66e9-146">Chrome/EME</span></span> |<span data-ttu-id="e66e9-147">DASH, HLS</span><span class="sxs-lookup"><span data-stu-id="e66e9-147">DASH,HLS</span></span> |
| <span data-ttu-id="e66e9-148">**iOS (iPhone, iPad), клиенты OS X и Apple TV**</span><span class="sxs-lookup"><span data-stu-id="e66e9-148">**iOS (iPhone, iPad), OS X clients and Apple TV**</span></span> |<span data-ttu-id="e66e9-149">FairPlay</span><span class="sxs-lookup"><span data-stu-id="e66e9-149">FairPlay</span></span> |<span data-ttu-id="e66e9-150">Safari 8+ или EME</span><span class="sxs-lookup"><span data-stu-id="e66e9-150">Safari 8+/EME</span></span> |<span data-ttu-id="e66e9-151">HLS</span><span class="sxs-lookup"><span data-stu-id="e66e9-151">HLS</span></span> |


<span data-ttu-id="e66e9-152">С учетом текущего состояния развертывания для каждого DRM службе обычно требуется реализовать 2 или 3 DRM, чтобы вы могли максимально эффективно использовать все типы конечных точек.</span><span class="sxs-lookup"><span data-stu-id="e66e9-152">Considering the current state of deployment for each DRM, a service will typically want to implement 2 or 3 DRMs to make sure you address all the types of endpoints in the best way.</span></span>

<span data-ttu-id="e66e9-153">Существует компромиссное решение, позволяющее справиться со сложностями логики службы и сложностями на стороне клиента по достижению определенного уровня работы пользователей на различных клиентах.</span><span class="sxs-lookup"><span data-stu-id="e66e9-153">There is a tradeoff between the complexity of the service logic and the complexity on the client side to reach a certain level of user experience on the various clients.</span></span>

<span data-ttu-id="e66e9-154">Делая выбор, необходимо иметь в виду следующие факты:</span><span class="sxs-lookup"><span data-stu-id="e66e9-154">To make your selection, keep in mind these facts:</span></span>

* <span data-ttu-id="e66e9-155">Технология PlayReady изначально реализована на всех устройствах Windows, на некоторых устройствах Android и доступна в пакетах SDK программ практически на любой платформе.</span><span class="sxs-lookup"><span data-stu-id="e66e9-155">PlayReady is natively implemented in every Windows device, on some Android devices, and available through software SDKs on virtually any platform</span></span>
* <span data-ttu-id="e66e9-156">Widevine изначально реализована на каждом устройстве Android, Chrome и некоторых других устройствах.</span><span class="sxs-lookup"><span data-stu-id="e66e9-156">Widevine is natively implemented in every Android device, in Chrome, and in some other devices</span></span>
* <span data-ttu-id="e66e9-157">Технология FairPlay доступна только на клиентах iOS и Mac OS или через iTunes.</span><span class="sxs-lookup"><span data-stu-id="e66e9-157">FairPlay is available only on iOS and Mac OS clients or through iTunes.</span></span>

<span data-ttu-id="e66e9-158">Поэтому обычные несколько DRM будут выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="e66e9-158">So a typical multi-DRM would be:</span></span>

* <span data-ttu-id="e66e9-159">Вариант 1. PlayReady и Widevine</span><span class="sxs-lookup"><span data-stu-id="e66e9-159">Option 1: PlayReady and Widevine</span></span>
* <span data-ttu-id="e66e9-160">Вариант 2. PlayReady, Widevine и FairPlay</span><span class="sxs-lookup"><span data-stu-id="e66e9-160">Option 2: PlayReady, Widevine and FairPlay</span></span>

## <a name="a-reference-design"></a><span data-ttu-id="e66e9-161">Справочное проектирование</span><span class="sxs-lookup"><span data-stu-id="e66e9-161">A reference design</span></span>
<span data-ttu-id="e66e9-162">В этом разделе мы представим справочное проектирование, которое не зависит от технологий, используемых для его реализации.</span><span class="sxs-lookup"><span data-stu-id="e66e9-162">In this section, we will present a reference design which is agnostic to technologies used to implement it.</span></span>

<span data-ttu-id="e66e9-163">Подсистема DRM может содержать следующие компоненты:</span><span class="sxs-lookup"><span data-stu-id="e66e9-163">A DRM subsystem may contain the following components:</span></span>

1. <span data-ttu-id="e66e9-164">Управление ключами</span><span class="sxs-lookup"><span data-stu-id="e66e9-164">Key management</span></span>
2. <span data-ttu-id="e66e9-165">Упаковка DRM</span><span class="sxs-lookup"><span data-stu-id="e66e9-165">DRM packaging</span></span>
3. <span data-ttu-id="e66e9-166">Доставка лицензий DRM</span><span class="sxs-lookup"><span data-stu-id="e66e9-166">DRM license delivery</span></span>
4. <span data-ttu-id="e66e9-167">Проверка прав</span><span class="sxs-lookup"><span data-stu-id="e66e9-167">Entitlement check</span></span>
5. <span data-ttu-id="e66e9-168">Проверка подлинности и авторизация</span><span class="sxs-lookup"><span data-stu-id="e66e9-168">Authentication/authorization</span></span>
6. <span data-ttu-id="e66e9-169">Проигрыватель</span><span class="sxs-lookup"><span data-stu-id="e66e9-169">Player</span></span>
7. <span data-ttu-id="e66e9-170">Происхождение и CDN</span><span class="sxs-lookup"><span data-stu-id="e66e9-170">Origin/CDN</span></span>

<span data-ttu-id="e66e9-171">На следующей схеме представлено взаимодействие высокого уровня между компонентами в подсистеме DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-171">The following diagram illustrates the high level interaction among the components in a DRM subsystem.</span></span>

![Подсистема DRM с CENC](./media/media-services-cenc-with-multidrm-access-control/media-services-generic-drm-subsystem-with-cenc.png)

<span data-ttu-id="e66e9-173">Существует три основных "уровня" в структуре.</span><span class="sxs-lookup"><span data-stu-id="e66e9-173">There are three basic “layers” in the design:</span></span>

1. <span data-ttu-id="e66e9-174">Уровень главного офиса (обозначен черным цветом), который не предоставляется внешним объектам.</span><span class="sxs-lookup"><span data-stu-id="e66e9-174">Back office layer (in black) which are not exposed externally;</span></span>
2. <span data-ttu-id="e66e9-175">Уровень "DMZ" (синий), содержащий все общедоступные конечные точки.</span><span class="sxs-lookup"><span data-stu-id="e66e9-175">“DMZ” layer (blue) containing all the endpoints facing public;</span></span>
3. <span data-ttu-id="e66e9-176">Уровень общедоступного Интернета (светло-синий), содержащий CDN и проигрыватели с трафиком через общедоступный Интернет.</span><span class="sxs-lookup"><span data-stu-id="e66e9-176">Public Internet layer (light blue) containing CDN and players with traffic across public Internet.</span></span>

<span data-ttu-id="e66e9-177">Должно быть средство управления содержимым для контроля защиты DRM независимо от используемого шифрования (статического или динамического).</span><span class="sxs-lookup"><span data-stu-id="e66e9-177">There should be a content management tool for controlling DRM protection, regardless it is static or dynamic encryption.</span></span> <span data-ttu-id="e66e9-178">Входные данные для шифрования DRM должны включать:</span><span class="sxs-lookup"><span data-stu-id="e66e9-178">The inputs for DRM encryption should include:</span></span>

1. <span data-ttu-id="e66e9-179">видеосодержимое MBR;</span><span class="sxs-lookup"><span data-stu-id="e66e9-179">MBR video content;</span></span>
2. <span data-ttu-id="e66e9-180">ключ содержимого;</span><span class="sxs-lookup"><span data-stu-id="e66e9-180">Content key;</span></span>
3. <span data-ttu-id="e66e9-181">URL-адреса для приобретения лицензии.</span><span class="sxs-lookup"><span data-stu-id="e66e9-181">License acquisition URLs.</span></span>

<span data-ttu-id="e66e9-182">Во время воспроизведения поток верхнего уровня включает:</span><span class="sxs-lookup"><span data-stu-id="e66e9-182">During playback time, the high level flow is:</span></span>

1. <span data-ttu-id="e66e9-183">проверку подлинности пользователя;</span><span class="sxs-lookup"><span data-stu-id="e66e9-183">User is authenticated;</span></span>
2. <span data-ttu-id="e66e9-184">создание маркера авторизации пользователя;</span><span class="sxs-lookup"><span data-stu-id="e66e9-184">Authorization token is created for the user;</span></span>
3. <span data-ttu-id="e66e9-185">загрузку защищенного DRM содержимого (манифест) в проигрыватель;</span><span class="sxs-lookup"><span data-stu-id="e66e9-185">DRM protected content (manifest) is downloaded to player;</span></span>
4. <span data-ttu-id="e66e9-186">отправку проигрывателем запроса на приобретение лицензий на серверы лицензий вместе с идентификатором ключа и маркером авторизации.</span><span class="sxs-lookup"><span data-stu-id="e66e9-186">Player submits license acquisition request to license servers together with key ID and authorization token.</span></span>

<span data-ttu-id="e66e9-187">Перед переходом к следующему разделу несколько слов о проектировании управления ключами.</span><span class="sxs-lookup"><span data-stu-id="e66e9-187">Before moving to the next topic, a few words about the design of key management.</span></span>

| <span data-ttu-id="e66e9-188">**Ключ содержимого/ресурс**</span><span class="sxs-lookup"><span data-stu-id="e66e9-188">**ContentKey–to-Asset**</span></span> | <span data-ttu-id="e66e9-189">**Сценарий**</span><span class="sxs-lookup"><span data-stu-id="e66e9-189">**Scenario**</span></span> |
| --- | --- |
| <span data-ttu-id="e66e9-190">1 ключ/1 ресурс</span><span class="sxs-lookup"><span data-stu-id="e66e9-190">1–to-1</span></span> |<span data-ttu-id="e66e9-191">Простейший случай.</span><span class="sxs-lookup"><span data-stu-id="e66e9-191">The simplest case.</span></span> <span data-ttu-id="e66e9-192">Он предоставляет самый лучший контроль.</span><span class="sxs-lookup"><span data-stu-id="e66e9-192">It provides the finest control.</span></span> <span data-ttu-id="e66e9-193">Однако обычно это приводит к наибольшей стоимости доставки лицензий.</span><span class="sxs-lookup"><span data-stu-id="e66e9-193">But this generally results in the highest license delivery cost.</span></span> <span data-ttu-id="e66e9-194">Для каждого защищенного ресурса требуется минимум один запрос лицензии.</span><span class="sxs-lookup"><span data-stu-id="e66e9-194">At minimum one license request is required for each protected asset.</span></span> |
| <span data-ttu-id="e66e9-195">1 ключ/несколько ресурсов</span><span class="sxs-lookup"><span data-stu-id="e66e9-195">1–to-Many</span></span> |<span data-ttu-id="e66e9-196">Можно использовать тот же ключ содержимого для нескольких ресурсов.</span><span class="sxs-lookup"><span data-stu-id="e66e9-196">You could use the same content key for multiple assets.</span></span> <span data-ttu-id="e66e9-197">Например, для всех ресурсов в логической группе, такой как жанр или подмножество жанров (или жанр фильма), можно использовать один ключ содержимого.</span><span class="sxs-lookup"><span data-stu-id="e66e9-197">For example, for all the assets in a logical group such as a genre or subset of genre (or Movie Gene), you could use a single content key.</span></span> |
| <span data-ttu-id="e66e9-198">Несколько ключей/1 ресурс</span><span class="sxs-lookup"><span data-stu-id="e66e9-198">Many–to-1</span></span> |<span data-ttu-id="e66e9-199">Несколько ключей содержимого необходимы для каждого ресурса.</span><span class="sxs-lookup"><span data-stu-id="e66e9-199">Multiple content keys are needed for each asset.</span></span> <br/><br/><span data-ttu-id="e66e9-200">Например, если необходимо применить динамическую защиту CENC с несколькими DRM для MPEG-DASH и динамическое шифрование AES-128 для HLS, требуется два отдельных ключа содержимого, каждый из которых имеет свой собственный ContentKeyType.</span><span class="sxs-lookup"><span data-stu-id="e66e9-200">For example, if you need to apply dynamic CENC protection with multi-DRM for MPEG-DASH, and dynamic AES-128 encryption for HLS, you need two separate content keys, each with its own ContentKeyType.</span></span> <span data-ttu-id="e66e9-201">(Для ключа содержимого, используемого для динамической защиты CENC, следует применять ContentKeyType.CommonEncryption. А для ключа содержимого, применяемого для динамического шифрования AES-128, используйте ContentKeyType.EnvelopeEncryption).</span><span class="sxs-lookup"><span data-stu-id="e66e9-201">(For the content key used for dynamic CENC protection, ContentKeyType.CommonEncryption should be used, while for the content key used for dynamic AES-128 encryption, ContentKeyType.EnvelopeEncryption should be used.)</span></span><br/><br/><span data-ttu-id="e66e9-202">Другой пример: в защите CENC содержимого DASH теоретически можно использовать один ключ содержимого для защиты видеопотока и другой ключ содержимого для защиты аудиопотока.</span><span class="sxs-lookup"><span data-stu-id="e66e9-202">Another example, in CENC protection of DASH content, in theory, one content key can be used to protect video stream and another content key to protect audio stream.</span></span> |
| <span data-ttu-id="e66e9-203">Несколько ключей/несколько ресурсов</span><span class="sxs-lookup"><span data-stu-id="e66e9-203">Many – to - Many</span></span> |<span data-ttu-id="e66e9-204">Сочетание описанных выше двух сценариев: один набор ключей содержимого используется для каждого из нескольких ресурсов в одной группе ресурсов.</span><span class="sxs-lookup"><span data-stu-id="e66e9-204">Combination of the above two scenarios: one set of content keys are used for each of the multiple assets in the same asset “group”.</span></span> |

<span data-ttu-id="e66e9-205">Другим важным вопросом является использование постоянных и временных лицензий.</span><span class="sxs-lookup"><span data-stu-id="e66e9-205">Another important factor to consider is the use of persistent and non-persistent licenses.</span></span>

<span data-ttu-id="e66e9-206">Почему эти вопросы важны?</span><span class="sxs-lookup"><span data-stu-id="e66e9-206">Why are these considerations important?</span></span>

<span data-ttu-id="e66e9-207">Они имеют непосредственное влияние на стоимость доставки лицензий при использовании общедоступного облака для доставки лицензий.</span><span class="sxs-lookup"><span data-stu-id="e66e9-207">They have direct impact to license delivery cost if you use public cloud for license delivery.</span></span> <span data-ttu-id="e66e9-208">Рассмотрим следующие два случая разных структур для иллюстрации.</span><span class="sxs-lookup"><span data-stu-id="e66e9-208">Let’s consider the following two different design cases to illustrate:</span></span>

1. <span data-ttu-id="e66e9-209">Ежемесячная подписка: используйте постоянную лицензию и 1 ключ содержимого для нескольких ресурсов.</span><span class="sxs-lookup"><span data-stu-id="e66e9-209">Monthly subscription: Use persistent license, and 1-to-many content key-to-asset mapping.</span></span> <span data-ttu-id="e66e9-210">Например: </span><span class="sxs-lookup"><span data-stu-id="e66e9-210">E.g.</span></span> <span data-ttu-id="e66e9-211">для всех детских фильмов мы используем один ключ содержимого для шифрования.</span><span class="sxs-lookup"><span data-stu-id="e66e9-211">for all the kids movies, we use a single content key for encryption.</span></span> <span data-ttu-id="e66e9-212">В данном случае:</span><span class="sxs-lookup"><span data-stu-id="e66e9-212">In this case:</span></span>

    <span data-ttu-id="e66e9-213">Общее число лицензий, запрашиваемых для всех детских фильмов или устройств = 1</span><span class="sxs-lookup"><span data-stu-id="e66e9-213">Total # licenses requested for all kids movies/device = 1</span></span>
2. <span data-ttu-id="e66e9-214">Ежемесячная подписка: используйте временную лицензию и 1 ключ содержимого для 1 ресурса.</span><span class="sxs-lookup"><span data-stu-id="e66e9-214">Monthly subscription: Use non-persistent license, and 1-to-1 mapping between content key and asset.</span></span> <span data-ttu-id="e66e9-215">В данном случае:</span><span class="sxs-lookup"><span data-stu-id="e66e9-215">In this case:</span></span>

    <span data-ttu-id="e66e9-216">Общее число лицензий, запрашиваемых для всех детских фильмов или устройств = [число просмотренных фильмов] x [число сеансов]</span><span class="sxs-lookup"><span data-stu-id="e66e9-216">Total # licenses requested for all kids movies/device = [# movies watched] x [# sessions]</span></span>

<span data-ttu-id="e66e9-217">Как видите, два различных варианта дают очень разные шаблоны запросов лицензий, а следовательно, и затраты на доставку лицензий, если доставка лицензий осуществляется через общедоступное облако, например через службы мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="e66e9-217">As you can easily see, the two different designs result in very different license request patterns hence license delivery cost if license delivery service is provided by a public cloud such as Azure Media Services.</span></span>

## <a name="mapping-design-to-technology-for-implementation"></a><span data-ttu-id="e66e9-218">Сопоставление структуры и технологии для реализации</span><span class="sxs-lookup"><span data-stu-id="e66e9-218">Mapping design to technology for implementation</span></span>
<span data-ttu-id="e66e9-219">Далее мы сопоставим универсальную структуру и технологии на платформе Microsoft Azure и служб мультимедиа Azure, указав, какую технологию использовать для каждого стандартного блока.</span><span class="sxs-lookup"><span data-stu-id="e66e9-219">Next, we map our generic design to technologies on Microsoft Azure/Azure Media Services platform, by specifying which technology to use for each building block.</span></span>

<span data-ttu-id="e66e9-220">Сопоставление показано в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="e66e9-220">The following table shows the mapping:</span></span>

| <span data-ttu-id="e66e9-221">**Стандартный блок**</span><span class="sxs-lookup"><span data-stu-id="e66e9-221">**Building Block**</span></span> | <span data-ttu-id="e66e9-222">**Технология**</span><span class="sxs-lookup"><span data-stu-id="e66e9-222">**Technology**</span></span> |
| --- | --- |
| <span data-ttu-id="e66e9-223">**Проигрыватель**</span><span class="sxs-lookup"><span data-stu-id="e66e9-223">**Player**</span></span> |[<span data-ttu-id="e66e9-224">Проигрыватель мультимедиа Azure</span><span class="sxs-lookup"><span data-stu-id="e66e9-224">Azure Media Player</span></span>](https://azure.microsoft.com/services/media-services/media-player/) |
| <span data-ttu-id="e66e9-225">**Поставщик удостоверений (IDP)**</span><span class="sxs-lookup"><span data-stu-id="e66e9-225">**Identity Provider (IDP)**</span></span> |<span data-ttu-id="e66e9-226">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="e66e9-226">Azure Active Directory</span></span> |
| <span data-ttu-id="e66e9-227">**Служба маркеров безопасности (STS)**</span><span class="sxs-lookup"><span data-stu-id="e66e9-227">**Secure Token Service (STS)**</span></span> |<span data-ttu-id="e66e9-228">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="e66e9-228">Azure Active Directory</span></span> |
| <span data-ttu-id="e66e9-229">**Рабочий процесс защиты DRM**</span><span class="sxs-lookup"><span data-stu-id="e66e9-229">**DRM Protection Workflow**</span></span> |<span data-ttu-id="e66e9-230">Динамическая защита служб мультимедиа Azure</span><span class="sxs-lookup"><span data-stu-id="e66e9-230">Azure Media Services Dynamic Protection</span></span> |
| <span data-ttu-id="e66e9-231">**Доставка лицензий DRM**</span><span class="sxs-lookup"><span data-stu-id="e66e9-231">**DRM License Delivery**</span></span> |<span data-ttu-id="e66e9-232">1. Доставка лицензий служб мультимедиа Azure (PlayReady, Widevine, FairPlay), или</span><span class="sxs-lookup"><span data-stu-id="e66e9-232">1. Azure Media Services License Delivery (PlayReady, Widevine, FairPlay), or</span></span> <br/><span data-ttu-id="e66e9-233">2. Axinom License Server,</span><span class="sxs-lookup"><span data-stu-id="e66e9-233">2. Axinom License Server,</span></span> <br/><span data-ttu-id="e66e9-234">3. Пользовательский сервер лицензирования PlayReady</span><span class="sxs-lookup"><span data-stu-id="e66e9-234">3. Custom PlayReady License Server</span></span> |
| <span data-ttu-id="e66e9-235">**Исходный домен**</span><span class="sxs-lookup"><span data-stu-id="e66e9-235">**Origin**</span></span> |<span data-ttu-id="e66e9-236">Конечная точка потоковой передачи служб мультимедиа Azure</span><span class="sxs-lookup"><span data-stu-id="e66e9-236">Azure Media Services Streaming Endpoint</span></span> |
| <span data-ttu-id="e66e9-237">**Управление ключами**</span><span class="sxs-lookup"><span data-stu-id="e66e9-237">**Key Management**</span></span> |<span data-ttu-id="e66e9-238">Не требуется для справочной реализации</span><span class="sxs-lookup"><span data-stu-id="e66e9-238">Not needed for reference implementation</span></span> |
| <span data-ttu-id="e66e9-239">**Управление содержимым**</span><span class="sxs-lookup"><span data-stu-id="e66e9-239">**Content Management**</span></span> |<span data-ttu-id="e66e9-240">Консольное приложение C#</span><span class="sxs-lookup"><span data-stu-id="e66e9-240">A C# console application</span></span> |

<span data-ttu-id="e66e9-241">Другими словами, и поставщиком удостоверений (IDP), и службой маркеров безопасности (STS) будет Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-241">In other words, both Identity Provider (IDP) and Secure Token Service (STS) will be Azure AD.</span></span> <span data-ttu-id="e66e9-242">Для проигрывателя мы будем использовать [API Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/).</span><span class="sxs-lookup"><span data-stu-id="e66e9-242">For player, we will use [Azure Media Player API](http://amp.azure.net/libs/amp/latest/docs/).</span></span> <span data-ttu-id="e66e9-243">Службы мультимедиа Azure и Проигрыватель Мультимедиа Azure поддерживают DASH и CENC с несколькими DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-243">Both Azure Media Services and Azure Media Player support DASH and CENC with multi-DRM.</span></span>

<span data-ttu-id="e66e9-244">Следующая схема показывает общую структуру и поток с описанным выше сопоставлением технологии.</span><span class="sxs-lookup"><span data-stu-id="e66e9-244">The following diagram shows the overall structure and flow with the above technology mapping.</span></span>

![CENC на AMS](./media/media-services-cenc-with-multidrm-access-control/media-services-cenc-subsystem-on-AMS-platform.png)

<span data-ttu-id="e66e9-246">Чтобы настроить динамическое шифрование CENC, средство управления содержимым будет использовать следующие входные данные:</span><span class="sxs-lookup"><span data-stu-id="e66e9-246">In order to set up dynamic CENC encryption, the content management tool will use the following inputs:</span></span>

1. <span data-ttu-id="e66e9-247">открывание содержимого;</span><span class="sxs-lookup"><span data-stu-id="e66e9-247">Open content;</span></span>
2. <span data-ttu-id="e66e9-248">ключ содержимого из раздела создания и управления ключом;</span><span class="sxs-lookup"><span data-stu-id="e66e9-248">Content key from key generation/management;</span></span>
3. <span data-ttu-id="e66e9-249">URL-адреса для приобретения лицензии;</span><span class="sxs-lookup"><span data-stu-id="e66e9-249">License acquisition URLs;</span></span>
4. <span data-ttu-id="e66e9-250">список сведений из Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-250">A list of information from Azure AD.</span></span>

<span data-ttu-id="e66e9-251">Выходные данные средства управления содержимым будут выглядеть так:</span><span class="sxs-lookup"><span data-stu-id="e66e9-251">The output of the content management tool will be:</span></span>

1. <span data-ttu-id="e66e9-252">ContentKeyAuthorizationPolicy, содержащая спецификацию на способ доставки лицензий, проверяет маркер JWT и спецификации лицензий DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-252">ContentKeyAuthorizationPolicy containing the specification on how license delivery verifies a JWT token and DRM license specifications;</span></span>
2. <span data-ttu-id="e66e9-253">AssetDeliveryPolicy, содержащая спецификации потоковых форматов, защиту DRM и URL-адреса приобретения лицензий.</span><span class="sxs-lookup"><span data-stu-id="e66e9-253">AssetDeliveryPolicy containing specifications on streaming format, DRM protection and license acquisition URLs.</span></span>

<span data-ttu-id="e66e9-254">Во время выполнения поток выглядит так:</span><span class="sxs-lookup"><span data-stu-id="e66e9-254">During runtime, the flow is as below:</span></span>

1. <span data-ttu-id="e66e9-255">После проверки подлинности пользователя создается маркер JWT.</span><span class="sxs-lookup"><span data-stu-id="e66e9-255">Upon user authentication, a JWT token is generated;</span></span>
2. <span data-ttu-id="e66e9-256">Одно из утверждений, содержащихся в маркере JWT, является утверждением "группы" и содержит идентификатор объекта группы "EntitledUserGroup".</span><span class="sxs-lookup"><span data-stu-id="e66e9-256">One of the claims contained in the JWT token is “groups” claim containing the group object ID of “EntitledUserGroup”.</span></span> <span data-ttu-id="e66e9-257">Это утверждение будет использоваться для передачи "проверка права".</span><span class="sxs-lookup"><span data-stu-id="e66e9-257">This claim will be used for passing “entitlement check”.</span></span>
3. <span data-ttu-id="e66e9-258">Проигрыватель загружает манифест клиента защищенного CENC содержимого и "видит" следующее:</span><span class="sxs-lookup"><span data-stu-id="e66e9-258">Player downloads client manifest of a CENC protected content and “sees” the following:</span></span>

   1. <span data-ttu-id="e66e9-259">идентификатор ключа;</span><span class="sxs-lookup"><span data-stu-id="e66e9-259">key ID,</span></span>
   2. <span data-ttu-id="e66e9-260">содержимое защищено CENC;</span><span class="sxs-lookup"><span data-stu-id="e66e9-260">the content is CENC protected,</span></span>
   3. <span data-ttu-id="e66e9-261">URL-адреса для приобретения лицензии.</span><span class="sxs-lookup"><span data-stu-id="e66e9-261">License acquisition URLs.</span></span>
4. <span data-ttu-id="e66e9-262">Проигрыватель делает запрос на приобретение лицензий на основании поддерживаемого браузера и DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-262">Player makes a license acquisition request based on the browser/DRM supported.</span></span> <span data-ttu-id="e66e9-263">Идентификатор ключа и маркер JWT также отправляются в запросе на приобретение лицензии.</span><span class="sxs-lookup"><span data-stu-id="e66e9-263">In the license acquisition request, key ID and the JWT token will also be submitted.</span></span> <span data-ttu-id="e66e9-264">Служба доставки лицензий проверит маркер JWT и утверждения, содержащиеся перед выдачей необходимых лицензий.</span><span class="sxs-lookup"><span data-stu-id="e66e9-264">License delivery service will verify the JWT token and the claims contained before issuing the needed license.</span></span>

## <a name="implementation"></a><span data-ttu-id="e66e9-265">Реализация</span><span class="sxs-lookup"><span data-stu-id="e66e9-265">Implementation</span></span>
### <a name="implementation-procedures"></a><span data-ttu-id="e66e9-266">Процедуры реализации</span><span class="sxs-lookup"><span data-stu-id="e66e9-266">Implementation procedures</span></span>
<span data-ttu-id="e66e9-267">Реализация будет включать следующие шаги.</span><span class="sxs-lookup"><span data-stu-id="e66e9-267">The implementation will include the following steps:</span></span>

1. <span data-ttu-id="e66e9-268">Подготовка тестовых ресурсов: кодирование или упаковка тестового видео в формат MP4 с разными скоростями в службах мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="e66e9-268">Prepare test asset(s): encode/package a test video to multi-bitrate fragmented MP4 in Azure Media Services.</span></span> <span data-ttu-id="e66e9-269">Этот ресурс НЕ защищен DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-269">This asset is NOT DRM protected.</span></span> <span data-ttu-id="e66e9-270">Защита DRM будет реализована позже с помощью динамической защиты.</span><span class="sxs-lookup"><span data-stu-id="e66e9-270">DRM protection will be done by dynamic protection later.</span></span>
2. <span data-ttu-id="e66e9-271">Создание идентификатора ключа и ключа содержимого (при необходимости из начального значения).</span><span class="sxs-lookup"><span data-stu-id="e66e9-271">Create key ID and content key (optionally from key seed).</span></span> <span data-ttu-id="e66e9-272">Для наших целей система управления ключами не требуется, поскольку мы имеем дело только с одним набором идентификатора ключа и ключа содержимого для нескольких тестовых ресурсов.</span><span class="sxs-lookup"><span data-stu-id="e66e9-272">For our purpose, key management system is not needed since we are dealing with only a single set of key ID and content key for a couple of test assets;</span></span>
3. <span data-ttu-id="e66e9-273">Используйте API AMS для настройки службы доставки лицензий с несколькими DRM для тестовых ресурсов.</span><span class="sxs-lookup"><span data-stu-id="e66e9-273">Use AMS API to configure multi-DRM license delivery services for the test asset.</span></span> <span data-ttu-id="e66e9-274">Если ваша компания или поставщик компании использует пользовательские серверы лицензий вместо служб лицензирования в службах мультимедиа Azure, можно пропустить этот шаг и указать URL-адреса приобретения лицензий на этапе настройки доставки лицензий.</span><span class="sxs-lookup"><span data-stu-id="e66e9-274">If you are using custom license servers by your company or your company’s vendors instead of license services in Azure Media Services, you can skip this step and specify license acquisition URLs in the step for configuring license delivery.</span></span> <span data-ttu-id="e66e9-275">API AMS необходим, чтобы указать подробные конфигурации, например ограничения политики авторизации, шаблоны ответов лицензий для различных лицензионных служб DRM и т. д. В настоящее время портал Azure пока не предоставляет необходимый пользовательский интерфейс для этой конфигурации.</span><span class="sxs-lookup"><span data-stu-id="e66e9-275">AMS API is needed to specify some detailed configurations, such as authorization policy restriction, license response templates for different DRM license services, etc. At this time, the Azure portal does not yet provide the needed UI for this configuration.</span></span> <span data-ttu-id="e66e9-276">Сведения об уровне API и образец кода см. в статье Юлии Корнич (Julia Kornich): [Использование общего динамического шифрования PlayReady и (или) Widevine DRM](media-services-protect-with-drm.md).</span><span class="sxs-lookup"><span data-stu-id="e66e9-276">You can find API level info and sample code in Julia Kornich’s document: [Using PlayReady and/or Widevine Dynamic Common Encryption](media-services-protect-with-drm.md).</span></span>
4. <span data-ttu-id="e66e9-277">Используйте API AMS для настройки политики доставки ресурсов для тестовых ресурсов.</span><span class="sxs-lookup"><span data-stu-id="e66e9-277">Use AMS API to configure asset delivery policy for the test asset.</span></span> <span data-ttu-id="e66e9-278">Сведения об уровне API и образец кода см. в статье Юлии Корнич (Julia Kornich): [Использование общего динамического шифрования PlayReady и (или) Widevine DRM](media-services-protect-with-drm.md).</span><span class="sxs-lookup"><span data-stu-id="e66e9-278">You can find API level info and sample code in Julia Kornich’s document: [Using PlayReady and/or Widevine Dynamic Common Encryption](media-services-protect-with-drm.md).</span></span>
5. <span data-ttu-id="e66e9-279">Создание и настройка клиента Azure Active Directory в Azure</span><span class="sxs-lookup"><span data-stu-id="e66e9-279">Create and configure an Azure Active Directory tenant in Azure;</span></span>
6. <span data-ttu-id="e66e9-280">Создайте несколько учетных записей пользователей и групп в клиенте Azure Active Directory: необходимо создать, по крайней мере, группу "EntitledUser" и добавить пользователя в эту группу.</span><span class="sxs-lookup"><span data-stu-id="e66e9-280">Create a few user accounts and groups in your Azure Active Directory tenant: you should create at least “EntitledUser” group and add a user to this group.</span></span> <span data-ttu-id="e66e9-281">Пользователи в этой группе будут проходить проверку прав при приобретении лицензий, и пользователи, не входящие в эту группу, не смогут пройти проверку подлинности и получить лицензии.</span><span class="sxs-lookup"><span data-stu-id="e66e9-281">Users in this group will pass entitlement check in license acquisition and users not in this group will fail to pass authentication check and will not be able to acquire any license.</span></span> <span data-ttu-id="e66e9-282">Членство в этой группе "EntitledUser" является обязательным утверждением "группы" в маркере JWT, выданном Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-282">Being a member of this “EntitledUser” group is a required “groups” claim in the JWT token issued by Azure AD.</span></span> <span data-ttu-id="e66e9-283">Это требование утверждения должно быть указано при настройке служб доставки лицензий с несколькими DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-283">This claim requirement should be specified in configuring multi-DRM license delivery services step.</span></span>
7. <span data-ttu-id="e66e9-284">Создайте приложение ASP.NET MVC, в котором будет размещен видеопроигрыватель.</span><span class="sxs-lookup"><span data-stu-id="e66e9-284">Create an ASP.NET MVC app which will be hosting your video player.</span></span> <span data-ttu-id="e66e9-285">Это приложение ASP.NET будет защищено с помощью проверки подлинности пользователей в клиенте Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="e66e9-285">This ASP.NET app will be protected with user authentication against the Azure Active Directory tenant.</span></span> <span data-ttu-id="e66e9-286">Соответствующие утверждения будут включены в маркеры доступа, получаемые после проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="e66e9-286">Proper claims will be included in the access tokens obtained after user authentication.</span></span> <span data-ttu-id="e66e9-287">В этом шаге рекомендуется использовать API OpenID Connect.</span><span class="sxs-lookup"><span data-stu-id="e66e9-287">OpenID Connect API is recommended for this step.</span></span> <span data-ttu-id="e66e9-288">Необходимо установить следующие пакеты NuGet:</span><span class="sxs-lookup"><span data-stu-id="e66e9-288">You need to install the following NuGet packages:</span></span>
   * <span data-ttu-id="e66e9-289">Install-Package Microsoft.Azure.ActiveDirectory.GraphClient</span><span class="sxs-lookup"><span data-stu-id="e66e9-289">Install-Package Microsoft.Azure.ActiveDirectory.GraphClient</span></span>
   * <span data-ttu-id="e66e9-290">Install-Package Microsoft.Owin.Security.OpenIdConnect</span><span class="sxs-lookup"><span data-stu-id="e66e9-290">Install-Package Microsoft.Owin.Security.OpenIdConnect</span></span>
   * <span data-ttu-id="e66e9-291">Install-Package Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="e66e9-291">Install-Package Microsoft.Owin.Security.Cookies</span></span>
   * <span data-ttu-id="e66e9-292">Install-Package Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="e66e9-292">Install-Package Microsoft.Owin.Host.SystemWeb</span></span>
   * <span data-ttu-id="e66e9-293">Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory</span><span class="sxs-lookup"><span data-stu-id="e66e9-293">Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory</span></span>
8. <span data-ttu-id="e66e9-294">Создайте проигрыватель с помощью [API Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/).</span><span class="sxs-lookup"><span data-stu-id="e66e9-294">Create a player using [Azure Media Player API](http://amp.azure.net/libs/amp/latest/docs/).</span></span> <span data-ttu-id="e66e9-295">[API ProtectionInfo Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/) позволяет указать, какие технологии DRM следует использовать на разных платформах DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-295">[Azure Media Player’s ProtectionInfo API](http://amp.azure.net/libs/amp/latest/docs/) allows you to specify which DRM technology to use on different DRM platform.</span></span>
9. <span data-ttu-id="e66e9-296">Тестовая матрица:</span><span class="sxs-lookup"><span data-stu-id="e66e9-296">Test matrix:</span></span>

| <span data-ttu-id="e66e9-297">**DRM**</span><span class="sxs-lookup"><span data-stu-id="e66e9-297">**DRM**</span></span> | <span data-ttu-id="e66e9-298">**"Обзор"**</span><span class="sxs-lookup"><span data-stu-id="e66e9-298">**Browser**</span></span> | <span data-ttu-id="e66e9-299">**Результат для соответствующего пользователя**</span><span class="sxs-lookup"><span data-stu-id="e66e9-299">**Result for Entitled User**</span></span> | <span data-ttu-id="e66e9-300">**Результат для не соответствующего пользователя**</span><span class="sxs-lookup"><span data-stu-id="e66e9-300">**Result for Un-entitled User**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="e66e9-301">**PlayReady**</span><span class="sxs-lookup"><span data-stu-id="e66e9-301">**PlayReady**</span></span> |<span data-ttu-id="e66e9-302">MS Edge или IE11 на Windows 10</span><span class="sxs-lookup"><span data-stu-id="e66e9-302">MS Edge or IE11 on Windows 10</span></span> |<span data-ttu-id="e66e9-303">Успешно</span><span class="sxs-lookup"><span data-stu-id="e66e9-303">Succeed</span></span> |<span data-ttu-id="e66e9-304">Fail;</span><span class="sxs-lookup"><span data-stu-id="e66e9-304">Fail</span></span> |
| <span data-ttu-id="e66e9-305">**Widevine**</span><span class="sxs-lookup"><span data-stu-id="e66e9-305">**Widevine**</span></span> |<span data-ttu-id="e66e9-306">Chrome на Windows 10</span><span class="sxs-lookup"><span data-stu-id="e66e9-306">Chrome on Windows 10</span></span> |<span data-ttu-id="e66e9-307">Успешно</span><span class="sxs-lookup"><span data-stu-id="e66e9-307">Succeed</span></span> |<span data-ttu-id="e66e9-308">Fail;</span><span class="sxs-lookup"><span data-stu-id="e66e9-308">Fail</span></span> |
| <span data-ttu-id="e66e9-309">**FairPlay**</span><span class="sxs-lookup"><span data-stu-id="e66e9-309">**FairPlay**</span></span> |<span data-ttu-id="e66e9-310">ПОДЛЕЖИТ УТОЧНЕНИЮ</span><span class="sxs-lookup"><span data-stu-id="e66e9-310">TBD</span></span> | | |

<span data-ttu-id="e66e9-311">Джордж Трифонов (George Trifonov) из команды служб мультимедиа Azure ведет блог, где вы найдете подробное описание шагов для настройки Azure Active Directory для приложения проигрывателя ASP.NET MVC, — [Интеграция приложения на основе OWIN MVC служб мультимедиа Azure с Azure Active Directory и ограничение доставки ключей содержимого на основе утверждений JWT](http://gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/).</span><span class="sxs-lookup"><span data-stu-id="e66e9-311">George Trifonov of Azure Media Services Team has written a blog providing detailed steps in setting up Azure Active Directory for an ASP.NET MVC player app: [Integrate Azure Media Services OWIN MVC based app with Azure Active Directory and restrict content key delivery based on JWT claims](http://gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/).</span></span>

<span data-ttu-id="e66e9-312">Джордж также ведет блог о [проверке подлинности маркера JWT в службах мультимедиа Azure и динамическом шифровании](http://gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/).</span><span class="sxs-lookup"><span data-stu-id="e66e9-312">George has also written a blog on [JWT token Authentication in Azure Media Services and Dynamic Encryption](http://gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/).</span></span> <span data-ttu-id="e66e9-313">А вот его [пример интеграции Azure AD с доставкой ключей служб мультимедиа Azure](https://github.com/AzureMediaServicesSamples/Key-delivery-with-AAD-integration/).</span><span class="sxs-lookup"><span data-stu-id="e66e9-313">And here is his [sample on Azure AD integration with Azure Media Services key delivery](https://github.com/AzureMediaServicesSamples/Key-delivery-with-AAD-integration/).</span></span>

<span data-ttu-id="e66e9-314">Дополнительные сведения об Azure Active Directory:</span><span class="sxs-lookup"><span data-stu-id="e66e9-314">For information on Azure Active Directory:</span></span>

* <span data-ttu-id="e66e9-315">Сведения для разработчиков см. в [руководстве разработчика по Azure Active Directory](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="e66e9-315">You can find developer information in [Azure Active Directory Developer’s Guide](../active-directory/active-directory-developers-guide.md).</span></span>
* <span data-ttu-id="e66e9-316">Сведения для администраторов см. в статье [Администрирование каталога Azure AD](../active-directory/active-directory-administer.md).</span><span class="sxs-lookup"><span data-stu-id="e66e9-316">You can find administrator information in [Administer Your Azure AD Directory](../active-directory/active-directory-administer.md).</span></span>

### <a name="some-gotchas-in-implementation"></a><span data-ttu-id="e66e9-317">Некоторые проблемы в реализации</span><span class="sxs-lookup"><span data-stu-id="e66e9-317">Some gotchas in implementation</span></span>
<span data-ttu-id="e66e9-318">В реализации есть некоторые "подводные камни".</span><span class="sxs-lookup"><span data-stu-id="e66e9-318">There are some “gotchas” in the implementation.</span></span> <span data-ttu-id="e66e9-319">Будем надеяться, что перечисленные ниже "подводные камни" помогут вам устранить неполадки в случае, если возникнут проблемы.</span><span class="sxs-lookup"><span data-stu-id="e66e9-319">Hopefully the following list of “gotchas” can help you troubleshooting in case you run into issues.</span></span>

1. <span data-ttu-id="e66e9-320">URL-адрес **издателя** должен заканчиваться на **"/"**.</span><span class="sxs-lookup"><span data-stu-id="e66e9-320">**Issuer** URL should end with **"/"**.</span></span>  

    <span data-ttu-id="e66e9-321">**Аудиторией** должен быть идентификатор клиента приложения проигрывателя, а также следует добавить **"/"** в конце URL-адреса издателя.</span><span class="sxs-lookup"><span data-stu-id="e66e9-321">**Audience** should be the player application client ID and you should also add **"/"** at the end of the issuer URL.</span></span>

        <add key="ida:audience" value="[Application Client ID GUID]" />
        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/" />

    <span data-ttu-id="e66e9-322">В [декодере JWT](http://jwt.calebb.net/) должны быть **aud** и **iss**, как показано ниже в маркере JWT:</span><span class="sxs-lookup"><span data-stu-id="e66e9-322">In [JWT Decoder](http://jwt.calebb.net/), you should see **aud** and **iss** as below in the JWT token:</span></span>

    ![1-я проблема](./media/media-services-cenc-with-multidrm-access-control/media-services-1st-gotcha.png)
2. <span data-ttu-id="e66e9-324">Добавьте разрешения для приложения в AAD (на вкладке "Настройка" приложения).</span><span class="sxs-lookup"><span data-stu-id="e66e9-324">Add Permissions to the application in AAD (on Configure tab of the application).</span></span> <span data-ttu-id="e66e9-325">Это необходимо для каждого приложения (локальной и развернутой версий).</span><span class="sxs-lookup"><span data-stu-id="e66e9-325">This is required for each application (local and deployed versions).</span></span>

    ![2-я проблема](./media/media-services-cenc-with-multidrm-access-control/media-services-perms-to-other-apps.png)
3. <span data-ttu-id="e66e9-327">Использование издателя прав в настройке динамической защиты CENC:</span><span class="sxs-lookup"><span data-stu-id="e66e9-327">Use the right issuer in setting up dynamic CENC protection:</span></span>

        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/"/>

    <span data-ttu-id="e66e9-328">Следующее работать не будет:</span><span class="sxs-lookup"><span data-stu-id="e66e9-328">The following will not work:</span></span>

        <add key="ida:issuer" value="https://willzhanad.onmicrosoft.com/" />

    <span data-ttu-id="e66e9-329">Идентификатор GUID — идентификатор клиента AAD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-329">The GUID is the AAD tenant ID.</span></span> <span data-ttu-id="e66e9-330">Идентификатор GUID можно найти во всплывающем окне конечных точек на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="e66e9-330">The GUID can be found in Endpoints popup in Azure portal.</span></span>
4. <span data-ttu-id="e66e9-331">Предоставление привилегий утверждения членства в группе.</span><span class="sxs-lookup"><span data-stu-id="e66e9-331">Grant group membership claims privileges.</span></span> <span data-ttu-id="e66e9-332">Убедитесь, что в файле манифеста приложения AAD содержится следующее</span><span class="sxs-lookup"><span data-stu-id="e66e9-332">Make sure in AAD application manifest file, we have the following</span></span>

    <span data-ttu-id="e66e9-333">"groupMembershipClaims": "All", (значение по умолчанию: null)</span><span class="sxs-lookup"><span data-stu-id="e66e9-333">"groupMembershipClaims": "All",    (the default value is null)</span></span>
5. <span data-ttu-id="e66e9-334">Установка правильного TokenType при создании требования к ограничениям.</span><span class="sxs-lookup"><span data-stu-id="e66e9-334">Setting proper TokenType when creating restriction requirements.</span></span>

        objTokenRestrictionTemplate.TokenType = TokenType.JWT;

    <span data-ttu-id="e66e9-335">После добавления поддержки для JWT (AAD) в дополнение к SWT (ACS) значение по умолчанию TokenType — TokenType.JWT.</span><span class="sxs-lookup"><span data-stu-id="e66e9-335">Since adding support of JWT (AAD) in addition to SWT (ACS), the default TokenType is TokenType.JWT.</span></span> <span data-ttu-id="e66e9-336">Если вы используете SWT и ACS, необходимо задать значение TokenType.SWT.</span><span class="sxs-lookup"><span data-stu-id="e66e9-336">If you use SWT/ACS, you must set to TokenType.SWT.</span></span>

## <a name="additional-topics-for-implementation"></a><span data-ttu-id="e66e9-337">Дополнительные разделы по реализации</span><span class="sxs-lookup"><span data-stu-id="e66e9-337">Additional Topics for Implementation</span></span>
<span data-ttu-id="e66e9-338">Далее мы рассмотрим некоторые дополнительные вопросы в нашей теме о проектировании и реализации.</span><span class="sxs-lookup"><span data-stu-id="e66e9-338">Next we will disc uss some additional topics in our design and implementation.</span></span>

### <a name="http-or-https"></a><span data-ttu-id="e66e9-339">HTTP или HTTPS?</span><span class="sxs-lookup"><span data-stu-id="e66e9-339">HTTP or HTTPS?</span></span>
<span data-ttu-id="e66e9-340">Приложение проигрывателя ASP.NET MVC, которое мы разработали, должно поддерживать следующее:</span><span class="sxs-lookup"><span data-stu-id="e66e9-340">The ASP.NET MVC player application we built must support the following:</span></span>

1. <span data-ttu-id="e66e9-341">проверку подлинности пользователя через Azure AD, который должен находиться в разделе HTTPS;</span><span class="sxs-lookup"><span data-stu-id="e66e9-341">User authentication through Azure AD which needs to be under HTTPS;</span></span>
2. <span data-ttu-id="e66e9-342">обмен маркерами JWT между клиентом и Azure AD, который должен находиться в разделе HTTPS;</span><span class="sxs-lookup"><span data-stu-id="e66e9-342">JWT token exchange between client and Azure AD which needs to be under HTTPS;</span></span>
3. <span data-ttu-id="e66e9-343">приобретение лицензий DRM клиентом, который должен находиться в разделе HTTPS, если доставка лицензий осуществляется службами мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="e66e9-343">DRM license acquisition by the client which is required to be under HTTPS if license delivery is provided by Azure Media Services.</span></span> <span data-ttu-id="e66e9-344">Конечно, набор продуктов PlayReady не требует HTTPS для доставки лицензий.</span><span class="sxs-lookup"><span data-stu-id="e66e9-344">Of course, PlayReady product suite does not mandate HTTPS for license delivery.</span></span> <span data-ttu-id="e66e9-345">Если ваш сервер лицензирования PlayReady находится за пределами служб мультимедиа Azure, можно использовать HTTP или HTTPS.</span><span class="sxs-lookup"><span data-stu-id="e66e9-345">If your PlayReady license server is outside of Azure Media Services, either HTTP or HTTPS could be used.</span></span>

<span data-ttu-id="e66e9-346">Поэтому приложение проигрывателя ASP.NET будет использовать HTTPS в качестве рекомендованной технологии.</span><span class="sxs-lookup"><span data-stu-id="e66e9-346">Therefore, the ASP.NET player application will use HTTPS as a best practice.</span></span> <span data-ttu-id="e66e9-347">Это означает, что Проигрыватель Мультимедиа Azure будет на странице в разделе HTTPS.</span><span class="sxs-lookup"><span data-stu-id="e66e9-347">This means the Azure Media Player will be on a page under HTTPS.</span></span> <span data-ttu-id="e66e9-348">Тем не менее, для потоковой передачи мы предпочитаем HTTP, так как нам нужно учесть проблемы смешанного содержимого.</span><span class="sxs-lookup"><span data-stu-id="e66e9-348">However, for streaming we prefer HTTP, hence we need to consider mixed content issue.</span></span>

1. <span data-ttu-id="e66e9-349">Браузер не разрешает смешанное содержимое.</span><span class="sxs-lookup"><span data-stu-id="e66e9-349">Browser does not allow mixed content.</span></span> <span data-ttu-id="e66e9-350">Однако подключаемые модули, например Silverlight и OSMF для бесперебойной работы и DASH, разрешают.</span><span class="sxs-lookup"><span data-stu-id="e66e9-350">But plugins like Silverlight and OSMF plugin for smooth and DASH allow.</span></span> <span data-ttu-id="e66e9-351">Смешанное содержимое является угрозой безопасности — это происходит из-за возможности вставить вредоносные JS, что может подвергнуть риску данные клиента.</span><span class="sxs-lookup"><span data-stu-id="e66e9-351">Mixed content is a security concern - This is due to the threat of the ability to inject malicious JS which can cause the customer data to be at risk.</span></span>  <span data-ttu-id="e66e9-352">Браузеры по умолчанию блокирует эту возможность, и на данный момент единственным способом обойти это на стороне сервера (источника) — разрешить все домены (и https, и http).</span><span class="sxs-lookup"><span data-stu-id="e66e9-352">Browsers block this by default and so far the only way to work around it is on the server (origin) side, to allow all domains (regardless https or http).</span></span> <span data-ttu-id="e66e9-353">Это, скорее всего, тоже не самая лучшая идея.</span><span class="sxs-lookup"><span data-stu-id="e66e9-353">This is probably not a good idea either.</span></span>
2. <span data-ttu-id="e66e9-354">Следует избегать смешанного содержимого: всегда использовать либо протокол HTTP, либо HTTPS.</span><span class="sxs-lookup"><span data-stu-id="e66e9-354">We should avoid mixed content: either both use HTTP or both use HTTPS.</span></span> <span data-ttu-id="e66e9-355">При воспроизведении смешанного содержимого технология silverlightSS требует удаления предупреждения о смешанном содержимом.</span><span class="sxs-lookup"><span data-stu-id="e66e9-355">When playing mixed content, silverlightSS tech requires clearing a mixed content warning.</span></span> <span data-ttu-id="e66e9-356">Технология flashSS обрабатывает смешанное содержимое без предупреждения о смешанном содержимом.</span><span class="sxs-lookup"><span data-stu-id="e66e9-356">flashSS tech handles mixed content without mixed content warning.</span></span>
3. <span data-ttu-id="e66e9-357">Если конечная точка потоковой передачи была создана до августа 2014 г., она не будет поддерживать протокол HTTPS.</span><span class="sxs-lookup"><span data-stu-id="e66e9-357">If your streaming endpoint was created before August 2014, it will not support HTTPS.</span></span> <span data-ttu-id="e66e9-358">В этом случае создайте и используйте новую конечную точку потоковой передачи для использования протокола HTTPS.</span><span class="sxs-lookup"><span data-stu-id="e66e9-358">In this case, please create and use a new streaming endpoint for HTTPS.</span></span>

<span data-ttu-id="e66e9-359">В справочной реализации в случае защищенного DRM содержимого и приложения, и потоковая передача будут в разделе HTTPS.</span><span class="sxs-lookup"><span data-stu-id="e66e9-359">In the reference implementation, for DRM protected contents, both application and streaming will be under HTTTPS.</span></span> <span data-ttu-id="e66e9-360">Для открытого содержимого проигрывателю не требуется лицензия или проверка подлинности, и вы можете использовать протокол HTTP или HTTPS.</span><span class="sxs-lookup"><span data-stu-id="e66e9-360">For open contents, the player does not need authentication or license, so you have the liberty to use either HTTP or HTTPS.</span></span>

### <a name="azure-active-directory-signing-key-rollover"></a><span data-ttu-id="e66e9-361">Смена ключей подписывания Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="e66e9-361">Azure Active Directory signing key rollover</span></span>
<span data-ttu-id="e66e9-362">Это важно учитывать при реализации.</span><span class="sxs-lookup"><span data-stu-id="e66e9-362">This is an important point to take into consideration of your implementation.</span></span> <span data-ttu-id="e66e9-363">Если не учитывать это при реализации, завершенная система полностью перестанет работать в течение не более 6 недель.</span><span class="sxs-lookup"><span data-stu-id="e66e9-363">If you do not consider this in your implementation, the completed system will eventually stop working completely within at most 6 weeks.</span></span>

<span data-ttu-id="e66e9-364">Azure AD использует отраслевой стандарт для установления доверительных отношений между собой и приложениями, использующими Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-364">Azure AD uses industry standard to establish trust between itself and applications using Azure AD.</span></span> <span data-ttu-id="e66e9-365">В частности, Azure AD использует ключ подписывания, состоящий из пары открытого и закрытого ключей.</span><span class="sxs-lookup"><span data-stu-id="e66e9-365">Specifically, Azure AD uses a signing key that consists of a public and private key pair.</span></span> <span data-ttu-id="e66e9-366">Когда Azure AD создает маркер безопасности, который содержит сведения о пользователе, этот маркер подписывается с помощью Azure AD, используя свой закрытый ключ перед отправкой в приложение.</span><span class="sxs-lookup"><span data-stu-id="e66e9-366">When Azure AD creates a security token that contains information about the user, this token is signed by Azure AD using its private key before it is sent back to the application.</span></span> <span data-ttu-id="e66e9-367">Чтобы убедиться, что маркер является допустимым и получен от Azure AD, приложение должно проверить его подпись с помощью открытого ключа, предоставленного Azure AD, который содержится в документе метаданных федерации клиента.</span><span class="sxs-lookup"><span data-stu-id="e66e9-367">To verify that the token is valid and actually originated from Azure AD, the application must validate the token’s signature using the public key exposed by Azure AD that is contained in the tenant’s federation metadata document.</span></span> <span data-ttu-id="e66e9-368">Этот открытый ключ — и ключ подписывания, от которого он происходит, — аналогичен тому, который используется для всех клиентов в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-368">This public key – and the signing key from which it derives – is the same one used for all tenants in Azure AD.</span></span>

<span data-ttu-id="e66e9-369">Подробные сведения о смене ключей Azure AD можно найти в документе [Важные сведения о смене ключей подписи в Azure AD](../active-directory/active-directory-signing-key-rollover.md).</span><span class="sxs-lookup"><span data-stu-id="e66e9-369">Detailed info on Azure AD key rollover can be found in the document: [Important Information about Signing Key Rollover in Azure AD](../active-directory/active-directory-signing-key-rollover.md).</span></span>

<span data-ttu-id="e66e9-370">Между [парой открытого и закрытого ключей](https://login.microsoftonline.com/common/discovery/keys/)</span><span class="sxs-lookup"><span data-stu-id="e66e9-370">Between the [public-private key pair](https://login.microsoftonline.com/common/discovery/keys/),</span></span>

* <span data-ttu-id="e66e9-371">Закрытый ключ используется Azure Active Directory для создания маркера JWT.</span><span class="sxs-lookup"><span data-stu-id="e66e9-371">The private key is used by Azure Active Directory to generate a JWT token;</span></span>
* <span data-ttu-id="e66e9-372">Открытый ключ используется приложением, таким как службы доставки лицензий DRM в AMS, для проверки маркера JWT.</span><span class="sxs-lookup"><span data-stu-id="e66e9-372">The public key is used by an application such as DRM License Delivery Services in AMS to verify the JWT token;</span></span>

<span data-ttu-id="e66e9-373">В целях безопасности Azure Active Directory периодически проводит ротацию этого сертификата (каждые 6 недель).</span><span class="sxs-lookup"><span data-stu-id="e66e9-373">For security purpose, Azure Active Directory rotates this certificate periodically (every 6 weeks).</span></span> <span data-ttu-id="e66e9-374">В случае нарушения безопасности смена ключей может произойти любое время.</span><span class="sxs-lookup"><span data-stu-id="e66e9-374">In case of security breaches, the key rollover can occur any time.</span></span> <span data-ttu-id="e66e9-375">Таким образом, службам доставки лицензий в AMS необходимо обновить открытый ключ, используемый по мере ротации пары ключей Azure AD, иначе произойдет сбой проверки подлинности маркера в AMS, и лицензия не будет выдана.</span><span class="sxs-lookup"><span data-stu-id="e66e9-375">Therefore, the license delivery services in AMS need to update the public key used as Azure AD rotates the key pair, otherwise token authentication in AMS will fail and no license will be issued.</span></span>

<span data-ttu-id="e66e9-376">Это достигается путем установки TokenRestrictionTemplate.OpenIdConnectDiscoveryDocument при настройке службы доставки лицензий DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-376">This is achieved by setting TokenRestrictionTemplate.OpenIdConnectDiscoveryDocument when configuring DRM license delivery services.</span></span>

<span data-ttu-id="e66e9-377">Поток маркеров JWT выглядит так:</span><span class="sxs-lookup"><span data-stu-id="e66e9-377">The JWT token flow is as below:</span></span>

1. <span data-ttu-id="e66e9-378">Azure AD выдаст маркер JWT с текущим закрытым ключом для прошедшего проверку пользователя.</span><span class="sxs-lookup"><span data-stu-id="e66e9-378">Azure AD will issue the JWT token with the current private key for an authenticated user;</span></span>
2. <span data-ttu-id="e66e9-379">Когда проигрыватель обнаруживает CENC с защищенным несколькими DRM содержимым, он сначала ищет маркер JWT, выданный Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-379">When a player sees a CENC with multi-DRM protected content, it will first locate the JWT token issued by Azure AD.</span></span>
3. <span data-ttu-id="e66e9-380">Проигрыватель отправляет запрос на приобретение лицензии с маркером JWT в службы доставки лицензий в AMS.</span><span class="sxs-lookup"><span data-stu-id="e66e9-380">The player sends license acquisition request with the JWT token to license delivery services in AMS;</span></span>
4. <span data-ttu-id="e66e9-381">Службы доставки лицензий AMS будут использовать текущий и допустимый открытый ключ из Azure AD для проверки маркера JWT перед выдачей лицензий.</span><span class="sxs-lookup"><span data-stu-id="e66e9-381">The license delivery services in AMS will use the current/valid public key from Azure AD to verify the JWT token, before issuing licenses.</span></span>

<span data-ttu-id="e66e9-382">Службы доставки лицензий DRM всегда будут проверять текущий и допустимый открытый ключ из Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-382">DRM license delivery services will always be checking for the current/valid public key from Azure AD.</span></span> <span data-ttu-id="e66e9-383">Открытый ключ, предоставленный Azure AD, будет ключом, используемым для проверки маркера JWT, выданного Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-383">The public key presented by Azure AD will be the key used for verifying a JWT token issued by Azure AD.</span></span>

<span data-ttu-id="e66e9-384">Что делать, если смена ключей происходит после того, как AAD создал маркер JWT, но перед тем, как маркер JWT отправляется проигрывателями в службы доставки лицензий DRM в AMS для проверки?</span><span class="sxs-lookup"><span data-stu-id="e66e9-384">What if the key rollover happens after AAD generates a JWT token but before the JWT token is sent by players to DRM license delivery services in AMS for verification?</span></span>

<span data-ttu-id="e66e9-385">Поскольку ключ может быть сменен в любой момент, всегда существует более одного допустимого открытого ключа в документе метаданных федерации.</span><span class="sxs-lookup"><span data-stu-id="e66e9-385">Because a key may be rolled at any moment, there is always more than one valid public key available in the federation metadata document.</span></span> <span data-ttu-id="e66e9-386">Доставка лицензий служб мультимедиа Azure может использовать любой из ключей, указанных в документе, поскольку один ключ может быть сменен раньше, другой может оказаться его заменой и т. д.</span><span class="sxs-lookup"><span data-stu-id="e66e9-386">Azure Media Services license delivery can use any of the keys specified in the document, since one key may be rolled soon, another may be its replacement, and so forth.</span></span>

### <a name="where-is-the-access-token"></a><span data-ttu-id="e66e9-387">Где маркер доступа?</span><span class="sxs-lookup"><span data-stu-id="e66e9-387">Where is the Access Token?</span></span>
<span data-ttu-id="e66e9-388">Если взглянуть на то, как веб-приложение вызывает приложение API в разделе [Удостоверение приложения с предоставлением учетных данных клиента OAuth 2.0](../active-directory/develop/active-directory-authentication-scenarios.md#web-application-to-web-api), схема проверки подлинности выглядит следующим образом.</span><span class="sxs-lookup"><span data-stu-id="e66e9-388">If you look at how a web app calls an API app under [Application Identity with OAuth 2.0 Client Credentials Grant](../active-directory/develop/active-directory-authentication-scenarios.md#web-application-to-web-api), the authentication flow is as below:</span></span>

1. <span data-ttu-id="e66e9-389">Пользователь входит в систему Azure AD в веб-приложении (см. раздел [Из веб-браузера в веб-приложение](../active-directory/develop/active-directory-authentication-scenarios.md#web-browser-to-web-application)).</span><span class="sxs-lookup"><span data-stu-id="e66e9-389">A user is signed in to Azure AD in the web application (see the [Web Browser to Web Application](../active-directory/develop/active-directory-authentication-scenarios.md#web-browser-to-web-application).</span></span>
2. <span data-ttu-id="e66e9-390">Конечная точка авторизации Azure AD перенаправляет агента пользователя в клиентское приложение с кодом авторизации.</span><span class="sxs-lookup"><span data-stu-id="e66e9-390">The Azure AD authorization endpoint redirects the user agent back to the client application with an authorization code.</span></span> <span data-ttu-id="e66e9-391">Агент пользователя возвращает код авторизации в URI перенаправления клиентского приложения.</span><span class="sxs-lookup"><span data-stu-id="e66e9-391">The user agent returns authorization code to the client application’s redirect URI.</span></span>
3. <span data-ttu-id="e66e9-392">Чтобы веб-приложение могло выполнить проверку подлинности для веб-интерфейса API и получить нужный ресурс, это приложение должно получить маркер доступа.</span><span class="sxs-lookup"><span data-stu-id="e66e9-392">The web application needs to acquire an access token so that it can authenticate to the web API and retrieve the desired resource.</span></span> <span data-ttu-id="e66e9-393">Оно отправляет запрос в конечную точку маркера Azure AD, предоставляя учетные данные, идентификатор клиента и URI идентификатора приложения веб-интерфейса API.</span><span class="sxs-lookup"><span data-stu-id="e66e9-393">It makes a request to Azure AD’s token endpoint, providing the credential, client ID, and web API’s application ID URI.</span></span> <span data-ttu-id="e66e9-394">Представляет код авторизации, чтобы доказать, что пользователь дал свое согласие.</span><span class="sxs-lookup"><span data-stu-id="e66e9-394">It presents the authorization code to prove that the user has consented.</span></span>
4. <span data-ttu-id="e66e9-395">Azure AD проверяет подлинность приложения и возвращает маркер доступа JWT, который используется для вызова веб-интерфейса API.</span><span class="sxs-lookup"><span data-stu-id="e66e9-395">Azure AD authenticates the application and returns a JWT access token that is used to call the web API.</span></span>
5. <span data-ttu-id="e66e9-396">Веб-приложение использует возвращенный маркер доступа JWT, добавляя строку JWT с обозначением "Носитель" в заголовок авторизации запроса, отправляемого по протоколу HTTPS в веб-интерфейс API.</span><span class="sxs-lookup"><span data-stu-id="e66e9-396">Over HTTPS, the web application uses the returned JWT access token to add the JWT string with a “Bearer” designation in the Authorization header of the request to the web API.</span></span> <span data-ttu-id="e66e9-397">Затем веб-интерфейс API проверяет этот маркер JWT, и, если проверка будет выполнена успешно, возвращает требуемый ресурс.</span><span class="sxs-lookup"><span data-stu-id="e66e9-397">The web API then validates the JWT token, and if validation is successful, returns the desired resource.</span></span>

<span data-ttu-id="e66e9-398">В этом потоке "удостоверения приложения" веб-интерфейс API доверяет тому, что веб-приложение проверило подлинность пользователя.</span><span class="sxs-lookup"><span data-stu-id="e66e9-398">In this “application identity” flow, the web API trusts that the web application authenticated the user.</span></span> <span data-ttu-id="e66e9-399">По этой причине данная схема называется доверенной (надежной) подсистемой.</span><span class="sxs-lookup"><span data-stu-id="e66e9-399">For this reason, this pattern is called a trusted subsystem.</span></span> <span data-ttu-id="e66e9-400">В [схеме на этой странице](https://docs.microsoft.com/azure/active-directory/active-directory-protocols-oauth-code) описывается принцип действия предоставления кода авторизации.</span><span class="sxs-lookup"><span data-stu-id="e66e9-400">The [diagram on this page](https://docs.microsoft.com/azure/active-directory/active-directory-protocols-oauth-code) describes how authorization code grant flow works.</span></span>

<span data-ttu-id="e66e9-401">При приобретении лицензий с ограничением маркера мы следуем тому же шаблону доверенной подсистемы.</span><span class="sxs-lookup"><span data-stu-id="e66e9-401">In license acquisition with token restriction, we are following the same trusted subsystem pattern.</span></span> <span data-ttu-id="e66e9-402">А служба доставки лицензий в службах мультимедиа Azure — это ресурс веб-API, "внутренний ресурс", доступ к которому требуется веб-приложению.</span><span class="sxs-lookup"><span data-stu-id="e66e9-402">And the license delivery service in Azure Media Services is the web API resource, the “backend resource” a web application needs to access.</span></span> <span data-ttu-id="e66e9-403">Так где же маркер доступа?</span><span class="sxs-lookup"><span data-stu-id="e66e9-403">So where is the access token?</span></span>

<span data-ttu-id="e66e9-404">В самом деле, мы получаем маркер доступа из Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-404">Indeed, we are obtaining access token from Azure AD.</span></span> <span data-ttu-id="e66e9-405">После успешной проверки подлинности пользователя возвращается код авторизации.</span><span class="sxs-lookup"><span data-stu-id="e66e9-405">After successful user authentication, authorization code is returned.</span></span> <span data-ttu-id="e66e9-406">Код авторизации затем используется совместно с идентификатором клиента и ключом приложения для обмена на маркер доступа.</span><span class="sxs-lookup"><span data-stu-id="e66e9-406">The authorization code is then used, together with client ID and app key, to exchange for access token.</span></span> <span data-ttu-id="e66e9-407">И маркер доступа предназначен для доступа к приложению "указатель", которое представляет службу доставки лицензий служб мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="e66e9-407">And the access token is for accessing a “pointer” application pointing or representing Azure Media Services license delivery service.</span></span>

<span data-ttu-id="e66e9-408">Необходимо зарегистрировать и настроить приложение "указатель" в Azure AD, выполнив следующие действия:</span><span class="sxs-lookup"><span data-stu-id="e66e9-408">We need to register and configure the “pointer” app in Azure AD by following the steps below:</span></span>

1. <span data-ttu-id="e66e9-409">В клиенте Azure AD</span><span class="sxs-lookup"><span data-stu-id="e66e9-409">In the Azure AD tenant</span></span>

   * <span data-ttu-id="e66e9-410">добавьте приложение (ресурс) с URL-адресом входа:</span><span class="sxs-lookup"><span data-stu-id="e66e9-410">add an application (resource) with sign-on URL:</span></span>

   <span data-ttu-id="e66e9-411">https://[resource_name].azurewebsites.net/ и</span><span class="sxs-lookup"><span data-stu-id="e66e9-411">https://[resource_name].azurewebsites.net/ and</span></span>

   * <span data-ttu-id="e66e9-412">URL-адрес идентификатора приложения:</span><span class="sxs-lookup"><span data-stu-id="e66e9-412">app ID URL:</span></span>

   <span data-ttu-id="e66e9-413">https://[aad_tenant_name].onmicrosoft.com/[resource_name];</span><span class="sxs-lookup"><span data-stu-id="e66e9-413">https://[aad_tenant_name].onmicrosoft.com/[resource_name];</span></span>
2. <span data-ttu-id="e66e9-414">Добавьте новый ключ для приложения ресурса.</span><span class="sxs-lookup"><span data-stu-id="e66e9-414">Add a new key for the resource app;</span></span>
3. <span data-ttu-id="e66e9-415">Обновите файл манифеста приложения, чтобы свойство groupMembershipClaims имело следующее значение: "groupMembershipClaims": "All".</span><span class="sxs-lookup"><span data-stu-id="e66e9-415">Update the app manifest file so that the groupMembershipClaims property has the following value: "groupMembershipClaims": "All",</span></span>  
4. <span data-ttu-id="e66e9-416">В приложении Azure AD, указывающем на веб-приложения проигрывателя в разделе "разрешения для других приложений", добавьте приложение ресурса, которое было добавлено на шаге 1 выше.</span><span class="sxs-lookup"><span data-stu-id="e66e9-416">In the Azure AD app pointing to the player web app, in the section “permissions to other applications”, add the resource app which was added in step 1 above.</span></span> <span data-ttu-id="e66e9-417">В разделе "делегированные разрешения" проверьте флажок "Доступ [имя_ресурса]".</span><span class="sxs-lookup"><span data-stu-id="e66e9-417">Under “delegated permissions” check “Access [resource_name]” checkmark.</span></span> <span data-ttu-id="e66e9-418">Это дает разрешение веб-приложению создать маркеры доступа для доступа к приложению ресурса.</span><span class="sxs-lookup"><span data-stu-id="e66e9-418">This gives the web app permission to create access tokens for accessing the resource app.</span></span> <span data-ttu-id="e66e9-419">Это следует сделать для локальной и развернутой версий веб-приложения при разработке с помощью веб-приложения Visual Studio и Azure.</span><span class="sxs-lookup"><span data-stu-id="e66e9-419">You should do this for both local and deployed version of the web app if you are developing with Visual Studio and Azure web app.</span></span>

<span data-ttu-id="e66e9-420">Таким образом, маркер JWT, выданный Azure AD, действительно является маркером доступа для доступа к ресурсу "указатель".</span><span class="sxs-lookup"><span data-stu-id="e66e9-420">Therefore, the JWT token issued by Azure AD is indeed the access token for accessing this “pointer” resource.</span></span>

### <a name="what-about-live-streaming"></a><span data-ttu-id="e66e9-421">Как насчет динамической потоковой передачи?</span><span class="sxs-lookup"><span data-stu-id="e66e9-421">What about Live Streaming?</span></span>
<span data-ttu-id="e66e9-422">Выше мы сфокусировались на ресурсах по требованию.</span><span class="sxs-lookup"><span data-stu-id="e66e9-422">In the above, our discussion has been focusing on on-demand assets.</span></span> <span data-ttu-id="e66e9-423">Как насчет динамической потоковой передачи?</span><span class="sxs-lookup"><span data-stu-id="e66e9-423">What about live streaming?</span></span>

<span data-ttu-id="e66e9-424">Хорошая новость в том, что вы можете использовать точно такую же структуру и реализацию для защиты динамической потоковой передачи в службах мультимедиа Azure, рассматривая ресурс, связанный с программой, как "ресурс VOD".</span><span class="sxs-lookup"><span data-stu-id="e66e9-424">The good news is that you can use exactly the same design and implementation for protecting live streaming in Azure Media Services, by treating the asset associated with a program as a “VOD asset”.</span></span>

<span data-ttu-id="e66e9-425">В частности, хорошо известно, что для реализации динамической потоковой передачи в службах мультимедиа Azure необходимо создать канал, а затем программу в рамках канала.</span><span class="sxs-lookup"><span data-stu-id="e66e9-425">Specifically, it is well known that to do live streaming in Azure Media Services, you need to create a channel, then a program under the channel.</span></span> <span data-ttu-id="e66e9-426">Чтобы создать программу, необходимо создать ресурс, который будет содержать текущий архив для программы.</span><span class="sxs-lookup"><span data-stu-id="e66e9-426">To create the program, you need to create an asset which will contain the live archive for the program.</span></span> <span data-ttu-id="e66e9-427">Чтобы предоставить защиту динамического содержимого CENC с несколькими DRM, необходимо всего лишь применить ту же программу установки и обработки к ресурсу, как если бы это был "ресурс VOD", прежде чем запустить программу.</span><span class="sxs-lookup"><span data-stu-id="e66e9-427">In order to provide CENC with multi-DRM protection of the live content, all you need to do, is to apply the same setup/processing to the asset as if it was a “VOD asset” before you start the program.</span></span>

### <a name="what-about-license-servers-outside-of-azure-media-services"></a><span data-ttu-id="e66e9-428">Как насчет серверов лицензирования за пределами служб мультимедиа Azure?</span><span class="sxs-lookup"><span data-stu-id="e66e9-428">What about license servers outside of Azure Media Services?</span></span>
<span data-ttu-id="e66e9-429">Часто пользователи могли вложить средства в ферму серверов лицензирования в собственном центре обработки данных или у поставщика услуг DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-429">Often, customers may have invested in license server farm either in their own data center or hosted by DRM service providers.</span></span> <span data-ttu-id="e66e9-430">К счастью, защита содержимого служб мультимедиа Azure дает возможность работы в гибридном режиме: содержимое размещается и динамически защищается в службах мультимедиа Azure, в то же время лицензии DRM доставляются серверами за пределами служб мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="e66e9-430">Fortunately, Azure Media Services Content Protection allows you to operate in hybrid mode: contents hosted and dynamically protected in Azure Media Services, while DRM licenses are delivered by servers outside Azure Media Services.</span></span> <span data-ttu-id="e66e9-431">В этом случае необходимо учитывать следующие изменения.</span><span class="sxs-lookup"><span data-stu-id="e66e9-431">In this case, there are the following considerations of changes:</span></span>

1. <span data-ttu-id="e66e9-432">Служба маркеров безопасности должна выдавать маркеры, которые являются допустимыми и могут быть проверены на ферме серверов лицензий.</span><span class="sxs-lookup"><span data-stu-id="e66e9-432">The Secure Token Service needs to issue tokens which are acceptable and can be verified by the license server farm.</span></span> <span data-ttu-id="e66e9-433">Например, серверы лицензий Widevine, предоставляемые Axinom, требуют определенного маркера JWT, который содержит "сообщение о правах".</span><span class="sxs-lookup"><span data-stu-id="e66e9-433">For example, the Widevine license servers provided by Axinom requires a specific JWT token which contains “entitlement message”.</span></span> <span data-ttu-id="e66e9-434">Таким образом, необходимо иметь STS для издания такого маркера JWT.</span><span class="sxs-lookup"><span data-stu-id="e66e9-434">Therefore, you need to have an STS to issue such JWT token.</span></span> <span data-ttu-id="e66e9-435">Авторы завершили такую реализацию. Подробные сведения см. в следующем документе в [центре документации Azure](https://azure.microsoft.com/documentation/): [Использование Axinom для доставки лицензий Widevine в службы мультимедиа Azure](media-services-axinom-integration.md).</span><span class="sxs-lookup"><span data-stu-id="e66e9-435">The authors have completed such an implementation and you can find the details in the following document in [Azure Documentation Center](https://azure.microsoft.com/documentation/): [Using Axinom to deliver Widevine licenses to Azure Media Services](media-services-axinom-integration.md).</span></span>
2. <span data-ttu-id="e66e9-436">Настройка службы доставки лицензий (ContentKeyAuthorizationPolicy) в службах мультимедиа больше не требуется.</span><span class="sxs-lookup"><span data-stu-id="e66e9-436">You no longer need to configure license delivery service (ContentKeyAuthorizationPolicy) in Azure Media Services.</span></span> <span data-ttu-id="e66e9-437">Вам просто нужно предоставить URL-адреса приобретения лицензии (для PlayReady, Widevine и FairPlay) при настройке AssetDeliveryPolicy в ходе настройки CENC с несколькими DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-437">What you need to do is to provide the license acquisition URLs (for PlayReady, Widevine and FairPlay) when you configure AssetDeliveryPolicy in setting up CENC with multi-DRM.</span></span>

### <a name="what-if-i-want-to-use-a-custom-sts"></a><span data-ttu-id="e66e9-438">Что делать, если нужно использовать пользовательскую службу STS?</span><span class="sxs-lookup"><span data-stu-id="e66e9-438">What if I want to use a custom STS?</span></span>
<span data-ttu-id="e66e9-439">Могут быть несколько причин, по которым клиент может использовать пользовательскую STS (службу маркеров безопасности) для предоставления маркеров JWT.</span><span class="sxs-lookup"><span data-stu-id="e66e9-439">There could be a few reasons that a customer may choose to use a custom STS (Secure Token Service) for providing JWT tokens.</span></span> <span data-ttu-id="e66e9-440">Ниже приведены некоторые из них.</span><span class="sxs-lookup"><span data-stu-id="e66e9-440">Some of them are:</span></span>

1. <span data-ttu-id="e66e9-441">Поставщик удостоверений (IDP), используемый клиентом, не поддерживает STS.</span><span class="sxs-lookup"><span data-stu-id="e66e9-441">The Identity Provider (IDP) used by the customer does not support STS.</span></span> <span data-ttu-id="e66e9-442">В этом случае выходом может оказаться пользовательская STS.</span><span class="sxs-lookup"><span data-stu-id="e66e9-442">In this case a custom STS may be an option.</span></span>
2. <span data-ttu-id="e66e9-443">Клиенту может потребоваться более гибкий или более жесткий контроль при интеграции STS с системой выставления счетов подписчика клиента.</span><span class="sxs-lookup"><span data-stu-id="e66e9-443">The customer may need more flexible or tighter control in integrating STS with customer’s subscriber billing system.</span></span> <span data-ttu-id="e66e9-444">Например, оператор MVPD может предлагать несколько пакетов подписчиков OTT, таких как Premium, Basic, Sports и т. д. Оператору может потребоваться сопоставить утверждения в маркере с пакетом подписчика, чтобы предоставлялось только содержимое в нужном пакете.</span><span class="sxs-lookup"><span data-stu-id="e66e9-444">For example, an MVPD operator may offer multiple OTT subscriber packages such as premium, basic, sports, etc. The operator may want to match the claims in a token with a subscriber’s package so that only contents in the right package is made available.</span></span> <span data-ttu-id="e66e9-445">В этом случае пользовательская STS предоставляет необходимую гибкость и контроль.</span><span class="sxs-lookup"><span data-stu-id="e66e9-445">In this case, a custom STS provides the needed flexibility and control.</span></span>

<span data-ttu-id="e66e9-446">При использовании пользовательской STS необходимо сделать два изменения:</span><span class="sxs-lookup"><span data-stu-id="e66e9-446">Two changes need to be made when using a custom STS:</span></span>

1. <span data-ttu-id="e66e9-447">При настройке службы доставки лицензий для ресурса необходимо указать ключ безопасности, используемый для проверки пользовательской STS (более подробное описание ниже) вместо текущего ключа из Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="e66e9-447">When configuring license delivery service for an asset, you need to specify the security key used for verification by the custom STS (more details below) instead of the current key from Azure Active Directory.</span></span>
2. <span data-ttu-id="e66e9-448">Когда создается маркер JTW, вместо закрытого ключа текущего сертификата X509 в Azure Active Directory указан ключ безопасности.</span><span class="sxs-lookup"><span data-stu-id="e66e9-448">When a JTW token is generated, a security key is specified instead of the private key of the current X509 certificate in Azure Active Directory.</span></span>

<span data-ttu-id="e66e9-449">Существует два типа ключей безопасности:</span><span class="sxs-lookup"><span data-stu-id="e66e9-449">There are two types of security keys:</span></span>

1. <span data-ttu-id="e66e9-450">Симметричный ключ: тот же ключ используется для создания и проверки маркера JWT.</span><span class="sxs-lookup"><span data-stu-id="e66e9-450">Symmetric key: the same key is used for both generating and verifying a JWT token;</span></span>
2. <span data-ttu-id="e66e9-451">Асимметричный ключ: пара открытого и закрытого ключей в сертификате X509 используется с закрытым ключом для шифрования и создания маркера JWT и с открытым ключом для проверки маркера.</span><span class="sxs-lookup"><span data-stu-id="e66e9-451">Asymmetric key: a public-private key pair in an X509 certificate is used with private key for encrypting/generating a JWT token and the public key for verifying the token.</span></span>

#### <a name="tech-note"></a><span data-ttu-id="e66e9-452">Техническое примечание</span><span class="sxs-lookup"><span data-stu-id="e66e9-452">Tech note</span></span>
<span data-ttu-id="e66e9-453">При использовании .NET Framework/C# в качестве платформы разработки сертификат X509, используемый для асимметричного ключа безопасности, должен иметь длину ключа минимум 2048 бит.</span><span class="sxs-lookup"><span data-stu-id="e66e9-453">If you use .NET Framework/C# as your development platform, the X509 certificate used for asymmetric security key must have key length at least 2048.</span></span> <span data-ttu-id="e66e9-454">Это требование класса System.IdentityModel.Tokens.X509AsymmetricSecurityKey в .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="e66e9-454">This is a requirement of the class System.IdentityModel.Tokens.X509AsymmetricSecurityKey in .NET Framework.</span></span> <span data-ttu-id="e66e9-455">В противном случае будет создано следующее исключение:</span><span class="sxs-lookup"><span data-stu-id="e66e9-455">Otherwise, the following exception will be thrown:</span></span>

<span data-ttu-id="e66e9-456">IDX10630: System.IdentityModel.Tokens.X509AsymmetricSecurityKey не может быть менее 2048 бит.</span><span class="sxs-lookup"><span data-stu-id="e66e9-456">IDX10630: The 'System.IdentityModel.Tokens.X509AsymmetricSecurityKey' for signing cannot be smaller than '2048' bits.</span></span>

## <a name="the-completed-system-and-test"></a><span data-ttu-id="e66e9-457">Завершенная система и тестирование</span><span class="sxs-lookup"><span data-stu-id="e66e9-457">The completed system and test</span></span>
<span data-ttu-id="e66e9-458">Мы рассмотрим несколько сценариев в завершенной комплексной системе, чтобы читатели получили базовое представление о поведении до получения учетной записи для входа.</span><span class="sxs-lookup"><span data-stu-id="e66e9-458">We will walk through a few scenarios in the completed end-to-end system so that readers can have a basic “picture” of the behavior before getting a login account.</span></span>

<span data-ttu-id="e66e9-459">Веб-приложение проигрывателя и учетную запись для входа можно найти [здесь](https://openidconnectweb.azurewebsites.net/).</span><span class="sxs-lookup"><span data-stu-id="e66e9-459">The player web application and its login can be found [here](https://openidconnectweb.azurewebsites.net/).</span></span>

<span data-ttu-id="e66e9-460">Если необходим "неинтегрированный" сценарий (видеоматериалы, размещенные в службах мультимедиа Azure либо не защищены, либо защищены DRM, но без проверки подлинности маркера; лицензия выдается тому, кто ее запрашивает), вы можете проверить его без входа в систему (путем переключения на HTTP, если ваше потоковое видео передается по протоколу HTTP).</span><span class="sxs-lookup"><span data-stu-id="e66e9-460">If what you need is “non-integrated” scenario: video assets hosted in Azure Media Services which are either unprotected, or DRM protected but without token authentication (issuing a license to whoever requesting it), you can test it without login (by switching to HTTP if your video streaming is over HTTP).</span></span>

<span data-ttu-id="e66e9-461">Если необходим полностью интегрированный сценарий (видеоматериалы обеспечены динамической защитой DRM в службах мультимедиа с проверкой подлинности маркера и маркером JWT, создаваемым в Azure AD), необходимо войти в систему.</span><span class="sxs-lookup"><span data-stu-id="e66e9-461">If what you need is end-to-end integrated scenario: video assets is under dynamic DRM protection in Azure Media Services, with token authentication and JWT token being generated by Azure AD, you need to login.</span></span>

### <a name="user-login"></a><span data-ttu-id="e66e9-462">Вход пользователя</span><span class="sxs-lookup"><span data-stu-id="e66e9-462">User login</span></span>
<span data-ttu-id="e66e9-463">Чтобы протестировать полностью интегрированную систему DRM, необходимо создать или добавить учетную запись.</span><span class="sxs-lookup"><span data-stu-id="e66e9-463">In order to test the end-to-end integrated DRM system, you need to have an “account” created or added.</span></span>

<span data-ttu-id="e66e9-464">Какую учетную запись?</span><span class="sxs-lookup"><span data-stu-id="e66e9-464">What account?</span></span>

<span data-ttu-id="e66e9-465">Хотя изначально система Azure разрешала доступ только пользователям учетных записей Майкрософт, теперь она позволяет получать доступ пользователям обеих систем.</span><span class="sxs-lookup"><span data-stu-id="e66e9-465">Although Azure originally allowed access only by Microsoft account users, it now allows access by users from both systems.</span></span> <span data-ttu-id="e66e9-466">Для этого было сделано так, чтобы все свойства Azure стали доверять процессу проверки подлинности Azure AD, чтобы Azure AD стала выполнять проверку подлинности пользователей организации, а также путем создания федеративных отношений, при которых Azure AD доверяет системе идентификации Майкрософт для учетных записей потребителей выполнять проверку подлинности пользователей.</span><span class="sxs-lookup"><span data-stu-id="e66e9-466">This was done by having all the Azure properties trust Azure AD for authentication, having Azure AD authenticate organizational users, and by creating a federation relationship where Azure AD trusts the Microsoft account consumer identity system to authenticate consumer users.</span></span> <span data-ttu-id="e66e9-467">В результате Azure AD может проверять подлинность "гостевых" учетных записей Майкрософт, а также "собственных" учетных записей Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-467">As a result, Azure AD is able to authenticate “guest” Microsoft accounts as well as “native” Azure AD accounts.</span></span>

<span data-ttu-id="e66e9-468">Поскольку Azure AD доверяет домену учетных записей Майкрософт (MSA), можно добавить любые учетные записи из любого из следующих доменов в пользовательский клиент Azure AD и использовать учетную запись для входа:</span><span class="sxs-lookup"><span data-stu-id="e66e9-468">Since Azure AD trusts Microsoft Account (MSA) domain, you can add any accounts from any of the following domains to the custom Azure AD tenant and use the account to login:</span></span>

| <span data-ttu-id="e66e9-469">**Доменное имя**</span><span class="sxs-lookup"><span data-stu-id="e66e9-469">**Domain Name**</span></span> | <span data-ttu-id="e66e9-470">**Домен**</span><span class="sxs-lookup"><span data-stu-id="e66e9-470">**Domain**</span></span> |
| --- | --- |
| <span data-ttu-id="e66e9-471">**Домен пользовательского клиента Azure AD**</span><span class="sxs-lookup"><span data-stu-id="e66e9-471">**Custom Azure AD tenant domain**</span></span> |<span data-ttu-id="e66e9-472">somename.onmicrosoft.com</span><span class="sxs-lookup"><span data-stu-id="e66e9-472">somename.onmicrosoft.com</span></span> |
| <span data-ttu-id="e66e9-473">**Домен организации**</span><span class="sxs-lookup"><span data-stu-id="e66e9-473">**Corporate domain**</span></span> |<span data-ttu-id="e66e9-474">microsoft.com</span><span class="sxs-lookup"><span data-stu-id="e66e9-474">microsoft.com</span></span> |
| <span data-ttu-id="e66e9-475">**Домен учетных записей Майкрософт (MSA)**</span><span class="sxs-lookup"><span data-stu-id="e66e9-475">**Microsoft Account (MSA) domain**</span></span> |<span data-ttu-id="e66e9-476">outlook.com, live.com, hotmail.com</span><span class="sxs-lookup"><span data-stu-id="e66e9-476">outlook.com, live.com, hotmail.com</span></span> |

<span data-ttu-id="e66e9-477">Вы можете связаться со любым автором, чтобы получить созданную или добавленную учетную запись.</span><span class="sxs-lookup"><span data-stu-id="e66e9-477">You may contact any of the authors to have an account created or added for you.</span></span>

<span data-ttu-id="e66e9-478">Ниже приведены снимки экранов различных страниц входа, используемых разными учетными записями домена.</span><span class="sxs-lookup"><span data-stu-id="e66e9-478">Below are the screenshots of different login pages used by different domain accounts.</span></span>

<span data-ttu-id="e66e9-479">**Учетная запись домена пользовательского клиента Azure AD**: в этом случае вы видите настраиваемую страницу входа домена пользовательского клиента Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-479">**Custom Azure AD tenant domain account**: In this case, you see the customized login page of the custom Azure AD tenant domain.</span></span>

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain1.png)

<span data-ttu-id="e66e9-481">**Учетная запись домена Майкрософт со смарт-картой**: в этом случае вы видите страницу входа, настроенную ИТ-специалистами корпорации Майкрософт, с двухфакторной проверкой подлинности.</span><span class="sxs-lookup"><span data-stu-id="e66e9-481">**Microsoft domain account with smart card**: In this case you see the login page customized by Microsoft corporate IT with two-factor authentication.</span></span>

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain2.png)

<span data-ttu-id="e66e9-483">**Учетная запись Майкрософт (MSA)**: в этом случае вы видите страницу входа учетной записи Майкрософт для потребителей.</span><span class="sxs-lookup"><span data-stu-id="e66e9-483">**Microsoft Account (MSA)**: In this case, you see the login page of Microsoft Account for consumers.</span></span>

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain3.png)

### <a name="using-encrypted-media-extensions-for-playready"></a><span data-ttu-id="e66e9-485">Использование расширений зашифрованных носителей для PlayReady</span><span class="sxs-lookup"><span data-stu-id="e66e9-485">Using Encrypted Media Extensions for PlayReady</span></span>
<span data-ttu-id="e66e9-486">В современных браузерах с поддержкой расширений зашифрованных носителей (EME) или PlayReady, таких как IE 11 в Windows 8.1 и выше и Microsoft Edge в Windows 10, PlayReady будет базовой DRM для EME.</span><span class="sxs-lookup"><span data-stu-id="e66e9-486">On a modern browser with Encrypted Media Extensions (EME) for PlayReady support, such as IE 11 on Windows 8.1 and up, and Microsoft Edge browser on Windows 10, PlayReady will be the underlying DRM for EME.</span></span>

![Использование EME для PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready1.png)

<span data-ttu-id="e66e9-488">Темная область проигрывателя возникает из-за того, что защита PlayReady не позволяет сделать снимок экрана защищенного видео.</span><span class="sxs-lookup"><span data-stu-id="e66e9-488">The dark player area is due to the fact that PlayReady protection prevents one from making screen capture of protected video.</span></span>

<span data-ttu-id="e66e9-489">На следующем снимке экрана представлены подключаемые модули проигрывателя и поддержка MSE или EME.</span><span class="sxs-lookup"><span data-stu-id="e66e9-489">The following screen shows the player plugins and MSE/EME support.</span></span>

![Использование EME для PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready2.png)

<span data-ttu-id="e66e9-491">EME в Microsoft Edge и IE 11 в Windows 10 позволяет вызывать из [PlayReady SL3000](https://www.microsoft.com/playready/features/EnhancedContentProtection.aspx/) на устройствах Windows 10, которые ее поддерживают.</span><span class="sxs-lookup"><span data-stu-id="e66e9-491">EME in Microsoft Edge and IE 11 on Windows 10 allows invoking of [PlayReady SL3000](https://www.microsoft.com/playready/features/EnhancedContentProtection.aspx/) on Windows 10 devices which support it.</span></span> <span data-ttu-id="e66e9-492">PlayReady SL3000 разблокирует поток улучшенного содержимого премиум-класса (4K, HDR и т. д.) и новые модели доставки содержимого (раннее окно для улучшенного содержимого).</span><span class="sxs-lookup"><span data-stu-id="e66e9-492">PlayReady SL3000 unlocks the flow of enhanced premium content (4K, HDR, etc.) and new content delivery models (early window for Enhanced Content).</span></span>

<span data-ttu-id="e66e9-493">Если брать во внимание устройства Windows, PlayReady является единственной технологией DRM, доступной на устройствах Windows (PlayReady SL3000).</span><span class="sxs-lookup"><span data-stu-id="e66e9-493">Focus on the Windows devices: PlayReady is the only DRM in the HW available on Windows devices (PlayReady SL3000).</span></span> <span data-ttu-id="e66e9-494">Служба потоковой передачи может использовать PlayReady через EME или приложение UWP. Благодаря PlayReady SL3000 она предлагает более высокое качество видеоизображения, чем другие DRM.</span><span class="sxs-lookup"><span data-stu-id="e66e9-494">A streaming service can use PlayReady through EME or through a UWP application and offer a higher video quality using PlayReady SL3000 than another DRM.</span></span> <span data-ttu-id="e66e9-495">Как правило, содержимое 2K будет передаваться через Chrome или Firefox, а содержимое 4K — через Microsoft Edge и IE11 или приложение UWP на том же устройстве (в зависимости от реализации и параметров службы).</span><span class="sxs-lookup"><span data-stu-id="e66e9-495">Typically, 2K content will flow through Chrome or Firefox, and 4K content through Microsoft Edge/IE11 or a UWP application on the same device (depending on service settings and implementation).</span></span>

#### <a name="using-eme-for-widevine"></a><span data-ttu-id="e66e9-496">Использование EME для Widevine</span><span class="sxs-lookup"><span data-stu-id="e66e9-496">Using EME for Widevine</span></span>
<span data-ttu-id="e66e9-497">В современных браузерах с поддержкой EME и Widevine, таких как Chrome 41+ в Windows 10, Windows 8.1, Mac OSX Yosemite и Chrome в Android 4.4.4, Google Widevine является DRM в основе EME.</span><span class="sxs-lookup"><span data-stu-id="e66e9-497">On a modern browser with EME/Widevine support, such as Chrome 41+ on Windows 10, Windows 8.1, Mac OSX Yosemite, and Chrome on Android 4.4.4, Google Widevine is the DRM behind EME.</span></span>

![Использование EME для Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine1.png)

<span data-ttu-id="e66e9-499">Обратите внимание, что Widevine не запрещает делать снимок экрана защищенного видео.</span><span class="sxs-lookup"><span data-stu-id="e66e9-499">Notice that Widevine does not prevent one from making screen capture of protected video.</span></span>

![Использование EME для Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine2.png)

### <a name="not-entitled-users"></a><span data-ttu-id="e66e9-501">Пользователи, не имеющие прав</span><span class="sxs-lookup"><span data-stu-id="e66e9-501">Not entitled users</span></span>
<span data-ttu-id="e66e9-502">Если пользователь не является участником группы "Соответствующие пользователи", то он не сможет пройти "проверку прав", и служба лицензий с несколькими DRM откажется выдать запрошенную лицензию, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="e66e9-502">If a user is not a member of "Entitled Users" group, the user will not be able to pass “entitlement check” and the multi-DRM license service will refuse to issue the requested license as shown below.</span></span> <span data-ttu-id="e66e9-503">Подробное описание звучит "Не удалось получить лицензию", как это и было задумано.</span><span class="sxs-lookup"><span data-stu-id="e66e9-503">The detailed description is “License acquire failed”, which is as designed.</span></span>

![Пользователи без прав](./media/media-services-cenc-with-multidrm-access-control/media-services-unentitledusers.png)

### <a name="running-custom-secure-token-service"></a><span data-ttu-id="e66e9-505">Использование пользовательской службы маркеров безопасности</span><span class="sxs-lookup"><span data-stu-id="e66e9-505">Running custom Secure Token Service</span></span>
<span data-ttu-id="e66e9-506">В сценариях с использованием настраиваемой службы STS маркер JWT будет выдаваться настраиваемой службой STS с использованием симметричного или асимметричного ключа.</span><span class="sxs-lookup"><span data-stu-id="e66e9-506">For the scenario of running custom Secure Token Service (STS), the JWT token will be issued by the custom STS using either symmetric or asymmetric key.</span></span>

<span data-ttu-id="e66e9-507">Случай использования симметричного ключа (в Chrome):</span><span class="sxs-lookup"><span data-stu-id="e66e9-507">The case of using symmetric key (using Chrome):</span></span>

![Выполнение пользовательской STS](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts1.png)

<span data-ttu-id="e66e9-509">Случай использования асимметричного ключа через сертификат X509 (в современных браузерах Майкрософт).</span><span class="sxs-lookup"><span data-stu-id="e66e9-509">The case of using asymmetric key via an X509 certificate (using Microsoft modern browser).</span></span>

![Выполнение пользовательской STS](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts2.png)

<span data-ttu-id="e66e9-511">В обоих указанных случаях проверка подлинности пользователя остается неизменной — через Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-511">In both of the above cases, user authentication stays the same – through Azure AD.</span></span> <span data-ttu-id="e66e9-512">Единственное различие состоит в том, что маркеры JWT выдаются пользовательской STS вместо Azure AD.</span><span class="sxs-lookup"><span data-stu-id="e66e9-512">The only difference is that JWT tokens are issued by the custom STS instead of Azure AD.</span></span> <span data-ttu-id="e66e9-513">Конечно, при настройке динамической защиты CENC ограничение службы доставки лицензий указывает тип маркера JWT, симметричный или асимметричный ключ.</span><span class="sxs-lookup"><span data-stu-id="e66e9-513">Of course, when configuring dynamic CENC protection, the restriction of license delivery service specifies the type of JWT token, either symmetric or asymmetric key.</span></span>

## <a name="summary"></a><span data-ttu-id="e66e9-514">Сводка</span><span class="sxs-lookup"><span data-stu-id="e66e9-514">Summary</span></span>
<span data-ttu-id="e66e9-515">В этом документе мы обсуждали CENC с несколькими собственными DRM и контролем доступа через проверку подлинности маркера: проектирование и реализацию системы с помощью Azure, служб мультимедиа Azure и Проигрывателя мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="e66e9-515">In this document, we discussed CENC with multi-native-DRM and access control via token authentication: its design and its implementation using Azure, Azure Media Services and Azure Media Player.</span></span>

* <span data-ttu-id="e66e9-516">Мы представили справочную структуру, содержащую все необходимые компоненты в подсистеме DRM и CENC, а также</span><span class="sxs-lookup"><span data-stu-id="e66e9-516">A reference design is presented which contains all the necessary components in a DRM/CENC subsystem;</span></span>
* <span data-ttu-id="e66e9-517">справочную реализацию в Azure, службах мультимедиа Azure и Проигрывателе мультимедиа Azure.</span><span class="sxs-lookup"><span data-stu-id="e66e9-517">A reference implementation on Azure, Azure Media Services and Azure Media Player.</span></span>
* <span data-ttu-id="e66e9-518">Мы также обсудили некоторые вопросы, напрямую связанные с проектированием и реализацией.</span><span class="sxs-lookup"><span data-stu-id="e66e9-518">Some topics directly involved in the design and implementation are also discussed.</span></span>

## <a name="media-services-learning-paths"></a><span data-ttu-id="e66e9-519">Схемы обучения работе со службами мультимедиа</span><span class="sxs-lookup"><span data-stu-id="e66e9-519">Media Services learning paths</span></span>
[!INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a><span data-ttu-id="e66e9-520">Отзывы</span><span class="sxs-lookup"><span data-stu-id="e66e9-520">Provide feedback</span></span>
[!INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]
 

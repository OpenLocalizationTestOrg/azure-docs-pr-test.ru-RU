---
title: "Проверка подлинности Azure Active Directory и Resource Manager | Документы Майкрософт"
description: "Руководство разработчика по проверке подлинности с помощью API Azure Resource Manager и Azure Active Directory для интеграции приложения с другими подписками Azure."
services: azure-resource-manager,active-directory
documentationcenter: na
author: dushyantgill
manager: timlt
editor: tysonn
ms.assetid: 17b2b40d-bf42-4c7d-9a88-9938409c5088
ms.service: azure-resource-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/27/2016
ms.author: dugill;tomfitz
ms.openlocfilehash: 7830dc4774652f4d108e98660dce3bcea7b32d05
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="use-resource-manager-authentication-api-to-access-subscriptions"></a><span data-ttu-id="45896-103">Использование API аутентификации Resource Manager для доступа к подпискам</span><span class="sxs-lookup"><span data-stu-id="45896-103">Use Resource Manager authentication API to access subscriptions</span></span>
## <a name="introduction"></a><span data-ttu-id="45896-104">Введение</span><span class="sxs-lookup"><span data-stu-id="45896-104">Introduction</span></span>
<span data-ttu-id="45896-105">Если вы разрабатываете программное обеспечение и хотите создать приложение для управления ресурсами Azure клиента, это руководство предназначено для вас. Здесь вы узнаете, как выполнить проверку подлинности с помощью интерфейсов API Azure Resource Manager и получить доступ к ресурсам в другой подписке.</span><span class="sxs-lookup"><span data-stu-id="45896-105">If you are a software developer who needs to create an app that manages customer's Azure resources, this topic shows you how to authenticate with the Azure Resource Manager APIs and gain access to resources in other subscriptions.</span></span>

<span data-ttu-id="45896-106">Приложение может получить доступ к интерфейсам API Azure Resource Manager двумя способами:</span><span class="sxs-lookup"><span data-stu-id="45896-106">Your app can access the Resource Manager APIs in couple of ways:</span></span>

1. <span data-ttu-id="45896-107">**Доступ от имени пользователя.**Используйте этот метод для приложений, осуществляющих доступ к ресурсам от имени выполнившего вход пользователя.</span><span class="sxs-lookup"><span data-stu-id="45896-107">**User + app access**: for apps that access resources on behalf of a signed-in user.</span></span> <span data-ttu-id="45896-108">Этот метод подходит для приложений, например веб-приложений и программ командной строки, которые осуществляют только интерактивное управление ресурсами Azure.</span><span class="sxs-lookup"><span data-stu-id="45896-108">This approach works for apps, such as web apps and command-line tools, that deal with only "interactive management" of Azure resources.</span></span>
2. <span data-ttu-id="45896-109">**Доступ только для приложений.**Используйте этот метод для приложений, на которых запущены службы управляющих программ и запланированные задания.</span><span class="sxs-lookup"><span data-stu-id="45896-109">**App-only access**: for apps that run daemon services and scheduled jobs.</span></span> <span data-ttu-id="45896-110">Удостоверение приложения предоставляет непосредственный доступ к ресурсам.</span><span class="sxs-lookup"><span data-stu-id="45896-110">The app's identity is granted direct access to the resources.</span></span> <span data-ttu-id="45896-111">Этот метод подходит для приложений, требующих долгосрочного автономного (автоматического) доступа Azure.</span><span class="sxs-lookup"><span data-stu-id="45896-111">This approach works for apps that need long-term headless (unattended) access to Azure.</span></span>

<span data-ttu-id="45896-112">В этой статье содержатся пошаговые инструкции по созданию приложения, поддерживающего оба эти метода авторизации.</span><span class="sxs-lookup"><span data-stu-id="45896-112">This topic provides step-by-step instructions to create an app that employs both these authorization methods.</span></span> <span data-ttu-id="45896-113">Здесь показано, как выполнить каждое действие, используя REST API или C#.</span><span class="sxs-lookup"><span data-stu-id="45896-113">It shows how to perform each step with REST API or C#.</span></span> <span data-ttu-id="45896-114">Полное приложение ASP.NET MVC можно получить на странице [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span><span class="sxs-lookup"><span data-stu-id="45896-114">The complete ASP.NET MVC application is available at [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span></span>

## <a name="what-the-web-app-does"></a><span data-ttu-id="45896-115">Возможности веб-приложения</span><span class="sxs-lookup"><span data-stu-id="45896-115">What the web app does</span></span>
<span data-ttu-id="45896-116">Веб-приложение обеспечивает следующие возможности:</span><span class="sxs-lookup"><span data-stu-id="45896-116">The web app:</span></span>

1. <span data-ttu-id="45896-117">Вход пользователя Azure в систему.</span><span class="sxs-lookup"><span data-stu-id="45896-117">Signs-in an Azure user.</span></span>
2. <span data-ttu-id="45896-118">Отправка запроса к пользователю на предоставление веб-приложению доступа к Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="45896-118">Asks user to grant the web app access to Resource Manager.</span></span>
3. <span data-ttu-id="45896-119">Получение маркера доступа от имени пользователя для доступа к Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="45896-119">Gets user + app access token for accessing Resource Manager.</span></span>
4. <span data-ttu-id="45896-120">Вызов Resource Manager с помощью маркера (полученного на шаге 3) и назначение субъекту-службе приложения роли в подписке, в результате чего приложение получает долгосрочный доступ к подписке.</span><span class="sxs-lookup"><span data-stu-id="45896-120">Uses token (from step 3) to call Resource Manager and assign the app's service principal to a role in the subscription, which gives the app long-term access to the subscription.</span></span>
5. <span data-ttu-id="45896-121">Получение маркера доступа только для приложений.</span><span class="sxs-lookup"><span data-stu-id="45896-121">Gets app-only access token.</span></span>
6. <span data-ttu-id="45896-122">Управление ресурсами в подписке через Resource Manager с помощью маркера (полученного на шаге 5).</span><span class="sxs-lookup"><span data-stu-id="45896-122">Uses token (from step 5) to manage resources in the subscription through Resource Manager.</span></span>

<span data-ttu-id="45896-123">Ниже приведены все процедуры, выполняемые веб-приложением.</span><span class="sxs-lookup"><span data-stu-id="45896-123">Here's the end-to-end flow of the web application.</span></span>

![Поток проверки подлинности Resource Manager](./media/resource-manager-api-authentication/Auth-Swim-Lane.png)

<span data-ttu-id="45896-125">Укажите идентификатор используемой подписки от имени пользователя.</span><span class="sxs-lookup"><span data-stu-id="45896-125">As a user, you provide the subscription id for the subscription you want to use:</span></span>

![предоставление идентификатора подписки](./media/resource-manager-api-authentication/sample-ux-1.png)

<span data-ttu-id="45896-127">Выберите учетную запись для входа в систему.</span><span class="sxs-lookup"><span data-stu-id="45896-127">Select the account to use for logging in.</span></span>

![выбор учетной записи](./media/resource-manager-api-authentication/sample-ux-2.png)

<span data-ttu-id="45896-129">Укажите свои учетные данные.</span><span class="sxs-lookup"><span data-stu-id="45896-129">Provide your credentials.</span></span>

![предоставление учетных данных](./media/resource-manager-api-authentication/sample-ux-3.png)

<span data-ttu-id="45896-131">Предоставьте приложению доступ к своим подпискам Azure.</span><span class="sxs-lookup"><span data-stu-id="45896-131">Grant the app access to your Azure subscriptions:</span></span>

![Предоставление доступа](./media/resource-manager-api-authentication/sample-ux-4.png)

<span data-ttu-id="45896-133">Управляйте своими подключенными подписками.</span><span class="sxs-lookup"><span data-stu-id="45896-133">Manage your connected subscriptions:</span></span>

![Подключение подписки](./media/resource-manager-api-authentication/sample-ux-7.png)

## <a name="register-application"></a><span data-ttu-id="45896-135">Регистрация приложения</span><span class="sxs-lookup"><span data-stu-id="45896-135">Register application</span></span>
<span data-ttu-id="45896-136">Прежде чем приступить к программированию, сначала нужно зарегистрировать веб-приложение в Azure Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="45896-136">Before you start coding, register your web app with Azure Active Directory (AD).</span></span> <span data-ttu-id="45896-137">При регистрации приложения для него создается центральное удостоверение в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="45896-137">The app registration creates a central identity for your app in Azure AD.</span></span> <span data-ttu-id="45896-138">Оно содержит основные сведения о приложении, например идентификатор клиента OAuth, URL-адреса ответа и учетные данные, используемые приложением для проверки подлинности и доступа к интерфейсам API Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="45896-138">It holds basic information about your application like OAuth Client ID, Reply URLs, and credentials that your application uses to authenticate and access Azure Resource Manager APIs.</span></span> <span data-ttu-id="45896-139">Кроме того, при регистрации приложения записываются различные делегированные разрешения, необходимые при получении доступа к интерфейсам API корпорации Майкрософт от имени пользователя.</span><span class="sxs-lookup"><span data-stu-id="45896-139">The app registration also records the various delegated permissions that your application needs when accessing Microsoft APIs on behalf of the user.</span></span>

<span data-ttu-id="45896-140">Так как приложение получает доступ к другой подписке, его необходимо настроить как мультитенантное.</span><span class="sxs-lookup"><span data-stu-id="45896-140">Because your app accesses other subscription, you must configure it as a multi-tenant application.</span></span> <span data-ttu-id="45896-141">Чтобы пройти проверку, укажите домен, связанный с Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="45896-141">To pass validation, provide a domain associated with your Azure Active Directory.</span></span> <span data-ttu-id="45896-142">Сведения о домене, связанном с Azure Active Directory, можно просмотреть на [классическом портале](https://manage.windowsazure.com).</span><span class="sxs-lookup"><span data-stu-id="45896-142">To see the domains associated with your Azure Active Directory, log in to the [classic portal](https://manage.windowsazure.com).</span></span> <span data-ttu-id="45896-143">Выберите свою службу Azure Active Directory и щелкните **Домены**.</span><span class="sxs-lookup"><span data-stu-id="45896-143">Select your Azure Active Directory and then select **Domains**.</span></span>

<span data-ttu-id="45896-144">В приведенном ниже примере показано, как зарегистрировать приложение с помощью Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="45896-144">The following example shows how to register the app by using Azure PowerShell.</span></span> <span data-ttu-id="45896-145">Эта команда поддерживается только в Azure PowerShell последней версии (обновление от августа 2016 г.).</span><span class="sxs-lookup"><span data-stu-id="45896-145">You must have the latest version (August 2016) of Azure PowerShell for this command to work.</span></span>

    $app = New-AzureRmADApplication -DisplayName "{app name}" -HomePage "https://{your domain}/{app name}" -IdentifierUris "https://{your domain}/{app name}" -Password "{your password}" -AvailableToOtherTenants $true

<span data-ttu-id="45896-146">Для входа в систему в качестве приложения AD необходимо указать идентификатор приложения и пароль.</span><span class="sxs-lookup"><span data-stu-id="45896-146">To log in as the AD application, you need the application id and password.</span></span> <span data-ttu-id="45896-147">Чтобы просмотреть идентификатор приложения, который возвращается в результате выполнения предыдущей команды, используйте следующую команду:</span><span class="sxs-lookup"><span data-stu-id="45896-147">To see the application id that is returned from the previous command, use:</span></span>

    $app.ApplicationId

<span data-ttu-id="45896-148">В приведенном ниже примере показано, как зарегистрировать приложение с помощью Azure CLI.</span><span class="sxs-lookup"><span data-stu-id="45896-148">The following example shows how to register the app by using Azure CLI.</span></span>

    azure ad app create --name {app name} --home-page https://{your domain}/{app name} --identifier-uris https://{your domain}/{app name} --password {your password} --available true

<span data-ttu-id="45896-149">Выходные данные содержат идентификатор приложения, необходимый для проверки подлинности в качестве приложения.</span><span class="sxs-lookup"><span data-stu-id="45896-149">The results include the AppId, which you need when authenticating as the application.</span></span>

### <a name="optional-configuration---certificate-credential"></a><span data-ttu-id="45896-150">Дополнительная настройка. Учетные данные сертификата</span><span class="sxs-lookup"><span data-stu-id="45896-150">Optional configuration - certificate credential</span></span>
<span data-ttu-id="45896-151">Azure AD также поддерживает учетные данные сертификата для приложения. При этом вам нужно создать самозаверяющий сертификат, сохранить закрытый ключ и добавить открытый ключ для регистрации приложения Azure AD.</span><span class="sxs-lookup"><span data-stu-id="45896-151">Azure AD also supports certificate credentials for applications: you create a self-signed cert, keep the private key, and add the public key to your Azure AD application registration.</span></span> <span data-ttu-id="45896-152">Для проверки подлинности приложение отправляет в Azure AD небольшой объем полезных данных, подписанных с помощью закрытого ключа, а Azure AD проверяет подпись, используя зарегистрированный открытый ключ.</span><span class="sxs-lookup"><span data-stu-id="45896-152">For authentication, your application sends a small payload to Azure AD signed using your private key, and Azure AD validates the signature using the public key that you registered.</span></span>

<span data-ttu-id="45896-153">Дополнительные сведения о создании приложения AD с использованием сертификата см. в статье [Использование Azure PowerShell для создания субъекта-службы и доступа к ресурса](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) или [Использование интерфейса командной строки Azure для создания субъекта-службы и доступа к ресурсам](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span><span class="sxs-lookup"><span data-stu-id="45896-153">For information about creating an AD app with a certificate, see [Use Azure PowerShell to create a service principal to access resources](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) or [Use Azure CLI to create a service principal to access resources](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span></span>

## <a name="get-tenant-id-from-subscription-id"></a><span data-ttu-id="45896-154">Получение идентификатора клиента из идентификатора подписки</span><span class="sxs-lookup"><span data-stu-id="45896-154">Get tenant id from subscription id</span></span>
<span data-ttu-id="45896-155">Чтобы получить маркер, используемый для вызова Resource Manager, в приложении необходимо указать идентификатор клиента Azure AD, в котором находится подписка Azure.</span><span class="sxs-lookup"><span data-stu-id="45896-155">To request a token that can be used to call Resource Manager, your application needs to know the tenant ID of the Azure AD tenant that hosts the Azure subscription.</span></span> <span data-ttu-id="45896-156">Скорее всего, пользователи знают идентификаторы подписок, но идентификаторы клиентов Azure Active Directory знает не каждый.</span><span class="sxs-lookup"><span data-stu-id="45896-156">Most likely, your users know their subscription ids, but they might not know their tenant ids for Azure Active Directory.</span></span> <span data-ttu-id="45896-157">Чтобы получить идентификатор клиента, необходимо знать идентификатор подписки пользователя.</span><span class="sxs-lookup"><span data-stu-id="45896-157">To get the user's tenant id, ask the user for the subscription id.</span></span> <span data-ttu-id="45896-158">Укажите этот идентификатор подписки при отправке запроса о подписке.</span><span class="sxs-lookup"><span data-stu-id="45896-158">Provide that subscription id when sending a request about the subscription:</span></span>

    https://management.azure.com/subscriptions/{subscription-id}?api-version=2015-01-01

<span data-ttu-id="45896-159">Запрос завершится сбоем, так как пользователь еще не вошел в систему, но идентификатор клиента можно получить из ответа.</span><span class="sxs-lookup"><span data-stu-id="45896-159">The request fails because the user has not logged in yet, but you can retrieve the tenant id from the response.</span></span> <span data-ttu-id="45896-160">В этом исключении идентификатор клиента указан в заголовке ответа **WWW-Authenticate**.</span><span class="sxs-lookup"><span data-stu-id="45896-160">In that exception, retrieve the tenant id from the response header value for **WWW-Authenticate**.</span></span> <span data-ttu-id="45896-161">Эта реализация используется в методе [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) .</span><span class="sxs-lookup"><span data-stu-id="45896-161">You see this implementation in the [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) method.</span></span>

## <a name="get-user--app-access-token"></a><span data-ttu-id="45896-162">Получение маркера доступа от имени пользователя</span><span class="sxs-lookup"><span data-stu-id="45896-162">Get user + app access token</span></span>
<span data-ttu-id="45896-163">Приложение перенаправляет пользователя в Azure AD с помощью запроса на авторизацию OAuth 2.0, применяемого для проверки подлинности учетных данных пользователя и возвращения кода авторизации.</span><span class="sxs-lookup"><span data-stu-id="45896-163">Your application redirects the user to Azure AD with an OAuth 2.0 Authorize Request - to authenticate the user's credentials and get back an authorization code.</span></span> <span data-ttu-id="45896-164">Приложение использует код авторизации, чтобы получить маркер доступа для Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="45896-164">Your application uses the authorization code to get an access token for Resource Manager.</span></span> <span data-ttu-id="45896-165">Метод [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) создает запрос на авторизацию.</span><span class="sxs-lookup"><span data-stu-id="45896-165">The [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) method creates the authorization request.</span></span>

<span data-ttu-id="45896-166">Здесь приводятся примеры запросов REST API, используемых для проверки подлинности пользователя.</span><span class="sxs-lookup"><span data-stu-id="45896-166">This topic shows the REST API requests to authenticate the user.</span></span> <span data-ttu-id="45896-167">Чтобы реализовать проверку подлинности в коде, можно также использовать вспомогательные библиотеки.</span><span class="sxs-lookup"><span data-stu-id="45896-167">You can also use helper libraries to perform authentication in your code.</span></span> <span data-ttu-id="45896-168">Дополнительные сведения об этих библиотеках см. в статье [Библиотеки проверки подлинности Azure Active Directory](../active-directory/active-directory-authentication-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="45896-168">For more information about these libraries, see [Azure Active Directory Authentication Libraries](../active-directory/active-directory-authentication-libraries.md).</span></span> <span data-ttu-id="45896-169">Рекомендации по интеграции функции управления удостоверениями в приложение см. в статье [Руководство разработчика по Azure Active Directory](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="45896-169">For guidance on integrating identity management in an application, see [Azure Active Directory developer's guide](../active-directory/active-directory-developers-guide.md).</span></span>

### <a name="auth-request-oauth-20"></a><span data-ttu-id="45896-170">Запрос проверки подлинности (OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="45896-170">Auth request (OAuth 2.0)</span></span>
<span data-ttu-id="45896-171">Выполните запрос на авторизацию Open ID Connect или OAuth 2.0 к конечной точке авторизации Azure AD:</span><span class="sxs-lookup"><span data-stu-id="45896-171">Issue an Open ID Connect/OAuth2.0 Authorize Request to the Azure AD Authorize endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize

<span data-ttu-id="45896-172">Параметры строки запроса, доступные для этого запроса, описаны в разделе [Запрос кода авторизации](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code).</span><span class="sxs-lookup"><span data-stu-id="45896-172">The query string parameters that are available for this request are described in the [request an authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) topic.</span></span>

<span data-ttu-id="45896-173">В следующем примере показано, как запросить авторизацию OAuth 2.0:</span><span class="sxs-lookup"><span data-stu-id="45896-173">The following example shows how to request OAuth2.0 authorization:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=query&response_type=code&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&domain_hint=live.com

<span data-ttu-id="45896-174">Служба Azure AD проверяет подлинность пользователя и при необходимости запрашивает у пользователя разрешение на доступ к приложению.</span><span class="sxs-lookup"><span data-stu-id="45896-174">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="45896-175">Она возвращает код авторизации на URL-адрес ответа приложения.</span><span class="sxs-lookup"><span data-stu-id="45896-175">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="45896-176">В зависимости от запрошенного параметра response_mode Azure AD отправляет данные в строке запроса или в качестве данных POST.</span><span class="sxs-lookup"><span data-stu-id="45896-176">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

    code=AAABAAAAiL****FDMZBUwZ8eCAA&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="auth-request-open-id-connect"></a><span data-ttu-id="45896-177">Запрос проверки подлинности (Open ID Connect)</span><span class="sxs-lookup"><span data-stu-id="45896-177">Auth request (Open ID Connect)</span></span>
<span data-ttu-id="45896-178">Если требуется не только получить доступ к Azure Resource Manager от имени пользователя, но и разрешить пользователю входить в ваше приложение с помощью его учетной записи Azure AD, отправьте запрос на авторизацию Open ID Connect.</span><span class="sxs-lookup"><span data-stu-id="45896-178">If you not only wish to access Azure Resource Manager on behalf of the user, but also allow the user to sign in to your application using their Azure AD account, issue an Open ID Connect Authorize Request.</span></span> <span data-ttu-id="45896-179">С помощью Open ID Connect приложение также получит маркер id_token из Azure AD, используемый приложением для выполнения входа пользователя.</span><span class="sxs-lookup"><span data-stu-id="45896-179">With Open ID Connect, your application also receives an id_token from Azure AD that your app can use to sign in the user.</span></span>

<span data-ttu-id="45896-180">Параметры строки запроса, доступные для этого запроса, описаны в разделе [Отправка запроса на вход](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request).</span><span class="sxs-lookup"><span data-stu-id="45896-180">The query string parameters that are available for this request are described in the [Send the sign-in request](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) topic.</span></span>

<span data-ttu-id="45896-181">Пример запроса Open ID Connect:</span><span class="sxs-lookup"><span data-stu-id="45896-181">An example Open ID Connect request is:</span></span>

     https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=form_post&response_type=code+id_token&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&scope=openid+profile&nonce=63567Dc4MDAw&domain_hint=live.com&state=M_12tMyKaM8

<span data-ttu-id="45896-182">Служба Azure AD проверяет подлинность пользователя и при необходимости запрашивает у пользователя разрешение на доступ к приложению.</span><span class="sxs-lookup"><span data-stu-id="45896-182">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="45896-183">Она возвращает код авторизации на URL-адрес ответа приложения.</span><span class="sxs-lookup"><span data-stu-id="45896-183">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="45896-184">В зависимости от запрошенного параметра response_mode Azure AD отправляет данные в строке запроса или в качестве данных POST.</span><span class="sxs-lookup"><span data-stu-id="45896-184">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

<span data-ttu-id="45896-185">Пример ответа Open ID Connect:</span><span class="sxs-lookup"><span data-stu-id="45896-185">An example Open ID Connect response is:</span></span>

    code=AAABAAAAiL*****I4rDWd7zXsH6WUjlkIEQxIAA&id_token=eyJ0eXAiOiJKV1Q*****T3GrzzSFxg&state=M_12tMyKaM8&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="token-request-oauth20-code-grant-flow"></a><span data-ttu-id="45896-186">Запрос токена (предоставление кода OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="45896-186">Token request (OAuth2.0 Code Grant Flow)</span></span>
<span data-ttu-id="45896-187">Теперь, когда приложение получило код авторизации из Azure AD, необходимо получить маркер доступа для Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="45896-187">Now that your application has received the authorization code from Azure AD, it is time to get the access token for Azure Resource Manager.</span></span>  <span data-ttu-id="45896-188">Выполните запрос на токен предоставления кода OAuth 2.0 к конечной точке токена Azure AD с помощью метода POST:</span><span class="sxs-lookup"><span data-stu-id="45896-188">Post an OAuth2.0 Code Grant Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="45896-189">Параметры строки запроса, доступные для этого запроса, описаны в разделе [Использование кода авторизации для запроса маркера доступа](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token).</span><span class="sxs-lookup"><span data-stu-id="45896-189">The query string parameters that are available for this request are described in the [use the authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) topic.</span></span>

<span data-ttu-id="45896-190">В следующем примере показан запрос на токен предоставления кода с использованием пароля:</span><span class="sxs-lookup"><span data-stu-id="45896-190">The following example shows a request for code grant token with password credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="45896-191">При работе с учетными данными сертификата создайте веб-токен JSON (JWT) и подпишите его (RSA-SHA256) с помощью закрытого ключа сертификата приложения.</span><span class="sxs-lookup"><span data-stu-id="45896-191">When working with certificate credentials, create a JSON Web Token (JWT) and sign (RSA SHA256) using the private key of your application's certificate credential.</span></span> <span data-ttu-id="45896-192">Типы утверждений для маркера содержатся в разделе [Утверждения JWT](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span><span class="sxs-lookup"><span data-stu-id="45896-192">The claim types for the token are shown in [JWT token claims](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span></span> <span data-ttu-id="45896-193">Справочную информацию по подписыванию маркеров JWT утверждений клиента см. на странице с [кодом библиотеки аутентификации Active Directory (.NET)](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs).</span><span class="sxs-lookup"><span data-stu-id="45896-193">For reference, see the [Active Directory Auth Library (.NET) code](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) to sign Client Assertion JWT tokens.</span></span>

<span data-ttu-id="45896-194">Дополнительные сведения об аутентификации клиента см. на странице [характеристик Open ID Connect](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication).</span><span class="sxs-lookup"><span data-stu-id="45896-194">See the [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) for details on client authentication.</span></span>

<span data-ttu-id="45896-195">В следующем примере показан запрос на токен предоставления кода с использованием учетных данных сертификата:</span><span class="sxs-lookup"><span data-stu-id="45896-195">The following example shows a request for code grant token with certificate credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&client_assertion=eyJhbG*****Y9cYo8nEjMyA

<span data-ttu-id="45896-196">Пример ответа для токена предоставления кода:</span><span class="sxs-lookup"><span data-stu-id="45896-196">An example response for code grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039858","not_before":"1432035958","resource":"https://management.core.windows.net/","access_token":"eyJ0eXAiOiJKV1Q****M7Cw6JWtfY2lGc5A","refresh_token":"AAABAAAAiL9Kn2Z****55j-sjnyYgAA","scope":"user_impersonation","id_token":"eyJ0eXAiOiJKV*****-drP1J3P-HnHi9Rr46kGZnukEBH4dsg"}

#### <a name="handle-code-grant-token-response"></a><span data-ttu-id="45896-197">Обработка ответа токена предоставления кода</span><span class="sxs-lookup"><span data-stu-id="45896-197">Handle code grant token response</span></span>
<span data-ttu-id="45896-198">Успешный ответ будет содержать маркер доступа (при доступе от имени пользователя) для Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="45896-198">A successful token response contains the (user + app) access token for Azure Resource Manager.</span></span> <span data-ttu-id="45896-199">Приложение использует этот маркер для доступа к Resource Manager от имени пользователя.</span><span class="sxs-lookup"><span data-stu-id="45896-199">Your application uses this access token to access Resource Manager on behalf of the user.</span></span> <span data-ttu-id="45896-200">Срок действия маркеров доступа, выданных Azure AD, составляет один час.</span><span class="sxs-lookup"><span data-stu-id="45896-200">The lifetime of access tokens issued by Azure AD is one hour.</span></span> <span data-ttu-id="45896-201">Маловероятно, что веб-приложению понадобится обновить маркер доступа (при доступе от имени пользователя).</span><span class="sxs-lookup"><span data-stu-id="45896-201">It is unlikely that your web application needs to renew the (user + app) access token.</span></span> <span data-ttu-id="45896-202">Однако если обновление потребуется, можно воспользоваться маркером обновления, который приложение получает в ответе маркера.</span><span class="sxs-lookup"><span data-stu-id="45896-202">If it needs to renew the access token, use the refresh token that your application receives in the token response.</span></span> <span data-ttu-id="45896-203">Выполните запрос токена OAuth 2.0 к конечной точке токена Azure AD с помощью метода POST:</span><span class="sxs-lookup"><span data-stu-id="45896-203">Post an OAuth2.0 Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="45896-204">Параметры для запроса обновления описаны в разделе [Обновление маркеров доступа](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span><span class="sxs-lookup"><span data-stu-id="45896-204">The parameters to use with the refresh request are described in [refreshing the access token](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span></span>

<span data-ttu-id="45896-205">В следующем примере показано, как использовать токен обновления:</span><span class="sxs-lookup"><span data-stu-id="45896-205">The following example shows how to use the refresh token:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=refresh_token&refresh_token=AAABAAAAiL9Kn2Z****55j-sjnyYgAA&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="45896-206">Хотя с помощью маркеров обновления и можно получать новые маркеры доступа для Azure Resource Manager, они не подходят для автономного доступа приложения.</span><span class="sxs-lookup"><span data-stu-id="45896-206">Although refresh tokens can be used to get new access tokens for Azure Resource Manager, they are not suitable for offline access by your application.</span></span> <span data-ttu-id="45896-207">Срок действия токенов обновления ограничен, и они привязаны к пользователю.</span><span class="sxs-lookup"><span data-stu-id="45896-207">The refresh tokens lifetime is limited, and refresh tokens are bound to the user.</span></span> <span data-ttu-id="45896-208">Если пользователь покидает организацию, приложение, использующее маркер обновления, теряет доступ.</span><span class="sxs-lookup"><span data-stu-id="45896-208">If the user leaves the organization, the application using the refresh token loses access.</span></span> <span data-ttu-id="45896-209">Этот способ не подходит для приложений, используемых группами для управления ресурсами Azure.</span><span class="sxs-lookup"><span data-stu-id="45896-209">This approach isn't suitable for applications that are used by teams to manage their Azure resources.</span></span>

## <a name="check-if-user-can-assign-access-to-subscription"></a><span data-ttu-id="45896-210">Проверка назначения пользователем доступа к подписке</span><span class="sxs-lookup"><span data-stu-id="45896-210">Check if user can assign access to subscription</span></span>
<span data-ttu-id="45896-211">Теперь у приложения есть маркер доступа к Azure Resource Manager от имени пользователя.</span><span class="sxs-lookup"><span data-stu-id="45896-211">Your application now has a token to access Azure Resource Manager on behalf of the user.</span></span> <span data-ttu-id="45896-212">Далее нужно подключить приложение к подписке,</span><span class="sxs-lookup"><span data-stu-id="45896-212">The next step is to connect your app to the subscription.</span></span> <span data-ttu-id="45896-213">чтобы оно могло управлять подписками, даже если пользователь отсутствует (долгосрочный автономный доступ).</span><span class="sxs-lookup"><span data-stu-id="45896-213">After connecting, your app can manage those subscriptions even when the user isn't present (long-term offline access).</span></span>

<span data-ttu-id="45896-214">Для подключения каждой подписки необходимо вызвать API [разрешений списка Resource Manager](https://docs.microsoft.com/rest/api/authorization/permissions) , чтобы определить, есть ли у пользователя права управления доступом для подписки.</span><span class="sxs-lookup"><span data-stu-id="45896-214">For each subscription to connect, call the [Resource Manager list permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API to determine whether the user has access management rights for the subscription.</span></span>

<span data-ttu-id="45896-215">Этот вызов осуществляет метод [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) примера приложения ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="45896-215">The [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) method of the ASP.NET MVC sample app implements this call.</span></span>

<span data-ttu-id="45896-216">В следующем примере показано, как запросить разрешения пользователя для подписки.</span><span class="sxs-lookup"><span data-stu-id="45896-216">The following example shows how to request a user's permissions on a subscription.</span></span> <span data-ttu-id="45896-217">83cfe939-2402-4581-b761-4f59b0a041e4 — это идентификатор подписки.</span><span class="sxs-lookup"><span data-stu-id="45896-217">83cfe939-2402-4581-b761-4f59b0a041e4 is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/83cfe939-2402-4581-b761-4f59b0a041e4/providers/microsoft.authorization/permissions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiLC***lwO1mM7Cw6JWtfY2lGc5A

<span data-ttu-id="45896-218">Пример ответа на получение разрешений пользователя на подписку:</span><span class="sxs-lookup"><span data-stu-id="45896-218">An example of the response to get user's permissions on subscription is:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"actions":["*"],"notActions":["Microsoft.Authorization/*/Write","Microsoft.Authorization/*/Delete"]},{"actions":["*/read"],"notActions":[]}]}

<span data-ttu-id="45896-219">API разрешений возвращает несколько разрешений.</span><span class="sxs-lookup"><span data-stu-id="45896-219">The permissions API returns multiple permissions.</span></span> <span data-ttu-id="45896-220">Каждое разрешение состоит из разрешенных действий (actions) и запрещенных действий (notActions).</span><span class="sxs-lookup"><span data-stu-id="45896-220">Each permission consists of allowed actions (actions) and disallowed actions (notactions).</span></span> <span data-ttu-id="45896-221">Если действие есть в списке разрешенных действий любого разрешения и отсутствует в списке запрещенных действий этого же разрешения, пользователь может его выполнять.</span><span class="sxs-lookup"><span data-stu-id="45896-221">If an action is present in the allowed actions list of any permission and not present in the notactions list of that permission, the user is allowed to perform that action.</span></span> <span data-ttu-id="45896-222">**microsoft.authorization/roleassignments/write** — действие, предоставляющее права на управление доступом.</span><span class="sxs-lookup"><span data-stu-id="45896-222">**microsoft.authorization/roleassignments/write** is the action that that grants access management rights.</span></span> <span data-ttu-id="45896-223">Приложение должно проанализировать результат разрешений, чтобы найти соответствующее регулярное выражение в этой строке действия в разрешенных и запрещенных действиях всех разрешений.</span><span class="sxs-lookup"><span data-stu-id="45896-223">Your application must parse the permissions result to look for a regex match on this action string in the actions and notactions of each permission.</span></span>

## <a name="get-app-only-access-token"></a><span data-ttu-id="45896-224">Получение маркера доступа только для приложений</span><span class="sxs-lookup"><span data-stu-id="45896-224">Get app-only access token</span></span>
<span data-ttu-id="45896-225">Теперь вы знаете, что пользователь может назначить доступ к подписке Azure.</span><span class="sxs-lookup"><span data-stu-id="45896-225">Now, you know if the user can assign access to the Azure subscription.</span></span> <span data-ttu-id="45896-226">Теперь нужно сделать следующее:</span><span class="sxs-lookup"><span data-stu-id="45896-226">The next steps are:</span></span>

1. <span data-ttu-id="45896-227">Назначить удостоверению приложения в подписке соответствующую роль RBAC.</span><span class="sxs-lookup"><span data-stu-id="45896-227">Assign the appropriate RBAC role to your application's identity on the subscription.</span></span>
2. <span data-ttu-id="45896-228">Проверить назначение доступа, запрашивая разрешение приложения для подписки или получив доступ к Resource Manager с помощью маркера только для приложений.</span><span class="sxs-lookup"><span data-stu-id="45896-228">Validate the access assignment by querying for the Application's permission on the subscription or by accessing Resource Manager using app-only token.</span></span>
3. <span data-ttu-id="45896-229">Записать подключение в структуре данных подключенных подписок приложения, сохраняя идентификатор подписки.</span><span class="sxs-lookup"><span data-stu-id="45896-229">Record the connection in your applications "connected subscriptions" data structure - persisting the id of the subscription.</span></span>

<span data-ttu-id="45896-230">Давайте рассмотрим первый шаг.</span><span class="sxs-lookup"><span data-stu-id="45896-230">Let's look closer at the first step.</span></span> <span data-ttu-id="45896-231">Чтобы назначить соответствующую роль RBAC удостоверению приложения, необходимо определить следующее:</span><span class="sxs-lookup"><span data-stu-id="45896-231">To assign the appropriate RBAC role to the application's identity, you must determine:</span></span>

* <span data-ttu-id="45896-232">Идентификатор объекта для удостоверения приложения в каталоге Azure Active Directory пользователя.</span><span class="sxs-lookup"><span data-stu-id="45896-232">The object id of your application's identity in the user's Azure Active Directory</span></span>
* <span data-ttu-id="45896-233">Идентификатор роли RBAC, требуемой приложению для подписки.</span><span class="sxs-lookup"><span data-stu-id="45896-233">The identifier of the RBAC role that your application requires on the subscription</span></span>

<span data-ttu-id="45896-234">Когда приложение впервые проверяет подлинность пользователя из Azure AD, в этом экземпляре Azure AD создается объект субъекта-службы для приложения.</span><span class="sxs-lookup"><span data-stu-id="45896-234">When your application authenticates a user from an Azure AD, it creates a service principal object for your application in that Azure AD.</span></span> <span data-ttu-id="45896-235">Azure позволяет назначать роли RBAC субъектам-службам, чтобы предоставить прямой доступ к соответствующим приложениям для ресурсов Azure.</span><span class="sxs-lookup"><span data-stu-id="45896-235">Azure allows RBAC roles to be assigned to service principals to grant direct access to corresponding applications on Azure resources.</span></span> <span data-ttu-id="45896-236">Нам нужно сделать именно это.</span><span class="sxs-lookup"><span data-stu-id="45896-236">This action is exactly what we wish to do.</span></span> <span data-ttu-id="45896-237">Отправьте запрос к API Graph Azure AD, чтобы определить идентификатор объекта субъекта-службы приложения в подключенном экземпляре Azure AD пользователя.</span><span class="sxs-lookup"><span data-stu-id="45896-237">Query the Azure AD Graph API to determine the identifier of the service principal of your application in the signed-in user's Azure AD.</span></span>

<span data-ttu-id="45896-238">У вас есть только маркер доступа для Azure Resource Manager. Поэтому вам понадобится новый маркер доступа для вызова API Graph Azure AD.</span><span class="sxs-lookup"><span data-stu-id="45896-238">You only have an access token for Azure Resource Manager - you need a new access token to call the Azure AD Graph API.</span></span> <span data-ttu-id="45896-239">У каждого приложения в Azure AD есть разрешение на запрос собственного объекта субъекта-службы. Поэтому нам достаточно маркера доступа только для приложений.</span><span class="sxs-lookup"><span data-stu-id="45896-239">Every application in Azure AD has permission to query its own service principal object, so an app-only access token is sufficient.</span></span>

<a id="app-azure-ad-graph" />

### <a name="get-app-only-access-token-for-azure-ad-graph-api"></a><span data-ttu-id="45896-240">Получение маркера доступа только для приложений для API Graph Azure AD</span><span class="sxs-lookup"><span data-stu-id="45896-240">Get app-only access token for Azure AD Graph API</span></span>
<span data-ttu-id="45896-241">Чтобы аутентифицировать приложение и получить маркер для API Graph Azure AD, выполните запрос маркера для предоставления учетных данных клиента OAuth 2.0 к конечной точке токена Azure AD (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span><span class="sxs-lookup"><span data-stu-id="45896-241">To authenticate your app and get a token to Azure AD Graph API, issue a Client Credential Grant OAuth2.0 flow token request to Azure AD token endpoint (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span></span>

<span data-ttu-id="45896-242">Метод [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) примера приложения ASP.NET MVC получает маркер доступа только для приложений для API Graph с использованием библиотеки проверки подлинности Active Directory для .NET.</span><span class="sxs-lookup"><span data-stu-id="45896-242">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) method of the ASP.net MVC sample application gets an app-only access token for Graph API using the Active Directory Authentication Library for .NET.</span></span>

<span data-ttu-id="45896-243">Параметры строки запроса, доступные для этого запроса, описаны в разделе [Запрос маркера доступа](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token).</span><span class="sxs-lookup"><span data-stu-id="45896-243">The query string parameters that are available for this request are described in the [Request an Access Token](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) topic.</span></span>

<span data-ttu-id="45896-244">Пример запроса на токен предоставления учетных данных клиента:</span><span class="sxs-lookup"><span data-stu-id="45896-244">An example request for client credential grant token:</span></span>

    POST https://login.microsoftonline.com/62e173e9-301e-423e-bcd4-29121ec1aa24/oauth2/token HTTP/1.1
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 187</pre>
    <pre>grant_type=client_credentials&client_id=a0448380-c346-4f9f-b897-c18733de9394&resource=https%3A%2F%2Fgraph.windows.net%2F &client_secret=olna8C*****Og%3D

<span data-ttu-id="45896-245">Пример ответа токена предоставления учетных данных клиента:</span><span class="sxs-lookup"><span data-stu-id="45896-245">An example response for client credential grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039862","not_before":"1432035962","resource":"https://graph.windows.net/","access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSIsImtpZCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRv****G5gUTV-kKorR-pg"}

### <a name="get-objectid-of-application-service-principal-in-user-azure-ad"></a><span data-ttu-id="45896-246">Получение идентификатора объекта субъекта-службы приложения в Azure AD пользователя</span><span class="sxs-lookup"><span data-stu-id="45896-246">Get ObjectId of application service principal in user Azure AD</span></span>
<span data-ttu-id="45896-247">Теперь используйте маркер доступа только для приложений для запроса API [субъектов-служб Azure AD Graph](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) , чтобы определить идентификатор объекта субъекта-службы приложения в каталоге.</span><span class="sxs-lookup"><span data-stu-id="45896-247">Now, use the app-only access token to query the [Azure AD Graph Service Principals](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API to determine the Object Id of the application's service principal in the directory.</span></span>

<span data-ttu-id="45896-248">Этот вызов осуществляет метод [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) примера приложения ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="45896-248">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) method of the ASP.net MVC sample application implements this call.</span></span>

<span data-ttu-id="45896-249">В следующем примере показано, как запросить субъект-службу приложения.</span><span class="sxs-lookup"><span data-stu-id="45896-249">The following example shows how to request an application's service principal.</span></span> <span data-ttu-id="45896-250">a0448380-c346-4f9f-b897-c18733de9394 — это идентификатор клиента приложения.</span><span class="sxs-lookup"><span data-stu-id="45896-250">a0448380-c346-4f9f-b897-c18733de9394 is the client id of the application.</span></span>

    GET https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/servicePrincipals?api-version=1.5&$filter=appId%20eq%20'a0448380-c346-4f9f-b897-c18733de9394' HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJK*****-kKorR-pg

<span data-ttu-id="45896-251">В следующем примере показан ответ на запрос субъекта-службы приложения.</span><span class="sxs-lookup"><span data-stu-id="45896-251">The following example shows a response to the request for an application's service principal</span></span>

    HTTP/1.1 200 OK

    {"odata.metadata":"https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/$metadata#directoryObjects/Microsoft.DirectoryServices.ServicePrincipal","value":[{"odata.type":"Microsoft.DirectoryServices.ServicePrincipal","objectType":"ServicePrincipal","objectId":"9b5018d4-6951-42ed-8a92-f11ec283ccec","deletionTimestamp":null,"accountEnabled":true,"appDisplayName":"CloudSense","appId":"a0448380-c346-4f9f-b897-c18733de9394","appOwnerTenantId":"62e173e9-301e-423e-bcd4-29121ec1aa24","appRoleAssignmentRequired":false,"appRoles":[],"displayName":"CloudSense","errorUrl":null,"homepage":"http://www.vipswapper.com/cloudsense","keyCredentials":[],"logoutUrl":null,"oauth2Permissions":[{"adminConsentDescription":"Allow the application to access CloudSense on behalf of the signed-in user.","adminConsentDisplayName":"Access CloudSense","id":"b7b7338e-683a-4796-b95e-60c10380de1c","isEnabled":true,"type":"User","userConsentDescription":"Allow the application to access CloudSense on your behalf.","userConsentDisplayName":"Access CloudSense","value":"user_impersonation"}],"passwordCredentials":[],"preferredTokenSigningKeyThumbprint":null,"publisherName":"vipswapper"quot;,"replyUrls":["http://www.vipswapper.com/cloudsense","http://www.vipswapper.com","http://vipswapper.com","http://vipswapper.azurewebsites.net","http://localhost:62080"],"samlMetadataUrl":null,"servicePrincipalNames":["http://www.vipswapper.com/cloudsense","a0448380-c346-4f9f-b897-c18733de9394"],"tags":["WindowsAzureActiveDirectoryIntegratedApp"]}]}

### <a name="get-azure-rbac-role-identifier"></a><span data-ttu-id="45896-252">Получение идентификатора роли RBAC Azure</span><span class="sxs-lookup"><span data-stu-id="45896-252">Get Azure RBAC role identifier</span></span>
<span data-ttu-id="45896-253">Чтобы назначить соответствующую роль RBAC для субъекта-службы, необходимо определить идентификатор роли RBAC Azure.</span><span class="sxs-lookup"><span data-stu-id="45896-253">To assign the appropriate RBAC role to your service principal, you must determine the identifier of the Azure RBAC role.</span></span>

<span data-ttu-id="45896-254">Выбор роли RBAC для приложения:</span><span class="sxs-lookup"><span data-stu-id="45896-254">The right RBAC role for your application:</span></span>

* <span data-ttu-id="45896-255">Если приложение только выполняет мониторинг подписки и не вносит никаких изменений, ему требуются разрешения только на чтение для подписки.</span><span class="sxs-lookup"><span data-stu-id="45896-255">If your application only monitors the subscription, without making any changes, it requires only reader permissions on the subscription.</span></span> <span data-ttu-id="45896-256">Назначьте роль **Читатель** .</span><span class="sxs-lookup"><span data-stu-id="45896-256">Assign the **Reader** role.</span></span>
* <span data-ttu-id="45896-257">Если приложение управляет подпиской Azure, а также создает, изменяет или удаляет сущности, ему понадобится разрешение участника.</span><span class="sxs-lookup"><span data-stu-id="45896-257">If your application manages Azure the subscription, creating/modifying/deleting entities, it requires one of the contributor permissions.</span></span>
  * <span data-ttu-id="45896-258">Для управления определенным типом ресурсов назначьте роли участников для конкретных ресурсов (участник виртуальных машин, участник виртуальных сетей, участник учетных записей хранения и т. д.).</span><span class="sxs-lookup"><span data-stu-id="45896-258">To manage a particular type of resource, assign the resource-specific contributor roles (Virtual Machine Contributor, Virtual Network Contributor, Storage Account Contributor, etc.)</span></span>
  * <span data-ttu-id="45896-259">Для управления ресурсами любого типа назначьте роль **Участник** .</span><span class="sxs-lookup"><span data-stu-id="45896-259">To manage any resource type, assign the **Contributor** role.</span></span>

<span data-ttu-id="45896-260">Роль, назначенная для приложения, видна пользователям, поэтому выбирайте наименее востребованные привилегии.</span><span class="sxs-lookup"><span data-stu-id="45896-260">The role assignment for your application is visible to users, so select the least-required privilege.</span></span>

<span data-ttu-id="45896-261">Вызовите [API определения ролей Resource Manager](https://docs.microsoft.com/rest/api/authorization/roledefinitions), чтобы получить список всех ролей RBAC Azure и перебрать результаты. Это нужно, чтобы найти определение требуемой роли по имени.</span><span class="sxs-lookup"><span data-stu-id="45896-261">Call the [Resource Manager role definition API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) to list all Azure RBAC roles and search then iterate over the result to find the desired role definition by name.</span></span>

<span data-ttu-id="45896-262">Этот вызов осуществляет метод [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) примера приложения ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="45896-262">The [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="45896-263">В следующем примере запроса показано, как получить идентификатор роли RBAC Azure.</span><span class="sxs-lookup"><span data-stu-id="45896-263">The following request example shows how to get Azure RBAC role identifier.</span></span> <span data-ttu-id="45896-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb — это идентификатор подписки.</span><span class="sxs-lookup"><span data-stu-id="45896-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV*****fY2lGc5

<span data-ttu-id="45896-265">Запрос имеет следующий формат:</span><span class="sxs-lookup"><span data-stu-id="45896-265">The response is in the following format:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"properties":{"roleName":"API Management Service Contributor","type":"BuiltInRole","description":"Lets you manage API Management services, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.ApiManagement/Services/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/312a565d-c81f-4fd8-895a-4e21e48d571c","type":"Microsoft.Authorization/roleDefinitions","name":"312a565d-c81f-4fd8-895a-4e21e48d571c"},{"properties":{"roleName":"Application Insights Component Contributor","type":"BuiltInRole","description":"Lets you manage Application Insights components, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.Insights/components/*","Microsoft.Insights/webtests/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/ae349356-3a1b-4a5e-921d-050484c6347e","type":"Microsoft.Authorization/roleDefinitions","name":"ae349356-3a1b-4a5e-921d-050484c6347e"}]}

<span data-ttu-id="45896-266">Этот API не нужно вызывать постоянно.</span><span class="sxs-lookup"><span data-stu-id="45896-266">You do not need to call this API on an ongoing basis.</span></span> <span data-ttu-id="45896-267">Определив известный GUID определения роли, можно создать идентификатор определения роли следующего вида:</span><span class="sxs-lookup"><span data-stu-id="45896-267">Once you've determined the well-known GUID of the role definition, you can construct the role definition id as:</span></span>

    /subscriptions/{subscription_id}/providers/Microsoft.Authorization/roleDefinitions/{well-known-role-guid}

<span data-ttu-id="45896-268">Ниже представлены известные идентификаторы GUID часто используемых встроенных ролей:</span><span class="sxs-lookup"><span data-stu-id="45896-268">Here are the well-known guids of commonly used built-in roles:</span></span>

| <span data-ttu-id="45896-269">Роль</span><span class="sxs-lookup"><span data-stu-id="45896-269">Role</span></span> | <span data-ttu-id="45896-270">Guid</span><span class="sxs-lookup"><span data-stu-id="45896-270">Guid</span></span> |
| --- | --- |
| <span data-ttu-id="45896-271">Читатель</span><span class="sxs-lookup"><span data-stu-id="45896-271">Reader</span></span> |<span data-ttu-id="45896-272">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="45896-272">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |
| <span data-ttu-id="45896-273">Участник</span><span class="sxs-lookup"><span data-stu-id="45896-273">Contributor</span></span> |<span data-ttu-id="45896-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span><span class="sxs-lookup"><span data-stu-id="45896-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span></span> |
| <span data-ttu-id="45896-275">Участник виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="45896-275">Virtual Machine Contributor</span></span> |<span data-ttu-id="45896-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span><span class="sxs-lookup"><span data-stu-id="45896-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span></span> |
| <span data-ttu-id="45896-277">Участник виртуальной сети</span><span class="sxs-lookup"><span data-stu-id="45896-277">Virtual Network Contributor</span></span> |<span data-ttu-id="45896-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span><span class="sxs-lookup"><span data-stu-id="45896-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span></span> |
| <span data-ttu-id="45896-279">Участник учетной записи хранения</span><span class="sxs-lookup"><span data-stu-id="45896-279">Storage Account Contributor</span></span> |<span data-ttu-id="45896-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span><span class="sxs-lookup"><span data-stu-id="45896-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span></span> |
| <span data-ttu-id="45896-281">Участник веб-сайта</span><span class="sxs-lookup"><span data-stu-id="45896-281">Website Contributor</span></span> |<span data-ttu-id="45896-282">de139f84-1756-47ae-9be6-808fbbe84772</span><span class="sxs-lookup"><span data-stu-id="45896-282">de139f84-1756-47ae-9be6-808fbbe84772</span></span> |
| <span data-ttu-id="45896-283">Участник веб-плана</span><span class="sxs-lookup"><span data-stu-id="45896-283">Web Plan Contributor</span></span> |<span data-ttu-id="45896-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span><span class="sxs-lookup"><span data-stu-id="45896-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span></span> |
| <span data-ttu-id="45896-285">Участник SQL Server</span><span class="sxs-lookup"><span data-stu-id="45896-285">SQL Server Contributor</span></span> |<span data-ttu-id="45896-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span><span class="sxs-lookup"><span data-stu-id="45896-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span></span> |
| <span data-ttu-id="45896-287">Участник БД SQL</span><span class="sxs-lookup"><span data-stu-id="45896-287">SQL DB Contributor</span></span> |<span data-ttu-id="45896-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span><span class="sxs-lookup"><span data-stu-id="45896-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span></span> |

### <a name="assign-rbac-role-to-application"></a><span data-ttu-id="45896-289">Назначение роли RBAC для приложения</span><span class="sxs-lookup"><span data-stu-id="45896-289">Assign RBAC role to application</span></span>
<span data-ttu-id="45896-290">Теперь все готово, чтобы назначить соответствующую роль RBAC субъекту-службе с помощью API [создания назначения роли Resource Manager](https://docs.microsoft.com/rest/api/authorization/roleassignments) .</span><span class="sxs-lookup"><span data-stu-id="45896-290">You have everything you need to assign the appropriate RBAC role to your service principal by using the [Resource Manager create role assignment](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span></span>

<span data-ttu-id="45896-291">Этот вызов осуществляет метод [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) примера приложения ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="45896-291">The [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="45896-292">Пример запроса на назначение роли RBAC для приложения:</span><span class="sxs-lookup"><span data-stu-id="45896-292">An example request to assign RBAC role to application:</span></span>

    PUT https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/microsoft.authorization/roleassignments/4f87261d-2816-465d-8311-70a27558df4c?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiL*****FlwO1mM7Cw6JWtfY2lGc5
    Content-Type: application/json
    Content-Length: 230

    {"properties": {"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2"}}

<span data-ttu-id="45896-293">В запросе используются следующие значения:</span><span class="sxs-lookup"><span data-stu-id="45896-293">In the request, the following values are used:</span></span>

| <span data-ttu-id="45896-294">Guid</span><span class="sxs-lookup"><span data-stu-id="45896-294">Guid</span></span> | <span data-ttu-id="45896-295">Описание</span><span class="sxs-lookup"><span data-stu-id="45896-295">Description</span></span> |
| --- | --- |
| <span data-ttu-id="45896-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span><span class="sxs-lookup"><span data-stu-id="45896-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span></span> |<span data-ttu-id="45896-297">Идентификатор подписки</span><span class="sxs-lookup"><span data-stu-id="45896-297">the id of the subscription</span></span> |
| <span data-ttu-id="45896-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span><span class="sxs-lookup"><span data-stu-id="45896-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span></span> |<span data-ttu-id="45896-299">Идентификатор объекта субъекта-службы приложения</span><span class="sxs-lookup"><span data-stu-id="45896-299">the object id of the service principal of the application</span></span> |
| <span data-ttu-id="45896-300">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="45896-300">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |<span data-ttu-id="45896-301">Идентификатор роли "Читатель"</span><span class="sxs-lookup"><span data-stu-id="45896-301">the id of the reader role</span></span> |
| <span data-ttu-id="45896-302">4f87261d-2816-465d-8311-70a27558df4c</span><span class="sxs-lookup"><span data-stu-id="45896-302">4f87261d-2816-465d-8311-70a27558df4c</span></span> |<span data-ttu-id="45896-303">Новый GUID, созданный для нового назначения роли</span><span class="sxs-lookup"><span data-stu-id="45896-303">a new guid created for the new role assignment</span></span> |

<span data-ttu-id="45896-304">Запрос имеет следующий формат:</span><span class="sxs-lookup"><span data-stu-id="45896-304">The response is in the following format:</span></span>

    HTTP/1.1 201 Created

    {"properties":{"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2","scope":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb"},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleAssignments/4f87261d-2816-465d-8311-70a27558df4c","type":"Microsoft.Authorization/roleAssignments","name":"4f87261d-2816-465d-8311-70a27558df4c"}

### <a name="get-app-only-access-token-for-azure-resource-manager"></a><span data-ttu-id="45896-305">Получение маркера доступа только для приложений для Azure Resource Manager</span><span class="sxs-lookup"><span data-stu-id="45896-305">Get app-only access token for Azure Resource Manager</span></span>
<span data-ttu-id="45896-306">Чтобы проверить, есть ли у приложения требуемый доступ для подписки, выполните тестовое задание для подписки, используя маркер только для приложений.</span><span class="sxs-lookup"><span data-stu-id="45896-306">To validate that app has the desired access on the subscription, perform a test task on the subscription using an app-only token.</span></span>

<span data-ttu-id="45896-307">Маркер доступа только для приложений можно получить, следуя инструкциям в разделе [Получение маркера доступа только для приложений для API Graph Azure AD](#app-azure-ad-graph). Но используйте другое значение для параметра ресурсов.</span><span class="sxs-lookup"><span data-stu-id="45896-307">To get an app-only access token, follow instructions from section [Get app-only access token for Azure AD Graph API](#app-azure-ad-graph), with a different value for the resource parameter:</span></span>

    https://management.core.windows.net/

<span data-ttu-id="45896-308">Метод [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) примера приложения ASP.NET MVC получает маркер доступа только для приложений для Azure Resource Manager с использованием библиотеки проверки подлинности Active Directory для .NET.</span><span class="sxs-lookup"><span data-stu-id="45896-308">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample application gets an app-only access token for Azure Resource Manager using the Active Directory Authentication Library for .net.</span></span>

#### <a name="get-applications-permissions-on-subscription"></a><span data-ttu-id="45896-309">Получение разрешений приложения для подписки</span><span class="sxs-lookup"><span data-stu-id="45896-309">Get Application's Permissions on Subscription</span></span>
<span data-ttu-id="45896-310">Чтобы проверить, есть ли у приложения необходимый доступ к подписке Azure, можно также вызвать API [разрешений Resource Manager](https://docs.microsoft.com/rest/api/authorization/permissions).</span><span class="sxs-lookup"><span data-stu-id="45896-310">To check that your application has the desired access on an Azure subscription, you may also call the [Resource Manager Permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span></span> <span data-ttu-id="45896-311">Этот метод аналогичен методу определения наличия у пользователя права на управление доступом для подписки.</span><span class="sxs-lookup"><span data-stu-id="45896-311">This approach is similar to how you determined whether the user has Access Management rights for the subscription.</span></span> <span data-ttu-id="45896-312">Однако на этот раз вызовите API разрешений с помощью маркера доступа только для приложений, полученного на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="45896-312">However, this time, call the permissions API with the app-only access token that you received in the previous step.</span></span>

<span data-ttu-id="45896-313">Этот вызов осуществляет метод [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) примера приложения ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="45896-313">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample app implements this call.</span></span>

## <a name="manage-connected-subscriptions"></a><span data-ttu-id="45896-314">Управление подключенными подписками</span><span class="sxs-lookup"><span data-stu-id="45896-314">Manage connected subscriptions</span></span>
<span data-ttu-id="45896-315">После назначения соответствующей роли RBAC субъекту-службе приложения для подписки приложение может и дальше выполнять мониторинг и управление с помощью маркеров доступа только для приложений для Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="45896-315">When the appropriate RBAC role is assigned to your application's service principal on the subscription, your application can keep monitoring/managing it using app-only access tokens for Azure Resource Manager.</span></span>

<span data-ttu-id="45896-316">Если владелец подписки удаляет назначение роли приложения, используя классический портал или программы командной строки, приложение больше не сможет получить доступ к этой подписке.</span><span class="sxs-lookup"><span data-stu-id="45896-316">If a subscription owner removes your application's role assignment using the classic portal or command-line tools, your application is no longer able to access that subscription.</span></span> <span data-ttu-id="45896-317">В этом случае следует уведомить пользователей, что подключение к подписке прервано вне приложения, и предоставить им возможность восстановить его.</span><span class="sxs-lookup"><span data-stu-id="45896-317">In that case, you should notify the user that the connection with the subscription was severed from outside the application and give them an option to "repair" the connection.</span></span> <span data-ttu-id="45896-318">При восстановлении назначение роли, удаленное в автономном режиме, будет создано заново.</span><span class="sxs-lookup"><span data-stu-id="45896-318">"Repair" would simply re-create the role assignment that was deleted offline.</span></span>

<span data-ttu-id="45896-319">Помимо предоставления возможности подключения подписок к вашему приложению, пользователю также необходимо разрешить отключать подписки.</span><span class="sxs-lookup"><span data-stu-id="45896-319">Just as you enabled the user to connect subscriptions to your application, you must allow the user to disconnect subscriptions too.</span></span> <span data-ttu-id="45896-320">С точки зрения управления доступом при отключении удаляется назначение роли субъекта-службы приложения для подписки.</span><span class="sxs-lookup"><span data-stu-id="45896-320">From an access management point of view, disconnect means removing the role assignment that the application's service principal has on the subscription.</span></span> <span data-ttu-id="45896-321">Кроме того, любое состояние в приложении для подписки может быть удалено.</span><span class="sxs-lookup"><span data-stu-id="45896-321">Optionally, any state in the application for the subscription might be removed too.</span></span>
<span data-ttu-id="45896-322">Отключить подписку могут только пользователи с разрешением на управление доступом для этой подписки.</span><span class="sxs-lookup"><span data-stu-id="45896-322">Only users with access management permission on the subscription are able to disconnect the subscription.</span></span>

<span data-ttu-id="45896-323">Этот вызов осуществляет метод [RevokeRoleFromServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) примера приложения ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="45896-323">The [RevokeRoleFromServicePrincipalOnSubscription method](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="45896-324">Теперь пользователи могут легко подключать подписки Azure к приложениям и управлять ими с помощью этих подписок.</span><span class="sxs-lookup"><span data-stu-id="45896-324">That's it - users can now easily connect and manage their Azure subscriptions with your application.</span></span>

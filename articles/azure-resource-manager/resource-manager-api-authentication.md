---
title: "aaaAzure Active Directory проверки подлинности и диспетчер ресурсов | Документы Microsoft"
description: "Для разработчиков руководство по tooauthentication hello API диспетчера ресурсов Azure и Azure Active Directory для интеграции приложения с помощью подписок Azure."
services: azure-resource-manager,active-directory
documentationcenter: na
author: dushyantgill
manager: timlt
editor: tysonn
ms.assetid: 17b2b40d-bf42-4c7d-9a88-9938409c5088
ms.service: azure-resource-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/27/2016
ms.author: dugill;tomfitz
ms.openlocfilehash: 757e45fdb28488b45de70647746461888bf35a56
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="use-resource-manager-authentication-api-tooaccess-subscriptions"></a><span data-ttu-id="730bc-103">Использовать подписки tooaccess проверки подлинности API диспетчера ресурсов</span><span class="sxs-lookup"><span data-stu-id="730bc-103">Use Resource Manager authentication API tooaccess subscriptions</span></span>
## <a name="introduction"></a><span data-ttu-id="730bc-104">Введение</span><span class="sxs-lookup"><span data-stu-id="730bc-104">Introduction</span></span>
<span data-ttu-id="730bc-105">Если разработчик программного обеспечения, которому нужен toocreate приложение, которое управляет ресурсами Azure клиента, в этом разделе показано, как tooauthenticate с hello API диспетчера ресурсов Azure и получать tooresources доступ в другие подписки.</span><span class="sxs-lookup"><span data-stu-id="730bc-105">If you are a software developer who needs toocreate an app that manages customer's Azure resources, this topic shows you how tooauthenticate with hello Azure Resource Manager APIs and gain access tooresources in other subscriptions.</span></span>

<span data-ttu-id="730bc-106">Приложения могут обращаться к hello API диспетчера ресурсов в двумя способами:</span><span class="sxs-lookup"><span data-stu-id="730bc-106">Your app can access hello Resource Manager APIs in couple of ways:</span></span>

1. <span data-ttu-id="730bc-107">**Доступ от имени пользователя.**Используйте этот метод для приложений, осуществляющих доступ к ресурсам от имени выполнившего вход пользователя.</span><span class="sxs-lookup"><span data-stu-id="730bc-107">**User + app access**: for apps that access resources on behalf of a signed-in user.</span></span> <span data-ttu-id="730bc-108">Этот метод подходит для приложений, например веб-приложений и программ командной строки, которые осуществляют только интерактивное управление ресурсами Azure.</span><span class="sxs-lookup"><span data-stu-id="730bc-108">This approach works for apps, such as web apps and command-line tools, that deal with only "interactive management" of Azure resources.</span></span>
2. <span data-ttu-id="730bc-109">**Доступ только для приложений.**Используйте этот метод для приложений, на которых запущены службы управляющих программ и запланированные задания.</span><span class="sxs-lookup"><span data-stu-id="730bc-109">**App-only access**: for apps that run daemon services and scheduled jobs.</span></span> <span data-ttu-id="730bc-110">удостоверение приложения Hello предоставляется toohello прямой доступ к ресурсам.</span><span class="sxs-lookup"><span data-stu-id="730bc-110">hello app's identity is granted direct access toohello resources.</span></span> <span data-ttu-id="730bc-111">Этот способ подходит для приложений, которым необходим долгосрочной tooAzure автономного доступа (автоматический режим).</span><span class="sxs-lookup"><span data-stu-id="730bc-111">This approach works for apps that need long-term headless (unattended) access tooAzure.</span></span>

<span data-ttu-id="730bc-112">Этот раздел содержит пошаговые инструкции toocreate приложение, которое использует оба эти метода авторизации.</span><span class="sxs-lookup"><span data-stu-id="730bc-112">This topic provides step-by-step instructions toocreate an app that employs both these authorization methods.</span></span> <span data-ttu-id="730bc-113">В нем показано, как tooperform каждый шаг с помощью API-интерфейса REST или C#.</span><span class="sxs-lookup"><span data-stu-id="730bc-113">It shows how tooperform each step with REST API or C#.</span></span> <span data-ttu-id="730bc-114">Hello приложения ASP.NET MVC доступна на [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span><span class="sxs-lookup"><span data-stu-id="730bc-114">hello complete ASP.NET MVC application is available at [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span></span>

## <a name="what-hello-web-app-does"></a><span data-ttu-id="730bc-115">Какое приложение hello web не</span><span class="sxs-lookup"><span data-stu-id="730bc-115">What hello web app does</span></span>
<span data-ttu-id="730bc-116">Hello веб-приложения:</span><span class="sxs-lookup"><span data-stu-id="730bc-116">hello web app:</span></span>

1. <span data-ttu-id="730bc-117">Вход пользователя Azure в систему.</span><span class="sxs-lookup"><span data-stu-id="730bc-117">Signs-in an Azure user.</span></span>
2. <span data-ttu-id="730bc-118">Запрашивает доступ пользователя toogrant hello web app tooResource диспетчера.</span><span class="sxs-lookup"><span data-stu-id="730bc-118">Asks user toogrant hello web app access tooResource Manager.</span></span>
3. <span data-ttu-id="730bc-119">Получение маркера доступа от имени пользователя для доступа к Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="730bc-119">Gets user + app access token for accessing Resource Manager.</span></span>
4. <span data-ttu-id="730bc-120">Использует toocall токена (из шага 3) диспетчера ресурсов и роль участника tooa приложение hello назначение службы в hello подписки, которая предоставляет подписки toohello долгосрочной доступа приложения hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-120">Uses token (from step 3) toocall Resource Manager and assign hello app's service principal tooa role in hello subscription, which gives hello app long-term access toohello subscription.</span></span>
5. <span data-ttu-id="730bc-121">Получение маркера доступа только для приложений.</span><span class="sxs-lookup"><span data-stu-id="730bc-121">Gets app-only access token.</span></span>
6. <span data-ttu-id="730bc-122">Использует ресурсы toomanage токена (из шага 5) в подписке hello через диспетчер ресурсов.</span><span class="sxs-lookup"><span data-stu-id="730bc-122">Uses token (from step 5) toomanage resources in hello subscription through Resource Manager.</span></span>

<span data-ttu-id="730bc-123">Ниже приведена последовательность конца в конец hello hello веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="730bc-123">Here's hello end-to-end flow of hello web application.</span></span>

![Поток проверки подлинности Resource Manager](./media/resource-manager-api-authentication/Auth-Swim-Lane.png)

<span data-ttu-id="730bc-125">Как пользователь, укажите идентификатор подписки hello hello подписки нужно toouse:</span><span class="sxs-lookup"><span data-stu-id="730bc-125">As a user, you provide hello subscription id for hello subscription you want toouse:</span></span>

![предоставление идентификатора подписки](./media/resource-manager-api-authentication/sample-ux-1.png)

<span data-ttu-id="730bc-127">Выберите toouse hello учетной записи для входа.</span><span class="sxs-lookup"><span data-stu-id="730bc-127">Select hello account toouse for logging in.</span></span>

![выбор учетной записи](./media/resource-manager-api-authentication/sample-ux-2.png)

<span data-ttu-id="730bc-129">Укажите свои учетные данные.</span><span class="sxs-lookup"><span data-stu-id="730bc-129">Provide your credentials.</span></span>

![предоставление учетных данных](./media/resource-manager-api-authentication/sample-ux-3.png)

<span data-ttu-id="730bc-131">Предоставьте tooyour доступ приложения hello подписок Azure:</span><span class="sxs-lookup"><span data-stu-id="730bc-131">Grant hello app access tooyour Azure subscriptions:</span></span>

![Предоставление доступа](./media/resource-manager-api-authentication/sample-ux-4.png)

<span data-ttu-id="730bc-133">Управляйте своими подключенными подписками.</span><span class="sxs-lookup"><span data-stu-id="730bc-133">Manage your connected subscriptions:</span></span>

![Подключение подписки](./media/resource-manager-api-authentication/sample-ux-7.png)

## <a name="register-application"></a><span data-ttu-id="730bc-135">Регистрация приложения</span><span class="sxs-lookup"><span data-stu-id="730bc-135">Register application</span></span>
<span data-ttu-id="730bc-136">Прежде чем приступить к программированию, сначала нужно зарегистрировать веб-приложение в Azure Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="730bc-136">Before you start coding, register your web app with Azure Active Directory (AD).</span></span> <span data-ttu-id="730bc-137">Регистрация приложения Hello создает центра удостоверение для приложения в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="730bc-137">hello app registration creates a central identity for your app in Azure AD.</span></span> <span data-ttu-id="730bc-138">Она содержит основные сведения о приложении, такие как идентификатор клиента OAuth, URL-адреса ответа и учетные данные, приложение использует tooauthenticate и доступа к API диспетчера ресурсов Azure.</span><span class="sxs-lookup"><span data-stu-id="730bc-138">It holds basic information about your application like OAuth Client ID, Reply URLs, and credentials that your application uses tooauthenticate and access Azure Resource Manager APIs.</span></span> <span data-ttu-id="730bc-139">Регистрация приложения Hello также записывает hello, различными делегированы разрешения, необходимые приложению при доступе к API-интерфейсы Microsoft от имени пользователя hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-139">hello app registration also records hello various delegated permissions that your application needs when accessing Microsoft APIs on behalf of hello user.</span></span>

<span data-ttu-id="730bc-140">Так как приложение получает доступ к другой подписке, его необходимо настроить как мультитенантное.</span><span class="sxs-lookup"><span data-stu-id="730bc-140">Because your app accesses other subscription, you must configure it as a multi-tenant application.</span></span> <span data-ttu-id="730bc-141">Проверка toopass, укажите домен, связанный с Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="730bc-141">toopass validation, provide a domain associated with your Azure Active Directory.</span></span> <span data-ttu-id="730bc-142">toosee hello домены, связанные с Azure Active Directory, вход toohello [классический портал](https://manage.windowsazure.com).</span><span class="sxs-lookup"><span data-stu-id="730bc-142">toosee hello domains associated with your Azure Active Directory, log in toohello [classic portal](https://manage.windowsazure.com).</span></span> <span data-ttu-id="730bc-143">Выберите свою службу Azure Active Directory и щелкните **Домены**.</span><span class="sxs-lookup"><span data-stu-id="730bc-143">Select your Azure Active Directory and then select **Domains**.</span></span>

<span data-ttu-id="730bc-144">Привет, в следующем примере показано, как tooregister hello приложения с помощью Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="730bc-144">hello following example shows how tooregister hello app by using Azure PowerShell.</span></span> <span data-ttu-id="730bc-145">Необходимо иметь hello последнюю версию (августа 2016 г.) Azure PowerShell для этой команды toowork.</span><span class="sxs-lookup"><span data-stu-id="730bc-145">You must have hello latest version (August 2016) of Azure PowerShell for this command toowork.</span></span>

    $app = New-AzureRmADApplication -DisplayName "{app name}" -HomePage "https://{your domain}/{app name}" -IdentifierUris "https://{your domain}/{app name}" -Password "{your password}" -AvailableToOtherTenants $true

<span data-ttu-id="730bc-146">toolog в качестве hello приложения AD, понадобится идентификатор приложения hello и пароль.</span><span class="sxs-lookup"><span data-stu-id="730bc-146">toolog in as hello AD application, you need hello application id and password.</span></span> <span data-ttu-id="730bc-147">toosee код приложения hello, возвращенный предыдущей командой hello, используйте:</span><span class="sxs-lookup"><span data-stu-id="730bc-147">toosee hello application id that is returned from hello previous command, use:</span></span>

    $app.ApplicationId

<span data-ttu-id="730bc-148">Привет, в следующем примере показано, как tooregister hello приложения с помощью Azure CLI.</span><span class="sxs-lookup"><span data-stu-id="730bc-148">hello following example shows how tooregister hello app by using Azure CLI.</span></span>

    azure ad app create --name {app name} --home-page https://{your domain}/{app name} --identifier-uris https://{your domain}/{app name} --password {your password} --available true

<span data-ttu-id="730bc-149">Hello результатов включать hello AppId, который требуется при проверке подлинности, как приложение hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-149">hello results include hello AppId, which you need when authenticating as hello application.</span></span>

### <a name="optional-configuration---certificate-credential"></a><span data-ttu-id="730bc-150">Дополнительная настройка. Учетные данные сертификата</span><span class="sxs-lookup"><span data-stu-id="730bc-150">Optional configuration - certificate credential</span></span>
<span data-ttu-id="730bc-151">Azure AD также поддерживает учетные данные сертификата для приложений: создать самозаверяющий сертификат, hello закрытый ключ должен оставаться и добавить регистрацию приложения hello открытого ключа tooyour Azure AD.</span><span class="sxs-lookup"><span data-stu-id="730bc-151">Azure AD also supports certificate credentials for applications: you create a self-signed cert, keep hello private key, and add hello public key tooyour Azure AD application registration.</span></span> <span data-ttu-id="730bc-152">Для проверки подлинности приложение отправляет tooAzure небольшой полезных данных, AD, подписывается с помощью закрытого ключа и Azure AD проверяет подпись hello, с помощью открытого ключа hello, которое вы зарегистрировали.</span><span class="sxs-lookup"><span data-stu-id="730bc-152">For authentication, your application sends a small payload tooAzure AD signed using your private key, and Azure AD validates hello signature using hello public key that you registered.</span></span>

<span data-ttu-id="730bc-153">Сведения о создании приложения AD с помощью сертификата см. в разделе [toocreate использование Azure PowerShell участника службы ресурсы tooaccess](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) или [toocreate использования Azure CLI участника службы ресурсы tooaccess](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span><span class="sxs-lookup"><span data-stu-id="730bc-153">For information about creating an AD app with a certificate, see [Use Azure PowerShell toocreate a service principal tooaccess resources](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) or [Use Azure CLI toocreate a service principal tooaccess resources](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span></span>

## <a name="get-tenant-id-from-subscription-id"></a><span data-ttu-id="730bc-154">Получение идентификатора клиента из идентификатора подписки</span><span class="sxs-lookup"><span data-stu-id="730bc-154">Get tenant id from subscription id</span></span>
<span data-ttu-id="730bc-155">toorequest маркер, который может быть toocall используется диспетчер ресурсов приложению tooknow hello идентификатор клиента hello Azure AD, на котором размещена hello подписки Azure.</span><span class="sxs-lookup"><span data-stu-id="730bc-155">toorequest a token that can be used toocall Resource Manager, your application needs tooknow hello tenant ID of hello Azure AD tenant that hosts hello Azure subscription.</span></span> <span data-ttu-id="730bc-156">Скорее всего, пользователи знают идентификаторы подписок, но идентификаторы клиентов Azure Active Directory знает не каждый.</span><span class="sxs-lookup"><span data-stu-id="730bc-156">Most likely, your users know their subscription ids, but they might not know their tenant ids for Azure Active Directory.</span></span> <span data-ttu-id="730bc-157">tooget hello идентификатор клиента пользователя, попросите пользователя hello для подписки с идентификатором hello. Укажите, идентификатор подписки, при отправке запроса о подписке hello:</span><span class="sxs-lookup"><span data-stu-id="730bc-157">tooget hello user's tenant id, ask hello user for hello subscription id. Provide that subscription id when sending a request about hello subscription:</span></span>

    https://management.azure.com/subscriptions/{subscription-id}?api-version=2015-01-01

<span data-ttu-id="730bc-158">Hello запроса происходит сбой, так как hello пользователь не вошел еще, hello идентификатор клиента можно получить из ответа hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-158">hello request fails because hello user has not logged in yet, but you can retrieve hello tenant id from hello response.</span></span> <span data-ttu-id="730bc-159">В это исключение получить идентификатор клиента hello из hello значение заголовка ответа для **WWW-Authenticate**.</span><span class="sxs-lookup"><span data-stu-id="730bc-159">In that exception, retrieve hello tenant id from hello response header value for **WWW-Authenticate**.</span></span> <span data-ttu-id="730bc-160">Вы видите этой реализации hello [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) метод.</span><span class="sxs-lookup"><span data-stu-id="730bc-160">You see this implementation in hello [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) method.</span></span>

## <a name="get-user--app-access-token"></a><span data-ttu-id="730bc-161">Получение маркера доступа от имени пользователя</span><span class="sxs-lookup"><span data-stu-id="730bc-161">Get user + app access token</span></span>
<span data-ttu-id="730bc-162">Приложение перенаправляет пользователя hello tooAzure AD с помощью OAuth 2.0 авторизовать запрос — tooauthenticate hello учетные данные пользователя и вернуть код авторизации.</span><span class="sxs-lookup"><span data-stu-id="730bc-162">Your application redirects hello user tooAzure AD with an OAuth 2.0 Authorize Request - tooauthenticate hello user's credentials and get back an authorization code.</span></span> <span data-ttu-id="730bc-163">Приложение использует tooget код авторизации hello маркер доступа для диспетчера ресурсов.</span><span class="sxs-lookup"><span data-stu-id="730bc-163">Your application uses hello authorization code tooget an access token for Resource Manager.</span></span> <span data-ttu-id="730bc-164">Hello [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) метод создает запрос на авторизацию hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-164">hello [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) method creates hello authorization request.</span></span>

<span data-ttu-id="730bc-165">В этом разделе показано hello REST API запросов tooauthenticate hello пользователя.</span><span class="sxs-lookup"><span data-stu-id="730bc-165">This topic shows hello REST API requests tooauthenticate hello user.</span></span> <span data-ttu-id="730bc-166">Также можно использовать вспомогательные библиотеки tooperform аутентификации в коде.</span><span class="sxs-lookup"><span data-stu-id="730bc-166">You can also use helper libraries tooperform authentication in your code.</span></span> <span data-ttu-id="730bc-167">Дополнительные сведения об этих библиотеках см. в статье [Библиотеки проверки подлинности Azure Active Directory](../active-directory/active-directory-authentication-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="730bc-167">For more information about these libraries, see [Azure Active Directory Authentication Libraries](../active-directory/active-directory-authentication-libraries.md).</span></span> <span data-ttu-id="730bc-168">Рекомендации по интеграции функции управления удостоверениями в приложение см. в статье [Руководство разработчика по Azure Active Directory](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="730bc-168">For guidance on integrating identity management in an application, see [Azure Active Directory developer's guide](../active-directory/active-directory-developers-guide.md).</span></span>

### <a name="auth-request-oauth-20"></a><span data-ttu-id="730bc-169">Запрос проверки подлинности (OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="730bc-169">Auth request (OAuth 2.0)</span></span>
<span data-ttu-id="730bc-170">Выполните открыть подключение и OAuth2.0 авторизации запросов идентификатора конечной точки Authorize toohello Azure AD:</span><span class="sxs-lookup"><span data-stu-id="730bc-170">Issue an Open ID Connect/OAuth2.0 Authorize Request toohello Azure AD Authorize endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize

<span data-ttu-id="730bc-171">Параметры строки запроса Hello, доступные для этого запроса описаны в hello [запрос кода авторизации](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) раздела.</span><span class="sxs-lookup"><span data-stu-id="730bc-171">hello query string parameters that are available for this request are described in hello [request an authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) topic.</span></span>

<span data-ttu-id="730bc-172">Следующий пример показывает как Hello toorequest OAuth2.0 авторизации:</span><span class="sxs-lookup"><span data-stu-id="730bc-172">hello following example shows how toorequest OAuth2.0 authorization:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=query&response_type=code&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&domain_hint=live.com

<span data-ttu-id="730bc-173">Azure AD проверяет подлинность пользователя hello и при необходимости запрашивает приложение hello пользователя toogrant разрешение toohello.</span><span class="sxs-lookup"><span data-stu-id="730bc-173">Azure AD authenticates hello user, and, if necessary, asks hello user toogrant permission toohello app.</span></span> <span data-ttu-id="730bc-174">Он возвращает toohello кода hello авторизации URL-адрес ответа приложения.</span><span class="sxs-lookup"><span data-stu-id="730bc-174">It returns hello authorization code toohello Reply URL of your application.</span></span> <span data-ttu-id="730bc-175">В зависимости от hello response_mode Azure AD, либо отправляет обратно hello данных в строке запроса или как отправленные данные по запросу.</span><span class="sxs-lookup"><span data-stu-id="730bc-175">Depending on hello requested response_mode, Azure AD either sends back hello data in query string or as post data.</span></span>

    code=AAABAAAAiL****FDMZBUwZ8eCAA&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="auth-request-open-id-connect"></a><span data-ttu-id="730bc-176">Запрос проверки подлинности (Open ID Connect)</span><span class="sxs-lookup"><span data-stu-id="730bc-176">Auth request (Open ID Connect)</span></span>
<span data-ttu-id="730bc-177">Если вы не только обратиться tooaccess диспетчера ресурсов Azure от имени пользователя hello, но также позволяют toosign hello пользователя в приложении tooyour, с помощью учетной записи Azure AD, отправить откройте идентификатор подключения авторизовать запрос.</span><span class="sxs-lookup"><span data-stu-id="730bc-177">If you not only wish tooaccess Azure Resource Manager on behalf of hello user, but also allow hello user toosign in tooyour application using their Azure AD account, issue an Open ID Connect Authorize Request.</span></span> <span data-ttu-id="730bc-178">Откройте подключение идентификатор приложения также получают id_token из Azure AD, что приложения могут использовать toosign hello пользователя.</span><span class="sxs-lookup"><span data-stu-id="730bc-178">With Open ID Connect, your application also receives an id_token from Azure AD that your app can use toosign in hello user.</span></span>

<span data-ttu-id="730bc-179">Параметры строки запроса Hello, доступные для этого запроса описаны в hello [запрос входа hello отправки](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) раздела.</span><span class="sxs-lookup"><span data-stu-id="730bc-179">hello query string parameters that are available for this request are described in hello [Send hello sign-in request](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) topic.</span></span>

<span data-ttu-id="730bc-180">Пример запроса Open ID Connect:</span><span class="sxs-lookup"><span data-stu-id="730bc-180">An example Open ID Connect request is:</span></span>

     https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=form_post&response_type=code+id_token&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&scope=openid+profile&nonce=63567Dc4MDAw&domain_hint=live.com&state=M_12tMyKaM8

<span data-ttu-id="730bc-181">Azure AD проверяет подлинность пользователя hello и при необходимости запрашивает приложение hello пользователя toogrant разрешение toohello.</span><span class="sxs-lookup"><span data-stu-id="730bc-181">Azure AD authenticates hello user, and, if necessary, asks hello user toogrant permission toohello app.</span></span> <span data-ttu-id="730bc-182">Он возвращает toohello кода hello авторизации URL-адрес ответа приложения.</span><span class="sxs-lookup"><span data-stu-id="730bc-182">It returns hello authorization code toohello Reply URL of your application.</span></span> <span data-ttu-id="730bc-183">В зависимости от hello response_mode Azure AD, либо отправляет обратно hello данных в строке запроса или как отправленные данные по запросу.</span><span class="sxs-lookup"><span data-stu-id="730bc-183">Depending on hello requested response_mode, Azure AD either sends back hello data in query string or as post data.</span></span>

<span data-ttu-id="730bc-184">Пример ответа Open ID Connect:</span><span class="sxs-lookup"><span data-stu-id="730bc-184">An example Open ID Connect response is:</span></span>

    code=AAABAAAAiL*****I4rDWd7zXsH6WUjlkIEQxIAA&id_token=eyJ0eXAiOiJKV1Q*****T3GrzzSFxg&state=M_12tMyKaM8&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="token-request-oauth20-code-grant-flow"></a><span data-ttu-id="730bc-185">Запрос токена (предоставление кода OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="730bc-185">Token request (OAuth2.0 Code Grant Flow)</span></span>
<span data-ttu-id="730bc-186">Теперь, когда приложение получило hello код авторизации из Azure AD, это маркер доступа hello tooget времени для диспетчера ресурсов Azure.</span><span class="sxs-lookup"><span data-stu-id="730bc-186">Now that your application has received hello authorization code from Azure AD, it is time tooget hello access token for Azure Resource Manager.</span></span>  <span data-ttu-id="730bc-187">Учет маркеров запрос OAuth2.0 кода Grant toohello токена Azure AD конечной точки:</span><span class="sxs-lookup"><span data-stu-id="730bc-187">Post an OAuth2.0 Code Grant Token Request toohello Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="730bc-188">Параметры строки запроса Hello, доступные для этого запроса описаны в hello [используйте код авторизации hello](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) раздела.</span><span class="sxs-lookup"><span data-stu-id="730bc-188">hello query string parameters that are available for this request are described in hello [use hello authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) topic.</span></span>

<span data-ttu-id="730bc-189">Hello в следующем примере показан запрос для маркера предоставление кода с помощью учетных данных пароля.</span><span class="sxs-lookup"><span data-stu-id="730bc-189">hello following example shows a request for code grant token with password credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="730bc-190">При работе с учетными данными сертификата, создайте JSON Web Token (JWT) и знак (RSA-SHA256) с помощью закрытого ключа учетных данных сертификата приложения hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-190">When working with certificate credentials, create a JSON Web Token (JWT) and sign (RSA SHA256) using hello private key of your application's certificate credential.</span></span> <span data-ttu-id="730bc-191">Hello утверждение для маркера hello отображаются типы в [утверждения маркера JWT](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span><span class="sxs-lookup"><span data-stu-id="730bc-191">hello claim types for hello token are shown in [JWT token claims](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span></span> <span data-ttu-id="730bc-192">Справочную информацию см. в разделе hello [кода библиотеки проверки подлинности Active Directory (.NET)](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) toosign маркеры JWT утверждение клиента.</span><span class="sxs-lookup"><span data-stu-id="730bc-192">For reference, see hello [Active Directory Auth Library (.NET) code](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) toosign Client Assertion JWT tokens.</span></span>

<span data-ttu-id="730bc-193">В разделе hello [спецификации Open ID подключения](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) подробные сведения о проверке подлинности клиента.</span><span class="sxs-lookup"><span data-stu-id="730bc-193">See hello [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) for details on client authentication.</span></span>

<span data-ttu-id="730bc-194">Hello в следующем примере показан запрос для кода маркера предоставление учетных данных сертификата.</span><span class="sxs-lookup"><span data-stu-id="730bc-194">hello following example shows a request for code grant token with certificate credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&client_assertion=eyJhbG*****Y9cYo8nEjMyA

<span data-ttu-id="730bc-195">Пример ответа для токена предоставления кода:</span><span class="sxs-lookup"><span data-stu-id="730bc-195">An example response for code grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039858","not_before":"1432035958","resource":"https://management.core.windows.net/","access_token":"eyJ0eXAiOiJKV1Q****M7Cw6JWtfY2lGc5A","refresh_token":"AAABAAAAiL9Kn2Z****55j-sjnyYgAA","scope":"user_impersonation","id_token":"eyJ0eXAiOiJKV*****-drP1J3P-HnHi9Rr46kGZnukEBH4dsg"}

#### <a name="handle-code-grant-token-response"></a><span data-ttu-id="730bc-196">Обработка ответа токена предоставления кода</span><span class="sxs-lookup"><span data-stu-id="730bc-196">Handle code grant token response</span></span>
<span data-ttu-id="730bc-197">Успешный ответ маркера содержит маркер доступа hello (пользователя и приложения) для диспетчера ресурсов Azure.</span><span class="sxs-lookup"><span data-stu-id="730bc-197">A successful token response contains hello (user + app) access token for Azure Resource Manager.</span></span> <span data-ttu-id="730bc-198">Приложение использует этот доступ маркера tooaccess диспетчера ресурсов от имени пользователя hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-198">Your application uses this access token tooaccess Resource Manager on behalf of hello user.</span></span> <span data-ttu-id="730bc-199">время жизни Hello маркеров доступа, выданный Azure AD — один час.</span><span class="sxs-lookup"><span data-stu-id="730bc-199">hello lifetime of access tokens issued by Azure AD is one hour.</span></span> <span data-ttu-id="730bc-200">Маловероятно, что веб-приложения требуется маркер доступа toorenew hello (пользователя и приложения).</span><span class="sxs-lookup"><span data-stu-id="730bc-200">It is unlikely that your web application needs toorenew hello (user + app) access token.</span></span> <span data-ttu-id="730bc-201">Если требуется маркер доступа toorenew hello, используйте токен обновления hello, получаемых приложением в ответ на токен hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-201">If it needs toorenew hello access token, use hello refresh token that your application receives in hello token response.</span></span> <span data-ttu-id="730bc-202">Учет маркеров запроса OAuth2.0 toohello токена Azure AD конечной точки:</span><span class="sxs-lookup"><span data-stu-id="730bc-202">Post an OAuth2.0 Token Request toohello Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="730bc-203">Hello toouse параметры с запросом hello обновления описаны в разделе [обновление токена доступа hello](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span><span class="sxs-lookup"><span data-stu-id="730bc-203">hello parameters toouse with hello refresh request are described in [refreshing hello access token](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span></span>

<span data-ttu-id="730bc-204">Hello следующем примере показано, как токен обновления toouse hello:</span><span class="sxs-lookup"><span data-stu-id="730bc-204">hello following example shows how toouse hello refresh token:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=refresh_token&refresh_token=AAABAAAAiL9Kn2Z****55j-sjnyYgAA&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="730bc-205">Токены обновления могут быть используется tooget новых токенов доступа для диспетчера ресурсов Azure, но они не подходит для автономного доступа для приложения.</span><span class="sxs-lookup"><span data-stu-id="730bc-205">Although refresh tokens can be used tooget new access tokens for Azure Resource Manager, they are not suitable for offline access by your application.</span></span> <span data-ttu-id="730bc-206">время жизни маркеров обновления Hello ограничен и токены обновления являются toohello связанного пользователя.</span><span class="sxs-lookup"><span data-stu-id="730bc-206">hello refresh tokens lifetime is limited, and refresh tokens are bound toohello user.</span></span> <span data-ttu-id="730bc-207">Если hello пользователь оставляет hello организации, с помощью токена обновления hello приложения hello теряет доступ.</span><span class="sxs-lookup"><span data-stu-id="730bc-207">If hello user leaves hello organization, hello application using hello refresh token loses access.</span></span> <span data-ttu-id="730bc-208">Этот способ не подходит для приложений, используемых командами toomanage свои ресурсы Azure.</span><span class="sxs-lookup"><span data-stu-id="730bc-208">This approach isn't suitable for applications that are used by teams toomanage their Azure resources.</span></span>

## <a name="check-if-user-can-assign-access-toosubscription"></a><span data-ttu-id="730bc-209">Проверьте, если пользователь может назначать toosubscription доступа</span><span class="sxs-lookup"><span data-stu-id="730bc-209">Check if user can assign access toosubscription</span></span>
<span data-ttu-id="730bc-210">Приложение теперь имеет токен tooaccess диспетчера ресурсов Azure от имени пользователя hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-210">Your application now has a token tooaccess Azure Resource Manager on behalf of hello user.</span></span> <span data-ttu-id="730bc-211">Hello следующим шагом является tooconnect подписки toohello приложения.</span><span class="sxs-lookup"><span data-stu-id="730bc-211">hello next step is tooconnect your app toohello subscription.</span></span> <span data-ttu-id="730bc-212">После подключения, приложения могут управлять эти подписки даже в том случае, если пользователь hello не существуют (долгосрочной автономного доступа).</span><span class="sxs-lookup"><span data-stu-id="730bc-212">After connecting, your app can manage those subscriptions even when hello user isn't present (long-term offline access).</span></span>

<span data-ttu-id="730bc-213">Для каждой подписки tooconnect, вызовите hello [разрешения списка диспетчера ресурсов](https://docs.microsoft.com/rest/api/authorization/permissions) API toodetermine ли hello пользователь имеет права управления доступом для hello подписки.</span><span class="sxs-lookup"><span data-stu-id="730bc-213">For each subscription tooconnect, call hello [Resource Manager list permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API toodetermine whether hello user has access management rights for hello subscription.</span></span>

<span data-ttu-id="730bc-214">Hello [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) этот вызов реализует метод hello пример приложения ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="730bc-214">hello [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) method of hello ASP.NET MVC sample app implements this call.</span></span>

<span data-ttu-id="730bc-215">Следующий пример показывает как Hello toorequest разрешения пользователя для подписки.</span><span class="sxs-lookup"><span data-stu-id="730bc-215">hello following example shows how toorequest a user's permissions on a subscription.</span></span> <span data-ttu-id="730bc-216">83cfe939-2402-4581-b761-4f59b0a041e4 — идентификатор hello hello подписки.</span><span class="sxs-lookup"><span data-stu-id="730bc-216">83cfe939-2402-4581-b761-4f59b0a041e4 is hello id of hello subscription.</span></span>

    GET https://management.azure.com/subscriptions/83cfe939-2402-4581-b761-4f59b0a041e4/providers/microsoft.authorization/permissions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiLC***lwO1mM7Cw6JWtfY2lGc5A

<span data-ttu-id="730bc-217">Примером разрешения пользователя tooget hello ответа на подписки является:</span><span class="sxs-lookup"><span data-stu-id="730bc-217">An example of hello response tooget user's permissions on subscription is:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"actions":["*"],"notActions":["Microsoft.Authorization/*/Write","Microsoft.Authorization/*/Delete"]},{"actions":["*/read"],"notActions":[]}]}

<span data-ttu-id="730bc-218">разрешения Hello API возвращает несколько разрешений.</span><span class="sxs-lookup"><span data-stu-id="730bc-218">hello permissions API returns multiple permissions.</span></span> <span data-ttu-id="730bc-219">Каждое разрешение состоит из разрешенных действий (actions) и запрещенных действий (notActions).</span><span class="sxs-lookup"><span data-stu-id="730bc-219">Each permission consists of allowed actions (actions) and disallowed actions (notactions).</span></span> <span data-ttu-id="730bc-220">Если действие, которое присутствует в hello допускается любое разрешение список действий и не присутствует в списке notactions hello этого разрешения, пользователь hello допускается tooperform это действие.</span><span class="sxs-lookup"><span data-stu-id="730bc-220">If an action is present in hello allowed actions list of any permission and not present in hello notactions list of that permission, hello user is allowed tooperform that action.</span></span> <span data-ttu-id="730bc-221">**Microsoft.Authorization/roleassignments/Write** — действие hello, который предоставляет доступ management rights.</span><span class="sxs-lookup"><span data-stu-id="730bc-221">**microsoft.authorization/roleassignments/write** is hello action that that grants access management rights.</span></span> <span data-ttu-id="730bc-222">Приложение необходимо выделить toolook результат hello разрешения для сопоставления регулярных выражений в строку этого действия в действиях hello и notactions всех разрешений.</span><span class="sxs-lookup"><span data-stu-id="730bc-222">Your application must parse hello permissions result toolook for a regex match on this action string in hello actions and notactions of each permission.</span></span>

## <a name="get-app-only-access-token"></a><span data-ttu-id="730bc-223">Получение маркера доступа только для приложений</span><span class="sxs-lookup"><span data-stu-id="730bc-223">Get app-only access token</span></span>
<span data-ttu-id="730bc-224">Теперь вы знаете, если hello пользователя можно назначить доступ toohello подписки Azure.</span><span class="sxs-lookup"><span data-stu-id="730bc-224">Now, you know if hello user can assign access toohello Azure subscription.</span></span> <span data-ttu-id="730bc-225">следующие действия Hello таковы.</span><span class="sxs-lookup"><span data-stu-id="730bc-225">hello next steps are:</span></span>

1. <span data-ttu-id="730bc-226">Назначьте hello соответствующие RBAC роли tooyour удостоверение приложения в подписке hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-226">Assign hello appropriate RBAC role tooyour application's identity on hello subscription.</span></span>
2. <span data-ttu-id="730bc-227">Проверьте назначение доступа hello путем запроса разрешений приложения hello в подписке hello, или обратившись токен только приложения с помощью диспетчера ресурсов.</span><span class="sxs-lookup"><span data-stu-id="730bc-227">Validate hello access assignment by querying for hello Application's permission on hello subscription or by accessing Resource Manager using app-only token.</span></span>
3. <span data-ttu-id="730bc-228">Соединение записей hello в структуре данных приложения «подключенных подписками» — сохранение hello идентификатор подписки hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-228">Record hello connection in your applications "connected subscriptions" data structure - persisting hello id of hello subscription.</span></span>

<span data-ttu-id="730bc-229">Давайте взглянем на первом шаге hello ближе.</span><span class="sxs-lookup"><span data-stu-id="730bc-229">Let's look closer at hello first step.</span></span> <span data-ttu-id="730bc-230">tooassign hello соответствующие RBAC роли toohello удостоверения приложения, необходимо определить:</span><span class="sxs-lookup"><span data-stu-id="730bc-230">tooassign hello appropriate RBAC role toohello application's identity, you must determine:</span></span>

* <span data-ttu-id="730bc-231">Идентификатор объекта Hello удостоверение приложения в hello пользователя Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="730bc-231">hello object id of your application's identity in hello user's Azure Active Directory</span></span>
* <span data-ttu-id="730bc-232">Идентификатор роли RBAC hello, приложению в подписке hello Hello</span><span class="sxs-lookup"><span data-stu-id="730bc-232">hello identifier of hello RBAC role that your application requires on hello subscription</span></span>

<span data-ttu-id="730bc-233">Когда приложение впервые проверяет подлинность пользователя из Azure AD, в этом экземпляре Azure AD создается объект субъекта-службы для приложения.</span><span class="sxs-lookup"><span data-stu-id="730bc-233">When your application authenticates a user from an Azure AD, it creates a service principal object for your application in that Azure AD.</span></span> <span data-ttu-id="730bc-234">Azure позволяет toobe роли RBAC назначены участникам tooservice toogrant прямой доступ toocorresponding приложения в ресурсах Azure.</span><span class="sxs-lookup"><span data-stu-id="730bc-234">Azure allows RBAC roles toobe assigned tooservice principals toogrant direct access toocorresponding applications on Azure resources.</span></span> <span data-ttu-id="730bc-235">Это действие именно то, что мы желаем toodo.</span><span class="sxs-lookup"><span data-stu-id="730bc-235">This action is exactly what we wish toodo.</span></span> <span data-ttu-id="730bc-236">Идентификатор запроса hello Azure AD Graph API toodetermine hello hello субъекта-службы приложения в hello выполнившего вход пользователя в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="730bc-236">Query hello Azure AD Graph API toodetermine hello identifier of hello service principal of your application in hello signed-in user's Azure AD.</span></span>

<span data-ttu-id="730bc-237">Имеется только маркер доступа для диспетчера ресурсов Azure — нужно новый hello toocall токена доступа к API Azure AD Graph.</span><span class="sxs-lookup"><span data-stu-id="730bc-237">You only have an access token for Azure Resource Manager - you need a new access token toocall hello Azure AD Graph API.</span></span> <span data-ttu-id="730bc-238">Каждое приложение в Azure AD имеет разрешение tooquery свой собственный объект участника службы, поэтому достаточно маркер доступа только для приложений.</span><span class="sxs-lookup"><span data-stu-id="730bc-238">Every application in Azure AD has permission tooquery its own service principal object, so an app-only access token is sufficient.</span></span>

<a id="app-azure-ad-graph" />

### <a name="get-app-only-access-token-for-azure-ad-graph-api"></a><span data-ttu-id="730bc-239">Получение маркера доступа только для приложений для API Graph Azure AD</span><span class="sxs-lookup"><span data-stu-id="730bc-239">Get app-only access token for Azure AD Graph API</span></span>
<span data-ttu-id="730bc-240">tooauthenticate приложения и получить токен tooAzure AD Graph API, выдавать OAuth2.0 предоставление учетных данных клиента потока запроса маркера tooAzure AD маркера конечной точки (**https://login.microsoftonline.com/ {directory_domain_name} / OAuth2/токен**).</span><span class="sxs-lookup"><span data-stu-id="730bc-240">tooauthenticate your app and get a token tooAzure AD Graph API, issue a Client Credential Grant OAuth2.0 flow token request tooAzure AD token endpoint (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span></span>

<span data-ttu-id="730bc-241">Hello [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) метод hello пример приложения ASP.net MVC получает доступ только для приложений маркера для Graph API с помощью hello библиотеку аутентификации Active Directory для .NET.</span><span class="sxs-lookup"><span data-stu-id="730bc-241">hello [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) method of hello ASP.net MVC sample application gets an app-only access token for Graph API using hello Active Directory Authentication Library for .NET.</span></span>

<span data-ttu-id="730bc-242">Параметры строки запроса Hello, доступные для этого запроса описаны в hello [запроса на токен доступа](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) раздела.</span><span class="sxs-lookup"><span data-stu-id="730bc-242">hello query string parameters that are available for this request are described in hello [Request an Access Token](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) topic.</span></span>

<span data-ttu-id="730bc-243">Пример запроса на токен предоставления учетных данных клиента:</span><span class="sxs-lookup"><span data-stu-id="730bc-243">An example request for client credential grant token:</span></span>

    POST https://login.microsoftonline.com/62e173e9-301e-423e-bcd4-29121ec1aa24/oauth2/token HTTP/1.1
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 187</pre>
    <pre>grant_type=client_credentials&client_id=a0448380-c346-4f9f-b897-c18733de9394&resource=https%3A%2F%2Fgraph.windows.net%2F &client_secret=olna8C*****Og%3D

<span data-ttu-id="730bc-244">Пример ответа токена предоставления учетных данных клиента:</span><span class="sxs-lookup"><span data-stu-id="730bc-244">An example response for client credential grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039862","not_before":"1432035962","resource":"https://graph.windows.net/","access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSIsImtpZCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRv****G5gUTV-kKorR-pg"}

### <a name="get-objectid-of-application-service-principal-in-user-azure-ad"></a><span data-ttu-id="730bc-245">Получение идентификатора объекта субъекта-службы приложения в Azure AD пользователя</span><span class="sxs-lookup"><span data-stu-id="730bc-245">Get ObjectId of application service principal in user Azure AD</span></span>
<span data-ttu-id="730bc-246">Теперь воспользуйтесь hello tooquery токена доступа только для приложения hello [субъекты-службы Azure AD Graph](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) hello toodetermine API идентификатор объекта участника-службы приложения hello в каталоге hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-246">Now, use hello app-only access token tooquery hello [Azure AD Graph Service Principals](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API toodetermine hello Object Id of hello application's service principal in hello directory.</span></span>

<span data-ttu-id="730bc-247">Hello [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) этот вызов реализует метод hello пример приложения ASP.net MVC.</span><span class="sxs-lookup"><span data-stu-id="730bc-247">hello [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) method of hello ASP.net MVC sample application implements this call.</span></span>

<span data-ttu-id="730bc-248">Следующий пример показывает как Hello toorequest участника-службы приложения.</span><span class="sxs-lookup"><span data-stu-id="730bc-248">hello following example shows how toorequest an application's service principal.</span></span> <span data-ttu-id="730bc-249">a0448380-c346-4f9f-b897-c18733de9394 — hello идентификатор клиента приложения hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-249">a0448380-c346-4f9f-b897-c18733de9394 is hello client id of hello application.</span></span>

    GET https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/servicePrincipals?api-version=1.5&$filter=appId%20eq%20'a0448380-c346-4f9f-b897-c18733de9394' HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJK*****-kKorR-pg

<span data-ttu-id="730bc-250">Hello примере показан запрос toohello ответа для приложения службы субъекта</span><span class="sxs-lookup"><span data-stu-id="730bc-250">hello following example shows a response toohello request for an application's service principal</span></span>

    HTTP/1.1 200 OK

    {"odata.metadata":"https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/$metadata#directoryObjects/Microsoft.DirectoryServices.ServicePrincipal","value":[{"odata.type":"Microsoft.DirectoryServices.ServicePrincipal","objectType":"ServicePrincipal","objectId":"9b5018d4-6951-42ed-8a92-f11ec283ccec","deletionTimestamp":null,"accountEnabled":true,"appDisplayName":"CloudSense","appId":"a0448380-c346-4f9f-b897-c18733de9394","appOwnerTenantId":"62e173e9-301e-423e-bcd4-29121ec1aa24","appRoleAssignmentRequired":false,"appRoles":[],"displayName":"CloudSense","errorUrl":null,"homepage":"http://www.vipswapper.com/cloudsense","keyCredentials":[],"logoutUrl":null,"oauth2Permissions":[{"adminConsentDescription":"Allow hello application tooaccess CloudSense on behalf of hello signed-in user.","adminConsentDisplayName":"Access CloudSense","id":"b7b7338e-683a-4796-b95e-60c10380de1c","isEnabled":true,"type":"User","userConsentDescription":"Allow hello application tooaccess CloudSense on your behalf.","userConsentDisplayName":"Access CloudSense","value":"user_impersonation"}],"passwordCredentials":[],"preferredTokenSigningKeyThumbprint":null,"publisherName":"vipswapper"quot;,"replyUrls":["http://www.vipswapper.com/cloudsense","http://www.vipswapper.com","http://vipswapper.com","http://vipswapper.azurewebsites.net","http://localhost:62080"],"samlMetadataUrl":null,"servicePrincipalNames":["http://www.vipswapper.com/cloudsense","a0448380-c346-4f9f-b897-c18733de9394"],"tags":["WindowsAzureActiveDirectoryIntegratedApp"]}]}

### <a name="get-azure-rbac-role-identifier"></a><span data-ttu-id="730bc-251">Получение идентификатора роли RBAC Azure</span><span class="sxs-lookup"><span data-stu-id="730bc-251">Get Azure RBAC role identifier</span></span>
<span data-ttu-id="730bc-252">tooassign hello соответствующие RBAC роли tooyour субъекта-службы, необходимо определить идентификатор hello роли Azure RBAC hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-252">tooassign hello appropriate RBAC role tooyour service principal, you must determine hello identifier of hello Azure RBAC role.</span></span>

<span data-ttu-id="730bc-253">Hello справа роль RBAC для приложения:</span><span class="sxs-lookup"><span data-stu-id="730bc-253">hello right RBAC role for your application:</span></span>

* <span data-ttu-id="730bc-254">Если приложение наблюдает только за подписку hello без внесения изменений, требуются только разрешения чтения на hello подписки.</span><span class="sxs-lookup"><span data-stu-id="730bc-254">If your application only monitors hello subscription, without making any changes, it requires only reader permissions on hello subscription.</span></span> <span data-ttu-id="730bc-255">Назначить hello **чтения** роли.</span><span class="sxs-lookup"><span data-stu-id="730bc-255">Assign hello **Reader** role.</span></span>
* <span data-ttu-id="730bc-256">Если приложение управляет подписки Azure hello, создание или изменение или удаление сущностей, он требует наличия разрешения участника hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-256">If your application manages Azure hello subscription, creating/modifying/deleting entities, it requires one of hello contributor permissions.</span></span>
  * <span data-ttu-id="730bc-257">toomanage определенного типа ресурсов, назначение ролей для конкретного ресурса участника hello (участника виртуальной машины, виртуальные сети участника, участник учетной записи хранилища, и т. д.)</span><span class="sxs-lookup"><span data-stu-id="730bc-257">toomanage a particular type of resource, assign hello resource-specific contributor roles (Virtual Machine Contributor, Virtual Network Contributor, Storage Account Contributor, etc.)</span></span>
  * <span data-ttu-id="730bc-258">toomanage какой-либо тип ресурса, назначьте hello **участника** роли.</span><span class="sxs-lookup"><span data-stu-id="730bc-258">toomanage any resource type, assign hello **Contributor** role.</span></span>

<span data-ttu-id="730bc-259">Hello назначение ролей для приложения является видимым toousers, поэтому выберите hello наименьших необходимых прав доступа.</span><span class="sxs-lookup"><span data-stu-id="730bc-259">hello role assignment for your application is visible toousers, so select hello least-required privilege.</span></span>

<span data-ttu-id="730bc-260">Вызовите hello [определение роли диспетчера ресурсов API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) toolist все роли Azure RBAC и поиска затем перебора hello результат toofind hello требуемого определения роли по имени.</span><span class="sxs-lookup"><span data-stu-id="730bc-260">Call hello [Resource Manager role definition API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) toolist all Azure RBAC roles and search then iterate over hello result toofind hello desired role definition by name.</span></span>

<span data-ttu-id="730bc-261">Hello [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) этот вызов реализует метод hello пример приложения ASP.net MVC.</span><span class="sxs-lookup"><span data-stu-id="730bc-261">hello [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) method of hello ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="730bc-262">Hello следующий запрос в примере как идентификатор роли tooget Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="730bc-262">hello following request example shows how tooget Azure RBAC role identifier.</span></span> <span data-ttu-id="730bc-263">09cbd307-aa71-4aca-b346-5f253e6e3ebb — идентификатор hello hello подписки.</span><span class="sxs-lookup"><span data-stu-id="730bc-263">09cbd307-aa71-4aca-b346-5f253e6e3ebb is hello id of hello subscription.</span></span>

    GET https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV*****fY2lGc5

<span data-ttu-id="730bc-264">Hello ответа имеет hello следующий формат:</span><span class="sxs-lookup"><span data-stu-id="730bc-264">hello response is in hello following format:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"properties":{"roleName":"API Management Service Contributor","type":"BuiltInRole","description":"Lets you manage API Management services, but not access toothem.","scope":"/","permissions":[{"actions":["Microsoft.ApiManagement/Services/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/312a565d-c81f-4fd8-895a-4e21e48d571c","type":"Microsoft.Authorization/roleDefinitions","name":"312a565d-c81f-4fd8-895a-4e21e48d571c"},{"properties":{"roleName":"Application Insights Component Contributor","type":"BuiltInRole","description":"Lets you manage Application Insights components, but not access toothem.","scope":"/","permissions":[{"actions":["Microsoft.Insights/components/*","Microsoft.Insights/webtests/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/ae349356-3a1b-4a5e-921d-050484c6347e","type":"Microsoft.Authorization/roleDefinitions","name":"ae349356-3a1b-4a5e-921d-050484c6347e"}]}

<span data-ttu-id="730bc-265">Необязательно toocall этот API на постоянной основе.</span><span class="sxs-lookup"><span data-stu-id="730bc-265">You do not need toocall this API on an ongoing basis.</span></span> <span data-ttu-id="730bc-266">После определения Здравствуйте хорошо известный идентификатор GUID hello определения роли, можно сконструировать идентификатор определения роли hello как:</span><span class="sxs-lookup"><span data-stu-id="730bc-266">Once you've determined hello well-known GUID of hello role definition, you can construct hello role definition id as:</span></span>

    /subscriptions/{subscription_id}/providers/Microsoft.Authorization/roleDefinitions/{well-known-role-guid}

<span data-ttu-id="730bc-267">Ниже приведены hello хорошо известные идентификаторы GUID часто используемых встроенных ролей.</span><span class="sxs-lookup"><span data-stu-id="730bc-267">Here are hello well-known guids of commonly used built-in roles:</span></span>

| <span data-ttu-id="730bc-268">Роль</span><span class="sxs-lookup"><span data-stu-id="730bc-268">Role</span></span> | <span data-ttu-id="730bc-269">Guid</span><span class="sxs-lookup"><span data-stu-id="730bc-269">Guid</span></span> |
| --- | --- |
| <span data-ttu-id="730bc-270">Читатель</span><span class="sxs-lookup"><span data-stu-id="730bc-270">Reader</span></span> |<span data-ttu-id="730bc-271">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="730bc-271">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |
| <span data-ttu-id="730bc-272">Участник</span><span class="sxs-lookup"><span data-stu-id="730bc-272">Contributor</span></span> |<span data-ttu-id="730bc-273">b24988ac-6180-42a0-ab88-20f7382dd24c</span><span class="sxs-lookup"><span data-stu-id="730bc-273">b24988ac-6180-42a0-ab88-20f7382dd24c</span></span> |
| <span data-ttu-id="730bc-274">Участник виртуальной машины</span><span class="sxs-lookup"><span data-stu-id="730bc-274">Virtual Machine Contributor</span></span> |<span data-ttu-id="730bc-275">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span><span class="sxs-lookup"><span data-stu-id="730bc-275">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span></span> |
| <span data-ttu-id="730bc-276">Участник виртуальной сети</span><span class="sxs-lookup"><span data-stu-id="730bc-276">Virtual Network Contributor</span></span> |<span data-ttu-id="730bc-277">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span><span class="sxs-lookup"><span data-stu-id="730bc-277">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span></span> |
| <span data-ttu-id="730bc-278">Участник учетной записи хранения</span><span class="sxs-lookup"><span data-stu-id="730bc-278">Storage Account Contributor</span></span> |<span data-ttu-id="730bc-279">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span><span class="sxs-lookup"><span data-stu-id="730bc-279">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span></span> |
| <span data-ttu-id="730bc-280">Участник веб-сайта</span><span class="sxs-lookup"><span data-stu-id="730bc-280">Website Contributor</span></span> |<span data-ttu-id="730bc-281">de139f84-1756-47ae-9be6-808fbbe84772</span><span class="sxs-lookup"><span data-stu-id="730bc-281">de139f84-1756-47ae-9be6-808fbbe84772</span></span> |
| <span data-ttu-id="730bc-282">Участник веб-плана</span><span class="sxs-lookup"><span data-stu-id="730bc-282">Web Plan Contributor</span></span> |<span data-ttu-id="730bc-283">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span><span class="sxs-lookup"><span data-stu-id="730bc-283">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span></span> |
| <span data-ttu-id="730bc-284">Участник SQL Server</span><span class="sxs-lookup"><span data-stu-id="730bc-284">SQL Server Contributor</span></span> |<span data-ttu-id="730bc-285">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span><span class="sxs-lookup"><span data-stu-id="730bc-285">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span></span> |
| <span data-ttu-id="730bc-286">Участник БД SQL</span><span class="sxs-lookup"><span data-stu-id="730bc-286">SQL DB Contributor</span></span> |<span data-ttu-id="730bc-287">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span><span class="sxs-lookup"><span data-stu-id="730bc-287">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span></span> |

### <a name="assign-rbac-role-tooapplication"></a><span data-ttu-id="730bc-288">Назначьте роль tooapplication RBAC</span><span class="sxs-lookup"><span data-stu-id="730bc-288">Assign RBAC role tooapplication</span></span>
<span data-ttu-id="730bc-289">У вас есть все необходимое tooassign hello соответствующие RBAC роли tooyour участника-службы с помощью hello [диспетчера ресурсов создать назначение ролей](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span><span class="sxs-lookup"><span data-stu-id="730bc-289">You have everything you need tooassign hello appropriate RBAC role tooyour service principal by using hello [Resource Manager create role assignment](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span></span>

<span data-ttu-id="730bc-290">Hello [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) этот вызов реализует метод hello пример приложения ASP.net MVC.</span><span class="sxs-lookup"><span data-stu-id="730bc-290">hello [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) method of hello ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="730bc-291">Пример запроса tooassign RBAC роли tooapplication:</span><span class="sxs-lookup"><span data-stu-id="730bc-291">An example request tooassign RBAC role tooapplication:</span></span>

    PUT https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/microsoft.authorization/roleassignments/4f87261d-2816-465d-8311-70a27558df4c?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiL*****FlwO1mM7Cw6JWtfY2lGc5
    Content-Type: application/json
    Content-Length: 230

    {"properties": {"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2"}}

<span data-ttu-id="730bc-292">В запросе hello используются hello следующие значения:</span><span class="sxs-lookup"><span data-stu-id="730bc-292">In hello request, hello following values are used:</span></span>

| <span data-ttu-id="730bc-293">Guid</span><span class="sxs-lookup"><span data-stu-id="730bc-293">Guid</span></span> | <span data-ttu-id="730bc-294">Описание</span><span class="sxs-lookup"><span data-stu-id="730bc-294">Description</span></span> |
| --- | --- |
| <span data-ttu-id="730bc-295">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span><span class="sxs-lookup"><span data-stu-id="730bc-295">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span></span> |<span data-ttu-id="730bc-296">Идентификатор Hello hello подписки</span><span class="sxs-lookup"><span data-stu-id="730bc-296">hello id of hello subscription</span></span> |
| <span data-ttu-id="730bc-297">c3097b31-7309-4c59-b4e3-770f8406bad2</span><span class="sxs-lookup"><span data-stu-id="730bc-297">c3097b31-7309-4c59-b4e3-770f8406bad2</span></span> |<span data-ttu-id="730bc-298">Идентификатор объекта Hello hello участника-службы приложения hello</span><span class="sxs-lookup"><span data-stu-id="730bc-298">hello object id of hello service principal of hello application</span></span> |
| <span data-ttu-id="730bc-299">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="730bc-299">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |<span data-ttu-id="730bc-300">Идентификатор роли модуля чтения hello Hello</span><span class="sxs-lookup"><span data-stu-id="730bc-300">hello id of hello reader role</span></span> |
| <span data-ttu-id="730bc-301">4f87261d-2816-465d-8311-70a27558df4c</span><span class="sxs-lookup"><span data-stu-id="730bc-301">4f87261d-2816-465d-8311-70a27558df4c</span></span> |<span data-ttu-id="730bc-302">новый идентификатор guid, созданный для hello создать назначение ролей</span><span class="sxs-lookup"><span data-stu-id="730bc-302">a new guid created for hello new role assignment</span></span> |

<span data-ttu-id="730bc-303">Hello ответа имеет hello следующий формат:</span><span class="sxs-lookup"><span data-stu-id="730bc-303">hello response is in hello following format:</span></span>

    HTTP/1.1 201 Created

    {"properties":{"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2","scope":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb"},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleAssignments/4f87261d-2816-465d-8311-70a27558df4c","type":"Microsoft.Authorization/roleAssignments","name":"4f87261d-2816-465d-8311-70a27558df4c"}

### <a name="get-app-only-access-token-for-azure-resource-manager"></a><span data-ttu-id="730bc-304">Получение маркера доступа только для приложений для Azure Resource Manager</span><span class="sxs-lookup"><span data-stu-id="730bc-304">Get app-only access token for Azure Resource Manager</span></span>
<span data-ttu-id="730bc-305">toovalidate приложение имеет доступ hello требуемого hello подписки, выполните задачу теста на hello подписки с помощью маркера только для приложений.</span><span class="sxs-lookup"><span data-stu-id="730bc-305">toovalidate that app has hello desired access on hello subscription, perform a test task on hello subscription using an app-only token.</span></span>

<span data-ttu-id="730bc-306">tooget маркер доступа только для приложений, следуйте инструкциям из раздела [получить маркер доступа только для приложений для Azure AD Graph API](#app-azure-ad-graph), с другим значением параметра hello ресурсов:</span><span class="sxs-lookup"><span data-stu-id="730bc-306">tooget an app-only access token, follow instructions from section [Get app-only access token for Azure AD Graph API](#app-azure-ad-graph), with a different value for hello resource parameter:</span></span>

    https://management.core.windows.net/

<span data-ttu-id="730bc-307">Hello [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) метод hello пример приложения ASP.NET MVC получает доступ только для приложений для диспетчера ресурсов Azure с помощью токена hello библиотеку аутентификации Active Directory для .net.</span><span class="sxs-lookup"><span data-stu-id="730bc-307">hello [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of hello ASP.NET MVC sample application gets an app-only access token for Azure Resource Manager using hello Active Directory Authentication Library for .net.</span></span>

#### <a name="get-applications-permissions-on-subscription"></a><span data-ttu-id="730bc-308">Получение разрешений приложения для подписки</span><span class="sxs-lookup"><span data-stu-id="730bc-308">Get Application's Permissions on Subscription</span></span>
<span data-ttu-id="730bc-309">toocheck, ваше приложение имеет hello требуемого доступ на подписку Azure, может также вызвать hello [разрешения диспетчера ресурсов](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span><span class="sxs-lookup"><span data-stu-id="730bc-309">toocheck that your application has hello desired access on an Azure subscription, you may also call hello [Resource Manager Permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span></span> <span data-ttu-id="730bc-310">Этот подход является аналогичные toohow определить, имеет ли пользователь hello права управления доступом для hello подписки.</span><span class="sxs-lookup"><span data-stu-id="730bc-310">This approach is similar toohow you determined whether hello user has Access Management rights for hello subscription.</span></span> <span data-ttu-id="730bc-311">Однако на этот раз вызовите hello разрешения API с маркером доступа только для приложения hello, полученный в предыдущем шаге hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-311">However, this time, call hello permissions API with hello app-only access token that you received in hello previous step.</span></span>

<span data-ttu-id="730bc-312">Hello [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) этот вызов реализует метод hello пример приложения ASP.NET MVC.</span><span class="sxs-lookup"><span data-stu-id="730bc-312">hello [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of hello ASP.NET MVC sample app implements this call.</span></span>

## <a name="manage-connected-subscriptions"></a><span data-ttu-id="730bc-313">Управление подключенными подписками</span><span class="sxs-lookup"><span data-stu-id="730bc-313">Manage connected subscriptions</span></span>
<span data-ttu-id="730bc-314">При соответствующей роли RBAC hello назначен субъект-служба приложения tooyour в подписке hello, приложения можно сохранить мониторинг и управление его с помощью маркера доступа только для приложений для диспетчера ресурсов Azure.</span><span class="sxs-lookup"><span data-stu-id="730bc-314">When hello appropriate RBAC role is assigned tooyour application's service principal on hello subscription, your application can keep monitoring/managing it using app-only access tokens for Azure Resource Manager.</span></span>

<span data-ttu-id="730bc-315">Если владелец подписки удаляет назначение роли приложения с помощью классического портала hello или средства командной строки, приложение будет tooaccess больше не будет этой подписки.</span><span class="sxs-lookup"><span data-stu-id="730bc-315">If a subscription owner removes your application's role assignment using hello classic portal or command-line tools, your application is no longer able tooaccess that subscription.</span></span> <span data-ttu-id="730bc-316">В этом случае необходимо hello пользователь уведомляется о том, что hello соединение с подпиской hello было разорвано из внешнего приложения hello и дать им параметр слишком «восстановить» hello соединения.</span><span class="sxs-lookup"><span data-stu-id="730bc-316">In that case, you should notify hello user that hello connection with hello subscription was severed from outside hello application and give them an option too"repair" hello connection.</span></span> <span data-ttu-id="730bc-317">«Восстановить» повторно просто создать назначение ролей hello, был удален в автономном режиме.</span><span class="sxs-lookup"><span data-stu-id="730bc-317">"Repair" would simply re-create hello role assignment that was deleted offline.</span></span>

<span data-ttu-id="730bc-318">Так же, как вы включили hello пользователя tooconnect подписки tooyour приложения, необходимо разрешить слишком подписки toodisconnect hello пользователя.</span><span class="sxs-lookup"><span data-stu-id="730bc-318">Just as you enabled hello user tooconnect subscriptions tooyour application, you must allow hello user toodisconnect subscriptions too.</span></span> <span data-ttu-id="730bc-319">С access management точки зрения отключите означает удаление назначения ролей hello с субъектом-службой приложения hello в подписке hello.</span><span class="sxs-lookup"><span data-stu-id="730bc-319">From an access management point of view, disconnect means removing hello role assignment that hello application's service principal has on hello subscription.</span></span> <span data-ttu-id="730bc-320">При необходимости состояние приложения hello для hello подписки может быть удалена слишком.</span><span class="sxs-lookup"><span data-stu-id="730bc-320">Optionally, any state in hello application for hello subscription might be removed too.</span></span>
<span data-ttu-id="730bc-321">Только пользователи с разрешением доступа управления в подписке hello, может toodisconnect hello подписки.</span><span class="sxs-lookup"><span data-stu-id="730bc-321">Only users with access management permission on hello subscription are able toodisconnect hello subscription.</span></span>

<span data-ttu-id="730bc-322">Hello [RevokeRoleFromServicePrincipalOnSubscription метод](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) пример приложения hello ASP.net MVC реализует этот вызов.</span><span class="sxs-lookup"><span data-stu-id="730bc-322">hello [RevokeRoleFromServicePrincipalOnSubscription method](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) of hello ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="730bc-323">Теперь пользователи могут легко подключать подписки Azure к приложениям и управлять ими с помощью этих подписок.</span><span class="sxs-lookup"><span data-stu-id="730bc-323">That's it - users can now easily connect and manage their Azure subscriptions with your application.</span></span>

---
title: "Проектирование шаблонов Azure для сложных решений | Документация Майкрософт"
description: "Содержит советы и рекомендации по разработке шаблонов Azure Resource Manager для сложных сценариев."
services: azure-resource-manager
documentationcenter: 
author: tfitzmac
manager: timlt
editor: tysonn
ms.assetid: ce1141d6-ece7-4976-acea-1db1f775409e
ms.service: azure-resource-manager
ms.workload: multiple
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/19/2016
ms.author: tomfitz
ms.openlocfilehash: dcc31f7a8c85a8f7fbd554371a66fb1e348bca17
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="design-patterns-for-azure-resource-manager-templates-when-deploying-complex-solutions"></a>Приемы разработки шаблонов Azure Resource Manager при развертывании сложных решений
Гибкий подход, основывающийся на использовании шаблонов Azure Resource Manager, позволяет быстро и согласованно развертывать сложные топологии. Эти развертывания можно с легкостью адаптировать по мере развития основных предложений. Кроме того, можно работать с вариантами для сценариев выбросов или клиентов.

Данная тема является частью другого технического документа. Чтобы ознакомиться с полным текстом этого документа, скачайте файл [World Class Azure Resource Manager Templates Considerations and Proven Practices](http://download.microsoft.com/download/8/E/1/8E1DBEFA-CECE-4DC9-A813-93520A5D7CFE/World Class ARM Templates - Considerations and Proven Practices.pdf) (Рекомендации по работе с шаблонами Azure Resource Manager мирового класса).

Шаблоны сочетают преимущества базового диспетчера ресурсов Azure с адаптивностью и удобочитаемостью нотации объектов JavaScript (JSON). Шаблоны можно использовать следующим образом.

* Последовательное развертывание топологий и рабочих нагрузок.
* Управление всеми ресурсами в приложении с помощью групп ресурсов.
* Управление доступом на основе ролей (RBAC) для предоставления соответствующего доступа пользователям, группам и службам.
* Использование сопоставления добавления тегов для упрощения задач, включая сведение при выставлении счетов.

В этой статье приводятся сведения об использовании сценариев, архитектуры и шаблонов реализации, определенных во время сеансов разработки и реализации шаблона в реальных условиях с клиентами группы консультирования клиентов Azure (AzureCAT). Далеко не теоретические, эти проверенные методики подкреплены опытом разработки шаблонов для 12 популярных программных решений с открытым исходным кодом на основе ОС Linux, включая Apache Kafka, Apache Spark, Cloudera, Couchbase, Hortonworks HDP, DataStax Enterprise, управляемых Apache-Cassandra, Elasticsearch, Jenkins, MongoDB, PostgreSQL, Redis и Nagios. 

В статье приводятся эти проверенные методики, помогающие проектировать шаблоны диспетчера ресурсов Azure мирового класса.  

При работе с клиентами мы определили объемы использования шаблонов Resource Manager предприятиями, системными интеграторами и поставщиками облачных служб. В следующих разделах приведен высокоуровневый обзор распространенных сценариев и шаблонов для разных типов клиентов.

## <a name="enterprises-and-system-integrators"></a>Предприятия и системные интеграторы
Пользователи шаблонов Resource Manager в рамках крупных организаций чаще всего представлены двумя типами: группами разработчиков программного обеспечения для внутреннего пользования и корпоративными ИТ-отделами. Мы обнаружили, что сценарии для системных интеграторов сопоставлены с таковыми для предприятий, поэтому для двух типов клиентов действительны одинаковые условия.

### <a name="internal-software-development-teams"></a>Группы разработчиков программного обеспечения для внутреннего пользования
Если группа разрабатывает программное обеспечение для поддержки бизнеса, шаблоны позволяют быстро и просто развертывать технологии для использования в бизнес-решениях. Вы также можете использовать шаблоны для быстрого создания сред обучения, с помощью которых участники группы могут получить необходимые навыки.

Вы можете использовать шаблоны как есть, расширять их или создавать в соответствии со своими потребностями. Добавляя теги в шаблоны, вы можете отображать сводку по выставленным счетам с использованием разных представлений — уровня отдельного пользователя, группы или проекта — включая обучающие представления.

Часто в организациях группам разработчиков программного обеспечения требуется создать шаблон для согласованного развертывания решения. Шаблон обеспечивает ограничения, благодаря которым определенные элементы в среде остаются фиксированными и не могут быть переопределены. Например, банку может потребоваться шаблон для включения RBAC, который запрещает программисту настраивать в банковском решении отправку данных на личную учетную запись хранения.

### <a name="corporate-it"></a>Корпоративные ИТ-отделы
Корпоративные ИТ-отделы обычно используют шаблоны для доставки емкости облака и возможностей размещения в облаке.

#### <a name="cloud-capacity"></a>Емкость облака
Чаще всего ИТ-группы предоставляют емкость облака для групп в виде "размеров футболки", где речь идет о малом, среднем и большом размерах конфигурации. Предложения в виде «размеров футболки» позволяют не только комбинировать разные типы и количества ресурсов, но и обеспечивают уровень стандартизации, который позволяет использовать шаблоны. Шаблоны предоставляют емкость согласованно, применяя корпоративные политики и используя теги. Это позволяет организациям-потребителям использовать возвратный платеж.

Например, вам необходимо предоставить среды для разработки, тестирования или производства, в которых группы разработчиков программного обеспечения смогут развернуть свои решения. Среда содержит предопределенную сетевую топологию и элементы, которые группы разработчиков программного обеспечения не могут изменять. Сюда входят правила, определяющие общий доступ в Интернет и проверку пакетов. Этим средам также можно назначить роли конкретной организации, предоставляющие уникальные права доступа.

#### <a name="cloud-hosted-capabilities"></a>Возможности размещения в облаке
Шаблоны можно использовать для поддержки возможностей размещения в облаке. Эти возможности представлены отдельными пакетами программного обеспечения или составными предложениями для внутренних бизнес-процессов. Пример составного предложения — это аналитика как услуга — технологии аналитики, визуализации и пр. Такие предложения реализуются в оптимизированной и подключенной конфигурации в рамках предопределенной сетевой топологии.

Возможности размещения в облаке зависят от условий безопасности и ролей, определенных предложением емкости облака и используемых при их создании. Эти возможности предоставляются как есть или в качестве управляемой службы. Во втором случае для предоставления доступа к среде с целью управления требуются роли, ограничивающие доступ.

## <a name="cloud-service-vendors"></a>Поставщики облачных служб
После общения со многими поставщиками облачных служб мы определили несколько подходов, которые можно использовать при развертывании служб для клиентов в соответствии с их требованиями.

### <a name="csv-hosted-offering"></a>Предложения, размещаемые поставщиками облачных служб
При размещении предложения в подписке Azure обычно используется два подхода: отдельное развертывание для каждого клиента и развертывание единиц масштабирования, которые обеспечивают общую инфраструктуру, используемую для всех клиентов.

* **Отдельные развертывания для каждого клиента.** Отдельные развертывания для каждого клиента требуют наличия фиксированной топологии разных известных конфигураций. Эти развертывания могут быть представлены разными размерами виртуальных машин, разным количеством узлов, а также разными объемами связанного хранилища. Добавление тегов развертываний используется для сведенного выставления счетов каждому клиенту. Функция RBAC может быть включена для предоставления клиентам доступа к компонентам облачной среды.
* **Единицы масштабирования в общей среде с несколькими клиентами.** Шаблон может представлять единицу масштабирования для сред с несколькими клиентами. В этом случае одна инфраструктура используется для поддержки всех клиентов. Развертывания представляют группу ресурсов, которые определяют емкость размещенных предложений, например количество пользователей и количество транзакций. Эти единицы масштабирования увеличиваются или уменьшаются по запросу.

### <a name="csv-offering-injected-into-customer-subscription"></a>Внедрение предложений поставщиков облачных служб в подписку клиента
Вам может потребоваться развернуть программное обеспечение в подписки, принадлежащие клиентам. Вы можете использовать шаблоны для развертывания отдельных развертываний в клиентской учетной записи Azure.

Эти развертывания используют RBAC, поэтому вы можете обновлять развертывания и управлять ими в рамках учетной записи клиента.

### <a name="azure-marketplace"></a>Azure Marketplace
Если вы хотите рекламировать и продавать предложения через магазин (например, Azure Marketplace), можно разработать шаблоны для предоставления разных типов развертывания, которые будут выполняться в клиентской учетной записи Azure. Эти разные развертывания обычно можно описать с помощью "размеров футболки" (малый, средний, большой), типа продукта и аудитории (сообщество, разработчики, предприятие) или типа функции (базовый, высокий уровень доступности).  В некоторых случаях эти типы позволяют задавать несколько атрибутов развертывания, включая тип виртуальной машины или количество дисков.

## <a name="oss-projects"></a>Программные проекты с открытым исходным кодом
В рамках проектов с открытым исходным кодом шаблоны диспетчера ресурсов позволяют сообществам быстро развертывать решения с использованием проверенных методик. Шаблоны можно хранить в репозитории GitHub, чтобы участники сообщества могли изменять их со временем. Пользователи могут развертывать эти шаблоны в своих подписках Azure.

В следующих разделах описываются моменты, которые следует принять во внимание перед разработкой решения.

## <a name="identifying-what-is-outside-and-inside-a-vm"></a>Определение внутренних и внешних возможностей виртуальной машины
При разработке шаблона полезно оценивать требования ко внешним и внутренним характеристикам виртуальных машин.

* Внешние характеристики означают саму виртуальную машину и другие ресурсы развертывания, включая топологию сети, теги, ссылки на сертификаты и секреты, а также управление доступом на основе ролей. Все эти ресурсы являются частью шаблона.
* Внутренние характеристики включают установленное программное обеспечение и настройку требуемого состояния. Другие механизмы, включая расширения виртуальной машины или сценарии, используются целиком или частично. Шаблон может определять и выполнять эти механизмы, но только как внешние по отношению к себе объекты.

Среди наиболее распространенных примеров стандартных выполняемых действий:  

* установка и удаление ролей и компонентов сервера;
* установка и настройка программного обеспечения на уровне узла или кластера;
* развертывание веб-сайтов на веб-сервере;
* развертывание схем базы данных;
* управление реестром или другими типами параметров конфигурации;
* управление файлами и каталогами;
* запуск и остановка процессов и служб, а также управление ими;
* управление локальными группами и учетными записями пользователей;
* установка пакетов и управление ими (файлы MSI и ЕХЕ, yum и т. д.);
* настройка переменных среды;
* запуск собственных скриптов (Windows PowerShell, bash и т. д.).

### <a name="desired-state-configuration-dsc"></a>Настройка требуемого состояния
Внутреннее состояние виртуальных машин после развертывания предполагает выполнение проверки, которая определяет расхождения с конфигурацией, определенной и отправленной в систему управления версиями. Этот подход предотвращает появление ситуаций, когда разработчики или сотрудники вносят в среду ad-hoc-изменения, которые не были просмотрены, протестированы или записаны в системе управления версиями. Это важно, так как вносимые вручную изменения не регистрируются в системе управления версиями. Кроме того, что они не являются частью стандартного развертывания, такие изменения влияют на будущие автоматические развертывания программного обеспечения.

Помимо управления доступом внутренних сотрудников настройка требуемого состояния имеет большое значение для безопасности. Злоумышленники постоянно пытаются нарушить конфиденциальность и воспользоваться программными системами. Когда им это удается, они, как правило, устанавливают файлы или другим образом изменяют состояние системы, к которой они получили доступ. С помощью настройки требуемого состояния вы можете определить разницу между требуемым и фактическим состоянием, а также восстановить известную конфигурацию.

Существуют расширения ресурсов для самых популярных механизмов настройки требуемого состояния — PowerShell DSC, Puppet и Chef. Каждое из этих расширений может развернуть начальное состояние виртуальной машины. С их помощью также можно проверить, поддерживается ли требуемое состояние.

## <a name="common-template-scopes"></a>Общие области действия шаблона
На практике мы сталкиваемся с тремя ключевыми областями действия шаблонов. Эти три области, определяющие емкость, возможности и законченное решение, описаны в следующих разделах.

### <a name="capacity-scope"></a>Область определения емкости
Область определения емкости предоставляет набор ресурсов в стандартной топологии, который предварительно настроен в соответствии с правилами и политиками. Наиболее распространенный пример — это развертывание стандартной среды разработки в сценарии корпоративного ИТ-отдела или системного интегратора.

### <a name="capability-scope"></a>Область определения возможностей
Область определения возможностей фокусируется на развертывании и настройке топологии для данной технологии. Типичные сценарии включают такие технологии, как SQL Server, Cassandra, Hadoop и т. д.

### <a name="end-to-end-solution-scope"></a>Область законченного решения
Область законченного решения не ограничивается каким-то одним типом возможностей, а задает законченному решению набор возможностей.  

Область действия шаблона, определяющего решение, представляет собой некий набор. Этот набор состоит из одного или нескольких шаблонов, определяющих возможности, со специальными ресурсами, логикой и требуемым состоянием конкретного решения. Пример шаблона, определяющего решение, — шаблон законченного решения конвейера данных. Этот шаблон может сочетать топологию и состояние конкретного решения с несколькими шаблонами решений, определяющими возможности, включая Kafka, Storm и Hadoop.

## <a name="choosing-free-form-vs-known-configurations"></a>Конфигурации свободной формы и известные конфигурации
Может показаться, что использование шаблона обеспечивает клиентам наибольшую гибкость. Тем не менее, выбор между использованием конфигураций свободной формы или известных конфигураций зависит от множества факторов. В этом разделе указаны ключевые требования клиента и технические вопросы, которые формируют описанный в этом документе подход.

### <a name="free-form-configurations"></a>Конфигурации свободной формы
На первый взгляд, конфигурации свободной формы являются идеальным решением. Они позволяют выбрать тип виртуальной машины и использовать произвольное количество узлов и подключенных дисков для этих узлов, реализуя эти действия в качестве параметров шаблона. Тем не менее этот подход не подходит для некоторых сценариев.

В статье [Размеры виртуальных машин](../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) определяются разные типы виртуальных машин, доступные размеры и количество надежных дисков (2, 4, 8, 16 или 32), которые можно подключить. Каждый подключенный диск выполняет 500 операций ввода-вывода в секунду; несколько таких дисков могут быть объединены для увеличения этого показателя. Например, 16 объединенных дисков выполняют 8000 операций ввода-вывода в секунду. Настройка параметров объединения в операционной системе выполняется с помощью дисковых пространств (Майкрософт) в ОС Windows или избыточного массива независимых дисков (RAID) в ОС Linux.

Конфигурации свободной формы позволяют выбирать количество экземпляров виртуальных машин, количество разных типов виртуальных машин и размеры этих экземпляров, количество дисков по типу виртуальной машины, а также один или несколько сценариев для настройки содержимого виртуальной машины.

Чаще всего развертывание может иметь несколько типов узлов, включая главные узлы и узлы данных, поэтому гибкое использование обеспечивается для каждого типа узла.

Прежде чем развернуть кластер любой значимости, начните работу с этими сложными сценариями. Например, при развертывании кластера Hadoop с 8 главными узлами и 200 узлами данных, а также 4 объединенными дисками, подключенными к каждому главному узлу, и 16 объединенными дисками, подключенными к каждому узлу данных, вам необходимо управлять 208 виртуальными машинами и 3232 дисками.

Поскольку учетная запись хранения будет регулировать запросы, превышающие определенный лимит в 20 000 транзакций в секунду, рассмотрите возможность разделения учетной записи хранилища и использования вычислений, чтобы определить соответствующее количество учетных записей хранилища для размещения этой топологии. Учитывая множество сочетаний, поддерживаемых подходом с использованием свободной формы, для определения соответствующих разделов требуются динамические вычисления. Поскольку язык шаблона диспетчера ресурсов Azure в настоящее время не позволяет использовать математические функции, вам необходимо выполнить эти вычисления в коде, создав уникальный жестко заданный шаблон с соответствующими свойствами.

В сценариях корпоративных ИТ-отделов и системных интеграторов кто-то должен обслуживать шаблоны и обеспечивать поддержку для развернутых топологий для одной или нескольких организаций. Эти дополнительные издержки — наличие разных конфигураций и шаблонов для каждого клиента — сложно назвать идеальным вариантом.

Эти шаблоны можно использовать для развертывания сред в рамках подписки клиента Azure. Корпоративные ИТ-отделы и поставщики облачных служб обычно развертывают их в своих подписках, используя функцию взимания средств за использование для выставления счетов клиентам. Цель этих сценариев — развертывание ресурсов для нескольких клиентов в рамках пула подписок, а также плотное заполнение подписок развертываниями во избежание разрастания инфраструктуры, требующей управления. Из-за действительно динамических размеров развертывания реализация этого типа плотности требует тщательного планирования и дополнительной разработки для скаффолдинга от имени организации.

Более того, так как создавать подписки через вызов API невозможно, это необходимо делать на портале вручную. Разрастание инфраструктуры из-за роста количества подписок требует вмешательства пользователя. Это регулирование не может быть автоматизировано. Из-за большого разнообразия размеров развертываний вам потребуется выполнять предварительную подготовку множества подписок вручную для обеспечения их доступности.

Учитывая все эти факторы, конфигурации свободной формы являются в реальности менее привлекательным решением, чем на первый взгляд.

### <a name="known-configurations--the-t-shirt-sizing-approach"></a>Известные конфигурации — подход «размер футболки»
Распространенной альтернативой использованию шаблона, который обеспечивает гибкость и множество вариантов, является предоставление возможности выбора известных конфигураций. Фактически размеры песочницы определяются по аналогии со стандартными размерами футболки (малый, средний и большой). Другие примеры использования этого подхода включают такие продукты, как Community Edition или Enterprise Edition.  Другие случаи могут быть представлены конфигурациями технологий, зависящими от рабочей нагрузки, включая решения Map/Reduce или NoSQL.

Многие корпоративные ИТ-отделы, поставщики программного обеспечения с открытым исходным кодом и системные интеграторы предоставляют свои продукты локально, в виртуализованных средах (предприятия) или в качестве программного обеспечения как услуги (SaaS) (поставщики облачных служб и поставщики решений с открытым исходным кодом).

Такой подход позволяет использовать хорошие и известные конфигурации разных размеров, предварительно настроенные для клиентов. Если пользователи не используют известные конфигурации, им необходимо определять размеры кластеров самостоятельно, учитывая ограничения ресурсов платформы и выполняя математические вычисления для определения итогового разделения учетных записей хранилища и других ресурсов (из-за ограничений, связанных с размерами кластеров и ресурсами). Известные конфигурации позволяют пользователям легко выбирать нужный размер по аналогии с выбором размера футболки, в данном случае — конкретного развертывания. Кроме оптимизации возможностей для клиента, небольшое количество известных конфигураций также проще обслуживать. Кроме того, вы получаете более высокий уровень плотности.

Подход с применением известной конфигурации по методу «размер футболки» также характеризуется переменным количеством узлов одного размера. Например, «футболка» малого размера может включать от 3 до 10 узлов.  Подход «размер футболки» позволяет включать до 10 узлов, предоставляя клиенту возможность выбора свободной формы вплоть до максимального определенного размера.  

Задаваемый по этому методу размер, основывающийся на типе рабочей нагрузки, может иметь гораздо более произвольный характер с точки зрения количества узлов, которые могут быть развернуты. При этом вы получите определенный размер узла рабочей нагрузки и конфигурацию программного обеспечения, установленного на этом узле.

Зависящие от особенностей продукта (Community Edition или Enterprise Edition) «размеры футболки» могут включать разные типы ресурсов и максимальное количество узлов, которые могут быть развернуты. Обычно это связано с особенностями лицензирования или доступностью функций разных продуктов.

Вы также можете предложить клиентам уникальные варианты с использованием шаблонов на основе JSON. При работе с выбросами можно включить соответствующее планирование и рекомендации по разработке, поддержке и учету затрат.

Подход к декомпозиции шаблонов мы определили на основе сценариев использования шаблона клиентом, а также требований, описанных в начале этого документа.

## <a name="capacity-and-capability-scoped-solution-templates"></a>Шаблоны решений, определяющие емкость и возможности
Декомпозиция предоставляет модульный подход к разработке шаблонов, поддерживая возможности повторного использования, расширяемости, тестирования и применения средств. В этом разделе содержится подробное описание применения декомпозиции к шаблонам, определяющим возможности или емкость.

В рамках этого подхода основной шаблон получает значения параметров из шаблона клиента, связывая их затем с несколькими типами шаблонов и скриптами на более низком уровне, как показано ниже. Параметры, а также статические и созданные переменные используются для предоставления значений связанным шаблонам и за их пределами.

![Параметры шаблона](./media/best-practices-resource-manager-design-templates/template-parameters.png)

**Параметры передаются в основной шаблон, а затем в связанные шаблоны**

В следующих разделах подробно описаны типы шаблонов и скриптов, на которые можно разложить один шаблон. Кроме того, здесь рассматриваются подходы к передаче шаблонам сведений о состоянии. Каждый описанный тип шаблонов и скриптов приводится вместе с примерами. Контекстные примеры см. в разделе «Сборка: пример реализации» далее в этом документе.

### <a name="template-metadata"></a>Метаданные шаблона
Метаданные шаблона (файл metadata.json) содержат пары «ключ — значение», описывающие шаблон в формате JSON, который может быть прочитан человеком и программными системами.

![Метаданные шаблона](./media/best-practices-resource-manager-design-templates/template-metadata.png)

**Метаданные шаблона описываются в файле metadata.json**

Агенты программного обеспечения могут получить файл metadata.json и опубликовать сведения и ссылку на шаблон на веб-странице или в каталоге. Элементы включают: *itemDisplayName*, *description*, *summary*, *githubUsername* и *dateUpdated*.

Ниже приведен пример файла целиком.

    {
        "itemDisplayName": "PostgreSQL 9.3 on Ubuntu VMs",
        "description": "This template creates a PostgreSQL streaming-replication between a master and one or more slave servers each with 2 striped data disks. The database servers are deployed into a private-only subnet with one publicly accessible jumpbox VM in a DMZ subnet with public IP.",
        "summary": "PostgreSQL stream-replication with multiple slave servers and a publicly accessible jumpbox VM",
        "githubUsername": "arsenvlad",
        "dateUpdated": "2015-04-24"
    }

### <a name="main-template"></a>Основной шаблон
Основной шаблон получает параметры от пользователя, использует эти сведения для заполнения переменных сложного объекта, а также выполняет связанные шаблоны.

![Основной шаблон](./media/best-practices-resource-manager-design-templates/main-template.png)

**Основной шаблон получает параметры от пользователя**

Один из предоставляемых параметров — это тип известной конфигурации, также известный как параметр «размер футболки» из-за его стандартизированных значений (малый, средний и большой). На практике этот параметр можно использовать разными способами. Дополнительные сведения см. в разделе «Шаблоны ресурсов известной конфигурации» далее в этом документе.

Некоторые ресурсы развертываются независимо от известной конфигурации, задаваемой указанным пользователем параметром. Эти ресурсы настраиваются с помощью одного шаблона общих ресурсов и совместно используются другими шаблонами, при этом шаблон общих ресурсов выполняется первым.

Некоторые ресурсы будут развернуты при необходимости независимо от указанной известной конфигурации.

### <a name="shared-resources-template"></a>Шаблон общих ресурсов
Этот шаблон предоставляет ресурсы, которые являются общими для всех известных конфигураций. Он содержит виртуальную сеть, группы доступности и другие ресурсы, которые требуются независимо от развертываемого шаблона известной конфигурации.

![Ресурсы шаблона](./media/best-practices-resource-manager-design-templates/template-resources.png)

**Шаблон общих ресурсов**

Имена ресурсов, включая имя виртуальной сети, основываются на основном шаблоне. Можно указать их в качестве переменной в рамках этого шаблона или получить их в качестве параметра от пользователя в соответствии с требованиями вашей организации.

### <a name="optional-resources-template"></a>Шаблон дополнительных ресурсов
Шаблон дополнительных ресурсов содержит ресурсы, которые развертываются программным способом на основе значения параметра или переменной.

![Дополнительные ресурсы](./media/best-practices-resource-manager-design-templates/optional-resources.png)

**Шаблон дополнительных ресурсов**

Например, вы можете использовать шаблон дополнительных ресурсов для настройки основной виртуальной машины, предоставляющей непрямой доступ к развернутой среде из общедоступного сегмента Интернета. Параметр или переменную можно использовать, чтобы определить необходимость включения основной виртуальной машины и функции *concat* для создания целевого имени шаблона, такого как *jumpbox_enabled.json*. Для установки основной виртуальной машины связывание шаблона будет использовать результирующую переменную.

Вы можете связать шаблон дополнительных ресурсов из нескольких мест.

* Если это применимо, создавайте для каждого развертывания управляемую параметрами ссылку из шаблона общих ресурсов.
* Если это применимо, выбирайте известные конфигурации — например, устанавливайте решения только в больших развертываниях — создавайте управляемые параметрами или переменными ссылки из шаблона известной конфигурации.

Если данный ресурс является дополнительным, он может управляться не пользователем шаблона, а его поставщиком. Например, вам может потребоваться удовлетворить конкретные требования к продукту или его надстройке (поставщики облачных служб) либо соблюсти политики (системные интеграторы и корпоративные ИТ-отделы). В этих случаях можно использовать переменную, чтобы определить необходимость развертывания ресурса.

### <a name="known-configuration-resources-template"></a>Шаблон известной конфигурации ресурсов
В основном шаблоне параметр может быть доступен для предоставления пользователю шаблона возможности указывать требуемую известную конфигурацию для развертывания. Зачастую эта известная конфигурация использует подход "размер футболки" с набором фиксированных размеров конфигураций песочницы: малый, средний и большой.

![Ресурсы известной конфигурации](./media/best-practices-resource-manager-design-templates/known-config.png)

**Шаблон известной конфигурации ресурсов**

Подход «размер футболки» используется повсеместно; при этом параметры могут представлять любой набор известных конфигураций. Например, вы можете указать набор сред для корпоративного приложения, включая среды для разработки, тестирования и производства. Или же вы можете использовать его для облачной службы, чтобы представлять разные единицы масштабирования, версии или конфигурации продукта для сообщества, разработчиков или организаций.

Как и в случае с шаблоном общих ресурсов, переменные передаются шаблону известных конфигураций следующим образом.

* От конечного пользователя — параметры передаются основному шаблону.
* От организации — переменные в основном шаблоне представляют внутренние требования или политики.

### <a name="member-resources-template"></a>Шаблон элемента ресурсов
В известную конфигурацию часто включены один или несколько типов элементов узла. Например, при работе с Hadoop у вас есть основные узлы и узлы данных. При установке MongoDB у вас будут узлы данных и арбитр. При развертывании DataStax у вас будут узлы данных, а также ВМ с установленной службой OpsCenter.

![Ресурсы элементов](./media/best-practices-resource-manager-design-templates/member-resources.png)

**Шаблон элемента ресурсов**

Каждый тип узлов может иметь разные размеры виртуальной машины, некоторое количество подключенных дисков, скрипты для установки и настройки узлов, конфигурации порта для виртуальной машины, некоторое количество экземпляров и другие сведения. Поэтому каждый тип узла получает свой собственный шаблон элемента ресурсов, который содержит сведения о развертывании и настройке инфраструктуры, а также о выполнении скриптов для развертывания и настройки программного обеспечения в виртуальной машине.

Для виртуальной машины обычно используется два типа скриптов: повторно используемые и пользовательские.

### <a name="widely-reusable-scripts"></a>Повторно используемые скрипты
Повторно используемые скрипты можно использовать для нескольких типов шаблонов. Один из лучших примеров — повторное использование скриптов, настраивающих RAID в ОС Linux для объединения дисков и увеличения частоты операций ввода-вывода в секунду. Независимо от программного обеспечения, установленного в виртуальной машине, этот скрипт обеспечивает повторное использование проверенных методик для распространенных сценариев.

![Скрипты повторного использования](./media/best-practices-resource-manager-design-templates/reusable-scripts.png)

**Шаблоны элементов ресурсов могут вызывать повторно используемые скрипты**

### <a name="custom-scripts"></a>Пользовательские скрипты
Шаблоны часто вызывают один или несколько скриптов, отвечающих за установку и настройку программного обеспечения в виртуальной машине. Общий шаблон используется с большими топологиями, в которых развернуто несколько экземпляров одного или нескольких типов элементов. Скрипт установки инициируется для каждой виртуальной машины, которая может быть запущена параллельно. Затем выполняется скрипт установки, который вызывается после развертывания всех виртуальных машин (или всех виртуальных машин данного типа элемента).

![Пользовательские скрипты](./media/best-practices-resource-manager-design-templates/custom-scripts.png)

**Шаблоны элементов ресурсов могут вызывать скрипты для выполнения определенных задач, например, конфигурации виртуальной машины**

## <a name="capability-scoped-solution-template-example---redis"></a>Пример шаблона решения, определяющего возможности — Redis
В качестве примера работы реализации рассмотрим практический случай создания шаблона, который облегчает развертывание и настройку Redis с использованием стандартных "размеров футболки".  

Для развертывания доступен набор общих ресурсов (виртуальная сеть, учетная запись хранилища, группы доступности) и необязательные ресурсы (основная виртуальная машина). Существует несколько известных конфигураций, представленных в рамках подхода «размеры футболки» (малая, средняя, большая), каждая с одним типом узла. Кроме того, есть два соответствующих задаче скрипта (установка и настройка).

### <a name="creating-the-template-files"></a>Создание файлов шаблона
Будет создан основной шаблон с именем azuredeploy.json.

Создание шаблона общих ресурсов с именем resources.json

Создание шаблона дополнительных ресурсов, включающего развертывание основной виртуальной машины, с именем jumpbox_enabled.json

Redis использует только один тип узла, поэтому создается один шаблон элемента ресурсов с именем node-resources.json.

С помощью Redis необходимо установить каждый отдельный узел, а затем настроить кластер.  Для этого у вас есть соответствующие скрипты redis-cluster-install.sh и redis-cluster-setup.sh.

### <a name="linking-the-templates"></a>Связывание шаблонов
Вы можете связать основной шаблон с шаблоном общих ресурсов, который определяет виртуальную сеть.

Логика добавляется в основной шаблон, позволяя пользователям шаблона определять необходимость развертывания основной виртуальной машины. Значение *enabled* для параметра *EnableJumpbox* означает, что клиент хочет развернуть основную виртуальную машину. Если указано это значение, шаблон присоединяет значение *_enabled* в качестве суффикса к имени базового шаблона возможности основной виртуальной машины.

Основной шаблон присоединяет значение *large* в качестве суффикса к имени базового шаблона (по методу "размер футболки"), а затем использует это значение для связывания шаблона *technology_on_os_large.json*.

Пример топологии приведен на этом рисунке.

![Шаблон Redis](./media/best-practices-resource-manager-design-templates/redis-template.png)

**Структура шаблона для шаблона Redis**

### <a name="configuring-state"></a>Настройка состояния
Для узлов кластера существуют два этапа настройки состояния, представленные скриптами особого назначения.  Скрипт redis-cluster-install.sh выполнит установку Redis, а скрипт redis-cluster-setup.sh настроит кластер.

### <a name="supporting-different-size-deployments"></a>Поддержка развертываний разных размеров
Шаблон "размер футболки" определяет в переменных количество узлов для каждого типа развертывания указанного размера (*большой*). Он также развертывает соответствующее количество экземпляров виртуальной машины с помощью циклов ресурсов и предоставляет уникальные имена для ресурсов, добавляя имя узла с номером числовой последовательности из *copyIndex()*. Это происходит для виртуальных машин горячей и теплой зон в соответствии с определением имени шаблона "размер футболки".

## <a name="decomposition-and-end-to-end-solution-scoped-templates"></a>Декомпозиция и шаблоны законченных решений
Шаблон решения, определяющий законченные решения, отвечает за предоставление законченного решения.  Обычно такой шаблон представляет собой сочетание нескольких шаблонов заданных возможностей с дополнительными ресурсами, логикой и состоянием.

Как видно на рисунке ниже, одна и та же модель, используемая для шаблонов с заданными возможностями, расширяется для использования с шаблонами в рамках области законченного решения.

Шаблон общих ресурсов и шаблоны дополнительных ресурсов выполняют одинаковую функцию в рамках подходов с использованием шаблонов, определяющих емкость и возможности. При этом они ограничены областью применения законченного решения.

Поскольку шаблоны, определяющие законченные решения, как правило, также могут использовать подход «размер футболки», шаблон ресурсов известной конфигурации отражает требования к заданной известной конфигурации решения.

Шаблон ресурсов известной конфигурации свяжется с одним или несколькими шаблонами решения, определяющими возможности и относящимися к законченному решению, — как и шаблоны элементов ресурсов, которые необходимы для создания законченного решения.

Значение "размера футболки" решения может отличаться от размера отдельного шаблона, определяющего возможности. Поэтому переменные шаблона ресурсов известной конфигурации должны предоставить соответствующие значения для подчиненных шаблонов решений, определяющих возможности. Благодаря этому шаблоны развертывают правильный "размер футболки".

![Законченное решение](./media/best-practices-resource-manager-design-templates/end-to-end.png)

**Модель, используемую для шаблонов решений, определяющих возможности или емкость, можно легко расширить для областей действия шаблона, определяющих законченное решение**

## <a name="preparing-templates-for-the-marketplace"></a>Подготовка шаблонов для размещения в Marketplace
Описанный выше подход позволяет использовать сценарии, в рамках которых организации, системные интеграторы и поставщики облачных служб развертывают шаблоны самостоятельно или делегируют это развертывание своим пользователям.

Еще одним требуемым сценарием является развертывание шаблона через магазин.  Этот подход к декомпозиции также будет работать с магазином с некоторыми незначительными изменениями.

Как упоминалось ранее, шаблоны можно использовать, предлагая для продажи в магазине развертывания разных типов. Разные типы развертываний могут быть представлены разными "размерами футболки" (малый, средний, большой), типом продукта и аудитории (сообщества, разработчики, организации) или типом функции (базовый, высокий уровень доступности).

Как показано ниже, существующие шаблоны, определяющие законченные решения или возможности, можно легко использовать для создания в магазине списка различных известных конфигураций.

Параметры основного шаблона изменяются первыми для удаления входящего параметра с именем tshirtSize.

Во время сопоставления разных типов развертывания с шаблоном ресурсов известной конфигурации также необходимы общие ресурсы и конфигурация, включенные в шаблон общих ресурсов и, возможно, в шаблоны дополнительных ресурсов.

Чтобы опубликовать шаблон в магазине, установите отдельные копии общего шаблона, который заменяет ранее доступный входящий параметр tshirtSize переменной, внедренной в шаблон.

![Marketplace](./media/best-practices-resource-manager-design-templates/marketplace.png)

**Адаптация шаблона заданного решения к магазину**

## <a name="next-steps"></a>Дальнейшие действия
* Дополнительные сведения о состоянии общего доступа в рамках шаблонов и за их пределами см. в статье [Sharing state in Azure Resource Manager templates](best-practices-resource-manager-state.md) (Состояние общего доступа в шаблонах Azure Resource Manager).
* Руководство по использованию Resource Manager для эффективного управления подписками в организациях см [Azure enterprise scaffold - prescriptive subscription governance](resource-manager-subscription-governance.md) (Шаблон Azure для организаций. Рекомендуемая система управления подпиской).


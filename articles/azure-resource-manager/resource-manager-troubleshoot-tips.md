---
title: "Основные сведения об ошибках развертывания Azure | Документация Майкрософт"
description: "Сведения о том, как узнать об ошибках развертывания Azure."
services: azure-resource-manager
documentationcenter: 
tags: top-support-issue
author: tfitzmac
manager: timlt
editor: tysonn
keywords: "ошибка развертывания, развертывание Azure, развернуть в Azure"
ms.service: azure-resource-manager
ms.devlang: na
ms.topic: support-article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/12/2017
ms.author: tomfitz
ms.openlocfilehash: b67bb30fa259fa08e37e11afec724c8b8c3eb633
ms.sourcegitcommit: 422efcbac5b6b68295064bd545132fcc98349d01
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/29/2017
---
# <a name="understand-azure-deployment-errors"></a>Основные сведения об ошибках развертывания Azure
В этой статье описаны ошибки развертывания и объясняется, как можно получить подробности ошибки. Способы решения распространенных ошибок развертывания см. в статье [Устранение распространенных ошибок развертывания в Azure с помощью Azure Resource Manager](resource-manager-common-deployment-errors.md).

## <a name="two-types-of-errors"></a>Два типа ошибок
Существует два типа ошибок, которые могут произойти:

* ошибки проверки;
* ошибки развертывания.

На следующем рисунке показан журнал действий для подписки. Он представляет два развертывания. В одном развертывании шаблон не прошел проверку (**Проверить**) и не продолжил работу. В другом развертывании шаблон прошел проверку, но при создании ресурсов произошел сбой (**Write Deployments** (Запись развертываний)). 

![Отображение кода ошибки](./media/resource-manager-troubleshoot-tips/show-activity-log.png)

Ошибки проверки возникают в сценариях, которые можно определить перед развертыванием. Это синтаксические ошибки в шаблоне или попытки развертывания ресурсов, которые приведут к превышению квот для подписки. Ошибки развертывания возникают из-за условий, возникающих во время развертывания. Это попытки получить доступ к ресурсу, который развертывается параллельно.

Ошибки обоих типов возвращают код ошибки, с помощью которого можно устранить неполадки развертывания. Ошибки обоих типов отображаются в [журнале действий](resource-group-audit.md). Однако ошибки проверки не отображаются в журнале развертывания, так как при их наличии развертывание не запускается.

## <a name="determine-error-code"></a>Определение кода ошибки

Сведения об ошибке можно получить, взглянув на сообщение об ошибке и ее код. В статье [Устранение распространенных ошибок развертывания в Azure с помощью Azure Resource Manager](resource-manager-common-deployment-errors.md) перечислены решения по коду ошибок. Здесь показано, как обнаружить код ошибки на портале Azure.

### <a name="validation-errors"></a>Ошибки проверки

При развертывании через портал ошибка проверки появляется после отправки значений.

![Показ ошибки проверки через портал](./media/resource-manager-troubleshoot-tips/validation-error.png)

Выберите сообщение для получения дополнительных сведений. На следующем изображении показана ошибка **InvalidTemplateDeployment** и сообщение, которое указывает, что развертывание заблокировано политикой.

![Отображение сведений о проверке](./media/resource-manager-troubleshoot-tips/validation-details.png)

### <a name="deployment-errors"></a>Ошибки развертывания

Если операция прошла проверку, но завершилась ошибкой во время развертывания, вы увидите ошибку в уведомлениях. Выберите уведомление.

![уведомление об ошибке](./media/resource-manager-troubleshoot-tips/notification.png)

Вы увидите больше сведений о развертывании. Щелкните область уведомления, чтобы получить дополнительные сведения об ошибке.

![сбой развертывания](./media/resource-manager-troubleshoot-tips/deployment-failed.png)

Вы увидите сообщение об ошибке и ее коды. Обратите внимание, что имеется два кода ошибки. Первый код ошибки (**DeploymentFailed**) является общей ошибкой, которая не содержит сведений, необходимых для ее устранения. Второй код ошибки (**StorageAccountNotFound**) предоставляет необходимые сведения. 

![Сведения об ошибке](./media/resource-manager-troubleshoot-tips/error-details.png)

## <a name="enable-debug-logging"></a>Включение ведения журнала отладки
Иногда требуются дополнительные сведения о запросе и ответе, чтобы понять, что пошло не так. С помощью PowerShell или Azure CLI вы можете запросить, чтобы во время развертывания в журнал записывались дополнительные сведения.

- PowerShell

   В PowerShell для параметра **DeploymentDebugLogLevel** задайте значение All, ResponseContent или RequestContent.

  ```powershell
  New-AzureRmResourceGroupDeployment -ResourceGroupName examplegroup -TemplateFile c:\Azure\Templates\storage.json -DeploymentDebugLogLevel All
  ```

   Проверьте содержимое запроса с помощью следующего командлета.

  ```powershell
  (Get-AzureRmResourceGroupDeploymentOperation -DeploymentName storageonly -ResourceGroupName startgroup).Properties.request | ConvertTo-Json
  ```

   Или проверьте содержимое ответа, выполнив команду, указанную ниже.

  ```powershell
  (Get-AzureRmResourceGroupDeploymentOperation -DeploymentName storageonly -ResourceGroupName startgroup).Properties.response | ConvertTo-Json
  ```

   Эти сведения помогут определить, правильно ли задано то или иное значение в шаблоне.

- Инфраструктура CLI Azure

   Для просмотра операций развертывания выполните следующую команду.

  ```azurecli
  az group deployment operation list --resource-group ExampleGroup --name vmlinux
  ```

- Вложенный шаблон

   Чтобы вести журнал отладочной информации для вложенного шаблона, используйте элемент **debugSetting**.

  ```json
  {
      "apiVersion": "2016-09-01",
      "name": "nestedTemplate",
      "type": "Microsoft.Resources/deployments",
      "properties": {
          "mode": "Incremental",
          "templateLink": {
              "uri": "{template-uri}",
              "contentVersion": "1.0.0.0"
          },
          "debugSetting": {
             "detailLevel": "requestContent, responseContent"
          }
      }
  }
  ```


## <a name="create-a-troubleshooting-template"></a>Создание шаблона для устранения неполадок
В некоторых случаях устранить неполадки шаблона проще всего, проверяя его части. Можно создавать упрощенный шаблон, позволяющий сосредоточиться на части, которая, как вы считаете, вызывает ошибку. Для примера предположим, что вы получили сообщение об ошибке при указании ссылки на ресурс. Вместо того, чтобы проверять весь шаблон, создайте шаблон, возвращающий часть, которая может быть причиной проблемы. Это поможет определить, передаются ли правильные параметры, правильно ли используются функции шаблона и получается ли ожидаемый ресурс.

```json
{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "storageName": {
        "type": "string"
    },
    "storageResourceGroup": {
        "type": "string"
    }
  },
  "variables": {},
  "resources": [],
  "outputs": {
    "exampleOutput": {
        "value": "[reference(resourceId(parameters('storageResourceGroup'), 'Microsoft.Storage/storageAccounts', parameters('storageName')), '2016-05-01')]",
        "type" : "object"
    }
  }
}
```

Или предположим, что возникают ошибки развертывания, которые, как вы считаете, связаны с неправильно заданными зависимостями. Проверьте шаблон, разбив его на более простые шаблоны. Сначала создайте шаблон, который развертывает только один ресурс (например, SQL Server). Когда вы убедитесь, что этот ресурс определен правильно, добавьте зависящий от него ресурс (например, базу данных SQL). Проверив правильность определения этих двух ресурсов, добавьте другие зависимые ресурсы (например, политики аудита). В перерывах между тестовыми развертываниями удаляйте группу ресурсов, чтобы гарантировать адекватную проверку зависимостей. 

## <a name="check-deployment-sequence"></a>Проверка последовательности развертывания

Многие ошибки развертывания происходят, когда ресурсы развертываются в непредвиденном порядке. Такие ошибки возникают, когда зависимости заданы неправильно. Если необходимая зависимость отсутствует, то один ресурс может пытаться использовать значение другого ресурса, который еще не существует. Произойдет ошибка и отобразится сообщение о том, что ресурс не найден. Такие ошибки могут происходить время от времени, так как время развертывания каждого ресурса может отличаться. Например, первая попытка развернуть ресурсы может завершиться успешно, так как требуемый ресурс случайно будет развернут в срок. Однако вторая попытка может завершиться сбоем, так как необходимый ресурс не будет развернут вовремя. 

Но следует избегать задания ненужных зависимостей. Ненужные зависимости могут замедлить развертывание, мешая параллельному развертыванию независимых между собой ресурсов. Кроме того, возможно образование циклических зависимостей, которые блокируют развертывание. Функция [reference](resource-group-template-functions-resource.md#reference) создает неявную зависимость от ресурса, на который указывает ссылка, когда этот ресурс развертывается в том же шаблоне. Таким образом можно использовать больше зависимостей, чем задано в свойстве **dependsOn**. Функция [ResourceId](resource-group-template-functions-resource.md#resourceid) не создает неявную зависимость и не проверяет, существует ли ресурс.

При возникновении проблем с зависимостями необходимо узнать, в каком порядке развертываются ресурсы. Вот как можно просмотреть порядок операций развертывания.

1. Выберите журнал развертывания для группы ресурсов.

   ![Выбор журнала развертывания](./media/resource-manager-troubleshoot-tips/select-deployment.png)

2. Выберите развертывание в журнале, затем выберите **События**.

   ![Выбор событий развертывания](./media/resource-manager-troubleshoot-tips/select-deployment-events.png)

3. Изучите последовательность событий для каждого ресурса. Обратите внимание на состояние каждой операции. Например, на следующем рисунке показаны три учетные записи хранения, которые были развернуты параллельно. Обратите внимание, что эти три учетные записи хранения были запущены одновременно.

   ![Параллельное развертывание](./media/resource-manager-troubleshoot-tips/deployment-events-parallel.png)

   На следующем рисунке показаны три учетные записи хранения, которые не были развернуты параллельно. Вторая учетная запись хранения зависит от первой учетной записи хранения, а третья учетная запись хранения — от второй. Поэтому первая учетная запись хранения должна быть запущена, принята и завершена, прежде чем будет запущена следующая.

   ![Последовательное развертывание](./media/resource-manager-troubleshoot-tips/deployment-events-sequence.png)

Даже для более сложных сценариев можно использовать тот же метод, чтобы определять, когда начинается и завершается развертывание каждого из ресурсов. Просмотрите события развертывания, чтобы узнать, не была ли нарушена ожидаемая последовательность развертывания. Если какой-либо ресурс нарушил ее, проверьте его зависимости.

Resource Manager выявляет циклические зависимости во время проверки шаблона. Он возвращает сообщение об ошибке, в котором специально сообщается о наличии циклической зависимости. Устранить циклическую зависимость можно следующим образом.

1. Найдите в шаблоне ресурс, указанный в циклической зависимости. 
2. Изучите свойство **dependsOn** и все случаи использования функции **reference** для этого ресурса, чтобы узнать, от каких ресурсов он зависит. 
3. Изучите эти ресурсы, чтобы узнать, от каких ресурсов зависят они. Отслеживайте зависимости, пока не найдете ресурс, который зависит от первоначального ресурса.
5. Для ресурсов, участвующих в циклической зависимости, тщательно изучите все случаи использования свойства **dependsOn**, чтобы выявить все лишние зависимости. Удалите эти зависимости. Если вы не уверены, нужна ли зависимость, попробуйте удалить ее. 
6. Повторно разверните шаблон.

Удаление значений из свойства **dependsOn** может привести к ошибкам при развертывании шаблона. Если возникла ошибка, верните удаленную зависимость в шаблон. 

Если этот подход не помог устранить циклическую зависимость, рекомендуется переместить часть логики развертывания в дочерние ресурсы (например, расширения или параметры конфигурации). Настройте эти дочерние ресурсы для развертывания после ресурсов, участвующих в циклической зависимости. Предположим, что вы развертываете две виртуальные машины, но на каждой из них необходимо задать свойства, которые ссылаются на другую виртуальную машину. Их можно развернуть в следующем порядке.

1. vm1.
2. vm2.
3. Расширение на vm1 зависит от vm1 и vm2. Расширение задает на vm1 значения, получаемые от vm2.
4. Расширение на vm2 зависит от vm1 и vm2. Расширение задает на vm2 значения, получаемые от vm1.

Этот подход пригоден и для приложений службы приложений. Рекомендуется переместить значения конфигурации в дочерний ресурс ресурса приложения. Два веб-приложения можно развернуть в следующем порядке.

1. webapp1.
2. webapp2.
3. Конфигурация webapp1 зависит от webapp1 и webapp2. Она содержит параметры приложения со значениями из webapp2.
4. Конфигурация webapp2 зависит от webapp1 и webapp2. Она содержит параметры приложения со значениями из webapp1.


## <a name="next-steps"></a>Дальнейшие действия
* Способы решения распространенных ошибок развертывания см. в статье [Устранение распространенных ошибок развертывания в Azure с помощью Azure Resource Manager](resource-manager-common-deployment-errors.md).
* Сведения о действиях аудита см. в статье [Операции аудита с помощью Resource Manager](resource-group-audit.md).
* Дополнительные сведения об определении ошибок во время развертывания см. в статье [Просмотр операций развертывания с помощью портала Azure](resource-manager-deployment-operations.md).

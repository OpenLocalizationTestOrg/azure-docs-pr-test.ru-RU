---
title: "Локальный шлюз данных | Документация Майкрософт"
description: "Локальный шлюз данных необходим тогда, когда сервер служб Analysis Services в Azure будет подключен к локальным источникам данных."
services: analysis-services
documentationcenter: 
author: minewiskan
manager: kfile
editor: 
tags: 
ms.assetid: cd596155-b608-4a34-935e-e45c95d884a9
ms.service: analysis-services
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: na
ms.date: 10/30/2017
ms.author: owend
ms.openlocfilehash: 0b11c005ddcf4a3416104e7cef39a7ce97957ba3
ms.sourcegitcommit: d41d9049625a7c9fc186ef721b8df4feeb28215f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/02/2017
---
# <a name="connecting-to-on-premises-data-sources-with-azure-on-premises-data-gateway"></a>Подключение к локальным источникам данных с помощью локального шлюза данных Azure
Локальный шлюз данных действует как мост, обеспечивая передачу данных между локальными источниками данных и серверами служб Azure Analysis Services в облаке. Последняя версия шлюза работает с несколькими серверами служб Azure Analysis Services в том же регионе, а также с Azure Logic Apps, Power BI, Power Apps и Microsoft Flow. Несколько служб в одном регионе можно связать с одним шлюзом. 

Впервые процесс установки с помощью шлюза проходит в четыре этапа:

- **Скачивание и запуск программы установки.** На этом шаге устанавливается служба шлюза на компьютер организации. Войдите в Azure с помощью учетной записи своего [клиента](https://msdn.microsoft.com/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant) Azure AD. Учетные записи Azure B2B (гостевые) не поддерживаются.

- **Регистрация шлюза.** На этом шаге следует указать имя и ключ восстановления для шлюза и выбрать регион. Таким образом шлюз регистрируется в облачной службе шлюза. Ресурс шлюза **должен быть зарегистрирован в том же регионе**, что и серверы служб Analysis Services. 

- **Создание ресурса шлюза в Azure.** На этом шаге необходимо создать ресурс шлюза в подписке Azure.

- **Подключение серверов к ресурсу шлюза.** После получения ресурса шлюза в подписке можно начать подключение к нему серверов. Вы можете подключить несколько серверов и другие ресурсы к ним, если они находятся в одном регионе.

Чтобы начать работу прямо сейчас, см. статью [Установка и настройка локального шлюза данных](analysis-services-gateway-install.md).

## <a name="how-it-works"> </a>Принцип работы
Установленный на компьютере в вашей организации шлюз работает как служба Windows, **локальный шлюз данных**. Эта локальная служба зарегистрирована в облачной службе шлюза с помощью служебной шины Azure. Затем создается ресурс шлюза в службе Gateway Cloud для подписки Azure. После этого серверы служб Azure Analysis Services уже подключены к ресурсу шлюза. Если моделям вашего сервера необходимо подключиться к локальным источникам данных для запросов или обработки, запрос и поток данных проходит через ресурс шлюза, служебную шину Azure, локальную службу локального шлюза данных и источники данных. 

![Принцип работы](./media/analysis-services-gateway/aas-gateway-how-it-works.png)

Запросы и поток данных

1. Облачная служба создает запрос с зашифрованными учетными данными для локального источника. Затем запрос отправляется в очередь, чтобы его обработал шлюз.
2. Облачная служба шлюза анализирует запрос и отправляет его в [служебную шину Azure](https://azure.microsoft.com/documentation/services/service-bus/).
3. Локальный шлюз данных опрашивает служебную шину Azure, чтобы проверить наличие ожидающих запросов.
4. Шлюз получает запрос, расшифровывает учетные данные и подключается к источникам данных, используя эти учетные данные.
5. Затем шлюз отправляет запрос к источнику данных для выполнения.
6. Результаты отправляются из источника данных обратно в шлюз, а затем в облачную службу и на сервер.

## <a name="windows-service-account"> </a>Учетная запись службы Windows
Локальный шлюз данных настроен для использования *NT SERVICE\PBIEgwService* в качестве учетных данных для входа службы Windows. По умолчанию у него есть право входа в систему в качестве службы в контексте компьютера, на котором устанавливается шлюз. Эти учетные данные не принадлежат той же учетной записи, которая используется для подключения к локальным источникам данных или к учетной записи Azure.  

При возникновении проблем с прокси-сервером из-за проверки подлинности можно изменить учетную запись службы Windows на учетную запись пользователя домена или управляемую запись службы.

## <a name="ports"> </a>Порты
Шлюз создает исходящее подключение к служебной шине Azure. Он обменивается данными через исходящие порты: TCP 443 (по умолчанию), а также 5671, 5672 и 9350–9354.  Шлюзу не требуются входящие порты.

Мы рекомендуем добавить IP-адреса для области данных в список разрешений вашего брандмауэра. Вы можете скачать [список IP-адресов центра обработки данных Microsoft Azure](https://www.microsoft.com/download/details.aspx?id=41653). Список обновляется раз в неделю.

> [!NOTE]
> IP-адреса, перечисленные в списке центра обработки данных Azure, находятся в нотации CIDR. Например, 10.0.0.0/24 не означает 10.0.0.0–10.0.0.24. Дополнительные сведения о нотации CIDR см. [здесь](http://whatismyipaddress.com/cidr).
>
>

Ниже приведены полные доменные имена, которые используются шлюзом.

| Имена доменов | Исходящие порты | Description (Описание) |
| --- | --- | --- |
| *.powerbi.com |80 |HTTP для скачивания установщика. |
| *.powerbi.com |443 |HTTPS |
| *.analysis.windows.net |443 |HTTPS |
| *.login.windows.net |443 |HTTPS |
| *.servicebus.windows.net |5671–5672 |Протокол AMQP |
| *.servicebus.windows.net |443, 9350–9354 |Прослушиватели ретрансляции служебной шины по протоколу TCP (порт 443 требуется для получения маркера контроля доступа). |
| *.frontend.clouddatahub.net |443 |HTTPS |
| *.core.windows.net |443 |HTTPS |
| login.microsoftonline.com |443 |HTTPS |
| *.msftncsi.com |443 |Используется для проверки подключения к Интернету, если шлюз недоступен для службы Power BI. |
| *.microsoftonline-p.com |443 |Используется для проверки подлинности в зависимости от конфигурации. |

### <a name="force-https"></a>Принудительное взаимодействие протокола HTTPS со служебной шиной Azure
Можно настроить шлюз для принудительного использования протокола HTTPS для связи со служебной шиной Azure вместо прямого подключения TCP. Однако это может значительно снизить производительность. Для этого можно отредактировать файл *Microsoft.PowerBI.DataMovement.Pipeline.GatewayCore.dll.config*, изменив значение `AutoDetect` на `Https`. Обычно этот файл находится в расположении *C:\Program Files\On-premises data gateway*.

```
<setting name="ServiceBusSystemConnectivityModeString" serializeAs="String">
    <value>Https</value>
</setting>
```

## <a name="faq"></a>Часто задаваемые вопросы

### <a name="general"></a>Общие сведения

**Вопрос**. Нужно ли устанавливать шлюз для источников данных в облаке, например для базы данных SQL Azure? <br/>
**Ответ**. Нет. Шлюз необходим для подключения только к локальным источникам данных.

**Вопрос**. Нужно ли устанавливать шлюз на том же компьютере, на котором находится источник данных? <br/>
**Ответ**. Нет. Для шлюза требуется только возможность подключения к серверу (как правило, в пределах той же сети).

<a name="why-azure-work-school-account"></a>

**Вопрос.** Почему для входа необходимо использовать рабочую или учебную учетную запись Azure? <br/>
**Ответ.** При установке локального шлюза данных вы можете использовать только рабочую или учебную учетную запись организации. Учетная запись должна быть в том же клиенте, что и подписка, в которой вы настраиваете ресурса шлюза. Учетная запись для входа хранится в клиенте, которым управляет Azure Active Directory (Azure AD). Как правило, имя участника-пользователя учетной записи Azure AD совпадает с адресом электронной почты.

**Вопрос**. Где хранятся мои учетные данные? <br/>
**Ответ.** Учетные данные, введенные для источника данных, хранятся в облачной службе шлюза в зашифрованном виде. Расшифровываются они в локальном шлюзе данных.

**Вопрос**. Есть ли какие-либо требования к пропускной способности сети? <br/>
**Ответ.** Пропускная способность сети должна быть высокой. Все среды разные и объем отправляемых данных влияет на результаты. Гарантировать определенный уровень пропускной способности между локальной средой и центрами обработки данных Azure может помочь применение ExpressRoute.
Измерить текущую пропускную способность можно с помощью стороннего инструмента — приложения Azure Speed Test.

**Вопрос**. Что такое задержка при выполнении запросов к источнику данных из шлюза? Какая архитектура подойдет лучше всего? <br/>
**Ответ**. Чтобы уменьшить задержки в сети, необходимо установить шлюз как можно ближе к источнику данных. Вы можете установить шлюз на фактический источник данных, что сведет к минимуму соответствующие задержки. Для этого также стоит рассмотреть центры обработки данных. Например, если служба использует центр обработки данных в западной части США, а SQL Server размещен на виртуальной машине Azure, то эту виртуальную машину лучше также разместить в западной части США. Это позволит свести к минимуму задержки и избежать затрат на исходящий трафик виртуальной машины Azure.

**Вопрос**. Как результаты отправляются обратно в облако? <br/>
**Ответ**. Результаты отправляются с помощью служебной шины Azure.

**Вопрос**. Устанавливаются ли какие-либо входящие подключения к шлюзу из облака? <br/>
**Ответ**. Нет. Шлюз использует исходящие подключения к служебной шине Azure.

**Вопрос**. Что делать, если мной заблокированы исходящие подключения? Что нужно открыть? <br/>
**Ответ**. Проверьте порты и узлы, которые использует шлюз.

**Вопрос**. Как на самом деле называется служба Windows?<br/>
**Ответ**. В списке служб шлюз называется службой локального шлюза данных.

**Вопрос**. Может ли служба Windows шлюза работать с учетной записью Azure Active Directory? <br/>
**Ответ**. Нет. Службе Windows требуется действительная учетная запись Windows. По умолчанию служба будет выполняться с идентификатором безопасности службы NT SERVICE\PBIEgwService.

**Вопрос**. Как перехватить шлюз? <br/>
**Ответ**. Чтобы перехватить шлюз (запустив установку или изменение в разделе "Панель управления" > "Программы"), необходимо быть владельцем ресурса шлюза в Azure и иметь ключ восстановления. Владельцы ресурса шлюза настраиваются в разделе управления доступом.

### <a name="high-availability"></a>Высокий уровень доступности и аварийное восстановление

**Вопрос**. Какие варианты доступны для аварийного восстановления? <br/>
**Ответ**. Вы можете использовать ключ восстановления для восстановления или переноса шлюза. Ключ восстановления указывается при установке шлюза.

**Вопрос**. В чем заключается преимущество ключа восстановления? <br/>
**Ответ.** Он позволяет перенести шлюз или восстановить его параметры после аварии.

## <a name="troubleshooting"> </a>Устранение неполадок

**Вопрос**. Почему я не вижу свой шлюз в списке экземпляров шлюза при попытке создать ресурс шлюза в Azure? <br/>
**Ответ**. Есть две возможные причины. Первая — для шлюза уже создан ресурс в текущей или какой-либо другой подписке. Чтобы исключить такую возможность, перечислите ресурсы типа **Локальные шлюзы данных** на портале. При перечислении всех ресурсов обязательно выберите все подписки. Обратите внимание, что после создания ресурса шлюз не отображается в списке экземпляров шлюза на странице создания ресурса шлюза на портале. Вторая возможная причина — удостоверение Azure AD пользователя, установившего шлюз, отличается от удостоверения пользователя, вошедшего на портал Azure. Чтобы устранить эту проблему, войдите на портал, используя учетную запись пользователя, установившего шлюз.

**Вопрос**. Как узнать, какие запросы отправляются к локальному источнику данных? <br/>
**Ответ**. Вы можете включить трассировку запросов, в том числе и отправляемых. Не забудьте вернуть исходное значение трассировки запросов после устранения неполадок. При включенной трассировке запросов создаются журналы большего размера.

Кроме того, можно рассмотреть инструменты трассировки запросов, доступные для вашего источника данных. Например, можно использовать расширенные события или SQL Profiler для SQL Server и служб Analysis Services.

**Вопрос**. Где находятся журналы шлюза? <br/>
**Ответ.** См. раздел "Журналы" далее в этой статье.

### <a name="update"></a>Обновление до последней версии

При использовании устаревшей версии шлюза может возникать ряд проблем. Рекомендуем убедиться, что используется последняя версия. Если шлюз не обновлялся месяц или дольше, то можно установить его последнюю версию и проверить, получится ли воспроизвести проблему.

### <a name="error-failed-to-add-user-to-group--2147463168-pbiegwservice-performance-log-users"></a>Error: Failed to add user to group. (Ошибка: не удалось добавить пользователя в группу.) (-2147463168 PBIEgwService Performance Log Users ) (-2147463168 пользователей журналов производительности PBIEgwService)

Эта ошибка появляется, если вы пытаетесь установить шлюз на контроллер домена, который не поддерживается. Убедитесь, что развертывание шлюза происходит на компьютере, который не является контроллером домена.

## <a name="logs"></a>Журналы

Файлы журналов являются важным ресурсом при устранении неполадок.

#### <a name="enterprise-gateway-service-logs"></a>Журналы службы корпоративного шлюза

`C:\Users\PBIEgwService\AppData\Local\Microsoft\On-premises data gateway\<yyyyymmdd>.<Number>.log`

#### <a name="configuration-logs"></a>Журналы конфигурации

`C:\Users\<username>\AppData\Local\Microsoft\On-premises data gateway\GatewayConfigurator.log`




#### <a name="event-logs"></a>Журналы событий

Журналы шлюза управления данными и PowerBIGateway находятся в разделе **Журналы приложения и служб**.


## <a name="telemetry"></a>Телеметрия
Телеметрию можно использовать для мониторинга и устранения неполадок. По умолчанию

**Включение телеметрии**

1.  Проверьте клиентский каталог локального шлюза данных на компьютере. Обычно это каталог **%системный_диск%\Program Files\On-premises data gateway**. Кроме того, можно открыть консоль "Службы" и проверить свойство "Путь доступа к исполняемому файлу" для службы локального шлюза данных.
2.  В файле Microsoft.PowerBI.DataMovement.Pipeline.GatewayCore.dll.config в каталоге клиента выполните указанные ниже действия. Измените значение параметра SendTelemetry на true.
        
    ```
        <setting name="SendTelemetry" serializeAs="String">
                    <value>true</value>
        </setting>
    ```

3.  Сохраните изменения и перезапустите службу Windows "Локальный шлюз данных".




## <a name="next-steps"></a>Дальнейшие действия
* [Установка и настройка локального шлюза данных](analysis-services-gateway-install.md)   
* [Управление службами Analysis Services](analysis-services-manage.md)
* [Получение данных из служб Azure Analysis Services](analysis-services-connect.md)

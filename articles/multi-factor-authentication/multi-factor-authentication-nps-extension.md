---
title: "aaaUse существующие NPS серверов tooprovide многофакторной проверки Подлинности Azure возможности | Документы Microsoft"
description: "Hello расширение сервера политики сети для многофакторной проверки подлинности Azure является простым решением tooadd облачного двухэтапный vericiation возможности tooyour существующую инфраструктуру проверки подлинности."
services: multi-factor-authentication
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/14/2017
ms.author: kgremban
ms.reviewer: yossib
ms.custom: H1Hack27Feb2017; it-pro
ms.openlocfilehash: e9fc495b06873d45f06233f1aa618db9d94f8bd9
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="integrate-your-existing-nps-infrastructure-with-azure-multi-factor-authentication"></a><span data-ttu-id="31514-103">Интеграция существующей инфраструктуры NPS с Многофакторной идентификацией Azure</span><span class="sxs-lookup"><span data-stu-id="31514-103">Integrate your existing NPS infrastructure with Azure Multi-Factor Authentication</span></span>

<span data-ttu-id="31514-104">Hello расширение сервера политики сети (NPS) для многофакторной проверки Подлинности Azure добавляет облачного многофакторной проверки Подлинности возможности tooyour инфраструктуры проверки подлинности с помощью существующие серверы.</span><span class="sxs-lookup"><span data-stu-id="31514-104">hello Network Policy Server (NPS) extension for Azure MFA adds cloud-based MFA capabilities tooyour authentication infrastructure using your existing servers.</span></span> <span data-ttu-id="31514-105">Hello расширения сервера политики сети можно добавить телефонный звонок, текстовое сообщение или phone app проверки tooyour существующий поток проверки подлинности без необходимости tooinstall, настраивать и обслуживать новые серверы.</span><span class="sxs-lookup"><span data-stu-id="31514-105">With hello NPS extension, you can add phone call, text message, or phone app verification tooyour existing authentication flow without having tooinstall, configure, and maintain new servers.</span></span> 

<span data-ttu-id="31514-106">Этот модуль был создан для организаций, которые планируют tooprotect VPN-подключений, не развертывая hello Azure многофакторной проверки Подлинности сервера.</span><span class="sxs-lookup"><span data-stu-id="31514-106">This extension was created for organizations that want tooprotect VPN connections without deploying hello Azure MFA Server.</span></span> <span data-ttu-id="31514-107">Hello расширения сервера политики сети выступает в качестве адаптера между RADIUS и облачного tooprovide многофакторной проверки Подлинности Azure второй фактор проверки подлинности для федеративной или синхронизированных пользователей.</span><span class="sxs-lookup"><span data-stu-id="31514-107">hello NPS extension acts as an adapter between RADIUS and cloud-based Azure MFA tooprovide a second factor of authentication for federated or synced users.</span></span>

<span data-ttu-id="31514-108">При использовании модуля политики сети hello многофакторной проверки подлинности Azure, процесс проверки подлинности hello включает hello следующие компоненты:</span><span class="sxs-lookup"><span data-stu-id="31514-108">When using hello NPS extension for Azure MFA, hello authentication flow includes hello following components:</span></span> 

1. <span data-ttu-id="31514-109">**NAS или VPN-сервер** получает запросы от VPN-клиентов и преобразует их в запросы RADIUS-серверов tooNPS.</span><span class="sxs-lookup"><span data-stu-id="31514-109">**NAS/VPN Server** receives requests from VPN clients and converts them into RADIUS requests tooNPS servers.</span></span> 
2. <span data-ttu-id="31514-110">**Сервер политики сети** подключается tooActive Directory tooperform hello основной проверки подлинности для hello RADIUS запросы и при успешном завершении передает hello запроса tooany установлены расширения.</span><span class="sxs-lookup"><span data-stu-id="31514-110">**NPS Server** connects tooActive Directory tooperform hello primary authentication for hello RADIUS requests and, upon success, passes hello request tooany installed extensions.</span></span>  
3. <span data-ttu-id="31514-111">**Расширение NPS** запускает запрос tooAzure многофакторной проверки Подлинности для hello вторичной проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="31514-111">**NPS Extension** triggers a request tooAzure MFA for hello secondary authentication.</span></span> <span data-ttu-id="31514-112">После расширения hello получает ответ hello и hello многофакторной проверки Подлинности запроса выполняется успешно, он завершает запрос проверки подлинности hello, предоставляя hello NPS-сервера с маркерами безопасности, включающие утверждение многофакторной проверки Подлинности, выданного службой маркеров безопасности Azure.</span><span class="sxs-lookup"><span data-stu-id="31514-112">Once hello extension receives hello response, and if hello MFA challenge succeeds, it completes hello authentication request by providing hello NPS server with security tokens that include an MFA claim, issued by Azure STS.</span></span>  
4. <span data-ttu-id="31514-113">**Azure MFA** связывается с сведения о пользователе для Azure Active Directory tooretrieve hello и выполняет hello вторичной проверки подлинности, использовать метод настроенный toohello проверки пользователя.</span><span class="sxs-lookup"><span data-stu-id="31514-113">**Azure MFA** communicates with Azure Active Directory tooretrieve hello user’s details and performs hello secondary authentication using a verification method configured toohello user.</span></span>

<span data-ttu-id="31514-114">Привет, следующая схема иллюстрирует этот процесс высокого уровня проверки подлинности запроса:</span><span class="sxs-lookup"><span data-stu-id="31514-114">hello following diagram illustrates this high-level authentication request flow:</span></span> 

![Схема последовательности проверки подлинности](./media/multi-factor-authentication-nps-extension/auth-flow.png)

## <a name="plan-your-deployment"></a><span data-ttu-id="31514-116">Планирование развертывания</span><span class="sxs-lookup"><span data-stu-id="31514-116">Plan your deployment</span></span>

<span data-ttu-id="31514-117">Hello расширения NPS автоматически обрабатывает избыточности, вам требуется специальной конфигурации.</span><span class="sxs-lookup"><span data-stu-id="31514-117">hello NPS extension automatically handles redundancy, so you don't need a special configuration.</span></span>

<span data-ttu-id="31514-118">Можно создать столько NPS-серверов с поддержкой Azure MFA, сколько требуется.</span><span class="sxs-lookup"><span data-stu-id="31514-118">You can create as many Azure MFA-enabled NPS servers as you need.</span></span> <span data-ttu-id="31514-119">При установке нескольких серверов для каждого из них следует использовать отдельный сертификат клиента.</span><span class="sxs-lookup"><span data-stu-id="31514-119">If you do install multiple servers, you should use a difference client certificate for each one of them.</span></span> <span data-ttu-id="31514-120">Создание сертификата для каждого сервера означает, что можно обновлять каждый сертификат по отдельности и не беспокоиться об одновременных простоях всех серверов.</span><span class="sxs-lookup"><span data-stu-id="31514-120">Creating a cert for each server means that you can update each cert individually, and not worry about downtime across all your servers.</span></span>

<span data-ttu-id="31514-121">VPN-серверы маршрутизацию запросов проверки подлинности, поэтому они должны toobe виду hello новых серверов NPS поддержкой многофакторной проверки Подлинности Azure.</span><span class="sxs-lookup"><span data-stu-id="31514-121">VPN servers route authentication requests, so they need toobe aware of hello new Azure MFA-enabled NPS servers.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="31514-122">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="31514-122">Prerequisites</span></span>

<span data-ttu-id="31514-123">Hello расширения NPS предназначен toowork в существующую инфраструктуру.</span><span class="sxs-lookup"><span data-stu-id="31514-123">hello NPS extension is meant toowork with your existing infrastructure.</span></span> <span data-ttu-id="31514-124">Убедитесь, что у вас есть hello следующие предварительные требования, прежде чем начать.</span><span class="sxs-lookup"><span data-stu-id="31514-124">Make sure you have hello following prerequisites before you begin.</span></span>

### <a name="licenses"></a><span data-ttu-id="31514-125">Лицензии</span><span class="sxs-lookup"><span data-stu-id="31514-125">Licenses</span></span>

<span data-ttu-id="31514-126">Hello NPS расширение для многофакторной проверки Подлинности Azure — доступные toocustomers с [лицензий для Azure Multi-factor Authentication](multi-factor-authentication.md) (входит в состав Azure AD Premium, EMS или подписка многофакторной проверки Подлинности).</span><span class="sxs-lookup"><span data-stu-id="31514-126">hello NPS Extension for Azure MFA is available toocustomers with [licenses for Azure Multi-Factor Authentication](multi-factor-authentication.md) (included with Azure AD Premium, EMS, or an MFA subscription).</span></span>

### <a name="software"></a><span data-ttu-id="31514-127">Программное обеспечение</span><span class="sxs-lookup"><span data-stu-id="31514-127">Software</span></span>

<span data-ttu-id="31514-128">Windows Server 2008 R2 с пакетом обновления 1 (SP1) или более поздняя версия.</span><span class="sxs-lookup"><span data-stu-id="31514-128">Windows Server 2008 R2 SP1 or above.</span></span>

### <a name="libraries"></a><span data-ttu-id="31514-129">Библиотеки</span><span class="sxs-lookup"><span data-stu-id="31514-129">Libraries</span></span>

<span data-ttu-id="31514-130">Эти библиотеки устанавливаются автоматически вместе с расширением hello.</span><span class="sxs-lookup"><span data-stu-id="31514-130">These libraries are installed automatically with hello extension.</span></span>
-   [<span data-ttu-id="31514-131">Распространяемые пакеты Visual C++ для Visual Studio 2013 (X64)</span><span class="sxs-lookup"><span data-stu-id="31514-131">Visual C++ Redistributable Packages for Visual Studio 2013 (X64)</span></span>](https://www.microsoft.com/download/details.aspx?id=40784)
-   [<span data-ttu-id="31514-132">Модуль Microsoft Azure Active Directory для Windows PowerShell, версия 1.1.166</span><span class="sxs-lookup"><span data-stu-id="31514-132">Microsoft Azure Active Directory Module for Windows PowerShell version 1.1.166.0</span></span>](https://connect.microsoft.com/site1164/Downloads/DownloadDetails.aspx?DownloadID=59185)

### <a name="azure-active-directory"></a><span data-ttu-id="31514-133">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="31514-133">Azure Active Directory</span></span>

<span data-ttu-id="31514-134">Всех пользователей с помощью расширения NPS hello должен быть синхронизирован tooAzure Active Directory с помощью Azure AD Connect и должен быть зарегистрирован для многофакторной проверки Подлинности.</span><span class="sxs-lookup"><span data-stu-id="31514-134">Everyone using hello NPS extension must be synced tooAzure Active Directory using Azure AD Connect, and must be registered for MFA.</span></span>

<span data-ttu-id="31514-135">При установке расширения hello необходимы учетные данные идентификатора и администратора каталога hello для вашего клиента Azure AD.</span><span class="sxs-lookup"><span data-stu-id="31514-135">When you install hello extension, you need hello directory ID and admin credentials for your Azure AD tenant.</span></span> <span data-ttu-id="31514-136">Идентификатор каталога можно узнать в hello [портал Azure](https://portal.azure.com).</span><span class="sxs-lookup"><span data-stu-id="31514-136">You can find your directory ID in hello [Azure portal](https://portal.azure.com).</span></span> <span data-ttu-id="31514-137">Вход от имени администратора, выберите hello **Azure Active Directory** выберите значок в левой части экрана приветствия **свойства**.</span><span class="sxs-lookup"><span data-stu-id="31514-137">Sign in as an administrator, select hello **Azure Active Directory** icon on hello left, then select **Properties**.</span></span> <span data-ttu-id="31514-138">Копировать hello GUID в hello **каталог с Идентификатором** и сохраните его.</span><span class="sxs-lookup"><span data-stu-id="31514-138">Copy hello GUID in hello **Directory ID** box and save it.</span></span> <span data-ttu-id="31514-139">Этот идентификатор GUID используется как идентификатор клиента hello при установке расширения NPS hello.</span><span class="sxs-lookup"><span data-stu-id="31514-139">You use this GUID as hello tenant ID when you install hello NPS extension.</span></span>

![Поиск идентификатора каталога в разделе свойств для Azure Active Directory](./media/multi-factor-authentication-nps-extension/find-directory-id.png)

## <a name="prepare-your-environment"></a><span data-ttu-id="31514-141">Подготовка среды</span><span class="sxs-lookup"><span data-stu-id="31514-141">Prepare your environment</span></span>

<span data-ttu-id="31514-142">Прежде чем устанавливать расширения NPS hello, требуется tooprepare вы среды toohandle hello трафик для проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="31514-142">Before you install hello NPS extension, you want tooprepare you environment toohandle hello authentication traffic.</span></span>

### <a name="enable-hello-nps-role-on-a-domain-joined-server"></a><span data-ttu-id="31514-143">Включите роль hello NPS на сервере, присоединенном к домену</span><span class="sxs-lookup"><span data-stu-id="31514-143">Enable hello NPS role on a domain-joined server</span></span>

<span data-ttu-id="31514-144">сервер политики сети Hello подключается tooAzure Active Directory и проверка подлинности запросов многофакторной проверки Подлинности hello.</span><span class="sxs-lookup"><span data-stu-id="31514-144">hello NPS server connects tooAzure Active Directory and authenticates hello MFA requests.</span></span> <span data-ttu-id="31514-145">Выберите один сервер для этой роли.</span><span class="sxs-lookup"><span data-stu-id="31514-145">Choose one server for this role.</span></span> <span data-ttu-id="31514-146">Рекомендуется выбирать сервер, не обрабатывает запросы от других служб, так как расширение NPS hello создает ошибки для всех запросов, которые не являются RADIUS.</span><span class="sxs-lookup"><span data-stu-id="31514-146">We recommend choosing a server that doesn't handle requests from other services, because hello NPS extension throws errors for any requests that aren't RADIUS.</span></span>

1. <span data-ttu-id="31514-147">На сервере, откройте hello **мастера добавления ролей и компонентов** из hello меню Быстрый запуск диспетчера сервера.</span><span class="sxs-lookup"><span data-stu-id="31514-147">On your server, open hello **Add Roles and Features Wizard** from hello Server Manager Quickstart menu.</span></span>
2. <span data-ttu-id="31514-148">Щелкните **Установка ролей или компонентов** для используемого типа установки.</span><span class="sxs-lookup"><span data-stu-id="31514-148">Choose **Role-based or feature-based installation** for your installation type.</span></span>
3. <span data-ttu-id="31514-149">Выберите hello **службы политики сети и доступа** роли сервера.</span><span class="sxs-lookup"><span data-stu-id="31514-149">Select hello **Network Policy and Access Services** server role.</span></span> <span data-ttu-id="31514-150">Окна могут всплывающие tooinform вы toorun необходимые компоненты этой роли.</span><span class="sxs-lookup"><span data-stu-id="31514-150">A window may pop up tooinform you of required features toorun this role.</span></span>
4. <span data-ttu-id="31514-151">Продолжайте работу приветствия мастера до страницы подтверждения hello.</span><span class="sxs-lookup"><span data-stu-id="31514-151">Continue through hello wizard until hello Confirmation page.</span></span> <span data-ttu-id="31514-152">Щелкните **Установить**.</span><span class="sxs-lookup"><span data-stu-id="31514-152">Select **Install**.</span></span>

<span data-ttu-id="31514-153">Теперь, когда у вас есть сервер, назначенный для сервера политики сети, нужно также настроить этот сервер toohandle входящих запросов RADIUS от hello решение VPN.</span><span class="sxs-lookup"><span data-stu-id="31514-153">Now that you have a server designated for NPS, you should also configure this server toohandle incoming RADIUS requests from hello VPN solution.</span></span>

### <a name="configure-your-vpn-solution-toocommunicate-with-hello-nps-server"></a><span data-ttu-id="31514-154">Настройка вашего toocommunicate решение VPN с сервера политики сети hello</span><span class="sxs-lookup"><span data-stu-id="31514-154">Configure your VPN solution toocommunicate with hello NPS server</span></span>

<span data-ttu-id="31514-155">В зависимости от того, какое решение VPN, вы используете hello tooconfigure действия, изменять политики проверки подлинности RADIUS.</span><span class="sxs-lookup"><span data-stu-id="31514-155">Depending on which VPN solution you use, hello steps tooconfigure your RADIUS authentication policy vary.</span></span> <span data-ttu-id="31514-156">Настройте этот сервер RADIUS сервера политики сети tooyour toopoint политики.</span><span class="sxs-lookup"><span data-stu-id="31514-156">Configure this policy toopoint tooyour RADIUS NPS server.</span></span>

### <a name="sync-domain-users-toohello-cloud"></a><span data-ttu-id="31514-157">Облако toohello пользователи домена синхронизации</span><span class="sxs-lookup"><span data-stu-id="31514-157">Sync domain users toohello cloud</span></span>

<span data-ttu-id="31514-158">Этот шаг может быть завершена на клиенте, но это хороший toodouble проверьте, что Azure AD Connect недавно синхронизации баз данных.</span><span class="sxs-lookup"><span data-stu-id="31514-158">This step may already be complete on your tenant, but it's good toodouble-check that Azure AD Connect has synchronized your databases recently.</span></span>

1. <span data-ttu-id="31514-159">Войдите в toohello [портал Azure](https://portal.azure.com) с правами администратора.</span><span class="sxs-lookup"><span data-stu-id="31514-159">Sign in toohello [Azure portal](https://portal.azure.com) as an administrator.</span></span>
2. <span data-ttu-id="31514-160">Щелкните **Azure Active Directory** > **Azure AD Connect**.</span><span class="sxs-lookup"><span data-stu-id="31514-160">Select **Azure Active Directory** > **Azure AD Connect**</span></span>
3. <span data-ttu-id="31514-161">Убедитесь в том, что синхронизация находится в состоянии **Включена** и последняя синхронизация была выполнена менее часа назад.</span><span class="sxs-lookup"><span data-stu-id="31514-161">Verify that your sync status is **Enabled** and that your last sync was less than an hour ago.</span></span>

<span data-ttu-id="31514-162">Если вам требуется tookick off новый цикл синхронизации, нам hello инструкциям [синхронизации Azure AD Connect: планировщика](../active-directory/connect/active-directory-aadconnectsync-feature-scheduler.md#start-the-scheduler).</span><span class="sxs-lookup"><span data-stu-id="31514-162">If you need tookick off a new round of synchronization, us hello instructions in [Azure AD Connect sync: Scheduler](../active-directory/connect/active-directory-aadconnectsync-feature-scheduler.md#start-the-scheduler).</span></span>

### <a name="determine-which-authentication-methods-your-users-can-use"></a><span data-ttu-id="31514-163">Определение методов проверки подлинности, которые смогут использовать пользователи</span><span class="sxs-lookup"><span data-stu-id="31514-163">Determine which authentication methods your users can use</span></span>

<span data-ttu-id="31514-164">Существует два фактора, влияющих на то, какие методы проверки подлинности доступны для развертывания расширения сервера политики сети (NPS):</span><span class="sxs-lookup"><span data-stu-id="31514-164">There are two factors that affect which authentication methods are available with an NPS extension deployment:</span></span>

1. <span data-ttu-id="31514-165">алгоритм шифрования пароля Hello, используемый между клиентом RADIUS hello (VPN, сервер Netscaler или другие) и серверов политики сети hello.</span><span class="sxs-lookup"><span data-stu-id="31514-165">hello password encryption algorithm used between hello RADIUS client (VPN, Netscaler server, or other) and hello NPS servers.</span></span>
   - <span data-ttu-id="31514-166">**PAP** поддерживает все методы проверки подлинности hello Azure MFA в облаке hello: телефонный звонок, односторонний текстовое сообщение, уведомление мобильного приложения и код проверки мобильного приложения.</span><span class="sxs-lookup"><span data-stu-id="31514-166">**PAP** supports all hello authentication methods of Azure MFA in hello cloud: phone call, one-way text message, mobile app notification, and mobile app verification code.</span></span>
   - <span data-ttu-id="31514-167">**CHAPV2** и **EAP** поддерживают телефонный звонок или уведомление мобильного приложения.</span><span class="sxs-lookup"><span data-stu-id="31514-167">**CHAPV2** and **EAP** support phone call and mobile app notification.</span></span>
2. <span data-ttu-id="31514-168">методы, которые клиентское приложение hello ввода Hello (VPN-сервера Netscaler или других) может обрабатывать.</span><span class="sxs-lookup"><span data-stu-id="31514-168">hello input methods that hello client application (VPN, Netscaler server, or other) can handle.</span></span> <span data-ttu-id="31514-169">Например, hello VPN-клиента иметь какие-либо средства tootype пользователя tooallow hello в код проверки из текста или мобильного приложения?</span><span class="sxs-lookup"><span data-stu-id="31514-169">For example, does hello VPN client have some means tooallow hello user tootype in a verification code from a text or mobile app?</span></span>

<span data-ttu-id="31514-170">При развертывании расширения hello NPS, используйте эти факторы tooevaluate, какие методы доступны для пользователей.</span><span class="sxs-lookup"><span data-stu-id="31514-170">When you deploy hello NPS extension, use these factors tooevaluate which methods are available for your users.</span></span> <span data-ttu-id="31514-171">Если клиент RADIUS поддержкой протокола PAP, но клиент hello UX не имеет полей ввода для проверки кода, затем телефонного звонка или уведомление мобильного приложения hello двумя способами поддерживаемых.</span><span class="sxs-lookup"><span data-stu-id="31514-171">If your RADIUS client supports PAP, but hello client UX doesn't have input fields for a verification code, then phone call and mobile app notification are hello two supported options.</span></span>

<span data-ttu-id="31514-172">Вы можете [отключить неподдерживаемые методы проверки подлинности](multi-factor-authentication-whats-next.md#selectable-verification-methods) в Azure.</span><span class="sxs-lookup"><span data-stu-id="31514-172">You can [disable unsupported authentication methods](multi-factor-authentication-whats-next.md#selectable-verification-methods) in Azure.</span></span>

### <a name="enable-users-for-mfa"></a><span data-ttu-id="31514-173">Включение MFA для пользователей</span><span class="sxs-lookup"><span data-stu-id="31514-173">Enable users for MFA</span></span>

<span data-ttu-id="31514-174">Перед развертыванием hello полный сервер политики сети необходимо tooenable многофакторной проверки Подлинности для пользователей hello, что требуется tooperform двухшаговую проверку.</span><span class="sxs-lookup"><span data-stu-id="31514-174">Before you deploy hello full NPS extension, you need tooenable MFA for hello users that you want tooperform two-step verification.</span></span> <span data-ttu-id="31514-175">Сразу же расширение hello tootest как можно развернуть его, необходимо по крайней мере одну пробную учетную запись, полностью зарегистрирован для многофакторной проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="31514-175">More immediately, tootest hello extension as you deploy it, you need at least one test account that is fully registered for Multi-Factor Authentication.</span></span>

<span data-ttu-id="31514-176">Используйте эти tooget действия тестовую учетную запись запуска:</span><span class="sxs-lookup"><span data-stu-id="31514-176">Use these steps tooget a test account started:</span></span>
1. <span data-ttu-id="31514-177">Войдите в слишком[https://aka.ms/mfasetup](https://aka.ms/mfasetup) с тестовой учетной записи.</span><span class="sxs-lookup"><span data-stu-id="31514-177">Sign in too[https://aka.ms/mfasetup](https://aka.ms/mfasetup) with a test account.</span></span> 
2. <span data-ttu-id="31514-178">Выполните tooset приглашения hello способ проверки.</span><span class="sxs-lookup"><span data-stu-id="31514-178">Follow hello prompts tooset up a verification method.</span></span>
3. <span data-ttu-id="31514-179">Создайте политику условного доступа или [изменения состояния пользователя hello](multi-factor-authentication-get-started-user-states.md) toorequire двухшаговую проверку для тестовой учетной записи hello.</span><span class="sxs-lookup"><span data-stu-id="31514-179">Either create a conditional access policy or [change hello user state](multi-factor-authentication-get-started-user-states.md) toorequire two-step verification for hello test account.</span></span> 

<span data-ttu-id="31514-180">Пользователи также должен иметь toofollow tooenroll эти действия они могут проверять подлинность с расширением NPS hello.</span><span class="sxs-lookup"><span data-stu-id="31514-180">Your users also need toofollow these steps tooenroll before they can authenticate with hello NPS extension.</span></span>

## <a name="install-hello-nps-extension"></a><span data-ttu-id="31514-181">Установка расширения NPS hello</span><span class="sxs-lookup"><span data-stu-id="31514-181">Install hello NPS extension</span></span>

> [!IMPORTANT]
> <span data-ttu-id="31514-182">Установите расширение hello NPS на сервере, отличном от точки доступа VPN hello.</span><span class="sxs-lookup"><span data-stu-id="31514-182">Install hello NPS extension on a different server than hello VPN access point.</span></span>

### <a name="download-and-install-hello-nps-extension-for-azure-mfa"></a><span data-ttu-id="31514-183">Загрузка и Установка расширения NPS hello для многофакторной проверки Подлинности Azure</span><span class="sxs-lookup"><span data-stu-id="31514-183">Download and install hello NPS extension for Azure MFA</span></span>

1.  <span data-ttu-id="31514-184">[Загрузите hello NPS расширения](https://aka.ms/npsmfa) из центра загрузки Майкрософт hello.</span><span class="sxs-lookup"><span data-stu-id="31514-184">[Download hello NPS Extension](https://aka.ms/npsmfa) from hello Microsoft Download Center.</span></span>
2.  <span data-ttu-id="31514-185">Скопируйте двоичные toohello hello требуется tooconfigure сервера политики сети.</span><span class="sxs-lookup"><span data-stu-id="31514-185">Copy hello binary toohello Network Policy Server you want tooconfigure.</span></span>
3.  <span data-ttu-id="31514-186">Запустите *setup.exe* и следуйте инструкциям по установке hello.</span><span class="sxs-lookup"><span data-stu-id="31514-186">Run *setup.exe* and follow hello installation instructions.</span></span> <span data-ttu-id="31514-187">Если возникнут ошибки, проверьте еще раз, hello, которые были успешно установлены две библиотеки из раздела готовности hello.</span><span class="sxs-lookup"><span data-stu-id="31514-187">If you encounter errors, double-check that hello two libraries from hello prerequisite section were successfully installed.</span></span>

### <a name="run-hello-powershell-script"></a><span data-ttu-id="31514-188">Запуск сценария PowerShell hello</span><span class="sxs-lookup"><span data-stu-id="31514-188">Run hello PowerShell script</span></span>

<span data-ttu-id="31514-189">Hello установщик создает сценарий PowerShell в этом расположении: `C:\Program Files\Microsoft\AzureMfa\Config` (где C:\ — установка).</span><span class="sxs-lookup"><span data-stu-id="31514-189">hello installer creates a PowerShell script in this location: `C:\Program Files\Microsoft\AzureMfa\Config` (where C:\ is your installation drive).</span></span> <span data-ttu-id="31514-190">Скрипт PowerShell выполняет hello следующие действия.</span><span class="sxs-lookup"><span data-stu-id="31514-190">This PowerShell script performs hello following actions:</span></span>

-   <span data-ttu-id="31514-191">Создать самозаверяющий сертификат.</span><span class="sxs-lookup"><span data-stu-id="31514-191">Create a self-signed certificate.</span></span>
-   <span data-ttu-id="31514-192">Свяжите hello открытый ключ hello сертификат toohello субъекта-службы в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="31514-192">Associate hello public key of hello certificate toohello service principal on Azure AD.</span></span>
-   <span data-ttu-id="31514-193">Храните hello сертификата в хранилище сертификатов локального компьютера hello.</span><span class="sxs-lookup"><span data-stu-id="31514-193">Store hello cert in hello local machine cert store.</span></span>
-   <span data-ttu-id="31514-194">Предоставление доступа toohello сертификата закрытого ключа tooNetwork пользователя.</span><span class="sxs-lookup"><span data-stu-id="31514-194">Grant access toohello certificate’s private key tooNetwork User.</span></span>
-   <span data-ttu-id="31514-195">Перезапустите hello NPS.</span><span class="sxs-lookup"><span data-stu-id="31514-195">Restart hello NPS.</span></span>

<span data-ttu-id="31514-196">Если не требуется toouse собственные сертификаты (вместо hello самозаверяющие сертификаты, hello приводит к возникновению ошибки сценария PowerShell), выполнить hello сценарий PowerShell toocomplete hello установку.</span><span class="sxs-lookup"><span data-stu-id="31514-196">Unless you want toouse your own certificates (instead of hello self-signed certificates that hello PowerShell script generates), run hello PowerShell Script toocomplete hello installation.</span></span> <span data-ttu-id="31514-197">При установке расширения hello на нескольких серверах, каждый из них должен иметь свой собственный сертификат.</span><span class="sxs-lookup"><span data-stu-id="31514-197">If you install hello extension on multiple servers, each one should have its own certificate.</span></span>

1. <span data-ttu-id="31514-198">Запустите Windows PowerShell от имени администратора.</span><span class="sxs-lookup"><span data-stu-id="31514-198">Run Windows PowerShell as an administrator.</span></span>
2. <span data-ttu-id="31514-199">Перейдите в соответствующий каталог.</span><span class="sxs-lookup"><span data-stu-id="31514-199">Change directories.</span></span>

   `cd "C:\Program Files\Microsoft\AzureMfa\Config"`

3. <span data-ttu-id="31514-200">Запустите сценарий PowerShell hello, созданный установщиком hello.</span><span class="sxs-lookup"><span data-stu-id="31514-200">Run hello PowerShell script created by hello installer.</span></span>

   `.\AzureMfaNpsExtnConfigSetup.ps1`

4. <span data-ttu-id="31514-201">PowerShell запросит ваш идентификатор клиента.</span><span class="sxs-lookup"><span data-stu-id="31514-201">PowerShell prompts for your tenant ID.</span></span> <span data-ttu-id="31514-202">Используйте каталог идентификатор GUID, скопированный из портала Azure в разделе предварительных требований hello hello hello.</span><span class="sxs-lookup"><span data-stu-id="31514-202">Use hello Directory ID GUID that you copied from hello Azure portal in hello prerequisites section.</span></span>
5. <span data-ttu-id="31514-203">Войдите в tooAzure AD с правами администратора.</span><span class="sxs-lookup"><span data-stu-id="31514-203">Sign in tooAzure AD as an administrator.</span></span>
6. <span data-ttu-id="31514-204">PowerShell показано сообщение об успешном выполнении после завершения сценария hello.</span><span class="sxs-lookup"><span data-stu-id="31514-204">PowerShell shows a success message when hello script is finished.</span></span>  

<span data-ttu-id="31514-205">Повторите эти действия на любые дополнительные серверы политики сети, которые должны tooset для балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="31514-205">Repeat these steps on any additional NPS servers that you want tooset up for load balancing.</span></span>

>[!NOTE]
><span data-ttu-id="31514-206">При использовании собственных сертификатов вместо создания сертификатов с помощью сценария PowerShell hello, убедитесь, что они были выровнены соглашение об именовании toohello NPS.</span><span class="sxs-lookup"><span data-stu-id="31514-206">If you use your own certificates instead of generating certificates with hello PowerShell script, make sure that they align toohello NPS naming convention.</span></span> <span data-ttu-id="31514-207">Hello имя субъекта должно быть **CN =\<TenantID\>, OU = Microsoft NPS расширение**.</span><span class="sxs-lookup"><span data-stu-id="31514-207">hello subject name must be **CN=\<TenantID\>,OU=Microsoft NPS Extension**.</span></span> 

## <a name="configure-your-nps-extension"></a><span data-ttu-id="31514-208">Настройка расширения NPS</span><span class="sxs-lookup"><span data-stu-id="31514-208">Configure your NPS extension</span></span>

<span data-ttu-id="31514-209">Этот раздел содержит рекомендации по проектированию и успешному развертыванию расширения NPS.</span><span class="sxs-lookup"><span data-stu-id="31514-209">This section includes design considerations and suggestions for successful NPS extension deployments.</span></span>

### <a name="configuration-limitations"></a><span data-ttu-id="31514-210">Ограничения конфигурации</span><span class="sxs-lookup"><span data-stu-id="31514-210">Configuration limitations</span></span>

- <span data-ttu-id="31514-211">Hello NPS расширение для многофакторной проверки Подлинности Azure не включает пользователей toomigrate средства и параметры из облака toohello многофакторной проверки Подлинности сервера.</span><span class="sxs-lookup"><span data-stu-id="31514-211">hello NPS extension for Azure MFA does not include tools toomigrate users and settings from MFA Server toohello cloud.</span></span> <span data-ttu-id="31514-212">По этой причине мы рекомендуем вам использовать расширение hello для новых развертываний, а не существующего развертывания.</span><span class="sxs-lookup"><span data-stu-id="31514-212">For this reason, we suggest using hello extension for new deployments, rather than existing deployment.</span></span> <span data-ttu-id="31514-213">При использовании hello на существующем развертывании, у пользователей есть доступ к tooperform доказательство снова toopopulate их многофакторной проверки Подлинности сведений в облаке hello.</span><span class="sxs-lookup"><span data-stu-id="31514-213">If you use hello extension on an existing deployment, your users have tooperform proof-up again toopopulate their MFA details in hello cloud.</span></span>  
- <span data-ttu-id="31514-214">Hello NPS расширение использует hello имени участника-пользователя из hello локального пользователя hello tooidentify Active directory в Azure MFA для выполнения расширения hello hello вторичной проверки подлинности может быть настроенный toouse это другой идентификатор, такой как альтернативных имен, идентификатор или пользовательские Active Directory поле, отличное от имени участника-пользователя.</span><span class="sxs-lookup"><span data-stu-id="31514-214">hello NPS extension uses hello UPN from hello on-premises Active directory tooidentify hello user on Azure MFA for performing hello Secondary Auth. hello extension can be configured toouse a different identifier like alternate login ID or custom Active Directory field other than UPN.</span></span> <span data-ttu-id="31514-215">В разделе [Дополнительные параметры конфигурации для расширения NPS hello многофакторной проверки подлинности](multi-factor-authentication-advanced-vpn-configurations.md) для получения дополнительной информации.</span><span class="sxs-lookup"><span data-stu-id="31514-215">See [Advanced configuration options for hello NPS extension for Multi-Factor Authentication](multi-factor-authentication-advanced-vpn-configurations.md) for more information.</span></span>
- <span data-ttu-id="31514-216">Не все протоколы шифрования поддерживают все методы проверки.</span><span class="sxs-lookup"><span data-stu-id="31514-216">Not all encryption protocols support all verification methods.</span></span>
   - <span data-ttu-id="31514-217">**PAP** поддерживает такие методы: телефонный звонок, одностороннее текстовое сообщение, уведомление мобильного приложения и код проверки мобильного приложения.</span><span class="sxs-lookup"><span data-stu-id="31514-217">**PAP** supports phone call, one-way text message, mobile app notification, and mobile app verification code</span></span>
   - <span data-ttu-id="31514-218">**CHAPV2** и **EAP** поддерживают телефонный звонок или уведомление мобильного приложения.</span><span class="sxs-lookup"><span data-stu-id="31514-218">**CHAPV2** and **EAP** support phone call and mobile app notification</span></span>

### <a name="control-radius-clients-that-require-mfa"></a><span data-ttu-id="31514-219">Управление клиентами RADIUS, для которых требуется MFA</span><span class="sxs-lookup"><span data-stu-id="31514-219">Control RADIUS clients that require MFA</span></span>

<span data-ttu-id="31514-220">После включения многофакторной проверки Подлинности для клиента RADIUS, с помощью hello NPS расширения, все проверки подлинности для данного клиента, необходимые tooperform многофакторной проверки Подлинности.</span><span class="sxs-lookup"><span data-stu-id="31514-220">Once you enable MFA for a RADIUS client using hello NPS Extension, all authentications for this client are required tooperform MFA.</span></span> <span data-ttu-id="31514-221">Если требуется tooenable MFA для RADIUS-клиентов, но не другие можно настроить два сервера политики сети и установить расширения hello только на одном из них.</span><span class="sxs-lookup"><span data-stu-id="31514-221">If you want tooenable MFA for some RADIUS clients but not others, you can configure two NPS servers and install hello extension on only one of them.</span></span> <span data-ttu-id="31514-222">Настройка RADIUS-клиентов, которые требуется toorequire многофакторной проверки Подлинности toosend запросов toohello сервер политики сети настроен с расширением hello и другие RADIUS клиентов toohello сервер политики сети не настроена с расширением hello.</span><span class="sxs-lookup"><span data-stu-id="31514-222">Configure RADIUS clients that you want toorequire MFA toosend requests toohello NPS server configured with hello extension, and other RADIUS clients toohello NPS server not configured with hello extension.</span></span>

### <a name="prepare-for-users-that-arent-enrolled-for-mfa"></a><span data-ttu-id="31514-223">Подготовка к входу пользователей, не зарегистрированных для MFA</span><span class="sxs-lookup"><span data-stu-id="31514-223">Prepare for users that aren't enrolled for MFA</span></span>

<span data-ttu-id="31514-224">Если у вас есть пользователи, которые не зарегистрированы для многофакторной проверки Подлинности, можно определить, что произойдет, если они пытаются выполнить tooauthenticate.</span><span class="sxs-lookup"><span data-stu-id="31514-224">If you have users that aren't enrolled for MFA, you can determine what happens when they try tooauthenticate.</span></span> <span data-ttu-id="31514-225">Используйте параметр реестра hello *REQUIRE_USER_MATCH* в пути реестра hello *HKLM\Software\Microsoft\AzureMFA* toocontrol поведение функции hello.</span><span class="sxs-lookup"><span data-stu-id="31514-225">Use hello registry setting *REQUIRE_USER_MATCH* in hello registry path *HKLM\Software\Microsoft\AzureMFA* toocontrol hello feature behavior.</span></span> <span data-ttu-id="31514-226">Здесь есть только один параметр конфигурации:</span><span class="sxs-lookup"><span data-stu-id="31514-226">This setting has a single configuration option:</span></span>

| <span data-ttu-id="31514-227">Ключ</span><span class="sxs-lookup"><span data-stu-id="31514-227">Key</span></span> | <span data-ttu-id="31514-228">Значение</span><span class="sxs-lookup"><span data-stu-id="31514-228">Value</span></span> | <span data-ttu-id="31514-229">значение по умолчанию</span><span class="sxs-lookup"><span data-stu-id="31514-229">Default</span></span> |
| --- | ----- | ------- |
| <span data-ttu-id="31514-230">REQUIRE_USER_MATCH</span><span class="sxs-lookup"><span data-stu-id="31514-230">REQUIRE_USER_MATCH</span></span> | <span data-ttu-id="31514-231">True или false</span><span class="sxs-lookup"><span data-stu-id="31514-231">TRUE/FALSE</span></span> | <span data-ttu-id="31514-232">Не задано (эквивалент tooTRUE)</span><span class="sxs-lookup"><span data-stu-id="31514-232">Not set (equivalent tooTRUE)</span></span> |

<span data-ttu-id="31514-233">Здравствуйте, это является toodetermine какие toodo, если пользователь не зарегистрирован для многофакторной проверки Подлинности.</span><span class="sxs-lookup"><span data-stu-id="31514-233">hello purpose of this setting is toodetermine what toodo when a user is not enrolled for MFA.</span></span> <span data-ttu-id="31514-234">При hello ключ не существует, не задано или имеет значение tooTRUE, hello пользователь не зарегистрирован, затем расширения hello сбоя hello многофакторной проверки Подлинности запроса.</span><span class="sxs-lookup"><span data-stu-id="31514-234">When hello key does not exist, is not set, or is set tooTRUE, and hello user is not enrolled, then hello extension fails hello MFA challenge.</span></span> <span data-ttu-id="31514-235">Если задан ключ hello tooFALSE hello пользователь не зарегистрирован, проверка подлинности продолжается без выполнения многофакторной проверки Подлинности.</span><span class="sxs-lookup"><span data-stu-id="31514-235">When hello key is set tooFALSE and hello user is not enrolled, authentication proceeds without performing MFA.</span></span>

<span data-ttu-id="31514-236">Можно выбрать toocreate этот ключ и задать для него tooFALSE адаптации находятся пользователи, а может не все зарегистрировано для многофакторной проверки Подлинности Azure еще.</span><span class="sxs-lookup"><span data-stu-id="31514-236">You can choose toocreate this key and set it tooFALSE while your users are onboarding, and may not all be enrolled for Azure MFA yet.</span></span> <span data-ttu-id="31514-237">Тем не менее поскольку ключ hello параметра позволяет пользователям, которые не зарегистрированы для toosign многофакторной проверки Подлинности в, следует удалить этот ключ, перед выходом tooproduction.</span><span class="sxs-lookup"><span data-stu-id="31514-237">However, since setting hello key permits users that aren't enrolled for MFA toosign in, you should remove this key before going tooproduction.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="31514-238">Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="31514-238">Troubleshooting</span></span>

### <a name="how-do-i-verify-that-hello-client-cert-is-installed-as-expected"></a><span data-ttu-id="31514-239">Как убедиться, что сертификат клиента, hello установлены, как ожидалось?</span><span class="sxs-lookup"><span data-stu-id="31514-239">How do I verify that hello client cert is installed as expected?</span></span>

<span data-ttu-id="31514-240">Найдите hello самозаверяющий сертификат, созданный установщика hello в хранилище сертификатов hello и убедитесь, что закрытый ключ hello обладает разрешениями, предоставляемыми toouser **СЕТЕВОЙ службы**.</span><span class="sxs-lookup"><span data-stu-id="31514-240">Look for hello self-signed certificate created by hello installer in hello cert store, and check that hello private key has permissions granted toouser **NETWORK SERVICE**.</span></span> <span data-ttu-id="31514-241">Hello сертификата имеет имя субъекта **CN \<tenantid\>, OU = расширение NPS корпорации Майкрософт**</span><span class="sxs-lookup"><span data-stu-id="31514-241">hello cert has a subject name of **CN \<tenantid\>, OU = Microsoft NPS Extension**</span></span>

-------------------------------------------------------------

### <a name="how-can-i-verify-that-my-client-cert-is-associated-toomy-tenant-in-azure-active-directory"></a><span data-ttu-id="31514-242">Как проверять, Мой сертификат клиента является связанной toomy клиента в Azure Active Directory?</span><span class="sxs-lookup"><span data-stu-id="31514-242">How can I verify that my client cert is associated toomy tenant in Azure Active Directory?</span></span>

<span data-ttu-id="31514-243">Откройте командную строку PowerShell и выполнения hello, следующие команды:</span><span class="sxs-lookup"><span data-stu-id="31514-243">Open PowerShell command prompt and run hello following commands:</span></span>

```
import-module MSOnline
Connect-MsolService
Get-MsolServicePrincipalCredential -AppPrincipalId "981f26a1-7f43-403b-a875-f8b09b8cd720" -ReturnKeyValues 1 
```

<span data-ttu-id="31514-244">Эти команды печатают все сертификаты hello связывание вашего клиента с имеющимся экземпляром hello расширения сервера политики сети в текущем сеансе PowerShell.</span><span class="sxs-lookup"><span data-stu-id="31514-244">These commands print all hello certificates associating your tenant with your instance of hello NPS extension in your PowerShell session.</span></span> <span data-ttu-id="31514-245">Найдите свой сертификат при экспорте сертификата клиента в формате «в кодировке Base-64 X.509(.cer)» без закрытого ключа hello и сравнить его со списком hello из PowerShell.</span><span class="sxs-lookup"><span data-stu-id="31514-245">Look for your certificate by exporting your client cert as a "Base-64 encoded X.509(.cer)" file without hello private key, and compare it with hello list from PowerShell.</span></span>

<span data-ttu-id="31514-246">Допустимые- и окончания-до отметки времени, которые входят в удобочитаемой форме, может быть используется toofilter out очевидным misfits, если команда hello возвращает более одного сертификата.</span><span class="sxs-lookup"><span data-stu-id="31514-246">Valid-From and Valid-Until timestamps, which are in human-readable form, can be used toofilter out obvious misfits if hello command returns more than one cert.</span></span>

-------------------------------------------------------------

### <a name="why-are-my-requests-failing-with-adal-token-error"></a><span data-ttu-id="31514-247">Почему запросы завершаются сбоем с ошибкой маркера ADAL?</span><span class="sxs-lookup"><span data-stu-id="31514-247">Why are my requests failing with ADAL token error?</span></span>

<span data-ttu-id="31514-248">Эта ошибка может быть вызвано tooone из нескольких причин.</span><span class="sxs-lookup"><span data-stu-id="31514-248">This error could be due tooone of several reasons.</span></span> <span data-ttu-id="31514-249">Выполните эти действия toohelp устранения неполадок.</span><span class="sxs-lookup"><span data-stu-id="31514-249">Use these steps toohelp troubleshoot:</span></span>

1. <span data-ttu-id="31514-250">Перезагрузите сервер политики сети.</span><span class="sxs-lookup"><span data-stu-id="31514-250">Restart your NPS server.</span></span>
2. <span data-ttu-id="31514-251">Убедитесь, что сертификат клиента установлен правильно.</span><span class="sxs-lookup"><span data-stu-id="31514-251">Verify that that client cert is installed as expected.</span></span>
3. <span data-ttu-id="31514-252">Убедитесь, что этот сертификат hello связан с вашим клиентом в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="31514-252">Verify that hello certificate is associated with your tenant on Azure AD.</span></span>
4. <span data-ttu-id="31514-253">Убедитесь, что этой https://login.microsoftonline.com/ доступен с hello сервер расширения hello.</span><span class="sxs-lookup"><span data-stu-id="31514-253">Verify that https://login.microsoftonline.com/ is accessible from hello server running hello extension.</span></span>

-------------------------------------------------------------

### <a name="why-does-authentication-fail-with-an-error-in-http-logs-stating-that-hello-user-is-not-found"></a><span data-ttu-id="31514-254">Почему проверка подлинности пройдена с сообщением об ошибке в журналах HTTP, о том, что этот пользователь hello не найден</span><span class="sxs-lookup"><span data-stu-id="31514-254">Why does authentication fail with an error in HTTP logs stating that hello user is not found?</span></span>

<span data-ttu-id="31514-255">Убедитесь, что выполняется AD Connect и этому пользователю hello присутствует в Windows Active Directory и Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="31514-255">Verify that AD Connect is running, and that hello user is present in both Windows Active Directory and Azure Active Directory.</span></span>

------------------------------------------------------------

### <a name="why-do-i-see-http-connect-errors-in-logs-with-all-my-authentications-failing"></a><span data-ttu-id="31514-256">Почему в журналах отображаются ошибки подключения HTTP для всех попыток проверки подлинности?</span><span class="sxs-lookup"><span data-stu-id="31514-256">Why do I see HTTP connect errors in logs with all my authentications failing?</span></span>

<span data-ttu-id="31514-257">Убедитесь, что этой https://adnotifications.windowsazure.com доступен с сервера hello, под управлением NPS расширения hello.</span><span class="sxs-lookup"><span data-stu-id="31514-257">Verify that https://adnotifications.windowsazure.com is reachable from hello server running hello NPS extension.</span></span>


## <a name="next-steps"></a><span data-ttu-id="31514-258">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="31514-258">Next steps</span></span>

- <span data-ttu-id="31514-259">Настройте альтернативные идентификаторы для имени входа, или настроить список исключений для IP-адресов, который не следует выполнять двухшаговую проверку в [Дополнительные параметры конфигурации для расширения NPS hello многофакторной проверки подлинности](nps-extension-advanced-configuration.md)</span><span class="sxs-lookup"><span data-stu-id="31514-259">Configure alternate IDs for login, or set up an exception list for IPs that shouldn't perform two-step verification in [Advanced configuration options for hello NPS extension for Multi-Factor Authentication](nps-extension-advanced-configuration.md)</span></span>

- [<span data-ttu-id="31514-260">Разрешить сообщения об ошибках из hello NPS расширения для многофакторной проверки подлинности Azure</span><span class="sxs-lookup"><span data-stu-id="31514-260">Resolve error messages from hello NPS extension for Azure Multi-Factor Authentication</span></span>](multi-factor-authentication-nps-errors.md)

---
title: "aaaUse существующие NPS серверов tooprovide многофакторной проверки Подлинности Azure возможности | Документы Microsoft"
description: "Hello расширение сервера политики сети для многофакторной проверки подлинности Azure является простым решением tooadd облачного двухэтапный vericiation возможности tooyour существующую инфраструктуру проверки подлинности."
services: multi-factor-authentication
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/14/2017
ms.author: kgremban
ms.reviewer: yossib
ms.custom: H1Hack27Feb2017; it-pro
ms.openlocfilehash: e9fc495b06873d45f06233f1aa618db9d94f8bd9
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="integrate-your-existing-nps-infrastructure-with-azure-multi-factor-authentication"></a>Интеграция существующей инфраструктуры NPS с Многофакторной идентификацией Azure

Hello расширение сервера политики сети (NPS) для многофакторной проверки Подлинности Azure добавляет облачного многофакторной проверки Подлинности возможности tooyour инфраструктуры проверки подлинности с помощью существующие серверы. Hello расширения сервера политики сети можно добавить телефонный звонок, текстовое сообщение или phone app проверки tooyour существующий поток проверки подлинности без необходимости tooinstall, настраивать и обслуживать новые серверы. 

Этот модуль был создан для организаций, которые планируют tooprotect VPN-подключений, не развертывая hello Azure многофакторной проверки Подлинности сервера. Hello расширения сервера политики сети выступает в качестве адаптера между RADIUS и облачного tooprovide многофакторной проверки Подлинности Azure второй фактор проверки подлинности для федеративной или синхронизированных пользователей.

При использовании модуля политики сети hello многофакторной проверки подлинности Azure, процесс проверки подлинности hello включает hello следующие компоненты: 

1. **NAS или VPN-сервер** получает запросы от VPN-клиентов и преобразует их в запросы RADIUS-серверов tooNPS. 
2. **Сервер политики сети** подключается tooActive Directory tooperform hello основной проверки подлинности для hello RADIUS запросы и при успешном завершении передает hello запроса tooany установлены расширения.  
3. **Расширение NPS** запускает запрос tooAzure многофакторной проверки Подлинности для hello вторичной проверки подлинности. После расширения hello получает ответ hello и hello многофакторной проверки Подлинности запроса выполняется успешно, он завершает запрос проверки подлинности hello, предоставляя hello NPS-сервера с маркерами безопасности, включающие утверждение многофакторной проверки Подлинности, выданного службой маркеров безопасности Azure.  
4. **Azure MFA** связывается с сведения о пользователе для Azure Active Directory tooretrieve hello и выполняет hello вторичной проверки подлинности, использовать метод настроенный toohello проверки пользователя.

Привет, следующая схема иллюстрирует этот процесс высокого уровня проверки подлинности запроса: 

![Схема последовательности проверки подлинности](./media/multi-factor-authentication-nps-extension/auth-flow.png)

## <a name="plan-your-deployment"></a>Планирование развертывания

Hello расширения NPS автоматически обрабатывает избыточности, вам требуется специальной конфигурации.

Можно создать столько NPS-серверов с поддержкой Azure MFA, сколько требуется. При установке нескольких серверов для каждого из них следует использовать отдельный сертификат клиента. Создание сертификата для каждого сервера означает, что можно обновлять каждый сертификат по отдельности и не беспокоиться об одновременных простоях всех серверов.

VPN-серверы маршрутизацию запросов проверки подлинности, поэтому они должны toobe виду hello новых серверов NPS поддержкой многофакторной проверки Подлинности Azure.

## <a name="prerequisites"></a>Предварительные требования

Hello расширения NPS предназначен toowork в существующую инфраструктуру. Убедитесь, что у вас есть hello следующие предварительные требования, прежде чем начать.

### <a name="licenses"></a>Лицензии

Hello NPS расширение для многофакторной проверки Подлинности Azure — доступные toocustomers с [лицензий для Azure Multi-factor Authentication](multi-factor-authentication.md) (входит в состав Azure AD Premium, EMS или подписка многофакторной проверки Подлинности).

### <a name="software"></a>Программное обеспечение

Windows Server 2008 R2 с пакетом обновления 1 (SP1) или более поздняя версия.

### <a name="libraries"></a>Библиотеки

Эти библиотеки устанавливаются автоматически вместе с расширением hello.
-   [Распространяемые пакеты Visual C++ для Visual Studio 2013 (X64)](https://www.microsoft.com/download/details.aspx?id=40784)
-   [Модуль Microsoft Azure Active Directory для Windows PowerShell, версия 1.1.166](https://connect.microsoft.com/site1164/Downloads/DownloadDetails.aspx?DownloadID=59185)

### <a name="azure-active-directory"></a>Azure Active Directory

Всех пользователей с помощью расширения NPS hello должен быть синхронизирован tooAzure Active Directory с помощью Azure AD Connect и должен быть зарегистрирован для многофакторной проверки Подлинности.

При установке расширения hello необходимы учетные данные идентификатора и администратора каталога hello для вашего клиента Azure AD. Идентификатор каталога можно узнать в hello [портал Azure](https://portal.azure.com). Вход от имени администратора, выберите hello **Azure Active Directory** выберите значок в левой части экрана приветствия **свойства**. Копировать hello GUID в hello **каталог с Идентификатором** и сохраните его. Этот идентификатор GUID используется как идентификатор клиента hello при установке расширения NPS hello.

![Поиск идентификатора каталога в разделе свойств для Azure Active Directory](./media/multi-factor-authentication-nps-extension/find-directory-id.png)

## <a name="prepare-your-environment"></a>Подготовка среды

Прежде чем устанавливать расширения NPS hello, требуется tooprepare вы среды toohandle hello трафик для проверки подлинности.

### <a name="enable-hello-nps-role-on-a-domain-joined-server"></a>Включите роль hello NPS на сервере, присоединенном к домену

сервер политики сети Hello подключается tooAzure Active Directory и проверка подлинности запросов многофакторной проверки Подлинности hello. Выберите один сервер для этой роли. Рекомендуется выбирать сервер, не обрабатывает запросы от других служб, так как расширение NPS hello создает ошибки для всех запросов, которые не являются RADIUS.

1. На сервере, откройте hello **мастера добавления ролей и компонентов** из hello меню Быстрый запуск диспетчера сервера.
2. Щелкните **Установка ролей или компонентов** для используемого типа установки.
3. Выберите hello **службы политики сети и доступа** роли сервера. Окна могут всплывающие tooinform вы toorun необходимые компоненты этой роли.
4. Продолжайте работу приветствия мастера до страницы подтверждения hello. Щелкните **Установить**.

Теперь, когда у вас есть сервер, назначенный для сервера политики сети, нужно также настроить этот сервер toohandle входящих запросов RADIUS от hello решение VPN.

### <a name="configure-your-vpn-solution-toocommunicate-with-hello-nps-server"></a>Настройка вашего toocommunicate решение VPN с сервера политики сети hello

В зависимости от того, какое решение VPN, вы используете hello tooconfigure действия, изменять политики проверки подлинности RADIUS. Настройте этот сервер RADIUS сервера политики сети tooyour toopoint политики.

### <a name="sync-domain-users-toohello-cloud"></a>Облако toohello пользователи домена синхронизации

Этот шаг может быть завершена на клиенте, но это хороший toodouble проверьте, что Azure AD Connect недавно синхронизации баз данных.

1. Войдите в toohello [портал Azure](https://portal.azure.com) с правами администратора.
2. Щелкните **Azure Active Directory** > **Azure AD Connect**.
3. Убедитесь в том, что синхронизация находится в состоянии **Включена** и последняя синхронизация была выполнена менее часа назад.

Если вам требуется tookick off новый цикл синхронизации, нам hello инструкциям [синхронизации Azure AD Connect: планировщика](../active-directory/connect/active-directory-aadconnectsync-feature-scheduler.md#start-the-scheduler).

### <a name="determine-which-authentication-methods-your-users-can-use"></a>Определение методов проверки подлинности, которые смогут использовать пользователи

Существует два фактора, влияющих на то, какие методы проверки подлинности доступны для развертывания расширения сервера политики сети (NPS):

1. алгоритм шифрования пароля Hello, используемый между клиентом RADIUS hello (VPN, сервер Netscaler или другие) и серверов политики сети hello.
   - **PAP** поддерживает все методы проверки подлинности hello Azure MFA в облаке hello: телефонный звонок, односторонний текстовое сообщение, уведомление мобильного приложения и код проверки мобильного приложения.
   - **CHAPV2** и **EAP** поддерживают телефонный звонок или уведомление мобильного приложения.
2. методы, которые клиентское приложение hello ввода Hello (VPN-сервера Netscaler или других) может обрабатывать. Например, hello VPN-клиента иметь какие-либо средства tootype пользователя tooallow hello в код проверки из текста или мобильного приложения?

При развертывании расширения hello NPS, используйте эти факторы tooevaluate, какие методы доступны для пользователей. Если клиент RADIUS поддержкой протокола PAP, но клиент hello UX не имеет полей ввода для проверки кода, затем телефонного звонка или уведомление мобильного приложения hello двумя способами поддерживаемых.

Вы можете [отключить неподдерживаемые методы проверки подлинности](multi-factor-authentication-whats-next.md#selectable-verification-methods) в Azure.

### <a name="enable-users-for-mfa"></a>Включение MFA для пользователей

Перед развертыванием hello полный сервер политики сети необходимо tooenable многофакторной проверки Подлинности для пользователей hello, что требуется tooperform двухшаговую проверку. Сразу же расширение hello tootest как можно развернуть его, необходимо по крайней мере одну пробную учетную запись, полностью зарегистрирован для многофакторной проверки подлинности.

Используйте эти tooget действия тестовую учетную запись запуска:
1. Войдите в слишком[https://aka.ms/mfasetup](https://aka.ms/mfasetup) с тестовой учетной записи. 
2. Выполните tooset приглашения hello способ проверки.
3. Создайте политику условного доступа или [изменения состояния пользователя hello](multi-factor-authentication-get-started-user-states.md) toorequire двухшаговую проверку для тестовой учетной записи hello. 

Пользователи также должен иметь toofollow tooenroll эти действия они могут проверять подлинность с расширением NPS hello.

## <a name="install-hello-nps-extension"></a>Установка расширения NPS hello

> [!IMPORTANT]
> Установите расширение hello NPS на сервере, отличном от точки доступа VPN hello.

### <a name="download-and-install-hello-nps-extension-for-azure-mfa"></a>Загрузка и Установка расширения NPS hello для многофакторной проверки Подлинности Azure

1.  [Загрузите hello NPS расширения](https://aka.ms/npsmfa) из центра загрузки Майкрософт hello.
2.  Скопируйте двоичные toohello hello требуется tooconfigure сервера политики сети.
3.  Запустите *setup.exe* и следуйте инструкциям по установке hello. Если возникнут ошибки, проверьте еще раз, hello, которые были успешно установлены две библиотеки из раздела готовности hello.

### <a name="run-hello-powershell-script"></a>Запуск сценария PowerShell hello

Hello установщик создает сценарий PowerShell в этом расположении: `C:\Program Files\Microsoft\AzureMfa\Config` (где C:\ — установка). Скрипт PowerShell выполняет hello следующие действия.

-   Создать самозаверяющий сертификат.
-   Свяжите hello открытый ключ hello сертификат toohello субъекта-службы в Azure AD.
-   Храните hello сертификата в хранилище сертификатов локального компьютера hello.
-   Предоставление доступа toohello сертификата закрытого ключа tooNetwork пользователя.
-   Перезапустите hello NPS.

Если не требуется toouse собственные сертификаты (вместо hello самозаверяющие сертификаты, hello приводит к возникновению ошибки сценария PowerShell), выполнить hello сценарий PowerShell toocomplete hello установку. При установке расширения hello на нескольких серверах, каждый из них должен иметь свой собственный сертификат.

1. Запустите Windows PowerShell от имени администратора.
2. Перейдите в соответствующий каталог.

   `cd "C:\Program Files\Microsoft\AzureMfa\Config"`

3. Запустите сценарий PowerShell hello, созданный установщиком hello.

   `.\AzureMfaNpsExtnConfigSetup.ps1`

4. PowerShell запросит ваш идентификатор клиента. Используйте каталог идентификатор GUID, скопированный из портала Azure в разделе предварительных требований hello hello hello.
5. Войдите в tooAzure AD с правами администратора.
6. PowerShell показано сообщение об успешном выполнении после завершения сценария hello.  

Повторите эти действия на любые дополнительные серверы политики сети, которые должны tooset для балансировки нагрузки.

>[!NOTE]
>При использовании собственных сертификатов вместо создания сертификатов с помощью сценария PowerShell hello, убедитесь, что они были выровнены соглашение об именовании toohello NPS. Hello имя субъекта должно быть **CN =\<TenantID\>, OU = Microsoft NPS расширение**. 

## <a name="configure-your-nps-extension"></a>Настройка расширения NPS

Этот раздел содержит рекомендации по проектированию и успешному развертыванию расширения NPS.

### <a name="configuration-limitations"></a>Ограничения конфигурации

- Hello NPS расширение для многофакторной проверки Подлинности Azure не включает пользователей toomigrate средства и параметры из облака toohello многофакторной проверки Подлинности сервера. По этой причине мы рекомендуем вам использовать расширение hello для новых развертываний, а не существующего развертывания. При использовании hello на существующем развертывании, у пользователей есть доступ к tooperform доказательство снова toopopulate их многофакторной проверки Подлинности сведений в облаке hello.  
- Hello NPS расширение использует hello имени участника-пользователя из hello локального пользователя hello tooidentify Active directory в Azure MFA для выполнения расширения hello hello вторичной проверки подлинности может быть настроенный toouse это другой идентификатор, такой как альтернативных имен, идентификатор или пользовательские Active Directory поле, отличное от имени участника-пользователя. В разделе [Дополнительные параметры конфигурации для расширения NPS hello многофакторной проверки подлинности](multi-factor-authentication-advanced-vpn-configurations.md) для получения дополнительной информации.
- Не все протоколы шифрования поддерживают все методы проверки.
   - **PAP** поддерживает такие методы: телефонный звонок, одностороннее текстовое сообщение, уведомление мобильного приложения и код проверки мобильного приложения.
   - **CHAPV2** и **EAP** поддерживают телефонный звонок или уведомление мобильного приложения.

### <a name="control-radius-clients-that-require-mfa"></a>Управление клиентами RADIUS, для которых требуется MFA

После включения многофакторной проверки Подлинности для клиента RADIUS, с помощью hello NPS расширения, все проверки подлинности для данного клиента, необходимые tooperform многофакторной проверки Подлинности. Если требуется tooenable MFA для RADIUS-клиентов, но не другие можно настроить два сервера политики сети и установить расширения hello только на одном из них. Настройка RADIUS-клиентов, которые требуется toorequire многофакторной проверки Подлинности toosend запросов toohello сервер политики сети настроен с расширением hello и другие RADIUS клиентов toohello сервер политики сети не настроена с расширением hello.

### <a name="prepare-for-users-that-arent-enrolled-for-mfa"></a>Подготовка к входу пользователей, не зарегистрированных для MFA

Если у вас есть пользователи, которые не зарегистрированы для многофакторной проверки Подлинности, можно определить, что произойдет, если они пытаются выполнить tooauthenticate. Используйте параметр реестра hello *REQUIRE_USER_MATCH* в пути реестра hello *HKLM\Software\Microsoft\AzureMFA* toocontrol поведение функции hello. Здесь есть только один параметр конфигурации:

| Ключ | Значение | значение по умолчанию |
| --- | ----- | ------- |
| REQUIRE_USER_MATCH | True или false | Не задано (эквивалент tooTRUE) |

Здравствуйте, это является toodetermine какие toodo, если пользователь не зарегистрирован для многофакторной проверки Подлинности. При hello ключ не существует, не задано или имеет значение tooTRUE, hello пользователь не зарегистрирован, затем расширения hello сбоя hello многофакторной проверки Подлинности запроса. Если задан ключ hello tooFALSE hello пользователь не зарегистрирован, проверка подлинности продолжается без выполнения многофакторной проверки Подлинности.

Можно выбрать toocreate этот ключ и задать для него tooFALSE адаптации находятся пользователи, а может не все зарегистрировано для многофакторной проверки Подлинности Azure еще. Тем не менее поскольку ключ hello параметра позволяет пользователям, которые не зарегистрированы для toosign многофакторной проверки Подлинности в, следует удалить этот ключ, перед выходом tooproduction.

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="how-do-i-verify-that-hello-client-cert-is-installed-as-expected"></a>Как убедиться, что сертификат клиента, hello установлены, как ожидалось?

Найдите hello самозаверяющий сертификат, созданный установщика hello в хранилище сертификатов hello и убедитесь, что закрытый ключ hello обладает разрешениями, предоставляемыми toouser **СЕТЕВОЙ службы**. Hello сертификата имеет имя субъекта **CN \<tenantid\>, OU = расширение NPS корпорации Майкрософт**

-------------------------------------------------------------

### <a name="how-can-i-verify-that-my-client-cert-is-associated-toomy-tenant-in-azure-active-directory"></a>Как проверять, Мой сертификат клиента является связанной toomy клиента в Azure Active Directory?

Откройте командную строку PowerShell и выполнения hello, следующие команды:

```
import-module MSOnline
Connect-MsolService
Get-MsolServicePrincipalCredential -AppPrincipalId "981f26a1-7f43-403b-a875-f8b09b8cd720" -ReturnKeyValues 1 
```

Эти команды печатают все сертификаты hello связывание вашего клиента с имеющимся экземпляром hello расширения сервера политики сети в текущем сеансе PowerShell. Найдите свой сертификат при экспорте сертификата клиента в формате «в кодировке Base-64 X.509(.cer)» без закрытого ключа hello и сравнить его со списком hello из PowerShell.

Допустимые- и окончания-до отметки времени, которые входят в удобочитаемой форме, может быть используется toofilter out очевидным misfits, если команда hello возвращает более одного сертификата.

-------------------------------------------------------------

### <a name="why-are-my-requests-failing-with-adal-token-error"></a>Почему запросы завершаются сбоем с ошибкой маркера ADAL?

Эта ошибка может быть вызвано tooone из нескольких причин. Выполните эти действия toohelp устранения неполадок.

1. Перезагрузите сервер политики сети.
2. Убедитесь, что сертификат клиента установлен правильно.
3. Убедитесь, что этот сертификат hello связан с вашим клиентом в Azure AD.
4. Убедитесь, что этой https://login.microsoftonline.com/ доступен с hello сервер расширения hello.

-------------------------------------------------------------

### <a name="why-does-authentication-fail-with-an-error-in-http-logs-stating-that-hello-user-is-not-found"></a>Почему проверка подлинности пройдена с сообщением об ошибке в журналах HTTP, о том, что этот пользователь hello не найден

Убедитесь, что выполняется AD Connect и этому пользователю hello присутствует в Windows Active Directory и Azure Active Directory.

------------------------------------------------------------

### <a name="why-do-i-see-http-connect-errors-in-logs-with-all-my-authentications-failing"></a>Почему в журналах отображаются ошибки подключения HTTP для всех попыток проверки подлинности?

Убедитесь, что этой https://adnotifications.windowsazure.com доступен с сервера hello, под управлением NPS расширения hello.


## <a name="next-steps"></a>Дальнейшие действия

- Настройте альтернативные идентификаторы для имени входа, или настроить список исключений для IP-адресов, который не следует выполнять двухшаговую проверку в [Дополнительные параметры конфигурации для расширения NPS hello многофакторной проверки подлинности](nps-extension-advanced-configuration.md)

- [Разрешить сообщения об ошибках из hello NPS расширения для многофакторной проверки подлинности Azure](multi-factor-authentication-nps-errors.md)

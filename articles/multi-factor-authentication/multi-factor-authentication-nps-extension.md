---
title: "Использование существующих серверов NPS для реализации возможностей MFA Azure | Документация Майкрософт"
description: "Расширение сервера политики сети для Многофакторной идентификации Azure — это простое решение, позволяющее добавить двухэтапную облачную проверку пользователей в существующую инфраструктуру проверки подлинности."
services: multi-factor-authentication
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/14/2017
ms.author: kgremban
ms.reviewer: yossib
ms.custom: H1Hack27Feb2017; it-pro
ms.openlocfilehash: fa125292ee85bd9b5329cffeff7f076d3002cbf3
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="integrate-your-existing-nps-infrastructure-with-azure-multi-factor-authentication"></a><span data-ttu-id="b8e07-103">Интеграция существующей инфраструктуры NPS с Многофакторной идентификацией Azure</span><span class="sxs-lookup"><span data-stu-id="b8e07-103">Integrate your existing NPS infrastructure with Azure Multi-Factor Authentication</span></span>

<span data-ttu-id="b8e07-104">Расширение сервера политики сети (NPS) для MFA Azure добавляет облачные функции многофакторной идентификации в инфраструктуру проверки подлинности на базе существующих серверов.</span><span class="sxs-lookup"><span data-stu-id="b8e07-104">The Network Policy Server (NPS) extension for Azure MFA adds cloud-based MFA capabilities to your authentication infrastructure using your existing servers.</span></span> <span data-ttu-id="b8e07-105">Расширение NPS позволяет добавить телефонный звонок, текстовое сообщение или запрос на подтверждение в мобильном приложении в существующую последовательность аутентификации, позволяя обойтись без установки, настройки и поддержания новых серверов.</span><span class="sxs-lookup"><span data-stu-id="b8e07-105">With the NPS extension, you can add phone call, text message, or phone app verification to your existing authentication flow without having to install, configure, and maintain new servers.</span></span> 

<span data-ttu-id="b8e07-106">Это расширение было создано для организаций, которым необходимо защитить VPN-подключения, не развертывая сервер Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="b8e07-106">This extension was created for organizations that want to protect VPN connections without deploying the Azure MFA Server.</span></span> <span data-ttu-id="b8e07-107">Расширение NPS выполняет функции адаптера между RADIUS и облачной службой Azure MFA, предоставляя второй фактор проверки подлинности для федеративных или синхронизированных пользователей.</span><span class="sxs-lookup"><span data-stu-id="b8e07-107">The NPS extension acts as an adapter between RADIUS and cloud-based Azure MFA to provide a second factor of authentication for federated or synced users.</span></span>

<span data-ttu-id="b8e07-108">Если вы используете расширение NPS для многофакторной идентификации Azure, процесс проверки подлинности состоит из следующих компонентов.</span><span class="sxs-lookup"><span data-stu-id="b8e07-108">When using the NPS extension for Azure MFA, the authentication flow includes the following components:</span></span> 

1. <span data-ttu-id="b8e07-109">**NAS или VPN-сервер** получает запросы от клиентов, использующих VPN-подключение, и преобразует их в запросы RADIUS, направляемые на серверы политики сети.</span><span class="sxs-lookup"><span data-stu-id="b8e07-109">**NAS/VPN Server** receives requests from VPN clients and converts them into RADIUS requests to NPS servers.</span></span> 
2. <span data-ttu-id="b8e07-110">**Сервер политики сети** подключается к Active Directory и выполняет первичную проверку подлинности по запросам RADIUS. В случае успеха он передает запрос в установленные расширения.</span><span class="sxs-lookup"><span data-stu-id="b8e07-110">**NPS Server** connects to Active Directory to perform the primary authentication for the RADIUS requests and, upon success, passes the request to any installed extensions.</span></span>  
3. <span data-ttu-id="b8e07-111">**Расширение NPS** активирует запрос к MFA Azure для проведения дополнительной проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="b8e07-111">**NPS Extension** triggers a request to Azure MFA for the secondary authentication.</span></span> <span data-ttu-id="b8e07-112">Когда расширение получает ответ (при условии, что запрос MFA выполнен успешно), расширение завершает процесс проверки подлинности, возвращая серверу NPS маркеры безопасности, которые включают утверждение многофакторной идентификации, выданное службой маркеров безопасности Azure.</span><span class="sxs-lookup"><span data-stu-id="b8e07-112">Once the extension receives the response, and if the MFA challenge succeeds, it completes the authentication request by providing the NPS server with security tokens that include an MFA claim, issued by Azure STS.</span></span>  
4. <span data-ttu-id="b8e07-113">**Azure MFA** обращается к Azure Active Directory для получения сведений о пользователе и выполняет дополнительную проверку подлинности по тому методу, который настроен для этого пользователя.</span><span class="sxs-lookup"><span data-stu-id="b8e07-113">**Azure MFA** communicates with Azure Active Directory to retrieve the user’s details and performs the secondary authentication using a verification method configured to the user.</span></span>

<span data-ttu-id="b8e07-114">На следующей схеме обобщенно представлена последовательность запросов на проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="b8e07-114">The following diagram illustrates this high-level authentication request flow:</span></span> 

![Схема последовательности проверки подлинности](./media/multi-factor-authentication-nps-extension/auth-flow.png)

## <a name="plan-your-deployment"></a><span data-ttu-id="b8e07-116">Планирование развертывания</span><span class="sxs-lookup"><span data-stu-id="b8e07-116">Plan your deployment</span></span>

<span data-ttu-id="b8e07-117">Расширение NPS автоматически обрабатывает избыточность, поэтому специальная настройка не требуется.</span><span class="sxs-lookup"><span data-stu-id="b8e07-117">The NPS extension automatically handles redundancy, so you don't need a special configuration.</span></span>

<span data-ttu-id="b8e07-118">Можно создать столько NPS-серверов с поддержкой Azure MFA, сколько требуется.</span><span class="sxs-lookup"><span data-stu-id="b8e07-118">You can create as many Azure MFA-enabled NPS servers as you need.</span></span> <span data-ttu-id="b8e07-119">При установке нескольких серверов для каждого из них следует использовать отдельный сертификат клиента.</span><span class="sxs-lookup"><span data-stu-id="b8e07-119">If you do install multiple servers, you should use a difference client certificate for each one of them.</span></span> <span data-ttu-id="b8e07-120">Создание сертификата для каждого сервера означает, что можно обновлять каждый сертификат по отдельности и не беспокоиться об одновременных простоях всех серверов.</span><span class="sxs-lookup"><span data-stu-id="b8e07-120">Creating a cert for each server means that you can update each cert individually, and not worry about downtime across all your servers.</span></span>

<span data-ttu-id="b8e07-121">VPN-серверы перенаправляют запросы на аутентификацию, поэтому они должны знать о новых NPS-серверах с поддержкой Многофакторной идентификации Azure.</span><span class="sxs-lookup"><span data-stu-id="b8e07-121">VPN servers route authentication requests, so they need to be aware of the new Azure MFA-enabled NPS servers.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="b8e07-122">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="b8e07-122">Prerequisites</span></span>

<span data-ttu-id="b8e07-123">Расширение NPS предназначено для работы с существующей инфраструктурой.</span><span class="sxs-lookup"><span data-stu-id="b8e07-123">The NPS extension is meant to work with your existing infrastructure.</span></span> <span data-ttu-id="b8e07-124">Прежде чем приступить к работе, убедитесь, что у вас есть следующие необходимые компоненты.</span><span class="sxs-lookup"><span data-stu-id="b8e07-124">Make sure you have the following prerequisites before you begin.</span></span>

### <a name="licenses"></a><span data-ttu-id="b8e07-125">Лицензии</span><span class="sxs-lookup"><span data-stu-id="b8e07-125">Licenses</span></span>

<span data-ttu-id="b8e07-126">Расширение NPS для Многофакторной идентификации Azure доступно для клиентов с [лицензией на MFA Azure](multi-factor-authentication.md) (входит в состав подписок Azure AD Premium, EMS и MFA).</span><span class="sxs-lookup"><span data-stu-id="b8e07-126">The NPS Extension for Azure MFA is available to customers with [licenses for Azure Multi-Factor Authentication](multi-factor-authentication.md) (included with Azure AD Premium, EMS, or an MFA subscription).</span></span>

### <a name="software"></a><span data-ttu-id="b8e07-127">Программное обеспечение</span><span class="sxs-lookup"><span data-stu-id="b8e07-127">Software</span></span>

<span data-ttu-id="b8e07-128">Windows Server 2008 R2 с пакетом обновления 1 (SP1) или более поздняя версия.</span><span class="sxs-lookup"><span data-stu-id="b8e07-128">Windows Server 2008 R2 SP1 or above.</span></span>

### <a name="libraries"></a><span data-ttu-id="b8e07-129">Библиотеки</span><span class="sxs-lookup"><span data-stu-id="b8e07-129">Libraries</span></span>

<span data-ttu-id="b8e07-130">Эти библиотеки устанавливаются автоматически вместе с расширением.</span><span class="sxs-lookup"><span data-stu-id="b8e07-130">These libraries are installed automatically with the extension.</span></span>
-   [<span data-ttu-id="b8e07-131">Распространяемые пакеты Visual C++ для Visual Studio 2013 (X64)</span><span class="sxs-lookup"><span data-stu-id="b8e07-131">Visual C++ Redistributable Packages for Visual Studio 2013 (X64)</span></span>](https://www.microsoft.com/download/details.aspx?id=40784)
-   [<span data-ttu-id="b8e07-132">Модуль Microsoft Azure Active Directory для Windows PowerShell, версия 1.1.166</span><span class="sxs-lookup"><span data-stu-id="b8e07-132">Microsoft Azure Active Directory Module for Windows PowerShell version 1.1.166.0</span></span>](https://connect.microsoft.com/site1164/Downloads/DownloadDetails.aspx?DownloadID=59185)

### <a name="azure-active-directory"></a><span data-ttu-id="b8e07-133">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="b8e07-133">Azure Active Directory</span></span>

<span data-ttu-id="b8e07-134">Все пользователи, использующие расширение NPS, должны синхронизироваться с Azure Active Directory с помощью Azure AD Connect и должны быть зарегистрированы в службе MFA.</span><span class="sxs-lookup"><span data-stu-id="b8e07-134">Everyone using the NPS extension must be synced to Azure Active Directory using Azure AD Connect, and must be registered for MFA.</span></span>

<span data-ttu-id="b8e07-135">Для установки расширения потребуются учетные данные администратора и идентификатор каталога для вашего клиента Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b8e07-135">When you install the extension, you need the directory ID and admin credentials for your Azure AD tenant.</span></span> <span data-ttu-id="b8e07-136">Идентификатор каталога вы можете найти на [портале Azure](https://portal.azure.com).</span><span class="sxs-lookup"><span data-stu-id="b8e07-136">You can find your directory ID in the [Azure portal](https://portal.azure.com).</span></span> <span data-ttu-id="b8e07-137">Войдите с учетными данными администратора, выберите значок **Azure Active Directory** слева, а затем выберите **Свойства**.</span><span class="sxs-lookup"><span data-stu-id="b8e07-137">Sign in as an administrator, select the **Azure Active Directory** icon on the left, then select **Properties**.</span></span> <span data-ttu-id="b8e07-138">Скопируйте значение GUID в поле **Directory ID** (Идентификатор каталога) и сохраните его.</span><span class="sxs-lookup"><span data-stu-id="b8e07-138">Copy the GUID in the **Directory ID** box and save it.</span></span> <span data-ttu-id="b8e07-139">Этот GUID используется как идентификатор клиента при установке расширения NPS.</span><span class="sxs-lookup"><span data-stu-id="b8e07-139">You use this GUID as the tenant ID when you install the NPS extension.</span></span>

![Поиск идентификатора каталога в разделе свойств для Azure Active Directory](./media/multi-factor-authentication-nps-extension/find-directory-id.png)

## <a name="prepare-your-environment"></a><span data-ttu-id="b8e07-141">Подготовка среды</span><span class="sxs-lookup"><span data-stu-id="b8e07-141">Prepare your environment</span></span>

<span data-ttu-id="b8e07-142">Прежде чем устанавливать расширение NPS, следует подготовить среду для обработки трафика аутентификации.</span><span class="sxs-lookup"><span data-stu-id="b8e07-142">Before you install the NPS extension, you want to prepare you environment to handle the authentication traffic.</span></span>

### <a name="enable-the-nps-role-on-a-domain-joined-server"></a><span data-ttu-id="b8e07-143">Включение роли NPS на сервере, присоединенном к домену</span><span class="sxs-lookup"><span data-stu-id="b8e07-143">Enable the NPS role on a domain-joined server</span></span>

<span data-ttu-id="b8e07-144">NPS-сервер подключается к Azure Active Directory и аутентифицирует запросы MFA.</span><span class="sxs-lookup"><span data-stu-id="b8e07-144">The NPS server connects to Azure Active Directory and authenticates the MFA requests.</span></span> <span data-ttu-id="b8e07-145">Выберите один сервер для этой роли.</span><span class="sxs-lookup"><span data-stu-id="b8e07-145">Choose one server for this role.</span></span> <span data-ttu-id="b8e07-146">Рекомендуется выбрать сервер, который не обрабатывает запросы от других служб, так как расширение NPS выдает ошибки для всех запросов, которые не являются запросами RADIUS.</span><span class="sxs-lookup"><span data-stu-id="b8e07-146">We recommend choosing a server that doesn't handle requests from other services, because the NPS extension throws errors for any requests that aren't RADIUS.</span></span>

1. <span data-ttu-id="b8e07-147">Откройте на сервере **мастер добавления ролей и компонентов**, воспользовавшись меню быстрого запуска диспетчера сервера.</span><span class="sxs-lookup"><span data-stu-id="b8e07-147">On your server, open the **Add Roles and Features Wizard** from the Server Manager Quickstart menu.</span></span>
2. <span data-ttu-id="b8e07-148">Щелкните **Установка ролей или компонентов** для используемого типа установки.</span><span class="sxs-lookup"><span data-stu-id="b8e07-148">Choose **Role-based or feature-based installation** for your installation type.</span></span>
3. <span data-ttu-id="b8e07-149">Выберите роль сервера **Службы политики сети и доступа**.</span><span class="sxs-lookup"><span data-stu-id="b8e07-149">Select the **Network Policy and Access Services** server role.</span></span> <span data-ttu-id="b8e07-150">Может появиться окно, сообщающее о необходимых компонентах для выполнения этой роли.</span><span class="sxs-lookup"><span data-stu-id="b8e07-150">A window may pop up to inform you of required features to run this role.</span></span>
4. <span data-ttu-id="b8e07-151">Следуйте дальнейшим указаниям мастера, пока не перейдете к странице подтверждения.</span><span class="sxs-lookup"><span data-stu-id="b8e07-151">Continue through the wizard until the Confirmation page.</span></span> <span data-ttu-id="b8e07-152">Щелкните **Установить**.</span><span class="sxs-lookup"><span data-stu-id="b8e07-152">Select **Install**.</span></span>

<span data-ttu-id="b8e07-153">Теперь назначенный NPS-сервер следует настроить для обработки входящих запросов RADIUS от решения VPN.</span><span class="sxs-lookup"><span data-stu-id="b8e07-153">Now that you have a server designated for NPS, you should also configure this server to handle incoming RADIUS requests from the VPN solution.</span></span>

### <a name="configure-your-vpn-solution-to-communicate-with-the-nps-server"></a><span data-ttu-id="b8e07-154">Настройка решения VPN для обмена данными с NPS-сервером</span><span class="sxs-lookup"><span data-stu-id="b8e07-154">Configure your VPN solution to communicate with the NPS server</span></span>

<span data-ttu-id="b8e07-155">В зависимости от того, какое решение VPN используется, действия по настройке политики аутентификации RADIUS могут отличаться.</span><span class="sxs-lookup"><span data-stu-id="b8e07-155">Depending on which VPN solution you use, the steps to configure your RADIUS authentication policy vary.</span></span> <span data-ttu-id="b8e07-156">Настройте эту политику, указав NPS-сервер RADIUS.</span><span class="sxs-lookup"><span data-stu-id="b8e07-156">Configure this policy to point to your RADIUS NPS server.</span></span>

### <a name="sync-domain-users-to-the-cloud"></a><span data-ttu-id="b8e07-157">Синхронизация пользователей домена с облаком</span><span class="sxs-lookup"><span data-stu-id="b8e07-157">Sync domain users to the cloud</span></span>

<span data-ttu-id="b8e07-158">Возможно, этот шаг уже выполнен в клиенте, но рекомендуется еще раз убедиться, что служба Azure AD Connect недавно синхронизировала базы данных.</span><span class="sxs-lookup"><span data-stu-id="b8e07-158">This step may already be complete on your tenant, but it's good to double-check that Azure AD Connect has synchronized your databases recently.</span></span>

1. <span data-ttu-id="b8e07-159">Войдите на [портал Azure](https://portal.azure.com) с использованием учетной записи администратора.</span><span class="sxs-lookup"><span data-stu-id="b8e07-159">Sign in to the [Azure portal](https://portal.azure.com) as an administrator.</span></span>
2. <span data-ttu-id="b8e07-160">Щелкните **Azure Active Directory** > **Azure AD Connect**.</span><span class="sxs-lookup"><span data-stu-id="b8e07-160">Select **Azure Active Directory** > **Azure AD Connect**</span></span>
3. <span data-ttu-id="b8e07-161">Убедитесь в том, что синхронизация находится в состоянии **Включена** и последняя синхронизация была выполнена менее часа назад.</span><span class="sxs-lookup"><span data-stu-id="b8e07-161">Verify that your sync status is **Enabled** and that your last sync was less than an hour ago.</span></span>

<span data-ttu-id="b8e07-162">Если требуется начать новый цикл синхронизации, следуйте инструкциям в разделе [Синхронизация Azure AD Connect: планировщик](../active-directory/connect/active-directory-aadconnectsync-feature-scheduler.md#start-the-scheduler).</span><span class="sxs-lookup"><span data-stu-id="b8e07-162">If you need to kick off a new round of synchronization, us the instructions in [Azure AD Connect sync: Scheduler](../active-directory/connect/active-directory-aadconnectsync-feature-scheduler.md#start-the-scheduler).</span></span>

### <a name="determine-which-authentication-methods-your-users-can-use"></a><span data-ttu-id="b8e07-163">Определение методов проверки подлинности, которые смогут использовать пользователи</span><span class="sxs-lookup"><span data-stu-id="b8e07-163">Determine which authentication methods your users can use</span></span>

<span data-ttu-id="b8e07-164">Существует два фактора, влияющих на то, какие методы проверки подлинности доступны для развертывания расширения сервера политики сети (NPS):</span><span class="sxs-lookup"><span data-stu-id="b8e07-164">There are two factors that affect which authentication methods are available with an NPS extension deployment:</span></span>

1. <span data-ttu-id="b8e07-165">Алгоритм шифрования пароля для обмена данными между клиентом RADIUS (VPN, сервером Netscaler или другим) и серверами NPS.</span><span class="sxs-lookup"><span data-stu-id="b8e07-165">The password encryption algorithm used between the RADIUS client (VPN, Netscaler server, or other) and the NPS servers.</span></span>
   - <span data-ttu-id="b8e07-166">**PAP** поддерживает все методы аутентификации Azure MFA в облаке: телефонный звонок, одностороннее текстовое сообщение, уведомление мобильного приложения и код проверки мобильного приложения.</span><span class="sxs-lookup"><span data-stu-id="b8e07-166">**PAP** supports all the authentication methods of Azure MFA in the cloud: phone call, one-way text message, mobile app notification, and mobile app verification code.</span></span>
   - <span data-ttu-id="b8e07-167">**CHAPV2** и **EAP** поддерживают телефонный звонок или уведомление мобильного приложения.</span><span class="sxs-lookup"><span data-stu-id="b8e07-167">**CHAPV2** and **EAP** support phone call and mobile app notification.</span></span>
2. <span data-ttu-id="b8e07-168">Методы ввода, которые может обработать клиентское приложение (VPN, сервер Netscaler или другое).</span><span class="sxs-lookup"><span data-stu-id="b8e07-168">The input methods that the client application (VPN, Netscaler server, or other) can handle.</span></span> <span data-ttu-id="b8e07-169">Например, может ли VPN-клиент разрешить пользователю вводить код проверки из мобильного приложения или текста?</span><span class="sxs-lookup"><span data-stu-id="b8e07-169">For example, does the VPN client have some means to allow the user to type in a verification code from a text or mobile app?</span></span>

<span data-ttu-id="b8e07-170">При развертывании расширения NPS используйте эти факторы, чтобы оценить, какие методы будут доступны для пользователей.</span><span class="sxs-lookup"><span data-stu-id="b8e07-170">When you deploy the NPS extension, use these factors to evaluate which methods are available for your users.</span></span> <span data-ttu-id="b8e07-171">Если клиент RADIUS поддерживает протокол PAP, а клиент UX не имеет полей ввода для проверки кода, тогда телефонный звонок или уведомление мобильного приложения являются подходящими вариантами.</span><span class="sxs-lookup"><span data-stu-id="b8e07-171">If your RADIUS client supports PAP, but the client UX doesn't have input fields for a verification code, then phone call and mobile app notification are the two supported options.</span></span>

<span data-ttu-id="b8e07-172">Вы можете [отключить неподдерживаемые методы проверки подлинности](multi-factor-authentication-whats-next.md#selectable-verification-methods) в Azure.</span><span class="sxs-lookup"><span data-stu-id="b8e07-172">You can [disable unsupported authentication methods](multi-factor-authentication-whats-next.md#selectable-verification-methods) in Azure.</span></span>

### <a name="enable-users-for-mfa"></a><span data-ttu-id="b8e07-173">Включение MFA для пользователей</span><span class="sxs-lookup"><span data-stu-id="b8e07-173">Enable users for MFA</span></span>

<span data-ttu-id="b8e07-174">Перед полным развертыванием расширения NPS необходимо включить MFA для пользователей, которым следует проходить двухфакторную проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="b8e07-174">Before you deploy the full NPS extension, you need to enable MFA for the users that you want to perform two-step verification.</span></span> <span data-ttu-id="b8e07-175">Сейчас же, чтобы проверить расширения после развертывания, необходима по крайней мере одна тестовая учетная запись, полностью зарегистрированная для использования Многофакторной идентификации.</span><span class="sxs-lookup"><span data-stu-id="b8e07-175">More immediately, to test the extension as you deploy it, you need at least one test account that is fully registered for Multi-Factor Authentication.</span></span>

<span data-ttu-id="b8e07-176">Чтобы приступить к работе с тестовой учетной записью, выполните следующее.</span><span class="sxs-lookup"><span data-stu-id="b8e07-176">Use these steps to get a test account started:</span></span>
1. <span data-ttu-id="b8e07-177">С помощью тестовой учетной записи войдите в систему на странице [https://aka.ms/mfasetup](https://aka.ms/mfasetup).</span><span class="sxs-lookup"><span data-stu-id="b8e07-177">Sign in to [https://aka.ms/mfasetup](https://aka.ms/mfasetup) with a test account.</span></span> 
2. <span data-ttu-id="b8e07-178">Чтобы настроить методы проверки, следуйте инструкциям на экране.</span><span class="sxs-lookup"><span data-stu-id="b8e07-178">Follow the prompts to set up a verification method.</span></span>
3. <span data-ttu-id="b8e07-179">Создайте политику условного доступа или [измените состояние пользователя](multi-factor-authentication-get-started-user-states.md), чтобы требовать двухфакторную проверку подлинности для тестовой учетной записи.</span><span class="sxs-lookup"><span data-stu-id="b8e07-179">Either create a conditional access policy or [change the user state](multi-factor-authentication-get-started-user-states.md) to require two-step verification for the test account.</span></span> 

<span data-ttu-id="b8e07-180">Пользователям также необходимо выполнить эти действия для регистрации, чтобы проходить проверку подлинности с помощью расширения NPS.</span><span class="sxs-lookup"><span data-stu-id="b8e07-180">Your users also need to follow these steps to enroll before they can authenticate with the NPS extension.</span></span>

## <a name="install-the-nps-extension"></a><span data-ttu-id="b8e07-181">Установка расширения NPS</span><span class="sxs-lookup"><span data-stu-id="b8e07-181">Install the NPS extension</span></span>

> [!IMPORTANT]
> <span data-ttu-id="b8e07-182">Установите расширение NPS на другом сервере, который не является точкой доступа VPN.</span><span class="sxs-lookup"><span data-stu-id="b8e07-182">Install the NPS extension on a different server than the VPN access point.</span></span>

### <a name="download-and-install-the-nps-extension-for-azure-mfa"></a><span data-ttu-id="b8e07-183">Скачивание и установка расширения NPS для MFA Azure</span><span class="sxs-lookup"><span data-stu-id="b8e07-183">Download and install the NPS extension for Azure MFA</span></span>

1.  <span data-ttu-id="b8e07-184">[Скачайте расширение NPS](https://aka.ms/npsmfa) из Центра загрузки Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="b8e07-184">[Download the NPS Extension](https://aka.ms/npsmfa) from the Microsoft Download Center.</span></span>
2.  <span data-ttu-id="b8e07-185">Скопируйте этот двоичный файл на сервер политики сети, который требуется настроить.</span><span class="sxs-lookup"><span data-stu-id="b8e07-185">Copy the binary to the Network Policy Server you want to configure.</span></span>
3.  <span data-ttu-id="b8e07-186">Запустите файл *setup.exe* и следуйте инструкциям по установке.</span><span class="sxs-lookup"><span data-stu-id="b8e07-186">Run *setup.exe* and follow the installation instructions.</span></span> <span data-ttu-id="b8e07-187">При возникновении ошибок проверьте, были ли успешно установлены две библиотеки из раздела необходимых компонентов.</span><span class="sxs-lookup"><span data-stu-id="b8e07-187">If you encounter errors, double-check that the two libraries from the prerequisite section were successfully installed.</span></span>

### <a name="run-the-powershell-script"></a><span data-ttu-id="b8e07-188">Запуск сценария PowerShell</span><span class="sxs-lookup"><span data-stu-id="b8e07-188">Run the PowerShell script</span></span>

<span data-ttu-id="b8e07-189">Установщик создаст сценарий PowerShell в этом расположении: `C:\Program Files\Microsoft\AzureMfa\Config` (где C:\ — диск установки).</span><span class="sxs-lookup"><span data-stu-id="b8e07-189">The installer creates a PowerShell script in this location: `C:\Program Files\Microsoft\AzureMfa\Config` (where C:\ is your installation drive).</span></span> <span data-ttu-id="b8e07-190">Скрипт PowerShell выполняет следующие действия.</span><span class="sxs-lookup"><span data-stu-id="b8e07-190">This PowerShell script performs the following actions:</span></span>

-   <span data-ttu-id="b8e07-191">Создать самозаверяющий сертификат.</span><span class="sxs-lookup"><span data-stu-id="b8e07-191">Create a self-signed certificate.</span></span>
-   <span data-ttu-id="b8e07-192">Связывает открытый ключ сертификата с субъектом-службой в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b8e07-192">Associate the public key of the certificate to the service principal on Azure AD.</span></span>
-   <span data-ttu-id="b8e07-193">Сохраняет сертификат в хранилище сертификатов на локальном компьютере.</span><span class="sxs-lookup"><span data-stu-id="b8e07-193">Store the cert in the local machine cert store.</span></span>
-   <span data-ttu-id="b8e07-194">Предоставляет пользователю в сети доступ к закрытому ключу сертификата.</span><span class="sxs-lookup"><span data-stu-id="b8e07-194">Grant access to the certificate’s private key to Network User.</span></span>
-   <span data-ttu-id="b8e07-195">Перезапускает расширение NPS.</span><span class="sxs-lookup"><span data-stu-id="b8e07-195">Restart the NPS.</span></span>

<span data-ttu-id="b8e07-196">Если вы не намерены использовать собственные сертификаты (вместо самозаверяющих сертификатов, которые создает скрипт PowerShell), запустите скрипт PowerShell для завершения установки.</span><span class="sxs-lookup"><span data-stu-id="b8e07-196">Unless you want to use your own certificates (instead of the self-signed certificates that the PowerShell script generates), run the PowerShell Script to complete the installation.</span></span> <span data-ttu-id="b8e07-197">Если установить расширение на нескольких серверах, каждый из них должен использовать собственный сертификат.</span><span class="sxs-lookup"><span data-stu-id="b8e07-197">If you install the extension on multiple servers, each one should have its own certificate.</span></span>

1. <span data-ttu-id="b8e07-198">Запустите Windows PowerShell от имени администратора.</span><span class="sxs-lookup"><span data-stu-id="b8e07-198">Run Windows PowerShell as an administrator.</span></span>
2. <span data-ttu-id="b8e07-199">Перейдите в соответствующий каталог.</span><span class="sxs-lookup"><span data-stu-id="b8e07-199">Change directories.</span></span>

   `cd "C:\Program Files\Microsoft\AzureMfa\Config"`

3. <span data-ttu-id="b8e07-200">Запустите сценарий PowerShell, созданный установщиком.</span><span class="sxs-lookup"><span data-stu-id="b8e07-200">Run the PowerShell script created by the installer.</span></span>

   `.\AzureMfaNpsExtnConfigSetup.ps1`

4. <span data-ttu-id="b8e07-201">PowerShell запросит ваш идентификатор клиента.</span><span class="sxs-lookup"><span data-stu-id="b8e07-201">PowerShell prompts for your tenant ID.</span></span> <span data-ttu-id="b8e07-202">Введите GUID каталога, скопированный с портала Azure при выполнении предварительных требований.</span><span class="sxs-lookup"><span data-stu-id="b8e07-202">Use the Directory ID GUID that you copied from the Azure portal in the prerequisites section.</span></span>
5. <span data-ttu-id="b8e07-203">Войдите в Azure AD как администратор.</span><span class="sxs-lookup"><span data-stu-id="b8e07-203">Sign in to Azure AD as an administrator.</span></span>
6. <span data-ttu-id="b8e07-204">PowerShell отобразит сообщение об успешном выполнении после завершения сценария.</span><span class="sxs-lookup"><span data-stu-id="b8e07-204">PowerShell shows a success message when the script is finished.</span></span>  

<span data-ttu-id="b8e07-205">Повторите эти действия на всех дополнительных серверах NPS, которые необходимо настроить для балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="b8e07-205">Repeat these steps on any additional NPS servers that you want to set up for load balancing.</span></span>

>[!NOTE]
><span data-ttu-id="b8e07-206">При использовании собственных сертификатов вместо их создания с помощью сценария PowerShell убедитесь, что они соответствуют соглашению об именовании сервера политики сети.</span><span class="sxs-lookup"><span data-stu-id="b8e07-206">If you use your own certificates instead of generating certificates with the PowerShell script, make sure that they align to the NPS naming convention.</span></span> <span data-ttu-id="b8e07-207">Имя субъекта-службы будет иметь значение **CN \<TenantID\>, а OU — Microsoft NPS Extension**.</span><span class="sxs-lookup"><span data-stu-id="b8e07-207">The subject name must be **CN=\<TenantID\>,OU=Microsoft NPS Extension**.</span></span> 

## <a name="configure-your-nps-extension"></a><span data-ttu-id="b8e07-208">Настройка расширения NPS</span><span class="sxs-lookup"><span data-stu-id="b8e07-208">Configure your NPS extension</span></span>

<span data-ttu-id="b8e07-209">Этот раздел содержит рекомендации по проектированию и успешному развертыванию расширения NPS.</span><span class="sxs-lookup"><span data-stu-id="b8e07-209">This section includes design considerations and suggestions for successful NPS extension deployments.</span></span>

### <a name="configuration-limitations"></a><span data-ttu-id="b8e07-210">Ограничения конфигурации</span><span class="sxs-lookup"><span data-stu-id="b8e07-210">Configuration limitations</span></span>

- <span data-ttu-id="b8e07-211">Расширение NPS для Azure MFA не включает в себя инструменты для переноса пользователей и настроек с сервера MFA в облако.</span><span class="sxs-lookup"><span data-stu-id="b8e07-211">The NPS extension for Azure MFA does not include tools to migrate users and settings from MFA Server to the cloud.</span></span> <span data-ttu-id="b8e07-212">По этой причине мы рекомендуем вам использовать расширение для новых развертываний, а не для существующего развертывания.</span><span class="sxs-lookup"><span data-stu-id="b8e07-212">For this reason, we suggest using the extension for new deployments, rather than existing deployment.</span></span> <span data-ttu-id="b8e07-213">При использовании расширения в существующем развертывании пользователям придется еще раз подтвердить свою личность, чтобы заполнить сведения для MFA в облаке.</span><span class="sxs-lookup"><span data-stu-id="b8e07-213">If you use the extension on an existing deployment, your users have to perform proof-up again to populate their MFA details in the cloud.</span></span>  
- <span data-ttu-id="b8e07-214">Расширение NPS использует имя участника-пользователя из локального каталога Active Directory и по нему определяет пользователя MFA Azure, для которого будет выполняться дополнительная проверка подлинности. Для этого расширения нельзя настроить использование других идентификаторов, например альтернативного имени для входа или настраиваемых полей Active Directory.</span><span class="sxs-lookup"><span data-stu-id="b8e07-214">The NPS extension uses the UPN from the on-premises Active directory to identify the user on Azure MFA for performing the Secondary Auth. The extension can be configured to use a different identifier like alternate login ID or custom Active Directory field other than UPN.</span></span> <span data-ttu-id="b8e07-215">См. дополнительные сведения о [параметрах расширенной конфигурации расширения NPS для Многофакторной идентификации](multi-factor-authentication-advanced-vpn-configurations.md).</span><span class="sxs-lookup"><span data-stu-id="b8e07-215">See [Advanced configuration options for the NPS extension for Multi-Factor Authentication](multi-factor-authentication-advanced-vpn-configurations.md) for more information.</span></span>
- <span data-ttu-id="b8e07-216">Не все протоколы шифрования поддерживают все методы проверки.</span><span class="sxs-lookup"><span data-stu-id="b8e07-216">Not all encryption protocols support all verification methods.</span></span>
   - <span data-ttu-id="b8e07-217">**PAP** поддерживает такие методы: телефонный звонок, одностороннее текстовое сообщение, уведомление мобильного приложения и код проверки мобильного приложения.</span><span class="sxs-lookup"><span data-stu-id="b8e07-217">**PAP** supports phone call, one-way text message, mobile app notification, and mobile app verification code</span></span>
   - <span data-ttu-id="b8e07-218">**CHAPV2** и **EAP** поддерживают телефонный звонок или уведомление мобильного приложения.</span><span class="sxs-lookup"><span data-stu-id="b8e07-218">**CHAPV2** and **EAP** support phone call and mobile app notification</span></span>

### <a name="control-radius-clients-that-require-mfa"></a><span data-ttu-id="b8e07-219">Управление клиентами RADIUS, для которых требуется MFA</span><span class="sxs-lookup"><span data-stu-id="b8e07-219">Control RADIUS clients that require MFA</span></span>

<span data-ttu-id="b8e07-220">Когда вы включаете для клиента RADIUS поддержку MFA с помощью расширения NPS, все сеансы проверки подлинности для этого клиента могут выполняться только с использованием MFA.</span><span class="sxs-lookup"><span data-stu-id="b8e07-220">Once you enable MFA for a RADIUS client using the NPS Extension, all authentications for this client are required to perform MFA.</span></span> <span data-ttu-id="b8e07-221">Если вы хотите включить MFA только для отдельных клиентов RADIUS, настройте два сервера NPS и установите расширение только на один из них.</span><span class="sxs-lookup"><span data-stu-id="b8e07-221">If you want to enable MFA for some RADIUS clients but not others, you can configure two NPS servers and install the extension on only one of them.</span></span> <span data-ttu-id="b8e07-222">Затем настройте для клиентов RADIUS, которые должны использовать MFA, отправку запросов на сервер NPS, на котором установлено это расширение. Всех остальных клиентов RADIUS направьте на другой сервер NPS, для которого расширение не используется.</span><span class="sxs-lookup"><span data-stu-id="b8e07-222">Configure RADIUS clients that you want to require MFA to send requests to the NPS server configured with the extension, and other RADIUS clients to the NPS server not configured with the extension.</span></span>

### <a name="prepare-for-users-that-arent-enrolled-for-mfa"></a><span data-ttu-id="b8e07-223">Подготовка к входу пользователей, не зарегистрированных для MFA</span><span class="sxs-lookup"><span data-stu-id="b8e07-223">Prepare for users that aren't enrolled for MFA</span></span>

<span data-ttu-id="b8e07-224">Если у вас есть пользователи, не зарегистрированные для MFA, вы можете выбрать действие, которое будет выполняться при попытке проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="b8e07-224">If you have users that aren't enrolled for MFA, you can determine what happens when they try to authenticate.</span></span> <span data-ttu-id="b8e07-225">Для управления этим поведением используйте параметр реестра *REQUIRE_USER_MATCH*, расположенный в пути *HKLM\Software\Microsoft\AzureMFA*.</span><span class="sxs-lookup"><span data-stu-id="b8e07-225">Use the registry setting *REQUIRE_USER_MATCH* in the registry path *HKLM\Software\Microsoft\AzureMFA* to control the feature behavior.</span></span> <span data-ttu-id="b8e07-226">Здесь есть только один параметр конфигурации:</span><span class="sxs-lookup"><span data-stu-id="b8e07-226">This setting has a single configuration option:</span></span>

| <span data-ttu-id="b8e07-227">Ключ</span><span class="sxs-lookup"><span data-stu-id="b8e07-227">Key</span></span> | <span data-ttu-id="b8e07-228">Значение</span><span class="sxs-lookup"><span data-stu-id="b8e07-228">Value</span></span> | <span data-ttu-id="b8e07-229">значение по умолчанию</span><span class="sxs-lookup"><span data-stu-id="b8e07-229">Default</span></span> |
| --- | ----- | ------- |
| <span data-ttu-id="b8e07-230">REQUIRE_USER_MATCH</span><span class="sxs-lookup"><span data-stu-id="b8e07-230">REQUIRE_USER_MATCH</span></span> | <span data-ttu-id="b8e07-231">True или false</span><span class="sxs-lookup"><span data-stu-id="b8e07-231">TRUE/FALSE</span></span> | <span data-ttu-id="b8e07-232">Не задано (эквивалентно значению True)</span><span class="sxs-lookup"><span data-stu-id="b8e07-232">Not set (equivalent to TRUE)</span></span> |

<span data-ttu-id="b8e07-233">Этот параметр определяет, что нужно делать при проверке подлинности пользователя, не зарегистрированного для MFA.</span><span class="sxs-lookup"><span data-stu-id="b8e07-233">The purpose of this setting is to determine what to do when a user is not enrolled for MFA.</span></span> <span data-ttu-id="b8e07-234">Если этот ключ не существует, не задан или имеет значение True, то для незарегистрированного пользователя проверка MFA считается не пройденной.</span><span class="sxs-lookup"><span data-stu-id="b8e07-234">When the key does not exist, is not set, or is set to TRUE, and the user is not enrolled, then the extension fails the MFA challenge.</span></span> <span data-ttu-id="b8e07-235">Если этот ключ имеет значение False, то для незарегистрированного пользователя проверка подлинности выполняется без MFA.</span><span class="sxs-lookup"><span data-stu-id="b8e07-235">When the key is set to FALSE and the user is not enrolled, authentication proceeds without performing MFA.</span></span>

<span data-ttu-id="b8e07-236">Вы можете создать этот ключ и присвоить ему значение False, если пользователи подключаются, но еще не зарегистрированы для Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="b8e07-236">You can choose to create this key and set it to FALSE while your users are onboarding, and may not all be enrolled for Azure MFA yet.</span></span> <span data-ttu-id="b8e07-237">Однако такая настройка ключа разрешает вход всем пользователям, которые не зарегистрированы для MFA, поэтому этот ключ следует удалить до начала использования в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="b8e07-237">However, since setting the key permits users that aren't enrolled for MFA to sign in, you should remove this key before going to production.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="b8e07-238">Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="b8e07-238">Troubleshooting</span></span>

### <a name="how-do-i-verify-that-the-client-cert-is-installed-as-expected"></a><span data-ttu-id="b8e07-239">Как проверить, правильно ли установлен сертификат клиента?</span><span class="sxs-lookup"><span data-stu-id="b8e07-239">How do I verify that the client cert is installed as expected?</span></span>

<span data-ttu-id="b8e07-240">Найдите самозаверяющий сертификат, созданный установщиком в хранилище сертификатов, и убедитесь, что его закрытый ключ имеет разрешения, предоставленные пользователю **NETWORK SERVICE**.</span><span class="sxs-lookup"><span data-stu-id="b8e07-240">Look for the self-signed certificate created by the installer in the cert store, and check that the private key has permissions granted to user **NETWORK SERVICE**.</span></span> <span data-ttu-id="b8e07-241">У этого сертификата имя субъекта-службы будет иметь значение **CN \<tenantid\>, а OU — Microsoft NPS Extension**.</span><span class="sxs-lookup"><span data-stu-id="b8e07-241">The cert has a subject name of **CN \<tenantid\>, OU = Microsoft NPS Extension**</span></span>

-------------------------------------------------------------

### <a name="how-can-i-verify-that-my-client-cert-is-associated-to-my-tenant-in-azure-active-directory"></a><span data-ttu-id="b8e07-242">Как проверить, связан ли сертификат клиента с правильным клиентом в Azure Active Directory?</span><span class="sxs-lookup"><span data-stu-id="b8e07-242">How can I verify that my client cert is associated to my tenant in Azure Active Directory?</span></span>

<span data-ttu-id="b8e07-243">Откройте командную строку PowerShell и выполните следующие команды:</span><span class="sxs-lookup"><span data-stu-id="b8e07-243">Open PowerShell command prompt and run the following commands:</span></span>

```
import-module MSOnline
Connect-MsolService
Get-MsolServicePrincipalCredential -AppPrincipalId "981f26a1-7f43-403b-a875-f8b09b8cd720" -ReturnKeyValues 1 
```

<span data-ttu-id="b8e07-244">Эти команды выводят в сеанс PowerShell все сертификаты, благодаря которым ваш клиент связывается с экземпляром расширения NPS.</span><span class="sxs-lookup"><span data-stu-id="b8e07-244">These commands print all the certificates associating your tenant with your instance of the NPS extension in your PowerShell session.</span></span> <span data-ttu-id="b8e07-245">Экспортируйте сертификат клиента в файл в кодировке Base-64 X.509 (CER) без закрытого ключа и сравните его со списком в PowerShell, чтобы найти соответствие.</span><span class="sxs-lookup"><span data-stu-id="b8e07-245">Look for your certificate by exporting your client cert as a "Base-64 encoded X.509(.cer)" file without the private key, and compare it with the list from PowerShell.</span></span>

<span data-ttu-id="b8e07-246">Метки времени Valid-From и Valid-Until, которые имеют понятный для человека формат, позволят отфильтровать очевидные несоответствия, если команда возвращает более одного сертификата.</span><span class="sxs-lookup"><span data-stu-id="b8e07-246">Valid-From and Valid-Until timestamps, which are in human-readable form, can be used to filter out obvious misfits if the command returns more than one cert.</span></span>

-------------------------------------------------------------

### <a name="why-are-my-requests-failing-with-adal-token-error"></a><span data-ttu-id="b8e07-247">Почему запросы завершаются сбоем с ошибкой маркера ADAL?</span><span class="sxs-lookup"><span data-stu-id="b8e07-247">Why are my requests failing with ADAL token error?</span></span>

<span data-ttu-id="b8e07-248">Эта ошибка может быть вызвана одной из нескольких причин.</span><span class="sxs-lookup"><span data-stu-id="b8e07-248">This error could be due to one of several reasons.</span></span> <span data-ttu-id="b8e07-249">Выполните следующие действия для устранения неполадок.</span><span class="sxs-lookup"><span data-stu-id="b8e07-249">Use these steps to help troubleshoot:</span></span>

1. <span data-ttu-id="b8e07-250">Перезагрузите сервер политики сети.</span><span class="sxs-lookup"><span data-stu-id="b8e07-250">Restart your NPS server.</span></span>
2. <span data-ttu-id="b8e07-251">Убедитесь, что сертификат клиента установлен правильно.</span><span class="sxs-lookup"><span data-stu-id="b8e07-251">Verify that that client cert is installed as expected.</span></span>
3. <span data-ttu-id="b8e07-252">Убедитесь, что сертификат связан с клиентом в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b8e07-252">Verify that the certificate is associated with your tenant on Azure AD.</span></span>
4. <span data-ttu-id="b8e07-253">Убедитесь, что адрес https://login.microsoftonline.com/ доступен с сервера, на котором выполняется расширение.</span><span class="sxs-lookup"><span data-stu-id="b8e07-253">Verify that https://login.microsoftonline.com/ is accessible from the server running the extension.</span></span>

-------------------------------------------------------------

### <a name="why-does-authentication-fail-with-an-error-in-http-logs-stating-that-the-user-is-not-found"></a><span data-ttu-id="b8e07-254">Почему проверка подлинности завершается ошибкой, а в журнал HTTP заносится ошибка с сообщением о том, что пользователь не найден?</span><span class="sxs-lookup"><span data-stu-id="b8e07-254">Why does authentication fail with an error in HTTP logs stating that the user is not found?</span></span>

<span data-ttu-id="b8e07-255">Убедитесь, что служба AD Connect работает, а нужный пользователь присутствует как в Windows Active Directory, так и в Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="b8e07-255">Verify that AD Connect is running, and that the user is present in both Windows Active Directory and Azure Active Directory.</span></span>

------------------------------------------------------------

### <a name="why-do-i-see-http-connect-errors-in-logs-with-all-my-authentications-failing"></a><span data-ttu-id="b8e07-256">Почему в журналах отображаются ошибки подключения HTTP для всех попыток проверки подлинности?</span><span class="sxs-lookup"><span data-stu-id="b8e07-256">Why do I see HTTP connect errors in logs with all my authentications failing?</span></span>

<span data-ttu-id="b8e07-257">Убедитесь, что адрес https://adnotifications.windowsazure.com доступен с сервера, на котором выполняется расширение NPS.</span><span class="sxs-lookup"><span data-stu-id="b8e07-257">Verify that https://adnotifications.windowsazure.com is reachable from the server running the NPS extension.</span></span>


## <a name="next-steps"></a><span data-ttu-id="b8e07-258">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="b8e07-258">Next steps</span></span>

- <span data-ttu-id="b8e07-259">Настройте альтернативные идентификаторы для входа или настройте список исключений IP-адресов, которым не нужно выполнять двухфакторную проверку подлинности, в [дополнительных параметрах конфигурации расширения NPS для Многофакторной идентификации](nps-extension-advanced-configuration.md)</span><span class="sxs-lookup"><span data-stu-id="b8e07-259">Configure alternate IDs for login, or set up an exception list for IPs that shouldn't perform two-step verification in [Advanced configuration options for the NPS extension for Multi-Factor Authentication](nps-extension-advanced-configuration.md)</span></span>

- [<span data-ttu-id="b8e07-260">Устранение ошибок, связанных с расширением NPS для Многофакторной идентификации Azure</span><span class="sxs-lookup"><span data-stu-id="b8e07-260">Resolve error messages from the NPS extension for Azure Multi-Factor Authentication</span></span>](multi-factor-authentication-nps-errors.md)

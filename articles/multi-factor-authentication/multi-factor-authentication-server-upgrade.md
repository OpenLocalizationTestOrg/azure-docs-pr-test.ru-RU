---
title: "Обновление сервера Azure MFA | Документация Майкрософт"
description: "Пошаговые инструкции по обновлению сервера Многофакторной идентификации Azure до более новой версии."
services: multi-factor-authentication
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 50bb8ac3-5559-4d8b-a96a-799a74978b14
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/16/2017
ms.author: kgremban
ms.reviewer: yossib
ms.custom: it-pro
ms.openlocfilehash: 6e4e09f8539aad56f92ad9137f4a6b9eb0d82370
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="upgrade-to-the-latest-azure-multi-factor-authentication-server"></a><span data-ttu-id="25bdc-103">Обновление сервера Многофакторной идентификации Azure до последней версии</span><span class="sxs-lookup"><span data-stu-id="25bdc-103">Upgrade to the latest Azure Multi-Factor Authentication Server</span></span>

<span data-ttu-id="25bdc-104">В этой статье описывается процесс обновления сервера Многофакторной идентификации (MFA) Azure до версии 6.0 или более поздней.</span><span class="sxs-lookup"><span data-stu-id="25bdc-104">This article walks you through the process of upgrading Azure Multi-Factor Authentication (MFA) Server v6.0 or higher.</span></span> <span data-ttu-id="25bdc-105">Если требуется обновить старую версию агента PhoneFactor, то см. статью [Переход с агента PhoneFactor на сервер Многофакторной идентификации Azure](multi-factor-authentication-get-started-server-upgrade.md).</span><span class="sxs-lookup"><span data-stu-id="25bdc-105">If you need to upgrade an old version of the PhoneFactor Agent, refer to [Upgrade the PhoneFactor Agent to Azure Multi-Factor Authentication Server](multi-factor-authentication-get-started-server-upgrade.md).</span></span>

<span data-ttu-id="25bdc-106">При обновлении с версии 6.x или более ранней до версии 7.x или более поздней все компоненты .NET 2.0 заменяются компонентами .NET 4.5.</span><span class="sxs-lookup"><span data-stu-id="25bdc-106">If you're upgrading from v6.x or older to v7.x or newer, all components change from .NET 2.0 to .NET 4.5.</span></span> <span data-ttu-id="25bdc-107">Для всех компонентов также требуется распространяемый компонент Microsoft Visual C++ 2015, обновление 1 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="25bdc-107">All components also require Microsoft Visual C++ 2015 Redistributable Update 1 or higher.</span></span> <span data-ttu-id="25bdc-108">Установщик сервера MFA установит версии x86 и x64 этих компонентов, если они еще не установлены.</span><span class="sxs-lookup"><span data-stu-id="25bdc-108">The MFA Server installer installs both the x86 and x64 versions of these components if they aren't already installed.</span></span> <span data-ttu-id="25bdc-109">Если пользовательский портал и веб-служба мобильного приложения работают на отдельных серверах, то необходимо установить эти пакеты, прежде чем обновлять данные компоненты.</span><span class="sxs-lookup"><span data-stu-id="25bdc-109">If the User Portal and Mobile App Web Service run on separate servers, you need to install those packages before upgrading those components.</span></span> <span data-ttu-id="25bdc-110">Последнее обновление распространяемого компонента Microsoft Visual C++ 2015 можно найти в [Центре загрузки Майкрософт](https://www.microsoft.com/en-us/download/).</span><span class="sxs-lookup"><span data-stu-id="25bdc-110">You can search for the latest Microsoft Visual C++ 2015 Redistributable update on the [Microsoft Download Center](https://www.microsoft.com/en-us/download/).</span></span> 

## <a name="install-the-latest-version-of-azure-mfa-server"></a><span data-ttu-id="25bdc-111">Установка последней версии сервера Azure MFA</span><span class="sxs-lookup"><span data-stu-id="25bdc-111">Install the latest version of Azure MFA Server</span></span>

1. <span data-ttu-id="25bdc-112">Следуйте указаниям в разделе [Загрузка сервера Azure Multi-Factor Authentication](multi-factor-authentication-get-started-server.md#download-the-azure-multi-factor-authentication-server), чтобы скачать последнюю версию сервера Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="25bdc-112">Use the instructions in [Download the Azure Multi-Factor Authentication Server](multi-factor-authentication-get-started-server.md#download-the-azure-multi-factor-authentication-server) to get the latest version of the Azure MFA Server.</span></span>
2. <span data-ttu-id="25bdc-113">Создайте резервную копию файла данных сервера MFA, который находится в расположении C:\Program Files\Multi-Factor Authentication Server\Data\PhoneFactor.pfdata (если расположение по умолчанию не было изменено при установке) на главном сервере MFA.</span><span class="sxs-lookup"><span data-stu-id="25bdc-113">Make a backup of the MFA Server data file located at C:\Program Files\Multi-Factor Authentication Server\Data\PhoneFactor.pfdata (assuming the default install location) on your master MFA Server.</span></span>
3. <span data-ttu-id="25bdc-114">Если для обеспечения высокой доступности работает несколько серверов, то измените клиентские системы, которые выполняют аутентификацию на сервере Mногофакторной идентификации, чтобы они прекратили отправлять трафик на обновляемые серверы Mногофакторной идентификации.</span><span class="sxs-lookup"><span data-stu-id="25bdc-114">If you run multiple servers for high availability, change the client systems that authenticate to the MFA Server so that they stop sending traffic to the servers that are upgrading.</span></span> <span data-ttu-id="25bdc-115">При использовании подсистемы балансировки нагрузки удалите из нее сервер Mногофакторной идентификации, выполните обновление, а затем снова добавьте сервер в ферму.</span><span class="sxs-lookup"><span data-stu-id="25bdc-115">If you use a load balancer, remove a MFA Server from the load balancer, do the upgrade, and then add the server back into the farm.</span></span>
4. <span data-ttu-id="25bdc-116">Запустите новый установщик на каждом сервере MFA.</span><span class="sxs-lookup"><span data-stu-id="25bdc-116">Run the new installer on each MFA Server.</span></span> <span data-ttu-id="25bdc-117">Сначала обновите подчиненные серверы, так как они смогут считывать устаревший файл данных, реплицируемый главным сервером.</span><span class="sxs-lookup"><span data-stu-id="25bdc-117">Upgrade subordinate servers first because they can read the old data file being replicated by the master.</span></span> 

  <span data-ttu-id="25bdc-118">Текущую версию сервера MFA не нужно удалять перед запуском установщика.</span><span class="sxs-lookup"><span data-stu-id="25bdc-118">You do not need to uninstall your current MFA Server before running the installer.</span></span> <span data-ttu-id="25bdc-119">Установщик выполняет обновление на месте.</span><span class="sxs-lookup"><span data-stu-id="25bdc-119">The installer performs an in-place upgrade.</span></span> <span data-ttu-id="25bdc-120">Путь установки берется из реестра предыдущей установки, поэтому сервер устанавливается в то же расположение (например, C:\Program Files\Multi-Factor Authentication Server).</span><span class="sxs-lookup"><span data-stu-id="25bdc-120">The installation path is picked up from the registry from the previous installation, so it installs in the same location (for example, C:\Program Files\Multi-Factor Authentication Server).</span></span> 
  
5. <span data-ttu-id="25bdc-121">Если отобразится запрос на установку пакета обновления распространяемого компонента Microsoft Visual C++ 2015, то примите этот запрос.</span><span class="sxs-lookup"><span data-stu-id="25bdc-121">If you're prompted to install a Microsoft Visual C++ 2015 Redistributable update package, accept the prompt.</span></span> <span data-ttu-id="25bdc-122">Устанавливаются версии x86 и x64 пакета.</span><span class="sxs-lookup"><span data-stu-id="25bdc-122">Both the x86 and x64 versions of the package are installed.</span></span>
5. <span data-ttu-id="25bdc-123">Если используется пакет SDK веб-службы, вам будет предложено установить новый пакет SDK веб-службы.</span><span class="sxs-lookup"><span data-stu-id="25bdc-123">If you use the Web Service SDK, you are prompted to install the new Web Service SDK.</span></span> <span data-ttu-id="25bdc-124">При установке нового пакета SDK веб-службы убедитесь, что имя виртуального каталога совпадает с именем ранее установленного виртуального каталога (например, MultiFactorAuthWebServiceSdk).</span><span class="sxs-lookup"><span data-stu-id="25bdc-124">When you install the new Web Service SDK, make sure that the virtual directory name matches the previously installed virtual directory (for example, MultiFactorAuthWebServiceSdk).</span></span>
6. <span data-ttu-id="25bdc-125">Повторите эти шаги на всех подчиненных серверах.</span><span class="sxs-lookup"><span data-stu-id="25bdc-125">Repeat the steps on all subordinate servers.</span></span> <span data-ttu-id="25bdc-126">Сделайте один из подчиненных серверов главным, а затем обновите сервер, который был главным.</span><span class="sxs-lookup"><span data-stu-id="25bdc-126">Promote one of the subordinates to be the new master, then upgrade the old master server.</span></span> 

## <a name="upgrade-the-user-portal"></a><span data-ttu-id="25bdc-127">Обновление пользовательского портала</span><span class="sxs-lookup"><span data-stu-id="25bdc-127">Upgrade the User Portal</span></span>

1. <span data-ttu-id="25bdc-128">Создайте резервную копию файла web.config, который находится в виртуальном каталоге, где установлен пользовательский портал (например, C:\inetpub\wwwroot\MultiFactorAuth).</span><span class="sxs-lookup"><span data-stu-id="25bdc-128">Make a backup of the web.config file that is in the virtual directory of the User Portal installation location (for example, C:\inetpub\wwwroot\MultiFactorAuth).</span></span> <span data-ttu-id="25bdc-129">Если тема по умолчанию была изменена, то создайте также резервную копию папки App_Themes\Default.</span><span class="sxs-lookup"><span data-stu-id="25bdc-129">If any changes were made to the default theme, make a backup of the App_Themes\Default folder as well.</span></span> <span data-ttu-id="25bdc-130">Рекомендуется создать копию папки Default и создать новую тему, а не изменять тему по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="25bdc-130">It is better to create a copy of the Default folder and create a new theme than to change the Default theme.</span></span>
2. <span data-ttu-id="25bdc-131">Если пользовательский портал работает на одном сервере с другими компонентами сервера MFA, то при установке сервера MFA отобразится запрос на обновление пользовательского портала.</span><span class="sxs-lookup"><span data-stu-id="25bdc-131">If the User Portal runs on the same server as the other MFA Server components, the MFA Server installation prompts you to update the User Portal.</span></span> <span data-ttu-id="25bdc-132">Примите запрос и установите это обновление пользовательского портала.</span><span class="sxs-lookup"><span data-stu-id="25bdc-132">Accept the prompt and install the User Portal update.</span></span> <span data-ttu-id="25bdc-133">При этом убедитесь, что имя виртуального каталога совпадает с именем ранее установленного виртуального каталога (например, MultiFactorAuth).</span><span class="sxs-lookup"><span data-stu-id="25bdc-133">Check that the virtual directory name matches the previously installed virtual directory (for example, MultiFactorAuth).</span></span>
3. <span data-ttu-id="25bdc-134">Если пользовательский портал установлен на отдельном сервере, то скопируйте файл MultiFactorAuthenticationUserPortalSetup64.msi из расположения установки одного из серверов Mногофакторной идентификации и поместите его на веб-сервер пользовательского портала.</span><span class="sxs-lookup"><span data-stu-id="25bdc-134">If the User Portal is on its own server, copy the MultiFactorAuthenticationUserPortalSetup64.msi file from the install location of one of the MFA Servers and put it onto the User Portal web server.</span></span> <span data-ttu-id="25bdc-135">Запустите установщик.</span><span class="sxs-lookup"><span data-stu-id="25bdc-135">Run the installer.</span></span> 

  <span data-ttu-id="25bdc-136">Если возникает ошибка и отображается сообщение о том, что требуется распространяемый компонент Microsoft Visual C++ 2015, обновление 1 или более поздней версии, то скачайте и установите последнюю версию пакета обновления из [Центра загрузки Майкрософт](https://www.microsoft.com/download/).</span><span class="sxs-lookup"><span data-stu-id="25bdc-136">If an error occurs stating, "Microsoft Visual C++ 2015 Redistributable Update 1 or higher is required," download and install the latest update package from the [Microsoft Download Center](https://www.microsoft.com/download/).</span></span> <span data-ttu-id="25bdc-137">Установите версии x86 и x64.</span><span class="sxs-lookup"><span data-stu-id="25bdc-137">Install both the x86 and x64 versions.</span></span>

4. <span data-ttu-id="25bdc-138">После установки обновленного программного обеспечения пользовательского портала сравните резервную копию файла web.config, которую вы создали на шаге 1, с новым файлом web.config.</span><span class="sxs-lookup"><span data-stu-id="25bdc-138">After the updated User Portal software is installed, compare the web.config backup you made in step 1 with the new web.config file.</span></span> <span data-ttu-id="25bdc-139">Если в новом файле web.config отсутствуют новые атрибуты, то скопируйте резервную копию этого файла в виртуальный каталог, чтобы перезаписать новую версию.</span><span class="sxs-lookup"><span data-stu-id="25bdc-139">If no new attributes exist in the new web.config, copy your backup web.config into the virtual directory to overwrite the new one.</span></span> <span data-ttu-id="25bdc-140">Другой вариант — скопировать значения раздела appSettings и URL-адрес пакета SDK веб-службы из резервной копии файла и вставить их в новый файл web.config.</span><span class="sxs-lookup"><span data-stu-id="25bdc-140">Another option is to copy/paste the appSettings values and the Web Service SDK URL from the backup file into the new web.config.</span></span>

<span data-ttu-id="25bdc-141">Если пользовательский портал размещен на нескольких серверах, то повторите установку на каждом из них.</span><span class="sxs-lookup"><span data-stu-id="25bdc-141">If you have the User Portal on multiple servers, repeat the installation on all of them.</span></span> 


## <a name="upgrade-the-mobile-app-web-service"></a><span data-ttu-id="25bdc-142">Установление веб-службы мобильного приложения</span><span class="sxs-lookup"><span data-stu-id="25bdc-142">Upgrade the Mobile App Web Service</span></span>

1. <span data-ttu-id="25bdc-143">Создайте резервную копию файла web.config, который находится в виртуальном каталоге, где установлена веб-служба мобильного приложения (например, C:\inetpub\wwwroot\app или C:\inetpub\wwwroot\MultiFactorAuthMobileAppWebService).</span><span class="sxs-lookup"><span data-stu-id="25bdc-143">Make a backup of the web.config file that is in the virtual directory of the Mobile App Web Service installation location (for example, C:\inetpub\wwwroot\app or C:\inetpub\wwwroot\MultiFactorAuthMobileAppWebService).</span></span>
2. <span data-ttu-id="25bdc-144">Скопируйте файл MultiFactorAuthenticationMobileAppWebServiceSetup64.msi из расположения установки одного из серверов Mногофакторной идентификации и поместите его на веб-сервер регистрации мобильного приложения.</span><span class="sxs-lookup"><span data-stu-id="25bdc-144">Copy the MultiFactorAuthenticationMobileAppWebServiceSetup64.msi file from the install location of the MFA Servers and put it onto the Mobile App registration web server.</span></span>
3. <span data-ttu-id="25bdc-145">Запустите установщик.</span><span class="sxs-lookup"><span data-stu-id="25bdc-145">Run the installer.</span></span> 

  <span data-ttu-id="25bdc-146">Если возникает ошибка и отображается сообщение о том, что требуется распространяемый компонент Microsoft Visual C++ 2015, обновление 1 или более поздней версии, то скачайте и установите последнюю версию пакета обновления из [Центра загрузки Майкрософт](https://www.microsoft.com/download/).</span><span class="sxs-lookup"><span data-stu-id="25bdc-146">If an error occurs stating that Microsoft Visual C++ 2015 Redistributable Update 1 or higher is required, download and install the latest update package from the [Microsoft Download Center](https://www.microsoft.com/download/).</span></span> <span data-ttu-id="25bdc-147">Установите версии x86 и x64.</span><span class="sxs-lookup"><span data-stu-id="25bdc-147">Install both the x86 and x64 versions.</span></span>

4. <span data-ttu-id="25bdc-148">После установки обновленного программного обеспечения веб-службы мобильного приложения сравните резервную копию файла web.config, созданную на шаге 1, с новым файлом web.config.</span><span class="sxs-lookup"><span data-stu-id="25bdc-148">After the updated Mobile App Web Service software installs, compare the web.config file that was backed up in step 1 with the new web.config file.</span></span> <span data-ttu-id="25bdc-149">Если в новом файле web.config отсутствуют новые атрибуты, то можно скопировать сохраненную версию этого файла в виртуальный каталог, чтобы перезаписать новую версию.</span><span class="sxs-lookup"><span data-stu-id="25bdc-149">If no new attributes exist in the new web.config, you can copy your saved web.config back into the virtual directory and overwrite the new one.</span></span> <span data-ttu-id="25bdc-150">Другой вариант — скопировать значения раздела appSettings и URL-адрес пакета SDK веб-службы из резервной копии файла и вставить их в новый файл web.config.</span><span class="sxs-lookup"><span data-stu-id="25bdc-150">Another option is to copy/paste the appSettings values and the Web Service SDK URL from the backup file into the new web.config.</span></span>

<span data-ttu-id="25bdc-151">Если веб-служба мобильного приложения размещена на нескольких серверах, то повторите установку на каждом из них.</span><span class="sxs-lookup"><span data-stu-id="25bdc-151">If you have the Mobile App Web Service on multiple servers, repeat the installation on all of them.</span></span> 

## <a name="upgrade-the-ad-fs-adapters"></a><span data-ttu-id="25bdc-152">Обновление AD FS-адаптеров</span><span class="sxs-lookup"><span data-stu-id="25bdc-152">Upgrade the AD FS Adapters</span></span>


### <a name="if-mfa-runs-on-different-servers-than-ad-fs"></a><span data-ttu-id="25bdc-153">Если MFA и службы AD FS работают на разных серверах</span><span class="sxs-lookup"><span data-stu-id="25bdc-153">If MFA runs on different servers than AD FS</span></span>

<span data-ttu-id="25bdc-154">Эти инструкции применяются только в том случае, если сервер Многофакторной идентификации используется отдельно от серверов AD FS.</span><span class="sxs-lookup"><span data-stu-id="25bdc-154">These instructions only apply if you run Multi-Factor Authentication Server separately from your AD FS servers.</span></span> <span data-ttu-id="25bdc-155">Если обе службы работают на одних и тех же серверах, то пропустите этот раздел и перейдите к действиям по установке.</span><span class="sxs-lookup"><span data-stu-id="25bdc-155">If both services run on the same servers, skip this section and go to the installation steps.</span></span> 

1. <span data-ttu-id="25bdc-156">Сохраните копию файла MultiFactorAuthenticationAdfsAdapter.config, зарегистрированного в AD FS, или экспортируйте конфигурацию с помощью следующей команды PowerShell: `Export-AdfsAuthenticationProviderConfigurationData -Name [adapter name] -FilePath [path to config file]`.</span><span class="sxs-lookup"><span data-stu-id="25bdc-156">Save a copy of the MultiFactorAuthenticationAdfsAdapter.config file that was registered in AD FS, or export the configuration using the following PowerShell command: `Export-AdfsAuthenticationProviderConfigurationData -Name [adapter name] -FilePath [path to config file]`.</span></span> <span data-ttu-id="25bdc-157">Имя адаптера — WindowsAzureMultiFactorAuthentication или AzureMfaServerAuthentication (в зависимости от ранее установленной версии).</span><span class="sxs-lookup"><span data-stu-id="25bdc-157">The adapter name is either "WindowsAzureMultiFactorAuthentication" or "AzureMfaServerAuthentication" depending on the version previously installed.</span></span>
2. <span data-ttu-id="25bdc-158">Скопируйте следующие файлы из расположения установки сервера MFA и вставьте их в серверы AD FS:</span><span class="sxs-lookup"><span data-stu-id="25bdc-158">Copy the following files from the MFA Server installation location to the AD FS servers:</span></span>

  - <span data-ttu-id="25bdc-159">MultiFactorAuthenticationAdfsAdapterSetup64.msi</span><span class="sxs-lookup"><span data-stu-id="25bdc-159">MultiFactorAuthenticationAdfsAdapterSetup64.msi</span></span>
  - <span data-ttu-id="25bdc-160">Register-MultiFactorAuthenticationAdfsAdapter.ps1</span><span class="sxs-lookup"><span data-stu-id="25bdc-160">Register-MultiFactorAuthenticationAdfsAdapter.ps1</span></span>
  - <span data-ttu-id="25bdc-161">Unregister-MultiFactorAuthenticationAdfsAdapter.ps1</span><span class="sxs-lookup"><span data-stu-id="25bdc-161">Unregister-MultiFactorAuthenticationAdfsAdapter.ps1</span></span>
  - <span data-ttu-id="25bdc-162">MultiFactorAuthenticationAdfsAdapter.config</span><span class="sxs-lookup"><span data-stu-id="25bdc-162">MultiFactorAuthenticationAdfsAdapter.config</span></span>

3. <span data-ttu-id="25bdc-163">Измените скрипт Register-MultiFactorAuthenticationAdfsAdapter.ps1, добавив `-ConfigurationFilePath [path]` в конец команды `Register-AdfsAuthenticationProvider`.</span><span class="sxs-lookup"><span data-stu-id="25bdc-163">Edit the Register-MultiFactorAuthenticationAdfsAdapter.ps1 script by adding `-ConfigurationFilePath [path]` to the end of the `Register-AdfsAuthenticationProvider` command.</span></span> <span data-ttu-id="25bdc-164">В качестве значения *[путь]* укажите полный путь к файлу MultiFactorAuthenticationAdfsAdapter.config или файлу конфигурации, экспортированному на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="25bdc-164">Replace *[path]* with the full path to the MultiFactorAuthenticationAdfsAdapter.config file or the configuration file exported in the previous step.</span></span> 

  <span data-ttu-id="25bdc-165">Проверьте атрибуты в новом файле MultiFactorAuthenticationAdfsAdapter.config, чтобы выяснить, соответствуют ли они старому файлу конфигурации.</span><span class="sxs-lookup"><span data-stu-id="25bdc-165">Check the attributes in the new MultiFactorAuthenticationAdfsAdapter.config to see if they match the old config file.</span></span> <span data-ttu-id="25bdc-166">Если в новой версии какие-то атрибуты добавлены или отсутствуют, то скопируйте значения атрибутов из старой версии файла конфигурации в новый файл или измените старый файл, чтобы значения совпадали.</span><span class="sxs-lookup"><span data-stu-id="25bdc-166">If any attributes were added or removed in the new version, copy the attribute values from the old configuration file to the new one or modify the old configuration file to match.</span></span>

### <a name="install-new-ad-fs-adapters"></a><span data-ttu-id="25bdc-167">Установка новых AD FS-адаптеров</span><span class="sxs-lookup"><span data-stu-id="25bdc-167">Install new AD FS adapters</span></span>

> [!IMPORTANT] 
> <span data-ttu-id="25bdc-168">Пользователям не нужно будет выполнять двухфакторную проверку подлинности, описанную на шагах 3–8 этого раздела.</span><span class="sxs-lookup"><span data-stu-id="25bdc-168">Your users will not be required to perform two-step verification during steps 3-8 of this section.</span></span> <span data-ttu-id="25bdc-169">Если вы настроили службы AD FS в нескольких кластерах, то можете удалять, обновлять или восстанавливать каждый кластер в ферме независимо от других кластеров, чтобы избежать простоя.</span><span class="sxs-lookup"><span data-stu-id="25bdc-169">If you have AD FS configured in multiple clusters, you can remove, upgrade, and restore each cluster in the farm independently of the other clusters to avoid downtime.</span></span>

1. <span data-ttu-id="25bdc-170">Удалите из фермы несколько серверов AD FS.</span><span class="sxs-lookup"><span data-stu-id="25bdc-170">Remove some AD FS servers from the farm.</span></span> <span data-ttu-id="25bdc-171">Обновите эти серверы, пока остальные продолжают работать.</span><span class="sxs-lookup"><span data-stu-id="25bdc-171">Update these servers while the others are still running.</span></span>
2. <span data-ttu-id="25bdc-172">Установите новый AD FS-адаптер на каждом сервере, удаленном из фермы AD FS.</span><span class="sxs-lookup"><span data-stu-id="25bdc-172">Install the new AD FS adapter on each server removed from the AD FS farm.</span></span> <span data-ttu-id="25bdc-173">Если сервер MFA установлен на каждом сервере AD FS, то обновление можно выполнить с помощью интерфейса администратора сервера MFA.</span><span class="sxs-lookup"><span data-stu-id="25bdc-173">If the MFA Server is installed on each AD FS server, you can update through the MFA Server admin UX.</span></span> <span data-ttu-id="25bdc-174">Если нет, то выполните обновление, запустив файл MultiFactorAuthenticationAdfsAdapterSetup64.msi.</span><span class="sxs-lookup"><span data-stu-id="25bdc-174">Otherwise, update by running MultiFactorAuthenticationAdfsAdapterSetup64.msi.</span></span> 

  <span data-ttu-id="25bdc-175">Если возникает ошибка и отображается сообщение о том, что требуется распространяемый компонент Microsoft Visual C++ 2015, обновление 1 или более поздней версии, то скачайте и установите последнюю версию пакета обновления из [Центра загрузки Майкрософт](https://www.microsoft.com/download/).</span><span class="sxs-lookup"><span data-stu-id="25bdc-175">If an error occurs stating, "Microsoft Visual C++ 2015 Redistributable Update 1 or higher is required," download and install the latest update package from the [Microsoft Download Center](https://www.microsoft.com/download/).</span></span> <span data-ttu-id="25bdc-176">Установите версии x86 и x64.</span><span class="sxs-lookup"><span data-stu-id="25bdc-176">Install both the x86 and x64 versions.</span></span>

3. <span data-ttu-id="25bdc-177">Последовательно выберите пункты **AD FS** > **Политики проверки подлинности** > **Edit Global MultiFactor Authentication Policy** (Изменить глобальную политику Многофакторной идентификации).</span><span class="sxs-lookup"><span data-stu-id="25bdc-177">Go to **AD FS** > **Authentication Policies** > **Edit Global MultiFactor Authentication Policy**.</span></span> <span data-ttu-id="25bdc-178">Снимите флажок **WindowsAzureMultiFactorAuthentication** или **AzureMFAServerAuthentication** (в зависимости от установленной версии).</span><span class="sxs-lookup"><span data-stu-id="25bdc-178">Uncheck **WindowsAzureMultiFactorAuthentication** or **AzureMFAServerAuthentication** (depending on the current version installed).</span></span> 

  <span data-ttu-id="25bdc-179">По завершении этого шага двухфакторная проверка подлинности через сервер Mногофакторной идентификации станет доступна в этом кластере AD FS, пока вы не выполните шаг 8.</span><span class="sxs-lookup"><span data-stu-id="25bdc-179">Once this step is complete, two-step verification through MFA Server is not available in this AD FS cluster until you complete step 8.</span></span>

4. <span data-ttu-id="25bdc-180">Отмените регистрацию старой версии AD FS-адаптера, выполнив сценарий PowerShell Unregister-MultiFactorAuthenticationAdfsAdapter.ps1.</span><span class="sxs-lookup"><span data-stu-id="25bdc-180">Unregister the older version of the AD FS adapter by running the Unregister-MultiFactorAuthenticationAdfsAdapter.ps1 PowerShell script.</span></span> <span data-ttu-id="25bdc-181">Убедитесь, что параметр *-Name* (WindowsAzureMultiFactorAuthentication или AzureMFAServerAuthentication) совпадает с именем, которое отображалось на шаге 3.</span><span class="sxs-lookup"><span data-stu-id="25bdc-181">Ensure that the *-Name* parameter (either “WindowsAzureMultiFactorAuthentication” or "AzureMFAServerAuthentication") matches the name that was displayed in step 3.</span></span> <span data-ttu-id="25bdc-182">Это относится ко всем серверам в одном кластере AD FS, так как существует центральная конфигурация.</span><span class="sxs-lookup"><span data-stu-id="25bdc-182">This applies to all servers in the same AD FS cluster since there is a central configuration.</span></span>
5. <span data-ttu-id="25bdc-183">Зарегистрируйте новый AD FS-адаптер, выполнив сценарий PowerShell Register-MultiFactorAuthenticationAdfsAdapter.ps1.</span><span class="sxs-lookup"><span data-stu-id="25bdc-183">Register the new AD FS adapter by running the Register-MultiFactorAuthenticationAdfsAdapter.ps1 PowerShell script.</span></span> <span data-ttu-id="25bdc-184">Это относится ко всем серверам в одном кластере AD FS, так как существует центральная конфигурация.</span><span class="sxs-lookup"><span data-stu-id="25bdc-184">This applies to all servers in the same AD FS cluster since there is a central configuration.</span></span>
6. <span data-ttu-id="25bdc-185">Перезапустите службу AD FS на каждом сервере, удаленном из фермы AD FS.</span><span class="sxs-lookup"><span data-stu-id="25bdc-185">Restart the AD FS service on each server removed from the AD FS farm.</span></span>
7. <span data-ttu-id="25bdc-186">Добавьте обновленные серверы обратно в ферму AD FS и удалите из нее другие серверы.</span><span class="sxs-lookup"><span data-stu-id="25bdc-186">Add the updated servers back to the AD FS farm and remove the other servers from the farm.</span></span>
8. <span data-ttu-id="25bdc-187">Последовательно выберите пункты **AD FS** > **Политики проверки подлинности** > **Edit Global MultiFactor Authentication Policy** (Изменить глобальную политику Многофакторной идентификации).</span><span class="sxs-lookup"><span data-stu-id="25bdc-187">Go to **AD FS** > **Authentication Policies** > **Edit Global MultiFactor Authentication Policy**.</span></span> <span data-ttu-id="25bdc-188">Установите флажок **AzureMfaServerAuthentication**.</span><span class="sxs-lookup"><span data-stu-id="25bdc-188">Check **AzureMfaServerAuthentication**.</span></span>
9. <span data-ttu-id="25bdc-189">Теперь повторите шаг 2, чтобы обновить серверы, удаленные из фермы AD FS, и перезапустите службу AD FS на этих серверах.</span><span class="sxs-lookup"><span data-stu-id="25bdc-189">Repeat step 2 to update the servers now removed from the AD FS farm and restart the AD FS service on those servers.</span></span>
10. <span data-ttu-id="25bdc-190">Добавьте эти серверы обратно в ферму AD FS.</span><span class="sxs-lookup"><span data-stu-id="25bdc-190">Add those servers back into the AD FS farm.</span></span>

## <a name="next-steps"></a><span data-ttu-id="25bdc-191">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="25bdc-191">Next steps</span></span>

- <span data-ttu-id="25bdc-192">Ознакомьтесь с примерами, приведенными в статье [Расширенные сценарии с использованием Многофакторной идентификации Azure и VPN-решений сторонних поставщиков](multi-factor-authentication-advanced-vpn-configurations.md).</span><span class="sxs-lookup"><span data-stu-id="25bdc-192">Get examples of [Advanced scenarios with Azure Multi-Factor Authentication and third-party VPNs](multi-factor-authentication-advanced-vpn-configurations.md)</span></span>

- <span data-ttu-id="25bdc-193">[Интеграция каталогов между сервером Azure Multi-Factor Authentication и Active Directory](multi-factor-authentication-get-started-server-dirint.md).</span><span class="sxs-lookup"><span data-stu-id="25bdc-193">[Synchronize MFA Server with Windows Server Active Directory](multi-factor-authentication-get-started-server-dirint.md)</span></span>

- <span data-ttu-id="25bdc-194">Настройте для своих приложений проверку подлинности Windows, как описано в статье [Проверка подлинности Windows и сервер Azure Multi-Factor Authentication](multi-factor-authentication-get-started-server-windows.md).</span><span class="sxs-lookup"><span data-stu-id="25bdc-194">[Configure Windows Authentication](multi-factor-authentication-get-started-server-windows.md) for your applications</span></span>

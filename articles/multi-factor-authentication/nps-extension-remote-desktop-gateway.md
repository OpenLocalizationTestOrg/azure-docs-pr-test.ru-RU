---
title: "Интеграция шлюза удаленных рабочих столов с Azure MFA с помощью расширения NPS | Документация Майкрософт"
description: "В этой статье рассматривается интеграция инфраструктуры шлюза удаленных рабочих столов с Azure MFA с помощью расширения сервера политики сети (NPS) для Microsoft Azure."
services: active-directory
keywords: "Azure MFA, интеграция шлюза удаленных рабочих столов, Azure Active Directory, расширение сервера политики сети"
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/15/2017
ms.author: kgremban
ms.reviewer: jsnow
ms.custom: it-pro
ms.openlocfilehash: 6ff9a341b31e5005949dcc0ecb2591060269846e
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
#  <a name="integrate-your-remote-desktop-gateway-infrastructure-using-the-network-policy-server-nps-extension-and-azure-ad"></a><span data-ttu-id="3660e-104">Интеграция инфраструктуры шлюза удаленных рабочих столов с помощью расширения сервера политики сети (NPS) и Azure AD</span><span class="sxs-lookup"><span data-stu-id="3660e-104">Integrate your Remote Desktop Gateway infrastructure using the Network Policy Server (NPS) extension and Azure AD</span></span>

<span data-ttu-id="3660e-105">В этой статье описывается интеграция инфраструктуры шлюза удаленных рабочих столов с Многофакторной идентификацией Azure (MFA) с помощью расширения сервера политики сети (NPS) для Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="3660e-105">This article provides details for integrating your Remote Desktop Gateway infrastructure with Azure Multi-Factor Authentication (MFA) using the Network Policy Server (NPS) extension for Microsoft Azure.</span></span> 

<span data-ttu-id="3660e-106">Расширение сервера политики сети (NPS) для Azure позволяет клиентам защитить аутентификацию клиентов RADIUS с помощью облачной [Многофакторной идентификации (MFA)](multi-factor-authentication.md) Azure.</span><span class="sxs-lookup"><span data-stu-id="3660e-106">The Network Policy Service (NPS) extension for Azure allows customers to safeguard Remote Authentication Dial-In User Service (RADIUS) client authentication using Azure’s cloud-based [Multi-Factor Authentication (MFA)](multi-factor-authentication.md).</span></span> <span data-ttu-id="3660e-107">Это решение предоставляет двухфакторную проверку подлинности в качестве второго уровня безопасности для входа пользователей в систему и транзакций.</span><span class="sxs-lookup"><span data-stu-id="3660e-107">This solution provides two-step verification for adding a second layer of security to user sign-ins and transactions.</span></span>

<span data-ttu-id="3660e-108">В этой статье приведены пошаговые инструкции по интеграции инфраструктуры NPS с Azure MFA с помощью расширения NPS для Azure.</span><span class="sxs-lookup"><span data-stu-id="3660e-108">This article provides step-by-step instructions for integrating the NPS infrastructure with Azure MFA using the NPS extension for Azure.</span></span> <span data-ttu-id="3660e-109">Это обеспечивает надежную проверку пользователей, пытающихся войти на шлюз удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-109">This enables secure verification for users attempting to log on to a Remote Desktop Gateway.</span></span> 

<span data-ttu-id="3660e-110">Службы политики сети и доступа (NPS) дают организациям следующие возможности.</span><span class="sxs-lookup"><span data-stu-id="3660e-110">The Network Policy and Access Services (NPS) gives organizations the ability to do the following:</span></span>
* <span data-ttu-id="3660e-111">Можно определить центральные расположения для управления сетевыми запросами и их контроля, указав, кто может подключаться, в какое время дня подключения разрешены, продолжительность подключений, уровень безопасности, который клиенты должны использовать для подключения, и так далее.</span><span class="sxs-lookup"><span data-stu-id="3660e-111">Define central locations for the management and control of network requests by specifying who can connect, what times of day connections are allowed, the duration of connections, and the level of security that clients must use to connect, and so on.</span></span> <span data-ttu-id="3660e-112">Вместо того, чтобы задавать эти политики на каждом VPN-сервере или сервере шлюза удаленных рабочих столов, их можно указать один раз в центральном расположении.</span><span class="sxs-lookup"><span data-stu-id="3660e-112">Rather than specifying these policies on each VPN or Remote Desktop (RD) Gateway server, these policies can be specified once in a central location.</span></span> <span data-ttu-id="3660e-113">Протокол RADIUS обеспечивает централизованную аутентификацию, авторизацию и учет.</span><span class="sxs-lookup"><span data-stu-id="3660e-113">The RADIUS protocol provides the centralized Authentication, Authorization, and Accounting (AAA).</span></span> 
* <span data-ttu-id="3660e-114">Можно устанавливать и применять политики работоспособности клиента защиты доступа к сети (NAP), которые определяют, предоставляется ли устройствам неограниченный или ограниченный доступ к сетевым ресурсам.</span><span class="sxs-lookup"><span data-stu-id="3660e-114">Establish and enforce Network Access Protection (NAP) client health policies that determine whether devices are granted unrestricted or restricted access to network resources.</span></span>
* <span data-ttu-id="3660e-115">Можно внедрить средства аутентификации и авторизации для доступа к точкам беспроводного доступа и коммутаторам Ethernet, поддерживающим протокол 802.1x.</span><span class="sxs-lookup"><span data-stu-id="3660e-115">Provide a means to enforce authentication and authorization for access to 802.1x-capable wireless access points and Ethernet switches.</span></span>    

<span data-ttu-id="3660e-116">Как правило, организации используют NPS (RADIUS) для упрощения и централизации управления политиками VPN.</span><span class="sxs-lookup"><span data-stu-id="3660e-116">Typically, organizations use NPS (RADIUS) to simplify and centralize the management of VPN polices.</span></span> <span data-ttu-id="3660e-117">Однако во многих организациях NPS также используется для упрощения и централизации управления политиками авторизации подключений к удаленным рабочим столам.</span><span class="sxs-lookup"><span data-stu-id="3660e-117">However, many organizations also use NPS to simplify and centralize the management of RD Desktop Connection Authorization Policies (RD CAPs).</span></span> 

<span data-ttu-id="3660e-118">Организации могут также интегрировать NPS с Azure MFA, чтобы повысить безопасность и обеспечить высокий уровень соответствия.</span><span class="sxs-lookup"><span data-stu-id="3660e-118">Organizations can also integrate NPS with Azure MFA to enhance security and provide a high level of compliance.</span></span> <span data-ttu-id="3660e-119">Это позволяет обеспечить применение пользователями двухфакторной проверки подлинности для входа на шлюз удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-119">This helps ensure that users establish two-step verification to log on to the Remote Desktop Gateway.</span></span> <span data-ttu-id="3660e-120">Чтобы получить доступ, пользователю необходимо предоставить свои имя пользователя и пароль, а также сведения, которыми он управляет.</span><span class="sxs-lookup"><span data-stu-id="3660e-120">For users to be granted access, they must provide their username/password combination with information that the user has in their control.</span></span> <span data-ttu-id="3660e-121">Эта информация должна быть надежной, и ее копирование должно быть затруднено. Например, это может быть номер мобильного телефона, номер стационарного телефона, приложение на мобильном устройстве и т. д.</span><span class="sxs-lookup"><span data-stu-id="3660e-121">This information must be trusted and not easily duplicated, such as a cell phone number, landline number, application on a mobile device, and so on.</span></span>

<span data-ttu-id="3660e-122">До появления расширения NPS для Azure клиентам, желавшим внедрить двухфакторную проверку подлинности для интегрированных сред NPS и Azure MFA, приходилось настраивать и обслуживать отдельный сервер MFA в локальной среде, как описано в разделе [Шлюз удаленных рабочих столов и сервер Azure Multi-Factor Authentication, использующие проверку подлинности RADIUS](multi-factor-authentication-get-started-server-rdg.md).</span><span class="sxs-lookup"><span data-stu-id="3660e-122">Prior to the availability of the NPS extension for Azure, customers who wished to implement two-step verification for integrated NPS and Azure MFA environments had to configure and maintain a separate MFA Server in the on-premises environment as documented in [Remote Desktop Gateway and Azure Multi-Factor Authentication Server using RADIUS](multi-factor-authentication-get-started-server-rdg.md).</span></span>

<span data-ttu-id="3660e-123">Теперь, когда доступно расширение NPS для Azure, организации имеют возможность развернуть локальное или облачное решение MFA для защиты аутентификации клиентов RADIUS.</span><span class="sxs-lookup"><span data-stu-id="3660e-123">The availability of the NPS extension for Azure now gives organizations the choice to deploy either an on-premises based MFA solution or a cloud-based MFA solution to secure RADIUS client authentication.</span></span>

## <a name="authentication-flow"></a><span data-ttu-id="3660e-124">Последовательность аутентификации</span><span class="sxs-lookup"><span data-stu-id="3660e-124">Authentication Flow</span></span>

<span data-ttu-id="3660e-125">Чтобы пользователи могли получить доступ к сетевым ресурсам через шлюз удаленных рабочих столов, они должны соответствовать условиям, заданным в одной политике авторизации подключений к удаленным рабочим столам (RD CAP) и одной политике авторизации ресурсов удаленных рабочих столов (RD RAP).</span><span class="sxs-lookup"><span data-stu-id="3660e-125">For users to be granted access to network resources through a Remote Desktop Gateway, they must meet the conditions specified in one RD Connection Authorization Policy (RD CAP) and one RD Resource Authorization Policy (RD RAP).</span></span> <span data-ttu-id="3660e-126">Политики авторизации подключений к удаленным рабочим столам определяют, кому разрешено подключаться к шлюзам удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-126">RD CAPs specify who is authorized to connect to RD Gateways.</span></span> <span data-ttu-id="3660e-127">Политики авторизации ресурсов удаленных рабочих столов определяют сетевые ресурсы, например удаленные рабочие столы или удаленные приложения, к которым пользователь может подключаться с помощью шлюза удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-127">RD RAPs specify the network resources, such as remote desktops or remote apps, that the user is allowed to connect to through the RD Gateway.</span></span> 

<span data-ttu-id="3660e-128">Шлюз удаленных рабочих столов можно настроить для использования центрального хранилища политик авторизации подключений к удаленным рабочим столам.</span><span class="sxs-lookup"><span data-stu-id="3660e-128">An RD Gateway can be configured to use a central policy store for RD CAPs.</span></span> <span data-ttu-id="3660e-129">Политики авторизации ресурсов удаленных рабочих столов не могут использовать центральное хранилище политик, так как они обрабатываются на шлюзе удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-129">RD RAPs cannot use a central policy, as they are processed on the RD Gateway.</span></span> <span data-ttu-id="3660e-130">В качестве примера шлюза удаленных рабочих столов, настроенного для использования центрального хранилища политик авторизации подключений к удаленным рабочим столам, можно привести клиент RADIUS на другом NPS-сервере, который выступает в качестве центрального хранилища политик.</span><span class="sxs-lookup"><span data-stu-id="3660e-130">An example of an RD Gateway configured to use a central policy store for RD CAPs is a RADIUS client to another NPS server that serves as the central policy store.</span></span>

<span data-ttu-id="3660e-131">Когда расширение NPS интегрировано с сервером политики сети и шлюзом удаленных рабочих столов, последовательность успешной аутентификации выглядит следующим образом.</span><span class="sxs-lookup"><span data-stu-id="3660e-131">When the NPS extension for Azure is integrated with the NPS and Remote Desktop Gateway, the successful authentication flow is as follows:</span></span>

1. <span data-ttu-id="3660e-132">Сервер шлюза удаленных рабочих столов получает запрос на аутентификацию от пользователя удаленного рабочего стола для подключения к ресурсу (например, к сеансу удаленного рабочего стола).</span><span class="sxs-lookup"><span data-stu-id="3660e-132">The Remote Desktop Gateway server receives an authentication request from a remote desktop user to connect to a resource, such as a Remote Desktop session.</span></span> <span data-ttu-id="3660e-133">Выступая в качестве клиента RADIUS, сервер шлюза удаленных рабочих столов преобразовывает запрос в сообщение Access-Request RADIUS и отправляет его на сервер RADIUS (NPS), на котором установлено расширение NPS.</span><span class="sxs-lookup"><span data-stu-id="3660e-133">Acting as a RADIUS client, the Remote Desktop Gateway server converts the request to a RADIUS Access-Request message and sends the message to the RADIUS (NPS) server where the NPS extension is installed.</span></span> 
2. <span data-ttu-id="3660e-134">Сочетание имени пользователя и пароля проверяется в Active Directory, после чего пользователь аутентифицируется.</span><span class="sxs-lookup"><span data-stu-id="3660e-134">The username and password combination is verified in Active Directory and the user is authenticated.</span></span>
3. <span data-ttu-id="3660e-135">Если выполнены все условия, указанные в запросе на подключение NPS и политиках сети (например, ограничение времени дня или членства в группах), расширение NPS активирует запрос дополнительной аутентификации с помощью Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="3660e-135">If all the conditions as specified in the NPS Connection Request and the Network Policies are met (for example, time of day or group membership restrictions), the NPS extension triggers a request for secondary authentication with Azure MFA.</span></span> 
4. <span data-ttu-id="3660e-136">Azure MFA обращается к Azure AD, получает сведения о пользователе и выполняет дополнительную аутентификацию по тому методу, который настроен пользователем (текстовое сообщение, мобильное приложение и так далее).</span><span class="sxs-lookup"><span data-stu-id="3660e-136">Azure MFA communicates with Azure AD, retrieves the user’s details, and performs the secondary authentication using the method configured by the user (text message, mobile app, and so on).</span></span> 
5. <span data-ttu-id="3660e-137">После успешного прохождения Многофакторной идентификации служба Azure MFA передает результат в расширение NPS.</span><span class="sxs-lookup"><span data-stu-id="3660e-137">Upon success of the MFA challenge, Azure MFA communicates the result to the NPS extension.</span></span>
6. <span data-ttu-id="3660e-138">NPS-сервер, на котором установлено расширение NPS, отправляет сообщение Access-Accept RADIUS для политики авторизации подключений к удаленным рабочим столам на сервер шлюза удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-138">The NPS server where the extension is installed sends a RADIUS Access-Accept message for the RD CAP policy to the Remote Desktop Gateway server.</span></span>
7. <span data-ttu-id="3660e-139">Пользователю предоставляется доступ к запрошенному сетевому ресурсу через шлюз удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-139">The user is granted access to the requested network resource through the RD Gateway.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="3660e-140">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="3660e-140">Prerequisites</span></span>
<span data-ttu-id="3660e-141">В этом разделе описаны предварительные условия, которые необходимо выполнить для интеграции Azure MFA и шлюза удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-141">This section details the prerequisites necessary before integrating Azure MFA with the Remote Desktop Gateway.</span></span> <span data-ttu-id="3660e-142">Прежде чем приступить к работе, следует подготовить приведенные ниже необходимые компоненты:</span><span class="sxs-lookup"><span data-stu-id="3660e-142">Before you begin, you must have the following prerequisites in place.</span></span>  

* <span data-ttu-id="3660e-143">инфраструктура служб удаленных рабочих столов (RDS);</span><span class="sxs-lookup"><span data-stu-id="3660e-143">Remote Desktop Services (RDS) infrastructure</span></span>
* <span data-ttu-id="3660e-144">лицензия Azure MFA;</span><span class="sxs-lookup"><span data-stu-id="3660e-144">Azure MFA License</span></span>
* <span data-ttu-id="3660e-145">программное обеспечение Windows Server;</span><span class="sxs-lookup"><span data-stu-id="3660e-145">Windows Server software</span></span>
* <span data-ttu-id="3660e-146">роль "Службы политики сети и доступа" (NPS);</span><span class="sxs-lookup"><span data-stu-id="3660e-146">Network Policy and Access Services (NPS) role</span></span>
* <span data-ttu-id="3660e-147">служба Azure AD должна быть синхронизирована с локальной службой AD;</span><span class="sxs-lookup"><span data-stu-id="3660e-147">Azure AD synched with on-premises AD</span></span> 
* <span data-ttu-id="3660e-148">идентификатор GUID Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="3660e-148">Azure Active Directory GUID ID</span></span>

### <a name="remote-desktop-services-rds-infrastructure"></a><span data-ttu-id="3660e-149">Инфраструктура служб удаленных рабочих столов (RDS)</span><span class="sxs-lookup"><span data-stu-id="3660e-149">Remote Desktop Services (RDS) infrastructure</span></span>
<span data-ttu-id="3660e-150">Необходима рабочая инфраструктура служб удаленных рабочих столов (RDS).</span><span class="sxs-lookup"><span data-stu-id="3660e-150">You must have a working Remote Desktop Services (RDS) infrastructure in place.</span></span> <span data-ttu-id="3660e-151">Если ее у вас нет, то можно быстро создать эту инфраструктуру в Azure, используя следующий шаблон быстрого запуска: [Create Remote Desktop Sesson Collection deployment](https://github.com/Azure/azure-quickstart-templates/tree/ad20c78b36d8e1246f96bb0e7a8741db481f957f/rds-deployment) (Создание развертывания набора для сеансов подключения к удаленным рабочим столам).</span><span class="sxs-lookup"><span data-stu-id="3660e-151">If you do not, then you can quickly create this infrastructure in Azure using the following quick start template: [Create Remote Desktop Session Collection deployment](https://github.com/Azure/azure-quickstart-templates/tree/ad20c78b36d8e1246f96bb0e7a8741db481f957f/rds-deployment).</span></span> 

<span data-ttu-id="3660e-152">Если вы хотите быстро вручную создать локальную инфраструктуру служб удаленных рабочих столов для тестирования, выполните соответствующие инструкции.</span><span class="sxs-lookup"><span data-stu-id="3660e-152">If you wish to manually create an on-premises RDS infrastructure quickly for testing purposes, follow the steps to deploy one.</span></span> 
<span data-ttu-id="3660e-153">**Дополнительные сведения**. [Развертывание службы удаленных рабочих столов с помощью шаблона быстрого запуска Azure](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/rds-in-azure) и [развертывание базовой инфраструктуры служб удаленных рабочих столов](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/rds-deploy-infrastructure).</span><span class="sxs-lookup"><span data-stu-id="3660e-153">**Learn more**: [Deploy RDS with Azure quick start](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/rds-in-azure) and [Basic RDS infrastructure deployment](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/rds-deploy-infrastructure).</span></span> 

### <a name="licenses"></a><span data-ttu-id="3660e-154">Лицензии</span><span class="sxs-lookup"><span data-stu-id="3660e-154">Licenses</span></span>
<span data-ttu-id="3660e-155">Требуется лицензия Azure MFA, которая предоставляется для подписки Azure AD Premium, Enterprise Mobility + Security (EMS) или MFA.</span><span class="sxs-lookup"><span data-stu-id="3660e-155">Required is a license for Azure MFA, which is available through an Azure AD Premium, Enterprise Mobility plus Security (EMS), or an MFA subscription.</span></span> <span data-ttu-id="3660e-156">Дополнительные сведения см. в разделе [Как получить службу Azure Multi-Factor Authentication](multi-factor-authentication-versions-plans.md).</span><span class="sxs-lookup"><span data-stu-id="3660e-156">For more information, see [How to get Azure Multi-Factor Authentication](multi-factor-authentication-versions-plans.md).</span></span> <span data-ttu-id="3660e-157">Для тестирования можно использовать пробную подписку.</span><span class="sxs-lookup"><span data-stu-id="3660e-157">For testing purposes, you can use a trial subscription.</span></span>

### <a name="software"></a><span data-ttu-id="3660e-158">Программное обеспечение</span><span class="sxs-lookup"><span data-stu-id="3660e-158">Software</span></span>
<span data-ttu-id="3660e-159">Для работы расширения NPS требуется Windows Server 2008 R2 с пакетом обновления 1 (SP1) или более поздней версии с установленной службой роли NPS.</span><span class="sxs-lookup"><span data-stu-id="3660e-159">The NPS extension requires Windows Server 2008 R2 SP1 or above with the NPS role service installed.</span></span> <span data-ttu-id="3660e-160">Все действия в этом разделе были выполнены с помощью Windows Server 2016.</span><span class="sxs-lookup"><span data-stu-id="3660e-160">All the steps in this section were performed using Windows Server 2016.</span></span>

### <a name="network-policy-and-access-services-nps-role"></a><span data-ttu-id="3660e-161">Роль "Службы политики сети и доступа" (NPS)</span><span class="sxs-lookup"><span data-stu-id="3660e-161">Network Policy and Access Services (NPS) role</span></span>
<span data-ttu-id="3660e-162">Служба роли NPS предоставляет функциональные возможности сервера и клиента RADIUS, а также службу работоспособности NAP.</span><span class="sxs-lookup"><span data-stu-id="3660e-162">The NPS role service provides the RADIUS server and client functionality as well as Network Access Policy health service.</span></span> <span data-ttu-id="3660e-163">Эту роль необходимо установить как минимум на двух компьютерах в инфраструктуре: одну на шлюзе удаленных рабочих столов, а другую — на рядовом сервере или контроллере домена.</span><span class="sxs-lookup"><span data-stu-id="3660e-163">This role must be installed on at least two computers in your infrastructure: The Remote Desktop Gateway and another member server or domain controller.</span></span> <span data-ttu-id="3660e-164">По умолчанию эта роль уже существует на компьютере, который настроен в качестве шлюза удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-164">By default, the role is already present on the computer configured as the Remote Desktop Gateway.</span></span>  <span data-ttu-id="3660e-165">Необходимо также установить роль NPS по крайней мере еще на одном компьютере, например контроллере домена или рядовом сервере.</span><span class="sxs-lookup"><span data-stu-id="3660e-165">You must also install the NPS role on at least on another computer, such as a domain controller or member server.</span></span>

<span data-ttu-id="3660e-166">Дополнительные сведения об установке службы роли NPS на компьютер под управлением Windows Server 2012 или более ранней версии см. в разделе [Install a NAP Health Policy Server](https://technet.microsoft.com/library/dd296890.aspx) (Установка сервера политики работоспособности NAP).</span><span class="sxs-lookup"><span data-stu-id="3660e-166">For information on installing the NPS role service Windows Server 2012 or older, see [Install a NAP Health Policy Server](https://technet.microsoft.com/library/dd296890.aspx).</span></span> <span data-ttu-id="3660e-167">Описание рекомендаций для сервера политики сети, включая рекомендации по установке сервера политики сети на контроллер домена, см. в разделе [Best Practices for NPS](https://technet.microsoft.com/library/cc771746) (Рекомендации для сервера политики сети).</span><span class="sxs-lookup"><span data-stu-id="3660e-167">For a description of best practices for NPS, including the recommendation to install NPS on a domain controller, see [Best Practices for NPS](https://technet.microsoft.com/library/cc771746).</span></span>

### <a name="azure-active-directory-synched-with-on-premises-active-directory"></a><span data-ttu-id="3660e-168">Синхронизация Azure Active Directory с локальной службой Active Directory</span><span class="sxs-lookup"><span data-stu-id="3660e-168">Azure Active Directory synched with on-premises Active Directory</span></span> 
<span data-ttu-id="3660e-169">Для использования расширения NPS локальные пользователи должны быть синхронизированы с Azure AD и настроены для использования Многофакторной идентификации.</span><span class="sxs-lookup"><span data-stu-id="3660e-169">To use the NPS extension, on-premises users must be synced with Azure AD and enabled for MFA.</span></span> <span data-ttu-id="3660e-170">В этом разделе предполагается, что синхронизация локальных пользователей с Azure AD выполнена с помощью AD Connect.</span><span class="sxs-lookup"><span data-stu-id="3660e-170">This section assumes that on-premises users are synched with Azure AD using AD Connect.</span></span> <span data-ttu-id="3660e-171">Дополнительные сведения про Azure AD Connect см. в статье [Выборочная установка Azure AD Connect](../active-directory/connect/active-directory-aadconnect.md).</span><span class="sxs-lookup"><span data-stu-id="3660e-171">For information on Azure AD connect, see [Integrate your on-premises directories with Azure Active Directory](../active-directory/connect/active-directory-aadconnect.md).</span></span> 

### <a name="azure-active-directory-guid-id"></a><span data-ttu-id="3660e-172">Идентификатор GUID Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="3660e-172">Azure Active Directory GUID ID</span></span>
<span data-ttu-id="3660e-173">Чтобы установить сервер политики сети, необходимо знать идентификатор GUID Azure AD.</span><span class="sxs-lookup"><span data-stu-id="3660e-173">To install NPS, you need to know the GUID of the Azure AD.</span></span> <span data-ttu-id="3660e-174">Ниже приведены инструкции по поиску идентификатора GUID Azure AD.</span><span class="sxs-lookup"><span data-stu-id="3660e-174">Instructions for finding the GUID of the Azure AD are provided below.</span></span>

## <a name="configure-multi-factor-authentication"></a><span data-ttu-id="3660e-175">Настройка Многофакторной идентификации</span><span class="sxs-lookup"><span data-stu-id="3660e-175">Configure Multi-Factor Authentication</span></span> 
<span data-ttu-id="3660e-176">Этот раздел содержит инструкции по интеграции Azure MFA со шлюзом удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-176">This section provides instructions for integrating Azure MFA with the Remote Desktop Gateway.</span></span> <span data-ttu-id="3660e-177">В качестве администратора необходимо настроить службу Azure MFA, прежде чем пользователи смогут самостоятельно регистрировать свои устройства или приложений для Многофакторной идентификации.</span><span class="sxs-lookup"><span data-stu-id="3660e-177">As an administrator, you must configure the Azure MFA service before users can self-register their multi-factor devices or applications.</span></span>

<span data-ttu-id="3660e-178">Следуйте указаниям в разделе [Приступая к работе со службой "Многофакторная идентификация Microsoft Azure" в облаке](multi-factor-authentication-get-started-cloud.md), чтобы включить Многофакторную идентификацию Azure для пользователей Azure AD.</span><span class="sxs-lookup"><span data-stu-id="3660e-178">Follow the steps in [Getting started with Azure Multi-Factor Authentication in the cloud](multi-factor-authentication-get-started-cloud.md) to enable MFA for your Azure AD users.</span></span> 

### <a name="configure-accounts-for-two-step-verification"></a><span data-ttu-id="3660e-179">Настройка учетных записей для двухфакторной проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="3660e-179">Configure accounts for two-step verification</span></span>
<span data-ttu-id="3660e-180">После включения Многофакторной идентификации для учетной записи вы не сможете выполнить вход для доступа к ресурсам, управляемым политикой MFA, пока не настроите доверенное устройство для второго фактора аутентификации и не пройдете двухфакторную проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="3660e-180">Once an account has been enabled for MFA, you cannot sign in to resources governed by the MFA policy until you have successfully configured a trusted device to use for the second authentication factor have authenticated using two-step verification.</span></span>

<span data-ttu-id="3660e-181">Следуйте указаниям в разделе [Что для меня означает Azure Multi-Factor Authentication](./end-user/multi-factor-authentication-end-user.md), чтобы понять процедуру и правильно настроить устройства для Многофакторной идентификации с помощью своей учетной записи пользователя.</span><span class="sxs-lookup"><span data-stu-id="3660e-181">Follow the steps in [What does Azure Multi-Factor Authentication mean for me?](./end-user/multi-factor-authentication-end-user.md) to understand and properly configure your devices for MFA with your user account.</span></span>

## <a name="install-and-configure-nps-extension"></a><span data-ttu-id="3660e-182">Установка и настройка расширения NPS</span><span class="sxs-lookup"><span data-stu-id="3660e-182">Install and configure NPS extension</span></span>
<span data-ttu-id="3660e-183">Этот раздел содержит инструкции по настройке инфраструктуры служб удаленных рабочих столов для использования Azure MFA для аутентификации клиентов с помощью шлюза удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-183">This section provides instructions for configuring RDS infrastructure to use Azure MFA for client authentication with the Remote Desktop Gateway.</span></span>

### <a name="acquire-azure-active-directory-guid-id"></a><span data-ttu-id="3660e-184">Получение идентификатора GUID Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="3660e-184">Acquire Azure Active Directory GUID ID</span></span>

<span data-ttu-id="3660e-185">При настройке расширения NPS необходимо ввести учетные данные администратора и идентификатор Azure AD для клиента Azure AD.</span><span class="sxs-lookup"><span data-stu-id="3660e-185">As part of the configuration of the NPS extension, you need to supply admin credentials and the Azure AD ID for your Azure AD tenant.</span></span> <span data-ttu-id="3660e-186">Ниже описывается, как получить идентификатор клиента.</span><span class="sxs-lookup"><span data-stu-id="3660e-186">The following steps show you how to get the tenant ID.</span></span>

1. <span data-ttu-id="3660e-187">Войдите на [портал Azure](https://portal.azure.com) как глобальный администратор клиента Azure.</span><span class="sxs-lookup"><span data-stu-id="3660e-187">Sign in to the [Azure portal](https://portal.azure.com) as the global administrator of the Azure tenant.</span></span>
2. <span data-ttu-id="3660e-188">В области навигации слева щелкните значок **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="3660e-188">In the left navigation, select the **Azure Active Directory** icon.</span></span>
3. <span data-ttu-id="3660e-189">Выберите **Свойства**.</span><span class="sxs-lookup"><span data-stu-id="3660e-189">Select **Properties**.</span></span>
4. <span data-ttu-id="3660e-190">В колонке "Свойства" рядом с идентификатором каталога щелкните значок **Копировать**, как показано ниже, чтобы скопировать идентификатор в буфер обмена.</span><span class="sxs-lookup"><span data-stu-id="3660e-190">In the Properties blade, beside the Directory ID, click the **Copy** icon, as shown below, to copy the ID to clipboard.</span></span>

 ![Свойства](./media/nps-extension-remote-desktop-gateway/image1.png)

### <a name="install-the-nps-extension"></a><span data-ttu-id="3660e-192">Установка расширения NPS</span><span class="sxs-lookup"><span data-stu-id="3660e-192">Install the NPS extension</span></span>
<span data-ttu-id="3660e-193">Установите расширение NPS на сервер, на котором установлена роль "Службы политики сети и доступа" (NPS).</span><span class="sxs-lookup"><span data-stu-id="3660e-193">Install the NPS extension on a server that has the Network Policy and Access Services (NPS) role installed.</span></span> <span data-ttu-id="3660e-194">Он выполняет роль сервера RADIUS в нашей инфраструктуре.</span><span class="sxs-lookup"><span data-stu-id="3660e-194">This functions as the RADIUS server for your design.</span></span> 

>[!Important]
> <span data-ttu-id="3660e-195">Не следует устанавливать расширение NPS на сервер шлюза удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-195">Be sure you do not install the NPS extension on your Remote Desktop Gateway server.</span></span>
> 

1. <span data-ttu-id="3660e-196">Скачайте [расширение NPS](https://aka.ms/npsmfa).</span><span class="sxs-lookup"><span data-stu-id="3660e-196">Download the [NPS extension](https://aka.ms/npsmfa).</span></span> 
2. <span data-ttu-id="3660e-197">Скопируйте исполняемый установочный файл (NpsExtnForAzureMfaInstaller.exe) на NPS-сервер.</span><span class="sxs-lookup"><span data-stu-id="3660e-197">Copy the setup executable file (NpsExtnForAzureMfaInstaller.exe) to the NPS server.</span></span>
3. <span data-ttu-id="3660e-198">На NPS-сервере дважды щелкните файл **NpsExtnForAzureMfaInstaller.exe**.</span><span class="sxs-lookup"><span data-stu-id="3660e-198">On the NPS server, double-click **NpsExtnForAzureMfaInstaller.exe**.</span></span> <span data-ttu-id="3660e-199">При появлении запроса щелкните **Запустить**.</span><span class="sxs-lookup"><span data-stu-id="3660e-199">If prompted, click **Run**.</span></span>
4. <span data-ttu-id="3660e-200">В диалоговом окне "NPS Extension for Azure MFA" (Расширение NPS для Azure MFA) ознакомьтесь с условиями лицензии на программное обеспечение, установите флажок **Я подтверждаю согласие с условиями лицензии** и нажмите кнопку **Установить**.</span><span class="sxs-lookup"><span data-stu-id="3660e-200">In the NPS Extension for Azure MFA dialog box, review the software license terms, check **I agree to the license terms and conditions**, and click **Install**.</span></span>
 
  ![Установка Azure MFA](./media/nps-extension-remote-desktop-gateway/image2.png)

5. <span data-ttu-id="3660e-202">В диалоговом окне "NPS Extension for Azure MFA" (Расширение NPS для Azure MFA) нажмите кнопку "Закрыть".</span><span class="sxs-lookup"><span data-stu-id="3660e-202">In the NPS Extension for Azure MFA dialog box, click Close.</span></span> 

  ![Расширение NPS для MFA Azure](./media/nps-extension-remote-desktop-gateway/image3.png)

### <a name="configure-certificates-for-use-with-the-nps-extension-using-a-powershell-script"></a><span data-ttu-id="3660e-204">Настройка сертификатов для расширения NPS с помощью сценария PowerShell</span><span class="sxs-lookup"><span data-stu-id="3660e-204">Configure certificates for use with the NPS extension using a PowerShell script</span></span>
<span data-ttu-id="3660e-205">Далее необходимо настроить сертификаты для расширения NPS, чтобы обеспечить безопасную связь и контроль.</span><span class="sxs-lookup"><span data-stu-id="3660e-205">Next, you need to configure certificates for use by the NPS extension to ensure secure communications and assurance.</span></span> <span data-ttu-id="3660e-206">Компоненты NPS включают в себя сценарий Windows PowerShell, предназначенный для настройки самозаверяющего сертификата для сервера политики сети.</span><span class="sxs-lookup"><span data-stu-id="3660e-206">The NPS components include a Windows PowerShell script that configures a self-signed certificate for use with NPS.</span></span> 

<span data-ttu-id="3660e-207">Этот сценарий выполняет следующие действия:</span><span class="sxs-lookup"><span data-stu-id="3660e-207">The script performs the following actions:</span></span>

* <span data-ttu-id="3660e-208">создает самозаверяющий сертификат;</span><span class="sxs-lookup"><span data-stu-id="3660e-208">Creates a self-signed certificate</span></span>
* <span data-ttu-id="3660e-209">связывает открытый ключ сертификата с субъектом-службой в Azure AD;</span><span class="sxs-lookup"><span data-stu-id="3660e-209">Associates public key of certificate to service principal on Azure AD</span></span>
* <span data-ttu-id="3660e-210">сохраняет сертификат в хранилище на локальном компьютере;</span><span class="sxs-lookup"><span data-stu-id="3660e-210">Stores the cert in the local machine store</span></span>
* <span data-ttu-id="3660e-211">предоставляет сетевому пользователю доступ к закрытому ключу сертификата;</span><span class="sxs-lookup"><span data-stu-id="3660e-211">Grants access to the certificate’s private key to the network user</span></span>
* <span data-ttu-id="3660e-212">перезапускает службу сервера политики сети.</span><span class="sxs-lookup"><span data-stu-id="3660e-212">Restarts Network Policy Server service</span></span>

<span data-ttu-id="3660e-213">Если вы хотите использовать собственные сертификаты, необходимо привязать открытый ключ сертификата к субъекту-службе в Azure AD и т. д.</span><span class="sxs-lookup"><span data-stu-id="3660e-213">If you want to use your own certificates, you need to associate the public of your certificate to the service principle on Azure AD, and so on.</span></span>

<span data-ttu-id="3660e-214">Чтобы использовать этот сценарий, укажите в расширении свои учетные данные администратора Azure AD и идентификатор клиента Azure AD, скопированный ранее.</span><span class="sxs-lookup"><span data-stu-id="3660e-214">To use the script, provide the extension with your Azure AD Admin credentials and the Azure AD tenant ID that you copied earlier.</span></span> <span data-ttu-id="3660e-215">Запустите сценарий на каждом NPS-сервере, на котором установлено расширение NPS.</span><span class="sxs-lookup"><span data-stu-id="3660e-215">Run the script on each NPS server where you installed the NPS extension.</span></span> <span data-ttu-id="3660e-216">После этого выполните описанные ниже действия.</span><span class="sxs-lookup"><span data-stu-id="3660e-216">Then do the following:</span></span>

1. <span data-ttu-id="3660e-217">Откройте командную строку Windows PowerShell с правами администратора.</span><span class="sxs-lookup"><span data-stu-id="3660e-217">Open an administrative Windows PowerShell prompt.</span></span>
2. <span data-ttu-id="3660e-218">В командной строке PowerShell введите команду **cd ‘c:\Program Files\Microsoft\AzureMfa\Config’** и нажмите клавишу **ВВОД**.</span><span class="sxs-lookup"><span data-stu-id="3660e-218">At the PowerShell prompt, type **cd ‘c:\Program Files\Microsoft\AzureMfa\Config’**, and press **ENTER**.</span></span>
3. <span data-ttu-id="3660e-219">Введите _.\AzureMfsNpsExtnConfigSetup.ps1_ и нажмите клавишу **ВВОД**.</span><span class="sxs-lookup"><span data-stu-id="3660e-219">Type _.\AzureMfsNpsExtnConfigSetup.ps1_, and press **ENTER**.</span></span> <span data-ttu-id="3660e-220">Сценарий проверяет, установлен ли модуль Azure Active Directory для PowerShell.</span><span class="sxs-lookup"><span data-stu-id="3660e-220">The script checks to see if the Azure Active Directory PowerShell module is installed.</span></span> <span data-ttu-id="3660e-221">Если он не установлен, сценарий автоматически установит этот модуль.</span><span class="sxs-lookup"><span data-stu-id="3660e-221">If not installed, the script installs the module for you.</span></span>

  ![Azure AD PowerShell](./media/nps-extension-remote-desktop-gateway/image4.png)
  
4. <span data-ttu-id="3660e-223">Проверив установку модуля PowerShell, сценарий отображает диалоговое окно модуля Azure Active Directory для PowerShell.</span><span class="sxs-lookup"><span data-stu-id="3660e-223">After the script verifies the installation of the PowerShell module, it displays the Azure Active Directory PowerShell module dialog box.</span></span> <span data-ttu-id="3660e-224">В этом диалоговом окне введите учетные данные администратора Azure AD и пароль, затем щелкните **Вход**.</span><span class="sxs-lookup"><span data-stu-id="3660e-224">In the dialog box, enter your Azure AD admin credentials and password, and click **Sign In**.</span></span>

  ![Открытие учетной записи PowerShell](./media/nps-extension-remote-desktop-gateway/image5.png)

5. <span data-ttu-id="3660e-226">При появлении запроса вставьте идентификатор клиента, скопированный в буфер обмена ранее, и нажмите клавишу **ВВОД**.</span><span class="sxs-lookup"><span data-stu-id="3660e-226">When prompted, paste the tenant ID you copied to the clipboard earlier, and press **ENTER**.</span></span>

  ![Ввод идентификатора клиента](./media/nps-extension-remote-desktop-gateway/image6.png)

6. <span data-ttu-id="3660e-228">Этот сценарий создает самозаверяющий сертификат и выполняет другие изменения конфигурация.</span><span class="sxs-lookup"><span data-stu-id="3660e-228">The script creates a self-signed certificate and performs other configuration changes.</span></span> <span data-ttu-id="3660e-229">На рисунке ниже показан пример выходных данных.</span><span class="sxs-lookup"><span data-stu-id="3660e-229">The output should be like the image shown below.</span></span>

  ![Самозаверяющий сертификат](./media/nps-extension-remote-desktop-gateway/image7.png)

## <a name="configure-nps-components-on-remote-desktop-gateway"></a><span data-ttu-id="3660e-231">Настройка компонентов NPS на шлюзе удаленных рабочих столов</span><span class="sxs-lookup"><span data-stu-id="3660e-231">Configure NPS components on Remote Desktop Gateway</span></span>
<span data-ttu-id="3660e-232">В этом разделе описывается настройка политик авторизации подключений к шлюзу удаленных рабочих столов и других параметров RADIUS.</span><span class="sxs-lookup"><span data-stu-id="3660e-232">In this section, you configure the Remote Desktop Gateway connection authorization policies and other RADIUS settings.</span></span>

<span data-ttu-id="3660e-233">Для аутентификации требуется обмен сообщениями RADIUS между шлюзом удаленных рабочих столов и NPS-сервером, на котором установлено расширение NPS.</span><span class="sxs-lookup"><span data-stu-id="3660e-233">The authentication flow requires that RADIUS messages be exchanged between the Remote Desktop Gateway and the NPS server where the NPS Server is installed.</span></span> <span data-ttu-id="3660e-234">Это означает, что необходимо настроить параметры клиента RADIUS на шлюзе удаленных рабочих столов и NPS-сервере, на котором установлено расширение NPS.</span><span class="sxs-lookup"><span data-stu-id="3660e-234">This means that you must configure RADIUS client settings on both Remote Desktop Gateway and the NPS server where the NPS extension is installed.</span></span> 

### <a name="configure-remote-desktop-gateway-connection-authorization-policies-to-use-central-store"></a><span data-ttu-id="3660e-235">Настройка политик авторизации подключений к шлюзу удаленных рабочих столов для использования центрального хранилища</span><span class="sxs-lookup"><span data-stu-id="3660e-235">Configure Remote Desktop Gateway connection authorization policies to use central store</span></span>
<span data-ttu-id="3660e-236">Политики авторизации подключений к удаленным рабочим столам определяют требования для подключения к серверу шлюза удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-236">Remote Desktop connection authorization policies (RD CAPs) specify the requirements for connecting to a Remote Desktop Gateway server.</span></span> <span data-ttu-id="3660e-237">Эти политики могут сохраняться локально (по умолчанию) или в центральном хранилище, в котором выполняется сервер политики сети.</span><span class="sxs-lookup"><span data-stu-id="3660e-237">RD CAPs can be stored locally (default) or they can be stored in a central RD CAP store that is running NPS.</span></span> <span data-ttu-id="3660e-238">Чтобы настроить интеграцию Azure MFA со службами удаленных рабочих столов, необходимо задать использование центрального хранилища.</span><span class="sxs-lookup"><span data-stu-id="3660e-238">To configure integration of Azure MFA with RDS, you need to specify the use of a central store.</span></span>

1. <span data-ttu-id="3660e-239">На сервере шлюза удаленных рабочих столов откройте **диспетчер сервера**.</span><span class="sxs-lookup"><span data-stu-id="3660e-239">On the RD Gateway server, open **Server Manager**.</span></span> 
2. <span data-ttu-id="3660e-240">В меню щелкните **Средства**, наведите указатель мыши на пункт **Службы удаленных рабочих столов**, а затем щелкните **Диспетчер шлюза удаленных рабочих столов**.</span><span class="sxs-lookup"><span data-stu-id="3660e-240">On the menu, click **Tools**, point to **Remote Desktop Services**, and then click **Remote Desktop Gateway Manager**.</span></span>

  ![Службы удаленных рабочих столов](./media/nps-extension-remote-desktop-gateway/image8.png)

3. <span data-ttu-id="3660e-242">В диспетчере шлюза удаленных рабочих Столов щелкните правой кнопкой мыши **\[имя сервера\] (локальный)** и выберите **Свойства**.</span><span class="sxs-lookup"><span data-stu-id="3660e-242">In the RD Gateway Manger, right-click **\[Server Name\] (Local)**, and click **Properties**.</span></span>

  ![Имя сервера](./media/nps-extension-remote-desktop-gateway/image9.png)

4. <span data-ttu-id="3660e-244">В диалоговом окне "Свойства" выберите вкладку **Хранилище политики авторизации подключений к удаленным рабочим столам**.</span><span class="sxs-lookup"><span data-stu-id="3660e-244">In the Properties dialog box, select the **RD CAP** Store tab.</span></span>
5. <span data-ttu-id="3660e-245">На вкладке "Хранилище политики авторизации подключений к удаленным рабочим столам" и выберите **Центральный сервер политики сети**.</span><span class="sxs-lookup"><span data-stu-id="3660e-245">On the RD CAP Store tab, select **Central Server running NPS**.</span></span> 
6. <span data-ttu-id="3660e-246">В поле **Введите имя или IP-адрес сервера политики сети** введите IP-адрес или имя сервера, на котором установлено расширение NPS.</span><span class="sxs-lookup"><span data-stu-id="3660e-246">In the **Enter a name or IP address for the server running NPS** field, type the IP address or server name of the server where you installed the NPS extension.</span></span>

  ![Ввод имени или IP-адреса](./media/nps-extension-remote-desktop-gateway/image10.png)
  
7. <span data-ttu-id="3660e-248">Щелкните **Добавить**.</span><span class="sxs-lookup"><span data-stu-id="3660e-248">Click **Add**.</span></span>
8. <span data-ttu-id="3660e-249">В диалоговом окне **Общий секрет** введите общий секрет и нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="3660e-249">In the **Shared Secret** dialog box, enter a shared secret, and then click **OK**.</span></span> <span data-ttu-id="3660e-250">Обязательно запишите этот общий секрет и сохраните в безопасном месте.</span><span class="sxs-lookup"><span data-stu-id="3660e-250">Ensure you record this shared secret and store the record securely.</span></span>

 >[!NOTE]
 ><span data-ttu-id="3660e-251">Он используется для установления доверия между серверами и клиентами RADIUS.</span><span class="sxs-lookup"><span data-stu-id="3660e-251">Shared secret is used to establish trust between the RADIUS servers and clients.</span></span> <span data-ttu-id="3660e-252">Создайте длинный и сложный пароль.</span><span class="sxs-lookup"><span data-stu-id="3660e-252">Create a long and complex password.</span></span>
 >

 ![Общий секрет](./media/nps-extension-remote-desktop-gateway/image11.png)

9. <span data-ttu-id="3660e-254">Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно.</span><span class="sxs-lookup"><span data-stu-id="3660e-254">Click **OK** to close the dialog box.</span></span>

### <a name="configure-radius-timeout-value-on-remote-desktop-gateway-nps"></a><span data-ttu-id="3660e-255">Настройка значения времени ожидания RADIUS на сервере политики сети шлюза удаленных рабочих столов</span><span class="sxs-lookup"><span data-stu-id="3660e-255">Configure RADIUS timeout value on Remote Desktop Gateway NPS</span></span>
<span data-ttu-id="3660e-256">Чтобы обеспечить достаточно времени для проверки учетных данных пользователей, двухфакторной проверки подлинности, получения ответов и реагирования на сообщения RADIUS, необходимо настроить значение времени ожидания RADIUS.</span><span class="sxs-lookup"><span data-stu-id="3660e-256">To ensure there is time to validate users’ credentials, perform two-step verification, receive responses, and respond to RADIUS messages, it is necessary to adjust the RADIUS timeout value.</span></span>

1. <span data-ttu-id="3660e-257">На сервере шлюза удаленных рабочих столов откройте диспетчер сервера и щелкните **Средства**, а затем щелкните **Сервер политики сети**.</span><span class="sxs-lookup"><span data-stu-id="3660e-257">On the RD Gateway server, in Server Manager, click **Tools**, and then click **Network Policy Server**.</span></span> 
2. <span data-ttu-id="3660e-258">В консоли **Сервер сетевых политик (локальный)** разверните элемент **RADIUS-клиенты и серверы** и выберите **Remote RADIUS Server** (Удаленный сервер RADIUS).</span><span class="sxs-lookup"><span data-stu-id="3660e-258">In the **NPS (Local)** console, expand **RADIUS Clients and Servers**, and select **Remote RADIUS Server**.</span></span>

 ![Удаленный сервер RADIUS](./media/nps-extension-remote-desktop-gateway/image12.png)

3. <span data-ttu-id="3660e-260">В области сведений дважды щелкните **TS GATEWAY SERVER GROUP** (Группа серверов шлюза службы терминалов).</span><span class="sxs-lookup"><span data-stu-id="3660e-260">In the details pane, double-click **TS GATEWAY SERVER GROUP**.</span></span>

 >[!NOTE]
 ><span data-ttu-id="3660e-261">Данная группа серверов RADIUS была создана при настройке центрального сервера для политик NPS.</span><span class="sxs-lookup"><span data-stu-id="3660e-261">This RADIUS Server Group was created when you configured the central server for NPS policies.</span></span> <span data-ttu-id="3660e-262">Шлюз удаленных рабочих столов перенаправляет сообщения RADIUS на этот сервер или в группу серверов, если серверов в группе несколько.</span><span class="sxs-lookup"><span data-stu-id="3660e-262">The RD Gateway forwards RADIUS messages to this server or group of servers, if more than one in the group.</span></span>
 >

4. <span data-ttu-id="3660e-263">В диалоговом окне **TS GATEWAY SERVER GROUP Properties** (Свойства группы серверов шлюза службы терминалов) выберите IP-адрес или имя NPS-сервера, настроенного для хранения политик авторизации подключений к удаленным рабочим столам, а затем нажмите кнопку **Изменить**.</span><span class="sxs-lookup"><span data-stu-id="3660e-263">In the **TS GATEWAY SERVER GROUP Properties** dialog box, select the IP address or name of the NPS server you configured to store RD CAPs, and then click **Edit**.</span></span> 

 ![Группа серверов шлюза служб терминалов](./media/nps-extension-remote-desktop-gateway/image13.png)

5. <span data-ttu-id="3660e-265">В диалоговом окне **Изменение сервера RADIUS** выберите вкладку **Балансировка нагрузки**.</span><span class="sxs-lookup"><span data-stu-id="3660e-265">In the **Edit RADIUS Server** dialog box, select the **Load Balancing** tab.</span></span>
6. <span data-ttu-id="3660e-266">На вкладке **Балансировка нагрузки** в поле **Число секунд без ответа, после которого запрос считается отброшенным** измените значение по умолчанию, равное 3, на значение в диапазоне от 30 до 60 секунд.</span><span class="sxs-lookup"><span data-stu-id="3660e-266">In the **Load Balancing** tab, in the **Number of seconds without response before request is considered dropped** field, change the default value from 3 to a value between 30 and 60 seconds.</span></span>
7. <span data-ttu-id="3660e-267">В поле **Число секунд между запросами, после которого сервер считается недоступным** измените значение по умолчанию, равное 30 секундам, на значение, которое равно или больше значения, указанного на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="3660e-267">In the **Number of seconds between requests when server is identified as unavailable** field, change the default value of 30 seconds to a value that is equal to or greater than the value you specified in the previous step.</span></span>

 ![Изменение сервера RADIUS](./media/nps-extension-remote-desktop-gateway/image14.png)

8.  <span data-ttu-id="3660e-269">Дважды нажмите кнопку "ОК", чтобы закрыть диалоговые окна.</span><span class="sxs-lookup"><span data-stu-id="3660e-269">Click OK two times to close the dialog boxes.</span></span>

### <a name="verify-connection-request-policies"></a><span data-ttu-id="3660e-270">Проверка политик запросов на подключение</span><span class="sxs-lookup"><span data-stu-id="3660e-270">Verify Connection Request Policies</span></span> 
<span data-ttu-id="3660e-271">По умолчанию при настройке шлюза удаленных рабочих столов для использования центрального хранилища для политик авторизации подключений шлюз удаленных рабочих столов перенаправляет запросы политик авторизации подключений на NPS-сервер.</span><span class="sxs-lookup"><span data-stu-id="3660e-271">By default, when you configure the RD Gateway to use a central policy store for connection authorization policies, the RD Gateway is configured to forward CAP requests to the NPS server.</span></span> <span data-ttu-id="3660e-272">NPS-сервер, на котором установлено расширение Azure MFA, обрабатывает запрос на доступ RADIUS.</span><span class="sxs-lookup"><span data-stu-id="3660e-272">The NPS server with the Azure MFA extension installed, processes the RADIUS access request.</span></span> <span data-ttu-id="3660e-273">Ниже показано, как проверить политику запросов на подключение по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="3660e-273">The following steps show you how to verify the default connection request policy.</span></span> 

1. <span data-ttu-id="3660e-274">На шлюзе удаленных рабочих столов в консоли "Сервер сетевых политик (локальный)" разверните элемент **Политики** и выберите **Политики запросов на подключение**.</span><span class="sxs-lookup"><span data-stu-id="3660e-274">On the RD Gateway, in the NPS (Local) console, expand **Policies**, and select **Connection Request Policies**.</span></span>
2. <span data-ttu-id="3660e-275">Щелкните правой кнопкой мыши **Политики запросов на подключение** и дважды щелкните **TS GATEWAY AUTHORIZATION POLICY** (Политика авторизации шлюза службы терминалов).</span><span class="sxs-lookup"><span data-stu-id="3660e-275">Right-click **Connect Request Policies**, and double-click **TS GATEWAY AUTHORIZATION POLICY**.</span></span>
3. <span data-ttu-id="3660e-276">В диалоговом окне **TS GATEWAY AUTHORIZATION POLICY properties** (Свойства политики авторизации шлюза службы терминалов) щелкните вкладку **Параметры**.</span><span class="sxs-lookup"><span data-stu-id="3660e-276">In the **TS GATEWAY AUTHORIZATION POLICY properties** dialog box, click the **Settings** tab.</span></span>
4. <span data-ttu-id="3660e-277">На вкладке **Параметры** в разделе "Пересылка запроса на подключение" щелкните **Проверка подлинности**.</span><span class="sxs-lookup"><span data-stu-id="3660e-277">On **Settings** tab, under Forwarding Connection Request, click **Authentication**.</span></span> <span data-ttu-id="3660e-278">Клиент RADIUS настроен для пересылки запросов на аутентификацию.</span><span class="sxs-lookup"><span data-stu-id="3660e-278">RADIUS client is configured to forward requests for authentication.</span></span>

 ![Параметры аутентификации](./media/nps-extension-remote-desktop-gateway/image15.png)
 
5. <span data-ttu-id="3660e-280">Нажмите кнопку **Отмена**.</span><span class="sxs-lookup"><span data-stu-id="3660e-280">Click **Cancel**.</span></span> 

## <a name="configure-nps-on-the-server-where-the-nps-extension-is-installed"></a><span data-ttu-id="3660e-281">Настройка компонентов NPS на сервере, на котором установлено расширение NPS</span><span class="sxs-lookup"><span data-stu-id="3660e-281">Configure NPS on the server where the NPS extension is installed</span></span>
<span data-ttu-id="3660e-282">NPS-сервер, на котором установлено расширение NPS, должен иметь возможность обмениваться сообщениями RADIUS с NPS-сервером в шлюзе удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-282">The NPS server where the NPS extension is installed needs to be able to exchange RADIUS messages with the NPS server on the Remote Desktop Gateway.</span></span> <span data-ttu-id="3660e-283">Чтобы обеспечить этот обмен сообщениями, необходимо настроить компоненты NPS на сервере, на котором установлена служба расширения NPS.</span><span class="sxs-lookup"><span data-stu-id="3660e-283">To enable this message exchange, you need to configure the NPS components on the server where the NPS extension service is installed.</span></span> 

### <a name="register-server-in-active-directory"></a><span data-ttu-id="3660e-284">Регистрация сервера в Active Directory</span><span class="sxs-lookup"><span data-stu-id="3660e-284">Register Server in Active Directory</span></span>
<span data-ttu-id="3660e-285">Для правильной работы в этом сценарии NPS-сервер должен быть зарегистрирован в Active Directory.</span><span class="sxs-lookup"><span data-stu-id="3660e-285">To function properly in this scenario, the NPS server needs to be registered in Active Directory.</span></span>

1. <span data-ttu-id="3660e-286">Откройте **диспетчер сервера**.</span><span class="sxs-lookup"><span data-stu-id="3660e-286">Open **Server Manager**.</span></span>
2. <span data-ttu-id="3660e-287">В диспетчере сервера щелкните **Средства**, а затем щелкните **Сервер политики сети**.</span><span class="sxs-lookup"><span data-stu-id="3660e-287">In Server Manager, click **Tools**, and then click **Network Policy Server**.</span></span> 
3. <span data-ttu-id="3660e-288">В консоли сервера политики сети щелкните правой кнопкой мыши **Сервер сетевых политик (локальный)**, а затем щелкните **Зарегистрировать сервер в Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="3660e-288">In the Network Policy Server console, right-click **NPS (Local)**, and then click **Register server in Active Directory**.</span></span> 
4. <span data-ttu-id="3660e-289">Дважды нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="3660e-289">Click **OK** two times.</span></span>

 ![Регистрация сервера в AD](./media/nps-extension-remote-desktop-gateway/image16.png)

5. <span data-ttu-id="3660e-291">Оставьте консоль открытой для выполнения следующей процедуры.</span><span class="sxs-lookup"><span data-stu-id="3660e-291">Leave the console open for the next procedure.</span></span>

### <a name="create-and-configure-radius-client"></a><span data-ttu-id="3660e-292">Создание и настройка клиента RADIUS</span><span class="sxs-lookup"><span data-stu-id="3660e-292">Create and configure RADIUS client</span></span> 
<span data-ttu-id="3660e-293">Шлюз удаленных рабочих столов необходимо настроить как клиент RADIUS на NPS-сервере.</span><span class="sxs-lookup"><span data-stu-id="3660e-293">The Remote Desktop Gateway needs to be configured as a RADIUS client to the NPS server.</span></span> 

1. <span data-ttu-id="3660e-294">На NPS-сервере, на котором установлено расширение NPS, в консоли **Сервер сетевых политик (локальный)** щелкните правой кнопкой мыши **RADIUS-клиенты** и выберите **Создать**.</span><span class="sxs-lookup"><span data-stu-id="3660e-294">On the NPS server where the NPS extension is installed, in the **NPS (Local)** console, right-click **RADIUS Clients** and click **New**.</span></span>

 ![Новые клиенты RADIUS](./media/nps-extension-remote-desktop-gateway/image17.png)

2. <span data-ttu-id="3660e-296">В диалоговом окне **Новый RADIUS-клиент** введите понятное имя, например _Шлюз_, и IP-адрес или DNS-имя сервера шлюза удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-296">In the **New RADIUS client** dialog box, provide a friendly name, such as _Gateway_, and the IP address or DNS name of the Remote Desktop Gateway server.</span></span> 
3. <span data-ttu-id="3660e-297">В полях **Общий секрет** и **Подтвердите общий секрет** введите тот же секрет, который использовался ранее.</span><span class="sxs-lookup"><span data-stu-id="3660e-297">In the **Shared secret** and the **Confirm shared secret** fields, enter the same secret that you used before.</span></span>

 ![Имя и адрес](./media/nps-extension-remote-desktop-gateway/image18.png)

4. <span data-ttu-id="3660e-299">Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно "Новый RADIUS-клиент".</span><span class="sxs-lookup"><span data-stu-id="3660e-299">Click **OK** to close the New RADIUS client dialog box.</span></span>

### <a name="configure-network-policy"></a><span data-ttu-id="3660e-300">Настройка политики сети</span><span class="sxs-lookup"><span data-stu-id="3660e-300">Configure Network Policy</span></span>
<span data-ttu-id="3660e-301">Как вы помните, NPS-сервер с расширением Azure MFA был назначен центральным хранилищем для политики авторизации подключений.</span><span class="sxs-lookup"><span data-stu-id="3660e-301">Recall the NPS server with the Azure MFA extension is the designated central policy store for the Connection Authorization Policy (CAP).</span></span> <span data-ttu-id="3660e-302">Поэтому необходимо внедрить политику авторизации подключений на NPS-сервере для авторизации допустимых запросов на подключение.</span><span class="sxs-lookup"><span data-stu-id="3660e-302">Therefore, you need to implement a CAP on the NPS server to authorize valid connections requests.</span></span>  

1. <span data-ttu-id="3660e-303">В консоли "Сервер сетевых политик (локальный)" разверните элемент **Политики** и щелкните **Сетевые политики**.</span><span class="sxs-lookup"><span data-stu-id="3660e-303">In the NPS (Local) console, expand **Policies**, and click **Network Policies**.</span></span>
2. <span data-ttu-id="3660e-304">Щелкните правой кнопкой мыши **Подключения к другим серверам доступа** и щелкните **Duplicate policy** (Копировать политику).</span><span class="sxs-lookup"><span data-stu-id="3660e-304">Right-click **Connections to other access servers**, and click **Duplicate policy**.</span></span> 

 ![Повторяющаяся политика](./media/nps-extension-remote-desktop-gateway/image19.png)

3. <span data-ttu-id="3660e-306">Щелкните правой кнопкой мыши **Copy of Connections to other access servers** (Копия политики подключения к другим серверам доступа) и щелкните **Свойства**.</span><span class="sxs-lookup"><span data-stu-id="3660e-306">Right-click **Copy of Connections to other access servers**, and click **Properties**.</span></span>

 ![Свойства сети](./media/nps-extension-remote-desktop-gateway/image20.png)

4. <span data-ttu-id="3660e-308">В диалоговом окне **Copy of Connections to other access servers** (Копия политики подключения к другим серверам доступа) в поле "Имя политики" введите подходящее имя, например **RDG_CAP**.</span><span class="sxs-lookup"><span data-stu-id="3660e-308">In the **Copy of Connections to other access servers** dialog box, in Policy Name, enter a suitable name, such as **RDG_CAP**.</span></span> <span data-ttu-id="3660e-309">Установите флажок **Политика включена** и щелкните **Разрешить доступ**.</span><span class="sxs-lookup"><span data-stu-id="3660e-309">Check **Policy Enabled**, and select **Grant access**.</span></span> <span data-ttu-id="3660e-310">При необходимости в разделе "Type of network access" (Тип доступа к сети) выберите **Шлюз удаленных рабочих столов** или оставьте стандартное значение **Не указано**.</span><span class="sxs-lookup"><span data-stu-id="3660e-310">Optionally, in Type of network access, select **Remote Desktop Gateway**, or you can leave it as **Unspecified**.</span></span>

 ![Копия политики подключения](./media/nps-extension-remote-desktop-gateway/image21.png)

5.  <span data-ttu-id="3660e-312">Щелкните вкладку **Ограничения** и установите флажок **Разрешить подключение клиентов без согласования метода проверки подлинности**.</span><span class="sxs-lookup"><span data-stu-id="3660e-312">Click the **Constraints** tab, and check **Allow clients to connect without negotiating an authentication method**.</span></span>

 ![Разрешение подключения клиентов](./media/nps-extension-remote-desktop-gateway/image22.png)

6. <span data-ttu-id="3660e-314">При необходимости щелкните вкладку **Условия** и добавьте условия, которые должны быть выполнены для авторизации подключения, например членство в определенной группе Windows.</span><span class="sxs-lookup"><span data-stu-id="3660e-314">Optionally, click the **Conditions** tab and add conditions that must be met for the connection to be authorized, for example, membership in a specific Windows group.</span></span>

 ![Условия](./media/nps-extension-remote-desktop-gateway/image23.png)

7. <span data-ttu-id="3660e-316">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="3660e-316">Click **OK**.</span></span> <span data-ttu-id="3660e-317">При появлении предложения просмотреть соответствующий раздел справки нажмите кнопку **Нет**.</span><span class="sxs-lookup"><span data-stu-id="3660e-317">When prompted to view the corresponding Help topic, click **No**.</span></span>
8. <span data-ttu-id="3660e-318">Убедитесь, что новая политика находится вверху списка, включена и предоставляет доступ.</span><span class="sxs-lookup"><span data-stu-id="3660e-318">Ensure that your new policy is at the top of the list, that the policy is enabled, and that it grants access.</span></span>

 ![Политики сети](./media/nps-extension-remote-desktop-gateway/image24.png)

## <a name="verify-configuration"></a><span data-ttu-id="3660e-320">Проверка конфигурации</span><span class="sxs-lookup"><span data-stu-id="3660e-320">Verify configuration</span></span>
<span data-ttu-id="3660e-321">Чтобы проверить конфигурацию, необходимо войти на шлюз удаленных рабочих столов с помощью подходящего клиента RDP.</span><span class="sxs-lookup"><span data-stu-id="3660e-321">To verify the configuration, you need to log on the Remote Desktop Gateway with a suitable RDP client.</span></span> <span data-ttu-id="3660e-322">Обязательно используйте учетную запись, которая разрешена вашими политиками авторизации подключений и для которой включена Многофакторная идентификация Azure.</span><span class="sxs-lookup"><span data-stu-id="3660e-322">Be sure to use an account that is allowed by your Connection Authorization Policies and is enabled for Azure MFA.</span></span> 

<span data-ttu-id="3660e-323">Как показано на рисунке ниже, вы можете использовать страницу **Веб-доступ к удаленным рабочим столам**.</span><span class="sxs-lookup"><span data-stu-id="3660e-323">As show in the image below, you can use the **Remote Desktop Web Access** page.</span></span>

![Веб-доступ к удаленным рабочим столам](./media/nps-extension-remote-desktop-gateway/image25.png)

<span data-ttu-id="3660e-325">После успешного ввода учетных данных для основной аутентификации в диалоговом окне подключения к удаленному рабочему столу отобразится состояние "Инициализация удаленного подключения", как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="3660e-325">Upon successfully entering your credentials for primary authentication, the Remote Desktop Connect dialog box shows a status of Initiating remote connection, as shown below.</span></span> 

<span data-ttu-id="3660e-326">После успешного прохождения дополнительной аутентификации, настроенной ранее в Azure MFA, вы будете подключены к ресурсу.</span><span class="sxs-lookup"><span data-stu-id="3660e-326">If you successfully authenticate with the secondary authentication method you previously configured in Azure MFA, you are connected to the resource.</span></span> <span data-ttu-id="3660e-327">Однако если вы не пройдете дополнительную аутентификацию, доступ к ресурсу будет запрещен.</span><span class="sxs-lookup"><span data-stu-id="3660e-327">However, if the secondary authentication is not successful, you are denied access to resource.</span></span> 

![Инициализация удаленного подключения](./media/nps-extension-remote-desktop-gateway/image26.png)

<span data-ttu-id="3660e-329">В следующем примере приложение Authenticator в Windows Phone используется для дополнительной аутентификации.</span><span class="sxs-lookup"><span data-stu-id="3660e-329">In the example below, the Authenticator app on a Windows phone is used to provide the secondary authentication.</span></span>

![Учетные записи](./media/nps-extension-remote-desktop-gateway/image27.png)

<span data-ttu-id="3660e-331">После успешного прохождения дополнительной аутентификации вы вошли в шлюз удаленных рабочих столов в обычном режиме.</span><span class="sxs-lookup"><span data-stu-id="3660e-331">Once you have successfully authenticated using the secondary authentication method, you are logged into the Remote Desktop Gateway as normal.</span></span> <span data-ttu-id="3660e-332">Тем не менее, так как вы должны были пройти дополнительную аутентификацию с помощью мобильного приложения на доверенном устройстве, процесс входа защищен лучше, чем был бы в противном случае.</span><span class="sxs-lookup"><span data-stu-id="3660e-332">However, because you are required to use a secondary authentication method using a mobile app on a trusted device, the log-in process is more secure than it would be otherwise.</span></span>

### <a name="view-event-viewer-logs-for-successful-logon-events"></a><span data-ttu-id="3660e-333">Просмотр событий успешного входа в журналах службы "Просмотр событий"</span><span class="sxs-lookup"><span data-stu-id="3660e-333">View Event Viewer logs for successful logon events</span></span>
<span data-ttu-id="3660e-334">Чтобы просмотреть события успешного входа в журналах службы "Просмотр событий" Windows, можно выполнить приведенную команду Windows PowerShell, которая запрашивает журналы служб терминалов Windows и журналы безопасности Windows.</span><span class="sxs-lookup"><span data-stu-id="3660e-334">To view the successful sign-in events in the Windows Event Viewer logs, you can issue the following Windows PowerShell command to query the Windows Terminal Services and Windows Security logs.</span></span>

<span data-ttu-id="3660e-335">Чтобы запросить события успешного входа из операционных журналов шлюза _(Event Viewer\Applications and Services Logs\Microsoft\Windows\TerminalServices-Gateway\Operational_, используйте следующие команды.</span><span class="sxs-lookup"><span data-stu-id="3660e-335">To query successful sign-in events in the Gateway operational logs _(Event Viewer\Applications and Services Logs\Microsoft\Windows\TerminalServices-Gateway\Operational_, use the following commands:</span></span>

* <span data-ttu-id="3660e-336">_Get-WinEvent -Logname Microsoft-Windows-TerminalServices-Gateway/Operational_ | where {$_.ID -eq '300'} | FL</span><span class="sxs-lookup"><span data-stu-id="3660e-336">_Get-WinEvent -Logname Microsoft-Windows-TerminalServices-Gateway/Operational_ | where {$_.ID -eq '300'} | FL</span></span> 
* <span data-ttu-id="3660e-337">Эта команда отображает события Windows, в которых пользователь выполнил требования политики авторизации ресурсов удаленных рабочих столов и получил доступ.</span><span class="sxs-lookup"><span data-stu-id="3660e-337">This command displays Windows events that show the user met resource authorization policy requirements (RD RAP) and was granted access.</span></span>

![Просмотр данных службы "Просмотр событий"](./media/nps-extension-remote-desktop-gateway/image28.png)

* <span data-ttu-id="3660e-339">_Get-WinEvent -Logname Microsoft-Windows-TerminalServices-Gateway/Operational_ | where {$_.ID -eq '200'} | FL</span><span class="sxs-lookup"><span data-stu-id="3660e-339">_Get-WinEvent -Logname Microsoft-Windows-TerminalServices-Gateway/Operational_ | where {$_.ID -eq '200'} | FL</span></span>
* <span data-ttu-id="3660e-340">Эта команда отображает события, в которых пользователь выполнил требования политики авторизации подключений.</span><span class="sxs-lookup"><span data-stu-id="3660e-340">This command displays the events that show when user met connection authorization policy requirements.</span></span>

![Авторизация подключений](./media/nps-extension-remote-desktop-gateway/image29.png)

<span data-ttu-id="3660e-342">Можно также просмотреть этот журнал и отфильтровать информацию по идентификаторам событий, 300 и 200.</span><span class="sxs-lookup"><span data-stu-id="3660e-342">You can also view this log and filter on event IDs, 300 and 200.</span></span> <span data-ttu-id="3660e-343">Чтобы запросить события успешного входа из журналов безопасности службы "Просмотр событий", используйте следующую команду.</span><span class="sxs-lookup"><span data-stu-id="3660e-343">To query successful logon events in the Security event viewer logs, use the following command:</span></span>

* <span data-ttu-id="3660e-344">_Get-WinEvent -Logname Security_ | where {$_.ID -eq '6272'} | FL</span><span class="sxs-lookup"><span data-stu-id="3660e-344">_Get-WinEvent -Logname Security_ | where {$_.ID -eq '6272'} | FL</span></span> 
* <span data-ttu-id="3660e-345">Эта команда может выполняться на центральном NPS-сервере или сервере шлюза удаленных рабочих столов.</span><span class="sxs-lookup"><span data-stu-id="3660e-345">This command can be run on either the central NPS or the RD Gateway Server.</span></span> 

![События успешного входа](./media/nps-extension-remote-desktop-gateway/image30.png)

<span data-ttu-id="3660e-347">Можно также просмотреть настраиваемое представление журналов безопасности или служб политики сети и доступа, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="3660e-347">You can also view the Security log or the Network Policy and Access Services custom view, as shown below:</span></span>

![Службы политики сети и доступа](./media/nps-extension-remote-desktop-gateway/image31.png)

<span data-ttu-id="3660e-349">На сервере с расширением NPS для Azure MFA можно найти журналы приложений службы "Просмотр событий", относящиеся к расширению: _Application and Services Logs\Microsoft\AzureMfa_.</span><span class="sxs-lookup"><span data-stu-id="3660e-349">On the server where you installed the NPS extension for Azure MFA, you can find Event Viewer application logs specific to the extension at _Application and Services Logs\Microsoft\AzureMfa_.</span></span> 

![Журналы приложений службы "Просмотр событий"](./media/nps-extension-remote-desktop-gateway/image32.png)

## <a name="troubleshoot-guide"></a><span data-ttu-id="3660e-351">Руководство по устранению неполадок</span><span class="sxs-lookup"><span data-stu-id="3660e-351">Troubleshoot Guide</span></span>

<span data-ttu-id="3660e-352">Если конфигурация не работает должным образом, то в первую очередь нужно убедиться, что пользователь настроен для использования Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="3660e-352">If the configuration is not working as expected, the first place to start to troubleshoot is to verify that the user is configured to use Azure MFA.</span></span> <span data-ttu-id="3660e-353">Подключите пользователя к [порталу Azure](https://portal.azure.com).</span><span class="sxs-lookup"><span data-stu-id="3660e-353">Have the user connect to the [Azure portal](https://portal.azure.com).</span></span> <span data-ttu-id="3660e-354">Если пользователю предлагается дополнительная проверка и он может успешно пройти аутентификацию, то можно исключить ошибку в конфигурации Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="3660e-354">If users are prompted for secondary verification and can successfully authenticate, you can eliminate an incorrect configuration of Azure MFA.</span></span>

<span data-ttu-id="3660e-355">Если пользователи успешно используют Azure MFA, следует изучить соответствующие журналы событий.</span><span class="sxs-lookup"><span data-stu-id="3660e-355">If Azure MFA is working for the user(s), you should review the relevant Event logs.</span></span> <span data-ttu-id="3660e-356">К ним относятся журналы событий безопасности, операционные журналы шлюза и журналы Azure MFA, рассмотренные в предыдущем разделе.</span><span class="sxs-lookup"><span data-stu-id="3660e-356">These include the Security Event, Gateway operational, and Azure MFA logs that are discussed in the previous section.</span></span> 

<span data-ttu-id="3660e-357">Ниже приведен пример выходных данных журнала безопасности, содержащих событие неудачного входа (идентификатор события 6273).</span><span class="sxs-lookup"><span data-stu-id="3660e-357">Below is an example output of Security log showing a failed logon event (Event ID 6273).</span></span>

![Событие неудачного входа](./media/nps-extension-remote-desktop-gateway/image33.png)

<span data-ttu-id="3660e-359">Ниже приведено связанное событие из журналов Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="3660e-359">Below is a related event from the AzureMFA logs:</span></span>

![Журнал Azure MFA](./media/nps-extension-remote-desktop-gateway/image34.png)

<span data-ttu-id="3660e-361">Чтобы расширить возможности устранения неполадок, просмотрите файлы журнала в формате базы данных NPS в расположении, в котором установлена служба NPS.</span><span class="sxs-lookup"><span data-stu-id="3660e-361">To perform advanced troubleshoot options, consult the NPS database format log files where the NPS service is installed.</span></span> <span data-ttu-id="3660e-362">Эти файлы журнала создаются в папке _%SystemRoot%\System32\Logs_ в виде файлов с разделителями-запятыми.</span><span class="sxs-lookup"><span data-stu-id="3660e-362">These log files are created in _%SystemRoot%\System32\Logs_ folder as comma-delimited text files.</span></span> 

<span data-ttu-id="3660e-363">Описание этих файлов журнала см. в разделе [Interpret NPS Database Format Log Files](https://technet.microsoft.com/library/cc771748.aspx) (Интерпретация файлов журнала в формате базы данных NPS).</span><span class="sxs-lookup"><span data-stu-id="3660e-363">For a description of these log files, see [Interpret NPS Database Format Log Files](https://technet.microsoft.com/library/cc771748.aspx).</span></span> <span data-ttu-id="3660e-364">Записи в этих файлах журнала может быть сложно интерпретировать, не импортировав их в электронную таблицу или базу данных.</span><span class="sxs-lookup"><span data-stu-id="3660e-364">The entries in these log files can be difficult to interpret without importing them into a spreadsheet or a database.</span></span> <span data-ttu-id="3660e-365">Помочь в интерпретации файлов журнала могут несколько средств синтаксического анализа IAS в Интернете.</span><span class="sxs-lookup"><span data-stu-id="3660e-365">You can find several IAS parsers online to assist you in interpreting the log files.</span></span> 

<span data-ttu-id="3660e-366">На рисунке ниже показаны выходные данные одной из таких скачиваемых [условно бесплатных программ](http://www.deepsoftware.com/iasviewer).</span><span class="sxs-lookup"><span data-stu-id="3660e-366">The image below shows the output of one such downloadable [shareware application](http://www.deepsoftware.com/iasviewer).</span></span> 

![Условно бесплатная программа](./media/nps-extension-remote-desktop-gateway/image35.png)

<span data-ttu-id="3660e-368">Наконец, чтобы еще больше расширить возможности устранения неполадок, можно использовать анализатор протокола, например [Microsoft Message Analyzer](https://technet.microsoft.com/library/jj649776.aspx).</span><span class="sxs-lookup"><span data-stu-id="3660e-368">Finally, for additional troubleshoot options, you can use a protocol analyzer, such [Microsoft Message Analyzer](https://technet.microsoft.com/library/jj649776.aspx).</span></span> 

<span data-ttu-id="3660e-369">На рисунке ниже в Microsoft Message Analyzer показан сетевой трафик, отфильтрованный по протоколу RADIUS и содержащий имя пользователя **Contoso\AliceC**.</span><span class="sxs-lookup"><span data-stu-id="3660e-369">The image below from Microsoft Message Analyzer shows network traffic filtered on RADIUS protocol that contains the user name **Contoso\AliceC**.</span></span>

![Microsoft Message Analyzer](./media/nps-extension-remote-desktop-gateway/image36.png)

## <a name="next-steps"></a><span data-ttu-id="3660e-371">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="3660e-371">Next steps</span></span>
[<span data-ttu-id="3660e-372">Как получить службу Azure Multi-Factor Authentication</span><span class="sxs-lookup"><span data-stu-id="3660e-372">How to get Azure Multi-Factor Authentication</span></span>](multi-factor-authentication-versions-plans.md)

[<span data-ttu-id="3660e-373">Шлюз удаленных рабочих столов и сервер Azure Multi-Factor Authentication, использующие проверку подлинности RADIUS</span><span class="sxs-lookup"><span data-stu-id="3660e-373">Remote Desktop Gateway and Azure Multi-Factor Authentication Server using RADIUS</span></span>](multi-factor-authentication-get-started-server-rdg.md)

[<span data-ttu-id="3660e-374">Интеграция локальных каталогов с Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="3660e-374">Integrate your on-premises directories with Azure Active Directory</span></span>](../active-directory/connect/active-directory-aadconnect.md)

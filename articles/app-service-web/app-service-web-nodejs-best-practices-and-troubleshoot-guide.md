---
title: "Рекомендации и руководство по устранению неполадок приложений Node в веб-приложениях Azure"
description: "Узнайте рекомендации и способы устранения неполадок приложений Node в веб-приложениях Azure."
services: app-service\web
documentationcenter: nodejs
author: ranjithr
manager: wadeh
editor: 
ms.assetid: 387ea217-7910-4468-8987-9a1022a99bef
ms.service: app-service-web
ms.workload: web
ms.tgt_pltfrm: na
ms.devlang: nodejs
ms.topic: article
ms.date: 06/06/2016
ms.author: ranjithr
ms.openlocfilehash: d820ef3438e13332657641b06b57fa277e79f811
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2017
---
# <a name="best-practices-and-troubleshooting-guide-for-node-applications-on-azure-web-apps"></a>Рекомендации и руководство по устранению неполадок приложений Node в веб-приложениях Azure
[!INCLUDE [tabs](../../includes/app-service-web-get-started-nav-tabs.md)]

В этой статье описываются рекомендации и способы устранения неполадок [приложений Node](app-service-web-get-started-nodejs.md), запущенных в веб-приложениях Azure (с помощью [iisnode](https://github.com/azure/iisnode)).

> [!WARNING]
> Будьте осторожны при выполнении действий по устранению неполадок на рабочем сайте. Действия по устранению неполадок приложения рекомендуется выполнять на нерабочем сайте. Например, настройте там промежуточный слот, а когда проблема будет решена, замените промежуточный слот на рабочий.
> 
> 

## <a name="iisnode-configuration"></a>Конфигурация IISNODE
В этом [файле схемы](https://github.com/Azure/iisnode/blob/master/src/config/iisnode_schema_x64.xml) показаны все параметры, которые можно настроить для iisnode. Ниже приведены параметры, которые будут полезны для вашего приложения.

* nodeProcessCountPerApplication
  
    Этот параметр определяет количество процессов Node, запущенных в одном приложении IIS. Значение по умолчанию — 1. Задав для него значение 0, можно запустить количество файлов node.exe, равное количеству ядер виртуальной машины. Для большинства приложений рекомендуемое значение — 0. Это позволяет использовать все ядра виртуальной машины. Файл node.exe является однопоточным. Это значит, что для запуска одного файла node.exe требуется 1 ядро, а чтобы обеспечить максимальную производительность приложения Node, необходимо использовать все ядра.
* nodeProcessCommandLine
  
    Этот параметр определяет путь к файлу node.exe. Это значение можно задать таким образом, чтобы оно указывало версию файла node.exe.
* maxConcurrentRequestsPerProcess
  
    Этот параметр определяет максимальное количество одновременных запросов, отправленных с помощью iisnode в каждый файл node.exe. В веб-приложениях Azure для этого параметра по умолчанию используется значение Infinite. Об этом параметре не нужно беспокоиться. В веб-приложениях за пределами Azure значение по умолчанию равно 1024. В зависимости от количества отправленных в приложение запросов и скорости их обработки, возможно, понадобится настроить это значение.
* maxNamedPipeConnectionRetry
  
    Этот параметр определяет максимальное количество повторных подключений с помощью iisnode к именованному каналу для отправки запроса в файл node.exe. В сочетании с параметром namedPipeConnectionRetryDelay он определяет общее значение времени ожидания каждого запроса в iisnode. В веб-приложениях Azure для этого параметра по умолчанию задано значение 200. Общее время ожидания в секундах равно произведению maxNamedPipeConnectionRetry \*на namedPipeConnectionRetryDelay, разделенному на 1000.
* namedPipeConnectionRetryDelay
  
    Этот параметр определяет интервал (в мс), с которым iisnode будет отправлять повторные запросы в файл node.exe через именованный канал. Значение по умолчанию — 250 мс.
    Общее время ожидания в секундах равно произведению maxNamedPipeConnectionRetry \*на namedPipeConnectionRetryDelay, разделенному на 1000.
  
    По умолчанию общее время ожидания для iisnode в веб-приложениях Azure составляет 50 секунд (200 \* 250 мс = 50 с).
* logDirectory
  
    Этот параметр определяет каталог, в который iisnode будет записывать сведения журналов stdout и stderr. По умолчанию для этого параметра задано значение iisnode. Оно задается относительно основного каталога скрипта (каталога, в котором находится основной файл server.js).
* debuggerExtensionDll
  
    Этот параметр определяет версию средства node-inspector, которую iisnode будет использовать при выполнении отладки приложения Node. Сейчас для этого параметра доступны только значения iisnode-inspector-0.7.3.dll и iisnode-inspector.dll. По умолчанию для этого параметра задано значение iisnode-inspector-0.7.3.dll. Так как в этой версии используется node-inspector-0.7.3 и протокол websockets, в веб-приложении Azure для протокола websockets понадобится включить поддержку этой версии. Дополнительные сведения о настройке новой версии node-inspector в iisnode см. по ссылке <http://www.ranjithr.com/?p=98>.
* flushResponse
  
    По умолчанию перед освобождением ответа или до его завершения (в зависимости от того, что произойдет раньше) IIS помещает в буфер до 4 МБ данных ответа. В iisnode предоставляется параметр конфигурации, который позволяет переопределить это поведение. Чтобы освободить фрагмент тела объекта ответа после того, как iisnode его получит, для атрибута iisnode/@flushResponse в файле web.config необходимо задать значение true:
  
    ```
    <configuration>    
        <system.webServer>    
            <!-- ... -->    
            <iisnode flushResponse="true" />    
        </system.webServer>    
    </configuration>
    ```
  
    Включение освобождения каждого фрагмента тела объекта ответа приводит к значительному снижению производительности, что, в свою очередь, уменьшает скорость работы системы приблизительно на 5 % (для версии v0.1.13). Поэтому этот параметр рекомендуется применять только к конечным точкам, для которых требуется потоковая передача ответа (например, при использовании элемента <location> в файле web.config).
  
    Кроме того, в приложениях потоковой передачи для параметра responseBufferLimit обработчика iisnode необходимо задать значение 0.
  
    ```
    <handlers>    
        <add name="iisnode" path="app.js" verb="\*" modules="iisnode" responseBufferLimit="0"/>    
    </handlers>
    ```
* watchedFiles
  
    Это список разделенных точкой с запятой файлов, в которых будут отслеживаться изменения. Изменение файла приводит к перезапуску приложения. Каждая запись состоит из необязательного имени каталога и обязательного имени файла, которые задаются относительно каталога, в котором находится основная точка входа приложения. Подстановочные знаки можно использовать только в части имени файла. Значение по умолчанию — \*.js;web.config.
* recycleSignalEnabled
  
    Значение по умолчанию — false. Этот параметр, если он включен, позволяет приложению Node подключаться к определенному каналу (переменная среды — IISNODE\_CONTROL\_PIPE) и отправлять сообщение о перезапуске. Это позволит надлежащим образом перезапустить процесс w3wp.
* idlePageOutTimePeriod
  
    По умолчанию для этого параметра используется значение 0, а это значит, что он отключен. Если задать значение больше нуля, iisnode будет выполнять выгрузку всех дочерних процессов с интервалом, указанным для этого параметра (в мс). Дополнительные сведения о выгрузке см. в этой [документации](https://msdn.microsoft.com/library/windows/desktop/ms682606.aspx). Этот параметр полезен для приложений, которые используют большой объем памяти и которым необходимо время от времени выгружать память на диск, чтобы освободить ОЗУ.

> [!WARNING]
> Соблюдайте осторожность при включении следующих параметров конфигурации в рабочих приложениях. Эти параметры не рекомендуется включать в активных рабочих приложениях.
> 
> 

* debugHeaderEnabled
  
    По умолчанию для этого параметра используется значение false. Если изменить его на true, iisnode будет добавлять HTTP-заголовок ответа iisnode-debug к каждому отправленному им ответу HTTP. Значение заголовка iisnode-debug — это URL-адрес. Из фрагмента URL-адреса можно извлечь только отдельную часть диагностических данных. Более детальные сведения можно получить, открыв URL-адрес в веб-браузере.
* loggingEnabled
  
    Этот параметр управляет ведением журналов stdout и stderr с помощью iisnode. Обработчик iisnode собирает из запущенных в нем процессов Node данные stdout и stderr, а затем записывает их в каталог, определенный в параметре logDirectory. Если этот параметр включен, приложение будет записывать журналы в файловую систему, а производительность приложения будет зависеть от объема собранных приложением данных.
* devErrorsEnabled
  
    Значение по умолчанию — false. Если изменить его на true, iisnode отобразит в браузере код состояния HTTP и код ошибки Win32. Этот код понадобится при отладке определенных типов проблем.
* debuggingEnabled (не включайте этот параметр на активном рабочем сайте)
  
    Этот параметр определяет функцию отладки. В iisnode интегрировано средство node-inspector. Включение этого параметра активирует отладку приложения Node. После включения параметра при первом запросе на отладку к приложению node обработчик iisnode разместит необходимые файлы node-inspector в каталоге debuggerVirtualDir. Средство node-inspector можно загрузить, отправив запрос на страницу http://yoursite/server.js/debug. С помощью параметра debuggerPathSegment можно управлять сегментом URL-адреса отладки. По умолчанию для этого параметра используется значение debug. Если задать для него, к примеру, значение GUID, другим пользователям будет труднее его отследить.
  
    Дополнительные сведения об отладке см. [здесь](https://tomasz.janczuk.org/2011/11/debug-nodejs-applications-on-windows.html).

## <a name="scenarios-and-recommendationstroubleshooting"></a>Сценарии, рекомендации и устранение неполадок
### <a name="my-node-application-is-making-too-many-outbound-calls"></a>В этом сценарии приложение Node отравляет слишком много вызовов.
В рамках своих операций многие приложения попытаются установить с ним исходящие подключения. Например, при получении запроса для его обработки приложению Node потребуется связаться с REST API и получить необходимые для этого сведения. Возможно, при вызовах HTTP или HTTPS понадобится использовать активный агент. Например, при выполнении этих исходящих вызовов в качестве активного агента можно использовать модуль agentkeepalive. Это гарантирует, что на виртуальной машине с веб-приложением сокеты повторно используются, а также позволяет снизить затраты на создание сокетов для каждого исходящего вызова. Кроме того, это гарантирует, что для выполнения исходящих вызовов используется меньшее количество сокетов и, следовательно, максимальное количество сокетов, выделенных на одну виртуальную машину, не превышается. В веб-приложении Azure для параметра agentKeepAlive maxSockets рекомендуется задать значение 160 сокетов на одну виртуальную машину. Это означает, что при наличии 4 файлов node.exe, запущенных на виртуальной машине, на один файл выделяется 40 сокетов, что в суме дает 160 сокетов на одну виртуальную машину.

Пример конфигурации модуля [agentKeepALive](https://www.npmjs.com/package/agentkeepalive):

```
var keepaliveAgent = new Agent({    
    maxSockets: 40,    
    maxFreeSockets: 10,    
    timeout: 60000,    
    keepAliveTimeout: 300000    
});
```

В этом примере предполагается, что на виртуальной машине запущено 4 файла node.exe. Если используется другое количество, параметр maxSockets необходимо изменить соответствующим образом.

### <a name="my-node-application-is-consuming-too-much-cpu"></a>Чрезмерное потребление ресурсов ЦП приложением Node
На вашем портале может отобразиться оповещение от веб-приложений Azure о высоком потреблении ресурсов ЦП. Эти [метрики](web-sites-monitor.md)также можно отслеживать, настроив для этого мониторы. Перед проверкой использования ЦП на [панели мониторинга портала Azure](../application-insights/app-insights-web-monitor-performance.md)сначала проверьте максимальные значения ЦП, чтобы не пропустить пиковые значения.
Если приложение Node потребляет слишком много ресурсов ЦП и не удается выяснить причину этого, необходимо выполнить его профилирование.

### 
#### <a name="profiling-your-node-application-on-azure-webapps-with-v8-profiler"></a>Профилирование приложения Node в веб-приложениях Azure с помощью средства V8-Profiler
Например, предположим, что у вас есть приложение Hello World, для которого необходимо выполнить профилирование, как показано ниже:

```
var http = require('http');    
function WriteConsoleLog() {    
    for(var i=0;i<99999;++i) {    
        console.log('hello world');    
    }    
}

function HandleRequest() {    
    WriteConsoleLog();    
}

http.createServer(function (req, res) {    
    res.writeHead(200, {'Content-Type': 'text/html'});    
    HandleRequest();    
    res.end('Hello world!');    
}).listen(process.env.PORT);
```

Перейдите на сайт SCM по адресу https://yoursite.scm.azurewebsites.net/DebugConsole.

Откроется следующая командная строка. Перейдите в каталог site/wwwroot.

![](./media/app-service-web-nodejs-best-practices-and-troubleshoot-guide/scm_install_v8.png)

Выполните команду npm install v8-profiler.

В каталоге node\_modules установится средство v8-profiler и все его зависимости.
Далее, чтобы выполнить профилирование приложения, измените файл server.js.

```
var http = require('http');    
var profiler = require('v8-profiler');    
var fs = require('fs');

function WriteConsoleLog() {    
    for(var i=0;i<99999;++i) {    
        console.log('hello world');    
    }    
}

function HandleRequest() {    
    profiler.startProfiling('HandleRequest');    
    WriteConsoleLog();    
    fs.writeFileSync('profile.cpuprofile', JSON.stringify(profiler.stopProfiling('HandleRequest')));    
}

http.createServer(function (req, res) {    
    res.writeHead(200, {'Content-Type': 'text/html'});    
    HandleRequest();    
    res.end('Hello world!');    
}).listen(process.env.PORT);
```

Указанные выше действия позволяют выполнить профилирование функции WriteConsoleLog, а затем записать выходные данные в файл profile.cpuprofile, расположенный в каталоге site wwwroot. Отправьте запрос в приложение. В каталоге site wwwroot будет создан файл profile.cpuprofile.

![](./media/app-service-web-nodejs-best-practices-and-troubleshoot-guide/scm_profile.cpuprofile.png)

Загрузите этот файл и откройте его, нажав в браузере Chrome клавишу F12. Затем перейдите на вкладку "Профили". Нажмите кнопку "Загрузить". Выберите только что загруженный файл profile.cpuprofile. Щелкните только что загруженный профиль.

![](./media/app-service-web-nodejs-best-practices-and-troubleshoot-guide/chrome_tools_view.png)

Вы увидите, что на работу функции WriteConsoleLog ушло 95 % времени, как показано ниже. Вы также увидите точные номера строк и исходные файлы, которые вызывают проблемы.

### <a name="my-node-application-is-consuming-too-much-memory"></a>Чрезмерное потребление памяти приложением Node
На вашем портале может отобразиться оповещение от веб-приложений Azure о высоком потреблении памяти. Эти [метрики](web-sites-monitor.md)также можно отслеживать, настроив для этого мониторы. Перед проверкой потребления памяти на [панели мониторинга портала Azure](../application-insights/app-insights-web-monitor-performance.md)сначала проверьте максимальный объем памяти, чтобы не пропустить пиковые значения.

#### <a name="leak-detection-and-heap-diffing-for-nodejs"></a>Обнаружение утечки и определение различий кучи для node.js
Чтобы обнаружить утечки памяти, можно использовать [node-memwatch](https://github.com/lloyd/node-memwatch) .
Установите memwatch (аналогично средству V8-Profiler) и измените код, чтобы извлечь кучи и выявить в них различия, что позволяет определить утечки памяти в приложении.

### <a name="my-nodeexes-are-getting-killed-randomly"></a>Случайное завершение работы файла node.exe
Это может произойти по нескольким причинам.

1. В приложении создаются неперехваченные исключения. Дополнительные сведения о создании исключений можно просмотреть в файле d:\\home\\LogFiles\\Application\\logging-errors.txt. В этом файле доступна трассировка стека, что позволяет исправить эту проблему в приложении.
2. Приложение потребляет слишком много памяти, что изначально влияет на другие процессы. Если общий объем памяти виртуальной машины составляет около 100 %, диспетчер процессов может завершить работу файла node.exe, чтобы остальные процессы могли выполнить определенные задания. Чтобы устранить эту проблему, убедитесь, что в приложении нет утечки памяти, или, если для него действительно требуется большой объем памяти, выполните масштабирование до большего размера виртуальной машины, увеличив объем ОЗУ.

### <a name="my-node-application-does-not-start"></a>Ошибка запуска приложения Node
Если при запуске приложения возвращаются ошибки с кодом 500, причин может быть несколько.

1. Файл node.exe находится в неправильном расположении. Проверьте параметр nodeProcessCommandLine.
2. Основной файл сценария находится в неправильном расположении. Проверьте файл web.config и убедитесь, что в разделе обработчиков задано соответствующее имя основного файла сценария.
3. Используется неправильная конфигурация файла web.config. Проверьте имена и значения параметров.
4. Холодный запуск. Приложение запускается слишком долго. Если для запуска приложения требуется больше времени, чем задано для общего времени ожидания в секундах ((maxNamedPipeConnectionRetry \* namedPipeConnectionRetryDelay), разделенное на 1000), iisnode вернет ошибку с кодом 500. Чтобы предотвратить превышение времени ожидания iisnode и возвращение ошибки с кодом 500, увеличьте значения этих параметров для соответствия времени запуска приложения.

### <a name="my-node-application-crashed"></a>Сбой приложения Node
В приложении создаются неперехваченные исключения. Дополнительные сведения о создании исключений можно просмотреть в файле d:\\home\\LogFiles\\Application\\logging-errors.txt. В этом файле доступна трассировка стека, что позволяет исправить эту проблему в приложении.

### <a name="my-node-application-takes-too-much-time-to-startup-cold-start"></a>Запуск приложения Node занимает слишком много времени (холодный запуск)
Вероятнее всего, это происходит потому, что в каталоге node\_modules содержится много файлов и приложение пытается загрузить большинство этих файлов при запуске. Так как по умолчанию эти файлы содержатся в сетевой папке в веб-приложениях Azure, загрузка такого количества файлов занимает больше времени.
Чтобы ускорить этот процесс, сделайте следующее:

1. Убедитесь, что используется плоская структура зависимости и нет дубликатов зависимостей, установив модули с помощью npm3.
2. Попробуйте выполнить отложенную загрузку node\_modules и не загружайте при запуске все модули. Это означает, что требуемый вызов ("модуль") должен выполниться при использовании в функции модуля.
3. В веб-приложениях Azure используется функция, которая называется "локальный кэш". С помощью этой функции можно скопировать содержимое сетевой папки на локальный диск виртуальной машины. Так как файлы расположены локально, загрузка node\_modules происходит значительно быстрее. Дополнительные сведения о функции локального кэша см. в этой [документации](../app-service/app-service-local-cache.md).

## <a name="iisnode-http-status-and-substatus"></a>Состояние и подсостояние HTTP обработчика iisnode
В этом [исходном файле](https://github.com/Azure/iisnode/blob/master/src/iisnode/cnodeconstants.h) перечислены все возможные сочетания состояний и подсостояний, которые может возвратить iisnode в случае возникновения ошибок.

Чтобы отобразить код ошибки Win32, включите для своего приложения FREB (для обеспечения производительности FREB рекомендуется включать только на нерабочих сайтах).

| Состояние HTTP | Подсостояние HTTP | Возможная причина |
| --- | --- | --- |
| 500 |1000 |При отправке запроса к iisnode возникла ошибка. Проверьте, запущен ли файл node.exe. Возможно, при запуске этого файла произошел сбой. Проверьте конфигурацию web.config на наличие ошибок. |
| 500 |1001 |Win32Error 0x2. Приложение не отвечает URL-адресу. Проверьте правила подстановки URL-адреса или определение маршрутов приложения Express. Win32Error 0x6d — именованный канал занят. Файл node.exe не принимает запросы, так как канал занят. Проверьте потребление ресурсов ЦП. Другие ошибки. Проверьте файл node.exe на наличие повреждений. |
| 500 |1002 |Файл node.exe поврежден. Для трассировки стека проверьте файл d:\\home\\LogFiles\\logging-errors.txt. |
| 500 |1003 |Ошибка конфигурации канала. Это оповещение не должно отображаться, в противном случае конфигурация именованного канала неправильна. |
| 500 |1004–1018 |При отправке запроса к файлу node.exe или обработке ответа от него произошла ошибка. Проверьте файл node.exe на наличие повреждений. Для трассировки стека проверьте файл d:\\home\\LogFiles\\logging-errors.txt. |
| 503 |1000 |Недостаточно памяти для выделения большего количества подключений по именованным каналам. Проверьте, почему приложение потребляет такое большое количество памяти. Проверьте значение параметра maxConcurrentRequestsPerProcess. Если для него не задано значение Infinite и выполняется большое количество запросов, увеличьте это значение, чтобы предотвратить возникновение этой ошибки. |
| 503 |1001 |Не удалось отправить запрос к файлу node.exe, так как приложение перезапускается. После перезапуска запросы будут обработаны должным образом. |
| 503 |1002 |Проверьте фактическую причину в коде ошибки Win32. Не удается отправить запрос к файлу node.exe. |
| 503 |1003 |Именованный канал слишком занят. Проверьте, не потребляет ли узел слишком много ресурсов ЦП. |

В файле node.exe содержится параметр, который называется NODE\_PENDING\_PIPE\_INSTANCES. По умолчанию за пределами веб-приложения Azure для этого параметра задано значение 4. Это означает, что файл node.exe в именованном канале может принять только 4 запроса за раз. В веб-приложениях Azure для этого параметра задано значение 5000, и его достаточно для большинства приложений Node, запущенных в веб-приложениях Azure. В веб-приложениях Azure для параметра NODE\_PENDING\_PIPE\_INSTANCES не используется значение 503.1003, так как для него задается наибольшее значение.  |

## <a name="more-resources"></a>Дополнительные ресурсы
Дополнительные сведения о приложениях Node.js в службе приложений Azure см. по следующим ссылкам.

* [Приступая к работе с веб-приложениями Node.js в службе приложений Azure](app-service-web-get-started-nodejs.md)
* [Отладка веб-приложения Node.js в службе приложений Azure](web-sites-nodejs-debug.md)
* [Использование модулей Node.js с приложениями Azure](../nodejs-use-node-modules-azure-apps.md)
* [Azure App Service Web Apps: Node.js (Веб-приложения службы приложений Azure: Node.js)](https://blogs.msdn.microsoft.com/silverlining/2012/06/14/windows-azure-websites-node-js/)
* [Центр разработчиков Node.js.](../nodejs-use-node-modules-azure-apps.md)
* [Exploring the Super Secret Kudu Debug Console (Обзор сверхсекретной консоли для отладки Kudu)](https://azure.microsoft.com/documentation/videos/super-secret-kudu-debug-console-for-azure-web-sites/)


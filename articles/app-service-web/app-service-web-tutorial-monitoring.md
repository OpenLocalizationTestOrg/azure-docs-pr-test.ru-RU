---
title: "Мониторинг веб-приложения | Документы Майкрософт"
description: "Узнайте, как настроить мониторинг веб-приложения"
services: App-Service
keywords: 
author: btardif
ms.author: byvinyal
ms.date: 04/04/2017
ms.topic: article
ms.service: app-service-web
ms.openlocfilehash: 29df824062d00e01b786533033097948c008588f
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="monitor-app-service"></a>Мониторинг службы приложений
Это руководство описывает мониторинг приложения и использование встроенных средств платформы для решения возникающих проблем.

Каждый раздел этого документа посвящен определенной функции. Совместное использование этих функций позволяет:
- выявить проблему в приложении;
- определить, вызвана ли проблема кодом или платформой;
- сузить число причин проблемы в коде;
- отладить и устранить проблему.

## <a name="before-you-begin"></a>Перед началом работы
- Для выполнения описанных действий вам понадобится веб-приложение, которое и будет отслеживаться.
    - Чтобы создать приложение, можно выполнить действия, описанные в руководстве [Создание приложения ASP.NET в Azure с подключением к базе данных SQL](app-service-web-tutorial-dotnet-sqldatabase.md).

- Если вы хотите попробовать **удаленную отладку** приложения, потребуется Visual Studio.
    - Если вы еще не установили Visual Studio 2017, вы можете скачать и использовать бесплатную среду [Visual Studio 2017 Community Edition](https://www.visualstudio.com/downloads/).
    - При установке Visual Studio необходимо включить возможность **разработки для Azure**.

## <a name="metrics"></a>Шаг 1. Просмотр метрик
Важно разбираться в значении **метрик**:
- Работоспособность приложения
- Производительность приложения
- Потребление ресурсов

При исследовании проблемы в приложении начать лучше всего с обзора метрик. На портале Azure можно быстро визуально оценить метрики приложения с помощью **Azure Monitor**.

Метрики обеспечивают историческое представление по нескольким ключевым агрегатам для вашего приложения. Для любого приложения, размещенного в службе приложений, нужно отслеживать как веб-приложение, так и план службы приложений.

> [!NOTE]
> План службы приложений представляет собой коллекцию физических ресурсов, используемых для размещения приложений. Все приложения, назначенные плану службы приложений, совместно используют ресурсы, определенные в нем. Поэтому, разместив несколько приложений, вы сможете сэкономить.
>
> Планы службы приложений определяют такие компоненты:
> * Регион: Северная Европа, восточная часть США, Юго-Восточная Азия и т. д.
> * Размер экземпляра: небольшой, средний, крупный и т. д.
> * Число масштабируемых элементов: один, два, три экземпляра и т. д.
> * SKU: "Бесплатный", "Общий", "Базовый", "Стандартный", "Премиум" и т. д.

Для просмотра метрик веб-приложения перейдите в колонку **Обзор** приложения, которое требуется отслеживать. Здесь можно просмотреть диаграмму для метрик приложения в **элементе "Мониторинг"**. Щелкните элемент, чтобы изменить и настроить отображаемые метрики и интервал времени.

По умолчанию колонка ресурсов содержит представление для запросов приложений и ошибки за последний час.
![Мониторинг приложения](media/app-service-web-tutorial-monitoring/app-service-monitor.png)

Как видно из примера, у нас есть приложения, создающее множество **ошибок HTTP-сервера**. Большое число ошибок является первым признаком того, что нужно изучить это приложение.

> [!TIP]
> Дополнительные сведения об Azure Monitor доступны в следующих разделах:
> - [Приступая к работе с Azure Monitor](..\monitoring-and-diagnostics\monitoring-overview.md)
> - [Метрики Azure](..\monitoring-and-diagnostics\monitoring-overview-metrics.md)
> - [Метрики, поддерживаемые Azure Monitor](..\monitoring-and-diagnostics\monitoring-supported-metrics.md)
> - [Панели мониторинга Azure](..\azure-portal\azure-portal-dashboards.md)

## <a name="alerts"></a> Шаг 2. Настройка оповещений
**Оповещения** можно настроить для активации по определенным условиям для вашего приложения.

В разделе [Шаг 1. Просмотр метрик](#metrics) мы видели, что приложение имеет большое количество ошибок.

Давайте настроим оповещение, чтобы автоматически получать уведомления при возникновении ошибок. В этом случае нам нужно, чтобы оповещение отправляло сообщение электронной почты каждый раз, когда число ошибок HTTP 50X превышает определенный порог.

Чтобы создать оповещение, перейдите в **Мониторинг** > **Оповещения** и щелкните **[+] Добавить оповещение**.

![Оповещения](media/app-service-web-tutorial-monitoring/app-service-monitor-alerts.png)

Укажите значения для конфигурации оповещений:
- **Ресурс:** сайт для мониторинга с помощью оповещения.
- **Имя:** имя оповещения, в данном случае это *High HTTP 50X* (Большое число HTTP 50X).
- **Описание:** пояснение, что отслеживает это оповещение, в виде обычного текста.
- **Оповещения включены:** оповещения могут отслеживать метрики или события. В этом примере нас интересуют метрики.
- **Метрика:** отслеживаемая метрика, в данном случае это *Ошибки сервера Http*.
- **Условие:** когда активируется оповещение, в данном случае выберите параметр *больше*.
- **Пороговое значение:** искомое значение, в данном случае это *400*.
- **Период:** оповещения учитывают среднее значение метрики. При уменьшении периодов чувствительность оповещений возрастает. В данном случае мы используем значение *5 минут*.
- **Email Owners and contributors** (Участники и владельцы электронной почты): в данном случае установлено значение *Включено*.

Теперь, когда оповещение создано, сообщение электронной почты отправляется каждый раз, когда приложение превышает заданное пороговое значение. Активные оповещения также можно просмотреть на портале Azure.

![Активированные оповещения](media/app-service-web-tutorial-monitoring/app-service-monitor-alerts-triggered.png)


> [!TIP]
> Дополнительные сведения об оповещениях Azure доступны в следующих разделах:
> - [Что такое оповещения в Microsoft Azure](..\monitoring-and-diagnostics\monitoring-overview-alerts.md)
> - [Действия с метриками](..\monitoring-and-diagnostics\monitoring-overview.md)
> - [Создание оповещений о метриках](..\monitoring-and-diagnostics\insights-alerts-portal.md)

## <a name="companion"></a> Шаг 3. Дополнительное приложение для службы приложений
С помощью **вспомогательного приложения для службы приложений** можно удобно отслеживать приложение с привычным интерфейсом на мобильном устройстве (iOS или Android).

Вспомогательное приложение для службы приложений Azure позволяет выполнять следующие действия:
- Просматривать метрики приложения.
- Просматривать уведомления для приложения и выполнять необходимые действия, а также получать рекомендации.
- Выполнять базовые действия при устранении неполадок (просмотр, запуск, остановка, перезапуск приложения).
- Получать push-уведомления о важных событиях.

![Вспомогательное приложение для службы приложений](media/app-service-web-tutorial-monitoring/app-service-companion.png)

[![Вспомогательное приложение для службы приложений в магазине приложений](media/app-service-web-tutorial-monitoring/app-service-companion-appStore.png)](https://itunes.apple.com/app/azure-app-service-companion/id1146659260)
[![Вспомогательное приложение для службы приложений в Google Play](media/app-service-web-tutorial-monitoring/app-service-companion-googlePlay.png)](https://play.google.com/store/apps/details?id=azureApps.AzureApps)

Вспомогательное приложение для службы приложений можно установить из [магазина приложений](https://itunes.apple.com/app/azure-app-service-companion/id1146659260) или [Google Play](https://play.google.com/store/apps/details?id=azureApps.AzureApps)

## <a name="diagnose"></a> Шаг 4. Диагностика и решение проблем
Пункт **Диагностика и решение проблем** помогает отделить проблемы приложений от проблем платформы. Он также может предложить возможные способы для восстановления работоспособности веб-приложения.

![Диагностика и решение проблем](media/app-service-web-tutorial-monitoring/app-service-monitor-diagnosis.png)

Продолжив работу с примером из предыдущих шагов, мы видим, что в приложении возникли проблемы с доступностью. Доступность платформы, напротив, неизменно оставалась на уровне 100 %.

Если приложение испытывает проблемы, а платформа остается работоспособной, это указывает на то, что проблема связана именно с приложением.

## <a name="logging"></a> Шаг 5. Ведение журналов
Теперь, когда мы связали сбои с проблемами в приложении, нужно просмотреть журналы приложения и сервера для получения дополнительных сведений.

Ведение журналов позволяет собирать сведения из журналов **диагностики приложений** и **диагностики веб-сервера** для веб-приложения.

### <a name="application-diagnostics"></a>Диагностика приложений
Диагностика приложений позволяет записывать сведения трассировки, создаваемые приложением во время выполнения.

Добавление трассировки в приложение значительно улучшает возможности отладки и выявления проблем.

В ASP.NET можно воспользоваться [классом System.Diagnostics.Trace](https://msdn.microsoft.com/library/system.diagnostics.trace.aspx) для создания событий трассировки приложений, которые будут зафиксированы инфраструктурой ведения журналов и записаны в журнал. Для упрощения фильтрации записей также можно указать уровень важности трассировки.

```csharp
public ActionResult Delete(Guid? id)
{
    System.Diagnostics.Trace.TraceInformation("GET /Todos/Delete/" + id);
    if (id == null)
    {
        System.Diagnostics.Trace.TraceError("/Todos/Delete/ failed, ID is null");
        return new HttpStatusCodeResult(HttpStatusCode.BadRequest);
    }
    Todo todo = db.Todoes.Find(id);
    if (todo == null)
    {
        System.Diagnostics.Trace.TraceWarning("/Todos/Delete/ failed, ID: " + id + " could not be found");
        return HttpNotFound();
    }
    System.Diagnostics.Trace.TraceInformation("GET /Todos/Delete/" + id + "completed successfully");
    return View(todo);
}
```
Чтобы включить ведение журнала приложений, перейдите в раздел **Мониторинг** > **Журналы диагностики** и включите ведение журналов приложений с помощью переключателей.

![Мониторинг приложения](media/app-service-web-tutorial-monitoring/app-service-monitor-applogs.png)

Журналы приложений можно хранить в файловой системе веб-приложения или отправлять в хранилище BLOB-объектов. В рабочей среде рекомендуется использовать хранилище BLOB-объектов.

> [!IMPORTANT]
> Ведение журналов оказывает влияние на производительность приложения и использование ресурсов. В рабочей среде рекомендуется вести журналы ошибок. Более подробное ведение журнала следует использовать только при устранении ошибок.

 ### <a name="web-server-diagnostics"></a>Диагностика веб-сервера
Журналы веб-сервера создаются, даже если приложение не инструментировано. Служба приложений может собирать сведения для трех различных типов журналов сервера:

- **Ведение журнала веб-сервера**
    - Сведения об HTTP-транзакциях в [расширенном формате файла журнала W3C](https://msdn.microsoft.com/library/windows/desktop/aa814385.aspx).
    - Это удобно при определении общих показателей сайта, например количества обработанных запросов или количества запросов, поступивших с определенного IP-адреса.
- **Ведение журнала подробных ошибок**
    - Подробные сведения об ошибке для кодов состояния HTTP, которые указывают на сбой (код состояния 400 и выше).
    - [Дополнительные сведения о подробных журналах ошибок](https://www.iis.net/learn/troubleshoot/diagnosing-http-errors/how-to-use-http-detailed-errors-in-iis)
- **Трассировка невыполненных запросов**
    - Подробные сведения о невыполненных запросах, включая трассировку компонентов IIS, использованных для обработки запроса, и время, потраченное для каждого компонента.
    - Журналы невыполненных запросов особенно удобны при выявлении причины конкретной ошибки HTTP.
    - [Дополнительные сведения о трассировке невыполненных запросов](https://www.iis.net/learn/troubleshoot/using-failed-request-tracing/troubleshooting-failed-requests-using-tracing-in-iis)

Чтобы включить ведение журнала сервера, выполните следующие действия:
- Выберите **Мониторинг** > **Журналы диагностики**.
- Включите различные типы диагностики веб-сервера с помощью переключателей.

![Мониторинг приложения](media/app-service-web-tutorial-monitoring/app-service-monitor-serverlogs.png)

> [!IMPORTANT]
> Ведение журналов оказывает влияние на производительность приложения и использование ресурсов. В рабочей среде рекомендуется вести журналы ошибок. Более подробное ведение журнала следует использовать только при устранении ошибок.

### <a name="accessing-logs"></a>Доступ к журналам
Для доступа к журналам в хранилище BLOB-объектов используется обозреватель хранилищ Azure. Для доступа к журналам в файловой системе веб-приложения используется протокол FTP. Журналы доступны по следующим путям:

- **Журналы приложений** - `%HOME%/LogFiles/Application/`.
    - Эта папка содержит один или несколько текстовых файлов со сведениями, созданными при ведении журнала приложения.
- **Трассировка невыполненных запросов** - `%HOME%/LogFiles/W3SVC#########/`.
    - Эта папка содержит XSL-файл и один или несколько XML-файлов.
- **Подробные журналы ошибок** - `%HOME%/LogFiles/DetailedErrors/`.
    - Эта папка содержит один или несколько HTML-файлов с подробными сведениями об ошибках HTTP, которые возникли в вашем приложении.
- **Журналы веб-сервера** - `%HOME%/LogFiles/http/RawLogs`.
    - Эта папка содержит один или несколько текстовых файлов, отформатированных с применением расширенного формата журнала W3C.

## <a name="streaming"></a> Шаг 6. Потоковая передача журналов
Потоковая передача журналов удобна при отладке приложения, так как позволяет сэкономить время по сравнению с [обращением к журналам](#Accessing-Logs) через FTP.

Служба приложения может передавать **журналы приложений** и **журналы веб-сервера** при их создании.

> [!TIP]
> Перед включением потоковой передачи журналов убедитесь, что вы включили сбор журналов, как описано в разделе [Ведение журнала](#logging).

Для потоковой передачи журналов выберите **Мониторинг**> **Потоковая передача журналов**. Выберите **Журналы приложений** или **Журналы веб-сервера** в зависимости от того, какие сведения вам необходимы. Здесь можно также приостановить, перезапустить и очистить буфер.

![Журналы потоковой передачи](media/app-service-web-tutorial-monitoring/app-service-monitor-logstream.png)

> [!TIP]
> Журналы создаются только при наличии трафика у приложения. Также можно повысить уровень детализации журналов, чтобы получить дополнительные события или сведения.

## <a name="remote"></a> Шаг 7. Удаленная отладка
Установив источник проблем в приложении, используйте **удаленную отладку** для прохода по коду.

Удаленная отладка позволяет подключить отладчик к веб-приложению, запущенному в облаке. Вы можете устанавливать точки останова, обращаться к памяти напрямую, пошагово выполнять код и даже изменять путь к коду, как и для приложения, запускаемого локально.

Чтобы подключить отладчик к приложению, запущенному в облаке, выполните следующие действия:

- Откройте решение для приложения, для которого нужно выполнить отладку, в Visual Studio 2017.
- Установите несколько точек останова так же, как и для локального приложения.
- Откройте **Cloud Explorer** (CTRL+/, CTRL+X).
- При необходимости войдите в систему с учетными данными Azure.
- Найдите приложение, для которого нужно выполнить отладку.
- Выберите **Подключить отладчик** в области **Действия**.

![Удаленная отладка](media/app-service-web-tutorial-monitoring/app-service-monitor-vsdebug.png)

Visual Studio настраивает приложение для удаленной отладки и затем открывает ваше приложение в окне браузера. Выполните необходимые действия в приложении для срабатывания точек останова и пройдитесь по коду.

> [!WARNING]
> В рабочей среде выполнение в режиме отладки не рекомендуется. Если ваше рабочее приложение не развернуто на несколько экземпляров сервера, то веб-сервер во время отладки не сможет отвечать на запросы от других приложений. Для устранения неполадок в рабочей среде лучше всего [настроить ведение журналов](#logging) и использовать [Application Insights](#insights).



## <a name="explorer"></a> Шаг 8. Обозреватель процессов
Когда приложение масштабируется до нескольких экземпляров, **обозреватель процессов** позволяет выявить проблемы конкретного экземпляра.

С помощью **обозревателя процессов** можно выполнять следующие действия:

- Получить список всех процессов для различных экземпляров плана службы приложений.
- Просматривать подробные сведения о каждом процессе, в том числе дескрипторы и модули.
- Просматривать сведения об использовании ЦП, рабочих наборах и количестве потоков на уровне процесса, чтобы определить процессы, выходящие за допустимые пределы.
- Находить открытые дескрипторы файлов и даже завершать конкретные экземпляры процессов.

Чтобы открыть обозреватель процессов, выберите **Мониторинг** > **Обозреватель процессов**.

![Обозреватель процессов](media/app-service-web-tutorial-monitoring/app-service-monitor-processexplorer.png)


## <a name="insights"></a> Шаг 9. Application Insights
**Application Insights** предоставляет функции профилирования и расширенные функции мониторинга для вашего приложения.

Application Insights позволяет выявлять и диагностировать исключения и проблемы производительности в веб-приложении.

Вы можете включить Application Insights для своего веб-приложения в разделе **Мониторинг** > **Application Insights**.

> [!NOTE]
> Application Insights может предложить вам установить расширение сайта Application Insights, чтобы начать сбор данных. Установка расширения сайта приводит к перезапуску приложения.

![Application Insights](media/app-service-web-tutorial-monitoring/app-service-monitor-appinsights.png)

Application Insights обладает богатым набором функций. Дополнительные сведения см. в статьях, указанных в разделе [Дальнейшие действия](#next).

## <a name="next"></a> Дальнейшие действия

 - [Что такое Application Insights](..\application-insights\app-insights-overview.md)
 - [Мониторинг производительности веб-приложения Azure с помощью Application Insights](..\application-insights\app-insights-azure-web-apps.md)
 - [Мониторинг доступности и скорости реагирования веб-сайта с помощью Application Insights](..\application-insights\app-insights-monitor-web-app-availability.md)

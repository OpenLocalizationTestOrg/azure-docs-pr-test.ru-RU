---
title: "Устранение лицензионных проблем группы в Azure Active Directory | Документация Майкрософт"
description: "Узнайте, как с помощью группового лицензирования Azure Active Directory определить и устранить проблемы при назначении лицензий"
services: active-directory
keywords: "Лицензирование Azure AD"
documentationcenter: 
author: curtand
manager: mtillman
editor: 
ms.assetid: 
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 06/05/2017
ms.author: curtand
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 5bd28eeb8d67dc0dcb3303fdb0e3c20b32f7c431
ms.sourcegitcommit: e266df9f97d04acfc4a843770fadfd8edf4fa2b7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/11/2017
---
# <a name="identify-and-resolve-license-assignment-problems-for-a-group-in-azure-active-directory"></a>Определение и устранение проблем назначения лицензий для группы в Azure Active Directory

При работе с групповым лицензированием в Azure Active Directory (Azure AD) пользователи могут столкнуться с состоянием ошибки лицензирования. В этой статье рассматриваются причины, вызывающие данное состояние.

Если вы назначаете лицензии непосредственно отдельным пользователям без использования группового лицензирования, операция назначения может завершиться сбоем. Например, выполнение командлета PowerShell `Set-MsolUserLicense` в системе пользователя может завершиться сбоем по ряду причин, связанных с бизнес-логикой. Некоторые из этих причин — недостаточное количество лицензий или конфликт между двумя планами обслуживания, которые не могут быть назначены в одно время. Вы сразу же получите уведомление о проблеме.

Если же вы используете групповое лицензирование, ошибки, описанные выше, также возможны, однако они будут вызваны в фоновом режиме, что не повлияет на назначение лицензий службой Azure AD. По этой причине вы будете уведомлены о проблемах позже. Ошибки записываются в пользовательский объект, а затем отправляются через административный портал. Исходное намерение лицензирования пользователя остается, но записывается в состояние ошибки для последующего исследования и разрешения.

## <a name="how-to-find-license-assignment-errors"></a>Поиск ошибок, связанных с назначением лицензий
**Поиск ошибок, связанных с назначением лицензий**

   1. Чтобы найти пользователей с состоянием ошибки в определенной группе, откройте панель этой группы. Если есть пользователи с состоянием ошибки, в разделе **Лицензии** появится уведомление.

   ![Группа, уведомление об ошибке](media/active-directory-licensing-group-problem-resolution-azure-portal/group-error-notification.png)

   2. Чтобы открыть список всех пользователей с состоянием, описанным выше, щелкните уведомление. Для просмотра дополнительных сведений можно выбрать отдельного пользователя.

   ![Группы, список пользователей с состоянием ошибки](media/active-directory-licensing-group-problem-resolution-azure-portal/list-of-users-with-errors.png)

   3. Чтобы найти все группы, в которых есть по крайней мере одна ошибка, в колонке **Azure Active Directory** выберите **Лицензии**, а затем — **Обзор**. Если есть группы, требующие внимания, отображается поле сведений.

   ![Обзор, сведения о группах с состоянием ошибки](media/active-directory-licensing-group-problem-resolution-azure-portal/group-errors-widget.png)

   4. Щелкните это поле, чтобы просмотреть список всех групп с ошибками. Для получения подробных сведений можно выбрать каждую группу отдельно.

   ![Обзор, список групп с ошибками](media/active-directory-licensing-group-problem-resolution-azure-portal/list-of-groups-with-errors.png)


В следующих разделах описываются все возможные проблемы и способы их устранения.

## <a name="not-enough-licenses"></a>Недостаточно лицензий

**Проблема.** Недостаточно доступных лицензий для одного из продуктов, указанных в группе. Необходимо приобрести дополнительные лицензии для продукта или освободить неиспользуемые лицензии других пользователей или групп.

Чтобы определить число доступных лицензий, выберите **Azure Active Directory** > **Лицензии** > **Все продукты**.

Чтобы увидеть, какие пользователи и группы используют лицензии, выберите продукт. В разделе **Лицензированные пользователи** вы увидите список всех пользователей, которым лицензии назначены напрямую или же с помощью одной или нескольких групп. В разделе **Лицензированные группы** вы увидите все группы, которым назначены продукты.

**PowerShell:** командлеты PowerShell сообщают об этой ошибке, как об ошибке _CountViolation_.

## <a name="conflicting-service-plans"></a>Конфликтующие планы обслуживания

**Проблема.** Один из продуктов, определенный в группе, содержит план обслуживания, конфликтующий с другим планом, назначенным пользователю в другом продукте. Некоторые планы обслуживания настроены так, что их нельзя назначить одному и тому же пользователю в качестве второго плана обслуживания.

Рассмотрим следующий пример. Пользователю напрямую назначена лицензия Office 365 корпоративный *E1*, в которой активированы все планы. Пользователь добавлен в группу, которой назначен продукт Office 365 корпоративный *E3*. Продукт E3 содержит планы обслуживания, которые не должны пересекаться с планами, включенными в лицензию E1, поэтому групповое назначение лицензии завершится ошибкой "Конфликтующие планы обслуживания". В этом примере следующие планы обслуживания являются конфликтующими:

-   SharePoint Online (план 2) конфликтует с SharePoint Online (план 1);
-   Exchange Online (план 2) конфликтует с Exchange Online (план 1).

Чтобы решить возникший конфликт, надо отключить каждый из этих планов. Можно отключить лицензию E1, которая напрямую назначена пользователю. Можно также изменить назначение лицензии для всей группы и отключить планы в лицензии E3. Кроме того, вы можете отменить назначение пользователю лицензии E1, если она является избыточной в контексте лицензии E3.

Способ разрешения конфликта между лицензиями продуктов всегда выбирает администратор. Azure AD не разрешает конфликты лицензий автоматически.

**PowerShell:** командлеты PowerShell сообщают об этой ошибке, как об ошибке _MutuallyExclusiveViolation_.

## <a name="other-products-depend-on-this-license"></a>Другие продукты зависят от этой лицензии

**Проблема.** Один из продуктов, указанных в группе, содержит план обслуживания, который нужно включить для другого плана обслуживания в другом продукте, чтобы он заработал. Эта ошибка возникает при попытке Azure AD удалить первоначальный план обслуживания. Например, это может случиться в результате удаления пользователя из группы.

Чтобы решить эту проблему, вам необходимо убедиться в том, что требуемый план все еще назначен пользователям с помощью какого-либо другого метода или что зависимые службы для этих пользователей отключены. После этого вы можете надлежащим образом удалить групповую лицензию для этих пользователей.

**PowerShell:** командлеты PowerShell сообщают об этой ошибке, как об ошибке _DependencyViolation_.

## <a name="usage-location-isnt-allowed"></a>Место использования запрещено

**Проблема.** Некоторые службы Майкрософт доступны не во всех расположениях из-за требований местного законодательства. Перед тем как назначать лицензию пользователю, задайте для пользователя свойство **Место использования**. Это можно сделать в разделе **Пользователь** > **Профиль** > **Параметры** на портале Azure.

При попытке Azure AD назначить групповую лицензию пользователю, место использования которого не поддерживается, данная операция назначения завершится сбоем и пользователь получит состояние ошибки.

Чтобы устранить эту проблему, удалите пользователей с неподдерживаемыми расположениями из лицензированной группы. Кроме того, если текущие значения места использования не соответствуют фактическому местонахождению пользователя, вы можете изменить эти значения для последующего правильного назначения лицензий (в случае, если новое расположение поддерживается).

**PowerShell:** командлеты PowerShell сообщают об этой ошибке, как об ошибке _ProhibitedInUsageLocationViolation_.

> [!NOTE]
> При назначении групповых лицензий Azure AD любой пользователь без места использования наследует расположение каталога. Перед использованием группового лицензирования для соблюдения требований местного законодательства мы рекомендуем задавать правильные значения места использования для пользователей.

## <a name="what-happens-when-theres-more-than-one-product-license-on-a-group"></a>Что происходит, если в группе более одной лицензии продукта?

Группе можно назначить несколько лицензий продукта. Например, вы можете назначить группе лицензии Office 365 корпоративный E3 и Enterprise Mobility + Security, чтобы активировать для пользователей все включенные службы.

Служба Azure AD попытается назначить все указанные в группе лицензии каждому пользователю. Если Azure AD не удается назначить один из продуктов из-за проблем, связанных с бизнес-логикой, назначить другие лицензии в группе также не получится. Например, если не хватает лицензий, а также в случае конфликтов с другими службами, активированными для пользователя.

Можно увидеть пользователей, которым не удалось назначить лицензии, а также определить, с какими продуктами связана эта проблема.

## <a name="how-do-you-manage-licenses-for-products-with-prerequisites"></a>Как управлять лицензиями на продукты с предварительными требованиями?

Некоторые продукты Microsoft Online, которые у вас есть, *являются надстройками*. Прежде чем их назначить, требуется включить для пользователя или группы план обслуживания необходимых компонентов. При использовании группового лицензирования системе требуется, чтобы в одной группе были планы обслуживания необходимых компонентов и надстроек. Это необходимо для того, чтобы все пользователи, которые будут добавляться в группу, получали полностью функциональный продукт. Рассмотрим следующий пример.

Microsoft Workplace Analytics является надстройкой. Она содержит отдельный план обслуживания с тем же именем. Мы можем назначить этот план обслуживания пользователю или группе, только если назначены следующие необходимые компоненты:
- Exchange Online (план 1); 
- Exchange Online (план 2).

Если мы попытаемся назначить группе этот продукт отдельно, портал отобразит сообщение об ошибке. Выбрав уведомления об ошибке, вы увидите следующие сведения:

![Назначение группе без необходимых компонентов](media/active-directory-licensing-group-problem-resolution-azure-portal/group-prerequisite-required.png)

Если выбрать сведения, отобразится следующее сообщение об ошибке:

>Сбой лицензирования. Убедитесь, что группа содержит нужные службы перед тем, как добавить или удалить зависимую службу. **Для службы Microsoft Workplace Analytics требуется включить Exchange Online (план 2).**

Чтобы назначить лицензию надстройки для группы, необходимо убедиться, что группа также содержит план обслуживания необходимых компонентов. Например, можно изменить существующую группу, которая уже содержит полную версию Office 365 E3, а затем добавить в нее надстройку.

Можно также создать изолированную группу, содержащую только минимальный требуемый набор продуктов, обеспечивающий работу надстройки. Ее можно использовать, чтобы предоставить лицензии на надстройку только определенным пользователям. В этом примере группе были назначены следующие продукты:
- Office 365 корпоративный E3 только с планом обслуживания Exchange Online (план 2);
- Microsoft Workplace Analytics.

![Группа с назначенными необходимыми компонентами](media/active-directory-licensing-group-problem-resolution-azure-portal/group-addon-with-prerequisite.png)

Теперь все пользователи, добавляемые в эту группу, используют одну лицензию на продукт E3 и одну лицензию на продукт Workplace Analytics. В то же время эти пользователи могут быть участниками другой группы, предоставляющей им полную версию продукта E3. В этом случае они все еще будут использовать только одну лицензию на этот продукт.

> [!TIP]
> Можно создать несколько групп, по одной для каждого плана обслуживания необходимых компонентов. Например, если пользователям предоставляются версии Office 365 корпоративный E1 и Office 365 корпоративный E3, можно создать две группы для назначения лицензий для Microsoft Workplace Analytics, указав в одной из них продукт E1 в качестве необходимого компонента, а в другой — продукт E3. Это позволит вам распределить надстройку между пользователями продуктов E1 и E3 без использования дополнительных лицензий.

## <a name="license-assignment-fails-silently-for-a-user-due-to-duplicate-proxy-addresses-in-exchange-online"></a>Назначение лицензии пользователю завершается сбоем без вывода уведомления из-за повторяющихся прокси-адресов в Exchange Online

Если вы используете Exchange Online, для некоторых пользователей в вашем клиенте может быть ошибочно настроено одно и то же значение адреса прокси-сервера. Если при групповом лицензировании производится попытка назначить лицензию такому пользователю, она завершается сбоем и ошибка не регистрируется. Это ограничение действует только в предварительной версии функции, и мы планируем устранить его в *общедоступной версии*.

> [!TIP]
> Если вы заметили, что некоторые пользователи не получили лицензию, но для них не зарегистрирована ошибка, сначала проверьте, не повторяются ли их прокси-адреса.
> Чтобы посмотреть, нет ли повторов прокси адресов, выполните следующий командлет PowerShell в Exchange Online:
```
Run Get-Recipient | where {$_.EmailAddresses -match "user@contoso.onmicrosoft.com"} | fL Name, RecipientType,emailaddresses
```
> Дополнительные сведения об этой проблеме см. в статье [Сообщение об ошибке "< адрес > адрес прокси-сервера уже используется" в Exchange Online](https://support.microsoft.com/help/3042584/-proxy-address-address-is-already-being-used-error-message-in-exchange-online). В статье [Подключение к Exchange Online PowerShell](https://technet.microsoft.com/library/jj984289.aspx) содержатся сведения о подключении к Exchange Online с помощью удаленного сеанса PowerShell.

После устранения проблем с прокси-адресами для соответствующих пользователей повторно выполните обработку лицензий для группы, чтобы проверить, что лицензии можно применять.

## <a name="how-do-you-force-license-processing-in-a-group-to-resolve-errors"></a>Как настроить принудительную обработку лицензий в группе, чтобы устранить ошибки

В зависимости от того, какие действия были предприняты для устранения ошибок, может потребоваться запустить обработку группы вручную, чтобы обновить состояние пользователя.

Например, если вы получили некоторые лицензии путем удаления прямых назначений лицензий пользователям, вам необходимо активировать обработку групп, в которых ранее не удалось полностью лицензировать всех пользователей. Для повторной обработки группы перейдите в область группы, откройте **Лицензии**, а потом нажмите кнопку **Повторная обработка** на панели инструментов.

## <a name="next-steps"></a>Дальнейшие действия

Чтобы получить дополнительные сведения о сценариях управления лицензиями с помощью групп, см. ссылки ниже.

* [Назначение лицензий группе в Azure Active Directory](active-directory-licensing-group-assignment-azure-portal.md)
* [Group-based licensing basics in Azure Active Directory](active-directory-licensing-whatis-azure-portal.md) (Основы группового лицензирования в Azure Active Directory)
* [Как перевести отдельных лицензированных пользователей на групповое лицензирование в Azure Active Directory](active-directory-licensing-group-migration-azure-portal.md)
* [Дополнительные сценарии лицензирования на основе группы в Azure Active Directory](active-directory-licensing-group-advanced.md)

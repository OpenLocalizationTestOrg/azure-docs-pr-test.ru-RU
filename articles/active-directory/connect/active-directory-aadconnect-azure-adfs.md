---
title: "Службы федерации Active Directory в Azure | Документация Майкрософт"
description: "Из этого документа вы узнаете, как развертывать AD FS в Azure, чтобы обеспечить высокую доступность."
keywords: "Развертывание AD FS в azure, развертывание azure adfs, azure adfs, azure ad fs, развертывание adfs, развертывание ad fs, ad fs в azure, развертывание adfs в azure, развертывание AD FS в azure, adfs azure, введение в AD FS, Azure, AD FS в Azure, iaas, ADFS, перемещение adfs в azure"
services: active-directory
documentationcenter: 
author: anandyadavmsft
manager: mtillman
editor: 
ms.assetid: 692a188c-badc-44aa-ba86-71c0e8074510
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 07/17/2017
ms.author: anandy; billmath
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 7a2b2bd139443159607a0cef800737de6761e1c2
ms.sourcegitcommit: 817c3db817348ad088711494e97fc84c9b32f19d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/20/2018
---
# <a name="deploying-active-directory-federation-services-in-azure"></a>Развертывание служб федерации Active Directory в Azure
В службах федерации Active Directory (AD FS) представлены возможности упрощенной безопасной федерации удостоверений и единого входа. Федерация с Azure AD или O365 дает пользователям возможность выполнять проверку подлинности с использованием локальных учетных данных и получать доступ ко всем ресурсам в облаке. В связи с этим требуется высокодоступная инфраструктура AD FS, обеспечивающая доступ к ресурсам как в локальной, так и в облачной средах. С помощью развертывания AD FS в Azure можно достичь необходимого уровня доступности с минимальными усилиями.
Ниже перечислены некоторые преимущества развертывания AD FS в Azure.

* **Высокая доступность.** Возможности групп доступности Azure помогают обеспечить высокодоступную инфраструктуру.
* **Простота масштабирования** . Если вам требуется более высокий уровень производительности, вы можете с легкостью перенести данные в более мощные виртуальные машины, выполнив всего несколько действий в Azure.
* **Перекрестная геоизбыточность.** Благодаря перекрестной геоизбыточности Azure ваша инфраструктура будет доступна по всему миру.
* **Простота управления.** Благодаря упрощенным параметрам управления на портале Azure можно очень просто и без проблем управлять своей инфраструктурой. 

## <a name="design-principles"></a>Принципы проектирования
![Структура развертывания](./media/active-directory-aadconnect-azure-adfs/deployment.png)

На приведенной выше схеме показана рекомендуемая базовая топология для начала развертывания инфраструктуры AD FS в Azure. Ниже представлены принципы работы различных компонентов топологии.

* **Контроллеры домена и серверы AD FS.** При наличии менее 1000 пользователей можно просто установить роль AD FS на контроллерах домена. Если необходимо предотвратить какое-либо влияние на производительность контроллеров домена или если у вас более 1000 пользователей, разверните AD FS на отдельных серверах.
* **Сервер WAP.** Необходимо развернуть прокси-серверы веб-приложений таким образом, чтобы пользователи могли получать доступ к AD FS вне локальной сети.
* **Зона DMZ.** Прокси-серверы веб-приложений будут помещены в DMZ. Доступ между DMZ и внутренней подсетью разрешен ТОЛЬКО через TCP-порт 443.
* **Балансировщики нагрузки.** Чтобы обеспечить высокий уровень доступности, для серверов AD FS рекомендуется использовать внутренний балансировщик нагрузки, а для прокси-серверов веб-приложений — Azure Load Balancer.
* **Группы доступности.** Чтобы обеспечить избыточность для развертывания AD FS, рекомендуется сгруппировать две или несколько виртуальных машин в группе доступности для аналогичных рабочих нагрузок. Эта конфигурация обеспечит доступность не менее одной виртуальной машины при событиях как запланированного, так и незапланированного обслуживания.
* **Учетные записи хранения.** Рекомендуется использовать две учетные записи хранения. При наличии одной учетной записи хранения создается только одна точка сбоя. Таким образом, если эта учетная запись выйдет из строя (маловероятный сценарий), развертывание может стать недоступным. При наличии двух учетных записей хранения одну из них можно связать с отдельным сбоем.
* **Разделение сети.** Прокси-серверы веб-приложений необходимо развертывать в отдельной сети DMZ. Одну виртуальную сеть можно разделить на две подсети, а затем развернуть прокси-серверы веб-приложений в изолированной подсети. Можно просто настроить параметры группы безопасности сети для каждой подсети и разрешить только требуемый обмен данными между двумя подсетями. Дополнительные сведения приведены в следующем сценарии развертывания.

## <a name="steps-to-deploy-ad-fs-in-azure"></a>Действия по развертыванию AD FS в Azure
Действия, описанные в этом разделе, представляют собой руководство по развертыванию показанной ниже инфраструктуры AD FS в Azure.

### <a name="1-deploying-the-network"></a>1. Развертывание сети
Как описано выше, можно создать две подсети в одной виртуальной сети или две совершенно разные виртуальные сети (VNet). В этой статье рассматривается развертывание одной виртуальной сети и ее разделение на две подсети. Сейчас это более простой подход, так как для обмена данными между двумя отдельными виртуальными сетями требуется шлюз типа "виртуальная сеть — виртуальная сеть".

**1.1. Создание виртуальной сети**

![Создание виртуальной сети](./media/active-directory-aadconnect-azure-adfs/deploynetwork1.png)

Выберите виртуальную сеть на портале Azure. Ее и одну подсеть можно развернуть сразу же всего одним щелчком. При этом также определяется подсеть INT. Она готова для добавления виртуальных машин.
Теперь необходимо добавить еще одну подсеть в сеть, т. е. подсеть DMZ. Чтобы создать подсеть DMZ, сделайте следующее:

* Выберите созданную сеть.
* В окне "Свойства" выберите подсеть.
* На панели "Подсети" щелкните "Добавить".
* Введите имя подсети и сведения об адресном пространстве, чтобы создать подсеть.

![Подсеть](./media/active-directory-aadconnect-azure-adfs/deploynetwork2.png)

![Подсеть DMZ](./media/active-directory-aadconnect-azure-adfs/deploynetwork3.png)

**1.2. Создание сетевых групп безопасности**

Группа безопасности сети (NSG) содержит перечень правил списка управления доступом, которые разрешают или запрещают сетевой трафик на экземпляры виртуальных машин в виртуальной сети. Группы безопасности сети можно связать с подсетями или отдельными экземплярами виртуальных машин в одной из подсетей. Когда NSG связана с подсетью, правила списка управления доступом применяются ко всем экземплярам виртуальной машины в этой подсети.
В этом руководстве мы создадим две группы NSG: одну для внутренней сети и одну для DMZ. Они будут называться NSG_INT и NSG_DMZ соответственно.

![Создание NSG](./media/active-directory-aadconnect-azure-adfs/creatensg1.png)

После создания NSG в ней будет 0 входящих и 0 исходящих правил. Когда роли на соответствующих серверах будут установлены и начнут работать, можно создать входящие и исходящие правила согласно требуемому уровню безопасности.

![Инициализация NSG](./media/active-directory-aadconnect-azure-adfs/nsgint1.png)

После создания групп NSG свяжите NSG_INT с подсетью INT, а NSG_DMZ — с подсетью DMZ. Ниже приведен снимок экрана для примера.

![Настройка NSG](./media/active-directory-aadconnect-azure-adfs/nsgconfigure1.png)

* Щелкните "Подсети", чтобы открыть панель подсетей.
* Выберите подсеть для связывания с NSG. 

После завершения настройки панель подсетей будет выглядеть следующим образом:

![Подсети после NSG](./media/active-directory-aadconnect-azure-adfs/nsgconfigure2.png)

**1.3. Создание подключения к локальной среде**

Для развертывания контроллера домена в Azure нам понадобится подключение к локальной среде. Azure предоставляет различные варианты подключения локальной инфраструктуры к инфраструктуре Azure:

* "точка — сеть";
* "сеть — сеть" между виртуальными сетями;
* ExpressRoute

Рекомендуется использовать ExpressRoute. ExpressRoute позволяет создавать частные подключения между центрами данных Azure и инфраструктурой вашей локальной среды или среды для совместного размещения. Подключения ExpressRoute не проходят через общедоступный Интернет. Они отличаются повышенной надежностью, более высокой скоростью, меньшей задержкой и дополнительной безопасностью по сравнению с обычными подключениями через Интернет.
Хотя рекомендуется использовать ExpressRoute, вы можете выбрать любой метод подключения, который лучше всего подходит для вашей организации. Дополнительные сведения об ExpressRoute и различных вариантах подключения с помощью ExpressRoute см. в статье [Технический обзор ExpressRoute](https://aka.ms/Azure/ExpressRoute).

### <a name="2-create-storage-accounts"></a>2. Создание учетных записей хранения
Чтобы обеспечить высокий уровень доступности и избежать зависимости от одной учетной записи, следует создать две учетные записи хранения. Разделите виртуальные машины в каждой группе доступности на две группы, а затем назначьте для каждой группы отдельную учетную запись хранения.

![Создание учетных записей хранения](./media/active-directory-aadconnect-azure-adfs/storageaccount1.png)

### <a name="3-create-availability-sets"></a>3. Создание групп доступности
Для каждой роли (контроллер домена или AD FS и WAP) создайте группы доступности, содержащие как минимум две виртуальные машины. Это поможет обеспечить более высокий уровень доступности для каждой роли. При создании групп доступности крайне важно учесть следующее:

* **Домены сбоя.** Для виртуальных машин в одном и том же домене сбоя используется один источник питания и физический сетевой коммутатор. Рекомендуется использовать не менее 2 доменов сбоя. Значение по умолчанию — 3. Для этого развертывания его можно оставить без изменений.
* **Домены обновления.** Во время обновления виртуальные машины, принадлежащие к одному домену обновления, перезапускаются вместе. Необходимо не менее 2 доменов обновления. Значение по умолчанию — 5. Для этого развертывания его можно оставить без изменений.

![Группы доступности](./media/active-directory-aadconnect-azure-adfs/availabilityset1.png)

Создайте следующие группы доступности.

| Группа доступности | Роль | Домены сбоя | Домены обновления |
|:---:|:---:|:---:|:--- |
| contosodcset |DC и AD FS |3 |5 |
| contosowapset |WAP |3 |5 |

### <a name="4-deploy-virtual-machines"></a>4. Развертывание виртуальных машин
Следующий шаг заключается в развертывании виртуальных машин, в которых будут размещаться разные роли вашей инфраструктуры. В каждой группе доступности рекомендуется использовать не менее двух виртуальных машин. Создайте четыре виртуальные машины для базового развертывания.

| Машина | Роль | Подсеть | Группа доступности | Учетная запись хранения | IP-адрес |
|:---:|:---:|:---:|:---:|:---:|:---:|
| contosodc1 |DC и AD FS |INT |contosodcset |contososac1 |Статическое |
| contosodc2 |DC и AD FS |INT |contosodcset |contososac2 |Статическое |
| contosowap1 |WAP |DMZ |contosowapset |contososac1 |Статическое |
| contosowap2 |WAP |DMZ |contosowapset |contososac2 |Статическое |

Как можно заметить, группы NSG не указаны. Это объясняется тем, что в Azure можно использовать группы NSG на уровне подсети. Сетевым трафиком виртуальной машины можно управлять с помощью отдельной группы NSG, связанной с подсетью или объектом сетевой карты. Дополнительные сведения см. в статье [Группа безопасности сети](https://aka.ms/Azure/NSG).
При управлении DNS рекомендуется использовать статический IP-адрес. Вы можете применять Azure DNS и ссылаться на новые виртуальные машины, используя их полные доменные имена Azure, а не записи DNS для домена.
После завершения развертывания панель вашей виртуальной машины должна выглядеть следующим образом:

![Развернутые виртуальные машины](./media/active-directory-aadconnect-azure-adfs/virtualmachinesdeployed_noadfs.png)

### <a name="5-configuring-the-domain-controller--ad-fs-servers"></a>5. Настройка контроллера домена или серверов AD FS
 Для проверки подлинности всех входящих запросов AD FS необходимо связаться с контроллером домена. Чтобы сэкономить на дорогостоящем маршруте из Azure в локальный контроллер домена для проверки подлинности, рекомендуется развертывать реплику контроллера домена в Azure. Для обеспечения высокой доступности рекомендуется создать группу доступности, содержащую не менее 2 контроллеров домена.

| Контроллер домена | Роль | Учетная запись хранения |
|:---:|:---:|:---:|
| contosodc1 |Реплика |contososac1 |
| contosodc2 |Реплика |contososac2 |

* Повысьте уровень двух серверов до контроллеров домена реплики с DNS.
* Настройте серверы AD FS, установив роли AD FS с помощью диспетчера серверов.

### <a name="6-deploying-internal-load-balancer-ilb"></a>6. Развертывание внутреннего балансировщика нагрузки
**6.1. Создание внутреннего балансировщика нагрузки**

Чтобы развернуть внутренний балансировщик нагрузки, выберите элемент "Балансировщики нагрузки" на портале Azure и щелкните "Добавить" (+).

> [!NOTE]
> Если пункт **Подсистемы балансировки нагрузки** не отображается в меню, щелкните **Обзор** в левом нижнем углу портала и прокрутите список до пункта **Подсистемы балансировки нагрузки**.  Щелкните желтую звездочку, чтобы добавить его в меню. Затем щелкните значок балансировщика нагрузки, чтобы открыть панель и начать настройку балансировщика нагрузки.
> 
> 

![Обзор балансировщика нагрузки](./media/active-directory-aadconnect-azure-adfs/browseloadbalancer.png)

* **Имя**. Присвойте балансировщику нагрузки любое подходящее имя.
* **Схема**. Так как этот балансировщик нагрузки будет размещаться перед серверами AD FS и предназначен ТОЛЬКО для подключения к внутренней сети, выберите "Внутренняя".
* **Виртуальная сеть**. Выберите виртуальную сеть, где развертывается AD FS.
* **Подсеть**. Выберите внутреннюю подсеть.
* **Назначение IP-адресов**: статический

![внутреннему балансировщику нагрузки;](./media/active-directory-aadconnect-azure-adfs/ilbdeployment1.png)

После нажатия кнопки "Создать" развернутый внутренний балансировщик нагрузки отобразится в соответствующем списке.

![Балансировщики нагрузки поверх внутреннего балансировщика нагрузки](./media/active-directory-aadconnect-azure-adfs/ilbdeployment2.png)

Следующий шаг — настройка серверного пула и серверной пробы.

**6.2. Настройка серверного пула внутреннего балансировщика нагрузки**

Выберите только что созданный внутренний балансировщик нагрузки на панели "Балансировщики нагрузки". Откроется панель "Параметры". 

1. Выберите на открывшейся панели серверные пулы.
2. На панели "Добавить серверный пул" щелкните "Добавить виртуальную машину".
3. Откроется панель, на которой можно выбрать группу доступности.
4. Выберите группу доступности AD FS.

![Настройка серверного пула внутреннего балансировщика нагрузки](./media/active-directory-aadconnect-azure-adfs/ilbdeployment3.png)

**6.3. Настройка пробы**

На панели "Параметры" внутреннего балансировщика нагрузки щелкните "Пробы".

1. Щелкните "Добавить".
2. Введите сведения о пробе: а) **Имя** — имя пробы; б) **Протокол** — TCP; в) **Порт** — 443 (HTTPS); г) **Интервал** — значение по умолчанию, 5 (это интервал, через который внутренний балансировщик нагрузки проверяет компьютеры в серверном пуле); д) **Unhealthy threshold limit** (Предельное пороговое значение состояния неработоспособности) — значение по умолчанию, 2 (это предельное число последовательных сбоев проверки, после которого внутренний балансировщик нагрузки объявит виртуальную машину в серверном пуле как неотвечающую и прекратит отправлять в нее трафик).

![Настройка пробы внутреннего балансировщика нагрузки](./media/active-directory-aadconnect-azure-adfs/ilbdeployment4.png)

**6.4. Создание правил балансировки нагрузки**

Чтобы обеспечить эффективную балансировку трафика, необходимо настроить во внутреннем балансировщике нагрузки правила балансировки нагрузки. Чтобы создать правило балансировки нагрузки, сделайте следующее: 

1. Выберите правило балансировки нагрузки на панели "Параметры" внутреннего балансировщика нагрузки.
2. Щелкните "Добавить" на панели "Правила балансировки нагрузки".
3. На панели "Добавить правило балансировки нагрузки" сделайте следующее: а) **Имя** — укажите имя правила; б) **Протокол** — выберите тип TCP; в) **Порт** — 443; г) **Внутренний порт** — 443; д) **Серверный пул** — выберите пул, созданный ранее для кластера AD FS; е) **Проба** — выберите пробу, созданную ранее для серверов AD FS.

![Настройка правил балансировки нагрузки во внутреннем балансировщике нагрузки](./media/active-directory-aadconnect-azure-adfs/ilbdeployment5.png)

**6.5. Указание внутреннего балансировщика нагрузки для DNS**

Перейдите на DNS-сервер и создайте запись CNAME для внутреннего балансировщика нагрузки. Эта запись должна быть предназначена для службы федерации и содержать IP-адрес, указывающий на IP-адрес внутреннего балансировщика нагрузки. Например, если выделенный IP-адрес внутреннего балансировщика нагрузки — 10.3.0.8, а установленная служба федерации — fs.contoso.com, создайте запись CNAME, содержащую fs.contoso.com и указывающую на 10.3.0.8.
После этого весь обмен данными, касающийся fs.contoso.com, будет осуществляться через внутренний балансировщик нагрузки, который будет направлять его соответствующим образом.

### <a name="7-configuring-the-web-application-proxy-server"></a>7. Настройка прокси-сервера веб-приложения
**7.1. Настройка прокси-серверов веб-приложений для получения доступа к серверам AD FS**

Чтобы обеспечить доступ прокси-серверов веб-приложений к серверам AD FS за пределами внутреннего балансировщика нагрузки, создайте запись в папке %systemroot%\system32\drivers\etc\hosts для внутреннего балансировщика нагрузки. Обратите внимание, что различающееся имя должно соответствовать имени службы федерации, например fs.contoso.com, а запись IP-адреса должна представлять собой IP-адрес внутреннего балансировщика нагрузки (10.3.0.8, как показано в примере).

**7.2. Установка роли прокси-сервера веб-приложения**

Убедитесь, что прокси-серверы веб-приложений могут получить доступ к серверам AD FS за пределами внутреннего балансировщика нагрузки, после чего их можно установить. Прокси-серверы веб-приложений не нужно присоединять к домену. Установите роль прокси веб-приложения на двух прокси-серверах веб-приложений, выбрав роль удаленного доступа. Диспетчер серверов поможет завершить установку WAP.
Дополнительные сведения о развертывании WAP см. в статье [Установка и настройка прокси-сервера веб-приложений](https://technet.microsoft.com/library/dn383662.aspx).

### <a name="8--deploying-the-internet-facing-public-load-balancer"></a>8.  Развертывание балансировщика нагрузки с выходом в Интернет (общедоступного)
**8.1.  Создание балансировщика нагрузки с выходом в Интернет (общедоступного)**

На портале Azure выберите "Балансировщики нагрузки", а затем щелкните "Добавить". На панели "Создание подсистемы балансировки нагрузки" введите следующие сведения.

1. **Имя**— имя балансировщика нагрузки.
2. **Схема** — выберите "Общедоступная". Этот параметр сообщает Azure, что для балансировщика нагрузки необходим общедоступный адрес.
3. **IP-адрес**— создайте IP-адрес (динамический).

![Приступая к созданию балансировщика нагрузки для Интернета в диспетчере ресурсов с помощью PowerShell](./media/active-directory-aadconnect-azure-adfs/elbdeployment1.png)

После развертывания балансировщик нагрузки появится в списке "Балансировщики нагрузки".

![Список "Балансировщики нагрузки"](./media/active-directory-aadconnect-azure-adfs/elbdeployment2.png)

**8.2. Назначение DNS-метки для общедоступного IP-адреса**

Щелкните только что созданную запись балансировщика нагрузки на панели "Балансировщик нагрузки", чтобы открыть панель для настройки. Чтобы настроить DNS-метку для общедоступного IP-адреса, сделайте следующее:

1. Щелкните общедоступный IP-адрес. Откроется панель общедоступного IP-адреса и его параметров.
2. Щелкните "Конфигурация".
3. Укажите DNS-метку. Это будет общедоступная DNS-метка, к которой можно получить доступ из любого места, например contosofs.westus.cloudapp.azure.com. Вы можете добавить запись во внешней службе DNS для службы федерации (например, fs.contoso.com), которая будет указывать на DNS-метку внешнего балансировщика нагрузки (contosofs.westus.cloudapp.azure.com).

![Настройка балансировщика нагрузки с выходом в Интернет](./media/active-directory-aadconnect-azure-adfs/elbdeployment3.png) 

![Настройка балансировщика нагрузки с выходом в Интернет (DNS)](./media/active-directory-aadconnect-azure-adfs/elbdeployment4.png)

**8.3. Настройка серверного пула для балансировщика нагрузки с выходом в Интернет (общедоступного)** 

Чтобы настроить серверный пул для балансировщика нагрузки с выходом в Интернет (общедоступного) в качестве группы доступности для серверов WAP, сделайте то же самое, что и при создании внутреннего балансировщика нагрузки. Например, contosowapset.

![Настройка серверного пула для балансировщика нагрузки с выходом в Интернет](./media/active-directory-aadconnect-azure-adfs/elbdeployment5.png)

**8.4. Настройка пробы**

Чтобы настроить пробу для серверного пула серверов WAP, сделайте то же самое, что и при настройке внутреннего балансировщика нагрузки.

![Настройка пробы для балансировщика нагрузки с выходом в Интернет](./media/active-directory-aadconnect-azure-adfs/elbdeployment6.png)

**8.5. Создание правил балансировки нагрузки**

Чтобы настроить правило балансировки нагрузки для TCP-порта 443, сделайте то же самое, что и при настройке внутреннего балансировщика нагрузки.

![Настройка правил балансировки нагрузки для балансировщика нагрузки с выходом в Интернет](./media/active-directory-aadconnect-azure-adfs/elbdeployment7.png)

### <a name="9-securing-the-network"></a>9. Обеспечение безопасности сети
**9.1. Обеспечение безопасности внутренней подсети**

В целом для эффективной защиты внутренней подсети требуются следующие правила (в порядке, как показано ниже).

| правило; | ОПИСАНИЕ | Поток |
|:--- |:--- |:---:|
| AllowHTTPSFromDMZ |Разрешение взаимодействия с DMZ по протоколу HTTPS |Входящий трафик |
| DenyInternetOutbound |Нет доступа к Интернету |Исходящие |

![Правила доступа INT (входящий трафик)](./media/active-directory-aadconnect-azure-adfs/nsg_int.png)

[комментарий]: <> (![правила доступа INT (входящий трафик)](./media/active-directory-aadconnect-azure-adfs/nsgintinbound.png)) [комментарий]: <> (![правила доступа INT (исходящий трафик)](./media/active-directory-aadconnect-azure-adfs/nsgintoutbound.png))

**9.2. Обеспечение защиты подсети DMZ**

| правило; | ОПИСАНИЕ | Поток |
|:--- |:--- |:---:|
| AllowHTTPSFromInternet |Разрешение обмена данными между DMZ и Интернетом по протоколу HTTPS |Входящий трафик |
| DenyInternetOutbound |Блокирование всего, кроме HTTPS-трафика, поступающего в Интернет |Исходящие |

![Правила доступа EXT (входящий трафик)](./media/active-directory-aadconnect-azure-adfs/nsg_dmz.png)

<!--
[comment]: <> (![EXT access rules (inbound)](./media/active-directory-aadconnect-azure-adfs/nsgdmzinbound.png))
[comment]: <> (![EXT access rules (outbound)](./media/active-directory-aadconnect-azure-adfs/nsgdmzoutbound.png))
-->

> [!NOTE]
> Если проверка подлинности сертификата клиента (проверка подлинности TLS-порта клиента: с использованием сертификатов пользователей X509) является обязательной, для AD FS требуется, чтобы TCP-порт 49443 был включен, обеспечивая входящий доступ.
> 
> 

### <a name="10-test-the-ad-fs-sign-in"></a>10. Тестирование входа AD FS
Самый простой способ тестировать вход AD FS — использовать страницу IdpInitiatedSignon.aspx. Для этого необходимо включить IdpInitiatedSignOn в свойствах AD FS. Чтобы проверить установку AD FS, сделайте следующее:

1. Запустите указанный ниже командлет на сервере AD FS с помощью PowerShell, чтобы включить страницу входа:
   Set-AdfsProperties -EnableIdPInitiatedSignonPage $true. 
2. С любого внешнего компьютера перейдите по адресу https://adfs.thecloudadvocate.com/adfs/ls/IdpInitiatedSignon.aspx.  
3. Должна появиться страница AD FS, как показано ниже.

![Тестовая страница входа](./media/active-directory-aadconnect-azure-adfs/test1.png)

Если вход будет выполнен успешно, отобразится сообщение об успешном выполнении, как показано ниже.

![Успешное завершение тестирования](./media/active-directory-aadconnect-azure-adfs/test2.png)

## <a name="template-for-deploying-ad-fs-in-azure"></a>Шаблон для развертывания AD FS в Azure
Шаблон развертывает 6 виртуальных машин, по 2 для контроллеров домена, серверов AD FS и WAP.

[Шаблон для развертывания AD FS в Azure](https://github.com/paulomarquesc/adfs-6vms-regular-template-based)

При развертывании этого шаблона можно использовать существующую виртуальную сеть или создать новую. Ниже перечислены различные параметры, доступные для настройки развертывания, а также приведено описание их использования в процессе развертывания. 

| Параметр | ОПИСАНИЕ |
|:--- |:--- |
| Расположение |Регион, в котором будут развернуты ресурсы, например East US. |
| StorageAccountType |Тип создаваемой учетной записи хранения. |
| VirtualNetworkUsage |Указывает, какая виртуальная сеть будет использоваться: новая или существующая. |
| VirtualNetworkName |Имя создаваемой виртуальной сети. Это обязательный параметр как при использовании существующей виртуальной сети, так и при создании новой. |
| VirtualNetworkResourceGroupName |Имя группы ресурсов, в которую входит существующая виртуальная сеть. Это обязательный параметр при использовании существующей виртуальной сети, так как при развертывании нужно определить идентификатор этой сети. |
| VirtualNetworkAddressRange |Диапазон адресов новой виртуальной сети. Обязательный параметр при создании новой виртуальной сети. |
| InternalSubnetName |Имя внутренней подсети. Это обязательный параметр как при использовании существующей виртуальной сети, так и при создании новой. |
| InternalSubnetAddressRange |Диапазон адресов внутренней подсети, содержащий контроллеры домена и серверы ADFS. Обязательный параметр при создании новой виртуальной сети. |
| DMZSubnetAddressRange |Диапазон адресов подсети DMZ, содержащий прокси-серверы приложения Windows. Обязательный параметр при создании новой виртуальной сети. |
| DMZSubnetName |Имя внутренней подсети. Это обязательный параметр как при использовании существующей виртуальной сети, так и при создании новой. |
| ADDC01NICIPAddress |Внутренний IP-адрес первого контроллера домена. Это должен быть допустимый IP-адрес в пределах внутренней подсети. Он назначается контроллеру домена статически. |
| ADDC02NICIPAddress |Внутренний IP-адрес второго контроллера домена. Это должен быть допустимый IP-адрес в пределах внутренней подсети. Он назначается контроллеру домена статически. |
| ADFS01NICIPAddress |Внутренний IP-адрес первого сервера ADFS. Это должен быть допустимый IP-адрес в пределах внутренней подсети. Он назначается серверу ADFS статически. |
| ADFS02NICIPAddress |Внутренний IP-адрес второго сервера ADFS. Это должен быть допустимый IP-адрес в пределах внутренней подсети. Он назначается серверу ADFS статически. |
| WAP01NICIPAddress |Внутренний IP-адрес первого сервера WAP. Это должен быть допустимый IP-адрес в пределах подсети DMZ. Он назначается серверу WAP статически. |
| WAP02NICIPAddress |Внутренний IP-адрес второго сервера WAP. Это должен быть допустимый IP-адрес в пределах подсети DMZ. Он назначается серверу WAP статически. |
| ADFSLoadBalancerPrivateIPAddress |Внутренний IP-адрес балансировщика нагрузки ADFS. Это должен быть допустимый IP-адрес в пределах внутренней подсети. Он назначается серверу балансировщику нагрузки статически. |
| ADDCVMNamePrefix |Префикс имени виртуальной машины для контроллеров домена. |
| ADFSVMNamePrefix |Префикс имени виртуальной машины для серверов ADFS. |
| WAPVMNamePrefix |Префикс имени виртуальной машины для серверов WAP. |
| ADDCVMSize |Размер виртуальной машины для контроллеров домена. |
| ADFSVMSize |Размер виртуальной машины для серверов ADFS. |
| WAPVMSize |Размер виртуальной машины для серверов WAP. |
| AdminUserName |Имя локального администратора виртуальных машин. |
| AdminPassword |Имя учетной записи локального администратора виртуальных машин. |

## <a name="additional-resources"></a>Дополнительные ресурсы
* [Группы доступности](https://aka.ms/Azure/Availability) 
* [Подсистема балансировщика нагрузки Azure](https://aka.ms/Azure/ILB)
* [Внутренний балансировщик нагрузки](https://aka.ms/Azure/ILB/Internal)
* [Приступая к созданию балансировщика нагрузки для Интернета в диспетчере ресурсов с помощью PowerShell](https://aka.ms/Azure/ILB/Internet)
* [Учетные записи хранения](https://aka.ms/Azure/Storage)
* [Виртуальные сети Azure](https://aka.ms/Azure/VNet)
* [AD FS and Web Application Proxy Links (Ссылки на ресурсы по AD FS и прокси веб-приложений)](http://aka.ms/ADFSLinks) 

## <a name="next-steps"></a>Дополнительная информация
* [Интеграция локальных удостоверений с Azure Active Directory](active-directory-aadconnect.md)
* [Настройка служб AD FS и управление ими с использованием Azure AD Connect](active-directory-aadconnectfed-whatis.md)
* [Развертывание AD FS высокого уровня доступности в нескольких регионах Azure с помощью диспетчера трафика Azure](../active-directory-adfs-in-azure-with-azure-traffic-manager.md)


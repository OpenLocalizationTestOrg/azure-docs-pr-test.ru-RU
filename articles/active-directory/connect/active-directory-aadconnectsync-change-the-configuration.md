---
title: "Синхронизация Azure AD Connect: изменение конфигурации | Документация Майкрософт"
description: "Узнайте, как изменить конфигурацию службы синхронизации Azure AD Connect."
services: active-directory
documentationcenter: 
author: andkjell
manager: femila
editor: 
ms.assetid: 7b9df836-e8a5-4228-97da-2faec9238b31
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/12/2017
ms.author: billmath
ms.openlocfilehash: 63a7ae9d39e1a74294637172efd607ee41b2d69b
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="azure-ad-connect-sync-how-to-make-a-change-to-the-default-configuration"></a>Службы синхронизации Azure AD Connect: изменение конфигурации по умолчанию
В этой статье предоставлены сведения об изменении конфигурации по умолчанию в службах синхронизации Azure AD Connect. Здесь также описываются действия для некоторых стандартных сценариев. Ознакомившись с этими сведениями, вы сможете вносить изменения в конфигурацию в соответствии с собственными бизнес-правилами.

## <a name="synchronization-rules-editor"></a>Редактор правил синхронизации
Редактор правил синхронизации используется для просмотра и изменения конфигурации по умолчанию. Его можно найти в меню "Пуск" в группе **Azure AD Connect** .  
![Редактор правил синхронизации в меню "Пуск"](./media/active-directory-aadconnectsync-change-the-configuration/startmenu2.png)

При открытии в нем отображаются стандартные правила по умолчанию.

![Редактор правил синхронизации](./media/active-directory-aadconnectsync-change-the-configuration/sre2.png)

### <a name="navigating-in-the-editor"></a>Перемещение в редакторе
Чтобы быстро найти определенное правило, можно воспользоваться раскрывающимися списками, расположенными в верхней части редактора. Например, чтобы просмотреть правила, содержащие атрибут proxyAddresses, необходимо выбрать в раскрывающихся списках следующее:   
![Фильтрация в редакторе правил синхронизации](./media/active-directory-aadconnectsync-change-the-configuration/filtering.png)  
Чтобы сбросить параметры фильтрации и загрузить новую конфигурацию, нажмите клавишу **F5** .

В верхнем правом углу расположена кнопка **Добавить новое правило**. Она используется для создания собственного настраиваемого правила.

Внизу находятся кнопки, позволяющие выполнять определенные действия с выбранным правилом синхронизации. Кнопки **Изменить** и **Удалить** используются для удаления и изменения правил. **Экспортировать** позволяет создать сценарий PowerShell для повторного создания правила синхронизации. При этом правило синхронизации перемещается с одного сервера на другой.

## <a name="create-your-first-custom-rule"></a>Создание настраиваемого правила
Чаще всего изменяются потоки атрибутов. Данные в исходном каталоге могут отображаться не так, как в Azure AD. В примере, рассматриваемом в этом разделе, необходимо убедиться, что имя пользователя всегда задано в **правильном регистре**.

### <a name="disable-the-scheduler"></a>Отключение планировщика
По умолчанию [планировщик](active-directory-aadconnectsync-feature-scheduler.md) запускается каждые 30 минут. В некоторых случаях, чтобы внести изменения и устранить неполадки, связанные с новыми правилами, может потребоваться отключить его. Чтобы временно отключить планировщик, запустите PowerShell и выполните команду `Set-ADSyncScheduler -SyncCycleEnabled $false`

![Отключение планировщика](./media/active-directory-aadconnectsync-change-the-configuration/schedulerdisable.png)  

### <a name="create-the-rule"></a>Создание правила
1. Щелкните **Добавить новое правило**.
2. На странице **Описание** заполните следующие поля.  
   ![Фильтрация входящего правила синхронизации](./media/active-directory-aadconnectsync-change-the-configuration/description2.png)  
   * "Имя". Введите описательное имя правила.
   * "Описание". Информация, позволяющая другим пользователям определить предназначение правила.
   * Connected system (Подключенная система). Система, в которой находится объект. В этом случае выберите соединитель Active Directory.
   * Connected System Type (Тип подключенной системы) и Metaverse Object Type (Тип объекта метавселенной). Выберите **Пользователь** и **Человек** соответственно.
   * "Тип связи". Задайте для этого параметра значение **Присоединение**.
   * "Приоритет". Укажите уникальное в системе значение. Более низкие значения имеют более высокий приоритет.
   * "Тег". Оставьте это поле пустым. Его нужно заполнять только при использовании стандартных правил Майкрософт.
3. На странице **Scoping filter** (Фильтр области действия) введите **givenName ISNOTNULL**.  
   ![Фильтр области входящего правила](./media/active-directory-aadconnectsync-change-the-configuration/scopingfilter.png)  
   Этот раздел позволит определить, к каким объектам должно применяться правило. Если оставить эти поля пустыми, правило будет применяться ко всем объектам пользователя, в том числе к конференц-залам, учетным записям службы и другим неодушевленным объектам.
4. Оставьте страницу **Join rules**(Правила присоединения) пустой.
5. На странице **Преобразования** для параметра FlowType (Тип потока) задайте значение **Выражение**. Выберите для параметра "Целевой атрибут" значение **givenName**, а в поле "Источник" введите `PCase([givenName])`.
   ![Преобразования входящего правила](./media/active-directory-aadconnectsync-change-the-configuration/transformations.png)  
   Для модуля синхронизации имя функции и имя атрибута необходимо указывать с учетом регистра. Если не учесть регистр, при добавлении правила отобразится предупреждение. В редакторе можно сохранить правило и продолжить с ним работу позже. Таким образом, вы сможете повторно открыть правило и внести в него изменения.
6. Нажмите кнопку **Добавить** , чтобы сохранить правило.

Новое настраиваемое правило отобразится в системе вместе с другими правилами синхронизации.

### <a name="verify-the-change"></a>Проверка изменений
После внесения изменений в правило его можно проверить на наличие ошибок. В зависимости от количества объектов это можно сделать двумя разными способами:

1. Выполнить полную синхронизацию всех объектов.
2. Выполнить предварительный просмотр и полную синхронизацию одного объекта.

Запустите **Synchronization Service** из меню "Пуск". Все действия, описанные в этом разделе, выполняются в этом средстве.

1. **Полная синхронизация всех объектов**  
   Выберите **Соединители** вверху. Определите соединитель, измененный в предыдущем разделе (в этом примере "Доменные службы Active Directory"), и выберите его. Выберите **Запустить** в колонке "Действия". После этого выберите **Полная синхронизация** и нажмите кнопку **ОК**.
   ![Полная синхронизация](./media/active-directory-aadconnectsync-change-the-configuration/fullsync.png)  
   Теперь объекты в метавселенной обновлены, и их можно просмотреть.
2. **Предварительный просмотр и полная синхронизация одного объекта**  
   Выберите **Соединители** вверху. Определите соединитель, измененный в предыдущем разделе (в этом примере "Доменные службы Active Directory"), и выберите его. Выберите **Search Connector Space**(Поиск пространства соединителя). Используйте область поиска, чтобы найти необходимый объект для проверки изменений. Выберите объект и щелкните **Предварительный просмотр**. В открывшемся окне выберите **Просмотр перед фиксацией**.  
   ![Просмотр перед фиксацией](./media/active-directory-aadconnectsync-change-the-configuration/commitpreview.png)  
   Теперь изменение зафиксировано в метавселенной.

**Просмотр объектов в метавселенной**  
В этом разделе мы выберем несколько образцов объектов и убедимся, что для них задано правильное значение и применено необходимое правило. В верхней части экрана выберите **Metaverse Search** (Поиск в метавселенной). Добавьте любой фильтр, чтобы найти соответствующие объекты. Откройте объект, выбрав его в результатах поиска. Просмотрите значения атрибута, а также проверьте применение правила в столбце **Правила синхронизации** .  
![Metaverse search](./media/active-directory-aadconnectsync-change-the-configuration/mvsearch.png)  

### <a name="enable-the-scheduler"></a>Включение планировщика
Если все параметры заданы правильно, планировщик можно включить снова. В PowerShell выполните команду `Set-ADSyncScheduler -SyncCycleEnabled $true`.

## <a name="other-common-attribute-flow-changes"></a>Другие основные изменения потоков атрибутов
В предыдущем разделе описан процесс изменения потока атрибута. В этом разделе приведены дополнительные примеры. Действия по созданию правила синхронизации упомянуты лишь в общих чертах. Полное описание можно просмотреть в предыдущем разделе.

### <a name="use-another-attribute-than-the-default"></a>Использование атрибута не по умолчанию
В компании Fabrikam есть лес, в котором для указания имени, фамилии и отображаемого имени используются локальные алфавиты. Представления этих атрибутов хранятся в атрибутах расширения, отображенные символами латиницы. При формировании глобального списка адресов в Azure AD и Office 365 организации требуется использовать эти атрибуты.

В конфигурации по умолчанию объект из локального леса выглядит следующим образом:  
![Поток атрибутов 1](./media/active-directory-aadconnectsync-change-the-configuration/attributeflowjp1.png)

Чтобы создать правило с другими потоками атрибутов, выполните следующие действия.

* В меню "Пуск" запустите **редактор правил синхронизации** .
* Не снимая флажок **Входящие** слева, нажмите кнопку **Добавить новое правило**.
* Присвойте правилу имя и описание. Выберите локальный каталог Active Directory и соответствующие типы объектов. В поле **Тип связи** выберите **Join** (Присоединение). Для задания приоритета выберите число, которое не используется другим правилом. Приоритет стандартных правил начинается со 100, поэтому в этом примере используется значение 50.
  ![Поток атрибутов 2](./media/active-directory-aadconnectsync-change-the-configuration/attributeflowjp2.png)
* Оставьте значение области пустым (это означает, что правило должно применяться для всех объектов-пользователей в лесу).
* Оставьте поле Join rules (Правила присоединения) пустым (это означает, что стандартные правила могут обрабатывать любые присоединения).
* В разделе "Преобразования" создайте следующие потоки.  
  ![Поток атрибутов 3](./media/active-directory-aadconnectsync-change-the-configuration/attributeflowjp3.png)
* Щелкните **Добавить** , чтобы сохранить правило.
* Откройте **Synchronization Service Manager**. В разделе **Соединители**выберите соединитель, в который мы добавили правило. Выберите **Запустить**, а затем — **Полная синхронизация**. Функция полной синхронизации повторно вычисляет все объекты, используя текущие правила.

Это результат для того же объекта с применением следующего настраиваемого правила.  
![Поток атрибутов 4](./media/active-directory-aadconnectsync-change-the-configuration/attributeflowjp4.png)

### <a name="length-of-attributes"></a>Длина атрибутов
Строковые атрибуты по умолчанию являются индексируемыми. Их длина не может превышать 448 знаков. При работе с атрибутами, которые могут содержать больше символов, необходимо включить в поток атрибутов следующее значение:  
`attributeName` <- `Left([attributeName],448)`

### <a name="changing-the-userprincipalsuffix"></a>Изменение атрибута userPrincipalSuffix
Атрибут userPrincipalName в Active Directory не всегда известен пользователям. Также он может не подходить в качестве идентификатора для входа. Мастер установки службы синхронизации Azure AD Connect позволяет выбрать другой атрибут, например mail. Но в некоторых случаях этот атрибут должен вычисляться. Например, у компании Contoso есть два каталога Azure AD: один для рабочей среды, а другой для тестовой. Пользователи в тестовом клиенте должны просто изменить суффикс в идентификаторе входа.  
`userPrincipalName` <- `Word([userPrincipalName],1,"@") & "@contosotest.com"`

В этом выражении берется вся часть слева от первого знака @-sign (Word) и сцепляется с фиксированной строкой.

### <a name="convert-a-multi-value-to-a-single-value"></a>Преобразование атрибута с несколькими значениями в атрибут с одним
Некоторые атрибуты в Active Directory имеют несколько значений в схеме, даже если в средстве администрирования «Пользователи и компьютеры Active Directory» они выглядят как атрибуты с одним значением. Пример — атрибут Description.  
`description` <- `IIF(IsNullOrEmpty([description]),NULL,Left(Trim(Item([description],1)),448))`

В этом выражении в случае, если атрибут имеет значение, берется первый элемент (Item) в атрибуте, удаляются начальные и конечные пробелы (Trim), а затем сохраняются первые 448 знаков (Left) в строке.

### <a name="do-not-flow-an-attribute"></a>Отключение потока для атрибута
Общие сведения о сценарии в этом разделе см. в разделе [Управление потоком атрибута](active-directory-aadconnectsync-understanding-declarative-provisioning.md#control-the-attribute-flow-process).

Существует два способа отключения потока для атрибута. Первый доступен в мастере установки и позволяет [удалить выбранные атрибуты](active-directory-aadconnect-get-started-custom.md#azure-ad-app-and-attribute-filtering). Им можно воспользоваться, если атрибут никогда не синхронизировался. Однако если вы начали синхронизацию этого атрибута и позже удалили его с помощью этой функции, то модуль синхронизации прекратит управление атрибутом и в Azure AD будут оставлены имеющиеся значения.

Если вы хотите удалить значение атрибута и гарантировать, что в будущем для него не будет включен поток, нужно создать настраиваемое правило.

В компании Fabrikam мы обнаружили, что некоторые атрибуты, синхронизируемые с облаком, лишние. Мы хотим удалить эти атрибуты из Azure AD.  
![Неправильные атрибуты расширения](./media/active-directory-aadconnectsync-change-the-configuration/badextensionattribute.png)

* Создайте новое входящее правило синхронизации и укажите описание. ![Описания](./media/active-directory-aadconnectsync-change-the-configuration/syncruledescription.png)
* Создайте потоки атрибутов типа **Выражение** с источником **AuthoritativeNull**. Литеральный тип **AuthoritativeNull** указывает, что значение должно быть пустым в MV, даже если правило синхронизации с более низким приоритетом пытается заполнить значение.
  ![Преобразование атрибутов расширения](./media/active-directory-aadconnectsync-change-the-configuration/syncruletransformations.png)
* Сохраните правило синхронизации. Запустите **службу синхронизации**, найдите соединитель, выберите **Запустить** и **Полная синхронизация**. Это приведет к пересчету всех потоков атрибутов.
* Убедитесь, что требуемые изменения будут экспортированы, с помощью поиска в пространстве соединителя.
  ![Промежуточное удаление](./media/active-directory-aadconnectsync-change-the-configuration/deletetobeexported.png)

## <a name="create-rules-with-powershell"></a>Создание правил с помощью PowerShell
Редактор правил синхронизации удобно использовать, если требуется внести всего несколько изменений. Если требуется внести много изменений, то лучше использовать PowerShell. Некоторые дополнительные функции доступны только в PowerShell.

### <a name="get-the-powershell-script-for-an-out-of-box-rule"></a>Получение сценария PowerShell для стандартного правила
Чтобы получить сценарий PowerShell для создания стандартного правила, выберите правило в редакторе правил синхронизации и щелкните **Экспорт**. Это позволит получить сценарий PowerShell, который создал данное правило.

### <a name="advanced-precedence"></a>Расширенный приоритет
Значение приоритета стандартного правила синхронизации начинается со 100. Если имеется несколько лесов и нужно внести множество пользовательских изменений, то 99 правил синхронизации может быть недостаточно.

Можно указать модулю синхронизации, что вам нужно вставить дополнительные правила перед стандартными правилами. Чтобы сделать это, выполните следующее.

1. Выберите первое стандартное правило синхронизации (это правило **In from AD-User Join**) в редакторе правил синхронизации и щелкните **Экспорт**. Скопируйте значение идентификатора SR.  
![PowerShell до изменения](./media/active-directory-aadconnectsync-change-the-configuration/powershell1.png)  
2. Создайте новое правило синхронизации. Для этого можно использовать редактор правил синхронизации. Экспортируйте это правило в сценарий PowerShell.
3. В свойство **PrecedenceBefore** вставьте значение идентификатора из стандартного правила. Задайте для параметра **Precedence** значение **0**. Убедитесь, что атрибут Identifier является уникальным и вы не используете повторно GUID из другого правила. Также убедитесь, что свойство **ImmutableTag** не задано. Это свойство должно задаваться только для стандартного правила. Сохраните сценарий PowerShell и запустите его. Результатом будет назначение приоритета со значением 100 вашему настраиваемому правилу, при этом приоритет всех прочих стандартных правил будет увеличен.  
![PowerShell после изменения](./media/active-directory-aadconnectsync-change-the-configuration/powershell2.png)  

При необходимости можно использовать несколько пользовательских правил синхронизации с одинаковым значением **PrecedenceBefore**.


## <a name="enable-synchronization-of-preferreddatalocation"></a>Включение синхронизации PreferredDataLocation
Azure AD Connect поддерживает синхронизацию атрибута **PreferredDataLocation** для объектов **User** в версии 1.1.524.0 и более поздних версиях. В частности, были введены следующие изменения.

* Схема типа объекта **User** в соединителе Azure AD расширена для включения атрибута PreferredDataLocation, который имеет строковый тип и является однозначным.

* Схема типа объекта **Person** в метавселенной расширена для включения атрибута PreferredDataLocation, который имеет строковый тип и является однозначным.

По умолчанию синхронизация атрибута PreferredDataLocation не включена, так как в локальном каталоге Active Directory отсутствует соответствующий атрибут PreferredDataLocation. Необходимо вручную включить синхронизацию.

> [!IMPORTANT]
> В настоящее время Azure AD позволяет непосредственно настроить атрибут PreferredDataLocation для синхронизированных объектов User и облачных объектов User с помощью Azure AD PowerShell. После включения синхронизации атрибута PreferredDataLocation необходимо перестать использовать Azure AD PowerShell для настройки этого атрибута для **синхронизированных объектов User**, так как Azure AD Connect переопределит их атрибуты на основе значений исходных атрибутов в локальном каталоге Active Directory.

> [!IMPORTANT]
> С 1 сентября 2017 года возможность непосредственно настроить атрибут PreferredDataLocation для **синхронизированных объектов User** в Azure AD с помощью Azure AD PowerShell будет отсутствовать. Чтобы настроить атрибут PreferredLocation для синхронизированных объектов User, необходимо использовать только Azure AD Connect.

Перед включением синхронизации атрибута PreferredDataLocation необходимо выполнить следующее.

 * Сначала определите, какой атрибут локального каталога Active Directory следует использовать в качестве исходного атрибута. Он должно иметь тип **string** и быть **однозначным**.

 * Если ранее с помощью Azure AD PowerShell в Azure AD вы настроили атрибут PreferredDataLocation для существующих синхронизированных объектов User, необходимо **бэкпортировать** значения атрибутов для соответствующих объектов User в локальном каталоге Active Directory.
 
    > [!IMPORTANT]
    > В противном случае после включения синхронизации атрибута PreferredDataLocation Azure AD Connect удалит существующие значения атрибутов в Azure AD.

 * Рекомендуется настроить исходный атрибут по крайней мере для двух локальных объектов User в Active Directory, которые позже могут быть использованы для проверки.
 
Включение синхронизации атрибута PreferredDataLocation можно вкратце описать следующим образом.

1. Отключите планировщик синхронизации и убедитесь, что синхронизация не выполняется

2. Добавьте исходный атрибут в схему локального соединителя AD.

3. Добавьте PreferredDataLocation в схему соединителя Azure AD.

4. Создайте правило входящей синхронизации для передачи значения атрибута из локального каталога Active Directory.

5. Создайте правило исходящей синхронизации для передачи значения атрибута в Azure AD.

6. Запустите полный цикл синхронизации.

7. Включите планировщик синхронизации.

> [!NOTE]
> Эти шаги подробно описываются в остальной части данного раздела. Они описаны в контексте развертывания Azure AD в топологии с отдельным лесом и без пользовательских правил синхронизации. Если используется топология с несколькими лесами, настроенными пользовательскими правилами синхронизации или промежуточным сервером, то необходимо соответствующим образом изменить действия.

### <a name="step-1-disable-sync-scheduler-and-verify-there-is-no-synchronization-in-progress"></a>Шаг 1. Отключение планировщика синхронизации и остановка синхронизации
Изменяя правила синхронизации, убедитесь, что синхронизация не выполняется, во избежание экспорта непреднамеренных изменений в Azure AD. Чтобы отключить встроенный планировщик синхронизации, сделайте следующее:

 1. Запустите сеанс PowerShell на сервере Azure AD Connect.

 2. Отключите плановую синхронизацию, выполнив командлет: `Set-ADSyncScheduler -SyncCycleEnabled $false`
 
 3. Запустите **Synchronization Service Manager**, выбрав "Пуск → Служба синхронизации".
 
 4. Перейдите на вкладку **операций** и убедитесь, что на ней не отображаются операции в состоянии *Выполняется*.

![Synchronization Service Manager: проверка наличия выполняющихся операций](./media/active-directory-aadconnectsync-change-the-configuration/preferredDataLocation-step1.png)

### <a name="step-2-add-the-source-attribute-to-the-on-premises-ad-connector-schema"></a>Шаг 2. Добавление исходного атрибута в схему локального соединителя AD
Не все атрибуты AD импортируются в пространство локального соединителя AD. Чтобы добавить исходный атрибут в список импортируемых атрибутов, сделайте следующее.

 1. Откройте вкладку **Connectors** (Соединители) в Synchronization Service Manager.
 
 2. Щелкните правой кнопкой мыши **локальный соединитель AD** и выберите **Properties** (Свойства).
 
 3. Во всплывающем диалоговом окне перейдите на вкладку **Select Attributes** (Выбор атрибутов).
 
 4. Убедитесь, что исходный атрибут выбран в списке атрибутов.
 
 5. Нажмите кнопку **OK**, чтобы сохранить изменения.

![Добавление исходного атрибута в схему локального соединителя AD](./media/active-directory-aadconnectsync-change-the-configuration/preferredDataLocation-step2.png)

### <a name="step-3-add-preferreddatalocation-to-the-azure-ad-connector-schema"></a>Шаг 3. Добавление PreferredDataLocation в схему соединителя Azure AD
По умолчанию атрибут PreferredDataLocation не импортируется в пространство Azure AD Connect. Вот как можно добавить атрибут PreferredDataLocation в список импортируемых атрибутов.

 1. Откройте вкладку **Connectors** (Соединители) в Synchronization Service Manager.

 2. Щелкните правой кнопкой мыши **соединитель Azure AD** и выберите **Properties** (Свойства).

 3. Во всплывающем диалоговом окне перейдите на вкладку **Select Attributes** (Выбор атрибутов).

 4. Убедитесь, что атрибут PreferredDataLocation выбран в списке атрибутов.

 5. Нажмите кнопку **OK**, чтобы сохранить изменения.

![Добавление исходного атрибута в схему соединителя Azure AD](./media/active-directory-aadconnectsync-change-the-configuration/preferredDataLocation-step3.png)

### <a name="step-4-create-an-inbound-synchronization-rule-to-flow-the-attribute-value-from-on-premises-active-directory"></a>Шаг 4. Создание правила входящей синхронизации для передачи значения атрибута из локального каталога Active Directory
Правило входящей синхронизации позволяет передавать значение исходного атрибута из локального каталога Active Directory в метавселенную.

1. Запустите **редактор правил синхронизации**, выбрав "Пуск → Редактор правил синхронизации".

2. В фильтре поиска для параметра **Направление** задайте значение **Входящие**.

3. Нажмите кнопку **Добавить правило**, чтобы создать правило входящей синхронизации.

4. На вкладке **Описание** укажите следующую конфигурацию.
 
    | Атрибут | Значение | Сведения |
    | --- | --- | --- |
    | Имя | *Укажите имя* | Например, *In from AD – User PreferredDataLocation*. |
    | Описание | *Укажите описание* |  |
    | Подключенная система | *Выберите локальный соединитель AD*. |  |
    | Тип объекта подключенной системы | **User** |  |
    | Тип объекта метавселенной | **Person** |  |
    | Тип связи | **Join** |  |
    | Приоритет | *Выберите число от 1 до 99*. | Значения 1–99 зарезервированы для настраиваемых правил синхронизации. Не выбирайте значение, которое используется в другом правиле синхронизации. |

5. Перейдите на вкладку **Scoping filter** (Фильтр области) и добавьте **отдельную группу фильтра области со следующим предложением**.
 
    | Атрибут | Оператор | Значение |
    | --- | --- | --- |
    | adminDescription | NOTSTARTWITH | Пользователь\_ | 
 
    Фильтр области определяет локальные объекты AD, к которым применяется данное правило входящей синхронизации. В этом примере мы используем тот же фильтр области, что и в правиле синхронизации OOB *In from AD – User Common*, который запрещает применять правило синхронизации к объектам User, созданным с помощью функции обратной записи пользователей Azure AD. Возможно, вам необходимо настроить фильтр области в соответствии с развертыванием Azure AD Connect.

6. Перейдите на вкладку **Преобразование** и реализуйте приведенное ниже правило преобразования.
 
    | Тип потока | Целевой атрибут | Источник | Применить однократно | "Merge Type" (Тип объединения) |
    | --- | --- | --- | --- | --- |
    | Напрямую | PreferredDataLocation | Выберите исходный атрибут. | Флажок снят. | Блокировка изменений |

7. Щелкните **Добавить**, чтобы создать правило входящей синхронизации.

![Создание правила входящей синхронизации](./media/active-directory-aadconnectsync-change-the-configuration/preferredDataLocation-step4.png)

### <a name="step-5-create-an-outbound-synchronization-rule-to-flow-the-attribute-value-to-azure-ad"></a>Шаг 5. Создание правила исходящей синхронизации для передачи значения атрибута в Azure AD
Правило исходящей синхронизации позволяет передать значение атрибута из метавселенной в атрибут PreferredDataLocation в Azure AD.

1. Перейдите в редактор **правил синхронизации**.

2. В фильтре поиска для параметра **Направление** задайте значение **Исходящие**.

3. Нажмите кнопку **Добавить правило**.

4. На вкладке **Описание** укажите следующую конфигурацию.

    | Атрибут | Значение | Сведения |
    | --- | --- | --- |
    | Имя | *Укажите имя* | Например, "Out to AAD – User PreferredDataLocation". |
    | Описание | *Укажите описание* |
    | Подключенная система | *Выберите соединитель AAD* |
    | Тип объекта подключенной системы | Пользователь ||
    | Тип объекта метавселенной | **Person** ||
    | Тип связи | **Join** ||
    | Приоритет | *Выберите число от 1 до 99*. | Значения 1–99 зарезервированы для настраиваемых правил синхронизации. Не выбирайте значение, которое используется в другом правиле синхронизации. |

5. Перейдите на вкладку **Scoping filter** (Фильтр области) и добавьте **отдельную группу фильтра области с двумя приведенными ниже предложениями**.
 
    | Атрибут | Оператор | Значение |
    | --- | --- | --- |
    | sourceObjectType | EQUAL | Пользователь |
    | cloudMastered | NOTEQUAL | Да |

    Фильтр области определяет объекты Azure AD, к которым применяется данное правило исходящей синхронизации. В этом примере мы используем фильтр области из правила синхронизации OOB "Out to AD – User Identity". Он предотвращает применение правила синхронизации к объектам User в локальном каталоге Active Directory, которые не синхронизируются. Возможно, вам необходимо настроить фильтр области в соответствии с развертыванием Azure AD Connect.
    
6. Перейдите на вкладку **Преобразование** и реализуйте приведенное ниже правило преобразования.

    | Тип потока | Целевой атрибут | Источник | Применить однократно | "Merge Type" (Тип объединения) |
    | --- | --- | --- | --- | --- |
    | Напрямую | PreferredDataLocation | PreferredDataLocation | Флажок снят. | Блокировка изменений |

7. Щелкните **Добавить**, чтобы создать правило исходящей синхронизации.

![Создание правила исходящей синхронизации](./media/active-directory-aadconnectsync-change-the-configuration/preferredDataLocation-step5.png)

### <a name="step-6-run-full-synchronization-cycle"></a>Шаг 6. Запуск полного цикла синхронизации
Как правило, полный цикл синхронизации обязателен, так как мы добавили новые атрибуты в схемы AD и соединителя Azure AD, а также ввели пользовательские правила синхронизации. Рекомендуется проверить изменения перед их экспортом в Azure AD. Можно следовать приведенным ниже инструкциям, чтобы проверить изменения во время ручного выполнения действий, составляющих полный цикл синхронизации. 

1. Выполните шаг **полного импорта** для **локального соединителя AD**.

   1. Откройте вкладку **Operations** (Операции) в Synchronization Service Manager.

   2. Щелкните правой кнопкой мыши **локальный соединитель AD** и выберите **Run** (Выполнить).

   3. Во всплывающем диалоговом окне выберите **Full Import** (Полный импорт) и нажмите кнопку **ОК**.
    
   4. Дождитесь завершения операции.

    > [!NOTE]
    > Можно пропустить полный импорт локального соединителя AD, если исходный атрибут уже включен в список импортируемых атрибутов. Другими словами, можно было не вносить изменения во время шага 2 [Добавление исходного атрибута в схему локального соединителя AD](#step-2-add-the-source-attribute-to-the-on-premises-ad-connector-schema).

2. Выполните шаг **полного импорта** для **соединителя Azure AD**.

   1. Щелкните правой кнопкой мыши **соединитель Azure AD** и выберите **Run** (Выполнить).

   2. Во всплывающем диалоговом окне выберите **Full Import** (Полный импорт) и нажмите кнопку **ОК**.
   
   3. Дождитесь завершения операции.

3. Проверьте изменения правила синхронизации на существующем объекте User.

Исходный атрибут из локального каталога Active Directory и атрибут PreferredDataLocation из Azure AD были импортированы в соответствующее пространство соединителя. Перед выполнением шага полной синхронизации рекомендуется выполнить **предварительный просмотр** существующего объекта User в пространстве локального соединителя AD. У выбранного объекта должен быть заполнен исходный атрибут. Если при **предварительном просмотре** атрибут PreferredDataLocation успешно заполнен, то это хороший показатель того, что вы верно настроили правила синхронизацию. Сведения о том, как выполнить **предварительный просмотр**, см. в разделе [Проверка изменений](#verify-the-change).

4. Выполните шаг **полной синхронизации** для **локального соединителя AD**.

   1. Щелкните правой кнопкой мыши **локальный соединитель AD** и выберите **Run** (Выполнить).
  
   2. Во всплывающем диалоговом окне выберите **Full Synchronization** (Полная синхронизация) и нажмите кнопку **ОК**.
   
   3. Дождитесь завершения операции.

5. Проверьте **ожидающие операции экспорта** в Azure AD.

   1. Щелкните правой кнопкой мыши **соединитель Azure AD** и выберите **Search Connector Space** (Поиск пространства соединителя).

   2. Во всплывающем диалоговом окне "Search Connector Space" (Поиск пространства соединителя) сделайте следующее.

      1. Для параметра **Scope** (Область) укажите значение **Pending Export** (Ожидающая операция экспорта).
      
      2. Установите все 3 флажка: **"Добавить", "Изменить" и "Удалить"**.
      
      3. Нажмите кнопку **Найти**, чтобы получить список объектов с изменениями для экспорта. Чтобы проверить изменения указанного объекта, дважды щелкните его.
      
      4. Убедитесь, что изменения являются ожидаемыми.

6. Выполните шаг **экспорта** для **соединителя Azure AD**.
      
   1. Щелкните правой кнопкой мыши **соединитель Azure AD** и выберите команду **Run** (Выполнить).
   
   2. Во всплывающем диалоговом окне "Run Connector" (Запуск соединителя) выберите **Экспорт** и нажмите кнопку **ОК**.
   
   3. Дождитесь завершения экспорта в Azure AD.

> [!NOTE]
> Вы можете заметить, что для соединителя Azure AD отсутствуют шаги полной синхронизации и экспорта. Они и не требуются, так как значения атрибутов передаются только из локального каталога Active Directory в Azure AD.

### <a name="step-7-re-enable-sync-scheduler"></a>Шаг 7. Повторное включение планировщика синхронизации
Повторно включите встроенный планировщик синхронизации.

1. Запустите сеанс PowerShell.

2. Повторно включите плановую синхронизацию, выполнив командлет: `Set-ADSyncScheduler -SyncCycleEnabled $true`



## <a name="next-steps"></a>Дальнейшие действия
* Дополнительные сведения о модели конфигурации, см. в статье о [принципах декларативной подготовки](active-directory-aadconnectsync-understanding-declarative-provisioning.md).
* Дополнительные сведения о языке выражений см. в статье [Служба синхронизации Azure AD Connect: общие сведения о выражениях декларативной подготовки](active-directory-aadconnectsync-understanding-declarative-provisioning-expressions.md).

**Обзорные статьи**

* [Службы синхронизации Azure AD Connect: общие сведений о синхронизации и ее настройка](active-directory-aadconnectsync-whatis.md)
* [Интеграция локальных удостоверений с Azure Active Directory](active-directory-aadconnect.md)

---
title: "Синхронизация Azure AD Connect: настройка фильтрации | Документация Майкрософт"
description: "В этой статье объясняется, как настроить фильтрацию в службах синхронизации Azure AD Connect."
services: active-directory
documentationcenter: 
author: billmath
manager: mtillman
editor: 
ms.assetid: 880facf6-1192-40e9-8181-544c0759d506
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/12/2017
ms.author: billmath
ms.openlocfilehash: 5af82e889a80994dd47d4fc3b89f8eece2201355
ms.sourcegitcommit: f1c1789f2f2502d683afaf5a2f46cc548c0dea50
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/18/2018
---
# <a name="azure-ad-connect-sync-configure-filtering"></a>Синхронизация Azure AD Connect: настройка фильтрации
Возможность фильтрации позволяет управлять тем, какие объекты локального каталога будут синхронизированы с Azure Active Directory (Azure AD). При конфигурации по умолчанию это все объекты во всех доменах настроенных лесов. Эта конфигурация является рекомендуемой в большинстве случаев. Пользователи системы Office 365, будь-то Exchange Online или Skype для бизнеса, могут использовать глобальный список адресов для отправки сообщений электронной почты и осуществления звонков по всем адресам. Использование конфигурации по умолчанию позволяет им работать так же, как и с локальным экземпляром Exchange или Lync.

Тем не менее в некоторых случаях в конфигурацию по умолчанию все же нужно внести некоторые изменения. Ниже приведены некоторые примеры:

* Если необходимо использовать [топологию с несколькими каталогами Azure AD](active-directory-aadconnect-topologies.md#each-object-only-once-in-an-azure-ad-tenant). В таком случае необходимо применить фильтр, чтобы выбрать, какие объекты следует синхронизировать с определенным каталогом Azure AD.
* Используется пилотная программа Azure или Office 365, и нужно синхронизировать с Azure AD только определенных пользователей. Если программа небольшого размера, всеми преимуществами можно воспользоваться и без глобального списка адресов.
* Если не нужно синхронизировать с Azure AD много учетных записей служб и других рабочих учетных записей.
* В целях обеспечения соответствия нельзя локально удалять учетные записи пользователей, но можно их отключить. Однако с Azure AD необходимо синхронизировать только активные учетные записи.

В этой статье описано, как настроить различные методы фильтрации.

> [!IMPORTANT]
> Мы поддерживаем изменение или использование служб синхронизации Azure AD Connect только в контексте официально задокументированных действий. Любые иные действия могут привести к несогласованному или неподдерживаемому состоянию служб синхронизации Azure AD Connect. Для таких развертываний Майкрософт не предоставляет техническую поддержку.

## <a name="basics-and-important-notes"></a>Основные сведения и важные примечания
В службах синхронизации Azure AD Connect фильтрацию можно включить в любое время. Если вы сначала настроили синхронизацию каталогов с параметрами по умолчанию, а затем настроили фильтрацию, отфильтрованные объекты больше не будут синхронизироваться с Azure AD. В результате этого изменения все объекты в Azure AD, которые ранее были синхронизированы, а затем отфильтрованы, будут удалены из Azure AD.

Прежде чем внести изменения в параметры фильтрации, [отключите запланированные задачи](#disable-scheduled-task), чтобы случайно не выполнить экспорт неправильно измененных данных.

Поскольку в результате фильтрации можно одновременно удалить множество объектов, прежде чем экспортировать измененные данные в Azure AD, следует убедиться в правильности настроенных фильтров. После выполнения необходимых шагов по настройке, прежде чем выполнить экспорт и внести изменения в Azure AD, настоятельно рекомендуется выполнить [шаги для проверки](#apply-and-verify-changes).

Функция [предотвращения случайного удаления](active-directory-aadconnectsync-feature-prevent-accidental-deletes.md) включена по умолчанию, что позволяет предотвратить случайное удаление множества объектов. При удалении объектов с использованием фильтрации (по умолчанию — 500) необходимо выполнить шаги, описанные в этой статье, чтобы удаление распространилось на Azure AD.

Если вы используете сборку, выпущенную до ноября 2015 года ([1.0.9125](active-directory-aadconnect-version-history.md#1091250)), при внесении изменений в конфигурацию фильтра, когда используется синхронизация паролей, необходимо запустить полную синхронизацию всех паролей после завершения настройки. Описание шагов по запуску полной синхронизации паролей см. в разделе [Запуск полной синхронизации всех паролей](active-directory-aadconnectsync-troubleshoot-password-synchronization.md#trigger-a-full-sync-of-all-passwords). Если вы используете сборку 1.0.9125 или более поздней версии, при выборе стандартного действия **полной синхронизации** можно задать, какие пароли следует синхронизировать, что лишает необходимости в дополнительном шаге.

Если объекты-**пользователи** случайно удалены в Azure AD в результате ошибки фильтрации, их можно воссоздать в этой службе, удалив настройки фильтрации. Затем можно снова синхронизировать каталоги. Это действие позволяет восстановить пользователей из корзины в Azure AD. Однако удаление объектов других типов отменить нельзя. Например, если вы случайно удалите группу безопасности, использованную в списках управления доступом к ресурсам, нельзя будет восстановить ни группу, ни соответствующие списки.

Azure AD Connect удаляет только те объекты, которые соответствуют фильтру. Объекты Azure AD, созданные в результате работы другого модуля синхронизации и не соответствующие фильтру, удалены не будут. Например, если изначально вы использовали сервер DirSync, который создал полную копию всего каталога в Azure AD, а затем установили новый сервер синхронизации Azure AD Connect и в начале его работы была включена фильтрация, то Azure AD Connect не удалит объекты, созданные DirSync.

При установке Azure AD Connect или обновлении до новой версии сохраняются все имеющиеся конфигурации. Перед выполнением первого цикла синхронизации мы настоятельно рекомендуем убедиться, что ваша конфигурация не была случайно изменена после обновления до новой версии.

При наличии нескольких лесов параметры фильтрации, описанные в этой статье, нужно применить к каждому из них (если у всех лесов должна быть одинаковая конфигурация).

### <a name="disable-the-scheduled-task"></a>Отключение запланированной задачи
Чтобы отключить встроенный планировщик, запускающий цикл синхронизации каждые 30 минут, выполните следующие действия.

1. Перейдите к командной строке PowerShell.
2. Запустите `Set-ADSyncScheduler -SyncCycleEnabled $False` , чтобы отключить планировщик.
3. Внесите изменения, описанные в этой статье.
4. Запустите `Set-ADSyncScheduler -SyncCycleEnabled $True` , чтобы снова включить планировщик.

**При использовании сборки Azure AD Connect до версии 1.1.105.0**  
Чтобы отключить запланированную задачу по запуску цикла синхронизации каждые три часа, сделайте следующее:

1. В меню **Пуск** запустите **планировщик задач**.
2. Прямо в каталоге **Библиотека планировщика заданий** найдите задачу с именем **Azure AD Sync Scheduler** (Планировщик синхронизации Azure AD Sync), щелкните ее правой кнопкой мыши и выберите пункт **Отключить**.  
   ![планировщик задач](./media/active-directory-aadconnectsync-configure-filtering/taskscheduler.png)  
3. Теперь можно внести изменения в конфигурацию и запустить модуль синхронизации вручную из консоли **Synchronization Service Manager**.

После внесения всех изменений в параметры фильтрации вернитесь обратно и снова выполните команду **Включить** для этой задачи.

## <a name="filtering-options"></a>Параметры фильтрации
В средстве синхронизации каталога можно настроить использование следующих типов конфигурации фильтрации:

* [**По группам.**](#group-based-filtering) Фильтрацию по одной группе можно настроить только при изначальной установке с помощью соответствующего мастера.
* [**По доменам.**](#domain-based-filtering) Этот параметр позволяет выбрать, какие домены следует синхронизировать с Azure AD. Также можно добавлять и удалять домены из модуля синхронизации при внесении изменений в локальную инфраструктуру после установки службы синхронизации Azure AD Connect.
* [**По подразделениям.**](#organizational-unitbased-filtering) Этот параметр позволяет выбрать, какие подразделения следует синхронизировать с Azure AD. Действие этого параметра распространяется на все типы объектов в выбранных подразделениях.
* [**По атрибутам.**](#attribute-based-filtering) Этот параметр позволяет фильтровать объекты по значениям атрибутов. Кроме того, для объектов различных типов можно использовать разные фильтры.

Можно также одновременно использовать несколько параметров фильтрации. Например, можно использовать фильтрацию по подразделению, чтобы включить объекты в одном подразделении, и одновременно фильтрацию по атрибуту, чтобы сузить круг результатов. При использовании нескольких методов фильтрации между фильтрами ставится логический оператор AND.

## <a name="domain-based-filtering"></a>Фильтрация по доменам
В этом разделе описана процедура настройки фильтра по доменам. Если вы установили Azure AD Connect, а затем добавили или удалили в лесу домены, вам также необходимо обновить конфигурацию фильтрации.

Для изменения фильтрации по доменам лучше всего запустить мастер установки и изменить [фильтрацию домена и подразделения](active-directory-aadconnect-get-started-custom.md#domain-and-ou-filtering). Мастер установки автоматизирует все описанные здесь задачи.

Выполнять эти действия вручную следует только в том случае, если мастер установки не удается запустить по какой-либо причине.

Настройка фильтрации по доменам предусматривает следующие шаги:

1. [Выберите домены](#select-domains-to-be-synchronized), которые следует задействовать при синхронизации.
2. Настройте [профили выполнения](#update-run-profiles)для каждого добавленного и удаленного домена.
3. [Примените и проверьте изменения](#apply-and-verify-changes).

### <a name="select-the-domains-to-be-synchronized"></a>Выбор доменов для синхронизации
Настройка фильтрации по доменам

1. Войдите на сервер, на котором запущена служба синхронизации Azure AD Connect, используя данные учетной записи участника группы безопасности **ADSyncAdmins** .
2. Запустите **службу синхронизации** из меню **Пуск**.
3. Щелкните **Соединители** и в списке **соединителей** выберите элемент типа **Доменные службы Active Directory**. В разделе **Действия** выберите **Свойства**.  
   ![Свойства соединителя](./media/active-directory-aadconnectsync-configure-filtering/connectorproperties.png)  
4. Щелкните **Настроить разделы каталога**.
5. В списке **Select directory partitions** (Выберите разделы каталога) выберите необходимые домены или отмените выбор. Должны быть выбраны только те разделы, которые следует синхронизировать.  
   ![Секции](./media/active-directory-aadconnectsync-configure-filtering/connectorpartitions.png)  
   Если вы изменили локальную инфраструктуру Active Directory и добавили или удалили домены в лесу, нажмите кнопку **Обновить**, чтобы получить обновленный список. Во время обновления будет предложено ввести учетные данные. Укажите учетные данные, с помощью которых можно получить доступ для чтения к Windows Server Active Directory. Убедитесь, что в этом диалоговом окне вы не используете предварительно заполненные данные пользователя.  
   ![Требуется обновление](./media/active-directory-aadconnectsync-configure-filtering/refreshneeded.png)  
6. Выполнив все действия, закройте диалоговое окно **Свойства**, нажав кнопку **ОК**. Если вы удалили домены из леса, появится всплывающее сообщение о том, что домен удален и конфигурация будет очищена.
7. Продолжите работу, чтобы настроить [профили выполнения](#update-run-profiles).

### <a name="update-the-run-profiles"></a>Обновление профилей выполнения
После обновления фильтра доменов нужно также изменить профили выполнения.

1. В списке **Соединители** выберите соединитель, настроенный на предыдущем шаге. В разделе **Действия** выберите **Configure Run Profiles** (Настроить профили выполнения).  
   ![Профили выполнения соединителя 1](./media/active-directory-aadconnectsync-configure-filtering/connectorrunprofiles1.png)  
2. Найдите и определите следующие профили:
    * полный импорт;
    * полная синхронизация;
    * импорт изменений;
    * синхронизация изменений;
    * экспорт.
3. Для каждого профиля настройте **добавленные** и **удаленные** домены.
    1. Выполните следующие действия для каждого из пяти профилей всех **добавленных** доменов:
        1. Выберите профиль выполнения и щелкните **Новый шаг**.
        2. На странице **Configure Step** (Настройка шага) в раскрывающемся меню **Тип** выберите тип шага с тем же именем, что и у настраиваемого профиля. Нажмите кнопку **Далее**.  
        ![Профили выполнения соединителя 2](./media/active-directory-aadconnectsync-configure-filtering/runprofilesnewstep1.png)  
        3. На странице **Connector Configuration** (Настройка соединителя) в раскрывающемся списке **Раздел** выберите имя домена, добавленного в фильтр доменов.  
        ![Профили выполнения соединителя 3](./media/active-directory-aadconnectsync-configure-filtering/runprofilesnewstep2.png)  
        4. Чтобы закрыть диалоговое окно **Configure Run Profile** (Настройка профиля выполнения), нажмите кнопку **Готово**.
    2. Выполните следующие действия для каждого из пяти профилей всех **удаленных** доменов:
        1. Выберите профиль выполнения.
        2. Если для атрибута **Раздел** в поле **Значение** указан GUID, то выберите шаг выполнения и нажмите кнопку **Удалить шаг**.  
        ![Профили выполнения соединителя 4](./media/active-directory-aadconnectsync-configure-filtering/runprofilesdeletestep.png)  
    3. Проверьте внесенные изменения. Каждый домен, который нужно синхронизировать, должен быть указан в качестве шага в каждом профиле выполнения.
4. Чтобы закрыть диалоговое окно **Configure Run Profiles** (Настройка профилей выполнения), нажмите кнопку **ОК**.
5.  Чтобы завершить настройку, необходимо выполнить **полный импорт** и **разностную синхронизацию**. Вернитесь к чтению раздела [Применение и проверка изменений](#apply-and-verify-changes).

## <a name="organizational-unitbased-filtering"></a>Фильтрация по подразделениям
Для изменения фильтрации по подразделениям лучше всего запустить мастер установки и изменить [фильтрацию по доменам и подразделениям](active-directory-aadconnect-get-started-custom.md#domain-and-ou-filtering). Мастер установки автоматизирует все описанные здесь задачи.

Выполнять эти действия вручную следует только в том случае, если мастер установки не удается запустить по какой-либо причине.

Чтобы настроить фильтрацию по подразделениям, сделайте следующее:

1. Войдите на сервер, на котором запущена служба синхронизации Azure AD Connect, используя данные учетной записи участника группы безопасности **ADSyncAdmins** .
2. Запустите **службу синхронизации** из меню **Пуск**.
3. Щелкните **Соединители** и в списке **соединителей** выберите элемент типа **Доменные службы Active Directory**. В разделе **Действия** выберите **Свойства**.  
   ![Свойства соединителя](./media/active-directory-aadconnectsync-configure-filtering/connectorproperties.png)  
4. Щелкните **Configure Directory Partitions** (Настроить разделы каталога), выберите домен, который нужно настроить, а затем щелкните **Контейнеры**.
5. Когда отобразится запрос, укажите учетные данные, с помощью которых можно получить доступ для чтения к локальному экземпляру Active Directory. Убедитесь, что в этом диалоговом окне вы не используете предварительно заполненные данные пользователя.
6. В диалоговом окне **Select Containers** (Выбор контейнеров) удалите подразделения, которые не нужно синхронизировать с облачным каталогом, и нажмите кнопку **ОК**.  
   ![Подразделения в диалоговом окне Select Containers (Выбор контейнеров)](./media/active-directory-aadconnectsync-configure-filtering/ou.png)  
   * Чтобы синхронизация компьютеров Windows 10 с Azure AD прошла успешно, должен быть установлен флажок для контейнера **Компьютеры** . Если компьютеры, присоединенные к домену, находятся в других подразделениях, выберите соответствующие подразделения.
   * При наличии нескольких доверенных лесов должен быть установлен флажок для контейнера **ForeignSecurityPrincipals** . Этот контейнер позволяет разрешить членство в группе безопасности между лесами.
   * Если включена функция обратной записи устройств, должен быть установлен флажок для подразделения **RegisteredDevices**. Если используется другая функция обратной записи, такая как обратная запись группы, выберите соответствующие расположения.
   * Выберите все подразделения, к которым принадлежат объекты контейнеров «Пользователи», iNetOrgPersons, «Группы», «Контакты» и «Компьютеры». На рисунке показано, что все они находятся в подразделении ManagedObjects.
   * При использовании фильтрации на основе группы подразделение, где находится группа, должно быть включено.
   * Обратите внимание, что можно настроить, следует ли синхронизировать новые подразделения, добавленные после завершения настройки фильтрации. подробности приведены в следующем разделе.
7. Выполнив все действия, закройте диалоговое окно **Свойства**, нажав кнопку **ОК**.
8. Чтобы завершить настройку, необходимо выполнить **полный импорт** и **разностную синхронизацию**. Вернитесь к чтению раздела [Применение и проверка изменений](#apply-and-verify-changes).

### <a name="synchronize-new-ous"></a>Синхронизация новых подразделений
Новые подразделения, созданные после настройки фильтрации, синхронизируются по умолчанию. Это состояние обозначается установленным флажком. С некоторых подразделений можно снять флажки. Для этого щелкайте поле, пока оно не станет белым и не будет содержать синий флажок (состояние по умолчанию). Затем снимите флажки для подразделений, которые не нужно синхронизировать.

Если синхронизируются все отделы, поле будет белым с синим флажком.  
![Подразделение со всеми установленными флажками](./media/active-directory-aadconnectsync-configure-filtering/ousyncnewall.png)

Если некоторые отделы не были выбраны, то поля будут серыми с белым флажком.  
![Подразделение, где не выбраны некоторые отделы](./media/active-directory-aadconnectsync-configure-filtering/ousyncnew.png)

С этой конфигурацией новое подразделение, созданное в ManagedObjects, синхронизируется.

Мастер установки Azure AD Connect всегда создает такую конфигурацию.

### <a name="dont-synchronize-new-ous"></a>Как не синхронизировать новые подразделения
В модуле синхронизации можно настроить так, чтобы он не синхронизировал новые подразделения после завершения настройки фильтрации. При таком состоянии в пользовательском интерфейсе поле будет полностью серое и без флажка. Для этого щелкайте поле, пока оно не станет белым без флажка. Затем выберите подразделения, которые требуется синхронизировать.

![Подразделение, где снят корневой флажок](./media/active-directory-aadconnectsync-configure-filtering/oudonotsyncnew.png)

С этой конфигурацией синхронизируется новое подразделение, созданное в ManagedObjects.

## <a name="attribute-based-filtering"></a>Фильтрация по атрибутам
Прежде чем выполнить следующие действия, убедитесь, что вы используете сборку, выпущенную в ноябре 2015 г. ([1.0.9125](active-directory-aadconnect-version-history.md#1091250)), или более поздней версии.

Фильтрация на основе атрибутов — самый гибкий способ отфильтровать объекты. Чтобы контролировать все аспекты, касающиеся времени синхронизации объектов с Azure AD, можно использовать функцию [декларативной подготовки](active-directory-aadconnectsync-understanding-declarative-provisioning.md).

Фильтрацию можно применять ко [входящим](#inbound-filtering) объектам из Active Directory в метавселенной и к [исходящим](#outbound-filtering) объектам из метавселенной в Azure AD. Мы рекомендуем использовать самый простой метод фильтрации — по входящим объектам. Фильтрацию по исходящим объектам следует использовать, только если это необходимо для присоединения объектов из нескольких лесов, чтобы выполнить оценку.

### <a name="inbound-filtering"></a>Фильтрация входящих объектов
Для фильтрации по входящим объектам используется конфигурация по умолчанию: для атрибута метавселенной cloudFiltered синхронизируемых объектов, которые передаются в Azure AD, не задано значение. Если для атрибута задано значение **True**, то объект не синхронизируется. Для этого параметра не следует устанавливать значение **False**. Чтобы можно было передавать значение с помощью других правил, у этого атрибута должно быть значение **True** или **NULL** (значение отсутствует).

Для фильтрации по входящим объектам мы будем использовать **область**, чтобы определить, какие объекты следует или не следует синхронизировать. Эта процедура предназначена для внесения изменений в соответствии с требованиями вашей организации. Модуль области использует **группу** и **предложение**, чтобы определить, распространяется ли правило синхронизации на область. В группе может содержаться одно или несколько предложений. Если предложений несколько, в качестве их разделителя используется логический оператор AND, а при наличии нескольких групп — оператор OR.

Вот пример.  
![Область](./media/active-directory-aadconnectsync-configure-filtering/scope.png)  
Его следует рассматривать так: **(department = IT) OR (department = Sales AND c = US)**.

В следующих образцах кода и шагах в качестве примера используется объект-пользователь, но их можно использовать для объектов любого типа.

В следующих примерах значение приоритета начинается с 50. Это может быть любое число меньше 100, которое еще не используется.

#### <a name="negative-filtering-do-not-sync-these"></a>Отрицательная фильтрация (выбор объектов, которые не следует синхронизировать)
В примере ниже отфильтруем (но не синхронизируем) всех пользователей для атрибута **extensionAttribute15** с заданным значением **NoSync**.

1. Войдите на сервер, на котором запущена служба синхронизации Azure AD Connect, используя данные учетной записи участника группы безопасности **ADSyncAdmins** .
2. В меню **Пуск** запустите **редактор правил синхронизации**.
3. Выберите параметр **Входящие** и щелкните **Add New Rule** (Добавить новое правило).
4. Задайте для правила описательное имя, например *In from AD – User DoNotSyncFilter*. Выберите правильный лес, значение **Пользователь** для параметра **CS object type** (Тип объекта CS) и **Person** (Человек) для параметра **MV object type** (Тип объекта MV). В поле **Тип связи** выберите **Join** (Присоединение). В поле **Приоритет** введите значение, которое не используется в другом правиле синхронизации (например, 50), и нажмите кнопку **Далее**.  
   ![Описание входящего объекта 1](./media/active-directory-aadconnectsync-configure-filtering/inbound1.png)  
5. В поле **Scoping filter** (Фильтр области действия) выберите **Добавить группу** и щелкните **Добавить предложение**. В поле **Атрибут** выберите **ExtensionAttribute15**. В качестве **оператора** выберите **EQUAL** и в поле **Значение** введите **NoSyn**. Нажмите кнопку **Далее**.  
   ![Область входящего объекта 2](./media/active-directory-aadconnectsync-configure-filtering/inbound2.png)  
6. Оставьте **правила объединения** (Join rules) пустыми и нажмите кнопку **Далее**.
7. Щелкните **Add Transformation** (Добавить преобразование), для параметра **FlowType** (Тип потока) выберите значение **Константа**, а для параметра **Целевой атрибут** — значение **cloudFiltered**. В текстовом поле **Источник** введите значение **True**. Щелкните **Добавить** , чтобы сохранить правило.  
   ![Преобразование входящего объекта 3](./media/active-directory-aadconnectsync-configure-filtering/inbound3.png)
8. Чтобы завершить настройку, необходимо выполнить **полную синхронизацию**. Вернитесь к чтению раздела [Применение и проверка изменений](#apply-and-verify-changes).

#### <a name="positive-filtering-only-sync-these"></a>Положительная фильтрация (выбор объектов, которые нужно синхронизировать)
Настройка положительной фильтрации может оказаться более сложной задачей, так как нужно учесть объекты, для которых необходимость синхронизации не очевидна, например конференц-залы. Необходимо также переопределить фильтр по умолчанию в стандартном правиле **In from AD - User Join**. При создании пользовательского фильтра убедитесь, что он не включает в себя критически важные системные объекты, конфликтующие объекты репликации, специальные почтовые ящики и учетные записи служб для Azure AD Connect.

Использование параметра положительной фильтрации требует настройки двух правил синхронизации. В одном правиле (но их может быть несколько) следует учесть правильную область объектов, которые нужно синхронизировать, а другое правило должно быть универсальным, чтобы отсеять все объекты, не соответствующие объектам, подлежащим синхронизации.

В примере ниже синхронизируем только объекты-пользователи, у которых для атрибута department задано значение **Sales**.

1. Войдите на сервер, на котором запущена служба синхронизации Azure AD Connect, используя данные учетной записи участника группы безопасности **ADSyncAdmins** .
2. В меню **Пуск** запустите **редактор правил синхронизации**.
3. Выберите параметр **Входящие** и щелкните **Add New Rule** (Добавить новое правило).
4. Задайте для правила описательное имя, например *In from AD – User Sales sync*. Выберите правильный лес, значение **Пользователь** для параметра **CS object type** (Тип объекта CS) и **Person** (Человек) для параметра **MV object type** (Тип объекта MV). В поле **Тип связи** выберите **Join** (Присоединение). В поле **Приоритет** введите значение, которое не используется в другом правиле синхронизации (например, 51), и нажмите кнопку **Далее**.  
   ![Описание входящего объекта 4](./media/active-directory-aadconnectsync-configure-filtering/inbound4.png)  
5. В поле **Scoping filter** (Фильтр области действия) выберите **Добавить группу** и щелкните **Добавить предложение**. В разделе **Атрибут** выберите **department**. В качестве оператора выберите **EQUAL**, а в поле **Значение** введите **Sales**. Нажмите кнопку **Далее**.  
   ![Область входящего объекта 5](./media/active-directory-aadconnectsync-configure-filtering/inbound5.png)  
6. Оставьте **правила объединения** (Join rules) пустыми и нажмите кнопку **Далее**.
7. Щелкните **Add Transformation** (Добавить преобразование), для параметра **FlowType** (Тип потока) выберите значение **Константа**, а для параметра **Целевой атрибут** — значение **sourceObjectType**. В поле **Источник** введите значение **False**. Щелкните **Добавить** , чтобы сохранить правило.  
   ![Преобразование входящего объекта 6](./media/active-directory-aadconnectsync-configure-filtering/inbound6.png)  
   Это особый случай, когда явно требуется задать для параметра cloudFiltered значение **False**.
8. Теперь универсальное правило синхронизации создано. Задайте для правила описательное имя, например*In from AD — User Catch-all filter*. Выберите правильный лес, значение **Пользователь** для параметра **CS object type** (Тип объекта CS) и **Person** (Человек) для параметра **MV object type** (Тип объекта MV). В поле **Тип связи** выберите **Join** (Присоединение). В поле **Приоритет** введите значение, которое не используется в другом правиле синхронизации (например, 99). Выбрано значение приоритета выше (с низшим приоритетом), чем у предыдущего правила синхронизации, но мы оставили интервал между этими значениями, чтобы в дальнейшем можно было добавить дополнительные правила фильтрации для синхронизации, если нужно будет дополнительно синхронизировать отделы. Нажмите кнопку **Далее**.  
   ![Описание входящего объекта 7](./media/active-directory-aadconnectsync-configure-filtering/inbound7.png)  
9. Оставьте поле **Scoping filter** (Фильтр области) пустым и нажмите кнопку **Далее**. Если поле фильтра пустое, правило применяется ко всем объектам.
10. Оставьте **правила объединения** (Join rules) пустыми и нажмите кнопку **Далее**.
11. Щелкните **Add Transformation** (Добавить преобразование), выберите значение **Константа** в качестве параметра **FlowType** (Тип потока) и **cloudFiltered** для параметра **Целевой атрибут**. В поле **Источник** введите значение **True**. Щелкните **Добавить** , чтобы сохранить правило.  
    ![Преобразование входящего объекта 3](./media/active-directory-aadconnectsync-configure-filtering/inbound3.png)  
12. Чтобы завершить настройку, необходимо выполнить **полную синхронизацию**. Вернитесь к чтению раздела [Применение и проверка изменений](#apply-and-verify-changes).

При необходимости можно создать дополнительные правила первого типа в примере, к которому мы добавляли объекты для синхронизации.

### <a name="outbound-filtering"></a>Фильтрация исходящих объектов
В некоторых случаях фильтрацию необходимо выполнять только после объединения объектов в метавселенной. Например, определение объектов для синхронизации может выполняться на основе атрибута mail из леса ресурсов и атрибута userPrincipalName из леса учетных записей. В таких случаях нужно создать фильтр на основе исходящего правила.

В примере ниже мы изменим фильтрацию так, чтобы синхронизировались только пользователи, значения атрибутов mail и userPrincipalName которых заканчиваются на @contoso.com.

1. Войдите на сервер, на котором запущена служба синхронизации Azure AD Connect, используя данные учетной записи участника группы безопасности **ADSyncAdmins** .
2. В меню **Пуск** запустите **редактор правил синхронизации**.
3. В разделе **Rules Type** (Тип правил) выберите **Outbound** (Исходящие).
4. В зависимости от используемой версии Connect, найдите правило **Out to AAD — User Join** или **Out to AAD — User Join SOAInAD** и нажмите кнопку **Изменить**.
5. Во всплывающем окне нажмите кнопку **Да** , чтобы создать копию правила.
6. На странице **Описание** измените **приоритет**, установив неиспользуемое значение, например 50.
7. В области навигации слева щелкните **Scoping filter** (Фильтр области), а затем щелкните **Добавить предложение**. В разделе **Атрибут** выберите **mail**. В разделе **Оператор** выберите **ENDSWITH**. В разделе **Значение** введите **@contoso.com**, а затем щелкните **Добавить предложение**. В разделе **Атрибут** выберите **userPrincipalName**. В разделе **Оператор** выберите **ENDSWITH**. В разделе **Значение** введите **@contoso.com**.
8. Выберите команду **Сохранить**.
9. Чтобы завершить настройку, необходимо выполнить **полную синхронизацию**. Вернитесь к чтению раздела [Применение и проверка изменений](#apply-and-verify-changes).

## <a name="apply-and-verify-changes"></a>Примените и проверьте изменения
После внесения изменений в конфигурацию их необходимо применить к объектам, которые уже есть в системе. Кроме того, могут быть объекты, которые отсутствуют в модуле синхронизации, но их нужно обработать. Для этого модулю синхронизации нужно еще раз выполнить чтение из исходной системы, чтобы проверить ее содержимое.

Если для изменения конфигурации вы использовали фильтрацию по **доменам** или **подразделениям**, необходимо выполнить **полный импорт**, а затем **синхронизацию изменений**.

Если для изменения конфигурации использовалась фильтрация по **атрибутам**, необходимо выполнить **полную синхронизацию**.

Сделайте следующее:

1. Запустите **службу синхронизации** из меню **Пуск**.
2. Выберите **Соединители**. В списке **соединителей** выберите элемент, конфигурация которого ранее была изменена. В разделе **Действия** выберите **Запуск**.  
   ![Выполнение соединителя](./media/active-directory-aadconnectsync-configure-filtering/connectorrun.png)  
3. В разделе **Run profiles** (Профили выполнения) выберите операцию, о которой шла речь в предыдущем разделе. Если необходимо выполнить два действия, запустите второе после завершения первого (в столбце **Состояние** выбранного соединителя должно быть указано **Неактивно**).

После запуска синхронизации будут экспортированы все изменения. Прежде чем применить изменения напрямую в Azure AD, следует проверить их правильность.

1. Откройте командную строку и перейдите в каталог `%Program Files%\Microsoft Azure AD Sync\bin`.
2. Запустите `csexport "Name of Connector" %temp%\export.xml /f:x`.  
   Имя соединителя можно найти в службе синхронизации. Это будет имя наподобие "contoso.com — AAD" для Azure AD.
3. Запустите `CSExportAnalyzer %temp%\export.xml > %temp%\export.csv`.
4. Теперь у вас в папке %temp% есть файл export.csv, который можно просмотреть в Microsoft Excel. Этот файл содержит все изменения, которые будут экспортированы.
5. Внесите необходимые изменения в данные и конфигурацию, а затем выполните описанные выше действия (импорт, синхронизация и проверка) повторно, чтобы привести изменения, которые предстоит экспортировать, в нужный вид.

После выполнения этих действий экспортируйте изменения в Azure AD.

1. Выберите **Соединители**. В списке **соединителей** выберите соединитель Azure AD. В разделе **Действия** выберите **Запуск**.
2. В разделе **Run profiles** (Профили выполнения) выберите **Экспорт**.
3. Если в результате изменения конфигурации будет удалено слишком много объектов, вы увидите ошибку во время экспорта, если их количество превышает пороговое значение (по умолчанию — 500). В случае возникновения ошибки необходимо временно отключить функцию [предотвращения случайного удаления](active-directory-aadconnectsync-feature-prevent-accidental-deletes.md).

Теперь можно снова включить планировщик.

1. В меню **Пуск** запустите **планировщик задач**.
2. Прямо в каталоге **Библиотека планировщика заданий** найдите задачу с именем **Azure AD Sync Scheduler** (Планировщик синхронизации Azure AD Sync), щелкните ее правой кнопкой мыши и выберите пункт **Включить**.

## <a name="group-based-filtering"></a>Фильтрация на основе группы
Фильтрацию на основе группы можно настроить при первоначальной установке Azure AD Connect, если выбран вариант [выборочной установки](active-directory-aadconnect-get-started-custom.md#sync-filtering-based-on-groups). Она предназначена для пилотного развертывания, в котором должно синхронизироваться только небольшое количество объектов. После отключения фильтрацию на основе группы невозможно будет включить заново. *Не поддерживается* использование фильтрации на основе группы в настраиваемой конфигурации. Эту функцию можно настроить только с помощью мастера установки. После завершения пилотного проекта следует использовать какой-либо другой метод фильтрации, описанный в этой статье. Если вы используете фильтрацию по подразделениям в сочетании с фильтрацией по группам, следует включить подразделения, содержащие группы и их участников.

При синхронизации нескольких лесов AD можно настроить фильтрацию по группам, указав отдельные группы для каждого соединителя AD. Если нужно синхронизировать пользователя в одном лесу AD и у этого пользователя есть несколько соответствующих объектов в других лесах AD, необходимо убедиться, что на объект пользователя и все соответствующие объекты распространяется фильтрация на основе групп. Примеры приведены ниже.

* У пользователя в одном лесу имеется соответствующий объект FSP (внешний субъект безопасности) в другом лесу. На оба объекта должна распространяться фильтрация на основе групп. В противном случае пользователь не будет синхронизирован с Azure AD.

* У пользователя в одном лесу имеется соответствующая учетная запись ресурса (например, связанный почтовый ящик) в другом лесу. Кроме того, вы настроили Azure AD Connect, чтобы связать данного пользователя с этой учетной записью ресурса. На оба объекта должна распространяться фильтрация на основе групп. В противном случае пользователь не будет синхронизирован с Azure AD.

* У пользователя в одном лесу имеется соответствующий почтовый контакт в другом лесу. Кроме того, вы настроили Azure AD Connect, чтобы связать данного пользователя с эти почтовым контактом. На оба объекта должна распространяться фильтрация на основе групп. В противном случае пользователь не будет синхронизирован с Azure AD.


## <a name="next-steps"></a>Дополнительная информация
- Сведения о настройке службы синхронизации Azure AD Connect см. в [этой статье](active-directory-aadconnectsync-whatis.md).
- Сведения об интеграции локальных удостоверений с Azure Active Directory см. в [этой статье](active-directory-aadconnect.md).

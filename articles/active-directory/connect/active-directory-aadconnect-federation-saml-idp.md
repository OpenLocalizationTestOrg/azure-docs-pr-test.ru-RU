---
title: "Azure AD Connect: использование поставщика удостоверений SAML 2.0 для единого входа | Документы Майкрософт"
description: "В этом разделе описывается использование поставщика удостоверений, совместимого с SAML 2.0, для единого входа."
services: active-directory
author: billmath
manager: femila
ms.custom: it-pro
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/13/2017
ms.author: billmath
ms.openlocfilehash: 048697f87383662506fb851bb3ea510c2cddf043
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
#  <a name="use-a-saml-20-identity-provider-idp-for-single-sign-on"></a><span data-ttu-id="ef1ed-103">Использование поставщика удостоверений (IdP) SAML 2.0 для единого входа</span><span class="sxs-lookup"><span data-stu-id="ef1ed-103">Use a SAML 2.0 Identity Provider (IdP) for Single Sign On</span></span>

<span data-ttu-id="ef1ed-104">В этом разделе содержатся сведения об использовании поставщика удостоверений на основе профилей SP-Lite, совместимого с SAML 2.0, в качестве предпочитаемой службы токенов безопасности (STS) или поставщика удостоверений.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-104">This topic contains information on using a SAML 2.0 compliant SP-Lite profile based Identity Provider as the preferred Security Token Service (STS) / identity provider.</span></span> <span data-ttu-id="ef1ed-105">Это полезно при наличии локального каталога пользователей и хранилища паролей, доступ к которым возможен с помощью SAML 2.0.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-105">This is useful where you already have a user directory and password store on-premises that can be accessed using SAML 2.0.</span></span> <span data-ttu-id="ef1ed-106">Существующий каталог пользователей может использоваться для единого входа в Office 365 и другие ресурсы, защищенные с помощью Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-106">This existing user directory can be used for sign-on to Office 365 and other Azure AD-secured resources.</span></span> <span data-ttu-id="ef1ed-107">Профиль SAML 2.0 SP-Lite основан на широко использующемся стандарте федеративных удостоверений SAML (Security Assertion Markup Language) для предоставления единого входа и структуры обмена атрибутами.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-107">The SAML 2.0 SP-Lite profile is based on the widely used Security Assertion Markup Language (SAML) federated identity standard to provide a sign-on and attribute exchange framework.</span></span>

>[!NOTE]
><span data-ttu-id="ef1ed-108">Перечень сторонних поставщиков удостоверений, проверенных для использования в Azure AD см. в [списке совместимости с федерацией Azure AD](active-directory-aadconnect-federation-compatibility.md).</span><span class="sxs-lookup"><span data-stu-id="ef1ed-108">For a list of 3rd party Idps that have been tested for use with Azure AD see the [Azure AD federation compatibility list](active-directory-aadconnect-federation-compatibility.md)</span></span>

<span data-ttu-id="ef1ed-109">Корпорация Майкрософт поддерживает систему единого входа путем интеграции облачной службы Майкрософт, например Office 365, с правильно настроенным поставщиком удостоверений на основе профилей SAML 2.0.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-109">Microsoft supports this sign-on experience as the integration of a Microsoft cloud service, such as Office 365, with your properly configured SAML 2.0 profile based IdP.</span></span> <span data-ttu-id="ef1ed-110">Поставщики удостоверений SAML 2.0 — это сторонние продукты, поэтому корпорация Майкрософт не оказывает поддержку по развертыванию, настройке, устранению неполадок и предоставлению рекомендаций, касающихся их.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-110">SAML 2.0 identity providers are third-party products and therefore Microsoft does not provide support for the deployment, configuration, troubleshooting best practices regarding them.</span></span> <span data-ttu-id="ef1ed-111">После настройки интеграции с поставщиком удостоверений SAML 2.0 ее правильность можно протестировать с помощью анализатора подключений Майкрософт, который подробно описывается ниже.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-111">Once properly configured, the integration with the SAML 2.0 identity provider can be tested for proper configuration by using the Microsoft Connectivity Analyzer Tool which is described in more detail below.</span></span> <span data-ttu-id="ef1ed-112">Для получения дополнительных сведений о своем поставщике удостоверений на основе профилей SAML 2.0 SP-Lite обратитесь в предоставившую его организацию.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-112">For more information about your SAML 2.0 SP-Lite profile based identity provider, ask the organization that supplied it.</span></span>

>[!IMPORTANT]
><span data-ttu-id="ef1ed-113">В этом сценарии единого входа с помощью поставщиков удостоверений SAML 2.0 доступен только ограниченный набор клиентов, в число которых входят приведенные далее.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-113">Only a limited set of clients are available in this sign-on scenario with SAML 2.0 identity providers, this includes:</span></span>

>- <span data-ttu-id="ef1ed-114">Веб-клиенты, такие как Outlook Web Access и SharePoint Online</span><span class="sxs-lookup"><span data-stu-id="ef1ed-114">Web-based clients such as Outlook Web Access and SharePoint Online</span></span>
- <span data-ttu-id="ef1ed-115">Полнофункциональные почтовые клиенты, использующие базовую проверку подлинности и поддерживаемый метод доступа Exchange, такой как IMAP, POP, Active Sync, MAPI и т. д. (требуется развертывание конечной точки расширенного клиентского протокола), включая следующие:</span><span class="sxs-lookup"><span data-stu-id="ef1ed-115">Email-rich clients that use basic authentication and a supported Exchange access method such as IMAP, POP, Active Sync, MAPI, etc. (the Enhanced Client Protocol end point is required to be deployed), including:</span></span>
    - <span data-ttu-id="ef1ed-116">Microsoft Outlook 2010/Outlook 2013/Outlook 2016, Apple iPhone (различные версии iOS);</span><span class="sxs-lookup"><span data-stu-id="ef1ed-116">Microsoft Outlook 2010/Outlook 2013/Outlook 2016, Apple iPhone (various iOS versions)</span></span>
    - <span data-ttu-id="ef1ed-117">различные устройства Google Android;</span><span class="sxs-lookup"><span data-stu-id="ef1ed-117">Various Google Android Devices</span></span>
    - <span data-ttu-id="ef1ed-118">Windows Phone 7, Windows Phone 7.8 и Windows Phone 8.0;</span><span class="sxs-lookup"><span data-stu-id="ef1ed-118">Windows Phone 7, Windows Phone 7.8, and Windows Phone 8.0</span></span>
    - <span data-ttu-id="ef1ed-119">почтовый клиент Windows 8 и Windows 8.1;</span><span class="sxs-lookup"><span data-stu-id="ef1ed-119">Windows 8 Mail Client and Windows 8.1 Mail Client</span></span>
    - <span data-ttu-id="ef1ed-120">почтовый клиент Windows 10.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-120">Windows 10 Mail Client</span></span>

<span data-ttu-id="ef1ed-121">Все остальные клиенты не поддерживаются в сценарии единого входа с помощью поставщика удостоверений SAML 2.0.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-121">All other clients are not available in this sign-on scenario with your SAML 2.0 Identity Provider.</span></span> <span data-ttu-id="ef1ed-122">Например, клиент Lync 2010 для настольных ПК не сможет войти в службу с помощью поставщика удостоверений SAML 2.0, настроенного для единого входа.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-122">For example, the Lync 2010 desktop client is not able to login into the service with your SAML 2.0 Identity Provider configured for single sign-on.</span></span>

## <a name="azure-ad-saml-20-protocol-requirements"></a><span data-ttu-id="ef1ed-123">Требования Azure AD к протоколу SAML 2.0</span><span class="sxs-lookup"><span data-stu-id="ef1ed-123">Azure AD SAML 2.0 protocol requirements</span></span>
<span data-ttu-id="ef1ed-124">В этом разделе подробно описываются требования к протоколу и формату сообщений, которые поставщик удостоверений SAML 2.0 должен выполнять для федерации с Azure AD с целью обеспечения единого входа в одну или несколько облачных служб Майкрософт (таких как Office 365).</span><span class="sxs-lookup"><span data-stu-id="ef1ed-124">This topic contains detailed requirements on the protocol and message formatting that your SAML 2.0 identity provider must implement to federate with Azure AD to enable sign-on to one or more Microsoft cloud services (such as Office 365).</span></span> <span data-ttu-id="ef1ed-125">Проверяющей стороной SAML 2.0 (SP-STS) для облачной службы Майкрософт в этом сценарии является Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-125">The SAML 2.0 relying party (SP-STS) for a Microsoft cloud service used in this scenario is Azure AD.</span></span>

<span data-ttu-id="ef1ed-126">Рекомендуется обеспечить максимальную схожесть выходных сообщений поставщика удостоверений SAML 2.0 с предоставленными образцами трассировки.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-126">It is recommended that you ensure your SAML 2.0 identity provider output messages be as similar to the provided sample traces as possible.</span></span> <span data-ttu-id="ef1ed-127">Кроме того, по возможности используйте значения атрибутов из предоставленных метаданных Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-127">Also, use specific attribute values from the supplied Azure AD metadata where possible.</span></span> <span data-ttu-id="ef1ed-128">Добившись требуемых выходных сообщений, проведите тестирование с помощью анализатора подключений Майкрософт, как описано ниже.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-128">Once you are happy with your output messages, you can test with the Microsoft Connectivity Analyzer as described below.</span></span>

<span data-ttu-id="ef1ed-129">Метаданные Azure AD можно скачать по следующему URL-адресу: [https://nexus.microsoftonline-p.com/federationmetadata/saml20/federationmetadata.xml](http://https://nexus.microsoftonline-p.com/federationmetadata/saml20/federationmetadata.xml).</span><span class="sxs-lookup"><span data-stu-id="ef1ed-129">The Azure AD metadata can be downloaded from this URL: [https://nexus.microsoftonline-p.com/federationmetadata/saml20/federationmetadata.xml](http://https://nexus.microsoftonline-p.com/federationmetadata/saml20/federationmetadata.xml).</span></span>
<span data-ttu-id="ef1ed-130">Клиентам, использующим экземпляр Office 365, предназначенный специально для Китая, следует использовать следующую конечную точку федерации: [https://nexus.partner.microsoftonline-p.cn/federationmetadata/saml20/federationmetadata.xml](https://nexus.partner.microsoftonline-p.cn/federationmetadata/saml20/federationmetadata.xml).</span><span class="sxs-lookup"><span data-stu-id="ef1ed-130">For customers in China using the China-specific instance of Office 365, the following federation endpoint should be used: [https://nexus.partner.microsoftonline-p.cn/federationmetadata/saml20/federationmetadata.xml](https://nexus.partner.microsoftonline-p.cn/federationmetadata/saml20/federationmetadata.xml).</span></span>

## <a name="saml-protocol-requirements"></a><span data-ttu-id="ef1ed-131">Требования к протоколу SAML</span><span class="sxs-lookup"><span data-stu-id="ef1ed-131">SAML protocol requirements</span></span>
<span data-ttu-id="ef1ed-132">В этом разделе подробно описывается, как составляются пары, состоящие из запроса и ответного сообщения. Это поможет вам правильно форматировать свои сообщения.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-132">This section details how the request and response message pairs are put together in order to help you to format your messages correctly.</span></span>

<span data-ttu-id="ef1ed-133">При настройке Azure AD для работы с поставщиками удостоверений, использующими профиль SAML 2.0 SP Lite, предъявляется ряд особых требований, которые приведены ниже.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-133">Azure AD can be configured to work with identity providers that use the SAML 2.0 SP Lite profile with some specific requirements as listed below.</span></span> <span data-ttu-id="ef1ed-134">Используя образцы запросов и ответных сообщений SAML в сочетании с автоматическим и ручным тестированием, вы можете обеспечить взаимодействие с Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-134">Using the sample SAML request and response messages along with automated and manual testing, you can work to achieve interoperability with Azure AD.</span></span>

## <a name="signature-block-requirements"></a><span data-ttu-id="ef1ed-135">Требования к блоку подписи</span><span class="sxs-lookup"><span data-stu-id="ef1ed-135">Signature block requirements</span></span>
<span data-ttu-id="ef1ed-136">В ответном сообщении SAML узел Signature содержит сведения о цифровой подписи самого сообщения.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-136">Within the SAML Response message the Signature node contains information about the digital signature for the message itself.</span></span> <span data-ttu-id="ef1ed-137">К блоку подписи предъявляются указанные ниже требования.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-137">The signature block has the following requirements:</span></span>

1. <span data-ttu-id="ef1ed-138">Узел утверждения должен быть подписан.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-138">The assertion node itself must be signed</span></span>
2.  <span data-ttu-id="ef1ed-139">В качестве метода DigestMethod необходимо использовать алгоритм RSA-sha1.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-139">The RSA-sha1 algorithm must be used as the DigestMethod.</span></span> <span data-ttu-id="ef1ed-140">Другие алгоритмы цифровой подписи не допускаются.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-140">Other digital signature algorithms are not accepted.</span></span>
   `<ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/>`
3.  <span data-ttu-id="ef1ed-141">Также можно подписать XML-документ.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-141">You may also sign the XML document.</span></span> 
4.  <span data-ttu-id="ef1ed-142">Значения алгоритма Transform Algorithm должны соответствовать приведенным в следующем примере: `<ds:Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>
       <ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"/>`</span><span class="sxs-lookup"><span data-stu-id="ef1ed-142">The Transform Algorithm must match the values in the following sample:    `<ds:Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>
       <ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"/>`</span></span>
9.  <span data-ttu-id="ef1ed-143">Алгоритм SignatureMethod Algorithm должен соответствовать приведенному в следующем примере:`<ds:SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"/>`</span><span class="sxs-lookup"><span data-stu-id="ef1ed-143">The SignatureMethod Algorithm must match the following sample:   `<ds:SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"/>`</span></span>

## <a name="supported-bindings"></a><span data-ttu-id="ef1ed-144">Поддерживаемые привязки</span><span class="sxs-lookup"><span data-stu-id="ef1ed-144">Supported bindings</span></span>
<span data-ttu-id="ef1ed-145">Привязки — это обязательные параметры взаимодействия, связанные с транспортом.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-145">Bindings are the transport related communications parameters that are required.</span></span> <span data-ttu-id="ef1ed-146">В отношении привязок действуют указанные ниже требования.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-146">The following requirements apply to the bindings</span></span>

1. <span data-ttu-id="ef1ed-147">HTTPS — это обязательный транспорт.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-147">HTTPS is the required transport.</span></span>
2.  <span data-ttu-id="ef1ed-148">Службе Azure AD потребуется запрос HTTP POST для отправки токена во время входа.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-148">Azure AD will require HTTP POST for token submission during logon</span></span>
3.  <span data-ttu-id="ef1ed-149">Служба Azure AD будет использовать метод HTTP POST для отправки запроса проверки подлинности поставщику удостоверений и метод REDIRECT для отправки ему сообщения о выходе.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-149">Azure AD will use HTTP POST for the authentication request to the identity provider and REDIRECT for the Logoff message to the identity provider.</span></span>

## <a name="required-attributes"></a><span data-ttu-id="ef1ed-150">Требуемые атрибуты</span><span class="sxs-lookup"><span data-stu-id="ef1ed-150">Required attributes</span></span>
<span data-ttu-id="ef1ed-151">В таблице ниже приведены требования к определенным атрибутам в сообщении SAML 2.0.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-151">This table shows requirements for specific attributes in the SAML 2.0 message.</span></span>
 
|<span data-ttu-id="ef1ed-152">Атрибут</span><span class="sxs-lookup"><span data-stu-id="ef1ed-152">Attribute</span></span>|<span data-ttu-id="ef1ed-153">Описание</span><span class="sxs-lookup"><span data-stu-id="ef1ed-153">Description</span></span>|
| ----- | ----- |
|<span data-ttu-id="ef1ed-154">NameID</span><span class="sxs-lookup"><span data-stu-id="ef1ed-154">NameID</span></span>|<span data-ttu-id="ef1ed-155">Значение этого утверждения должно совпадать с идентификатором ImmutableID пользователя в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-155">The value of this assertion must be the same as the Azure AD user’s ImmutableID.</span></span> <span data-ttu-id="ef1ed-156">Это должно быть буквенно-цифровое значение длиной до 64 символов.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-156">It can be up to 64 alpha numeric characters.</span></span> <span data-ttu-id="ef1ed-157">Все небезопасные символы HTML должны кодироваться, например, символ "+" должен быть представлен как ".2B".</span><span class="sxs-lookup"><span data-stu-id="ef1ed-157">Any non HTML safe characters must be encoded, for example a “+” character is shown as “.2B”.</span></span>|
|<span data-ttu-id="ef1ed-158">IDPEmail</span><span class="sxs-lookup"><span data-stu-id="ef1ed-158">IDPEmail</span></span>|<span data-ttu-id="ef1ed-159">Имя субъекта-пользователя (UPN) приводится в ответе SAML в виде элемента с именем IDPEmail. Это атрибут UserPrincipalName (UPN) пользователя в Azure AD и Office 365.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-159">The User Principal Name (UPN) is listed in the SAML response as an element with the name IDPEmail This is the user’s UserPrincipalName (UPN) in Azure AD/Office 365.</span></span> <span data-ttu-id="ef1ed-160">Имя субъекта-пользователя указывается в формате адреса электронной почты.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-160">The UPN is in email address format.</span></span> <span data-ttu-id="ef1ed-161">Значение UPN в Windows Office 365 (Azure Active Directory).</span><span class="sxs-lookup"><span data-stu-id="ef1ed-161">UPN value in Windows Office 365 (Azure Active Directory).</span></span>|
|<span data-ttu-id="ef1ed-162">Издатель</span><span class="sxs-lookup"><span data-stu-id="ef1ed-162">Issuer</span></span>|<span data-ttu-id="ef1ed-163">Это должен быть универсальный код ресурса (URI) поставщика удостоверений.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-163">This is required to be a URI of the identity provider.</span></span> <span data-ttu-id="ef1ed-164">Не следует использовать значение Issuer из образцов сообщений.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-164">You should not reuse the Issuer from the sample messages.</span></span> <span data-ttu-id="ef1ed-165">Если в клиентах Azure AD несколько доменов верхнего уровня, значение Issuer должно совпадать с универсальным кодом ресурса (URI), настроенным для домена.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-165">If you have multiple top-level domains in your Azure AD tenants the Issuer must match the specified URI setting configured per domain.</span></span>|

>[!IMPORTANT]
><span data-ttu-id="ef1ed-166">Сейчас Azure AD поддерживает следующий формат URI для атрибута NameID в SAML 2.0: urn:oasis:names:tc:SAML:2.0:nameid-format:persistent.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-166">Azure AD currently supports the following NameID Format URI for SAML 2.0:urn:oasis:names:tc:SAML:2.0:nameid-format:persistent.</span></span>

## <a name="sample-saml-request-and-response-messages"></a><span data-ttu-id="ef1ed-167">Примеры сообщений SAML с запросом и ответом</span><span class="sxs-lookup"><span data-stu-id="ef1ed-167">Sample SAML request and response messages</span></span>
<span data-ttu-id="ef1ed-168">Ниже приведена пара сообщений, состоящая из запроса и ответа и используемая при обмене сообщениями единого входа.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-168">A request and response message pair is shown for the sign-on message exchange.</span></span>
<span data-ttu-id="ef1ed-169">Это пример сообщения с запросом, отправляемого из Azure AD поставщику удостоверений SAML 2.0.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-169">This is a sample request message that is sent from Azure AD to a sample SAML 2.0 identity provider.</span></span> <span data-ttu-id="ef1ed-170">Поставщик удостоверений SAML 2.0 в этом примере представляет собой службы федерации Active Directory (AD FS), настроенные для использования протокола SAML-P.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-170">The sample SAML 2.0 identity provider is Active Directory Federation Services (AD FS) configured to use SAML-P protocol.</span></span> <span data-ttu-id="ef1ed-171">Тестирование взаимодействия было выполнено и для других поставщиков удостоверений SAML 2.0.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-171">Interoperability testing has also been completed with other SAML 2.0 identity providers.</span></span>

    `<samlp:AuthnRequest xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol" xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion" ID="_7171b0b2-19f2-4ba2-8f94-24b5e56b7f1e" IssueInstant="2014-01-30T16:18:35Z" Version="2.0" AssertionConsumerServiceIndex="0" >
    <saml:Issuer>urn:federation:MicrosoftOnline</saml:Issuer>
    <samlp:NameIDPolicy Format="urn:oasis:names:tc:SAML:2.0:nameid-format:persistent"/>
    </samlp:AuthnRequest>`

<span data-ttu-id="ef1ed-172">Это пример ответного сообщения, отправляемого поставщиком удостоверений, совместимым с SAML 2.0, в Azure AD или Office 365.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-172">This is a sample response message that is sent from the sample SAML 2.0 compliant identity provider to Azure AD / Office 365.</span></span>

    `<samlp:Response ID="_592c022f-e85e-4d23-b55b-9141c95cd2a5" Version="2.0" IssueInstant="2014-01-31T15:36:31.357Z" Destination="https://login.microsoftonline.com/login.srf" Consent="urn:oasis:names:tc:SAML:2.0:consent:unspecified" InResponseTo="_049917a6-1183-42fd-a190-1d2cbaf9b144" xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol">
    <Issuer xmlns="urn:oasis:names:tc:SAML:2.0:assertion">http://WS2012R2-0.contoso.com/adfs/services/trust</Issuer>
    <samlp:Status>
    <samlp:StatusCode Value="urn:oasis:names:tc:SAML:2.0:status:Success" />
    </samlp:Status>
    <Assertion ID="_7e3c1bcd-f180-4f78-83e1-7680920793aa" IssueInstant="2014-01-31T15:36:31.279Z" Version="2.0" xmlns="urn:oasis:names:tc:SAML:2.0:assertion">
    <Issuer>http://WS2012R2-0.contoso.com/adfs/services/trust</Issuer>
    <ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
      <ds:SignedInfo>
        <ds:CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#" />
        <ds:SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1" />
        <ds:Reference URI="#_7e3c1bcd-f180-4f78-83e1-7680920793aa">
          <ds:Transforms>
            <ds:Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature" />
            <ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#" />
          </ds:Transforms>
          <ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1" />
          <ds:DigestValue>CBn/5YqbheaJP425c0pHva9PhNY=</ds:DigestValue>
        </ds:Reference>
      </ds:SignedInfo>
      <ds:SignatureValue>TciWMyHW2ZODrh/2xrvp5ggmcHBFEd9vrp6DYXp+hZWJzmXMmzwmwS8KNRJKy8H7XqBsdELA1Msqi8I3TmWdnoIRfM/ZAyUppo8suMu6Zw+boE32hoQRnX9EWN/f0vH6zA/YKTzrjca6JQ8gAV1ErwvRWDpyMcwdYCiWALv9ScbkAcebOE1s1JctZ5RBXggdZWrYi72X+I4i6WgyZcIGai/rZ4v2otoWAEHS0y1yh1qT7NDPpl/McDaTGkNU6C+8VfjD78DrUXEcAfKvPgKlKrOMZnD1lCGsViimGY+LSuIdY45MLmyaa5UT4KWph6dA==</ds:SignatureValue>
      <KeyInfo xmlns="http://www.w3.org/2000/09/xmldsig#">
        <ds:X509Data>
          <ds:X509Certificate>MIIC7jCCAdagAwIBAgIQRrjsbFPaXIlOG3GTv50fkjANBgkqhkiG9w0BAQsFADAzMTEwLwYDVQQDEyhBREZTIFNpZ25pbmcgLSBXUzIwMTJSMi0wLnN3aW5mb3JtZXIuY29tMB4XDTE0MDEyMDE1MTY0MFoXDTE1MDEyMDE1MTY0MFowMzExMC8GA1UEAxMoQURGUyBTaWduaW5nIC0gV1MyMDEyUjItMC5zd2luZm9ybWVyLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAKe+rLVmXy1QwCwZwqgbbp1/+3ZWxd9T/jV0hpLIIWr+LCOHqq8n8beJvlivgLmDJo8f+EITnAxWcsJUvVai/35AhHCUq9tc9sqMp5PWtabAEMb2AU72/QlX/72D2/NbGQq1BWYbqUpgpCZ2nSgvlWDHlCiUo//UGsvfox01kjTFlmqQInsJVfRxF5AcCAwEAATANBgkqhkiG9w0BAQsFAAOCAQEAi8c6C4zaTEc7aQiUgvnGQgCbMZbhUXXLGRpjvFLKaQzkwa9eq7WLJibcSNyGXBa/SfT5wJgsm3TPKgSehGAOTirhcqHheZyvBObAScY7GOT+u9pVYp6raFrc7ez3c+CGHeV/tNvy1hJNs12FYH4X+ZCNFIT9tprieR25NCdi5SWUbPZL0tVzJsHc1y92b2M2FxqRDohxQgJvyJOpcg2mSBzZZIkvDg7gfPSUXHVS1MQs0RHSbwq/XdQocUUhl9/e/YWCbNNxlM84BxFsBUok1dH/gzBySx+Fc8zYi7cOq9yaBT3RLT6cGmFGVYZJW4FyhPZOCLVNsLlnPQcX3dDg9A==</ds:X509Certificate>
        </ds:X509Data>
      </KeyInfo>
    </ds:Signature>
    <Subject>
      <NameID Format="urn:oasis:names:tc:SAML:2.0:nameid-format:persistent">ABCDEG1234567890</NameID>
      <SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer">
        <SubjectConfirmationData InResponseTo="_049917a6-1183-42fd-a190-1d2cbaf9b144" NotOnOrAfter="2014-01-31T15:41:31.357Z" Recipient="https://login.microsoftonline.com/login.srf" />
      </SubjectConfirmation>
    </Subject>
    <Conditions NotBefore="2014-01-31T15:36:31.263Z" NotOnOrAfter="2014-01-31T16:36:31.263Z">
      <AudienceRestriction>
        <Audience>urn:federation:MicrosoftOnline</Audience>
      </AudienceRestriction>
    </Conditions>
    <AttributeStatement>
      <Attribute Name="IDPEmail">
        <AttributeValue>administrator@contoso.com</AttributeValue>
      </Attribute>
    </AttributeStatement>
    <AuthnStatement AuthnInstant="2014-01-31T15:36:30.200Z" SessionIndex="_7e3c1bcd-f180-4f78-83e1-7680920793aa">
      <AuthnContext>
        <AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport</AuthnContextClassRef>
      </AuthnContext>
    </AuthnStatement>
    </Assertion>
    </samlp:Response>`

## <a name="configure-your-saml-20-compliant-identity-provider"></a><span data-ttu-id="ef1ed-173">Настройка поставщика удостоверений, совместимого с SAML 2.0</span><span class="sxs-lookup"><span data-stu-id="ef1ed-173">Configure your SAML 2.0 compliant identity provider</span></span>
<span data-ttu-id="ef1ed-174">В этом разделе содержатся рекомендации по настройке поставщика удостоверений SAML 2.0 для федерации с Azure AD с целью обеспечения единого входа в одну или несколько облачных служб Майкрософт (таких как Office 365) по протоколу SAML 2.0.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-174">This topic contains guidelines on how to configure your SAML 2.0 identity provider to federate with Azure AD to enable single sign-on access to one or more Microsoft cloud services (such as Office 365) using the SAML 2.0 protocol.</span></span> <span data-ttu-id="ef1ed-175">В качестве проверяющей стороны SAML 2.0 для облачной службы (Майкрософт) в этом сценарии используется Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-175">The SAML 2.0 relying party for a Microsoft cloud service used in this scenario is Azure AD.</span></span>

## <a name="add-azure-ad-metadata"></a><span data-ttu-id="ef1ed-176">Добавление метаданных Azure AD</span><span class="sxs-lookup"><span data-stu-id="ef1ed-176">Add Azure AD metadata</span></span>
<span data-ttu-id="ef1ed-177">Поставщик удостоверений SAML 2.0 должен придерживаться информации о проверяющей стороне Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-177">Your SAML 2.0 identity provider needs to adhere to information about the Azure AD relying party.</span></span> <span data-ttu-id="ef1ed-178">Azure AD публикует метаданные в https://nexus.microsoftonline-p.com/federationmetadata/saml20/federationmetadata.xml.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-178">Azure AD publishes metadata at https://nexus.microsoftonline-p.com/federationmetadata/saml20/federationmetadata.xml.</span></span>

<span data-ttu-id="ef1ed-179">При настройке поставщика удостоверений SAML 2.0 рекомендуется всегда импортировать новейшие метаданные Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-179">It is recommended that you always import the latest Azure AD metadata when configuring your SAML 2.0 identity provider.</span></span> <span data-ttu-id="ef1ed-180">Имейте в виду, что служба Azure AD не считывает метаданные поставщика удостоверений.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-180">Note that Azure AD does not read metadata from the identity provider.</span></span>

## <a name="add-azure-ad-as-a-relying-party"></a><span data-ttu-id="ef1ed-181">Добавление Azure AD в качестве проверяющей стороны</span><span class="sxs-lookup"><span data-stu-id="ef1ed-181">Add Azure AD as a relying party</span></span>
<span data-ttu-id="ef1ed-182">Необходимо включить обмен данными между поставщиком удостоверений SAML 2.0 и Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-182">You have to enable communication between your SAML 2.0 identity provider and Azure AD.</span></span> <span data-ttu-id="ef1ed-183">Эта конфигурация будет зависеть от используемого поставщика удостоверений. Обратитесь к документации по нему.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-183">This configuration will be dependent on your specific identity provider and you should refer to documentation for it.</span></span> <span data-ttu-id="ef1ed-184">Идентификатор проверяющей стороны, как правило, должен совпадать с идентификатором entityID, указанным в метаданных Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-184">You would typically set the relying party ID to the same as the entityID from the Azure AD metadata.</span></span>

>[!NOTE]
><span data-ttu-id="ef1ed-185">Убедитесь, что часы на сервере поставщика удостоверений SAML 2.0 синхронизированы с источником точного времени.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-185">Verify the clock on your SAML 2.0 identity provider server is synchronized to an accurate time source.</span></span> <span data-ttu-id="ef1ed-186">Неточное время часов может приводить к ошибкам при выполнении федеративных входов.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-186">An inaccurate clock time can cause federated logins to fail.</span></span>

## <a name="install-windows-powershell-for-sign-on-with-saml-20-identity-provider"></a><span data-ttu-id="ef1ed-187">Установка Windows PowerShell для единого входа с помощью поставщика удостоверений SAML 2.0</span><span class="sxs-lookup"><span data-stu-id="ef1ed-187">Install Windows PowerShell for sign-on with SAML 2.0 identity provider</span></span>
<span data-ttu-id="ef1ed-188">После настройки поставщика удостоверений SAML 2.0 для единого входа с помощью Azure AD далее необходимо загрузить и установить модуль Azure Active Directory для Windows PowerShell.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-188">After you have configured your SAML 2.0 identity provider for use with Azure AD sign-on, the next step is to download and install the Azure Active Directory Module for Windows PowerShell.</span></span> <span data-ttu-id="ef1ed-189">После установки эти командлеты будут использоваться для настройки доменов Azure AD в качестве федеративных доменов.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-189">Once installed, you will use these cmdlets to configure your Azure AD domains as federated domains.</span></span>

<span data-ttu-id="ef1ed-190">Модуль Azure Active Directory для Windows PowerShell — это загружаемый компонент для управления данными организации в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-190">The Azure Active Directory Module for Windows PowerShell is a download for managing your organizations data in Azure AD.</span></span> <span data-ttu-id="ef1ed-191">Он устанавливает набор командлетов в Windows PowerShell, которые служат для настройки единого входа в Azure AD и далее во все облачные службы, на которые вы подписаны.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-191">This module installs a set of cmdlets to Windows PowerShell; you run those cmdlets to set up single sign-on access to Azure AD and in turn to all of the cloud services you are subscribed to.</span></span> <span data-ttu-id="ef1ed-192">Инструкции по загрузке и установке командлетов см. на странице по адресу: [http://technet.microsoft.com/library/jj151815.aspx](http://technet.microsoft.com/library/jj151815.aspx).</span><span class="sxs-lookup"><span data-stu-id="ef1ed-192">For instructions about how to download and install the cmdlets, see [http://technet.microsoft.com/library/jj151815.aspx](http://technet.microsoft.com/library/jj151815.aspx)</span></span>

## <a name="set-up-a-trust-between-your-saml-identity-provider-and-azure-ad"></a><span data-ttu-id="ef1ed-193">Настройка отношения доверия между поставщиком удостоверений SAML и Azure AD</span><span class="sxs-lookup"><span data-stu-id="ef1ed-193">Set up a trust between your SAML identity provider and Azure AD</span></span>
<span data-ttu-id="ef1ed-194">Перед настройкой федерации в домене Azure AD в нем должен быть настроен личный домен.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-194">Before configuring federation on an Azure AD domain, it must have a custom domain configured.</span></span> <span data-ttu-id="ef1ed-195">Установить федерацию с доменом по умолчанию, предоставленным корпорацией Майкрософт, нельзя.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-195">You cannot federate the default domain that is provided by Microsoft.</span></span> <span data-ttu-id="ef1ed-196">Домен по умолчанию от корпорации Майкрософт заканчивается на onmicrosoft.com.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-196">The default domain from Microsoft ends with “onmicrosoft.com”.</span></span>
<span data-ttu-id="ef1ed-197">Чтобы добавить или преобразовать домены для единого входа, вам потребуется выполнить ряд командлетов в интерфейсе командной строки PowerShell.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-197">You will run a series of cmdlets in the Windows PowerShell command-line interface to add or convert domains for single sign-on.</span></span>

<span data-ttu-id="ef1ed-198">Каждый домен Azure Active Directory, который необходимо включить в федерацию с помощью поставщика удостоверений SAML 2.0, должен быть добавлен как домен единого входа или преобразован из стандартного домена в домен единого входа.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-198">Each Azure Active Directory domain that you want to federate using your SAML 2.0 identity provider must either be added as a single sign-on domain or converted to be a single sign-on domain from a standard domain.</span></span> <span data-ttu-id="ef1ed-199">При добавлении или преобразовании домена между поставщиком удостоверений SAML 2.0 и Azure AD настраивается отношение доверия.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-199">Adding or converting a domain sets up a trust between your SAML 2.0 identity provider and Azure AD.</span></span>

<span data-ttu-id="ef1ed-200">В следующей процедуре содержатся указания по преобразованию существующего стандартного домена в федеративный домен с помощью SAML 2.0 SP-Lite.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-200">The following procedure walks you through converting an existing standard domain to a federated domain using SAML 2.0 SP-Lite.</span></span> <span data-ttu-id="ef1ed-201">Имейте в виду, что после выполнения этого действия домен может стать недоступен для пользователей на срок до 2 часов.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-201">Note that your domain may experience an outage that impacts users up to 2 hours after you take this step.</span></span>

## <a name="configuring-a-domain-in-your-azure-ad-directory-for-federation"></a><span data-ttu-id="ef1ed-202">Настройка домена в каталоге Azure AD для федерации</span><span class="sxs-lookup"><span data-stu-id="ef1ed-202">Configuring a domain in your Azure AD Directory for federation</span></span>


1. <span data-ttu-id="ef1ed-203">Подключитесь к каталогу Azure AD в качестве администратора клиента: Connect-MsolService.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-203">Connect to your Azure AD Directory as a tenant administrator: Connect-MsolService .</span></span>
2.  <span data-ttu-id="ef1ed-204">Настройте требуемый домен Office 365 для использования федерации с SAML 2.0: `$dom = "contoso.com" $BrandName - "Sample SAML 2.0 IDP" $LogOnUrl = "https://WS2012R2-0.contoso.com/passiveLogon" $LogOffUrl = "https://WS2012R2-0.contoso.com/passiveLogOff" $ecpUrl = "https://WS2012R2-0.contoso.com/PAOS" $MyURI = "urn:uri:MySamlp2IDP" $MySigningCert = @" MIIC7jCCAdagAwIBAgIQRrjsbFPaXIlOG3GTv50fkjANBgkqhkiG9w0BAQsFADAzMTEwLwYDVQQDEyh BREZTIFNpZ25pbmcgLSBXUzIwMTJSMi0wLnN3aW5mb3JtZXIuY29tMB4XDTE0MDEyMDE1MTY0MFoXDT E1MDEyMDE1MTY0MFowMzExMC8GA1UEAxMoQURGUyBTaWduaW5nIC0gV1MyMDEyUjItMC5zd2luZm9yb WVyLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAKe+rLVmXy1QwCwZwqgbbp1/kupQ VcjKuKLitVDbssFyqbDTjP7WRjlVMWAHBI3kgNT7oE362Gf2WMJFf1b0HcrsgLin7daRXpq4Qi6OA57 sW1YFMj3sqyuTP0eZV3S4+ZbDVob6amsZIdIwxaLP9Zfywg2bLsGnVldB0+XKedZwDbCLCVg+3ZWxd9 T/jV0hpLIIWr+LCOHqq8n8beJvlivgLmDJo8f+EITnAxWcsJUvVai/35AhHCUq9tc9sqMp5PWtabAEM b2AU72/QlX/72D2/NbGQq1BWYbqUpgpCZ2nSgvlWDHlCiUo//UGsvfox01kjTFlmqQInsJVfRxF5AcC AwEAATANBgkqhkiG9w0BAQsFAAOCAQEAi8c6C4zaTEc7aQiUgvnGQgCbMZbhUXXLGRpjvFLKaQzkwa9 eq7WLJibcSNyGXBa/SfT5wJgsm3TPKgSehGAOTirhcqHheZyvBObAScY7GOT+u9pVYp6raFrc7ez3c+ CGHeV/tNvy1hJNs12FYH4X+ZCNFIT9tprieR25NCdi5SWUbPZL0tVzJsHc1y92b2M2FxqRDohxQgJvy JOpcg2mSBzZZIkvDg7gfPSUXHVS1MQs0RHSbwq/XdQocUUhl9/e/YWCbNNxlM84BxFsBUok1dH/gzBy Sx+Fc8zYi7cOq9yaBT3RLT6cGmFGVYZJW4FyhPZOCLVNsLlnPQcX3dDg9A==" "@ $uri = "http://WS2012R2-0.contoso.com/adfs/services/trust" $Protocol = "SAMLP" Set-MsolDomainAuthentication -DomainName $dom -FederationBrandName $dom -Authentication Federated -PassiveLogOnUri $MyURI -ActiveLogOnUri $ecpUrl -SigningCertificate $MySigningCert -IssuerUri $uri -LogOffUri $url -PreferredAuthenticationProtocol $Protocol`</span><span class="sxs-lookup"><span data-stu-id="ef1ed-204">Configure your desired Office 365 domain to use federation with SAML 2.0: `$dom = "contoso.com" $BrandName - "Sample SAML 2.0 IDP" $LogOnUrl = "https://WS2012R2-0.contoso.com/passiveLogon" $LogOffUrl = "https://WS2012R2-0.contoso.com/passiveLogOff" $ecpUrl = "https://WS2012R2-0.contoso.com/PAOS" $MyURI = "urn:uri:MySamlp2IDP" $MySigningCert = @" MIIC7jCCAdagAwIBAgIQRrjsbFPaXIlOG3GTv50fkjANBgkqhkiG9w0BAQsFADAzMTEwLwYDVQQDEyh BREZTIFNpZ25pbmcgLSBXUzIwMTJSMi0wLnN3aW5mb3JtZXIuY29tMB4XDTE0MDEyMDE1MTY0MFoXDT E1MDEyMDE1MTY0MFowMzExMC8GA1UEAxMoQURGUyBTaWduaW5nIC0gV1MyMDEyUjItMC5zd2luZm9yb WVyLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAKe+rLVmXy1QwCwZwqgbbp1/kupQ VcjKuKLitVDbssFyqbDTjP7WRjlVMWAHBI3kgNT7oE362Gf2WMJFf1b0HcrsgLin7daRXpq4Qi6OA57 sW1YFMj3sqyuTP0eZV3S4+ZbDVob6amsZIdIwxaLP9Zfywg2bLsGnVldB0+XKedZwDbCLCVg+3ZWxd9 T/jV0hpLIIWr+LCOHqq8n8beJvlivgLmDJo8f+EITnAxWcsJUvVai/35AhHCUq9tc9sqMp5PWtabAEM b2AU72/QlX/72D2/NbGQq1BWYbqUpgpCZ2nSgvlWDHlCiUo//UGsvfox01kjTFlmqQInsJVfRxF5AcC AwEAATANBgkqhkiG9w0BAQsFAAOCAQEAi8c6C4zaTEc7aQiUgvnGQgCbMZbhUXXLGRpjvFLKaQzkwa9 eq7WLJibcSNyGXBa/SfT5wJgsm3TPKgSehGAOTirhcqHheZyvBObAScY7GOT+u9pVYp6raFrc7ez3c+ CGHeV/tNvy1hJNs12FYH4X+ZCNFIT9tprieR25NCdi5SWUbPZL0tVzJsHc1y92b2M2FxqRDohxQgJvy JOpcg2mSBzZZIkvDg7gfPSUXHVS1MQs0RHSbwq/XdQocUUhl9/e/YWCbNNxlM84BxFsBUok1dH/gzBy Sx+Fc8zYi7cOq9yaBT3RLT6cGmFGVYZJW4FyhPZOCLVNsLlnPQcX3dDg9A==" "@ $uri = "http://WS2012R2-0.contoso.com/adfs/services/trust" $Protocol = "SAMLP" Set-MsolDomainAuthentication -DomainName $dom -FederationBrandName $dom -Authentication Federated -PassiveLogOnUri $MyURI -ActiveLogOnUri $ecpUrl -SigningCertificate $MySigningCert -IssuerUri $uri -LogOffUri $url -PreferredAuthenticationProtocol $Protocol`</span></span> 

3.  <span data-ttu-id="ef1ed-205">Получить строку сертификата подписи в кодировке base64 можно из файла метаданных IDP.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-205">You can obtain the signing certificate base64 encoded string from your IDP metadata file.</span></span> <span data-ttu-id="ef1ed-206">Пример его расположения приведен, но в зависимости от особенностей развертывания оно может быть немного иным.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-206">An example of this location has been provided but may differ slightly based on your implementation.</span></span>

    `<IDPSSODescriptor protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"> <KeyDescriptor use="signing"> <KeyInfo xmlns="http://www.w3.org/2000/09/xmldsig#"> <X509Data> <X509Certificate>MIIC5jCCAc6gAwIBAgIQLnaxUPzay6ZJsC8HVv/QfTANBgkqhkiG9w0BAQsFADAvMS0wKwYDVQQDEyRBREZTIFNpZ25pbmcgLSBmcy50ZWNobGFiY2VudHJhbC5vcmcwHhcNMTMxMTA0MTgxMzMyWhcNMTQxMTA0MTgxMzMyWjAvMS0wKwYDVQQDEyRBREZTIFNpZ25pbmcgLSBmcy50ZWNobGFiY2VudHJhbC5vcmcwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCwMdVLTr5YTSRp+ccbSpuuFeXMfABD9mVCi2wtkRwC30TIyPdORz642MkurdxdPCWjwgJ0HW6TvXwcO9afH3OC5V//wEGDoNcI8PV4enCzTYFe/h//w51uqyv48Fbb3lEXs+aVl8155OAj2sO9IX64OJWKey82GQWK3g7LfhWWpp17j5bKpSd9DBH5pvrV+Q1ESU3mx71TEOvikHGCZYitEPywNeVMLRKrevdWI3FAhFjcCSO6nWDiMqCqiTDYOURXIcHVYTSof1YotkJ4tG6mP5Kpjzd4VQvnR7Pjb47nhIYG6iZ3mR1F85Ns9+hBWukQWNN2hcD/uGdPXhpdMVpBAgMBAAEwDQYJKoZIhvcNAQELBQADggEBAK7h7jF7wPzhZ1dPl4e+XMAr8I7TNbhgEU3+oxKyW/IioQbvZVw1mYVCbGq9Rsw4KE06eSMybqHln3w5EeBbLS0MEkApqHY+p68iRpguqa+W7UHKXXQVgPMCpqxMFKonX6VlSQOR64FgpBme2uG+LJ8reTgypEKspQIN0WvtPWmiq4zAwBp08hAacgv868c0MM4WbOYU0rzMIR6Q+ceGVRImlCwZ5b7XKp4mJZ9hlaRjeuyVrDuzBkzROSurX1OXoci08yJvhbtiBJLf3uPOJHrhjKRwIt2TnzS9ElgFZlJiDIA26Athe73n43CT0af2IG6yC7e6sK4L3NEXJrwwUZk=</X509Certificate> </X509Data> </KeyInfo> </KeyDescriptor>` 

<span data-ttu-id="ef1ed-207">Дополнительные сведения о командлете Set-MsolDomainAuthentication см. на странице по адресу: [http://technet.microsoft.com/library/dn194112.aspx](http://technet.microsoft.com/library/dn194112.aspx).</span><span class="sxs-lookup"><span data-stu-id="ef1ed-207">For more information about “Set-MsolDomainAuthentication”, see: [http://technet.microsoft.com/library/dn194112.aspx](http://technet.microsoft.com/library/dn194112.aspx).</span></span>

>[!NOTE]
><span data-ttu-id="ef1ed-208">Использовать атрибут "$ecpUrl = "https://WS2012R2-0.contoso.com/PAOS"" следует только в том случае, если для поставщика удостоверений настраивается расширение ECP.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-208">You must run use “$ecpUrl = “https://WS2012R2-0.contoso.com/PAOS“” only if you set up an ECP extension for your identity provider.</span></span> <span data-ttu-id="ef1ed-209">Клиенты Exchange Online, исключая Outlook Web Application (OWA), используют активную конечную точку на основе метода POST.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-209">Exchange Online clients, excluding Outlook Web Application (OWA), rely on a POST based active end point.</span></span> <span data-ttu-id="ef1ed-210">Если служба токенов безопасности SAML 2.0 реализует активную конечную точку, аналогичную реализации активной конечной точки с помощью расширения ECP для Shibboleth, эти полнофункциональные клиенты могут взаимодействовать со службой Exchange Online.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-210">If your SAML 2.0 STS implements an active end point similar to Shibboleth’s ECP implementation of an active end point it may be possible for these rich clients to interact with the Exchange Online service.</span></span>

<span data-ttu-id="ef1ed-211">После настройки федерации можно вернуться к управляемой реализации (без поддержки федерации), однако на применение этого изменения требуется до двух часов, а каждому пользователю необходимо назначить новый случайный пароль для входа в облачные службы.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-211">Once federation has been configured you can switch back to “non-federated” (or “managed”), however this change takes up to two hours to complete and it requires assigning new random passwords for cloud based sign-in to each user.</span></span> <span data-ttu-id="ef1ed-212">Переключение к управляемой реализации может потребоваться в некоторых сценариях для сброса ошибочных параметров.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-212">Switching back to “managed” may be required in some scenarios to reset an error in your settings.</span></span> <span data-ttu-id="ef1ed-213">Дополнительные сведения о преобразовании домена см. на странице по адресу: [http://msdn.microsoft.com/library/windowsazure/dn194122.aspx](http://msdn.microsoft.com/library/windowsazure/dn194122.aspx).</span><span class="sxs-lookup"><span data-stu-id="ef1ed-213">For more information on Domain conversion see: [http://msdn.microsoft.com/library/windowsazure/dn194122.aspx](http://msdn.microsoft.com/library/windowsazure/dn194122.aspx).</span></span>

## <a name="provision-user-principals-to-azure-ad--office-365"></a><span data-ttu-id="ef1ed-214">Подготовка субъектов-пользователей для Azure AD и Office 365</span><span class="sxs-lookup"><span data-stu-id="ef1ed-214">Provision user principals to Azure AD / Office 365</span></span>
<span data-ttu-id="ef1ed-215">Чтобы пользователи могли проходить проверку подлинности в Office 365, сначала нужно подготовить в Azure AD субъектов-пользователей, соответствующих утверждению в SAML 2.0.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-215">Before you can authenticate your users to Office 365 you must provision Azure AD with user principals that correspond to the assertion in the SAML 2.0 claim.</span></span> <span data-ttu-id="ef1ed-216">Если эти субъекты-пользователи заранее не известны службе Azure AD, их нельзя использовать для федеративного входа.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-216">If these user principals are not known to Azure AD in advance then they cannot be used for federated sign-in.</span></span> <span data-ttu-id="ef1ed-217">Подготовить субъектов-пользователей можно с помощью Azure AD Connect или Windows PowerShell.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-217">Either Azure AD Connect or Windows PowerShell can be used to provision user principals.</span></span>

<span data-ttu-id="ef1ed-218">С помощью Azure AD Connect можно подготавливать субъектов-пользователей для доменов каталога Azure AD из локальной службы Active Directory.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-218">Azure AD Connect can be used to provision principals to your domains in your Azure AD Directory from the on-premises Active Directory.</span></span> <span data-ttu-id="ef1ed-219">Дополнительные сведения см. в статье [Интеграция локальных каталогов с Azure Active Directory](active-directory-aadconnect.md).</span><span class="sxs-lookup"><span data-stu-id="ef1ed-219">For more detailed information, see [Integrate your on-premises directories with Azure Active Directory](active-directory-aadconnect.md).</span></span>

<span data-ttu-id="ef1ed-220">С помощью Windows PowerShell также можно автоматизировать добавление новых пользователей в Azure AD и синхронизировать изменения из локального каталога.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-220">Windows PowerShell can also be used to automate adding new users to Azure AD and to synchronize changes from the on-premises directory.</span></span> <span data-ttu-id="ef1ed-221">Для использования командлетов Windows PowerShell необходимо скачать [модули Azure Active Directory](https://docs.microsoft.com/powershell/azure/install-adv2?view=azureadps-2.0).</span><span class="sxs-lookup"><span data-stu-id="ef1ed-221">To use the Windows PowerShell cmdlets you must download the [Azure Active Directory Modules](https://docs.microsoft.com/powershell/azure/install-adv2?view=azureadps-2.0).</span></span>

<span data-ttu-id="ef1ed-222">Ниже приведена процедура добавления отдельного пользователя в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-222">This procedure shows how to add a single user to Azure AD.</span></span>


1. <span data-ttu-id="ef1ed-223">Подключитесь к каталогу Azure AD в качестве администратора клиента: Connect-MsolService.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-223">Connect to your Azure AD Directory as a tenant administrator: Connect-MsolService.</span></span>
2.  <span data-ttu-id="ef1ed-224">Создайте субъекта-пользователя: ` New-MsolUser
        -UserPrincipalName elwoodf1@contoso.com
        -ImmutableId ABCDEFG1234567890
        -DisplayName "Elwood Folk"
        -FirstName Elwood 
        -LastName Folk 
        -AlternateEmailAddresses "Elwood.Folk@contoso.com" 
        -LicenseAssignment "samlp2test:ENTERPRISEPACK" 
        -UsageLocation "US" `</span><span class="sxs-lookup"><span data-stu-id="ef1ed-224">Create a new user principal: ` New-MsolUser
        -UserPrincipalName elwoodf1@contoso.com
    -ImmutableId ABCDEFG1234567890
    -DisplayName "Elwood Folk"
    -FirstName Elwood 
    -LastName Folk 
    -AlternateEmailAddresses "Elwood.Folk@contoso.com" 
    -LicenseAssignment "samlp2test:ENTERPRISEPACK" 
    -UsageLocation "US" `</span></span> 

<span data-ttu-id="ef1ed-225">Дополнительные сведения о командлете New-MsolUser см. на странице по адресу: [http://technet.microsoft.com/library/dn194096.aspx](http://technet.microsoft.com/library/dn194096.aspx).</span><span class="sxs-lookup"><span data-stu-id="ef1ed-225">For more information about “New-MsolUser” check out, [http://technet.microsoft.com/library/dn194096.aspx](http://technet.microsoft.com/library/dn194096.aspx)</span></span>

>[!NOTE]
><span data-ttu-id="ef1ed-226">Значение UserPrinciplName должно совпадать со значением, которое будет отправляться для атрибута IDPEmail в утверждении SAML 2.0, а значение ImmutableID должно совпадать со значением, отправляемым в утверждении NameID.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-226">The “UserPrinciplName” value must match the value that you will send for “IDPEmail” in your SAML 2.0 claim and the “ImmutableID” value must match the value sent in your “NameID” assertion.</span></span>

## <a name="verify-single-sign-on-with-your-saml-20-idp"></a><span data-ttu-id="ef1ed-227">Проверка единого входа с помощью поставщика удостоверений SAML 2.0</span><span class="sxs-lookup"><span data-stu-id="ef1ed-227">Verify single sign-on with your SAML 2.0 IDP</span></span>
<span data-ttu-id="ef1ed-228">Перед проверкой единого входа (также называемого федерацией удостоверений) и управлением им администратору следует ознакомиться с информацией и выполнить инструкции в указанных ниже статьях, чтобы настроить единый вход с помощью поставщика удостоверений на основе SAML 2.0 SP-Lite:</span><span class="sxs-lookup"><span data-stu-id="ef1ed-228">As the administrator, before you verify and manage single sign-on (also called identity federation), review the information and perform the steps in the following articles to set up single sign-on with your SAML 2.0 SP-Lite based identity provider:</span></span>


1.  <span data-ttu-id="ef1ed-229">Ознакомление с требованиями к протоколу SAML 2.0 для Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-229">You have reviewed the Azure AD SAML 2.0 Protocol Requirements</span></span>
2.  <span data-ttu-id="ef1ed-230">Настройки поставщика удостоверений SAML 2.0.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-230">You have configured your SAML 2.0 identity provider</span></span>
3.  <span data-ttu-id="ef1ed-231">Установка Windows PowerShell для единого входа с помощью поставщика удостоверений SAML 2.0.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-231">Install Windows PowerShell for single sign-on with SAML 2.0 identity provider</span></span>
4.  <span data-ttu-id="ef1ed-232">Настройка отношения доверия между поставщиком удостоверений SAML 2.0 и Azure AD.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-232">Set up a trust between SAML 2.0 identity provider and Azure AD</span></span>
5.  <span data-ttu-id="ef1ed-233">Подготовка известного тестового субъекта-пользователя для Azure Active Directory (Office 365) с помощью Windows PowerShell или Azure AD Connect.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-233">Provisioned a known test user principal to Azure Active Directory (Office 365) either through Windows PowerShell or Azure AD Connect.</span></span>
6.  <span data-ttu-id="ef1ed-234">Настройка синхронизации каталогов с помощью [Azure AD Connect](active-directory-aadconnect.md).</span><span class="sxs-lookup"><span data-stu-id="ef1ed-234">Configure directory synchronization using [Azure AD Connect](active-directory-aadconnect.md).</span></span>

<span data-ttu-id="ef1ed-235">После настройки единого входа с помощью поставщика удостоверений на основе SAML 2.0 SP-Lite следует проверить, правильно ли он работает.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-235">After setting up single sign-on with your SAML 2.0 SP-Lite based identity Provider, you should verify that it is working correctly.</span></span>

>[!NOTE]
><span data-ttu-id="ef1ed-236">Если вместо добавления домен преобразуется, то для настройки единого входа может понадобиться до 24 часов.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-236">If you converted a domain, rather than adding one, it may take up to 24 hours to set up single sign-on.</span></span>
<span data-ttu-id="ef1ed-237">Перед проверкой единого входа следует завершить настройку синхронизации Active Directory, синхронизировать каталоги и активировать синхронизированных пользователей.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-237">Before you verify single sign-on, you should finish setting up Active Directory synchronization, synchronize your directories, and activate your synced users.</span></span>

### <a name="use-the-tool-to-verify-that-single-sign-on-has-been-set-up-correctly"></a><span data-ttu-id="ef1ed-238">Проверка правильной настройки единого входа с помощью средства</span><span class="sxs-lookup"><span data-stu-id="ef1ed-238">Use the tool to verify that single sign-on has been set up correctly</span></span>
<span data-ttu-id="ef1ed-239">Чтобы проверить, правильно ли настроен единый вход, можно выполнить следующую процедуру, позволяющую подтвердить возможность входа в облачную службу с помощью корпоративных учетных данных.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-239">To verify that single sign-on has been set up correctly, you can perform the following procedure to confirm that you are able to sign in to the cloud service with your corporate credentials.</span></span>

<span data-ttu-id="ef1ed-240">Корпорация Майкрософт предоставляет средство, позволяющее протестировать поставщика удостоверений на основе SAML 2.0.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-240">Microsoft has provided a tool that you can use to test your SAML 2.0 based identity provider.</span></span> <span data-ttu-id="ef1ed-241">Перед запуском средства тестирования должна быть настроена федерация клиента Azure AD с поставщиком удостоверений.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-241">Before running the test tool you must have configured an Azure AD tenant to federate with your identity provider.</span></span>

>[!NOTE]
><span data-ttu-id="ef1ed-242">Для работы анализатора подключений требуется браузер Internet Explorer 10 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-242">The Connectivity Analyzer requires Internet Explorer 10 or later.</span></span>



1. <span data-ttu-id="ef1ed-243">Скачать анализатор подключений можно на странице по адресу: [https://testconnectivity.microsoft.com/?tabid=Client](https://testconnectivity.microsoft.com/?tabid=Client).</span><span class="sxs-lookup"><span data-stu-id="ef1ed-243">Download the Connectivity Analyzer from, [https://testconnectivity.microsoft.com/?tabid=Client](https://testconnectivity.microsoft.com/?tabid=Client).</span></span>
2.  <span data-ttu-id="ef1ed-244">Чтобы начать загрузку и установку средства, щелкните "Установить сейчас".</span><span class="sxs-lookup"><span data-stu-id="ef1ed-244">Click Install Now to begin downloading and installing the tool.</span></span>
3.  <span data-ttu-id="ef1ed-245">Выберите пункт "Не удается настроить федерацию с Office 365, Azure или другими службами, использующими Azure Active Directory".</span><span class="sxs-lookup"><span data-stu-id="ef1ed-245">Select “I can’t set up federation with Office 365, Azure, or other services that use Azure Active Directory”.</span></span>
4.  <span data-ttu-id="ef1ed-246">После загрузки и запуска средства откроется окно "Диагностика подключений".</span><span class="sxs-lookup"><span data-stu-id="ef1ed-246">Once the tool is downloaded and running, you will see the Connectivity Diagnostics window.</span></span> <span data-ttu-id="ef1ed-247">Средство предоставляет пошаговые инструкции по тестированию подключения федерации.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-247">The tool will step you through testing your federation connection.</span></span>
5.  <span data-ttu-id="ef1ed-248">Анализатор подключений откроет поставщика удостоверений SAML 2.0, чтобы вы могли выполнить вход. Введите учетные данные тестируемого субъекта-пользователя: ![SAML](media/active-directory-aadconnect-federation-saml-idp/saml1.png)</span><span class="sxs-lookup"><span data-stu-id="ef1ed-248">The Connectivity Analyzer will open your SAML 2.0 IDP for you to logon, enter the credentials for the user principal you are testing: ![SAML](media/active-directory-aadconnect-federation-saml-idp/saml1.png)</span></span>
6.  <span data-ttu-id="ef1ed-249">В диалоговом окне "Вход для выполнения тестирования федерации" следует ввести имя учетной записи и пароль клиента Azure AD, который настроен для федерации с поставщиком удостоверений SAML 2.0.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-249">At the Federation test sign-in window you should enter an account name and password for the Azure AD tenant that is configured to be federated with your SAML 2.0 identity provider.</span></span> <span data-ttu-id="ef1ed-250">Средство попытается выполнить вход, используя эти учетные данные, после чего выведет подробные результаты тестов, выполненных во время попытки входа.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-250">The tool will attempt to sign-in using those credentials and detailed results of tests performed during the sign-in attempt will be provided as output.</span></span>
<span data-ttu-id="ef1ed-251">![SAML](media/active-directory-aadconnect-federation-saml-idp/saml2.png)</span><span class="sxs-lookup"><span data-stu-id="ef1ed-251">![SAML](media/active-directory-aadconnect-federation-saml-idp/saml2.png)</span></span>
7. <span data-ttu-id="ef1ed-252">В этом окне показано, что тест не пройден.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-252">This window shows a failed result of testing.</span></span> <span data-ttu-id="ef1ed-253">Щелкнув ссылку "Просмотреть подробные результаты", можно просмотреть сведения о результатах каждого выполненного теста.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-253">Clicking on Review detailed results will show information about the results for each test that was performed.</span></span> <span data-ttu-id="ef1ed-254">Также можно сохранить результаты на диск, чтобы поделиться ими.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-254">You can also save the results to disk in order to share them.</span></span>
 
>[!NOTE]
><span data-ttu-id="ef1ed-255">Кроме того, анализатор подключений тестирует активную федерацию с помощью протоколов на основе WS*, а также протоколов ECP и PAOS.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-255">The Connectivity analyzer also tests Active Federation using the WS*-based and ECP/PAOS protocols.</span></span> <span data-ttu-id="ef1ed-256">Если они не используются, следующую ошибку можно игнорировать: "Тестируется поток активного входа с помощью конечной точки активной федерации вашего поставщика удостоверений".</span><span class="sxs-lookup"><span data-stu-id="ef1ed-256">If you are not using these you can disregard the following error: Testing the Active sign-in flow using your identity provider’s Active federation endpoint.</span></span>

### <a name="manually-verify-that-single-sign-on-has-been-set-up-correctly"></a><span data-ttu-id="ef1ed-257">Проверка правильной настройки единого входа с помощью средства</span><span class="sxs-lookup"><span data-stu-id="ef1ed-257">Manually verify that single sign-on has been set up correctly</span></span>
<span data-ttu-id="ef1ed-258">Проверка вручную — это дополнительный способ, с помощью которого можно убедиться в том, что поставщик удостоверений SAML 2.0 работает правильно во многих сценариях.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-258">Manual verification provides additional steps that you can take to ensure that your SAML 2.0 identity Provider is working properly in many scenarios.</span></span>
<span data-ttu-id="ef1ed-259">Чтобы проверить, правильно ли настроен единый вход, выполните указанные ниже действия.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-259">To verify that single sign-on has been set up correctly, complete the following steps:</span></span>


1. <span data-ttu-id="ef1ed-260">На присоединенном к домену компьютере войдите в облачную службу, используя то же имя для входа, что и в ваших корпоративных учетных данных.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-260">On a domain-joined computer, sign in to your cloud service using the same logon name that you use for your corporate credentials.</span></span>
2.  <span data-ttu-id="ef1ed-261">Щелкните в поле "Пароль".</span><span class="sxs-lookup"><span data-stu-id="ef1ed-261">Click inside the password box.</span></span> <span data-ttu-id="ef1ed-262">Если единый вход настроен, поле "Пароль" станет темнее и отобразится следующее сообщение: "Вам нужно войти на веб-сайт <your company>".</span><span class="sxs-lookup"><span data-stu-id="ef1ed-262">If single sign-on is set up, the password box will be shaded, and you will see the following message: “You are now required to sign in at <your company>.”</span></span>
3.  <span data-ttu-id="ef1ed-263">Щелкните ссылку "Войти на веб-сайт <your company>".</span><span class="sxs-lookup"><span data-stu-id="ef1ed-263">Click the Sign in at <your company> link.</span></span> <span data-ttu-id="ef1ed-264">Если вход возможен, то единый вход настроен.</span><span class="sxs-lookup"><span data-stu-id="ef1ed-264">If you are able to sign in, then single sign-on has been set up.</span></span>

## <a name="next-steps"></a><span data-ttu-id="ef1ed-265">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="ef1ed-265">Next Steps</span></span>


- [<span data-ttu-id="ef1ed-266">Управление службами федерации Active Directory и их настройка с помощью Azure AD Connect</span><span class="sxs-lookup"><span data-stu-id="ef1ed-266">Active Directory Federation Services management and customization with Azure AD Connect</span></span>](active-directory-aadconnect-federation-management.md)
- [<span data-ttu-id="ef1ed-267">Список совместимости с федерацией Azure AD</span><span class="sxs-lookup"><span data-stu-id="ef1ed-267">Azure AD federation compatibility list</span></span>](active-directory-aadconnect-federation-compatibility.md)
- [<span data-ttu-id="ef1ed-268">Выборочная установка Azure AD Connect</span><span class="sxs-lookup"><span data-stu-id="ef1ed-268">Azure AD Connect Custom Installation</span></span>](active-directory-aadconnect-get-started-custom.md)

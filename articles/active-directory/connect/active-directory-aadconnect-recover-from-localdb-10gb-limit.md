---
title: "Azure AD Connect: восстановление из LocalDB с ограничением в 10 ГБ | Документация Майкрософт"
description: "В этой статье описывается восстановление службы синхронизации Azure AD Connect при возникновении проблемы LocalDB, связанной с ограничением в 10 ГБ."
services: active-directory
documentationcenter: 
author: cychua
manager: femila
editor: 
ms.assetid: 41d081af-ed89-4e17-be34-14f7e80ae358
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/17/2017
ms.author: billmath
ms.openlocfilehash: 08e682c51b12d4506019d2f6b68e1eae0798b990
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="azure-ad-connect-how-to-recover-from-localdb-10-gb-limit"></a><span data-ttu-id="3f9d0-103">Azure AD Connect: восстановление из LocalDB с ограничением в 10 ГБ</span><span class="sxs-lookup"><span data-stu-id="3f9d0-103">Azure AD Connect: How to recover from LocalDB 10-GB limit</span></span>
<span data-ttu-id="3f9d0-104">Azure AD Connect требуется база данных SQL Server для хранения учетных данных.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-104">Azure AD Connect requires a SQL Server database to store identity data.</span></span> <span data-ttu-id="3f9d0-105">Можно использовать выпуск SQL Server 2012 Express LocalDB по умолчанию, установленный с помощью Azure AD Connect, или полную версию SQL Server.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-105">You can either use the default SQL Server 2012 Express LocalDB installed with Azure AD Connect or use your own full SQL.</span></span> <span data-ttu-id="3f9d0-106">SQL Server Express налагает ограничение в размере 10 ГБ.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-106">SQL Server Express imposes a 10-GB size limit.</span></span> <span data-ttu-id="3f9d0-107">Если при использовании LocalDB достигнут этот предел, служба синхронизации Azure AD Connect больше не сможет запускаться или выполнять синхронизацию должным образом.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-107">When using LocalDB and this limit is reached, Azure AD Connect Synchronization Service can no longer start or synchronize properly.</span></span> <span data-ttu-id="3f9d0-108">Эта статья содержит рекомендации по восстановлению.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-108">This article provides the recovery steps.</span></span>

## <a name="symptoms"></a><span data-ttu-id="3f9d0-109">Симптомы</span><span class="sxs-lookup"><span data-stu-id="3f9d0-109">Symptoms</span></span>
<span data-ttu-id="3f9d0-110">Существует два общих признака проблемы:</span><span class="sxs-lookup"><span data-stu-id="3f9d0-110">There are two common symptoms:</span></span>

* <span data-ttu-id="3f9d0-111">Служба синхронизации Azure AD Connect **работает**, но синхронизация завершается сбоем с ошибкой *stopped-database-disk-full*.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-111">Azure AD Connect Synchronization Service **is running** but fails to synchronize with *“stopped-database-disk-full”* error.</span></span>

* <span data-ttu-id="3f9d0-112">Служба синхронизации Azure AD Connect **не запускается**.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-112">Azure AD Connect Synchronization Service **is unable to start**.</span></span> <span data-ttu-id="3f9d0-113">Попытка запуска службы завершается сбоем (событие 6323) и сообщением об ошибке *Ошибка сервера в связи с недостатком места на диске для SQL Server*.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-113">When you attempt to start the service, it fails with event 6323 and error message *"The server encountered an error because SQL Server is out of disk space."*</span></span>

## <a name="short-term-recovery-steps"></a><span data-ttu-id="3f9d0-114">Краткосрочные действия по восстановлению</span><span class="sxs-lookup"><span data-stu-id="3f9d0-114">Short-term recovery steps</span></span>
<span data-ttu-id="3f9d0-115">В этом разделе описаны действия для освобождения места базы данных, необходимого для возобновления работы службы синхронизации Azure AD Connect.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-115">This section provides the steps to reclaim DB space required for Azure AD Connect Synchronization Service to resume operation.</span></span> <span data-ttu-id="3f9d0-116">Для этого нужно выполнить следующие действия:</span><span class="sxs-lookup"><span data-stu-id="3f9d0-116">The steps include:</span></span>
1. <span data-ttu-id="3f9d0-117">[Определите состояние службы синхронизации](#determine-the-synchronization-service-status).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-117">[Determine the Synchronization Service status](#determine-the-synchronization-service-status)</span></span>
2. <span data-ttu-id="3f9d0-118">[Выполните сжатие базы данных](#shrink-the-database).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-118">[Shrink the database](#shrink-the-database)</span></span>
3. <span data-ttu-id="3f9d0-119">[Удалите данные журнала выполнения](#delete-run-history-data).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-119">[Delete run history data](#delete-run-history-data)</span></span>
4. <span data-ttu-id="3f9d0-120">[Сократите срок хранения данных журнала выполнения](#shorten-retention-period-for-run-history-data).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-120">[Shorten retention period for run history data](#shorten-retention-period-for-run-history-data)</span></span>

### <a name="determine-the-synchronization-service-status"></a><span data-ttu-id="3f9d0-121">Определение состояния службы синхронизации</span><span class="sxs-lookup"><span data-stu-id="3f9d0-121">Determine the Synchronization Service status</span></span>
<span data-ttu-id="3f9d0-122">Во-первых, определите, выполняется ли служба синхронизации:</span><span class="sxs-lookup"><span data-stu-id="3f9d0-122">First, determine whether the Synchronization Service is still running or not:</span></span>

1. <span data-ttu-id="3f9d0-123">Войдите на сервер Azure AD Connect от имени администратора.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-123">Log in to your Azure AD Connect server as administrator.</span></span>

2. <span data-ttu-id="3f9d0-124">Перейдите к **диспетчеру управления службами**.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-124">Go to **Service Control Manager**.</span></span>

3. <span data-ttu-id="3f9d0-125">Проверьте состояние **службы синхронизации Microsoft Azure AD**.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-125">Check the status of **Microsoft Azure AD Sync**.</span></span>


4. <span data-ttu-id="3f9d0-126">Если она выполняется, не останавливайте и не перезапускайте службу.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-126">If it is running, do not stop or restart the service.</span></span> <span data-ttu-id="3f9d0-127">Пропустите шаг [сжатия базы данных](#shrink-the-database) и перейдите к шагу [удаления данных журнала выполнения](#delete-run-history-data).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-127">Skip [Shrink the database](#shrink-the-database) step and go to [Delete run history data](#delete-run-history-data) step.</span></span>

5. <span data-ttu-id="3f9d0-128">Попытайтесь запустить службу, если она не запущена.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-128">If it is not running, try to start the service.</span></span> <span data-ttu-id="3f9d0-129">Если служба запустилась, пропустите шаг [сжатия базы данных](#shrink-the-database) и перейдите к шагу [удаления данных журнала выполнения](#delete-run-history-data).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-129">If the service starts successfully, skip [Shrink the database](#shrink-the-database) step and go to [Delete run history data](#delete-run-history-data) step.</span></span> <span data-ttu-id="3f9d0-130">В противном случае перейдите к шагу [сжатия базы данных](#shrink-the-database).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-130">Otherwise, continue with [Shrink the database](#shrink-the-database) step.</span></span>

### <a name="shrink-the-database"></a><span data-ttu-id="3f9d0-131">Сжатие базы данных</span><span class="sxs-lookup"><span data-stu-id="3f9d0-131">Shrink the database</span></span>
<span data-ttu-id="3f9d0-132">Операция сжатия позволяет освободить достаточный объем пространства базы данных, чтобы запустить службу синхронизации.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-132">Use the Shrink operation to free up enough DB space to start the Synchronization Service.</span></span> <span data-ttu-id="3f9d0-133">При этом освобождается место в базе данных путем удаления пробелов.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-133">It frees up DB space by removing whitespaces in the database.</span></span> <span data-ttu-id="3f9d0-134">Этот наилучшее, но не всегда действующее решение.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-134">This step is best-effort as it is not guaranteed that you can always recover space.</span></span> <span data-ttu-id="3f9d0-135">Дополнительные сведения об операции сжатия см. в статье [Сжатие базы данных](https://msdn.microsoft.com/library/ms189035.aspx).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-135">To learn more about Shrink operation, read this article [Shrink a database](https://msdn.microsoft.com/library/ms189035.aspx).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="3f9d0-136">Этот шаг можно пропустить, если службу синхронизации удалось запустить.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-136">Skip this step if you can get the Synchronization Service to run.</span></span> <span data-ttu-id="3f9d0-137">Не рекомендуется сжимать базу данных SQL, так как это может привести к снижению производительности из-за увеличения фрагментации.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-137">It is not recommended to shrink the SQL DB as it can lead to poor performance due to increased fragmentation.</span></span>

<span data-ttu-id="3f9d0-138">Имя базы данных, созданной для Azure AD Connect, — **ADSync**.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-138">The name of the database created for Azure AD Connect is **ADSync**.</span></span> <span data-ttu-id="3f9d0-139">Чтобы выполнить операцию сжатия, необходимо войти от имени системного администратора или владельца базы данных.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-139">To perform a Shrink operation, you must log in either as the sysadmin or DBO of the database.</span></span> <span data-ttu-id="3f9d0-140">Во время установки Azure AD Connect следующим учетным записям предоставляются права системного администратора:</span><span class="sxs-lookup"><span data-stu-id="3f9d0-140">During Azure AD Connect installation, the following accounts are granted sysadmin rights:</span></span>
* <span data-ttu-id="3f9d0-141">локальные администраторы;</span><span class="sxs-lookup"><span data-stu-id="3f9d0-141">Local Administrators</span></span>
* <span data-ttu-id="3f9d0-142">учетная запись пользователя, которая использовалась для установки Azure AD Connect;</span><span class="sxs-lookup"><span data-stu-id="3f9d0-142">The user account that was used to run Azure AD Connect installation.</span></span>
* <span data-ttu-id="3f9d0-143">учетная запись службы синхронизации, используемая для работы службы синхронизации Azure AD Connect;</span><span class="sxs-lookup"><span data-stu-id="3f9d0-143">The Sync Service account that is used as the operating context of Azure AD Connect Synchronization Service.</span></span>
* <span data-ttu-id="3f9d0-144">локальная группа ADSyncAdmins, которая была создана во время установки.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-144">The local group ADSyncAdmins that was created during installation.</span></span>

1. <span data-ttu-id="3f9d0-145">Выполните резервное копирование базы данных в безопасное расположение, скопировав файлы **ADSync.mdf** и **ADSync_log.ldf**, расположенные в `%ProgramFiles%\program files\Microsoft Azure AD Sync\Data`.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-145">Back up the database by copying **ADSync.mdf** and **ADSync_log.ldf** files located under `%ProgramFiles%\program files\Microsoft Azure AD Sync\Data` to a safe location.</span></span>

2. <span data-ttu-id="3f9d0-146">Запустите сеанс PowerShell.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-146">Start a new PowerShell session.</span></span>

3. <span data-ttu-id="3f9d0-147">Перейдите в папку `%ProgramFiles%\Program Files\Microsoft SQL Server\110\Tools\Binn`.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-147">Navigate to folder `%ProgramFiles%\Program Files\Microsoft SQL Server\110\Tools\Binn`.</span></span>

4. <span data-ttu-id="3f9d0-148">Запустите служебную программу **sqlcmd** с помощью команды `./SQLCMD.EXE -S “(localdb)\.\ADSync” -U <Username> -P <Password>`, используя учетные данные системного администратора или владельца базы данных.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-148">Start **sqlcmd** utility by running the command `./SQLCMD.EXE -S “(localdb)\.\ADSync” -U <Username> -P <Password>`, using the credential of a sysadmin or the database DBO.</span></span>

5. <span data-ttu-id="3f9d0-149">Чтобы сжать базу данных, в командной строке sqlcmd (1>) введите `DBCC Shrinkdatabase(ADSync,1);`, а затем `GO` в следующей строке.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-149">To shrink the database, at the sqlcmd prompt (1>), enter `DBCC Shrinkdatabase(ADSync,1);`, followed by `GO` in the next line.</span></span>

6. <span data-ttu-id="3f9d0-150">Если операция выполнена успешно, попробуйте снова запустить службу синхронизации.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-150">If the operation is successful, try to start the Synchronization Service again.</span></span> <span data-ttu-id="3f9d0-151">Если удалось запустить службу синхронизации, перейдите к шагу [удаления данных журнала выполнения](#delete-run-history-data).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-151">If you can start the Synchronization Service, go to [Delete run history data](#delete-run-history-data) step.</span></span> <span data-ttu-id="3f9d0-152">В противном случае обратитесь в службу поддержки.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-152">If not, contact Support.</span></span>

### <a name="delete-run-history-data"></a><span data-ttu-id="3f9d0-153">Удаление данных журнала выполнения</span><span class="sxs-lookup"><span data-stu-id="3f9d0-153">Delete run history data</span></span>
<span data-ttu-id="3f9d0-154">По умолчанию Azure AD Connect сохраняет данные журнала выполнения, накопленные за период до 7 дней.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-154">By default, Azure AD Connect retains up to seven days’ worth of run history data.</span></span> <span data-ttu-id="3f9d0-155">На этом этапе мы удалим данные журнала выполнения, чтобы освободить место в базе данных для повторного запуска службы синхронизации Azure AD Connect.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-155">In this step, we delete the run history data to reclaim DB space so that Azure AD Connect Synchronization Service can start syncing again.</span></span>

1.  <span data-ttu-id="3f9d0-156">Запустите **Synchronization Service Manager**, выбрав "Запуск → Служба синхронизации".</span><span class="sxs-lookup"><span data-stu-id="3f9d0-156">Start **Synchronization Service Manager** by going to START → Synchronization Service.</span></span>

2.  <span data-ttu-id="3f9d0-157">Перейдите на вкладку **Операции**.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-157">Go to the **Operations** tab.</span></span>

3.  <span data-ttu-id="3f9d0-158">В разделе **Действия** выберите **Clear Runs** (Очистить выполнения).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-158">Under **Actions**, select **Clear Runs**…</span></span>

4.  <span data-ttu-id="3f9d0-159">Можно выбрать параметр **Clear all runs** (Очистить все выполнения) или **Clear runs before…<date>** (Очистить выполнения до...).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-159">You can either choose **Clear all runs** or **Clear runs before… <date>** option.</span></span> <span data-ttu-id="3f9d0-160">Рекомендуется начать с очистки тех данных журнала выполнения, которым больше двух дней.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-160">It is recommended that you start by clearing run history data that are older than two days.</span></span> <span data-ttu-id="3f9d0-161">Если вы продолжаете сталкиваться с проблемой размера базы данных, выберите параметр **Clear all runs** (Очистить все выполнения).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-161">If you continue to run into DB size issue, then choose the **Clear all runs** option.</span></span>

### <a name="shorten-retention-period-for-run-history-data"></a><span data-ttu-id="3f9d0-162">Сокращение срока хранения данных журнала выполнения</span><span class="sxs-lookup"><span data-stu-id="3f9d0-162">Shorten retention period for run history data</span></span>
<span data-ttu-id="3f9d0-163">Этот шаг необходим для снижения вероятности возникновения проблемы нехватки дискового пространства после нескольких циклов синхронизации.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-163">This step is to reduce the likelihood of running into the 10-GB limit issue after multiple sync cycles.</span></span>

1. <span data-ttu-id="3f9d0-164">Запустите новый сеанс PowerShell.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-164">Open a new PowerShell session.</span></span>

2. <span data-ttu-id="3f9d0-165">Запустите `Get-ADSyncScheduler` и обратите внимание на свойство PurgeRunHistoryInterval, которое указывает текущий срок хранения.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-165">Run `Get-ADSyncScheduler` and take note of the PurgeRunHistoryInterval property, which specifies the current retention period.</span></span>

3. <span data-ttu-id="3f9d0-166">Выполните `Set-ADSyncScheduler -PurgeRunHistoryInterval 2.00:00:00`, чтобы установить для срока хранения значение 2 дня.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-166">Run `Set-ADSyncScheduler -PurgeRunHistoryInterval 2.00:00:00` to set the retention period to two days.</span></span> <span data-ttu-id="3f9d0-167">Измените срок хранения соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-167">Adjust the retention period as appropriate.</span></span>

## <a name="long-term-solution--migrate-to-full-sql"></a><span data-ttu-id="3f9d0-168">Долгосрочное решение. Переход на полную версию SQL Server</span><span class="sxs-lookup"><span data-stu-id="3f9d0-168">Long-term solution – Migrate to full SQL</span></span>
<span data-ttu-id="3f9d0-169">Эта проблема указывает на то, что текущий размер базы данных (10 ГБ) больше не достаточен для синхронизации локальной службы Active Directory с Azure AD.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-169">In general, the issue is indicative that 10-GB database size is no longer sufficient for Azure AD Connect to synchronize your on-premises Active Directory to Azure AD.</span></span> <span data-ttu-id="3f9d0-170">Рекомендуется перейти на использование полной версии SQL Server.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-170">It is recommended that you switch to using the full version of SQL server.</span></span> <span data-ttu-id="3f9d0-171">Нельзя напрямую заменить LocalDB существующего развертывания Azure AD Connect полной версией SQL Server.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-171">You cannot directly replace the LocalDB of an existing Azure AD Connect deployment with the database of the full version of SQL.</span></span> <span data-ttu-id="3f9d0-172">Вместо этого необходимо развернуть новый сервер Azure AD Connect с полной версией SQL Server.</span><span class="sxs-lookup"><span data-stu-id="3f9d0-172">Instead, you must deploy a new Azure AD Connect server with the full version of SQL.</span></span> <span data-ttu-id="3f9d0-173">Рекомендуется выполнить обновление со сменой сервера, при котором новый сервер Azure AD Connect (с базой данных SQL) развертывается в качестве промежуточного сервера рядом с существующим сервером Azure AD Connect (с LocalDB).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-173">It is recommended that you do a swing migration where the new Azure AD Connect server (with SQL DB) is deployed as a staging server, next to the existing Azure AD Connect server (with LocalDB).</span></span> 
* <span data-ttu-id="3f9d0-174">Инструкции по настройке удаленного экземпляра SQL Server с Azure AD Connect см.в статье [Выборочная установка Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-get-started-custom).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-174">For instruction on how to configure remote SQL with Azure AD Connect, refer to article [Custom installation of Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-get-started-custom).</span></span>
* <span data-ttu-id="3f9d0-175">Инструкции по выполнению обновления со сменой сервера для Azure AD Connect см. в разделе [Обновление со сменой сервера](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-upgrade-previous-version#swing-migration).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-175">For instructions on swing migration for Azure AD Connect upgrade, refer to article [Azure AD Connect: Upgrade from a previous version to the latest](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-upgrade-previous-version#swing-migration).</span></span>

## <a name="next-steps"></a><span data-ttu-id="3f9d0-176">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="3f9d0-176">Next steps</span></span>
<span data-ttu-id="3f9d0-177">Узнайте больше об [интеграции локальных удостоверений с Azure Active Directory](active-directory-aadconnect.md).</span><span class="sxs-lookup"><span data-stu-id="3f9d0-177">Learn more about [Integrating your on-premises identities with Azure Active Directory](active-directory-aadconnect.md).</span></span>

---
title: "aaaCertificate обновления для пользователей Office 365 и Azure AD | Документы Microsoft"
description: "В этой статье описываются tooOffice 365 пользователей как tooresolve проблемы с сообщения электронной почты, уведомлением об обновлении сертификата."
services: active-directory
documentationcenter: 
author: billmath
manager: femila
editor: curtand
ms.assetid: 543b7dc1-ccc9-407f-85a1-a9944c0ba1be
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/12/2017
ms.author: billmath
ms.openlocfilehash: b9b309e06949dc5488cd628650be413f366ed347
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="renew-federation-certificates-for-office-365-and-azure-active-directory"></a><span data-ttu-id="df768-103">Обновление сертификатов федерации для Office 365 и Azure AD</span><span class="sxs-lookup"><span data-stu-id="df768-103">Renew federation certificates for Office 365 and Azure Active Directory</span></span>
## <a name="overview"></a><span data-ttu-id="df768-104">Обзор</span><span class="sxs-lookup"><span data-stu-id="df768-104">Overview</span></span>
<span data-ttu-id="df768-105">Для успешного федерации между Azure Active Directory (Azure AD) и службы федерации Active Directory (AD FS) hello сертификаты, используемые службой маркеров безопасности tooAzure AD для AD FS toosign должно соответствовать настроенным в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="df768-105">For successful federation between Azure Active Directory (Azure AD) and Active Directory Federation Services (AD FS), hello certificates used by AD FS toosign security tokens tooAzure AD should match what is configured in Azure AD.</span></span> <span data-ttu-id="df768-106">Любые различия можно привести toobroken доверия.</span><span class="sxs-lookup"><span data-stu-id="df768-106">Any mismatch can lead toobroken trust.</span></span> <span data-ttu-id="df768-107">Azure AD гарантирует, что эта информация синхронизируется при развертывании AD FS и прокси веб-приложения (для доступа к экстрасети).</span><span class="sxs-lookup"><span data-stu-id="df768-107">Azure AD ensures that this information is kept in sync when you deploy AD FS and Web Application Proxy (for extranet access).</span></span>

<span data-ttu-id="df768-108">В этой статье предоставляет дополнительные сведения о toomanage сертификаты подписи токена и синхронизировать их с помощью Azure AD в hello в следующих случаях:</span><span class="sxs-lookup"><span data-stu-id="df768-108">This article provides you additional information toomanage your token signing certificates and keep them in sync with Azure AD, in hello following cases:</span></span>

* <span data-ttu-id="df768-109">Hello прокси веб-приложения не развертываются и поэтому метаданные федерации hello недоступен в экстрасети hello.</span><span class="sxs-lookup"><span data-stu-id="df768-109">You are not deploying hello Web Application Proxy, and therefore hello federation metadata is not available in hello extranet.</span></span>
* <span data-ttu-id="df768-110">Конфигурация по умолчанию hello AD FS не используются для сертификатов для подписи маркеров.</span><span class="sxs-lookup"><span data-stu-id="df768-110">You are not using hello default configuration of AD FS for token signing certificates.</span></span>
* <span data-ttu-id="df768-111">Вы используете сторонний поставщик удостоверений.</span><span class="sxs-lookup"><span data-stu-id="df768-111">You are using a third-party identity provider.</span></span>

## <a name="default-configuration-of-ad-fs-for-token-signing-certificates"></a><span data-ttu-id="df768-112">Стандартная конфигурация AD FS для сертификатов для подписи маркеров</span><span class="sxs-lookup"><span data-stu-id="df768-112">Default configuration of AD FS for token signing certificates</span></span>
<span data-ttu-id="df768-113">для подписи маркера Hello и сертификаты расшифровки маркера, обычно самозаверяющие сертификаты и подходят для одного года.</span><span class="sxs-lookup"><span data-stu-id="df768-113">hello token signing and token decrypting certificates are usually self-signed certificates, and are good for one year.</span></span> <span data-ttu-id="df768-114">По умолчанию AD FS предусматривает процесс автоматического возобновления действия, который называется **AutoCertificateRollover**.</span><span class="sxs-lookup"><span data-stu-id="df768-114">By default, AD FS includes an auto-renewal process called **AutoCertificateRollover**.</span></span> <span data-ttu-id="df768-115">Если вы используете AD FS 2.0 или более поздней версии, службы Office 365 и Azure AD автоматически обновят ваш сертификат до окончания срока его действия.</span><span class="sxs-lookup"><span data-stu-id="df768-115">If you are using AD FS 2.0 or later, Office 365 and Azure AD automatically update your certificate before it expires.</span></span>

### <a name="renewal-notification-from-hello-office-365-portal-or-an-email"></a><span data-ttu-id="df768-116">Уведомление обновления из портала Office 365 hello или сообщение электронной почты</span><span class="sxs-lookup"><span data-stu-id="df768-116">Renewal notification from hello Office 365 portal or an email</span></span>
> [!NOTE]
> <span data-ttu-id="df768-117">Если вы получили сообщение электронной почты или портала уведомления, запрашивающее toorenew сертификат для Office, в разделе [управление изменяет сертификаты подписи tootoken](#managecerts) toocheck при необходимости tootake какие-либо действия.</span><span class="sxs-lookup"><span data-stu-id="df768-117">If you received an email or a portal notification asking you toorenew your certificate for Office, see [Managing changes tootoken signing certificates](#managecerts) toocheck if you need tootake any action.</span></span> <span data-ttu-id="df768-118">Корпорации Майкрософт известно возможная проблема, которая может привести к получению toonotifications для обновления сертификатов, которые были отправлены, даже в том случае, если не требуется никаких действий.</span><span class="sxs-lookup"><span data-stu-id="df768-118">Microsoft is aware of a possible issue that can lead toonotifications for certificate renewal being sent, even when no action is required.</span></span>
>
>

<span data-ttu-id="df768-119">Azure AD попыток метаданных федерации toomonitor hello и токен hello обновления сертификатов подписи, как указано в метаданных.</span><span class="sxs-lookup"><span data-stu-id="df768-119">Azure AD attempts toomonitor hello federation metadata, and update hello token signing certificates as indicated by this metadata.</span></span> <span data-ttu-id="df768-120">30 дней до истечения срока действия hello сертификатов подписи токена hello Azure AD проверяет, если доступны новые сертификаты путем опроса hello метаданных федерации.</span><span class="sxs-lookup"><span data-stu-id="df768-120">30 days before hello expiration of hello token signing certificates, Azure AD checks if new certificates are available by polling hello federation metadata.</span></span>

* <span data-ttu-id="df768-121">Если он успешно опрашивать метаданных федерации hello и получить новые сертификаты hello, никакого уведомления по электронной почте или предупреждения в портал Office 365 hello выдается toohello пользователя.</span><span class="sxs-lookup"><span data-stu-id="df768-121">If it can successfully poll hello federation metadata and retrieve hello new certificates, no email notification or warning in hello Office 365 portal is issued toohello user.</span></span>
* <span data-ttu-id="df768-122">Если не удалось получить новый маркер hello сертификаты подписи, либо потому, что метаданные федерации hello недоступен или не включена операция переключения сертификата автоматическое, Azure AD выдает уведомление по электронной почте и предупреждение портала Office 365 hello.</span><span class="sxs-lookup"><span data-stu-id="df768-122">If it cannot retrieve hello new token signing certificates, either because hello federation metadata is not reachable or automatic certificate rollover is not enabled, Azure AD issues an email notification and a warning in hello Office 365 portal.</span></span>

![Уведомление на портале Office 365](./media/active-directory-aadconnect-o365-certs/notification.png)

> [!IMPORTANT]
> <span data-ttu-id="df768-124">Если вы используете службы федерации Active Directory, tooensure непрерывность бизнес-процессов, убедитесь, серверы имеют hello, после обновления, чтобы не происходят сбои проверки подлинности для известных проблем.</span><span class="sxs-lookup"><span data-stu-id="df768-124">If you are using AD FS, tooensure business continuity, please verify that your servers have hello following updates so that authentication failures for known issues do not occur.</span></span> <span data-ttu-id="df768-125">Это позволит устранить известные проблемы с прокси-сервером AD FS при текущем и последующем возобновлении действия сертификатов.</span><span class="sxs-lookup"><span data-stu-id="df768-125">This mitigates known AD FS proxy server issues for this renewal and future renewal periods:</span></span>
>
> <span data-ttu-id="df768-126">Server 2012 R2 — [Накопительный пакет обновления от мая 2014 г. для Windows RT 8.1, Windows 8.1 и Windows Server 2012 R2](http://support.microsoft.com/kb/2955164).</span><span class="sxs-lookup"><span data-stu-id="df768-126">Server 2012 R2 - [Windows Server May 2014 rollup](http://support.microsoft.com/kb/2955164)</span></span>
>
> <span data-ttu-id="df768-127">Server 2008 R2 и 2012 — [Authentication through proxy fails in Windows Server 2012 or Windows Server 2008 R2 SP1](http://support.microsoft.com/kb/3094446)</span><span class="sxs-lookup"><span data-stu-id="df768-127">Server 2008 R2 and 2012 - [Authentication through proxy fails in Windows Server 2012 or Windows 2008 R2 SP1](http://support.microsoft.com/kb/3094446)</span></span>
>
>

## <span data-ttu-id="df768-128">Проверьте, если hello сертификаты должны обновить toobe<a name="managecerts"></a></span><span class="sxs-lookup"><span data-stu-id="df768-128">Check if hello certificates need toobe updated <a name="managecerts"></a></span></span>
### <a name="step-1-check-hello-autocertificaterollover-state"></a><span data-ttu-id="df768-129">Шаг 1: Проверьте состояние AutoCertificateRollover hello</span><span class="sxs-lookup"><span data-stu-id="df768-129">Step 1: Check hello AutoCertificateRollover state</span></span>
<span data-ttu-id="df768-130">На сервере AD FS откройте PowerShell.</span><span class="sxs-lookup"><span data-stu-id="df768-130">On your AD FS server, open PowerShell.</span></span> <span data-ttu-id="df768-131">Проверьте, что hello AutoCertificateRollover имеет значение tooTrue.</span><span class="sxs-lookup"><span data-stu-id="df768-131">Check that hello AutoCertificateRollover value is set tooTrue.</span></span>

    Get-Adfsproperties

![AutoCertificateRollover](./media/active-directory-aadconnect-o365-certs/autocertrollover.png)

>[!NOTE] 
><span data-ttu-id="df768-133">При использовании AD FS 2.0 необходимо сначала выполнить команду Add-Pssnapin Microsoft.Adfs.Powershell.</span><span class="sxs-lookup"><span data-stu-id="df768-133">If you are using AD FS 2.0, first run Add-Pssnapin Microsoft.Adfs.Powershell.</span></span>

### <a name="step-2-confirm-that-ad-fs-and-azure-ad-are-in-sync"></a><span data-ttu-id="df768-134">Шаг 2. Убедитесь, что службы AD FS и Azure AD синхронизированы</span><span class="sxs-lookup"><span data-stu-id="df768-134">Step 2: Confirm that AD FS and Azure AD are in sync</span></span>
<span data-ttu-id="df768-135">На сервере AD FS откройте строку hello Azure AD PowerShell и подключитесь tooAzure AD.</span><span class="sxs-lookup"><span data-stu-id="df768-135">On your AD FS server, open hello Azure AD PowerShell prompt, and connect tooAzure AD.</span></span>

> [!NOTE]
> <span data-ttu-id="df768-136">Вы можете скачать Azure AD PowerShell [здесь](https://technet.microsoft.com/library/jj151815.aspx).</span><span class="sxs-lookup"><span data-stu-id="df768-136">You can download Azure AD PowerShell [here](https://technet.microsoft.com/library/jj151815.aspx).</span></span>
>
>

    Connect-MsolService

<span data-ttu-id="df768-137">Проверьте сертификаты hello настроены в AD FS и свойства отношений доверия Azure AD для hello указанного домена.</span><span class="sxs-lookup"><span data-stu-id="df768-137">Check hello certificates configured in AD FS and Azure AD trust properties for hello specified domain.</span></span>

    Get-MsolFederationProperty -DomainName <domain.name> | FL Source, TokenSigningCertificate

![Get-MsolFederationProperty](./media/active-directory-aadconnect-o365-certs/certsync.png)

<span data-ttu-id="df768-139">Если отпечатки hello в обоих hello выходы совпадения, ваши сертификаты синхронизированы с Azure AD.</span><span class="sxs-lookup"><span data-stu-id="df768-139">If hello thumbprints in both hello outputs match, your certificates are in sync with Azure AD.</span></span>

### <a name="step-3-check-if-your-certificate-is-about-tooexpire"></a><span data-ttu-id="df768-140">Шаг 3: Проверьте, является ли сертификат о tooexpire</span><span class="sxs-lookup"><span data-stu-id="df768-140">Step 3: Check if your certificate is about tooexpire</span></span>
<span data-ttu-id="df768-141">В выходных данных hello Get-MsolFederationProperty или Get-AdfsCertificate проверьте дату hello в разделе «Не после.»</span><span class="sxs-lookup"><span data-stu-id="df768-141">In hello output of either Get-MsolFederationProperty or Get-AdfsCertificate, check for hello date under "Not After."</span></span> <span data-ttu-id="df768-142">Если дата hello немедленно менее 30 дней, необходимо принять действие.</span><span class="sxs-lookup"><span data-stu-id="df768-142">If hello date is less than 30 days away, you should take action.</span></span>

| <span data-ttu-id="df768-143">AutoCertificateRollover</span><span class="sxs-lookup"><span data-stu-id="df768-143">AutoCertificateRollover</span></span> | <span data-ttu-id="df768-144">Сертификаты синхронизированы с Azure AD</span><span class="sxs-lookup"><span data-stu-id="df768-144">Certificates in sync with Azure AD</span></span> | <span data-ttu-id="df768-145">Метаданные федерации общедоступны</span><span class="sxs-lookup"><span data-stu-id="df768-145">Federation metadata is publicly accessible</span></span> | <span data-ttu-id="df768-146">Срок действия</span><span class="sxs-lookup"><span data-stu-id="df768-146">Validity</span></span> | <span data-ttu-id="df768-147">Действие</span><span class="sxs-lookup"><span data-stu-id="df768-147">Action</span></span> |
|:---:|:---:|:---:|:---:|:---:|
| <span data-ttu-id="df768-148">Да</span><span class="sxs-lookup"><span data-stu-id="df768-148">Yes</span></span> |<span data-ttu-id="df768-149">Да</span><span class="sxs-lookup"><span data-stu-id="df768-149">Yes</span></span> |<span data-ttu-id="df768-150">Да</span><span class="sxs-lookup"><span data-stu-id="df768-150">Yes</span></span> |- |<span data-ttu-id="df768-151">Никаких действий не требуется.</span><span class="sxs-lookup"><span data-stu-id="df768-151">No action needed.</span></span> <span data-ttu-id="df768-152">См. раздел [Автоматическое возобновление действия сертификата для подписи маркера](#autorenew).</span><span class="sxs-lookup"><span data-stu-id="df768-152">See [Renew token signing certificate automatically](#autorenew).</span></span> |
| <span data-ttu-id="df768-153">Да</span><span class="sxs-lookup"><span data-stu-id="df768-153">Yes</span></span> |<span data-ttu-id="df768-154">Нет</span><span class="sxs-lookup"><span data-stu-id="df768-154">No</span></span> |- |<span data-ttu-id="df768-155">Менее 15 дней</span><span class="sxs-lookup"><span data-stu-id="df768-155">Less than 15 days</span></span> |<span data-ttu-id="df768-156">Обновите немедленно.</span><span class="sxs-lookup"><span data-stu-id="df768-156">Renew immediately.</span></span> <span data-ttu-id="df768-157">См. раздел [Возобновление действия сертификата для подписи маркера вручную](#manualrenew).</span><span class="sxs-lookup"><span data-stu-id="df768-157">See [Renew token signing certificate manually](#manualrenew).</span></span> |
| <span data-ttu-id="df768-158">Нет</span><span class="sxs-lookup"><span data-stu-id="df768-158">No</span></span> |- |- |<span data-ttu-id="df768-159">Менее 30 дней</span><span class="sxs-lookup"><span data-stu-id="df768-159">Less than 30 days</span></span> |<span data-ttu-id="df768-160">Обновите немедленно.</span><span class="sxs-lookup"><span data-stu-id="df768-160">Renew immediately.</span></span> <span data-ttu-id="df768-161">См. раздел [Возобновление действия сертификата для подписи маркера вручную](#manualrenew).</span><span class="sxs-lookup"><span data-stu-id="df768-161">See [Renew token signing certificate manually](#manualrenew).</span></span> |

<span data-ttu-id="df768-162">\[-] — не имеет значения</span><span class="sxs-lookup"><span data-stu-id="df768-162">\[-]  Does not matter</span></span>

## <span data-ttu-id="df768-163">Обновления автоматически сертификат для подписи маркера hello (рекомендуется)<a name="autorenew"></a></span><span class="sxs-lookup"><span data-stu-id="df768-163">Renew hello token signing certificate automatically (recommended) <a name="autorenew"></a></span></span>
<span data-ttu-id="df768-164">Не требуется tooperform какие-то действия, если выполняются оба указанных ниже hello:</span><span class="sxs-lookup"><span data-stu-id="df768-164">You don't need tooperform any manual steps if both of hello following are true:</span></span>

* <span data-ttu-id="df768-165">Развертывания прокси веб-приложения, позволяющие получить доступ к метаданным федерации toohello из экстрасети hello.</span><span class="sxs-lookup"><span data-stu-id="df768-165">You have deployed Web Application Proxy, which can enable access toohello federation metadata from hello extranet.</span></span>
* <span data-ttu-id="df768-166">Используется конфигурация по умолчанию hello AD FS (AutoCertificateRollover включен).</span><span class="sxs-lookup"><span data-stu-id="df768-166">You are using hello AD FS default configuration (AutoCertificateRollover is enabled).</span></span>

<span data-ttu-id="df768-167">Убедитесь, что hello следующие tooconfirm, hello сертификатов могут обновляться автоматически.</span><span class="sxs-lookup"><span data-stu-id="df768-167">Check hello following tooconfirm that hello certificate can be automatically updated.</span></span>

<span data-ttu-id="df768-168">**1. hello AD FS свойство AutoCertificateRollover должно быть задано tooTrue.**</span><span class="sxs-lookup"><span data-stu-id="df768-168">**1. hello AD FS property AutoCertificateRollover must be set tooTrue.**</span></span> <span data-ttu-id="df768-169">Это означает, что службы федерации Active Directory автоматически создаст новый подписи маркеров и сертификаты для расшифровки токенов, прежде чем те, срок действия старых hello.</span><span class="sxs-lookup"><span data-stu-id="df768-169">This indicates that AD FS will automatically generate new token signing and token decryption certificates, before hello old ones expire.</span></span>

<span data-ttu-id="df768-170">**2. метаданные федерации hello AD FS является общедоступным.**</span><span class="sxs-lookup"><span data-stu-id="df768-170">**2. hello AD FS federation metadata is publicly accessible.**</span></span> <span data-ttu-id="df768-171">Убедитесь, что метаданные федерации, перейдя по toohello общедоступный следующий URL-адрес с компьютера hello общедоступный Интернет (за пределами корпоративной сети hello):</span><span class="sxs-lookup"><span data-stu-id="df768-171">Check that your federation metadata is publicly accessible by navigating toohello following URL from a computer on hello public internet (off of hello corporate network):</span></span>

<span data-ttu-id="df768-172">https://(ваше_имя_FS)/federationmetadata/2007-06/federationmetadata.xml</span><span class="sxs-lookup"><span data-stu-id="df768-172">https://(your_FS_name)/federationmetadata/2007-06/federationmetadata.xml</span></span>

<span data-ttu-id="df768-173">где `(your_FS_name) `заменяется hello имя службы федерации узел использует вашей организации, например fs.contoso.com.  При наличии возможности tooverify обоих этих параметров успешно, у вас toodo других действий.</span><span class="sxs-lookup"><span data-stu-id="df768-173">where `(your_FS_name) `is replaced with hello federation service host name your organization uses, such as fs.contoso.com.  If you are able tooverify both of these settings successfully, you do not have toodo anything else.</span></span>  

<span data-ttu-id="df768-174">Пример: https://fs.contoso.com/federationmetadata/2007-06/federationmetadata.xml</span><span class="sxs-lookup"><span data-stu-id="df768-174">Example: https://fs.contoso.com/federationmetadata/2007-06/federationmetadata.xml</span></span>

## <span data-ttu-id="df768-175">Обновить hello сертификат подписи токена вручную<a name="manualrenew"></a></span><span class="sxs-lookup"><span data-stu-id="df768-175">Renew hello token signing certificate manually <a name="manualrenew"></a></span></span>
<span data-ttu-id="df768-176">Вы можете toorenew сертификаты для подписи токенов hello вручную.</span><span class="sxs-lookup"><span data-stu-id="df768-176">You may choose toorenew hello token signing certificates manually.</span></span> <span data-ttu-id="df768-177">Например hello следующие сценарии могут лучше подходит для ручного обновления:</span><span class="sxs-lookup"><span data-stu-id="df768-177">For example, hello following scenarios might work better for manual renewal:</span></span>

* <span data-ttu-id="df768-178">Сертификаты для подписи маркеров не являются самозаверяющими.</span><span class="sxs-lookup"><span data-stu-id="df768-178">Token signing certificates are not self-signed certificates.</span></span> <span data-ttu-id="df768-179">Hello наиболее распространенной причиной этого является то, что ваша организация управляет AD FS сертификатов, выдаваемых ЦС организации.</span><span class="sxs-lookup"><span data-stu-id="df768-179">hello most common reason for this is that your organization manages AD FS certificates enrolled from an organizational certificate authority.</span></span>
* <span data-ttu-id="df768-180">Сетевая безопасность не допускает toobe метаданные федерации hello общедоступным.</span><span class="sxs-lookup"><span data-stu-id="df768-180">Network security does not allow hello federation metadata toobe publicly available.</span></span>

<span data-ttu-id="df768-181">В этих сценариях каждый раз при обновлении сертификатов, для подписи маркеров hello необходимо также обновить доменом Office 365 с помощью команды PowerShell hello, Update-MsolFederatedDomain.</span><span class="sxs-lookup"><span data-stu-id="df768-181">In these scenarios, every time you update hello token signing certificates, you must also update your Office 365 domain by using hello PowerShell command, Update-MsolFederatedDomain.</span></span>

### <a name="step-1-ensure-that-ad-fs-has-new-token-signing-certificates"></a><span data-ttu-id="df768-182">Шаг 1. Убедитесь, что в службах AD FS используются новые сертификаты для подписи маркеров</span><span class="sxs-lookup"><span data-stu-id="df768-182">Step 1: Ensure that AD FS has new token signing certificates</span></span>
<span data-ttu-id="df768-183">**Нестандартная конфигурация**</span><span class="sxs-lookup"><span data-stu-id="df768-183">**Non-default configuration**</span></span>

<span data-ttu-id="df768-184">При использовании нестандартной конфигурации AD FS, (где **AutoCertificateRollover** задано слишком**False**), возможно, вы используете пользовательские сертификаты (не самозаверяющий).</span><span class="sxs-lookup"><span data-stu-id="df768-184">If you are using a non-default configuration of AD FS (where **AutoCertificateRollover** is set too**False**), you are probably using custom certificates (not self-signed).</span></span> <span data-ttu-id="df768-185">Дополнительные сведения о том, как toorenew hello AD FS сертификатов подписи маркеров см. в разделе [рекомендации для клиентов, не использующих AD FS самозаверяющие сертификаты](https://msdn.microsoft.com/library/azure/JJ933264.aspx#BKMK_NotADFSCert).</span><span class="sxs-lookup"><span data-stu-id="df768-185">For more information about how toorenew hello AD FS token signing certificates, see [Guidance for customers not using AD FS self-signed certificates](https://msdn.microsoft.com/library/azure/JJ933264.aspx#BKMK_NotADFSCert).</span></span>

<span data-ttu-id="df768-186">**Метаданные федерации не являются общедоступными**</span><span class="sxs-lookup"><span data-stu-id="df768-186">**Federation metadata is not publicly available**</span></span>

<span data-ttu-id="df768-187">На hello другой стороны, если **AutoCertificateRollover** задано слишком**True**, но метаданные федерации не является общедоступным, сначала убедитесь, что новый сертификат для подписи маркера было создано с AD ФЕДЕРАЦИИ ACTIVE DIRECTORY.</span><span class="sxs-lookup"><span data-stu-id="df768-187">On hello other hand, if **AutoCertificateRollover** is set too**True**, but your federation metadata is not publicly accessible, first make sure that new token signing certificates have been generated by AD FS.</span></span> <span data-ttu-id="df768-188">Убедитесь, что у вас есть новый маркер подписи сертификатов, выполнив hello следующие шаги:</span><span class="sxs-lookup"><span data-stu-id="df768-188">Confirm you have new token signing certificates by taking hello following steps:</span></span>

1. <span data-ttu-id="df768-189">Убедитесь, что вы вошли на сервер toohello первичного AD FS.</span><span class="sxs-lookup"><span data-stu-id="df768-189">Verify that you are logged on toohello primary AD FS server.</span></span>
2. <span data-ttu-id="df768-190">Проверьте текущие сертификаты подписи hello в AD FS, открыв окно командной строки PowerShell и выполнив hello следующую команду:</span><span class="sxs-lookup"><span data-stu-id="df768-190">Check hello current signing certificates in AD FS by opening a PowerShell command window, and running hello following command:</span></span>

    <span data-ttu-id="df768-191">PS C:\>Get-ADFSCertificate –CertificateType token-signing</span><span class="sxs-lookup"><span data-stu-id="df768-191">PS C:\>Get-ADFSCertificate –CertificateType token-signing</span></span>

   > [!NOTE]
   > <span data-ttu-id="df768-192">При использовании AD FS 2.0 необходимо сначала выполнить команду Add-Pssnapin Microsoft.Adfs.Powershell.</span><span class="sxs-lookup"><span data-stu-id="df768-192">If you are using AD FS 2.0, you should run Add-Pssnapin Microsoft.Adfs.Powershell first.</span></span>
   >
   >
3. <span data-ttu-id="df768-193">Посмотрите на выходные данные команды hello во все сертификаты в списке.</span><span class="sxs-lookup"><span data-stu-id="df768-193">Look at hello command output at any certificates listed.</span></span> <span data-ttu-id="df768-194">Если AD FS создан новый сертификат, вы увидите два сертификата в выходных данных hello: один для какой hello **IsPrimary** значение **True** и hello **NotAfter** Дата в течение 5 дней и один для которого **IsPrimary** — **False** и **NotAfter** о год в будущем hello.</span><span class="sxs-lookup"><span data-stu-id="df768-194">If AD FS has generated a new certificate, you should see two certificates in hello output: one for which hello **IsPrimary** value is **True** and hello **NotAfter** date is within 5 days, and one for which **IsPrimary** is **False** and **NotAfter** is about a year in hello future.</span></span>
4. <span data-ttu-id="df768-195">Если только один сертификат в разделе, а hello **NotAfter** дата находится в пределах 5 дней, вы должны toogenerate новый сертификат.</span><span class="sxs-lookup"><span data-stu-id="df768-195">If you only see one certificate, and hello **NotAfter** date is within 5 days, you need toogenerate a new certificate.</span></span>
5. <span data-ttu-id="df768-196">toogenerate новый сертификат, выполните следующую команду в командной строке PowerShell hello: `PS C:\>Update-ADFSCertificate –CertificateType token-signing`.</span><span class="sxs-lookup"><span data-stu-id="df768-196">toogenerate a new certificate, execute hello following command at a PowerShell command prompt: `PS C:\>Update-ADFSCertificate –CertificateType token-signing`.</span></span>
6. <span data-ttu-id="df768-197">Проверка обновления hello, выполнив следующую команду еще раз hello: PS C:\>Get-ADFSCertificate — CertificateType подписи токена</span><span class="sxs-lookup"><span data-stu-id="df768-197">Verify hello update by running hello following command again: PS C:\>Get-ADFSCertificate –CertificateType token-signing</span></span>

<span data-ttu-id="df768-198">Теперь будут указаны два сертификата, один из которых имеет **NotAfter** Дата приблизительно на год в будущем hello и какие hello **IsPrimary** значение **False**.</span><span class="sxs-lookup"><span data-stu-id="df768-198">Two certificates should be listed now, one of which has a **NotAfter** date of approximately one year in hello future, and for which hello **IsPrimary** value is **False**.</span></span>

### <a name="step-2-update-hello-new-token-signing-certificates-for-hello-office-365-trust"></a><span data-ttu-id="df768-199">Шаг 2: Обновление hello новый маркер подписи сертификатов для доверия hello Office 365</span><span class="sxs-lookup"><span data-stu-id="df768-199">Step 2: Update hello new token signing certificates for hello Office 365 trust</span></span>
<span data-ttu-id="df768-200">Обновление Office 365 с hello новый маркер подписи сертификатов toobe использовать hello отношений доверия, следующим образом.</span><span class="sxs-lookup"><span data-stu-id="df768-200">Update Office 365 with hello new token signing certificates toobe used for hello trust, as follows.</span></span>

1. <span data-ttu-id="df768-201">Откройте hello Microsoft Azure Active Directory модуля для Windows PowerShell.</span><span class="sxs-lookup"><span data-stu-id="df768-201">Open hello Microsoft Azure Active Directory Module for Windows PowerShell.</span></span>
2. <span data-ttu-id="df768-202">Запустите $cred=Get-Credential.</span><span class="sxs-lookup"><span data-stu-id="df768-202">Run $cred=Get-Credential.</span></span> <span data-ttu-id="df768-203">Если этот командлет запрашивает учетные данные, введите данные учетной записи администратора облачных служб.</span><span class="sxs-lookup"><span data-stu-id="df768-203">When this cmdlet prompts you for credentials, type your cloud service administrator account credentials.</span></span>
3. <span data-ttu-id="df768-204">Запустите Connect-MsolService –Credential $cred. Этот командлет подключается toohello облачной службы.</span><span class="sxs-lookup"><span data-stu-id="df768-204">Run Connect-MsolService –Credential $cred. This cmdlet connects you toohello cloud service.</span></span> <span data-ttu-id="df768-205">Перед выполнением дополнительных командлетов hello устанавливается средством hello требуется создание контекста, который используется для подключения toohello облачной службы.</span><span class="sxs-lookup"><span data-stu-id="df768-205">Creating a context that connects you toohello cloud service is required before running any of hello additional cmdlets installed by hello tool.</span></span>
4. <span data-ttu-id="df768-206">Если эти команды выполняются на компьютере, который не является hello AD FS основной сервер федерации, выполните Set-MSOLAdfscontext-компьютере <AD FS primary server>, где <AD FS primary server> является hello внутреннее полное ДОМЕННОЕ имя сервера hello основной AD FS.</span><span class="sxs-lookup"><span data-stu-id="df768-206">If you are running these commands on a computer that is not hello AD FS primary federation server, run Set-MSOLAdfscontext -Computer <AD FS primary server>, where <AD FS primary server> is hello internal FQDN name of hello primary AD FS server.</span></span> <span data-ttu-id="df768-207">Этот командлет создает контекст, который подключает вас tooAD федерации Active Directory.</span><span class="sxs-lookup"><span data-stu-id="df768-207">This cmdlet creates a context that connects you tooAD FS.</span></span>
5. <span data-ttu-id="df768-208">Выполните команду Update-MSOLFederatedDomain -DomainName <domain>.</span><span class="sxs-lookup"><span data-stu-id="df768-208">Run Update-MSOLFederatedDomain –DomainName <domain>.</span></span> <span data-ttu-id="df768-209">Этот командлет обновляет параметры hello от AD FS в облачную службу hello и настраивает hello доверительных отношений между двумя hello.</span><span class="sxs-lookup"><span data-stu-id="df768-209">This cmdlet updates hello settings from AD FS into hello cloud service, and configures hello trust relationship between hello two.</span></span>

> [!NOTE]
> <span data-ttu-id="df768-210">Если вам требуется toosupport нескольких доменов верхнего уровня, например contoso.com и fabrikam.com, необходимо использовать hello **SupportMultipleDomain** с любым командлетом.</span><span class="sxs-lookup"><span data-stu-id="df768-210">If you need toosupport multiple top-level domains, such as contoso.com and fabrikam.com, you must use hello **SupportMultipleDomain** switch with any cmdlets.</span></span> <span data-ttu-id="df768-211">Дополнительные сведения см. в статье [Поддержка нескольких доменов для федерации с Azure AD](active-directory-aadconnect-multiple-domains.md).</span><span class="sxs-lookup"><span data-stu-id="df768-211">For more information, see [Support for Multiple Top Level Domains](active-directory-aadconnect-multiple-domains.md).</span></span>
>
>

## <span data-ttu-id="df768-212">Восстановление доверия Azure AD с помощью Azure AD Connect <a name="connectrenew"></a></span><span class="sxs-lookup"><span data-stu-id="df768-212">Repair Azure AD trust by using Azure AD Connect <a name="connectrenew"></a></span></span>
<span data-ttu-id="df768-213">Если вы настроили вашей фермы AD FS и отношение доверия Azure AD с помощью Azure AD Connect, можно использовать toodetect Azure AD Connect, если требуется tootake какие-либо действия для сертификатов подписи токена.</span><span class="sxs-lookup"><span data-stu-id="df768-213">If you configured your AD FS farm and Azure AD trust by using Azure AD Connect, you can use Azure AD Connect toodetect if you need tootake any action for your token signing certificates.</span></span> <span data-ttu-id="df768-214">При необходимости toorenew hello сертификаты можно использовать Azure AD Connect toodo таким образом.</span><span class="sxs-lookup"><span data-stu-id="df768-214">If you need toorenew hello certificates, you can use Azure AD Connect toodo so.</span></span>

<span data-ttu-id="df768-215">Дополнительные сведения см. в разделе [восстановление hello доверия](active-directory-aadconnect-federation-management.md).</span><span class="sxs-lookup"><span data-stu-id="df768-215">For more information, see [Repairing hello trust](active-directory-aadconnect-federation-management.md).</span></span>

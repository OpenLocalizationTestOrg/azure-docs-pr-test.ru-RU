---
title: "Обновление сертификатов для пользователей Office 365 и Azure AD | Документация Майкрософт"
description: "В этой статье рассматриваются способы устранения проблем с сообщениями электронной почты, уведомляющими пользователей Office 365 о необходимости обновления сертификата."
services: active-directory
documentationcenter: 
author: billmath
manager: femila
editor: curtand
ms.assetid: 543b7dc1-ccc9-407f-85a1-a9944c0ba1be
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/12/2017
ms.author: billmath
ms.openlocfilehash: 7f1a3303eff9c413602e745b702baa659343eba6
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="renew-federation-certificates-for-office-365-and-azure-active-directory"></a><span data-ttu-id="cec23-103">Обновление сертификатов федерации для Office 365 и Azure AD</span><span class="sxs-lookup"><span data-stu-id="cec23-103">Renew federation certificates for Office 365 and Azure Active Directory</span></span>
## <a name="overview"></a><span data-ttu-id="cec23-104">Обзор</span><span class="sxs-lookup"><span data-stu-id="cec23-104">Overview</span></span>
<span data-ttu-id="cec23-105">Для успешной федерации между Azure Active Directory (Azure AD) и службами федерации Active Directory (AD FS) сертификаты, используемые службами AD FS для подписывания маркеров безопасности в Azure AD, должны соответствовать параметрам, настроенным в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="cec23-105">For successful federation between Azure Active Directory (Azure AD) and Active Directory Federation Services (AD FS), the certificates used by AD FS to sign security tokens to Azure AD should match what is configured in Azure AD.</span></span> <span data-ttu-id="cec23-106">Расхождение может привести к нарушению отношений доверия.</span><span class="sxs-lookup"><span data-stu-id="cec23-106">Any mismatch can lead to broken trust.</span></span> <span data-ttu-id="cec23-107">Azure AD гарантирует, что эта информация синхронизируется при развертывании AD FS и прокси веб-приложения (для доступа к экстрасети).</span><span class="sxs-lookup"><span data-stu-id="cec23-107">Azure AD ensures that this information is kept in sync when you deploy AD FS and Web Application Proxy (for extranet access).</span></span>

<span data-ttu-id="cec23-108">В этой статье представлены дополнительные сведения об управлении сертификатами для подписи маркеров и их синхронизации с Azure AD в следующих случаях:</span><span class="sxs-lookup"><span data-stu-id="cec23-108">This article provides you additional information to manage your token signing certificates and keep them in sync with Azure AD, in the following cases:</span></span>

* <span data-ttu-id="cec23-109">Вы не развертываете прокси веб-приложения, поэтому метаданные федерации недоступны в экстрасети.</span><span class="sxs-lookup"><span data-stu-id="cec23-109">You are not deploying the Web Application Proxy, and therefore the federation metadata is not available in the extranet.</span></span>
* <span data-ttu-id="cec23-110">Вы не применяете стандартную конфигурацию AD FS к сертификатам для подписи маркеров.</span><span class="sxs-lookup"><span data-stu-id="cec23-110">You are not using the default configuration of AD FS for token signing certificates.</span></span>
* <span data-ttu-id="cec23-111">Вы используете сторонний поставщик удостоверений.</span><span class="sxs-lookup"><span data-stu-id="cec23-111">You are using a third-party identity provider.</span></span>

## <a name="default-configuration-of-ad-fs-for-token-signing-certificates"></a><span data-ttu-id="cec23-112">Стандартная конфигурация AD FS для сертификатов для подписи маркеров</span><span class="sxs-lookup"><span data-stu-id="cec23-112">Default configuration of AD FS for token signing certificates</span></span>
<span data-ttu-id="cec23-113">Сертификаты для подписи маркеров и их расшифровки обычно представляют собой самозаверяющие сертификаты со сроком годности в один год.</span><span class="sxs-lookup"><span data-stu-id="cec23-113">The token signing and token decrypting certificates are usually self-signed certificates, and are good for one year.</span></span> <span data-ttu-id="cec23-114">По умолчанию AD FS предусматривает процесс автоматического возобновления действия, который называется **AutoCertificateRollover**.</span><span class="sxs-lookup"><span data-stu-id="cec23-114">By default, AD FS includes an auto-renewal process called **AutoCertificateRollover**.</span></span> <span data-ttu-id="cec23-115">Если вы используете AD FS 2.0 или более поздней версии, службы Office 365 и Azure AD автоматически обновят ваш сертификат до окончания срока его действия.</span><span class="sxs-lookup"><span data-stu-id="cec23-115">If you are using AD FS 2.0 or later, Office 365 and Azure AD automatically update your certificate before it expires.</span></span>

### <a name="renewal-notification-from-the-office-365-portal-or-an-email"></a><span data-ttu-id="cec23-116">Уведомление о возобновлении действия на портале Office 365 или по электронной почте</span><span class="sxs-lookup"><span data-stu-id="cec23-116">Renewal notification from the Office 365 portal or an email</span></span>
> [!NOTE]
> <span data-ttu-id="cec23-117">Если вы получите через портал или по электронной почте уведомление о том, что необходимо возобновить действие сертификата для Office, см. раздел об [управлении изменениями в сертификатах для подписи маркеров](#managecerts). Так вы сможете узнать, нужно ли предпринимать какие-либо действия.</span><span class="sxs-lookup"><span data-stu-id="cec23-117">If you received an email or a portal notification asking you to renew your certificate for Office, see [Managing changes to token signing certificates](#managecerts) to check if you need to take any action.</span></span> <span data-ttu-id="cec23-118">Корпорации Майкрософт известно о потенциальной проблеме, в результате которой могут отправляться уведомления о возобновлении действия сертификата, даже если никаких действий не требуется.</span><span class="sxs-lookup"><span data-stu-id="cec23-118">Microsoft is aware of a possible issue that can lead to notifications for certificate renewal being sent, even when no action is required.</span></span>
>
>

<span data-ttu-id="cec23-119">Azure AD пытается отслеживать метаданные федерации и обновлять сертификаты для подписи маркеров, как указано в этих метаданных.</span><span class="sxs-lookup"><span data-stu-id="cec23-119">Azure AD attempts to monitor the federation metadata, and update the token signing certificates as indicated by this metadata.</span></span> <span data-ttu-id="cec23-120">За 30 дней до истечения срока действия сертификатов для подписи маркеров Azure AD проверит, доступны ли новые сертификаты, путем опроса метаданных федерации.</span><span class="sxs-lookup"><span data-stu-id="cec23-120">30 days before the expiration of the token signing certificates, Azure AD checks if new certificates are available by polling the federation metadata.</span></span>

* <span data-ttu-id="cec23-121">Если метаданные федерации успешно опрошены и получены новые сертификаты, пользователь не будет получать уведомление по электронной почте или предупреждение через портал Office 365.</span><span class="sxs-lookup"><span data-stu-id="cec23-121">If it can successfully poll the federation metadata and retrieve the new certificates, no email notification or warning in the Office 365 portal is issued to the user.</span></span>
* <span data-ttu-id="cec23-122">Если новые сертификаты для подписи маркеров не удалось получить, потому что метаданные федерации недоступны или автоматическая смена сертификатов не включена, Azure AD отправит соответствующее уведомление по электронной почте, а на портале Office 365 появится предупреждение.</span><span class="sxs-lookup"><span data-stu-id="cec23-122">If it cannot retrieve the new token signing certificates, either because the federation metadata is not reachable or automatic certificate rollover is not enabled, Azure AD issues an email notification and a warning in the Office 365 portal.</span></span>

![Уведомление на портале Office 365](./media/active-directory-aadconnect-o365-certs/notification.png)

> [!IMPORTANT]
> <span data-ttu-id="cec23-124">Чтобы обеспечить непрерывность бизнес-процессов при использовании AD FS, проверьте, установлены ли на ваших серверах следующие обновления, предотвращающие ошибки проверки подлинности при известных проблемах.</span><span class="sxs-lookup"><span data-stu-id="cec23-124">If you are using AD FS, to ensure business continuity, please verify that your servers have the following updates so that authentication failures for known issues do not occur.</span></span> <span data-ttu-id="cec23-125">Это позволит устранить известные проблемы с прокси-сервером AD FS при текущем и последующем возобновлении действия сертификатов.</span><span class="sxs-lookup"><span data-stu-id="cec23-125">This mitigates known AD FS proxy server issues for this renewal and future renewal periods:</span></span>
>
> <span data-ttu-id="cec23-126">Server 2012 R2 — [Накопительный пакет обновления от мая 2014 г. для Windows RT 8.1, Windows 8.1 и Windows Server 2012 R2](http://support.microsoft.com/kb/2955164).</span><span class="sxs-lookup"><span data-stu-id="cec23-126">Server 2012 R2 - [Windows Server May 2014 rollup](http://support.microsoft.com/kb/2955164)</span></span>
>
> <span data-ttu-id="cec23-127">Server 2008 R2 и 2012 — [Authentication through proxy fails in Windows Server 2012 or Windows Server 2008 R2 SP1](http://support.microsoft.com/kb/3094446)</span><span class="sxs-lookup"><span data-stu-id="cec23-127">Server 2008 R2 and 2012 - [Authentication through proxy fails in Windows Server 2012 or Windows 2008 R2 SP1](http://support.microsoft.com/kb/3094446)</span></span>
>
>

## <span data-ttu-id="cec23-128">Проверка необходимости в обновлении сертификатов <a name="managecerts"></a></span><span class="sxs-lookup"><span data-stu-id="cec23-128">Check if the certificates need to be updated <a name="managecerts"></a></span></span>
### <a name="step-1-check-the-autocertificaterollover-state"></a><span data-ttu-id="cec23-129">Шаг 1. Проверка состояния свойства AutoCertificateRollover</span><span class="sxs-lookup"><span data-stu-id="cec23-129">Step 1: Check the AutoCertificateRollover state</span></span>
<span data-ttu-id="cec23-130">На сервере AD FS откройте PowerShell.</span><span class="sxs-lookup"><span data-stu-id="cec23-130">On your AD FS server, open PowerShell.</span></span> <span data-ttu-id="cec23-131">Удостоверьтесь, что для AutoCertificateRollover задано значение True.</span><span class="sxs-lookup"><span data-stu-id="cec23-131">Check that the AutoCertificateRollover value is set to True.</span></span>

    Get-Adfsproperties

![AutoCertificateRollover](./media/active-directory-aadconnect-o365-certs/autocertrollover.png)

>[!NOTE] 
><span data-ttu-id="cec23-133">При использовании AD FS 2.0 необходимо сначала выполнить команду Add-Pssnapin Microsoft.Adfs.Powershell.</span><span class="sxs-lookup"><span data-stu-id="cec23-133">If you are using AD FS 2.0, first run Add-Pssnapin Microsoft.Adfs.Powershell.</span></span>

### <a name="step-2-confirm-that-ad-fs-and-azure-ad-are-in-sync"></a><span data-ttu-id="cec23-134">Шаг 2. Убедитесь, что службы AD FS и Azure AD синхронизированы</span><span class="sxs-lookup"><span data-stu-id="cec23-134">Step 2: Confirm that AD FS and Azure AD are in sync</span></span>
<span data-ttu-id="cec23-135">На сервере AD FS откройте командную строку Azure AD PowerShell и подключитесь к Azure AD.</span><span class="sxs-lookup"><span data-stu-id="cec23-135">On your AD FS server, open the Azure AD PowerShell prompt, and connect to Azure AD.</span></span>

> [!NOTE]
> <span data-ttu-id="cec23-136">Вы можете скачать Azure AD PowerShell [здесь](https://technet.microsoft.com/library/jj151815.aspx).</span><span class="sxs-lookup"><span data-stu-id="cec23-136">You can download Azure AD PowerShell [here](https://technet.microsoft.com/library/jj151815.aspx).</span></span>
>
>

    Connect-MsolService

<span data-ttu-id="cec23-137">Проверьте сертификаты, настроенные в AD FS, и свойства доверия Azure AD для указанного домена.</span><span class="sxs-lookup"><span data-stu-id="cec23-137">Check the certificates configured in AD FS and Azure AD trust properties for the specified domain.</span></span>

    Get-MsolFederationProperty -DomainName <domain.name> | FL Source, TokenSigningCertificate

![Get-MsolFederationProperty](./media/active-directory-aadconnect-o365-certs/certsync.png)

<span data-ttu-id="cec23-139">Если отпечатки в обоих наборах выходных данных совпадают, значит, сертификаты синхронизируются с Azure AD.</span><span class="sxs-lookup"><span data-stu-id="cec23-139">If the thumbprints in both the outputs match, your certificates are in sync with Azure AD.</span></span>

### <a name="step-3-check-if-your-certificate-is-about-to-expire"></a><span data-ttu-id="cec23-140">Шаг 3. Проверьте, не истекает ли срок действия сертификата</span><span class="sxs-lookup"><span data-stu-id="cec23-140">Step 3: Check if your certificate is about to expire</span></span>
<span data-ttu-id="cec23-141">В выходных данных Get-MsolFederationProperty или Get-AdfsCertificate проверьте дату, указанную после строки Not After.</span><span class="sxs-lookup"><span data-stu-id="cec23-141">In the output of either Get-MsolFederationProperty or Get-AdfsCertificate, check for the date under "Not After."</span></span> <span data-ttu-id="cec23-142">Если эта дата наступает менее чем через 30 дней, следует принять меры.</span><span class="sxs-lookup"><span data-stu-id="cec23-142">If the date is less than 30 days away, you should take action.</span></span>

| <span data-ttu-id="cec23-143">AutoCertificateRollover</span><span class="sxs-lookup"><span data-stu-id="cec23-143">AutoCertificateRollover</span></span> | <span data-ttu-id="cec23-144">Сертификаты синхронизированы с Azure AD</span><span class="sxs-lookup"><span data-stu-id="cec23-144">Certificates in sync with Azure AD</span></span> | <span data-ttu-id="cec23-145">Метаданные федерации общедоступны</span><span class="sxs-lookup"><span data-stu-id="cec23-145">Federation metadata is publicly accessible</span></span> | <span data-ttu-id="cec23-146">Срок действия</span><span class="sxs-lookup"><span data-stu-id="cec23-146">Validity</span></span> | <span data-ttu-id="cec23-147">Действие</span><span class="sxs-lookup"><span data-stu-id="cec23-147">Action</span></span> |
|:---:|:---:|:---:|:---:|:---:|
| <span data-ttu-id="cec23-148">Да</span><span class="sxs-lookup"><span data-stu-id="cec23-148">Yes</span></span> |<span data-ttu-id="cec23-149">Да</span><span class="sxs-lookup"><span data-stu-id="cec23-149">Yes</span></span> |<span data-ttu-id="cec23-150">Да</span><span class="sxs-lookup"><span data-stu-id="cec23-150">Yes</span></span> |- |<span data-ttu-id="cec23-151">Никаких действий не требуется.</span><span class="sxs-lookup"><span data-stu-id="cec23-151">No action needed.</span></span> <span data-ttu-id="cec23-152">См. раздел [Автоматическое возобновление действия сертификата для подписи маркера](#autorenew).</span><span class="sxs-lookup"><span data-stu-id="cec23-152">See [Renew token signing certificate automatically](#autorenew).</span></span> |
| <span data-ttu-id="cec23-153">Да</span><span class="sxs-lookup"><span data-stu-id="cec23-153">Yes</span></span> |<span data-ttu-id="cec23-154">Нет</span><span class="sxs-lookup"><span data-stu-id="cec23-154">No</span></span> |- |<span data-ttu-id="cec23-155">Менее 15 дней</span><span class="sxs-lookup"><span data-stu-id="cec23-155">Less than 15 days</span></span> |<span data-ttu-id="cec23-156">Обновите немедленно.</span><span class="sxs-lookup"><span data-stu-id="cec23-156">Renew immediately.</span></span> <span data-ttu-id="cec23-157">См. раздел [Возобновление действия сертификата для подписи маркера вручную](#manualrenew).</span><span class="sxs-lookup"><span data-stu-id="cec23-157">See [Renew token signing certificate manually](#manualrenew).</span></span> |
| <span data-ttu-id="cec23-158">Нет</span><span class="sxs-lookup"><span data-stu-id="cec23-158">No</span></span> |- |- |<span data-ttu-id="cec23-159">Менее 30 дней</span><span class="sxs-lookup"><span data-stu-id="cec23-159">Less than 30 days</span></span> |<span data-ttu-id="cec23-160">Обновите немедленно.</span><span class="sxs-lookup"><span data-stu-id="cec23-160">Renew immediately.</span></span> <span data-ttu-id="cec23-161">См. раздел [Возобновление действия сертификата для подписи маркера вручную](#manualrenew).</span><span class="sxs-lookup"><span data-stu-id="cec23-161">See [Renew token signing certificate manually](#manualrenew).</span></span> |

<span data-ttu-id="cec23-162">\[-] — не имеет значения</span><span class="sxs-lookup"><span data-stu-id="cec23-162">\[-]  Does not matter</span></span>

## <span data-ttu-id="cec23-163">Автоматическое возобновление действия сертификата для подписи маркера (рекомендуется) <a name="autorenew"></a></span><span class="sxs-lookup"><span data-stu-id="cec23-163">Renew the token signing certificate automatically (recommended) <a name="autorenew"></a></span></span>
<span data-ttu-id="cec23-164">Если приведенные ниже условия выполняются, ничего не нужно делать вручную.</span><span class="sxs-lookup"><span data-stu-id="cec23-164">You don't need to perform any manual steps if both of the following are true:</span></span>

* <span data-ttu-id="cec23-165">Вы развернули прокси веб-приложения, предоставляющий доступ к метаданным федерации из экстрасети.</span><span class="sxs-lookup"><span data-stu-id="cec23-165">You have deployed Web Application Proxy, which can enable access to the federation metadata from the extranet.</span></span>
* <span data-ttu-id="cec23-166">Вы используете стандартную конфигурацию AD FS (свойство AutoCertificateRollover включено).</span><span class="sxs-lookup"><span data-stu-id="cec23-166">You are using the AD FS default configuration (AutoCertificateRollover is enabled).</span></span>

<span data-ttu-id="cec23-167">Проверьте следующие пункты, чтобы удостовериться, что действие сертификата может обновляться автоматически.</span><span class="sxs-lookup"><span data-stu-id="cec23-167">Check the following to confirm that the certificate can be automatically updated.</span></span>

<span data-ttu-id="cec23-168">**1. Для свойства AutoCertificateRollover служб AD FS должно быть задано значение True.**</span><span class="sxs-lookup"><span data-stu-id="cec23-168">**1. The AD FS property AutoCertificateRollover must be set to True.**</span></span> <span data-ttu-id="cec23-169">Это указывает на то, что службы AD FS будут автоматически создавать сертификаты для подписи маркеров и их расшифровки до окончания срока действия старых.</span><span class="sxs-lookup"><span data-stu-id="cec23-169">This indicates that AD FS will automatically generate new token signing and token decryption certificates, before the old ones expire.</span></span>

<span data-ttu-id="cec23-170">**2. Метаданные федерации AD FS общедоступны.**</span><span class="sxs-lookup"><span data-stu-id="cec23-170">**2. The AD FS federation metadata is publicly accessible.**</span></span> <span data-ttu-id="cec23-171">Убедитесь, что метаданные федерации доступны для общего пользования через Интернет (за пределами корпоративной сети), перейдя со своего компьютера по следующему URL-адресу.</span><span class="sxs-lookup"><span data-stu-id="cec23-171">Check that your federation metadata is publicly accessible by navigating to the following URL from a computer on the public internet (off of the corporate network):</span></span>

<span data-ttu-id="cec23-172">https://(ваше_имя_FS)/federationmetadata/2007-06/federationmetadata.xml</span><span class="sxs-lookup"><span data-stu-id="cec23-172">https://(your_FS_name)/federationmetadata/2007-06/federationmetadata.xml</span></span>

<span data-ttu-id="cec23-173">где `(your_FS_name) `заменяется именем узла службы федерации, которое используется в вашей организации (например, fs.contoso.com).</span><span class="sxs-lookup"><span data-stu-id="cec23-173">where `(your_FS_name) `is replaced with the federation service host name your organization uses, such as fs.contoso.com.</span></span>  <span data-ttu-id="cec23-174">Если проверка двух этих параметров оказалась успешной, вам больше не нужно ничего делать.</span><span class="sxs-lookup"><span data-stu-id="cec23-174">If you are able to verify both of these settings successfully, you do not have to do anything else.</span></span>  

<span data-ttu-id="cec23-175">Пример: https://fs.contoso.com/federationmetadata/2007-06/federationmetadata.xml</span><span class="sxs-lookup"><span data-stu-id="cec23-175">Example: https://fs.contoso.com/federationmetadata/2007-06/federationmetadata.xml</span></span>

## <span data-ttu-id="cec23-176">Возобновление действия сертификата для подписи маркера вручную <a name="manualrenew"></a></span><span class="sxs-lookup"><span data-stu-id="cec23-176">Renew the token signing certificate manually <a name="manualrenew"></a></span></span>
<span data-ttu-id="cec23-177">Сертификаты для подписи маркеров можно обновить вручную.</span><span class="sxs-lookup"><span data-stu-id="cec23-177">You may choose to renew the token signing certificates manually.</span></span> <span data-ttu-id="cec23-178">Например, в следующих сценариях лучше выполнять ручное обновление.</span><span class="sxs-lookup"><span data-stu-id="cec23-178">For example, the following scenarios might work better for manual renewal:</span></span>

* <span data-ttu-id="cec23-179">Сертификаты для подписи маркеров не являются самозаверяющими.</span><span class="sxs-lookup"><span data-stu-id="cec23-179">Token signing certificates are not self-signed certificates.</span></span> <span data-ttu-id="cec23-180">Вероятнее всего, это происходит потому, что ваша организация использует сертификаты AD FS, зарегистрированные в центре сертификации организации.</span><span class="sxs-lookup"><span data-stu-id="cec23-180">The most common reason for this is that your organization manages AD FS certificates enrolled from an organizational certificate authority.</span></span>
* <span data-ttu-id="cec23-181">В системе безопасности сети запрещен общий доступ к метаданным федерации.</span><span class="sxs-lookup"><span data-stu-id="cec23-181">Network security does not allow the federation metadata to be publicly available.</span></span>

<span data-ttu-id="cec23-182">В этих ситуациях при каждом обновлении сертификатов для подписи маркеров также необходимо обновить домен Office 365 с помощью команды PowerShell Update-MsolFederatedDomain.</span><span class="sxs-lookup"><span data-stu-id="cec23-182">In these scenarios, every time you update the token signing certificates, you must also update your Office 365 domain by using the PowerShell command, Update-MsolFederatedDomain.</span></span>

### <a name="step-1-ensure-that-ad-fs-has-new-token-signing-certificates"></a><span data-ttu-id="cec23-183">Шаг 1. Убедитесь, что в службах AD FS используются новые сертификаты для подписи маркеров</span><span class="sxs-lookup"><span data-stu-id="cec23-183">Step 1: Ensure that AD FS has new token signing certificates</span></span>
<span data-ttu-id="cec23-184">**Нестандартная конфигурация**</span><span class="sxs-lookup"><span data-stu-id="cec23-184">**Non-default configuration**</span></span>

<span data-ttu-id="cec23-185">Если применяется нестандартная конфигурация AD FS (где значение свойства **AutoCertificateRollover** равно **False**), вероятно, вы используете настраиваемые (не самозаверяющие) сертификаты.</span><span class="sxs-lookup"><span data-stu-id="cec23-185">If you are using a non-default configuration of AD FS (where **AutoCertificateRollover** is set to **False**), you are probably using custom certificates (not self-signed).</span></span> <span data-ttu-id="cec23-186">Дополнительные сведения об обновлении сертификатов для подписи маркеров AD FS см. в разделе [Рекомендации для клиентов, не использующих самозаверяющие сертификаты AD FS](https://msdn.microsoft.com/library/azure/JJ933264.aspx#BKMK_NotADFSCert).</span><span class="sxs-lookup"><span data-stu-id="cec23-186">For more information about how to renew the AD FS token signing certificates, see [Guidance for customers not using AD FS self-signed certificates](https://msdn.microsoft.com/library/azure/JJ933264.aspx#BKMK_NotADFSCert).</span></span>

<span data-ttu-id="cec23-187">**Метаданные федерации не являются общедоступными**</span><span class="sxs-lookup"><span data-stu-id="cec23-187">**Federation metadata is not publicly available**</span></span>

<span data-ttu-id="cec23-188">С другой стороны, если значение свойства **AutoCertificateRollover** равно **True**, но метаданные федерации не являются общедоступными, сначала удостоверьтесь, что сертификаты для подписи маркеров созданы службами AD FS.</span><span class="sxs-lookup"><span data-stu-id="cec23-188">On the other hand, if **AutoCertificateRollover** is set to **True**, but your federation metadata is not publicly accessible, first make sure that new token signing certificates have been generated by AD FS.</span></span> <span data-ttu-id="cec23-189">Чтобы убедиться, что у вас есть новые сертификаты для подписи маркеров, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="cec23-189">Confirm you have new token signing certificates by taking the following steps:</span></span>

1. <span data-ttu-id="cec23-190">Удостоверьтесь, что вы вошли на основной сервер AD FS.</span><span class="sxs-lookup"><span data-stu-id="cec23-190">Verify that you are logged on to the primary AD FS server.</span></span>
2. <span data-ttu-id="cec23-191">Проверьте текущие сертификаты подписи в AD FS, открыв командное окно PowerShell и выполнив следующую команду.</span><span class="sxs-lookup"><span data-stu-id="cec23-191">Check the current signing certificates in AD FS by opening a PowerShell command window, and running the following command:</span></span>

    <span data-ttu-id="cec23-192">PS C:\>Get-ADFSCertificate –CertificateType token-signing</span><span class="sxs-lookup"><span data-stu-id="cec23-192">PS C:\>Get-ADFSCertificate –CertificateType token-signing</span></span>

   > [!NOTE]
   > <span data-ttu-id="cec23-193">При использовании AD FS 2.0 необходимо сначала выполнить команду Add-Pssnapin Microsoft.Adfs.Powershell.</span><span class="sxs-lookup"><span data-stu-id="cec23-193">If you are using AD FS 2.0, you should run Add-Pssnapin Microsoft.Adfs.Powershell first.</span></span>
   >
   >
3. <span data-ttu-id="cec23-194">Просмотрите данные, которые будут выведены для всех сертификатов в списке.</span><span class="sxs-lookup"><span data-stu-id="cec23-194">Look at the command output at any certificates listed.</span></span> <span data-ttu-id="cec23-195">Если служба AD FS создала сертификат, вы увидите два сертификата в выходных данных: один, для которого значение **IsPrimary** равно **True**, а дата **NotAfter** равна 5 дней; второй, для которого значение **IsPrimary** равно **False**, а дата **NotAfter** равна приблизительно году.</span><span class="sxs-lookup"><span data-stu-id="cec23-195">If AD FS has generated a new certificate, you should see two certificates in the output: one for which the **IsPrimary** value is **True** and the **NotAfter** date is within 5 days, and one for which **IsPrimary** is **False** and **NotAfter** is about a year in the future.</span></span>
4. <span data-ttu-id="cec23-196">Если вы видите только один сертификат, а дата **NotAfter** равна 5 дням, необходимо создать сертификат.</span><span class="sxs-lookup"><span data-stu-id="cec23-196">If you only see one certificate, and the **NotAfter** date is within 5 days, you need to generate a new certificate.</span></span>
5. <span data-ttu-id="cec23-197">Чтобы создать сертификат, в командной строке PowerShell выполните такую команду: `PS C:\>Update-ADFSCertificate –CertificateType token-signing`.</span><span class="sxs-lookup"><span data-stu-id="cec23-197">To generate a new certificate, execute the following command at a PowerShell command prompt: `PS C:\>Update-ADFSCertificate –CertificateType token-signing`.</span></span>
6. <span data-ttu-id="cec23-198">Проверьте обновление, запустив следующую команду еще раз: PS C:\>Get-ADFSCertificate –CertificateType token-signing</span><span class="sxs-lookup"><span data-stu-id="cec23-198">Verify the update by running the following command again: PS C:\>Get-ADFSCertificate –CertificateType token-signing</span></span>

<span data-ttu-id="cec23-199">Теперь должны появиться два сертификата, один из которых имеет дату **NotAfter**, равную приблизительно году, и у которого значение параметра **IsPrimary** равно **False**.</span><span class="sxs-lookup"><span data-stu-id="cec23-199">Two certificates should be listed now, one of which has a **NotAfter** date of approximately one year in the future, and for which the **IsPrimary** value is **False**.</span></span>

### <a name="step-2-update-the-new-token-signing-certificates-for-the-office-365-trust"></a><span data-ttu-id="cec23-200">Шаг 2. Обновление новых сертификатов для подписи маркеров для использования в отношениях доверия Office 365</span><span class="sxs-lookup"><span data-stu-id="cec23-200">Step 2: Update the new token signing certificates for the Office 365 trust</span></span>
<span data-ttu-id="cec23-201">Выполните описанные ниже действия, чтобы добавить в Office 365 новые сертификаты для подписи маркеров, которые будут использоваться в отношениях доверия.</span><span class="sxs-lookup"><span data-stu-id="cec23-201">Update Office 365 with the new token signing certificates to be used for the trust, as follows.</span></span>

1. <span data-ttu-id="cec23-202">Откройте модуль Microsoft Azure Active Directory для Windows PowerShell.</span><span class="sxs-lookup"><span data-stu-id="cec23-202">Open the Microsoft Azure Active Directory Module for Windows PowerShell.</span></span>
2. <span data-ttu-id="cec23-203">Запустите $cred=Get-Credential.</span><span class="sxs-lookup"><span data-stu-id="cec23-203">Run $cred=Get-Credential.</span></span> <span data-ttu-id="cec23-204">Если этот командлет запрашивает учетные данные, введите данные учетной записи администратора облачных служб.</span><span class="sxs-lookup"><span data-stu-id="cec23-204">When this cmdlet prompts you for credentials, type your cloud service administrator account credentials.</span></span>
3. <span data-ttu-id="cec23-205">Запустите Connect-MsolService –Credential $cred.</span><span class="sxs-lookup"><span data-stu-id="cec23-205">Run Connect-MsolService –Credential $cred.</span></span> <span data-ttu-id="cec23-206">Этот командлет подключит вас к облачной службе.</span><span class="sxs-lookup"><span data-stu-id="cec23-206">This cmdlet connects you to the cloud service.</span></span> <span data-ttu-id="cec23-207">Перед выполнением любых дополнительных командлетов, установленных с помощью средства, необходимо создать контекст, который подключит вас к облачной службе.</span><span class="sxs-lookup"><span data-stu-id="cec23-207">Creating a context that connects you to the cloud service is required before running any of the additional cmdlets installed by the tool.</span></span>
4. <span data-ttu-id="cec23-208">Если эти команды выполняются на компьютере, который не является основным сервером федерации AD FS, выполните команду Set-MSOLAdfscontext -Computer <AD FS primary server>, где <AD FS primary server> — внутреннее полное доменное имея основного сервера AD FS.</span><span class="sxs-lookup"><span data-stu-id="cec23-208">If you are running these commands on a computer that is not the AD FS primary federation server, run Set-MSOLAdfscontext -Computer <AD FS primary server>, where <AD FS primary server> is the internal FQDN name of the primary AD FS server.</span></span> <span data-ttu-id="cec23-209">Этот командлет создает контекст, подключающий вас к AD FS.</span><span class="sxs-lookup"><span data-stu-id="cec23-209">This cmdlet creates a context that connects you to AD FS.</span></span>
5. <span data-ttu-id="cec23-210">Выполните команду Update-MSOLFederatedDomain -DomainName <domain>.</span><span class="sxs-lookup"><span data-stu-id="cec23-210">Run Update-MSOLFederatedDomain –DomainName <domain>.</span></span> <span data-ttu-id="cec23-211">Этот командлет обновляет параметры AD FS в облачной службе и настраивает отношения доверия между ними.</span><span class="sxs-lookup"><span data-stu-id="cec23-211">This cmdlet updates the settings from AD FS into the cloud service, and configures the trust relationship between the two.</span></span>

> [!NOTE]
> <span data-ttu-id="cec23-212">Если требуется поддержка нескольких доменов верхнего уровня, например contoso.com и fabrikam.com, то необходимо использовать параметр **SupportMultipleDomain** с любыми командлетами.</span><span class="sxs-lookup"><span data-stu-id="cec23-212">If you need to support multiple top-level domains, such as contoso.com and fabrikam.com, you must use the **SupportMultipleDomain** switch with any cmdlets.</span></span> <span data-ttu-id="cec23-213">Дополнительные сведения см. в статье [Поддержка нескольких доменов для федерации с Azure AD](active-directory-aadconnect-multiple-domains.md).</span><span class="sxs-lookup"><span data-stu-id="cec23-213">For more information, see [Support for Multiple Top Level Domains](active-directory-aadconnect-multiple-domains.md).</span></span>
>
>

## <span data-ttu-id="cec23-214">Восстановление доверия Azure AD с помощью Azure AD Connect <a name="connectrenew"></a></span><span class="sxs-lookup"><span data-stu-id="cec23-214">Repair Azure AD trust by using Azure AD Connect <a name="connectrenew"></a></span></span>
<span data-ttu-id="cec23-215">Если вы настроили ферму AD FS и доверие Azure AD, используя Azure AD Connect, то с помощью Azure AD Connect можно определить, нужно ли выполнять какие-либо действия с сертификатами для подписи маркеров.</span><span class="sxs-lookup"><span data-stu-id="cec23-215">If you configured your AD FS farm and Azure AD trust by using Azure AD Connect, you can use Azure AD Connect to detect if you need to take any action for your token signing certificates.</span></span> <span data-ttu-id="cec23-216">Если требуется обновить сертификаты, используйте Azure AD Connect.</span><span class="sxs-lookup"><span data-stu-id="cec23-216">If you need to renew the certificates, you can use Azure AD Connect to do so.</span></span>

<span data-ttu-id="cec23-217">Дополнительные сведения см. в разделе [Восстановление доверия](active-directory-aadconnect-federation-management.md).</span><span class="sxs-lookup"><span data-stu-id="cec23-217">For more information, see [Repairing the trust](active-directory-aadconnect-federation-management.md).</span></span>

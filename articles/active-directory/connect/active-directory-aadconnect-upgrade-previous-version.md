---
title: "Azure AD Connect: обновление до последней версии | Документация Майкрософт"
description: "В этой статье описаны различные способы обновления Azure Active Directory Connect до последней версии, включая обновление на месте и обновление со сменой сервера."
services: active-directory
documentationcenter: 
author: AndKjell
manager: femila
editor: 
ms.assetid: 31f084d8-2b89-478c-9079-76cf92e6618f
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: Identity
ms.date: 07/12/2017
ms.author: billmath
ms.openlocfilehash: 52fd9375c71c42feaf87f4a0f4220e1cb3889e63
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="azure-ad-connect-upgrade-from-a-previous-version-to-the-latest"></a><span data-ttu-id="a4269-103">Azure AD Connect: обновление до последней версии</span><span class="sxs-lookup"><span data-stu-id="a4269-103">Azure AD Connect: Upgrade from a previous version to the latest</span></span>
<span data-ttu-id="a4269-104">В этой статье описываются различные варианты обновления установленного экземпляра Azure Active Directory (Azure AD) Connect до последней версии.</span><span class="sxs-lookup"><span data-stu-id="a4269-104">This topic describes the different methods that you can use to upgrade your Azure Active Directory (Azure AD) Connect installation to the latest release.</span></span> <span data-ttu-id="a4269-105">Мы рекомендуем устанавливать все новые выпуски Azure AD Connect.</span><span class="sxs-lookup"><span data-stu-id="a4269-105">We recommend that you keep yourself current with the releases of Azure AD Connect.</span></span> <span data-ttu-id="a4269-106">Действия, описанные в разделе [Обновление со сменой сервера](#swing-migration), можно также использовать при значительных изменениях конфигурации.</span><span class="sxs-lookup"><span data-stu-id="a4269-106">You also use the steps in the [Swing migration](#swing-migration) section when you make a substantial configuration change.</span></span>

<span data-ttu-id="a4269-107">Инструкции по обновлению DirSync см. в статье [Azure AD Connect: обновление DirSync](active-directory-aadconnect-dirsync-upgrade-get-started.md).</span><span class="sxs-lookup"><span data-stu-id="a4269-107">If you want to upgrade from DirSync, see [Upgrade from Azure AD sync tool (DirSync)](active-directory-aadconnect-dirsync-upgrade-get-started.md) instead.</span></span>

<span data-ttu-id="a4269-108">Существует несколько различных стратегий обновления Azure AD Connect.</span><span class="sxs-lookup"><span data-stu-id="a4269-108">There are a few different strategies that you can use to upgrade Azure AD Connect.</span></span>

| <span data-ttu-id="a4269-109">Метод</span><span class="sxs-lookup"><span data-stu-id="a4269-109">Method</span></span> | <span data-ttu-id="a4269-110">Описание</span><span class="sxs-lookup"><span data-stu-id="a4269-110">Description</span></span> |
| --- | --- |
| [<span data-ttu-id="a4269-111">Автоматическое обновление</span><span class="sxs-lookup"><span data-stu-id="a4269-111">Automatic upgrade</span></span>](active-directory-aadconnect-feature-automatic-upgrade.md) |<span data-ttu-id="a4269-112">Самый простой вариант — для клиентов с экспресс-установкой.</span><span class="sxs-lookup"><span data-stu-id="a4269-112">This is the easiest method for customers with an express installation.</span></span> |
| [<span data-ttu-id="a4269-113">Обновление «на месте»</span><span class="sxs-lookup"><span data-stu-id="a4269-113">In-place upgrade</span></span>](#in-place-upgrade) |<span data-ttu-id="a4269-114">Если у вас один сервер, то установку можно обновить "на месте".</span><span class="sxs-lookup"><span data-stu-id="a4269-114">If you have a single server, you can upgrade the installation in-place on the same server.</span></span> |
| [<span data-ttu-id="a4269-115">Обновление со сменой сервера</span><span class="sxs-lookup"><span data-stu-id="a4269-115">Swing migration</span></span>](#swing-migration) |<span data-ttu-id="a4269-116">Если серверов два, то можно установить новый выпуск или конфигурацию на один из них, а затем сменить активный сервер.</span><span class="sxs-lookup"><span data-stu-id="a4269-116">With two servers, you can prepare one of the servers with the new release or configuration, and change the active server when you're ready.</span></span> |

<span data-ttu-id="a4269-117">Сведения о разрешениях см. в разделе [Azure AD Connect: учетные записи и разрешения](active-directory-aadconnect-accounts-permissions.md#upgrade).</span><span class="sxs-lookup"><span data-stu-id="a4269-117">For permissions information, see the [permissions required for an upgrade](active-directory-aadconnect-accounts-permissions.md#upgrade).</span></span>

> [!NOTE]
> <span data-ttu-id="a4269-118">После включения нового сервера Azure AD Connect для запуска синхронизации изменений в Azure AD откат к использованию DirSync или Azure AD Sync уже невозможен.</span><span class="sxs-lookup"><span data-stu-id="a4269-118">After you've enabled your new Azure AD Connect server to start synchronizing changes to Azure AD, you must not roll back to using DirSync or Azure AD Sync.</span></span> <span data-ttu-id="a4269-119">Обратный переход с Azure AD Connect к устаревшим клиентам, включая DirSync и Azure AD Sync, не поддерживается и может привести к таким проблемам, как потеря данных в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="a4269-119">Downgrading from Azure AD Connect to legacy clients, including DirSync and Azure AD Sync, isn't supported and can lead to issues such as data loss in Azure AD.</span></span>

## <a name="in-place-upgrade"></a><span data-ttu-id="a4269-120">Обновление «на месте»</span><span class="sxs-lookup"><span data-stu-id="a4269-120">In-place upgrade</span></span>
<span data-ttu-id="a4269-121">Обновление на месте подходит для обновления Azure AD Sync или Azure AD Connect.</span><span class="sxs-lookup"><span data-stu-id="a4269-121">An in-place upgrade works for moving from Azure AD Sync or Azure AD Connect.</span></span> <span data-ttu-id="a4269-122">Оно не подходит для перехода с DirSync или для решения на основе Forefront Identity Manager (FIM) и соединителя Azure AD.</span><span class="sxs-lookup"><span data-stu-id="a4269-122">It doesn't work for moving from DirSync or for a solution with Forefront Identity Manager (FIM) + Azure AD Connector.</span></span>

<span data-ttu-id="a4269-123">Мы советуем использовать этот вариант, если у вас есть один сервер и меньше 100 000 объектов.</span><span class="sxs-lookup"><span data-stu-id="a4269-123">This method is preferred when you have a single server and less than about 100,000 objects.</span></span> <span data-ttu-id="a4269-124">Если в стандартных правилах синхронизации есть какие-либо изменения, после обновления выполняется полный импорт и полная синхронизация.</span><span class="sxs-lookup"><span data-stu-id="a4269-124">If there are any changes to the out-of-box sync rules, a full import and full synchronization occur after the upgrade.</span></span> <span data-ttu-id="a4269-125">Этот способ гарантирует, что новая конфигурация будет применена ко всем существующим в системе объектам.</span><span class="sxs-lookup"><span data-stu-id="a4269-125">This method ensures that the new configuration is applied to all existing objects in the system.</span></span> <span data-ttu-id="a4269-126">Этот процесс может занять несколько часов в зависимости от числа объектов в области действия модуля синхронизации.</span><span class="sxs-lookup"><span data-stu-id="a4269-126">This run might take a few hours, depending on the number of objects that are in scope of the sync engine.</span></span> <span data-ttu-id="a4269-127">Обычная синхронизация изменений, по умолчанию выполняемая каждые 30 минут, приостанавливается, но синхронизация паролей продолжает выполняться.</span><span class="sxs-lookup"><span data-stu-id="a4269-127">The normal delta synchronization scheduler (which synchronizes every 30 minutes by default) is suspended, but password synchronization continues.</span></span> <span data-ttu-id="a4269-128">Обновление "на месте" лучше всего проводить в выходные дни.</span><span class="sxs-lookup"><span data-stu-id="a4269-128">You might consider doing the in-place upgrade during a weekend.</span></span> <span data-ttu-id="a4269-129">Если в новом выпуске Azure AD Connect не изменены стандартные правила синхронизации, то начнется обычная процедура импорта или синхронизации изменений.</span><span class="sxs-lookup"><span data-stu-id="a4269-129">If there are no changes to the out-of-box configuration with the new Azure AD Connect release, then a normal delta import/sync starts instead.</span></span>  
![Обновление «на месте»](./media/active-directory-aadconnect-upgrade-previous-version/inplaceupgrade.png)

<span data-ttu-id="a4269-131">Если вы внесли изменения в стандартные правила синхронизации, при обновлении они возвращаются к конфигурации по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="a4269-131">If you've made changes to the out-of-box synchronization rules, then these rules are set back to the default configuration on upgrade.</span></span> <span data-ttu-id="a4269-132">Чтобы после обновления конфигурация сохранялась, внесите изменения, как указано в статье [Службы синхронизации Azure AD Connect: рекомендации по изменению конфигурации по умолчанию](active-directory-aadconnectsync-best-practices-changing-default-configuration.md).</span><span class="sxs-lookup"><span data-stu-id="a4269-132">To make sure that your configuration is kept between upgrades, make sure that you make changes as they're described in [Best practices for changing the default configuration](active-directory-aadconnectsync-best-practices-changing-default-configuration.md).</span></span>

<span data-ttu-id="a4269-133">Во время обновления на месте могут быть внесены изменения, требующие выполнения определенных действий по синхронизации (включая шаг полного импорта и шаг полной синхронизации) после завершения обновления.</span><span class="sxs-lookup"><span data-stu-id="a4269-133">During in-place upgrade, there may be changes introduced that require specific synchronization activities (including Full Import step and Full Synchronization step) to be executed after upgrade completes.</span></span> <span data-ttu-id="a4269-134">Сведения о том, как отложить эти действия, см. в разделе [Как отложить полную синхронизацию после обновления](#how-to-defer-full-synchronization-after-upgrade).</span><span class="sxs-lookup"><span data-stu-id="a4269-134">To defer such activities, refer to section [How to defer full synchronization after upgrade](#how-to-defer-full-synchronization-after-upgrade).</span></span>

## <a name="swing-migration"></a><span data-ttu-id="a4269-135">Обновление со сменой сервера</span><span class="sxs-lookup"><span data-stu-id="a4269-135">Swing migration</span></span>
<span data-ttu-id="a4269-136">При наличии сложного развертывания или большого числа объектов обновление системы "на месте" будет нецелесообразно.</span><span class="sxs-lookup"><span data-stu-id="a4269-136">If you have a complex deployment or many objects, it might be impractical to do an in-place upgrade on the live system.</span></span> <span data-ttu-id="a4269-137">У некоторых клиентов процесс может занять несколько дней, в течение которых никакие изменения синхронизироваться не будут.</span><span class="sxs-lookup"><span data-stu-id="a4269-137">For some customers, this process might take multiple days--and during this time, no delta changes are processed.</span></span> <span data-ttu-id="a4269-138">Этот метод также можно использовать, если планируется значительно изменить конфигурацию и нужно проверить ее перед отправкой в облако.</span><span class="sxs-lookup"><span data-stu-id="a4269-138">You can also use this method when you plan to make substantial changes to your configuration and you want to try them out before they're pushed to the cloud.</span></span>

<span data-ttu-id="a4269-139">В подобных случаях мы рекомендуем обновление со сменой сервера.</span><span class="sxs-lookup"><span data-stu-id="a4269-139">The recommended method for these scenarios is to use a swing migration.</span></span> <span data-ttu-id="a4269-140">Вам потребуется по крайней мере два сервера — активный и промежуточный.</span><span class="sxs-lookup"><span data-stu-id="a4269-140">You need (at least) two servers--one active server and one staging server.</span></span> <span data-ttu-id="a4269-141">Активный сервер (обозначен сплошными синими линиями на приведенном ниже рисунке) отвечает за активные рабочие нагрузки.</span><span class="sxs-lookup"><span data-stu-id="a4269-141">The active server (shown with solid blue lines in the following picture) is responsible for the active production load.</span></span> <span data-ttu-id="a4269-142">Промежуточный сервер (обозначен пунктирными фиолетовыми линиями) подготавливается с использованием нового выпуска или конфигурации.</span><span class="sxs-lookup"><span data-stu-id="a4269-142">The staging server (shown with dashed purple lines) is prepared with the new release or configuration.</span></span> <span data-ttu-id="a4269-143">После завершения подготовки к использованию он становится активным сервером.</span><span class="sxs-lookup"><span data-stu-id="a4269-143">When it's fully ready, this server is made active.</span></span> <span data-ttu-id="a4269-144">Сервер, который раньше был активным и на котором теперь установлена старая версия или конфигурация, становится промежуточным и обновляется.</span><span class="sxs-lookup"><span data-stu-id="a4269-144">The previous active server, which now has the old version or configuration installed, is made into the staging server and is upgraded.</span></span>

<span data-ttu-id="a4269-145">На двух серверах могут использоваться разные версии.</span><span class="sxs-lookup"><span data-stu-id="a4269-145">The two servers can use different versions.</span></span> <span data-ttu-id="a4269-146">Например, активный сервер, который вы планируете перестать использовать, может использовать Azure AD Sync, а новый промежуточный сервер — Azure AD Connect.</span><span class="sxs-lookup"><span data-stu-id="a4269-146">For example, the active server that you plan to decommission can use Azure AD Sync, and the new staging server can use Azure AD Connect.</span></span> <span data-ttu-id="a4269-147">Если для развертывания новой конфигурации используется обновление со сменой сервера, мы рекомендуем устанавливать одинаковые версии на двух серверах.</span><span class="sxs-lookup"><span data-stu-id="a4269-147">If you use swing migration to develop a new configuration, it's a good idea to have the same versions on the two servers.</span></span>  
![Промежуточный сервер.](./media/active-directory-aadconnect-upgrade-previous-version/stagingserver1.png)

> [!NOTE]
> <span data-ttu-id="a4269-149">Некоторые клиенты предпочитают использовать для этого сценария три или четыре сервера.</span><span class="sxs-lookup"><span data-stu-id="a4269-149">Some customers prefer to have three or four servers for this scenario.</span></span> <span data-ttu-id="a4269-150">Когда промежуточный сервер обновляется, он не может служить резервным сервером для [аварийного восстановления](active-directory-aadconnectsync-operations.md#disaster-recovery).</span><span class="sxs-lookup"><span data-stu-id="a4269-150">When the staging server is upgraded, you don't have a backup server for [disaster recovery](active-directory-aadconnectsync-operations.md#disaster-recovery).</span></span> <span data-ttu-id="a4269-151">При наличии трех или четырех серверов можно установить новую версию на одной паре основного и резервного серверов. Это обеспечит постоянную доступность промежуточного сервера.</span><span class="sxs-lookup"><span data-stu-id="a4269-151">With three or four servers, you can prepare one set of primary/standby servers with the new version, which ensures that there is always a staging server that's ready to take over.</span></span>

<span data-ttu-id="a4269-152">Эти действия подходят также для обновления Azure AD Sync или решения на основе FIM и соединителя Azure AD.</span><span class="sxs-lookup"><span data-stu-id="a4269-152">These steps also work to move from Azure AD Sync or a solution with FIM + Azure AD Connector.</span></span> <span data-ttu-id="a4269-153">Они не подходят для DirSync. Метод обновления со сменой сервера (также называемый параллельным развертыванием) для DirSync описывается в статье [Azure AD Connect: обновление DirSync](active-directory-aadconnect-dirsync-upgrade-get-started.md).</span><span class="sxs-lookup"><span data-stu-id="a4269-153">These steps don't work for DirSync, but the same swing migration method (also called parallel deployment) with steps for DirSync is in [Upgrade Azure Active Directory sync (DirSync)](active-directory-aadconnect-dirsync-upgrade-get-started.md).</span></span>

### <a name="use-a-swing-migration-to-upgrade"></a><span data-ttu-id="a4269-154">Использование обновления со сменой сервера</span><span class="sxs-lookup"><span data-stu-id="a4269-154">Use a swing migration to upgrade</span></span>
1. <span data-ttu-id="a4269-155">Если вы используете Azure AD Connect на обоих серверах и хотите только изменить конфигурацию, убедитесь, что на активном и промежуточном серверах установлена одна и та же версия.</span><span class="sxs-lookup"><span data-stu-id="a4269-155">If you use Azure AD Connect on both servers and plan to only make a configuration change, make sure that your active server and staging server are both using the same version.</span></span> <span data-ttu-id="a4269-156">Это упростит сравнение различий позже.</span><span class="sxs-lookup"><span data-stu-id="a4269-156">That makes it easier to compare differences later.</span></span> <span data-ttu-id="a4269-157">При обновлении Azure AD Sync эти серверы имеют разные версии.</span><span class="sxs-lookup"><span data-stu-id="a4269-157">If you're upgrading from Azure AD Sync, then these servers have different versions.</span></span> <span data-ttu-id="a4269-158">При обновлении более ранней версии Azure AD Connect удобно использовать одинаковую версию на обоих серверах, но это необязательно.</span><span class="sxs-lookup"><span data-stu-id="a4269-158">If you're upgrading from an older version of Azure AD Connect, it's a good idea to start with the two servers that are using the same version, but it's not required.</span></span>
2. <span data-ttu-id="a4269-159">Если вы внесли изменения в конфигурацию на активном сервере, а на промежуточном они отсутствуют, выполните инструкции в разделе [Перенос пользовательской конфигурации с активного на промежуточный сервер](#move-custom-configuration-from-active-to-staging-server).</span><span class="sxs-lookup"><span data-stu-id="a4269-159">If you've made a custom configuration and your staging server doesn't have it, follow the steps under [Move a custom configuration from the active server to the staging server](#move-custom-configuration-from-active-to-staging-server).</span></span>
3. <span data-ttu-id="a4269-160">При обновлении более ранней версии Azure AD Connect обновите промежуточный сервер до последней версии.</span><span class="sxs-lookup"><span data-stu-id="a4269-160">If you're upgrading from an earlier release of Azure AD Connect, upgrade the staging server to the latest version.</span></span> <span data-ttu-id="a4269-161">При перемещении из Azure AD Sync установите Azure AD Connect на промежуточном сервере.</span><span class="sxs-lookup"><span data-stu-id="a4269-161">If you're moving from Azure AD Sync, then install Azure AD Connect on your staging server.</span></span>
4. <span data-ttu-id="a4269-162">Разрешите модулю синхронизации выполнить полный импорт и полную синхронизацию на промежуточном сервере.</span><span class="sxs-lookup"><span data-stu-id="a4269-162">Let the sync engine run full import and full synchronization on your staging server.</span></span>
5. <span data-ttu-id="a4269-163">Убедитесь, что новая конфигурация не вызывает непредвиденных изменений, выполнив инструкции из раздела "Проверка" в статье [Проверка конфигурации сервера](active-directory-aadconnectsync-operations.md#verify-the-configuration-of-a-server).</span><span class="sxs-lookup"><span data-stu-id="a4269-163">Verify that the new configuration didn't cause any unexpected changes by using the steps under "Verify" in [Verify the configuration of a server](active-directory-aadconnectsync-operations.md#verify-the-configuration-of-a-server).</span></span> <span data-ttu-id="a4269-164">Если что-то пошло не так, как ожидалось, внесите необходимые исправления, выполните импорт и синхронизацию, после чего проверьте, исправлены ли данные, выполнив приведенные ниже действия.</span><span class="sxs-lookup"><span data-stu-id="a4269-164">If something isn't as expected, correct it, run the import and sync, and verify the data until it looks good, by following the steps.</span></span>
6. <span data-ttu-id="a4269-165">Сделайте промежуточный сервер активным.</span><span class="sxs-lookup"><span data-stu-id="a4269-165">Switch the staging server to be the active server.</span></span> <span data-ttu-id="a4269-166">Это действие соответствует последнему шагу, "Переключение активного сервера", в статье [Проверка конфигурации сервера](active-directory-aadconnectsync-operations.md#verify-the-configuration-of-a-server).</span><span class="sxs-lookup"><span data-stu-id="a4269-166">This is the final step "Switch active server" in [Verify the configuration of a server](active-directory-aadconnectsync-operations.md#verify-the-configuration-of-a-server).</span></span>
7. <span data-ttu-id="a4269-167">При обновлении Azure AD Connect обновите сервер, находящийся в промежуточном режиме, до последней версии.</span><span class="sxs-lookup"><span data-stu-id="a4269-167">If you're upgrading Azure AD Connect, upgrade the server that's now in staging mode to the latest release.</span></span> <span data-ttu-id="a4269-168">Обновите данные и конфигурацию, как описано выше.</span><span class="sxs-lookup"><span data-stu-id="a4269-168">Follow the same steps as before to get the data and configuration upgraded.</span></span> <span data-ttu-id="a4269-169">При обновлении Azure AD Sync на этом этапе можно отключить и списать старый сервер.</span><span class="sxs-lookup"><span data-stu-id="a4269-169">If you upgraded from Azure AD Sync, you can now turn off and decommission your old server.</span></span>

### <a name="move-a-custom-configuration-from-the-active-server-to-the-staging-server"></a><span data-ttu-id="a4269-170">Перемещение пользовательской конфигурации с активного сервера на промежуточный сервер</span><span class="sxs-lookup"><span data-stu-id="a4269-170">Move a custom configuration from the active server to the staging server</span></span>
<span data-ttu-id="a4269-171">Если вы внесли изменения в конфигурацию на активном сервере, их нужно применить и к промежуточному серверу.</span><span class="sxs-lookup"><span data-stu-id="a4269-171">If you've made configuration changes to the active server, you need to make sure that the same changes are applied to the staging server.</span></span> <span data-ttu-id="a4269-172">Чтобы упростить этот переход, можно воспользоваться [средством документирования конфигурации Azure AD Connect](https://github.com/Microsoft/AADConnectConfigDocumenter).</span><span class="sxs-lookup"><span data-stu-id="a4269-172">To help with this move, you can use the [Azure AD Connect configuration documenter](https://github.com/Microsoft/AADConnectConfigDocumenter).</span></span>

<span data-ttu-id="a4269-173">Можно переместить созданные вами пользовательские правила синхронизации с помощью PowerShell.</span><span class="sxs-lookup"><span data-stu-id="a4269-173">You can move the custom sync rules that you've created by using PowerShell.</span></span> <span data-ttu-id="a4269-174">Другие изменения необходимо применить одинаковым способом в обеих системах, и их нельзя перенести.</span><span class="sxs-lookup"><span data-stu-id="a4269-174">You must apply other changes the same way on both systems, and you can't migrate the changes.</span></span> <span data-ttu-id="a4269-175">[Средство документирования конфигураций](https://github.com/Microsoft/AADConnectConfigDocumenter) поможет сравнить две системы на идентичность.</span><span class="sxs-lookup"><span data-stu-id="a4269-175">The [configuration documenter](https://github.com/Microsoft/AADConnectConfigDocumenter) can help you comparing the two systems to make sure they are identical.</span></span> <span data-ttu-id="a4269-176">Его также можно использовать при автоматизации шагов, описанных в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="a4269-176">The tool can also help in automating the steps found in this section.</span></span>

<span data-ttu-id="a4269-177">На обоих серверах необходимо одинаково настроить следующее:</span><span class="sxs-lookup"><span data-stu-id="a4269-177">You need to configure the following things the same way on both servers:</span></span>

* <span data-ttu-id="a4269-178">Подключение к одним и тем же лесам.</span><span class="sxs-lookup"><span data-stu-id="a4269-178">Connection to the same forests</span></span>
* <span data-ttu-id="a4269-179">Фильтрацию доменов и подразделений.</span><span class="sxs-lookup"><span data-stu-id="a4269-179">Any domain and OU filtering</span></span>
* <span data-ttu-id="a4269-180">Одни и те же дополнительные компоненты, например синхронизацию и обратную запись паролей.</span><span class="sxs-lookup"><span data-stu-id="a4269-180">The same optional features, such as password sync and password writeback</span></span>

<span data-ttu-id="a4269-181">**Перемещение пользовательских правил синхронизации**</span><span class="sxs-lookup"><span data-stu-id="a4269-181">**Move custom synchronization rules**</span></span>  
<span data-ttu-id="a4269-182">Для перемещения пользовательских правил синхронизации выполните следующее.</span><span class="sxs-lookup"><span data-stu-id="a4269-182">To move custom synchronization rules, do the following:</span></span>

1. <span data-ttu-id="a4269-183">Откройте **редактор правил синхронизации** на активном сервере.</span><span class="sxs-lookup"><span data-stu-id="a4269-183">Open **Synchronization Rules Editor** on your active server.</span></span>
2. <span data-ttu-id="a4269-184">Выберите пользовательское правило.</span><span class="sxs-lookup"><span data-stu-id="a4269-184">Select a custom rule.</span></span> <span data-ttu-id="a4269-185">Щелкните **Экспорт**.</span><span class="sxs-lookup"><span data-stu-id="a4269-185">Click **Export**.</span></span> <span data-ttu-id="a4269-186">Откроется окно Блокнота.</span><span class="sxs-lookup"><span data-stu-id="a4269-186">This brings up a Notepad window.</span></span> <span data-ttu-id="a4269-187">Сохраните временный файл с расширением PS1 —</span><span class="sxs-lookup"><span data-stu-id="a4269-187">Save the temporary file with a PS1 extension.</span></span> <span data-ttu-id="a4269-188">он станет скриптом PowerShell.</span><span class="sxs-lookup"><span data-stu-id="a4269-188">This makes it a PowerShell script.</span></span> <span data-ttu-id="a4269-189">Скопируйте PS1-файл на промежуточный сервер.</span><span class="sxs-lookup"><span data-stu-id="a4269-189">Copy the PS1 file to the staging server.</span></span>  
   <span data-ttu-id="a4269-190">![Экспорт правил синхронизации](./media/active-directory-aadconnect-upgrade-previous-version/exportrule.png)</span><span class="sxs-lookup"><span data-stu-id="a4269-190">![Sync rule export](./media/active-directory-aadconnect-upgrade-previous-version/exportrule.png)</span></span>
3. <span data-ttu-id="a4269-191">На промежуточном сервере используется другой GUID соединителя, и его нужно изменить.</span><span class="sxs-lookup"><span data-stu-id="a4269-191">The Connector GUID is different on the staging server, and you must change it.</span></span> <span data-ttu-id="a4269-192">Чтобы получить GUID, запустите **редактор правил синхронизации**, выберите одно из стандартных правил, представляющих ту же подключенную систему, и щелкните **Экспорт**.</span><span class="sxs-lookup"><span data-stu-id="a4269-192">To get the GUID, start **Synchronization Rules Editor**, select one of the out-of-box rules that represent the same connected system, and click **Export**.</span></span> <span data-ttu-id="a4269-193">Замените GUID в файл PS1 на GUID для промежуточного сервера.</span><span class="sxs-lookup"><span data-stu-id="a4269-193">Replace the GUID in your PS1 file with the GUID from the staging server.</span></span>
4. <span data-ttu-id="a4269-194">Запустите файл PS1 из командной строки PowerShell.</span><span class="sxs-lookup"><span data-stu-id="a4269-194">In a PowerShell prompt, run the PS1 file.</span></span> <span data-ttu-id="a4269-195">На промежуточном сервере будет создано пользовательское правило синхронизации.</span><span class="sxs-lookup"><span data-stu-id="a4269-195">This creates the custom synchronization rule on the staging server.</span></span>
5. <span data-ttu-id="a4269-196">Повторите эти действия для всех пользовательских правил.</span><span class="sxs-lookup"><span data-stu-id="a4269-196">Repeat this for all your custom rules.</span></span>

## <a name="how-to-defer-full-synchronization-after-upgrade"></a><span data-ttu-id="a4269-197">Как отложить полную синхронизацию после обновления</span><span class="sxs-lookup"><span data-stu-id="a4269-197">How to defer full synchronization after upgrade</span></span>
<span data-ttu-id="a4269-198">Во время обновления на месте могут быть внесены изменения, требующие выполнения определенных действий по синхронизации (включая шаг полного импорта и шаг полной синхронизации).</span><span class="sxs-lookup"><span data-stu-id="a4269-198">During in-place upgrade, there may be changes introduced that require specific synchronization activities (including Full Import step and Full Synchronization step) to be executed.</span></span> <span data-ttu-id="a4269-199">Например, при изменении схемы соединителя на затронутых соединителях необходимо выполнить **полный импорт**, а при изменении стандартного правила синхронизации — **полную синхронизацию**.</span><span class="sxs-lookup"><span data-stu-id="a4269-199">For example, connector schema changes require **full import** step and out-of-box synchronization rule changes require **full synchronization** step to be executed on affected connectors.</span></span> <span data-ttu-id="a4269-200">Во время обновления Azure AD Connect определяет действия синхронизации, которые необходимо выполнить, и записывает их в виде *переопределений*.</span><span class="sxs-lookup"><span data-stu-id="a4269-200">During upgrade, Azure AD Connect determines what synchronization activities are required and records them as *overrides*.</span></span> <span data-ttu-id="a4269-201">В следующем цикле синхронизации планировщик синхронизации выбирает и выполняет эти переопределения.</span><span class="sxs-lookup"><span data-stu-id="a4269-201">In the following synchronization cycle, the synchronization scheduler picks up these overrides and executes them.</span></span> <span data-ttu-id="a4269-202">После успешного выполнения переопределения оно удаляется.</span><span class="sxs-lookup"><span data-stu-id="a4269-202">Once an override is successfully executed, it is removed.</span></span>

<span data-ttu-id="a4269-203">Возможны ситуации, при которых не нужно выполнять эти переопределения сразу же после обновления.</span><span class="sxs-lookup"><span data-stu-id="a4269-203">There may be situations where you do not want these overrides to take place immediately after upgrade.</span></span> <span data-ttu-id="a4269-204">Например, у вас есть много синхронизируемых объектов и вы хотите выполнить эти шаги синхронизации после рабочих часов.</span><span class="sxs-lookup"><span data-stu-id="a4269-204">For example, you have numerous synchronized objects and you would like these synchronization steps to occur after business hours.</span></span> <span data-ttu-id="a4269-205">Чтобы удалить эти переопределения, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="a4269-205">To remove these overrides:</span></span>

1. <span data-ttu-id="a4269-206">Во время обновления **снимите** флажок **Запустить синхронизацию сразу после завершения настройки**.</span><span class="sxs-lookup"><span data-stu-id="a4269-206">During upgrade, **uncheck** the option **Start the synchronization process when configuration completes**.</span></span> <span data-ttu-id="a4269-207">Это отключит планировщик синхронизации и предотвратит автоматическое выполнение цикла синхронизации, прежде чем переопределения будут удалены.</span><span class="sxs-lookup"><span data-stu-id="a4269-207">This disables the synchronization scheduler and prevents synchronization cycle from taking place automatically before the overrides are removed.</span></span>

   ![DisableFullSyncAfterUpgrade](./media/active-directory-aadconnect-upgrade-previous-version/disablefullsync01.png)

2. <span data-ttu-id="a4269-209">После завершения обновления выполните следующий командлет, чтобы узнать, какие переопределения были добавлены: `Get-ADSyncSchedulerConnectorOverride | fl`</span><span class="sxs-lookup"><span data-stu-id="a4269-209">After upgrade completes, run the following cmdlet to find out what overrides have been added: `Get-ADSyncSchedulerConnectorOverride | fl`</span></span>

   >[!NOTE]
   > <span data-ttu-id="a4269-210">Переопределения зависят от соединителя.</span><span class="sxs-lookup"><span data-stu-id="a4269-210">The overrides are connector-specific.</span></span> <span data-ttu-id="a4269-211">В указанном ниже примере в локальный соединитель AD и соединитель Azure AD был добавлен шаг для полного импорта и полной синхронизации.</span><span class="sxs-lookup"><span data-stu-id="a4269-211">In the following example, Full Import step and Full Synchronization step have been added to both the on-premises AD Connector and Azure AD Connector.</span></span>

   ![DisableFullSyncAfterUpgrade](./media/active-directory-aadconnect-upgrade-previous-version/disablefullsync02.png)

3. <span data-ttu-id="a4269-213">Запишите добавленные переопределения.</span><span class="sxs-lookup"><span data-stu-id="a4269-213">Note down the existing overrides that have been added.</span></span>
   
4. <span data-ttu-id="a4269-214">Чтобы удалить переопределения для полного импорта и полной синхронизации на произвольном соединителе, выполните следующий командлет: `Set-ADSyncSchedulerConnectorOverride -ConnectorIdentifier <Guid-of-ConnectorIdentifier> -FullImportRequired $false -FullSyncRequired $false`</span><span class="sxs-lookup"><span data-stu-id="a4269-214">To remove the overrides for both full import and full synchronization on an arbitrary connector, run the following cmdlet: `Set-ADSyncSchedulerConnectorOverride -ConnectorIdentifier <Guid-of-ConnectorIdentifier> -FullImportRequired $false -FullSyncRequired $false`</span></span>

   <span data-ttu-id="a4269-215">Чтобы удалить переопределения во всех соединителях, выполните следующий сценарий PowerShell:</span><span class="sxs-lookup"><span data-stu-id="a4269-215">To remove the overrides on all connectors, execute the following PowerShell script:</span></span>

   ```
   foreach ($connectorOverride in Get-ADSyncSchedulerConnectorOverride)
   {
       Set-ADSyncSchedulerConnectorOverride -ConnectorIdentifier $connectorOverride.ConnectorIdentifier.Guid -FullSyncRequired $false -FullImportRequired $false
   }
   ```

5. <span data-ttu-id="a4269-216">Чтобы возобновить работу планировщика, выполните следующий командлет: `Set-ADSyncScheduler -SyncCycleEnabled $true`</span><span class="sxs-lookup"><span data-stu-id="a4269-216">To resume the scheduler, run the following cmdlet: `Set-ADSyncScheduler -SyncCycleEnabled $true`</span></span>

   >[!IMPORTANT]
   > <span data-ttu-id="a4269-217">Не забудьте выполнить необходимые шаги синхронизации при первой возможности.</span><span class="sxs-lookup"><span data-stu-id="a4269-217">Remember to execute the required synchronization steps at your earliest convenience.</span></span> <span data-ttu-id="a4269-218">Вы можете выполнить эти действия вручную с помощью Synchronization Service Manager или вернуть переопределения с помощью командлета Set-ADSyncSchedulerConnectorOverride.</span><span class="sxs-lookup"><span data-stu-id="a4269-218">You can either manually execute these steps using the Synchronization Service Manager or add the overrides back using the Set-ADSyncSchedulerConnectorOverride cmdlet.</span></span>

<span data-ttu-id="a4269-219">Чтобы добавить переопределения для полного импорта и полной синхронизации на произвольном соединителе, выполните следующий командлет: `Set-ADSyncSchedulerConnectorOverride -ConnectorIdentifier <Guid> -FullImportRequired $true -FullSyncRequired $true`</span><span class="sxs-lookup"><span data-stu-id="a4269-219">To add the overrides for both full import and full synchronization on an arbitrary connector, run the following cmdlet:  `Set-ADSyncSchedulerConnectorOverride -ConnectorIdentifier <Guid> -FullImportRequired $true -FullSyncRequired $true`</span></span>

## <a name="next-steps"></a><span data-ttu-id="a4269-220">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="a4269-220">Next steps</span></span>
<span data-ttu-id="a4269-221">Дополнительные сведения об интеграции локальных удостоверений см. в статье [Подключение Active Directory к Azure Active Directory](active-directory-aadconnect.md).</span><span class="sxs-lookup"><span data-stu-id="a4269-221">Learn more about [integrating your on-premises identities with Azure Active Directory](active-directory-aadconnect.md).</span></span>

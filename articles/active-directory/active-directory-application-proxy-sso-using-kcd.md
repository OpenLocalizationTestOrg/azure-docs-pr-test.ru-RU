---
title: "Единый вход с помощью прокси приложения | Документация Майкрософт"
description: "Статья описывает, как реализовать единый вход с помощью прокси приложения Azure AD."
services: active-directory
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: ded0d9c9-45f6-47d7-bd0f-3f7fd99ab621
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/25/2017
ms.author: kgremban
ms.reviewer: harshja
ms.custom: H1Hack27Feb2017, it-pro
ms.openlocfilehash: 149af1f68e574f78127a9c2de8a0e79ed8774d29
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="kerberos-constrained-delegation-for-single-sign-on-to-your-apps-with-application-proxy"></a><span data-ttu-id="6752b-103">Ограниченное делегирование Kerberos для поддержки единого входа в приложения с помощью прокси приложения</span><span class="sxs-lookup"><span data-stu-id="6752b-103">Kerberos Constrained Delegation for single sign-on to your apps with Application Proxy</span></span>

<span data-ttu-id="6752b-104">Вы можете организовать поддержку единого входа для локальных приложений, опубликованных через прокси приложения и защищенных с использованием встроенной проверки подлинности Windows.</span><span class="sxs-lookup"><span data-stu-id="6752b-104">You can provide single sign-on for on-premises applications published through Application Proxy that are secured with Integrated Windows Authentication.</span></span> <span data-ttu-id="6752b-105">Для доступа к таким приложениям нужен билет Kerberos.</span><span class="sxs-lookup"><span data-stu-id="6752b-105">These applications require a Kerberos ticket for access.</span></span> <span data-ttu-id="6752b-106">Прокси приложения использует ограниченное делегирование Kerberos (KCD) для поддержки таких приложений.</span><span class="sxs-lookup"><span data-stu-id="6752b-106">Application Proxy uses Kerberos Constrained Delegation (KCD) to support these applications.</span></span> 

<span data-ttu-id="6752b-107">Для приложений, использующих встроенную проверку подлинности Windows (IWA), можно активировать единый вход, разрешив соединителям прокси приложения олицетворять пользователей.</span><span class="sxs-lookup"><span data-stu-id="6752b-107">You can enable single sign-on to your applications using Integrated Windows Authentication (IWA) by giving Application Proxy connectors permission in Active Directory to impersonate users.</span></span> <span data-ttu-id="6752b-108">Соединители используют это разрешение для отправки и получения токенов от имени пользователей.</span><span class="sxs-lookup"><span data-stu-id="6752b-108">The connectors use this permission to send and receive tokens on their behalf.</span></span>

## <a name="how-single-sign-on-with-kcd-works"></a><span data-ttu-id="6752b-109">Принцип работы единого входа с применением KCD</span><span class="sxs-lookup"><span data-stu-id="6752b-109">How single sign-on with KCD works</span></span>
<span data-ttu-id="6752b-110">На схеме показан процесс, когда пользователь пытается получить доступ к локальному приложению, использующему IWA.</span><span class="sxs-lookup"><span data-stu-id="6752b-110">This diagram explains the flow when a user attempts to access an on-prem application that uses IWA.</span></span>

![Схема проверки подлинности Microsoft Azure AD](./media/active-directory-application-proxy-sso-using-kcd/AuthDiagram.png)

1. <span data-ttu-id="6752b-112">Пользователь вводит URL-адрес для доступа к локальному приложению через прокси приложения.</span><span class="sxs-lookup"><span data-stu-id="6752b-112">The user enters the URL to access the on-prem application through Application Proxy.</span></span>
2. <span data-ttu-id="6752b-113">Прокси приложения перенаправляет запрос в службы проверки подлинности Azure AD, чтобы выполнить предварительную проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="6752b-113">Application Proxy redirects the request to Azure AD authentication services to preauthenticate.</span></span> <span data-ttu-id="6752b-114">На этом этапе Azure AD применяет все применимые политики проверки подлинности и авторизации, например многофакторную проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="6752b-114">At this point, Azure AD applies any applicable authentication and authorization policies, such as multifactor authentication.</span></span> <span data-ttu-id="6752b-115">Если пользователь проверен, Azure AD создает токен и отправляет его пользователю.</span><span class="sxs-lookup"><span data-stu-id="6752b-115">If the user is validated, Azure AD creates a token and sends it to the user.</span></span>
3. <span data-ttu-id="6752b-116">Пользователь передает токен в прокси приложения.</span><span class="sxs-lookup"><span data-stu-id="6752b-116">The user passes the token to Application Proxy.</span></span>
4. <span data-ttu-id="6752b-117">Прокси приложения проверяет токен и извлекает из него имя участника-пользователя, затем отправляет запрос, имя участника-пользователя и имя субъекта-службы в соединитель через безопасный канал с двойной проверкой подлинности.</span><span class="sxs-lookup"><span data-stu-id="6752b-117">Application Proxy validates the token and retrieves the User Principal Name (UPN) from it, and then sends the request, the UPN, and the Service Principal Name (SPN) to the Connector through a dually authenticated secure channel.</span></span>
5. <span data-ttu-id="6752b-118">Соединитель выполняет согласование ограниченного делегирования Kerberos с локальной службой AD, олицетворяя пользователя, чтобы получить токен Kerberos для приложения.</span><span class="sxs-lookup"><span data-stu-id="6752b-118">The Connector performs Kerberos Constrained Delegation (KCD) negotiation with the on-prem AD, impersonating the user to get a Kerberos token to the application.</span></span>
6. <span data-ttu-id="6752b-119">Active Directory отправляет токен Kerberos для приложения соединителю.</span><span class="sxs-lookup"><span data-stu-id="6752b-119">Active Directory sends the Kerberos token for the application to the Connector.</span></span>
7. <span data-ttu-id="6752b-120">Соединитель отправляет исходный запрос на сервер приложений, используя токен Kerberos, полученный от AD.</span><span class="sxs-lookup"><span data-stu-id="6752b-120">The Connector sends the original request to the application server, using the Kerberos token it received from AD.</span></span>
8. <span data-ttu-id="6752b-121">Приложение отправляет соединителю ответ, который затем возвращается службе прокси приложения и пользователю.</span><span class="sxs-lookup"><span data-stu-id="6752b-121">The application sends the response to the Connector, which is then returned to the Application Proxy service and finally to the user.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="6752b-122">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="6752b-122">Prerequisites</span></span>
<span data-ttu-id="6752b-123">Прежде чем организовать единый вход для приложений IWA, проверьте готовность следующих параметров и настроек в своей среде.</span><span class="sxs-lookup"><span data-stu-id="6752b-123">Before you get started with single sign-on for IWA applications, make sure your environment is ready with the following settings and configurations:</span></span>

* <span data-ttu-id="6752b-124">Настройте свои приложения, например веб-приложения SharePoint, на использование встроенной проверки подлинности Windows.</span><span class="sxs-lookup"><span data-stu-id="6752b-124">Your apps, like SharePoint Web apps, are set to use Integrated Windows Authentication.</span></span> <span data-ttu-id="6752b-125">Дополнительные сведения см. в статье [Включение поддержки протокола проверки подлинности Kerberos](https://technet.microsoft.com/library/dd759186.aspx) или (для SharePoint) в статье [Планирование проверки подлинности Kerberos в SharePoint 2013](https://technet.microsoft.com/library/ee806870.aspx).</span><span class="sxs-lookup"><span data-stu-id="6752b-125">For more information, see [Enable Support for Kerberos Authentication](https://technet.microsoft.com/library/dd759186.aspx), or for SharePoint see [Plan for Kerberos authentication in SharePoint 2013](https://technet.microsoft.com/library/ee806870.aspx).</span></span>
* <span data-ttu-id="6752b-126">Все приложения должны иметь [имена субъектов-служб](https://social.technet.microsoft.com/wiki/contents/articles/717.service-principal-names-spns-setspn-syntax-setspn-exe.aspx).</span><span class="sxs-lookup"><span data-stu-id="6752b-126">All your apps have [Service Principal Names](https://social.technet.microsoft.com/wiki/contents/articles/717.service-principal-names-spns-setspn-syntax-setspn-exe.aspx).</span></span>
* <span data-ttu-id="6752b-127">Сервер, на котором работает соединитель, и сервер, на котором работает приложение, должны быть присоединены к домену и должны быть частью одного и того же домена или доверенных доменов.</span><span class="sxs-lookup"><span data-stu-id="6752b-127">The server running the Connector and the server running the app are domain joined and part of the same domain or trusting domains.</span></span> <span data-ttu-id="6752b-128">Дополнительные сведения о присоединении к домену см. в разделе [Присоединение компьютера к домену](https://technet.microsoft.com/library/dd807102.aspx).</span><span class="sxs-lookup"><span data-stu-id="6752b-128">For more information on domain join, see [Join a Computer to a Domain](https://technet.microsoft.com/library/dd807102.aspx).</span></span>
* <span data-ttu-id="6752b-129">Сервер, на котором работает соединитель, должен иметь доступ на чтение атрибута TokenGroupsGlobalAndUniversal у пользователей.</span><span class="sxs-lookup"><span data-stu-id="6752b-129">The server running the Connector has access to read the TokenGroupsGlobalAndUniversal attribute for users.</span></span> <span data-ttu-id="6752b-130">Эта стандартная настройка может измениться в случае усиления защиты среды.</span><span class="sxs-lookup"><span data-stu-id="6752b-130">This default setting might have been impacted by security hardening the environment.</span></span>

### <a name="configure-active-directory"></a><span data-ttu-id="6752b-131">Настройка Active Directory</span><span class="sxs-lookup"><span data-stu-id="6752b-131">Configure Active Directory</span></span>
<span data-ttu-id="6752b-132">Действия по настройке в Active Directory зависят от того, находятся ли соединитель прокси приложения и сервер приложения в одном и том же домене.</span><span class="sxs-lookup"><span data-stu-id="6752b-132">The Active Directory configuration varies, depending on whether your Application Proxy connector and the application server are in the same domain or not.</span></span>

#### <a name="connector-and-application-server-in-the-same-domain"></a><span data-ttu-id="6752b-133">Соединитель и сервер приложения находятся в одном домене</span><span class="sxs-lookup"><span data-stu-id="6752b-133">Connector and application server in the same domain</span></span>
1. <span data-ttu-id="6752b-134">В Active Directory выберите **Средства** > **Пользователи и компьютеры**.</span><span class="sxs-lookup"><span data-stu-id="6752b-134">In Active Directory, go to **Tools** > **Users and Computers**.</span></span>
2. <span data-ttu-id="6752b-135">Выберите сервер, на котором работает соединитель.</span><span class="sxs-lookup"><span data-stu-id="6752b-135">Select the server running the connector.</span></span>
3. <span data-ttu-id="6752b-136">Щелкните его правой кнопкой мыши и выберите **Свойства** > **Делегирование**.</span><span class="sxs-lookup"><span data-stu-id="6752b-136">Right-click and select **Properties** > **Delegation**.</span></span>
4. <span data-ttu-id="6752b-137">Выберите **Доверять компьютеру делегирование указанных служб**.</span><span class="sxs-lookup"><span data-stu-id="6752b-137">Select **Trust this computer for delegation to specified services only**.</span></span> 
5. <span data-ttu-id="6752b-138">В разделе **Службы, с которыми эта учетная запись может использовать делегированные учетные данные** добавьте значение для идентификации имени субъекта-службы сервера приложений.</span><span class="sxs-lookup"><span data-stu-id="6752b-138">Under **Services to which this account can present delegated credentials** add the value for the SPN identity of the application server.</span></span> <span data-ttu-id="6752b-139">После этого соединитель прокси приложения будет олицетворять пользователей в AD при работе с приложениями, указанными в списке.</span><span class="sxs-lookup"><span data-stu-id="6752b-139">This enables the Application Proxy Connector to impersonate users in AD against the applications defined in the list.</span></span>

   ![Окно свойств соединителя SVR (снимок экрана)](./media/active-directory-application-proxy-sso-using-kcd/Properties.jpg)

#### <a name="connector-and-application-server-in-different-domains"></a><span data-ttu-id="6752b-141">Соединитель и сервер приложения находятся в разных доменах</span><span class="sxs-lookup"><span data-stu-id="6752b-141">Connector and application server in different domains</span></span>
1. <span data-ttu-id="6752b-142">Список предварительных требований для работы с ограниченным делегированием Kerberos в разных доменах см. в статье [Ограниченное делегирование Kerberos в разных доменах](https://technet.microsoft.com/library/hh831477.aspx).</span><span class="sxs-lookup"><span data-stu-id="6752b-142">For a list of prerequisites for working with KCD across domains, see [Kerberos Constrained Delegation across domains](https://technet.microsoft.com/library/hh831477.aspx).</span></span>
2. <span data-ttu-id="6752b-143">Используйте свойство `principalsallowedtodelegateto` на сервере соединителя, чтобы разрешить прокси приложения делегировать полномочия серверу соединителя.</span><span class="sxs-lookup"><span data-stu-id="6752b-143">Use the `principalsallowedtodelegateto` property on the Connector server to enable the Application Proxy to delegate for the Connector server.</span></span> <span data-ttu-id="6752b-144">Сервер приложений указан в свойстве `sharepointserviceaccount`, а делегирующий сервер — в свойстве `connectormachineaccount`.</span><span class="sxs-lookup"><span data-stu-id="6752b-144">The application server is `sharepointserviceaccount` and the delegating server is `connectormachineaccount`.</span></span> <span data-ttu-id="6752b-145">Следующий пример содержит код для Windows 2012 R2:</span><span class="sxs-lookup"><span data-stu-id="6752b-145">For Windows 2012 R2, use this code as an example:</span></span>

        $connector= Get-ADComputer -Identity connectormachineaccount -server dc.connectordomain.com

        Set-ADComputer -Identity sharepointserviceaccount -PrincipalsAllowedToDelegateToAccount $connector

        Get-ADComputer sharepointserviceaccount -Properties PrincipalsAllowedToDelegateToAccount

<span data-ttu-id="6752b-146">Sharepointserviceaccount может содержать учетную запись компьютера Microsoft SharePoint Server или учетную запись службы, с учетными данными которой выполняется пул приложений Microsoft SharePoint Server.</span><span class="sxs-lookup"><span data-stu-id="6752b-146">Sharepointserviceaccount can be the SPS machine account or a service account under which the SPS app pool is running.</span></span>

## <a name="configure-single-sign-on"></a><span data-ttu-id="6752b-147">Настройка единого входа</span><span class="sxs-lookup"><span data-stu-id="6752b-147">Configure single sign-on</span></span> 
1. <span data-ttu-id="6752b-148">Опубликуйте приложение в соответствии с инструкциями, описанными в статье [Публикация приложений с помощью прокси приложения](application-proxy-publish-azure-portal.md).</span><span class="sxs-lookup"><span data-stu-id="6752b-148">Publish your application according to the instructions described in [Publish applications with Application Proxy](application-proxy-publish-azure-portal.md).</span></span> <span data-ttu-id="6752b-149">Обязательно выберите значение **Azure Active Directory** для параметра **Метод предварительной проверки подлинности**.</span><span class="sxs-lookup"><span data-stu-id="6752b-149">Make sure to select **Azure Active Directory** as the **Preauthentication Method**.</span></span>
2. <span data-ttu-id="6752b-150">Когда приложение появится в списке корпоративных приложений, выберите его и щелкните **Единый вход**.</span><span class="sxs-lookup"><span data-stu-id="6752b-150">After your application appears in the list of enterprise applications, select it and click **Single sign-on**.</span></span>
3. <span data-ttu-id="6752b-151">Выберите режим единого входа **Встроенная проверка подлинности Windows**.</span><span class="sxs-lookup"><span data-stu-id="6752b-151">Set the single sign-on mode to **Integrated Windows Authentication**.</span></span>  
4. <span data-ttu-id="6752b-152">Введите **Внутреннее имя субъекта-службы приложения** сервера приложений.</span><span class="sxs-lookup"><span data-stu-id="6752b-152">Enter the **Internal Application SPN** of the application server.</span></span> <span data-ttu-id="6752b-153">В этом примере таким именем для опубликованного приложения будет http/www.contoso.com. Это имя субъекта-службы должно входить в список служб, для которого соединитель может имеет делегированные учетные данные.</span><span class="sxs-lookup"><span data-stu-id="6752b-153">In this example, the SPN for our published application is http/www.contoso.com. This SPN needs to be in the list of services to which the connector can present delegated credentials.</span></span> 
5. <span data-ttu-id="6752b-154">Выберите **делегированную идентификацию для входа**, которую соединитель сможет использовать от имени пользователей.</span><span class="sxs-lookup"><span data-stu-id="6752b-154">Choose the **Delegated Login Identity** for the connector to use on behalf of your users.</span></span> <span data-ttu-id="6752b-155">См. дополнительные сведения о [реализации единого входа в приложения с помощью прокси приложения](#Working-with-different-on-premises-and-cloud-identities).</span><span class="sxs-lookup"><span data-stu-id="6752b-155">For more information, see [Working with different on-premises and cloud identities](#Working-with-different-on-premises-and-cloud-identities)</span></span>

   ![Дополнительная настройка приложения](./media/active-directory-application-proxy-sso-using-kcd/cwap_auth2.png)  


## <a name="sso-for-non-windows-apps"></a><span data-ttu-id="6752b-157">Единый вход для приложений не на базе Windows</span><span class="sxs-lookup"><span data-stu-id="6752b-157">SSO for non-Windows apps</span></span>
<span data-ttu-id="6752b-158">Поток делегирования Kerberos в прокси приложения Azure AD запускается, когда Azure AD проверяет подлинность пользователя в облаке.</span><span class="sxs-lookup"><span data-stu-id="6752b-158">The Kerberos delegation flow in Azure AD Application Proxy starts when Azure AD authenticates the user in the cloud.</span></span> <span data-ttu-id="6752b-159">После поступления запроса в локальную среду соединитель прокси приложения Azure AD выдает билет Kerberos от имени пользователя посредством взаимодействия с локальной службой Active Directory.</span><span class="sxs-lookup"><span data-stu-id="6752b-159">Once the request arrives on-premises, the Azure AD Application Proxy connector issues a Kerberos ticket on behalf of the user by interacting with the local Active Directory.</span></span> <span data-ttu-id="6752b-160">Этот процесс называется ограниченным делегированием Kerberos (KCD).</span><span class="sxs-lookup"><span data-stu-id="6752b-160">This process is referred to as Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="6752b-161">На следующем этапе запрос отправляется во внутреннее приложение с этим билетом Kerberos.</span><span class="sxs-lookup"><span data-stu-id="6752b-161">In the next phase, a request is sent to the backend application with this Kerberos ticket.</span></span> <span data-ttu-id="6752b-162">Есть несколько протоколов, которые определяют процедуру отправки таких запросов.</span><span class="sxs-lookup"><span data-stu-id="6752b-162">There are several protocols that define how to send such requests.</span></span> <span data-ttu-id="6752b-163">Большинство серверов не на базе Windows ожидают механизм Negotiate/SPNego, который теперь поддерживается в прокси приложения Azure AD.</span><span class="sxs-lookup"><span data-stu-id="6752b-163">Most non-Windows servers expect Negotiate/SPNego that is now supported on Azure AD Application Proxy.</span></span>

<span data-ttu-id="6752b-164">Дополнительные сведения о Kerberos см. в записи блога [All you want to know about Kerberos Constrained Delegation (KCD)](https://blogs.technet.microsoft.com/applicationproxyblog/2015/09/21/all-you-want-to-know-about-kerberos-constrained-delegation-kcd) (Все, что вы хотели знать об ограниченном делегировании Kerberos (KCD)).</span><span class="sxs-lookup"><span data-stu-id="6752b-164">For more information about Kerberos, see [All you want to know about Kerberos Constrained Delegation (KCD)](https://blogs.technet.microsoft.com/applicationproxyblog/2015/09/21/all-you-want-to-know-about-kerberos-constrained-delegation-kcd).</span></span>

<span data-ttu-id="6752b-165">Приложения других ОС, кроме Windows, вместо доменных адресов электронной почты обычно используют имена пользователей или имена учетных записей SAM.</span><span class="sxs-lookup"><span data-stu-id="6752b-165">Non-Windows apps typically user usernames or SAM account names instead of domain email addresses.</span></span> <span data-ttu-id="6752b-166">Если это применимо к вашим приложениям, следует настроить поле делегированной идентификации для входа, чтобы связать облачные удостоверения с удостоверениями ваших приложений.</span><span class="sxs-lookup"><span data-stu-id="6752b-166">If that situation applies to your applications, you need to configure the delegated login identity field to connect your cloud identities to your application identities.</span></span> 

## <a name="working-with-different-on-premises-and-cloud-identities"></a><span data-ttu-id="6752b-167">Реализация единого входа в приложения с помощью прокси приложения</span><span class="sxs-lookup"><span data-stu-id="6752b-167">Working with different on-premises and cloud identities</span></span>
<span data-ttu-id="6752b-168">Прокси приложения предполагает, что пользователи используют одно и то же удостоверение как в облаке, так и в локальной среде.</span><span class="sxs-lookup"><span data-stu-id="6752b-168">Application Proxy assumes that users have exactly the same identity in the cloud and on-premises.</span></span> <span data-ttu-id="6752b-169">Если это не так, вы можете применить ограниченное делегирование Kerberos для поддержки единого входа.</span><span class="sxs-lookup"><span data-stu-id="6752b-169">If that's not the case, you can can still use KCD for single sign-on.</span></span> <span data-ttu-id="6752b-170">Настройте параметр **Делегированная идентификация для входа** для каждого приложения. Он обозначает, какой идентификатор следует использовать при выполнении единого входа.</span><span class="sxs-lookup"><span data-stu-id="6752b-170">Configure a **Delegated login identity** for each application to specify which identity should be used when performing single sign-on.</span></span>  

<span data-ttu-id="6752b-171">Эта возможность позволяет многим организациям с разными локальными и облачными удостоверениями реализовать единый вход из облака в локальные приложения, чтобы пользователям не нужно было использовать разные имена и пароли.</span><span class="sxs-lookup"><span data-stu-id="6752b-171">This capability allows many organizations that have different on-premises and cloud identities to have SSO from the cloud to on-premises apps without requiring the users to enter different usernames and passwords.</span></span> <span data-ttu-id="6752b-172">Сюда относятся следующие виды организаций:</span><span class="sxs-lookup"><span data-stu-id="6752b-172">This includes organizations that:</span></span>

* <span data-ttu-id="6752b-173">организации, имеющие несколько внутренних доменов (joe@us.contoso.com, joe@eu.contoso.com) и отдельный домен в облаке (joe@contoso.com);</span><span class="sxs-lookup"><span data-stu-id="6752b-173">Have multiple domains internally (joe@us.contoso.com, joe@eu.contoso.com) and a single domain in the cloud (joe@contoso.com).</span></span>
* <span data-ttu-id="6752b-174">организации, у которых внутреннее доменное имя не поддерживает маршрутизацию (joe@contoso.usa), а допустимое доменное имя относится к облаку;</span><span class="sxs-lookup"><span data-stu-id="6752b-174">Have non-routable domain name internally (joe@contoso.usa) and a legal one in the cloud.</span></span>
* <span data-ttu-id="6752b-175">организации, которые не используют внутренние доменные имена (joe);</span><span class="sxs-lookup"><span data-stu-id="6752b-175">Do not use domain names internally (joe)</span></span>
* <span data-ttu-id="6752b-176">организации, использующие разные псевдонимы в локальной и облачной средах.</span><span class="sxs-lookup"><span data-stu-id="6752b-176">Use different aliases on-prem and in the cloud.</span></span> <span data-ttu-id="6752b-177">Например, joe-johns@contoso.com и joej@contoso.com.</span><span class="sxs-lookup"><span data-stu-id="6752b-177">For example, joe-johns@contoso.com vs. joej@contoso.com</span></span>  

<span data-ttu-id="6752b-178">С помощью прокси приложения можно выбрать удостоверение для получения билета Kerberos.</span><span class="sxs-lookup"><span data-stu-id="6752b-178">With Application Proxy, you can select which identity to use to obtain the Kerberos ticket.</span></span> <span data-ttu-id="6752b-179">Этот параметр устанавливается в каждом отдельном приложении.</span><span class="sxs-lookup"><span data-stu-id="6752b-179">This setting is per application.</span></span> <span data-ttu-id="6752b-180">Некоторые из этих параметров подходят для систем, не поддерживающих значения в формате адреса электронной почты, другие предназначены для альтернативного входа в систему.</span><span class="sxs-lookup"><span data-stu-id="6752b-180">Some of these options are suitable for systems that do not accept email address format, others are designed for alternative login.</span></span>

![Снимок экрана параметра "Делегированное удостоверение для входа"](./media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_upn.png)

<span data-ttu-id="6752b-182">Если вы используете делегированную идентификацию для входа, это значение может быть разным для разных доменов или лесов вашей организации.</span><span class="sxs-lookup"><span data-stu-id="6752b-182">If delegated login identity is used, the value might not be unique across all the domains or forests in your organization.</span></span> <span data-ttu-id="6752b-183">Этой проблемы можно избежать, опубликовав приложения дважды с использованием двух разных групп соединителей.</span><span class="sxs-lookup"><span data-stu-id="6752b-183">You can avoid this issue by publishing these applications twice using two different Connector groups.</span></span> <span data-ttu-id="6752b-184">Поскольку каждое приложение имеет собственную аудиторию, его соединители можно присоединить к другому домену.</span><span class="sxs-lookup"><span data-stu-id="6752b-184">Since each application has a different user audience, you can join its Connectors to a different domain.</span></span>

### <a name="configure-sso-for-different-identities"></a><span data-ttu-id="6752b-185">Настройка единого входа для использования разных удостоверений</span><span class="sxs-lookup"><span data-stu-id="6752b-185">Configure SSO for different identities</span></span>
1. <span data-ttu-id="6752b-186">Настройте параметры Azure AD Connect так, чтобы основным удостоверением был адрес электронной почты (почта).</span><span class="sxs-lookup"><span data-stu-id="6752b-186">Configure Azure AD Connect settings so the main identity is the email address (mail).</span></span> <span data-ttu-id="6752b-187">Для этого при настройке следует изменить поле **Имя субъекта-пользователя** в параметрах синхронизации.</span><span class="sxs-lookup"><span data-stu-id="6752b-187">This is done as part of the customize process, by changing the **User Principal Name** field in the sync settings.</span></span> <span data-ttu-id="6752b-188">Эти параметры также определяют, как именно пользователи входят в Office 365, на устройства Windows 10 и в другие приложения, использующие Azure AD в качестве хранилища своих удостоверений.</span><span class="sxs-lookup"><span data-stu-id="6752b-188">These settings also determine how users log in to Office365, Windows10 devices, and other applications that use Azure AD as their identity store.</span></span>  
   <span data-ttu-id="6752b-189">![Снимок экрана "Идентификация пользователей": раскрывающееся меню "Имя участника-пользователя"](./media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_connect_settings.png)</span><span class="sxs-lookup"><span data-stu-id="6752b-189">![Identifying users screenshot - User Principal Name dropdown](./media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_connect_settings.png)</span></span>  
2. <span data-ttu-id="6752b-190">В параметрах конфигурации приложения для приложения, которое вы хотите изменить, выберите нужное значение параметра **Делегированное удостоверение для входа** :</span><span class="sxs-lookup"><span data-stu-id="6752b-190">In the Application Configuration settings for the application you would like to modify, select the **Delegated Login Identity** to be used:</span></span>

   * <span data-ttu-id="6752b-191">имя участника-пользователя (например, joe@contoso.com);</span><span class="sxs-lookup"><span data-stu-id="6752b-191">User Principal Name (for example, joe@contoso.com)</span></span>
   * <span data-ttu-id="6752b-192">дополнительное имя участника-пользователя (например, joed@contoso.local);</span><span class="sxs-lookup"><span data-stu-id="6752b-192">Alternate User Principal Name (for example, joed@contoso.local)</span></span>
   * <span data-ttu-id="6752b-193">имя пользователя, входящее в имя участника-пользователя (например, joe);</span><span class="sxs-lookup"><span data-stu-id="6752b-193">Username part of User Principal Name (for example, joe)</span></span>
   * <span data-ttu-id="6752b-194">имя пользователя, входящее в дополнительное имя участника-пользователя (например, joed);</span><span class="sxs-lookup"><span data-stu-id="6752b-194">Username part of Alternate User Principal Name (for example, joed)</span></span>
   * <span data-ttu-id="6752b-195">имя локальной учетной записи SAM (в зависимости от локальной конфигурации контроллера домена).</span><span class="sxs-lookup"><span data-stu-id="6752b-195">On-premises SAM account name (depends on the domain controller configuration)</span></span>

### <a name="troubleshooting-sso-for-different-identities"></a><span data-ttu-id="6752b-196">Устранение неполадок единого входа для различных удостоверений</span><span class="sxs-lookup"><span data-stu-id="6752b-196">Troubleshooting SSO for different identities</span></span>
<span data-ttu-id="6752b-197">Когда в процессе единого входа возникает ошибка, она заносится в журнал событий на компьютере соединителя, как описано в разделе [Устранение неполадок](application-proxy-back-end-kerberos-constrained-delegation-how-to.md).</span><span class="sxs-lookup"><span data-stu-id="6752b-197">If there is an error in the SSO process, it appears in the connector machine event log as explained in [Troubleshooting](application-proxy-back-end-kerberos-constrained-delegation-how-to.md).</span></span>
<span data-ttu-id="6752b-198">Но в некоторых случаях запрос успешно отправляется внутреннему приложению, пока оно обрабатывает другие HTTP-ответы.</span><span class="sxs-lookup"><span data-stu-id="6752b-198">But, in some cases, the request is successfully sent to the backend application while this application replies in various other HTTP responses.</span></span> <span data-ttu-id="6752b-199">Устранение подобных неполадок следует начинать с проверки события с номером 24029 в журнале событий сеанса прокси приложения на компьютере соединителя.</span><span class="sxs-lookup"><span data-stu-id="6752b-199">Troubleshooting these cases should start by examining event number 24029 on the connector machine in the Application Proxy session event log.</span></span> <span data-ttu-id="6752b-200">Удостоверение пользователя, которое использовалось для делегирования, отображается в поле "Пользователь" в сведениях о событии.</span><span class="sxs-lookup"><span data-stu-id="6752b-200">The user identity that was used for delegation appears in the “user” field within the event details.</span></span> <span data-ttu-id="6752b-201">Чтобы включить журнал сеанса, выберите пункт **Отобразить аналитический и отладочный журналы** в меню "Вид" средства просмотра событий.</span><span class="sxs-lookup"><span data-stu-id="6752b-201">To turn on session log, select **Show analytic and debug logs** in the event viewer view menu.</span></span>

## <a name="next-steps"></a><span data-ttu-id="6752b-202">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="6752b-202">Next steps</span></span>

* [<span data-ttu-id="6752b-203">Настройка приложения прокси приложения для использования ограниченного делегирования Kerberos</span><span class="sxs-lookup"><span data-stu-id="6752b-203">How to configure an Application Proxy application to use Kerberos Constrained Delegation</span></span>](application-proxy-back-end-kerberos-constrained-delegation-how-to.md)
* [<span data-ttu-id="6752b-204">Устранение неполадок с прокси приложения</span><span class="sxs-lookup"><span data-stu-id="6752b-204">Troubleshoot issues you're having with Application Proxy</span></span>](active-directory-application-proxy-troubleshoot.md)


<span data-ttu-id="6752b-205">Последние новости и обновления см. в [блоге, посвященном прокси приложения](http://blogs.technet.com/b/applicationproxyblog/).</span><span class="sxs-lookup"><span data-stu-id="6752b-205">For the latest news and updates, check out the [Application Proxy blog](http://blogs.technet.com/b/applicationproxyblog/)</span></span>


---
title: "Аутентификация на основе заголовков с использованием PingAccess для прокси приложения Azure AD | Документация Майкрософт"
description: "Публикация приложений с использованием PingAccess и прокси приложения для реализации аутентификации на основе заголовка."
services: active-directory
documentationcenter: 
author: daveba
manager: mtillman
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/11/2017
ms.author: daveba
ms.reviewer: harshja
ms.custom: it-pro
ms.openlocfilehash: bfff8ebff87b6c3c501202e95c463a0f4e235ffc
ms.sourcegitcommit: 3cdc82a5561abe564c318bd12986df63fc980a5a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/05/2018
---
# <a name="header-based-authentication-for-single-sign-on-with-application-proxy-and-pingaccess"></a>Аутентификация на основе заголовка для единого входа с использованием прокси приложения и PingAccess

Прокси приложения Active Directory и Azure PingAccess можно использовать для предоставления пользователям Azure Active Directory доступа к разным приложениям. PingAccess позволяет включить в [существующие предложения прокси приложения](active-directory-application-proxy-get-started.md) возможность доступа с единым входом к приложениям, в которых используется аутентификация на основе заголовков.

## <a name="what-is-pingaccess-for-azure-ad"></a>Что такое PingAccess для Azure AD?

PingAccess для Azure Active Directory — предложение PingAccess, позволяющее предоставить пользователям доступ и единый вход для приложений, использующих заголовки для аутентификации. Прокси приложения обрабатывает такие приложения, как и любые другие, используя Azure AD для аутентификации доступа и передавая трафик через службу соединителя. PingAccess находится перед приложением, преобразуя маркер доступа из Azure AD в заголовок. Таким образом приложение может выполнять аутентификацию в поддерживаемом формате.

При этом при получении доступа к корпоративным приложениям пользователи не заметят никаких отличий в процедуре входа. Они по-прежнему смогут работать в любом расположении и на любом устройстве. 

Так как соединители прокси приложения направляют удаленный трафик во все приложения независимо от поддерживаемого типа аутентификации, они также будут продолжать выполнять балансировку нагрузки.

## <a name="how-do-i-get-access"></a>Как мне получить доступ?

Так как этот сценарий предоставляется при совместном использовании Azure Active Directory и PingAccess, вам понадобятся лицензии для двух этих служб. Тем не менее подписки Azure Active Directory Premium включает в себя базовую лицензию PingAccess, которая поддерживает до 20 приложений. Если необходимо опубликовать более 20 приложений, использующих заголовки, вы можете приобрести дополнительную лицензию PingAccess. 

Дополнительные сведения см. в разделе [Выпуски Azure Active Directory](active-directory-editions.md).

## <a name="publish-your-application-in-azure"></a>Публикация приложения в Azure

Эта статья предназначена для пользователей, которые еще не публиковали приложения. В ней рассказывается, как приступить к работе с прокси приложения и PingAccess, а также описываются этапы публикации. Если вы уже настроили обе службы, но хотите вспомнить действия по публикации, то можете пропустить установку соединителя и перейти к разделу [Публикация приложений с поддержкой аутентификации на основе заголовков с использованием прокси приложения Azure AD и PingAccess](#add-your-app-to-Azure-AD-with-Application-Proxy).

>[!NOTE]
>Так как этот сценарий предполагает совместное использование Azure AD и PingAccess, некоторые инструкции доступны на сайте Ping Identity.

### <a name="install-an-application-proxy-connector"></a>Установка соединителя прокси приложения

Если вы уже включили прокси приложения и установили соединитель, то можете пропустить этот раздел и перейти к разделу [Добавление приложения в Azure AD с помощью прокси приложения](#add-your-app-to-azure-ad-with-application-proxy).

Соединитель прокси приложения — это служба Windows Server, которая направляет трафик, поступающий от удаленных сотрудников к опубликованным приложениям. Дополнительные сведения об установке см. в статье [Включение прокси приложения на портале Azure](active-directory-application-proxy-enable.md).

1. Войдите на [портал Azure](https://portal.azure.com) как глобальный администратор.
2. Выберите **Azure Active Directory** > **Прокси приложения**.
3. Щелкните **Скачать соединитель**, чтобы начать скачивание соединителя прокси приложения. Выполните инструкции по установке.

   ![Включение прокси приложения и скачивание соединителя](./media/application-proxy-ping-access/install-connector.png)

4. После скачивания соединитель должен автоматически включить прокси приложения для каталога. В противном случае щелкните **Включить прокси приложения**.


### <a name="add-your-app-to-azure-ad-with-application-proxy"></a>Добавление приложения в Azure AD с помощью прокси приложения

Существуют два действия, которые необходимо выполнить на портале Azure. Во-первых, необходимо опубликовать приложение с помощью прокси приложения. Во-вторых, об этом приложении нужно собрать некоторые сведения, которые можно использовать при работе с PingAccess.

Выполните следующие действия, чтобы опубликовать приложение. Более подробное пошаговое руководство по этапам 1–8 приведено в разделе [Публикация приложений с помощью прокси приложения Azure AD](application-proxy-publish-azure-portal.md).

1. Войдите на [портал Azure](https://portal.azure.com) как глобальный администратор, если вы не сделали это ранее.
2. Выберите **Azure Active Directory** > **Корпоративные приложения**.
3. Щелкните **Добавить** в верхней части колонки.
4. Выберите **Локальное приложение**.
5. Введите в обязательные поля сведения о новом приложении. Вам нужно настроить следующие параметры.
   - **Внутренний URL-адрес** — обычно для приложения указывается URL-адрес страницы входа, на которую вы будете переходить во время работы в корпоративной сети. Для такого сценария соединителю необходимо считать прокси-сервер PingAccess титульной страницей приложения. Используйте следующий формат: `https://<host name of your PA server>:<port>`. Порт 3000 используется по умолчанию, но его можно настроить в PingAccess.

    > [!WARNING]
    > Для этого типа единого входа внутренний URL-адрес должен использовать протокол https и не может использовать протокол http.

   - **Метод предварительной аутентификации** — выберите Azure Active Directory.
   - **Преобразование URL-адреса в заголовок** — выберите значение "Нет".

   >[!NOTE]
   >Если это ваше первое приложение, для начала используйте порт 3000, а затем измените этот параметр, если измените конфигурацию доступа PingAccess. Если это не первое ваше приложение, то данное значение должно соответствовать прослушивателю, настроенному в PingAccess. Узнайте больше о [прослушивателях в PingAccess](https://documentation.pingidentity.com/pingaccess/pa31/index.shtml#Listeners.html).

6. Щелкните **Добавить** в нижней части колонки. Когда приложение будет добавлено, откроется меню быстрого запуска.
7. В меню быстрого запуска выберите **Назначить пользователя для тестирования**, а затем назначьте для приложения хотя бы одного пользователя. Убедитесь, что у тестовой учетной записи есть доступ к локальному приложению.
8. Щелкните **Назначить**, чтобы сохранить назначение тестового пользователя.
9. В колонке управления приложением щелкните **Единый вход**.
10. В раскрывающемся меню выберите **Единый вход на основе заголовка**. Щелкните **Сохранить**.

   >[!TIP]
   >Если вы впервые используете единый вход на основе заголовка, необходимо установить PingAccess. Чтобы обеспечить автоматическую привязку подписки Azure к установленной службе PingAccess, используйте ссылку на этой странице единого входа для скачивания PingAccess. Вы можете прямо сейчас перейти на сайт скачивания или вернуться на эту страницу позже. 

   ![Выбор единого входа на основе заголовка](./media/application-proxy-ping-access/sso-header.PNG)

11. Закройте колонку корпоративных приложений или прокрутите влево, чтобы вернуться в меню Azure Active Directory.
12. Щелкните **Регистрация приложений**.

   ![Выбор "Регистрация приложений"](./media/application-proxy-ping-access/app-registrations.png)

13. Выберите только что добавленное приложение и укажите **URL-адреса ответа**.

   ![Выбор "URL-адреса ответа"](./media/application-proxy-ping-access/reply-urls.png)

14. Убедитесь, что в списке URL-адресов ответа отображается внешний URL-адрес, назначенный приложению на шаге 5. В противном случае добавьте этот URL-адрес.
15. В колонке параметров приложения щелкните **Требуемые разрешения**.

  ![Выбор "Необходимые разрешения"](./media/application-proxy-ping-access/required-permissions.png)

16. Выберите **Добавить**. В качестве API укажите **Windows Azure Active Directory** и щелкните **Выбрать**. В качестве разрешений укажите **Чтение и запись всех приложений** и **Вход и чтение профиля пользователя**, а затем щелкните **Выбрать** и **Готово**.  

  ![Выбор разрешений](./media/application-proxy-ping-access/select-permissions.png)

17. Предоставьте разрешения, прежде чем закрыть окно разрешений. 
![Предоставление разрешений](media/application-proxy-ping-access/grantperms.png)

### <a name="collect-information-for-the-pingaccess-steps"></a>Сбор сведений об этапах PingAccess

1. В колонке параметров приложения щелкните **Свойства**. 

  ![Выбор "Свойства"](./media/application-proxy-ping-access/properties.png)

2. Сохраните значение **идентификатора приложения**. Оно используется в качестве идентификатора клиента при настройке PingAccess.
3. В колонке параметров щелкните **Ключи**.

  ![Выбор "Ключи"](./media/application-proxy-ping-access/Keys.png)

4. Создайте ключ. Для этого в раскрывающемся меню введите описание ключа и выберите дату окончания срока его действия.
5. Щелкните **Сохранить**. В поле **Значение** отобразится идентификатор GUID.

  Сохраните это значение. Закрыв это окно, вы больше не сможете его увидеть.

  ![Создание ключа](./media/application-proxy-ping-access/create-keys.png)

6. Закройте колонку регистрации приложений или прокрутите влево, чтобы вернуться в меню Azure Active Directory.
7. Выберите **Свойства**.
8. Сохраните **идентификатор каталога** (GUID).

### <a name="optional---update-graphapi-to-send-custom-fields"></a>Необязательно. Обновление API Graph для отправки настраиваемых полей

Список маркеров безопасности, отправляемых Azure AD для проверки подлинности, см. в [справочнике по маркерам Azure AD](./develop/active-directory-token-and-claims.md). Если требуется пользовательское утверждение, отправляющий других токенов, использовать Graph Explorer или манифест приложения на портале Azure Чтобы задать поле приложения *acceptMappedClaims* для **True**.    

В этом примере используется Graph Explorer.

```
PATCH https://graph.windows.net/myorganization/applications/<object_id_GUID_of_your_application> 

{
  "acceptMappedClaims":true
}
```
В этом примере используется [портал Azure](https://portal.azure.com) для udpate будет именем *acceptedMappedClaims* поля:
1. Войдите на [портал Azure](https://portal.azure.com) как глобальный администратор.
2. Выберите **Azure Active Directory** > **регистрации приложения**.
3. Выберите приложение > **манифеста**.
4. Выберите **изменить**, поиск *acceptedMappedClaims* поле и измените значение на **true**.
![Манифест приложения](media/application-proxy-ping-access/application-proxy-ping-access-manifest.PNG)
1. Щелкните **Сохранить**.

>[!NOTE]
>Чтобы использовать настраиваемое утверждение, также необходимо определить настраиваемую политику и назначить ее приложению.  Эта политика должна включать все обязательные настраиваемые атрибуты.
>
>Определить и назначить политику можно с помощью PowerShell, песочницы Graph в Azure AD или Microsoft Graph.  Если вы выполняете эти действия в PowerShell, возможно, сначала потребуется использовать `New-AzureADPolicy ` и назначить политику приложению с помощью `Set-AzureADServicePrincipalPolicy`.  Дополнительные сведения см. в [документации о политике Azure AD](active-directory-claims-mapping.md#claims-mapping-policy-assignment).

### <a name="optional---use-a-custom-claim"></a>Использование настраиваемого утверждения (необязательно)
Чтобы использовать в приложении настраиваемое утверждение и включить в него дополнительные поля, также необходимо [создать политику сопоставления настраиваемых утверждений и назначить ее приложению](active-directory-claims-mapping.md#claims-mapping-policy-assignment).

## <a name="download-pingaccess-and-configure-your-app"></a>Скачивание PingAccess и настройка приложения

Теперь, когда вы выполнили все этапы установки Azure Active Directory, можно перейти к настройке PingAccess. 

См. подробные инструкции по [настройке PingAccess для работы с Azure AD](https://docs.pingidentity.com/bundle/paaad_m_ConfigurePAforMSAzureADSolution_paaad43/page/pa_c_PAAzureSolutionOverview.html) в рамках этого сценария в документации по Ping Identity.

В этом руководстве описывается, как получить учетную запись PingAccess (если у вас ее еще нет), установить сервер PingAccess и создать подключение к поставщику Azure AD OIDC с использованием идентификатора каталога, скопированного на портале Azure. Затем с использованием ключа и идентификатора приложения вы создадите веб-сеанс PingAccess. После этого вы сможете настроить сопоставление удостоверений и создать виртуальный узел, сайт и приложение.

### <a name="test-your-app"></a>Тестирование приложения

Когда вы завершите выполнение этих шагов, ваше приложение будет настроено и запущено. Чтобы протестировать его, откройте браузер и перейдите по внешнему URL-адресу, созданному при публикации приложения в Azure. Войдите с помощью тестовой учетной записи, назначенной приложению.

## <a name="next-steps"></a>Дальнейшие действия

- [Настройка PingAccess для Azure AD](https://docs.pingidentity.com/bundle/paaad_m_ConfigurePAforMSAzureADSolution_paaad43/page/pa_c_PAAzureSolutionOverview.html)
- [Как прокси приложения Azure AD предоставляет единый вход?](application-proxy-sso-overview.md)
- [Устранение неполадок прокси-сервера приложений](active-directory-application-proxy-troubleshoot.md)

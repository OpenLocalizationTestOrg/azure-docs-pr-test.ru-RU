---
title: "Настройка удаленного доступа к SharePoint с помощью прокси приложения Azure AD | Документы Майкрософт"
description: "Рассматриваются основные сведения об интеграции локального сервера SharePoint с прокси приложения Azure AD."
services: active-directory
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/21/2017
ms.author: kgremban
ms.reviewer: harshja
ms.custom: it-pro
ms.openlocfilehash: 97eeec3b3936bcbef6ac3966b890332901bcb153
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="enable-remote-access-to-sharepoint-with-azure-ad-application-proxy"></a><span data-ttu-id="06ca8-103">Настройка удаленного доступа к SharePoint с помощью прокси приложения Azure AD</span><span class="sxs-lookup"><span data-stu-id="06ca8-103">Enable remote access to SharePoint with Azure AD Application Proxy</span></span>

<span data-ttu-id="06ca8-104">В этой статье описывается интеграция локального сервера SharePoint с прокси приложения Azure Active Directory (Azure AD).</span><span class="sxs-lookup"><span data-stu-id="06ca8-104">This article discusses how to integrate an on-premises SharePoint server with Azure Active Directory (Azure AD) Application Proxy.</span></span>

<span data-ttu-id="06ca8-105">Чтобы включить удаленный доступ к SharePoint с помощью прокси приложения Azure AD, следуйте пошаговым инструкциям в разделах этой статьи.</span><span class="sxs-lookup"><span data-stu-id="06ca8-105">To enable remote access to SharePoint with Azure AD Application Proxy, follow the sections in this article step by step.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="06ca8-106">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="06ca8-106">Prerequisites</span></span>

<span data-ttu-id="06ca8-107">В этой статье предполагается, что в вашей среде уже есть SharePoint 2013 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="06ca8-107">This article assumes that you already have SharePoint 2013 or newer in your environment.</span></span> <span data-ttu-id="06ca8-108">Кроме того, необходимо выполнить следующие предварительные требования.</span><span class="sxs-lookup"><span data-stu-id="06ca8-108">In addition, consider the following prerequisites:</span></span>

* <span data-ttu-id="06ca8-109">SharePoint имеет встроенную поддержку Kerberos.</span><span class="sxs-lookup"><span data-stu-id="06ca8-109">SharePoint includes native Kerberos support.</span></span> <span data-ttu-id="06ca8-110">Поэтому можно предположить, что пользователи, которые получают удаленный доступ к внутренним сайтам через прокси приложения Azure AD, пользуются преимуществами единого входа.</span><span class="sxs-lookup"><span data-stu-id="06ca8-110">Therefore, users who are accessing internal sites remotely through Azure AD Application Proxy can assume to have a single sign-on (SSO) experience.</span></span>

* <span data-ttu-id="06ca8-111">Вам понадобится внести некоторые изменения в конфигурацию на сервере SharePoint.</span><span class="sxs-lookup"><span data-stu-id="06ca8-111">You need to make a few configuration changes to your SharePoint server.</span></span> <span data-ttu-id="06ca8-112">Мы рекомендуем использовать промежуточную среду.</span><span class="sxs-lookup"><span data-stu-id="06ca8-112">We recommend using a staging environment.</span></span> <span data-ttu-id="06ca8-113">Так вы сначала внесете изменения на промежуточном сервере, что упростит цикл тестирования при переходе на рабочую среду.</span><span class="sxs-lookup"><span data-stu-id="06ca8-113">This way, you can make updates to your staging server first, and then facilitate a testing cycle before going into production.</span></span>

* <span data-ttu-id="06ca8-114">Мы предполагаем, что вы уже настроили SSL для SharePoint, так как он требуется для опубликованного URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="06ca8-114">We assume that you have already set up SSL for SharePoint, because we require SSL on the published URL.</span></span> <span data-ttu-id="06ca8-115">Вам потребуется включить SSL на внутреннем сайте, чтобы обеспечить надлежащую отправку и сопоставление ссылок.</span><span class="sxs-lookup"><span data-stu-id="06ca8-115">You need to have SSL enabled on your internal site, to ensure that links are sent/mapped correctly.</span></span> <span data-ttu-id="06ca8-116">Если вы еще не настроили SSL, см. инструкции в разделе [Настройка SSL для SharePoint 2013](https://blogs.msdn.microsoft.com/fabdulwahab/2013/01/20/configure-ssl-for-sharepoint-2013).</span><span class="sxs-lookup"><span data-stu-id="06ca8-116">If you haven't configured SSL, see [Configure SSL for SharePoint 2013](https://blogs.msdn.microsoft.com/fabdulwahab/2013/01/20/configure-ssl-for-sharepoint-2013) for instructions.</span></span> <span data-ttu-id="06ca8-117">Кроме того, убедитесь, что соединитель компьютера доверяет выдаваемому сертификату.</span><span class="sxs-lookup"><span data-stu-id="06ca8-117">Also, make sure that the connector machine trusts the certificate that you issue.</span></span> <span data-ttu-id="06ca8-118">(Это необязательно должен быть открыто выданный сертификат.)</span><span class="sxs-lookup"><span data-stu-id="06ca8-118">(The certificate does not need to be publicly issued.)</span></span>

## <a name="step-1-set-up-single-sign-on-to-sharepoint"></a><span data-ttu-id="06ca8-119">Шаг 1. Настройка единого входа в SharePoint</span><span class="sxs-lookup"><span data-stu-id="06ca8-119">Step 1: Set up single sign-on to SharePoint</span></span>

<span data-ttu-id="06ca8-120">Наши клиенты хотят обеспечить простую процедуру единого входа для серверных приложений (в нашем случае для сервера SharePoint).</span><span class="sxs-lookup"><span data-stu-id="06ca8-120">Our customers want the best SSO experience for their back-end applications, SharePoint server in this case.</span></span> <span data-ttu-id="06ca8-121">В этом распространенном сценарии Azure AD пользователь проходит проверку подлинности только один раз. Последующих запросов на проверку не будет.</span><span class="sxs-lookup"><span data-stu-id="06ca8-121">In this common Azure AD scenario, the user is authenticated only once, because they will not be prompted for authentication again.</span></span>

<span data-ttu-id="06ca8-122">Для локальных приложений, требующих или использующих проверку подлинности Windows, единый вход можно обеспечить с помощью протокола проверки подлинности Kerberos и функции, называемой ограниченным делегированием Kerberos (KCD).</span><span class="sxs-lookup"><span data-stu-id="06ca8-122">For on-premises applications that require or use Windows authentication, you can achieve SSO by using the Kerberos authentication protocol and a feature called Kerberos constrained delegation (KCD).</span></span> <span data-ttu-id="06ca8-123">Если функция KCD настроена, она позволяет соединителю прокси приложения получить билет и маркер Windows для пользователя, даже если тот не выполнил вход в Windows напрямую.</span><span class="sxs-lookup"><span data-stu-id="06ca8-123">KCD, when configured, allows the Application Proxy connector to obtain a windows ticket/token for a user, even if the user hasn’t signed in to Windows directly.</span></span> <span data-ttu-id="06ca8-124">Дополнительные сведения об ограниченном делегировании Kerberos см. в [этой статье](https://technet.microsoft.com/library/jj553400.aspx).</span><span class="sxs-lookup"><span data-stu-id="06ca8-124">To learn more about KCD, see [Kerberos Constrained Delegation Overview](https://technet.microsoft.com/library/jj553400.aspx).</span></span>

<span data-ttu-id="06ca8-125">Чтобы настроить KCD для сервера, выполните процедуры, описанные в следующих разделах.</span><span class="sxs-lookup"><span data-stu-id="06ca8-125">To set up KCD for a SharePoint server, use the procedures in the following sequential sections:</span></span>

### <a name="ensure-that-sharepoint-is-running-under-a-service-account"></a><span data-ttu-id="06ca8-126">Проверка того, что сервер SharePoint запущен с использованием учетной записи службы</span><span class="sxs-lookup"><span data-stu-id="06ca8-126">Ensure that SharePoint is running under a service account</span></span>

<span data-ttu-id="06ca8-127">Сначала проверьте, что сервер SharePoint запущен с использованием определенной учетной записи службы, а не учетной записи локальной системы, локальной службы или сетевой службы.</span><span class="sxs-lookup"><span data-stu-id="06ca8-127">First, make sure that SharePoint is running under a defined service account--not local system, local service, or network service.</span></span> <span data-ttu-id="06ca8-128">Это нужно сделать, чтобы вы могли присоединить имена субъектов-служб к действительной учетной записи.</span><span class="sxs-lookup"><span data-stu-id="06ca8-128">Do this so that you can attach service principal names (SPNs) to a valid account.</span></span> <span data-ttu-id="06ca8-129">Kerberos идентифицирует различные службы по этим именам.</span><span class="sxs-lookup"><span data-stu-id="06ca8-129">SPNs are how the Kerberos protocol identifies different services.</span></span> <span data-ttu-id="06ca8-130">Учетная запись потребуется позже, чтобы настроить ограниченное делегирование Kerberos.</span><span class="sxs-lookup"><span data-stu-id="06ca8-130">And you will need the account later to configure the KCD.</span></span>

<span data-ttu-id="06ca8-131">Чтобы убедиться, что сайты запущены с использованием определенной учетной записи службы, сделайте следующее.</span><span class="sxs-lookup"><span data-stu-id="06ca8-131">To ensure that your sites are running under a defined service account, perform the following steps:</span></span>

1. <span data-ttu-id="06ca8-132">Откройте сайт **центра администрирования SharePoint 2013**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-132">Open the **SharePoint 2013 Central Administration** site.</span></span>
2. <span data-ttu-id="06ca8-133">Щелкните **Безопасность** и выберите **Настройка учетных записей служб**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-133">Go to **Security** and select **Configure service accounts**.</span></span>
3. <span data-ttu-id="06ca8-134">Выберите **Пул веб-приложений — SharePoint — 80**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-134">Select **Web Application Pool - SharePoint - 80**.</span></span> <span data-ttu-id="06ca8-135">Параметры могут немного отличаться в зависимости от имени пула веб-приложений или при использовании SSL по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="06ca8-135">The options may be slightly different based on the name of your web pool, or if the web pool uses SSL by default.</span></span>

  ![Параметры для настройки учетной записи службы](./media/application-proxy-remote-sharepoint/remote-sharepoint-service-web-application.png)

4. <span data-ttu-id="06ca8-137">Если в разделе **Выберите учетную запись для этого компонента** выбран вариант **Локальная служба** или **Сетевая служба**, необходимо создать учетную запись.</span><span class="sxs-lookup"><span data-stu-id="06ca8-137">If **Select an account for this component** is **Local Service** or **Network Service**, you need to create an account.</span></span> <span data-ttu-id="06ca8-138">В противном случае все готово, и вы можете переходить к следующему шагу.</span><span class="sxs-lookup"><span data-stu-id="06ca8-138">If not, you're finished and can move to the next section.</span></span>
5. <span data-ttu-id="06ca8-139">Выберите **Регистрация новой управляемой учетной записи**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-139">Select **Register new managed account**.</span></span> <span data-ttu-id="06ca8-140">Как только учетная запись будет создана, прежде чем ее использовать, необходимо задать **пул веб-приложений**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-140">After your account is created, you must set **Web Application Pool** before you can use the account.</span></span>

> [!NOTE]
<span data-ttu-id="06ca8-141">Вам потребуется ранее созданная учетная запись AD для службы.</span><span class="sxs-lookup"><span data-stu-id="06ca8-141">You need to have a previously created Azure AD account for the service.</span></span> <span data-ttu-id="06ca8-142">Мы рекомендуем настроить автоматическую смену паролей.</span><span class="sxs-lookup"><span data-stu-id="06ca8-142">We suggest that you allow for an automatic password change.</span></span> <span data-ttu-id="06ca8-143">Описание полной процедуры и сведения по устранению неполадок см. в статье [Настройка автоматической смены паролей в SharePoint 2013](https://technet.microsoft.com/library/ff724280.aspx).</span><span class="sxs-lookup"><span data-stu-id="06ca8-143">For more information about the full set of steps and troubleshooting issues, see [Configure automatic password change in SharePoint 2013](https://technet.microsoft.com/library/ff724280.aspx).</span></span>

### <a name="configure-sharepoint-for-kerberos"></a><span data-ttu-id="06ca8-144">Настройка SharePoint для Kerberos</span><span class="sxs-lookup"><span data-stu-id="06ca8-144">Configure SharePoint for Kerberos</span></span>

<span data-ttu-id="06ca8-145">Вы применяете ограниченное делегирование Kerberos для выполнения единого входа на сервер SharePoint. Это работает только с использованием Kerberos.</span><span class="sxs-lookup"><span data-stu-id="06ca8-145">You use KCD to perform single sign-on to the SharePoint server, and this works only with Kerberos.</span></span>

<span data-ttu-id="06ca8-146">Чтобы настроить сайт SharePoint для проверки подлинности Kerberos:</span><span class="sxs-lookup"><span data-stu-id="06ca8-146">To configure your SharePoint site for Kerberos authentication:</span></span>

1. <span data-ttu-id="06ca8-147">Откройте сайт **центра администрирования SharePoint 2013**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-147">Open the **SharePoint 2013 Central Administration** site.</span></span>
2. <span data-ttu-id="06ca8-148">Щелкните **Управление приложениями**, выберите **Управление веб-приложениями**, а затем — свой сайт SharePoint.</span><span class="sxs-lookup"><span data-stu-id="06ca8-148">Go to **Application Management**, select **Manage web applications**, and select your SharePoint site.</span></span> <span data-ttu-id="06ca8-149">В данном примере выберите **SharePoint — 80**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-149">In this example, it is **SharePoint - 80**.</span></span>

  ![Выбор сайта SharePoint](./media/application-proxy-remote-sharepoint/remote-sharepoint-manage-web-applications.png)

3. <span data-ttu-id="06ca8-151">На панели инструментов щелкните **Поставщики проверки подлинности**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-151">Click **Authentication Providers** on the toolbar.</span></span>
4. <span data-ttu-id="06ca8-152">В окне **Поставщики проверки подлинности** щелкните **Default Zone** (Зона по умолчанию), чтобы просмотреть параметры.</span><span class="sxs-lookup"><span data-stu-id="06ca8-152">In the **Authentication Providers** box, click **Default Zone** to view the settings.</span></span>
5. <span data-ttu-id="06ca8-153">В окне **Изменение параметров проверки подлинности** прокрутите вниз до раздела **Типы проверки подлинности на основе утверждений** и установите флажки **Включить проверку подлинности Windows** и **Встроенная проверка подлинности Windows**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-153">In the **Edit Authentication** dialog box, scroll down until you see **Claims Authentication Types** and ensure that both **Enable Windows Authentication** and **Integrated Windows Authentication** are selected.</span></span>
6. <span data-ttu-id="06ca8-154">В раскрывающемся списке выберите **Согласование (Kerberos)**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-154">In the drop-down box, make sure that **Negotiate (Kerberos)** is selected.</span></span>

  ![Диалоговое окно "Изменение параметров проверки подлинности"](./media/application-proxy-remote-sharepoint/remote-sharepoint-service-edit-authentication.png)

7. <span data-ttu-id="06ca8-156">В самом низу окна **Изменение параметров проверки подлинности** нажмите кнопку **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-156">At the bottom of the **Edit Authentication** dialog box, click **Save**.</span></span>

### <a name="set-a-service-principal-name-for-the-sharepoint-service-account"></a><span data-ttu-id="06ca8-157">Задание имени субъекта-службы для учетной записи службы SharePoint</span><span class="sxs-lookup"><span data-stu-id="06ca8-157">Set a service principal name for the SharePoint service account</span></span>

<span data-ttu-id="06ca8-158">Прежде чем настраивать ограниченное делегирование Kerberos, необходимо определить службу SharePoint, запущенную в качестве настроенной учетной записи службы.</span><span class="sxs-lookup"><span data-stu-id="06ca8-158">Before you configure the KCD, you need to identify the SharePoint service running as the service account that you've configured.</span></span> <span data-ttu-id="06ca8-159">Для этого нужно задать имя субъекта-службы.</span><span class="sxs-lookup"><span data-stu-id="06ca8-159">You do this by setting an SPN.</span></span> <span data-ttu-id="06ca8-160">Дополнительные сведения об именах субъектов-служб см. в [этом разделе](https://technet.microsoft.com/library/cc961723.aspx).</span><span class="sxs-lookup"><span data-stu-id="06ca8-160">For more information, see [Service Principal Names](https://technet.microsoft.com/library/cc961723.aspx).</span></span>

<span data-ttu-id="06ca8-161">Имя субъекта-службы выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="06ca8-161">The SPN format is:</span></span>

```
<service class>/<host>:<port>
```

<span data-ttu-id="06ca8-162">В формате SPN:</span><span class="sxs-lookup"><span data-stu-id="06ca8-162">In the SPN format:</span></span>

* <span data-ttu-id="06ca8-163">_service class_ — это уникальное имя службы.</span><span class="sxs-lookup"><span data-stu-id="06ca8-163">_service class_ is a unique name for the service.</span></span> <span data-ttu-id="06ca8-164">Для SharePoint используется **HTTP**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-164">For SharePoint, you use **HTTP**.</span></span>

* <span data-ttu-id="06ca8-165">_host_ — это полное доменное имя или NetBIOS-имя узла, на котором запущена служба.</span><span class="sxs-lookup"><span data-stu-id="06ca8-165">_host_ is the fully qualified domain or NetBIOS name of the host that the service is running on.</span></span> <span data-ttu-id="06ca8-166">Для сайта SharePoint это может быть URL-адрес сайта в зависимости от используемой версии IIS.</span><span class="sxs-lookup"><span data-stu-id="06ca8-166">For a SharePoint site, this text might need to be the URL of the site, depending on the version of IIS that you're using.</span></span>

* <span data-ttu-id="06ca8-167">_port_ указывать необязательно.</span><span class="sxs-lookup"><span data-stu-id="06ca8-167">_port_ is optional.</span></span>

<span data-ttu-id="06ca8-168">Полное доменное имя сервера SharePoint может выглядеть так:</span><span class="sxs-lookup"><span data-stu-id="06ca8-168">If the FQDN of the SharePoint server is:</span></span>

```
sharepoint.demo.o365identity.us
```

<span data-ttu-id="06ca8-169">В таком случае имя субъекта-службы будет иметь следующий вид:</span><span class="sxs-lookup"><span data-stu-id="06ca8-169">Then the SPN is:</span></span>

```
HTTP/ sharepoint.demo.o365identity.us demo
```

<span data-ttu-id="06ca8-170">Кроме того, может потребоваться задать имена субъектов-служб для определенных сайтов на сервере.</span><span class="sxs-lookup"><span data-stu-id="06ca8-170">You might also need to set SPNs for specific sites on your server.</span></span> <span data-ttu-id="06ca8-171">Дополнительные сведения см. в статье [Настройка проверки подлинности Kerberos](https://technet.microsoft.com/library/cc263449(v=office.12).aspx).</span><span class="sxs-lookup"><span data-stu-id="06ca8-171">For more information, see [Configure Kerberos authentication](https://technet.microsoft.com/library/cc263449(v=office.12).aspx).</span></span> <span data-ttu-id="06ca8-172">Уделите особое внимание разделу "Создание имен участников служб для веб-приложений, использующих проверку подлинности Kerberos".</span><span class="sxs-lookup"><span data-stu-id="06ca8-172">Pay close attention to the section "Create Service Principal Names for your Web applications using Kerberos authentication."</span></span>

<span data-ttu-id="06ca8-173">Самый простой способ сделать это — использовать имена субъектов-служб, которые уже существуют для вашего сайта.</span><span class="sxs-lookup"><span data-stu-id="06ca8-173">The easiest way for you to set SPNs is to follow the SPN formats that may already be present for your sites.</span></span> <span data-ttu-id="06ca8-174">Скопируйте эти имена субъектов-служб для регистрации в учетной записи службы.</span><span class="sxs-lookup"><span data-stu-id="06ca8-174">Copy those SPNs to register against the service account.</span></span> <span data-ttu-id="06ca8-175">Для этого:</span><span class="sxs-lookup"><span data-stu-id="06ca8-175">To do this:</span></span>

1. <span data-ttu-id="06ca8-176">Перейдите к сайту с другого компьютера, используя имя субъекта-службы.</span><span class="sxs-lookup"><span data-stu-id="06ca8-176">Browse to the site with the SPN from another machine.</span></span>
 <span data-ttu-id="06ca8-177">При этом соответствующий набор билетов Kerberos кэшируется на этом компьютере.</span><span class="sxs-lookup"><span data-stu-id="06ca8-177">When you do, the relevant set of Kerberos tickets is cached on the machine.</span></span> <span data-ttu-id="06ca8-178">Эти билеты содержат имя субъекта-службы целевого сайта, на который вы перешли.</span><span class="sxs-lookup"><span data-stu-id="06ca8-178">These tickets contain the SPN of the target site that you browsed to.</span></span>

2. <span data-ttu-id="06ca8-179">Можно извлечь имя субъекта-службы этого сайта, используя средство [Klist](http://web.mit.edu/kerberos/krb5-devel/doc/user/user_commands/klist.html).</span><span class="sxs-lookup"><span data-stu-id="06ca8-179">You can pull the SPN for that site by using a tool called [Klist](http://web.mit.edu/kerberos/krb5-devel/doc/user/user_commands/klist.html).</span></span> <span data-ttu-id="06ca8-180">В командном окне, запущенном в том же контексте, что и пользователь, который перешел на сайт в браузере, выполните следующую команду:</span><span class="sxs-lookup"><span data-stu-id="06ca8-180">In a command window that's running in the same context as the user who accessed the site in the browser, run the following command:</span></span>
```
Klist
```
<span data-ttu-id="06ca8-181">Klist возвращает набор целевых имен субъектов-служб.</span><span class="sxs-lookup"><span data-stu-id="06ca8-181">Klist then returns the set of target SPNs.</span></span> <span data-ttu-id="06ca8-182">В этом примере выделено необходимое нам имя субъекта-службы.</span><span class="sxs-lookup"><span data-stu-id="06ca8-182">In this example, the highlighted value is the SPN that's needed:</span></span>

  ![Пример результатов Klist](./media/application-proxy-remote-sharepoint/remote-sharepoint-target-service.png)

4. <span data-ttu-id="06ca8-184">Теперь, когда у вас есть имя субъекта-службы, его необходимо правильно настроить для учетной записи службы, заданной для веб-приложения ранее.</span><span class="sxs-lookup"><span data-stu-id="06ca8-184">Now that you have the SPN, you need to make sure that it's configured correctly on the service account that you set up for the web application earlier.</span></span> <span data-ttu-id="06ca8-185">Выполните указанную ниже команду из командной строки с правами администратора домена.</span><span class="sxs-lookup"><span data-stu-id="06ca8-185">Run the following command from the command prompt as an administrator of the domain:</span></span>

 ```
 setspn -S http/sharepoint.demo.o365identity.us demo\sp_svc
 ```

 <span data-ttu-id="06ca8-186">Эта команда задает имя субъекта-службы для учетной записи службы SharePoint _demo\sp_svc_.</span><span class="sxs-lookup"><span data-stu-id="06ca8-186">This command sets the SPN for the SharePoint service account running as _demo\sp_svc_.</span></span>

 <span data-ttu-id="06ca8-187">Замените _http/sharepoint.demo.o365identity.us_ именем субъекта-службы для сервера, а _demo\sp_svc_ — учетной записью службы в вашей среде.</span><span class="sxs-lookup"><span data-stu-id="06ca8-187">Replace _http/sharepoint.demo.o365identity.us_ with the SPN for your server and _demo\sp_svc_ with the service account in your environment.</span></span> <span data-ttu-id="06ca8-188">Команда setspn выполняет поиск имени субъекта-службы, прежде чем его добавить.</span><span class="sxs-lookup"><span data-stu-id="06ca8-188">The Setspn command searches for the SPN before it adds it.</span></span> <span data-ttu-id="06ca8-189">В этом случае может появиться ошибка **Повторяющееся значение имени субъекта-службы**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-189">In this case, you might see a **Duplicate SPN Value** error.</span></span> <span data-ttu-id="06ca8-190">Если вы видите эту ошибку, убедитесь, что это значение связано с нужной учетной записью службы.</span><span class="sxs-lookup"><span data-stu-id="06ca8-190">If you see this error, make sure that the value is associated with the service account.</span></span>

<span data-ttu-id="06ca8-191">Чтобы убедиться, что имя субъекта-службы добавлено, выполните команду setspn с параметром -l.</span><span class="sxs-lookup"><span data-stu-id="06ca8-191">You can verify that the SPN was added by running the Setspn command with the -l option.</span></span> <span data-ttu-id="06ca8-192">Дополнительные сведения о команде setspn см. в [этой статье](https://technet.microsoft.com/library/cc731241.aspx).</span><span class="sxs-lookup"><span data-stu-id="06ca8-192">To learn more about this command, see [Setspn](https://technet.microsoft.com/library/cc731241.aspx).</span></span>

### <a name="ensure-that-the-connector-is-set-as-a-trusted-delegate-to-sharepoint"></a><span data-ttu-id="06ca8-193">Настройка доверенного соединителя для делегирования для SharePoint</span><span class="sxs-lookup"><span data-stu-id="06ca8-193">Ensure that the connector is set as a trusted delegate to SharePoint</span></span>

<span data-ttu-id="06ca8-194">Настройте ограниченное делегирование Kerberos, чтобы служба прокси приложения Azure AD могла делегировать удостоверения пользователей для службы SharePoint.</span><span class="sxs-lookup"><span data-stu-id="06ca8-194">Configure the KCD so that the Azure AD Application Proxy service can delegate user identities to the SharePoint service.</span></span> <span data-ttu-id="06ca8-195">Для этого мы настроим для соединителя прокси приложения возможность получать билеты Kerberos для пользователей, которые прошли проверку подлинности в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="06ca8-195">You do this by enabling the Application Proxy connector to retrieve Kerberos tickets for your users who have been authenticated in Azure AD.</span></span> <span data-ttu-id="06ca8-196">Затем этот сервер передает контекст в целевое приложение (SharePoint в нашем случае).</span><span class="sxs-lookup"><span data-stu-id="06ca8-196">Then that server passes the context to the target application, or SharePoint in this case.</span></span>

<span data-ttu-id="06ca8-197">Чтобы настроить ограниченное делегирование Kerberos, выполните приведенные далее действия для каждого компьютера соединителя.</span><span class="sxs-lookup"><span data-stu-id="06ca8-197">To configure the KCD, repeat the following steps for each connector machine:</span></span>

1. <span data-ttu-id="06ca8-198">Войдите в контроллер домена от имени администратора домена, а затем перейдите к компоненту **Пользователи и компьютеры Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-198">Log in as a domain administrator to a DC, and then open **Active Directory Users and Computers**.</span></span>
2. <span data-ttu-id="06ca8-199">Найдите компьютер, на котором запущен соединитель.</span><span class="sxs-lookup"><span data-stu-id="06ca8-199">Find the computer that the connector is running on.</span></span> <span data-ttu-id="06ca8-200">В этом примере это тот же сервер SharePoint.</span><span class="sxs-lookup"><span data-stu-id="06ca8-200">In this example, it's the same SharePoint server.</span></span>
3. <span data-ttu-id="06ca8-201">Дважды щелкните имя компьютера, а затем перейдите на вкладку **Делегирование**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-201">Double-click the computer, and then click the **Delegation** tab.</span></span>
4. <span data-ttu-id="06ca8-202">Установите переключатель **Trust this computer for delegation to the specified services only** (Доверять этому компьютеру для делегирования только указанным службам), а затем — **Use any authentication protocol** (Использовать любой протокол проверки подлинности).</span><span class="sxs-lookup"><span data-stu-id="06ca8-202">Ensure that the delegation settings are set to **Trust this computer for delegation to the specified services only**, and then select **Use any authentication protocol**.</span></span>

  ![Параметры делегирования](./media/application-proxy-remote-sharepoint/remote-sharepoint-delegation-box.png)

5. <span data-ttu-id="06ca8-204">Нажмите кнопку **Добавить**, щелкните **Пользователи или компьютеры** и найдите учетную запись службы.</span><span class="sxs-lookup"><span data-stu-id="06ca8-204">Click the **Add** button, click **Users or Computers**, and locate the service account.</span></span>

  ![Добавление имени участника-службы для учетной записи службы](./media/application-proxy-remote-sharepoint/remote-sharepoint-users-computers.png)

6. <span data-ttu-id="06ca8-206">В списке имен участников-служб выберите того, который вы создали ранее для учетной записи службы.</span><span class="sxs-lookup"><span data-stu-id="06ca8-206">In the list of SPNs, select the one that you created earlier for the service account.</span></span>
7. <span data-ttu-id="06ca8-207">Нажмите кнопку **ОК**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-207">Click **OK**.</span></span> <span data-ttu-id="06ca8-208">Нажмите кнопку **ОК** еще раз, чтобы сохранить изменения.</span><span class="sxs-lookup"><span data-stu-id="06ca8-208">Click **OK** again to save the changes.</span></span>

## <a name="step-2-enable-remote-access-to-sharepoint"></a><span data-ttu-id="06ca8-209">Шаг 2. Включение удаленного доступа к SharePoint</span><span class="sxs-lookup"><span data-stu-id="06ca8-209">Step 2: Enable remote access to SharePoint</span></span>

<span data-ttu-id="06ca8-210">Теперь, когда вы настроили SharePoint для Kerberos и функцию KCD, можно приступать к настройке единого входа для SharePoint.</span><span class="sxs-lookup"><span data-stu-id="06ca8-210">Now that you’ve enabled SharePoint for Kerberos and configured KCD, you're ready to set up single sign-on to SharePoint.</span></span> <span data-ttu-id="06ca8-211">Затем из этого соединителя можно опубликовать ферму SharePoint для удаленного доступа через прокси приложения Azure AD.</span><span class="sxs-lookup"><span data-stu-id="06ca8-211">Then from the connector, you can publish the SharePoint farm for remote access through Azure AD Application Proxy.</span></span>

<span data-ttu-id="06ca8-212">Чтобы выполнить действия ниже, необходимо быть участником роли глобального администратора в рамках учетной записи Azure Active Directory вашей организации.</span><span class="sxs-lookup"><span data-stu-id="06ca8-212">To perform the following steps, you need to be a member of the Global Administrator Role in your organization's Azure Active Directory account.</span></span>

1. <span data-ttu-id="06ca8-213">Войдите на [портал Azure](https://manage.windowsazure.com) и найдите свой клиент Azure AD.</span><span class="sxs-lookup"><span data-stu-id="06ca8-213">Sign in to the [Azure portal](https://manage.windowsazure.com) and find your Azure AD tenant.</span></span>
2. <span data-ttu-id="06ca8-214">Щелкните **Приложения**, а затем — **Добавить**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-214">Click **Applications**, and then click **Add**.</span></span>
3. <span data-ttu-id="06ca8-215">Выберите **Публикация приложения, которое будет доступно за пределами вашей сети**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-215">Select **Publish an application that will be accessible from outside your network**.</span></span> <span data-ttu-id="06ca8-216">Если этот параметр не отображается, убедитесь, что в этом клиенте используется Azure AD уровня "Базовый" или "Премиум".</span><span class="sxs-lookup"><span data-stu-id="06ca8-216">If you don’t see this option, make sure that you have Azure AD Basic or Premium set up in the tenant.</span></span>
4. <span data-ttu-id="06ca8-217">Укажите значения следующих параметров.</span><span class="sxs-lookup"><span data-stu-id="06ca8-217">Complete each of the options as follows:</span></span>
 * <span data-ttu-id="06ca8-218">**Имя**: любое значение, например **SharePoint**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-218">**Name**: Use any value that you want--for example, **SharePoint**.</span></span>
 * <span data-ttu-id="06ca8-219">**Внутренний URL-адрес**: это URL-адрес внутреннего сайта SharePoint, например **https://SharePoint/**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-219">**Internal URL**: This is the URL of the SharePoint site internally, such as **https://SharePoint/**.</span></span> <span data-ttu-id="06ca8-220">В этом примере обязательно используйте **http**s.</span><span class="sxs-lookup"><span data-stu-id="06ca8-220">In this example, make sure to use **https**.</span></span>
 * <span data-ttu-id="06ca8-221">**Метод предварительной проверки подлинности:** выберите **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-221">**Preauthentication Method**: Select **Azure Active Directory**.</span></span>

  ![Параметры для добавления приложения](./media/application-proxy-remote-sharepoint/remote-sharepoint-add-application.png)

5. <span data-ttu-id="06ca8-223">После публикации приложения перейдите на вкладку **Настройка**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-223">After the app is published, click the **Configure** tab.</span></span>
6. <span data-ttu-id="06ca8-224">Прокрутите к параметру **Перевод веб-страниц в заголовках**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-224">Scroll down to the option **Translate URL in Headers**.</span></span> <span data-ttu-id="06ca8-225">Значение по умолчанию — **Да**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-225">The default value is **YES**.</span></span> <span data-ttu-id="06ca8-226">Измените его на **Нет**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-226">Change it to **NO**.</span></span>

 <span data-ttu-id="06ca8-227">SharePoint использует значение _заголовка узла_ для поиска сайта.</span><span class="sxs-lookup"><span data-stu-id="06ca8-227">SharePoint uses the _Host Header_ value to look up the site.</span></span> <span data-ttu-id="06ca8-228">Он также создает ссылки на его основе.</span><span class="sxs-lookup"><span data-stu-id="06ca8-228">It also generates links based on this value.</span></span> <span data-ttu-id="06ca8-229">Таким образом, любая ссылка, которую создает SharePoint, представляет собой опубликованный URL-адрес, правильно настроенный для использования внешнего URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="06ca8-229">The net effect is to make sure that any link that SharePoint generates is a published URL that is correctly set to use the external URL.</span></span> <span data-ttu-id="06ca8-230">Если выбрать значение **Да**, соединитель будет перенаправлять запрос к серверному приложению.</span><span class="sxs-lookup"><span data-stu-id="06ca8-230">Setting the value to **YES** also enables the connector to forward the request to the back-end application.</span></span> <span data-ttu-id="06ca8-231">Но если выбрать значение **Нет**, соединитель не будет отправлять имя внутреннего узла.</span><span class="sxs-lookup"><span data-stu-id="06ca8-231">However, setting the value to **NO** means that the connector will not send the internal host name.</span></span> <span data-ttu-id="06ca8-232">Вместо этого он отправляет заголовок узла в качестве опубликованного URL-адреса в серверное приложение.</span><span class="sxs-lookup"><span data-stu-id="06ca8-232">Instead, the connector sends the host header as the published URL to the back-end application.</span></span>

 <span data-ttu-id="06ca8-233">Кроме того, чтобы SharePoint принимал этот URL-адрес, необходимо выполнить еще одну настойку на сервере SharePoint.</span><span class="sxs-lookup"><span data-stu-id="06ca8-233">Also, to ensure that SharePoint accepts this URL, you need to complete one more configuration on the SharePoint server.</span></span> <span data-ttu-id="06ca8-234">Это будет сделано в следующем разделе.</span><span class="sxs-lookup"><span data-stu-id="06ca8-234">You'll do that in the next section.</span></span>

7. <span data-ttu-id="06ca8-235">Задайте для параметра **Метод внутренней проверки подлинности** значение **Встроенная проверка подлинности Windows**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-235">Change **Internal Authentication Method** to **Integrated Windows Authentication**.</span></span> <span data-ttu-id="06ca8-236">Если клиент Azure AD использует различные имена участников-пользователей в облачной и локальной средах, обновите также параметр **Делегированная идентификация для входа**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-236">If your Azure AD tenant uses a UPN in the cloud that's different from the UPN on-premises, remember to update **Delegated Login Identity** as well.</span></span>
8. <span data-ttu-id="06ca8-237">Задайте для параметра **Внутреннее имя субъекта-службы приложения** значение, заданное ранее.</span><span class="sxs-lookup"><span data-stu-id="06ca8-237">Set **Internal Application SPN** to the value that you set earlier.</span></span> <span data-ttu-id="06ca8-238">Например, **http/sharepoint.demo.o365identity.us**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-238">For example, use **http/sharepoint.demo.o365identity.us**.</span></span>
9. <span data-ttu-id="06ca8-239">Назначьте приложение целевым пользователям.</span><span class="sxs-lookup"><span data-stu-id="06ca8-239">Assign the application to your target users.</span></span>

<span data-ttu-id="06ca8-240">Приложение должно выглядеть, как в приведенном ниже примере.</span><span class="sxs-lookup"><span data-stu-id="06ca8-240">Your application should look similar to the following example:</span></span>

  ![Завершенное приложение](./media/application-proxy-remote-sharepoint/remote-sharepoint-internal-application-spn.png)

## <a name="step-3-ensure-that-sharepoint-knows-about-the-external-url"></a><span data-ttu-id="06ca8-242">Шаг 3. Настройка сопоставлений, чтобы служба SharePoint знала о внешнем URL-адресе</span><span class="sxs-lookup"><span data-stu-id="06ca8-242">Step 3: Ensure that SharePoint knows about the external URL</span></span>

<span data-ttu-id="06ca8-243">Последний шаг — сделать так, чтобы служба SharePoint могла найти сайт по внешнему URL-адресу, а также могла обрабатывать ссылки на основе этого адреса.</span><span class="sxs-lookup"><span data-stu-id="06ca8-243">Your last step to ensure that SharePoint can find the site based on the external URL, so that it will render links based on that external URL.</span></span> <span data-ttu-id="06ca8-244">Для этого необходимо настроить сопоставления альтернативного доступа для сайта SharePoint.</span><span class="sxs-lookup"><span data-stu-id="06ca8-244">You do this by configuring alternate access mappings for the SharePoint site.</span></span>

1. <span data-ttu-id="06ca8-245">Откройте сайт **центра администрирования SharePoint 2013**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-245">Open the **SharePoint 2013 Central Administration** site.</span></span>
2. <span data-ttu-id="06ca8-246">В разделе **Параметры системы** выберите **Настройка сопоставлений альтернативного доступа**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-246">Under **System Settings**, select **Configure Alternate Access Mappings**.</span></span>

 <span data-ttu-id="06ca8-247">Откроется окно **Сопоставления для альтернативного доступа**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-247">This opens the **Alternate Access Mappings** box.</span></span>

  ![Окно "Сопоставления для альтернативного доступа"](./media/application-proxy-remote-sharepoint/remote-sharepoint-alternate-access1.png)

3. <span data-ttu-id="06ca8-249">В раскрывающемся списке рядом с надписью **Alternative Access Mapping Collections** (Коллекции сопоставлений альтернативного доступа) выберите **Change Alternative Access Mapping Collection** (Изменить коллекцию сопоставлений альтернативного доступа).</span><span class="sxs-lookup"><span data-stu-id="06ca8-249">In the drop-down list beside **Alternate Access Mapping Collection**, select **Change Alternate Access Mapping Collection**.</span></span>
4. <span data-ttu-id="06ca8-250">Выберите сайт, например **SharePoint — 80**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-250">Select your site--for example, **SharePoint - 80**.</span></span>

  ![Выбор сайта](./media/application-proxy-remote-sharepoint/remote-sharepoint-alternate-access2.png)

5. <span data-ttu-id="06ca8-252">Вы можете добавить опубликованный URL-адрес как внутренний URL-адрес или общедоступный URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="06ca8-252">You can choose to add the published URL as either an internal URL or a public URL.</span></span> <span data-ttu-id="06ca8-253">В этом примере используется общедоступный URL-адрес в пределах экстрасети.</span><span class="sxs-lookup"><span data-stu-id="06ca8-253">This example uses a public URL as the extranet.</span></span>
6. <span data-ttu-id="06ca8-254">Щелкните **Изменить общедоступные URL-адреса** в пути **экстрасети**, а затем введите путь опубликованного приложения, как на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="06ca8-254">Click **Edit Public URLs** in the **Extranet** path, and then enter the path for the published application, as in the previous step.</span></span> <span data-ttu-id="06ca8-255">Например, **https://sharepoint-iddemo.msappproxy.net**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-255">For example, enter **https://sharepoint-iddemo.msappproxy.net**.</span></span>

  ![Ввод пути](./media/application-proxy-remote-sharepoint/remote-sharepoint-alternate-access3.png)

7. <span data-ttu-id="06ca8-257">Щелкните **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="06ca8-257">Click **Save**.</span></span>

 <span data-ttu-id="06ca8-258">Теперь вы можете получать внешний доступ к сайту SharePoint через прокси приложения Azure AD.</span><span class="sxs-lookup"><span data-stu-id="06ca8-258">You can now access the SharePoint site externally via Azure AD Application Proxy.</span></span>

## <a name="next-steps"></a><span data-ttu-id="06ca8-259">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="06ca8-259">Next steps</span></span>

- [<span data-ttu-id="06ca8-260">Как обеспечить безопасный удаленный доступ к локальным приложениям</span><span class="sxs-lookup"><span data-stu-id="06ca8-260">How to provide secure remote access to on-premises applications</span></span>](active-directory-application-proxy-get-started.md)
- [<span data-ttu-id="06ca8-261">Сведения о соединителях прокси приложения Azure AD</span><span class="sxs-lookup"><span data-stu-id="06ca8-261">Understand Azure AD Application Proxy connectors</span></span>](application-proxy-understand-connectors.md)
- [<span data-ttu-id="06ca8-262">Публикация SharePoint 2016 и Office Online Server с помощью прокси приложения Azure AD</span><span class="sxs-lookup"><span data-stu-id="06ca8-262">Publishing SharePoint 2016 and Office Online Server with Azure AD Application Proxy</span></span>](https://blogs.technet.microsoft.com/dawiese/2016/06/09/publishing-sharepoint-2016-and-office-online-server-with-azure-ad-application-proxy/)

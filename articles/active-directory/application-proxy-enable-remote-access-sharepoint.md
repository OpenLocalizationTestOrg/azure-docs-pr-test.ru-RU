---
title: "Настройка удаленного доступа к SharePoint с помощью прокси приложения Azure AD | Документы Майкрософт"
description: "Рассматриваются основные сведения об интеграции локального сервера SharePoint с прокси приложения Azure AD."
services: active-directory
documentationcenter: 
author: daveba
manager: mtillman
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 09/06/2017
ms.author: daveba
ms.reviewer: harshja
ms.custom: it-pro
ms.openlocfilehash: c6a1b82b82dc89378533e375bd8a5d4868ae5308
ms.sourcegitcommit: 3cdc82a5561abe564c318bd12986df63fc980a5a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/05/2018
---
# <a name="enable-remote-access-to-sharepoint-with-azure-ad-application-proxy"></a>Настройка удаленного доступа к SharePoint с помощью прокси приложения Azure AD

В этой статье описывается интеграция локального сервера SharePoint с прокси приложения Azure Active Directory (Azure AD).

Чтобы включить удаленный доступ к SharePoint с помощью прокси приложения Azure AD, следуйте пошаговым инструкциям в разделах этой статьи.

## <a name="prerequisites"></a>Технические условия

В этой статье предполагается, что в вашей среде уже есть SharePoint 2013 или более поздней версии. Кроме того, необходимо выполнить следующие предварительные требования.

* SharePoint имеет встроенную поддержку Kerberos. Поэтому можно предположить, что пользователи, которые получают удаленный доступ к внутренним сайтам через прокси приложения Azure AD, пользуются преимуществами единого входа.

* В этом сценарии предусмотрено внесение некоторых изменений в конфигурацию на сервере SharePoint. Мы рекомендуем использовать промежуточную среду. Так вы сначала внесете изменения на промежуточном сервере, что упростит цикл тестирования при переходе на рабочую среду.

* Нам требуется SSL для опубликованного URL-адреса. Вам необходимо включить SSL на внутреннем сайте, чтобы обеспечить надлежащую отправку и сопоставление ссылок. Если вы еще не настроили SSL, см. инструкции в разделе [Настройка SSL для SharePoint 2013](https://blogs.msdn.microsoft.com/fabdulwahab/2013/01/20/configure-ssl-for-sharepoint-2013). Кроме того, убедитесь, что соединитель компьютера доверяет выдаваемому сертификату. (Это необязательно должен быть открыто выданный сертификат.)

## <a name="step-1-set-up-single-sign-on-to-sharepoint"></a>Шаг 1. Настройка единого входа в SharePoint

Для локальных приложений, использующих проверку подлинности Windows, единый вход можно обеспечить с помощью протокола проверки подлинности Kerberos и функции, называемой ограниченным делегированием Kerberos (KCD). Если функция KCD настроена, она дает возможность соединителю прокси приложения получить билет и маркер Windows для пользователя, даже если тот не выполнил вход в Windows напрямую. Дополнительные сведения об ограниченном делегировании Kerberos см. в [этой статье](https://technet.microsoft.com/library/jj553400.aspx).

Чтобы настроить KCD для сервера, выполните процедуры, описанные в следующих разделах.

### <a name="ensure-that-sharepoint-is-running-under-a-service-account"></a>Проверка того, что сервер SharePoint запущен с использованием учетной записи службы

Сначала проверьте, что сервер SharePoint запущен с использованием определенной учетной записи службы, а не учетной записи локальной системы, локальной службы или сетевой службы. Это нужно сделать, чтобы вы могли присоединить имена субъектов-служб к действительной учетной записи. Kerberos идентифицирует различные службы по этим именам. Учетная запись потребуется позже, чтобы настроить ограниченное делегирование Kerberos.

> [!NOTE]
Вам потребуется ранее созданная учетная запись AD для службы. Мы рекомендуем настроить автоматическую смену паролей. Описание полной процедуры и сведения по устранению неполадок см. в статье [Настройка автоматической смены паролей в SharePoint 2013](https://technet.microsoft.com/library/ff724280.aspx).

Чтобы убедиться, что сайты запущены с использованием определенной учетной записи службы, сделайте следующее.

1. Откройте сайт **центра администрирования SharePoint 2013**.
2. Щелкните **Безопасность** и выберите **Настройка учетных записей служб**.
3. Выберите **Пул веб-приложений — SharePoint — 80**. Параметры могут немного отличаться в зависимости от имени пула веб-приложений или при использовании SSL по умолчанию.

  ![Параметры для настройки учетной записи службы](./media/application-proxy-remote-sharepoint/service-web-application.png)

4. Если в поле **Выберите учетную запись для этого компонента** выбран вариант **Локальная служба** или **Сетевая служба**, необходимо создать учетную запись. В противном случае все готово, и вы можете переходить к следующему шагу.
5. Выберите **Регистрация новой управляемой учетной записи**. Как только учетная запись будет создана, прежде чем ее использовать, необходимо задать **пул веб-приложений**.

### <a name="configure-sharepoint-for-kerberos"></a>Настройка SharePoint для Kerberos

Вы применяете ограниченное делегирование Kerberos для выполнения единого входа на сервер SharePoint.

Чтобы настроить сайт SharePoint для проверки подлинности Kerberos:

1. Откройте сайт **центра администрирования SharePoint 2013**.
2. Щелкните **Управление приложениями**, выберите **Управление веб-приложениями**, а затем — свой сайт SharePoint. В данном примере выберите **SharePoint — 80**.

  ![Выбор сайта SharePoint](./media/application-proxy-remote-sharepoint/manage-web-applications.png)

3. На панели инструментов щелкните **Поставщики проверки подлинности**.
4. В окне **Поставщики проверки подлинности** щелкните **Default Zone** (Зона по умолчанию), чтобы просмотреть параметры.
5. В диалоговом окне **Изменение параметров проверки подлинности** прокрутите вниз, пока не увидите пункт **Типы проверки подлинности на основе утверждений**. Убедитесь, что выбраны варианты **Включить проверку подлинности Windows** и **Встроенная проверка подлинности Windows**.
6. В раскрывающемся списке для поля "Встроенная проверка подлинности Windows" нужно выбрать значение **Согласование (Kerberos)**.

  ![Диалоговое окно "Изменение параметров проверки подлинности"](./media/application-proxy-remote-sharepoint/service-edit-authentication.png)

7. В самом низу окна **Изменение параметров проверки подлинности** нажмите кнопку **Сохранить**.

### <a name="set-a-service-principal-name-for-the-sharepoint-service-account"></a>Задание имени субъекта-службы для учетной записи службы SharePoint

Прежде чем настраивать ограниченное делегирование Kerberos, необходимо определить службу SharePoint, запущенную в качестве настроенной учетной записи службы. Определите службу, задав имя субъекта-службы. Дополнительные сведения об именах субъектов-служб см. в [этом разделе](https://technet.microsoft.com/library/cc961723.aspx).

Имя субъекта-службы выглядит следующим образом:

```
<service class>/<host>:<port>
```

В формате SPN:

* _service class_ — это уникальное имя службы. Для SharePoint используется **HTTP**.

* _host_ — это полное доменное имя или NetBIOS-имя узла, на котором запущена служба. Для сайта SharePoint это может быть URL-адрес сайта в зависимости от используемой версии IIS.

* _port_ указывать необязательно.

Полное доменное имя сервера SharePoint может выглядеть так:

```
sharepoint.demo.o365identity.us
```

В таком случае имя субъекта-службы будет иметь следующий вид:

```
HTTP/sharepoint.demo.o365identity.us demo
```

Кроме того, может потребоваться задать имена субъектов-служб для определенных сайтов на сервере. Дополнительные сведения см. в статье [Настройка проверки подлинности Kerberos](https://technet.microsoft.com/library/cc263449(v=office.12).aspx). Уделите особое внимание разделу "Создание имен субъектов-служб для веб-приложений, использующих проверку подлинности Kerberos".

Самый простой способ сделать это — использовать имена субъектов-служб, которые уже существуют для вашего сайта. Скопируйте эти имена субъектов-служб для регистрации в учетной записи службы. Для этого:

1. Перейдите к сайту с другого компьютера, используя имя субъекта-службы.
 При этом соответствующий набор билетов Kerberos кэшируется на этом компьютере. Эти билеты содержат имя субъекта-службы целевого сайта, на который вы перешли.

2. Можно извлечь имя субъекта-службы этого сайта, используя средство [Klist](http://web.mit.edu/kerberos/krb5-devel/doc/user/user_commands/klist.html). В командном окне, запущенном в том же контексте, что и пользователь, который перешел на сайт в браузере, выполните следующую команду:
```
Klist
```
Klist возвращает набор целевых имен субъектов-служб. В этом примере выделено необходимое нам имя субъекта-службы.

  ![Пример результатов Klist](./media/application-proxy-remote-sharepoint/remote-sharepoint-target-service.png)

4. Теперь, когда у вас есть имя субъекта-службы, его необходимо правильно настроить для учетной записи службы, заданной для веб-приложения ранее. Выполните указанную ниже команду из командной строки с правами администратора домена.

 ```
 setspn -S http/sharepoint.demo.o365identity.us demo\sp_svc
 ```

 Эта команда задает имя субъекта-службы для учетной записи службы SharePoint _demo\sp_svc_.

 Замените _http/sharepoint.demo.o365identity.us_ именем субъекта-службы для сервера, а _demo\sp_svc_ — учетной записью службы в вашей среде. Команда setspn выполняет поиск имени субъекта-службы, прежде чем его добавить. В этом случае может появиться ошибка **Повторяющееся значение имени субъекта-службы**. Если вы видите эту ошибку, убедитесь, что это значение связано с нужной учетной записью службы.

Чтобы убедиться, что имя субъекта-службы добавлено, выполните команду setspn с параметром -l. Дополнительные сведения о команде setspn см. в [этой статье](https://technet.microsoft.com/library/cc731241.aspx).

### <a name="ensure-that-the-connector-is-set-as-a-trusted-delegate-to-sharepoint"></a>Настройка доверенного соединителя для делегирования для SharePoint

Настройте ограниченное делегирование Kerberos, чтобы служба прокси приложения Azure AD могла делегировать удостоверения пользователей для службы SharePoint. Для этого настройте для соединителя прокси приложения возможность получать билеты Kerberos для пользователей, которые прошли проверку подлинности в Azure AD. Затем этот сервер передает контекст в целевое приложение (SharePoint в нашем случае).

Чтобы настроить ограниченное делегирование Kerberos, выполните приведенные далее действия для каждого компьютера соединителя.

1. Войдите в контроллер домена от имени администратора домена, а затем перейдите к компоненту **Пользователи и компьютеры Active Directory**.
2. Найдите компьютер, на котором запущен соединитель. В этом примере это тот же сервер SharePoint.
3. Дважды щелкните имя компьютера, а затем перейдите на вкладку **Делегирование**.
4. Установите переключатель **Trust this computer for delegation to the specified services only** (Доверять этому компьютеру для делегирования только указанным службам), а затем — **Use any authentication protocol** (Использовать любой протокол проверки подлинности).

  ![Параметры делегирования](./media/application-proxy-remote-sharepoint/delegation-box.png)

5. Нажмите кнопку **Добавить**, щелкните **Пользователи или компьютеры** и найдите учетную запись службы.

  ![Добавление имени участника-службы для учетной записи службы](./media/application-proxy-remote-sharepoint/users-computers.png)

6. В списке имен участников-служб выберите того, который вы создали ранее для учетной записи службы.
7. Последовательно выберите **ОК**. Нажмите кнопку **ОК** еще раз, чтобы сохранить изменения.

## <a name="step-2-enable-remote-access-to-sharepoint"></a>Шаг 2. Включение удаленного доступа к SharePoint

Теперь, когда вы настроили SharePoint для Kerberos и функцию KCD, вы можете опубликовать ферму SharePoint для удаленного доступа через прокси приложения Azure AD.

1. Опубликуйте сайт SharePoint со следующими параметрами. Пошаговые инструкции см. в статье [Публикация приложений с помощью прокси приложения Azure AD](application-proxy-publish-azure-portal.md). 
   - **Внутренний URL-адрес**: URL-адрес внутреннего сайта SharePoint (например, **https://SharePoint/**). В этом примере обязательно используйте **https**.
   - **Метод предварительной проверки подлинности**: Azure Active Directory.
   - **Перевод веб-страниц в заголовках**: выберите значение "Нет".

   >[!TIP]
   >SharePoint использует значение _заголовка узла_ для поиска сайта. Он также создает ссылки на его основе. Таким образом, любая ссылка, созданная в SharePoint, представляет собой опубликованный URL-адрес, правильно настроенный для использования внешнего URL-адреса. Если выбрать значение **Да**, соединитель будет перенаправлять запрос к серверному приложению. Но если выбрать значение **Нет**, соединитель не будет отправлять имя внутреннего узла. Вместо этого он отправляет заголовок узла в качестве опубликованного URL-адреса в серверное приложение.

   ![Публикация SharePoint в качестве приложения](./media/application-proxy-remote-sharepoint/publish-app.png)

2. После публикации приложения необходимо настроить параметры единого входа с помощью следующих действий:

   1. На странице приложения на портале выберите **Единый вход**.
   2. Для единого входа выберите режим **Встроенная проверка подлинности Windows**.
   3. Задайте для параметра "Внутреннее имя субъекта-службы приложения" значение, заданное ранее. Например, **http/sharepoint.demo.o365identity.us**.

   ![Настройка встроенной проверки подлинности Windows для единого входа](./media/application-proxy-remote-sharepoint/configure-iwa.png)

3. Чтобы завершить настройку приложения, перейдите к разделу **Пользователи и группы** и назначьте доступ к этому приложению необходимым пользователям. 

## <a name="step-3-ensure-that-sharepoint-knows-about-the-external-url"></a>Шаг 3. Настройка сопоставлений, чтобы служба SharePoint знала о внешнем URL-адресе

Последний шаг — сделать так, чтобы служба SharePoint могла найти сайт по внешнему URL-адресу, а также могла обрабатывать ссылки на основе этого адреса. Для этого необходимо настроить сопоставления альтернативного доступа для сайта SharePoint.

1. Откройте сайт **центра администрирования SharePoint 2013**.
2. В разделе **Параметры системы** выберите **Настройка сопоставлений альтернативного доступа**. Откроется окно "Сопоставления для альтернативного доступа".

  ![Окно "Сопоставления для альтернативного доступа"](./media/application-proxy-remote-sharepoint/alternate-access1.png)

3. В раскрывающемся списке рядом с надписью **Alternative Access Mapping Collections** (Коллекции сопоставлений альтернативного доступа) выберите **Change Alternative Access Mapping Collection** (Изменить коллекцию сопоставлений альтернативного доступа).
4. Выберите сайт, например **SharePoint — 80**.
5. Вы можете добавить опубликованный URL-адрес как внутренний URL-адрес или общедоступный URL-адрес. В этом примере используется общедоступный URL-адрес в пределах экстрасети.
6. Щелкните **Изменить общедоступные URL-адреса** в пути **экстрасети**, а затем введите внешний URL-адрес, созданный при публикации приложения. Например, **https://sharepoint-iddemo.msappproxy.net**.

  ![Ввод пути](./media/application-proxy-remote-sharepoint/alternate-access3.png)

7. Выберите команду **Сохранить**.

Теперь вы можете получать внешний доступ к сайту SharePoint через прокси приложения Azure AD.

## <a name="next-steps"></a>Дальнейшие действия

- [Работа с пользовательскими доменами в прокси приложения Azure AD](active-directory-application-proxy-custom-domains.md)
- [Сведения о соединителях прокси приложения Azure AD](application-proxy-understand-connectors.md)


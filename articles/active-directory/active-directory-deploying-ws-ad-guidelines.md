---
title: "Рекомендации по развертыванию Windows Server Active Directory на виртуальных машинах Azure | Документация Майкрософт"
description: "Если вы знаете, как развернуть доменные службы и службы федерации AD в локальной среде, изучите принцип их работы на виртуальных машинах Azure."
services: active-directory
documentationcenter: 
author: femila
manager: mtillman
editor: 
ms.assetid: 04df4c46-e6b6-4754-960a-57b823d617fa
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 07/26/2017
ms.author: femila
ms.openlocfilehash: 2c9b072551b467785dbb4aae02492ffae6cdb787
ms.sourcegitcommit: e266df9f97d04acfc4a843770fadfd8edf4fa2b7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/11/2017
---
# <a name="guidelines-for-deploying-windows-server-active-directory-on-azure-virtual-machines"></a>Рекомендации по развертыванию Windows Server Active Directory на виртуальных машинах Azure
В этой статье описываются важные различия локального развертывания доменных служб Windows Server Active Directory (AD DS) и служб федерации Active Directory (AD FS) по сравнению с их развертыванием на виртуальных машинах Microsoft Azure.

## <a name="scope-and-audience"></a>Область и аудитория
Эта статья предназначена для тех, у кого уже есть опыт локального развертывания Active Directory. Здесь описываются отличия развертывания Active Directory на виртуальных машинах Microsoft Azure и в виртуальных сетях Azure от традиционного локального развертывания. Виртуальные машины и виртуальные сети Azure предоставляются организациям в составе инфраструктуры как услуги (IaaS), предназначенной для использования вычислительных ресурсов в облаке.

Если у вас нет опыта развертывания AD, см. разделы [AD DS Deployment Guide](https://technet.microsoft.com/library/cc753963) (Руководство по развертыванию AD DS) или [Планирование развертывания служб федерации Active Directory](https://technet.microsoft.com/library/dn151324.aspx) соответственно.

В этой статье предполагается, что читатель знаком со следующими концепциями:

* развертывание служб Windows Server AD DS и управление ими;
* развертывание и настройка DNS для поддержки инфраструктуры Windows Server AD DS;
* развертывание служб Windows Server AD FS и управление ими;
* развертывание и настройка приложений проверяющей стороны (веб-сайтов и веб-служб), которые могут использовать маркеры Windows Server AD FS, а также управление ими;
* настройка виртуальной машины, виртуальных дисков и виртуальных сетей, а также с другими общими концепциями использования виртуальных машин.

В этой статье приводятся требования для гибридного развертывания, при котором службы Windows Server AD DS или AD FS развертываются частично локально и частично на виртуальных машинах Azure. Сначала описываются важные различия между запуском служб AD DS и AD FS Windows Server на виртуальных машинах Azure и их запуском в локальной сети, а также рассматриваются важные моменты, которые влияют на проектирование и развертывание системы. В остальной части предоставляются более подробные рекомендации по принятию решений на каждом важном этапе и по применению рекомендаций в различных сценариях развертывания.

Эта статья не охватывает обсуждение конфигурации [Azure Active Directory](http://azure.microsoft.com/services/active-directory/), службы на основе интерфейса REST, которая предоставляет возможности для управления удостоверениями и контроля доступом в облачных приложениях. Тем не менее Azure AD и Windows Server AD DS предназначены для совместной работы с целью предоставления решения по управлению удостоверениями и доступом для современных гибридных ИТ-сред и приложений. Чтобы понять, чем отличаются Windows Server AD DS и Azure AD, а также связь между ними, нужно учесть следующее:

1. Windows Server AD DS можно запускать в облаке на виртуальных машинах Azure, если вы используете Azure, чтобы расширить локальный центр обработки данных для работы в облаке.
2. Azure AD можно использовать, чтобы предоставить пользователям возможность единого входа в приложения типа "Программное обеспечение как услуга" (SaaS). Эта технология используется, например, в Microsoft Office 365, а также в приложениях, работающих на платформе Azure и других облачных платформах.
3. Вы также можете настроить Azure AD (ее службу контроля доступа), чтобы позволить пользователям входить в облачные и локальные приложения, используя удостоверения Facebook, Google, Майкрософт и других поставщиков удостоверений.

Дополнительные сведения об этих различиях см. в статье об [удостоверениях Azure](fundamentals-identity.md).

## <a name="related-resources"></a>Связанные ресурсы
Вы можете скачать и запустить средство [оценки готовности виртуальной машины Azure](https://www.microsoft.com/download/details.aspx?id=40898). Этот инструмент оценки автоматически проверит локальную среду и создаст настраиваемый отчет на основе рекомендаций из этого руководства, чтобы помочь вам перенести свою среду в Azure.

Рекомендуем сначала изучить руководства, рекомендации и видеоролики, охватывающие следующие темы:

* [настройка виртуальной сети только для облака на портале Azure](../virtual-network/virtual-networks-create-vnet-arm-pportal.md)
* [настройка VPN типа "cеть-сеть" на портале Azure](../vpn-gateway/vpn-gateway-site-to-site-create.md)
* [Установка нового леса Active Directory в виртуальной сети Azure](active-directory-new-forest-virtual-machine.md)
* [установка реплики контроллера домена Active Directory в Azure;](active-directory-install-replica-active-directory-domain-controller.md)
* [Microsoft Azure IaaS для профессионалов в сфере IT. (01) Основная информация о виртуальных машинах](https://channel9.msdn.com/Series/Windows-Azure-IT-Pro-IaaS/01)
* [Microsoft Azure IaaS для профессионалов в сфере IT. (05) Создание виртуальных сетей и подключений между организациями](https://channel9.msdn.com/Series/Windows-Azure-IT-Pro-IaaS/05)

## <a name="introduction"></a>Общие сведения
Основные требования в отношении развертывания Windows Server Active Directory на виртуальных машинах Azure мало отличаются от требований для локального развертывания этой службы на виртуальных машинах (и в некоторой степени на физических компьютерах). Например, при использовании Windows Server AD DS, если контроллеры домена, развертываемые на виртуальных машинах Azure, являются репликами в существующем локальном корпоративном домене или лесу, то развертывание Azure можно в основном проводить аналогично этому процессу для дополнительного сайта Windows Server Active Directory. То есть необходимо определить подсети в Windows Server AD DS, создать сайт, связать с ним подсети, а их связать с другими сайтами с помощью соответствующих ссылок. Но существует несколько различий, общих для всех развертываний Azure, и несколько различий, которые зависят от выбранного сценария развертывания. Ниже описываются два основных различия.

### <a name="azure-virtual-machines-may-need-connectivity-to-the-on-premises-corporate-network"></a>Необходимость подключения виртуальных машин Azure к локальной корпоративной сети
Чтобы подключить виртуальные машины Azure к локальной корпоративной сети, нужна виртуальная сеть Azure с компонентом VPN типа "сеть-сеть" или "точка-сеть", с помощью которого можно легко установить подключение между виртуальными машинами Azure и локальными компьютерами. При помощи этого компонента VPN можно также обеспечить доступ к домену Windows Server Active Directory, чьи контроллеры размещены только на виртуальных машинах Azure, для компьютеров-членов домена в локальной сети. Следует отметить, что, если VPN выйдет из строя, произойдет сбой проверки подлинности и других операций, которые зависят от работы Windows Server Active Directory. В этом случае пользователи смогут входить в систему, используя кэшированные учетные данные, но все одноранговые проверки подлинности и проверки подлинности клиента на сервере, для которых еще не выданы билеты или билеты которых устарели, будут завершаться сбоем.

См. раздел [Виртуальная сеть](http://azure.microsoft.com/documentation/services/virtual-network/), где можно найти демонстрационные видео, а также список пошаговых учебников, включая статью [Создание виртуальной сети с подключением типа "сеть — сеть" с помощью портала Azure](../vpn-gateway/vpn-gateway-site-to-site-create.md).

> [!NOTE]
> Вы также можете развернуть Windows Server Active Directory в виртуальной сети Azure, которая не подключена к локальной сети. В приведенных здесь рекомендациях подразумевается, что используется виртуальная сеть Azure, так как она предоставляет возможности IP-адресации, необходимые для работы Windows Server.
> 
> 

### <a name="static-ip-addresses-must-be-configured-with-azure-powershell"></a>Необходимость настройки статических IP-адресов в Azure PowerShell
Динамические адреса выделяются по умолчанию, но вам нужно назначить статический IP-адрес, выполнив командлет AzureStaticVNetIP. Он устанавливает статический IP-адрес, который будет сохраняться при восстановлении работоспособности службы, а также при завершении работы и перезагрузке виртуальной машины. Дополнительные сведения см. в записи блога [Static internal IP address for virtual machines](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/) (Настройка статического внутреннего IP-адреса для виртуальных машин).

## <a name="BKMK_Glossary"></a>Термины и определения
Ниже приведен неполный список терминов различных технологий Azure, которые будут упоминаться в этой статье.

* **Виртуальные машины Azure**— предложение IaaS в Azure, позволяющее клиентам развертывать виртуальные машины, способные справиться с практически любой стандартной серверной рабочей нагрузкой в локальной сети.
* **Виртуальная сеть Azure**— сетевая служба в Azure, благодаря которой клиенты могут создавать виртуальные сети и управлять ими в Azure, а также безопасно связывать их со своей локальной сетевой инфраструктурой с помощью VPN.
* **Виртуальный IP-адрес**— IP-адрес для Интернета, который не связан с компьютером или сетевой картой. Виртуальный IP-адрес назначается облачным службам для приема сетевого трафика, который перенаправляется в виртуальную машину Azure. Этот адрес является свойством облачной службы, в которую может входить одна или несколько виртуальных машин Azure. Кроме того, обратите внимание, что в виртуальной сети Azure может работать одна или несколько облачных служб. Виртуальные IP-адреса обеспечивают системные возможности балансировки рабочей нагрузки.
* **Динамический IP-адрес**— это IP-адрес только для внутреннего использования. Его следует настроить, как и статический IP-адрес (выполнив командлет Set-AzureStaticVNetIP), для виртуальных машин c ролями сервера контроллера домена или DNS.
* **Восстановление работоспособности службы**— процесс, при котором Azure автоматически возвращает службу в рабочее состояние, если обнаружит, что произошел сбой. Это одна из функций Azure по обеспечению поддержки доступности и устойчивости. Маловероятно, но результат восстановления работоспособности службы для контроллера домена, работающего на виртуальной машине, будет таким же, как при незапланированной перезагрузке, но этот инцидент влечет несколько побочных явлений:
  
  * изменится виртуальный сетевой адаптер виртуальной машины;
  * изменится MAC-адрес виртуального сетевого адаптера;
  * изменится идентификатор процессора и ЦП виртуальной машины;
  * IP-конфигурация виртуального сетевого адаптера не изменится, если виртуальная машина подключена к виртуальной сети и у нее статический IP-адрес.
  
  На Windows Server Active Directory не повлияют эти обстоятельства, так как ее работа не зависит от MAC-адреса, а также идентификатора процессора или ЦП. Мы рекомендуем выполнять все развертывания Windows Server Active Directory в виртуальной сети Azure, как описано выше.

## <a name="is-it-safe-to-virtualize-windows-server-active-directory-domain-controllers"></a>Безопасно ли виртуализировать контроллеры домена Windows Server Active Directory?
Для развертывания контроллеров домена Windows Server Active Directory на виртуальных машинах Azure действуют те же рекомендации, что и для локального запуска контроллеров домена на виртуальной машине. Запуск виртуализированных контроллеров домена безопасен, если выполнены рекомендации по их резервному копированию и восстановлению. Дополнительные сведения об ограничениях запуска виртуализированных контроллеров домена и рекомендации по нему см. в разделе [Работа контроллеров домена в среде Hyper-V](https://technet.microsoft.com/library/dd363553).

Низкоуровневые оболочки предоставляют и упрощают технологии, использование которых может создавать проблемы во многих распределенных системах, в том числе в Windows Server Active Directory. Например, на физическом сервере можно клонировать диск или использовать неподдерживаемые методы для отката состояния сервера, в том числе использовать SAN и т. п., но сделать это на физическом сервере гораздо сложнее, чем восстановить виртуальную машину из моментального снимка в низкоуровневой оболочке. Azure предлагает функции, которые могут привести к подобному нежелательному состоянию. Например, не следует копировать VHD-файлы контроллеров домена вместо регулярного создания резервных копий, так как их восстановление может дать те же результаты, что и использование функций восстановления моментальных снимков.

Подобные откаты создают USN-пузыри (отличия номеров последовательного обновления), что может повлечь переход контроллеров домена в постоянное отклоняющееся состояние. Кроме того, могут возникнуть такие проблемы:

* наличие устаревших объектов;
* наличие несогласованных паролей;
* наличие несогласованных значений атрибутов;
* несоответствия в схеме при откате хозяина схемы.

Дополнительные сведения о влиянии на контроллеры домена см. в разделе об [USN и откате USN](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv.aspx#usn_and_usn_rollback).

Начиная с Windows Server 2012, в [AD DS предусмотрены дополнительные меры безопасности](https://technet.microsoft.com/library/hh831734.aspx). Эти меры безопасности помогают защитить виртуализированные контроллеры домена от возникновения вышеуказанных проблем при условии, что базовая платформа низкоуровневой оболочки поддерживает VM-GenerationID. Azure поддерживает VM-GenerationID, а это значит, что контроллеры доменов, которые работают под управлением Windows Server 2012 или более поздних версий на виртуальных машинах Azure, будут защищены дополнительными мерами безопасности.

> [!NOTE]
> Завершение работы и перезагрузку виртуальной машины, которая работает в роли контроллера домена в Azure, следует выполнять в операционной системе на виртуальной машине, а не с помощью команды **Завершение работы** на портале Azure. Сейчас завершение работы виртуальной машины на портале влечет отмену распределения соответствующих ресурсов. Преимущество такой виртуальной машины в том, что за ее использование не взимается плата, но при этом происходит сброс VM-GenerationID, что нежелательно для контроллера домена. При сбросе VM-GenerationID также сбрасывается invocationID базы данных AD DS, удаляется пул RID, а SYSVOL помечается как не заслуживающий доверия. Дополнительные сведения см. в разделах [Introduction to Active Directory Domain Services (AD DS) Virtualization](https://technet.microsoft.com/library/hh831734.aspx) (Знакомство с виртуализацией доменных служб Active Directory) и [Safely Virtualizing DFSR](http://blogs.technet.com/b/filecab/archive/2013/04/05/safely-virtualizing-dfsr.aspx) (Безопасная виртуализация DFSR).
> 
> 

## <a name="why-deploy-windows-server-ad-ds-on-azure-virtual-machines"></a>Почему стоит развертывать Windows Server AD DS на виртуальных машинах Azure?
Для развертывания на виртуальных машинах в Azure подходит много сценариев развертывания Windows Server AD DS. Например, предположим, что компании в Европе необходимо выполнять проверку подлинности пользователей в удаленном местоположении в Азии. Компания ранее не выполняла развертывание контроллеров домена Windows Server Active Directory в Азии из-за стоимости развертывания или ограниченного опыта управления серверами после развертывания. В результате запросы проверки подлинности из Азии обслуживают контроллеры домена в Европе, но неэффективно. В таком случае можно развернуть контроллер домена на виртуальной машине, для которой задана работа в центре обработки данных Azure в Азии. Присоединение этого контроллера домена к виртуальной сети Azure, подключенной напрямую к удаленному местоположению, улучшит производительность проверки подлинности.

Azure также хорошо подходит как замена дорогим объектам аварийного восстановления. Относительно недорогая цена размещения малого числа контроллеров домена и одной виртуальной сети в Azure — привлекательная альтернатива.

И наконец, возможно, вам необходимо будет развернуть в Azure сетевое приложение, такое как SharePoint, для работы которого нужна Windows Server Active Directory, но не нужна локальная сеть или корпоративная служба Windows Server Active Directory. В этом случае развертывание изолированного леса в Azure будет оптимальным решением в соответствии с требованиями сервера SharePoint. Опять же, поддерживается и развертывание сетевых приложений, для которых требуется подключение к локальной сети и корпоративной службе Active Directory.

> [!NOTE]
> Так как компонент VPN обеспечивает подключение 3-го уровня и связь между виртуальной сетью Azure и локальной сетью, он также может позволить серверам-членам домена в локальной сети использовать контроллеры домена, которые работают на виртуальных машинах в виртуальной сети Azure. Но если VPN станет недоступна, пропадет связь между компьютерами локальной сети и контроллерами домена в Azure, а при проверке подлинности и других операциях будут возникать ошибки.  
> 
> 

## <a name="contrasts-between-deploying-windows-server-active-directory-domain-controllers-on-azure-virtual-machines-versus-on-premises"></a>Разница между развертыванием контроллеров домена Windows Server Active Directory на виртуальных машинах Azure и локальным развертыванием
* В любом сценарии развертывания Windows Server Active Directory, где используется больше одной виртуальной машины, необходимо использовать виртуальную сеть Azure, чтобы обеспечить согласованность IP-адресов. Обратите внимание, в этом руководстве подразумевается, что контроллеры домена работают в виртуальной сети Azure.
* Как и для локальных контроллеров, рекомендуется настройка статических IP-адресов. Статический IP-адрес можно настроить только с помощью Azure PowerShell. Дополнительные сведения см. в статье [Static internal IP address for VMs](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/) (Настройка статического внутреннего IP-адреса для виртуальных машин). Если у вас есть системы мониторинга или другие решения, которые проверяют конфигурацию статических IP-адресов в операционной системе на виртуальной машине, то можно назначить тот же статический IP-адрес свойствам сетевого адаптера виртуальной машины. Но необходимо учитывать, что сетевой адаптер будет изменен, если в виртуальной машине будет восстановлена работоспособность службы или если работа виртуальной машины будет завершена на портале, а назначение ей адреса будет отменено. В таком случае придется сбросить статический IP-адрес в операционной системе на виртуальной машине.
* Развертывание виртуальных машин в виртуальной сети не подразумевает (и не требует) обратной связи с локальной сетью. Виртуальная сеть лишь обеспечивает такую возможность. Чтобы обеспечить частную связь между Azure и вашей локальной сетью, нужно создать виртуальную сеть. Кроме этого, необходимо развернуть конечную точку VPN в локальной сети. Чтобы открыть подключение к VPN, нужно подключить Azure к локальной сети. Дополнительные сведения см. в статьях [Обзор виртуальной сети](../virtual-network/virtual-networks-overview.md) и [Создание виртуальной сети с подключением типа "сеть — сеть" с помощью портала Azure](../vpn-gateway/vpn-gateway-site-to-site-create.md).

> [!NOTE]
> Чтобы [создать VPN типа "точка-сеть"](../vpn-gateway/vpn-gateway-point-to-site-create.md) , нужно подключить отдельные компьютеры Windows напрямую к виртуальной сети Azure.
> 
> 

* Azure взимает плату за исходящий трафик (не за входящий) независимо от того, создана ли виртуальная сеть. Объем входящего трафика развертывания может зависеть от выбранной архитектуры Windows Server Active Directory. Например, при развертывании контроллера домена только для чтения входящий трафик ограничен, так как исходящие данные не реплицируются. Однако при принятии решения о развертывании контроллера домена только для чтения нужно учитывать необходимость выполнять операции записи в контроллере, а также [совместимость](https://technet.microsoft.com/library/cc755190) приложений и служб на сайте с контроллером домена только для чтения. Дополнительные сведения о ценах на использование трафика см. в разделе [Цены Azure](http://azure.microsoft.com/pricing/).
* При настройке виртуальных машин в локальной сети у вас есть полный контроль над тем, какой объем серверных ресурсов, например ОЗУ, размер диска и т. п., будет отведен под машины, а при работе в Azure его нужно выбрать в списке предопределенных размеров сервера. В дополнение к диску операционной системы для контроллера домена также требуется диск данных, где будет храниться база данных Windows Server Active Directory.

## <a name="can-you-deploy-windows-server-ad-fs-on-azure-virtual-machines"></a>Можно ли развернуть Windows Server AD FS на виртуальных машинах Azure?
Да, Windows Server AD FS можно развернуть на виртуальных машинах в Azure. [Рекомендации по развертыванию AD FS](https://technet.microsoft.com/library/dn151324.aspx) в локальной среде относятся и к развертыванию AD FS в Azure. Но для выполнения некоторых рекомендаций, например по балансировке нагрузки и обеспечению высокой доступности, требуется использовать технологии, которые не реализованы в AD FS. Они должны быть в базовой инфраструктуре. Рассмотрим некоторые из этих рекомендаций, чтобы узнать, как их реализовать с помощью виртуальных машин Azure и виртуальной сети Azure.

1. **Никогда не предоставляйте доступ к серверам службы маркеров безопасности напрямую в Интернете.**
   
    Это важно, так как соответствующая служба выдает маркеры безопасности. Следовательно, такие серверы службы маркеров безопасности, как AD FS, следует защищать на том же уровне, что и контроллер домена. Если пользователи-злоумышленники скомпрометируют службу маркеров безопасности, они смогут выдавать маркеры доступа, потенциально содержащие их утверждения для приложений проверяющей стороны и других серверов службы маркеров безопасности в доверяющих организациях.
2. **Развертывайте контроллеры доменов Active Directory для всех доменов пользователей в сети, где размещены серверы AD FS.**
   
    Серверы AD FS используют доменные службы Active Directory для проверки подлинности пользователей. Контроллеры доменов рекомендуется развертывать в той же сети, что и серверы AD FS. Это обеспечит непрерывность работы на случай разрыва связи между сетью Azure и локальной сетью, а также позволит уменьшить задержки и повысить производительность при входе.
3. **Разверните несколько узлов AD FS, чтобы обеспечить высокую доступность и балансировку нагрузки.**
   
    В большинстве случаев сбои приложений, обслуживаемых AD FS, неприемлемы, так как приложения, которым требуются маркеры безопасности, часто критически важны для работы. Так как AD FS необходимы для доступа к важным приложениям, у этих служб должен быть высокий уровень доступности на нескольких прокси-серверах и серверах AD FS. Чтобы добиться соответствующего распределения запросов, балансировщики нагрузки обычно развертывают на прокси-серверах и серверах AD FS.
4. **Разверните один или несколько узлов прокси-служб веб-приложений для доступа в Интернете.**
   
    Если пользователям нужен доступ к приложениям, защищенным службами AD FS, эти службы должны быть доступны в Интернете. Для этого нужно развернуть прокси-службу веб-приложений. Настоятельно рекомендуется развернуть несколько узлов, чтобы обеспечить высокий уровень доступности и балансировку нагрузки.
5. **Ограничьте доступ к ресурсам внутренней сети с узлов прокси-служб веб-приложений.**
   
    Чтобы предоставить внешним пользователям доступ к службам AD FS в Интернете, необходимо развернуть узлы прокси-служб веб-приложений (или прокси-сервера AD FS, если используется более ранняя версия Windows Server). Узлы прокси-служб веб-приложений доступны напрямую в Интернете. Их не нужно присоединять к домену, так как для них необходимо только обеспечить доступ к серверам AD FS через TCP-порты 443 и 80. Настоятельно рекомендуется заблокировать связь со всеми остальными компьютерами (особенно контроллерами доменов).
   
    Обычно это делают локально с использованием сети периметра. Брандмауэры используют режим списка разрешений, чтобы ограничить трафик сети периметра до использования локальной сети (т. е. разрешен только трафик с указанных IP-адресов и через указанные порты, а весь остальной трафик блокируется).

На следующей схеме показано традиционное локальное развертывание AD FS.

![Схема стандартного локального развертывания служб федерации Active Directory](media/active-directory-deploying-ws-ad-guidelines/ADFS_onprem.png)

Так как Azure не предоставляет встроенный полнофункциональный брандмауэр, нужно использовать другие варианты, чтобы ограничить трафик. В следующей таблице показаны все доступные варианты, их преимущества и недостатки.

| Параметр | Преимущество | Недостаток |
| --- | --- | --- |
| [ACL сети Azure](../virtual-network/virtual-networks-acl.md) |Стоят меньше, простая начальная настройка |При добавлении в развертывание новых виртуальных машин требуется дополнительная настройка ACL |
| [Barracuda NG Firewall](https://www.barracuda.com/products/ngfirewall) |Режим списка разрешений, не требуется настройка ACL |Стоит дороже, сложная начальная настройка |

Далее представлена подробная процедура такого развертывания AD FS:

1. Создайте виртуальную сеть с распределенным подключением, используя VPN или [ExpressRoute](http://azure.microsoft.com/services/expressroute/).
2. Разверните контроллеры домена в виртуальной сети. Этот шаг необязателен, но мы рекомендуем его выполнить.
3. Разверните присоединенные к домену серверы AD FS в виртуальной сети.
4. Создайте [набор с внутренней балансировкой нагрузки](http://azure.microsoft.com/blog/internal-load-balancing/) , который включает в себя серверы AD FS и использует новый частный (динамический) IP-адрес в виртуальной сети.
   
   1. Обновите DNS, чтобы создать FQDN, указывающее на частный (динамический) IP-адрес набора с внутренней балансировкой нагрузки.
5. Создайте облачную службу (или отдельную виртуальную сеть) для узлов прокси-служб веб-приложений.
6. Разверните узлы прокси-служб веб-приложений в облачной службе или виртуальной сети.
   
   1. Создайте внешний набор с балансировкой нагрузки, который включает в себя узлы прокси-служб веб-приложений.
   2. Обновите имя внешней DNS (FQDN), указывающее на общедоступный (виртуальный) IP-адрес облачной службы.
   3. Настройте использование FQDN, соответствующего набору с внутренней балансировкой нагрузки серверов AD FS, для прокси-серверов AD FS.
   4. Обновите веб-сайты на основе утверждений, чтобы они использовали FQDN для поставщика утверждений.
7. Ограничьте доступ между узлами прокси-служб веб-приложения, указав любой компьютер в виртуальной сети AD FS.

Чтобы ограничить трафик, набор с балансировкой нагрузки для внутреннего балансировщика нагрузки Azure необходимо настроить так, чтобы трафик проходил только через TCP-порты 80 и 443, при этом весь остальной трафик по внутренним динамическим IP-адресам набора с балансировкой нагрузки отклонялся.

![Схема сетевых списков ACL служб ADFS с разрешенным набором портов TCP 443 и 80.](media/active-directory-deploying-ws-ad-guidelines/ADFS_ACLs.png)

Допускается трафик на серверы AD FS со следующих источников:

* внутренний балансировщик нагрузки Azure;
* IP-адрес администратора локальной сети.

> [!WARNING]
> При такой архитектуре узлы прокси-служб веб-приложений не смогут связываться с другими виртуальными машинами в виртуальной сети Azure или расположениями в локальной сети. Для этого необходимо настроить правила брандмауэра для подключений ExpressRoute на локальном модуле или для VPN типа "сеть-сеть" на устройстве VPN.
> 
> 

Недостаток этого варианта заключается в необходимости настройки сетевых списков ACL для нескольких устройств, в том числе внутреннего балансировщика нагрузки, серверов AD FS и других серверов, добавляемых в виртуальную сеть. Если какое-то устройство добавляется к развертыванию без настройки сетевых списков ACL для ограничения трафика к нему, все развертывание может быть под угрозой. Если IP-адреса узлов прокси-служб веб-приложений изменятся, необходимо сбросить сетевые списки управления доступом (т. е. для прокси-серверов нужно настроить использование [статических динамических IP-адресов](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/)).

![Службы ADFS в Azure с использованием сетевых списков ACL.](media/active-directory-deploying-ws-ad-guidelines/ADFS_Azure.png)

Другой вариант — использовать модуль [Barracuda NG Firewall](https://www.barracuda.com/products/ngfirewall) , чтобы контролировать трафик между прокси-серверами AD FS и серверами AD FS. Этот вариант соответствует рекомендациям по безопасности и высокой доступности и требует меньше администрирования после начальной настройки, так как модуль Barracuda NG Firewall использует режим списка разрешений и его можно установить прямо в виртуальной сети Azure. Это устраняет необходимость настраивать сетевые списки ACL всякий раз, когда в развертывание добавляется новый сервер. Но при использовании этого варианта начальное развертывание становится сложнее и дороже.

В этом случае развертываются две виртуальные сети вместо одной. Мы назовем их VNet1 и VNet2. В VNet1 содержатся прокси-серверы, а в VNet2 — службы маркеров безопасности. Кроме того, в последней установлено сетевое подключение к корпоративной сети. Таким образом, VNet1 физически (хотя и виртуально) изолирована от сети VNet2 и, в свою очередь, от корпоративной сети. VNet1 подключается к VNet2 с помощью специальной технологии туннелирования под названием Transport Independent Network Architecture (TINA). Туннель TINA подключается к каждой виртуальной сети с помощью брандмауэра Barracuda NG Firewall (один такой брандмауэр на каждую виртуальную сеть).  Для обеспечения высокой доступности рекомендуется развернуть два брандмауэра Barracuda в каждой виртуальной сети — активный и пассивный. Они предусматривают множество возможностей защиты брандмауэром, которые позволяют сымитировать работу стандартной локальной сети периметра в Azure.

![Службы ADFS в Azure с использованием брандмауэра.](media/active-directory-deploying-ws-ad-guidelines/ADFS_Azure_firewall.png)

Дополнительные сведения см. в разделе [AD FS: предоставление доступа к локальному внешнему приложению с поддержкой утверждений через Интернет](#BKMK_CloudOnlyFed).

### <a name="an-alternative-to-ad-fs-deployment-if-the-goal-is-office-365-sso-alone"></a>Альтернатива развертыванию AD FS, если целью является только единый вход в Office 365
Есть также и другой способ развертывания AD FS, если целью является только единый вход в Office 365. В этом случае можно просто развернуть DirSync с синхронизацией паролей в локальной сети и добиться того же самого конечного результата с помощью простого развертывания, так как для этого подхода не требуется AD FS или Azure.

В следующей таблице приводится сравнение процессов входа в систему с развертыванием AD FS и без него.

| Единый вход в Office 365 с использованием AD FS и DirSync | "Такой же вход" в Office 365 с использованием DirSync и синхронизации паролей |
| --- | --- |
| 1. Пользователь входит в корпоративную сеть и проходит проверку подлинности в Windows Server Active Directory. |1. Пользователь входит в корпоративную сеть и проходит проверку подлинности в Windows Server Active Directory. |
| 2. Пользователь пытается получить доступ к Office 365 (имя @contoso.com). |2. Пользователь пытается получить доступ к Office 365 (имя @contoso.com). |
| 3. Office 365 перенаправляет пользователя в Azure AD. |3. Office 365 перенаправляет пользователя в Azure AD. |
| 4. Так как Azure AD не может проверить подлинность пользователя и учитывает, что с локальной инфраструктурой AD FS установлены доверительные отношения, пользователь перенаправляется в AD FS. |4. Azure AD не может принять билеты Kerberos напрямую, так как доверительные отношения не установлены, поэтому пользователю отправляется запрос на ввод учетных данных. |
| 5. Пользователь отправляет билет Kerberos в службу маркеров безопасности AD FS. |5. Пользователь вводит те же локальные учетные данные, после чего Azure AD проверяет их на соответствие данным, синхронизированным с помощью DirSync. |
| 6. AD FS преобразовывает билет Kerberos в необходимый формат маркера или утверждения и перенаправляет пользователя в Azure AD. |6. Azure AD перенаправляет пользователя в Office 365. |
| 7. Пользователь проходит проверку подлинности для Azure AD (выполняется еще одно преобразование). |7. Пользователь может войти в Office 365 и OWA, используя маркер Azure AD. |
| 8. Azure AD перенаправляет пользователя в Office 365. | |
| 9. Пользователь автоматически входит в Office 365. | |

В сценарии с Office 365, где применяется синхронизация паролей с помощью DirSync (без AD FS), единый вход заменяется на "такой же вход", где "такой же" означает, что во время доступа к Office 365 пользователю нужно повторно ввести те же локальные учетные данные. Обратите внимание, браузер пользователя может сохранить эти данные, чтобы сократить число запросов в будущем.

### <a name="additional-food-for-thought"></a>Важные сведения
* Если прокси-сервер AD FS развертывается на виртуальной машине Azure, необходимо подключение к серверам AD FS. Если серверы локальные, рекомендуется использовать VPN-подключение типа "сеть-сеть", предоставляемое виртуальной сетью, чтобы узлы прокси-служб веб-приложений могли взаимодействовать со своими серверами AD FS.
* Если сервер AD FS развертывается на виртуальной машине Azure, необходимо подключение к контроллерам домена Windows Server Active Directory, хранилищам атрибутов и базам данных конфигурации. Может также потребоваться подключение ExpressRoute или VPN-подключение типа "сеть-сеть" между виртуальной сетью Azure и локальной сетью.
* За трафик, поступающий с виртуальных машин Azure, (исходящий) взимается плата. Если затраты играют решающую роль, рекомендуется развертывать узлы прокси-служб веб-приложений в Azure, оставив серверы AD FS в локальной среде. Если серверы AD FS также развертываются на виртуальных машинах Azure, за проверку подлинности локальных пользователей взимается дополнительная плата. Исходящий трафик оплачивается независимо от используемого подключения: ExpressRoute или VPN-подключение типа "сеть-сеть".
* Обратите внимание, если для обеспечения высокой доступности серверов AD FS будет использоваться собственная балансировка нагрузки сервера в Azure, будут выполняться проверки для определения состояния виртуальных машин в облачной службе. В случае использования виртуальных машин Azure (в отличие от рабочих ролей или веб-ролей) необходимо использовать пользовательскую проверку, так как на этих машинах отсутствует агент, который отвечает на проверку по умолчанию. Чтобы упростить этот процесс, можно использовать пользовательскую проверку TCP. В этом случае для определения работоспособности виртуальной машины требуется только успешное TCP-подключение (отправка сегмента TCP SYN и получение ответа с сегментом TCP SYN ACK). Вы можете настроить пользовательскую проверку таким образом, чтобы использовался любой TCP-порт, который активно прослушивается на ваших виртуальных машинах.

> [!NOTE]
> Компьютеры с одинаковым набором открытых в Интернете портов (например, порт 80 и 443), не могут использовать одну и ту же облачную службу. Поэтому рекомендуется создать выделенную облачную службу для ваших серверов Windows Server AD FS, чтобы избежать потенциальных перекрытий в требованиях к портам для приложения и служб Windows Server AD FS.
> 
> 

## <a name="deployment-scenarios"></a>Сценарии развертывания
Ниже описаны обычные сценарии развертывания, а также приведены важные моменты, которые нужно учесть. Каждый сценарий содержит ссылки на дополнительные сведения о решениях и факторах, требующих рассмотрения.

1. [AD DS: развертывание приложения с поддержкой AD DS, для которого не требуется подключение к корпоративной сети.](#BKMK_CloudOnly)
   
    К примеру, служба SharePoint с доступом через Интернет развертывается на виртуальной машине Azure. У приложения нет зависимостей от ресурсов корпоративной сети. Приложению требуются службы Windows Server AD DS, но НЕ требуются корпоративные службы Windows Server AD DS.
2. [AD FS: предоставление доступа к локальному внешнему приложению с поддержкой утверждений через Интернет.](#BKMK_CloudOnlyFed)
   
    Например, необходимо, чтобы развернутое в локальной среде приложение с поддержкой утверждений, которое используется корпоративными пользователями, стало доступным через Интернет. Это приложение должно быть доступно напрямую через Интернет как для деловых партнеров при использовании их корпоративных удостоверений, так и для существующих корпоративных пользователей.
3. [AD DS: развертывание приложения с поддержкой Windows Server AD DS, для которого требуется подключение к корпоративной сети.](#BKMK_HybridExt)
   
    Например, поддерживающее LDAP и встроенную проверку подлинности Windows приложение, которое использует службы Windows Server AD DS в качестве репозитория для данных конфигурации и профилей пользователей, развертывается на виртуальной машине Azure. Рекомендуется, чтобы приложение использовало существующие корпоративные службы Windows Server AD DS и обеспечивало единый вход. Приложение не поддерживает утверждения.

### <a name="BKMK_CloudOnly"></a>1. AD DS: развертывание приложения с поддержкой AD DS, для которого не требуется подключение к корпоративной сети
![Развертывание служб AD DS только в облаке](media/active-directory-deploying-ws-ad-guidelines/ADDS_cloud.png)
**Рис. 1**

#### <a name="description"></a>ОПИСАНИЕ
Служба SharePoint развертывается на виртуальной машине Azure, а приложение не имеет зависимостей от ресурсов корпоративной сети. Приложению требуются службы Windows Server AD DS, но *не* требуются корпоративные службы Windows Server AD DS. Доверительные отношения с Kerberos и федерацией не требуются, так как пользователи самостоятельно подготавливаются для домена Windows Server AD DS, который также размещается в облаке на виртуальных машинах Azure, через приложение.

#### <a name="scenario-considerations-and-how-technology-areas-apply-to-the-scenario"></a>Рекомендации по сценарию и применению технологий в его рамках
* [Топология сети](#BKMK_NetworkTopology). Создайте виртуальную сеть Azure без подключения между организациями (также называется подключением типа "сеть — сеть").
* [Настройка развертывания контроллера домена](#BKMK_DeploymentConfig). Разверните новый контроллер домена в новый лес Windows Server Active Directory с одним доменом. Его необходимо развернуть вместе с DNS-сервером Windows.
* [Топология сайтов Windows Server Active Directory](#BKMK_ADSiteTopology). Используйте сайт Windows Server Active Directory по умолчанию (все компьютеры будут относиться к объекту сайта Default-First-Site-Name).
* [Назначение IP-адресов и DNS](#BKMK_IPAddressDNS):
  
  * Задайте статический IP-адрес для контроллера домена с помощью командлета Set-AzureStaticVNetIP в Azure PowerShell.
  * Установите и настройте DNS Windows Server на контроллерах домена в Azure.
  * Настройте свойства виртуальной сети, указав имя и IP-адрес виртуальной машины, на которой размещены роли контроллера домена и DNS-сервера.
* [Глобальный каталог](#BKMK_GC). Первый контроллер домена в лесу должен быть сервером глобального каталога. Дополнительные контроллеры домена необходимо настроить как глобальные каталоги, так как в лесу с одним доменом для глобального каталога не требуется каких-либо дополнительных действий со стороны контроллера домена.
* [Размещение базы данных и SYSVOL служб Windows Server AD DS](#BKMK_PlaceDB). Добавьте диск данных к контроллерам домена, работающим в качестве виртуальных машин Azure, для хранения базы данных, журналов и SYSVOL служб Windows Server Active Directory.
* [Резервное копирование и восстановление](#BKMK_BUR). Определите место хранения резервных копий состояния системы. При необходимости добавьте к виртуальной машине контроллера домена другой диск данных для хранения резервных копий.

### <a name="BKMK_CloudOnlyFed"></a>2. AD FS: предоставление доступа к локальному внешнему приложению с поддержкой утверждений через Интернет
![Федерация с подключением между организациями](media/active-directory-deploying-ws-ad-guidelines/Federation_xprem.png)
**Рис. 2**

#### <a name="description"></a>ОПИСАНИЕ
Необходимо, чтобы развернутое в локальной среде приложение с поддержкой утверждений, которое используется корпоративными пользователями, стало доступным напрямую через Интернет. Приложение выполняет функцию внешнего веб-интерфейса в базе данных SQL, в которой оно хранит данные. Серверы SQL Server, используемые приложением, также находятся в корпоративной сети. Две службы маркеров безопасности Windows Server AD FS и балансировщик нагрузки развернуты в локальной среде для предоставления доступа корпоративным пользователям. Теперь необходимо, чтобы приложение также было доступно непосредственно через Интернет как для деловых партнеров при использовании их корпоративных удостоверений, так и для существующих корпоративных пользователей.

Чтобы упростить процедуру развертывания и настройки в связи с новым требованием, на виртуальных машинах Azure необходимо установить два дополнительных внешних веб-интерфейса и два прокси-сервера Windows Server AD FS. Все четыре виртуальные машины будут доступны непосредственно через Интернет и подключены к локальной сети через VPN-подключение типа "сеть-сеть" виртуальной сети Azure.

#### <a name="scenario-considerations-and-how-technology-areas-apply-to-the-scenario"></a>Рекомендации по сценарию и применению технологий в его рамках
* [Топология сети](#BKMK_NetworkTopology). Создайте виртуальную сеть Azure и [настройте подключение между организациями](../vpn-gateway/vpn-gateway-site-to-site-create.md).
  
  > [!NOTE]
  > Необходимо, чтобы экземпляры Windows Server AD FS, запущенные в Azure, могли получить доступ к URL-адресу, определенному в шаблоне сертификата, и полученным сертификатам Windows Server AD FS. Для этого может потребоваться распределенное подключение для частей инфраструктуры PKI. К примеру, если конечная точка списка отзыва сертификатов создана на основе LDAP и расположена только в локальной среде, потребуется подключение между организациями. Если этого нужно избежать, необходимо использовать выданные центром сертификации сертификаты, списки отзыва сертификатов которых доступны через Интернет.
  > 
  > 
* [Настройка облачных служб](#BKMK_CloudSvcConfig). Для предоставления двух виртуальных IP-адресов с балансировкой нагрузки требуются две облачные службы. Виртуальный IP-адрес первой облачной службы будет направляться на две виртуальные машины прокси-сервера Windows Server AD FS через порты 80 и 443. Виртуальные машины прокси-сервера Windows Server AD FS будут настроены таким образом, чтобы они указывали на IP-адрес локального балансировщика нагрузки, который расположен перед службами маркеров безопасности Windows Server AD FS. Виртуальный IP-адрес второй облачной службы будет направляться на две виртуальные машины с внешним веб-интерфейсом также через порты 80 и 443. Настройте пользовательскую проверку, чтобы балансировщик нагрузки направлял трафик только на исправные прокси-серверы и виртуальные машины внешнего веб-интерфейса Windows Server AD FS.
* [Настройка сервера федерации](#BKMK_FedSrvConfig). Настройте службы Windows Server AD FS как сервер федерации (служба маркеров безопасности) для создания маркеров безопасности для леса Windows Server Active Directory, созданного в облаке. Установите доверительные отношения между поставщиком утверждений федерации и различными партнерами, от которых необходимо принимать удостоверения, а также между проверяющей стороной и различными приложениями, для которых необходимо создавать маркеры.
  
    В большинстве сценариев в целях безопасности прокси-серверы Windows Server AD FS развертываются с возможностью доступа к Интернету, в то время как соответствующие части федерации остаются изолированными от прямого подключения к Интернету. Независимо от сценария развертывания для облачной службы необходимо настроить виртуальный IP-адрес, который предоставит открытый IP-адрес и порт с возможностью балансировки нагрузки по двум экземплярам службы маркеров безопасности или экземплярам прокси-сервера Windows Server AD FS.
* [Настройка высокой доступности Windows Server AD FS](#BKMK_ADFSHighAvail). Рекомендуется развернуть ферму Windows Server AD FS по крайней мере с двумя серверами для отработки отказа и балансировки нагрузки. Возможно, вам потребуется внутренняя база данных Windows (WID) для данных конфигурации Windows Server AD FS и внутренняя балансировка нагрузки Azure для распределения входящих запросов по серверам в ферме.

Дополнительные сведения см. в статье [AD DS Deployment Guide](https://technet.microsoft.com/library/cc753963) (Руководство по развертыванию AD DS).

### <a name="BKMK_HybridExt"></a>3. AD DS: развертывание приложения с поддержкой Windows Server AD DS, для которого требуется подключение к корпоративной сети
![Развертывание служб AD DS между организациями](media/active-directory-deploying-ws-ad-guidelines/ADDS_xprem.png)
**Рис. 3**

#### <a name="description"></a>ОПИСАНИЕ
Приложение, поддерживающее LDAP, развертывается на виртуальной машине Azure. Оно поддерживает встроенную проверку подлинности Windows и использует Windows Server AD DS в качестве репозитория для данных конфигурации и профилей пользователей. Необходимо, чтобы приложение использовало существующие корпоративные службы Windows Server AD DS и обеспечивало единый вход. Приложение не поддерживает утверждения. Пользователи также должны получать доступ к приложению непосредственно через Интернет. Чтобы оптимизировать производительность и расходы, вместе с приложением в Azure развертываются два дополнительных контроллера домена, которые являются частью корпоративного домена.

#### <a name="scenario-considerations-and-how-technology-areas-apply-to-the-scenario"></a>Рекомендации по сценарию и применению технологий в его рамках
* [Топология сети](#BKMK_NetworkTopology). Создайте виртуальную сеть Azure с возможностью [подключения между организациями](../vpn-gateway/vpn-gateway-site-to-site-create.md).
* [Метод установки](#BKMK_InstallMethod). Разверните реплики контроллеров домена из корпоративного домена Windows Server Active Directory. Для реплики контроллера домена можно установить Windows Server AD DS на виртуальной машине и при необходимости использовать функцию установки с носителя, чтобы сократить объем данных, которые необходимо реплицировать в новый контроллер домена во время установки. Руководство см. в статье [Установка реплики контроллера домена Active Directory в виртуальной сети Azure](active-directory-install-replica-active-directory-domain-controller.md). Даже при использовании функции установки с носителя создание виртуальных локальных контроллеров домена и перемещение всего виртуального жесткого диска (VHD) в облако может быть гораздо эффективнее репликации Windows Server AD DS во время установки. В целях безопасности после копирования виртуального жесткого диска в Azure рекомендуется удалить его из локальной сети.
* [Топология сайтов Windows Server Active Directory](#BKMK_ADSiteTopology). Создайте сайт Azure в оснастке "Active Directory — сайты и службы". Затем создайте объект подсети Windows Server Active Directory в качестве виртуальной сети Azure и добавьте его к сайту. После этого создайте новую связь между новым сайтом Azure и сайтом, в котором находится конечная точка VPN виртуальной сети Azure, для управления входящим и исходящим трафиком Azure для Windows Server Active Directory и его оптимизации.
* [Назначение IP-адресов и DNS](#BKMK_IPAddressDNS):
  
  * Задайте статический IP-адрес для контроллера домена с помощью командлета Set-AzureStaticVNetIP в Azure PowerShell.
  * Установите и настройте DNS Windows Server на контроллерах домена в Azure.
  * Настройте свойства виртуальной сети, указав имя и IP-адрес виртуальной машины, на которой размещены роли контроллера домена и DNS-сервера.
* [Географически распределенные контроллеры домена](#BKMK_DistributedDCs). При необходимости настройте дополнительные виртуальные сети. Если для топологии сайтов Active Directory требуются контроллеры доменов в географических регионах, которые соответствуют разным регионам Azure, необходимо создавать сайты Active Directory соответствующим образом.
* [Контроллеры домена только для чтения](#BKMK_RODC). Вы можете развернуть контроллер домена только для чтения на сайте Azure в зависимости от требований к выполнению операций записи для контроллера домена и совместимости приложений и служб на сайте с этими контроллерами домена. Дополнительные сведения о совместимости приложений см. в разделе [Read-Only domain controllers application compatibility guide](https://technet.microsoft.com/library/cc755190) (Совместимость приложений с контроллерами домена только для чтения).
* [Глобальный каталог](#BKMK_GC). Глобальные каталоги нужны для обслуживания запросов на вход в мультидоменных лесах. Если на сайте Azure не развернут глобальный каталог, с вас будет взиматься плата за исходящий трафик, так как запросы на проверку подлинности приведут к возникновению глобальных каталогов запросов на других сайтах. Чтобы уменьшить объем этого трафика, можно включить кэширование сведений о членстве в универсальных группах для сайта Azure в оснастке "Active Directory — сайты и службы".
  
    Если глобальный каталог развертывается, настройте связи сайтов и их стоимость, чтобы глобальный каталог на сайте Azure не был выбран в качестве исходного контроллера домена другими глобальными каталогами, которым необходимо реплицировать те же частичные разделы домена.
* [Размещение базы данных и SYSVOL служб Windows Server AD DS](#BKMK_PlaceDB). Добавьте диск данных к контроллерам домена, запущенным на виртуальных машинах Azure, для хранения базы данных, журналов и SYSVOL служб Windows Server Active Directory.
* [Резервное копирование и восстановление](#BKMK_BUR). Определите место хранения резервных копий состояния системы. При необходимости добавьте к виртуальной машине контроллера домена другой диск данных для хранения резервных копий.

## <a name="deployment-decisions-and-factors"></a>Решения и факторы, связанные с развертыванием
В следующей таблице приведены технологические области Windows Server Active Directory, которые затрагиваются в описанных выше сценариях, и соответствующие решения, а также ссылки на более подробное описание. Некоторые технологические области могут быть неприменимы к каждому сценарию развертывания, в то время как некоторые области могут быть более важными для сценария развертывания, чем другие.

Например, если реплика контроллера домена развертывается в виртуальной сети, а в лесу есть только один домен, то развертывание сервера глобального каталога в этом случае не будет особенно важным для сценария развертывания, так как при этом не будут возникать какие-либо дополнительные требования к репликации. С другой стороны, если в лесу есть несколько доменов, то развертывание глобального каталога в виртуальной сети может повлиять на пропускную способность, производительность, проверку подлинности, поиск в каталоге и т. д.

| Технологическая область Windows Server Active Directory | Решения | Факторы |
| --- | --- | --- |
| [Топология сети](#BKMK_NetworkTopology) |Нужно ли создавать виртуальную сеть? |<li>Требования к доступу к корпоративным ресурсам</li> <li>Authentication</li> <li>Управление учетными записями</li> |
| [Настройка развертывания контроллера домена](#BKMK_DeploymentConfig) |<li>Нужно ли развернуть отдельный лес без отношений доверия?</li> <li>Нужно ли развернуть новый лес с федерацией?</li> <li>Нужно ли развернуть новый лес с отношениями доверия с лесом Windows Server Active Directory или Kerberos?</li> <li>Нужно ли расширить корпоративный лес путем развертывания реплики контроллера домена?</li> <li>Нужно ли расширить корпоративный лес с помощью развертывания нового дочернего домена или доменного дерева?</li> |<li>Безопасность</li> <li>Соответствие нормативным требованиям</li> <li>Стоимость</li> <li>Устойчивость к сбоям</li> <li>Совместимость приложений</li> |
| [Топология сайтов Windows Server Active Directory](#BKMK_ADSiteTopology) |Каким образом нужно настроить подсети, сайты и связи сайтов с помощью виртуальной сети Azure для оптимизации трафика и сокращения затрат? |<li>Определения подсетей и сайтов</li> <li>Свойства связей сайтов и уведомления об изменениях</li> <li>Сжатие репликации</li> |
| [Назначение IP-адресов и DNS](#BKMK_IPAddressDNS) |Как настроить IP-адреса и разрешение имен? |<li>Воспользуйтесь командлетом Set-AzureStaticVNetIP, чтобы назначить статический IP-адрес.</li> <li>Установите DNS-сервер Windows Server и настройте свойства виртуальной сети, указав имя и IP-адрес виртуальной машины, на которой размещены роли контроллера домена и DNS-сервера.</li> |
| [Географически распределенные контроллеры домена](#BKMK_DistributedDCs) |Как выполнять репликацию в контроллеры домена в отдельных виртуальных сетях? |Если для топологии сайтов Active Directory требуются контроллеры доменов в географических регионах, которые соответствуют разным регионам Azure, необходимо создавать сайты Active Directory соответствующим образом. [Настройте подключение между виртуальными сетями](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md) , чтобы обеспечить репликацию между контроллерами домена в отдельных виртуальных сетях. |
| [Контроллеры доменов только для чтения](#BKMK_RODC) |Нужно ли использовать контроллеры домена только для чтения или с возможностью записи? |<li>Фильтрация атрибутов HBI и PII</li> <li>Фильтрация секретных данных</li> <li>Ограничения исходящего трафика</li> |
| [Глобальный каталог](#BKMK_GC) |Нужно ли устанавливать глобальный каталог? |<li>Для леса с одним доменом настройте все контроллеры домена в качестве глобальных каталогов.</li> <li>При использовании мультидоменного леса глобальные каталоги необходимы для аутентификации.</li> |
| [Метод установки](#BKMK_InstallMethod) |Как установить контроллер домена в Azure? |Одно из двух: <li>Установите AD DS с помощью Windows PowerShell или Dcpromo.</li> <li>Переместите VHD локального виртуального контроллера домена.</li> |
| [Размещение базы данных и SYSVOL служб Windows Server AD DS](#BKMK_PlaceDB) |Где будут храниться база данных, журналы и SYSVOL служб Windows Server AD DS? |Измените значения по умолчанию в файле Dcpromo.exe. Эти критически важные файлы Active Directory *необходимо* разместить на дисках данных Azure, а не на дисках операционной системы, которые реализуют кэширование записи. |
| [Резервное копирование и восстановление](#BKMK_BUR) |Как выполнять защиту и восстановление данных? |Создайте резервные копии состояния системы. |
| [Настройка сервера федерации](#BKMK_FedSrvConfig) |<li>Нужно ли развернуть новый лес с федерацией в облаке?</li> <li>Нужно ли развернуть AD FS локально и предоставлять доступ к прокси-серверу в облаке?</li> |<li>Безопасность</li> <li>Соответствие нормативным требованиям</li> <li>Стоимость</li> <li>Доступ к приложениям для деловых партнеров</li> |
| [Настройка облачных служб](#BKMK_CloudSvcConfig) |Облачная служба неявно развертывается при первом создании виртуальной машины. Нужно ли развертывать дополнительные облачные службы? |<li>Необходимость наличия прямого доступа к Интернету для виртуальных машин</li> <li> Необходимость балансировки нагрузки для службы</li> |
| [Требования сервера федерации в отношении общих и частных IP-адресов (динамические и виртуальные IP-адреса)](#BKMK_FedReqVIPDIP) |<li>Требуется ли прямой доступ к экземпляру Windows Server AD FS через Интернет?</li> <li>Требуются ли для приложения, развертываемого в облаке, отдельные IP-адрес и порт в Интернете?</li> |Создайте одну облачную службу для каждого виртуального IP-адреса, требуемого для развертывания. |
| [Настройка высокой доступности Windows Server AD FS](#BKMK_ADFSHighAvail) |<li>Сколько узлов будет содержаться в ферме серверов Windows Server AD FS?</li> <li>Сколько узлов необходимо развернуть в ферме прокси-серверов Windows Server AD FS?</li> |Устойчивость к сбоям |

### <a name="BKMK_NetworkTopology"></a>Топология сети
Чтобы обеспечить соблюдение требований к DNS и согласованности IP-адресов для Windows Server AD DS, сначала необходимо создать [виртуальную сеть Azure](../virtual-network/virtual-networks-overview.md) и присоединить к ней виртуальные машины. Во время создания этой сети необходимо решить, требуется ли подключение к локальной корпоративной сети, чтобы прозрачно подключать виртуальные машины Azure к локальным компьютерам. Для этого нужны стандартные технологии VPN и конечная точка VPN на границе корпоративной сети. То есть VPN-подключение инициируется из Azure к корпоративной сети, а не наоборот.

Обратите внимание, что при подключении виртуальной сети к локальной сети, помимо стандартной тарификации по каждой виртуальной машине, взимается дополнительная плата. В частности, плата взимается за время ЦП шлюза виртуальной сети Azure и исходящий трафик, генерируемый каждой виртуальной машиной, которая взаимодействует с локальными компьютерами по сети VPN. Дополнительные сведения о ценах на использование сетевого трафика см. в статье [Цены Azure](http://azure.microsoft.com/pricing/).

### <a name="BKMK_DeploymentConfig"></a>Настройка развертывания контроллера домена
Способ настройки контроллера домена зависит от требований к службе, которая будет запущена в Azure. Например, можно развернуть новый лес, изолированный от корпоративного леса, чтобы протестировать экспериментальное развертывание, а также новое приложение или краткосрочный проект, которым необходимы службы каталогов, но не требуется доступ к внутренним корпоративным ресурсам.

Контроллер домена изолированного леса не реплицируется с локальными контроллерами домена, что позволяет уменьшить объем генерируемого системой исходящего сетевого трафика, а значит, и сократить затраты. Дополнительные сведения о ценах на использование сетевого трафика см. в статье [Цены Azure](http://azure.microsoft.com/pricing/).

В качестве другого примера предположим, что для службы предусмотрены требования к конфиденциальности, но ее работа зависит от доступа к внутренней службе Windows Server Active Directory. Если данные для службы можно размещать в облаке, вы можете развернуть новый дочерний домен для внутреннего леса в Azure. В этом случае контроллер домена можно развернуть для этого дочернего домена (без глобального каталога, чтобы обеспечить конфиденциальность). В этом сценарии, как и при развертывании реплики контроллера домена, требуется виртуальная сеть для подключения к локальным контроллерам доменов.

При создании нового леса необходимо выбрать тип доверительных отношений — [с Active Directory](https://technet.microsoft.com/library/cc771397) или [с федерацией](https://technet.microsoft.com/library/dd807036). Согласуйте требования с целевыми показателями совместимости, безопасности, затрат и устойчивости, а также с нормативными требованиями. Например, чтобы воспользоваться преимуществами [выборочной проверки подлинности](https://technet.microsoft.com/library/cc755844) , можно развернуть новый лес в Azure и создать отношения доверия Windows Server Active Directory с локальным и облачным лесами. Однако если приложение поддерживает утверждения, вместо отношений доверия с лесом Active Directory можно развернуть отношения доверия с федерацией. Кроме того, следует сравнить затраты на репликацию данных большего объема при подключении локальной службы Windows Server Active Directory к облаку с затратами, которые влечет генерирование большего объема исходящего трафика из-за нагрузки в связи с проверкой подлинности и отправкой запросов.

На выбор способа настройки также влияют требования к доступности и отказоустойчивости. Например, если связь разорвана, работа приложений, использующих отношения доверия с Kerberos или федерацией, скорее всего, будет нарушена. Этого можно избежать, если в Azure развернута достаточная инфраструктура. При использовании альтернативных конфигураций развертывания, например с репликой контроллеров домена (с возможностью записи или только для чтения), такое прерывание связи не будет критическим.

### <a name="BKMK_ADSiteTopology"></a>Топология сайтов Windows Server Active Directory
Чтобы оптимизировать трафик и снизить затраты, необходимо должным образом задать сайты и связи между ними. Сайты, связи сайтов и подсети влияют на топологию репликации между контроллерами домена и поток трафика проверки подлинности. Рассмотрите затраты на использование трафика ниже, а затем разверните и настройте контроллеры домена согласно требованиям сценария развертывания.

* За час использования шлюза взимается номинальная плата.
  
  * Его можно запустить и остановить по своему усмотрению.
  * В случае остановки виртуальные машины Azure будут изолированы от корпоративной сети.
* Входящий трафик бесплатный.
* Плата за исходящий трафик взимается согласно ценам в статье [Цены Azure](http://azure.microsoft.com/pricing/). Ниже приведены рекомендации, которые помогут оптимизировать свойства связей между локальными и облачными сайтами.
  
  * Если вы используете несколько виртуальных сетей, настройте связи между сайтами и связанные с ними затраты таким образом, чтобы службы Windows Server AD DS использовали сайты, которые предоставляют необходимый уровень обслуживания бесплатно, а не платные сайты Azure. Кроме того, можно отключить функцию создания мостов для всех связей сайтов (включена по умолчанию). Если ее отключить, друг с другом будут реплицироваться только напрямую подключенные сайты. Контроллеры домена сайтов, подключенных транзитивно, не могут реплицироваться друг с другом напрямую, но должны выполнять репликацию с помощью общего сайта или сайтов. Если по какой-то причине эти промежуточные сайты становятся недоступными, репликация между контроллерами домена транзитивно подключенных сайтов не будет выполняться, даже если между ними есть подключение. Наконец, если режим транзитивной репликации является подходящим, следует создать мосты связей сайтов, которые содержат соответствующие связи и сайты (например, локальные среды и сайты корпоративной сети).
  * [Укажите ограничения расходов в отношении связей сайтов](https://technet.microsoft.com/library/cc794882), чтобы избежать непредусмотренного трафика. Если параметр **Попробовать следующий ближайший сайт** включен, убедитесь, что сайты виртуальной сети не являются ближайшими. Для этого увеличьте затраты на объект связи сайтов, который подключает сайт Azure обратно к корпоративной сети.
  * Настройте [интервалы](https://technet.microsoft.com/library/cc794878) и [расписания](https://technet.microsoft.com/library/cc816906) установки связей сайтов в соответствии с требованиями к согласованности и частоте изменений объекта. Расписание репликации должно предусматривать задержку. Контроллеры домена выполняют репликацию только последнего состояния значения, поэтому при достаточной частоте изменения объекта можно сэкономить затраты путем сокращения интервала репликации.
* Чтобы снизить затраты, настройте расписание репликации и отключите уведомления об изменениях. Это конфигурация по умолчанию при репликации между сайтами. Хотя это не имеет значения при развертывании контроллера домена только для чтения в виртуальной сети, так как он не выполняет репликацию исходящих изменений, при развертывании контроллера домена с возможностью записи связь сайтов не должна быть настроена для репликации обновлений с нежелаемой частотой. Если вы развертываете сервер глобального каталога, каждый сайт с глобальным каталогом должен выполнять репликацию разделов домена из исходного контроллера домена на сайт, который подключен с использованием связи или связей сайтов, что влечет меньшие затраты, чем глобальный каталог на сайте Azure.
* Чтобы еще больше уменьшить сетевой трафик репликации между сайтами, можно сменить алгоритм сжатия репликации. Алгоритм сжатия настраивается с помощью записи реестра REG_DWORD: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters\Replicator compression algorithm. Значение по умолчанию — 3. Если задано это значение, используется алгоритм сжатия Xpress. Можно изменить значение на 2. Тогда будет использоваться алгоритм MSZip. В большинстве случаев после этого сжатие увеличится, но это повлияет на загрузку ЦП. Дополнительные сведения см. в статье [How Active Directory replication topology works](https://technet.microsoft.com/library/cc755994) (Принципы работы топологии репликации Active Directory).

### <a name="BKMK_IPAddressDNS"></a>Назначение IP-адресов и DNS
По умолчанию для виртуальных машин Azure выделяются адреса по протоколу DHCP на определенный срок аренды. Так как динамические адреса виртуальной сети Azure сохраняются на все время существования виртуальной машины, требования к службам Windows Server AD DS соблюдаются.

При использовании динамического адреса в Azure вы фактически используете статический IP-адрес, так как он назначается на период аренды и этот период совпадает со временем существования облачной службы.

Однако после завершении работы виртуальной машины динамический адрес освобождается. Чтобы предотвратить освобождение IP-адреса, [назначайте статический IP-адрес, используя командлет Set-AzureStaticVNetIP](http://social.technet.microsoft.com/wiki/contents/articles/23447.how-to-assign-a-private-static-ip-to-an-azure-vm.aspx).

Для разрешения имен следует развернуть собственную (или использовать существующую) инфраструктуру DNS-сервера. DNS-сервер, предоставляемый Azure, не соответствует требованиям Windows Server AD DS к разрешению имен. Например, он не поддерживает динамические записи SRV и т. п. Разрешение имени — это критически важный компонент настройки контроллеров домена и присоединенных к домену клиентов. Контроллеры домена должны регистрировать записи ресурсов и разрешать другие записи контроллера домена.
Чтобы обеспечить отказоустойчивость и оптимальную производительность, установите службу DNS Windows Server на контроллерах домена в Azure. Затем настройте свойства виртуальной сети Azure, указав имя и IP-адрес DNS-сервера. При запуске других виртуальных машин в виртуальной сети параметры сопоставителя клиента DNS будут настроены с помощью DNS-сервера в рамках выделения динамических IP-адресов.

> [!NOTE]
> Нельзя присоединить локальные компьютеры к размещенному в Azure домену Active Directory служб Windows Server AD DS напрямую через Интернет. В связи с требованиями к портам для Active Directory и операции присоединения к домену нецелесообразно открывать прямой доступ к нужным портам и, в сущности, всему контроллеру домена в Интернете.
> 
> 

При запуске или изменении DNS-имя виртуальных машин регистрируется автоматически.

Дополнительные сведения об этом примере и других примерах подготовки первой виртуальной машины и установки на ней служб AD DS см. в статье [Установка нового леса Active Directory в виртуальной сети Azure](active-directory-new-forest-virtual-machine.md). Дополнительные сведения об использовании Windows PowerShell см. в разделах [Справка по Azure PowerShell](/powershell/azureps-cmdlets-docs) и [Azure Management Cmdlets](/powershell/module/azurerm.compute/#virtual_machines) (Командлеты управления Azure).

### <a name="BKMK_DistributedDCs"></a>Географически распределенные контроллеры домена
Преимущества размещения нескольких контроллеров домена в разных виртуальных сетях Azure:

* отказоустойчивость нескольких сайтов;
* близкое расположение к филиалам (меньшая задержка).

Дополнительные сведения о настройке прямой связи между виртуальными сетями см. в статье о [настройке подключения между виртуальными сетями](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md).

### <a name="BKMK_RODC"></a>Контроллеры доменов только для чтения
Необходимо выбрать, какие контроллеры домена нужно развернуть: только для чтения или с возможностью записи. Возможно, вы захотите развернуть контроллеры домена только для чтения, так как вам не нужно будет ними управлять, но они предназначены для развертывания в расположениях с риском для их физической безопасности, например в филиалах.

В Azure риск для физической безопасности филиала отсутствует, но контроллеры домена только для чтения могут оказаться более экономически выгодными, потому что по совершенно другим причинам их функции хорошо подходят для этих сред. Например, они не предусматривают исходящую репликацию и могут заполнять секретные коды (пароли) выборочно. Отрицательным моментом является то, что при недостатке этих секретных кодов может потребоваться исходящий трафик по требованию для выполнения проверки подлинности пользователя или компьютера. Но секретные коды можно заполнить предварительно и кэшировать.

Еще одно преимущество контроллеров домена только для чтения — это возможность добавить атрибуты, которые содержат конфиденциальные (личные или критически важные для бизнеса) данные, в отфильтрованный набор атрибутов (FAS). Этот настраиваемый набор содержит атрибуты, которые не реплицируются в контроллеры домена только для чтения. Отфильтрованный набор атрибутов можно использовать в качестве меры предосторожности, если вы не хотите использовать или не можете хранить конфиденциальные данные в Azure. Дополнительные сведения см. в разделе об [отфильтрованном наборе атрибутов контроллеров домена только для чтения[(https://technet.microsoft.com/library/cc753459)].

Приложения должны быть совместимы с используемыми контроллерами домена только для чтения. Многие приложения, работающие с Windows Server Active Directory, совместимы с контроллерами домена только для чтения, но некоторые приложения могут работать не оптимально или завершаться сбоями при отсутствии доступа к контроллеру домена с возможностью записи. Дополнительные сведения см. в статье [Read-Only DCs application compatibility guide](https://technet.microsoft.com/library/cc755190) (Совместимость приложений с контроллерами домена только для чтения).

### <a name="BKMK_GC"></a>Глобальный каталог
Необходимо выбрать, следует ли устанавливать глобальный каталог. В лесу с одним доменом необходимо настроить все контроллеры домена в качестве серверов глобального каталога. Это не увеличит затраты, так как не влечет за собой дополнительный трафик репликации.

Глобальные каталоги в лесу с несколькими доменами необходимы для расширения членства в универсальных группах во время процесса проверки подлинности. Если вы не развертываете глобальный каталог, при каждой попытке проверки подлинности рабочие нагрузки в виртуальной сети, проходящие проверку подлинности в контроллере домена в Azure, будут косвенно формировать исходящий трафик проверки подлинности для запроса локальных глобальных каталогов.

Трудно предугадать затраты на глобальный каталог, так как они отвечают за размещение каждого домена (частично). Если в рамках рабочей нагрузки размещается служба с выходом в Интернет и выполняется проверка подлинности пользователей в Windows Server AD DS, затраты будут совершенно непредсказуемыми. Чтобы уменьшить запросы глобального каталога за пределами облачного сайта при проверке подлинности, [включите кэширование членства в универсальных группах](https://technet.microsoft.com/library/cc816928).

### <a name="BKMK_InstallMethod"></a>Метод установки
Необходимо выбрать способ установки контроллеров домена в виртуальной сети:

* Повышение уровня новых контроллеров домена. Дополнительные сведения см. в статье [Установка нового леса Active Directory в виртуальной сети Azure](active-directory-new-forest-virtual-machine.md).
* Перемещение виртуального жесткого диска локального виртуального контроллера домена в облако. В этом случае локальный виртуальный контроллер домена должен быть именно перемещен, а не копирован или клонирован.

Для контроллеров домена следует использовать только виртуальные машины Azure (а не виртуальные машины с рабочей ролью или веб-ролью). Они надежные, а эта характеристика необходима для контроллера домена. Виртуальные машины Azure предназначены для таких рабочих нагрузок, как операции с контроллерами домена.

Не используйте средство SYSPREP для развертывания или клонирования контроллеров домена. Возможность клонирования контроллеров домена предусмотрена в Windows Server, начиная с версии 2012. Для функции клонирования требуется поддержка идентификатора VMGenerationID в базовой низкоуровневой оболочке. Hyper-V в составе Windows Server 2012 и виртуальные сети Azure поддерживают этот идентификатор, как и сторонние поставщики программного обеспечения виртуализации.

### <a name="BKMK_PlaceDB"></a>Размещение базы данных и SYSVOL служб Windows Server AD DS
Выберите место размещения базы данных, журналов и SYSVOL служб Windows Server AD DS. Они должны быть развернуты на дисках данных Azure.

> [!NOTE]
> Размер дисков данных Azure составляет 1 ТБ.
> 
> 

По умолчанию диски данных не кэшируют операции записи. В дисках данных, подключенных к виртуальной машине, используется кэширование со сквозной записью. Кэширование со сквозной записью гарантирует запись в надежную службу хранилища Azure до завершения транзакции с точки зрения операционной системы виртуальной машины. Это обеспечивает надежность, хотя и за счет скорости операций записи.

Это важно для Windows Server AD DS, так как кэширование диска с задержкой записи сводит на нет предположения контроллера домена. Windows Server AD DS пытается отключить кэширование записи, но это зависит от системы операций ввода-вывода на диске. При определенных обстоятельствах сбой отключения кэширования записи вызывает откат USN, а это приводит к появлению устаревших объектов и другим проблемам.

Для виртуальных контроллеров домена рекомендуется сделать следующее:

* Установить для параметра настройки кэша узла на диске данных Azure значение "Нет". Это позволяет предотвратить проблемы с кэшированием записи для операций AD DS.
* Храните базу данных, журналы и SYSVOL на одном или на отдельных дисках данных. Как правило, используется не диск с операционной системой. Главное, база данных и SYSVOL служб Windows Server AD DS не должны храниться на диске операционной системы Azure. По умолчанию в процессе установки AD DS эти компоненты устанавливаются в папку %systemroot%, что НЕ рекомендуется для Azure.

### <a name="BKMK_BUR"></a>Резервное копирование и восстановление
Следует учитывать, что поддерживается и не поддерживается для резервного копирования и восстановления контроллеров домена в целом и для контроллеров домена, запущенных на виртуальной машине, в частности. Дополнительные сведения см. в статье [Backup and Restore Considerations for Virtualized DCs](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv#backup_and_restore_considerations_for_virtualized_domain_controllers) (Особенности архивации и восстановления виртуализированных контроллеров домена).

Создайте резервные копии состояния системы с помощью программного обеспечения для архивации, которое поддерживает требования для резервного копирования Windows Server AD DS (например, с помощью системы архивации данных Windows Server).

Не копируйте и не клонируйте VHD-файлы контроллеров домена вместо регулярного создания резервных копий. Если потребуется восстановление, при использовании скопированных или клонированных VHD-файлов отдельно от Windows Server 2012 и поддерживаемой низкоуровневой оболочки создаются USN-пузыри.

### <a name="BKMK_FedSrvConfig"></a>Настройка сервера федерации
Настройка серверов федерации (служб маркеров безопасности) служб Windows Server AD FS отчасти зависит от того, требуется ли для развертываемых в Azure приложениях доступ к ресурсам локальной сети.

Если приложения отвечают следующим условиям, их можно развернуть отдельно от локальной сети:

* они принимают маркеры безопасности SAML;
* они доступны в Интернете;
* они не осуществляют доступ к локальным ресурсам.

В этом случае службы маркеров безопасности Windows Server AD FS нужно настроить следующим образом:

1. Настройте изолированный лес с одним доменом в Azure.
2. Обеспечьте федеративный доступ к лесу, настроив ферму сервера федерации Windows Server AD FS.
3. Настройте службы Windows Server AD FS (ферму сервера федерации и ферму прокси-сервера федерации) в локальном лесу.
4. Установите федеративные отношения доверия между локальными экземплярами и экземплярами Azure служб Windows Server AD FS.

В свою очередь, если приложениям требуется доступ к локальным ресурсам, настройте службы Windows Server AD FS с использованием приложения в Azure следующим образом:

1. Настройте подключение между локальными сетями и Azure.
2. Настройте ферму сервера федерации служб Windows Server AD FS в локальном лесу.
3. Настройте ферму прокси-сервера федерации служб AD FS Windows Server в Azure.

Эта настройка удобна тем, что позволяет предотвратить доступ к локальным ресурсам, аналогично настройке служб Windows Server AD FS с приложениями в сети периметра.

Отметим, что в любом сценарии для взаимодействия типа "бизнес-бизнес" можно установить отношения доверия с дополнительными поставщиками удостоверений.

### <a name="BKMK_CloudSvcConfig"></a>Настройка облачных служб
Если вы хотите предоставить доступ к виртуальной машине напрямую через Интернет или предоставить доступное в Интернете приложение с балансировкой нагрузки, вам понадобятся облачные службы. Это возможно, потому что для каждой облачной службой предоставляется один настраиваемый виртуальный IP-адрес.

### <a name="BKMK_FedReqVIPDIP"></a>Требования сервера федерации в отношении общих и частных IP-адресов (динамические и виртуальные IP-адреса)
Каждой виртуальной машине Azure присваивается динамический IP-адрес. Это частный адрес, который доступен только в Azure. Однако в большинстве случаев для развертываний служб Windows Server AD FS необходимо настроить виртуальный IP-адрес. Виртуальный IP-адрес необходим для предоставления доступа к конечным точкам Windows Server AD FS в Интернете. Его будут использовать федеративные партнеры и клиенты для проверки подлинности и постоянного управления. Этот адрес является свойством облачной службы, в которую входит одна или несколько виртуальных машин Azure. Если поддерживающее утверждения приложение, развернутое в Azure, и Windows Server AD FS доступны в Интернете и используют общие порты, им потребуется собственный виртуальный IP-адрес. Кроме того, понадобится создать одну облачную службу для приложения и вторую — для Windows Server AD FS.

Определения виртуального и динамического IP-адресов см. в разделе [Термины и определения](#BKMK_Glossary).

### <a name="BKMK_ADFSHighAvail"></a>Настройка высокой доступности Windows Server AD FS
Хотя можно развернуть автономные службы федерации Windows Server AD FS, для рабочих сред рекомендуется развернуть ферму с по меньшей мере двумя узлами для службы маркеров безопасности AD FS и прокси-серверов.

Чтобы выбрать варианты настройки развертывания, которые наилучшим образом соответствуют вашим потребностям, см. раздел [AD FS 2.0 deployment topology considerations](https://technet.microsoft.com/library/gg982489) (Некоторые аспекты топологии развертывания AD FS 2.0) в руководстве [AD FS 2.0 Design Guide](https://technet.microsoft.com/library/dd807036) (Руководство по разработке служб AD FS 2.0).

> [!NOTE]
> Чтобы настроить балансировку нагрузки для конечных точек Windows Server AD FS в Azure, следует настроить всех членов фермы Windows Server AD FS в той же облачной службе и использовать балансировку нагрузки Azure для портов HTTP (по умолчанию — 80) и HTTPS (по умолчанию — 443). Дополнительные сведения см. в статье [LoadBalancerProbe Schema](https://msdn.microsoft.com/library/azure/jj151530) (Схема LoadBalancerProbe).
> Балансировка сетевой нагрузки Windows Server не поддерживается в Azure.
> 
> 


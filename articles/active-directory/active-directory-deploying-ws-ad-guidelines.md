---
title: "Рекомендации по развертыванию Windows Server Active Directory на виртуальных машинах Azure | Документация Майкрософт"
description: "Если вы знаете, как развернуть доменные службы и службы федерации AD в локальной среде, изучите принцип их работы на виртуальных машинах Azure."
services: active-directory
documentationcenter: 
author: femila
manager: femila
editor: 
ms.assetid: 04df4c46-e6b6-4754-960a-57b823d617fa
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 07/26/2017
ms.author: femila
ms.openlocfilehash: 342d9e2787add3d04f1b744152e135db98848179
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="guidelines-for-deploying-windows-server-active-directory-on-azure-virtual-machines"></a><span data-ttu-id="c9337-103">Рекомендации по развертыванию Windows Server Active Directory на виртуальных машинах Azure</span><span class="sxs-lookup"><span data-stu-id="c9337-103">Guidelines for deploying Windows Server Active Directory on Azure virtual machines</span></span>
<span data-ttu-id="c9337-104">В этой статье описываются важные различия локального развертывания доменных служб Windows Server Active Directory (AD DS) и служб федерации Active Directory (AD FS) по сравнению с их развертыванием на виртуальных машинах Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-104">This article explains the important differences between deploying Windows Server Active Directory Domain Services (AD DS) and Active Directory Federation Services (AD FS) on-premises versus deploying them on Microsoft Azure virtual machines.</span></span>

## <a name="scope-and-audience"></a><span data-ttu-id="c9337-105">Область и аудитория</span><span class="sxs-lookup"><span data-stu-id="c9337-105">Scope and audience</span></span>
<span data-ttu-id="c9337-106">Эта статья предназначена для тех, у кого уже есть опыт локального развертывания Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-106">The article is intended for those already experienced with deploying Active Directory on-premises.</span></span> <span data-ttu-id="c9337-107">Здесь описываются отличия развертывания Active Directory на виртуальных машинах Microsoft Azure и в виртуальных сетях Azure от традиционного локального развертывания.</span><span class="sxs-lookup"><span data-stu-id="c9337-107">It covers the differences between deploying Active Directory on Microsoft Azure virtual machines/Azure virtual networks and traditional on-premises Active Directory deployments.</span></span> <span data-ttu-id="c9337-108">Виртуальные машины и виртуальные сети Azure предоставляются организациям в составе инфраструктуры как услуги (IaaS), предназначенной для использования вычислительных ресурсов в облаке.</span><span class="sxs-lookup"><span data-stu-id="c9337-108">Azure virtual machines and Azure virtual networks are part of an Infrastructure-as-a-Service (IaaS) offering for organizations to leverage computing resources in the cloud.</span></span>

<span data-ttu-id="c9337-109">Если у вас нет опыта развертывания AD, см. разделы [AD DS Deployment Guide](https://technet.microsoft.com/library/cc753963) (Руководство по развертыванию AD DS) или [Планирование развертывания служб федерации Active Directory](https://technet.microsoft.com/library/dn151324.aspx) соответственно.</span><span class="sxs-lookup"><span data-stu-id="c9337-109">For those that are not familiar with AD deployment, see the [AD DS Deployment Guide](https://technet.microsoft.com/library/cc753963) or [Plan your AD FS deployment](https://technet.microsoft.com/library/dn151324.aspx) as appropriate.</span></span>

<span data-ttu-id="c9337-110">В этой статье предполагается, что читатель знаком со следующими концепциями:</span><span class="sxs-lookup"><span data-stu-id="c9337-110">This article assumes that the reader is familiar with the following concepts:</span></span>

* <span data-ttu-id="c9337-111">развертывание служб Windows Server AD DS и управление ими;</span><span class="sxs-lookup"><span data-stu-id="c9337-111">Windows Server AD DS deployment and management</span></span>
* <span data-ttu-id="c9337-112">развертывание и настройка DNS для поддержки инфраструктуры Windows Server AD DS;</span><span class="sxs-lookup"><span data-stu-id="c9337-112">Deployment and configuration of DNS to support a Windows Server AD DS infrastructure</span></span>
* <span data-ttu-id="c9337-113">развертывание служб Windows Server AD FS и управление ими;</span><span class="sxs-lookup"><span data-stu-id="c9337-113">Windows Server AD FS deployment and management</span></span>
* <span data-ttu-id="c9337-114">развертывание и настройка приложений проверяющей стороны (веб-сайтов и веб-служб), которые могут использовать маркеры Windows Server AD FS, а также управление ими;</span><span class="sxs-lookup"><span data-stu-id="c9337-114">Deploying, configuring, and managing relying party applications (websites and web services) that can consume Windows Server AD FS tokens</span></span>
* <span data-ttu-id="c9337-115">настройка виртуальной машины, виртуальных дисков и виртуальных сетей, а также с другими общими концепциями использования виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="c9337-115">General virtual machine concepts, such as how to configure a virtual machine, virtual disks, and virtual networks</span></span>

<span data-ttu-id="c9337-116">В этой статье приводятся требования для гибридного развертывания, при котором службы Windows Server AD DS или AD FS развертываются частично локально и частично на виртуальных машинах Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-116">This article highlights the requirements for a hybrid deployment scenario in which Windows Server AD DS or AD FS are partly deployed on-premises and partly deployed on Azure virtual machines.</span></span> <span data-ttu-id="c9337-117">Сначала описываются важные различия между запуском служб AD DS и AD FS Windows Server на виртуальных машинах Azure и их запуском в локальной сети, а также рассматриваются важные моменты, которые влияют на проектирование и развертывание системы.</span><span class="sxs-lookup"><span data-stu-id="c9337-117">The document first covers the critical differences between running Windows Server AD DS and AD FS on Azure virtual machines versus on-premises, and important decision points that affect design and deployment.</span></span> <span data-ttu-id="c9337-118">В остальной части предоставляются более подробные рекомендации по принятию решений на каждом важном этапе и по применению рекомендаций в различных сценариях развертывания.</span><span class="sxs-lookup"><span data-stu-id="c9337-118">The rest of the paper explains guidelines for each of the decision points in more detail, and how to apply the guidelines to various deployment scenarios.</span></span>

<span data-ttu-id="c9337-119">Эта статья не охватывает обсуждение конфигурации [Azure Active Directory](http://azure.microsoft.com/services/active-directory/), службы на основе интерфейса REST, которая предоставляет возможности для управления удостоверениями и контроля доступом в облачных приложениях.</span><span class="sxs-lookup"><span data-stu-id="c9337-119">This article does not discuss the configuration of [Azure Active Directory](http://azure.microsoft.com/services/active-directory/), which is a REST-based service that provides identity management and access control capabilities for cloud applications.</span></span> <span data-ttu-id="c9337-120">Тем не менее Azure AD и Windows Server AD DS предназначены для совместной работы с целью предоставления решения по управлению удостоверениями и доступом для современных гибридных ИТ-сред и приложений.</span><span class="sxs-lookup"><span data-stu-id="c9337-120">Azure Active Directory (Azure AD) and Windows Server AD DS are, however, designed to work together to provide an identity and access management solution for today’s hybrid IT environments and modern applications.</span></span> <span data-ttu-id="c9337-121">Чтобы понять, чем отличаются Windows Server AD DS и Azure AD, а также связь между ними, нужно учесть следующее:</span><span class="sxs-lookup"><span data-stu-id="c9337-121">To help understand the differences and relationships between Windows Server AD DS and Azure AD, consider the following:</span></span>

1. <span data-ttu-id="c9337-122">Windows Server AD DS можно запускать в облаке на виртуальных машинах Azure, если вы используете Azure, чтобы расширить локальный центр обработки данных для работы в облаке.</span><span class="sxs-lookup"><span data-stu-id="c9337-122">You might run Windows Server AD DS in the cloud on Azure virtual machines when you are using Azure to extend your on-premises datacenter into the cloud.</span></span>
2. <span data-ttu-id="c9337-123">Azure AD можно использовать, чтобы предоставить пользователям возможность единого входа в приложения типа "Программное обеспечение как услуга" (SaaS).</span><span class="sxs-lookup"><span data-stu-id="c9337-123">You might use Azure AD to give your users single sign-on to Software-as-a-Service (SaaS) applications.</span></span> <span data-ttu-id="c9337-124">Эта технология используется, например, в Microsoft Office 365, а также в приложениях, работающих на платформе Azure и других облачных платформах.</span><span class="sxs-lookup"><span data-stu-id="c9337-124">Microsoft Office 365 uses this technology, for example, and applications running on Azure or other cloud platforms can also use it.</span></span>
3. <span data-ttu-id="c9337-125">Вы также можете настроить Azure AD (ее службу контроля доступа), чтобы позволить пользователям входить в облачные и локальные приложения, используя удостоверения Facebook, Google, Майкрософт и других поставщиков удостоверений.</span><span class="sxs-lookup"><span data-stu-id="c9337-125">You might use Azure AD (its Access Control Service) to let users sign in using identities from Facebook, Google, Microsoft, and other identity providers to applications that are hosted in the cloud or on-premises.</span></span>

<span data-ttu-id="c9337-126">Дополнительные сведения об этих различиях см. в статье об [удостоверениях Azure](fundamentals-identity.md).</span><span class="sxs-lookup"><span data-stu-id="c9337-126">For more information about these differences, see [Azure Identity](fundamentals-identity.md).</span></span>

## <a name="related-resources"></a><span data-ttu-id="c9337-127">Связанные ресурсы</span><span class="sxs-lookup"><span data-stu-id="c9337-127">Related resources</span></span>
<span data-ttu-id="c9337-128">Вы можете скачать и запустить средство [оценки готовности виртуальной машины Azure](https://www.microsoft.com/download/details.aspx?id=40898).</span><span class="sxs-lookup"><span data-stu-id="c9337-128">You may download and run the [Azure Virtual Machine Readiness Assessment](https://www.microsoft.com/download/details.aspx?id=40898).</span></span> <span data-ttu-id="c9337-129">Этот инструмент оценки автоматически проверит локальную среду и создаст настраиваемый отчет на основе рекомендаций из этого руководства, чтобы помочь вам перенести свою среду в Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-129">The assessment will automatically inspect your on-premises environment and generate a customized report based on the guidance found in this topic to help you migrate the environment to Azure.</span></span>

<span data-ttu-id="c9337-130">Рекомендуем сначала изучить руководства, рекомендации и видеоролики, охватывающие следующие темы:</span><span class="sxs-lookup"><span data-stu-id="c9337-130">We recommend that you also first review the tutorials, guides, and videos that cover the following topics:</span></span>

* [<span data-ttu-id="c9337-131">настройка виртуальной сети только для облака на портале Azure</span><span class="sxs-lookup"><span data-stu-id="c9337-131">Configure a Cloud-Only Virtual Network in the Azure Portal</span></span>](../virtual-network/virtual-networks-create-vnet-arm-pportal.md)
* [<span data-ttu-id="c9337-132">настройка VPN типа "cеть-сеть" на портале Azure</span><span class="sxs-lookup"><span data-stu-id="c9337-132">Configure a Site-to-Site VPN in the Azure Portal</span></span>](../vpn-gateway/vpn-gateway-site-to-site-create.md)
* [<span data-ttu-id="c9337-133">Установка нового леса Active Directory в виртуальной сети Azure</span><span class="sxs-lookup"><span data-stu-id="c9337-133">Install a new Active Directory forest on an Azure virtual network</span></span>](active-directory-new-forest-virtual-machine.md)
* [<span data-ttu-id="c9337-134">установка реплики контроллера домена Active Directory в Azure;</span><span class="sxs-lookup"><span data-stu-id="c9337-134">Install a replica Active Directory domain controller on Azure</span></span>](active-directory-install-replica-active-directory-domain-controller.md)
* [<span data-ttu-id="c9337-135">Microsoft Azure IaaS для профессионалов в сфере IT. (01) Основная информация о виртуальных машинах</span><span class="sxs-lookup"><span data-stu-id="c9337-135">Microsoft Azure IT Pro IaaS: (01) Virtual Machine Fundamentals</span></span>](https://channel9.msdn.com/Series/Windows-Azure-IT-Pro-IaaS/01)
* [<span data-ttu-id="c9337-136">Microsoft Azure IaaS для профессионалов в сфере IT. (05) Создание виртуальных сетей и подключений между организациями</span><span class="sxs-lookup"><span data-stu-id="c9337-136">Microsoft Azure IT Pro IaaS: (05) Creating Virtual Networks and Cross-Premises Connectivity</span></span>](https://channel9.msdn.com/Series/Windows-Azure-IT-Pro-IaaS/05)

## <a name="introduction"></a><span data-ttu-id="c9337-137">Введение</span><span class="sxs-lookup"><span data-stu-id="c9337-137">Introduction</span></span>
<span data-ttu-id="c9337-138">Основные требования в отношении развертывания Windows Server Active Directory на виртуальных машинах Azure мало отличаются от требований для локального развертывания этой службы на виртуальных машинах (и в некоторой степени на физических компьютерах).</span><span class="sxs-lookup"><span data-stu-id="c9337-138">The fundamental requirements for deploying Windows Server Active Directory on Azure virtual machines differ very little from deploying it in on-premises virtual machines (and, to some extent, physical machines).</span></span> <span data-ttu-id="c9337-139">Например, при использовании Windows Server AD DS, если контроллеры домена, развертываемые на виртуальных машинах Azure, являются репликами в существующем локальном корпоративном домене или лесу, то развертывание Azure можно в основном проводить аналогично этому процессу для дополнительного сайта Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-139">For example, in the case of Windows Server AD DS, if the domain controllers (DCs) that you deploy on Azure virtual machines are replicas in an existing on-premises corporate domain/forest, then the Azure deployment can largely be treated in the same way as you might treat any other additional Windows Server Active Directory site.</span></span> <span data-ttu-id="c9337-140">То есть необходимо определить подсети в Windows Server AD DS, создать сайт, связать с ним подсети, а их связать с другими сайтами с помощью соответствующих ссылок.</span><span class="sxs-lookup"><span data-stu-id="c9337-140">That is, subnets must be defined in Windows Server AD DS, a site created, the subnets linked to that site, and connected to other sites using appropriate site-links.</span></span> <span data-ttu-id="c9337-141">Но существует несколько различий, общих для всех развертываний Azure, и несколько различий, которые зависят от выбранного сценария развертывания.</span><span class="sxs-lookup"><span data-stu-id="c9337-141">There are, however, some differences that are common to all Azure deployments and some that vary according to the specific deployment scenario.</span></span> <span data-ttu-id="c9337-142">Ниже описываются два основных различия.</span><span class="sxs-lookup"><span data-stu-id="c9337-142">Two fundamental differences are outlined below:</span></span>

### <a name="azure-virtual-machines-may-need-connectivity-to-the-on-premises-corporate-network"></a><span data-ttu-id="c9337-143">Необходимость подключения виртуальных машин Azure к локальной корпоративной сети</span><span class="sxs-lookup"><span data-stu-id="c9337-143">Azure virtual machines may need connectivity to the on-premises corporate network.</span></span>
<span data-ttu-id="c9337-144">Чтобы подключить виртуальные машины Azure к локальной корпоративной сети, нужна виртуальная сеть Azure с компонентом VPN типа "сеть-сеть" или "точка-сеть", с помощью которого можно легко установить подключение между виртуальными машинами Azure и локальными компьютерами.</span><span class="sxs-lookup"><span data-stu-id="c9337-144">Connecting Azure virtual machines back to an on-premises corporate network requires Azure virtual network, which includes a site-to-site or site-to-point virtual private network (VPN) component able to seamlessly connect Azure virtual machines and on-premises machines.</span></span> <span data-ttu-id="c9337-145">При помощи этого компонента VPN можно также обеспечить доступ к домену Windows Server Active Directory, чьи контроллеры размещены только на виртуальных машинах Azure, для компьютеров-членов домена в локальной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-145">This VPN component could also enable on-premises domain member computers to access a Windows Server Active Directory domain whose domain controllers are hosted exclusively on Azure virtual machines.</span></span> <span data-ttu-id="c9337-146">Следует отметить, что, если VPN выйдет из строя, произойдет сбой проверки подлинности и других операций, которые зависят от работы Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-146">It is important to note, though, that if the VPN fails, authentication and other operations that depend on Windows Server Active Directory will also fail.</span></span> <span data-ttu-id="c9337-147">В этом случае пользователи смогут входить в систему, используя кэшированные учетные данные, но все одноранговые проверки подлинности и проверки подлинности клиента на сервере, для которых еще не выданы билеты или билеты которых устарели, будут завершаться сбоем.</span><span class="sxs-lookup"><span data-stu-id="c9337-147">While users may be able to sign in using existing cached credentials, all peer-to-peer or client-to-server authentication attempts for which tickets have yet to be issued or have become stale will fail.</span></span>

<span data-ttu-id="c9337-148">См. раздел [Виртуальная сеть](http://azure.microsoft.com/documentation/services/virtual-network/), где можно найти демонстрационные видео, а также список пошаговых учебников, включая статью [Создание виртуальной сети с подключением типа "сеть — сеть" с помощью портала Azure](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span><span class="sxs-lookup"><span data-stu-id="c9337-148">See [Virtual Network](http://azure.microsoft.com/documentation/services/virtual-network/) for a demonstration video and a list of step-by-step tutorials, including [Configure a Site-to-Site VPN in the Azure portal](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span></span>

> [!NOTE]
> <span data-ttu-id="c9337-149">Вы также можете развернуть Windows Server Active Directory в виртуальной сети Azure, которая не подключена к локальной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-149">You can also deploy Windows Server Active Directory on an Azure virtual network that does not have connectivity with an on-premises network.</span></span> <span data-ttu-id="c9337-150">В приведенных здесь рекомендациях подразумевается, что используется виртуальная сеть Azure, так как она предоставляет возможности IP-адресации, необходимые для работы Windows Server.</span><span class="sxs-lookup"><span data-stu-id="c9337-150">The guidelines in this topic, however, assume that an Azure virtual network is used because it provides IP addressing capabilities that are essential to Windows Server.</span></span>
> 
> 

### <a name="static-ip-addresses-must-be-configured-with-azure-powershell"></a><span data-ttu-id="c9337-151">Необходимость настройки статических IP-адресов в Azure PowerShell</span><span class="sxs-lookup"><span data-stu-id="c9337-151">Static IP addresses must be configured with Azure PowerShell.</span></span>
<span data-ttu-id="c9337-152">Динамические адреса выделяются по умолчанию, но вам нужно назначить статический IP-адрес, выполнив командлет AzureStaticVNetIP.</span><span class="sxs-lookup"><span data-stu-id="c9337-152">Dynamic addresses are allocated by default, but use the Set-AzureStaticVNetIP cmdlet to assign a static IP address instead.</span></span> <span data-ttu-id="c9337-153">Он устанавливает статический IP-адрес, который будет сохраняться при восстановлении работоспособности службы, а также при завершении работы и перезагрузке виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="c9337-153">That sets a static IP address that will persist through service healing and VM shutdown/restart.</span></span> <span data-ttu-id="c9337-154">Дополнительные сведения см. в записи блога [Static internal IP address for virtual machines](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/) (Настройка статического внутреннего IP-адреса для виртуальных машин).</span><span class="sxs-lookup"><span data-stu-id="c9337-154">For more information, see [Static internal IP address for virtual machines](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/).</span></span>

## <span data-ttu-id="c9337-155"><a name="BKMK_Glossary"></a>Термины и определения</span><span class="sxs-lookup"><span data-stu-id="c9337-155"><a name="BKMK_Glossary"></a>Terms and definitions</span></span>
<span data-ttu-id="c9337-156">Ниже приведен неполный список терминов различных технологий Azure, которые будут упоминаться в этой статье.</span><span class="sxs-lookup"><span data-stu-id="c9337-156">The following is a non-exhaustive list of terms for various Azure technologies which will be referenced in this article.</span></span>

* <span data-ttu-id="c9337-157">**Виртуальные машины Azure**— предложение IaaS в Azure, позволяющее клиентам развертывать виртуальные машины, способные справиться с практически любой стандартной серверной рабочей нагрузкой в локальной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-157">**Azure virtual machines**: The IaaS offering in Azure that allows customers to deploy VMs running nearly any traditionally on-premises server workload.</span></span>
* <span data-ttu-id="c9337-158">**Виртуальная сеть Azure**— сетевая служба в Azure, благодаря которой клиенты могут создавать виртуальные сети и управлять ими в Azure, а также безопасно связывать их со своей локальной сетевой инфраструктурой с помощью VPN.</span><span class="sxs-lookup"><span data-stu-id="c9337-158">**Azure virtual network**: The networking service in Azure that lets customers create and manage virtual networks in Azure and securely link them to their own on-premises networking infrastructure by using a virtual private network (VPN).</span></span>
* <span data-ttu-id="c9337-159">**Виртуальный IP-адрес**— IP-адрес для Интернета, который не связан с компьютером или сетевой картой.</span><span class="sxs-lookup"><span data-stu-id="c9337-159">**Virtual IP address**: An internet-facing IP address that is not bound to a specific computer or network interface card.</span></span> <span data-ttu-id="c9337-160">Виртуальный IP-адрес назначается облачным службам для приема сетевого трафика, который перенаправляется в виртуальную машину Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-160">Cloud services are assigned a virtual IP address for receiving network traffic which is redirected to an Azure VM.</span></span> <span data-ttu-id="c9337-161">Этот адрес является свойством облачной службы, в которую может входить одна или несколько виртуальных машин Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-161">A virtual IP address is a property of a cloud-service which can contain one or more Azure virtual machines.</span></span> <span data-ttu-id="c9337-162">Кроме того, обратите внимание, что в виртуальной сети Azure может работать одна или несколько облачных служб.</span><span class="sxs-lookup"><span data-stu-id="c9337-162">Also note that an Azure virtual network can contain one or more cloud-services.</span></span> <span data-ttu-id="c9337-163">Виртуальные IP-адреса обеспечивают системные возможности балансировки рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="c9337-163">Virtual IP addresses provide native load-balancing capabilities.</span></span>
* <span data-ttu-id="c9337-164">**Динамический IP-адрес**— это IP-адрес только для внутреннего использования.</span><span class="sxs-lookup"><span data-stu-id="c9337-164">**Dynamic IP address**: This is the IP address that is internal only.</span></span> <span data-ttu-id="c9337-165">Его следует настроить, как и статический IP-адрес (выполнив командлет Set-AzureStaticVNetIP), для виртуальных машин c ролями сервера контроллера домена или DNS.</span><span class="sxs-lookup"><span data-stu-id="c9337-165">It should be configured as a static IP address (by using the Set-AzureStaticVNetIP cmdlet) for VMs that host the DC/DNS server roles.</span></span>
* <span data-ttu-id="c9337-166">**Восстановление работоспособности службы**— процесс, при котором Azure автоматически возвращает службу в рабочее состояние, если обнаружит, что произошел сбой.</span><span class="sxs-lookup"><span data-stu-id="c9337-166">**Service healing**: The process in which Azure automatically returns a service to a running state again after it detects that the service has failed.</span></span> <span data-ttu-id="c9337-167">Это одна из функций Azure по обеспечению поддержки доступности и устойчивости.</span><span class="sxs-lookup"><span data-stu-id="c9337-167">Service healing is one of the aspects of Azure that supports availability and resiliency.</span></span> <span data-ttu-id="c9337-168">Маловероятно, но результат восстановления работоспособности службы для контроллера домена, работающего на виртуальной машине, будет таким же, как при незапланированной перезагрузке, но этот инцидент влечет несколько побочных явлений:</span><span class="sxs-lookup"><span data-stu-id="c9337-168">While unlikely, the result following a service healing incident for a DC running on a VM is similar to an unplanned reboot, but has a few side-effects:</span></span>
  
  * <span data-ttu-id="c9337-169">изменится виртуальный сетевой адаптер виртуальной машины;</span><span class="sxs-lookup"><span data-stu-id="c9337-169">The virtual network adapter in the VM will change</span></span>
  * <span data-ttu-id="c9337-170">изменится MAC-адрес виртуального сетевого адаптера;</span><span class="sxs-lookup"><span data-stu-id="c9337-170">The MAC address of the virtual network adapter will change</span></span>
  * <span data-ttu-id="c9337-171">изменится идентификатор процессора и ЦП виртуальной машины;</span><span class="sxs-lookup"><span data-stu-id="c9337-171">The Processor/CPU ID of the VM will change</span></span>
  * <span data-ttu-id="c9337-172">IP-конфигурация виртуального сетевого адаптера не изменится, если виртуальная машина подключена к виртуальной сети и у нее статический IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="c9337-172">The IP configuration of the virtual network adapter will not change as long as the VM is attached to a virtual network and the VM’s IP address is static.</span></span>
  
  <span data-ttu-id="c9337-173">На Windows Server Active Directory не повлияют эти обстоятельства, так как ее работа не зависит от MAC-адреса, а также идентификатора процессора или ЦП. Мы рекомендуем выполнять все развертывания Windows Server Active Directory в виртуальной сети Azure, как описано выше.</span><span class="sxs-lookup"><span data-stu-id="c9337-173">None of these behaviors affect Windows Server Active Directory because it has no dependency on the MAC address or Processor/CPU ID, and all Windows Server Active Directory deployments on Azure are recommended to be run on an Azure virtual network as outlined above.</span></span>

## <a name="is-it-safe-to-virtualize-windows-server-active-directory-domain-controllers"></a><span data-ttu-id="c9337-174">Безопасно ли виртуализировать контроллеры домена Windows Server Active Directory?</span><span class="sxs-lookup"><span data-stu-id="c9337-174">Is it safe to virtualize Windows Server Active Directory domain controllers?</span></span>
<span data-ttu-id="c9337-175">Для развертывания контроллеров домена Windows Server Active Directory на виртуальных машинах Azure действуют те же рекомендации, что и для локального запуска контроллеров домена на виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="c9337-175">Deploying Windows Server Active Directory DCs on Azure virtual machines is subject to the same guidelines as running DCs on-premises in a virtual machine.</span></span> <span data-ttu-id="c9337-176">Запуск виртуализированных контроллеров домена безопасен, если выполнены рекомендации по их резервному копированию и восстановлению.</span><span class="sxs-lookup"><span data-stu-id="c9337-176">Running virtualized DCs is a safe practice as long as guidelines for backing up and restoring DCs are followed.</span></span> <span data-ttu-id="c9337-177">Дополнительные сведения об ограничениях запуска виртуализированных контроллеров домена и рекомендации по нему см. в разделе [Работа контроллеров домена в среде Hyper-V](https://technet.microsoft.com/library/dd363553).</span><span class="sxs-lookup"><span data-stu-id="c9337-177">For more information about constraints and guidelines for running virtualized DCs, see [Running Domain Controllers in Hyper-V](https://technet.microsoft.com/library/dd363553).</span></span>

<span data-ttu-id="c9337-178">Низкоуровневые оболочки предоставляют и упрощают технологии, использование которых может создавать проблемы во многих распределенных системах, в том числе в Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-178">Hypervisors provide or trivialize technologies that can cause problems for many distributed systems, including Windows Server Active Directory.</span></span> <span data-ttu-id="c9337-179">Например, на физическом сервере можно клонировать диск или использовать неподдерживаемые методы для отката состояния сервера, в том числе использовать SAN и т. п., но сделать это на физическом сервере гораздо сложнее, чем восстановить виртуальную машину из моментального снимка в низкоуровневой оболочке.</span><span class="sxs-lookup"><span data-stu-id="c9337-179">For example, on a physical server, you can clone a disk or use unsupported methods to roll back the state of a server, including using SANs and so on, but doing that on a physical server is much harder than restoring a virtual machine snapshot in a hypervisor.</span></span> <span data-ttu-id="c9337-180">Azure предлагает функции, которые могут привести к подобному нежелательному состоянию.</span><span class="sxs-lookup"><span data-stu-id="c9337-180">Azure offers functionality that can result in the same undesirable condition.</span></span> <span data-ttu-id="c9337-181">Например, не следует копировать VHD-файлы контроллеров домена вместо регулярного создания резервных копий, так как их восстановление может дать те же результаты, что и использование функций восстановления моментальных снимков.</span><span class="sxs-lookup"><span data-stu-id="c9337-181">For example, you should not copy VHD files of DCs instead of performing regular backups because restoring them can result in a similar situation to using snapshot restore features.</span></span>

<span data-ttu-id="c9337-182">Подобные откаты создают USN-пузыри (отличия номеров последовательного обновления), что может повлечь переход контроллеров домена в постоянное отклоняющееся состояние.</span><span class="sxs-lookup"><span data-stu-id="c9337-182">Such rollbacks introduce USN bubbles that can lead to permanently divergent states between DCs.</span></span> <span data-ttu-id="c9337-183">Кроме того, могут возникнуть такие проблемы:</span><span class="sxs-lookup"><span data-stu-id="c9337-183">That can cause issues such as:</span></span>

* <span data-ttu-id="c9337-184">наличие устаревших объектов;</span><span class="sxs-lookup"><span data-stu-id="c9337-184">Lingering objects</span></span>
* <span data-ttu-id="c9337-185">наличие несогласованных паролей;</span><span class="sxs-lookup"><span data-stu-id="c9337-185">Inconsistent passwords</span></span>
* <span data-ttu-id="c9337-186">наличие несогласованных значений атрибутов;</span><span class="sxs-lookup"><span data-stu-id="c9337-186">Inconsistent attribute values</span></span>
* <span data-ttu-id="c9337-187">несоответствия в схеме при откате хозяина схемы.</span><span class="sxs-lookup"><span data-stu-id="c9337-187">Schema mismatches if the schema master is rolled back</span></span>

<span data-ttu-id="c9337-188">Дополнительные сведения о влиянии на контроллеры домена см. в разделе об [USN и откате USN](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv.aspx#usn_and_usn_rollback).</span><span class="sxs-lookup"><span data-stu-id="c9337-188">For more information about how DCs are impacted, see [USN and USN Rollback](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv.aspx#usn_and_usn_rollback).</span></span>

<span data-ttu-id="c9337-189">Начиная с Windows Server 2012, в [AD DS предусмотрены дополнительные меры безопасности](https://technet.microsoft.com/library/hh831734.aspx).</span><span class="sxs-lookup"><span data-stu-id="c9337-189">Beginning with Windows Server 2012, [additional safeguards are built in to AD DS](https://technet.microsoft.com/library/hh831734.aspx).</span></span> <span data-ttu-id="c9337-190">Эти меры безопасности помогают защитить виртуализированные контроллеры домена от возникновения вышеуказанных проблем при условии, что базовая платформа низкоуровневой оболочки поддерживает VM-GenerationID.</span><span class="sxs-lookup"><span data-stu-id="c9337-190">These safeguards help protect virtualized domain controllers against the aforementioned problems, as long as the underlying hypervisor platform supports VM-GenerationID.</span></span> <span data-ttu-id="c9337-191">Azure поддерживает VM-GenerationID, а это значит, что контроллеры доменов, которые работают под управлением Windows Server 2012 или более поздних версий на виртуальных машинах Azure, будут защищены дополнительными мерами безопасности.</span><span class="sxs-lookup"><span data-stu-id="c9337-191">Azure supports VM-GenerationID, which means that domain controllers that run Windows Server 2012 or later on Azure virtual machines have the additional safeguards.</span></span>

> [!NOTE]
> <span data-ttu-id="c9337-192">Завершение работы и перезагрузку виртуальной машины, которая работает в роли контроллера домена в Azure, следует выполнять в операционной системе на виртуальной машине, а не с помощью команды **Завершение работы** на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-192">You should shut down and restart a VM that runs the domain controller role in Azure within the guest operating system instead of using the **Shut Down** option in the Azure porta.</span></span> <span data-ttu-id="c9337-193">Сейчас завершение работы виртуальной машины на портале влечет отмену распределения соответствующих ресурсов.</span><span class="sxs-lookup"><span data-stu-id="c9337-193">Today, using the portal to shut down a VM causes the VM to be deallocated.</span></span> <span data-ttu-id="c9337-194">Преимущество такой виртуальной машины в том, что за ее использование не взимается плата, но при этом происходит сброс VM-GenerationID, что нежелательно для контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="c9337-194">A deallocated VM has the advantage of not incurring charges, but it also resets the VM-GenerationID, which is undesirable for a DC.</span></span> <span data-ttu-id="c9337-195">При сбросе VM-GenerationID также сбрасывается invocationID базы данных AD DS, удаляется пул RID, а SYSVOL помечается как не заслуживающий доверия.</span><span class="sxs-lookup"><span data-stu-id="c9337-195">When the VM-GenerationID is reset, the invocationID of the AD DS database is also reset, the RID pool is discarded, and SYSVOL is marked as non-authoritative.</span></span> <span data-ttu-id="c9337-196">Дополнительные сведения см. в разделах [Introduction to Active Directory Domain Services (AD DS) Virtualization](https://technet.microsoft.com/library/hh831734.aspx) (Знакомство с виртуализацией доменных служб Active Directory) и [Safely Virtualizing DFSR](http://blogs.technet.com/b/filecab/archive/2013/04/05/safely-virtualizing-dfsr.aspx) (Безопасная виртуализация DFSR).</span><span class="sxs-lookup"><span data-stu-id="c9337-196">For more information, see [Introduction to Active Directory Domain Services (AD DS) Virtualization](https://technet.microsoft.com/library/hh831734.aspx) and [Safely Virtualizing DFSR](http://blogs.technet.com/b/filecab/archive/2013/04/05/safely-virtualizing-dfsr.aspx).</span></span>
> 
> 

## <a name="why-deploy-windows-server-ad-ds-on-azure-virtual-machines"></a><span data-ttu-id="c9337-197">Почему стоит развертывать Windows Server AD DS на виртуальных машинах Azure?</span><span class="sxs-lookup"><span data-stu-id="c9337-197">Why deploy Windows Server AD DS on Azure Virtual Machines?</span></span>
<span data-ttu-id="c9337-198">Для развертывания на виртуальных машинах в Azure подходит много сценариев развертывания Windows Server AD DS.</span><span class="sxs-lookup"><span data-stu-id="c9337-198">Many Windows Server AD DS deployment scenarios are well-suited for deployment as VMs on Azure.</span></span> <span data-ttu-id="c9337-199">Например, предположим, что компании в Европе необходимо выполнять проверку подлинности пользователей в удаленном местоположении в Азии.</span><span class="sxs-lookup"><span data-stu-id="c9337-199">For example, suppose you have a company in Europe that needs to authenticate users in a remote location in Asia.</span></span> <span data-ttu-id="c9337-200">Компания ранее не выполняла развертывание контроллеров домена Windows Server Active Directory в Азии из-за стоимости развертывания или ограниченного опыта управления серверами после развертывания.</span><span class="sxs-lookup"><span data-stu-id="c9337-200">The company has not previously deployed Windows Server Active Directory DCs in Asia due to the cost to deploy them and limited expertise to manage the servers post-deployment.</span></span> <span data-ttu-id="c9337-201">В результате запросы проверки подлинности из Азии обслуживают контроллеры домена в Европе, но неэффективно.</span><span class="sxs-lookup"><span data-stu-id="c9337-201">As a result, authentication requests from Asia are serviced by DCs in Europe with suboptimal results.</span></span> <span data-ttu-id="c9337-202">В таком случае можно развернуть контроллер домена на виртуальной машине, для которой задана работа в центре обработки данных Azure в Азии.</span><span class="sxs-lookup"><span data-stu-id="c9337-202">In this case, you can deploy a DC on a VM that you have specified must be run within the Azure datacenter in Asia.</span></span> <span data-ttu-id="c9337-203">Присоединение этого контроллера домена к виртуальной сети Azure, подключенной напрямую к удаленному местоположению, улучшит производительность проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="c9337-203">Attaching that DC to an Azure virtual network that is connected directly to the remote location will improve authentication performance.</span></span>

<span data-ttu-id="c9337-204">Azure также хорошо подходит как замена дорогим объектам аварийного восстановления.</span><span class="sxs-lookup"><span data-stu-id="c9337-204">Azure is also well-suited as a substitute to otherwise costly disaster recovery (DR) sites.</span></span> <span data-ttu-id="c9337-205">Относительно недорогая цена размещения малого числа контроллеров домена и одной виртуальной сети в Azure — привлекательная альтернатива.</span><span class="sxs-lookup"><span data-stu-id="c9337-205">The relatively low-cost of hosting a small number of domain controllers and a single virtual network on Azure represents an attractive alternative.</span></span>

<span data-ttu-id="c9337-206">И наконец, возможно, вам необходимо будет развернуть в Azure сетевое приложение, такое как SharePoint, для работы которого нужна Windows Server Active Directory, но не нужна локальная сеть или корпоративная служба Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-206">Finally, you may want to deploy a network application on Azure, such as SharePoint, that requires Windows Server Active Directory but has no dependency on the on-premises network or the corporate Windows Server Active Directory.</span></span> <span data-ttu-id="c9337-207">В этом случае развертывание изолированного леса в Azure будет оптимальным решением в соответствии с требованиями сервера SharePoint.</span><span class="sxs-lookup"><span data-stu-id="c9337-207">In this case, deploying an isolated forest on Azure to meet the SharePoint server’s requirements is optimal.</span></span> <span data-ttu-id="c9337-208">Опять же, поддерживается и развертывание сетевых приложений, для которых требуется подключение к локальной сети и корпоративной службе Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-208">Again, deploying network applications that do require connectivity to the on-premises network and the corporate Active Directory is also supported.</span></span>

> [!NOTE]
> <span data-ttu-id="c9337-209">Так как компонент VPN обеспечивает подключение 3-го уровня и связь между виртуальной сетью Azure и локальной сетью, он также может позволить серверам-членам домена в локальной сети использовать контроллеры домена, которые работают на виртуальных машинах в виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-209">Since it provides a layer-3 connection, the VPN component that provides connectivity between an Azure virtual network and an on-premises network can also enable member servers that run on-premises to leverage DCs that run as Azure virtual machines on Azure virtual network.</span></span> <span data-ttu-id="c9337-210">Но если VPN станет недоступна, пропадет связь между компьютерами локальной сети и контроллерами домена в Azure, а при проверке подлинности и других операциях будут возникать ошибки.</span><span class="sxs-lookup"><span data-stu-id="c9337-210">But if the VPN is unavailable, communication between on-premises computers and Azure-based domain controllers will not function, resulting in authentication and various other errors.</span></span>  
> 
> 

## <a name="contrasts-between-deploying-windows-server-active-directory-domain-controllers-on-azure-virtual-machines-versus-on-premises"></a><span data-ttu-id="c9337-211">Разница между развертыванием контроллеров домена Windows Server Active Directory на виртуальных машинах Azure и локальным развертыванием</span><span class="sxs-lookup"><span data-stu-id="c9337-211">Contrasts between deploying Windows Server Active Directory domain controllers on Azure Virtual Machines versus on-premises</span></span>
* <span data-ttu-id="c9337-212">В любом сценарии развертывания Windows Server Active Directory, где используется больше одной виртуальной машины, необходимо использовать виртуальную сеть Azure, чтобы обеспечить согласованность IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="c9337-212">For any Windows Server Active Directory deployment scenario that includes more than a single VM, it is necessary to use an Azure virtual network for IP address consistency.</span></span> <span data-ttu-id="c9337-213">Обратите внимание, в этом руководстве подразумевается, что контроллеры домена работают в виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-213">Note that this guide assumes that DCs are running on an Azure virtual network.</span></span>
* <span data-ttu-id="c9337-214">Как и для локальных контроллеров, рекомендуется настройка статических IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="c9337-214">As with on-premises DCs, static IP addresses are recommended.</span></span> <span data-ttu-id="c9337-215">Статический IP-адрес можно настроить только с помощью Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="c9337-215">A static IP address can only be configured by using Azure PowerShell.</span></span> <span data-ttu-id="c9337-216">Дополнительные сведения см. в статье [Static internal IP address for VMs](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/) (Настройка статического внутреннего IP-адреса для виртуальных машин).</span><span class="sxs-lookup"><span data-stu-id="c9337-216">See [Static internal IP address for VMs](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/) for more details.</span></span> <span data-ttu-id="c9337-217">Если у вас есть системы мониторинга или другие решения, которые проверяют конфигурацию статических IP-адресов в операционной системе на виртуальной машине, то можно назначить тот же статический IP-адрес свойствам сетевого адаптера виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="c9337-217">If you have monitoring systems or other solutions that check for static IP address configuration within the guest operating system, you can assign the same static IP address to the network adapter properties of the VM.</span></span> <span data-ttu-id="c9337-218">Но необходимо учитывать, что сетевой адаптер будет изменен, если в виртуальной машине будет восстановлена работоспособность службы или если работа виртуальной машины будет завершена на портале, а назначение ей адреса будет отменено.</span><span class="sxs-lookup"><span data-stu-id="c9337-218">But be aware that the network adapter will be discarded if the VM undergoes service healing or is shut down in the portal and has its address deallocated.</span></span> <span data-ttu-id="c9337-219">В таком случае придется сбросить статический IP-адрес в операционной системе на виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="c9337-219">In that case, the static IP address within the guest will need to be reset.</span></span>
* <span data-ttu-id="c9337-220">Развертывание виртуальных машин в виртуальной сети не подразумевает (и не требует) обратной связи с локальной сетью. Виртуальная сеть лишь обеспечивает такую возможность.</span><span class="sxs-lookup"><span data-stu-id="c9337-220">Deploying VMs on a virtual network does not imply (or require) connectivity back to an on-premises network; the virtual network merely enables that possibility.</span></span> <span data-ttu-id="c9337-221">Чтобы обеспечить частную связь между Azure и вашей локальной сетью, нужно создать виртуальную сеть.</span><span class="sxs-lookup"><span data-stu-id="c9337-221">You must create a virtual network for private communication between Azure and your on-premises network.</span></span> <span data-ttu-id="c9337-222">Кроме этого, необходимо развернуть конечную точку VPN в локальной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-222">You need to deploy a VPN endpoint on the on-premises network.</span></span> <span data-ttu-id="c9337-223">Чтобы открыть подключение к VPN, нужно подключить Azure к локальной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-223">The VPN is opened from Azure to the on-premises network.</span></span> <span data-ttu-id="c9337-224">Дополнительные сведения см. в статьях [Обзор виртуальной сети](../virtual-network/virtual-networks-overview.md) и [Создание виртуальной сети с подключением типа "сеть — сеть" с помощью портала Azure](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span><span class="sxs-lookup"><span data-stu-id="c9337-224">For more information, see [Virtual Network Overview](../virtual-network/virtual-networks-overview.md) and [Configure a Site-to-Site VPN in the Azure Portal](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span></span>

> [!NOTE]
> <span data-ttu-id="c9337-225">Чтобы [создать VPN типа "точка-сеть"](../vpn-gateway/vpn-gateway-point-to-site-create.md) , нужно подключить отдельные компьютеры Windows напрямую к виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-225">An option to [create a point-to-site VPN](../vpn-gateway/vpn-gateway-point-to-site-create.md) is available to connect individual Windows-based computers directly to an Azure virtual network.</span></span>
> 
> 

* <span data-ttu-id="c9337-226">Azure взимает плату за исходящий трафик (не за входящий) независимо от того, создана ли виртуальная сеть.</span><span class="sxs-lookup"><span data-stu-id="c9337-226">Regardless of whether you create a virtual network or not, Azure charges for egress traffic but not ingress.</span></span> <span data-ttu-id="c9337-227">Объем входящего трафика развертывания может зависеть от выбранной архитектуры Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-227">Various Windows Server Active Directory design choices can affect how much egress traffic is generated by a deployment.</span></span> <span data-ttu-id="c9337-228">Например, при развертывании контроллера домена только для чтения входящий трафик ограничен, так как исходящие данные не реплицируются.</span><span class="sxs-lookup"><span data-stu-id="c9337-228">For example, deploying a read-only domain controller (RODC) limits egress traffic because it does not replicate outbound.</span></span> <span data-ttu-id="c9337-229">Однако при принятии решения о развертывании контроллера домена только для чтения нужно учитывать необходимость выполнять операции записи в контроллере, а также [совместимость](https://technet.microsoft.com/library/cc755190) приложений и служб на сайте с контроллером домена только для чтения.</span><span class="sxs-lookup"><span data-stu-id="c9337-229">But the decision to deploy an RODC needs to be weighed against the need to perform write operations against the DC and the [compatibility](https://technet.microsoft.com/library/cc755190) that applications and services in the site have with RODCs.</span></span> <span data-ttu-id="c9337-230">Дополнительные сведения о ценах на использование трафика см. в разделе [Цены Azure](http://azure.microsoft.com/pricing/).</span><span class="sxs-lookup"><span data-stu-id="c9337-230">For more information about traffic charges, see [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span></span>
* <span data-ttu-id="c9337-231">При настройке виртуальных машин в локальной сети у вас есть полный контроль над тем, какой объем серверных ресурсов, например ОЗУ, размер диска и т. п., будет отведен под машины, а при работе в Azure его нужно выбрать в списке предопределенных размеров сервера.</span><span class="sxs-lookup"><span data-stu-id="c9337-231">While you have complete control over what server resources to use for VMs on-premises, such as RAM, disk size, and so on, on Azure you must select from a list of preconfigured server sizes.</span></span> <span data-ttu-id="c9337-232">В дополнение к диску операционной системы для контроллера домена также требуется диск данных, где будет храниться база данных Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-232">For a DC, a data disk is needed in addition to the operating system disk in order to store the Windows Server Active Directory database.</span></span>

## <a name="can-you-deploy-windows-server-ad-fs-on-azure-virtual-machines"></a><span data-ttu-id="c9337-233">Можно ли развернуть Windows Server AD FS на виртуальных машинах Azure?</span><span class="sxs-lookup"><span data-stu-id="c9337-233">Can you deploy Windows Server AD FS on Azure virtual machines?</span></span>
<span data-ttu-id="c9337-234">Да, Windows Server AD FS можно развернуть на виртуальных машинах в Azure. [Рекомендации по развертыванию AD FS](https://technet.microsoft.com/library/dn151324.aspx) в локальной среде относятся и к развертыванию AD FS в Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-234">Yes, you can deploy Windows Server AD FS on Azure virtual machines, and the [best practices for AD FS deployment](https://technet.microsoft.com/library/dn151324.aspx) on-premises apply equally to AD FS deployment on Azure.</span></span> <span data-ttu-id="c9337-235">Но для выполнения некоторых рекомендаций, например по балансировке нагрузки и обеспечению высокой доступности, требуется использовать технологии, которые не реализованы в AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-235">But some of the best practices such as load balancing and high availability require technologies beyond what AD FS offers itself.</span></span> <span data-ttu-id="c9337-236">Они должны быть в базовой инфраструктуре.</span><span class="sxs-lookup"><span data-stu-id="c9337-236">They must be provided by the underlying infrastructure.</span></span> <span data-ttu-id="c9337-237">Рассмотрим некоторые из этих рекомендаций, чтобы узнать, как их реализовать с помощью виртуальных машин Azure и виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-237">Let’s review some of those best practices and see how they can be achieved by using Azure VMs and an Azure virtual network.</span></span>

1. <span data-ttu-id="c9337-238">**Никогда не предоставляйте доступ к серверам службы маркеров безопасности напрямую в Интернете.**</span><span class="sxs-lookup"><span data-stu-id="c9337-238">**Never expose security token service (STS) servers directly to the Internet.**</span></span>
   
    <span data-ttu-id="c9337-239">Это важно, так как соответствующая служба выдает маркеры безопасности.</span><span class="sxs-lookup"><span data-stu-id="c9337-239">This is important because the STS issues security tokens.</span></span> <span data-ttu-id="c9337-240">Следовательно, такие серверы службы маркеров безопасности, как AD FS, следует защищать на том же уровне, что и контроллер домена.</span><span class="sxs-lookup"><span data-stu-id="c9337-240">As a result, STS servers such as AD FS servers should be treated with the same level of protection as a domain controller.</span></span> <span data-ttu-id="c9337-241">Если пользователи-злоумышленники скомпрометируют службу маркеров безопасности, они смогут выдавать маркеры доступа, потенциально содержащие их утверждения для приложений проверяющей стороны и других серверов службы маркеров безопасности в доверяющих организациях.</span><span class="sxs-lookup"><span data-stu-id="c9337-241">If an STS is compromised, malicious users have the ability to issue access tokens potentially containing claims of their choosing to relying party applications and other STS servers in trusting organizations.</span></span>
2. <span data-ttu-id="c9337-242">**Развертывайте контроллеры доменов Active Directory для всех доменов пользователей в сети, где размещены серверы AD FS.**</span><span class="sxs-lookup"><span data-stu-id="c9337-242">**Deploy Active Directory domain controllers for all user domains in the same network as the AD FS servers.**</span></span>
   
    <span data-ttu-id="c9337-243">Серверы AD FS используют доменные службы Active Directory для проверки подлинности пользователей.</span><span class="sxs-lookup"><span data-stu-id="c9337-243">AD FS servers use Active Directory Domain Services to authenticate users.</span></span> <span data-ttu-id="c9337-244">Контроллеры доменов рекомендуется развертывать в той же сети, что и серверы AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-244">It is recommended to deploy domain controllers on the same network as the AD FS servers.</span></span> <span data-ttu-id="c9337-245">Это обеспечит непрерывность работы на случай разрыва связи между сетью Azure и локальной сетью, а также позволит уменьшить задержки и повысить производительность при входе.</span><span class="sxs-lookup"><span data-stu-id="c9337-245">This provides business continuity in case the link between the Azure network and your on-premises network is broken, and enables lower latency and increased performance for logins.</span></span>
3. <span data-ttu-id="c9337-246">**Разверните несколько узлов AD FS, чтобы обеспечить высокую доступность и балансировку нагрузки.**</span><span class="sxs-lookup"><span data-stu-id="c9337-246">**Deploy multiple AD FS nodes for high availability and balancing the load.**</span></span>
   
    <span data-ttu-id="c9337-247">В большинстве случаев сбои приложений, обслуживаемых AD FS, неприемлемы, так как приложения, которым требуются маркеры безопасности, часто критически важны для работы.</span><span class="sxs-lookup"><span data-stu-id="c9337-247">In most cases, the failure of an application that AD FS enables is unacceptable because the applications that require security tokens are often mission critical.</span></span> <span data-ttu-id="c9337-248">Так как AD FS необходимы для доступа к важным приложениям, у этих служб должен быть высокий уровень доступности на нескольких прокси-серверах и серверах AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-248">As a result, and because AD FS now resides in the critical path to accessing mission critical applications, the AD FS service must be highly available through multiple AD FS proxies and AD FS servers.</span></span> <span data-ttu-id="c9337-249">Чтобы добиться соответствующего распределения запросов, балансировщики нагрузки обычно развертывают на прокси-серверах и серверах AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-249">To achieve distribution of requests, load balancers are typically deployed in front of both the AD FS Proxies and the AD FS servers.</span></span>
4. <span data-ttu-id="c9337-250">**Разверните один или несколько узлов прокси-служб веб-приложений для доступа в Интернете.**</span><span class="sxs-lookup"><span data-stu-id="c9337-250">**Deploy one or more Web Application Proxy nodes for internet access.**</span></span>
   
    <span data-ttu-id="c9337-251">Если пользователям нужен доступ к приложениям, защищенным службами AD FS, эти службы должны быть доступны в Интернете.</span><span class="sxs-lookup"><span data-stu-id="c9337-251">When users need to access applications protected by the AD FS service, the AD FS service needs to be available from the internet.</span></span> <span data-ttu-id="c9337-252">Для этого нужно развернуть прокси-службу веб-приложений.</span><span class="sxs-lookup"><span data-stu-id="c9337-252">This is achieved by deploying the Web Application Proxy service.</span></span> <span data-ttu-id="c9337-253">Настоятельно рекомендуется развернуть несколько узлов, чтобы обеспечить высокий уровень доступности и балансировку нагрузки.</span><span class="sxs-lookup"><span data-stu-id="c9337-253">It is strongly recommended to deploy more than one node for the purposes of high availability and load balancing.</span></span>
5. <span data-ttu-id="c9337-254">**Ограничьте доступ к ресурсам внутренней сети с узлов прокси-служб веб-приложений.**</span><span class="sxs-lookup"><span data-stu-id="c9337-254">**Restrict access from the Web Application Proxy nodes to internal network resources.**</span></span>
   
    <span data-ttu-id="c9337-255">Чтобы предоставить внешним пользователям доступ к службам AD FS в Интернете, необходимо развернуть узлы прокси-служб веб-приложений (или прокси-сервера AD FS, если используется более ранняя версия Windows Server).</span><span class="sxs-lookup"><span data-stu-id="c9337-255">To allow external users to access AD FS from the internet, you need to deploy Web Application Proxy nodes (or AD FS Proxy in earlier versions of Windows Server).</span></span> <span data-ttu-id="c9337-256">Узлы прокси-служб веб-приложений доступны напрямую в Интернете.</span><span class="sxs-lookup"><span data-stu-id="c9337-256">The Web Application proxy nodes are directly exposed to the Internet.</span></span> <span data-ttu-id="c9337-257">Их не нужно присоединять к домену, так как для них необходимо только обеспечить доступ к серверам AD FS через TCP-порты 443 и 80.</span><span class="sxs-lookup"><span data-stu-id="c9337-257">They are not required to be domain-joined and they only need access to the AD FS servers over TCP ports 443 and 80.</span></span> <span data-ttu-id="c9337-258">Настоятельно рекомендуется заблокировать связь со всеми остальными компьютерами (особенно контроллерами доменов).</span><span class="sxs-lookup"><span data-stu-id="c9337-258">It is strongly recommended that communication to all other computers (especially domain controllers) is blocked.</span></span>
   
    <span data-ttu-id="c9337-259">Обычно это делают локально с использованием сети периметра.</span><span class="sxs-lookup"><span data-stu-id="c9337-259">This is typically achieved on-premises by means of a DMZ.</span></span> <span data-ttu-id="c9337-260">Брандмауэры используют режим списка разрешений, чтобы ограничить трафик сети периметра до использования локальной сети (т. е. разрешен только трафик с указанных IP-адресов и через указанные порты, а весь остальной трафик блокируется).</span><span class="sxs-lookup"><span data-stu-id="c9337-260">Firewalls use a whitelist mode of operation to restrict traffic from the DMZ to the on-premises network (that is, only traffic from the specified IP addresses and over specified ports is allowed, and all other traffic is blocked).</span></span>

<span data-ttu-id="c9337-261">На следующей схеме показано традиционное локальное развертывание AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-261">The following diagram shows a traditional on-premises AD FS deployment.</span></span>

![Схема стандартного локального развертывания служб федерации Active Directory](media/active-directory-deploying-ws-ad-guidelines/ADFS_onprem.png)

<span data-ttu-id="c9337-263">Так как Azure не предоставляет встроенный полнофункциональный брандмауэр, нужно использовать другие варианты, чтобы ограничить трафик.</span><span class="sxs-lookup"><span data-stu-id="c9337-263">However, because Azure does not provide native, full-featured firewall capability, other options need to be used to restrict traffic.</span></span> <span data-ttu-id="c9337-264">В следующей таблице показаны все доступные варианты, их преимущества и недостатки.</span><span class="sxs-lookup"><span data-stu-id="c9337-264">The following table shows each option and its advantages and disadvantages.</span></span>

| <span data-ttu-id="c9337-265">Параметр</span><span class="sxs-lookup"><span data-stu-id="c9337-265">Option</span></span> | <span data-ttu-id="c9337-266">Преимущество</span><span class="sxs-lookup"><span data-stu-id="c9337-266">Advantage</span></span> | <span data-ttu-id="c9337-267">Недостаток</span><span class="sxs-lookup"><span data-stu-id="c9337-267">Disadvantage</span></span> |
| --- | --- | --- |
| [<span data-ttu-id="c9337-268">ACL сети Azure</span><span class="sxs-lookup"><span data-stu-id="c9337-268">Azure network ACLs</span></span>](../virtual-network/virtual-networks-acl.md) |<span data-ttu-id="c9337-269">Стоят меньше, простая начальная настройка</span><span class="sxs-lookup"><span data-stu-id="c9337-269">Less costly and simpler initial configuration</span></span> |<span data-ttu-id="c9337-270">При добавлении в развертывание новых виртуальных машин требуется дополнительная настройка ACL</span><span class="sxs-lookup"><span data-stu-id="c9337-270">Additional network ACL configuration required if any new VMs are added to the deployment</span></span> |
| [<span data-ttu-id="c9337-271">Barracuda NG Firewall</span><span class="sxs-lookup"><span data-stu-id="c9337-271">Barracuda NG firewall</span></span>](https://www.barracuda.com/products/ngfirewall) |<span data-ttu-id="c9337-272">Режим списка разрешений, не требуется настройка ACL</span><span class="sxs-lookup"><span data-stu-id="c9337-272">Whitelist mode of operation and it requires no network ACL configuration</span></span> |<span data-ttu-id="c9337-273">Стоит дороже, сложная начальная настройка</span><span class="sxs-lookup"><span data-stu-id="c9337-273">Increased cost and complexity for initial setup</span></span> |

<span data-ttu-id="c9337-274">Далее представлена подробная процедура такого развертывания AD FS:</span><span class="sxs-lookup"><span data-stu-id="c9337-274">The high-level steps to deploy AD FS in this case are as follows:</span></span>

1. <span data-ttu-id="c9337-275">Создайте виртуальную сеть с распределенным подключением, используя VPN или [ExpressRoute](http://azure.microsoft.com/services/expressroute/).</span><span class="sxs-lookup"><span data-stu-id="c9337-275">Create a virtual network with cross-premises connectivity, using either a VPN or [ExpressRoute](http://azure.microsoft.com/services/expressroute/).</span></span>
2. <span data-ttu-id="c9337-276">Разверните контроллеры домена в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-276">Deploy domain controllers on the virtual network.</span></span> <span data-ttu-id="c9337-277">Этот шаг необязателен, но мы рекомендуем его выполнить.</span><span class="sxs-lookup"><span data-stu-id="c9337-277">This step is optional but recommended.</span></span>
3. <span data-ttu-id="c9337-278">Разверните присоединенные к домену серверы AD FS в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-278">Deploy domain-joined AD FS servers on the virtual network.</span></span>
4. <span data-ttu-id="c9337-279">Создайте [набор с внутренней балансировкой нагрузки](http://azure.microsoft.com/blog/internal-load-balancing/) , который включает в себя серверы AD FS и использует новый частный (динамический) IP-адрес в виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-279">Create an [internal load balanced set](http://azure.microsoft.com/blog/internal-load-balancing/) that includes the AD FS servers and uses a new private IP address within the virtual network (a dynamic IP address).</span></span>
   
   1. <span data-ttu-id="c9337-280">Обновите DNS, чтобы создать FQDN, указывающее на частный (динамический) IP-адрес набора с внутренней балансировкой нагрузки.</span><span class="sxs-lookup"><span data-stu-id="c9337-280">Update DNS to create the FQDN to point to the private (dynamic) IP address of the internal load balanced set.</span></span>
5. <span data-ttu-id="c9337-281">Создайте облачную службу (или отдельную виртуальную сеть) для узлов прокси-служб веб-приложений.</span><span class="sxs-lookup"><span data-stu-id="c9337-281">Create a cloud service (or a separate virtual network) for the Web Application Proxy nodes.</span></span>
6. <span data-ttu-id="c9337-282">Разверните узлы прокси-служб веб-приложений в облачной службе или виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-282">Deploy the Web Application Proxy nodes in the cloud service or virtual network</span></span>
   
   1. <span data-ttu-id="c9337-283">Создайте внешний набор с балансировкой нагрузки, который включает в себя узлы прокси-служб веб-приложений.</span><span class="sxs-lookup"><span data-stu-id="c9337-283">Create an external load balanced set that includes the Web Application Proxy nodes.</span></span>
   2. <span data-ttu-id="c9337-284">Обновите имя внешней DNS (FQDN), указывающее на общедоступный (виртуальный) IP-адрес облачной службы.</span><span class="sxs-lookup"><span data-stu-id="c9337-284">Update the external DNS name (FQDN) to point to the cloud service public IP address (the virtual IP address).</span></span>
   3. <span data-ttu-id="c9337-285">Настройте использование FQDN, соответствующего набору с внутренней балансировкой нагрузки серверов AD FS, для прокси-серверов AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-285">Configure AD FS proxies to use the FQDN that corresponds to the internal load balanced set for the AD FS servers.</span></span>
   4. <span data-ttu-id="c9337-286">Обновите веб-сайты на основе утверждений, чтобы они использовали FQDN для поставщика утверждений.</span><span class="sxs-lookup"><span data-stu-id="c9337-286">Update claims-based web sites to use the external FQDN for their claims provider.</span></span>
7. <span data-ttu-id="c9337-287">Ограничьте доступ между узлами прокси-служб веб-приложения, указав любой компьютер в виртуальной сети AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-287">Restrict access between Web Application Proxy to any machine in the AD FS virtual network.</span></span>

<span data-ttu-id="c9337-288">Чтобы ограничить трафик, набор с балансировкой нагрузки для внутреннего балансировщика нагрузки Azure необходимо настроить так, чтобы трафик проходил только через TCP-порты 80 и 443, при этом весь остальной трафик по внутренним динамическим IP-адресам набора с балансировкой нагрузки отклонялся.</span><span class="sxs-lookup"><span data-stu-id="c9337-288">To restrict traffic, the load-balanced set for the Azure internal load balancer needs to be configured for only traffic to TCP ports 80 and 443, and all other traffic to the internal dynamic IP address of the load balanced set is dropped.</span></span>

![Схема сетевых списков ACL служб ADFS с разрешенным набором портов TCP 443 и 80.](media/active-directory-deploying-ws-ad-guidelines/ADFS_ACLs.png)

<span data-ttu-id="c9337-290">Допускается трафик на серверы AD FS со следующих источников:</span><span class="sxs-lookup"><span data-stu-id="c9337-290">Traffic to the AD FS servers would be permitted only by the following sources:</span></span>

* <span data-ttu-id="c9337-291">внутренний балансировщик нагрузки Azure;</span><span class="sxs-lookup"><span data-stu-id="c9337-291">The Azure internal load balancer.</span></span>
* <span data-ttu-id="c9337-292">IP-адрес администратора локальной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-292">The IP address of an administrator on the on-premises network.</span></span>

> [!WARNING]
> <span data-ttu-id="c9337-293">При такой архитектуре узлы прокси-служб веб-приложений не смогут связываться с другими виртуальными машинами в виртуальной сети Azure или расположениями в локальной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-293">The design must prevent Web Application Proxy nodes from reaching any other VMs in the Azure virtual network or any locations on the on-premises network.</span></span> <span data-ttu-id="c9337-294">Для этого необходимо настроить правила брандмауэра для подключений ExpressRoute на локальном модуле или для VPN типа "сеть-сеть" на устройстве VPN.</span><span class="sxs-lookup"><span data-stu-id="c9337-294">That can be done by configuring firewall rules in the on-premises appliance for Express Route connections or the VPN device for site-to-site VPN connections.</span></span>
> 
> 

<span data-ttu-id="c9337-295">Недостаток этого варианта заключается в необходимости настройки сетевых списков ACL для нескольких устройств, в том числе внутреннего балансировщика нагрузки, серверов AD FS и других серверов, добавляемых в виртуальную сеть.</span><span class="sxs-lookup"><span data-stu-id="c9337-295">A disadvantage to this option is the need to configure the network ACLs for multiple devices, including internal load balancer, the AD FS servers, and any other servers that get added to the virtual network.</span></span> <span data-ttu-id="c9337-296">Если какое-то устройство добавляется к развертыванию без настройки сетевых списков ACL для ограничения трафика к нему, все развертывание может быть под угрозой.</span><span class="sxs-lookup"><span data-stu-id="c9337-296">If any device is added to the deployment without configuring network ACLs to restrict traffic to it, the entire deployment can be at risk.</span></span> <span data-ttu-id="c9337-297">Если IP-адреса узлов прокси-служб веб-приложений изменятся, необходимо сбросить сетевые списки управления доступом (т. е. для прокси-серверов нужно настроить использование [статических динамических IP-адресов](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/)).</span><span class="sxs-lookup"><span data-stu-id="c9337-297">If the IP addresses of the Web Application Proxy nodes ever change, the network ACLs must be reset (which means the proxies should be configured to use [static dynamic IP addresses](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/)).</span></span>

![Службы ADFS в Azure с использованием сетевых списков ACL.](media/active-directory-deploying-ws-ad-guidelines/ADFS_Azure.png)

<span data-ttu-id="c9337-299">Другой вариант — использовать модуль [Barracuda NG Firewall](https://www.barracuda.com/products/ngfirewall) , чтобы контролировать трафик между прокси-серверами AD FS и серверами AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-299">Another option is to use the [Barracuda NG Firewall](https://www.barracuda.com/products/ngfirewall) appliance to control traffic between AD FS proxy servers and the AD FS servers.</span></span> <span data-ttu-id="c9337-300">Этот вариант соответствует рекомендациям по безопасности и высокой доступности и требует меньше администрирования после начальной настройки, так как модуль Barracuda NG Firewall использует режим списка разрешений и его можно установить прямо в виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-300">This option complies with best practices for security and high availability, and requires less administration after the initial setup because the Barracuda NG Firewall appliance provides a whitelist mode of firewall administration and it can be installed directly on an Azure virtual network.</span></span> <span data-ttu-id="c9337-301">Это устраняет необходимость настраивать сетевые списки ACL всякий раз, когда в развертывание добавляется новый сервер.</span><span class="sxs-lookup"><span data-stu-id="c9337-301">That eliminates the need to configure network ACLs any time a new server is added to the deployment.</span></span> <span data-ttu-id="c9337-302">Но при использовании этого варианта начальное развертывание становится сложнее и дороже.</span><span class="sxs-lookup"><span data-stu-id="c9337-302">But this option adds initial deployment complexity and cost.</span></span>

<span data-ttu-id="c9337-303">В этом случае развертываются две виртуальные сети вместо одной.</span><span class="sxs-lookup"><span data-stu-id="c9337-303">In this case, two virtual networks are deployed instead of one.</span></span> <span data-ttu-id="c9337-304">Мы назовем их VNet1 и VNet2.</span><span class="sxs-lookup"><span data-stu-id="c9337-304">We'll call them VNet1 and VNet2.</span></span> <span data-ttu-id="c9337-305">В VNet1 содержатся прокси-серверы, а в VNet2 — службы маркеров безопасности. Кроме того, в последней установлено сетевое подключение к корпоративной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-305">VNet1 contains the proxies and VNet2 contains the STSs and the network connection back to the corporate network.</span></span> <span data-ttu-id="c9337-306">Таким образом, VNet1 физически (хотя и виртуально) изолирована от сети VNet2 и, в свою очередь, от корпоративной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-306">VNet1 is therefore physically (albeit virtually) isolated from VNet2 and, in turn, from the corporate network.</span></span> <span data-ttu-id="c9337-307">VNet1 подключается к VNet2 с помощью специальной технологии туннелирования под названием Transport Independent Network Architecture (TINA).</span><span class="sxs-lookup"><span data-stu-id="c9337-307">VNet1 is then connected to VNet2 using a special tunneling technology known as Transport Independent Network Architecture (TINA).</span></span> <span data-ttu-id="c9337-308">Туннель TINA подключается к каждой виртуальной сети с помощью брандмауэра Barracuda NG Firewall (один такой брандмауэр на каждую виртуальную сеть).</span><span class="sxs-lookup"><span data-stu-id="c9337-308">The TINA tunnel is attached to each of the virtual networks using a Barracuda NG firewall—one Barracuda on each of the virtual networks.</span></span>  <span data-ttu-id="c9337-309">Для обеспечения высокой доступности рекомендуется развернуть два брандмауэра Barracuda в каждой виртуальной сети — активный и пассивный.</span><span class="sxs-lookup"><span data-stu-id="c9337-309">For high-availability, it is recommended that you deploy two Barracudas on each virtual network; one active, the other passive.</span></span> <span data-ttu-id="c9337-310">Они предусматривают множество возможностей защиты брандмауэром, которые позволяют сымитировать работу стандартной локальной сети периметра в Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-310">They offer extremely rich firewalling capabilities which allow us to mimic the operation of a traditional on-premises DMZ in Azure.</span></span>

![Службы ADFS в Azure с использованием брандмауэра.](media/active-directory-deploying-ws-ad-guidelines/ADFS_Azure_firewall.png)

<span data-ttu-id="c9337-312">Дополнительные сведения см. в разделе [AD FS: предоставление доступа к локальному внешнему приложению с поддержкой утверждений через Интернет](#BKMK_CloudOnlyFed).</span><span class="sxs-lookup"><span data-stu-id="c9337-312">For more information, see [AD FS: Extend a claims-aware on-premises front-end application to the Internet](#BKMK_CloudOnlyFed).</span></span>

### <a name="an-alternative-to-ad-fs-deployment-if-the-goal-is-office-365-sso-alone"></a><span data-ttu-id="c9337-313">Альтернатива развертыванию AD FS, если целью является только единый вход в Office 365</span><span class="sxs-lookup"><span data-stu-id="c9337-313">An alternative to AD FS deployment if the goal is Office 365 SSO alone</span></span>
<span data-ttu-id="c9337-314">Есть также и другой способ развертывания AD FS, если целью является только единый вход в Office 365.</span><span class="sxs-lookup"><span data-stu-id="c9337-314">There is another alternative to deploying AD FS altogether if your goal is only to enable sign-in for Office 365.</span></span> <span data-ttu-id="c9337-315">В этом случае можно просто развернуть DirSync с синхронизацией паролей в локальной сети и добиться того же самого конечного результата с помощью простого развертывания, так как для этого подхода не требуется AD FS или Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-315">In that case, you can simply deploy DirSync with password sync on-premises and achieve the same end-result with minimal deployment complexity because this approach does not require AD FS or Azure.</span></span>

<span data-ttu-id="c9337-316">В следующей таблице приводится сравнение процессов входа в систему с развертыванием AD FS и без него.</span><span class="sxs-lookup"><span data-stu-id="c9337-316">The following table compares how the sign-in processes work with and without deploying AD FS.</span></span>

| <span data-ttu-id="c9337-317">Единый вход в Office 365 с использованием AD FS и DirSync</span><span class="sxs-lookup"><span data-stu-id="c9337-317">Office 365 single sign-on using AD FS and DirSync</span></span> | <span data-ttu-id="c9337-318">"Такой же вход" в Office 365 с использованием DirSync и синхронизации паролей</span><span class="sxs-lookup"><span data-stu-id="c9337-318">Office 365 same sign-on using DirSync + Password Sync</span></span> |
| --- | --- |
| <span data-ttu-id="c9337-319">1. Пользователь входит в корпоративную сеть и проходит проверку подлинности в Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-319">1. The user logs on to a corporate network, and is authenticated to Windows Server Active Directory.</span></span> |<span data-ttu-id="c9337-320">1. Пользователь входит в корпоративную сеть и проходит проверку подлинности в Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-320">1. The user logs on to a corporate network, and is authenticated to Windows Server Active Directory.</span></span> |
| <span data-ttu-id="c9337-321">2. Пользователь пытается получить доступ к Office 365 (имя @contoso.com).</span><span class="sxs-lookup"><span data-stu-id="c9337-321">2. The user tries to access Office 365 (I am @contoso.com).</span></span> |<span data-ttu-id="c9337-322">2. Пользователь пытается получить доступ к Office 365 (имя @contoso.com).</span><span class="sxs-lookup"><span data-stu-id="c9337-322">2. The user tries to access Office 365 (I am @contoso.com).</span></span> |
| <span data-ttu-id="c9337-323">3. Office 365 перенаправляет пользователя в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="c9337-323">3. Office 365 redirects the user to Azure AD.</span></span> |<span data-ttu-id="c9337-324">3. Office 365 перенаправляет пользователя в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="c9337-324">3. Office 365 redirects the user to Azure AD.</span></span> |
| <span data-ttu-id="c9337-325">4. Так как Azure AD не может проверить подлинность пользователя и учитывает, что с локальной инфраструктурой AD FS установлены доверительные отношения, пользователь перенаправляется в AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-325">4. Since Azure AD can’t authenticate the user and understands there is a trust with AD FS on-premises, it redirects the user to AD FS.</span></span> |<span data-ttu-id="c9337-326">4. Azure AD не может принять билеты Kerberos напрямую, так как доверительные отношения не установлены, поэтому пользователю отправляется запрос на ввод учетных данных.</span><span class="sxs-lookup"><span data-stu-id="c9337-326">4. Azure AD can’t accept Kerberos tickets directly and no trust relationship exists so it requests that the user enter credentials.</span></span> |
| <span data-ttu-id="c9337-327">5. Пользователь отправляет билет Kerberos в службу маркеров безопасности AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-327">5. The user sends a Kerberos ticket to the AD FS STS.</span></span> |<span data-ttu-id="c9337-328">5. Пользователь вводит те же локальные учетные данные, после чего Azure AD проверяет их на соответствие данным, синхронизированным с помощью DirSync.</span><span class="sxs-lookup"><span data-stu-id="c9337-328">5. The user enters the same on-premises password, and Azure AD validates them against the user name and password that was synchronized by DirSync.</span></span> |
| <span data-ttu-id="c9337-329">6. AD FS преобразовывает билет Kerberos в необходимый формат маркера или утверждения и перенаправляет пользователя в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="c9337-329">6. AD FS transforms the Kerberos ticket to the required token format/claims and redirects the user to Azure AD.</span></span> |<span data-ttu-id="c9337-330">6. Azure AD перенаправляет пользователя в Office 365.</span><span class="sxs-lookup"><span data-stu-id="c9337-330">6. Azure AD redirects the user to Office 365.</span></span> |
| <span data-ttu-id="c9337-331">7. Пользователь проходит проверку подлинности для Azure AD (выполняется еще одно преобразование).</span><span class="sxs-lookup"><span data-stu-id="c9337-331">7. The user authenticates to Azure AD (another transformation occurs).</span></span> |<span data-ttu-id="c9337-332">7. Пользователь может войти в Office 365 и OWA, используя маркер Azure AD.</span><span class="sxs-lookup"><span data-stu-id="c9337-332">7. The user can sign in to Office 365 and OWA using the Azure AD token.</span></span> |
| <span data-ttu-id="c9337-333">8. Azure AD перенаправляет пользователя в Office 365.</span><span class="sxs-lookup"><span data-stu-id="c9337-333">8. Azure AD redirects the user to Office 365.</span></span> | |
| <span data-ttu-id="c9337-334">9. Пользователь автоматически входит в Office 365.</span><span class="sxs-lookup"><span data-stu-id="c9337-334">9. The user is silently signed on to Office 365.</span></span> | |

<span data-ttu-id="c9337-335">В сценарии с Office 365, где применяется синхронизация паролей с помощью DirSync (без AD FS), единый вход заменяется на "такой же вход", где "такой же" означает, что во время доступа к Office 365 пользователю нужно повторно ввести те же локальные учетные данные.</span><span class="sxs-lookup"><span data-stu-id="c9337-335">In the Office 365 with DirSync with password sync scenario (no AD FS), single sign-on is replaced by “same sign-on” where “same” simply means that users must re-enter their same on-premises credentials when accessing Office 365.</span></span> <span data-ttu-id="c9337-336">Обратите внимание, браузер пользователя может сохранить эти данные, чтобы сократить число запросов в будущем.</span><span class="sxs-lookup"><span data-stu-id="c9337-336">Note that this data can be remembered by the user’s browser to help reduce subsequent prompts.</span></span>

### <a name="additional-food-for-thought"></a><span data-ttu-id="c9337-337">Важные сведения</span><span class="sxs-lookup"><span data-stu-id="c9337-337">Additional food for thought</span></span>
* <span data-ttu-id="c9337-338">Если прокси-сервер AD FS развертывается на виртуальной машине Azure, необходимо подключение к серверам AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-338">If you deploy an AD FS proxy on an Azure virtual machine, connectivity to the AD FS servers is needed.</span></span> <span data-ttu-id="c9337-339">Если серверы локальные, рекомендуется использовать VPN-подключение типа "сеть-сеть", предоставляемое виртуальной сетью, чтобы узлы прокси-служб веб-приложений могли взаимодействовать со своими серверами AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-339">If they are on-premises, it is recommended that you leverage the site-to-site VPN connectivity provided by the virtual network to allow the Web Application Proxy nodes to communicate with their AD FS servers.</span></span>
* <span data-ttu-id="c9337-340">Если сервер AD FS развертывается на виртуальной машине Azure, необходимо подключение к контроллерам домена Windows Server Active Directory, хранилищам атрибутов и базам данных конфигурации. Может также потребоваться подключение ExpressRoute или VPN-подключение типа "сеть-сеть" между виртуальной сетью Azure и локальной сетью.</span><span class="sxs-lookup"><span data-stu-id="c9337-340">If you deploy an AD FS server on an Azure virtual machine, connectivity to Windows Server Active Directory domain controllers, Attribute Stores, and Configuration databases is necessary and may also require an ExpressRoute or a site-to-site VPN connection between the Azure virtual network and the on-premises network.</span></span>
* <span data-ttu-id="c9337-341">За трафик, поступающий с виртуальных машин Azure, (исходящий) взимается плата.</span><span class="sxs-lookup"><span data-stu-id="c9337-341">Charges are applied to all traffic from Azure virtual machines (egress traffic).</span></span> <span data-ttu-id="c9337-342">Если затраты играют решающую роль, рекомендуется развертывать узлы прокси-служб веб-приложений в Azure, оставив серверы AD FS в локальной среде.</span><span class="sxs-lookup"><span data-stu-id="c9337-342">If cost is the driving factor, it is advisable to deploy the Web Application Proxy nodes on Azure, leaving the AD FS servers on-premises.</span></span> <span data-ttu-id="c9337-343">Если серверы AD FS также развертываются на виртуальных машинах Azure, за проверку подлинности локальных пользователей взимается дополнительная плата.</span><span class="sxs-lookup"><span data-stu-id="c9337-343">If the AD FS servers are deployed on Azure virtual machines as well, additional costs will be incurred to authenticate on-premises users.</span></span> <span data-ttu-id="c9337-344">Исходящий трафик оплачивается независимо от используемого подключения: ExpressRoute или VPN-подключение типа "сеть-сеть".</span><span class="sxs-lookup"><span data-stu-id="c9337-344">Egress traffic incurs a cost regardless of whether or not it is traversing the ExpressRoute or the VPN site-to-site connection.</span></span>
* <span data-ttu-id="c9337-345">Обратите внимание, если для обеспечения высокой доступности серверов AD FS будет использоваться собственная балансировка нагрузки сервера в Azure, будут выполняться проверки для определения состояния виртуальных машин в облачной службе.</span><span class="sxs-lookup"><span data-stu-id="c9337-345">If you decide to use Azure’s native server load balancing capabilities for high availability of AD FS servers, note that load balancing provides probes that are used to determine the health of the virtual machines within the cloud service.</span></span> <span data-ttu-id="c9337-346">В случае использования виртуальных машин Azure (в отличие от рабочих ролей или веб-ролей) необходимо использовать пользовательскую проверку, так как на этих машинах отсутствует агент, который отвечает на проверку по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="c9337-346">In the case of Azure virtual machines (as opposed to web or worker roles), a custom probe must be used since the agent that responds to the default probes is not present on Azure virtual machines.</span></span> <span data-ttu-id="c9337-347">Чтобы упростить этот процесс, можно использовать пользовательскую проверку TCP. В этом случае для определения работоспособности виртуальной машины требуется только успешное TCP-подключение (отправка сегмента TCP SYN и получение ответа с сегментом TCP SYN ACK).</span><span class="sxs-lookup"><span data-stu-id="c9337-347">For simplicity, you might use a custom TCP probe — this requires only that a TCP connection (a TCP SYN segment sent and responded to with a TCP SYN ACK segment) be successfully established to determine virtual machine health.</span></span> <span data-ttu-id="c9337-348">Вы можете настроить пользовательскую проверку таким образом, чтобы использовался любой TCP-порт, который активно прослушивается на ваших виртуальных машинах.</span><span class="sxs-lookup"><span data-stu-id="c9337-348">You can configure the custom probe to use any TCP port to which your virtual machines are actively listening.</span></span>

> [!NOTE]
> <span data-ttu-id="c9337-349">Компьютеры с одинаковым набором открытых в Интернете портов (например, порт 80 и 443), не могут использовать одну и ту же облачную службу.</span><span class="sxs-lookup"><span data-stu-id="c9337-349">Machines that need to expose the same set of ports directly to the Internet (such as port 80 and 443) cannot share the same cloud service.</span></span> <span data-ttu-id="c9337-350">Поэтому рекомендуется создать выделенную облачную службу для ваших серверов Windows Server AD FS, чтобы избежать потенциальных перекрытий в требованиях к портам для приложения и служб Windows Server AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-350">It is, therefore, recommended that you create a dedicated cloud service for your Windows Server AD FS servers in order to avoid potential overlaps between port requirements for an application and Windows Server AD FS.</span></span>
> 
> 

## <a name="deployment-scenarios"></a><span data-ttu-id="c9337-351">Сценарии развертывания</span><span class="sxs-lookup"><span data-stu-id="c9337-351">Deployment scenarios</span></span>
<span data-ttu-id="c9337-352">Ниже описаны обычные сценарии развертывания, а также приведены важные моменты, которые нужно учесть.</span><span class="sxs-lookup"><span data-stu-id="c9337-352">The following section outlines commonplace deployment scenarios to draw attention to important considerations that must be taken into account.</span></span> <span data-ttu-id="c9337-353">Каждый сценарий содержит ссылки на дополнительные сведения о решениях и факторах, требующих рассмотрения.</span><span class="sxs-lookup"><span data-stu-id="c9337-353">Each scenario has links to more details about the decisions and factors to consider.</span></span>

1. [<span data-ttu-id="c9337-354">AD DS: развертывание приложения с поддержкой AD DS, для которого не требуется подключение к корпоративной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-354">AD DS: Deploy an AD DS-aware application with no requirement for corporate network connectivity</span></span>](#BKMK_CloudOnly)
   
    <span data-ttu-id="c9337-355">К примеру, служба SharePoint с доступом через Интернет развертывается на виртуальной машине Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-355">For example, an Internet-facing SharePoint service is deployed on an Azure virtual machine.</span></span> <span data-ttu-id="c9337-356">У приложения нет зависимостей от ресурсов корпоративной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-356">The application has no dependencies on corporate-network resources.</span></span> <span data-ttu-id="c9337-357">Приложению требуются службы Windows Server AD DS, но НЕ требуются корпоративные службы Windows Server AD DS.</span><span class="sxs-lookup"><span data-stu-id="c9337-357">The application does require Windows Server AD DS but does NOT require the corporate Windows Server AD DS.</span></span>
2. [<span data-ttu-id="c9337-358">AD FS: предоставление доступа к локальному внешнему приложению с поддержкой утверждений через Интернет.</span><span class="sxs-lookup"><span data-stu-id="c9337-358">AD FS: Extend a claims-aware on-premises front-end application to the Internet</span></span>](#BKMK_CloudOnlyFed)
   
    <span data-ttu-id="c9337-359">Например, необходимо, чтобы развернутое в локальной среде приложение с поддержкой утверждений, которое используется корпоративными пользователями, стало доступным через Интернет.</span><span class="sxs-lookup"><span data-stu-id="c9337-359">For example, a claims-aware application that has been successfully deployed on-premises and used by corporate users needs to become accessible from the Internet.</span></span> <span data-ttu-id="c9337-360">Это приложение должно быть доступно напрямую через Интернет как для деловых партнеров при использовании их корпоративных удостоверений, так и для существующих корпоративных пользователей.</span><span class="sxs-lookup"><span data-stu-id="c9337-360">The application needs to be accessed directly over the Internet both by business partners using their own corporate identities and by existing corporate users.</span></span>
3. [<span data-ttu-id="c9337-361">AD DS: развертывание приложения с поддержкой Windows Server AD DS, для которого требуется подключение к корпоративной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-361">AD DS: Deploy a Windows Server AD DS-aware application that requires connectivity to the corporate network</span></span>](#BKMK_HybridExt)
   
    <span data-ttu-id="c9337-362">Например, поддерживающее LDAP и встроенную проверку подлинности Windows приложение, которое использует службы Windows Server AD DS в качестве репозитория для данных конфигурации и профилей пользователей, развертывается на виртуальной машине Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-362">For example, an LDAP-aware application that supports Windows-integrated authentication and uses Windows Server AD DS as a repository for configuration and user-profile data is deployed on an Azure virtual machine.</span></span> <span data-ttu-id="c9337-363">Рекомендуется, чтобы приложение использовало существующие корпоративные службы Windows Server AD DS и обеспечивало единый вход.</span><span class="sxs-lookup"><span data-stu-id="c9337-363">It is desirable for the application to leverage the existing corporate Windows Server AD DS and provide single sign-on.</span></span> <span data-ttu-id="c9337-364">Приложение не поддерживает утверждения.</span><span class="sxs-lookup"><span data-stu-id="c9337-364">The application is not claims-aware.</span></span>

### <span data-ttu-id="c9337-365"><a name="BKMK_CloudOnly"></a>1. AD DS: развертывание приложения с поддержкой AD DS, для которого не требуется подключение к корпоративной сети</span><span class="sxs-lookup"><span data-stu-id="c9337-365"><a name="BKMK_CloudOnly"></a>1. AD DS: Deploy an AD DS-aware application with no requirement for corporate network connectivity</span></span>
<span data-ttu-id="c9337-366">![Развертывание служб AD DS только в облаке](media/active-directory-deploying-ws-ad-guidelines/ADDS_cloud.png)
**Рис. 1**</span><span class="sxs-lookup"><span data-stu-id="c9337-366">![Cloud-only AD DS deployment](media/active-directory-deploying-ws-ad-guidelines/ADDS_cloud.png)
**Figure 1**</span></span>

#### <a name="description"></a><span data-ttu-id="c9337-367">Описание</span><span class="sxs-lookup"><span data-stu-id="c9337-367">Description</span></span>
<span data-ttu-id="c9337-368">Служба SharePoint развертывается на виртуальной машине Azure, а приложение не имеет зависимостей от ресурсов корпоративной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-368">SharePoint is deployed on an Azure virtual machine and the application has no dependencies on corporate-network resources.</span></span> <span data-ttu-id="c9337-369">Приложению требуются службы Windows Server AD DS, но *не* требуются корпоративные службы Windows Server AD DS.</span><span class="sxs-lookup"><span data-stu-id="c9337-369">The application does require Windows Server AD DS but does *not* require the corporate Windows Server AD DS.</span></span> <span data-ttu-id="c9337-370">Доверительные отношения с Kerberos и федерацией не требуются, так как пользователи самостоятельно подготавливаются для домена Windows Server AD DS, который также размещается в облаке на виртуальных машинах Azure, через приложение.</span><span class="sxs-lookup"><span data-stu-id="c9337-370">No Kerberos or federated trusts are required because users are self-provisioned through the application into the Windows Server AD DS domain that is also hosted in the cloud on Azure virtual machines.</span></span>

#### <a name="scenario-considerations-and-how-technology-areas-apply-to-the-scenario"></a><span data-ttu-id="c9337-371">Рекомендации по сценарию и применению технологий в его рамках</span><span class="sxs-lookup"><span data-stu-id="c9337-371">Scenario considerations and how technology areas apply to the scenario</span></span>
* <span data-ttu-id="c9337-372">[Топология сети](#BKMK_NetworkTopology). Создайте виртуальную сеть Azure без подключения между организациями (также называется подключением типа "сеть — сеть").</span><span class="sxs-lookup"><span data-stu-id="c9337-372">[Network topology](#BKMK_NetworkTopology): Create an Azure virtual network without cross-premises connectivity (also known as site-to-site connectivity).</span></span>
* <span data-ttu-id="c9337-373">[Настройка развертывания контроллера домена](#BKMK_DeploymentConfig). Разверните новый контроллер домена в новый лес Windows Server Active Directory с одним доменом.</span><span class="sxs-lookup"><span data-stu-id="c9337-373">[DC deployment configuration](#BKMK_DeploymentConfig): Deploy a new domain controller into a new, single-domain, Windows Server Active Directory forest.</span></span> <span data-ttu-id="c9337-374">Его необходимо развернуть вместе с DNS-сервером Windows.</span><span class="sxs-lookup"><span data-stu-id="c9337-374">This should be deployed along with the Windows DNS server.</span></span>
* <span data-ttu-id="c9337-375">[Топология сайтов Windows Server Active Directory](#BKMK_ADSiteTopology). Используйте сайт Windows Server Active Directory по умолчанию (все компьютеры будут относиться к объекту сайта Default-First-Site-Name).</span><span class="sxs-lookup"><span data-stu-id="c9337-375">[Windows Server Active Directory site topology](#BKMK_ADSiteTopology): Use the default Windows Server Active Directory site (all computers will be in Default-First-Site-Name).</span></span>
* <span data-ttu-id="c9337-376">[Назначение IP-адресов и DNS](#BKMK_IPAddressDNS):</span><span class="sxs-lookup"><span data-stu-id="c9337-376">[IP addressing and DNS](#BKMK_IPAddressDNS):</span></span>
  
  * <span data-ttu-id="c9337-377">Задайте статический IP-адрес для контроллера домена с помощью командлета Set-AzureStaticVNetIP в Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="c9337-377">Set a static IP address for the DC by using the Set-AzureStaticVNetIP Azure PowerShell cmdlet.</span></span>
  * <span data-ttu-id="c9337-378">Установите и настройте DNS Windows Server на контроллерах домена в Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-378">Install and configure Windows Server DNS on the domain controller(s) on Azure.</span></span>
  * <span data-ttu-id="c9337-379">Настройте свойства виртуальной сети, указав имя и IP-адрес виртуальной машины, на которой размещены роли контроллера домена и DNS-сервера.</span><span class="sxs-lookup"><span data-stu-id="c9337-379">Configure the virtual network properties with the name and IP address of the VM that hosts the DC and DNS server roles.</span></span>
* <span data-ttu-id="c9337-380">[Глобальный каталог](#BKMK_GC). Первый контроллер домена в лесу должен быть сервером глобального каталога.</span><span class="sxs-lookup"><span data-stu-id="c9337-380">[Global Catalog](#BKMK_GC): The first DC in the forest must be a global catalog server.</span></span> <span data-ttu-id="c9337-381">Дополнительные контроллеры домена необходимо настроить как глобальные каталоги, так как в лесу с одним доменом для глобального каталога не требуется каких-либо дополнительных действий со стороны контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="c9337-381">Additional DCs should also be configured as GCs because in a single domain forest, the global catalog does not require any additional work from the DC.</span></span>
* <span data-ttu-id="c9337-382">[Размещение базы данных и SYSVOL служб Windows Server AD DS](#BKMK_PlaceDB). Добавьте диск данных к контроллерам домена, работающим в качестве виртуальных машин Azure, для хранения базы данных, журналов и SYSVOL служб Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-382">[Placement of the Windows Server AD DS database and SYSVOL](#BKMK_PlaceDB): Add a data disk to DCs running as Azure VMs in order to store the Windows Server Active Directory database, logs, and SYSVOL.</span></span>
* <span data-ttu-id="c9337-383">[Резервное копирование и восстановление](#BKMK_BUR). Определите место хранения резервных копий состояния системы.</span><span class="sxs-lookup"><span data-stu-id="c9337-383">[Backup and Restore](#BKMK_BUR): Determine where you want to store system state backups.</span></span> <span data-ttu-id="c9337-384">При необходимости добавьте к виртуальной машине контроллера домена другой диск данных для хранения резервных копий.</span><span class="sxs-lookup"><span data-stu-id="c9337-384">If necessary, add another data disk to the DC VM to store backups.</span></span>

### <span data-ttu-id="c9337-385"><a name="BKMK_CloudOnlyFed"></a>2. AD FS: предоставление доступа к локальному внешнему приложению с поддержкой утверждений через Интернет</span><span class="sxs-lookup"><span data-stu-id="c9337-385"><a name="BKMK_CloudOnlyFed"></a>2 AD FS: Extend a claims-aware on-premises front-end application to the Internet</span></span>
<span data-ttu-id="c9337-386">![Федерация с подключением между организациями](media/active-directory-deploying-ws-ad-guidelines/Federation_xprem.png)
**Рис. 2**</span><span class="sxs-lookup"><span data-stu-id="c9337-386">![Federation with cross-premises connectivity](media/active-directory-deploying-ws-ad-guidelines/Federation_xprem.png)
**Figure 2**</span></span>

#### <a name="description"></a><span data-ttu-id="c9337-387">Description (Описание)</span><span class="sxs-lookup"><span data-stu-id="c9337-387">Description</span></span>
<span data-ttu-id="c9337-388">Необходимо, чтобы развернутое в локальной среде приложение с поддержкой утверждений, которое используется корпоративными пользователями, стало доступным напрямую через Интернет.</span><span class="sxs-lookup"><span data-stu-id="c9337-388">A claims-aware application that has been successfully deployed on-premises and used by corporate users needs to become accessible directly from the Internet.</span></span> <span data-ttu-id="c9337-389">Приложение выполняет функцию внешнего веб-интерфейса в базе данных SQL, в которой оно хранит данные.</span><span class="sxs-lookup"><span data-stu-id="c9337-389">The application serves as a web frontend to a SQL database in which it stores data.</span></span> <span data-ttu-id="c9337-390">Серверы SQL Server, используемые приложением, также находятся в корпоративной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-390">The SQL servers used by the application are also located on the corporate network.</span></span> <span data-ttu-id="c9337-391">Две службы маркеров безопасности Windows Server AD FS и балансировщик нагрузки развернуты в локальной среде для предоставления доступа корпоративным пользователям.</span><span class="sxs-lookup"><span data-stu-id="c9337-391">Two Windows Server AD FS STSs and a load-balancer have been deployed on-premises to provide access to the corporate users.</span></span> <span data-ttu-id="c9337-392">Теперь необходимо, чтобы приложение также было доступно непосредственно через Интернет как для деловых партнеров при использовании их корпоративных удостоверений, так и для существующих корпоративных пользователей.</span><span class="sxs-lookup"><span data-stu-id="c9337-392">The application now needs to be additionally accessed directly over the Internet both by business partners using their own corporate identities and by existing corporate users.</span></span>

<span data-ttu-id="c9337-393">Чтобы упростить процедуру развертывания и настройки в связи с новым требованием, на виртуальных машинах Azure необходимо установить два дополнительных внешних веб-интерфейса и два прокси-сервера Windows Server AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-393">In an effort to simplify and meet the deployment and configuration needs of this new requirement, it is decided that two additional web frontends and two Windows Server AD FS proxy servers be installed on Azure virtual machines.</span></span> <span data-ttu-id="c9337-394">Все четыре виртуальные машины будут доступны непосредственно через Интернет и подключены к локальной сети через VPN-подключение типа "сеть-сеть" виртуальной сети Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-394">All four VMs will be exposed directly to the Internet and will be provided connectivity to the on-premises network using Azure Virtual Network’s site-to-site VPN capability.</span></span>

#### <a name="scenario-considerations-and-how-technology-areas-apply-to-the-scenario"></a><span data-ttu-id="c9337-395">Рекомендации по сценарию и применению технологий в его рамках</span><span class="sxs-lookup"><span data-stu-id="c9337-395">Scenario considerations and how technology areas apply to the scenario</span></span>
* <span data-ttu-id="c9337-396">[Топология сети](#BKMK_NetworkTopology). Создайте виртуальную сеть Azure и [настройте подключение между организациями](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span><span class="sxs-lookup"><span data-stu-id="c9337-396">[Network topology](#BKMK_NetworkTopology): Create an Azure virtual network and [configure cross-premises connectivity](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="c9337-397">Необходимо, чтобы экземпляры Windows Server AD FS, запущенные в Azure, могли получить доступ к URL-адресу, определенному в шаблоне сертификата, и полученным сертификатам Windows Server AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-397">For each of the Windows Server AD FS certificates, ensure that the URL defined within the certificate template and the resulting certificates can be reached by the Windows Server AD FS instances running on Azure.</span></span> <span data-ttu-id="c9337-398">Для этого может потребоваться распределенное подключение для частей инфраструктуры PKI.</span><span class="sxs-lookup"><span data-stu-id="c9337-398">This may require cross-premises connectivity to parts of your PKI infrastructure.</span></span> <span data-ttu-id="c9337-399">К примеру, если конечная точка списка отзыва сертификатов создана на основе LDAP и расположена только в локальной среде, потребуется подключение между организациями.</span><span class="sxs-lookup"><span data-stu-id="c9337-399">For example if the CRL's endpoint is LDAP-based and hosted exclusively on-premises, then cross-premises connectivity will be required.</span></span> <span data-ttu-id="c9337-400">Если этого нужно избежать, необходимо использовать выданные центром сертификации сертификаты, списки отзыва сертификатов которых доступны через Интернет.</span><span class="sxs-lookup"><span data-stu-id="c9337-400">If this is not desirable, it may be necessary to use certificates issued by a CA whose CRL is accessible over the Internet.</span></span>
  > 
  > 
* <span data-ttu-id="c9337-401">[Настройка облачных служб](#BKMK_CloudSvcConfig). Для предоставления двух виртуальных IP-адресов с балансировкой нагрузки требуются две облачные службы.</span><span class="sxs-lookup"><span data-stu-id="c9337-401">[Cloud services configuration](#BKMK_CloudSvcConfig): Ensure you have two cloud services in order provide two load-balanced virtual IP addresses.</span></span> <span data-ttu-id="c9337-402">Виртуальный IP-адрес первой облачной службы будет направляться на две виртуальные машины прокси-сервера Windows Server AD FS через порты 80 и 443.</span><span class="sxs-lookup"><span data-stu-id="c9337-402">The first cloud service’s virtual IP address will be directed to the two Windows Server AD FS proxy VMs on ports 80 and 443.</span></span> <span data-ttu-id="c9337-403">Виртуальные машины прокси-сервера Windows Server AD FS будут настроены таким образом, чтобы они указывали на IP-адрес локального балансировщика нагрузки, который расположен перед службами маркеров безопасности Windows Server AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-403">The Windows Server AD FS proxy VMs will be configured to point to the IP address of the on-premises load-balancer that fronts the Windows Server AD FS STSs.</span></span> <span data-ttu-id="c9337-404">Виртуальный IP-адрес второй облачной службы будет направляться на две виртуальные машины с внешним веб-интерфейсом также через порты 80 и 443.</span><span class="sxs-lookup"><span data-stu-id="c9337-404">The second cloud service’s virtual IP address will be directed to the two VMs running the web frontend again on ports 80 and 443.</span></span> <span data-ttu-id="c9337-405">Настройте пользовательскую проверку, чтобы балансировщик нагрузки направлял трафик только на исправные прокси-серверы и виртуальные машины внешнего веб-интерфейса Windows Server AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-405">Configure a custom probe to ensure the load-balancer only directs traffic to functioning Windows Server AD FS proxy and web frontend VMs.</span></span>
* <span data-ttu-id="c9337-406">[Настройка сервера федерации](#BKMK_FedSrvConfig). Настройте службы Windows Server AD FS как сервер федерации (служба маркеров безопасности) для создания маркеров безопасности для леса Windows Server Active Directory, созданного в облаке.</span><span class="sxs-lookup"><span data-stu-id="c9337-406">[Federation server configuration](#BKMK_FedSrvConfig): Configure Windows Server AD FS as a federation server (STS) to generate security tokens for the Windows Server Active Directory forest created in the cloud.</span></span> <span data-ttu-id="c9337-407">Установите доверительные отношения между поставщиком утверждений федерации и различными партнерами, от которых необходимо принимать удостоверения, а также между проверяющей стороной и различными приложениями, для которых необходимо создавать маркеры.</span><span class="sxs-lookup"><span data-stu-id="c9337-407">Set federation claims provider trust relationships with the different partners you wish to accept identities from, and configure relying party trust relationships with the different applications you want to generate tokens to.</span></span>
  
    <span data-ttu-id="c9337-408">В большинстве сценариев в целях безопасности прокси-серверы Windows Server AD FS развертываются с возможностью доступа к Интернету, в то время как соответствующие части федерации остаются изолированными от прямого подключения к Интернету.</span><span class="sxs-lookup"><span data-stu-id="c9337-408">In most scenarios, Windows Server AD FS proxy servers are deployed in an Internet-facing capacity for security purposes while their Windows Server AD FS federation counterparts remain isolated from direct Internet connectivity.</span></span> <span data-ttu-id="c9337-409">Независимо от сценария развертывания для облачной службы необходимо настроить виртуальный IP-адрес, который предоставит открытый IP-адрес и порт с возможностью балансировки нагрузки по двум экземплярам службы маркеров безопасности или экземплярам прокси-сервера Windows Server AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-409">Regardless of your deployment scenario, you must configure your cloud service with a virtual IP address that will provide a publicly exposed IP address and port that is able to load-balance across either your two Windows Server AD FS STS instances or proxy instances.</span></span>
* <span data-ttu-id="c9337-410">[Настройка высокой доступности Windows Server AD FS](#BKMK_ADFSHighAvail). Рекомендуется развернуть ферму Windows Server AD FS по крайней мере с двумя серверами для отработки отказа и балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="c9337-410">[Windows Server AD FS high availability configuration](#BKMK_ADFSHighAvail): It is advisable to deploy a Windows Server AD FS farm with at least two servers for failover and load balancing.</span></span> <span data-ttu-id="c9337-411">Возможно, вам потребуется внутренняя база данных Windows (WID) для данных конфигурации Windows Server AD FS и внутренняя балансировка нагрузки Azure для распределения входящих запросов по серверам в ферме.</span><span class="sxs-lookup"><span data-stu-id="c9337-411">You might want to consider using the Windows Internal Database (WID) for Windows Server AD FS configuration data, and use the internal load balancing capability of Azure to distribute incoming requests across the servers in the farm.</span></span>

<span data-ttu-id="c9337-412">Дополнительные сведения см. в статье [AD DS Deployment Guide](https://technet.microsoft.com/library/cc753963) (Руководство по развертыванию AD DS).</span><span class="sxs-lookup"><span data-stu-id="c9337-412">For more information, see the [AD DS Deployment Guide](https://technet.microsoft.com/library/cc753963).</span></span>

### <span data-ttu-id="c9337-413"><a name="BKMK_HybridExt"></a>3. AD DS: развертывание приложения с поддержкой Windows Server AD DS, для которого требуется подключение к корпоративной сети</span><span class="sxs-lookup"><span data-stu-id="c9337-413"><a name="BKMK_HybridExt"></a>3. AD DS: Deploy a Windows Server AD DS-aware application that requires connectivity to the corporate network</span></span>
<span data-ttu-id="c9337-414">![Развертывание служб AD DS между организациями](media/active-directory-deploying-ws-ad-guidelines/ADDS_xprem.png)
**Рис. 3**</span><span class="sxs-lookup"><span data-stu-id="c9337-414">![Cross-premises AD DS deployment](media/active-directory-deploying-ws-ad-guidelines/ADDS_xprem.png)
**Figure 3**</span></span>

#### <a name="description"></a><span data-ttu-id="c9337-415">Описание</span><span class="sxs-lookup"><span data-stu-id="c9337-415">Description</span></span>
<span data-ttu-id="c9337-416">Приложение, поддерживающее LDAP, развертывается на виртуальной машине Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-416">An LDAP-aware application is deployed on an Azure virtual machine.</span></span> <span data-ttu-id="c9337-417">Оно поддерживает встроенную проверку подлинности Windows и использует Windows Server AD DS в качестве репозитория для данных конфигурации и профилей пользователей.</span><span class="sxs-lookup"><span data-stu-id="c9337-417">It supports Windows-integrated authentication and uses Windows Server AD DS as a repository for configuration and user profile data.</span></span> <span data-ttu-id="c9337-418">Необходимо, чтобы приложение использовало существующие корпоративные службы Windows Server AD DS и обеспечивало единый вход.</span><span class="sxs-lookup"><span data-stu-id="c9337-418">The goal is for the application to leverage the existing corporate Windows Server AD DS and provide single sign-on.</span></span> <span data-ttu-id="c9337-419">Приложение не поддерживает утверждения.</span><span class="sxs-lookup"><span data-stu-id="c9337-419">The application is not claims-aware.</span></span> <span data-ttu-id="c9337-420">Пользователи также должны получать доступ к приложению непосредственно через Интернет.</span><span class="sxs-lookup"><span data-stu-id="c9337-420">Users also need to access the application directly from the Internet.</span></span> <span data-ttu-id="c9337-421">Чтобы оптимизировать производительность и расходы, вместе с приложением в Azure развертываются два дополнительных контроллера домена, которые являются частью корпоративного домена.</span><span class="sxs-lookup"><span data-stu-id="c9337-421">To optimize for performance and cost, it is decided that two additional domain controllers that are part of the corporate domain be deployed alongside the application on Azure.</span></span>

#### <a name="scenario-considerations-and-how-technology-areas-apply-to-the-scenario"></a><span data-ttu-id="c9337-422">Рекомендации по сценарию и применению технологий в его рамках</span><span class="sxs-lookup"><span data-stu-id="c9337-422">Scenario considerations and how technology areas apply to the scenario</span></span>
* <span data-ttu-id="c9337-423">[Топология сети](#BKMK_NetworkTopology). Создайте виртуальную сеть Azure с возможностью [подключения между организациями](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span><span class="sxs-lookup"><span data-stu-id="c9337-423">[Network topology](#BKMK_NetworkTopology): Create an Azure virtual network with [cross-premises connectivity](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span></span>
* <span data-ttu-id="c9337-424">[Метод установки](#BKMK_InstallMethod). Разверните реплики контроллеров домена из корпоративного домена Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-424">[Installation method](#BKMK_InstallMethod): Deploy replica DCs from the corporate Windows Server Active Directory domain.</span></span> <span data-ttu-id="c9337-425">Для реплики контроллера домена можно установить Windows Server AD DS на виртуальной машине и при необходимости использовать функцию установки с носителя, чтобы сократить объем данных, которые необходимо реплицировать в новый контроллер домена во время установки.</span><span class="sxs-lookup"><span data-stu-id="c9337-425">For a replica DC, you can install Windows Server AD DS on the VM, and optionally use the Install From Media (IFM) feature to reduce the amount of data that needs to be replicated to the new DC during installation.</span></span> <span data-ttu-id="c9337-426">Руководство см. в статье [Установка реплики контроллера домена Active Directory в виртуальной сети Azure](active-directory-install-replica-active-directory-domain-controller.md).</span><span class="sxs-lookup"><span data-stu-id="c9337-426">For a tutorial, see [Install a replica Active Directory domain controller on Azure](active-directory-install-replica-active-directory-domain-controller.md).</span></span> <span data-ttu-id="c9337-427">Даже при использовании функции установки с носителя создание виртуальных локальных контроллеров домена и перемещение всего виртуального жесткого диска (VHD) в облако может быть гораздо эффективнее репликации Windows Server AD DS во время установки.</span><span class="sxs-lookup"><span data-stu-id="c9337-427">Even if you use IFM, it may be more efficient to build the virtual DC on-premises and move the entire Virtual Hard Disk (VHD) to the cloud instead of replicating Windows Server AD DS during installation.</span></span> <span data-ttu-id="c9337-428">В целях безопасности после копирования виртуального жесткого диска в Azure рекомендуется удалить его из локальной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-428">For safety, it is recommended that you delete the VHD from the on-premises network once it has been copied to Azure.</span></span>
* <span data-ttu-id="c9337-429">[Топология сайтов Windows Server Active Directory](#BKMK_ADSiteTopology). Создайте сайт Azure в оснастке "Active Directory — сайты и службы".</span><span class="sxs-lookup"><span data-stu-id="c9337-429">[Windows Server Active Directory site topology](#BKMK_ADSiteTopology): Create a new Azure site in Active Directory Sites and Services.</span></span> <span data-ttu-id="c9337-430">Затем создайте объект подсети Windows Server Active Directory в качестве виртуальной сети Azure и добавьте его к сайту.</span><span class="sxs-lookup"><span data-stu-id="c9337-430">Create a Windows Server Active Directory subnet object to represent the Azure virtual network and add the subnet to the site.</span></span> <span data-ttu-id="c9337-431">После этого создайте новую связь между новым сайтом Azure и сайтом, в котором находится конечная точка VPN виртуальной сети Azure, для управления входящим и исходящим трафиком Azure для Windows Server Active Directory и его оптимизации.</span><span class="sxs-lookup"><span data-stu-id="c9337-431">Create a new site link that includes the new Azure site and the site in which the Azure virtual network VPN endpoint is located in order to control and optimize Windows Server Active Directory traffic to and from Azure.</span></span>
* <span data-ttu-id="c9337-432">[Назначение IP-адресов и DNS](#BKMK_IPAddressDNS):</span><span class="sxs-lookup"><span data-stu-id="c9337-432">[IP addressing and DNS](#BKMK_IPAddressDNS):</span></span>
  
  * <span data-ttu-id="c9337-433">Задайте статический IP-адрес для контроллера домена с помощью командлета Set-AzureStaticVNetIP в Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="c9337-433">Set a static IP address for the DC by using the Set-AzureStaticVNetIP Azure PowerShell cmdlet.</span></span>
  * <span data-ttu-id="c9337-434">Установите и настройте DNS Windows Server на контроллерах домена в Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-434">Install and configure Windows Server DNS on the domain controller(s) on Azure.</span></span>
  * <span data-ttu-id="c9337-435">Настройте свойства виртуальной сети, указав имя и IP-адрес виртуальной машины, на которой размещены роли контроллера домена и DNS-сервера.</span><span class="sxs-lookup"><span data-stu-id="c9337-435">Configure the virtual network properties with the name and IP address of the VM that hosts the DC and DNS server roles.</span></span>
* <span data-ttu-id="c9337-436">[Географически распределенные контроллеры домена](#BKMK_DistributedDCs). При необходимости настройте дополнительные виртуальные сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-436">[Geo-distributed DCs](#BKMK_DistributedDCs): Configure additional virtual networks as needed.</span></span> <span data-ttu-id="c9337-437">Если для топологии сайтов Active Directory требуются контроллеры доменов в географических регионах, которые соответствуют разным регионам Azure, необходимо создавать сайты Active Directory соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="c9337-437">If your Active Directory site topology requires DCs in geographies that correspond to different Azure regions, than you want to create Active Directory sites accordingly.</span></span>
* <span data-ttu-id="c9337-438">[Контроллеры домена только для чтения](#BKMK_RODC). Вы можете развернуть контроллер домена только для чтения на сайте Azure в зависимости от требований к выполнению операций записи для контроллера домена и совместимости приложений и служб на сайте с этими контроллерами домена.</span><span class="sxs-lookup"><span data-stu-id="c9337-438">[Read-only DCs](#BKMK_RODC): You might deploy an RODC in the Azure site, depending on your requirements for performing write operations against the DC and the compatibility of applications and services in the site with RODCs.</span></span> <span data-ttu-id="c9337-439">Дополнительные сведения о совместимости приложений см. в разделе [Read-Only domain controllers application compatibility guide](https://technet.microsoft.com/library/cc755190) (Совместимость приложений с контроллерами домена только для чтения).</span><span class="sxs-lookup"><span data-stu-id="c9337-439">For more information about application compatibility, see the [Read-Only domain controllers application compatibility guide](https://technet.microsoft.com/library/cc755190).</span></span>
* <span data-ttu-id="c9337-440">[Глобальный каталог](#BKMK_GC). Глобальные каталоги нужны для обслуживания запросов на вход в мультидоменных лесах.</span><span class="sxs-lookup"><span data-stu-id="c9337-440">[Global Catalog](#BKMK_GC): GCs are needed to service logon requests in multidomain forests.</span></span> <span data-ttu-id="c9337-441">Если на сайте Azure не развернут глобальный каталог, с вас будет взиматься плата за исходящий трафик, так как запросы на проверку подлинности приведут к возникновению глобальных каталогов запросов на других сайтах.</span><span class="sxs-lookup"><span data-stu-id="c9337-441">If you do not deploy a GC in the Azure site, you will incur egress traffic costs as authentication requests cause queries GCs in other sites.</span></span> <span data-ttu-id="c9337-442">Чтобы уменьшить объем этого трафика, можно включить кэширование сведений о членстве в универсальных группах для сайта Azure в оснастке "Active Directory — сайты и службы".</span><span class="sxs-lookup"><span data-stu-id="c9337-442">To minimize that traffic, you can enable universal group membership caching for the Azure site in Active Directory Sites and Services.</span></span>
  
    <span data-ttu-id="c9337-443">Если глобальный каталог развертывается, настройте связи сайтов и их стоимость, чтобы глобальный каталог на сайте Azure не был выбран в качестве исходного контроллера домена другими глобальными каталогами, которым необходимо реплицировать те же частичные разделы домена.</span><span class="sxs-lookup"><span data-stu-id="c9337-443">If you deploy a GC, configure site links and site links costs so that the GC in the Azure site is not preferred as a source DC by other GCs that need to replicate the same partial domain partitions.</span></span>
* <span data-ttu-id="c9337-444">[Размещение базы данных и SYSVOL служб Windows Server AD DS](#BKMK_PlaceDB). Добавьте диск данных к контроллерам домена, запущенным на виртуальных машинах Azure, для хранения базы данных, журналов и SYSVOL служб Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-444">[Placement of the Windows Server AD DS database and SYSVOL](#BKMK_PlaceDB): Add a data disk to DCs running on Azure VMs in order to store the Windows Server Active Directory database, logs, and SYSVOL.</span></span>
* <span data-ttu-id="c9337-445">[Резервное копирование и восстановление](#BKMK_BUR). Определите место хранения резервных копий состояния системы.</span><span class="sxs-lookup"><span data-stu-id="c9337-445">[Backup and Restore](#BKMK_BUR): Determine where you want to store system state backups.</span></span> <span data-ttu-id="c9337-446">При необходимости добавьте к виртуальной машине контроллера домена другой диск данных для хранения резервных копий.</span><span class="sxs-lookup"><span data-stu-id="c9337-446">If necessary, add another data disk to the DC VM to store backups.</span></span>

## <a name="deployment-decisions-and-factors"></a><span data-ttu-id="c9337-447">Решения и факторы, связанные с развертыванием</span><span class="sxs-lookup"><span data-stu-id="c9337-447">Deployment decisions and factors</span></span>
<span data-ttu-id="c9337-448">В следующей таблице приведены технологические области Windows Server Active Directory, которые затрагиваются в описанных выше сценариях, и соответствующие решения, а также ссылки на более подробное описание.</span><span class="sxs-lookup"><span data-stu-id="c9337-448">This table summarizes the Windows Server Active Directory technology areas that are impacted in the preceding scenarios and the corresponding decisions to consider, with links to more detail below.</span></span> <span data-ttu-id="c9337-449">Некоторые технологические области могут быть неприменимы к каждому сценарию развертывания, в то время как некоторые области могут быть более важными для сценария развертывания, чем другие.</span><span class="sxs-lookup"><span data-stu-id="c9337-449">Some technology areas might not be applicable to every deployment scenario, and some technology areas might be more critical to a deployment scenario than other technology areas.</span></span>

<span data-ttu-id="c9337-450">Например, если реплика контроллера домена развертывается в виртуальной сети, а в лесу есть только один домен, то развертывание сервера глобального каталога в этом случае не будет особенно важным для сценария развертывания, так как при этом не будут возникать какие-либо дополнительные требования к репликации.</span><span class="sxs-lookup"><span data-stu-id="c9337-450">For example, if you deploy a replica DC on a virtual network and your forest has only a single domain, then choosing to deploy a global catalog server in that case will not be critical to the deployment scenario because it will not create any additional replication requirements.</span></span> <span data-ttu-id="c9337-451">С другой стороны, если в лесу есть несколько доменов, то развертывание глобального каталога в виртуальной сети может повлиять на пропускную способность, производительность, проверку подлинности, поиск в каталоге и т. д.</span><span class="sxs-lookup"><span data-stu-id="c9337-451">On the other hand, if the forest has several domains, then the decision to deploy a global catalog on a virtual network could affect available bandwidth, performance, authentication, directory lookups, and so on.</span></span>

| <span data-ttu-id="c9337-452">Технологическая область Windows Server Active Directory</span><span class="sxs-lookup"><span data-stu-id="c9337-452">Windows Server Active Directory technology area</span></span> | <span data-ttu-id="c9337-453">Решения</span><span class="sxs-lookup"><span data-stu-id="c9337-453">Decisions</span></span> | <span data-ttu-id="c9337-454">Факторы</span><span class="sxs-lookup"><span data-stu-id="c9337-454">Factors</span></span> |
| --- | --- | --- |
| [<span data-ttu-id="c9337-455">Топология сети</span><span class="sxs-lookup"><span data-stu-id="c9337-455">Network topology</span></span>](#BKMK_NetworkTopology) |<span data-ttu-id="c9337-456">Нужно ли создавать виртуальную сеть?</span><span class="sxs-lookup"><span data-stu-id="c9337-456">Do you create a virtual network?</span></span> |<li><span data-ttu-id="c9337-457">Требования к доступу к корпоративным ресурсам</span><span class="sxs-lookup"><span data-stu-id="c9337-457">Requirements to access Corp resources</span></span></li> <li><span data-ttu-id="c9337-458">Аутентификация</span><span class="sxs-lookup"><span data-stu-id="c9337-458">Authentication</span></span></li> <li><span data-ttu-id="c9337-459">Управление учетными записями</span><span class="sxs-lookup"><span data-stu-id="c9337-459">Account management</span></span></li> |
| [<span data-ttu-id="c9337-460">Настройка развертывания контроллера домена</span><span class="sxs-lookup"><span data-stu-id="c9337-460">DC deployment configuration</span></span>](#BKMK_DeploymentConfig) |<li><span data-ttu-id="c9337-461">Нужно ли развернуть отдельный лес без отношений доверия?</span><span class="sxs-lookup"><span data-stu-id="c9337-461">Deploy a separate forest without any trusts?</span></span></li> <li><span data-ttu-id="c9337-462">Нужно ли развернуть новый лес с федерацией?</span><span class="sxs-lookup"><span data-stu-id="c9337-462">Deploy a new forest with federation?</span></span></li> <li><span data-ttu-id="c9337-463">Нужно ли развернуть новый лес с отношениями доверия с лесом Windows Server Active Directory или Kerberos?</span><span class="sxs-lookup"><span data-stu-id="c9337-463">Deploy a new forest with Windows Server Active Directory forest trust or Kerberos?</span></span></li> <li><span data-ttu-id="c9337-464">Нужно ли расширить корпоративный лес путем развертывания реплики контроллера домена?</span><span class="sxs-lookup"><span data-stu-id="c9337-464">Extend Corp forest by deploying a replica DC?</span></span></li> <li><span data-ttu-id="c9337-465">Нужно ли расширить корпоративный лес с помощью развертывания нового дочернего домена или доменного дерева?</span><span class="sxs-lookup"><span data-stu-id="c9337-465">Extend Corp forest by deploying a new child domain or domain tree?</span></span></li> |<li><span data-ttu-id="c9337-466">Безопасность</span><span class="sxs-lookup"><span data-stu-id="c9337-466">Security</span></span></li> <li><span data-ttu-id="c9337-467">Соответствие нормативным требованиям</span><span class="sxs-lookup"><span data-stu-id="c9337-467">Compliance</span></span></li> <li><span data-ttu-id="c9337-468">Стоимость</span><span class="sxs-lookup"><span data-stu-id="c9337-468">Cost</span></span></li> <li><span data-ttu-id="c9337-469">Устойчивость к сбоям</span><span class="sxs-lookup"><span data-stu-id="c9337-469">Resiliency and fault-tolerance</span></span></li> <li><span data-ttu-id="c9337-470">Совместимость приложений</span><span class="sxs-lookup"><span data-stu-id="c9337-470">Application compatibility</span></span></li> |
| [<span data-ttu-id="c9337-471">Топология сайтов Windows Server Active Directory</span><span class="sxs-lookup"><span data-stu-id="c9337-471">Windows Server Active Directory site topology</span></span>](#BKMK_ADSiteTopology) |<span data-ttu-id="c9337-472">Каким образом нужно настроить подсети, сайты и связи сайтов с помощью виртуальной сети Azure для оптимизации трафика и сокращения затрат?</span><span class="sxs-lookup"><span data-stu-id="c9337-472">How do you configure subnets, sites, and site links with Azure Virtual Network to optimize traffic and minimize cost?</span></span> |<li><span data-ttu-id="c9337-473">Определения подсетей и сайтов</span><span class="sxs-lookup"><span data-stu-id="c9337-473">Subnet and site definitions</span></span></li> <li><span data-ttu-id="c9337-474">Свойства связей сайтов и уведомления об изменениях</span><span class="sxs-lookup"><span data-stu-id="c9337-474">Site link properties and change notification</span></span></li> <li><span data-ttu-id="c9337-475">Сжатие репликации</span><span class="sxs-lookup"><span data-stu-id="c9337-475">Replication compression</span></span></li> |
| [<span data-ttu-id="c9337-476">Назначение IP-адресов и DNS</span><span class="sxs-lookup"><span data-stu-id="c9337-476">IP addressing and DNS</span></span>](#BKMK_IPAddressDNS) |<span data-ttu-id="c9337-477">Как настроить IP-адреса и разрешение имен?</span><span class="sxs-lookup"><span data-stu-id="c9337-477">How to configure IP addresses and name resolution?</span></span> |<li><span data-ttu-id="c9337-478">Воспользуйтесь командлетом Set-AzureStaticVNetIP, чтобы назначить статический IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="c9337-478">Use the Use the Set-AzureStaticVNetIP cmdlet to assign a static IP address</span></span></li> <li><span data-ttu-id="c9337-479">Установите DNS-сервер Windows Server и настройте свойства виртуальной сети, указав имя и IP-адрес виртуальной машины, на которой размещены роли контроллера домена и DNS-сервера.</span><span class="sxs-lookup"><span data-stu-id="c9337-479">Install Windows Server DNS server and configure the virtual network properties with the name and IP address of the VM that hosts the DC and DNS server roles</span></span></li> |
| [<span data-ttu-id="c9337-480">Географически распределенные контроллеры домена</span><span class="sxs-lookup"><span data-stu-id="c9337-480">Geo-distributed DCs</span></span>](#BKMK_DistributedDCs) |<span data-ttu-id="c9337-481">Как выполнять репликацию в контроллеры домена в отдельных виртуальных сетях?</span><span class="sxs-lookup"><span data-stu-id="c9337-481">How to replicate to DCs on separate virtual networks?</span></span> |<span data-ttu-id="c9337-482">Если для топологии сайтов Active Directory требуются контроллеры доменов в географических регионах, которые соответствуют разным регионам Azure, необходимо создавать сайты Active Directory соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="c9337-482">If your Active Directory site topology requires DCs in geographies that corresponds to different Azure regions, than you want to create Active Directory sites accordingly.</span></span> <span data-ttu-id="c9337-483">[Настройте подключение между виртуальными сетями](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md) , чтобы обеспечить репликацию между контроллерами домена в отдельных виртуальных сетях.</span><span class="sxs-lookup"><span data-stu-id="c9337-483">[Configure virtual network to virtual network Connectivity](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md) to replicate between domain controllers on separate virtual networks.</span></span> |
| [<span data-ttu-id="c9337-484">Контроллеры доменов только для чтения</span><span class="sxs-lookup"><span data-stu-id="c9337-484">Read-only DCs</span></span>](#BKMK_RODC) |<span data-ttu-id="c9337-485">Нужно ли использовать контроллеры домена только для чтения или с возможностью записи?</span><span class="sxs-lookup"><span data-stu-id="c9337-485">Use read-only or writeable DCs?</span></span> |<li><span data-ttu-id="c9337-486">Фильтрация атрибутов HBI и PII</span><span class="sxs-lookup"><span data-stu-id="c9337-486">Filter HBI/PII attributes</span></span></li> <li><span data-ttu-id="c9337-487">Фильтрация секретных данных</span><span class="sxs-lookup"><span data-stu-id="c9337-487">Filter secrets</span></span></li> <li><span data-ttu-id="c9337-488">Ограничения исходящего трафика</span><span class="sxs-lookup"><span data-stu-id="c9337-488">Limit outbound traffic</span></span></li> |
| [<span data-ttu-id="c9337-489">Глобальный каталог</span><span class="sxs-lookup"><span data-stu-id="c9337-489">Global catalog</span></span>](#BKMK_GC) |<span data-ttu-id="c9337-490">Нужно ли устанавливать глобальный каталог?</span><span class="sxs-lookup"><span data-stu-id="c9337-490">Install global catalog?</span></span> |<li><span data-ttu-id="c9337-491">Для леса с одним доменом настройте все контроллеры домена в качестве глобальных каталогов.</span><span class="sxs-lookup"><span data-stu-id="c9337-491">For single-domain forest, make all DCs GCs</span></span></li> <li><span data-ttu-id="c9337-492">При использовании мультидоменного леса глобальные каталоги необходимы для аутентификации.</span><span class="sxs-lookup"><span data-stu-id="c9337-492">For multidomain forest, GCs are required for authentication</span></span></li> |
| [<span data-ttu-id="c9337-493">Метод установки</span><span class="sxs-lookup"><span data-stu-id="c9337-493">Installation method</span></span>](#BKMK_InstallMethod) |<span data-ttu-id="c9337-494">Как установить контроллер домена в Azure?</span><span class="sxs-lookup"><span data-stu-id="c9337-494">How to install DC in Azure?</span></span> |<span data-ttu-id="c9337-495">Одно из двух:</span><span class="sxs-lookup"><span data-stu-id="c9337-495">Either:</span></span> <li><span data-ttu-id="c9337-496">Установите AD DS с помощью Windows PowerShell или Dcpromo.</span><span class="sxs-lookup"><span data-stu-id="c9337-496">Install AD DS using Windows PowerShell or Dcpromo</span></span></li> <li><span data-ttu-id="c9337-497">Переместите VHD локального виртуального контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="c9337-497">Move VHD of an on-premises virtual DC</span></span></li> |
| [<span data-ttu-id="c9337-498">Размещение базы данных и SYSVOL служб Windows Server AD DS</span><span class="sxs-lookup"><span data-stu-id="c9337-498">Placement of the Windows Server AD DS database and SYSVOL</span></span>](#BKMK_PlaceDB) |<span data-ttu-id="c9337-499">Где будут храниться база данных, журналы и SYSVOL служб Windows Server AD DS?</span><span class="sxs-lookup"><span data-stu-id="c9337-499">Where to store Windows Server AD DS database, logs, and SYSVOL?</span></span> |<span data-ttu-id="c9337-500">Измените значения по умолчанию в файле Dcpromo.exe.</span><span class="sxs-lookup"><span data-stu-id="c9337-500">Change Dcpromo.exe default values.</span></span> <span data-ttu-id="c9337-501">Эти критически важные файлы Active Directory *необходимо* разместить на дисках данных Azure, а не на дисках операционной системы, которые реализуют кэширование записи.</span><span class="sxs-lookup"><span data-stu-id="c9337-501">These critical Active Directory files *must* be placed on Azure Data Disks instead of Operating System disks that implement write caching.</span></span> |
| [<span data-ttu-id="c9337-502">Резервное копирование и восстановление</span><span class="sxs-lookup"><span data-stu-id="c9337-502">Backup and Restore</span></span>](#BKMK_BUR) |<span data-ttu-id="c9337-503">Как выполнять защиту и восстановление данных?</span><span class="sxs-lookup"><span data-stu-id="c9337-503">How to safeguard and recover data?</span></span> |<span data-ttu-id="c9337-504">Создайте резервные копии состояния системы.</span><span class="sxs-lookup"><span data-stu-id="c9337-504">Create system state backups</span></span> |
| [<span data-ttu-id="c9337-505">Настройка сервера федерации</span><span class="sxs-lookup"><span data-stu-id="c9337-505">Federation server configuration</span></span>](#BKMK_FedSrvConfig) |<li><span data-ttu-id="c9337-506">Нужно ли развернуть новый лес с федерацией в облаке?</span><span class="sxs-lookup"><span data-stu-id="c9337-506">Deploy a new forest with federation in the cloud?</span></span></li> <li><span data-ttu-id="c9337-507">Нужно ли развернуть AD FS локально и предоставлять доступ к прокси-серверу в облаке?</span><span class="sxs-lookup"><span data-stu-id="c9337-507">Deploy AD FS on-premises and expose a proxy in the cloud?</span></span></li> |<li><span data-ttu-id="c9337-508">Безопасность</span><span class="sxs-lookup"><span data-stu-id="c9337-508">Security</span></span></li> <li><span data-ttu-id="c9337-509">Соответствие нормативным требованиям</span><span class="sxs-lookup"><span data-stu-id="c9337-509">Compliance</span></span></li> <li><span data-ttu-id="c9337-510">Стоимость</span><span class="sxs-lookup"><span data-stu-id="c9337-510">Cost</span></span></li> <li><span data-ttu-id="c9337-511">Доступ к приложениям для деловых партнеров</span><span class="sxs-lookup"><span data-stu-id="c9337-511">Access to applications by business partners</span></span></li> |
| [<span data-ttu-id="c9337-512">Настройка облачных служб</span><span class="sxs-lookup"><span data-stu-id="c9337-512">Cloud services configuration</span></span>](#BKMK_CloudSvcConfig) |<span data-ttu-id="c9337-513">Облачная служба неявно развертывается при первом создании виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="c9337-513">A cloud service is implicitly deployed the first time you create a virtual machine.</span></span> <span data-ttu-id="c9337-514">Нужно ли развертывать дополнительные облачные службы?</span><span class="sxs-lookup"><span data-stu-id="c9337-514">Do you need to deploy additional cloud services?</span></span> |<li><span data-ttu-id="c9337-515">Необходимость наличия прямого доступа к Интернету для виртуальных машин</span><span class="sxs-lookup"><span data-stu-id="c9337-515">Does a VM or VMs require direct exposure to the Internet?</span></span></li> <li> <span data-ttu-id="c9337-516">Необходимость балансировки нагрузки для службы</span><span class="sxs-lookup"><span data-stu-id="c9337-516">Does the service require load-balancing?</span></span></li> |
| [<span data-ttu-id="c9337-517">Требования сервера федерации в отношении общих и частных IP-адресов (динамические и виртуальные IP-адреса)</span><span class="sxs-lookup"><span data-stu-id="c9337-517">Federation server requirements for public and private IP addressing (dynamic IP vs. virtual IP)</span></span>](#BKMK_FedReqVIPDIP) |<li><span data-ttu-id="c9337-518">Требуется ли прямой доступ к экземпляру Windows Server AD FS через Интернет?</span><span class="sxs-lookup"><span data-stu-id="c9337-518">Does the Windows Server AD FS instance need to be reached directly from the Internet?</span></span></li> <li><span data-ttu-id="c9337-519">Требуются ли для приложения, развертываемого в облаке, отдельные IP-адрес и порт в Интернете?</span><span class="sxs-lookup"><span data-stu-id="c9337-519">Does the application being deployed in the cloud require its own Internet-facing IP address and port?</span></span></li> |<span data-ttu-id="c9337-520">Создайте одну облачную службу для каждого виртуального IP-адреса, требуемого для развертывания.</span><span class="sxs-lookup"><span data-stu-id="c9337-520">Create one cloud-service for each virtual IP address that is required by your deployment</span></span> |
| [<span data-ttu-id="c9337-521">Настройка высокой доступности Windows Server AD FS</span><span class="sxs-lookup"><span data-stu-id="c9337-521">Windows Server AD FS high availability configuration</span></span>](#BKMK_ADFSHighAvail) |<li><span data-ttu-id="c9337-522">Сколько узлов будет содержаться в ферме серверов Windows Server AD FS?</span><span class="sxs-lookup"><span data-stu-id="c9337-522">How many nodes in my Windows Server AD FS server farm?</span></span></li> <li><span data-ttu-id="c9337-523">Сколько узлов необходимо развернуть в ферме прокси-серверов Windows Server AD FS?</span><span class="sxs-lookup"><span data-stu-id="c9337-523">How many nodes to deploy in my Windows Server AD FS proxy farm?</span></span></li> |<span data-ttu-id="c9337-524">Устойчивость к сбоям</span><span class="sxs-lookup"><span data-stu-id="c9337-524">Resiliency and fault tolerance</span></span> |

### <span data-ttu-id="c9337-525"><a name="BKMK_NetworkTopology"></a>Топология сети</span><span class="sxs-lookup"><span data-stu-id="c9337-525"><a name="BKMK_NetworkTopology"></a>Network topology</span></span>
<span data-ttu-id="c9337-526">Чтобы обеспечить соблюдение требований к DNS и согласованности IP-адресов для Windows Server AD DS, сначала необходимо создать [виртуальную сеть Azure](../virtual-network/virtual-networks-overview.md) и присоединить к ней виртуальные машины.</span><span class="sxs-lookup"><span data-stu-id="c9337-526">In order to meet the IP address consistency and DNS requirements of Windows Server AD DS, it is necessary to first create an [Azure virtual network](../virtual-network/virtual-networks-overview.md) and attach your virtual machines to it.</span></span> <span data-ttu-id="c9337-527">Во время создания этой сети необходимо решить, требуется ли подключение к локальной корпоративной сети, чтобы прозрачно подключать виртуальные машины Azure к локальным компьютерам. Для этого нужны стандартные технологии VPN и конечная точка VPN на границе корпоративной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-527">During its creation, you must decide whether to optionally extend connectivity to your on-premises corporate network, which transparently connects Azure virtual machines to on-premises machines — this is achieved using traditional VPN technologies and requires that a VPN endpoint be exposed on the edge of the corporate network.</span></span> <span data-ttu-id="c9337-528">То есть VPN-подключение инициируется из Azure к корпоративной сети, а не наоборот.</span><span class="sxs-lookup"><span data-stu-id="c9337-528">That is, the VPN is initiated from Azure to the corporate network, not vice-versa.</span></span>

<span data-ttu-id="c9337-529">Обратите внимание, что при подключении виртуальной сети к локальной сети, помимо стандартной тарификации по каждой виртуальной машине, взимается дополнительная плата.</span><span class="sxs-lookup"><span data-stu-id="c9337-529">Note that additional charges apply when extending a virtual network to your on-premises network beyond the standard charges that apply to each VM.</span></span> <span data-ttu-id="c9337-530">В частности, плата взимается за время ЦП шлюза виртуальной сети Azure и исходящий трафик, генерируемый каждой виртуальной машиной, которая взаимодействует с локальными компьютерами по сети VPN.</span><span class="sxs-lookup"><span data-stu-id="c9337-530">Specifically, there are charges for CPU time of the Azure Virtual Network gateway and for the egress traffic generated by each VM that communicates with on-premises machines across the VPN.</span></span> <span data-ttu-id="c9337-531">Дополнительные сведения о ценах на использование сетевого трафика см. в статье [Цены Azure](http://azure.microsoft.com/pricing/).</span><span class="sxs-lookup"><span data-stu-id="c9337-531">For more information about network traffic charges, see [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span></span>

### <span data-ttu-id="c9337-532"><a name="BKMK_DeploymentConfig"></a>Настройка развертывания контроллера домена</span><span class="sxs-lookup"><span data-stu-id="c9337-532"><a name="BKMK_DeploymentConfig"></a>DC deployment configuration</span></span>
<span data-ttu-id="c9337-533">Способ настройки контроллера домена зависит от требований к службе, которая будет запущена в Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-533">The way you configure the DC depends on the requirements for the service you want to run on Azure.</span></span> <span data-ttu-id="c9337-534">Например, можно развернуть новый лес, изолированный от корпоративного леса, чтобы протестировать экспериментальное развертывание, а также новое приложение или краткосрочный проект, которым необходимы службы каталогов, но не требуется доступ к внутренним корпоративным ресурсам.</span><span class="sxs-lookup"><span data-stu-id="c9337-534">For example, you might deploy a new forest, isolated from your own corporate forest, for testing a proof-of-concept, a new application, or some other short term project that requires directory services but not specific access to internal corporate resources.</span></span>

<span data-ttu-id="c9337-535">Контроллер домена изолированного леса не реплицируется с локальными контроллерами домена, что позволяет уменьшить объем генерируемого системой исходящего сетевого трафика, а значит, и сократить затраты.</span><span class="sxs-lookup"><span data-stu-id="c9337-535">As a benefit, an isolated forest DC does not replicate with on-premises DCs, resulting in less outbound network traffic generated by the system itself, directly reducing costs.</span></span> <span data-ttu-id="c9337-536">Дополнительные сведения о ценах на использование сетевого трафика см. в статье [Цены Azure](http://azure.microsoft.com/pricing/).</span><span class="sxs-lookup"><span data-stu-id="c9337-536">For more information about network traffic charges, see [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span></span>

<span data-ttu-id="c9337-537">В качестве другого примера предположим, что для службы предусмотрены требования к конфиденциальности, но ее работа зависит от доступа к внутренней службе Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="c9337-537">As another example, suppose you have privacy requirements for a service, but the service depends on access to your internal Windows Server Active Directory.</span></span> <span data-ttu-id="c9337-538">Если данные для службы можно размещать в облаке, вы можете развернуть новый дочерний домен для внутреннего леса в Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-538">If you are allowed to host data for the service in the cloud, you might deploy a new child domain for your internal forest on Azure.</span></span> <span data-ttu-id="c9337-539">В этом случае контроллер домена можно развернуть для этого дочернего домена (без глобального каталога, чтобы обеспечить конфиденциальность).</span><span class="sxs-lookup"><span data-stu-id="c9337-539">In this case, you can deploy a DC for the new child domain (without the global catalog in order to help address privacy concerns).</span></span> <span data-ttu-id="c9337-540">В этом сценарии, как и при развертывании реплики контроллера домена, требуется виртуальная сеть для подключения к локальным контроллерам доменов.</span><span class="sxs-lookup"><span data-stu-id="c9337-540">This scenario, along with a replica DC deployment, requires a virtual network for connectivity with your on-premises DCs.</span></span>

<span data-ttu-id="c9337-541">При создании нового леса необходимо выбрать тип доверительных отношений — [с Active Directory](https://technet.microsoft.com/library/cc771397) или [с федерацией](https://technet.microsoft.com/library/dd807036).</span><span class="sxs-lookup"><span data-stu-id="c9337-541">If you create a new forest, choose whether to use [Active Directory trusts](https://technet.microsoft.com/library/cc771397) or [Federation trusts](https://technet.microsoft.com/library/dd807036).</span></span> <span data-ttu-id="c9337-542">Согласуйте требования с целевыми показателями совместимости, безопасности, затрат и устойчивости, а также с нормативными требованиями.</span><span class="sxs-lookup"><span data-stu-id="c9337-542">Balance the requirements dictated by compatibility, security, compliance, cost, and resiliency.</span></span> <span data-ttu-id="c9337-543">Например, чтобы воспользоваться преимуществами [выборочной проверки подлинности](https://technet.microsoft.com/library/cc755844) , можно развернуть новый лес в Azure и создать отношения доверия Windows Server Active Directory с локальным и облачным лесами.</span><span class="sxs-lookup"><span data-stu-id="c9337-543">For example, to take advantage of [selective authentication](https://technet.microsoft.com/library/cc755844) you might choose to deploy a new forest on Azure and create a Windows Server Active Directory trust between the on-premises forest and the cloud forest.</span></span> <span data-ttu-id="c9337-544">Однако если приложение поддерживает утверждения, вместо отношений доверия с лесом Active Directory можно развернуть отношения доверия с федерацией.</span><span class="sxs-lookup"><span data-stu-id="c9337-544">If the application is claims-aware, however, you might deploy federation trusts instead of Active Directory forest trusts.</span></span> <span data-ttu-id="c9337-545">Кроме того, следует сравнить затраты на репликацию данных большего объема при подключении локальной службы Windows Server Active Directory к облаку с затратами, которые влечет генерирование большего объема исходящего трафика из-за нагрузки в связи с проверкой подлинности и отправкой запросов.</span><span class="sxs-lookup"><span data-stu-id="c9337-545">Another factor will be the cost to either replicate more data by extending your on-premises Windows Server Active Directory to the cloud or generate more outbound traffic as a result of authentication and query load.</span></span>

<span data-ttu-id="c9337-546">На выбор способа настройки также влияют требования к доступности и отказоустойчивости.</span><span class="sxs-lookup"><span data-stu-id="c9337-546">Requirements for availability and fault tolerance also affect your choice.</span></span> <span data-ttu-id="c9337-547">Например, если связь разорвана, работа приложений, использующих отношения доверия с Kerberos или федерацией, скорее всего, будет нарушена. Этого можно избежать, если в Azure развернута достаточная инфраструктура.</span><span class="sxs-lookup"><span data-stu-id="c9337-547">For example, if the link is interrupted, applications leveraging either a Kerberos trust or a federation trust are all likely entirely broken unless you have deployed sufficient infrastructure on Azure.</span></span> <span data-ttu-id="c9337-548">При использовании альтернативных конфигураций развертывания, например с репликой контроллеров домена (с возможностью записи или только для чтения), такое прерывание связи не будет критическим.</span><span class="sxs-lookup"><span data-stu-id="c9337-548">Alternative deployment configurations such as replica DCs (writeable or RODCs) increase the likelihood of being able to tolerate link outages.</span></span>

### <span data-ttu-id="c9337-549"><a name="BKMK_ADSiteTopology"></a>Топология сайтов Windows Server Active Directory</span><span class="sxs-lookup"><span data-stu-id="c9337-549"><a name="BKMK_ADSiteTopology"></a>Windows Server Active Directory site topology</span></span>
<span data-ttu-id="c9337-550">Чтобы оптимизировать трафик и снизить затраты, необходимо должным образом задать сайты и связи между ними.</span><span class="sxs-lookup"><span data-stu-id="c9337-550">You need to correctly define sites and site links in order to optimize traffic and minimize cost.</span></span> <span data-ttu-id="c9337-551">Сайты, связи сайтов и подсети влияют на топологию репликации между контроллерами домена и поток трафика проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="c9337-551">Sites, site-links, and subnets affect the replication topology between DCs and the flow of authentication traffic.</span></span> <span data-ttu-id="c9337-552">Рассмотрите затраты на использование трафика ниже, а затем разверните и настройте контроллеры домена согласно требованиям сценария развертывания.</span><span class="sxs-lookup"><span data-stu-id="c9337-552">Consider the following traffic charges and then deploy and configure DCs according to the requirements of your deployment scenario:</span></span>

* <span data-ttu-id="c9337-553">За час использования шлюза взимается номинальная плата.</span><span class="sxs-lookup"><span data-stu-id="c9337-553">There is a nominal fee per hour for the gateway itself:</span></span>
  
  * <span data-ttu-id="c9337-554">Его можно запустить и остановить по своему усмотрению.</span><span class="sxs-lookup"><span data-stu-id="c9337-554">It can be started and stopped as you see fit</span></span>
  * <span data-ttu-id="c9337-555">В случае остановки виртуальные машины Azure будут изолированы от корпоративной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-555">If stopped, Azure VMs are isolated from the corporate network</span></span>
* <span data-ttu-id="c9337-556">Входящий трафик бесплатный.</span><span class="sxs-lookup"><span data-stu-id="c9337-556">Inbound traffic is free</span></span>
* <span data-ttu-id="c9337-557">Плата за исходящий трафик взимается согласно ценам в статье [Цены Azure](http://azure.microsoft.com/pricing/).</span><span class="sxs-lookup"><span data-stu-id="c9337-557">Outbound traffic is charged, according to [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span></span> <span data-ttu-id="c9337-558">Ниже приведены рекомендации, которые помогут оптимизировать свойства связей между локальными и облачными сайтами.</span><span class="sxs-lookup"><span data-stu-id="c9337-558">You can optimize site link properties between on-premises sites and the cloud sites as follows:</span></span>
  
  * <span data-ttu-id="c9337-559">Если вы используете несколько виртуальных сетей, настройте связи между сайтами и связанные с ними затраты таким образом, чтобы службы Windows Server AD DS использовали сайты, которые предоставляют необходимый уровень обслуживания бесплатно, а не платные сайты Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-559">If you are using multiple virtual networks, configure the site-links and their costs appropriately to prevent Windows Server AD DS from prioritizing the Azure site over one that can provide the same levels of service at no charge.</span></span> <span data-ttu-id="c9337-560">Кроме того, можно отключить функцию создания мостов для всех связей сайтов (включена по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="c9337-560">You might also consider disabling the Bridge all site link (BASL) option (which is enabled by default).</span></span> <span data-ttu-id="c9337-561">Если ее отключить, друг с другом будут реплицироваться только напрямую подключенные сайты.</span><span class="sxs-lookup"><span data-stu-id="c9337-561">This ensures that only directly-connected sites replicate with one another.</span></span> <span data-ttu-id="c9337-562">Контроллеры домена сайтов, подключенных транзитивно, не могут реплицироваться друг с другом напрямую, но должны выполнять репликацию с помощью общего сайта или сайтов.</span><span class="sxs-lookup"><span data-stu-id="c9337-562">DCs in transitively connected sites are no longer able to replicate directly with each other, but must replicate through a common site or sites.</span></span> <span data-ttu-id="c9337-563">Если по какой-то причине эти промежуточные сайты становятся недоступными, репликация между контроллерами домена транзитивно подключенных сайтов не будет выполняться, даже если между ними есть подключение.</span><span class="sxs-lookup"><span data-stu-id="c9337-563">If the intermediary sites become unavailable for some reason, replication between DCs in transitively connected sites will not occur even if connectivity between the sites is available.</span></span> <span data-ttu-id="c9337-564">Наконец, если режим транзитивной репликации является подходящим, следует создать мосты связей сайтов, которые содержат соответствующие связи и сайты (например, локальные среды и сайты корпоративной сети).</span><span class="sxs-lookup"><span data-stu-id="c9337-564">Finally, where sections of transitive replication behavior remain desirable, create site link bridges that contain the appropriate site-links and sites, such as on-premises, corporate network sites.</span></span>
  * <span data-ttu-id="c9337-565">[Укажите ограничения расходов в отношении связей сайтов](https://technet.microsoft.com/library/cc794882), чтобы избежать непредусмотренного трафика.</span><span class="sxs-lookup"><span data-stu-id="c9337-565">[Configure site link costs](https://technet.microsoft.com/library/cc794882) appropriately to avoid unintended traffic.</span></span> <span data-ttu-id="c9337-566">Если параметр **Попробовать следующий ближайший сайт** включен, убедитесь, что сайты виртуальной сети не являются ближайшими. Для этого увеличьте затраты на объект связи сайтов, который подключает сайт Azure обратно к корпоративной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-566">For example, if **Try Next Closest Site** setting is enabled, make sure the virtual network sites are not the next closest by increasing the cost associated of the site-link object that connects the Azure site back to the corporate network.</span></span>
  * <span data-ttu-id="c9337-567">Настройте [интервалы](https://technet.microsoft.com/library/cc794878) и [расписания](https://technet.microsoft.com/library/cc816906) установки связей сайтов в соответствии с требованиями к согласованности и частоте изменений объекта.</span><span class="sxs-lookup"><span data-stu-id="c9337-567">Configure site link [intervals](https://technet.microsoft.com/library/cc794878) and [schedules](https://technet.microsoft.com/library/cc816906) according to consistency requirements and rate of object changes.</span></span> <span data-ttu-id="c9337-568">Расписание репликации должно предусматривать задержку.</span><span class="sxs-lookup"><span data-stu-id="c9337-568">Align replication schedule with latency tolerance.</span></span> <span data-ttu-id="c9337-569">Контроллеры домена выполняют репликацию только последнего состояния значения, поэтому при достаточной частоте изменения объекта можно сэкономить затраты путем сокращения интервала репликации.</span><span class="sxs-lookup"><span data-stu-id="c9337-569">DCs replicate only the last state of a value, so decreasing the replication interval can save costs if there is a sufficient object change rate.</span></span>
* <span data-ttu-id="c9337-570">Чтобы снизить затраты, настройте расписание репликации и отключите уведомления об изменениях.</span><span class="sxs-lookup"><span data-stu-id="c9337-570">If minimizing costs is a priority, ensure replication is scheduled and change notification is not enabled.</span></span> <span data-ttu-id="c9337-571">Это конфигурация по умолчанию при репликации между сайтами.</span><span class="sxs-lookup"><span data-stu-id="c9337-571">This is the default configuration when replicating between sites.</span></span> <span data-ttu-id="c9337-572">Хотя это не имеет значения при развертывании контроллера домена только для чтения в виртуальной сети, так как он не выполняет репликацию исходящих изменений,</span><span class="sxs-lookup"><span data-stu-id="c9337-572">This is not important if you are deploying an RODC on a virtual network because the RODC will not replicate any changes outbound.</span></span> <span data-ttu-id="c9337-573">при развертывании контроллера домена с возможностью записи связь сайтов не должна быть настроена для репликации обновлений с нежелаемой частотой.</span><span class="sxs-lookup"><span data-stu-id="c9337-573">But if you deploy a writable DC, you should make sure the site link is not configured to replicate updates with unnecessary frequency.</span></span> <span data-ttu-id="c9337-574">Если вы развертываете сервер глобального каталога, каждый сайт с глобальным каталогом должен выполнять репликацию разделов домена из исходного контроллера домена на сайт, который подключен с использованием связи или связей сайтов, что влечет меньшие затраты, чем глобальный каталог на сайте Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-574">If you deploy a global catalog server (GC), make sure that every other site that contains a GC replicates domain partitions from a source DC in a site that is connected with a site-link or site-links that have a lower cost than the GC in the Azure site.</span></span>
* <span data-ttu-id="c9337-575">Чтобы еще больше уменьшить сетевой трафик репликации между сайтами, можно сменить алгоритм сжатия репликации.</span><span class="sxs-lookup"><span data-stu-id="c9337-575">It is possible to further still reduce network traffic generated by replication between sites by changing the replication compression algorithm.</span></span> <span data-ttu-id="c9337-576">Алгоритм сжатия настраивается с помощью записи реестра REG_DWORD: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters\Replicator compression algorithm.</span><span class="sxs-lookup"><span data-stu-id="c9337-576">The compression algorithm is controlled by the REG_DWORD registry entry HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters\Replicator compression algorithm.</span></span> <span data-ttu-id="c9337-577">Значение по умолчанию — 3. Если задано это значение, используется алгоритм сжатия Xpress.</span><span class="sxs-lookup"><span data-stu-id="c9337-577">The default value is 3, which correlates to the Xpress Compress algorithm.</span></span> <span data-ttu-id="c9337-578">Можно изменить значение на 2. Тогда будет использоваться алгоритм MSZip.</span><span class="sxs-lookup"><span data-stu-id="c9337-578">You can change the value to 2, which changes the algorithm to MSZip.</span></span> <span data-ttu-id="c9337-579">В большинстве случаев после этого сжатие увеличится, но это повлияет на загрузку ЦП.</span><span class="sxs-lookup"><span data-stu-id="c9337-579">In most cases, this will increase the compression, but it does so at the expense of CPU utilization.</span></span> <span data-ttu-id="c9337-580">Дополнительные сведения см. в статье [How Active Directory replication topology works](https://technet.microsoft.com/library/cc755994) (Принципы работы топологии репликации Active Directory).</span><span class="sxs-lookup"><span data-stu-id="c9337-580">For more information, see [How Active Directory replication topology works](https://technet.microsoft.com/library/cc755994).</span></span>

### <span data-ttu-id="c9337-581"><a name="BKMK_IPAddressDNS"></a>Назначение IP-адресов и DNS</span><span class="sxs-lookup"><span data-stu-id="c9337-581"><a name="BKMK_IPAddressDNS"></a>IP addressing and DNS</span></span>
<span data-ttu-id="c9337-582">По умолчанию для виртуальных машин Azure выделяются адреса по протоколу DHCP на определенный срок аренды.</span><span class="sxs-lookup"><span data-stu-id="c9337-582">Azure virtual machines are allocated “DHCP-leased addresses” by default.</span></span> <span data-ttu-id="c9337-583">Так как динамические адреса виртуальной сети Azure сохраняются на все время существования виртуальной машины, требования к службам Windows Server AD DS соблюдаются.</span><span class="sxs-lookup"><span data-stu-id="c9337-583">Because Azure virtual network dynamic addresses persist with a virtual machine for the lifetime of the virtual machine, the requirements of Windows Server AD DS are met.</span></span>

<span data-ttu-id="c9337-584">При использовании динамического адреса в Azure вы фактически используете статический IP-адрес, так как он назначается на период аренды и этот период совпадает со временем существования облачной службы.</span><span class="sxs-lookup"><span data-stu-id="c9337-584">As a result, when you use a dynamic address on Azure, you are in effect using a static IP address because it is routable for the period of the lease, and the period of the lease is equal to the lifetime of the cloud service.</span></span>

<span data-ttu-id="c9337-585">Однако после завершении работы виртуальной машины динамический адрес освобождается.</span><span class="sxs-lookup"><span data-stu-id="c9337-585">However, the dynamic address is deallocated if the VM is shutdown.</span></span> <span data-ttu-id="c9337-586">Чтобы предотвратить освобождение IP-адреса, [назначайте статический IP-адрес, используя командлет Set-AzureStaticVNetIP](http://social.technet.microsoft.com/wiki/contents/articles/23447.how-to-assign-a-private-static-ip-to-an-azure-vm.aspx).</span><span class="sxs-lookup"><span data-stu-id="c9337-586">To prevent the IP address from being deallocated, you can [use Set-AzureStaticVNetIP to assign a static IP address](http://social.technet.microsoft.com/wiki/contents/articles/23447.how-to-assign-a-private-static-ip-to-an-azure-vm.aspx).</span></span>

<span data-ttu-id="c9337-587">Для разрешения имен следует развернуть собственную (или использовать существующую) инфраструктуру DNS-сервера. DNS-сервер, предоставляемый Azure, не соответствует требованиям Windows Server AD DS к разрешению имен.</span><span class="sxs-lookup"><span data-stu-id="c9337-587">For name resolution, deploy your own (or leverage your existing) DNS server infrastructure; Azure-provided DNS does not meet the advanced name resolution needs of Windows Server AD DS.</span></span> <span data-ttu-id="c9337-588">Например, он не поддерживает динамические записи SRV и т. п.</span><span class="sxs-lookup"><span data-stu-id="c9337-588">For example, it does not support dynamic SRV records, and so on.</span></span> <span data-ttu-id="c9337-589">Разрешение имени — это критически важный компонент настройки контроллеров домена и присоединенных к домену клиентов.</span><span class="sxs-lookup"><span data-stu-id="c9337-589">Name resolution is a critical configuration item for DCs and domain-joined clients.</span></span> <span data-ttu-id="c9337-590">Контроллеры домена должны регистрировать записи ресурсов и разрешать другие записи контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="c9337-590">DCs must be capable of registering resource records and resolving other DC’s resource records.</span></span>
<span data-ttu-id="c9337-591">Чтобы обеспечить отказоустойчивость и оптимальную производительность, установите службу DNS Windows Server на контроллерах домена в Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-591">For fault tolerance and performance reasons, it is optimal to install the Windows Server DNS service on the DCs running on Azure.</span></span> <span data-ttu-id="c9337-592">Затем настройте свойства виртуальной сети Azure, указав имя и IP-адрес DNS-сервера.</span><span class="sxs-lookup"><span data-stu-id="c9337-592">Then configure the Azure virtual network properties with the name and IP address of the DNS server.</span></span> <span data-ttu-id="c9337-593">При запуске других виртуальных машин в виртуальной сети параметры сопоставителя клиента DNS будут настроены с помощью DNS-сервера в рамках выделения динамических IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="c9337-593">When other VMs on the virtual network start, their DNS client resolver settings will be configured with DNS server as part of the dynamic IP address allocation.</span></span>

> [!NOTE]
> <span data-ttu-id="c9337-594">Нельзя присоединить локальные компьютеры к размещенному в Azure домену Active Directory служб Windows Server AD DS напрямую через Интернет.</span><span class="sxs-lookup"><span data-stu-id="c9337-594">You cannot join on-premises computers to a Windows Server AD DS Active Directory domain that is hosted on Azure directly over the Internet.</span></span> <span data-ttu-id="c9337-595">В связи с требованиями к портам для Active Directory и операции присоединения к домену нецелесообразно открывать прямой доступ к нужным портам и, в сущности, всему контроллеру домена в Интернете.</span><span class="sxs-lookup"><span data-stu-id="c9337-595">The port requirements for Active Directory and the domain-join operation render it impractical to directly expose the necessary ports and in effect, an entire DC to the Internet.</span></span>
> 
> 

<span data-ttu-id="c9337-596">При запуске или изменении DNS-имя виртуальных машин регистрируется автоматически.</span><span class="sxs-lookup"><span data-stu-id="c9337-596">VMs register their DNS name automatically on startup or when there is a name change.</span></span>

<span data-ttu-id="c9337-597">Дополнительные сведения об этом примере и других примерах подготовки первой виртуальной машины и установки на ней служб AD DS см. в статье [Установка нового леса Active Directory в виртуальной сети Azure](active-directory-new-forest-virtual-machine.md).</span><span class="sxs-lookup"><span data-stu-id="c9337-597">For more information about this example and another example that shows how to provision the first VM and install AD DS on it, see [Install a new Active Directory forest on Microsoft Azure](active-directory-new-forest-virtual-machine.md).</span></span> <span data-ttu-id="c9337-598">Дополнительные сведения об использовании Windows PowerShell см. в разделах [Справка по Azure PowerShell](/powershell/azureps-cmdlets-docs) и [Azure Management Cmdlets](/powershell/module/azurerm.compute/#virtual_machines) (Командлеты управления Azure).</span><span class="sxs-lookup"><span data-stu-id="c9337-598">For more information about using Windows PowerShell, see [Install Azure PowerShell](/powershell/azureps-cmdlets-docs) and [Azure Management Cmdlets](/powershell/module/azurerm.compute/#virtual_machines).</span></span>

### <span data-ttu-id="c9337-599"><a name="BKMK_DistributedDCs"></a>Географически распределенные контроллеры домена</span><span class="sxs-lookup"><span data-stu-id="c9337-599"><a name="BKMK_DistributedDCs"></a>Geo-distributed DCs</span></span>
<span data-ttu-id="c9337-600">Преимущества размещения нескольких контроллеров домена в разных виртуальных сетях Azure:</span><span class="sxs-lookup"><span data-stu-id="c9337-600">Azure offers advantages when hosting multiple DCs on different virtual networks:</span></span>

* <span data-ttu-id="c9337-601">отказоустойчивость нескольких сайтов;</span><span class="sxs-lookup"><span data-stu-id="c9337-601">Multi-site fault-tolerance</span></span>
* <span data-ttu-id="c9337-602">близкое расположение к филиалам (меньшая задержка).</span><span class="sxs-lookup"><span data-stu-id="c9337-602">Physical proximity to branch offices (lower latency)</span></span>

<span data-ttu-id="c9337-603">Дополнительные сведения о настройке прямой связи между виртуальными сетями см. в статье о [настройке подключения между виртуальными сетями](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md).</span><span class="sxs-lookup"><span data-stu-id="c9337-603">For information about configuring direct communication between virtual networks, see [Configure virtual network to virtual network connectivity](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md).</span></span>

### <span data-ttu-id="c9337-604"><a name="BKMK_RODC"></a>Контроллеры доменов только для чтения</span><span class="sxs-lookup"><span data-stu-id="c9337-604"><a name="BKMK_RODC"></a>Read-only DCs</span></span>
<span data-ttu-id="c9337-605">Необходимо выбрать, какие контроллеры домена нужно развернуть: только для чтения или с возможностью записи.</span><span class="sxs-lookup"><span data-stu-id="c9337-605">You need to choose whether to deploy read-only or writeable DCs.</span></span> <span data-ttu-id="c9337-606">Возможно, вы захотите развернуть контроллеры домена только для чтения, так как вам не нужно будет ними управлять, но они предназначены для развертывания в расположениях с риском для их физической безопасности, например в филиалах.</span><span class="sxs-lookup"><span data-stu-id="c9337-606">You might be inclined to deploy RODCs because you will not have physical control over them, but RODCs are designed to be deployed in locations where their physical security is at risk, such as branch offices.</span></span>

<span data-ttu-id="c9337-607">В Azure риск для физической безопасности филиала отсутствует, но контроллеры домена только для чтения могут оказаться более экономически выгодными, потому что по совершенно другим причинам их функции хорошо подходят для этих сред.</span><span class="sxs-lookup"><span data-stu-id="c9337-607">Azure does not present the physical security risk of a branch office, but RODCs might still prove to be more cost effective because the features they provide are well-suited to these environments albeit for very different reasons.</span></span> <span data-ttu-id="c9337-608">Например, они не предусматривают исходящую репликацию и могут заполнять секретные коды (пароли) выборочно.</span><span class="sxs-lookup"><span data-stu-id="c9337-608">For example, RODCs have no outbound replication and are able to selectively populate secrets (passwords).</span></span> <span data-ttu-id="c9337-609">Отрицательным моментом является то, что при недостатке этих секретных кодов может потребоваться исходящий трафик по требованию для выполнения проверки подлинности пользователя или компьютера.</span><span class="sxs-lookup"><span data-stu-id="c9337-609">On the downside, the lack of these secrets might require on-demand outbound traffic to validate them as a user or computer authenticates.</span></span> <span data-ttu-id="c9337-610">Но секретные коды можно заполнить предварительно и кэшировать.</span><span class="sxs-lookup"><span data-stu-id="c9337-610">But secrets can be selectively prepopulated and cached.</span></span>

<span data-ttu-id="c9337-611">Еще одно преимущество контроллеров домена только для чтения — это возможность добавить атрибуты, которые содержат конфиденциальные (личные или критически важные для бизнеса) данные, в отфильтрованный набор атрибутов (FAS).</span><span class="sxs-lookup"><span data-stu-id="c9337-611">RODCs provide an additional advantage in and around HBI and PII concerns because you can add attributes that contain sensitive data to the RODC filtered attribute set (FAS).</span></span> <span data-ttu-id="c9337-612">Этот настраиваемый набор содержит атрибуты, которые не реплицируются в контроллеры домена только для чтения.</span><span class="sxs-lookup"><span data-stu-id="c9337-612">The FAS is a customizable set of attributes that are not replicated to RODCs.</span></span> <span data-ttu-id="c9337-613">Отфильтрованный набор атрибутов можно использовать в качестве меры предосторожности, если вы не хотите использовать или не можете хранить конфиденциальные данные в Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-613">You can use the FAS as a safeguard in case you are not permitted or do not want to store PII or HBI on Azure.</span></span> <span data-ttu-id="c9337-614">Дополнительные сведения см. в разделе об [отфильтрованном наборе атрибутов контроллеров домена только для чтения[(https://technet.microsoft.com/library/cc753459)].</span><span class="sxs-lookup"><span data-stu-id="c9337-614">For more information, see [RODC filtered attribute set[(https://technet.microsoft.com/library/cc753459)].</span></span>

<span data-ttu-id="c9337-615">Приложения должны быть совместимы с используемыми контроллерами домена только для чтения.</span><span class="sxs-lookup"><span data-stu-id="c9337-615">Make sure that applications will be compatible with RODCs you plan to use.</span></span> <span data-ttu-id="c9337-616">Многие приложения, работающие с Windows Server Active Directory, совместимы с контроллерами домена только для чтения, но некоторые приложения могут работать не оптимально или завершаться сбоями при отсутствии доступа к контроллеру домена с возможностью записи.</span><span class="sxs-lookup"><span data-stu-id="c9337-616">Many Windows Server Active Directory-enabled applications work well with RODCs, but some applications can perform inefficiently or fail if they do not have access to a writable DC.</span></span> <span data-ttu-id="c9337-617">Дополнительные сведения см. в статье [Read-Only DCs application compatibility guide](https://technet.microsoft.com/library/cc755190) (Совместимость приложений с контроллерами домена только для чтения).</span><span class="sxs-lookup"><span data-stu-id="c9337-617">For more information, see [Read-Only DCs application compatibility guide](https://technet.microsoft.com/library/cc755190).</span></span>

### <span data-ttu-id="c9337-618"><a name="BKMK_GC"></a>Глобальный каталог</span><span class="sxs-lookup"><span data-stu-id="c9337-618"><a name="BKMK_GC"></a>Global catalog</span></span>
<span data-ttu-id="c9337-619">Необходимо выбрать, следует ли устанавливать глобальный каталог.</span><span class="sxs-lookup"><span data-stu-id="c9337-619">You need to choose whether to install a global catalog (GC).</span></span> <span data-ttu-id="c9337-620">В лесу с одним доменом необходимо настроить все контроллеры домена в качестве серверов глобального каталога.</span><span class="sxs-lookup"><span data-stu-id="c9337-620">In a single domain forest, you should configure all DCs as global catalog servers.</span></span> <span data-ttu-id="c9337-621">Это не увеличит затраты, так как не влечет за собой дополнительный трафик репликации.</span><span class="sxs-lookup"><span data-stu-id="c9337-621">It will not increase costs because there will be no additional replication traffic.</span></span>

<span data-ttu-id="c9337-622">Глобальные каталоги в лесу с несколькими доменами необходимы для расширения членства в универсальных группах во время процесса проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="c9337-622">In a multidomain forest, GCs are necessary to expand Universal Group memberships during the authentication process.</span></span> <span data-ttu-id="c9337-623">Если вы не развертываете глобальный каталог, при каждой попытке проверки подлинности рабочие нагрузки в виртуальной сети, проходящие проверку подлинности в контроллере домена в Azure, будут косвенно формировать исходящий трафик проверки подлинности для запроса локальных глобальных каталогов.</span><span class="sxs-lookup"><span data-stu-id="c9337-623">If you do not deploy a GC, workloads on the virtual network that authenticate against a DC on Azure will indirectly generate outbound authentication traffic to query GCs on-premises during each authentication attempt.</span></span>

<span data-ttu-id="c9337-624">Трудно предугадать затраты на глобальный каталог, так как они отвечают за размещение каждого домена (частично).</span><span class="sxs-lookup"><span data-stu-id="c9337-624">The costs associated with GCs are less-predictable because they host every domain (in-part).</span></span> <span data-ttu-id="c9337-625">Если в рамках рабочей нагрузки размещается служба с выходом в Интернет и выполняется проверка подлинности пользователей в Windows Server AD DS, затраты будут совершенно непредсказуемыми.</span><span class="sxs-lookup"><span data-stu-id="c9337-625">If the workload hosts an Internet-facing service and authenticates users against Windows Server AD DS, the costs could be completely unpredictable.</span></span> <span data-ttu-id="c9337-626">Чтобы уменьшить запросы глобального каталога за пределами облачного сайта при проверке подлинности, [включите кэширование членства в универсальных группах](https://technet.microsoft.com/library/cc816928).</span><span class="sxs-lookup"><span data-stu-id="c9337-626">To help reduce GC queries outside of the cloud site during authentication, you can [enable Universal Group Membership Caching](https://technet.microsoft.com/library/cc816928).</span></span>

### <span data-ttu-id="c9337-627"><a name="BKMK_InstallMethod"></a>Метод установки</span><span class="sxs-lookup"><span data-stu-id="c9337-627"><a name="BKMK_InstallMethod"></a>Installation method</span></span>
<span data-ttu-id="c9337-628">Необходимо выбрать способ установки контроллеров домена в виртуальной сети:</span><span class="sxs-lookup"><span data-stu-id="c9337-628">You need to choose how to install the DCs on the virtual network:</span></span>

* <span data-ttu-id="c9337-629">Повышение уровня новых контроллеров домена.</span><span class="sxs-lookup"><span data-stu-id="c9337-629">Promote new DCs.</span></span> <span data-ttu-id="c9337-630">Дополнительные сведения см. в статье [Установка нового леса Active Directory в виртуальной сети Azure](active-directory-new-forest-virtual-machine.md).</span><span class="sxs-lookup"><span data-stu-id="c9337-630">For more information, see [Install a new Active Directory forest on an Azure virtual network](active-directory-new-forest-virtual-machine.md).</span></span>
* <span data-ttu-id="c9337-631">Перемещение виртуального жесткого диска локального виртуального контроллера домена в облако.</span><span class="sxs-lookup"><span data-stu-id="c9337-631">Move the VHD of an on-premises virtual DC to the cloud.</span></span> <span data-ttu-id="c9337-632">В этом случае локальный виртуальный контроллер домена должен быть именно перемещен, а не копирован или клонирован.</span><span class="sxs-lookup"><span data-stu-id="c9337-632">In this case, you must ensure that the on-premises virtual DC is “moved,” not “copied” or “cloned.”</span></span>

<span data-ttu-id="c9337-633">Для контроллеров домена следует использовать только виртуальные машины Azure (а не виртуальные машины с рабочей ролью или веб-ролью).</span><span class="sxs-lookup"><span data-stu-id="c9337-633">Use only Azure virtual machines for DCs (as opposed to Azure “web” or “worker” role VMs).</span></span> <span data-ttu-id="c9337-634">Они надежные, а эта характеристика необходима для контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="c9337-634">They are durable and durability of state for a DC is required.</span></span> <span data-ttu-id="c9337-635">Виртуальные машины Azure предназначены для таких рабочих нагрузок, как операции с контроллерами домена.</span><span class="sxs-lookup"><span data-stu-id="c9337-635">Azure virtual machines are designed for workloads such as DCs.</span></span>

<span data-ttu-id="c9337-636">Не используйте средство SYSPREP для развертывания или клонирования контроллеров домена.</span><span class="sxs-lookup"><span data-stu-id="c9337-636">Do not use SYSPREP to deploy or clone DCs.</span></span> <span data-ttu-id="c9337-637">Возможность клонирования контроллеров домена предусмотрена в Windows Server, начиная с версии 2012.</span><span class="sxs-lookup"><span data-stu-id="c9337-637">The ability to clone DCs is only available beginning in Windows Server 2012.</span></span> <span data-ttu-id="c9337-638">Для функции клонирования требуется поддержка идентификатора VMGenerationID в базовой низкоуровневой оболочке.</span><span class="sxs-lookup"><span data-stu-id="c9337-638">The cloning feature requires support for VMGenerationID in the underlying hypervisor.</span></span> <span data-ttu-id="c9337-639">Hyper-V в составе Windows Server 2012 и виртуальные сети Azure поддерживают этот идентификатор, как и сторонние поставщики программного обеспечения виртуализации.</span><span class="sxs-lookup"><span data-stu-id="c9337-639">Hyper-V in Windows Server 2012 and Azure virtual networks both support VMGenerationID, as do third-party virtualization software vendors.</span></span>

### <span data-ttu-id="c9337-640"><a name="BKMK_PlaceDB"></a>Размещение базы данных и SYSVOL служб Windows Server AD DS</span><span class="sxs-lookup"><span data-stu-id="c9337-640"><a name="BKMK_PlaceDB"></a>Placement of the Windows Server AD DS database and SYSVOL</span></span>
<span data-ttu-id="c9337-641">Выберите место размещения базы данных, журналов и SYSVOL служб Windows Server AD DS.</span><span class="sxs-lookup"><span data-stu-id="c9337-641">Select where to locate the Windows Server AD DS database, logs, and SYSVOL.</span></span> <span data-ttu-id="c9337-642">Они должны быть развернуты на дисках данных Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-642">They must be deployed on Azure Data disks.</span></span>

> [!NOTE]
> <span data-ttu-id="c9337-643">Размер дисков данных Azure составляет 1 ТБ.</span><span class="sxs-lookup"><span data-stu-id="c9337-643">Azure Data disks are constrained to 1 TB.</span></span>
> 
> 

<span data-ttu-id="c9337-644">По умолчанию диски данных не кэшируют операции записи.</span><span class="sxs-lookup"><span data-stu-id="c9337-644">Data disk drives do not cache writes by default.</span></span> <span data-ttu-id="c9337-645">В дисках данных, подключенных к виртуальной машине, используется кэширование со сквозной записью.</span><span class="sxs-lookup"><span data-stu-id="c9337-645">Data disk drives that are attached to a VM use write-through caching.</span></span> <span data-ttu-id="c9337-646">Кэширование со сквозной записью гарантирует запись в надежную службу хранилища Azure до завершения транзакции с точки зрения операционной системы виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="c9337-646">Write-through caching makes sure the write is committed to durable Azure storage before the transaction is complete from the perspective of the VM’s operating system.</span></span> <span data-ttu-id="c9337-647">Это обеспечивает надежность, хотя и за счет скорости операций записи.</span><span class="sxs-lookup"><span data-stu-id="c9337-647">It provides durability, at the expense of slightly slower writes.</span></span>

<span data-ttu-id="c9337-648">Это важно для Windows Server AD DS, так как кэширование диска с задержкой записи сводит на нет предположения контроллера домена.</span><span class="sxs-lookup"><span data-stu-id="c9337-648">This is important for Windows Server AD DS because write-behind disk-caching invalidates assumptions made by the DC.</span></span> <span data-ttu-id="c9337-649">Windows Server AD DS пытается отключить кэширование записи, но это зависит от системы операций ввода-вывода на диске.</span><span class="sxs-lookup"><span data-stu-id="c9337-649">Windows Server AD DS attempts to disable write caching but it is up to the disk IO system to honor it.</span></span> <span data-ttu-id="c9337-650">При определенных обстоятельствах сбой отключения кэширования записи вызывает откат USN, а это приводит к появлению устаревших объектов и другим проблемам.</span><span class="sxs-lookup"><span data-stu-id="c9337-650">Failure to disable write caching may, under certain circumstances, introduce USN rollback resulting in lingering objects and other problems.</span></span>

<span data-ttu-id="c9337-651">Для виртуальных контроллеров домена рекомендуется сделать следующее:</span><span class="sxs-lookup"><span data-stu-id="c9337-651">As a best practice for virtual DCs, do the following:</span></span>

* <span data-ttu-id="c9337-652">Установить для параметра настройки кэша узла на диске данных Azure значение "Нет".</span><span class="sxs-lookup"><span data-stu-id="c9337-652">Set the Host Cache Preference setting on the Azure data disk for NONE.</span></span> <span data-ttu-id="c9337-653">Это позволяет предотвратить проблемы с кэшированием записи для операций AD DS.</span><span class="sxs-lookup"><span data-stu-id="c9337-653">This prevents issues with write caching for AD DS operations.</span></span>
* <span data-ttu-id="c9337-654">Храните базу данных, журналы и SYSVOL на одном или на отдельных дисках данных.</span><span class="sxs-lookup"><span data-stu-id="c9337-654">Store the database, logs, and SYSVOL on the either same data disk or separate data disks.</span></span> <span data-ttu-id="c9337-655">Как правило, используется не диск с операционной системой.</span><span class="sxs-lookup"><span data-stu-id="c9337-655">Typically, this is a separate disk from the disk used for the operating system itself.</span></span> <span data-ttu-id="c9337-656">Главное, база данных и SYSVOL служб Windows Server AD DS не должны храниться на диске операционной системы Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-656">The key takeaway is that the Windows Server AD DS database and SYSVOL must not be stored on an Azure Operating System disk type.</span></span> <span data-ttu-id="c9337-657">По умолчанию в процессе установки AD DS эти компоненты устанавливаются в папку %systemroot%, что НЕ рекомендуется для Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-657">By default, the AD DS installation process installs these components in %systemroot% folder, which is NOT recommended for Azure.</span></span>

### <span data-ttu-id="c9337-658"><a name="BKMK_BUR"></a>Резервное копирование и восстановление</span><span class="sxs-lookup"><span data-stu-id="c9337-658"><a name="BKMK_BUR"></a>Backup and restore</span></span>
<span data-ttu-id="c9337-659">Следует учитывать, что поддерживается и не поддерживается для резервного копирования и восстановления контроллеров домена в целом и для контроллеров домена, запущенных на виртуальной машине, в частности.</span><span class="sxs-lookup"><span data-stu-id="c9337-659">Be aware of what is and is not supported for backup and restore of a DC in general, and more specifically, those running in a VM.</span></span> <span data-ttu-id="c9337-660">Дополнительные сведения см. в статье [Backup and Restore Considerations for Virtualized DCs](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv#backup_and_restore_considerations_for_virtualized_domain_controllers) (Особенности архивации и восстановления виртуализированных контроллеров домена).</span><span class="sxs-lookup"><span data-stu-id="c9337-660">See [Backup and Restore Considerations for Virtualized DCs](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv#backup_and_restore_considerations_for_virtualized_domain_controllers).</span></span>

<span data-ttu-id="c9337-661">Создайте резервные копии состояния системы с помощью программного обеспечения для архивации, которое поддерживает требования для резервного копирования Windows Server AD DS (например, с помощью системы архивации данных Windows Server).</span><span class="sxs-lookup"><span data-stu-id="c9337-661">Create system state backups by using only backup software that is specifically aware of backup requirements for Windows Server AD DS, such as Windows Server Backup.</span></span>

<span data-ttu-id="c9337-662">Не копируйте и не клонируйте VHD-файлы контроллеров домена вместо регулярного создания резервных копий.</span><span class="sxs-lookup"><span data-stu-id="c9337-662">Do not copy or clone VHD files of DCs instead of performing regular backups.</span></span> <span data-ttu-id="c9337-663">Если потребуется восстановление, при использовании скопированных или клонированных VHD-файлов отдельно от Windows Server 2012 и поддерживаемой низкоуровневой оболочки создаются USN-пузыри.</span><span class="sxs-lookup"><span data-stu-id="c9337-663">Should a restore ever be required, doing so using cloned or copied VHDs without Windows Server 2012 and a supported hypervisor will introduce USN bubbles.</span></span>

### <span data-ttu-id="c9337-664"><a name="BKMK_FedSrvConfig"></a>Настройка сервера федерации</span><span class="sxs-lookup"><span data-stu-id="c9337-664"><a name="BKMK_FedSrvConfig"></a>Federation server configuration</span></span>
<span data-ttu-id="c9337-665">Настройка серверов федерации (служб маркеров безопасности) служб Windows Server AD FS отчасти зависит от того, требуется ли для развертываемых в Azure приложениях доступ к ресурсам локальной сети.</span><span class="sxs-lookup"><span data-stu-id="c9337-665">The configuration of Windows Server AD FS federation servers (STSs) depends in part on whether the applications that you want to deploy on Azure need to access resources on your on-premises network.</span></span>

<span data-ttu-id="c9337-666">Если приложения отвечают следующим условиям, их можно развернуть отдельно от локальной сети:</span><span class="sxs-lookup"><span data-stu-id="c9337-666">If the applications meet the following criteria, you could deploy the applications in isolation from your on-premises network.</span></span>

* <span data-ttu-id="c9337-667">они принимают маркеры безопасности SAML;</span><span class="sxs-lookup"><span data-stu-id="c9337-667">They accept SAML security tokens</span></span>
* <span data-ttu-id="c9337-668">они доступны в Интернете;</span><span class="sxs-lookup"><span data-stu-id="c9337-668">They are exposable to the Internet</span></span>
* <span data-ttu-id="c9337-669">они не осуществляют доступ к локальным ресурсам.</span><span class="sxs-lookup"><span data-stu-id="c9337-669">They do not access on-premises resources</span></span>

<span data-ttu-id="c9337-670">В этом случае службы маркеров безопасности Windows Server AD FS нужно настроить следующим образом:</span><span class="sxs-lookup"><span data-stu-id="c9337-670">In this case, configure Windows Server AD FS STSs as follows:</span></span>

1. <span data-ttu-id="c9337-671">Настройте изолированный лес с одним доменом в Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-671">Configure an isolated single-domain forest on Azure.</span></span>
2. <span data-ttu-id="c9337-672">Обеспечьте федеративный доступ к лесу, настроив ферму сервера федерации Windows Server AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-672">Provide federated access to the forest by configuring a Windows Server AD FS federation server farm.</span></span>
3. <span data-ttu-id="c9337-673">Настройте службы Windows Server AD FS (ферму сервера федерации и ферму прокси-сервера федерации) в локальном лесу.</span><span class="sxs-lookup"><span data-stu-id="c9337-673">Configure Windows Server AD FS (federation server farm and federation server proxy farm) in the on-premises forest.</span></span>
4. <span data-ttu-id="c9337-674">Установите федеративные отношения доверия между локальными экземплярами и экземплярами Azure служб Windows Server AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-674">Establish a federation trust relationship between the on-premises and Azure instances of Windows Server AD FS.</span></span>

<span data-ttu-id="c9337-675">В свою очередь, если приложениям требуется доступ к локальным ресурсам, настройте службы Windows Server AD FS с использованием приложения в Azure следующим образом:</span><span class="sxs-lookup"><span data-stu-id="c9337-675">On the other hand, if the applications require access to on-premises resources, you could configure Windows Server AD FS with the application on Azure as follows:</span></span>

1. <span data-ttu-id="c9337-676">Настройте подключение между локальными сетями и Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-676">Configure connectivity between on-premises networks and Azure.</span></span>
2. <span data-ttu-id="c9337-677">Настройте ферму сервера федерации служб Windows Server AD FS в локальном лесу.</span><span class="sxs-lookup"><span data-stu-id="c9337-677">Configure a Windows Server AD FS federation server farm in the on-premises forest.</span></span>
3. <span data-ttu-id="c9337-678">Настройте ферму прокси-сервера федерации служб AD FS Windows Server в Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-678">Configure a Windows Server AD FS federation server proxy farm on Azure.</span></span>

<span data-ttu-id="c9337-679">Эта настройка удобна тем, что позволяет предотвратить доступ к локальным ресурсам, аналогично настройке служб Windows Server AD FS с приложениями в сети периметра.</span><span class="sxs-lookup"><span data-stu-id="c9337-679">This configuration has the advantage of reducing the exposure of on-premises resources, similar to configuring Windows Server AD FS with applications in a perimeter network.</span></span>

<span data-ttu-id="c9337-680">Отметим, что в любом сценарии для взаимодействия типа "бизнес-бизнес" можно установить отношения доверия с дополнительными поставщиками удостоверений.</span><span class="sxs-lookup"><span data-stu-id="c9337-680">Note that in either scenario, you can establish trusts relationships with more identity providers, if business-to-business collaboration is needed.</span></span>

### <span data-ttu-id="c9337-681"><a name="BKMK_CloudSvcConfig"></a>Настройка облачных служб</span><span class="sxs-lookup"><span data-stu-id="c9337-681"><a name="BKMK_CloudSvcConfig"></a>Cloud services configuration</span></span>
<span data-ttu-id="c9337-682">Если вы хотите предоставить доступ к виртуальной машине напрямую через Интернет или предоставить доступное в Интернете приложение с балансировкой нагрузки, вам понадобятся облачные службы.</span><span class="sxs-lookup"><span data-stu-id="c9337-682">Cloud services are necessary if you want to expose a VM directly to the Internet or to expose an Internet-facing load-balanced application.</span></span> <span data-ttu-id="c9337-683">Это возможно, потому что для каждой облачной службой предоставляется один настраиваемый виртуальный IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="c9337-683">This is possible because each cloud service offers a single configurable virtual IP address.</span></span>

### <span data-ttu-id="c9337-684"><a name="BKMK_FedReqVIPDIP"></a>Требования сервера федерации в отношении общих и частных IP-адресов (динамические и виртуальные IP-адреса)</span><span class="sxs-lookup"><span data-stu-id="c9337-684"><a name="BKMK_FedReqVIPDIP"></a>Federation server requirements for public and private IP addressing (dynamic IP vs. virtual IP)</span></span>
<span data-ttu-id="c9337-685">Каждой виртуальной машине Azure присваивается динамический IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="c9337-685">Each Azure virtual machine receives a dynamic IP address.</span></span> <span data-ttu-id="c9337-686">Это частный адрес, который доступен только в Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-686">A dynamic IP address is a private address accessible only within Azure.</span></span> <span data-ttu-id="c9337-687">Однако в большинстве случаев для развертываний служб Windows Server AD FS необходимо настроить виртуальный IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="c9337-687">In most cases, however, it will be necessary to configure a virtual IP address for your Windows Server AD FS deployments.</span></span> <span data-ttu-id="c9337-688">Виртуальный IP-адрес необходим для предоставления доступа к конечным точкам Windows Server AD FS в Интернете. Его будут использовать федеративные партнеры и клиенты для проверки подлинности и постоянного управления.</span><span class="sxs-lookup"><span data-stu-id="c9337-688">The virtual IP is necessary to expose Windows Server AD FS endpoints to the Internet, and will be used by federated partners and clients for authentication and ongoing management.</span></span> <span data-ttu-id="c9337-689">Этот адрес является свойством облачной службы, в которую входит одна или несколько виртуальных машин Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-689">A virtual IP address is a property of a cloud service which contains one or more Azure virtual machines.</span></span> <span data-ttu-id="c9337-690">Если поддерживающее утверждения приложение, развернутое в Azure, и Windows Server AD FS доступны в Интернете и используют общие порты, им потребуется собственный виртуальный IP-адрес. Кроме того, понадобится создать одну облачную службу для приложения и вторую — для Windows Server AD FS.</span><span class="sxs-lookup"><span data-stu-id="c9337-690">If the claims-aware application deployed on Azure and Windows Server AD FS are both Internet-facing and share common ports, each will require a virtual IP address of its own and it will therefore be necessary to create one cloud service for the application and a second for Windows Server AD FS.</span></span>

<span data-ttu-id="c9337-691">Определения виртуального и динамического IP-адресов см. в разделе [Термины и определения](#BKMK_Glossary).</span><span class="sxs-lookup"><span data-stu-id="c9337-691">For definitions of the terms virtual IP address and dynamic IP address, see [Terms and definitions](#BKMK_Glossary).</span></span>

### <span data-ttu-id="c9337-692"><a name="BKMK_ADFSHighAvail"></a>Настройка высокой доступности Windows Server AD FS</span><span class="sxs-lookup"><span data-stu-id="c9337-692"><a name="BKMK_ADFSHighAvail"></a>Windows Server AD FS high availability configuration</span></span>
<span data-ttu-id="c9337-693">Хотя можно развернуть автономные службы федерации Windows Server AD FS, для рабочих сред рекомендуется развернуть ферму с по меньшей мере двумя узлами для службы маркеров безопасности AD FS и прокси-серверов.</span><span class="sxs-lookup"><span data-stu-id="c9337-693">While it is possible to deploy standalone Windows Server AD FS federation services, it is recommended to deploy a farm with at least two nodes for both AD FS STS and proxies for production environments.</span></span>

<span data-ttu-id="c9337-694">Чтобы выбрать варианты настройки развертывания, которые наилучшим образом соответствуют вашим потребностям, см. раздел [AD FS 2.0 deployment topology considerations](https://technet.microsoft.com/library/gg982489) (Некоторые аспекты топологии развертывания AD FS 2.0) в руководстве [AD FS 2.0 Design Guide](https://technet.microsoft.com/library/dd807036) (Руководство по разработке служб AD FS 2.0).</span><span class="sxs-lookup"><span data-stu-id="c9337-694">See [AD FS 2.0 deployment topology considerations](https://technet.microsoft.com/library/gg982489) in the [AD FS 2.0 Design Guide](https://technet.microsoft.com/library/dd807036) to decide which deployment configuration options best suit your particular needs.</span></span>

> [!NOTE]
> <span data-ttu-id="c9337-695">Чтобы настроить балансировку нагрузки для конечных точек Windows Server AD FS в Azure, следует настроить всех членов фермы Windows Server AD FS в той же облачной службе и использовать балансировку нагрузки Azure для портов HTTP (по умолчанию — 80) и HTTPS (по умолчанию — 443).</span><span class="sxs-lookup"><span data-stu-id="c9337-695">In order to get load balancing for Windows Server AD FS endpoints on Azure, configure all members of the Windows Server AD FS farm in the same cloud service, and use the load balancing capability of Azure for HTTP (default 80) and HTTPS ports (default 443).</span></span> <span data-ttu-id="c9337-696">Дополнительные сведения см. в статье [LoadBalancerProbe Schema](https://msdn.microsoft.com/library/azure/jj151530) (Схема LoadBalancerProbe).</span><span class="sxs-lookup"><span data-stu-id="c9337-696">For more information, see [Azure load-balancer probe](https://msdn.microsoft.com/library/azure/jj151530).</span></span>
> <span data-ttu-id="c9337-697">Балансировка сетевой нагрузки Windows Server не поддерживается в Azure.</span><span class="sxs-lookup"><span data-stu-id="c9337-697">Windows Server Network Load Balancing (NLB) is not supported on Azure.</span></span>
> 
> 


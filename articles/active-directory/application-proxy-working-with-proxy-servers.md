---
title: "Работа с имеющимися локальными прокси-серверами в Azure AD | Документация Майкрософт"
description: "В этой статье описывается, как работать с существующими локальными прокси-серверами."
services: active-directory
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/04/2017
ms.author: kgremban
ms.openlocfilehash: bdca442755507c4ffe8d43692c5b7f2aa3a746f3
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2017
---
# <a name="work-with-existing-on-premises-proxy-servers"></a>Работа с имеющимися локальными прокси-серверами

В этой статье описывается, как настроить соединители прокси приложения Azure Active Directory для работы с исходящими прокси-серверами. Она предназначена для клиентов, использующих сетевые среды с имеющимися прокси.

Рассмотрим основные сценарии развертывания:
* Настройка соединителей для обхода локальных исходящих прокси-серверов.
* Настройка соединителей для доступа к прокси приложения Azure AD через исходящий прокси-сервер.

Дополнительные сведения о соединителях см. в статье [Сведения о соединителях прокси приложения Azure AD](application-proxy-understand-connectors.md).

## <a name="configure-the-outbound-proxy"></a>Настройка исходящего прокси-сервера

Если в вашей среде имеется исходящий прокси-сервер, используйте учетную запись с соответствующими разрешениями для настройки исходящих прокси. Поскольку программа установки выполняется в контексте пользователя, который выполняет установку, настройки можно проверить с помощью Microsoft Edge или любого другого браузера.

Настройка параметров прокси с помощью Microsoft Edge:

1. Последовательно выберите пункты **Параметры** > **Дополнительные параметры** > **Открыть параметры прокси-сервера** > **Настройка прокси вручную**.
2. **Включите** параметр **Использовать прокси-сервер**, установите флажок **Не использовать прокси-сервер для локальных (внутрисетевых) адресов**, а затем укажите адрес и порт локального прокси-сервера.
3. Заполните необходимые параметры прокси-сервера.

   ![Диалоговое окно для настройки прокси-сервера](./media/application-proxy-working-with-proxy-servers/proxy-bypass-local-addresses.png)

## <a name="bypass-outbound-proxies"></a>Обход исходящих прокси-серверов

Соединители имеют базовые компоненты ОС, выполняющие исходящие запросы. Эти компоненты автоматически пытаются найти прокси-сервер в сети. Для этого применяется протокол автоматической настройки прокси, если он поддерживается в сети.

Компоненты ОС для поиска прокси-сервера выполняют поиск в DNS для доменного имени wpad.[доменный_суффикс]. Если DNS возвращает IP-адрес для этого имени, выполняется HTTP-запрос на этот адрес для получения файла wpad.dat. Этот запрос возвращает скрипт конфигурации прокси-сервера для вашей среды. Соединитель использует этот скрипт, чтобы выбрать исходящий прокси-сервер. Однако прокси-сервер может не принимать трафик соединителя, поскольку для этого требуется настройка дополнительных параметров конфигурации.

Можно настроить соединитель, чтобы он игнорировал локальный прокси-сервер и подключался к службам Azure напрямую. Мы рекомендуем использовать именно этот подход (если допускает политика сети), так как он позволяет сократить количество конфигураций.

Чтобы отключить в соединителе использование исходящего прокси-сервера, измените файл C:\Program Files\Microsoft AAD App Proxy Connector\ApplicationProxyConnectorService.exe.config. Добавьте в него раздел *system.net* с приведенным далее текстом:

```xml
<?xml version="1.0" encoding="utf-8" ?>
<configuration>
  <system.net>
    <defaultProxy enabled="false"></defaultProxy>
  </system.net>
  <runtime>
    <gcServer enabled="true"/>
  </runtime>
  <appSettings>
    <add key="TraceFilename" value="AadAppProxyConnector.log" />
  </appSettings>
</configuration>
```
Чтобы служба обновления соединителя также обходила прокси-сервер, измените аналогичным образом и файл ApplicationProxyConnectorUpdaterService.exe.config, расположенный в каталоге C:\Program Files\Microsoft AAD App Proxy Connector Updater.

Обязательно сделайте копии исходных файлов на случай, если потребуется восстановить конфигурации по умолчанию.

## <a name="use-the-outbound-proxy-server"></a>Использование исходящего прокси-сервера

В некоторых средах весь исходящий трафик без исключений должен проходить через исходящий прокси-сервер. В результате этого невозможно будет выполнить обход прокси-сервера.

Вы можете настроить передачу трафика соединителя через исходящий прокси-сервер, как показано на следующей схеме:

 ![Использование исходящего прокси-сервера для передачи трафика от соединителя к прокси приложения Azure AD](./media/application-proxy-working-with-proxy-servers/configure-proxy-settings.png)

Поскольку соединитель использует только исходящий трафик, нет необходимости пропускать входящий трафик через брандмауэры.

### <a name="step-1-configure-the-connector-and-related-services-to-go-through-the-outbound-proxy"></a>Шаг 1. Настройка использования исходящего прокси-сервера для соединителя и службы средства обновления

Как мы уже объясняли выше, соединитель автоматически обнаружит исходящий прокси-сервер и попытается его использовать, если в среде поддерживается протокол автоматической настройки прокси. Тем не менее можно явным образом настроить использование исходящего прокси-сервера для соединителя.

Для этого измените файл C:\Program Files\Microsoft AAD App Proxy Connector\ApplicationProxyConnectorService.exe.config и добавьте раздел *system.net*, поместив в него следующий образец кода. Вместо *proxyserver:8080* укажите имя или IP-адрес локального прокси-сервера и номер порта для доступа к нему.

```xml
<?xml version="1.0" encoding="utf-8" ?>
<configuration>
  <system.net>  
    <defaultProxy>   
      <proxy proxyaddress="http://proxyserver:8080" bypassonlocal="True" usesystemdefault="True"/>   
    </defaultProxy>  
  </system.net>
  <runtime>
    <gcServer enabled="true"/>
  </runtime>
  <appSettings>
    <add key="TraceFilename" value="AadAppProxyConnector.log" />
  </appSettings>
</configuration>
```

Затем настройте службу обновления соединителя, чтобы она использовала тот же прокси-сервер, изменив аналогичным образом файл, расположенный по пути C:\Program Files\Microsoft AAD App Proxy Connector Updater\ApplicationProxyConnectorUpdaterService.exe.config.

### <a name="step-2-configure-the-proxy-to-allow-traffic-from-the-connector-and-related-services-to-flow-through"></a>Шаг 2. Настройка прокси-сервера для передачи трафика соединителя и связанных с ним служб

В настройках прокси-сервера нужно учесть 4 аспекта:
* правила для исходящих подключений прокси-сервера;
* проверка подлинности прокси-сервера;
* порты прокси-сервера;
* проверка SSL.

#### <a name="proxy-outbound-rules"></a>правила для исходящих подключений прокси-сервера;
Разрешите доступ к следующих конечным точкам, чтобы получить доступ к службе соединителя:

* *.msappproxy.net;
* *.servicebus.windows.net

Для первоначальной регистрации нужно разрешить доступ к следующим конечным точкам:

* login.windows.net
* login.microsoftonline.com

Невозможно разрешить подключения по полному доменному имени. Вместо этого укажите диапазоны IP-адресов. Используйте следующие параметры:

* разрешите соединителю исходящий доступ к любым адресам назначения;
* разрешите соединителю исходящий доступ к [IP-адресам центров обработки данных Azure](https://www.microsoft.com/en-gb/download/details.aspx?id=41653). Если вы предпочитаете использовать диапазоны IP-адресов центров обработки данных Azure, вас ждет одна сложность — эти списки обновляются еженедельно. Необходимо организовать процесс соответствующего обновления правил доступа.

#### <a name="proxy-authentication"></a>проверка подлинности прокси-сервера;

Проверка подлинности прокси в настоящее время не поддерживается. Сейчас мы рекомендуем разрешить соединителю получать анонимный доступ к определенному сайту Интернета.

#### <a name="proxy-ports"></a>порты прокси-сервера;

Соединитель устанавливает исходящие SSL-подключения, используя метод CONNECT. По сути он создает туннель через исходящий прокси-сервер. В настройках прокси-сервера разрешите туннелирование к портам 443 и 80.

>[!NOTE]
>При запуске служебной шины по протоколу HTTPS используется порт 443. По умолчанию служебная шина пытается использовать прямые TCP-подключения, а протокол HTTPS применяет только при невозможности прямого подключения.

Чтобы проверить, отправляется ли трафик служебной шины через исходящий прокси-сервер, убедитесь, что соединитель не может напрямую подключиться к службам Azure по портам 9350, 9352 и 5671.

#### <a name="ssl-inspection"></a>проверка SSL.
Для трафика соединителя не стоит использовать проверку SSL, так как это вызывает проблемы.

## <a name="troubleshoot-connector-proxy-problems-and-service-connectivity-issues"></a>Устранение неполадок в работе соединителя через прокси-сервера и с подключением к службе
Теперь весь трафик должен проходить через прокси-сервер. Если вы столкнетесь с проблемами, попробуйте применить следующие сведения об устранении неполадок.

Для определения и устранения проблем с подключением соединителя мы рекомендуем выполнить запись сетевых данных для службы соединителя во время ее запуска. Это может оказаться непростой задачей, так что давайте рассмотрим советы по сбору и фильтрации данных трассировки сети.

Вы можете использовать выбранное средство мониторинга. Для целей этой статьи мы использовали Microsoft Network Monitor 3.4. Эту версию можно загрузить [здесь](https://www.microsoft.com/download/details.aspx?id=4865).

Примеры и фильтры, которые мы используем ниже, относятся именно к сетевому монитору, но те же принципы можно применить к любому средству анализа.

### <a name="take-a-capture-by-using-network-monitor"></a>Выполнение записи с помощью сетевого монитора

Для начала записи:

1. Откройте сетевой монитор и щелкните **New Capture** (Новая запись).
2. Нажмите кнопку **Запустить**.

   ![Окно сетевого монитора](./media/application-proxy-working-with-proxy-servers/network-capture.png)

Когда вы закончите запись данных, нажмите кнопку **Стоп**, чтобы завершить процесс.

### <a name="take-a-capture-of-connector-traffic"></a>Сбор трафика соединителя

Для первоначального устранения неполадок сделайте следующее:

1. Из оснастки services.msc остановите службу соединителя прокси приложения Azure AD.
2. Запустите запись сетевых данных.
3. Запустите службу соединителя прокси приложения Azure AD.
4. Остановите запись сетевых данных.

   ![Служба соединителя прокси приложения Azure AD в services.msc](./media/application-proxy-working-with-proxy-servers/services-local.png)

### <a name="look-at-the-requests-from-the-connector-to-the-proxy-server"></a>Просмотр запросов от соединителя к прокси-серверу

Итак, вы собрали сетевые данные и теперь можете отфильтровать их. Основным моментом в трассировке является умение фильтровать собранные данные.

Например, можно использовать такой фильтр (где 8080 — это порт службы прокси-сервера):

**(http.Request or http.Response) and tcp.port==8080**

Если вы введете этот фильтр в окно **Фильтр отображения** и щелкнете **Применить**, собранный трафик отфильтруется по этому фильтру.

Указанный выше фильтр отбирает только HTTP-запросы на порт прокси-сервера и его ответы. Для запуска соединителя, настроенного для использования прокси-сервера, этот фильтр отобразит примерно такие результаты:

 ![Пример списка отфильтрованных запросов и ответов HTTP](./media/application-proxy-working-with-proxy-servers/http-requests.png)

Теперь нужно найти запросы CONNECT, которые демонстрируют взаимодействие с прокси-сервером. В случае успеха вы получите ответ OK с HTTP-кодом 200.

Если отобразятся другие коды ответов, например 407 или 502, это означает, что прокси-сервер требует проверки подлинности или не разрешает передачу трафика по другой причине. На этом этапе следует обратиться в службу поддержки прокси-сервера.

### <a name="identify-failed-tcp-connection-attempts"></a>Выявление неудачных попыток подключения TCP

Вас может заинтересовать еще один распространенный сценарий: соединитель пытается подключиться напрямую, но не может.

Ниже представлен пример фильтра сетевого монитора, который позволяет легко выявить такую проблему.

**property.TCPSynRetransmit**

Пакет SYN — это первый пакет, отправленный для установления подключения TCP. Если ответ на этот пакет не возвращается, пакет SYN отправляется еще раз. Для поиска повторных пакетов SYN можно использовать предыдущий фильтр. После этого можно проверить, соответствуют ли эти пакеты SYN трафику соединителя.

В следующем примере показана ошибка подключения к порту 9352 служебной шины:

 ![Пример ответа для ошибки подключения](./media/application-proxy-working-with-proxy-servers/failed-connection-attempt.png)

Если вы видите ответ, аналогичный указанному выше, значит соединитель пытается напрямую взаимодействовать со службой служебной шины Azure. Если соединитель действительно должен подключаться к службам Azure напрямую, логично предположить проблему в сети или в брандмауэре.

>[!NOTE]
>Если же вы используете подключение через прокси-сервер, такой ответ может означать, что служебная шина пытается применить прямое подключение TCP, прежде чем использовать подключение по протоколу HTTPS.
>

Анализ трассировки сети — не идеальное решение. Но он может быть ценным средством для быстрого получения сведений о проблемах с сетью.

Если проблемы с подключением соединителя не удалось устранить, отправьте запрос в службу технической поддержки. Мы поможем вам с устранением неполадок.

Сведения об устранении ошибок соединителя прокси приложения см. в [этой статье](https://azure.microsoft.com/documentation/articles/active-directory-application-proxy-troubleshoot).

## <a name="next-steps"></a>Дальнейшие действия

[Сведения о соединителях прокси приложения Azure AD](application-proxy-understand-connectors.md)<br>
[Автоматическая установка соединителя прокси приложения Azure AD](active-directory-application-proxy-silent-installation.md)

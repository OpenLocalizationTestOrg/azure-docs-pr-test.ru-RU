---
title: "aaaHow tooconfigure toouse приложения прокси приложения ограниченное делегирование Kerberos | Документы Microsoft"
description: "Как tooconfigure ограниченное делегирование Kerberos для приложения прокси приложения Azure AD."
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 93dac264ff1d3b99dead1d9c759c37c59373cbd4
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="how-tooconfigure-an-application-proxy-application-toouse-kerberos-constrained-delegation"></a>Как tooconfigure toouse приложения прокси приложения ограниченное делегирование Kerberos

Hello методы, доступные для реализации единого входа toopublished приложений может немного отличаться из tooapplication приложения и один из параметров hello, что прокси приложения Azure предлагает справа стандартной hello — ограниченное делегирование Kerberos (KCD). Именно здесь узел соединителя находится настроенный tooperform ограниченное kerberos проверки подлинности toobackend приложений, от имени пользователей.

Hello фактическое процедура включения проверки подлинности Kerberos выполняется относительно просто и обычно требует не более чем общее представление о hello, различные компоненты и поток проверки подлинности, который упрощает единого входа. Поиск полезные источники информации toohelp устранения неполадок, связанных сценариев, где единого входа для проверки подлинности Kerberos не работает должным образом, могут быть разреженными.

Таким образом в этой статье попыток tooprovide точки ссылки, должны помочь при устранении и самостоятельно устранять некоторые hello наиболее распространенных проблем, которые мы видим. В hello же время предложение получения дополнительных рекомендаций по диагностике hello сложнее и проблемной реализации.

Обратите внимание, что в данной статье выполняет hello следующие допущения:

-   Прокси приложения Azure был развернут согласно нашей [документации](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) и общего доступа toonon KCD приложений работает надлежащим образом.

-   Hello опубликованных целевого приложения основан на IIS и Майкрософт для реализации kerberos.

-   узлы сервера и приложения Hello находятся в одном домене Active Directory. Подробные сведения о междоменных и межлесных сценариях см. в нашем [техническом документе об ограниченном делегировании Kerberos](http://aka.ms/KCDPaper).

-   Hello субъекта публикации приложения в Azure клиента с помощью предварительной проверки подлинности включена, а пользователи должны tooAzure tooauthenticate через формы проверки подлинности на основе. Сценарии проверки подлинности клиента Rich не представленных в этой статье, но добавлены в определенный момент в будущем hello.

## <a name="prerequisites"></a>Предварительные требования

Прокси приложения Azure могут развертываться в практически любой тип инфраструктуры или архитектуры среды и hello без сомнения различаться в зависимости от tooorganization организации. Одна из наиболее распространенных причин hello ограниченное делегирование Kerberos, касающиеся проблемы не hello сред, но довольно простой неверной конфигурации или общие контроля.

По этой причине пользователям рекомендуется всегда toostart, убедившись, что выполнены все необходимые компоненты hello располагаются в нашем main [с помощью единого входа проверки подлинности Kerberos со статьей прокси приложения hello](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) до запуска Устранение неполадок.

Особенно hello раздел о настройке проверки подлинности Kerberos в 2012 R2, как в нем используется tooconfiguring существенно различается способ проверки подлинности Kerberos в предыдущих версиях Windows, но не учитывать несколько факторов:

-   Довольно часто для tooopen сервер члена домена диалоговое окно безопасный канал с определенным контроллером домена. Переместите tooanother диалогового окна в любой момент времени, поэтому соединитель узлы обычно не должно быть ограниченным toobeing может toocommunicate с контроллерами домена только определенным локального сайта.

-   Аналогичные toohello выше точки междоменные сценарии используют ссылок, которые будут направлять tooDCs узла соединителя, находящиеся за пределами локальной сети периметра hello. В этом сценарии, он не столь же важно toomake в том, что также позволяет пользователям начиная трафика tooDCs, представляющие других соответствующих доменах, в противном случае делегирование ошибкой.

-   По возможности не следует располагать активные устройства IPS/IDS между узлами соединителя и контроллерами домена, так как иногда это нарушает правильную работу и мешает прохождению основного трафика RPC.

Столько, мы хотели бы tooresolve проблемы быстро и эффективно, может потребоваться время, таким образом по возможности следует повторите и проверить делегирование в hello простой сценариев. Здравствуйте, несколько переменных, которые вы вводите, hello более имеется toocontend с. Например ограничение тестирования один соединитель tooa экономить ценное рабочее время и дополнительные соединители можно добавлять после устранения проблемы hello.

Некоторые факторы среды могут также вызывать проблемы tooan и опять же если возможно, что свести к минимуму hello архитектура tooa минимальный набор для тестирования. Например, имеет неправильный формат внутренним брандмауэром ACL не являются редкими, поэтому желательно по возможности имеют весь трафик от соединителя, допускается прямо через toohello контроллеров домена и серверной части приложения. 

Фактически hello абсолютный наиболее месте tooposition соединители — как целевые объекты tootheir как может быть. Использование встроенного брандмауэра при тестировании лишь чрезмерно усложняет процесс и может приводить к затягиванию работы.

Так в чем именно состоит проблема ограниченного делегирования Kerberos? Также существует несколько указывают на классический единого входа проверки подлинности Kerberos, сбои и hello первый признаков проблемы обычно ведут себя в hello браузера.

   ![Ошибка из-за неправильной конфигурации ограниченного делегирования Kerberos](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![Авторизация не выполнена из-за toomissing разрешения](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

все, которые содержат hello же признаком сбоя tooperform единого входа и поэтому запрет hello приложение toohello доступа пользователя.

## <a name="troubleshooting"></a>Устранение неполадок

Как вы устраните зависят проблема hello и наблюдается проблема. Прежде чем идти дальнейшей бы рекомендуется hello ссылкам, как они содержат полезные сведения, которые вы не еще получен через:

-   [Устранение неполадок и сообщения об ошибках прокси приложения](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [Ошибки и симптомы Kerberos](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [Работа с единым входом при несовпадении локальных и облачных удостоверений](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

Если у вас есть это расстояние, а затем hello основной проблема определенно существует. Требуется toodig глубже, запустите, разделяя hello потока в трех различных этапов, вы можете устранить.

**Предварительная проверка подлинности клиента** -hello внешнего пользователя, проверки подлинности tooAzure через браузер.

Выполняется доступ toopre-проверки подлинности tooAzure при toofunction единого входа для проверки подлинности Kerberos. При возникновении проблем этот аспект нужно проверить первым. Обратите внимание, что Этап предварительной проверки подлинности hello не tooKCD отношения или hello опубликованное приложение. Должно быть довольно просто toocorrect несоответствий, по злому проверка учетной записи субъекта hello в Azure существует и что он не отключено или заблокирован. Отклик Hello в браузере hello является причиной обычно достаточно информативным toounderstand hello. Если вы не уверены, можно также проверить наши tooverify docs Устранение неполадок.

**Делегирование службы** -hello получения билета службы kerberos KDC (центр распространения Kerberos), соединитель прокси-сервера Azure от лица пользователей.

Hello внешнего обмена данными между клиентом hello и hello Azure внешнего интерфейса следует никак не влияют на ограниченное делегирование Kerberos ни при каких обстоятельствах, отличный от обеспечение его работы. Это hello Azure прокси-службы может быть предоставленный идентификатор пользователя недопустим, быть используется tooobtain билет kerberos. Без этого ограниченное делегирование Kerberos невозможно и приведет к сбою.

Как упоминалось ранее, сообщения об ошибках обозревателя hello обычно обеспечивают некоторые хорошо выявить причину ошибки при выполнении действия. Убедитесь что toonote вниз hello идентификатор действия и отметку времени в ответ hello, поскольку это позволяет toocorrelate hello поведение tooactual события в журнал событий прокси-сервера Azure hello.

   ![Ошибка из-за неправильной конфигурации ограниченного делегирования Kerberos](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

И hello соответствующие записи журнала событий для замеченный hello будет рассматривать как события 13019 или 12027. Найти hello соединителя журналы событий в **журналы приложений и служб** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Соединитель**&gt;**администратора**.

   ![Событие 13019 из журнала событий прокси приложения](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![Событие 12027 из журнала событий прокси приложения](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   Использовать записи в внутренние DNS-сервера для адреса приложения hello, а не запись CName

-   Повторно подтвердить, на которых размещены hello соединителя была предоставлена hello права toodelegate toohello назначенному целевую учетную запись имени участника-службы и что **использовать любой протокол проверки подлинности** выбран. Подробнее это рассмотрено в основной [статье о конфигурации единого входа](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd).

-   Проверьте, что используется только один экземпляр hello имени участника-службы, существующее в AD, выполнив **setspn - x** из командную строку на любом узле член домена

-   Проверьте toosee, если политика домена выполняется принудительно toolimit hello [максимальный размер маркеров kerberos выданного](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), как этот соединитель hello запретить получение токена, если найден toobe чрезмерного

Захват hello обмена между hello соединителя узла и домена KDC трассировку в сети, будут hello наиболее Далее для получения более низкого уровня подробно описывается hello проблемы. Соответствующие сведения приведены в [подробном официальном документе по устранению неполадок](https://aka.ms/proxytshootpaper).

Если бронирование хорошее, вы увидите события в журналах hello, о том, что проверка подлинности сбоем из-за toohello приложением, которое возвращает 401. Это обычно указывает на это целевое приложение hello отклоняет запрос, поэтому действуйте с hello, выполнив следующий этап.

**Идентификатор целевого приложения** -потребитель hello hello билета kerberos, предоставляемые hello соединителя

На этот этап hello соединитель ожидаемым toohave отправляется основы toohello билет службы kerberos, как заголовок в первом запросе приложения hello.

-   С помощью приложения hello внутреннего URL-адреса, определенные в портал hello проверку приложения hello доступным напрямую из браузера hello на узел соединителя hello. После этого можно выполнить вход. Подробные сведения об этом можно найти на странице Устранение неполадок соединителя hello.

-   По-прежнему на узел соединителя hello, убедитесь, что проверка подлинности hello между браузера hello и приложения hello использует протокол kerberos, выполнив одно из следующих hello:

1.  Запуск средств разработки (**F12**) в Internet Explorer или использовать [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) с hello соединителя узла. Go toohello приложения, использующего hello внутренний URL-адрес и проверять hello предлагаемых заголовки authorization WWW, возвращенный в ответе hello из приложения hello, присутствует tooensure, либо negotiate или kerberos. В последующих kerberos большой двоичный объект, возвращенный в ответе hello из браузера toohello hello приложения обычно начинаются с **YII**, поэтому это полное представление о kerberos в Google play. NTLM на hello другой стороны всегда начинаются с **TlRMTVNTUAAB**, который читает NTLMSSP при декодирование из Base64. Если вы видите **TlRMTVNTUAAB** во время запуска hello hello большого двоичного объекта, это означает, что Kerberos **не** доступны. В противном случае он, вероятнее всего, доступен.

  * Обратите внимание, если с помощью Fiddler, этот метод потребует временно отключить расширенную защиту в конфигурации приложения hello в службах IIS.

     ![Окно проверки сети в браузере](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    *Рисунок.* Так как в начале стоит не TIRMTVNTUAAB, значит протокол Kerberos доступен. Это пример BLOB-объекта Kerberos, который начинается не с YII.

2.  Временно удалите NTLM из списка поставщиков hello для сайта и доступ приложения IIS непосредственно из IE на узле соединителя. При использовании NTLM больше не в список поставщиков hello должно быть приложения hello может tooaccess только с помощью Kerberos. Если это не удается, затем, предполагает, что имеется проблема с конфигурацией приложения hello и проверка подлинности Kerberos не работает.

Если проверка Kerberos недоступна, приложения hello флажок проверки подлинности, согласовывать параметры в IIS toomake убедиться, что отображается переднего плана с использованием протокола NTLM непосредственно под ним. (не Negotiate:kerberos или Negotiate:PKU2U). Продолжайте работу, только если Kerberos работает.

   ![Поставщики проверки подлинности Windows](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   Kerberos и NTLM в месте позволяет теперь временно отключить предварительную проверку подлинности для приложения hello hello портала. Если доступен из hello в разделе Интернет с помощью hello внешний URL-адрес. Должен быть запросом tooauthenticate и должно быть возможности toodo, чтобы с hello учетную запись hello используется в предыдущем шаге. Если нет, это указывает на проблему с внутреннее приложение hello и ограниченное делегирование Kerberos не вообще.

-   Теперь снова включить предварительную проверку подлинности на портале hello и проверки подлинности с помощью Azure, попробуйте tooconnect toohello приложения с помощью внешних URL. Если произошел сбой единого входа, вы увидите запрещенных сообщение hello браузера, а также событие 13022 hello журнала:

    *Microsoft AAD Application Proxy Connector не удается проверить подлинность пользователя hello, поскольку hello внутренний сервер отвечает tooKerberos попыток проверки подлинности с ошибкой HTTP 401.*

    ![Ошибка запрета доступа 401 HTTTP](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   Проверьте настроенные toouse приветствия одной учетной записи hello имени участника-службы настроен для в AD, перейдя в службах IIS, как показано ниже пул приложений настроен hello tooensure приложения hello IIS

    ![Окно конфигурации приложения IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    После известно удостоверение hello, выполните следующую команду hello cmd prompt toomake том, что эта учетная запись определенно с hello рассматриваемой имени участника-службы. Например, **setspn – q http/spn.wacketywack.com**

    ![Командное окно SetSPN](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   Проверьте, hello, имя участника-службы, определенных для приложения hello параметры на портале hello hello тоже имя SPN, настроенных для учетной записи целевой AD hello используется пул приложений приложения hello

   ![Настройка имени субъекта-службы на портале Azure](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   Перейдите в IIS и выберите hello **редактор конфигурации** для приложения hello, а затем перейдите слишком**system.webServer/security/authentication/windowsAuthentication** toomake убедиться, что этот **UseAppPoolCredentials** задано tootrue

   ![Параметр учетных данные для пулов приложений в конфигурации IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

При, полезны для повышения производительности hello операций Kerberos, также оставить включенным режимом ядра приводит hello билет для hello запрошенный toobe службы расшифровать с помощью учетной записи компьютера. Это также называется hello локальной системы, так что наличие этого набора tootrue разрыв ограниченное делегирование Kerberos, когда приложение hello размещается на нескольких серверах в ферме.

-   Как дополнительную проверку, может также потребоваться toodisable hello **расширенного** защиты слишком. Были обнаружены сценариях, где это доказал toobreak ограниченное делегирование Kerberos, при включении в определенных конфигурациях, где приложение публикуется как вложенной папкой hello по умолчанию веб-сайта. Это сам настраивается для анонимной проверки подлинности, только если оставить все диалоговые окна hello серым цветом, что означает, что дочерние объекты бы не наследования параметров active. Но, возможно, будет всегда рекомендуется использовать эта возможность включена, поэтому все далеко тестирования, когда не забывайте toorestore этот tooenabled.

Они должны ставить вас toostart отслеживания с помощью опубликованного приложения. Начинайте и раскрутки дополнительных соединителей, которые также являются toodelegate, но если обстоятельства более нет бы рекомендуется выполнить чтение нашей более подробные технические пошагового руководства [hello полное руководство по для приложения AD Azure, устранение неполадок Прокси-сервера](https://aka.ms/proxytshootpaper)

Если вы по-прежнему не удается tooprogress проблему, поддержки будут более чем довольны tooassist и продолжить здесь. Создайте запрос в службу поддержки непосредственно на портале hello и наши инженеры будут направляться tooyou.

## <a name="other-scenarios"></a>Другие сценарии

-   Прокси приложения Azure запрашивает билет Kerberos перед отправкой его применение tooan запроса. Некоторые сторонние приложения например Tableau Server не хотелось бы этот метод проверки подлинности, а вместо этого ожидает hello более традиционных согласования tootake месте. первый запрос Hello является анонимным, позволить toorespond приложения hello hello типы проверки подлинности, которые она поддерживает через 401.

-   Проверка подлинности с двумя прыжками — обычно используется в сценариях с многоуровневым приложением, где проверка подлинности требуется как для серверной, так и для интерфейсной части (например, SQL Reporting Services).

## <a name="next-steps"></a>Дальнейшие действия
[Настройка ограниченного делегирования Kerberos в управляемом домене](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)

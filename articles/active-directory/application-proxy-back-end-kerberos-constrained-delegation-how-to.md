---
title: "Настройка приложения прокси приложения для использования ограниченного делегирования Kerberos | Документы Майкрософт"
description: "Описание настройки ограниченного делегирования Kerberos для приложения прокси приложения Azure AD."
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 3a768c30cb874d42d7b4fbd2eeaa6c0e23904e10
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="how-to-configure-an-application-proxy-application-to-use-kerberos-constrained-delegation"></a><span data-ttu-id="1085a-103">Настройка приложения прокси приложения для использования ограниченного делегирования Kerberos</span><span class="sxs-lookup"><span data-stu-id="1085a-103">How to configure an Application Proxy application to use Kerberos Constrained Delegation</span></span>

<span data-ttu-id="1085a-104">Методы обеспечения единого входа в разных опубликованных приложениях могут немного различаться. Одной из функций, включенных в состав прокси приложения Azure, является ограниченное делегирование Kerberos (KCD).</span><span class="sxs-lookup"><span data-stu-id="1085a-104">The methods available for achieving SSO to published applications can somewhat vary from application to application and one of the options that Azure Application Proxy offers right out of the box, is Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="1085a-105">В ней узел соединителя настроен для проверки подлинности на базе ограниченного делегирования Kerberos для серверных приложений, от имени пользователей.</span><span class="sxs-lookup"><span data-stu-id="1085a-105">This is where a connector host is configured to perform constrained kerberos authentication to backend applications, on behalf of users.</span></span>

<span data-ttu-id="1085a-106">Процедура включения этой функции относительно проста, и обычно для нее достаточно общих знаний о разных компонентах и потоке проверки подлинности, на основе которого реализуется единый вход.</span><span class="sxs-lookup"><span data-stu-id="1085a-106">The actual procedure for enabling KCD is relatively straightforward and typically requires no more than a general understanding of the various components and authentication flow that facilitates SSO.</span></span> <span data-ttu-id="1085a-107">Доступно довольно мало хороших источников информации по устранению неполадок в случаях, когда единый вход с ограниченным делегированием Kerberos работает неправильно, и они довольно разрозненны.</span><span class="sxs-lookup"><span data-stu-id="1085a-107">Finding good sources of information to help troubleshoot scenarios where KCD SSO doesn’t function as expected, can be sparse.</span></span>

<span data-ttu-id="1085a-108">Эта статья призвана выступить в роли сводного справочника, помогающего самостоятельно выявить и устранить некоторые из наиболее распространенных проблем.</span><span class="sxs-lookup"><span data-stu-id="1085a-108">As such, this article attempts to provide a single point of reference that should help troubleshoot and self-remediate some of the most common issues that we see.</span></span> <span data-ttu-id="1085a-109">Кроме того, в ней приводятся дополнительные рекомендации по диагностике более сложных проблем реализации.</span><span class="sxs-lookup"><span data-stu-id="1085a-109">At the same time offer additional guidance for diagnosing the more complex and troubled of implementation.</span></span>

<span data-ttu-id="1085a-110">Обратите внимание, что в этой статье сделаны следующие предположения:</span><span class="sxs-lookup"><span data-stu-id="1085a-110">note that this article makes the following assumptions:</span></span>

-   <span data-ttu-id="1085a-111">Прокси приложения Azure был развернут согласно нашей [документации](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable), а общий доступ к приложениям без ограниченного делегирования Kerberos работает как ожидалось.</span><span class="sxs-lookup"><span data-stu-id="1085a-111">Azure Application Proxy has been deployed as per our [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) and general access to non KCD applications is working as expected.</span></span>

-   <span data-ttu-id="1085a-112">Опубликованное целевое приложение основано на службах IIS и реализации kerberos от корпорации Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="1085a-112">The published target application is based on IIS and Microsoft’s implementation of kerberos.</span></span>

-   <span data-ttu-id="1085a-113">Узлы сервера и приложения находятся в одном домене Active Directory.</span><span class="sxs-lookup"><span data-stu-id="1085a-113">The server and application hosts reside in a single Active Directory domain.</span></span> <span data-ttu-id="1085a-114">Подробные сведения о междоменных и межлесных сценариях см. в нашем [техническом документе об ограниченном делегировании Kerberos](http://aka.ms/KCDPaper).</span><span class="sxs-lookup"><span data-stu-id="1085a-114">Detailed information on cross domain and forest scenarios can be found in our [KCD whitepaper](http://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="1085a-115">Целевое приложение публикуется в клиенте Azure с включенной предварительной проверкой подлинности, а пользователи должны входить в Azure с помощью проверки подлинности на основе форм.</span><span class="sxs-lookup"><span data-stu-id="1085a-115">The subject application is published in an Azure tenant with pre-authentication enabled, and users are expected to authenticate to Azure via forms based authentication.</span></span> <span data-ttu-id="1085a-116">Расширенные сценарии проверки подлинности клиента не рассматриваются в этой статье, но будут добавлены в будущем.</span><span class="sxs-lookup"><span data-stu-id="1085a-116">Rich client authentication scenarios are not covered by this article, but be added at some point in the future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="1085a-117">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="1085a-117">Prerequisites</span></span>

<span data-ttu-id="1085a-118">Прокси приложения Azure можно развернуть в инфраструктуре или среде практически любого типа, и конкретная архитектура наверняка будет зависеть от потребностей соответствующей организации.</span><span class="sxs-lookup"><span data-stu-id="1085a-118">Azure Application Proxy can be deployed into pretty much any type of infrastructure or environment and the architectures no doubt vary from organization to organization.</span></span> <span data-ttu-id="1085a-119">Одной из наиболее распространенных причин для проблем, связанных с ограниченным делегированием Kerberos, являются не столько сами среды, сколько неправильная настройка или общий контроль.</span><span class="sxs-lookup"><span data-stu-id="1085a-119">One of the most common causes of KCD related issues are not the environments themselves, but rather simple mis-configurations, or general oversight.</span></span>

<span data-ttu-id="1085a-120">Поэтому до начала работы по устранению неполадок мы рекомендуем убедиться в выполнении всех предварительных требований, изложенных в нашей основной [статье об использовании единого входа с ограниченным делегированием Kerberos вместе с прокси приложения](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd).</span><span class="sxs-lookup"><span data-stu-id="1085a-120">For this reason, our advice is always to start by making sure you have met all the pre-requisites laid out in our main [Using KCD SSO with the Application Proxy article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) before starting troubleshooting.</span></span>

<span data-ttu-id="1085a-121">Особое внимание нужно уделить разделу о настройке ограниченного делегирования Kerberos в 2012 R2, так как там описан кардинально иной подход к настройке ограниченного делегирования Kerberos для предыдущих версий Windows. При этом не следует забывать о нескольких других аспектах:</span><span class="sxs-lookup"><span data-stu-id="1085a-121">Particularly the section on configuring KCD on 2012R2, as this employs a fundamentally different approach to configuring KCD on previous versions of Windows, but also while being mindful of several other considerations:</span></span>

-   <span data-ttu-id="1085a-122">Рядовой сервер домена довольно часто изменяет диалоговый сеанс, открытый по безопасному каналу с определенным контроллером домена.</span><span class="sxs-lookup"><span data-stu-id="1085a-122">It is not uncommon for a domain member server to open a secure channel dialog with a specific domain controller.</span></span> <span data-ttu-id="1085a-123">Смена диалогового сеанса может произойти в любое время, поэтому в общем случае не следует ограничивать взаимодействие узлов соединителя лишь контроллерами домена определенного локального сайта.</span><span class="sxs-lookup"><span data-stu-id="1085a-123">Then move to another dialog at any given time, so connector hosts should generally not be restricted to being able to communicate with only specific local site DCs.</span></span>

-   <span data-ttu-id="1085a-124">Аналогичным образом, междоменные сценарии основываются на ссылках, ведущих к контроллерам домена, которые могут находиться за пределами периметра локальной сети.</span><span class="sxs-lookup"><span data-stu-id="1085a-124">Similar to the above point, cross domain scenarios rely on referrals that direct a connector host to DCs that may reside outside of the local network perimeter.</span></span> <span data-ttu-id="1085a-125">В данном случае не менее важно обеспечить прохождение трафика к контроллерам, представляющим другие соответствующие домены, иначе произойдет сбой делегирования.</span><span class="sxs-lookup"><span data-stu-id="1085a-125">In this scenario it is equally important to make sure you are also allowing traffic onwards to DCs that represent other respective domains, or else delegation fail.</span></span>

-   <span data-ttu-id="1085a-126">По возможности не следует располагать активные устройства IPS/IDS между узлами соединителя и контроллерами домена, так как иногда это нарушает правильную работу и мешает прохождению основного трафика RPC.</span><span class="sxs-lookup"><span data-stu-id="1085a-126">Where possible, you should avoid placing any active IPS/IDS devices between connector hosts and DCs, as these are sometimes over intrusive and interfere with core RPC traffic</span></span>

<span data-ttu-id="1085a-127">Как бы нам ни хотелось устранить такие проблемы быстро и эффективно, на это может потребоваться время. Поэтому по возможности следует тестировать делегирование на простых сценариях.</span><span class="sxs-lookup"><span data-stu-id="1085a-127">As much as we’d like to resolve issues quickly and effectively, it can take time, so where possible you should try and test delegation in the simplest of scenarios.</span></span> <span data-ttu-id="1085a-128">Чем больше переменных вы вводите, тем с большими трудностями можете столкнуться.</span><span class="sxs-lookup"><span data-stu-id="1085a-128">The more variables you introduce, the more you may have to contend with.</span></span> <span data-ttu-id="1085a-129">Например, ограничив тестирование одним соединителем, вы можете сэкономить время и добавить другие соединители уже после устранения проблем.</span><span class="sxs-lookup"><span data-stu-id="1085a-129">For example, limiting your testing to a single connector can save valuable time, and additional connectors can be added after the issues has been resolved.</span></span>

<span data-ttu-id="1085a-130">Появлению проблем могут способствовать и некоторые факторы среды. Поэтому так важно минимизировать архитектуру для тестирования.</span><span class="sxs-lookup"><span data-stu-id="1085a-130">Some environmental factors may also be contributing to an issue, so again if possible try and minimize the architecture to a bare minimum for testing.</span></span> <span data-ttu-id="1085a-131">Например, довольно часто встречаются неправильно настроенные внутренние списки ACL брандмауэра, поэтому по возможности организуйте прохождение трафика напрямую от соединителя к контроллерам домена и серверному приложению.</span><span class="sxs-lookup"><span data-stu-id="1085a-131">For example, misconfigured internal firewall ACLs are not uncommon, so if possible have all traffic from a connector allowed straight through to the DCs and backend application.</span></span> 

<span data-ttu-id="1085a-132">Соединители лучше всего располагать как можно ближе к их целям.</span><span class="sxs-lookup"><span data-stu-id="1085a-132">Actually the absolute best place to position connectors is as close to their targets as can be.</span></span> <span data-ttu-id="1085a-133">Использование встроенного брандмауэра при тестировании лишь чрезмерно усложняет процесс и может приводить к затягиванию работы.</span><span class="sxs-lookup"><span data-stu-id="1085a-133">Having a firewall sat inline whilst testing simply adds unnecessary complexity, and could just prolong your investigations.</span></span>

<span data-ttu-id="1085a-134">Так в чем именно состоит проблема ограниченного делегирования Kerberos?</span><span class="sxs-lookup"><span data-stu-id="1085a-134">So, what constitutes a KCD problem anyway?</span></span> <span data-ttu-id="1085a-135">Существует несколько распространенных признаков, указывающих на сбой единого входа с ограниченным делегированием Kerberos, и первые признаки проблемы обычно проявляются в браузере.</span><span class="sxs-lookup"><span data-stu-id="1085a-135">Well, there several classic indications of KCD SSO failing and the first signs of an issue usually manifest themselves in the browser.</span></span>

   ![Ошибка из-за неправильной конфигурации ограниченного делегирования Kerberos](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![Сбой авторизации из-за отсутствующих разрешений](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="1085a-138">Все это указывает на неработоспособность единого входа, в результате чего пользователь не может получить доступ к приложению.</span><span class="sxs-lookup"><span data-stu-id="1085a-138">all which bear the same symptom of failing to perform SSO, and consequently denying the user access to the application.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="1085a-139">Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="1085a-139">Troubleshooting</span></span>

<span data-ttu-id="1085a-140">Дальнейшая диагностика зависит от характера проблемы и наблюдаемых симптомов.</span><span class="sxs-lookup"><span data-stu-id="1085a-140">How you then troubleshoot depend on the issue and observed symptoms.</span></span> <span data-ttu-id="1085a-141">Прежде чем продолжить, мы предлагаем изучить материалы по следующим ссылкам, так как там приведены полезные сведения, которые могут быть вам неизвестны:</span><span class="sxs-lookup"><span data-stu-id="1085a-141">Before going any further we would suggest the following links, as they contain useful information you may not yet have come across:</span></span>

-   [<span data-ttu-id="1085a-142">Устранение неполадок и сообщения об ошибках прокси приложения</span><span class="sxs-lookup"><span data-stu-id="1085a-142">Troubleshoot Application Proxy problems and error messages</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [<span data-ttu-id="1085a-143">Ошибки и симптомы Kerberos</span><span class="sxs-lookup"><span data-stu-id="1085a-143">Kerberos errors and symptoms</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [<span data-ttu-id="1085a-144">Работа с единым входом при несовпадении локальных и облачных удостоверений</span><span class="sxs-lookup"><span data-stu-id="1085a-144">Working with SSO when on-premises and cloud identities are not identical</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

<span data-ttu-id="1085a-145">Если вы добрались до этого места, наверняка у вас возникла серьезная проблема.</span><span class="sxs-lookup"><span data-stu-id="1085a-145">If you’ve got this far, then the main issue definitely exists.</span></span> <span data-ttu-id="1085a-146">Нужно подробнее изучить возникшую ситуацию, поэтому разделим всю процедуру на три части, в рамках которых можно устранять неполадки.</span><span class="sxs-lookup"><span data-stu-id="1085a-146">You need to dig deeper, so start by separating the flow into three distinct stages that you can troubleshoot.</span></span>

<span data-ttu-id="1085a-147">**Предварительная проверка подлинности клиента** — внешний пользователь проходит проверку подлинности в Azure через браузер.</span><span class="sxs-lookup"><span data-stu-id="1085a-147">**Client pre-authentication** - The external user authenticating to Azure via a browser.</span></span>

<span data-ttu-id="1085a-148">Возможность прохождения предварительной проверки подлинности в Azure является обязательным условием для правильной работы единого входа с ограниченным делегированием Kerberos.</span><span class="sxs-lookup"><span data-stu-id="1085a-148">Being able to pre-authenticate to Azure is imperative for KCD SSO to function.</span></span> <span data-ttu-id="1085a-149">При возникновении проблем этот аспект нужно проверить первым.</span><span class="sxs-lookup"><span data-stu-id="1085a-149">This should be tested and addressed first, if there are any issues.</span></span> <span data-ttu-id="1085a-150">Обратите внимание, что этап предварительной проверки подлинности не имеет отношения к ограниченному делегированию Kerberos или опубликованному приложению.</span><span class="sxs-lookup"><span data-stu-id="1085a-150">Note that the pre-authentication stage has no relation to KCD or the published application.</span></span> <span data-ttu-id="1085a-151">Любые неполадки легко исправить, просто убедившись, что учетная запись существует в Azure и она не отключена и не заблокирована.</span><span class="sxs-lookup"><span data-stu-id="1085a-151">It should be fairly easy to correct any discrepancies by sanity checking the subject account exists in Azure, and that it is not disabled/blocked.</span></span> <span data-ttu-id="1085a-152">Сообщение об ошибке в браузере обычно достаточно информативно, чтобы понять причину.</span><span class="sxs-lookup"><span data-stu-id="1085a-152">The error response in the browser is usually descriptive enough to understand the cause.</span></span> <span data-ttu-id="1085a-153">Если вы не уверены, можете обратиться к другим нашим документам по устранению неполадок.</span><span class="sxs-lookup"><span data-stu-id="1085a-153">You can also check our other Troubleshoot docs to verify if you aren’t sure.</span></span>

<span data-ttu-id="1085a-154">**Служба делегирования** — соединитель прокси Azure, получающий билет службы Kerberos из KDC (центр распространения Kerberos) от имени пользователей.</span><span class="sxs-lookup"><span data-stu-id="1085a-154">**Delegation service** - The Azure Proxy connector obtaining a kerberos service ticket from a KDC (Kerberos Distribution Center), on behalf of users.</span></span>

<span data-ttu-id="1085a-155">Внешнее взаимодействие между клиентом и интерфейсной частью Azure должно осуществляться без привлечения ограниченного делегирования Kerberos. Эта функция используется лишь при проверке работоспособности такого взаимодействия.</span><span class="sxs-lookup"><span data-stu-id="1085a-155">The external communications between the client and the Azure front end should have no bearing on KCD whatsoever, other than ensuring that it works.</span></span> <span data-ttu-id="1085a-156">Таким образом, прокси-службе Azure можно предоставить допустимый идентификатор пользователя, используемый для получения билета Kerberos.</span><span class="sxs-lookup"><span data-stu-id="1085a-156">This is so the Azure Proxy service can be provided with a valid user ID that be used to obtain a kerberos ticket.</span></span> <span data-ttu-id="1085a-157">Без этого ограниченное делегирование Kerberos невозможно и приведет к сбою.</span><span class="sxs-lookup"><span data-stu-id="1085a-157">Without this KCD is not possible and would fail.</span></span>

<span data-ttu-id="1085a-158">Как упоминалось ранее, сообщения об ошибках в браузере обычно довольно точно описывают характер проблемы.</span><span class="sxs-lookup"><span data-stu-id="1085a-158">As mentioned previously, the browser error messages usually provide some good clues on why things are failing.</span></span> <span data-ttu-id="1085a-159">Обязательно запишите идентификатор действия и метку времени из сообщения, так как эти сведения помогут вам связать работу системы с событиями в журнале событий прокси Azure.</span><span class="sxs-lookup"><span data-stu-id="1085a-159">Make sure to note down the activity ID and timestamp in the response as this allow you to correlate the behavior to actual events in the Azure Proxy event log.</span></span>

   ![Ошибка из-за неправильной конфигурации ограниченного делегирования Kerberos](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="1085a-161">Соответствующие записи в журнале событий имеют номер 13019 или 12027.</span><span class="sxs-lookup"><span data-stu-id="1085a-161">And the corresponding entries seen the event log would be seen as events 13019 or 12027.</span></span> <span data-ttu-id="1085a-162">Журналы событий соединителя доступны в разделе **Журналы приложений и служб** &gt; **Майкрософт** &gt; **AadApplicationProxy** &gt; **Соединитель**&gt;**Администрирование**.</span><span class="sxs-lookup"><span data-stu-id="1085a-162">You can find the connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span></span>

   ![Событие 13019 из журнала событий прокси приложения](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![Событие 12027 из журнала событий прокси приложения](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   <span data-ttu-id="1085a-165">Используйте запись A во внутренней DNS для адреса приложения, а не запись CName.</span><span class="sxs-lookup"><span data-stu-id="1085a-165">Use an A record in your internal DNS for the application’s address, and not a CName</span></span>

-   <span data-ttu-id="1085a-166">Перепроверьте, что узлу соединителя предоставлены права на делегирование для имени субъекта-службы назначенной учетной записи и выбран параметр **Использовать любой протокол проверки подлинности**.</span><span class="sxs-lookup"><span data-stu-id="1085a-166">Re-confirm that the connector host has been granted the rights to delegate to the designated target account’s SPN, and that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="1085a-167">Подробнее это рассмотрено в основной [статье о конфигурации единого входа](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd).</span><span class="sxs-lookup"><span data-stu-id="1085a-167">This is covered in our main [SSO configuration article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span></span>

-   <span data-ttu-id="1085a-168">Убедитесь, что в AD существует всего один экземпляр имени субъекта-службы, выполнив команду **setspn -x** из командной строки на любом узле члена домена.</span><span class="sxs-lookup"><span data-stu-id="1085a-168">Verify that there is only a single instance of the SPN in existence in AD by issuing a **setspn -x** from a cmd prompt on any domain member host</span></span>

-   <span data-ttu-id="1085a-169">Проверьте, применяется ли политика домена для ограничения [максимального размера выдаваемых токенов Kerberos](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), так как она помешает соединителю получить токен, если он будет признан избыточным.</span><span class="sxs-lookup"><span data-stu-id="1085a-169">Check to see if a domain policy is being enforced to limit the [max size of issued kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), as this prevent the connector from obtaining a token if found to be excessive</span></span>

<span data-ttu-id="1085a-170">После этого для более глубокого понимания проблемы можно захватить данные, которыми обмениваются узел соединителя и домен ограниченного делегирования Kerberos, с помощью сетевой трассировки.</span><span class="sxs-lookup"><span data-stu-id="1085a-170">A network trace capturing the exchanges between the connector host and a domain KDC would then be the next best step in obtaining more low level detail on the issues.</span></span> <span data-ttu-id="1085a-171">Соответствующие сведения приведены в [подробном официальном документе по устранению неполадок](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="1085a-171">You can find this in [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="1085a-172">Если билеты обрабатываются правильно, в журналах должно присутствовать событие, указывающее на сбой проверки подлинности в связи с тем, что приложение возвращает ошибку 401.</span><span class="sxs-lookup"><span data-stu-id="1085a-172">If ticketing looks good, you should see an event in the logs stating that authentication failed due to the application returning a 401.</span></span> <span data-ttu-id="1085a-173">Обычно это означает, что целевое приложение отклоняет ваш билет, поэтому перейдите к следующему этапу.</span><span class="sxs-lookup"><span data-stu-id="1085a-173">This typically indicates that the target application rejecting your ticket, so proceed with the following next stage.</span></span>

<span data-ttu-id="1085a-174">**Целевое приложение** —потребитель билета Kerberos, предоставляемого соединителем.</span><span class="sxs-lookup"><span data-stu-id="1085a-174">**Target application** - The consumer of the kerberos ticket provided by the connector</span></span>

<span data-ttu-id="1085a-175">На этом этапе ожидается, что соединитель отправил билет службы Kerberos в серверную часть в виде заголовка внутри первого запроса приложения.</span><span class="sxs-lookup"><span data-stu-id="1085a-175">At this stage the connector is expected to have sent a kerberos service ticket to the backend, as a header within the first application request.</span></span>

-   <span data-ttu-id="1085a-176">Используя определенный на портале внутренний URL-адрес приложения, убедитесь, что приложение доступно прямо из браузера на узле соединителя.</span><span class="sxs-lookup"><span data-stu-id="1085a-176">Using the application’s internal URL defined in the portal, validate that the application is accessible directly from the browser on the connector host.</span></span> <span data-ttu-id="1085a-177">После этого можно выполнить вход.</span><span class="sxs-lookup"><span data-stu-id="1085a-177">Then you can login successfully.</span></span> <span data-ttu-id="1085a-178">Соответствующие сведения см. на странице об устранении неполадок соединителя.</span><span class="sxs-lookup"><span data-stu-id="1085a-178">Details on doing this can be found on the connector Troubleshoot page.</span></span>

-   <span data-ttu-id="1085a-179">Находясь на узле соединителя, убедитесь, что для проверки подлинности между браузером и приложением используется Kerberos. Для этого выполните одно из следующих действий:</span><span class="sxs-lookup"><span data-stu-id="1085a-179">Still on the connector host, confirm that the authentication between the browser and the application is using kerberos, by doing one of the following:</span></span>

1.  <span data-ttu-id="1085a-180">Запустите средства разработчика (**F12**) в Internet Explorer или используйте [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) на узле соединителя.</span><span class="sxs-lookup"><span data-stu-id="1085a-180">Run Dev tools(**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from the connector host.</span></span> <span data-ttu-id="1085a-181">Перейдите в приложение по внутреннему URL-адресу и проверьте предложенные заголовки авторизации WWW, возвращенные в ответе приложения, убедитесь в наличии согласования или Kerberos.</span><span class="sxs-lookup"><span data-stu-id="1085a-181">Go to the application using the internal URL, and inspect the offered WWW authorization headers returned in the response from the application, to ensure that either negotiate or kerberos is present.</span></span> <span data-ttu-id="1085a-182">BLOB-объект Kerberos, который затем возвращается в ответе из браузера в приложение, обычно начинается с **YII**, что указывает на использование Kerberos.</span><span class="sxs-lookup"><span data-stu-id="1085a-182">A subsequent kerberos blob returned in the response from the browser to the application typically start with **YII**, so this is a good indication of kerberos being in play.</span></span> <span data-ttu-id="1085a-183">С другой стороны, NTLM всегда начинается с **TlRMTVNTUAAB**, что после расшифровки из Base64 читается как NTLMSSP.</span><span class="sxs-lookup"><span data-stu-id="1085a-183">NTLM on the other hand always start with **TlRMTVNTUAAB**, which reads NTLMSSP when decoded from Base64.</span></span> <span data-ttu-id="1085a-184">Если в начале BLOB-объекта стоит **TlRMTVNTUAAB**, значит протокол Kerberos **недоступен**.</span><span class="sxs-lookup"><span data-stu-id="1085a-184">If you see **TlRMTVNTUAAB** at the start of the blob, this means that Kerberos is **not** available.</span></span> <span data-ttu-id="1085a-185">В противном случае он, вероятнее всего, доступен.</span><span class="sxs-lookup"><span data-stu-id="1085a-185">If you don’t see this, Kerberos is likely available.</span></span>

  * <span data-ttu-id="1085a-186">Обратите внимание, что при использовании Fiddler такой метод потребует временно отключить расширенную защиту в конфигурации приложения в службах IIS.</span><span class="sxs-lookup"><span data-stu-id="1085a-186">Note, if using Fiddler, this method would require temporarily disabling extended protection on the application’s config in IIS.</span></span>

     ![Окно проверки сети в браузере](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    <span data-ttu-id="1085a-188">*Рисунок.* Так как в начале стоит не TIRMTVNTUAAB, значит протокол Kerberos доступен.</span><span class="sxs-lookup"><span data-stu-id="1085a-188">*Figure:* Since this does not start with TIRMTVNTUAAB, this is an example that Kerberos is available.</span></span> <span data-ttu-id="1085a-189">Это пример BLOB-объекта Kerberos, который начинается не с YII.</span><span class="sxs-lookup"><span data-stu-id="1085a-189">This is an example of a Kerberos Blob that doesn’t start with YII.</span></span>

2.  <span data-ttu-id="1085a-190">Временно удалите NTLM из списка поставщиков на сайте IIS и обратитесь к приложению непосредственно из Internet Explorer на узле соединителя.</span><span class="sxs-lookup"><span data-stu-id="1085a-190">Temporarily remove NTLM from the providers list on IIS site and access app directly from IE on connector host.</span></span> <span data-ttu-id="1085a-191">Удалив NTLM из списка поставщиков, вы сможете обратиться к приложению с помощью одного только Kerberos.</span><span class="sxs-lookup"><span data-stu-id="1085a-191">With NTLM no longer in the providers list, you should be able to access the application using Kerberos only.</span></span> <span data-ttu-id="1085a-192">Если сделать это не удается, вероятно, возникла проблема с конфигурацией приложения и проверка подлинности Kerberos не работает.</span><span class="sxs-lookup"><span data-stu-id="1085a-192">If this fails, then that suggests that there is a problem with the application’s configuration and Kerberos authentication is not functioning.</span></span>

<span data-ttu-id="1085a-193">Если протокол Kerberos недоступен, проверьте параметры проверки подлинности приложения в службах IIS, где в самом начале должно быть указано согласование, а сразу после него — NTLM</span><span class="sxs-lookup"><span data-stu-id="1085a-193">If Kerberos is not available, then check the application’s authentication settings in IIS to make sure negotiate is listed topmost, with NTLM just beneath it.</span></span> <span data-ttu-id="1085a-194">(не Negotiate:kerberos или Negotiate:PKU2U).</span><span class="sxs-lookup"><span data-stu-id="1085a-194">(Not Negotiate:kerberos or Negotiate:PKU2U).</span></span> <span data-ttu-id="1085a-195">Продолжайте работу, только если Kerberos работает.</span><span class="sxs-lookup"><span data-stu-id="1085a-195">Only continue if Kerberos is functional.</span></span>

   ![Поставщики проверки подлинности Windows](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   <span data-ttu-id="1085a-197">Наладив работу Kerberos и NTLM, давайте временно отключим предварительную проверку подлинности для приложения на портале.</span><span class="sxs-lookup"><span data-stu-id="1085a-197">With Kerberos and NTLM in place, lets now temporarily disable pre-authentication for the application in the portal.</span></span> <span data-ttu-id="1085a-198">Проверьте, можно ли обратиться к приложению из Интернета по внешнему URL-адресу.</span><span class="sxs-lookup"><span data-stu-id="1085a-198">See if you can access it from the internet using the external URL.</span></span> <span data-ttu-id="1085a-199">Вы должны получить запрос на проверку подлинности и быть в состоянии пройти ее с помощью той же учетной записи, которая использовалась на предыдущем этапе.</span><span class="sxs-lookup"><span data-stu-id="1085a-199">You should be prompted to authenticate and should be able to do so with the same account used in the previous step.</span></span> <span data-ttu-id="1085a-200">Если эти условия не выполняются, значит проблема связана с серверным приложением, а не с ограниченным делегированием Kerberos.</span><span class="sxs-lookup"><span data-stu-id="1085a-200">If not, this indicates a problem with the backend application and not KCD at all.</span></span>

-   <span data-ttu-id="1085a-201">Теперь снова включите предварительную проверку подлинности на портале и пройдите проверку подлинности в Azure, попытавшись подключиться к приложению по внешнему URL-адресу.</span><span class="sxs-lookup"><span data-stu-id="1085a-201">Now re-enable pre-authentication in the portal and authenticate through Azure by attempting to connect to the application via it’s external URL.</span></span> <span data-ttu-id="1085a-202">Если произошел сбой единого входа, должно появиться сообщение о запрете доступа в браузере, а также событие 13022 в журнале:</span><span class="sxs-lookup"><span data-stu-id="1085a-202">If SSO has failed, then you should see a forbidden error message in the browser, plus event 13022 in the log:</span></span>

    <span data-ttu-id="1085a-203">*Соединителю прокси приложения Microsoft AAD не удается проверить подлинность пользователя, так как внутренний сервер отвечает на попытки проверки подлинности Kerberos ошибкой HTTP 401.*</span><span class="sxs-lookup"><span data-stu-id="1085a-203">*Microsoft AAD Application Proxy Connector cannot authenticate the user because the backend server responds to Kerberos authentication attempts with an HTTP 401 error.*</span></span>

    ![Ошибка запрета доступа 401 HTTTP](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   <span data-ttu-id="1085a-205">В приложении IIS убедитесь, что пул приложений настроен для использования той же учетной записи, для которой было задано имя субъекта-службы в AD. Для этого перейдите в IIS, как показано ниже:</span><span class="sxs-lookup"><span data-stu-id="1085a-205">Check the IIS application to ensure the configured application pool is configured to use the same account that the SPN has been configured against in AD, by navigating in IIS as illustrated below</span></span>

    ![Окно конфигурации приложения IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    <span data-ttu-id="1085a-207">Зная удостоверение, выполните приведенную ниже команду из командной строки, чтобы убедиться, что эта учетная запись действительно настроена с использованием соответствующего имени субъекта-службы.</span><span class="sxs-lookup"><span data-stu-id="1085a-207">Once you know the identity, issue the following from a cmd prompt to make sure this account is definitely configured with the SPN in question.</span></span> <span data-ttu-id="1085a-208">Например, **setspn – q http/spn.wacketywack.com**</span><span class="sxs-lookup"><span data-stu-id="1085a-208">For example,  **setspn – q http/spn.wacketywack.com**</span></span>

    ![Командное окно SetSPN](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   <span data-ttu-id="1085a-210">Убедитесь, что имя субъекта-службы, определенное в параметрах приложения на портале, совпадает с именем, настроенным для целевой учетной записи AD, которая используется в пуле приложений данного приложения.</span><span class="sxs-lookup"><span data-stu-id="1085a-210">Check that the SPN defined against the application’s settings in the portal is the same SPN that is configured against the target AD account in use by the application’s app pool</span></span>

   ![Настройка имени субъекта-службы на портале Azure](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   <span data-ttu-id="1085a-212">Перейдите в службы IIS и выберите для приложения параметр **Редактор конфигураций**, а затем перейдите в **system.webServer/security/authentication/windowsAuthentication** и убедитесь, что для **UseAppPoolCredentials** задано значение true.</span><span class="sxs-lookup"><span data-stu-id="1085a-212">Go into IIS and select the **Configuration Editor** option for the application, and navigate to **system.webServer/security/authentication/windowsAuthentication** to make sure that **UseAppPoolCredentials** is set to true</span></span>

   ![Параметр учетных данные для пулов приложений в конфигурации IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

<span data-ttu-id="1085a-214">Хотя это бывает полезно для повышения производительности операций Kerberos, при включенном режиме ядра расшифровка билета для запрашиваемой службы выполняется с помощью учетной записи компьютера.</span><span class="sxs-lookup"><span data-stu-id="1085a-214">While being useful in improving the performance of Kerberos operations, leaving Kernel mode enabled also causes the ticket for the requested service to be decrypted using machine account.</span></span> <span data-ttu-id="1085a-215">Это также называется локальной системой, поэтому установка значения true может нарушать работу ограниченного делегирования Kerberos, когда приложение размещается сразу на нескольких серверах фермы.</span><span class="sxs-lookup"><span data-stu-id="1085a-215">This is also called the Local system, so having this set to true break KCD when the application is hosted across multiple servers in a farm.</span></span>

-   <span data-ttu-id="1085a-216">В качестве дополнительной проверки вам также может потребоваться отключить **расширенную** защиту.</span><span class="sxs-lookup"><span data-stu-id="1085a-216">As an additional check, you may also want to disable the **Extended** protection too.</span></span> <span data-ttu-id="1085a-217">Были выявлены сценарии, где эта функция нарушала работу ограниченного делегирования Kerberos, когда приложение публиковалось в качестве вложенной папки веб-сайта по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="1085a-217">There have been encountered scenarios where this has proved to break KCD when enabled in very specific configurations, where an application is published as a sub folder of the Default Web site.</span></span> <span data-ttu-id="1085a-218">Она сама настроена только для анонимного доступа, в результате чего целые диалоговые окна выделяются серым, и можно сделать вывод, что дочерние объекты не наследуют никакие активные параметры.</span><span class="sxs-lookup"><span data-stu-id="1085a-218">This itself is configured for Anonymous authentication only, leaving the entire dialogs greyed out suggesting child objects would not be inheriting any active settings.</span></span> <span data-ttu-id="1085a-219">Однако мы рекомендуем всегда включать эту функцию, когда это возможно. Поэтому не забудьте сделать это после тестирования.</span><span class="sxs-lookup"><span data-stu-id="1085a-219">But where possible we would always recommend having this enabled, so by all means test, but don’t forget to restore this to enabled.</span></span>

<span data-ttu-id="1085a-220">После этих дополнительных проверок вы можете начинать работу с опубликованным приложением.</span><span class="sxs-lookup"><span data-stu-id="1085a-220">These additional checks should have put you on track to start using your published application.</span></span> <span data-ttu-id="1085a-221">Теперь можно добавить дополнительные соединители, также настроенные для делегирования. Если же устранить проблему не удалось, предлагаем обратиться к полному техническому [руководству по устранению неполадок в прокси приложения Azure AD](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="1085a-221">You can go ahead and spin up additional connectors that are also configured to delegate, but if things are no further then we would suggest a read of our more in-depth technical walkthrough [The complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span></span>

<span data-ttu-id="1085a-222">Если и после этого остаются неполадки, с которыми вам не удалось справиться, обратитесь в службу поддержки.</span><span class="sxs-lookup"><span data-stu-id="1085a-222">If you’re still unable to progress your issue, support would be more than happy to assist and continue from here.</span></span> <span data-ttu-id="1085a-223">Создайте запрос в службу поддержки прямо на портале, и наши инженеры свяжутся с вами.</span><span class="sxs-lookup"><span data-stu-id="1085a-223">Create a support ticket directly within the portal and our engineers will reach out to you.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="1085a-224">Другие сценарии</span><span class="sxs-lookup"><span data-stu-id="1085a-224">Other scenarios</span></span>

-   <span data-ttu-id="1085a-225">Прокси приложения Azure запрашивает билет Kerberos перед отправкой запроса к приложению.</span><span class="sxs-lookup"><span data-stu-id="1085a-225">Azure Application Proxy requests a Kerberos ticket before sending its request to an application.</span></span> <span data-ttu-id="1085a-226">Некоторые приложения сторонних разработчиков, например Tableau Server, не полностью поддерживают этот метод проверки подлинности, ожидая более традиционных согласований.</span><span class="sxs-lookup"><span data-stu-id="1085a-226">Some 3rd party applications such as Tableau Server do not like this method of authenticating, and rather expects the more conventional negotiations to take place,.</span></span> <span data-ttu-id="1085a-227">Первый запрос выполняется анонимно, позволяя приложению отправить ответ с поддерживаемыми типами проверки подлинности через 401.</span><span class="sxs-lookup"><span data-stu-id="1085a-227">The first request is anonymous, allowing the application to respond with the authentication types that it supports through a 401.</span></span>

-   <span data-ttu-id="1085a-228">Проверка подлинности с двумя прыжками — обычно используется в сценариях с многоуровневым приложением, где проверка подлинности требуется как для серверной, так и для интерфейсной части (например, SQL Reporting Services).</span><span class="sxs-lookup"><span data-stu-id="1085a-228">Double hop authentication - Commonly used in scenarios where an application is tiered, with a backend and front end, both requiring authentication, such as SQL Reporting Services.</span></span>

## <a name="next-steps"></a><span data-ttu-id="1085a-229">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="1085a-229">Next steps</span></span>
[<span data-ttu-id="1085a-230">Настройка ограниченного делегирования Kerberos в управляемом домене</span><span class="sxs-lookup"><span data-stu-id="1085a-230">Configure kerberos constrained delegation (KCD) on a managed domain</span></span>](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)

---
title: "aaaHow tooconfigure toouse приложения прокси приложения ограниченное делегирование Kerberos | Документы Microsoft"
description: "Как tooconfigure ограниченное делегирование Kerberos для приложения прокси приложения Azure AD."
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 93dac264ff1d3b99dead1d9c759c37c59373cbd4
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="how-tooconfigure-an-application-proxy-application-toouse-kerberos-constrained-delegation"></a><span data-ttu-id="3aa03-103">Как tooconfigure toouse приложения прокси приложения ограниченное делегирование Kerberos</span><span class="sxs-lookup"><span data-stu-id="3aa03-103">How tooconfigure an Application Proxy application toouse Kerberos Constrained Delegation</span></span>

<span data-ttu-id="3aa03-104">Hello методы, доступные для реализации единого входа toopublished приложений может немного отличаться из tooapplication приложения и один из параметров hello, что прокси приложения Azure предлагает справа стандартной hello — ограниченное делегирование Kerberos (KCD).</span><span class="sxs-lookup"><span data-stu-id="3aa03-104">hello methods available for achieving SSO toopublished applications can somewhat vary from application tooapplication and one of hello options that Azure Application Proxy offers right out of hello box, is Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="3aa03-105">Именно здесь узел соединителя находится настроенный tooperform ограниченное kerberos проверки подлинности toobackend приложений, от имени пользователей.</span><span class="sxs-lookup"><span data-stu-id="3aa03-105">This is where a connector host is configured tooperform constrained kerberos authentication toobackend applications, on behalf of users.</span></span>

<span data-ttu-id="3aa03-106">Hello фактическое процедура включения проверки подлинности Kerberos выполняется относительно просто и обычно требует не более чем общее представление о hello, различные компоненты и поток проверки подлинности, который упрощает единого входа.</span><span class="sxs-lookup"><span data-stu-id="3aa03-106">hello actual procedure for enabling KCD is relatively straightforward and typically requires no more than a general understanding of hello various components and authentication flow that facilitates SSO.</span></span> <span data-ttu-id="3aa03-107">Поиск полезные источники информации toohelp устранения неполадок, связанных сценариев, где единого входа для проверки подлинности Kerberos не работает должным образом, могут быть разреженными.</span><span class="sxs-lookup"><span data-stu-id="3aa03-107">Finding good sources of information toohelp troubleshoot scenarios where KCD SSO doesn’t function as expected, can be sparse.</span></span>

<span data-ttu-id="3aa03-108">Таким образом в этой статье попыток tooprovide точки ссылки, должны помочь при устранении и самостоятельно устранять некоторые hello наиболее распространенных проблем, которые мы видим.</span><span class="sxs-lookup"><span data-stu-id="3aa03-108">As such, this article attempts tooprovide a single point of reference that should help troubleshoot and self-remediate some of hello most common issues that we see.</span></span> <span data-ttu-id="3aa03-109">В hello же время предложение получения дополнительных рекомендаций по диагностике hello сложнее и проблемной реализации.</span><span class="sxs-lookup"><span data-stu-id="3aa03-109">At hello same time offer additional guidance for diagnosing hello more complex and troubled of implementation.</span></span>

<span data-ttu-id="3aa03-110">Обратите внимание, что в данной статье выполняет hello следующие допущения:</span><span class="sxs-lookup"><span data-stu-id="3aa03-110">note that this article makes hello following assumptions:</span></span>

-   <span data-ttu-id="3aa03-111">Прокси приложения Azure был развернут согласно нашей [документации](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) и общего доступа toonon KCD приложений работает надлежащим образом.</span><span class="sxs-lookup"><span data-stu-id="3aa03-111">Azure Application Proxy has been deployed as per our [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) and general access toonon KCD applications is working as expected.</span></span>

-   <span data-ttu-id="3aa03-112">Hello опубликованных целевого приложения основан на IIS и Майкрософт для реализации kerberos.</span><span class="sxs-lookup"><span data-stu-id="3aa03-112">hello published target application is based on IIS and Microsoft’s implementation of kerberos.</span></span>

-   <span data-ttu-id="3aa03-113">узлы сервера и приложения Hello находятся в одном домене Active Directory.</span><span class="sxs-lookup"><span data-stu-id="3aa03-113">hello server and application hosts reside in a single Active Directory domain.</span></span> <span data-ttu-id="3aa03-114">Подробные сведения о междоменных и межлесных сценариях см. в нашем [техническом документе об ограниченном делегировании Kerberos](http://aka.ms/KCDPaper).</span><span class="sxs-lookup"><span data-stu-id="3aa03-114">Detailed information on cross domain and forest scenarios can be found in our [KCD whitepaper](http://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="3aa03-115">Hello субъекта публикации приложения в Azure клиента с помощью предварительной проверки подлинности включена, а пользователи должны tooAzure tooauthenticate через формы проверки подлинности на основе.</span><span class="sxs-lookup"><span data-stu-id="3aa03-115">hello subject application is published in an Azure tenant with pre-authentication enabled, and users are expected tooauthenticate tooAzure via forms based authentication.</span></span> <span data-ttu-id="3aa03-116">Сценарии проверки подлинности клиента Rich не представленных в этой статье, но добавлены в определенный момент в будущем hello.</span><span class="sxs-lookup"><span data-stu-id="3aa03-116">Rich client authentication scenarios are not covered by this article, but be added at some point in hello future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="3aa03-117">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="3aa03-117">Prerequisites</span></span>

<span data-ttu-id="3aa03-118">Прокси приложения Azure могут развертываться в практически любой тип инфраструктуры или архитектуры среды и hello без сомнения различаться в зависимости от tooorganization организации.</span><span class="sxs-lookup"><span data-stu-id="3aa03-118">Azure Application Proxy can be deployed into pretty much any type of infrastructure or environment and hello architectures no doubt vary from organization tooorganization.</span></span> <span data-ttu-id="3aa03-119">Одна из наиболее распространенных причин hello ограниченное делегирование Kerberos, касающиеся проблемы не hello сред, но довольно простой неверной конфигурации или общие контроля.</span><span class="sxs-lookup"><span data-stu-id="3aa03-119">One of hello most common causes of KCD related issues are not hello environments themselves, but rather simple mis-configurations, or general oversight.</span></span>

<span data-ttu-id="3aa03-120">По этой причине пользователям рекомендуется всегда toostart, убедившись, что выполнены все необходимые компоненты hello располагаются в нашем main [с помощью единого входа проверки подлинности Kerberos со статьей прокси приложения hello](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) до запуска Устранение неполадок.</span><span class="sxs-lookup"><span data-stu-id="3aa03-120">For this reason, our advice is always toostart by making sure you have met all hello pre-requisites laid out in our main [Using KCD SSO with hello Application Proxy article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) before starting troubleshooting.</span></span>

<span data-ttu-id="3aa03-121">Особенно hello раздел о настройке проверки подлинности Kerberos в 2012 R2, как в нем используется tooconfiguring существенно различается способ проверки подлинности Kerberos в предыдущих версиях Windows, но не учитывать несколько факторов:</span><span class="sxs-lookup"><span data-stu-id="3aa03-121">Particularly hello section on configuring KCD on 2012R2, as this employs a fundamentally different approach tooconfiguring KCD on previous versions of Windows, but also while being mindful of several other considerations:</span></span>

-   <span data-ttu-id="3aa03-122">Довольно часто для tooopen сервер члена домена диалоговое окно безопасный канал с определенным контроллером домена.</span><span class="sxs-lookup"><span data-stu-id="3aa03-122">It is not uncommon for a domain member server tooopen a secure channel dialog with a specific domain controller.</span></span> <span data-ttu-id="3aa03-123">Переместите tooanother диалогового окна в любой момент времени, поэтому соединитель узлы обычно не должно быть ограниченным toobeing может toocommunicate с контроллерами домена только определенным локального сайта.</span><span class="sxs-lookup"><span data-stu-id="3aa03-123">Then move tooanother dialog at any given time, so connector hosts should generally not be restricted toobeing able toocommunicate with only specific local site DCs.</span></span>

-   <span data-ttu-id="3aa03-124">Аналогичные toohello выше точки междоменные сценарии используют ссылок, которые будут направлять tooDCs узла соединителя, находящиеся за пределами локальной сети периметра hello.</span><span class="sxs-lookup"><span data-stu-id="3aa03-124">Similar toohello above point, cross domain scenarios rely on referrals that direct a connector host tooDCs that may reside outside of hello local network perimeter.</span></span> <span data-ttu-id="3aa03-125">В этом сценарии, он не столь же важно toomake в том, что также позволяет пользователям начиная трафика tooDCs, представляющие других соответствующих доменах, в противном случае делегирование ошибкой.</span><span class="sxs-lookup"><span data-stu-id="3aa03-125">In this scenario it is equally important toomake sure you are also allowing traffic onwards tooDCs that represent other respective domains, or else delegation fail.</span></span>

-   <span data-ttu-id="3aa03-126">По возможности не следует располагать активные устройства IPS/IDS между узлами соединителя и контроллерами домена, так как иногда это нарушает правильную работу и мешает прохождению основного трафика RPC.</span><span class="sxs-lookup"><span data-stu-id="3aa03-126">Where possible, you should avoid placing any active IPS/IDS devices between connector hosts and DCs, as these are sometimes over intrusive and interfere with core RPC traffic</span></span>

<span data-ttu-id="3aa03-127">Столько, мы хотели бы tooresolve проблемы быстро и эффективно, может потребоваться время, таким образом по возможности следует повторите и проверить делегирование в hello простой сценариев.</span><span class="sxs-lookup"><span data-stu-id="3aa03-127">As much as we’d like tooresolve issues quickly and effectively, it can take time, so where possible you should try and test delegation in hello simplest of scenarios.</span></span> <span data-ttu-id="3aa03-128">Здравствуйте, несколько переменных, которые вы вводите, hello более имеется toocontend с.</span><span class="sxs-lookup"><span data-stu-id="3aa03-128">hello more variables you introduce, hello more you may have toocontend with.</span></span> <span data-ttu-id="3aa03-129">Например ограничение тестирования один соединитель tooa экономить ценное рабочее время и дополнительные соединители можно добавлять после устранения проблемы hello.</span><span class="sxs-lookup"><span data-stu-id="3aa03-129">For example, limiting your testing tooa single connector can save valuable time, and additional connectors can be added after hello issues has been resolved.</span></span>

<span data-ttu-id="3aa03-130">Некоторые факторы среды могут также вызывать проблемы tooan и опять же если возможно, что свести к минимуму hello архитектура tooa минимальный набор для тестирования.</span><span class="sxs-lookup"><span data-stu-id="3aa03-130">Some environmental factors may also be contributing tooan issue, so again if possible try and minimize hello architecture tooa bare minimum for testing.</span></span> <span data-ttu-id="3aa03-131">Например, имеет неправильный формат внутренним брандмауэром ACL не являются редкими, поэтому желательно по возможности имеют весь трафик от соединителя, допускается прямо через toohello контроллеров домена и серверной части приложения.</span><span class="sxs-lookup"><span data-stu-id="3aa03-131">For example, misconfigured internal firewall ACLs are not uncommon, so if possible have all traffic from a connector allowed straight through toohello DCs and backend application.</span></span> 

<span data-ttu-id="3aa03-132">Фактически hello абсолютный наиболее месте tooposition соединители — как целевые объекты tootheir как может быть.</span><span class="sxs-lookup"><span data-stu-id="3aa03-132">Actually hello absolute best place tooposition connectors is as close tootheir targets as can be.</span></span> <span data-ttu-id="3aa03-133">Использование встроенного брандмауэра при тестировании лишь чрезмерно усложняет процесс и может приводить к затягиванию работы.</span><span class="sxs-lookup"><span data-stu-id="3aa03-133">Having a firewall sat inline whilst testing simply adds unnecessary complexity, and could just prolong your investigations.</span></span>

<span data-ttu-id="3aa03-134">Так в чем именно состоит проблема ограниченного делегирования Kerberos?</span><span class="sxs-lookup"><span data-stu-id="3aa03-134">So, what constitutes a KCD problem anyway?</span></span> <span data-ttu-id="3aa03-135">Также существует несколько указывают на классический единого входа проверки подлинности Kerberos, сбои и hello первый признаков проблемы обычно ведут себя в hello браузера.</span><span class="sxs-lookup"><span data-stu-id="3aa03-135">Well, there several classic indications of KCD SSO failing and hello first signs of an issue usually manifest themselves in hello browser.</span></span>

   ![Ошибка из-за неправильной конфигурации ограниченного делегирования Kerberos](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![Авторизация не выполнена из-за toomissing разрешения](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="3aa03-138">все, которые содержат hello же признаком сбоя tooperform единого входа и поэтому запрет hello приложение toohello доступа пользователя.</span><span class="sxs-lookup"><span data-stu-id="3aa03-138">all which bear hello same symptom of failing tooperform SSO, and consequently denying hello user access toohello application.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="3aa03-139">Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="3aa03-139">Troubleshooting</span></span>

<span data-ttu-id="3aa03-140">Как вы устраните зависят проблема hello и наблюдается проблема.</span><span class="sxs-lookup"><span data-stu-id="3aa03-140">How you then troubleshoot depend on hello issue and observed symptoms.</span></span> <span data-ttu-id="3aa03-141">Прежде чем идти дальнейшей бы рекомендуется hello ссылкам, как они содержат полезные сведения, которые вы не еще получен через:</span><span class="sxs-lookup"><span data-stu-id="3aa03-141">Before going any further we would suggest hello following links, as they contain useful information you may not yet have come across:</span></span>

-   [<span data-ttu-id="3aa03-142">Устранение неполадок и сообщения об ошибках прокси приложения</span><span class="sxs-lookup"><span data-stu-id="3aa03-142">Troubleshoot Application Proxy problems and error messages</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [<span data-ttu-id="3aa03-143">Ошибки и симптомы Kerberos</span><span class="sxs-lookup"><span data-stu-id="3aa03-143">Kerberos errors and symptoms</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [<span data-ttu-id="3aa03-144">Работа с единым входом при несовпадении локальных и облачных удостоверений</span><span class="sxs-lookup"><span data-stu-id="3aa03-144">Working with SSO when on-premises and cloud identities are not identical</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

<span data-ttu-id="3aa03-145">Если у вас есть это расстояние, а затем hello основной проблема определенно существует.</span><span class="sxs-lookup"><span data-stu-id="3aa03-145">If you’ve got this far, then hello main issue definitely exists.</span></span> <span data-ttu-id="3aa03-146">Требуется toodig глубже, запустите, разделяя hello потока в трех различных этапов, вы можете устранить.</span><span class="sxs-lookup"><span data-stu-id="3aa03-146">You need toodig deeper, so start by separating hello flow into three distinct stages that you can troubleshoot.</span></span>

<span data-ttu-id="3aa03-147">**Предварительная проверка подлинности клиента** -hello внешнего пользователя, проверки подлинности tooAzure через браузер.</span><span class="sxs-lookup"><span data-stu-id="3aa03-147">**Client pre-authentication** - hello external user authenticating tooAzure via a browser.</span></span>

<span data-ttu-id="3aa03-148">Выполняется доступ toopre-проверки подлинности tooAzure при toofunction единого входа для проверки подлинности Kerberos.</span><span class="sxs-lookup"><span data-stu-id="3aa03-148">Being able toopre-authenticate tooAzure is imperative for KCD SSO toofunction.</span></span> <span data-ttu-id="3aa03-149">При возникновении проблем этот аспект нужно проверить первым.</span><span class="sxs-lookup"><span data-stu-id="3aa03-149">This should be tested and addressed first, if there are any issues.</span></span> <span data-ttu-id="3aa03-150">Обратите внимание, что Этап предварительной проверки подлинности hello не tooKCD отношения или hello опубликованное приложение.</span><span class="sxs-lookup"><span data-stu-id="3aa03-150">Note that hello pre-authentication stage has no relation tooKCD or hello published application.</span></span> <span data-ttu-id="3aa03-151">Должно быть довольно просто toocorrect несоответствий, по злому проверка учетной записи субъекта hello в Azure существует и что он не отключено или заблокирован.</span><span class="sxs-lookup"><span data-stu-id="3aa03-151">It should be fairly easy toocorrect any discrepancies by sanity checking hello subject account exists in Azure, and that it is not disabled/blocked.</span></span> <span data-ttu-id="3aa03-152">Отклик Hello в браузере hello является причиной обычно достаточно информативным toounderstand hello.</span><span class="sxs-lookup"><span data-stu-id="3aa03-152">hello error response in hello browser is usually descriptive enough toounderstand hello cause.</span></span> <span data-ttu-id="3aa03-153">Если вы не уверены, можно также проверить наши tooverify docs Устранение неполадок.</span><span class="sxs-lookup"><span data-stu-id="3aa03-153">You can also check our other Troubleshoot docs tooverify if you aren’t sure.</span></span>

<span data-ttu-id="3aa03-154">**Делегирование службы** -hello получения билета службы kerberos KDC (центр распространения Kerberos), соединитель прокси-сервера Azure от лица пользователей.</span><span class="sxs-lookup"><span data-stu-id="3aa03-154">**Delegation service** - hello Azure Proxy connector obtaining a kerberos service ticket from a KDC (Kerberos Distribution Center), on behalf of users.</span></span>

<span data-ttu-id="3aa03-155">Hello внешнего обмена данными между клиентом hello и hello Azure внешнего интерфейса следует никак не влияют на ограниченное делегирование Kerberos ни при каких обстоятельствах, отличный от обеспечение его работы.</span><span class="sxs-lookup"><span data-stu-id="3aa03-155">hello external communications between hello client and hello Azure front end should have no bearing on KCD whatsoever, other than ensuring that it works.</span></span> <span data-ttu-id="3aa03-156">Это hello Azure прокси-службы может быть предоставленный идентификатор пользователя недопустим, быть используется tooobtain билет kerberos.</span><span class="sxs-lookup"><span data-stu-id="3aa03-156">This is so hello Azure Proxy service can be provided with a valid user ID that be used tooobtain a kerberos ticket.</span></span> <span data-ttu-id="3aa03-157">Без этого ограниченное делегирование Kerberos невозможно и приведет к сбою.</span><span class="sxs-lookup"><span data-stu-id="3aa03-157">Without this KCD is not possible and would fail.</span></span>

<span data-ttu-id="3aa03-158">Как упоминалось ранее, сообщения об ошибках обозревателя hello обычно обеспечивают некоторые хорошо выявить причину ошибки при выполнении действия.</span><span class="sxs-lookup"><span data-stu-id="3aa03-158">As mentioned previously, hello browser error messages usually provide some good clues on why things are failing.</span></span> <span data-ttu-id="3aa03-159">Убедитесь что toonote вниз hello идентификатор действия и отметку времени в ответ hello, поскольку это позволяет toocorrelate hello поведение tooactual события в журнал событий прокси-сервера Azure hello.</span><span class="sxs-lookup"><span data-stu-id="3aa03-159">Make sure toonote down hello activity ID and timestamp in hello response as this allow you toocorrelate hello behavior tooactual events in hello Azure Proxy event log.</span></span>

   ![Ошибка из-за неправильной конфигурации ограниченного делегирования Kerberos](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="3aa03-161">И hello соответствующие записи журнала событий для замеченный hello будет рассматривать как события 13019 или 12027.</span><span class="sxs-lookup"><span data-stu-id="3aa03-161">And hello corresponding entries seen hello event log would be seen as events 13019 or 12027.</span></span> <span data-ttu-id="3aa03-162">Найти hello соединителя журналы событий в **журналы приложений и служб** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Соединитель**&gt;**администратора**.</span><span class="sxs-lookup"><span data-stu-id="3aa03-162">You can find hello connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span></span>

   ![Событие 13019 из журнала событий прокси приложения](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![Событие 12027 из журнала событий прокси приложения](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   <span data-ttu-id="3aa03-165">Использовать записи в внутренние DNS-сервера для адреса приложения hello, а не запись CName</span><span class="sxs-lookup"><span data-stu-id="3aa03-165">Use an A record in your internal DNS for hello application’s address, and not a CName</span></span>

-   <span data-ttu-id="3aa03-166">Повторно подтвердить, на которых размещены hello соединителя была предоставлена hello права toodelegate toohello назначенному целевую учетную запись имени участника-службы и что **использовать любой протокол проверки подлинности** выбран.</span><span class="sxs-lookup"><span data-stu-id="3aa03-166">Re-confirm that hello connector host has been granted hello rights toodelegate toohello designated target account’s SPN, and that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="3aa03-167">Подробнее это рассмотрено в основной [статье о конфигурации единого входа](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd).</span><span class="sxs-lookup"><span data-stu-id="3aa03-167">This is covered in our main [SSO configuration article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span></span>

-   <span data-ttu-id="3aa03-168">Проверьте, что используется только один экземпляр hello имени участника-службы, существующее в AD, выполнив **setspn - x** из командную строку на любом узле член домена</span><span class="sxs-lookup"><span data-stu-id="3aa03-168">Verify that there is only a single instance of hello SPN in existence in AD by issuing a **setspn -x** from a cmd prompt on any domain member host</span></span>

-   <span data-ttu-id="3aa03-169">Проверьте toosee, если политика домена выполняется принудительно toolimit hello [максимальный размер маркеров kerberos выданного](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), как этот соединитель hello запретить получение токена, если найден toobe чрезмерного</span><span class="sxs-lookup"><span data-stu-id="3aa03-169">Check toosee if a domain policy is being enforced toolimit hello [max size of issued kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), as this prevent hello connector from obtaining a token if found toobe excessive</span></span>

<span data-ttu-id="3aa03-170">Захват hello обмена между hello соединителя узла и домена KDC трассировку в сети, будут hello наиболее Далее для получения более низкого уровня подробно описывается hello проблемы.</span><span class="sxs-lookup"><span data-stu-id="3aa03-170">A network trace capturing hello exchanges between hello connector host and a domain KDC would then be hello next best step in obtaining more low level detail on hello issues.</span></span> <span data-ttu-id="3aa03-171">Соответствующие сведения приведены в [подробном официальном документе по устранению неполадок](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="3aa03-171">You can find this in [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="3aa03-172">Если бронирование хорошее, вы увидите события в журналах hello, о том, что проверка подлинности сбоем из-за toohello приложением, которое возвращает 401.</span><span class="sxs-lookup"><span data-stu-id="3aa03-172">If ticketing looks good, you should see an event in hello logs stating that authentication failed due toohello application returning a 401.</span></span> <span data-ttu-id="3aa03-173">Это обычно указывает на это целевое приложение hello отклоняет запрос, поэтому действуйте с hello, выполнив следующий этап.</span><span class="sxs-lookup"><span data-stu-id="3aa03-173">This typically indicates that hello target application rejecting your ticket, so proceed with hello following next stage.</span></span>

<span data-ttu-id="3aa03-174">**Идентификатор целевого приложения** -потребитель hello hello билета kerberos, предоставляемые hello соединителя</span><span class="sxs-lookup"><span data-stu-id="3aa03-174">**Target application** - hello consumer of hello kerberos ticket provided by hello connector</span></span>

<span data-ttu-id="3aa03-175">На этот этап hello соединитель ожидаемым toohave отправляется основы toohello билет службы kerberos, как заголовок в первом запросе приложения hello.</span><span class="sxs-lookup"><span data-stu-id="3aa03-175">At this stage hello connector is expected toohave sent a kerberos service ticket toohello backend, as a header within hello first application request.</span></span>

-   <span data-ttu-id="3aa03-176">С помощью приложения hello внутреннего URL-адреса, определенные в портал hello проверку приложения hello доступным напрямую из браузера hello на узел соединителя hello.</span><span class="sxs-lookup"><span data-stu-id="3aa03-176">Using hello application’s internal URL defined in hello portal, validate that hello application is accessible directly from hello browser on hello connector host.</span></span> <span data-ttu-id="3aa03-177">После этого можно выполнить вход.</span><span class="sxs-lookup"><span data-stu-id="3aa03-177">Then you can login successfully.</span></span> <span data-ttu-id="3aa03-178">Подробные сведения об этом можно найти на странице Устранение неполадок соединителя hello.</span><span class="sxs-lookup"><span data-stu-id="3aa03-178">Details on doing this can be found on hello connector Troubleshoot page.</span></span>

-   <span data-ttu-id="3aa03-179">По-прежнему на узел соединителя hello, убедитесь, что проверка подлинности hello между браузера hello и приложения hello использует протокол kerberos, выполнив одно из следующих hello:</span><span class="sxs-lookup"><span data-stu-id="3aa03-179">Still on hello connector host, confirm that hello authentication between hello browser and hello application is using kerberos, by doing one of hello following:</span></span>

1.  <span data-ttu-id="3aa03-180">Запуск средств разработки (**F12**) в Internet Explorer или использовать [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) с hello соединителя узла.</span><span class="sxs-lookup"><span data-stu-id="3aa03-180">Run Dev tools(**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from hello connector host.</span></span> <span data-ttu-id="3aa03-181">Go toohello приложения, использующего hello внутренний URL-адрес и проверять hello предлагаемых заголовки authorization WWW, возвращенный в ответе hello из приложения hello, присутствует tooensure, либо negotiate или kerberos.</span><span class="sxs-lookup"><span data-stu-id="3aa03-181">Go toohello application using hello internal URL, and inspect hello offered WWW authorization headers returned in hello response from hello application, tooensure that either negotiate or kerberos is present.</span></span> <span data-ttu-id="3aa03-182">В последующих kerberos большой двоичный объект, возвращенный в ответе hello из браузера toohello hello приложения обычно начинаются с **YII**, поэтому это полное представление о kerberos в Google play.</span><span class="sxs-lookup"><span data-stu-id="3aa03-182">A subsequent kerberos blob returned in hello response from hello browser toohello application typically start with **YII**, so this is a good indication of kerberos being in play.</span></span> <span data-ttu-id="3aa03-183">NTLM на hello другой стороны всегда начинаются с **TlRMTVNTUAAB**, который читает NTLMSSP при декодирование из Base64.</span><span class="sxs-lookup"><span data-stu-id="3aa03-183">NTLM on hello other hand always start with **TlRMTVNTUAAB**, which reads NTLMSSP when decoded from Base64.</span></span> <span data-ttu-id="3aa03-184">Если вы видите **TlRMTVNTUAAB** во время запуска hello hello большого двоичного объекта, это означает, что Kerberos **не** доступны.</span><span class="sxs-lookup"><span data-stu-id="3aa03-184">If you see **TlRMTVNTUAAB** at hello start of hello blob, this means that Kerberos is **not** available.</span></span> <span data-ttu-id="3aa03-185">В противном случае он, вероятнее всего, доступен.</span><span class="sxs-lookup"><span data-stu-id="3aa03-185">If you don’t see this, Kerberos is likely available.</span></span>

  * <span data-ttu-id="3aa03-186">Обратите внимание, если с помощью Fiddler, этот метод потребует временно отключить расширенную защиту в конфигурации приложения hello в службах IIS.</span><span class="sxs-lookup"><span data-stu-id="3aa03-186">Note, if using Fiddler, this method would require temporarily disabling extended protection on hello application’s config in IIS.</span></span>

     ![Окно проверки сети в браузере](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    <span data-ttu-id="3aa03-188">*Рисунок.* Так как в начале стоит не TIRMTVNTUAAB, значит протокол Kerberos доступен.</span><span class="sxs-lookup"><span data-stu-id="3aa03-188">*Figure:* Since this does not start with TIRMTVNTUAAB, this is an example that Kerberos is available.</span></span> <span data-ttu-id="3aa03-189">Это пример BLOB-объекта Kerberos, который начинается не с YII.</span><span class="sxs-lookup"><span data-stu-id="3aa03-189">This is an example of a Kerberos Blob that doesn’t start with YII.</span></span>

2.  <span data-ttu-id="3aa03-190">Временно удалите NTLM из списка поставщиков hello для сайта и доступ приложения IIS непосредственно из IE на узле соединителя.</span><span class="sxs-lookup"><span data-stu-id="3aa03-190">Temporarily remove NTLM from hello providers list on IIS site and access app directly from IE on connector host.</span></span> <span data-ttu-id="3aa03-191">При использовании NTLM больше не в список поставщиков hello должно быть приложения hello может tooaccess только с помощью Kerberos.</span><span class="sxs-lookup"><span data-stu-id="3aa03-191">With NTLM no longer in hello providers list, you should be able tooaccess hello application using Kerberos only.</span></span> <span data-ttu-id="3aa03-192">Если это не удается, затем, предполагает, что имеется проблема с конфигурацией приложения hello и проверка подлинности Kerberos не работает.</span><span class="sxs-lookup"><span data-stu-id="3aa03-192">If this fails, then that suggests that there is a problem with hello application’s configuration and Kerberos authentication is not functioning.</span></span>

<span data-ttu-id="3aa03-193">Если проверка Kerberos недоступна, приложения hello флажок проверки подлинности, согласовывать параметры в IIS toomake убедиться, что отображается переднего плана с использованием протокола NTLM непосредственно под ним.</span><span class="sxs-lookup"><span data-stu-id="3aa03-193">If Kerberos is not available, then check hello application’s authentication settings in IIS toomake sure negotiate is listed topmost, with NTLM just beneath it.</span></span> <span data-ttu-id="3aa03-194">(не Negotiate:kerberos или Negotiate:PKU2U).</span><span class="sxs-lookup"><span data-stu-id="3aa03-194">(Not Negotiate:kerberos or Negotiate:PKU2U).</span></span> <span data-ttu-id="3aa03-195">Продолжайте работу, только если Kerberos работает.</span><span class="sxs-lookup"><span data-stu-id="3aa03-195">Only continue if Kerberos is functional.</span></span>

   ![Поставщики проверки подлинности Windows](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   <span data-ttu-id="3aa03-197">Kerberos и NTLM в месте позволяет теперь временно отключить предварительную проверку подлинности для приложения hello hello портала.</span><span class="sxs-lookup"><span data-stu-id="3aa03-197">With Kerberos and NTLM in place, lets now temporarily disable pre-authentication for hello application in hello portal.</span></span> <span data-ttu-id="3aa03-198">Если доступен из hello в разделе Интернет с помощью hello внешний URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="3aa03-198">See if you can access it from hello internet using hello external URL.</span></span> <span data-ttu-id="3aa03-199">Должен быть запросом tooauthenticate и должно быть возможности toodo, чтобы с hello учетную запись hello используется в предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="3aa03-199">You should be prompted tooauthenticate and should be able toodo so with hello same account used in hello previous step.</span></span> <span data-ttu-id="3aa03-200">Если нет, это указывает на проблему с внутреннее приложение hello и ограниченное делегирование Kerberos не вообще.</span><span class="sxs-lookup"><span data-stu-id="3aa03-200">If not, this indicates a problem with hello backend application and not KCD at all.</span></span>

-   <span data-ttu-id="3aa03-201">Теперь снова включить предварительную проверку подлинности на портале hello и проверки подлинности с помощью Azure, попробуйте tooconnect toohello приложения с помощью внешних URL.</span><span class="sxs-lookup"><span data-stu-id="3aa03-201">Now re-enable pre-authentication in hello portal and authenticate through Azure by attempting tooconnect toohello application via it’s external URL.</span></span> <span data-ttu-id="3aa03-202">Если произошел сбой единого входа, вы увидите запрещенных сообщение hello браузера, а также событие 13022 hello журнала:</span><span class="sxs-lookup"><span data-stu-id="3aa03-202">If SSO has failed, then you should see a forbidden error message in hello browser, plus event 13022 in hello log:</span></span>

    <span data-ttu-id="3aa03-203">*Microsoft AAD Application Proxy Connector не удается проверить подлинность пользователя hello, поскольку hello внутренний сервер отвечает tooKerberos попыток проверки подлинности с ошибкой HTTP 401.*</span><span class="sxs-lookup"><span data-stu-id="3aa03-203">*Microsoft AAD Application Proxy Connector cannot authenticate hello user because hello backend server responds tooKerberos authentication attempts with an HTTP 401 error.*</span></span>

    ![Ошибка запрета доступа 401 HTTTP](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   <span data-ttu-id="3aa03-205">Проверьте настроенные toouse приветствия одной учетной записи hello имени участника-службы настроен для в AD, перейдя в службах IIS, как показано ниже пул приложений настроен hello tooensure приложения hello IIS</span><span class="sxs-lookup"><span data-stu-id="3aa03-205">Check hello IIS application tooensure hello configured application pool is configured toouse hello same account that hello SPN has been configured against in AD, by navigating in IIS as illustrated below</span></span>

    ![Окно конфигурации приложения IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    <span data-ttu-id="3aa03-207">После известно удостоверение hello, выполните следующую команду hello cmd prompt toomake том, что эта учетная запись определенно с hello рассматриваемой имени участника-службы.</span><span class="sxs-lookup"><span data-stu-id="3aa03-207">Once you know hello identity, issue hello following from a cmd prompt toomake sure this account is definitely configured with hello SPN in question.</span></span> <span data-ttu-id="3aa03-208">Например, **setspn – q http/spn.wacketywack.com**</span><span class="sxs-lookup"><span data-stu-id="3aa03-208">For example,  **setspn – q http/spn.wacketywack.com**</span></span>

    ![Командное окно SetSPN](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   <span data-ttu-id="3aa03-210">Проверьте, hello, имя участника-службы, определенных для приложения hello параметры на портале hello hello тоже имя SPN, настроенных для учетной записи целевой AD hello используется пул приложений приложения hello</span><span class="sxs-lookup"><span data-stu-id="3aa03-210">Check that hello SPN defined against hello application’s settings in hello portal is hello same SPN that is configured against hello target AD account in use by hello application’s app pool</span></span>

   ![Настройка имени субъекта-службы на портале Azure](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   <span data-ttu-id="3aa03-212">Перейдите в IIS и выберите hello **редактор конфигурации** для приложения hello, а затем перейдите слишком**system.webServer/security/authentication/windowsAuthentication** toomake убедиться, что этот **UseAppPoolCredentials** задано tootrue</span><span class="sxs-lookup"><span data-stu-id="3aa03-212">Go into IIS and select hello **Configuration Editor** option for hello application, and navigate too**system.webServer/security/authentication/windowsAuthentication** toomake sure that **UseAppPoolCredentials** is set tootrue</span></span>

   ![Параметр учетных данные для пулов приложений в конфигурации IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

<span data-ttu-id="3aa03-214">При, полезны для повышения производительности hello операций Kerberos, также оставить включенным режимом ядра приводит hello билет для hello запрошенный toobe службы расшифровать с помощью учетной записи компьютера.</span><span class="sxs-lookup"><span data-stu-id="3aa03-214">While being useful in improving hello performance of Kerberos operations, leaving Kernel mode enabled also causes hello ticket for hello requested service toobe decrypted using machine account.</span></span> <span data-ttu-id="3aa03-215">Это также называется hello локальной системы, так что наличие этого набора tootrue разрыв ограниченное делегирование Kerberos, когда приложение hello размещается на нескольких серверах в ферме.</span><span class="sxs-lookup"><span data-stu-id="3aa03-215">This is also called hello Local system, so having this set tootrue break KCD when hello application is hosted across multiple servers in a farm.</span></span>

-   <span data-ttu-id="3aa03-216">Как дополнительную проверку, может также потребоваться toodisable hello **расширенного** защиты слишком.</span><span class="sxs-lookup"><span data-stu-id="3aa03-216">As an additional check, you may also want toodisable hello **Extended** protection too.</span></span> <span data-ttu-id="3aa03-217">Были обнаружены сценариях, где это доказал toobreak ограниченное делегирование Kerberos, при включении в определенных конфигурациях, где приложение публикуется как вложенной папкой hello по умолчанию веб-сайта.</span><span class="sxs-lookup"><span data-stu-id="3aa03-217">There have been encountered scenarios where this has proved toobreak KCD when enabled in very specific configurations, where an application is published as a sub folder of hello Default Web site.</span></span> <span data-ttu-id="3aa03-218">Это сам настраивается для анонимной проверки подлинности, только если оставить все диалоговые окна hello серым цветом, что означает, что дочерние объекты бы не наследования параметров active.</span><span class="sxs-lookup"><span data-stu-id="3aa03-218">This itself is configured for Anonymous authentication only, leaving hello entire dialogs greyed out suggesting child objects would not be inheriting any active settings.</span></span> <span data-ttu-id="3aa03-219">Но, возможно, будет всегда рекомендуется использовать эта возможность включена, поэтому все далеко тестирования, когда не забывайте toorestore этот tooenabled.</span><span class="sxs-lookup"><span data-stu-id="3aa03-219">But where possible we would always recommend having this enabled, so by all means test, but don’t forget toorestore this tooenabled.</span></span>

<span data-ttu-id="3aa03-220">Они должны ставить вас toostart отслеживания с помощью опубликованного приложения.</span><span class="sxs-lookup"><span data-stu-id="3aa03-220">These additional checks should have put you on track toostart using your published application.</span></span> <span data-ttu-id="3aa03-221">Начинайте и раскрутки дополнительных соединителей, которые также являются toodelegate, но если обстоятельства более нет бы рекомендуется выполнить чтение нашей более подробные технические пошагового руководства [hello полное руководство по для приложения AD Azure, устранение неполадок Прокси-сервера](https://aka.ms/proxytshootpaper)</span><span class="sxs-lookup"><span data-stu-id="3aa03-221">You can go ahead and spin up additional connectors that are also configured toodelegate, but if things are no further then we would suggest a read of our more in-depth technical walkthrough [hello complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span></span>

<span data-ttu-id="3aa03-222">Если вы по-прежнему не удается tooprogress проблему, поддержки будут более чем довольны tooassist и продолжить здесь.</span><span class="sxs-lookup"><span data-stu-id="3aa03-222">If you’re still unable tooprogress your issue, support would be more than happy tooassist and continue from here.</span></span> <span data-ttu-id="3aa03-223">Создайте запрос в службу поддержки непосредственно на портале hello и наши инженеры будут направляться tooyou.</span><span class="sxs-lookup"><span data-stu-id="3aa03-223">Create a support ticket directly within hello portal and our engineers will reach out tooyou.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="3aa03-224">Другие сценарии</span><span class="sxs-lookup"><span data-stu-id="3aa03-224">Other scenarios</span></span>

-   <span data-ttu-id="3aa03-225">Прокси приложения Azure запрашивает билет Kerberos перед отправкой его применение tooan запроса.</span><span class="sxs-lookup"><span data-stu-id="3aa03-225">Azure Application Proxy requests a Kerberos ticket before sending its request tooan application.</span></span> <span data-ttu-id="3aa03-226">Некоторые сторонние приложения например Tableau Server не хотелось бы этот метод проверки подлинности, а вместо этого ожидает hello более традиционных согласования tootake месте.</span><span class="sxs-lookup"><span data-stu-id="3aa03-226">Some 3rd party applications such as Tableau Server do not like this method of authenticating, and rather expects hello more conventional negotiations tootake place,.</span></span> <span data-ttu-id="3aa03-227">первый запрос Hello является анонимным, позволить toorespond приложения hello hello типы проверки подлинности, которые она поддерживает через 401.</span><span class="sxs-lookup"><span data-stu-id="3aa03-227">hello first request is anonymous, allowing hello application toorespond with hello authentication types that it supports through a 401.</span></span>

-   <span data-ttu-id="3aa03-228">Проверка подлинности с двумя прыжками — обычно используется в сценариях с многоуровневым приложением, где проверка подлинности требуется как для серверной, так и для интерфейсной части (например, SQL Reporting Services).</span><span class="sxs-lookup"><span data-stu-id="3aa03-228">Double hop authentication - Commonly used in scenarios where an application is tiered, with a backend and front end, both requiring authentication, such as SQL Reporting Services.</span></span>

## <a name="next-steps"></a><span data-ttu-id="3aa03-229">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="3aa03-229">Next steps</span></span>
[<span data-ttu-id="3aa03-230">Настройка ограниченного делегирования Kerberos в управляемом домене</span><span class="sxs-lookup"><span data-stu-id="3aa03-230">Configure kerberos constrained delegation (KCD) on a managed domain</span></span>](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)

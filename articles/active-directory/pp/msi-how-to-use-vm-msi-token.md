---
title: "Инструкции по использованию удостоверения назначенный пользователем управляемые службы для получения маркера доступа на виртуальной Машине."
description: "Пошаговые инструкции и примеры для получения OAuth с помощью MSI, назначенный пользователем, из виртуальной Машины Azure доступ к токену."
services: active-directory
documentationcenter: 
author: BryanLa
manager: mtillman
editor: 
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/22/2017
ms.author: bryanla
ROBOTS: NOINDEX,NOFOLLOW
ms.openlocfilehash: 5c9bf052ecb2e9c79e0eb627a0fd709d587125cd
ms.sourcegitcommit: a648f9d7a502bfbab4cd89c9e25aa03d1a0c412b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/22/2017
---
# <a name="acquire-an-access-token-for-a-vm-user-assigned-managed-service-identity-msi"></a>Получить маркер доступа для виртуальной Машины назначенный пользователем управляемые службы удостоверений (MSI)

[!INCLUDE[preview-notice](~/includes/active-directory-msi-preview-notice-ua.md)] Эта статья содержит различные примеры кода и скриптов для получения маркера, а также руководство по важным темам, таким как обработка срока действия маркера и ошибки HTTP.

## <a name="prerequisites"></a>Технические условия

[!INCLUDE [msi-core-prereqs](~/includes/active-directory-msi-core-prereqs-ua.md)]

Если вы планируете использовать примеры Azure PowerShell в этой статье, убедитесь, что установлена последняя версия [Azure PowerShell](https://www.powershellgallery.com/packages/AzureRM).

> [!IMPORTANT]
> - Во всех примерах кода или скриптов в этой статье предполагается, что клиент выполняется на виртуальной машине с поддержкой MSI. Используйте функцию подключения виртуальной машины на портале Azure для удаленного подключения к своей виртуальной машине. Дополнительные сведения о включении MSI на виртуальной Машине см. в разделе [настроить назначенное пользователем управляемые службы удостоверений (MSI) для виртуальной Машины, с помощью Azure CLI](msi-qs-configure-cli-windows-vm.md), или один из вариантов статей (с помощью портала, PowerShell, шаблон или пакет Azure SDK). 

## <a name="overview"></a>Обзор

Клиентское приложение может запрашивать [маркер доступа к приложению](~/articles/active-directory/develop/active-directory-dev-glossary.md#access-token) MSI для доступа к данному ресурсу. Маркер создан на основе [субъекта-службы MSI](msi-overview.md#how-does-it-work). Таким образом клиенту не нужно регистрироваться для получения маркера доступа для собственного субъекта-службы. Маркер подходит для использования в качестве маркера носителя при [выполнении вызовов между службами, требующих учетных данных клиента](~/articles/active-directory/active-directory-protocols-oauth-service-to-service.md).

|  |  |
| -------------- | -------------------- |
| [Получение маркера с использованием HTTP](#get-a-token-using-http) | Сведения о протоколе для конечной точки маркера MSI |
| [Получение маркера с использованием CURL](#get-a-token-using-curl) | Пример использования конечной точки MSI REST от клиента Bash/CURL |
| [Обработка срока действия маркера](#handling-token-expiration) | Рекомендации по обработке срока действия маркера доступа |
| [Обработка ошибок](#error-handling) | Рекомендации по обработке ошибок HTTP, возвращаемых из конечной точки маркера MSI |
| [Идентификаторы ресурсов для служб Azure](#resource-ids-for-azure-services) | Сведения о том, где можно получить идентификаторы ресурсов для поддерживаемых служб Azure |

## <a name="get-a-token-using-http"></a>Получение маркера с использованием HTTP 

Основной интерфейс для получения маркера доступа создан на основе REST, что делает его доступным для любого клиентского приложения, выполняющегося на виртуальной машине,которая может выполнять вызовы HTTP REST. Это похоже на модель программирования Azure AD, за исключением того, что клиент использует конечную точку localhost на виртуальной машине (а не конечную точку Azure AD).

Пример запроса:

```
GET http://localhost:50342/oauth2/token?resource=https%3A%2F%2Fmanagement.azure.com%2F&client_id=712eac09-e943-418c-9be6-9fd5c91078bl HTTP/1.1
Metadata: true
```

| Элемент | ОПИСАНИЕ |
| ------- | ----------- |
| `GET` | HTTP-команда, указывающая, что необходимо извлечь данные из конечной точки. В этом случае используется маркер доступа OAuth. | 
| `http://localhost:50342/oauth2/token` | Конечная точка MSI, в которой порт 50342 является портом по умолчанию, который можно настроить. |
| `resource` | Параметр строки запроса, указывающий URI идентификатора приложения целевого ресурса. Он также отображается в утверждении (аудитории) `aud` выданного маркера. В этом примере запрашивается маркер для доступа к Azure Resource Manager, который имеет универсальный код ресурса (URI) идентификатора приложения https://management.azure.com/. |
| `client_id` | Параметр строки запроса, субъекта-службы, представляющий MSI назначенное пользователем, позволяющее определить, идентификатор клиента (также известный как идентификатор приложения). Это значение возвращается в `clientId` свойство во время создания MSI, назначенный пользователем. В этом примере запрашивает маркер для клиента с Идентификатором «712eac09-e943-418c-9be6-9fd5c91078bl». |
| `Metadata` | Поле заголовка HTTP-запроса, требуемое MSI с целью устранения рисков от атак с подделкой запроса со стороны сервера (SSRF). Должно быть присвоено значение true (все в нижнем регистре).

Пример ответа:

```
HTTP/1.1 200 OK
Content-Type: application/json
{
  "access_token": "eyJ0eXAi...",
  "expires_in": "3599",
  "expires_on": "1506484173",
  "not_before": "1506480273",
  "resource": "https://management.azure.com/",
  "token_type": "Bearer"
  "client_id":"712eac09-e943-418c-9be6-9fd5c91078bl"
}
```

| Элемент | ОПИСАНИЕ |
| ------- | ----------- |
| `access_token` | Запрашиваемый маркер доступа. При вызове защищенного REST API маркер внедряется в поле `Authorization` заголовка запроса в качестве маркера носителя, позволяя API выполнить проверку подлинности вызывающего объекта. | 
| `expires_in` | Количество секунд, в течение которых маркер доступа является действительным, прежде чем его срок действия истечет (с момента выдачи). Время выдачи можно найти в утверждении `iat` маркера. |
| `expires_on` | Период времени после истечения срока действия маркера доступа. Дата представляется как количество секунд с 1970-01-01T0:0:0Z в формате UTC (соответствует утверждению `exp` маркера). |
| `not_before` | Период времени, когда маркер доступа вступает в силу и может быть принят. Дата представляется как количество секунд с 1970-01-01T0:0:0Z в формате UTC (соответствует утверждению `nbf` маркера). |
| `resource` | Ресурс, для которого был запрошен маркер доступа, соответствует параметру строки запроса `resource`. |
| `token_type` | Тип маркера, который является маркером доступа носителя, что значит, что ресурс может предоставлять доступ носителю этого маркера. |
| `client_id` | Идентификатор клиента (также известный как идентификатор приложения) субъекта-службы, представляющий назначенный пользователем MSI-ФАЙЛ, для которого был запрошен маркер. |

## <a name="get-a-token-using-curl"></a>Получение маркера с использованием CURL

Не забудьте заменить идентификатор клиента (также известный как идентификатор приложения) участника, для службы MSI вашей назначенный пользователем <MSI CLIENT ID> значение `client_id` параметра. Это значение возвращается в `clientId` свойство во время создания MSI, назначенный пользователем.

   ```bash
   response=$(curl http://localhost:50342/oauth2/token --data "resource=https://management.azure.com/&client_id=<MSI CLIENT ID>" -H Metadata:true -s)
   access_token=$(echo $response | python -c 'import sys, json; print (json.load(sys.stdin)["access_token"])')
   echo The MSI access token is $access_token
   ```

   Примеры ответов:

   ```bash
   user@vmLinux:~$ response=$(curl http://localhost:50342/oauth2/token --data "resource=https://management.azure.com/&client_id=9d484c98-b99d-420e-939c-z585174b63bl" -H Metadata:true -s)
   user@vmLinux:~$ access_token=$(echo $response | python -c 'import sys, json; print (json.load(sys.stdin)["access_token"])')
   user@vmLinux:~$ echo The MSI access token is $access_token
   The MSI access token is eyJ0eXAiOiJKV1QiLCJhbGciO...
   ```

## <a name="handling-token-expiration"></a>Обработка срока действия маркера

Локальная подсистема MSI кэширует маркеры. Таким образом их можно вызывать столько, сколько нужно, а сетевой вызов Azure AD выполняется, только если:
- произошел промах кэша из-за отсутствия маркера в кэше;
- истек срок действия маркера.

Если маркер кэшируется в коде, необходимо подготовиться к обработке сценариев, в которых ресурс указывает, что срок действия маркера истек.

## <a name="error-handling"></a>Обработка ошибок 

Конечная точка MSI сообщает об ошибках в поле кода состояния заголовка ответного сообщения HTTP в виде ошибок 4xx или 5xx:

| Код состояния | Причина ошибки | Способ устранения |
| ----------- | ------------ | ------------- |
| Ошибка 4xx в запросе. | Один или несколько параметров запроса неверные. | Не выполняйте повторную попытку.  Для получения дополнительной информации просмотрите сведения об ошибке.  Ошибки 4xx — это ошибки времени разработки.|
| Временная ошибка 5xx службы. | Подсистема MSI или Azure Active Directory вернули временную ошибку. | По прошествии 1 секунды можно безопасно повторить попытку.  Если повторные попытки будут выполняться слишком быстро или слишком часто, Azure AD может возвратить ошибку ограничения частоты (429).|

Если возникает ошибка, в соответствующем тексте ответа HTTP содержится код JSON с подробностями об ошибке:

| Элемент | ОПИСАНИЕ |
| ------- | ----------- |
| error   | Идентификатор ошибки. |
| error_description | Подробное описание ошибки. **Описания ошибки могут в любое время измениться. Не записывайте код, который создает ветвь на основе значений в описании ошибки.**|

### <a name="http-response-reference"></a>Ссылка ответа HTTP

В этом разделе описываются возможные сообщения об ошибках. Состояние "200 ОК" — это успешный ответ, а маркер доступа содержится в коде JSON текста ответа в элементе access_token.

| Код состояния | Ошибка | Описание ошибки | Решение |
| ----------- | ----- | ----------------- | -------- |
| 400 — недопустимый запрос | invalid_resource | AADSTS50001: приложение с именем *\<URI\>* не найдено в клиенте с именем *\<TENANT-ID\>*. Это может произойти, если приложение установил не администратор клиента или если пользователь в клиенте не предоставил к нему разрешение. Возможно, вы отправили запрос на проверку подлинности не тому клиенту. | (только для Linux) |
| 400 — недопустимый запрос | bad_request_102 | Необходимый заголовок метаданных не указан | Поле заголовка запроса `Metadata` отсутствует или имеет неправильный формат. Должно быть указано значение `true` в нижнем регистре. В разделе «Пример запроса» в [получить токен, используя HTTP](#get-a-token-using-http) разделе в качестве примера.|
| 401 — недостаточно прав | unknown_source | Неизвестный *\<URI\>* источника | Убедитесь, что универсальный код ресурса (URI) запроса HTTP GET имеет правильный формат. Часть `scheme:host/resource-path` должна быть указана как `http://localhost:50342/oauth2/token`. В разделе «Пример запроса» в [получить токен, используя HTTP](#get-a-token-using-http) разделе в качестве примера.|
|           | invalid_request | В запросе отсутствует требуемый параметр, он включает недопустимое значение параметра, параметр указан несколько раз или как-то искажен. |  |
|           | unauthorized_client | Клиент не авторизован для запроса маркера доступа с помощью этого метода. | Ошибка возникла из-за запроса, который не использовал локальное замыкание на себя для вызова расширения, или из-за того, что на виртуальной машине неправильно настроен MSI. Если вам нужна помощь при конфигурации виртуальной машины, см. статью [Настройка управляемого удостоверения службы (MSI) на виртуальной машине Azure с помощью портала Azure](msi-qs-configure-portal-windows-vm.md). |
|           | access_denied | Владелец ресурса или сервер авторизации отклонил запрос. |  |
|           | unsupported_response_type | Сервер авторизации не поддерживает получение маркера доступа с помощью этого метода. |  |
|           | invalid_scope | Запрошенная область недопустима, неизвестна или неверна. |  |
| 500 — внутренняя ошибка сервера | неизвестно | Не удалось извлечь маркер из Active Directory. Дополнительные сведения см. в журналах в *\<путь к файлу\>*. | Убедитесь, что MSI включен на виртуальной машине. Если вам нужна помощь при конфигурации виртуальной машины, см. статью [Настройка управляемого удостоверения службы (MSI) на виртуальной машине Azure с помощью портала Azure](msi-qs-configure-portal-windows-vm.md).<br><br>Кроме того, убедитесь, что универсальный код ресурса (URI) запроса HTTP GET отформатирован правильно, в частности универсальный код ресурса (URI), указанный в строке запроса. В разделе «Пример запроса» в [получить токен, используя HTTP](#get-a-token-using-http) раздела, например, или [службы Azure, что проверка подлинности Azure AD поддержку](msi-overview.md#azure-services-that-support-azure-ad-authentication) список служб и их соответствующие идентификаторы ресурсов.

## <a name="resource-ids-for-azure-services"></a>Идентификаторы ресурсов для служб Azure

Список ресурсов, которые поддерживают Azure AD и были протестированы с MSI и соответствующими идентификаторами ресурсов, см. в разделе [Службы Azure, поддерживающие аутентификацию Azure AD](msi-overview.md#azure-services-that-support-azure-ad-authentication).


## <a name="next-steps"></a>Дальнейшие действия

- При включении MSI в виртуальной Машине Azure см. [настроить назначенное пользователем управляемые службы удостоверений (MSI) для виртуальной Машины, с помощью Azure CLI](msi-qs-configure-cli-windows-vm.md).

Оставляйте свои замечания и пожелания в разделе ниже. Они помогают нам улучшать содержимое веб-сайта.









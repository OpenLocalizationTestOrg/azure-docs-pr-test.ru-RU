---
title: "Azure Active Directory версии 2.0 и протокол OpenID Connect"
description: "Создайте веб-приложение, используя реализацию протокола аутентификации OpenID Connect в Azure AD версии 2.0."
services: active-directory
documentationcenter: 
author: dstrockis
manager: mtillman
editor: 
ms.assetid: a4875997-3aac-4e4c-b7fe-2b4b829151ce
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/08/2017
ms.author: dastrock
ms.custom: aaddev
ms.openlocfilehash: 568c2128a12abd4f3c366eae943e3ea8c1af2532
ms.sourcegitcommit: e266df9f97d04acfc4a843770fadfd8edf4fa2b7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/11/2017
---
# <a name="azure-active-directory-v20-and-the-openid-connect-protocol"></a>Azure Active Directory версии 2.0 и протокол OpenID Connect
OpenID Connect — это протокол аутентификации на основе OAuth 2.0, который можно использовать для безопасного входа пользователей в веб-приложение. С помощью реализации OpenID Connect в конечной точке версии 2.0 можно добавить в веб-приложения функции входа и доступа к API. В этой статье мы покажем, как это сделать независимо от используемого языка. Мы рассмотрим, как отправлять и получать сообщения HTTP, не используя ни одну из библиотек с открытым кодом Майкрософт.

> [!NOTE]
> Не все сценарии и компоненты Azure Active Directory поддерживаются конечной точкой версии 2.0. Чтобы определить, стоит ли вам использовать конечную точку версии 2.0, ознакомьтесь с [ограничениями версии 2.0](active-directory-v2-limitations.md).
> 
> 

[OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html) расширяет возможности протокола *авторизации* OAuth 2.0 и позволяет использовать его в качестве протокола *аутентификации*, что дает возможность выполнять единый вход с помощью OAuth. В OpenID Connect вводится понятие *маркера идентификации*, который представляет собой маркер безопасности, позволяющий клиенту проверять личность пользователя. Маркер идентификации также позволяет получить базовые сведения о профиле пользователя. Так как OpenID Connect является расширением протокола OAuth 2.0, приложения могут безопасно получать *маркеры доступа*, с помощью которых можно получить доступ к ресурсам, защищенным [сервером авторизации](active-directory-v2-protocols.md#the-basics). Мы рекомендуем использовать OpenID Connect для [веб-приложений](active-directory-v2-flows.md#web-apps), которые размещаются на сервере и доступны через браузер.

## <a name="protocol-diagram-sign-in"></a>Схема протокола: вход в систему
На следующей схеме показаны этапы самого простого потока входа. Каждый этап подробно описан далее в этой статье.

![Протокол OpenID Connect: вход в систему](../../media/active-directory-v2-flows/convergence_scenarios_webapp.png)

## <a name="fetch-the-openid-connect-metadata-document"></a>Получение документа метаданных OpenID Connect
OpenID Connect описывает документ метаданных, который содержит большинство сведений, необходимых приложению для выполнения входа. Сюда входят такие сведения, как используемые URL-адреса и расположение открытых ключей подписывания службы. Ниже указан документ метаданных OpenID Connect, который следует использовать для конечной точки версии 2.0.

```
https://login.microsoftonline.com/{tenant}/v2.0/.well-known/openid-configuration
```

`{tenant}` может принимать одно из четырех значений.

| Значение | ОПИСАНИЕ |
| --- | --- |
| `common` |Пользователи с личной учетной записью Майкрософт и рабочей или учебной учетной записью Azure Active Directory (Azure AD) могут выполнять вход в приложение. |
| `organizations` |Вход в приложение могут выполнять только пользователи с рабочими или учебными учетными записями Azure AD. |
| `consumers` |Вход в приложение могут выполнять только пользователи с личной учетной записью Майкрософт. |
| `8eaef023-2b34-4da1-9baa-8bc8c9d6a490` или `contoso.onmicrosoft.com` |Вход в приложение могут выполнять только пользователи с рабочей или учебной учетной записью из определенного клиента Azure AD. Можно использовать понятное доменное имя клиента Azure AD или идентификатор GUID клиента. |

Метаданные — это простой документ JSON. В качестве примера ниже приведен фрагмент кода. Его содержимое полностью описано в [спецификации OpenID Connect](https://openid.net).

```
{
  "authorization_endpoint": "https:\/\/login.microsoftonline.com\/common\/oauth2\/v2.0\/authorize",
  "token_endpoint": "https:\/\/login.microsoftonline.com\/common\/oauth2\/v2.0\/token",
  "token_endpoint_auth_methods_supported": [
    "client_secret_post",
    "private_key_jwt"
  ],
  "jwks_uri": "https:\/\/login.microsoftonline.com\/common\/discovery\/v2.0\/keys",

  ...

}
```

Как правило, этот документ метаданных используется для настройки библиотеки OpenID Connect или пакета SDK. Метаданные будут использоваться для работы библиотеки. Тем не менее, если вы не используете предварительно собранную библиотеку OpenID Connect, то можете выполнить инструкции в оставшейся части этой статьи, чтобы выполнить вход в веб-приложение, использующее конечную точку версии 2.0.

## <a name="send-the-sign-in-request"></a>Отправка запроса на вход
Если веб-приложению требуется проверить подлинность пользователя, оно может направить его к конечной точке `/authorize` . Этот запрос похож на первый этап [потока кода авторизации OAuth 2.0](active-directory-v2-protocols-oauth-code.md) с несколькими важными различиями, которые приведены ниже.

* Запрос должен содержать область `openid` в параметре `scope`.
* Параметр `response_type` должен включать `id_token`.
* Запрос должен содержать параметр `nonce` .

Например: 

```
// Line breaks are for legibility only.

GET https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=id_token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=form_post
&scope=openid
&state=12345
&nonce=678910
```

> [!TIP]
> Чтобы выполнить этот запрос, щелкните приведенную ниже ссылку. После входа в систему в браузере будет выполнен переход по адресу https://localhost/myapp/ с указанием маркера идентификации в адресной строке. Обратите внимание, что в этом запросе используется `response_mode=query` (исключительно в демонстрационных целях). Мы рекомендуем использовать `response_mode=form_post`.
> <a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=id_token&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&scope=openid&response_mode=query&state=12345&nonce=678910" target="_blank">https://login.microsoftonline.com/common/oauth2/v2.0/authorize...</a>
> 
> 

| Параметр | Условие | ОПИСАНИЕ |
| --- | --- | --- |
| tenant |Требуется |Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать вход пользователей в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Чтобы узнать больше, ознакомьтесь с [основами протокола](active-directory-v2-protocols.md#endpoints). |
| client_id |Требуется |Идентификатор приложения, присвоенный приложению на [портале регистрации приложений](https://apps.dev.microsoft.com/?referrer=https://azure.microsoft.com/documentation/articles&deeplink=/appList). |
| response_type |Требуется |Должен включать `id_token` для входа в OpenID Connect. Кроме того, может включать другие значения `response_types`, например `code`. |
| redirect_uri |Рекомендуется |Универсальный код ресурса (URI) перенаправления приложения, на который можно отправлять ответы аутентификации для их получения приложением. Он должен в точности соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных на портале, но иметь форму URL-адреса. |
| scope |Требуется |Список областей с разделителями-пробелами. При использовании протокола OpenID Connect он должен содержать область `openid`, что преобразуется в разрешение "Вход" в пользовательском интерфейсе предоставления согласия. Для предоставления согласия этот запрос может также включать в себя другие области. |
| nonce |Требуется |Значение, включенное в запрос и созданное приложением, которое будет добавлено в полученное значение id_token в качестве утверждения. Приложение может проверить это значение во избежание атак с использованием воспроизведения маркера. Как правило, это значение представляет собой случайную уникальную строку, которую можно использовать для определения источника запроса. |
| response_mode |Рекомендуется |Указывает метод, с помощью которого следует отправлять полученный код авторизации приложению. Может иметь значение `query`, `form_post` или `fragment`. Для веб-приложений рекомендуется использовать `response_mode=form_post`, чтобы обеспечить наиболее безопасную передачу маркеров в приложение. |
| state |Рекомендуется |Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого содержания. Как правило, с целью [предотвращения подделки межсайтовых запросов](http://tools.ietf.org/html/rfc6749#section-10.12) используется генерируемое случайным образом уникальное значение. Параметр state используется также для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении. |
| prompt |Необязательно |Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственные допустимые значения — `login`, `none` и `consent`. Утверждение `prompt=login` требует от пользователя ввести учетные данные по запросу. Единый вход не сработает. Утверждение `prompt=none` является противоположным. Оно гарантирует, что интерактивные запросы для пользователя не будут выводиться ни при каких обстоятельствах. Если запрос не удастся завершить автоматически с использованием единого входа, то конечная точка версии 2.0 вернет ошибку. Утверждение `prompt=consent` активирует диалоговое окно предоставления согласия OAuth после входа пользователя в систему. В нем у пользователя запрашиваются разрешения для приложения. |
| login_hint |Необязательно |Этот параметр можно применять для предварительного заполнения полей имени пользователя и электронного адреса на странице входа пользователя (если имя пользователя известно заранее). Зачастую этот параметр используется в приложениях при повторной аутентификации. При этом имя пользователя извлекается во время предыдущего входа с помощью утверждения `preferred_username`. |
| domain_hint |Необязательно |Возможные значения — `consumers` или `organizations`. Если используется этот параметр, процесс обнаружения на основе электронной почты, который проходит пользователь на странице входа в приложение версии 2.0, пропускается, что немного оптимизирует работу. Нередко этот параметр используется в приложениях при повторной аутентификации. Для этого значение утверждения `tid` извлекается из маркера идентификации. Если значение утверждения `tid` — `9188040d-6c67-4c5b-b112-36a304b66dad`, следует использовать `domain_hint=consumers`. Или используйте `domain_hint=organizations`. |

На текущем этапе пользователю предлагается ввести учетные данные и завершить аутентификацию. Конечная точка версии 2.0 проверяет, дал ли пользователь согласие на предоставление разрешений, указанных в параметре запроса `scope`. Если пользователь не предоставил какие-либо из этих разрешений, конечная точка версии 2.0 запросит их у пользователя. Вы можете узнать больше о [разрешениях, согласии и мультитенантных приложениях](active-directory-v2-scopes.md).

После того как пользователь пройдет аутентификацию и согласится на предоставление разрешений, конечная точка версии 2.0 вернет приложению ответ на указанный универсальный код ресурса (URI) перенаправления с помощью метода, указанного в параметре `response_mode`.

### <a name="successful-response"></a>Успешный ответ
Успешный ответ при использовании `response_mode=form_post` выглядит следующим образом.

```
POST /myapp/ HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded

id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNB...&state=12345
```

| Параметр | ОПИСАНИЕ |
| --- | --- |
| id_token |Маркер идентификации, запрошенный приложением. Вы можете использовать параметр `id_token` для проверки личности пользователя и запуска сеанса пользователя. Дополнительные сведения о маркерах идентификации и их содержимом можно найти в [справочнике по маркерам конечной точки версии 2.0](active-directory-v2-tokens.md). |
| state |Если запрос содержит параметр `state`, то в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

### <a name="error-response"></a>Сообщение об ошибке
Сообщения об ошибках также можно отправлять на универсальный код ресурса (URI) перенаправления, чтобы приложение могло их обработать. Сообщение об ошибке выглядит следующим образом.

```
POST /myapp/ HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded

error=access_denied&error_description=the+user+canceled+the+authentication
```

| Параметр | ОПИСАНИЕ |
| --- | --- |
| error |Строка кода ошибки, которую можно использовать для классификации типов возникших ошибок и реагирования на них. |
| error_description |Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки аутентификации. |

### <a name="error-codes-for-authorization-endpoint-errors"></a>Коды ошибок конечной точки авторизации
В таблице ниже описаны коды ошибок, которые могут возвращаться в параметре `error` сообщения об ошибке.

| Код ошибки | ОПИСАНИЕ | Действие клиента |
| --- | --- | --- |
| invalid_request |Ошибка протокола, например отсутствует обязательный параметр. |Исправьте запрос и отправьте его повторно. Это ошибка разработки, которая, как правило, обнаруживается во время первоначального тестирования. |
| unauthorized_client |Клиентское приложение не может запрашивать код авторизации. |Как правило, это происходит, если клиентское приложение не зарегистрировано в Azure AD или не добавлено в клиент Azure AD пользователя. Приложение может отобразить для пользователя запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| access_denied |Владелец ресурса не дал согласия. |Клиентское приложение может уведомить пользователя, что не может продолжить работу без согласия пользователя. |
| unsupported_response_type |Сервер авторизации не поддерживает тип ответа в запросе. |Исправьте запрос и отправьте его повторно. Это ошибка разработки, которая, как правило, обнаруживается во время первоначального тестирования. |
| server_error |Сервер обнаружил непредвиденную ошибку. |Повторите запрос. Эти ошибки могут возникать в связи с временными условиями. Клиентское приложение может отобразить для пользователя сообщение о том, что его ответ задерживается из-за временной ошибки. |
| temporarily_unavailable |Сервер временно занят и не может обработать запрос. |Повторите запрос. Клиентское приложение может отобразить для пользователя сообщение о том, что его ответ задерживается из-за временных условий. |
| invalid_resource |Целевой ресурс является недопустимым, так как он не существует. Azure AD не удается найти ресурс, или он настроен неправильно. |Это означает, что ресурс, если он существует, не настроен в клиенте. Приложение может отобразить для пользователя запрос с инструкциями по установке приложения и его добавлению в Azure AD. |

## <a name="validate-the-id-token"></a>Проверка маркера идентификации
Получение маркера идентификации не является достаточным для прохождения пользователем аутентификации. Необходимо также проверить подпись маркера идентификации и сопоставить утверждения в маркере с требованиями вашего приложения. В конечной точке версии 2.0 для подписи маркеров и проверки их правильности используются [веб-маркеры JSON Web Token (JWT)](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) и шифрование с открытым ключом.

Вы можете выбрать проверку маркера идентификации в клиентском коде, но обычно этот маркер отправляется для проверки на внутренний сервер. После проверки подписи маркера идентификации потребуется проверить несколько утверждений. Дополнительные сведения, включая описание [проверки маркеров](active-directory-v2-tokens.md#validating-tokens) и [важную информацию о смене ключей подписывания](active-directory-v2-tokens.md#validating-tokens), см. в [справочнике по маркерам версии 2.0](active-directory-v2-tokens.md). Рекомендуется использовать библиотеку для анализа и проверки маркеров. Для большинства языков и платформ доступна по крайней мере одна такая библиотека.
<!--TODO: Improve the information on this-->

Вам также может потребоваться проверить дополнительные утверждения в зависимости от реализуемого сценария. Ниже приведены некоторые из стандартных проверок:

* Обеспечение регистрации пользователя или организации в приложении.
* Обеспечение наличия у пользователя требуемых разрешений или привилегий.
* Обеспечение определенной строгости аутентификации, например Многофакторной идентификации.

Дополнительные сведения об утверждениях в маркере идентификации можно найти в [справочнике по маркерам конечной точки версии 2.0](active-directory-v2-tokens.md).

После полной проверки маркера идентификации можно запустить сеанс пользователя. Используйте утверждения в маркере идентификации для получения сведений о пользователе в вашем приложении. Эти сведения можно использовать для отображения, записей, авторизации и т. д.

## <a name="send-a-sign-out-request"></a>Отправка запроса на выход
Для выхода пользователя из приложения недостаточно очистить файлы cookie или каким-то другим образом завершить сеанс пользователя. Чтобы пользователь вышел, его также необходимо перенаправить в конечную точку версии 2.0. Если этого не сделать, то пользователь сможет снова пройти проверку подлинности в приложении без ввода учетных данных, так как они будут иметь действительный сеанс единого входа с конечной точкой версии 2.0.

Можно перенаправить пользователя на адрес, указанный в параметре `end_session_endpoint` в документе метаданных OpenID Connect:

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/logout?
post_logout_redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
```

| Параметр | Условие | ОПИСАНИЕ |
| ----------------------- | ------------------------------- | ------------ |
| post_logout_redirect_uri | Рекомендуется | URL-адрес, на который пользователя следует перенаправить после успешного выхода. Если этот параметр не указан, пользователь увидит общее сообщение, которое создается конечной точкой версии 2.0. URL-адрес должен в точности соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных для приложения на портале регистрации приложений.  |

## <a name="single-sign-out"></a>Единый выход
Если перенаправить пользователя к `end_session_endpoint`, конечная точка версии 2.0 очистит сеанс пользователя из браузера. Тем не менее пользователь может оставаться вошедшим в другие приложения, использующие учетные записи Майкрософт для аутентификации. Чтобы обеспечить одновременный выход пользователя из всех приложений, конечная точка версии 2.0 отправляет HTTP-запрос GET к зарегистрированному URL-адресу `LogoutUrl` для всех приложений, в которые в настоящее время вошел пользователь. Приложения должны ответить на него, удалив любой сеанс, который идентифицирует пользователя, и возвратив ответ `200`.  Для поддержки единого входа в приложении необходимо в его коде реализовать такой URL-адрес `LogoutUrl`.  `LogoutUrl` можно задать на портале регистрации приложения.

## <a name="protocol-diagram-token-acquisition"></a>Схема протокола: получение маркера
Многим веб-приложениям требуется не только выполнить вход пользователя, но и получить доступ к веб-службе от имени этого пользователя с помощью OAuth. Этот сценарий совмещает применение OpenID Connect для аутентификации пользователей и одновременное получение кода авторизации, который можно использовать для получения маркеров доступа с помощью потока кода авторизации OAuth.

Полный поток входа OpenID Connect и получения маркера представлен на следующей схеме. Каждый этап подробно описан в следующих разделах статьи.

![Протокол OpenID Connect: получение маркера](../../media/active-directory-v2-flows/convergence_scenarios_webapp_webapi.png)

## <a name="get-access-tokens"></a>Получение маркеров доступа
Для получения маркеров доступа необходимо изменить запрос на вход.

```
// Line breaks are for legibility only.

GET https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e        // Your registered Application ID
&response_type=id_token%20code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F       // Your registered redirect URI, URL encoded
&response_mode=form_post                              // 'query', 'form_post', or 'fragment'
&scope=openid%20                                      // Include both 'openid' and scopes that your app needs  
offline_access%20                                         
https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
&state=12345                                          // Any value, provided by your app
&nonce=678910                                         // Any value, provided by your app
```

> [!TIP]
> Чтобы выполнить этот запрос, щелкните приведенную ниже ссылку. После входа в систему в браузере будет выполнен переход по адресу https://localhost/myapp/ с указанием маркера идентификации и кода в адресной строке. Обратите внимание, что в этом запросе используется `response_mode=query` (исключительно в демонстрационных целях). Мы рекомендуем использовать `response_mode=form_post`.
> <a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=id_token%20code&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&response_mode=query&scope=openid%20offline_access%20https%3A%2F%2Fgraph.microsoft.com%2Fmail.read&state=12345&nonce=678910" target="_blank">https://login.microsoftonline.com/common/oauth2/v2.0/authorize...</a>
> 
> 

Добавляя области разрешений в запрос и используя `response_type=id_token code`, конечная точка версии 2.0 гарантирует, что пользователь согласился предоставить разрешения, перечисленные в параметре запроса `scope`. Он возвращает приложению код авторизации в обмен на маркер доступа.

### <a name="successful-response"></a>Успешный ответ
Успешный ответ с использованием `response_mode=form_post` выглядит следующим образом.

```
POST /myapp/ HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded

id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNB...&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...&state=12345
```

| Параметр | ОПИСАНИЕ |
| --- | --- |
| id_token |Маркер идентификации, запрошенный приложением. Вы можете использовать маркер идентификации для проверки личности пользователя и запуска сеанса пользователя. Дополнительные сведения о маркерах идентификации и их содержимом можно найти в [справочнике по маркерам конечной точки версии 2.0](active-directory-v2-tokens.md). |
| Код |Запрашиваемый приложением код авторизации. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса. Код авторизации имеет очень небольшой срок действия. Как правило, он действует в течение 10 минут. |
| state |Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

### <a name="error-response"></a>Сообщение об ошибке
Сообщения об ошибках также можно отправлять на универсальный код ресурса (URI) перенаправления, чтобы приложение могло их правильно обработать. Сообщение об ошибке выглядит следующим образом.

```
POST /myapp/ HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded

error=access_denied&error_description=the+user+canceled+the+authentication
```

| Параметр | ОПИСАНИЕ |
| --- | --- |
| error |Строка кода ошибки, которую можно использовать для классификации типов возникших ошибок и реагирования на них. |
| error_description |Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки аутентификации. |

Описание возможных кодов ошибок и рекомендуемые ответы клиента см. в разделе [Коды ошибок конечной точки авторизации](#error-codes-for-authorization-endpoint-errors).

После получения кода авторизации и маркера идентификации можно выполнить вход пользователя в систему и получить маркеры доступа от его имени. Для входа пользователя необходимо проверить маркер идентификации [в точности, как описано выше](#validate-the-id-token). Для получения маркеров доступа следует выполнить действия, описанные в нашей [документации по протоколу OAuth](active-directory-v2-protocols-oauth-code.md#request-an-access-token).

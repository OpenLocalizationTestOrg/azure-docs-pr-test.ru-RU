---
title: "Включение единого входа для нескольких приложений Android с помощью ADAL | Документация Майкрософт"
description: "Использование функций ADAL SDK для включения единого входа в приложениях. "
services: active-directory
documentationcenter: 
author: danieldobalian
manager: mtillman
editor: 
ms.assetid: 40710225-05ab-40a3-9aec-8b4e96b6b5e7
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: android
ms.devlang: java
ms.topic: article
ms.date: 04/07/2017
ms.author: dadobali
ms.custom: aaddev
ms.openlocfilehash: 7d832ecf3e9c64088a75cc88551879b4e09df715
ms.sourcegitcommit: e266df9f97d04acfc4a843770fadfd8edf4fa2b7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/11/2017
---
# <a name="how-to-enable-cross-app-sso-on-android-using-adal"></a>Как включить единый вход для нескольких приложений Android с помощью ADAL
Сегодня пользователи рассчитывают на возможность единого входа, позволяющую вводить учетные данные только один раз с последующим автоматическим входом в разные приложения. Сложность ввода имени пользователя и пароля на маленьком экране, часто с дополнительной проверкой подлинности, например посредством звонка по телефону или кода в SMS, приводит к неудовлетворенности пользователя, если ему приходится это делать больше одного раза.

Кроме того, если вы используете платформу удостоверений, которую могут использовать другие приложения, например учетные записи Майкрософт или рабочую учетную запись Office 365, пользователи ожидают, что эти учетные данные будут доступны во всех приложениях любых поставщиков.

Платформа Microsoft Identity вместе с пакетом SDK для этой платформы делают всю сложную работу за вас, предоставляя пользователям возможность единого входа во все используемые вами приложения либо на всем устройстве (с помощью брокера и приложений Authenticator).

В этом пошаговом руководстве описывается, как настроить пакет SDK в приложении, чтобы ваши пользователи смогли воспользоваться этими преимуществами.

Руководство применимо при работе с такими службами:

* Azure Active Directory
* Azure Active Directory B2C
* Azure Active Directory B2B
* Условный доступ к Azure Active Directory

В представленном выше документе предполагается, что вы способны [подготовить приложения на устаревшем портале для Azure Active Directory](active-directory-how-to-integrate.md) и уже интегрировали приложение с [пакетом Android SDK для Microsoft Identity](https://github.com/AzureAD/azure-activedirectory-library-for-android).

## <a name="sso-concepts-in-the-microsoft-identity-platform"></a>Концепции единого входа на платформе Microsoft Identity
### <a name="microsoft-identity-brokers"></a>Брокеры Microsoft Identity
Корпорация Майкрософт предоставляет приложения для всех мобильных платформ, которые позволяют привязывать учетные данные к приложениям разных поставщиков и использовать специальные расширенные возможности, требующие единого безопасного расположения для проверки учетных данных. Они называются **брокеры**. В iOS и Android брокеры доступны в скачиваемых приложениях. Эти приложения пользователи устанавливают самостоятельно, либо их может передавать на устройство сотрудника компания, частично или полностью управляющая такими устройствами. Брокеры поддерживают управление безопасностью только для некоторых приложений или для всего устройства в зависимости от требований ИТ-администраторов. В Windows этот компонент предоставляется средством выбора учетной записи, встроенным в операционную систему (его техническое название — брокер веб-аутентификации).

Сведения о том, как мы используем эти брокеры и как они будут отображаться для пользователей при входе на платформу Microsoft Identity, приводятся дальше в этой статье.

### <a name="patterns-for-logging-in-on-mobile-devices"></a>Способы входа на мобильные устройства
Доступ к учетным данным на устройствах с поддержкой платформы Microsoft Identity осуществляется в рамках двух основных подходов:

* вход без брокера;
* вход с брокером.

#### <a name="non-broker-assisted-logins"></a>вход без брокера;
Вход без брокера — это встроенная возможность входа в приложение с использованием локального хранилища на устройстве. Хотя доступ к этом хранилищу может осуществляться из других приложений, учетные данные строго привязаны к использующему их приложению или набору приложений. Скорее всего, вы уже встречали такой подход во многих мобильных приложениях, в которых имя пользователя и пароль вводятся непосредственно в приложении.

Такой способ входа отличается следующими преимуществами:

* пользовательский интерфейс полностью реализован в приложении;
* учетные данные можно передавать в приложения, подписанные с использованием одного и того же сертификата, что создает возможность единого входа во все ваши приложения;
* управление процедурой входа в рамках приложения возможно как до, так и после входа.

Такой способ входа имеет следующие недостатки:

* единый вход будет доступен пользователю не во всех приложениях, в которых используются удостоверения Microsoft Identity, а только для тех удостоверений Microsoft Identity, которые настроены в вашем приложении;
* нет возможности использовать для приложения расширенные бизнес-функции и компоненты, например условный доступ или набор продуктов InTune;
* приложение не поддерживает аутентификацию бизнес-пользователей на основе сертификата.

Ниже показано, как с помощью пакетов SDK для Microsoft Identity можно включить единый вход, используя общее хранилище приложений.

```
+------------+ +------------+  +-------------+
|            | |            |  |             |
|   App 1    | |   App 2    |  |   App 3     |
|            | |            |  |             |
|            | |            |  |             |
+------------+ +------------+  +-------------+
| Azure SDK  | | Azure SDK  |  | Azure SDK   |
+------------+-+------------+--+-------------+
|                                            |
|            App Shared Storage              |
+--------------------------------------------+
```

#### <a name="broker-assisted-logins"></a>вход с брокером.
Так называется вход, выполняемый в приложении брокера с использованием хранилища и системы безопасности брокера, который позволяет применить на устройстве один набор учетных данных для всех приложений, которые используют платформу Microsoft Identity. Это означает, что ваши приложения используют брокер для входа пользователей в систему. В iOS и Android брокеры доступны в виде скачиваемых приложений. Эти приложения устанавливаются пользователями самостоятельно либо принудительно передаются на устройство компанией, которая управляет устройствами. Пример этого типа приложений — приложение Microsoft Authenticator в iOS. В Windows этот компонент предоставляется средством выбора учетной записи, встроенным в операционную систему (его техническое название — брокер веб-проверки подлинности).
Этот способ входа зависит от платформы. При неправильном управлении он может мешать работе пользователей. Возможно, вы знакомы с этим способом входа, если у вас установлено приложение Facebook и вы используете Facebook Connect для входа в другие приложения. Платформа Microsoft Identity использует этот же принцип.

В iOS это реализовано в виде анимированного "перехода", в рамках которого ваше приложение переходит на задний план, а приложения Microsoft Authenticator — на передний, что позволяет пользователю выбрать учетную запись для входа.  

В Android и Windows для удобства пользователя средство выбора учетной записи отображается поверх приложения.

#### <a name="how-the-broker-gets-invoked"></a>Способы вызова брокера
При установке совместимого брокера на устройство, например приложение Microsoft Authenticator, пакеты SDK Microsoft Identity автоматически будут выполнять вызов брокера, когда пользователь укажет, что хочет войти с помощью любой учетной записи платформы Microsoft Identity. Это может быть личная учетная запись Майкрософт, рабочая или учебная учетная запись либо любая другая учетная запись, которую вы предоставили и разместили в Azure с использованием продуктов B2C и B2B. 
 
 #### <a name="how-we-ensure-the-application-is-valid"></a>Как мы проверяем, что приложение является допустимым
 
 Идентификация приложений, обращающихся к брокеру, имеет решающее значение для обеспечения безопасности при входе с брокером. Ни iOS, ни Android не предоставляют уникальные идентификаторы, действующие только для конкретного приложения. Это означает, что любое вредоносное ПО может имитировать идентификатор уполномоченного приложения и получать предназначенные для него маркеры. Чтобы убедиться, что во время выполнения мы всегда взаимодействуем с надежным приложением, мы просим разработчиков при регистрации приложений в корпорации Майкрософт предоставлять собственный универсальный код ресурса (URI) для перенаправления. **Ниже подробно описано, как разработчику создать URI-адрес для перенаправления.** Этот пользовательский URI для перенаправления содержит отпечаток сертификата приложения и служит уникальным идентификатором приложения в магазине Google Play. Когда приложение вызывает брокер, тот запрашивает у операционной системы Android отпечаток сертификата, с которым был вызван этот брокер. Затем брокер предоставляет этот отпечаток сертификата в корпорацию Майкрософт в рамках обращения к системе удостоверений. Если отпечаток сертификата, указанный приложением, не соответствует тому отпечатку сертификата, который разработчик предоставил нам во время регистрации, запрошенные приложением маркеры доступа к ресурсам не выдаются. Такая проверка гарантирует, что только зарегистрированные разработчиком приложения получат маркеры.

**Разработчик может выбрать, будет ли SDK Microsoft Identity вызывать брокер или использовать поток без помощи брокера.** Если разработчик не желает использовать последовательность с брокером, он не сможет предоставить пользователям единый вход с помощью учетных данных, уже добавленных на устройство. Кроме того, приложение не сможет использовать такие бизнес-функции корпорации Майкрософт, как условный доступ, возможности управления InTune и аутентификация на основе сертификата.

Такой способ входа отличается следующими преимуществами:

* пользователь выполняет единый вход во всех приложениях независимо от поставщика;
* в приложении можно использовать расширенные бизнес-функции и компоненты, включая условный доступ и набор продуктов InTune;
* приложение может поддерживать аутентификацию бизнес-пользователей на основе сертификата;
* более безопасная процедура входа — удостоверение приложения и пользователь проверяются приложением брокера с использованием шифрования и дополнительных алгоритмов безопасности.

Такой способ входа имеет следующие недостатки:

* в iOS пользователь выходит из приложения во время выбора учетных данных;
* невозможность управления процедурой входа пользователей в приложении.

Ниже показано, как с помощью пакетов SDK для Microsoft Identity можно включить единый вход, используя приложение брокера.

```
+------------+ +------------+   +-------------+
|            | |            |   |             |
|   App 1    | |   App 2    |   |   Someone   |
|            | |            |   |    Else's   |
|            | |            |   |     App     |
+------------+ +------------+   +-------------+
|  ADAL SDK  | |  ADAL SDK  |   |  ADAL SDK   |
+-----+------+-+-----+------+-  +-------+-----+
      |              |                  |
      |       +------v------+           |
      |       |             |           |
      |       | Microsoft   |           |
      +-------> Broker      |^----------+
              | Application
              |             |
              +-------------+
              |             |
              |   Broker    |
              |   Storage   |
              |             |
              +-------------+

```

Теперь, вооружившись базовыми сведениями, вы сможете лучше понимать возможности единого входа и эффективнее реализовывать их в своем приложении с помощью платформы Microsoft Identity и пакетов SDK.

## <a name="enabling-cross-app-sso-using-adal"></a>Включение единого входа в нескольких приложениях с помощью ADAL
Здесь мы с помощью пакета SDK ADAL для Android решим следующие задачи:

* включение единого входа без помощи брокера для набора приложений;
* включить поддержку единого входа с помощью брокера.

### <a name="turning-on-sso-for-non-broker-assisted-sso"></a>Включение единого входа без брокера
Когда для приложений включен единый вход без брокера, большей частью связанных с этой функцией процессов управляют пакеты SDK для Microsoft Identity. Сюда входит поиск нужного пользователя в кэше, а также хранение списка вошедших пользователей для выполнения запросов.

Включить единый вход для своих приложений можно так:

1. Убедитесь, что все приложения используют один идентификатор клиента или приложения.
2. Убедитесь, что все приложения имеют один набор SharedUserID.
3. Убедитесь, что все приложения используют один самозаверяющий сертификат из магазина Google Play для общего доступа к хранилищу.

#### <a name="step-1-using-the-same-client-id--application-id-for-all-the-applications-in-your-suite-of-apps"></a>Шаг 1. Использование одного идентификатора клиента или приложения для всех приложений в наборе
Чтобы платформа Microsoft Identity получила разрешение на использование общих токенов в приложениях, каждому из приложений потребуется предоставить один идентификатор клиента или приложения. Это уникальный идентификатор, предоставленный вам при регистрации первого приложения на портале.

Возможно, вы еще не знаете, как службе Microsoft Identity различать разные приложения, ведь она использует только один идентификатор приложения. Все дело в **URI перенаправления**. Каждое приложение может иметь несколько кодов URI перенаправления, зарегистрированных на портале подключения. Каждое приложение в наборе получит уникальный код URI перенаправления. Вот как это выглядит:

URI перенаправления App1: `msauth://com.example.userapp/IcB5PxIyvbLkbFVtBI%2FitkW%2Fejk%3D`

URI перенаправления App2: `msauth://com.example.userapp1/KmB7PxIytyLkbGHuI%2UitkW%2Fejk%4E`

URI перенаправления App3: `msauth://com.example.userapp2/Pt85PxIyvbLkbKUtBI%2SitkW%2Fejk%9F`

....

Эти элементы вложены в один и тот же идентификатор клиента или приложения. Найти их можно по коду URI перенаправления, возвращаемого нам в конфигурации пакета SDK.

```
+-------------------+
|                   |
|  Client ID        |
+---------+---------+
          |
          |           +-----------------------------------+
          |           |  App 1 Redirect URI               |
          +----------^+                                   |
          |           +-----------------------------------+
          |
          |           +-----------------------------------+
          +----------^+  App 2 Redirect URI               |
          |           |                                   |
          |           +-----------------------------------+
          |
          +----------^+-----------------------------------+
                      |  App 3 Redirect URI               |
                      |                                   |
                      +-----------------------------------+

```


*Обратите внимание, что формат URI перенаправления представлен ниже. Вы можете использовать любой код URI перенаправления, если не хотите использовать брокер. В таком случае он будет выглядеть как показано выше.*

#### <a name="step-2-configuring-shared-storage-in-android"></a>Шаг 2. Настройка общего хранилища в Android
Настройка идентификатора `SharedUserID` не описана в этом документе. См. соответствующие инструкции в документации по Google Android в разделе [Manifest](http://developer.android.com/guide/topics/manifest/manifest-element.html). Важно, что именно вы решаете, как следует назвать идентификатор sharedUserID, и используете его во всех ваших приложениях.

После того как вы добавите идентификатор `SharedUserID` во все свои приложения, вы сможете использовать единый вход.

> [!WARNING]
> Если вы предоставляете общий доступ к хранилищу всем своим приложениям, любое из них может удалить пользователей или, что еще хуже, все маркеры в приложении. Это особенно катастрофично, если фоновая работа некоторых приложений зависит от токенов. Общий доступ к хранилищу означает, что все операции удаления с помощью пакета SDK для Microsoft Identity теперь следует выполнять крайне осторожно.
> 
> 

Вот и все! Теперь пакет SDK для Microsoft Identity передаст учетные данные во все приложения. Кроме того, во все экземпляры приложений будет отправлен список пользователей.

### <a name="turning-on-sso-for-broker-assisted-sso"></a>Включение единого входа с брокером
Возможность приложения использовать любой брокер, который установлен на устройстве, **по умолчанию отключена**. Чтобы пользоваться приложением с брокером, необходимо выполнить дополнительную настройку и добавить код в приложение.

Вот как это сделать:

1. Включите режим брокера в вызове пакета SDK MS, осуществляемом в коде приложения.
2. Укажите новый код URI перенаправления для самого приложения и его регистрации.
3. Настройте требуемые разрешения в манифесте Android.

#### <a name="step-1-enable-broker-mode-in-your-application"></a>Шаг 1. Включение режима брокера в приложении
Возможность использовать в приложении брокер включается во время создания параметров или при первоначальной настройке экземпляра проверки подлинности. Это можно сделать, настроив тип ApplicationSettings в коде.

```
AuthenticationSettings.Instance.setUseBroker(true);
```


#### <a name="step-2-establish-a-new-redirect-uri-with-your-url-scheme"></a>Шаг 2. Настройка нового кода URI перенаправления в схеме URL-адреса
Вы можете обеспечить возврат маркеров учетных данных в нужное приложение. Для этого нужно убедиться, что способ выполнения обратного вызова к приложению доступен для проверки операционной системой Android. Операционная система Android использует хэш сертификата в магазине Google Play. Стороннее приложение не сможет подделать его. Следовательно, мы будем использовать его с кодом URI приложения брокера, обеспечивая тем самым возврат маркеров в нужное приложение. Вам нужно указать этот уникальный код URI перенаправления в приложении, а также выбрать его в качестве URI перенаправления на нашем портале разработчиков.

Формат кода URI перенаправления должен быть таким:

`msauth://packagename/Base64UrlencodedSignature`

Например, *msauth://com.example.userapp/IcB5PxIyvbLkbFVtBI%2FitkW%2Fejk%3D*

Этот URI перенаправления должен быть указан при регистрации приложения на [портале Azure](https://portal.azure.com/). Дополнительные сведения о регистрации приложения Azure AD см. в статье, посвященной [интеграции с Azure Active Directory](active-directory-how-to-integrate.md).

#### <a name="step-3-set-up-the-correct-permissions-in-your-application"></a>Шаг 3. Настройка требуемых разрешений в приложении
В нашем приложении брокера в Android используется функция диспетчера учетных записей ОС Android для управления учетными данными в разных приложениях. Чтобы использовать брокер в приложении Android, ваш манифест приложения должен содержать разрешения на использование учетных записей AccountManager. Дополнительные сведения об этом см. в [документации Google по использованию диспетчера учетных записей](http://developer.android.com/reference/android/accounts/AccountManager.html).

Речь идет о следующих разрешениях:

```
GET_ACCOUNTS
USE_CREDENTIALS
MANAGE_ACCOUNTS
```

### <a name="youve-configured-sso"></a>Вы настроили единый вход!
Теперь пакет SDK для Microsoft Identity будет автоматически предоставлять учетные данные в приложения и вызывать брокера, если он есть на устройстве.


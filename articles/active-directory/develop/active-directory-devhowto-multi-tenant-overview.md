---
title: "Как создать приложение, поддерживающее вход любого пользователя Azure AD | Документация Майкрософт"
description: "Пошаговые инструкции по созданию приложения, которое может реализовать вход пользователя из любого клиента Azure Active Directory, также известного как мультитенантное приложение."
services: active-directory
documentationcenter: 
author: dstrockis
manager: mbaldwin
editor: 
ms.assetid: 35af95cb-ced3-46ad-b01d-5d2f6fd064a3
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 04/26/2017
ms.author: dastrock
ms.custom: aaddev
ms.openlocfilehash: f1c79fa7e3b0e160487b5941741f6a6c677c6b81
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="how-to-sign-in-any-azure-active-directory-ad-user-using-the-multi-tenant-application-pattern"></a><span data-ttu-id="fd29f-103">Как реализовать вход любого пользователя Azure Active Directory (AD) с помощью шаблона мультитенантного приложения</span><span class="sxs-lookup"><span data-stu-id="fd29f-103">How to sign in any Azure Active Directory (AD) user using the multi-tenant application pattern</span></span>
<span data-ttu-id="fd29f-104">Если вы предлагаете приложение "программное обеспечение как сервис" для многих организаций, то можете настроить приложение таким образом, чтобы оно поддерживало вход из любого клиента Azure AD.</span><span class="sxs-lookup"><span data-stu-id="fd29f-104">If you offer a Software as a Service application to many organizations, you can configure your application to accept sign-ins from any Azure AD tenant.</span></span>  <span data-ttu-id="fd29f-105">В Azure AD это называется "сделать приложение мультитенантным".</span><span class="sxs-lookup"><span data-stu-id="fd29f-105">In Azure AD this is called making your application multi-tenant.</span></span>  <span data-ttu-id="fd29f-106">Пользователи из любого клиента Azure AD смогут входить в приложение после того, как согласятся использовать свою учетную запись с вашим приложением.</span><span class="sxs-lookup"><span data-stu-id="fd29f-106">Users in any Azure AD tenant will be able to sign in to your application after consenting to use their account with your application.</span></span>  

<span data-ttu-id="fd29f-107">Если у вас есть приложение, которое имеет собственную систему учетных записей или поддерживает виды входа от других поставщиков облачных служб, добавить вход в Azure AD с любого клиента не составит труда.</span><span class="sxs-lookup"><span data-stu-id="fd29f-107">If you have an existing application that has its own account system, or supports other kinds of sign-in from other cloud providers, adding Azure AD sign-in from any tenant is simple.</span></span> <span data-ttu-id="fd29f-108">Просто зарегистрируйте свое приложение, добавьте код входа через OAuth2, OpenID Connect или SAML и поместите кнопку "Вход с учетной записью Майкрософт" в свое приложение.</span><span class="sxs-lookup"><span data-stu-id="fd29f-108">Just register your app, add sign-in code via OAuth2, OpenID Connect, or SAML, and put a "Sign In with Microsoft" button on your application.</span></span> <span data-ttu-id="fd29f-109">Чтобы узнать больше о добавлении фирменной символики в приложение, нажмите кнопку ниже.</span><span class="sxs-lookup"><span data-stu-id="fd29f-109">Click the following button to learn more about branding your application.</span></span>

<span data-ttu-id="fd29f-110">[![Sign in button][AAD-Sign-In]][AAD-App-Branding]</span><span class="sxs-lookup"><span data-stu-id="fd29f-110">[![Sign in button][AAD-Sign-In]][AAD-App-Branding]</span></span>

<span data-ttu-id="fd29f-111">В этой статье предполагается, что вы уже знакомы с процессом создания однотенантного приложения для Azure AD.</span><span class="sxs-lookup"><span data-stu-id="fd29f-111">This article assumes you’re already familiar with building a single tenant application for Azure AD.</span></span>  <span data-ttu-id="fd29f-112">Если это не так, вернитесь на страницу [Руководство разработчика по Azure Active Directory][AAD-Dev-Guide] и ознакомьтесь с одним из кратких руководств, указанных в разделе "Приступая к работе".</span><span class="sxs-lookup"><span data-stu-id="fd29f-112">If you’re not, head back up to the [developer guide homepage][AAD-Dev-Guide] and try one of our quick starts!</span></span>

<span data-ttu-id="fd29f-113">Преобразовать приложение в мультитенантное приложение Azure AD можно с помощью четырех простых шагов:</span><span class="sxs-lookup"><span data-stu-id="fd29f-113">There are four simple steps to convert your application into an Azure AD multi-tenant app:</span></span>

1. <span data-ttu-id="fd29f-114">Обновите регистрацию приложения, изменив ее на мультитенантную.</span><span class="sxs-lookup"><span data-stu-id="fd29f-114">Update your application registration to be multi-tenant</span></span>
2. <span data-ttu-id="fd29f-115">Обновите код для отправки запросов в конечную точку "/common".</span><span class="sxs-lookup"><span data-stu-id="fd29f-115">Update your code to send requests to the /common endpoint</span></span> 
3. <span data-ttu-id="fd29f-116">Обновите код для обработки нескольких значений издателя.</span><span class="sxs-lookup"><span data-stu-id="fd29f-116">Update your code to handle multiple issuer values</span></span>
4. <span data-ttu-id="fd29f-117">Изучите особенности получения согласия пользователя и администратора и внесите соответствующие изменения в код.</span><span class="sxs-lookup"><span data-stu-id="fd29f-117">Understand user and admin consent and make appropriate code changes</span></span>

<span data-ttu-id="fd29f-118">Давайте рассмотрим каждый из этих шагов подробнее.</span><span class="sxs-lookup"><span data-stu-id="fd29f-118">Let’s look at each step in detail.</span></span> <span data-ttu-id="fd29f-119">Вы также можете сразу перейти к [этому списку примеров кода для мультитенантных приложений][AAD-Samples-MT].</span><span class="sxs-lookup"><span data-stu-id="fd29f-119">You can also jump straight to [this list of multi-tenant samples][AAD-Samples-MT].</span></span>

## <a name="update-registration-to-be-multi-tenant"></a><span data-ttu-id="fd29f-120">Обновление регистрации с изменением ее на мультитенантную</span><span class="sxs-lookup"><span data-stu-id="fd29f-120">Update registration to be multi-tenant</span></span>
<span data-ttu-id="fd29f-121">По умолчанию регистрация веб-приложения или API в Azure AD предусматривает работу только с одним клиентом, то есть является однотенантной.</span><span class="sxs-lookup"><span data-stu-id="fd29f-121">By default, web app/API registrations in Azure AD are single tenant.</span></span>  <span data-ttu-id="fd29f-122">Чтобы сделать регистрацию мультитенантной, на [классическом портале Azure][AZURE-portal] на странице свойств регистрации приложения найдите переключатель "Мультитенантный" и установите его в положение "Да".</span><span class="sxs-lookup"><span data-stu-id="fd29f-122">You can make your registration multi-tenant by finding the “Multi-Tenanted” switch on the properties page of your application registration in the [Azure portal][AZURE-portal] and setting it to “Yes”.</span></span>

<span data-ttu-id="fd29f-123">Также обратите внимание, что прежде чем сделать приложение мультитенантным, Azure AD требуется, чтобы универсальный код ресурса (URI) кода приложения был глобально уникальным.</span><span class="sxs-lookup"><span data-stu-id="fd29f-123">Also note, before an application can be made multi-tenant, Azure AD requires the App ID URI of the application to be globally unique.</span></span> <span data-ttu-id="fd29f-124">URI кода приложения является одним из способов идентификации приложения в сообщениях протокола.</span><span class="sxs-lookup"><span data-stu-id="fd29f-124">The App ID URI is one of the ways an application is identified in protocol messages.</span></span>  <span data-ttu-id="fd29f-125">Для приложения с одним клиентом достаточно, чтобы URI кода приложения был уникальным в рамках клиента.</span><span class="sxs-lookup"><span data-stu-id="fd29f-125">For a single tenant application, it is sufficient for the App ID URI to be unique within that tenant.</span></span>  <span data-ttu-id="fd29f-126">Для мультитенантного приложения он должен быть глобально уникальным, чтобы служба Azure AD могла найти приложение по всем клиентам.</span><span class="sxs-lookup"><span data-stu-id="fd29f-126">For a multi-tenant application, it must be globally unique so Azure AD can find the application across all tenants.</span></span>  <span data-ttu-id="fd29f-127">Глобальная уникальность обеспечивается за счет требования, чтобы URI кода приложения имел имя узла, соответствующее проверенному домену клиента Azure AD.</span><span class="sxs-lookup"><span data-stu-id="fd29f-127">Global uniqueness is enforced by requiring the App ID URI to have a host name that matches a verified domain of the Azure AD tenant.</span></span>  <span data-ttu-id="fd29f-128">Например, если имя клиента — contoso.onmicrosoft.com, то допустимым URI кода приложения будет `https://contoso.onmicrosoft.com/myapp`.</span><span class="sxs-lookup"><span data-stu-id="fd29f-128">For example, if the name of your tenant was contoso.onmicrosoft.com then a valid App ID URI would be `https://contoso.onmicrosoft.com/myapp`.</span></span>  <span data-ttu-id="fd29f-129">Если проверенный домен клиента — `contoso.com`, то допустимым URI кода приложения тоже будет `https://contoso.com/myapp`.</span><span class="sxs-lookup"><span data-stu-id="fd29f-129">If your tenant had a verified domain of `contoso.com`, then a valid App ID URI would also be `https://contoso.com/myapp`.</span></span>  <span data-ttu-id="fd29f-130">Вы не сможете сделать приложение мультитенантным, если URI кода приложения не будет соответствовать этому шаблону.</span><span class="sxs-lookup"><span data-stu-id="fd29f-130">Setting an application as multi-tenant will fail if the App ID URI doesn’t follow this pattern.</span></span>

<span data-ttu-id="fd29f-131">Регистрации собственных клиентов являются мультитенантными по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="fd29f-131">Native client registrations are multi-tenant by default.</span></span>  <span data-ttu-id="fd29f-132">Чтобы сделать регистрацию собственного клиентского приложения мультитенантной, не нужно предпринимать каких-либо действий.</span><span class="sxs-lookup"><span data-stu-id="fd29f-132">You don’t need to take any action to make a native client application registration multi-tenant.</span></span>

## <a name="update-your-code-to-send-requests-to-common"></a><span data-ttu-id="fd29f-133">Обновление кода для отправки запросов в конечную точку "/common"</span><span class="sxs-lookup"><span data-stu-id="fd29f-133">Update your code to send requests to /common</span></span>
<span data-ttu-id="fd29f-134">В приложении с одним клиентом запросы на вход отправляются в конечную точку входа клиента.</span><span class="sxs-lookup"><span data-stu-id="fd29f-134">In a single tenant application, sign-in requests are sent to the tenant’s sign-in endpoint.</span></span> <span data-ttu-id="fd29f-135">Например, для contoso.onmicrosoft.com конечная точка имела бы следующий вид:</span><span class="sxs-lookup"><span data-stu-id="fd29f-135">For example, for contoso.onmicrosoft.com the endpoint would be:</span></span>

    https://login.microsoftonline.com/contoso.onmicrosoft.com

<span data-ttu-id="fd29f-136">Запросы, отправленные в конечную точку клиента, могут выполнять вход пользователей (или гостей) этого клиента в приложения этого клиента.</span><span class="sxs-lookup"><span data-stu-id="fd29f-136">Requests sent to a tenant’s endpoint can sign in users (or guests) in that tenant to applications in that tenant.</span></span>  <span data-ttu-id="fd29f-137">Если используется мультитенантное приложение, то оно не знает заранее, из какого клиента тот или иной пользователь, поэтому невозможно отправить запрос в конечную точку клиента.</span><span class="sxs-lookup"><span data-stu-id="fd29f-137">With a multi-tenant application, the application doesn’t know up front what tenant the user is from, so you can’t send requests to a tenant’s endpoint.</span></span>  <span data-ttu-id="fd29f-138">Вместо этого запросы отправляются в конечную точку, которая мультиплексируется по всем клиентам Azure AD:</span><span class="sxs-lookup"><span data-stu-id="fd29f-138">Instead, requests are sent to an endpoint that multiplexes across all Azure AD tenants:</span></span>

    https://login.microsoftonline.com/common

<span data-ttu-id="fd29f-139">Когда служба Azure AD получает запрос в конечной точке "/common", она выполняет вход пользователя и, как следствие, выясняет, из какого клиента этот пользователь.</span><span class="sxs-lookup"><span data-stu-id="fd29f-139">When Azure AD receives a request on the /common endpoint, it signs the user in and as a consequence discovers which tenant the user is from.</span></span>  <span data-ttu-id="fd29f-140">Конечная точка /common работает со всеми протоколами проверки подлинности, поддерживаемыми Azure AD: OpenID Connect, OAuth 2.0, SAML 2.0 и WS-Federation.</span><span class="sxs-lookup"><span data-stu-id="fd29f-140">The /common endpoint works with all of the authentication protocols supported by Azure AD:  OpenID Connect, OAuth 2.0, SAML 2.0, and WS-Federation.</span></span>

<span data-ttu-id="fd29f-141">Ответ приложению на вход содержит маркер, представляющий пользователя.</span><span class="sxs-lookup"><span data-stu-id="fd29f-141">The sign-in response to the application then contains a token representing the user.</span></span>  <span data-ttu-id="fd29f-142">Значение издателя в маркере сообщает приложению, из какого клиента этот пользователь.</span><span class="sxs-lookup"><span data-stu-id="fd29f-142">The issuer value in the token tells an application what tenant the user is from.</span></span>  <span data-ttu-id="fd29f-143">Когда из конечной точки "/common" возвращается ответ, значение издателя в маркере соответствует клиенту пользователя.</span><span class="sxs-lookup"><span data-stu-id="fd29f-143">When a response returns from the /common endpoint, the issuer value in the token will correspond to the user’s tenant.</span></span>  <span data-ttu-id="fd29f-144">Важно отметить, что конечная точка "/common" — это просто мультиплексор, а не клиент или издатель.</span><span class="sxs-lookup"><span data-stu-id="fd29f-144">It’s important to note the /common endpoint is not a tenant and is not an issuer, it’s just a multiplexer.</span></span>  <span data-ttu-id="fd29f-145">Учитывая этот факт, при использовании "/common" логику проверки маркеров в приложении необходимо обновить.</span><span class="sxs-lookup"><span data-stu-id="fd29f-145">When using /common, the logic in your application to validate tokens needs to be updated to take this into account.</span></span> 

<span data-ttu-id="fd29f-146">Как упоминалось ранее, мультитенантные приложения также должны предоставлять согласованную процедуру входа для пользователей. Эта процедура должна соответствовать рекомендациям по фирменной символике приложений Azure AD.</span><span class="sxs-lookup"><span data-stu-id="fd29f-146">As mentioned earlier, multi-tenant applications should also provide a consistent sign-in experience for users, following the Azure AD application branding guidelines.</span></span> <span data-ttu-id="fd29f-147">Чтобы узнать больше о добавлении фирменной символики в приложение, нажмите кнопку ниже.</span><span class="sxs-lookup"><span data-stu-id="fd29f-147">Click the following button to learn more about branding your application.</span></span>

<span data-ttu-id="fd29f-148">[![Sign in button][AAD-Sign-In]][AAD-App-Branding]</span><span class="sxs-lookup"><span data-stu-id="fd29f-148">[![Sign in button][AAD-Sign-In]][AAD-App-Branding]</span></span>

<span data-ttu-id="fd29f-149">Рассмотрим подробнее реализацию вашего кода и использование конечной точки /common.</span><span class="sxs-lookup"><span data-stu-id="fd29f-149">Let’s take a look at the use of the /common endpoint and your code implementation in more detail.</span></span>

## <a name="update-your-code-to-handle-multiple-issuer-values"></a><span data-ttu-id="fd29f-150">Обновите код для обработки нескольких значений издателя.</span><span class="sxs-lookup"><span data-stu-id="fd29f-150">Update your code to handle multiple issuer values</span></span>
<span data-ttu-id="fd29f-151">Веб-приложения и веб-API получают маркеры из Azure AD и там же выполняют их проверку.</span><span class="sxs-lookup"><span data-stu-id="fd29f-151">Web applications and web APIs receive and validate tokens from Azure AD.</span></span>  

> [!NOTE]
> <span data-ttu-id="fd29f-152">А собственные клиентские приложения запрашивают и получают маркеры из Azure AD, чтобы затем отправить их в API, где они проходят проверку.</span><span class="sxs-lookup"><span data-stu-id="fd29f-152">While native client applications request and receive tokens from Azure AD, they do so to send them to APIs, where they are validated.</span></span>  <span data-ttu-id="fd29f-153">Собственные приложения не проверяют маркеры и воспринимают их как непрозрачные.</span><span class="sxs-lookup"><span data-stu-id="fd29f-153">Native applications do not validate tokens and must treat them as opaque.</span></span>
> 
> 

<span data-ttu-id="fd29f-154">Давайте посмотрим, как приложение проверяет маркеры, полученные из Azure AD.</span><span class="sxs-lookup"><span data-stu-id="fd29f-154">Let’s look at how an application validates tokens it receives from Azure AD.</span></span>  <span data-ttu-id="fd29f-155">Однотенантное приложение обычно принимает значение конечной точки, подобное этому:</span><span class="sxs-lookup"><span data-stu-id="fd29f-155">A single tenant application will normally take an endpoint value like:</span></span>

    https://login.microsoftonline.com/contoso.onmicrosoft.com

<span data-ttu-id="fd29f-156">Оно используется для формирования URL-адреса метаданных (в данном случае — OpenID Connect), например:</span><span class="sxs-lookup"><span data-stu-id="fd29f-156">and use it to construct a metadata URL (in this case, OpenID Connect) like:</span></span>

    https://login.microsoftonline.com/contoso.onmicrosoft.com/.well-known/openid-configuration

<span data-ttu-id="fd29f-157">С его помощью скачиваются два критически важных фрагмента данных, используемые для проверки маркеров: значение издателя и ключи подписи клиента.</span><span class="sxs-lookup"><span data-stu-id="fd29f-157">to download two critical pieces of information that are used to validate tokens:  the tenant’s signing keys and issuer value.</span></span>  <span data-ttu-id="fd29f-158">Каждый клиент Azure AD имеет уникальное значение издателя, которое можно представить в такой форме:</span><span class="sxs-lookup"><span data-stu-id="fd29f-158">Each Azure AD tenant has a unique issuer value of the form:</span></span>

    https://sts.windows.net/31537af4-6d77-4bb9-a681-d2394888ea26/

<span data-ttu-id="fd29f-159">где значение GUID — это версия кода клиента, защищенная от переименования.</span><span class="sxs-lookup"><span data-stu-id="fd29f-159">where the GUID value is the rename-safe version of the tenant ID of the tenant.</span></span>  <span data-ttu-id="fd29f-160">Если щелкнуть предыдущую ссылку на метаданные для `contoso.onmicrosoft.com`, то вы увидите это значение издателя в документе.</span><span class="sxs-lookup"><span data-stu-id="fd29f-160">If you click on the preceding metadata link for `contoso.onmicrosoft.com`, you can see this issuer value in the document.</span></span>

<span data-ttu-id="fd29f-161">Когда приложение с одним клиентом проверяет токен, оно сверяет подпись токена с ключами подписи из документа метаданных.</span><span class="sxs-lookup"><span data-stu-id="fd29f-161">When a single tenant application validates a token, it checks the signature of the token against the signing keys from the metadata document.</span></span> <span data-ttu-id="fd29f-162">Это позволит убедиться, что значение издателя в токене соответствует значению в документе метаданных.</span><span class="sxs-lookup"><span data-stu-id="fd29f-162">This allows it to make sure the issuer value in the token matches the one that was found in the metadata document.</span></span>

<span data-ttu-id="fd29f-163">Так как конечная точка "/common" не соответствует клиенту и не является издателем, то при проверке значения издателя в метаданных для точки "/common" вместо фактического значения отображается шаблон URL-адреса:</span><span class="sxs-lookup"><span data-stu-id="fd29f-163">Since the /common endpoint doesn’t correspond to a tenant and isn’t an issuer, when you examine the issuer value in the metadata for /common it has a templated URL instead of an actual value:</span></span>

    https://sts.windows.net/{tenantid}/

<span data-ttu-id="fd29f-164">Таким образом, мультитенантное приложение не может проверить маркеры, просто сопоставив значение издателя в метаданных со значением `issuer` в маркере.</span><span class="sxs-lookup"><span data-stu-id="fd29f-164">Therefore, a multi-tenant application can’t validate tokens just by matching the issuer value in the metadata with the `issuer` value in the token.</span></span>  <span data-ttu-id="fd29f-165">Мультитенантному приложению требуется логика, чтобы решить, какие значения издателя являются допустимыми, а какие не являются, исходя из части значения издателя, в которой указан код клиента.</span><span class="sxs-lookup"><span data-stu-id="fd29f-165">A multi-tenant application needs logic to decide which issuer values are valid and which are not, based on the tenant ID portion of the issuer value.</span></span>  

<span data-ttu-id="fd29f-166">Например, если мультитенантное приложение разрешает вход только из определенных клиентов, которые зарегистрировались в службе, то оно должно проверить значение издателя или значение утверждения `tid` в токене, чтобы убедиться, что этот клиент внесен в его список подписчиков.</span><span class="sxs-lookup"><span data-stu-id="fd29f-166">For example, if a multi-tenant application only allows sign-in from specific tenants who have signed up for their service, then it must check either the issuer value or the `tid` claim value in the token to make sure that tenant is in their list of subscribers.</span></span>  <span data-ttu-id="fd29f-167">Если мультитенантное приложение работает только с отдельными пользователями и не принимает решений о доступе на основе данных клиентов, то оно может полностью игнорировать значение издателя.</span><span class="sxs-lookup"><span data-stu-id="fd29f-167">If a multi-tenant application only deals with individuals and doesn’t make any access decisions based on tenants, then it can ignore the issuer value altogether.</span></span>

<span data-ttu-id="fd29f-168">В примерах мультитенантных приложений, которые можно найти в разделе [Связанная информация](#related-content) в конце этой статьи, проверка издателя отключена, чтобы можно было включить возможность входа для любого клиента Azure AD.</span><span class="sxs-lookup"><span data-stu-id="fd29f-168">In the multi-tenant samples in the [Related Content](#related-content) section at the end of this article, issuer validation is disabled to enable any Azure AD tenant to sign in.</span></span>

<span data-ttu-id="fd29f-169">Теперь давайте взглянем на то, как осуществляется вход пользователей в мультитенантные приложения.</span><span class="sxs-lookup"><span data-stu-id="fd29f-169">Now let’s look at the user experience for users that are signing in to multi-tenant applications.</span></span>

## <a name="understanding-user-and-admin-consent"></a><span data-ttu-id="fd29f-170">Получение согласия пользователя и администратора</span><span class="sxs-lookup"><span data-stu-id="fd29f-170">Understanding user and admin consent</span></span>
<span data-ttu-id="fd29f-171">Чтобы пользователь мог войти в приложение в Azure AD, это приложение должно быть представлено в клиенте пользователя.</span><span class="sxs-lookup"><span data-stu-id="fd29f-171">For a user to sign in to an application in Azure AD, the application must be represented in the user’s tenant.</span></span>  <span data-ttu-id="fd29f-172">Это дает возможность организации применять уникальные политики входа в приложение пользователей из клиента.</span><span class="sxs-lookup"><span data-stu-id="fd29f-172">This allows the organization to do things like apply unique policies when users from their tenant sign in to the application.</span></span>  <span data-ttu-id="fd29f-173">Регистрацию для однотенантного приложения легко выполнить. Это та же самая процедура, которая выполняется при регистрации приложения на [портале Azure][AZURE-portal].</span><span class="sxs-lookup"><span data-stu-id="fd29f-173">For a single tenant application, this registration is simple; it’s the one that happens when you register the application in the [Azure portal][AZURE-portal].</span></span>

<span data-ttu-id="fd29f-174">Для мультитенантного приложения его начальная регистрация находится в клиенте Azure AD, используемом разработчиком.</span><span class="sxs-lookup"><span data-stu-id="fd29f-174">For a multi-tenant application, the initial registration for the application lives in the Azure AD tenant used by the developer.</span></span>  <span data-ttu-id="fd29f-175">При первом входе в приложение пользователя из другого клиента Azure AD предлагает принять разрешения, запрошенные приложением.</span><span class="sxs-lookup"><span data-stu-id="fd29f-175">When a user from a different tenant signs in to the application for the first time, Azure AD asks them to consent to the permissions requested by the application.</span></span>  <span data-ttu-id="fd29f-176">Если пользователь соглашается, то в его клиенте создается представление приложения, называемое *субъектом-службой*, после чего можно продолжить вход.</span><span class="sxs-lookup"><span data-stu-id="fd29f-176">If they consent, then a representation of the application called a *service principal* is created in the user’s tenant, and sign-in can continue.</span></span> <span data-ttu-id="fd29f-177">В каталоге также создается делегирование, которое записывает согласие пользователя в приложение.</span><span class="sxs-lookup"><span data-stu-id="fd29f-177">A delegation is also created in the directory that records the user’s consent to the application.</span></span> <span data-ttu-id="fd29f-178">Дополнительные сведения об объектах приложений и объектах субъектов-служб и их взаимосвязи см. в [этой статье][AAD-App-SP-Objects].</span><span class="sxs-lookup"><span data-stu-id="fd29f-178">See [Application Objects and Service Principal Objects][AAD-App-SP-Objects] for details on the application's Application and ServicePrincipal objects, and how they relate to each other.</span></span>

![Разрешения для одноуровневого приложения][Consent-Single-Tier] 

<span data-ttu-id="fd29f-180">Для получения согласия используются разрешения, запрашиваемые приложением.</span><span class="sxs-lookup"><span data-stu-id="fd29f-180">This consent experience is affected by the permissions requested by the application.</span></span>  <span data-ttu-id="fd29f-181">Azure AD поддерживает два типа разрешений: делегированные и только для приложения. Различия между ними описаны ниже.</span><span class="sxs-lookup"><span data-stu-id="fd29f-181">Azure AD supports two kinds of permissions, app-only and delegated:</span></span>

* <span data-ttu-id="fd29f-182">Делегированное разрешение предоставляет приложению возможность выступать в качестве выполнившего вход пользователя и выполнять ряд действий, доступных пользователю.</span><span class="sxs-lookup"><span data-stu-id="fd29f-182">A delegated permission grants an application the ability to act as a signed in user for a subset of the things the user can do.</span></span>  <span data-ttu-id="fd29f-183">Например, можно предоставить приложению делегированное разрешение на чтение календаря выполнившего вход пользователя.</span><span class="sxs-lookup"><span data-stu-id="fd29f-183">For example, you can grant an application the delegated permission to read the signed in user’s calendar.</span></span>
* <span data-ttu-id="fd29f-184">Разрешение "только для приложения" предоставляется непосредственно удостоверению приложения.</span><span class="sxs-lookup"><span data-stu-id="fd29f-184">An app-only permission is granted directly to the identity of the application.</span></span>  <span data-ttu-id="fd29f-185">Например, если предоставить приложению разрешение "только для приложения" на чтение списка пользователей в клиенте, независимо от того, кто выполнил вход в приложение.</span><span class="sxs-lookup"><span data-stu-id="fd29f-185">For example, you can grant an application the app-only permission to read the list of users in a tenant, regardless of who is signed in to the application.</span></span>

<span data-ttu-id="fd29f-186">Некоторые разрешения могут быть приняты обычным пользователем, а для других требуется согласие администратора клиента.</span><span class="sxs-lookup"><span data-stu-id="fd29f-186">Some permissions can be consented to by a regular user, while others require a tenant administrator’s consent.</span></span> 

### <a name="admin-consent"></a><span data-ttu-id="fd29f-187">Согласие администратора</span><span class="sxs-lookup"><span data-stu-id="fd29f-187">Admin consent</span></span>
<span data-ttu-id="fd29f-188">Для разрешений "только для приложения" всегда требуется согласие администратора клиента.</span><span class="sxs-lookup"><span data-stu-id="fd29f-188">App-only permissions always require a tenant administrator’s consent.</span></span>  <span data-ttu-id="fd29f-189">Если приложение запрашивает разрешение "только для приложения" и пользователь пытается войти в него, то в приложении отобразится сообщение об ошибке, информирующее, что пользователь не может принять это разрешение.</span><span class="sxs-lookup"><span data-stu-id="fd29f-189">If your application requests an app-only permission and a user tries to sign in to the application, an error message will be displayed saying the user isn’t able to consent.</span></span>

<span data-ttu-id="fd29f-190">Для некоторых делегированных разрешений также требуется согласие администратора клиента.</span><span class="sxs-lookup"><span data-stu-id="fd29f-190">Certain delegated permissions also require a tenant administrator’s consent.</span></span>  <span data-ttu-id="fd29f-191">Например, оно требуется для возможности обратной записи в Azure AD в качестве выполнившего вход пользователя.</span><span class="sxs-lookup"><span data-stu-id="fd29f-191">For example, the ability to write back to Azure AD as the signed in user requires a tenant administrator’s consent.</span></span>  <span data-ttu-id="fd29f-192">Как и в случае с разрешениями "только для приложения", если обычный пользователь пытается войти в приложение, запрашивающее делегированное разрешение, для которого требуется согласие администратора, то в приложении отобразится сообщение об ошибке.</span><span class="sxs-lookup"><span data-stu-id="fd29f-192">Like app-only permissions, if an ordinary user tries to sign in to an application that requests a delegated permission that requires administrator consent, your application will receive an error.</span></span>  <span data-ttu-id="fd29f-193">Требует ли разрешение согласия администратора определяется разработчиком, опубликовавшим ресурс. Эти сведения можно найти в документации по данному ресурсу.</span><span class="sxs-lookup"><span data-stu-id="fd29f-193">Whether or not a permission requires admin consent is determined by the developer that published the resource, and can be found in the documentation for the resource.</span></span>  <span data-ttu-id="fd29f-194">Ссылки на статьи, описывающие доступные разрешения для API Graph Azure AD и API Microsoft Graph, приведены в разделе [Связанная информация](#related-content) этой статьи.</span><span class="sxs-lookup"><span data-stu-id="fd29f-194">Links to topics describing the available permissions for the Azure AD Graph API and Microsoft Graph API are in the [Related Content](#related-content) section of this article.</span></span>

<span data-ttu-id="fd29f-195">Если приложение использует разрешения, требующие согласия администратора, то в приложении должен быть элемент, такой как кнопка или ссылка, с помощью которого администратор может инициировать действие.</span><span class="sxs-lookup"><span data-stu-id="fd29f-195">If your application uses permissions that require admin consent, you need to have a gesture such as a button or link where the admin can initiate the action.</span></span>  <span data-ttu-id="fd29f-196">Запрос, отправляемый приложением для этого действия, является обычным запросом авторизации OAuth2 или OpenID Connect, но он также включает в себя параметр строки запроса `prompt=admin_consent` .</span><span class="sxs-lookup"><span data-stu-id="fd29f-196">The request your application sends for this action is a usual OAuth2/OpenID Connect authorization request, but that also includes the `prompt=admin_consent` query string parameter.</span></span>  <span data-ttu-id="fd29f-197">После того как администратор предоставит свое согласие, а в клиенте пользователя будет создан субъект-служба, в последующих запросах входа не нужно будет указывать параметр `prompt=admin_consent`.</span><span class="sxs-lookup"><span data-stu-id="fd29f-197">Once the admin has consented and the service principal is created in the customer’s tenant, subsequent sign-in requests do not need the `prompt=admin_consent` parameter.</span></span> <span data-ttu-id="fd29f-198">Когда администратор решил, что запрошенные разрешения являются приемлемыми, то с этого момента у других пользователей в клиенте согласие запрашиваться не будет.</span><span class="sxs-lookup"><span data-stu-id="fd29f-198">Since the administrator has decided the requested permissions are acceptable, no other users in the tenant will be prompted for consent from that point forward.</span></span>

<span data-ttu-id="fd29f-199">Параметр `prompt=admin_consent` может использоваться приложениями, запрашивающими разрешения, которые не требуют согласия администратора.</span><span class="sxs-lookup"><span data-stu-id="fd29f-199">The `prompt=admin_consent` parameter can also be used by applications that request permissions that do not require admin consent.</span></span> <span data-ttu-id="fd29f-200">Это делается, если приложению требуется возможность одноразовой регистрации администратора клиента, после которой у других пользователей согласие не запрашивается.</span><span class="sxs-lookup"><span data-stu-id="fd29f-200">This is done when the applicaton requires an experience where the tenant admin “signs up” one time, and no other users are prompted for consent from that point on.</span></span>

<span data-ttu-id="fd29f-201">Если приложению требуется разрешение администратора и администратор выполняет вход, но параметр `prompt=admin_consent` не передается, администратор успешно предоставит согласие **только для своей учетной записи пользователя**.</span><span class="sxs-lookup"><span data-stu-id="fd29f-201">If an application requires admin consent, and an admin signs in but the `prompt=admin_consent` parameter is not sent, the admin will successfully consent to the application **only for their user account**.</span></span>  <span data-ttu-id="fd29f-202">Обычные пользователи по-прежнему не смогут выполнять вход и давать свое согласие приложению.</span><span class="sxs-lookup"><span data-stu-id="fd29f-202">Regular users will still not be able to sign in and consent to the application.</span></span>  <span data-ttu-id="fd29f-203">Это полезно, если требуется предоставить администратору клиента возможность просмотреть приложение, прежде чем предоставлять доступ другим пользователям.</span><span class="sxs-lookup"><span data-stu-id="fd29f-203">This is useful if you want to give the tenant administrator the ability to explore your application before allowing other users access.</span></span>

<span data-ttu-id="fd29f-204">Администратор клиента может отключить возможность обычным пользователям предоставлять согласие для приложений.</span><span class="sxs-lookup"><span data-stu-id="fd29f-204">A tenant administrator can disable the ability for regular users to consent to applications.</span></span>  <span data-ttu-id="fd29f-205">Если эта возможность отключена, то для настройки приложения в клиенте всегда требуется согласие администратора.</span><span class="sxs-lookup"><span data-stu-id="fd29f-205">If this capability is disabled, admin consent is always required for the application to be set up in the tenant.</span></span>  <span data-ttu-id="fd29f-206">Чтобы протестировать приложение, в котором отключена возможность предоставления согласия для обычных пользователей, найдите соответствующий параметр в разделе конфигурации клиента Azure AD на [портале Azure][AZURE-portal].</span><span class="sxs-lookup"><span data-stu-id="fd29f-206">If you want to test your application with regular user consent disabled, you can find the configuration switch in the Azure AD tenant configuration section of the [Azure portal][AZURE-portal].</span></span>

> [!NOTE]
> <span data-ttu-id="fd29f-207">В некоторых приложениях применяется следующая практика: сначала свое согласие имеют возможность предоставить обычные пользователи, а затем приложение может привлечь администратора и запросить разрешения, для которых требуется его согласие.</span><span class="sxs-lookup"><span data-stu-id="fd29f-207">Some applications want an experience where regular users are able to consent initially, and later the application can involve the administrator and request permissions that require admin consent.</span></span>  <span data-ttu-id="fd29f-208">При регистрации однотенантного приложения такая возможность в Azure AD в данный момент отсутствует.</span><span class="sxs-lookup"><span data-stu-id="fd29f-208">There is no way to do this with a single application registration in Azure AD today.</span></span>  <span data-ttu-id="fd29f-209">Предстоящий выпуск конечной точки Azure AD версии 2.0 позволит приложениям запрашивать разрешения в среде выполнения, а не во время регистрации, что даст возможность реализовать этот сценарий.</span><span class="sxs-lookup"><span data-stu-id="fd29f-209">The upcoming Azure AD v2 endpoint will allow applications to request permissions at runtime, instead of at registration time, which will enable this scenario.</span></span>  <span data-ttu-id="fd29f-210">Дополнительные сведения см. в статье [Вход для пользователей учетных записей Майкрософт и Azure AD в одном приложении][AAD-V2-Dev-Guide].</span><span class="sxs-lookup"><span data-stu-id="fd29f-210">For more information, see the [Azure AD App Model v2 Developer Guide][AAD-V2-Dev-Guide].</span></span>
> 
> 

### <a name="consent-and-multi-tier-applications"></a><span data-ttu-id="fd29f-211">Согласие и многоуровневые приложения</span><span class="sxs-lookup"><span data-stu-id="fd29f-211">Consent and multi-tier applications</span></span>
<span data-ttu-id="fd29f-212">Приложение может иметь несколько уровней, каждый из которых представлен в Azure AD собственной регистрацией.</span><span class="sxs-lookup"><span data-stu-id="fd29f-212">Your application may have multiple tiers, each represented by its own registration in Azure AD.</span></span>  <span data-ttu-id="fd29f-213">Например, собственное приложение, выполняющее вызовы веб-API, или веб-приложение, выполняющее вызовы веб-API.</span><span class="sxs-lookup"><span data-stu-id="fd29f-213">For example, a native application that calls a web API, or a web application that calls a web API.</span></span>  <span data-ttu-id="fd29f-214">В обоих случаях клиент (собственное приложение или веб-приложение) запрашивает разрешения на вызов ресурса (веб-API).</span><span class="sxs-lookup"><span data-stu-id="fd29f-214">In both of these cases, the client (native app or web app) requests permissions to call the resource (web API).</span></span>  <span data-ttu-id="fd29f-215">Чтобы клиент мог получить согласие от клиента пользователя, все ресурсы, к которым он запрашивает разрешения, должны существовать в клиенте пользователя.</span><span class="sxs-lookup"><span data-stu-id="fd29f-215">For the client to be successfully consented into a customer’s tenant, all resources to which it requests permissions must already exist in the customer’s tenant.</span></span>  <span data-ttu-id="fd29f-216">Если это условие не выполняется, то Azure AD выдаст ошибку и сообщит, что сначала необходимо добавить ресурс.</span><span class="sxs-lookup"><span data-stu-id="fd29f-216">If this condition isn’t met, Azure AD will return an error that the resource must be added first.</span></span>

<span data-ttu-id="fd29f-217">**Несколько уровней в одном клиенте**</span><span class="sxs-lookup"><span data-stu-id="fd29f-217">**Multiple tiers in a single tenant**</span></span>

<span data-ttu-id="fd29f-218">Это может быть проблемой, если ваше логические приложение состоит из двух или более регистраций приложения, например, отдельно для клиента и ресурса.</span><span class="sxs-lookup"><span data-stu-id="fd29f-218">This can be a problem if your logical application consists of two or more application registrations, for example a separate client and resource.</span></span>  <span data-ttu-id="fd29f-219">Как сначала поместить ресурс в клиент пользователя?</span><span class="sxs-lookup"><span data-stu-id="fd29f-219">How do you get the resource into the customer tenant first?</span></span>  <span data-ttu-id="fd29f-220">На этот случай в Azure AD предусмотрена возможность получения согласия для клиента и ресурса за один шаг.</span><span class="sxs-lookup"><span data-stu-id="fd29f-220">Azure AD covers this case by enabling client and resource to be consented in a single step.</span></span> <span data-ttu-id="fd29f-221">Пользователь видит общее число разрешений, запрошенных клиентом и ресурсом на странице получения согласия.</span><span class="sxs-lookup"><span data-stu-id="fd29f-221">The user sees the sum total of the permissions requested by both the client and resource on the consent page.</span></span>  <span data-ttu-id="fd29f-222">Чтобы активировать такое поведение, регистрация приложения ресурса должна включать в себя идентификатор приложения клиента как `knownClientApplications` в манифесте соответствующего приложения.</span><span class="sxs-lookup"><span data-stu-id="fd29f-222">To enable this behavior, the resource’s application registration must include the client’s App ID as a `knownClientApplications` in its application manifest.</span></span>  <span data-ttu-id="fd29f-223">Например:</span><span class="sxs-lookup"><span data-stu-id="fd29f-223">For example:</span></span>

    knownClientApplications": ["94da0930-763f-45c7-8d26-04d5938baab2"]

<span data-ttu-id="fd29f-224">Это свойство можно обновить с помощью [манифеста приложения][AAD-App-Manifest] ресурса.</span><span class="sxs-lookup"><span data-stu-id="fd29f-224">This property can be updated via the resource [application’s manifest][AAD-App-Manifest].</span></span> <span data-ttu-id="fd29f-225">Это демонстрируется в примере многоуровневого собственного клиента, выполняющего вызов веб-API, в разделе [Связанная информация](#related-content) в конце этой статьи.</span><span class="sxs-lookup"><span data-stu-id="fd29f-225">This is demonstrated in a multi-tier native client calling web API sample in the [Related Content](#related-content) section at the end of this article.</span></span> <span data-ttu-id="fd29f-226">На следующей схеме представлен обзор согласия для многоуровневого приложения, зарегистрированного в одном клиенте:</span><span class="sxs-lookup"><span data-stu-id="fd29f-226">The following diagram provides an overview of consent for a multi-tier app registered in a single tenant :</span></span>

![Разрешения для известного многоуровневого приложения][Consent-Multi-Tier-Known-Client] 

<span data-ttu-id="fd29f-228">**Несколько уровней в нескольких клиентах**</span><span class="sxs-lookup"><span data-stu-id="fd29f-228">**Multiple tiers in multiple tenants**</span></span>

<span data-ttu-id="fd29f-229">Аналогичная ситуация складывается, когда различные уровни приложения регистрируются в разных клиентах.</span><span class="sxs-lookup"><span data-stu-id="fd29f-229">A similar case happens if the different tiers of an application are registered in different tenants.</span></span>  <span data-ttu-id="fd29f-230">Например, рассмотрим случай создания собственного клиентского приложения, выполняющего вызов API Office 365 Exchange Online.</span><span class="sxs-lookup"><span data-stu-id="fd29f-230">For example, consider the case of building a native client application that calls the Office 365 Exchange Online API.</span></span>  <span data-ttu-id="fd29f-231">Для разработки собственного приложения, а затем и для его запуска в клиенте пользователя необходимо наличие субъекта-службы Exchange Online.</span><span class="sxs-lookup"><span data-stu-id="fd29f-231">To develop the native application, and later for the native application to run in a customer’s tenant, the Exchange Online service principal must be present.</span></span>  <span data-ttu-id="fd29f-232">В этом случае разработчик и пользователь должен приобрести Exchange Online, чтобы в их клиентах был создан субъект-служба.</span><span class="sxs-lookup"><span data-stu-id="fd29f-232">In this case, the developer and customer must purchase Exchange Online for the service principal to be created in their tenants.</span></span>  

<span data-ttu-id="fd29f-233">Если используется API, созданный не Майкрософт, а иной организацией, то разработчик API должен предоставить пользователям возможность получать согласие на связь своего приложения с клиентом пользователя.</span><span class="sxs-lookup"><span data-stu-id="fd29f-233">In the case of an API built by an organization other than Microsoft, the developer of the API needs to provide a way for their customers to consent the application into their customers' tenants.</span></span> <span data-ttu-id="fd29f-234">Рекомендуемая конфигурация предназначена для стороннего разработчика для создания API, которое могло бы также выполнять роль веб-клиента для реализации регистрации:</span><span class="sxs-lookup"><span data-stu-id="fd29f-234">The recommended design is for the 3rd party developer to build the API such that it can also function as a web client to implement sign-up :</span></span>

1. <span data-ttu-id="fd29f-235">Выполните действия из предыдущих разделов, чтобы убедиться, что API реализует требования к регистрации и коду мультитенантного приложения.</span><span class="sxs-lookup"><span data-stu-id="fd29f-235">Follow the earlier sections to ensure the API implements the multi-tenant application registration/code requirements</span></span>
2. <span data-ttu-id="fd29f-236">Указав области и роли API, убедитесь, что регистрация включает в себя разрешение Azure AD "Вход и чтение профиля пользователя" (предоставляется по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="fd29f-236">In addition to exposing the API's scopes/roles, ensure the registration includes the "Sign in and read user profile" Azure AD permission (provided by default)</span></span>
3. <span data-ttu-id="fd29f-237">Создайте страницу входа и регистрации в веб-клиенте, следуя инструкциям рассмотренного ранее руководства по [согласию администратора](#admin-consent).</span><span class="sxs-lookup"><span data-stu-id="fd29f-237">Implement a sign-in/sign-up page in the web client, following the [admin consent](#admin-consent) guidance discussed earlier</span></span> 
4. <span data-ttu-id="fd29f-238">После того как пользователь предоставит свое согласие в приложении, в клиенте создаются субъект-служба и ссылки на делегирование согласия, а собственное приложение может получать токены для API.</span><span class="sxs-lookup"><span data-stu-id="fd29f-238">Once the user consents to the application, the service principal and consent delegation links are created in their tenant, and the native application can get tokens for the API</span></span>

<span data-ttu-id="fd29f-239">На следующей схеме представлен обзор согласия для многоуровневого приложения, зарегистрированного в разных клиентах:</span><span class="sxs-lookup"><span data-stu-id="fd29f-239">The following diagram provides an overview of consent for a multi-tier app registered in different tenants:</span></span>

![Разрешения для многоуровневого приложения c несколькими участниками][Consent-Multi-Tier-Multi-Party] 

### <a name="revoking-consent"></a><span data-ttu-id="fd29f-241">Отзыв согласия</span><span class="sxs-lookup"><span data-stu-id="fd29f-241">Revoking Consent</span></span>
<span data-ttu-id="fd29f-242">Пользователи и администраторы в любой момент могут отозвать свое согласие, предоставленное приложению.</span><span class="sxs-lookup"><span data-stu-id="fd29f-242">Users and administrators can revoke consent to your application at any time:</span></span>

* <span data-ttu-id="fd29f-243">Чтобы отозвать доступ к отдельным приложениям, пользователям необходимо удалить их из списка [Приложения панели доступа][AAD-Access-Panel].</span><span class="sxs-lookup"><span data-stu-id="fd29f-243">Users revoke access to individual applications by removing them from their [Access Panel Applications][AAD-Access-Panel] list.</span></span>
* <span data-ttu-id="fd29f-244">Администраторы могут отозвать доступ к приложениям, удалив их из Azure AD с помощью раздела управления на [портале Azure][AZURE-portal].</span><span class="sxs-lookup"><span data-stu-id="fd29f-244">Administrators revoke access to applications by removing them from Azure AD using the Azure AD management section of the [Azure portal][AZURE-portal].</span></span>

<span data-ttu-id="fd29f-245">Если администратор дает свое согласие на доступ к приложению для всех пользователей в клиенте, то пользователи не могут отзывать доступ индивидуально.</span><span class="sxs-lookup"><span data-stu-id="fd29f-245">If an administrator consents to an application for all users in a tenant, users cannot revoke access individually.</span></span>  <span data-ttu-id="fd29f-246">В этом случае отозвать доступ может только администратор и только для всего приложения.</span><span class="sxs-lookup"><span data-stu-id="fd29f-246">Only the administrator can revoke access, and only for the whole application.</span></span>

### <a name="consent-and-protocol-support"></a><span data-ttu-id="fd29f-247">Согласие и поддерживаемые протоколы</span><span class="sxs-lookup"><span data-stu-id="fd29f-247">Consent and Protocol Support</span></span>
<span data-ttu-id="fd29f-248">Процедура получения согласия в Azure AD поддерживается для протоколов OAuth, OpenID Connect, WS-Federation и SAML.</span><span class="sxs-lookup"><span data-stu-id="fd29f-248">Consent is supported in Azure AD via the OAuth, OpenID Connect, WS-Federation, and SAML protocols.</span></span>  <span data-ttu-id="fd29f-249">Протоколы SAML и WS-Federation не поддерживают параметр `prompt=admin_consent` , поэтому получение согласия администратора возможно только с использованием протоколов OAuth и OpenID Connect.</span><span class="sxs-lookup"><span data-stu-id="fd29f-249">The SAML and WS-Federation protocols do not support the `prompt=admin_consent` parameter, so admin consent is only possible via OAuth and OpenID Connect.</span></span>

## <a name="multi-tenant-applications-and-caching-access-tokens"></a><span data-ttu-id="fd29f-250">Мультитенантные приложения и кэширование маркеров доступа</span><span class="sxs-lookup"><span data-stu-id="fd29f-250">Multi-Tenant Applications and Caching Access Tokens</span></span>
<span data-ttu-id="fd29f-251">Мультитенантные приложения также могут получать маркеры доступа для вызова API, защищенных службой Azure AD.</span><span class="sxs-lookup"><span data-stu-id="fd29f-251">Multi-tenant applications can also get access tokens to call APIs that are protected by Azure AD.</span></span>  <span data-ttu-id="fd29f-252">Распространенной ошибкой при использовании библиотеки проверки подлинности Active Directory (ADAL) с мультитенантным приложением является начальный запрос токена для пользователя с помощью точки /common, получение ответа, а затем запрос последующего токена для того же пользователя с помощью той же точки /common.</span><span class="sxs-lookup"><span data-stu-id="fd29f-252">A common error when using the Active Directory Authentication Library (ADAL) with a multi-tenant application, is to initially request a token for a user using /common, receive a response, then request a subsequent token for that same user also using /common.</span></span>  <span data-ttu-id="fd29f-253">Так как ответ от Azure AD приходит из клиента, а не из "/common", то ADAL кэширует маркер как полученный из клиента.</span><span class="sxs-lookup"><span data-stu-id="fd29f-253">Since the response from Azure AD comes from a tenant, not /common, ADAL caches the token as being from the tenant.</span></span> <span data-ttu-id="fd29f-254">Последующий вызов точки "/common" для получения маркера доступа для пользователя не записывается в кэш (происходит промах кэша), и пользователю предлагается выполнить вход повторно.</span><span class="sxs-lookup"><span data-stu-id="fd29f-254">The subsequent call to /common to get an access token for the user misses the cache entry, and the user is prompted to sign in again.</span></span>  <span data-ttu-id="fd29f-255">Во избежание промахов кэша убедитесь, что последующие вызовы для выполнившего вход пользователя осуществляются в конечную точку клиента.</span><span class="sxs-lookup"><span data-stu-id="fd29f-255">To avoid missing the cache, make sure subsequent calls for an already signed in user are made to the tenant’s endpoint.</span></span>

## <a name="next-steps"></a><span data-ttu-id="fd29f-256">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="fd29f-256">Next steps</span></span>
<span data-ttu-id="fd29f-257">В этой статье было показано, как создать приложение, поддерживающее вход пользователя с любого клиента Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="fd29f-257">In this article, you learned how to build an application that can sign in a user from any Azure Active Directory tenant.</span></span> <span data-ttu-id="fd29f-258">После включения единого входа между своим приложением и Azure Active Directory вы также можете обновить приложение для доступа к API, которые предоставляются ресурсами Майкрософт, например Office 365.</span><span class="sxs-lookup"><span data-stu-id="fd29f-258">After enabling Single Sign-On between your app and Azure Active Directory, you can also update your application to access APIs exposed by Microsoft resources, like Office 365.</span></span> <span data-ttu-id="fd29f-259">Это позволит вам предлагать своим пользователям персонализированные возможности при работе с приложением, например отображать контекстную информацию, такую как изображение профиля или следующая встреча из календаря.</span><span class="sxs-lookup"><span data-stu-id="fd29f-259">So you can offer a personalized experience in your application, for example showing contextual information to the users, like their profile picture or their next calendar appointment.</span></span> <span data-ttu-id="fd29f-260">Дополнительные сведения о вызовах API к службам Azure Active Directory и Office 365 (например Exchange, SharePoint, OneDrive, OneNote, Планировщик, Excel и др.) см. в статье [Overview of Microsoft Graph][MSFT-Graph-overview] (Обзор Microsoft Graph).</span><span class="sxs-lookup"><span data-stu-id="fd29f-260">To learn more about making API calls to Azure Active Directory and Office 365 services like Exchange, SharePoint, OneDrive, OneNote, Planner, Excel and more, visit: [Microsoft Graph API][MSFT-Graph-overview].</span></span>


## <a name="related-content"></a><span data-ttu-id="fd29f-261">Связанная информация</span><span class="sxs-lookup"><span data-stu-id="fd29f-261">Related content</span></span>
* <span data-ttu-id="fd29f-262">[Примеры мультитенантных приложений][AAD-Samples-MT]</span><span class="sxs-lookup"><span data-stu-id="fd29f-262">[Multi-tenant application samples][AAD-Samples-MT]</span></span>
* <span data-ttu-id="fd29f-263">[Рекомендации по фирменной символике для приложений][AAD-App-Branding]</span><span class="sxs-lookup"><span data-stu-id="fd29f-263">[Branding Guidelines for Applications][AAD-App-Branding]</span></span>
* <span data-ttu-id="fd29f-264">[Руководство разработчика по Azure Active Directory][AAD-Dev-Guide]</span><span class="sxs-lookup"><span data-stu-id="fd29f-264">[Azure AD Developer's Guide][AAD-Dev-Guide]</span></span>
* <span data-ttu-id="fd29f-265">[Объекты приложения и субъекта-службы в Azure Active Directory][AAD-App-SP-Objects]</span><span class="sxs-lookup"><span data-stu-id="fd29f-265">[Application Objects and Service Principal Objects][AAD-App-SP-Objects]</span></span>
* <span data-ttu-id="fd29f-266">[Интеграция приложений с Azure Active Directory][AAD-Integrating-Apps]</span><span class="sxs-lookup"><span data-stu-id="fd29f-266">[Integrating Applications with Azure Active Directory][AAD-Integrating-Apps]</span></span>
* <span data-ttu-id="fd29f-267">[Обзор платформы согласия][AAD-Consent-Overview]</span><span class="sxs-lookup"><span data-stu-id="fd29f-267">[Overview of the Consent Framework][AAD-Consent-Overview]</span></span>
* <span data-ttu-id="fd29f-268">[Microsoft Graph permission scopes (Области действия разрешений Microsoft Graph)][MSFT-Graph-permision-scopes]</span><span class="sxs-lookup"><span data-stu-id="fd29f-268">[Microsoft Graph API Permission Scopes][MSFT-Graph-permision-scopes]</span></span>
* <span data-ttu-id="fd29f-269">[Области разрешений | Основные понятия API Graph][AAD-Graph-Perm-Scopes]</span><span class="sxs-lookup"><span data-stu-id="fd29f-269">[Azure AD Graph API Permission Scopes][AAD-Graph-Perm-Scopes]</span></span>

<span data-ttu-id="fd29f-270">Оставляйте свои замечания и пожелания в разделе ниже. Они помогают нам улучшать содержимое веб-сайта.</span><span class="sxs-lookup"><span data-stu-id="fd29f-270">Please use the following comments section to provide feedback and help us refine and shape our content.</span></span>

<!--Reference style links IN USE -->
[AAD-Access-Panel]:  https://myapps.microsoft.com
[AAD-App-Branding]: ./active-directory-branding-guidelines.md
[AAD-App-Manifest]: ./active-directory-application-manifest.md
[AAD-App-SP-Objects]: ./active-directory-application-objects.md
[AAD-Auth-Scenarios]: ./active-directory-authentication-scenarios.md
[AAD-Consent-Overview]: ./active-directory-integrating-applications.md#overview-of-the-consent-framework
[AAD-Dev-Guide]: ./active-directory-developers-guide.md
[AAD-Graph-Overview]: https://azure.microsoft.com/en-us/documentation/articles/active-directory-graph-api/
[AAD-Graph-Perm-Scopes]: https://msdn.microsoft.com/library/azure/ad/graph/howto/azure-ad-graph-api-permission-scopes
[AAD-Integrating-Apps]: ./active-directory-integrating-applications.md
[AAD-Samples-MT]: https://azure.microsoft.com/documentation/samples/?service=active-directory&term=multitenant
[AAD-Why-To-Integrate]: ./active-directory-how-to-integrate.md
[AZURE-portal]: https://portal.azure.com
[MSFT-Graph-overview]: https://graph.microsoft.io/en-us/docs/overview/overview
[MSFT-Graph-permision-scopes]: https://graph.microsoft.io/en-us/docs/authorization/permission_scopes

<!--Image references-->
[AAD-Sign-In]: ./media/active-directory-devhowto-multi-tenant-overview/sign-in-with-microsoft-light.png
[Consent-Single-Tier]: ./media/active-directory-devhowto-multi-tenant-overview/consent-flow-single-tier.png
[Consent-Multi-Tier-Known-Client]: ./media/active-directory-devhowto-multi-tenant-overview/consent-flow-multi-tier-known-clients.png
[Consent-Multi-Tier-Multi-Party]: ./media/active-directory-devhowto-multi-tenant-overview/consent-flow-multi-tier-multi-party.png

<!--Reference style links -->
[AAD-App-Manifest]: ./active-directory-application-manifest.md
[AAD-App-SP-Objects]: ./active-directory-application-objects.md
[AAD-Auth-Scenarios]: ./active-directory-authentication-scenarios.md
[AAD-Integrating-Apps]: ./active-directory-integrating-applications.md
[AAD-Dev-Guide]: ./active-directory-developers-guide.md
[AAD-Graph-Perm-Scopes]: https://msdn.microsoft.com/library/azure/ad/graph/howto/azure-ad-graph-api-permission-scopes
[AAD-Graph-App-Entity]: https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#application-entity
[AAD-Graph-Sp-Entity]: https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity
[AAD-Graph-User-Entity]: https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#user-entity
[AAD-How-To-Integrate]: ./active-directory-how-to-integrate.md
[AAD-Security-Token-Claims]: ./active-directory-authentication-scenarios/#claims-in-azure-ad-security-tokens
[AAD-Tokens-Claims]: ./active-directory-token-and-claims.md
[AAD-V2-Dev-Guide]: ../active-directory-appmodel-v2-overview.md
[AZURE-portal]: https://portal.azure.com
[Duyshant-Role-Blog]: http://www.dushyantgill.com/blog/2014/12/10/roles-based-access-control-in-cloud-applications-using-azure-ad/
[JWT]: https://tools.ietf.org/html/draft-ietf-oauth-json-web-token-32
[O365-Perm-Ref]: https://msdn.microsoft.com/en-us/office/office365/howto/application-manifest
[OAuth2-Access-Token-Scopes]: https://tools.ietf.org/html/rfc6749#section-3.3
[OAuth2-AuthZ-Code-Grant-Flow]: https://msdn.microsoft.com/library/azure/dn645542.aspx
[OAuth2-AuthZ-Grant-Types]: https://tools.ietf.org/html/rfc6749#section-1.3 
[OAuth2-Client-Types]: https://tools.ietf.org/html/rfc6749#section-2.1
[OAuth2-Role-Def]: https://tools.ietf.org/html/rfc6749#page-6
[OpenIDConnect]: http://openid.net/specs/openid-connect-core-1_0.html
[OpenIDConnect-ID-Token]: http://openid.net/specs/openid-connect-core-1_0.html#IDToken















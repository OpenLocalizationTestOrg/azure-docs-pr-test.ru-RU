---
title: "Области, разрешения и согласие в Azure Active Directory версии 2.0 | Документация Майкрософт"
description: "Описание авторизации в конечной точке Azure AD версии 2.0, включая области, разрешение и предоставление согласия."
services: active-directory
documentationcenter: 
author: dstrockis
manager: mbaldwin
editor: 
ms.assetid: 8f98cbf0-a71d-4e34-babf-e644ad9ff423
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/07/2017
ms.author: dastrock
ms.custom: aaddev
ms.openlocfilehash: 04869a7627ecb3e6a0d11733fae7da2ecb04ed51
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="scopes-permissions-and-consent-in-the-azure-active-directory-v20-endpoint"></a><span data-ttu-id="62cff-103">Области, разрешения и согласие для конечной точки Azure Active Directory версии 2.0</span><span class="sxs-lookup"><span data-stu-id="62cff-103">Scopes, permissions, and consent in the Azure Active Directory v2.0 endpoint</span></span>
<span data-ttu-id="62cff-104">Приложения, интегрируемые с Azure Active Directory (Azure AD), придерживаются определенной модели авторизации, позволяющей пользователям контролировать способ получения приложением доступа к их данным.</span><span class="sxs-lookup"><span data-stu-id="62cff-104">Apps that integrate with Azure Active Directory (Azure AD) follow an authorization model that gives users control over how an app can access their data.</span></span> <span data-ttu-id="62cff-105">Реализация версии 2.0 этой модели авторизации была обновлена, в результате чего изменился механизм взаимодействия приложения с Azure AD.</span><span class="sxs-lookup"><span data-stu-id="62cff-105">The v2.0 implementation of the authorization model has been updated, and it changes how an app must interact with Azure AD.</span></span> <span data-ttu-id="62cff-106">В этой статье рассматриваются основные понятия этой модели авторизации, включая области, разрешения и согласие на их предоставление.</span><span class="sxs-lookup"><span data-stu-id="62cff-106">This article covers the basic concepts of this authorization model, including scopes, permissions, and consent.</span></span>

> [!NOTE]
> <span data-ttu-id="62cff-107">Не все сценарии и компоненты Azure Active Directory поддерживаются конечной точкой версии 2.0.</span><span class="sxs-lookup"><span data-stu-id="62cff-107">The v2.0 endpoint does not support all Azure Active Directory scenarios and features.</span></span> <span data-ttu-id="62cff-108">Чтобы определить, стоит ли вам использовать конечную точку версии 2.0, ознакомьтесь с [ограничениями версии 2.0](active-directory-v2-limitations.md).</span><span class="sxs-lookup"><span data-stu-id="62cff-108">To determine whether you should use the v2.0 endpoint, read about [v2.0 limitations](active-directory-v2-limitations.md).</span></span>
>
>

## <a name="scopes-and-permissions"></a><span data-ttu-id="62cff-109">Области и разрешения</span><span class="sxs-lookup"><span data-stu-id="62cff-109">Scopes and permissions</span></span>
<span data-ttu-id="62cff-110">Azure AD реализует протокол авторизации [OAuth 2.0](active-directory-v2-protocols.md).</span><span class="sxs-lookup"><span data-stu-id="62cff-110">Azure AD implements the [OAuth 2.0](active-directory-v2-protocols.md) authorization protocol.</span></span> <span data-ttu-id="62cff-111">OAuth 2.0 — это метод, посредством которого стороннее приложение может обращаться к интернет-ресурсам от имени пользователя.</span><span class="sxs-lookup"><span data-stu-id="62cff-111">OAuth 2.0 is a method through which a third-party app can access web-hosted resources on behalf of a user.</span></span> <span data-ttu-id="62cff-112">Любой интернет-ресурс, интегрируемый с Azure AD, имеет идентификатор ресурса или *универсальный код ресурса (URI) идентификатора приложения*.</span><span class="sxs-lookup"><span data-stu-id="62cff-112">Any web-hosted resource that integrates with Azure AD has a resource identifier, or *Application ID URI*.</span></span> <span data-ttu-id="62cff-113">К примеру, ниже приведены некоторые из размещенных в Интернете ресурсов Майкрософт:</span><span class="sxs-lookup"><span data-stu-id="62cff-113">For example, some of Microsoft's web-hosted resources include:</span></span>

* <span data-ttu-id="62cff-114">Единый API почты Office 365: `https://outlook.office.com`</span><span class="sxs-lookup"><span data-stu-id="62cff-114">The Office 365 Unified Mail API: `https://outlook.office.com`</span></span>
* <span data-ttu-id="62cff-115">API Graph Azure AD: `https://graph.windows.net`</span><span class="sxs-lookup"><span data-stu-id="62cff-115">The Azure AD Graph API: `https://graph.windows.net`</span></span>
* <span data-ttu-id="62cff-116">Microsoft Graph: `https://graph.microsoft.com`</span><span class="sxs-lookup"><span data-stu-id="62cff-116">Microsoft Graph: `https://graph.microsoft.com`</span></span>

<span data-ttu-id="62cff-117">Это касается любых сторонних ресурсов, интегрированных с Azure AD.</span><span class="sxs-lookup"><span data-stu-id="62cff-117">The same is true for any third-party resources that have integrated with Azure AD.</span></span> <span data-ttu-id="62cff-118">Любой из этих ресурсов может также определять набор разрешений, с помощью которых можно разделить функции ресурса на меньшие блоки.</span><span class="sxs-lookup"><span data-stu-id="62cff-118">Any of these resources also can define a set of permissions that can be used to divide the functionality of that resource into smaller chunks.</span></span> <span data-ttu-id="62cff-119">Например, в [Microsoft Graph](https://graph.microsoft.io) определены разрешения для выполнения таких задач, как:</span><span class="sxs-lookup"><span data-stu-id="62cff-119">As an example, [Microsoft Graph](https://graph.microsoft.io) has defined permissions to do the following tasks, among others:</span></span>

* <span data-ttu-id="62cff-120">чтение календаря пользователя;</span><span class="sxs-lookup"><span data-stu-id="62cff-120">Read a user's calendar</span></span>
* <span data-ttu-id="62cff-121">запись в календарь пользователя;</span><span class="sxs-lookup"><span data-stu-id="62cff-121">Write to a user's calendar</span></span>
* <span data-ttu-id="62cff-122">отправка сообщений в качестве пользователя.</span><span class="sxs-lookup"><span data-stu-id="62cff-122">Send mail as a user</span></span>

<span data-ttu-id="62cff-123">Благодаря определению этих разрешений ресурс получает детализированный контроль над своими данными и предоставлением внешнего доступа к ним.</span><span class="sxs-lookup"><span data-stu-id="62cff-123">By defining these types of permissions, the resource has fine-grained control over its data and how the data is exposed.</span></span> <span data-ttu-id="62cff-124">Приложение стороннего производителя может запросить эти разрешения у пользователя приложения.</span><span class="sxs-lookup"><span data-stu-id="62cff-124">A third-party app can request these permissions from an app user.</span></span> <span data-ttu-id="62cff-125">Пользователь приложения должен утвердить разрешения, прежде чем приложение сможет действовать от его имени.</span><span class="sxs-lookup"><span data-stu-id="62cff-125">The app user must approve the permissions before the app can act on the user's behalf.</span></span> <span data-ttu-id="62cff-126">Разделяя функции ресурса на меньшие наборы разрешений, приложения сторонних производителей можно настроить таким образом, чтобы они запрашивали только определенные разрешения, необходимые им для выполнения своих задач.</span><span class="sxs-lookup"><span data-stu-id="62cff-126">By chunking the resource's functionality into smaller permission sets, third-party apps can be built to request only the specific permissions that they need to perform their function.</span></span> <span data-ttu-id="62cff-127">Такой подход позволяет пользователям точно знать, как приложение будет использовать их данные, давая им большую уверенность в отсутствии вредоносных целей в работе приложения.</span><span class="sxs-lookup"><span data-stu-id="62cff-127">App users can know exactly how an app will use their data, and they can be more confident that the app is not behaving with malicious intent.</span></span>

<span data-ttu-id="62cff-128">В Azure AD и OAuth разрешения такого типа называются *областями*.</span><span class="sxs-lookup"><span data-stu-id="62cff-128">In Azure AD and OAuth, these types of permissions are called *scopes*.</span></span> <span data-ttu-id="62cff-129">Иногда их также называют областью *oAuth2Permissions*.</span><span class="sxs-lookup"><span data-stu-id="62cff-129">They also sometimes are referred to as *oAuth2Permissions*.</span></span> <span data-ttu-id="62cff-130">В Azure AD область представляется как строковое значение.</span><span class="sxs-lookup"><span data-stu-id="62cff-130">A scope is represented in Azure AD as a string value.</span></span> <span data-ttu-id="62cff-131">Продолжим рассмотрение примера для Microsoft Graph. Значение области для каждого разрешения следующее:</span><span class="sxs-lookup"><span data-stu-id="62cff-131">Continuing with the Microsoft Graph example, the scope value for each permission is:</span></span>

* <span data-ttu-id="62cff-132">чтение календаря пользователя с помощью `Calendar.Read`;</span><span class="sxs-lookup"><span data-stu-id="62cff-132">Read a user's calendar by using `Calendar.Read`</span></span>
* <span data-ttu-id="62cff-133">запись в календарь пользователя с помощью `Mail.ReadWrite`;</span><span class="sxs-lookup"><span data-stu-id="62cff-133">Write to a user's calendar by using `Mail.ReadWrite`</span></span>
* <span data-ttu-id="62cff-134">отправка сообщений в качестве пользователя с помощью `Mail.Send`.</span><span class="sxs-lookup"><span data-stu-id="62cff-134">Send mail as a user using by `Mail.Send`</span></span>

<span data-ttu-id="62cff-135">Приложение может запросить эти разрешения, указав области в запросах к конечной точке версии 2.0.</span><span class="sxs-lookup"><span data-stu-id="62cff-135">An app can request these permissions by specifying the scopes in requests to the v2.0 endpoint.</span></span>

## <a name="openid-connect-scopes"></a><span data-ttu-id="62cff-136">Области OpenId Connect</span><span class="sxs-lookup"><span data-stu-id="62cff-136">OpenID Connect scopes</span></span>
<span data-ttu-id="62cff-137">Реализация OpenID Connect на основе версии 2.0 содержит несколько четко определенных областей, которые не применяются к какому-либо конкретному ресурсу: `openid`, `email`, `profile` и `offline_access`.</span><span class="sxs-lookup"><span data-stu-id="62cff-137">The v2.0 implementation of OpenID Connect has a few well-defined scopes that do not apply to a specific resource: `openid`, `email`, `profile`, and `offline_access`.</span></span>

### <a name="openid"></a><span data-ttu-id="62cff-138">OpenId</span><span class="sxs-lookup"><span data-stu-id="62cff-138">openid</span></span>
<span data-ttu-id="62cff-139">Если приложение выполняет вход с помощью протокола [OpenID Connect](active-directory-v2-protocols.md), оно должно запросить область `openid`.</span><span class="sxs-lookup"><span data-stu-id="62cff-139">If an app performs sign-in by using [OpenID Connect](active-directory-v2-protocols.md), it must request the `openid` scope.</span></span> <span data-ttu-id="62cff-140">В рабочей учетной записи область `openid` отображается на странице согласия в виде разрешения "Вход", а в личной учетной записи Майкрософт — в виде разрешения "View your profile and connect to apps and services using your Microsoft account" (Просмотр профиля и подключение к приложениям и службам с помощью учетной записи Майкрософт).</span><span class="sxs-lookup"><span data-stu-id="62cff-140">The `openid` scope shows on the work account consent page as the "Sign you in" permission, and on the personal Microsoft account consent page as the "View your profile and connect to apps and services using your Microsoft account" permission.</span></span> <span data-ttu-id="62cff-141">Это разрешение позволяет приложению получить уникальный идентификатор для пользователя в виде утверждения `sub`.</span><span class="sxs-lookup"><span data-stu-id="62cff-141">With this permission, an app can receive a unique identifier for the user in the form of the `sub` claim.</span></span> <span data-ttu-id="62cff-142">Оно также предоставляет приложению доступ к конечной точке сведений о пользователе.</span><span class="sxs-lookup"><span data-stu-id="62cff-142">It also gives the app access to the UserInfo endpoint.</span></span> <span data-ttu-id="62cff-143">Область `openid` можно использовать на конечной точке маркеров версии 2.0 для получения маркеров идентификации, с помощью которых можно защитить HTTP-вызовы между разными компонентами приложения.</span><span class="sxs-lookup"><span data-stu-id="62cff-143">The `openid` scope can be used at the v2.0 token endpoint to acquire ID tokens, which can be used to secure HTTP calls between different components of an app.</span></span>

### <a name="email"></a><span data-ttu-id="62cff-144">email</span><span class="sxs-lookup"><span data-stu-id="62cff-144">email</span></span>
<span data-ttu-id="62cff-145">Область `email` можно использовать вместе с областью `openid` и любыми другими областями.</span><span class="sxs-lookup"><span data-stu-id="62cff-145">The `email` scope can be used with the `openid` scope and any others.</span></span> <span data-ttu-id="62cff-146">Она предоставляет приложению доступ к основному электронному адресу пользователя в виде утверждения `email`.</span><span class="sxs-lookup"><span data-stu-id="62cff-146">It gives the app access to the user's primary email address in the form of the `email` claim.</span></span> <span data-ttu-id="62cff-147">Утверждение `email` будет включено в маркер, только если электронный адрес связан с учетной записью пользователя (а это не всегда так).</span><span class="sxs-lookup"><span data-stu-id="62cff-147">The `email` claim is included in a token only if an email address is associated with the user account, which is not always the case.</span></span> <span data-ttu-id="62cff-148">При использовании области `email` приложение должно быть готово обрабатывать случаи, когда утверждение `email` в маркере отсутствует.</span><span class="sxs-lookup"><span data-stu-id="62cff-148">If it uses the `email` scope, your app should be prepared to handle a case in which the `email` claim does not exist in the token.</span></span>

### <a name="profile"></a><span data-ttu-id="62cff-149">Профиль</span><span class="sxs-lookup"><span data-stu-id="62cff-149">profile</span></span>
<span data-ttu-id="62cff-150">Область `profile` можно использовать вместе с областью `openid` и любыми другими областями.</span><span class="sxs-lookup"><span data-stu-id="62cff-150">The `profile` scope can be used with the `openid` scope and any others.</span></span> <span data-ttu-id="62cff-151">Она предоставляет приложению доступ к существенному объему сведений о пользователе.</span><span class="sxs-lookup"><span data-stu-id="62cff-151">It gives the app access to a substantial amount of information about the user.</span></span> <span data-ttu-id="62cff-152">К этим сведениям, в частности, относятся имя и фамилия пользователя, предпочтительное имя пользователя и идентификатор объекта.</span><span class="sxs-lookup"><span data-stu-id="62cff-152">The information it can access includes, but is not limited to, the user's given name, surname, preferred username, and object ID.</span></span> <span data-ttu-id="62cff-153">Полный список утверждений профиля, доступных в параметре id_tokens для конкретного пользователя, представлен в [справочнике по маркерам версии 2.0](active-directory-v2-tokens.md).</span><span class="sxs-lookup"><span data-stu-id="62cff-153">For a complete list of the profile claims available in the id_tokens parameter for a specific user, see the [v2.0 tokens reference](active-directory-v2-tokens.md).</span></span>

### <a name="offlineaccess"></a><span data-ttu-id="62cff-154">offline_access</span><span class="sxs-lookup"><span data-stu-id="62cff-154">offline_access</span></span>
<span data-ttu-id="62cff-155">[Область `offline_access`](http://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess) предоставляет приложению доступ к ресурсам от имени пользователя на длительное время.</span><span class="sxs-lookup"><span data-stu-id="62cff-155">The [`offline_access` scope](http://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess) gives your app access to resources on behalf of the user for an extended time.</span></span> <span data-ttu-id="62cff-156">На странице согласия рабочей учетной записи эта область отображается в виде разрешения "Access your data anytime" (Доступ к вашим данным в любое время).</span><span class="sxs-lookup"><span data-stu-id="62cff-156">On the work account consent page, this scope appears as the "Access your data anytime" permission.</span></span> <span data-ttu-id="62cff-157">На странице согласия личной учетной записи Майкрософт она отображается в виде разрешения "Доступ к вашим сведениям в любое время".</span><span class="sxs-lookup"><span data-stu-id="62cff-157">On the personal Microsoft account consent page, it appears as the "Access your info anytime" permission.</span></span> <span data-ttu-id="62cff-158">Когда пользователь утвердит область `offline_access`, приложение сможет получать маркеры обновления от конечной точки маркеров версии 2.0.</span><span class="sxs-lookup"><span data-stu-id="62cff-158">When a user approves the `offline_access` scope, your app can receive refresh tokens from the v2.0 token endpoint.</span></span> <span data-ttu-id="62cff-159">Маркеры обновления имеют большой срок действия.</span><span class="sxs-lookup"><span data-stu-id="62cff-159">Refresh tokens are long-lived.</span></span> <span data-ttu-id="62cff-160">Приложение может получать новые маркеры доступа после того, как срок действия старых истечет.</span><span class="sxs-lookup"><span data-stu-id="62cff-160">Your app can get new access tokens as older ones expire.</span></span>

<span data-ttu-id="62cff-161">Если приложение не запросит область `offline_access`, оно не получит маркеры обновления.</span><span class="sxs-lookup"><span data-stu-id="62cff-161">If your app does not request the `offline_access` scope, it won't receive refresh tokens.</span></span> <span data-ttu-id="62cff-162">Это значит, что при использовании кода авторизации в [потоке кода авторизации OAuth 2.0](active-directory-v2-protocols.md) от конечной точки `/token` вы получите только маркер доступа.</span><span class="sxs-lookup"><span data-stu-id="62cff-162">This means that when you redeem an authorization code in the [OAuth 2.0 authorization code flow](active-directory-v2-protocols.md), you'll receive only an access token from the `/token` endpoint.</span></span> <span data-ttu-id="62cff-163">Маркер доступа действителен недолго.</span><span class="sxs-lookup"><span data-stu-id="62cff-163">The access token is valid for a short time.</span></span> <span data-ttu-id="62cff-164">Как правило, его срок действия истекает через один час.</span><span class="sxs-lookup"><span data-stu-id="62cff-164">The access token usually expires in one hour.</span></span> <span data-ttu-id="62cff-165">В этот момент приложению будет необходимо перенаправить пользователя обратно к конечной точке `/authorize`, чтобы получить новый код авторизации.</span><span class="sxs-lookup"><span data-stu-id="62cff-165">At that point, your app needs to redirect the user back to the `/authorize` endpoint to get a new authorization code.</span></span> <span data-ttu-id="62cff-166">При этом, в зависимости от типа приложения, пользователю может потребоваться повторно ввести учетные данные или предоставить разрешения.</span><span class="sxs-lookup"><span data-stu-id="62cff-166">During this redirect, depending on the type of app, the user might need to enter their credentials again or consent again to permissions.</span></span>

<span data-ttu-id="62cff-167">Дополнительные сведения о том, как получать и использовать маркеры обновления, можно найти в [справочнике по протоколу версии 2.0](active-directory-v2-protocols.md).</span><span class="sxs-lookup"><span data-stu-id="62cff-167">For more information about how to get and use refresh tokens, see the [v2.0 protocol reference](active-directory-v2-protocols.md).</span></span>

## <a name="requesting-individual-user-consent"></a><span data-ttu-id="62cff-168">Запрос на получение согласия одного пользователя</span><span class="sxs-lookup"><span data-stu-id="62cff-168">Requesting individual user consent</span></span>
<span data-ttu-id="62cff-169">В запросе авторизации [OpenID Connect или OAuth 2.0](active-directory-v2-protocols.md) приложение может запросить необходимые разрешения с помощью параметра запроса `scope`.</span><span class="sxs-lookup"><span data-stu-id="62cff-169">In an [OpenID Connect or OAuth 2.0](active-directory-v2-protocols.md) authorization request, an app can request the permissions it needs by using the `scope` query parameter.</span></span> <span data-ttu-id="62cff-170">Например, при входе пользователя в приложение оно отправит запрос следующего вида (разрывы строк добавлены для удобства чтения).</span><span class="sxs-lookup"><span data-stu-id="62cff-170">For example, when a user signs in to an app, the app sends a request like the following example (with line breaks added for legibility):</span></span>

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=query
&scope=
https%3A%2F%2Fgraph.microsoft.com%2Fcalendar.read%20
https%3A%2F%2Fgraph.microsoft.com%2Fmail.send
&state=12345
```

<span data-ttu-id="62cff-171">Параметр `scope` — это запрашиваемый приложением список областей с разделителями-пробелами.</span><span class="sxs-lookup"><span data-stu-id="62cff-171">The `scope` parameter is a space-separated list of scopes that the app is requesting.</span></span> <span data-ttu-id="62cff-172">Каждая область указывается путем добавления значения области к идентификатору ресурса (универсальному коду ресурса (URI) идентификатора приложения).</span><span class="sxs-lookup"><span data-stu-id="62cff-172">Each scope is indicated by appending the scope value to the resource's identifier (the Application ID URI).</span></span> <span data-ttu-id="62cff-173">В приведенном примере запроса приложению требуется разрешение на чтение календаря пользователя и отправку сообщений от его имени.</span><span class="sxs-lookup"><span data-stu-id="62cff-173">In the request example, the app needs permission to read the user's calendar and send mail as the user.</span></span>

<span data-ttu-id="62cff-174">После того как пользователь введет учетные данные, конечная точка версии 2.0 проверит наличие соответствующей записи *согласия пользователя*.</span><span class="sxs-lookup"><span data-stu-id="62cff-174">After the user enters their credentials, the v2.0 endpoint checks for a matching record of *user consent*.</span></span> <span data-ttu-id="62cff-175">Если пользователь ранее не давал согласие на предоставление какого-либо из запрашиваемых разрешений, конечная точка версии 2.0 предложит пользователю сделать это.</span><span class="sxs-lookup"><span data-stu-id="62cff-175">If the user has not consented to any of the requested permissions in the past, the v2.0 endpoint asks the user to grant the requested permissions.</span></span>

![Предоставление разрешений рабочей учетной записью](../../media/active-directory-v2-flows/work_account_consent.png)

<span data-ttu-id="62cff-177">После того как пользователь утвердит разрешение, факт согласия будет записан, чтобы пользователю не пришлось повторно давать его при входе в учетную запись в дальнейшем.</span><span class="sxs-lookup"><span data-stu-id="62cff-177">When the user approves the permission, the consent is recorded so that the user doesn't have to consent again on subsequent account sign-ins.</span></span>

## <a name="requesting-consent-for-an-entire-tenant"></a><span data-ttu-id="62cff-178">Запрос на получение согласия для клиента</span><span class="sxs-lookup"><span data-stu-id="62cff-178">Requesting consent for an entire tenant</span></span>
<span data-ttu-id="62cff-179">Часто, когда организация приобретает лицензию или подписку на приложение, планируется полностью подготовить это приложение для своих сотрудников.</span><span class="sxs-lookup"><span data-stu-id="62cff-179">Often, when an organization purchases a license or subscription for an application, the organization wants to fully provision the application for its employees.</span></span> <span data-ttu-id="62cff-180">В ходе этого процесса администратор может предоставить этому приложению разрешение действовать от имени любого сотрудника.</span><span class="sxs-lookup"><span data-stu-id="62cff-180">As part of this process, an administrator can grant consent for the application to act on behalf of any employee.</span></span> <span data-ttu-id="62cff-181">Если администратор предоставляет разрешения для всего клиента, то сотрудники организации не увидят страницу согласия для приложения.</span><span class="sxs-lookup"><span data-stu-id="62cff-181">If the admin grants consent for the entire tenant, the organization's employees won't see a consent page for the application.</span></span>

<span data-ttu-id="62cff-182">Чтобы запросить согласие для всех пользователей в клиенте, приложение может использовать конечную точку предоставления согласия администратора.</span><span class="sxs-lookup"><span data-stu-id="62cff-182">To request consent for all users in a tenant, your app can use the admin consent endpoint.</span></span>

## <a name="admin-restricted-scopes"></a><span data-ttu-id="62cff-183">Области только для администраторов</span><span class="sxs-lookup"><span data-stu-id="62cff-183">Admin-restricted scopes</span></span>
<span data-ttu-id="62cff-184">Некоторые высокопривилегированные разрешения в экосистеме Майкрософт могут быть помечены как *предназначенные только для администраторов*.</span><span class="sxs-lookup"><span data-stu-id="62cff-184">Some high-privilege permissions in the Microsoft ecosystem can be set to *admin-restricted*.</span></span> <span data-ttu-id="62cff-185">Ниже приведены примеры разрешений из подобных областей:</span><span class="sxs-lookup"><span data-stu-id="62cff-185">Examples of these kinds of scopes include the following permissions:</span></span>

* <span data-ttu-id="62cff-186">чтение данных из каталога организации с помощью `Directory.Read`;</span><span class="sxs-lookup"><span data-stu-id="62cff-186">Read an organization's directory data by using `Directory.Read`</span></span>
* <span data-ttu-id="62cff-187">запись данных в каталог организации с помощью `Directory.ReadWrite`;</span><span class="sxs-lookup"><span data-stu-id="62cff-187">Write data to an organization's directory by using `Directory.ReadWrite`</span></span>
* <span data-ttu-id="62cff-188">чтение групп безопасности в каталоге организации с помощью `Groups.Read.All`.</span><span class="sxs-lookup"><span data-stu-id="62cff-188">Read security groups in an organization's directory by using `Groups.Read.All`</span></span>

<span data-ttu-id="62cff-189">Хотя пользователь, являющийся потребителем, и может предоставить приложению доступ к таким данным, корпоративным пользователям нельзя предоставлять доступ к таким же конфиденциальным данным компании.</span><span class="sxs-lookup"><span data-stu-id="62cff-189">Although a consumer user might grant an application access to this kind of data, organizational users are restricted from granting access to the same set of sensitive company data.</span></span> <span data-ttu-id="62cff-190">Если приложение запрашивает доступ к одному из этих разрешений у корпоративного пользователя, появится сообщение об ошибке со сведениями о том, что этот пользователь не может предоставить разрешения приложению.</span><span class="sxs-lookup"><span data-stu-id="62cff-190">If your application requests access to one of these permissions from an organizational user, the user receives an error message that says they are not authorized to consent to your app's permissions.</span></span>

<span data-ttu-id="62cff-191">Если вашему приложению требуется доступ к областям только для администраторов организаций, следует запросить их непосредственно у администратора компании, а также с помощью конечной точки предоставления согласия администратора, как описано ниже.</span><span class="sxs-lookup"><span data-stu-id="62cff-191">If your app requires access to admin-restricted scopes for organizations, you should request them directly from a company administrator, also by using the admin consent endpoint, described next.</span></span>

<span data-ttu-id="62cff-192">Когда администратор предоставит эти разрешения через конечную точку предоставления согласия администратора, согласие получат все пользователи в клиенте.</span><span class="sxs-lookup"><span data-stu-id="62cff-192">When an administrator grants these permissions via the admin consent endpoint, consent is granted for all users in the tenant.</span></span>

## <a name="using-the-admin-consent-endpoint"></a><span data-ttu-id="62cff-193">Использование конечной точки предоставления согласия администратора</span><span class="sxs-lookup"><span data-stu-id="62cff-193">Using the admin consent endpoint</span></span>
<span data-ttu-id="62cff-194">Выполнив приведенные действия, приложение получит возможность получать разрешения для всех пользователей в клиенте, включая области только для администраторов.</span><span class="sxs-lookup"><span data-stu-id="62cff-194">If you follow these steps, your app can gather permissions for all users in a tenant, including admin-restricted scopes.</span></span> <span data-ttu-id="62cff-195">Пример кода, реализующий эти действия, см. в [примере областей только для администраторов](https://github.com/Azure-Samples/active-directory-dotnet-admin-restricted-scopes-v2).</span><span class="sxs-lookup"><span data-stu-id="62cff-195">To see a code sample that implements the steps, see the [admin-restricted scopes sample](https://github.com/Azure-Samples/active-directory-dotnet-admin-restricted-scopes-v2).</span></span>

### <a name="request-the-permissions-in-the-app-registration-portal"></a><span data-ttu-id="62cff-196">Запрос разрешений на портале регистрации приложения</span><span class="sxs-lookup"><span data-stu-id="62cff-196">Request the permissions in the app registration portal</span></span>
1. <span data-ttu-id="62cff-197">Перейдите к приложению на [портале регистрации приложения](https://apps.dev.microsoft.com/?referrer=https://azure.microsoft.com/documentation/articles&deeplink=/appList) или [создайте приложение](active-directory-v2-app-registration.md), если это еще не сделано.</span><span class="sxs-lookup"><span data-stu-id="62cff-197">Go to your application in the [Application Registration Portal](https://apps.dev.microsoft.com/?referrer=https://azure.microsoft.com/documentation/articles&deeplink=/appList), or [create an app](active-directory-v2-app-registration.md) if you haven't already.</span></span>
2. <span data-ttu-id="62cff-198">Найдите раздел **Разрешения Microsoft Graph** и добавьте разрешения, необходимые для приложения.</span><span class="sxs-lookup"><span data-stu-id="62cff-198">Locate the **Microsoft Graph Permissions** section, and then add the permissions that your app requires.</span></span>
3. <span data-ttu-id="62cff-199">Обязательно **сохраните** регистрацию приложения.</span><span class="sxs-lookup"><span data-stu-id="62cff-199">Make sure you **Save** the app registration.</span></span>

### <a name="recommended-sign-the-user-in-to-your-app"></a><span data-ttu-id="62cff-200">Выполнение входа пользователя в приложение (рекомендуется)</span><span class="sxs-lookup"><span data-stu-id="62cff-200">Recommended: Sign the user in to your app</span></span>
<span data-ttu-id="62cff-201">Как правило, при создании приложения, использующего конечную точку предоставления согласия администратора, для него нужно настроить страницу или представление, в котором администратор может утвердить разрешения приложения.</span><span class="sxs-lookup"><span data-stu-id="62cff-201">Typically, when you build an application that uses the admin consent endpoint, the app needs a page or view in which the admin can approve the app's permissions.</span></span> <span data-ttu-id="62cff-202">Эта страница может быть частью потока регистрации приложения, параметров приложения или выделенного потока подключения.</span><span class="sxs-lookup"><span data-stu-id="62cff-202">This page can be part of the app's sign-up flow, part of the app's settings, or it can be a dedicated "connect" flow.</span></span> <span data-ttu-id="62cff-203">Во многих случаях разумно отображать это представление подключения в приложении только после того, как пользователь выполнил вход с помощью учебной или рабочей учетной записи Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="62cff-203">In many cases, it makes sense for the app to show this "connect" view only after a user has signed in with a work or school Microsoft account.</span></span>

<span data-ttu-id="62cff-204">При входе пользователя в приложение можно определить организацию, к которой принадлежит администратор, прежде чем запрашивать у него утверждение необходимых разрешений.</span><span class="sxs-lookup"><span data-stu-id="62cff-204">When you sign the user in to your app, you can identify the organization to which the admin belongs before asking them to approve the necessary permissions.</span></span> <span data-ttu-id="62cff-205">Хотя это не обязательно, таким образом можно сделать пользовательский интерфейс более интуитивно понятным для сотрудников организации.</span><span class="sxs-lookup"><span data-stu-id="62cff-205">Although not strictly necessary, it can help you create a more intuitive experience for your organizational users.</span></span> <span data-ttu-id="62cff-206">Чтобы выполнить вход пользователя, следуйте нашим [указаниям в учебниках по протоколу версии 2.0](active-directory-v2-protocols.md).</span><span class="sxs-lookup"><span data-stu-id="62cff-206">To sign the user in, follow our [v2.0 protocol tutorials](active-directory-v2-protocols.md).</span></span>

### <a name="request-the-permissions-from-a-directory-admin"></a><span data-ttu-id="62cff-207">Запрос разрешений у администратора каталога</span><span class="sxs-lookup"><span data-stu-id="62cff-207">Request the permissions from a directory admin</span></span>
<span data-ttu-id="62cff-208">Когда вы будете готовы запросить разрешения у администратора организации, можно будет перенаправить пользователя к *конечной точке предоставления согласия администратора* версии 2.0.</span><span class="sxs-lookup"><span data-stu-id="62cff-208">When you're ready to request permissions from your organization's admin, you can redirect the user to the v2.0 *admin consent endpoint*.</span></span>

```
// Line breaks are for legibility only.

GET https://login.microsoftonline.com/{tenant}/adminconsent?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&state=12345
&redirect_uri=http://localhost/myapp/permissions
```

```
// Pro tip: Try pasting the below request in a browser!
```

```
https://login.microsoftonline.com/common/adminconsent?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&state=12345&redirect_uri=http://localhost/myapp/permissions
```

| <span data-ttu-id="62cff-209">Параметр</span><span class="sxs-lookup"><span data-stu-id="62cff-209">Parameter</span></span> | <span data-ttu-id="62cff-210">Условие</span><span class="sxs-lookup"><span data-stu-id="62cff-210">Condition</span></span> | <span data-ttu-id="62cff-211">Описание</span><span class="sxs-lookup"><span data-stu-id="62cff-211">Description</span></span> |
| --- | --- | --- |
| <span data-ttu-id="62cff-212">tenant</span><span class="sxs-lookup"><span data-stu-id="62cff-212">tenant</span></span> |<span data-ttu-id="62cff-213">Обязательно</span><span class="sxs-lookup"><span data-stu-id="62cff-213">Required</span></span> |<span data-ttu-id="62cff-214">Клиент каталога, из которого необходимо запросить разрешение.</span><span class="sxs-lookup"><span data-stu-id="62cff-214">The directory tenant that you want to request permission from.</span></span> <span data-ttu-id="62cff-215">Можно указать в виде GUID или понятного имени.</span><span class="sxs-lookup"><span data-stu-id="62cff-215">Can be provided in GUID or friendly name format.</span></span> |
| <span data-ttu-id="62cff-216">client_id</span><span class="sxs-lookup"><span data-stu-id="62cff-216">client_id</span></span> |<span data-ttu-id="62cff-217">Обязательно</span><span class="sxs-lookup"><span data-stu-id="62cff-217">Required</span></span> |<span data-ttu-id="62cff-218">Идентификатор приложения, присвоенный приложению на [портале регистрации приложений](https://apps.dev.microsoft.com/?referrer=https://azure.microsoft.com/documentation/articles&deeplink=/appList).</span><span class="sxs-lookup"><span data-stu-id="62cff-218">The Application ID that the [Application Registration Portal](https://apps.dev.microsoft.com/?referrer=https://azure.microsoft.com/documentation/articles&deeplink=/appList) assigned to your app.</span></span> |
| <span data-ttu-id="62cff-219">redirect_uri</span><span class="sxs-lookup"><span data-stu-id="62cff-219">redirect_uri</span></span> |<span data-ttu-id="62cff-220">Обязательно</span><span class="sxs-lookup"><span data-stu-id="62cff-220">Required</span></span> |<span data-ttu-id="62cff-221">Универсальный код ресурса (URI) перенаправления, на который нужно направлять ответ для обработки в приложении.</span><span class="sxs-lookup"><span data-stu-id="62cff-221">The redirect URI where you want the response to be sent for your app to handle.</span></span> <span data-ttu-id="62cff-222">Он должен в точности соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных на портале регистрации приложений.</span><span class="sxs-lookup"><span data-stu-id="62cff-222">It must exactly match one of the redirect URIs that you registered in the app registration portal.</span></span> |
| <span data-ttu-id="62cff-223">state</span><span class="sxs-lookup"><span data-stu-id="62cff-223">state</span></span> |<span data-ttu-id="62cff-224">Рекомендуется</span><span class="sxs-lookup"><span data-stu-id="62cff-224">Recommended</span></span> |<span data-ttu-id="62cff-225">Значение, включенное в запрос, которое также возвращается в ответе токена.</span><span class="sxs-lookup"><span data-stu-id="62cff-225">A value included in the request that will also be returned in the token response.</span></span> <span data-ttu-id="62cff-226">Это может быть строка любого содержания.</span><span class="sxs-lookup"><span data-stu-id="62cff-226">It can be a string of any content you want.</span></span> <span data-ttu-id="62cff-227">Используйте параметр state для кодирования сведений о состоянии пользователя в приложении перед выполнением запроса на аутентификацию. Например, это могут быть сведения об открытой на тот момент странице или представлении.</span><span class="sxs-lookup"><span data-stu-id="62cff-227">Use the state to encode information about the user's state in the app before the authentication request occurred, such as the page or view they were on.</span></span> |

<span data-ttu-id="62cff-228">На этом этапе Azure AD требует, чтобы администратор клиента вошел в систему, чтобы выполнить запрос.</span><span class="sxs-lookup"><span data-stu-id="62cff-228">At this point, Azure AD requires a tenant administrator to sign in to complete the request.</span></span> <span data-ttu-id="62cff-229">Администратору предлагается утвердить все разрешения, запрошенные для приложения на портале регистрации приложений.</span><span class="sxs-lookup"><span data-stu-id="62cff-229">The administrator is asked to approve all the permissions that you have requested for your app in the app registration portal.</span></span>

#### <a name="successful-response"></a><span data-ttu-id="62cff-230">Успешный ответ</span><span class="sxs-lookup"><span data-stu-id="62cff-230">Successful response</span></span>
<span data-ttu-id="62cff-231">Если администратор утверждает разрешения для приложения, то успешный ответ будет выглядеть следующим образом.</span><span class="sxs-lookup"><span data-stu-id="62cff-231">If the admin approves the permissions for your app, the successful response looks like this:</span></span>

```
GET http://localhost/myapp/permissions?tenant=a8990e1f-ff32-408a-9f8e-78d3b9139b95&state=state=12345&admin_consent=True
```

| <span data-ttu-id="62cff-232">Параметр</span><span class="sxs-lookup"><span data-stu-id="62cff-232">Parameter</span></span> | <span data-ttu-id="62cff-233">Описание</span><span class="sxs-lookup"><span data-stu-id="62cff-233">Description</span></span> |
| --- | --- | --- |
| <span data-ttu-id="62cff-234">tenant</span><span class="sxs-lookup"><span data-stu-id="62cff-234">tenant</span></span> |<span data-ttu-id="62cff-235">Клиент каталога, предоставивший приложению запрошенные разрешения, в виде GUID.</span><span class="sxs-lookup"><span data-stu-id="62cff-235">The directory tenant that granted your application the permissions it requested, in GUID format.</span></span> |
| <span data-ttu-id="62cff-236">state</span><span class="sxs-lookup"><span data-stu-id="62cff-236">state</span></span> |<span data-ttu-id="62cff-237">Значение, включенное в запрос, которое также возвращается в ответе маркера.</span><span class="sxs-lookup"><span data-stu-id="62cff-237">A value included in the request that also will be returned in the token response.</span></span> <span data-ttu-id="62cff-238">Это может быть строка любого содержания.</span><span class="sxs-lookup"><span data-stu-id="62cff-238">It can be a string of any content you want.</span></span> <span data-ttu-id="62cff-239">Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении.</span><span class="sxs-lookup"><span data-stu-id="62cff-239">The state is used to encode information about the user's state in the app before the authentication request occurred, such as the page or view they were on.</span></span> |
| <span data-ttu-id="62cff-240">admin_consent</span><span class="sxs-lookup"><span data-stu-id="62cff-240">admin_consent</span></span> |<span data-ttu-id="62cff-241">Будет присвоено значение **true**.</span><span class="sxs-lookup"><span data-stu-id="62cff-241">Will be set to **true**.</span></span> |

#### <a name="error-response"></a><span data-ttu-id="62cff-242">Сообщение об ошибке</span><span class="sxs-lookup"><span data-stu-id="62cff-242">Error response</span></span>
<span data-ttu-id="62cff-243">Если администратор не утверждает разрешения для приложения, то сообщение о неудачном выполнении будет выглядеть следующим образом.</span><span class="sxs-lookup"><span data-stu-id="62cff-243">If the admin does not approve the permissions for your app, the failed response looks like this:</span></span>

```
GET http://localhost/myapp/permissions?error=permission_denied&error_description=The+admin+canceled+the+request
```

| <span data-ttu-id="62cff-244">Параметр</span><span class="sxs-lookup"><span data-stu-id="62cff-244">Parameter</span></span> | <span data-ttu-id="62cff-245">Описание</span><span class="sxs-lookup"><span data-stu-id="62cff-245">Description</span></span> |
| --- | --- | --- |
| <span data-ttu-id="62cff-246">error</span><span class="sxs-lookup"><span data-stu-id="62cff-246">error</span></span> |<span data-ttu-id="62cff-247">Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них.</span><span class="sxs-lookup"><span data-stu-id="62cff-247">An error code string that can be used to classify types of errors that occur, and can be used to react to errors.</span></span> |
| <span data-ttu-id="62cff-248">error_description</span><span class="sxs-lookup"><span data-stu-id="62cff-248">error_description</span></span> |<span data-ttu-id="62cff-249">Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки.</span><span class="sxs-lookup"><span data-stu-id="62cff-249">A specific error message that can help a developer identify the root cause of an error.</span></span> |

<span data-ttu-id="62cff-250">После получения успешного ответа от конечной точки предоставления согласия администратора приложение получит запрошенные разрешения.</span><span class="sxs-lookup"><span data-stu-id="62cff-250">After you've received a successful response from the admin consent endpoint, your app has gained the permissions it requested.</span></span> <span data-ttu-id="62cff-251">Далее вы можете запросить маркер для ресурса, который вам нужен.</span><span class="sxs-lookup"><span data-stu-id="62cff-251">Next, you can request a token for the resource you want.</span></span>

## <a name="using-permissions"></a><span data-ttu-id="62cff-252">Использование разрешений</span><span class="sxs-lookup"><span data-stu-id="62cff-252">Using permissions</span></span>
<span data-ttu-id="62cff-253">После того как пользователь предоставит разрешения для приложения, оно может получать маркеры доступа, представляющие разрешение приложения на определенный уровень доступа к ресурсу.</span><span class="sxs-lookup"><span data-stu-id="62cff-253">After the user consents to permissions for your app, your app can acquire access tokens that represent your app's permission to access a resource in some capacity.</span></span> <span data-ttu-id="62cff-254">Маркер доступа можно использовать только для отдельного ресурса, но в этом маркере закодированы все разрешения, предоставленные приложению для данного ресурса.</span><span class="sxs-lookup"><span data-stu-id="62cff-254">An access token can be used only for a single resource, but encoded inside the access token is every permission that your app has been granted for that resource.</span></span> <span data-ttu-id="62cff-255">Чтобы получить маркер доступа, приложение может отправить запрос к конечной точке маркеров версии 2.0, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="62cff-255">To acquire an access token, your app can make a request to the v2.0 token endpoint, like this:</span></span>

```
POST common/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
    "grant_type": "authorization_code",
    "client_id": "6731de76-14a6-49ae-97bc-6eba6914391e",
    "scope": "https://outlook.office.com/mail.read https://outlook.office.com/mail.send",
    "code": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq..."
    "redirect_uri": "https://localhost/myapp",
    "client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

<span data-ttu-id="62cff-256">Полученный маркер доступа можно использовать в HTTP-запросах к ресурсу.</span><span class="sxs-lookup"><span data-stu-id="62cff-256">You can use the resulting access token in HTTP requests to the resource.</span></span> <span data-ttu-id="62cff-257">Он достоверно указывает ресурсу, что у приложения имеется необходимое разрешение для выполнения определенной задачи.</span><span class="sxs-lookup"><span data-stu-id="62cff-257">It reliably indicates to the resource that your app has the proper permission to perform a specific task.</span></span>  

<span data-ttu-id="62cff-258">Дополнительные сведения о протоколе OAuth 2.0 и способах получения маркеров доступа можно найти в [справочнике по протоколу конечной точки версии 2.0](active-directory-v2-protocols.md).</span><span class="sxs-lookup"><span data-stu-id="62cff-258">For more information about the OAuth 2.0 protocol and how to get access tokens, see the [v2.0 endpoint protocol reference](active-directory-v2-protocols.md).</span></span>

---
title: "aaaDeveloper руководство по Azure Active Directory условного доступа | Документы Microsoft"
description: "Руководство для разработчиков и сценарии по условному доступу в Azure AD"
services: active-directory
keywords: 
author: danieldobalian
manager: mbaldwin
editor: PatAltimore
ms.author: dadobali
ms.date: 07/19/2017
ms.assetid: 115bdab2-e1fd-4403-ac15-d4195e24ac95
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.openlocfilehash: 589393f5d084d64872b372d895dc889f300592bf
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="developer-guidance-for-azure-active-directory-conditional-access"></a><span data-ttu-id="d4108-103">Руководство для разработчиков по условному доступу в Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="d4108-103">Developer Guidance for Azure Active Directory Conditional Access</span></span>

<span data-ttu-id="d4108-104">Azure Active Directory (AD) предлагает несколько способов toosecure приложения и службы защиты.</span><span class="sxs-lookup"><span data-stu-id="d4108-104">Azure Active Directory (AD) offers several ways toosecure your app and protect a service.</span></span>  <span data-ttu-id="d4108-105">Одним из этих уникальных способов является условный доступ.</span><span class="sxs-lookup"><span data-stu-id="d4108-105">One of these unique features is conditional access.</span></span>  <span data-ttu-id="d4108-106">Условный доступ позволяет разработчикам и корпоративных клиентов служб tooprotect множеством способов, в том числе:</span><span class="sxs-lookup"><span data-stu-id="d4108-106">Conditional access enables developers and enterprise customers tooprotect services in a multitude of ways including:</span></span>

* <span data-ttu-id="d4108-107">Многофакторная проверка подлинности</span><span class="sxs-lookup"><span data-stu-id="d4108-107">Multi-factor authentication</span></span>
* <span data-ttu-id="d4108-108">Разрешение только Intune зарегистрированных устройств tooaccess определенных служб</span><span class="sxs-lookup"><span data-stu-id="d4108-108">Allowing only Intune enrolled devices tooaccess specific services</span></span>
* <span data-ttu-id="d4108-109">ограничение расположения пользователей и диапазонов IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="d4108-109">Restricting user locations and IP ranges</span></span>

<span data-ttu-id="d4108-110">Дополнительные сведения о полных возможностях hello условного доступа см. в разделе [условного доступа в классический портал Azure hello](../active-directory-conditional-access.md).</span><span class="sxs-lookup"><span data-stu-id="d4108-110">For more information on hello full capabilities of conditional access, see [Conditional access in hello Azure classic portal](../active-directory-conditional-access.md).</span></span> 

<span data-ttu-id="d4108-111">В этой статье рассматривается какие условного доступа означает toodevelopers создание приложений для Azure AD.</span><span class="sxs-lookup"><span data-stu-id="d4108-111">In this article, we focus on what conditional access means toodevelopers building apps for Azure AD.</span></span>  <span data-ttu-id="d4108-112">Предполагается знание [однотенантных](active-directory-integrating-applications.md) и [мультитенантных](active-directory-devhowto-multi-tenant-overview.md) приложений, а также [распространенных шаблонов аутентификации](active-directory-authentication-scenarios.md).</span><span class="sxs-lookup"><span data-stu-id="d4108-112">It assumes knowledge of [single](active-directory-integrating-applications.md) and [multi-tenant](active-directory-devhowto-multi-tenant-overview.md) apps and [common authentication patterns](active-directory-authentication-scenarios.md).</span></span>

<span data-ttu-id="d4108-113">Мы будем подробно рассмотреть влияние hello доступ к ресурсам, не имеет контроль над которым может применяются политики условного доступа.</span><span class="sxs-lookup"><span data-stu-id="d4108-113">We'll dive into hello impact of accessing resources you don't have control over that may have conditional access policies applied.</span></span>  <span data-ttu-id="d4108-114">Кроме того мы исследуем последствия hello условным доступом hello от имени представляет потока веб-приложений, доступ к Microsoft Graph hello и вызова интерфейсов API.</span><span class="sxs-lookup"><span data-stu-id="d4108-114">Moreover, we explore hello implications of conditional access in hello on-behalf-of flow, web apps, accessing hello Microsoft Graph, and calling APIs.</span></span>

## <a name="how-does-conditional-access-impact-an-app"></a><span data-ttu-id="d4108-115">Как условный доступ влияет на приложения</span><span class="sxs-lookup"><span data-stu-id="d4108-115">How does conditional access impact an app?</span></span>

### <a name="app-topologies-impacted"></a><span data-ttu-id="d4108-116">Затронутые топологии приложения</span><span class="sxs-lookup"><span data-stu-id="d4108-116">App topologies impacted</span></span>

<span data-ttu-id="d4108-117">В наиболее распространенных случаях условного доступа не приводит к изменению поведения приложения или требует изменения от разработчика hello.</span><span class="sxs-lookup"><span data-stu-id="d4108-117">In most common cases, conditional access does not change an app's behavior or requires any changes from hello developer.</span></span>  <span data-ttu-id="d4108-118">Только в некоторых случаях при приложения без вмешательства пользователя или косвенно запрашивает маркер для службы, приложению требуются изменения кода toohandle условный доступ «проблемы».</span><span class="sxs-lookup"><span data-stu-id="d4108-118">Only in certain cases when an app indirectly or silently requests a token for a service, an app requires code changes toohandle conditional access "challenges".</span></span>  <span data-ttu-id="d4108-119">Это может быть так же просто, как выполнение запроса на интерактивный вход.</span><span class="sxs-lookup"><span data-stu-id="d4108-119">It may be as simple as performing an interactive sign-in request.</span></span> 

<span data-ttu-id="d4108-120">В частности, hello следующих сценариях требуется код toohandle условный доступ «проблемы»:</span><span class="sxs-lookup"><span data-stu-id="d4108-120">Specifically, hello following scenarios require code toohandle conditional access "challenges":</span></span> 

* <span data-ttu-id="d4108-121">Приложения, обращающиеся к hello Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="d4108-121">Apps accessing hello Microsoft Graph</span></span>
* <span data-ttu-id="d4108-122">Выполнение hello от имени представляет поток приложения</span><span class="sxs-lookup"><span data-stu-id="d4108-122">Apps performing hello on-behalf-of flow</span></span>
* <span data-ttu-id="d4108-123">приложения, получающие доступ к нескольким службам или ресурсам;</span><span class="sxs-lookup"><span data-stu-id="d4108-123">Apps accessing multiple services/resources</span></span>
* <span data-ttu-id="d4108-124">одностраничные приложения, использующие ADAL.js.</span><span class="sxs-lookup"><span data-stu-id="d4108-124">Single page apps using ADAL.js</span></span>

<span data-ttu-id="d4108-125">Политики условного доступа может быть применен toohello приложения, но также может быть применен tooa веб-API приложение обращается к.</span><span class="sxs-lookup"><span data-stu-id="d4108-125">Conditional access policies can be applied toohello app, but also can be applied tooa web API your app accesses.</span></span> <span data-ttu-id="d4108-126">Дополнительные сведения о toolearn как tooconfigure политику условного доступа см. в разделе [Приступая к работе с Azure Active Directory условного доступа](../active-directory-conditional-access-azuread-connected-apps.md#configure-per-application-access-rules).</span><span class="sxs-lookup"><span data-stu-id="d4108-126">toolearn more about how tooconfigure a conditional access policy, please see [Getting started with Azure Active Directory Conditional Access](../active-directory-conditional-access-azuread-connected-apps.md#configure-per-application-access-rules).</span></span>

<span data-ttu-id="d4108-127">В зависимости от сценария hello корпоративный клиент можно применять и удалять политики условного доступа в любое время.</span><span class="sxs-lookup"><span data-stu-id="d4108-127">Depending on hello scenario, an enterprise customer can apply and remove conditional access policies at any time.</span></span>  <span data-ttu-id="d4108-128">Чтобы вашего приложения toocontinue работать при применении новой политики необходимо tooimplement hello» задача» обработка.</span><span class="sxs-lookup"><span data-stu-id="d4108-128">In order for your app toocontinue functioning when a new policy is applied, you need tooimplement hello "challenge" handling.</span></span> <span data-ttu-id="d4108-129">Привет, следующие примеры иллюстрируют обработки запроса.</span><span class="sxs-lookup"><span data-stu-id="d4108-129">hello following examples illustrate challenge handling.</span></span> 

### <a name="conditional-access-examples"></a><span data-ttu-id="d4108-130">Примеры условного доступа</span><span class="sxs-lookup"><span data-stu-id="d4108-130">Conditional access examples</span></span>

<span data-ttu-id="d4108-131">В некоторых сценариях требуется код изменения toohandle условного доступа, тогда как другие работать как есть.</span><span class="sxs-lookup"><span data-stu-id="d4108-131">Some scenarios require code changes toohandle conditional access whereas others work as is.</span></span>  <span data-ttu-id="d4108-132">Ниже приведены несколько сценариев, с помощью условного доступа toodo многофакторной проверки подлинности, предоставляет некоторые регулировать различие hello.</span><span class="sxs-lookup"><span data-stu-id="d4108-132">Here are a few scenarios using conditional access toodo multi-factor authentication that gives some insight into hello difference.</span></span>

* <span data-ttu-id="d4108-133">Создается однотенантное приложение iOS и применяется политика условного доступа.</span><span class="sxs-lookup"><span data-stu-id="d4108-133">You are building a single-tenant iOS app and apply a conditional access policy.</span></span>  <span data-ttu-id="d4108-134">приложение Hello выполняет вход пользователя и не запроса доступа tooan API.</span><span class="sxs-lookup"><span data-stu-id="d4108-134">hello app signs in a user and doesn't request access tooan API.</span></span>  <span data-ttu-id="d4108-135">При входе в систему пользователя hello политики hello вызывается автоматически, и пользователь hello должен tooperform многофакторной проверки подлинности (MFA).</span><span class="sxs-lookup"><span data-stu-id="d4108-135">When hello user signs in, hello policy is automatically invoked and hello user needs tooperform multi-factor authentication (MFA).</span></span> 
* <span data-ttu-id="d4108-136">При создании нескольких клиентов веб-приложения, использующего Microsoft Graph hello tooaccess Exchange, среди других служб.</span><span class="sxs-lookup"><span data-stu-id="d4108-136">You are building a multi-tenant web app that uses hello Microsoft Graph tooaccess Exchange, among other services.</span></span>  <span data-ttu-id="d4108-137">Корпоративный клиент, использующий это приложение, устанавливает политику для SharePoint Online.</span><span class="sxs-lookup"><span data-stu-id="d4108-137">An enterprise customer who adopts this app sets a policy on SharePoint Online.</span></span>  <span data-ttu-id="d4108-138">Когда hello веб-приложение запрашивает маркер для Microsoft Graph, применения политики на любой службы Microsoft (в частности службы, которые можно получить с помощью graph).</span><span class="sxs-lookup"><span data-stu-id="d4108-138">When hello web app requests a token for MS Graph, a policy on any Microsoft Service is applied (specifically services that can be accessed through graph).</span></span>  <span data-ttu-id="d4108-139">Пользователю предлагается пройти многофакторную проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="d4108-139">This end-user is prompted for MFA.</span></span> <span data-ttu-id="d4108-140">В случае hello hello для конечных пользователей, вошли допустимые токены, утверждения «запрос», возвращается toohello веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="d4108-140">In hello case, hello end-user is signed in with valid tokens, a claims "challenge" is returned toohello web app.</span></span>  
* <span data-ttu-id="d4108-141">При создании собственного приложения, в котором используется hello tooaccess службы среднего уровня Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="d4108-141">You are building a native app that uses a middle tier service tooaccess hello Microsoft Graph.</span></span>  <span data-ttu-id="d4108-142">Корпоративный клиент компании hello, с помощью этого приложения применяется tooExchange политики в оперативный режим.</span><span class="sxs-lookup"><span data-stu-id="d4108-142">An enterprise customer at hello company using this app applies a policy tooExchange Online.</span></span>  <span data-ttu-id="d4108-143">При входе в систему конечного пользователя hello собственное приложение запрашивает доступ toohello среднего уровня и отправляет токен hello.</span><span class="sxs-lookup"><span data-stu-id="d4108-143">When an end-user signs in, hello native app requests access toohello middle tier and sends hello token.</span></span>  <span data-ttu-id="d4108-144">Средний уровень Hello выполняет от имени представляет поток toorequest доступа toohello MS Graph.</span><span class="sxs-lookup"><span data-stu-id="d4108-144">hello middle tier performs on-behalf-of flow toorequest access toohello MS Graph.</span></span>  <span data-ttu-id="d4108-145">На этом этапе утверждения «запрос» представлены toohello среднего уровня.</span><span class="sxs-lookup"><span data-stu-id="d4108-145">At this point, a claims "challenge" is presented toohello middle tier.</span></span> <span data-ttu-id="d4108-146">Средний уровень Hello отправляет hello запрос назад toohello собственное приложение, требующий toocomply с политикой условного доступа hello.</span><span class="sxs-lookup"><span data-stu-id="d4108-146">hello middle tier sends hello challenge back toohello native app, which needs toocomply with hello conditional access policy.</span></span>

### <a name="complying-with-a-conditional-access-policy"></a><span data-ttu-id="d4108-147">Соответствие политике условного доступа</span><span class="sxs-lookup"><span data-stu-id="d4108-147">Complying with a conditional access policy</span></span>

<span data-ttu-id="d4108-148">Для разных топологий другое приложение при установлении сеанса hello оценивается политика условного доступа.</span><span class="sxs-lookup"><span data-stu-id="d4108-148">For several different app topologies, a conditional access policy is evaluated when hello session is established.</span></span>  <span data-ttu-id="d4108-149">Как политики условного доступа оперирует гранулярности hello приложений и служб, hello точки, с которой он вызывается сильно зависит от сценария hello вы пытаетесь tooaccomplish.</span><span class="sxs-lookup"><span data-stu-id="d4108-149">As a conditional access policy operates on hello granularity of apps and services, hello point at which it is invoked depends heavily on hello scenario you're trying tooaccomplish.</span></span>

<span data-ttu-id="d4108-150">Если приложение пытается tooaccess службы с помощью политики условного доступа, могут возникнуть проблема условного доступа.</span><span class="sxs-lookup"><span data-stu-id="d4108-150">When your app attempts tooaccess a service with a conditional access policy, it may encounter a conditional access challenge.</span></span>  <span data-ttu-id="d4108-151">Этот запрос зашифрован в hello `claims` параметр, который поставляется в ответе от Azure AD или hello Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="d4108-151">This challenge is encoded in hello `claims` parameter that comes in a response from Azure AD or hello Microsoft Graph.</span></span>  <span data-ttu-id="d4108-152">Ниже приведен пример этого параметра запроса:</span><span class="sxs-lookup"><span data-stu-id="d4108-152">Here's an example of this challenge parameter:</span></span> 

```
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

<span data-ttu-id="d4108-153">Разработчики могут воспользоваться этой проблемы и добавить его на новый tooAzure запрос AD.</span><span class="sxs-lookup"><span data-stu-id="d4108-153">Developers can take this challenge and append it onto a new request tooAzure AD.</span></span>  <span data-ttu-id="d4108-154">Передача это состояние предлагает toocomply любые необходимые действия, с помощью политики условного доступа hello hello tooperform конечного пользователя.</span><span class="sxs-lookup"><span data-stu-id="d4108-154">Passing this state prompts hello end-user tooperform any action necessary toocomply with hello conditional access policy.</span></span> <span data-ttu-id="d4108-155">Следующие сценарии hello описываются особенности ошибки hello и как tooextract hello параметра.</span><span class="sxs-lookup"><span data-stu-id="d4108-155">In hello following scenarios, specifics of hello error and how tooextract hello parameter are explained.</span></span> 

## <a name="scenarios"></a><span data-ttu-id="d4108-156">Сценарии</span><span class="sxs-lookup"><span data-stu-id="d4108-156">Scenarios</span></span>

### <a name="prerequisites"></a><span data-ttu-id="d4108-157">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="d4108-157">Prerequisites</span></span>

<span data-ttu-id="d4108-158">Условный доступ Azure AD — это функция, включенная в [Azure AD Premium](../active-directory-whatis.md#choose-an-edition).</span><span class="sxs-lookup"><span data-stu-id="d4108-158">Azure AD conditional access is a feature included in [Azure AD Premium](../active-directory-whatis.md#choose-an-edition).</span></span>  <span data-ttu-id="d4108-159">Дополнительные сведения о лицензировании требований в hello [Нелицензированное использование отчетов](../active-directory-conditional-access-unlicensed-usage-report.md).</span><span class="sxs-lookup"><span data-stu-id="d4108-159">You can learn more about licensing requirements in hello [unlicensed usage report](../active-directory-conditional-access-unlicensed-usage-report.md).</span></span>  <span data-ttu-id="d4108-160">Разработчики могут присоединить hello [Microsoft Developer Network](https://msdn.microsoft.com/dn308572.aspx), включающее toohello бесплатная подписка Enterprise Mobility Suite, которая включает Azure AD Premium.</span><span class="sxs-lookup"><span data-stu-id="d4108-160">Developers can join hello [Microsoft Developer Network](https://msdn.microsoft.com/dn308572.aspx), which includes a free subscription toohello Enterprise Mobility Suite which includes Azure AD Premium.</span></span>

### <a name="considerations-for-specific-scenarios"></a><span data-ttu-id="d4108-161">Рекомендации для конкретных сценариев</span><span class="sxs-lookup"><span data-stu-id="d4108-161">Considerations for specific scenarios</span></span>

<span data-ttu-id="d4108-162">в этих сценариях условного доступа применяется Hello следующую информацию только:</span><span class="sxs-lookup"><span data-stu-id="d4108-162">hello following information only applies in these conditional access scenarios:</span></span>

* <span data-ttu-id="d4108-163">Приложения, обращающиеся к hello Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="d4108-163">Apps accessing hello Microsoft Graph</span></span>
* <span data-ttu-id="d4108-164">Выполнение hello от имени представляет поток приложения</span><span class="sxs-lookup"><span data-stu-id="d4108-164">Apps performing hello on-behalf-of flow</span></span>
* <span data-ttu-id="d4108-165">приложения, получающие доступ к нескольким службам или ресурсам;</span><span class="sxs-lookup"><span data-stu-id="d4108-165">Apps accessing multiple services/resources</span></span>
* <span data-ttu-id="d4108-166">одностраничные приложения, использующие ADAL.js.</span><span class="sxs-lookup"><span data-stu-id="d4108-166">Single page apps using ADAL.js</span></span>

<span data-ttu-id="d4108-167">В следующих разделах hello мы получаем в общих сценариев, в которых являются более сложными.</span><span class="sxs-lookup"><span data-stu-id="d4108-167">In hello following sections, we'll get into common scenarios in which are more complex.</span></span>  <span data-ttu-id="d4108-168">Hello принцип работы лежит политики оцениваются на hello hello маркера при запросе службы hello с политикой условного доступа применяются, если осуществляется через hello Microsoft Graph условного доступа.</span><span class="sxs-lookup"><span data-stu-id="d4108-168">hello core operating principle is conditional access policies are evaluated at hello time hello token is requested for hello service that has a conditional access policy applied unless it's being accessed through hello Microsoft Graph.</span></span>

### <a name="scenario-app-accessing-hello-microsoft-graph"></a><span data-ttu-id="d4108-169">Сценария: Доступ к hello Microsoft Graph приложение</span><span class="sxs-lookup"><span data-stu-id="d4108-169">Scenario: App accessing hello Microsoft Graph</span></span>

<span data-ttu-id="d4108-170">В этом сценарии мы будем рассматривать hello случай если веб-приложение запрашивает доступ toohello Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="d4108-170">In this scenario, we walk through hello case when a web app requests access toohello Microsoft Graph.</span></span> <span data-ttu-id="d4108-171">политики условного доступа Hello в этом случае может назначаться tooSharePoint Exchange и другие службы, к которому осуществляется в качестве рабочей нагрузки по hello Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="d4108-171">hello conditional access policy in this case could be assigned tooSharePoint, Exchange, or some other service that is accessed as a workload through hello Microsoft Graph.</span></span>  <span data-ttu-id="d4108-172">В этом примере предположим, что для Sharepoint Online имеется политика условного доступа.</span><span class="sxs-lookup"><span data-stu-id="d4108-172">In this example, let's assume there's a conditional access policy on Sharepoint Online.</span></span>

![Приложения, доступ к Microsoft Graph схема hello](media/active-directory-conditional-access-developer/app-accessing-microsoft-graph-scenario.png)

<span data-ttu-id="d4108-174">приложение Hello сначала запрашивает авторизацию toohello Microsoft Graph, которой требуется доступ к подчиненным рабочую нагрузку без условного доступа.</span><span class="sxs-lookup"><span data-stu-id="d4108-174">hello app first requests authorization toohello Microsoft Graph which requires accessing a downstream workload without conditional access.</span></span>  <span data-ttu-id="d4108-175">Hello запрос завершается успешно без вызова любая политика, и приложение hello получение маркеров для Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="d4108-175">hello request succeeds without invoking any policy and hello app receives tokens for Microsoft Graph.</span></span>  <span data-ttu-id="d4108-176">На этом этапе приложение hello имеете права использовать маркер доступа hello запрос носителя для конечной точки hello запрошено.</span><span class="sxs-lookup"><span data-stu-id="d4108-176">At this point, hello app may use hello access token in a bearer request for hello endpoint requested.</span></span> <span data-ttu-id="d4108-177">Теперь приложение hello требуется tooaccess к Sharepoint Online конечной точке Microsoft Graph, например:`https://graph.microsoft.com/v1.0/me/mySite`</span><span class="sxs-lookup"><span data-stu-id="d4108-177">Now, hello app needs tooaccess a Sharepoint Online endpoint of Microsoft Graph, for example: `https://graph.microsoft.com/v1.0/me/mySite`</span></span>

<span data-ttu-id="d4108-178">приложение Hello уже имеет допустимый токен для hello Microsoft Graph, поэтому он может выполнять hello новый запрос без выдается новый токен.</span><span class="sxs-lookup"><span data-stu-id="d4108-178">hello app already has a valid token for hello Microsoft Graph, so it can perform hello new request without being issued a new token.</span></span> <span data-ttu-id="d4108-179">Этот запрос завершается неудачей и запрос утверждения, выданные Microsoft Graph в форме hello HTTP 403 — запрещено с ```WWW-Authenticate``` задачей.</span><span class="sxs-lookup"><span data-stu-id="d4108-179">This request fails and a claims challenge is issued from Microsoft Graph in hello form of an HTTP 403 Forbidden with a ```WWW-Authenticate``` challenge.</span></span>
<span data-ttu-id="d4108-180">Ниже приведен пример hello ответа:</span><span class="sxs-lookup"><span data-stu-id="d4108-180">Here's an example of hello response:</span></span> 

```
HTTP 403; Forbidden 
error=insufficient_claims
www-authenticate="Bearer realm="", authorization_uri="https://login.windows.net/common/oauth2/authorize", client_id="<GUID>", error=insufficient_claims, claims={"access_token":{"polids":{"essential":true,"values":["<GUID>"]}}}"
```

<span data-ttu-id="d4108-181">Hello утверждений запрос находится внутри hello ```WWW-Authenticate``` заголовок, который может быть параметром утверждений hello проанализированный tooextract hello следующего запроса.</span><span class="sxs-lookup"><span data-stu-id="d4108-181">hello claims challenge is inside hello ```WWW-Authenticate``` header, which can be parsed tooextract hello claims parameter for hello next request.</span></span>  <span data-ttu-id="d4108-182">После присоединенных toohello новый запрос, Azure AD знает политики условного доступа hello tooevaluate при входе пользователя hello и приложение hello теперь hello политики условного доступа в соответствии с.</span><span class="sxs-lookup"><span data-stu-id="d4108-182">Once it's appended toohello new request, Azure AD knows tooevaluate hello conditional access policy when signing in hello user and hello app is now in compliance with hello conditional access policy.</span></span>  <span data-ttu-id="d4108-183">Повторение hello запроса toohello Sharepoint Online конечная точка была выполнена успешно.</span><span class="sxs-lookup"><span data-stu-id="d4108-183">Repeating hello request toohello Sharepoint Online endpoint succeeds.</span></span>

<span data-ttu-id="d4108-184">Примеры кода демонстрируют, как toohandle hello утверждения запроса, см. в разделе toohello [образца кода рабочего стола .NET](https://github.com/Azure-Samples/active-directory-dotnet-native-desktop) для ADAL .NET или hello [образец кода от имени представляет](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca) для ADAL .NET.</span><span class="sxs-lookup"><span data-stu-id="d4108-184">For code samples that demonstrate how toohandle hello claims challenge, refer toohello [.NET Desktop code sample](https://github.com/Azure-Samples/active-directory-dotnet-native-desktop) for ADAL .NET or hello [On-behalf-of code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca) for ADAL .NET.</span></span>

### <a name="scenario-app-performing-hello-on-behalf-of-flow"></a><span data-ttu-id="d4108-185">Сценария: Выполнение hello от имени представляет поток приложения</span><span class="sxs-lookup"><span data-stu-id="d4108-185">Scenario: App performing hello on-behalf-of flow</span></span>

<span data-ttu-id="d4108-186">В этом сценарии мы будем рассматривать hello случай, в котором собственное приложение вызывает веб-службы или API.</span><span class="sxs-lookup"><span data-stu-id="d4108-186">In this scenario, we walk through hello case in which a native app calls a web service/API.</span></span>  <span data-ttu-id="d4108-187">В свою очередь, применения службы [Здравствуйте, «от имени представляет» потока](active-directory-authentication-scenarios.md#application-types-and-scenarios) toocall нижестоящую службу.</span><span class="sxs-lookup"><span data-stu-id="d4108-187">In turn, this service does [hello "on-behalf-of" flow](active-directory-authentication-scenarios.md#application-types-and-scenarios) toocall a downstream service.</span></span>  <span data-ttu-id="d4108-188">В нашем случае мы применили условного доступа политики toohello подчиненных услуги (веб-API 2) и используете собственное приложение, а не серверное/управляющее приложение.</span><span class="sxs-lookup"><span data-stu-id="d4108-188">In our case, we've applied our conditional access policy toohello downstream service (Web API 2) and are using a native app rather than a server/daemon app.</span></span> 

![Выполнение hello от имени представляет блок-схема приложения](media/active-directory-conditional-access-developer/app-performing-on-behalf-of-scenario.png)

<span data-ttu-id="d4108-190">исходный запрос маркера Hello для веб-API 1 не запрашивает hello конечного пользователя для многофакторной проверки подлинности как веб-API 1 могут не всегда обращение hello подчиненных API.</span><span class="sxs-lookup"><span data-stu-id="d4108-190">hello initial token request for Web API 1 does not prompt hello end-user for multi-factor authentication as Web API 1 may not always hit hello downstream API.</span></span>  <span data-ttu-id="d4108-191">Когда веб-API 1 пытается toorequest hello маркера от имени представляет пользователя для веб-API 2, hello запрос завершается с ошибкой, поскольку hello пользователь не выполнил вход с помощью многофакторной проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="d4108-191">Once Web API 1 tries toorequest a token on-behalf-of hello user for Web API 2, hello request fails since hello user has not signed in with multi-factor authentication.</span></span>

<span data-ttu-id="d4108-192">Azure AD возвращает ответ HTTP с некоторыми полезными данными:</span><span class="sxs-lookup"><span data-stu-id="d4108-192">Azure AD returns an HTTP response with some interesting data:</span></span> 

> [!NOTE]
> <span data-ttu-id="d4108-193">В данном случае это описание ошибки многофакторной проверки подлинности, но существует широкий спектр `interaction_required` относится tooconditional доступ.</span><span class="sxs-lookup"><span data-stu-id="d4108-193">In this instance it's a multi-factor authentication error description, but there's a wide range of `interaction_required` possible pertaining tooconditional access.</span></span>  

```
HTTP 400; Bad Request 
error=interaction_required
error_description=AADSTS50076: Due tooa configuration change made by your administrator, or because you moved tooa new location, you must use multi-factor authentication tooaccess '<Web API 2 App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

<span data-ttu-id="d4108-194">В наших веб-API 1 мы перехватывать ошибки hello `error=interaction_required`и отправить назад hello `claims` запроса toohello классического приложения.</span><span class="sxs-lookup"><span data-stu-id="d4108-194">In our Web API 1, we catch hello error `error=interaction_required`, and send back hello `claims` challenge toohello desktop app.</span></span>  <span data-ttu-id="d4108-195">На этом этапе можно сделать новый классического приложения hello `acquireToken()` вызова и добавить hello `claims`запрос как параметр запроса лишние строки.</span><span class="sxs-lookup"><span data-stu-id="d4108-195">At that point, hello desktop app can make a new `acquireToken()` call and append hello `claims`challenge as an extra query string parameter.</span></span>  <span data-ttu-id="d4108-196">Этот новый запрос требует hello пользователя toodo многофакторной проверки подлинности, а затем отправьте этот новый токен задней tooWeb API 1 и завершения hello от имени представляет поток.</span><span class="sxs-lookup"><span data-stu-id="d4108-196">This new request requires hello user toodo multi-factor authentication and then send this new token back tooWeb API 1 and complete hello on-behalf-of flow.</span></span>

<span data-ttu-id="d4108-197">tootry out этого сценария см. наш [образец кода .NET](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span><span class="sxs-lookup"><span data-stu-id="d4108-197">tootry out this scenario, see our [.NET code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span></span>  <span data-ttu-id="d4108-198">Он демонстрирует, как toopass hello утверждения запроса из веб-API 1 toohello собственное приложение и создать новый запрос в клиентское приложение hello.</span><span class="sxs-lookup"><span data-stu-id="d4108-198">It demonstrates how toopass hello claims challenge back from Web API 1 toohello native app and construct a new request inside hello client app.</span></span> 

### <a name="scenario-app-accessing-multiple-services"></a><span data-ttu-id="d4108-199">Сценарий: приложение, получающее доступ к нескольким службам</span><span class="sxs-lookup"><span data-stu-id="d4108-199">Scenario: App accessing multiple services</span></span>

<span data-ttu-id="d4108-200">В этом сценарии мы будем рассматривать случай hello две службы обращается к веб-приложения, один из которых имеет назначенный политику условного доступа.</span><span class="sxs-lookup"><span data-stu-id="d4108-200">In this scenario, we walk through hello case in which a web app accesses two services one of which has a conditional access policy assigned.</span></span>  <span data-ttu-id="d4108-201">В зависимости от логики приложения могут существовать пути, в которой приложение не требует доступа tooboth веб-службы.</span><span class="sxs-lookup"><span data-stu-id="d4108-201">Depending on your app logic, there may exist a path in which your app does not require access tooboth web services.</span></span>  <span data-ttu-id="d4108-202">В этом сценарии hello порядок, в котором запрос маркера играет важную роль в hello взаимодействие с пользователем.</span><span class="sxs-lookup"><span data-stu-id="d4108-202">In this scenario, hello order in which you request a token plays an important role in hello end-user experience.</span></span>

<span data-ttu-id="d4108-203">Предположим, что у нас есть веб-службы A и B. К веб-службе B применяется политика условного доступа.</span><span class="sxs-lookup"><span data-stu-id="d4108-203">Let's assume we have web service A and B and web service B has our conditional access policy applied.</span></span>  <span data-ttu-id="d4108-204">Хотя запрос начальной проверки подлинности интерактивных hello необходимы разрешения для обеих служб, hello политики условного доступа не требуется во всех случаях.</span><span class="sxs-lookup"><span data-stu-id="d4108-204">While hello initial interactive auth request requires consent for both services, hello conditional access policy is not required in all cases.</span></span>  <span data-ttu-id="d4108-205">Если приложение hello запрашивает маркер для веб-службы B, вызывается политика hello, и последующие запросы для веб-службы, А также завершается успешно, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="d4108-205">If hello app requests a token for web service B, then hello policy is invoked and subsequent requests for web service A also succeeds as follows.</span></span>

![Схема приложения, получающего доступ к нескольким службам](media/active-directory-conditional-access-developer/app-accessing-multiple-services-scenario.png)

<span data-ttu-id="d4108-207">Кроме того Если приложение hello изначально запрашивает маркер для web service A, hello для конечных пользователей не вызывает hello политики условного доступа.</span><span class="sxs-lookup"><span data-stu-id="d4108-207">Alternatively, if hello app initially requests a token for web service A, hello end-user does not invoke hello conditional access policy.</span></span>  <span data-ttu-id="d4108-208">Это позволяет разработчику приложения hello hello toocontrol взаимодействии с пользователем и не используется принудительное hello условным доступом политики toobe вызывается во всех случаях.</span><span class="sxs-lookup"><span data-stu-id="d4108-208">This allows hello app developer toocontrol hello end-user experience and not force hello conditional access policy toobe invoked in all cases.</span></span> <span data-ttu-id="d4108-209">Hello сложным случаем является, если приложение hello впоследствии запрашивает маркер для веб-службы б. На этом этапе конечный пользователь hello должен toocomply с политикой условного доступа hello.</span><span class="sxs-lookup"><span data-stu-id="d4108-209">hello tricky case is if hello app subsequently requests a token for web service B. At this point, hello end-user needs toocomply with hello conditional access policy.</span></span>  <span data-ttu-id="d4108-210">Когда приложение hello пытается слишком`acquireToken`, он может генерировать hello следующая ошибка (как показано на следующая диаграмме hello):</span><span class="sxs-lookup"><span data-stu-id="d4108-210">When hello app tries too`acquireToken`, it may generate hello following error (illustrated in hello following diagram):</span></span> 

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due tooa configuration change made by your administrator, or because you moved tooa new location, you must use multi-factor authentication tooaccess '<Web API App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
``` 

![Приложение, получающее доступ к нескольким службам, запрашивающим новый маркер](media/active-directory-conditional-access-developer/app-accessing-multiple-services-new-token.png)

<span data-ttu-id="d4108-212">Если приложение hello используется библиотека ADAL hello, маркер сбоя tooacquire hello интерактивно всегда перезапускается.</span><span class="sxs-lookup"><span data-stu-id="d4108-212">If hello app is using hello ADAL library, a failure tooacquire hello token is always retried interactively.</span></span>  <span data-ttu-id="d4108-213">При возникновении этого интерактивного запроса, конечный пользователь hello должен toocomply возможности hello с hello условным доступом.</span><span class="sxs-lookup"><span data-stu-id="d4108-213">When this interactive request occurs, hello end-user has hello opportunity toocomply with hello conditional access.</span></span>  <span data-ttu-id="d4108-214">Это верно, если запрашивается hello `AcquireTokenSilentAsync` или `PromptBehavior.Never` в этом случае приложение hello должен tooperform интерактивная ```AcquireToken``` запроса toocomply toogive hello конечного использования hello возможных сделок с политикой hello.</span><span class="sxs-lookup"><span data-stu-id="d4108-214">This is true unless hello request is a `AcquireTokenSilentAsync` or `PromptBehavior.Never` in which case hello app needs tooperform an interactive ```AcquireToken``` request toogive hello end use hello opportunity toocomply with hello policy.</span></span> 

### <a name="scenario-single-page-app-spa-using-adaljs"></a><span data-ttu-id="d4108-215">Сценарий: одностраничное приложение (SPA), использующее ADAL.js</span><span class="sxs-lookup"><span data-stu-id="d4108-215">Scenario: Single Page App (SPA) using ADAL.js</span></span>

<span data-ttu-id="d4108-216">В этом сценарии мы будем рассматривать hello случай, когда у нас есть приложения, написанного на одной странице (SPA), защищенные с помощью ADAL.js toocall условного доступа веб-API.</span><span class="sxs-lookup"><span data-stu-id="d4108-216">In this scenario, we walk through hello case when we have a single page app (SPA), using ADAL.js toocall a conditional access protected web API.</span></span>  <span data-ttu-id="d4108-217">Это простой архитектуры, но имеет некоторые особенности, которые необходимо принимать во внимание при разработке решения условного доступа toobe.</span><span class="sxs-lookup"><span data-stu-id="d4108-217">This is a simple architecture but has some nuances that need toobe taken into account when developing around conditional access.</span></span>

<span data-ttu-id="d4108-218">В ADAL.js есть несколько функций получения маркеров: `login()`, `acquireToken(...)`, `acquireTokenPopup(…)` и `acquireTokenRedirect(…)`.</span><span class="sxs-lookup"><span data-stu-id="d4108-218">In ADAL.js, there are a few functions that obtain tokens: `login()`, `acquireToken(...)`, `acquireTokenPopup(…)`, and `acquireTokenRedirect(…)`.</span></span> 

* <span data-ttu-id="d4108-219">`login()` получает маркер идентификатора через интерактивный запрос на вход, но не получает маркер доступа для любой службы (включая защищенный условным доступом веб-API).</span><span class="sxs-lookup"><span data-stu-id="d4108-219">`login()` obtains an ID token through an interactive sign-in request but does not obtain access tokens for any service (including a conditional access protected web API).</span></span>  
* <span data-ttu-id="d4108-220">`acquireToken(…)`может быть используется toosilently получить маркер доступа, это означает, что он не отображается пользовательский Интерфейс при любых обстоятельствах.</span><span class="sxs-lookup"><span data-stu-id="d4108-220">`acquireToken(…)` can then be used toosilently obtain an access token meaning it does not show UI in any circumstance.</span></span>  
* <span data-ttu-id="d4108-221">`acquireTokenPopup(…)`и `acquireTokenRedirect(…)` являются обоих используется toointeractively запроса маркера для ресурса, то есть они всегда отображать пользовательский Интерфейс входа в систему.</span><span class="sxs-lookup"><span data-stu-id="d4108-221">`acquireTokenPopup(…)` and `acquireTokenRedirect(…)` are both used toointeractively request a token for a resource meaning they always show sign-in UI.</span></span>

<span data-ttu-id="d4108-222">Когда приложению нужен toocall токена доступа веб-API, он предпримет новые попытки `acquireToken(…)`.</span><span class="sxs-lookup"><span data-stu-id="d4108-222">When an app needs an access token toocall a Web API, it attempts an `acquireToken(…)`.</span></span>  <span data-ttu-id="d4108-223">Если истек срок действия маркера сеанса hello или нам нужно toocomply с политикой условного доступа, затем hello *acquireToken* функция завершается с ошибкой, и использует приложение hello `acquireTokenPopup()` или `acquireTokenRedirect()`.</span><span class="sxs-lookup"><span data-stu-id="d4108-223">If hello token session is expired or we need toocomply with a conditional access policy, then hello *acquireToken* function fails and hello app uses `acquireTokenPopup()` or `acquireTokenRedirect()`.</span></span>

![Схема одностраничного приложения, использующего поток ADAL](media/active-directory-conditional-access-developer/spa-using-adal-scenario.png)

<span data-ttu-id="d4108-225">Давайте подробно рассмотрим пример со сценарием условного доступа.</span><span class="sxs-lookup"><span data-stu-id="d4108-225">Let's walk through an example with our conditional access scenario.</span></span>  <span data-ttu-id="d4108-226">Hello для конечных пользователей просто приобретенных на сайте hello и не имеет сеанса.</span><span class="sxs-lookup"><span data-stu-id="d4108-226">hello end-user just landed on hello site and doesn’t have a session.</span></span>  <span data-ttu-id="d4108-227">Мы выполним вызов `login()` и получим идентификатор маркера без многофакторной проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="d4108-227">We perform a `login()` call, get an ID token without multi-factor authentication.</span></span>  <span data-ttu-id="d4108-228">Затем hello пользователь нажимает кнопку, которая требует hello приложения toorequest данные из веб-API.</span><span class="sxs-lookup"><span data-stu-id="d4108-228">Then hello user hits a button that requires hello app toorequest data from a web API.</span></span>  <span data-ttu-id="d4108-229">приложение Hello пытается toodo `acquireToken()` вызов но попытка завершается неудачей, так как пользователь hello многофакторной проверки подлинности еще не выполнено и должен toocomply с политикой условного доступа hello.</span><span class="sxs-lookup"><span data-stu-id="d4108-229">hello app tries toodo an `acquireToken()` call but fails since hello user has not performed multi-factor authentication yet and needs toocomply with hello conditional access policy.</span></span>

<span data-ttu-id="d4108-230">Azure AD отправляет назад hello, выполнив HTTP-ответа:</span><span class="sxs-lookup"><span data-stu-id="d4108-230">Azure AD sends back hello following HTTP response:</span></span> 

```
HTTP 400; Bad Request 
error=interaction_required
error_description=AADSTS50076: Due tooa configuration change made by your administrator, or because you moved tooa new location, you must use multi-factor authentication tooaccess '<Web API App/Client ID>'.
```

<span data-ttu-id="d4108-231">Наш приложению toocatch hello `error=interaction_required`.</span><span class="sxs-lookup"><span data-stu-id="d4108-231">Our app needs toocatch hello `error=interaction_required`.</span></span>  <span data-ttu-id="d4108-232">Hello затем приложение может использовать либо `acquireTokenPopup()` или `acquireTokenRedirect()` на hello же ресурса.</span><span class="sxs-lookup"><span data-stu-id="d4108-232">hello application can then use either `acquireTokenPopup()` or `acquireTokenRedirect()` on hello same resource.</span></span>  <span data-ttu-id="d4108-233">пользователь Hello является принудительное toodo многофакторной проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="d4108-233">hello user is forced toodo a multi-factor authentication.</span></span> <span data-ttu-id="d4108-234">После завершения пользователем hello hello многофакторной проверки подлинности, приложение hello выдается новый токен доступа для hello запрашиваемый ресурс.</span><span class="sxs-lookup"><span data-stu-id="d4108-234">After hello user completes hello multi-factor authentication, hello app is issued a fresh access token for hello requested resource.</span></span>

<span data-ttu-id="d4108-235">tootry out этого сценария см. наш [образец кода от имени представляет JS SPA](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span><span class="sxs-lookup"><span data-stu-id="d4108-235">tootry out this scenario, see our [JS SPA On-behalf-of code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span></span>  <span data-ttu-id="d4108-236">Этот пример кода использует политику условного доступа hello и веб-API, которые вы ранее зарегистрированы с toodemonstrate JS SPA этот сценарий.</span><span class="sxs-lookup"><span data-stu-id="d4108-236">This code sample uses hello conditional access policy and web API you registered earlier with a JS SPA toodemonstrate this scenario.</span></span> <span data-ttu-id="d4108-237">Показано, как утверждения hello дескриптор tooproperly запрос и получить маркер доступа, который может использоваться для веб-API.</span><span class="sxs-lookup"><span data-stu-id="d4108-237">It shows how tooproperly handle hello claims challenge and get an access token that can be used for your Web API.</span></span> <span data-ttu-id="d4108-238">Кроме того, извлечение hello Общие [образец кода Angular.js](https://github.com/Azure-Samples/active-directory-angularjs-singlepageapp) рекомендации по углового SPA</span><span class="sxs-lookup"><span data-stu-id="d4108-238">Alternatively, checkout hello general [Angular.js code sample](https://github.com/Azure-Samples/active-directory-angularjs-singlepageapp) for guidance on an Angular SPA</span></span>


## <a name="see-also"></a><span data-ttu-id="d4108-239">См. также</span><span class="sxs-lookup"><span data-stu-id="d4108-239">See also</span></span>

* <span data-ttu-id="d4108-240">toolearn Дополнительные сведения о возможностях hello. в разделе [условного доступа в Azure AD](../active-directory-conditional-access.md).</span><span class="sxs-lookup"><span data-stu-id="d4108-240">toolearn more about hello capabilities, see [Conditional Access in Azure AD](../active-directory-conditional-access.md).</span></span>
* <span data-ttu-id="d4108-241">Дополнительные примеры кода Azure AD см. в [репозитории примеров кода GitHub](https://github.com/azure-samples?utf8=%E2%9C%93&q=active-directory).</span><span class="sxs-lookup"><span data-stu-id="d4108-241">For more Azure AD code samples, see [Github Repo of Code Samples](https://github.com/azure-samples?utf8=%E2%9C%93&q=active-directory).</span></span> 
* <span data-ttu-id="d4108-242">Дополнительные сведения о hello ADAL SDK и доступа к справочной документации hello см. в разделе [руководство по библиотеки](active-directory-authentication-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="d4108-242">For more info on hello ADAL SDK's and access hello reference documentation, see [library guide](active-directory-authentication-libraries.md).</span></span>
* <span data-ttu-id="d4108-243">toolearn Дополнительные сведения о сценариях с несколькими клиентами, в разделе [как toosign пользователей, используя шаблон несколькими клиентами hello](active-directory-devhowto-multi-tenant-overview.md).</span><span class="sxs-lookup"><span data-stu-id="d4108-243">toolearn more about multi-tenant scenarios, see [How toosign in users using hello multi-tenant pattern](active-directory-devhowto-multi-tenant-overview.md).</span></span>

---
title: "Рекомендации по настройке производительности для Storm в Azure Data Lake Store | Документация Майкрософт"
description: "Рекомендации по настройке производительности для Storm в Azure Data Lake Store"
services: data-lake-store
documentationcenter: 
author: stewu
manager: amitkul
editor: stewu
ms.assetid: ebde7b9f-2e51-4d43-b7ab-566417221335
ms.service: data-lake-store
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: big-data
ms.date: 12/19/2016
ms.author: stewu
ms.openlocfilehash: 1dfa93643f45a96ded3fd022aa8b1c71d487acb4
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="performance-tuning-guidance-for-storm-on-hdinsight-and-azure-data-lake-store"></a><span data-ttu-id="68165-103">Рекомендации по настройке производительности для Storm в HDInsight и Azure Data Lake Store</span><span class="sxs-lookup"><span data-stu-id="68165-103">Performance tuning guidance for Storm on HDInsight and Azure Data Lake Store</span></span>

<span data-ttu-id="68165-104">Изучите факторы, которые важны для настройки производительности в топологии Azure Storm.</span><span class="sxs-lookup"><span data-stu-id="68165-104">Understand the factors that should be considered when you tune the performance of an Azure Storm topology.</span></span> <span data-ttu-id="68165-105">Например, нужно понимать характеристики работы, выполняемой элементами spout и bolt (в случае, когда работа связана с интенсивными рабочими нагрузками ввода-вывода или активным использованием памяти).</span><span class="sxs-lookup"><span data-stu-id="68165-105">For example, it's important to understand the characteristics of the work done by the spouts and the bolts (whether the work is I/O or memory intensive).</span></span> <span data-ttu-id="68165-106">В этой статье рассматривается ряд рекомендаций по улучшению производительности, в том числе по устранению типичных неполадок.</span><span class="sxs-lookup"><span data-stu-id="68165-106">This article covers a range of performance tuning guidelines, including troubleshooting common issues.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="68165-107">Предварительные требования</span><span class="sxs-lookup"><span data-stu-id="68165-107">Prerequisites</span></span>

* <span data-ttu-id="68165-108">**Подписка Azure**.</span><span class="sxs-lookup"><span data-stu-id="68165-108">**An Azure subscription**.</span></span> <span data-ttu-id="68165-109">Ознакомьтесь с [бесплатной пробной версией Azure](https://azure.microsoft.com/pricing/free-trial/).</span><span class="sxs-lookup"><span data-stu-id="68165-109">See [Get Azure free trial](https://azure.microsoft.com/pricing/free-trial/).</span></span>
* <span data-ttu-id="68165-110">**Учетная запись Azure Data Lake Store.**</span><span class="sxs-lookup"><span data-stu-id="68165-110">**An Azure Data Lake Store account**.</span></span> <span data-ttu-id="68165-111">Инструкции по созданию учетной записи см. в статье, посвященной [началу работы с Azure Data Lake Store с помощью портала Azure](data-lake-store-get-started-portal.md).</span><span class="sxs-lookup"><span data-stu-id="68165-111">For instructions on how to create one, see [Get started with Azure Data Lake Store](data-lake-store-get-started-portal.md).</span></span>
* <span data-ttu-id="68165-112">**Кластер Azure HDInsight** с доступом к учетной записи Data Lake Store.</span><span class="sxs-lookup"><span data-stu-id="68165-112">**An Azure HDInsight cluster** with access to a Data Lake Store account.</span></span> <span data-ttu-id="68165-113">См. статью [Создание кластера HDInsight с Data Lake Store с помощью портала Azure](data-lake-store-hdinsight-hadoop-use-portal.md).</span><span class="sxs-lookup"><span data-stu-id="68165-113">See [Create an HDInsight cluster with Data Lake Store](data-lake-store-hdinsight-hadoop-use-portal.md).</span></span> <span data-ttu-id="68165-114">Убедитесь, что вы включили удаленный рабочий стол для кластера.</span><span class="sxs-lookup"><span data-stu-id="68165-114">Make sure you enable Remote Desktop for the cluster.</span></span>
* <span data-ttu-id="68165-115">**Запущенный кластер Storm в Data Lake Store**.</span><span class="sxs-lookup"><span data-stu-id="68165-115">**Running a Storm cluster on Data Lake Store**.</span></span> <span data-ttu-id="68165-116">Дополнительные сведения см. в статье [Основные сведения об Apache Storm в службе HDInsight. Аналитика в реальном времени для Hadoop](https://docs.microsoft.com/en-us/azure/hdinsight/hdinsight-storm-overview).</span><span class="sxs-lookup"><span data-stu-id="68165-116">For more information, see [Storm on HDInsight](https://docs.microsoft.com/en-us/azure/hdinsight/hdinsight-storm-overview).</span></span>
* <span data-ttu-id="68165-117">**Рекомендации по настройке производительности для Data Lake Store**.</span><span class="sxs-lookup"><span data-stu-id="68165-117">**Performance tuning guidelines on Data Lake Store**.</span></span>  <span data-ttu-id="68165-118">Общие вопросы производительности описаны в [рекомендациях по настройке](https://docs.microsoft.com/en-us/azure/data-lake-store/data-lake-store-performance-tuning-guidance).</span><span class="sxs-lookup"><span data-stu-id="68165-118">For general performance concepts, see [Data Lake Store Performance Tuning Guidance](https://docs.microsoft.com/en-us/azure/data-lake-store/data-lake-store-performance-tuning-guidance).</span></span>  

## <a name="tune-the-parallelism-of-the-topology"></a><span data-ttu-id="68165-119">Настройка параллелизма топологии</span><span class="sxs-lookup"><span data-stu-id="68165-119">Tune the parallelism of the topology</span></span>

<span data-ttu-id="68165-120">Возможно, повысить производительность поможет увеличение степени параллелизма операций ввода-вывода для Data Lake Store.</span><span class="sxs-lookup"><span data-stu-id="68165-120">You might be able to improve performance by increasing the concurrency of the I/O to and from Data Lake Store.</span></span> <span data-ttu-id="68165-121">Топология Storm имеет набор конфигураций, которые определяют параллелизм:</span><span class="sxs-lookup"><span data-stu-id="68165-121">A Storm topology has a set of configurations that determine the parallelism:</span></span>
* <span data-ttu-id="68165-122">Количество рабочих процессов. Рабочие роли равномерно распределяются между виртуальными машинами.</span><span class="sxs-lookup"><span data-stu-id="68165-122">Number of worker processes (the workers are evenly distributed across the VMs).</span></span>
* <span data-ttu-id="68165-123">Количество экземпляров исполнителей spout.</span><span class="sxs-lookup"><span data-stu-id="68165-123">Number of spout executor instances.</span></span>
* <span data-ttu-id="68165-124">Количество экземпляров исполнителей bolt.</span><span class="sxs-lookup"><span data-stu-id="68165-124">Number of bolt executor instances.</span></span>
* <span data-ttu-id="68165-125">Количество задач spout.</span><span class="sxs-lookup"><span data-stu-id="68165-125">Number of spout tasks.</span></span>
* <span data-ttu-id="68165-126">Количество задач bolt.</span><span class="sxs-lookup"><span data-stu-id="68165-126">Number of bolt tasks.</span></span>

<span data-ttu-id="68165-127">Предположим, что в кластере с 4 виртуальными машинами и 4 рабочими процессами работают 32 исполнителя и 32 задачи для элемента spout, а также 256 исполнителей и 512 задач для элемента bolt. Для этой ситуации справедливо следующее.</span><span class="sxs-lookup"><span data-stu-id="68165-127">For example, on a cluster with 4 VMs and 4 worker processes, 32 spout executors and 32 spout tasks, and 256 bolt executors and 512 bolt tasks, consider the following:</span></span>

<span data-ttu-id="68165-128">Каждый супервизор, то есть рабочий узел, имеет один рабочий процесс виртуальной машины Java (JVM).</span><span class="sxs-lookup"><span data-stu-id="68165-128">Each supervisor, which is a worker node, has a single worker Java virtual machine (JVM) process.</span></span> <span data-ttu-id="68165-129">Этот процесс JVM управляет 4-мя потоками spout и 64-ю потоками bolt.</span><span class="sxs-lookup"><span data-stu-id="68165-129">This JVM process manages 4 spout threads and 64 bolt threads.</span></span> <span data-ttu-id="68165-130">Внутри каждого потока задачи выполняются последовательно.</span><span class="sxs-lookup"><span data-stu-id="68165-130">Within each thread, tasks are run sequentially.</span></span> <span data-ttu-id="68165-131">В условиях описанной выше конфигурации каждый поток spout выполняет 1 задачу, а каждый поток bolt — 2 задачи.</span><span class="sxs-lookup"><span data-stu-id="68165-131">With the preceding configuration, each spout thread has 1 task, and each bolt thread has 2 tasks.</span></span>

<span data-ttu-id="68165-132">Ниже приведены компоненты Storm, участвующие в процессе, и их влияние на итоговый уровень параллелизма.</span><span class="sxs-lookup"><span data-stu-id="68165-132">In Storm, here are the various components involved, and how they affect the level of parallelism you have:</span></span>
* <span data-ttu-id="68165-133">Головной узел (называемый в Storm Nimbus) используется для отправки заданий и управления ими.</span><span class="sxs-lookup"><span data-stu-id="68165-133">The head node (called Nimbus in Storm) is used to submit and manage jobs.</span></span> <span data-ttu-id="68165-134">Эти узлы не оказывают влияния на степень параллелизма.</span><span class="sxs-lookup"><span data-stu-id="68165-134">These nodes have no impact on the degree of parallelism.</span></span>
* <span data-ttu-id="68165-135">Узлы супервизора.</span><span class="sxs-lookup"><span data-stu-id="68165-135">The supervisor nodes.</span></span> <span data-ttu-id="68165-136">Этот объект HDInsight соответствует рабочему узлу на виртуальной машине Azure.</span><span class="sxs-lookup"><span data-stu-id="68165-136">In HDInsight, this corresponds to a worker node Azure VM.</span></span>
* <span data-ttu-id="68165-137">Рабочие задачи — это процессы Storm, выполняемые на виртуальных машинах.</span><span class="sxs-lookup"><span data-stu-id="68165-137">The worker tasks are Storm processes running in the VMs.</span></span> <span data-ttu-id="68165-138">Каждая рабочая задача соответствует экземпляру виртуальной машины Java.</span><span class="sxs-lookup"><span data-stu-id="68165-138">Each worker task corresponds to a JVM instance.</span></span> <span data-ttu-id="68165-139">Storm распределяет указанное число рабочих процессов между рабочими узлами максимально равномерно.</span><span class="sxs-lookup"><span data-stu-id="68165-139">Storm distributes the number of worker processes you specify to the worker nodes as evenly as possible.</span></span>
* <span data-ttu-id="68165-140">Количество экземпляров исполнителей spout и bolt.</span><span class="sxs-lookup"><span data-stu-id="68165-140">Spout and bolt executor instances.</span></span> <span data-ttu-id="68165-141">Каждый экземпляр исполнителя соответствует потоку, который выполняется в рабочих процессах (на виртуальных машинах Java).</span><span class="sxs-lookup"><span data-stu-id="68165-141">Each executor instance corresponds to a thread running within the workers (JVMs).</span></span>
* <span data-ttu-id="68165-142">Задачи Storm.</span><span class="sxs-lookup"><span data-stu-id="68165-142">Storm tasks.</span></span> <span data-ttu-id="68165-143">Это логические задачи, которые выполняет каждый из потоков.</span><span class="sxs-lookup"><span data-stu-id="68165-143">These are logical tasks that each of these threads run.</span></span> <span data-ttu-id="68165-144">Это не меняет уровень параллелизма, поэтому следует оценить, нужны ли вам несколько задач на каждый исполнитель.</span><span class="sxs-lookup"><span data-stu-id="68165-144">This does not change the level of parallelism, so you should evaluate if you need multiple tasks per executor or not.</span></span>

### <a name="get-the-best-performance-from-data-lake-store"></a><span data-ttu-id="68165-145">Достижение максимальной производительности Data Lake Store</span><span class="sxs-lookup"><span data-stu-id="68165-145">Get the best performance from Data Lake Store</span></span>

<span data-ttu-id="68165-146">Чтобы достичь оптимальной производительности при работе с Azure Data Lake, следует сделать следующее.</span><span class="sxs-lookup"><span data-stu-id="68165-146">When working with Data Lake Store, you get the best performance if you do the following:</span></span>
* <span data-ttu-id="68165-147">Объедините маленькие добавления в пакеты большего размера (в идеале размером по 4 МБ).</span><span class="sxs-lookup"><span data-stu-id="68165-147">Coalesce your small appends into larger sizes (ideally 4 MB).</span></span>
* <span data-ttu-id="68165-148">Выполняйте максимально возможное количество одновременных запросов.</span><span class="sxs-lookup"><span data-stu-id="68165-148">Do as many concurrent requests as you can.</span></span> <span data-ttu-id="68165-149">Так как каждый поток элементов bolt выполняет чтение с блокировкой, желательно выполнять от 8 до 12 потоков на каждое ядро.</span><span class="sxs-lookup"><span data-stu-id="68165-149">Because each bolt thread is doing blocking reads, you want to have somewhere in the range of 8-12 threads per core.</span></span> <span data-ttu-id="68165-150">Это позволит сохранить хорошую нагрузку на сетевой адаптер и ЦП.</span><span class="sxs-lookup"><span data-stu-id="68165-150">This keeps the NIC and the CPU well utilized.</span></span> <span data-ttu-id="68165-151">Крупная виртуальная машина позволяет выполнять большее число параллельных запросов.</span><span class="sxs-lookup"><span data-stu-id="68165-151">A larger VM enables more concurrent requests.</span></span>  

### <a name="example-topology"></a><span data-ttu-id="68165-152">Пример топологии</span><span class="sxs-lookup"><span data-stu-id="68165-152">Example topology</span></span>

<span data-ttu-id="68165-153">Предположим, что у вас есть кластер из 8 рабочих узлов на виртуальной машине Azure D13v2.</span><span class="sxs-lookup"><span data-stu-id="68165-153">Let’s assume you have an 8 worker node cluster with a D13v2 Azure VM.</span></span> <span data-ttu-id="68165-154">Эта виртуальная машина имеет 8 ядер, то есть 8 рабочих узлов в совокупности предоставляют 64 ядра.</span><span class="sxs-lookup"><span data-stu-id="68165-154">This VM has 8 cores, so among the 8 worker nodes, you have 64 total cores.</span></span>

<span data-ttu-id="68165-155">Предположим, что мы запускаем 8 потоков элементов bolt на ядро.</span><span class="sxs-lookup"><span data-stu-id="68165-155">Let’s say we do 8 bolt threads per core.</span></span> <span data-ttu-id="68165-156">Так как у нас есть 64 ядра, мы получаем 512 экземпляров исполнителей элемента bolt (т. е. потоков).</span><span class="sxs-lookup"><span data-stu-id="68165-156">Given 64 cores, that means we want 512 total bolt executor instances (that is, threads).</span></span> <span data-ttu-id="68165-157">Например, мы начинаем с одной виртуальной машины Java на каждую виртуальную машину, а для достижения параллелизма используем в основном параллелизм потоков внутри виртуальной машины Java.</span><span class="sxs-lookup"><span data-stu-id="68165-157">In this case, let’s say we start with one JVM per VM, and mainly use the thread concurrency within the JVM to achieve concurrency.</span></span> <span data-ttu-id="68165-158">Это означает, что нам нужно 8 рабочих задач (по одной на каждую виртуальную машину Azure) и 512 исполнителей элемента bolt.</span><span class="sxs-lookup"><span data-stu-id="68165-158">That means we need 8 worker tasks (one per Azure VM), and 512 bolt executors.</span></span> <span data-ttu-id="68165-159">В такой конфигурации Storm пытается распределить рабочие процессы равномерно между рабочими узлами (узлами супервизора), предоставляя каждому рабочему узлу одну виртуальную машину Java.</span><span class="sxs-lookup"><span data-stu-id="68165-159">Given this configuration, Storm tries to distribute the workers evenly across worker nodes (also known as supervisor nodes), giving each worker node 1 JVM.</span></span> <span data-ttu-id="68165-160">В пределах супервизоров Storm пытается распределить исполнители равномерно между ними, предоставляя каждому супервизору (а следовательно, каждой виртуальной машине Java) по 8 потоков.</span><span class="sxs-lookup"><span data-stu-id="68165-160">Now within the supervisors, Storm tries to distribute the executors evenly between supervisors, giving each supervisor (that is, JVM) 8 threads each.</span></span>

## <a name="tune-additional-parameters"></a><span data-ttu-id="68165-161">Настройка дополнительных параметров</span><span class="sxs-lookup"><span data-stu-id="68165-161">Tune additional parameters</span></span>
<span data-ttu-id="68165-162">Когда будет готова базовая топология, можно обдумать настройку следующих параметров.</span><span class="sxs-lookup"><span data-stu-id="68165-162">After you have the basic topology, you can consider whether you want to tweak any of the parameters:</span></span>
* <span data-ttu-id="68165-163">**Число виртуальных машин Java на рабочий узел.**</span><span class="sxs-lookup"><span data-stu-id="68165-163">**Number of JVMs per worker node.**</span></span> <span data-ttu-id="68165-164">Если вы размещаете в памяти структуру данных большого объема (например, таблицу подстановки), потребуется отдельный экземпляр этой структуры для каждой виртуальной машины Java.</span><span class="sxs-lookup"><span data-stu-id="68165-164">If you have a large data structure (for example, a lookup table) that you host in memory, each JVM requires a separate copy.</span></span> <span data-ttu-id="68165-165">Кроме того, можно распределить структуру данных на несколько потоков, если число виртуальных машин Java сравнительно невелико.</span><span class="sxs-lookup"><span data-stu-id="68165-165">Alternatively, you can use the data structure across many threads if you have fewer JVMs.</span></span> <span data-ttu-id="68165-166">Количество виртуальных машин Java не так сильно влияет на производительность операций ввода-вывода элементов bolt, как число потоков на этих машинах.</span><span class="sxs-lookup"><span data-stu-id="68165-166">For the bolt’s I/O, the number of JVMs does not make as much of a difference as the number of threads added across those JVMs.</span></span> <span data-ttu-id="68165-167">Мы рекомендуем использовать простое правило: выделять одну виртуальную машину Java для каждой рабочей роли.</span><span class="sxs-lookup"><span data-stu-id="68165-167">For simplicity, it's a good idea to have one JVM per worker.</span></span> <span data-ttu-id="68165-168">Это количество можно изменять в зависимости от того, какие функции выполняет объект bolt, и какая нужна обработка в приложении.</span><span class="sxs-lookup"><span data-stu-id="68165-168">Depending on what your bolt is doing or what application processing you require, though, you may need to change this number.</span></span>
* <span data-ttu-id="68165-169">**Количество экземпляров исполнителей spout.**</span><span class="sxs-lookup"><span data-stu-id="68165-169">**Number of spout executors.**</span></span> <span data-ttu-id="68165-170">В примере выше элементы bolt используются для записи в Azure Data Lake, поэтому количество элементов spout не влияет непосредственным образом на производительность элементов bolt.</span><span class="sxs-lookup"><span data-stu-id="68165-170">Because the preceding example uses bolts for writing to Data Lake Store, the number of spouts is not directly relevant to the bolt performance.</span></span> <span data-ttu-id="68165-171">В зависимости от объема обработки или операций ввода-вывода в элементе spout, для повышения производительности можно попробовать изменить количество spout.</span><span class="sxs-lookup"><span data-stu-id="68165-171">However, depending on the amount of processing or I/O happening in the spout, it's a good idea to tune the spouts for best performance.</span></span> <span data-ttu-id="68165-172">Убедитесь, что у вас есть достаточно элементов spout, чтобы загрузить все элементы bolt.</span><span class="sxs-lookup"><span data-stu-id="68165-172">Ensure that you have enough spouts to be able to keep the bolts busy.</span></span> <span data-ttu-id="68165-173">Скорость вывода элементов spout должна соответствовать пропускной способности элементов bolt.</span><span class="sxs-lookup"><span data-stu-id="68165-173">The output rates of the spouts should match the throughput of the bolts.</span></span> <span data-ttu-id="68165-174">Итоговая конфигурация зависит от работы spout.</span><span class="sxs-lookup"><span data-stu-id="68165-174">The actual configuration depends on the spout.</span></span>
* <span data-ttu-id="68165-175">**Число задач.**</span><span class="sxs-lookup"><span data-stu-id="68165-175">**Number of tasks.**</span></span> <span data-ttu-id="68165-176">Каждый элемент bolt выполняется как один поток.</span><span class="sxs-lookup"><span data-stu-id="68165-176">Each bolt runs as a single thread.</span></span> <span data-ttu-id="68165-177">Увеличение количества задач для каждого элемента bolt не повышает уровень параллелизма.</span><span class="sxs-lookup"><span data-stu-id="68165-177">Additional tasks per bolt don't provide any additional concurrency.</span></span> <span data-ttu-id="68165-178">Они могут обеспечить преимущество только в том случае, если на процесс подтверждения кортежа затрачивается большая часть времени выполнения элемента bolt.</span><span class="sxs-lookup"><span data-stu-id="68165-178">The only time they are of benefit is if your process of acknowledging the tuple takes a large proportion of your bolt execution time.</span></span> <span data-ttu-id="68165-179">Будет разумно объединить несколько кортежей в крупную операцию добавления, прежде чем отправлять подтверждение из элемента bolt.</span><span class="sxs-lookup"><span data-stu-id="68165-179">It's a good idea to group many tuples into a larger append before you send an acknowledgement from the bolt.</span></span> <span data-ttu-id="68165-180">Поэтому в большинстве случаев увеличение количества задач не дает дополнительных преимуществ.</span><span class="sxs-lookup"><span data-stu-id="68165-180">So, in most cases, multiple tasks provide no additional benefit.</span></span>
* <span data-ttu-id="68165-181">**Локальное группирование или группирование в случайном порядке.**</span><span class="sxs-lookup"><span data-stu-id="68165-181">**Local or shuffle grouping.**</span></span> <span data-ttu-id="68165-182">Если включить этот параметр, все кортежи отправляются в bolt в одном рабочем процессе.</span><span class="sxs-lookup"><span data-stu-id="68165-182">When this setting is enabled, tuples are sent to bolts within the same worker process.</span></span> <span data-ttu-id="68165-183">Это уменьшает межпроцессное взаимодействие и количество сетевых вызовов.</span><span class="sxs-lookup"><span data-stu-id="68165-183">This reduces inter-process communication and network calls.</span></span> <span data-ttu-id="68165-184">Мы рекомендуем использовать этот параметр для большинства топологий.</span><span class="sxs-lookup"><span data-stu-id="68165-184">This is recommended for most topologies.</span></span>

<span data-ttu-id="68165-185">Такой вариант хорошо подойдет в качестве базового.</span><span class="sxs-lookup"><span data-stu-id="68165-185">This basic scenario is a good starting point.</span></span> <span data-ttu-id="68165-186">Проверьте его производительность на конкретных данных и измените описанные выше параметры так, чтобы оптимизировать эту производительность.</span><span class="sxs-lookup"><span data-stu-id="68165-186">Test with your own data to tweak the preceding parameters to achieve optimal performance.</span></span>

## <a name="tune-the-spout"></a><span data-ttu-id="68165-187">Настройка spout</span><span class="sxs-lookup"><span data-stu-id="68165-187">Tune the spout</span></span>

<span data-ttu-id="68165-188">Можно изменить следующие параметры для настройки spout.</span><span class="sxs-lookup"><span data-stu-id="68165-188">You can modify the following settings to tune the spout.</span></span>

- <span data-ttu-id="68165-189">**Время ожидания кортежа: topology.message.timeout.secs**.</span><span class="sxs-lookup"><span data-stu-id="68165-189">**Tuple timeout: topology.message.timeout.secs**.</span></span> <span data-ttu-id="68165-190">Этот параметр определяет количество времени, в течение которого сообщение должно завершиться и получить подтверждение. По истечении этого времени для сообщения регистрируется сбой.</span><span class="sxs-lookup"><span data-stu-id="68165-190">This setting determines the amount of time a message takes to complete, and receive acknowledgement, before it is considered failed.</span></span>

- <span data-ttu-id="68165-191">**Максимальный объем памяти для каждого рабочего процесса: worker.childopts**.</span><span class="sxs-lookup"><span data-stu-id="68165-191">**Max memory per worker process: worker.childopts**.</span></span> <span data-ttu-id="68165-192">Этот параметр позволяет указать дополнительные параметры командной строки для рабочих ролей Java.</span><span class="sxs-lookup"><span data-stu-id="68165-192">This setting lets you specify additional command-line parameters to the Java workers.</span></span> <span data-ttu-id="68165-193">Наиболее часто используемый здесь параметр — XmX, который определяет максимальный объем памяти, выделенный для кучи виртуальных машин Java.</span><span class="sxs-lookup"><span data-stu-id="68165-193">The most commonly used setting here is XmX, which determines the maximum memory allocated to a JVM’s heap.</span></span>

- <span data-ttu-id="68165-194">**Максимальное количество ожидающих spout: topology.max.spout.pending**.</span><span class="sxs-lookup"><span data-stu-id="68165-194">**Max spout pending: topology.max.spout.pending**.</span></span> <span data-ttu-id="68165-195">Этот параметр определяет максимально допустимое число активных (не подтвержденных на всех узлах в топологии) кортежей для каждого потока spout в любой момент времени.</span><span class="sxs-lookup"><span data-stu-id="68165-195">This setting determines the number of tuples that can in be flight (not yet acknowledged at all nodes in the topology) per spout thread at any time.</span></span>

 <span data-ttu-id="68165-196">Мы рекомендуем оценить размер каждого кортежа.</span><span class="sxs-lookup"><span data-stu-id="68165-196">A good calculation to do is to estimate the size of each of your tuples.</span></span> <span data-ttu-id="68165-197">и разобраться, сколько памяти выделяется для потока spout.</span><span class="sxs-lookup"><span data-stu-id="68165-197">Then figure out how much memory one spout thread has.</span></span> <span data-ttu-id="68165-198">Общий выделенный для потока объем памяти, разделенный на это значение, обозначит верхнюю границу для максимального количества ожидающих spout.</span><span class="sxs-lookup"><span data-stu-id="68165-198">The total memory allocated to a thread, divided by this value, should give you the upper bound for the max spout pending parameter.</span></span>

## <a name="tune-the-bolt"></a><span data-ttu-id="68165-199">Настройка bolt</span><span class="sxs-lookup"><span data-stu-id="68165-199">Tune the bolt</span></span>
<span data-ttu-id="68165-200">При записи в Data Lake Store установите для политики размера синхронизации (буфер на стороне клиента) значение 4 МБ.</span><span class="sxs-lookup"><span data-stu-id="68165-200">When you're writing to Data Lake Store, set a size sync policy (buffer on the client side) to 4 MB.</span></span> <span data-ttu-id="68165-201">Очистка или операция hsync() выполняется только тогда, когда размер буфера достигает этого значения.</span><span class="sxs-lookup"><span data-stu-id="68165-201">A flushing or hsync() is then performed only when the buffer size is the at this value.</span></span> <span data-ttu-id="68165-202">Драйвер Data Lake Store на виртуальных машинах рабочих ролей автоматически выполняет эту буферизацию, если пользователь не выполняет операцию hsync() явным образом.</span><span class="sxs-lookup"><span data-stu-id="68165-202">The Data Lake Store driver on the worker VM automatically does this buffering, unless you explicitly perform an hsync().</span></span>

<span data-ttu-id="68165-203">По умолчанию в Data Lake Store для объекта bolt Storm определен параметр политики размера синхронизации (fileBufferSize), который можно использовать для настройки этого параметра.</span><span class="sxs-lookup"><span data-stu-id="68165-203">The default Data Lake Store Storm bolt has a size sync policy parameter (fileBufferSize) that can be used to tune this parameter.</span></span>

<span data-ttu-id="68165-204">В топологиях с интенсивным выполнением операций ввода-вывода желательно настроить запись в отдельный файл для каждого потока bolt и установить политику ротации файлов (fileRotationSize).</span><span class="sxs-lookup"><span data-stu-id="68165-204">In I/O-intensive topologies, it's a good idea to have each bolt thread write to its own file, and to set a file rotation policy (fileRotationSize).</span></span> <span data-ttu-id="68165-205">Когда файл достигает определенного размера, поток автоматически очищается и выполняется запись в новый файл.</span><span class="sxs-lookup"><span data-stu-id="68165-205">When the file reaches a certain size, the stream is automatically flushed and a new file is written to.</span></span> <span data-ttu-id="68165-206">Рекомендуемый размер файла для ротации составляет 1 ГБ.</span><span class="sxs-lookup"><span data-stu-id="68165-206">The recommended file size for rotation is 1 GB.</span></span>

### <a name="handle-tuple-data"></a><span data-ttu-id="68165-207">Обработка данных кортежа</span><span class="sxs-lookup"><span data-stu-id="68165-207">Handle tuple data</span></span>

<span data-ttu-id="68165-208">В Storm элемент spout удерживает кортеж, пока не получит явное подтверждение от элемента bolt.</span><span class="sxs-lookup"><span data-stu-id="68165-208">In Storm, a spout holds on to a tuple until it is explicitly acknowledged by the bolt.</span></span> <span data-ttu-id="68165-209">Если bolt уже прочитал кортеж, но не подтвердил его, для spout не гарантируется сохранение данных в серверной части Data Lake Store.</span><span class="sxs-lookup"><span data-stu-id="68165-209">If a tuple has been read by the bolt but has not been acknowledged yet, the spout might not have persisted into Data Lake Store back end.</span></span> <span data-ttu-id="68165-210">После подтверждения кортежа элемент bolt гарантированно сохраняет данные, поэтому элемент spout может удалить исходные данные, независимо от того, откуда он их считывает.</span><span class="sxs-lookup"><span data-stu-id="68165-210">After a tuple is acknowledged, the spout can be guaranteed persistence by the bolt, and can then delete the source data from whatever source it is reading from.</span></span>  

<span data-ttu-id="68165-211">Для обеспечения максимальной производительности Data Lake Store настройте в bolt буфер для данных кортежа размером 4 МБ.</span><span class="sxs-lookup"><span data-stu-id="68165-211">For best performance on Data Lake Store, have the bolt buffer 4 MB of tuple data.</span></span> <span data-ttu-id="68165-212">Передавайте эти данные в Data Lake Store одной операцией записи размером 4 МБ.</span><span class="sxs-lookup"><span data-stu-id="68165-212">Then write to the Data Lake Store back end as one 4-MB write.</span></span> <span data-ttu-id="68165-213">После успешной записи данных в хранилище (путем вызова hflush()) элемент bolt может отправить элементу spout подтверждение обработки данных.</span><span class="sxs-lookup"><span data-stu-id="68165-213">After the data has been successfully written to the store (by calling hflush()), the bolt can acknowledge the data back to the spout.</span></span> <span data-ttu-id="68165-214">Это выполняет приведенный здесь пример элемента bolt.</span><span class="sxs-lookup"><span data-stu-id="68165-214">This is what the example bolt supplied here does.</span></span> <span data-ttu-id="68165-215">Вполне допустимо удерживать большее количество кортежей до вызова hflush() и подтверждения кортежей.</span><span class="sxs-lookup"><span data-stu-id="68165-215">It is also acceptable to hold a larger number of tuples before the hflush() call is made and the tuples acknowledged.</span></span> <span data-ttu-id="68165-216">Однако это увеличивает число активных кортежей, которые должен удерживать элемент spout. Таким образом увеличивается объем памяти, необходимый для каждой виртуальной машины Java.</span><span class="sxs-lookup"><span data-stu-id="68165-216">However, this increases the number of tuples in flight that the spout needs to hold, and therefore increases the amount of memory required per JVM.</span></span>

> [!NOTE]
<span data-ttu-id="68165-217">Иногда приложения обязаны подтверждать кортежи чаще (при размере данных меньше 4 МБ) по причинам, не связанным с производительностью.</span><span class="sxs-lookup"><span data-stu-id="68165-217">Applications might have a requirement to acknowledge tuples more frequently (at data sizes less than 4 MB) for other non-performance reasons.</span></span> <span data-ttu-id="68165-218">Это может негативно повлиять на пропускную способность ввода-вывода для сервера хранилища.</span><span class="sxs-lookup"><span data-stu-id="68165-218">However, that might affect the I/O throughput to the storage back end.</span></span> <span data-ttu-id="68165-219">Тщательно взвесьте такие последствия в сравнении с производительностью операций ввода-вывода для bolt.</span><span class="sxs-lookup"><span data-stu-id="68165-219">Carefully weigh this tradeoff against the bolt’s I/O performance.</span></span>

<span data-ttu-id="68165-220">Если скорости поступления кортежей недостаточно и буфер на 4 МБ заполняется долго, это можно исправить следующими способами.</span><span class="sxs-lookup"><span data-stu-id="68165-220">If the incoming rate of tuples is not high, so the 4-MB buffer takes a long time to fill, consider mitigating this by:</span></span>
* <span data-ttu-id="68165-221">Уменьшите количество элементов bolt, чтобы заполнять меньше буферов.</span><span class="sxs-lookup"><span data-stu-id="68165-221">Reducing the number of bolts, so there are fewer buffers to fill.</span></span>
* <span data-ttu-id="68165-222">Создайте политику на основе времени или на основе количества, которая будет запускать операцию hflush() после каждых x операций сброса данных или через каждые y миллисекунд, а затем подтверждать накопленные кортежи.</span><span class="sxs-lookup"><span data-stu-id="68165-222">Having a time-based or count-based policy, where an hflush() is triggered every x flushes or every y milliseconds, and the tuples accumulated so far are acknowledged back.</span></span>

<span data-ttu-id="68165-223">Обратите внимание, что пропускная способность в этом случае будет меньше, хотя при низкой скорости событий максимальная пропускная способность не самое главное.</span><span class="sxs-lookup"><span data-stu-id="68165-223">Note that the throughput in this case is lower, but with a slow rate of events, maximum throughput is not the biggest objective anyway.</span></span> <span data-ttu-id="68165-224">Эти меры помогут снизить общее время передачи кортежа в хранилище.</span><span class="sxs-lookup"><span data-stu-id="68165-224">These mitigations help you reduce the total time that it takes for a tuple to flow through to the store.</span></span> <span data-ttu-id="68165-225">Это будет полезно, если конвейер должен работать в режиме реального времени даже при низкой частоте событий.</span><span class="sxs-lookup"><span data-stu-id="68165-225">This might matter if you want a real-time pipeline even with a low event rate.</span></span> <span data-ttu-id="68165-226">Обратите внимание, что при низкой скорости входящего кортежа следует настроить параметр topology.message.timeout_secs таким образом, чтобы не истекал срок ожидания кортежа, пока он буферизуется или обрабатывается.</span><span class="sxs-lookup"><span data-stu-id="68165-226">Also note that if your incoming tuple rate is low, you should adjust the topology.message.timeout_secs parameter, so the tuples don’t time out while they are getting buffered or processed.</span></span>

## <a name="monitor-your-topology-in-storm"></a><span data-ttu-id="68165-227">Мониторинг топологии в Storm</span><span class="sxs-lookup"><span data-stu-id="68165-227">Monitor your topology in Storm</span></span>  
<span data-ttu-id="68165-228">Выполнение топологии можно отслеживать в пользовательском интерфейсе Storm.</span><span class="sxs-lookup"><span data-stu-id="68165-228">While your topology is running, you can monitor it in the Storm user interface.</span></span> <span data-ttu-id="68165-229">Вот основные параметры, на которые следует обращать внимание.</span><span class="sxs-lookup"><span data-stu-id="68165-229">Here are the main parameters to look at:</span></span>

* <span data-ttu-id="68165-230">**Общая задержка выполнения процесса.**</span><span class="sxs-lookup"><span data-stu-id="68165-230">**Total process execution latency.**</span></span> <span data-ttu-id="68165-231">Это среднее время, за которое один кортеж создается элементом spout, обрабатывается элементом bolt и подтверждается.</span><span class="sxs-lookup"><span data-stu-id="68165-231">This is the average time one tuple takes to be emitted by the spout, processed by the bolt, and acknowledged.</span></span>

* <span data-ttu-id="68165-232">**Общая задержка процесса bolt.**</span><span class="sxs-lookup"><span data-stu-id="68165-232">**Total bolt process latency.**</span></span> <span data-ttu-id="68165-233">Это среднее время, проведенное кортежем в элементе bolt до получения подтверждения.</span><span class="sxs-lookup"><span data-stu-id="68165-233">This is the average time spent by the tuple at the bolt until it receives an acknowledgement.</span></span>

* <span data-ttu-id="68165-234">**Общая задержка выполнения bolt.**</span><span class="sxs-lookup"><span data-stu-id="68165-234">**Total bolt execute latency.**</span></span> <span data-ttu-id="68165-235">Это среднее время, затраченное элементом bolt на выполнение метода execute.</span><span class="sxs-lookup"><span data-stu-id="68165-235">This is the average time spent by the bolt in the execute method.</span></span>

* <span data-ttu-id="68165-236">**Количество сбоев.**</span><span class="sxs-lookup"><span data-stu-id="68165-236">**Number of failures.**</span></span> <span data-ttu-id="68165-237">Это число кортежей, которые не удалось полностью обработать прежде, чем истекло время их ожидания.</span><span class="sxs-lookup"><span data-stu-id="68165-237">This refers to the number of tuples that failed to be fully processed before they timed out.</span></span>

* <span data-ttu-id="68165-238">**Емкость.**</span><span class="sxs-lookup"><span data-stu-id="68165-238">**Capacity.**</span></span> <span data-ttu-id="68165-239">Это мера занятости вашей системы.</span><span class="sxs-lookup"><span data-stu-id="68165-239">This is a measure of how busy your system is.</span></span> <span data-ttu-id="68165-240">Если это значение равно 1, элементы bolt работают с максимально возможной скоростью.</span><span class="sxs-lookup"><span data-stu-id="68165-240">If this number is 1, your bolts are working as fast as they can.</span></span> <span data-ttu-id="68165-241">Если это значение меньше 1, необходимо увеличить параллелизм.</span><span class="sxs-lookup"><span data-stu-id="68165-241">If it is less than 1, increase the parallelism.</span></span> <span data-ttu-id="68165-242">Если значение больше 1, уменьшите параллелизм.</span><span class="sxs-lookup"><span data-stu-id="68165-242">If it is greater than 1, reduce the parallelism.</span></span>

## <a name="troubleshoot-common-problems"></a><span data-ttu-id="68165-243">Устранение распространенных неполадок</span><span class="sxs-lookup"><span data-stu-id="68165-243">Troubleshoot common problems</span></span>
<span data-ttu-id="68165-244">Здесь описано несколько типичных сценариев устранения неполадок.</span><span class="sxs-lookup"><span data-stu-id="68165-244">Here are a few common troubleshooting scenarios.</span></span>
* <span data-ttu-id="68165-245">**Множество кортежей завершается по времени ожидания.**</span><span class="sxs-lookup"><span data-stu-id="68165-245">**Many tuples are timing out.**</span></span> <span data-ttu-id="68165-246">Изучите каждый узел в топологии, чтобы определить, где находится узкое место.</span><span class="sxs-lookup"><span data-stu-id="68165-246">Look at each node in the topology to determine where the bottleneck is.</span></span> <span data-ttu-id="68165-247">Чаще всего такая проблема связана с тем, что производительность элементов bolt ниже, чем у элементов spout.</span><span class="sxs-lookup"><span data-stu-id="68165-247">The most common reason for this is that the bolts are not able to keep up with the spouts.</span></span> <span data-ttu-id="68165-248">Это приводит к тому, что ожидающие обработки кортежи переполняют внутренние буферы.</span><span class="sxs-lookup"><span data-stu-id="68165-248">This leads to tuples clogging the internal buffers while waiting to be processed.</span></span> <span data-ttu-id="68165-249">Попробуйте увеличить время ожидания или уменьшить максимальное количество ожидающих spout.</span><span class="sxs-lookup"><span data-stu-id="68165-249">Consider increasing the timeout value or decreasing the max spout pending.</span></span>

* <span data-ttu-id="68165-250">**Высокая общая задержка выполнения процесса, но при этом низкая задержка процесса bolt.**</span><span class="sxs-lookup"><span data-stu-id="68165-250">**There is a high total process execution latency, but a low bolt process latency.**</span></span> <span data-ttu-id="68165-251">В этом случае, возможно, кортежи не были подтверждены достаточно быстро.</span><span class="sxs-lookup"><span data-stu-id="68165-251">In this case, it is possible that the tuples are not being acknowledged fast enough.</span></span> <span data-ttu-id="68165-252">Убедитесь, что имеется достаточное количество подтверждающих.</span><span class="sxs-lookup"><span data-stu-id="68165-252">Check that there are a sufficient number of acknowledgers.</span></span> <span data-ttu-id="68165-253">Второй вариант — кортежи ожидают в очереди слишком долго, прежде чем элементы bolt начинают их обрабатывать.</span><span class="sxs-lookup"><span data-stu-id="68165-253">Another possibility is that they are waiting in the queue for too long before the bolts start processing them.</span></span> <span data-ttu-id="68165-254">Уменьшите максимальное время ожидания элемента spout.</span><span class="sxs-lookup"><span data-stu-id="68165-254">Decrease the max spout pending.</span></span>

* <span data-ttu-id="68165-255">**Высокая задержка выполнения bolt.**</span><span class="sxs-lookup"><span data-stu-id="68165-255">**There is a high bolt execute latency.**</span></span> <span data-ttu-id="68165-256">Это означает, что метод execute() элемента bolt выполняется слишком долго.</span><span class="sxs-lookup"><span data-stu-id="68165-256">This means that the execute() method of your bolt is taking too long.</span></span> <span data-ttu-id="68165-257">Оптимизируйте код или изучите настройки размеров и процессов для записи.</span><span class="sxs-lookup"><span data-stu-id="68165-257">Optimize the code, or look at write sizes and flush behavior.</span></span>

### <a name="data-lake-store-throttling"></a><span data-ttu-id="68165-258">Регулирование в Data Lake Store</span><span class="sxs-lookup"><span data-stu-id="68165-258">Data Lake Store throttling</span></span>
<span data-ttu-id="68165-259">Если вы достигнете пределов пропускной способности, предоставленной Data Lake Store, вы увидите сбои задач.</span><span class="sxs-lookup"><span data-stu-id="68165-259">If you hit the limits of bandwidth provided by Data Lake Store, you might see task failures.</span></span> <span data-ttu-id="68165-260">Проверьте журналы задач на наличие ошибок регулирования.</span><span class="sxs-lookup"><span data-stu-id="68165-260">Check task logs for throttling errors.</span></span> <span data-ttu-id="68165-261">Вы можете уменьшить параллелизм, увеличив размер контейнера.</span><span class="sxs-lookup"><span data-stu-id="68165-261">You can decrease the parallelism by increasing container size.</span></span>    

<span data-ttu-id="68165-262">Чтобы проверить, применяется ли для вас регулирование, включите ведение журнала отладки на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="68165-262">To check if you are getting throttled, enable the debug logging on the client side:</span></span>

1. <span data-ttu-id="68165-263">В разделе **Ambari** > **Storm** > **Config** (Настройка) > **Advanced storm-worker-log4j** (Расширенные параметры storm-worker-log4j) измените значение **&lt;root level="info"&gt;** на **&lt;root level=”debug”&gt;**.</span><span class="sxs-lookup"><span data-stu-id="68165-263">In **Ambari** > **Storm** > **Config** > **Advanced storm-worker-log4j**, change **&lt;root level="info"&gt;** to **&lt;root level=”debug”&gt;**.</span></span> <span data-ttu-id="68165-264">Перезапустите все узлы и службы, чтобы изменения конфигурации вступили в силу.</span><span class="sxs-lookup"><span data-stu-id="68165-264">Restart all the nodes/service for the configuration to take effect.</span></span>
2. <span data-ttu-id="68165-265">Отслеживайте журналы топологии для рабочих узлов Storm (в разделе /var/log/storm/worker-artifacts/&lt;TopologyName&gt;/&lt;port&gt;/worker.log) на предмет наличия исключений регулирования Data Lake Store.</span><span class="sxs-lookup"><span data-stu-id="68165-265">Monitor the Storm topology logs on worker nodes (under /var/log/storm/worker-artifacts/&lt;TopologyName&gt;/&lt;port&gt;/worker.log) for Data Lake Store throttling exceptions.</span></span>

## <a name="next-steps"></a><span data-ttu-id="68165-266">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="68165-266">Next steps</span></span>
<span data-ttu-id="68165-267">Сведения о дополнительных настройках производительности Storm см. в этом [блоге](https://blogs.msdn.microsoft.com/shanyu/2015/05/14/performance-tuning-for-hdinsight-storm-and-microsoft-azure-eventhubs/).</span><span class="sxs-lookup"><span data-stu-id="68165-267">Additional performance tuning for Storm can be referenced in [this blog](https://blogs.msdn.microsoft.com/shanyu/2015/05/14/performance-tuning-for-hdinsight-storm-and-microsoft-azure-eventhubs/).</span></span>

<span data-ttu-id="68165-268">Дополнительный пример для запуска есть [в этом разделе GitHub](https://github.com/hdinsight/storm-performance-automation).</span><span class="sxs-lookup"><span data-stu-id="68165-268">For an additional example to run, see [this one on GitHub](https://github.com/hdinsight/storm-performance-automation).</span></span>

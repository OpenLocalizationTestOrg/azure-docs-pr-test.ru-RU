---
title: "Вызов модуля Runbook службы автоматизации Azure из оповещения Log Analytics | Документация Майкрософт"
description: "В статье приведены общие сведения о том, как вызывать модуль Runbook службы автоматизации из оповещения Microsoft OMS Log Analytics."
services: automation
documentationcenter: 
author: mgoedtel
manager: jwhit
editor: 
ms.assetid: 
ms.service: automation
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 01/31/2017
ms.author: magoedte
ms.openlocfilehash: 81cf490eae7f283c0180875cb3a2ed2ffe6333c8
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="calling-an-azure-automation-runbook-from-an-oms-log-analytics-alert"></a>Вызов модуля Runbook службы автоматизации Azure из оповещения OMS Log Analytics

В Log Analytics оповещения можно настроить так, чтобы они автоматически запускали модуль Runbook службы автоматизации с целью автоматического устранения проблемы. Оповещения будут отслеживать журнал событий Windows на предмет определенных записей, например о продолжительной пиковой загрузке процессора или сбое процесса приложения, критически важного для работы бизнес-приложения.  

Существует два способа вызвать модуль Runbook при настройке оповещения:   В частности:

1. Использование объекта Webhook.
   * Это единственный доступный способ в том случае, если рабочая область OMS не связана с учетной записью службы автоматизации.
   * Если учетная запись службы автоматизации связана с рабочей областью OMS, этот вариант остается доступным.  

2. Непосредственный выбор модуля Runbook.
   * Этот способ доступен только в том случае, когда рабочая область OMS связана с учетной записью службы автоматизации.  

## <a name="calling-a-runbook-using-a-webhook"></a>Вызов модуля Runbook с помощью объекта Webhook

Объект Webhook позволяет запустить определенный модуль Runbook в службе автоматизации Azure с помощью одного HTTP-запроса.  Перед настройкой [оповещения Log Analytics](../log-analytics/log-analytics-alerts.md#alert-rules) для вызова модуля Runbook с помощью объекта Webhook в качестве реакции на предупреждение необходимо сначала создать объект Webhook для модуля Runbook, который будет вызываться с помощью этого метода.  Просмотрите и выполните действия, описанные в разделе [Создание объекта Webhook](automation-webhooks.md#creating-a-webhook). Кроме того, не забудьте записать URL-адрес объекта Webhook, так как он потребуется при настройке правила оповещения.   

## <a name="calling-a-runbook-directly"></a>Непосредственный вызов модуля Runbook

Если в рабочей области OMS установлено и настроено решение Automation & Control, при настройке действий оповещения для модуля Runbook можно просмотреть все модули Runbook из раскрывающегося списка **Выберите Runbook** и выбрать тот модуль, который следует запускать в ответ на оповещение.  Выбранный модуль можно запустить в рабочей области в облаке Azure или в гибридной рабочей роли Runbook.  Когда оповещение создано с помощью модулю Runbook, для этого модуля создается объект Webhook.  Объект Webhook можно увидеть, если перейти в учетную запись службы автоматизации и открыть колонку Webhook выбранного модуля Runbook.  Если удалить оповещение, объект Webhook удален не будет, но пользователь сможет удалить его вручную.  Неудаленный объект не является проблемой — это просто потерянный элемент, который в конечном итоге потребуется удалить для поддержания порядка в учетной записи службы автоматизации.  

## <a name="characteristics-of-a-runbook-for-both-options"></a>Характеристики модуля Runbook (для обоих способов)

Оба метода вызова модуля Runbook из оповещения Log Analytics обладают разными характеристиками поведения, которые необходимо понимать перед настройкой правил оповещения.  

* Для модуля Runbook необходим входной параметр с именем **WebhookData** и типом **Object**.  Этот параметр может быть обязательным или необязательным.  С его помощью оповещение передает результаты поиска в модуль Runbook.

        param  
         (  
          [Parameter (Mandatory=$true)]  
          [object] $WebhookData  
         )

*  Также необходим код для преобразования данных WebhookData в объект PowerShell.

    `$SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value`

    Результаты поиска (*$SearchResults*) будут представлять собой массив объектов, каждый объект в котором содержит поля со значениями из одного результата поиска.

### <a name="webhookdata-inconsistencies-between-the-webhook-option-and-runbook-option"></a>Различия в данных WebhookData при использовании объекта Webhook и модуля Runbook

* Если вы настраиваете вызов объекта Webhook из оповещения, введите URL-адрес объекта Webhook, созданный для модуля Runbook, и нажмите кнопку **Test Webhook** (Тестировать Webhook).  Полученные в результате данные WebhookData, отправляемые модулю Runbook, не содержат *.SearchResult* или *.SearchResults*.

*  Если сохранить это оповещение, то при его срабатывании и вызове объекта Webhook данные WebhookData, отправляемые модулю Runbook, будут содержать *.SearchResult*.
* Если вы настраиваете вызов модуля Runbook из оповещения (при этом также создается объект Webhook), то при срабатывании оповещения модулю Runbook будут отправлены данные WebhookData, которые содержат *.SearchResults*.

Поэтому в приведенном выше примере кода необходимо получить *.SearchResult*, если оповещение вызывает объект Webhook, и *.SearchResults*, если оповещение непосредственно вызывает модуль Runbook.

## <a name="example-walkthrough"></a>Пошаговое руководство по примеру

Мы продемонстрируем, как это работает, на следующем примере графического модуля Runbook, который запускает службу Windows.<br><br> ![Графический модуль Runbook запуска службы Windows](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice.png)<br>

Модуль Runbook имеет один входной параметр **WebhookData** типа **Object** и включает в себя данные объекта Webhook, переданные из оповещения, содержащего *.SearchResults*.<br><br> ![Входные параметры модуля Runbook](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice-inputparameter.png)<br>

Для этого примера мы создали в Log Analytics два пользовательских поля, *SvcDisplayName_CF* и *SvcState_CF*, чтобы извлечь отображаемое имя службы и состояние службы (запущенное или остановленное) из события, записываемого в журнал системных событий.  Затем мы создаем правило генерации оповещений с помощью следующего поискового запроса: `Type=Event SvcDisplayName_CF="Print Spooler" SvcState_CF="stopped"`. Это даст нам возможность определить, когда служба диспетчера очереди печати в системе Windows будет остановлена.  Это может быть любая интересующая вас служба, но в данном примере мы используем уже существующую службу, которая входит в состав ОС Windows.  Действие оповещения настраивается так, чтобы выполнить наш модуль Runbook, используемый в данном примере, и запустить его в гибридном компоненте Runbook Worker, который включен в целевых системах.   

Действие кода Runbook **Получить имя службы из LA** преобразует строку формата JSON в объектный тип и выполнит фильтрацию по элементу *SvcDisplayName_CF*, чтобы извлечь отображаемое имя службы Windows и передать его в следующее действие, которое проверит, остановлена ли служба, прежде чем попытаться ее перезапустить.  *SvcDisplayName_CF* — это [пользовательское поле](../log-analytics/log-analytics-custom-fields.md), созданное в Log Analytics для демонстрации этого примера.

    $SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value
    $SearchResults.SvcDisplayName_CF  

При остановке службы правило оповещения в Log Analytics обнаружит совпадение, запустит модуль Runbook и отправит в него контекст оповещения. Модуль Runbook проверит, остановлена ли служба, и если это так, перезапустит службу, проверит корректность ее запуска и выведет результаты.     

Если у вас нет учетной записи службы автоматизации, связанной с рабочей областью OMS, настройте правило оповещения так, чтобы объект Webhook запускал модуль Runbook. Кроме того, настройте для модуля Runbook преобразование строки в формате JSON и фильтрацию по *.SearchResult* согласно упомянутым выше инструкциям.    

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения об оповещениях в Log Analytics и их создании см. в статье [Оповещения в Log Analytics](../log-analytics/log-analytics-alerts.md).

* Сведения о том, как запускать модули Runbook с помощью объекта Webhook, см. в статье [Объекты Webhook в службе автоматизации Azure](automation-webhooks.md).

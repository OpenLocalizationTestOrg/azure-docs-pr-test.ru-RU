---
title: "Вызов модуля Runbook службы автоматизации Azure из оповещения Log Analytics | Документация Майкрософт"
description: "В статье приведены общие сведения о том, как вызывать модуль Runbook службы автоматизации из оповещения Microsoft OMS Log Analytics."
services: automation
documentationcenter: 
author: mgoedtel
manager: jwhit
editor: 
ms.assetid: 
ms.service: automation
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 01/31/2017
ms.author: magoedte
ms.openlocfilehash: 81cf490eae7f283c0180875cb3a2ed2ffe6333c8
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="calling-an-azure-automation-runbook-from-an-oms-log-analytics-alert"></a><span data-ttu-id="dab6f-103">Вызов модуля Runbook службы автоматизации Azure из оповещения OMS Log Analytics</span><span class="sxs-lookup"><span data-stu-id="dab6f-103">Calling an Azure Automation runbook from an OMS Log Analytics alert</span></span>

<span data-ttu-id="dab6f-104">В Log Analytics оповещения можно настроить так, чтобы они автоматически запускали модуль Runbook службы автоматизации с целью автоматического устранения проблемы. Оповещения будут отслеживать журнал событий Windows на предмет определенных записей, например о продолжительной пиковой загрузке процессора или сбое процесса приложения, критически важного для работы бизнес-приложения.</span><span class="sxs-lookup"><span data-stu-id="dab6f-104">When an alert is configured in Log Analytics to create an alert record if results match a particular criteria, such as a prolonged spike in processor utilization or a particular application process critical to the functionality of a business application fails and writes a corresponding event in the Windows event log, that alert can automatically run an Automation runbook in an attempt to auto-remediate the issue.</span></span>  

<span data-ttu-id="dab6f-105">Существует два способа вызвать модуль Runbook при настройке оповещения:</span><span class="sxs-lookup"><span data-stu-id="dab6f-105">There are two options to call a runbook when configuring the alert.</span></span>  <span data-ttu-id="dab6f-106"> В частности:</span><span class="sxs-lookup"><span data-stu-id="dab6f-106">Specifically,</span></span>

1. <span data-ttu-id="dab6f-107">Использование объекта Webhook.</span><span class="sxs-lookup"><span data-stu-id="dab6f-107">Using a Webhook.</span></span>
   * <span data-ttu-id="dab6f-108">Это единственный доступный способ в том случае, если рабочая область OMS не связана с учетной записью службы автоматизации.</span><span class="sxs-lookup"><span data-stu-id="dab6f-108">This is the only option available if your OMS workspace is not linked to an Automation account.</span></span>
   * <span data-ttu-id="dab6f-109">Если учетная запись службы автоматизации связана с рабочей областью OMS, этот вариант остается доступным.</span><span class="sxs-lookup"><span data-stu-id="dab6f-109">If you already have an Automation account linked to an OMS workspace, this option is still available.</span></span>  

2. <span data-ttu-id="dab6f-110">Непосредственный выбор модуля Runbook.</span><span class="sxs-lookup"><span data-stu-id="dab6f-110">Select a runbook directly.</span></span>
   * <span data-ttu-id="dab6f-111">Этот способ доступен только в том случае, когда рабочая область OMS связана с учетной записью службы автоматизации.</span><span class="sxs-lookup"><span data-stu-id="dab6f-111">This option is available only when the OMS workspace is linked to an Automation account.</span></span>  

## <a name="calling-a-runbook-using-a-webhook"></a><span data-ttu-id="dab6f-112">Вызов модуля Runbook с помощью объекта Webhook</span><span class="sxs-lookup"><span data-stu-id="dab6f-112">Calling a runbook using a webhook</span></span>

<span data-ttu-id="dab6f-113">Объект Webhook позволяет запустить определенный модуль Runbook в службе автоматизации Azure с помощью одного HTTP-запроса.</span><span class="sxs-lookup"><span data-stu-id="dab6f-113">A webhook allows you to start a particular runbook in Azure Automation through a single HTTP request.</span></span>  <span data-ttu-id="dab6f-114">Перед настройкой [оповещения Log Analytics](../log-analytics/log-analytics-alerts.md#alert-rules) для вызова модуля Runbook с помощью объекта Webhook в качестве реакции на предупреждение необходимо сначала создать объект Webhook для модуля Runbook, который будет вызываться с помощью этого метода.</span><span class="sxs-lookup"><span data-stu-id="dab6f-114">Before configuring the [Log Analytics alert](../log-analytics/log-analytics-alerts.md#alert-rules) to call the runbook using a webhook as an alert action, you will need to first create a webhook for the runbook that will be called using this method.</span></span>  <span data-ttu-id="dab6f-115">Просмотрите и выполните действия, описанные в разделе [Создание объекта Webhook](automation-webhooks.md#creating-a-webhook). Кроме того, не забудьте записать URL-адрес объекта Webhook, так как он потребуется при настройке правила оповещения.</span><span class="sxs-lookup"><span data-stu-id="dab6f-115">Review and follow the steps in the [create a webhook](automation-webhooks.md#creating-a-webhook) article and remember to record the webhook URL so that you can reference it while configuring the alert rule.</span></span>   

## <a name="calling-a-runbook-directly"></a><span data-ttu-id="dab6f-116">Непосредственный вызов модуля Runbook</span><span class="sxs-lookup"><span data-stu-id="dab6f-116">Calling a runbook directly</span></span>

<span data-ttu-id="dab6f-117">Если в рабочей области OMS установлено и настроено решение Automation & Control, при настройке действий оповещения для модуля Runbook можно просмотреть все модули Runbook из раскрывающегося списка **Выберите Runbook** и выбрать тот модуль, который следует запускать в ответ на оповещение.</span><span class="sxs-lookup"><span data-stu-id="dab6f-117">If you have the Automation & Control offering installed and configured in your OMS workspace, when configuring the Runbook actions option for the alert, you can view all runbooks from the **Select a runbook** dropdown list and select the specific runbook you want to run in response to the alert.</span></span>  <span data-ttu-id="dab6f-118">Выбранный модуль можно запустить в рабочей области в облаке Azure или в гибридной рабочей роли Runbook.</span><span class="sxs-lookup"><span data-stu-id="dab6f-118">The selected runbook can run in a workspace in the Azure cloud or on a hybrid runbook worker.</span></span>  <span data-ttu-id="dab6f-119">Когда оповещение создано с помощью модулю Runbook, для этого модуля создается объект Webhook.</span><span class="sxs-lookup"><span data-stu-id="dab6f-119">When the alert is created using the runbook option, a webhook will be created for the runbook.</span></span>  <span data-ttu-id="dab6f-120">Объект Webhook можно увидеть, если перейти в учетную запись службы автоматизации и открыть колонку Webhook выбранного модуля Runbook.</span><span class="sxs-lookup"><span data-stu-id="dab6f-120">You can see the webhook if you go to the Automation account and navigate to the webhook blade of the selected runbook.</span></span>  <span data-ttu-id="dab6f-121">Если удалить оповещение, объект Webhook удален не будет, но пользователь сможет удалить его вручную.</span><span class="sxs-lookup"><span data-stu-id="dab6f-121">If you delete the alert, the webhook is not deleted, but the user can delete the webhook manually.</span></span>  <span data-ttu-id="dab6f-122">Неудаленный объект не является проблемой — это просто потерянный элемент, который в конечном итоге потребуется удалить для поддержания порядка в учетной записи службы автоматизации.</span><span class="sxs-lookup"><span data-stu-id="dab6f-122">It is not a problem if the webhook is not deleted, it is just an orphaned item that will eventually need to be deleted in order to maintain an organized Automation account.</span></span>  

## <a name="characteristics-of-a-runbook-for-both-options"></a><span data-ttu-id="dab6f-123">Характеристики модуля Runbook (для обоих способов)</span><span class="sxs-lookup"><span data-stu-id="dab6f-123">Characteristics of a runbook (for both options)</span></span>

<span data-ttu-id="dab6f-124">Оба метода вызова модуля Runbook из оповещения Log Analytics обладают разными характеристиками поведения, которые необходимо понимать перед настройкой правил оповещения.</span><span class="sxs-lookup"><span data-stu-id="dab6f-124">Both methods for calling the runbook from the Log Analytics alert have different behavior characteristics that need to be understood before you configure your alert rules.</span></span>  

* <span data-ttu-id="dab6f-125">Для модуля Runbook необходим входной параметр с именем **WebhookData** и типом **Object**.</span><span class="sxs-lookup"><span data-stu-id="dab6f-125">You must have a runbook input parameter called **WebhookData** that is **Object** type.</span></span>  <span data-ttu-id="dab6f-126">Этот параметр может быть обязательным или необязательным.</span><span class="sxs-lookup"><span data-stu-id="dab6f-126">It can be mandatory or optional.</span></span>  <span data-ttu-id="dab6f-127">С его помощью оповещение передает результаты поиска в модуль Runbook.</span><span class="sxs-lookup"><span data-stu-id="dab6f-127">The alert passes the search results to the runbook using this input parameter.</span></span>

        param  
         (  
          [Parameter (Mandatory=$true)]  
          [object] $WebhookData  
         )

*  <span data-ttu-id="dab6f-128">Также необходим код для преобразования данных WebhookData в объект PowerShell.</span><span class="sxs-lookup"><span data-stu-id="dab6f-128">You must have code to convert the WebhookData to a PowerShell object.</span></span>

    `$SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value`

    <span data-ttu-id="dab6f-129">Результаты поиска (*$SearchResults*) будут представлять собой массив объектов, каждый объект в котором содержит поля со значениями из одного результата поиска.</span><span class="sxs-lookup"><span data-stu-id="dab6f-129">*$SearchResults* will be an array of objects; each object contains the fields with values from one search result</span></span>

### <a name="webhookdata-inconsistencies-between-the-webhook-option-and-runbook-option"></a><span data-ttu-id="dab6f-130">Различия в данных WebhookData при использовании объекта Webhook и модуля Runbook</span><span class="sxs-lookup"><span data-stu-id="dab6f-130">WebhookData inconsistencies between the webhook option and runbook option</span></span>

* <span data-ttu-id="dab6f-131">Если вы настраиваете вызов объекта Webhook из оповещения, введите URL-адрес объекта Webhook, созданный для модуля Runbook, и нажмите кнопку **Test Webhook** (Тестировать Webhook).</span><span class="sxs-lookup"><span data-stu-id="dab6f-131">When configuring an alert to call a Webhook, enter a webhook URL you created for a runbook, and click the **Test Webhook** button.</span></span>  <span data-ttu-id="dab6f-132">Полученные в результате данные WebhookData, отправляемые модулю Runbook, не содержат *.SearchResult* или *.SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="dab6f-132">The resulting WebhookData sent to the runbook does not contain either *.SearchResult* or *.SearchResults*.</span></span>

*  <span data-ttu-id="dab6f-133">Если сохранить это оповещение, то при его срабатывании и вызове объекта Webhook данные WebhookData, отправляемые модулю Runbook, будут содержать *.SearchResult*.</span><span class="sxs-lookup"><span data-stu-id="dab6f-133">If you save that alert, when the alert triggers and calls the webhook, the WebhookData sent to the runbook contains *.SearchResult*.</span></span>
* <span data-ttu-id="dab6f-134">Если вы настраиваете вызов модуля Runbook из оповещения (при этом также создается объект Webhook), то при срабатывании оповещения модулю Runbook будут отправлены данные WebhookData, которые содержат *.SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="dab6f-134">If you create an alert, and configure it to call a runbook (which also creates a webhook), when the alert triggers it sends WebhookData to the runbook that contains *.SearchResults*.</span></span>

<span data-ttu-id="dab6f-135">Поэтому в приведенном выше примере кода необходимо получить *.SearchResult*, если оповещение вызывает объект Webhook, и *.SearchResults*, если оповещение непосредственно вызывает модуль Runbook.</span><span class="sxs-lookup"><span data-stu-id="dab6f-135">Thus in the code example above, you will need to get *.SearchResult* if the alert calls a webhook, and will need to get *.SearchResults* if the alert calls a runbook directly.</span></span>

## <a name="example-walkthrough"></a><span data-ttu-id="dab6f-136">Пошаговое руководство по примеру</span><span class="sxs-lookup"><span data-stu-id="dab6f-136">Example walkthrough</span></span>

<span data-ttu-id="dab6f-137">Мы продемонстрируем, как это работает, на следующем примере графического модуля Runbook, который запускает службу Windows.</span><span class="sxs-lookup"><span data-stu-id="dab6f-137">We will demonstrate how this works by using the following example graphical runbook, which starts a Windows service.</span></span><br><br> ![Графический модуль Runbook запуска службы Windows](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice.png)<br>

<span data-ttu-id="dab6f-139">Модуль Runbook имеет один входной параметр **WebhookData** типа **Object** и включает в себя данные объекта Webhook, переданные из оповещения, содержащего *.SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="dab6f-139">The runbook has one input parameter of type **Object** that is called **WebhookData** and includes the webhook data passed from the alert containing *.SearchResults*.</span></span><br><br> <span data-ttu-id="dab6f-140">![Входные параметры модуля Runbook](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice-inputparameter.png)</span><span class="sxs-lookup"><span data-stu-id="dab6f-140">![Runbook input parameters](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice-inputparameter.png)</span></span><br>

<span data-ttu-id="dab6f-141">Для этого примера мы создали в Log Analytics два пользовательских поля, *SvcDisplayName_CF* и *SvcState_CF*, чтобы извлечь отображаемое имя службы и состояние службы (запущенное или остановленное) из события, записываемого в журнал системных событий.</span><span class="sxs-lookup"><span data-stu-id="dab6f-141">For this example, in Log Analytics we created two custom fields, *SvcDisplayName_CF* and *SvcState_CF*, to extract the service display name and the state of the service (i.e. running or stopped) from the event written to the System event log.</span></span>  <span data-ttu-id="dab6f-142">Затем мы создаем правило генерации оповещений с помощью следующего поискового запроса: `Type=Event SvcDisplayName_CF="Print Spooler" SvcState_CF="stopped"`. Это даст нам возможность определить, когда служба диспетчера очереди печати в системе Windows будет остановлена.</span><span class="sxs-lookup"><span data-stu-id="dab6f-142">We then create an alert rule with the following search query: `Type=Event SvcDisplayName_CF="Print Spooler" SvcState_CF="stopped"` so that we can detect when the Print Spooler service is stopped on the Windows system.</span></span>  <span data-ttu-id="dab6f-143">Это может быть любая интересующая вас служба, но в данном примере мы используем уже существующую службу, которая входит в состав ОС Windows.</span><span class="sxs-lookup"><span data-stu-id="dab6f-143">It can be any service of interest, but for this example we are referencing one of the pre-existing services that are included with the Windows OS.</span></span>  <span data-ttu-id="dab6f-144">Действие оповещения настраивается так, чтобы выполнить наш модуль Runbook, используемый в данном примере, и запустить его в гибридном компоненте Runbook Worker, который включен в целевых системах.</span><span class="sxs-lookup"><span data-stu-id="dab6f-144">The alert action is configured to execute our runbook used in this example and run on the Hybrid Runbook Worker, which are enabled on the target systems.</span></span>   

<span data-ttu-id="dab6f-145">Действие кода Runbook **Получить имя службы из LA** преобразует строку формата JSON в объектный тип и выполнит фильтрацию по элементу *SvcDisplayName_CF*, чтобы извлечь отображаемое имя службы Windows и передать его в следующее действие, которое проверит, остановлена ли служба, прежде чем попытаться ее перезапустить.</span><span class="sxs-lookup"><span data-stu-id="dab6f-145">The runbook code activity **Get Service Name from LA** will convert the JSON-formatted string into an object type and filter on the item *SvcDisplayName_CF* to extract the display name of the Windows service and pass this onto the next activity which will verify the service is stopped before attempting to restart it.</span></span>  <span data-ttu-id="dab6f-146">*SvcDisplayName_CF* — это [пользовательское поле](../log-analytics/log-analytics-custom-fields.md), созданное в Log Analytics для демонстрации этого примера.</span><span class="sxs-lookup"><span data-stu-id="dab6f-146">*SvcDisplayName_CF* is a [custom field](../log-analytics/log-analytics-custom-fields.md) created in Log Analytics to demonstrate this example.</span></span>

    $SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value
    $SearchResults.SvcDisplayName_CF  

<span data-ttu-id="dab6f-147">При остановке службы правило оповещения в Log Analytics обнаружит совпадение, запустит модуль Runbook и отправит в него контекст оповещения.</span><span class="sxs-lookup"><span data-stu-id="dab6f-147">When the service stops, the alert rule in Log Analytics will detect a match and trigger the runbook and send the alert context to the runbook.</span></span> <span data-ttu-id="dab6f-148">Модуль Runbook проверит, остановлена ли служба, и если это так, перезапустит службу, проверит корректность ее запуска и выведет результаты.</span><span class="sxs-lookup"><span data-stu-id="dab6f-148">The runbook will take action to verify the service is stopped, and if so attempt to restart the service and verify it started correctly and output the results.</span></span>     

<span data-ttu-id="dab6f-149">Если у вас нет учетной записи службы автоматизации, связанной с рабочей областью OMS, настройте правило оповещения так, чтобы объект Webhook запускал модуль Runbook. Кроме того, настройте для модуля Runbook преобразование строки в формате JSON и фильтрацию по *.SearchResult* согласно упомянутым выше инструкциям.</span><span class="sxs-lookup"><span data-stu-id="dab6f-149">Alternatively if you don't have your Automation account linked to your OMS workspace, you would configure the alert rule with a webhook action to trigger the runbook and configure the runbook to convert the JSON-formatted string and filter on *.SearchResult* following the guidance mentioned earlier.</span></span>    

## <a name="next-steps"></a><span data-ttu-id="dab6f-150">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="dab6f-150">Next steps</span></span>

* <span data-ttu-id="dab6f-151">Дополнительные сведения об оповещениях в Log Analytics и их создании см. в статье [Оповещения в Log Analytics](../log-analytics/log-analytics-alerts.md).</span><span class="sxs-lookup"><span data-stu-id="dab6f-151">To learn more about alerts in Log Analytics and how to create one, see [Alerts in Log Analytics](../log-analytics/log-analytics-alerts.md).</span></span>

* <span data-ttu-id="dab6f-152">Сведения о том, как запускать модули Runbook с помощью объекта Webhook, см. в статье [Объекты Webhook в службе автоматизации Azure](automation-webhooks.md).</span><span class="sxs-lookup"><span data-stu-id="dab6f-152">To understand how to trigger runbooks using a webhook, see [Azure Automation webhooks](automation-webhooks.md).</span></span>

---
title: "aaaCalling Runbook автоматизации Azure из предупреждение аналитика журналов | Документы Microsoft"
description: "В этой статье содержатся общие сведения о том, как tooinvoke runbook автоматизации из предупреждения анализа журналов OMS корпорации Майкрософт."
services: automation
documentationcenter: 
author: mgoedtel
manager: jwhit
editor: 
ms.assetid: 
ms.service: automation
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 01/31/2017
ms.author: magoedte
ms.openlocfilehash: 8b745d6e6c2b0294d676e010f52855cd51741cf9
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="calling-an-azure-automation-runbook-from-an-oms-log-analytics-alert"></a><span data-ttu-id="e3e6b-103">Вызов модуля Runbook службы автоматизации Azure из оповещения OMS Log Analytics</span><span class="sxs-lookup"><span data-stu-id="e3e6b-103">Calling an Azure Automation runbook from an OMS Log Analytics alert</span></span>

<span data-ttu-id="e3e6b-104">При настройке предупреждения в службе анализа журналов toocreate запись предупреждения, если результаты соответствуют определенным условиям, например длительного пика загрузки процессора или процесс для конкретного приложения критические toohello функциональные возможности бизнес-приложения завершается ошибкой и записывает соответствующее событие в журнале событий Windows hello, что оповещение автоматически можно запустить runbook автоматизации в tooauto попытки-устранять проблему hello.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-104">When an alert is configured in Log Analytics toocreate an alert record if results match a particular criteria, such as a prolonged spike in processor utilization or a particular application process critical toohello functionality of a business application fails and writes a corresponding event in hello Windows event log, that alert can automatically run an Automation runbook in an attempt tooauto-remediate hello issue.</span></span>  

<span data-ttu-id="e3e6b-105">Существует два toocall параметры модуля runbook при настройке предупреждения hello.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-105">There are two options toocall a runbook when configuring hello alert.</span></span>  <span data-ttu-id="e3e6b-106"> В частности:</span><span class="sxs-lookup"><span data-stu-id="e3e6b-106">Specifically,</span></span>

1. <span data-ttu-id="e3e6b-107">Использование объекта Webhook.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-107">Using a Webhook.</span></span>
   * <span data-ttu-id="e3e6b-108">Это hello единственный доступный параметр, если рабочую область OMS не tooan связанной учетной записи автоматизации.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-108">This is hello only option available if your OMS workspace is not linked tooan Automation account.</span></span>
   * <span data-ttu-id="e3e6b-109">При наличии рабочей области OMS tooan связанной учетной записи автоматизации, этот параметр по-прежнему доступен.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-109">If you already have an Automation account linked tooan OMS workspace, this option is still available.</span></span>  

2. <span data-ttu-id="e3e6b-110">Непосредственный выбор модуля Runbook.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-110">Select a runbook directly.</span></span>
   * <span data-ttu-id="e3e6b-111">Этот параметр доступен только в том случае, если рабочая область OMS hello — tooan связанной учетной записи автоматизации.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-111">This option is available only when hello OMS workspace is linked tooan Automation account.</span></span>  

## <a name="calling-a-runbook-using-a-webhook"></a><span data-ttu-id="e3e6b-112">Вызов модуля Runbook с помощью объекта Webhook</span><span class="sxs-lookup"><span data-stu-id="e3e6b-112">Calling a runbook using a webhook</span></span>

<span data-ttu-id="e3e6b-113">Веб-перехватчика позволяет toostart конкретного модуля runbook в автоматизации Azure через один HTTP-запроса.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-113">A webhook allows you toostart a particular runbook in Azure Automation through a single HTTP request.</span></span>  <span data-ttu-id="e3e6b-114">Перед настройкой hello [предупреждение анализа журналов](../log-analytics/log-analytics-alerts.md#alert-rules) runbook toocall hello, используя веб-перехватчик в качестве реакции на предупреждение, вам потребуется toofirst создать веб-перехватчика для hello runbook, который будет вызываться с помощью этого метода.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-114">Before configuring hello [Log Analytics alert](../log-analytics/log-analytics-alerts.md#alert-rules) toocall hello runbook using a webhook as an alert action, you will need toofirst create a webhook for hello runbook that will be called using this method.</span></span>  <span data-ttu-id="e3e6b-115">Просмотрите и следуйте указаниям hello hello [создать веб-перехватчика](automation-webhooks.md#creating-a-webhook) статью и запомнить URL-адрес веб-перехватчика toorecord hello, чтобы вы могли сослаться при настройке правила оповещения hello.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-115">Review and follow hello steps in hello [create a webhook](automation-webhooks.md#creating-a-webhook) article and remember toorecord hello webhook URL so that you can reference it while configuring hello alert rule.</span></span>   

## <a name="calling-a-runbook-directly"></a><span data-ttu-id="e3e6b-116">Непосредственный вызов модуля Runbook</span><span class="sxs-lookup"><span data-stu-id="e3e6b-116">Calling a runbook directly</span></span>

<span data-ttu-id="e3e6b-117">Если у вас есть hello автоматизации & предложения управления устанавливается и настраивается в рабочую область OMS, при настройке параметра действия Runbook hello для оповещения hello, можно просмотреть все модули Runbook из hello **выберите runbook** раскрывающегося списка и выберите hello требуется toorun в предупреждении toohello ответа определенного модуля runbook.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-117">If you have hello Automation & Control offering installed and configured in your OMS workspace, when configuring hello Runbook actions option for hello alert, you can view all runbooks from hello **Select a runbook** dropdown list and select hello specific runbook you want toorun in response toohello alert.</span></span>  <span data-ttu-id="e3e6b-118">Hello выбранного модуля runbook можно запускать в рабочей области в облаке Azure hello или на гибридной рабочей роли runbook.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-118">hello selected runbook can run in a workspace in hello Azure cloud or on a hybrid runbook worker.</span></span>  <span data-ttu-id="e3e6b-119">При создании с помощью параметра runbook hello предупреждение hello веб-перехватчика будут созданы для hello runbook.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-119">When hello alert is created using hello runbook option, a webhook will be created for hello runbook.</span></span>  <span data-ttu-id="e3e6b-120">Если перейти учетной записи автоматизации toohello и перейдите в колонку веб-перехватчика toohello hello выбранного модуля Runbook вы увидите веб-перехватчика hello.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-120">You can see hello webhook if you go toohello Automation account and navigate toohello webhook blade of hello selected runbook.</span></span>  <span data-ttu-id="e3e6b-121">При удалении предупреждения hello hello веб-перехватчика не удаляется, но hello пользователь может вручную удалить веб-перехватчика hello.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-121">If you delete hello alert, hello webhook is not deleted, but hello user can delete hello webhook manually.</span></span>  <span data-ttu-id="e3e6b-122">Он не является проблемой, если веб-перехватчика hello не удаляется, это просто потерянных элемента, который рано или поздно toobe удаления в порядке toomaintain организованную учетной записи автоматизации.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-122">It is not a problem if hello webhook is not deleted, it is just an orphaned item that will eventually need toobe deleted in order toomaintain an organized Automation account.</span></span>  

## <a name="characteristics-of-a-runbook-for-both-options"></a><span data-ttu-id="e3e6b-123">Характеристики модуля Runbook (для обоих способов)</span><span class="sxs-lookup"><span data-stu-id="e3e6b-123">Characteristics of a runbook (for both options)</span></span>

<span data-ttu-id="e3e6b-124">Оба метода для вызова модуля runbook hello из предупреждения анализа журналов hello имеют характеристики по-разному, которые должны toobe понятны перед настройкой правилами генерации оповещений.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-124">Both methods for calling hello runbook from hello Log Analytics alert have different behavior characteristics that need toobe understood before you configure your alert rules.</span></span>  

* <span data-ttu-id="e3e6b-125">Для модуля Runbook необходим входной параметр с именем **WebhookData** и типом **Object**.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-125">You must have a runbook input parameter called **WebhookData** that is **Object** type.</span></span>  <span data-ttu-id="e3e6b-126">Этот параметр может быть обязательным или необязательным.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-126">It can be mandatory or optional.</span></span>  <span data-ttu-id="e3e6b-127">Предупреждение Hello передает hello результаты поиска toohello runbook с помощью этого входного параметра.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-127">hello alert passes hello search results toohello runbook using this input parameter.</span></span>

        param  
         (  
          [Parameter (Mandatory=$true)]  
          [object] $WebhookData  
         )

*  <span data-ttu-id="e3e6b-128">Необходимо иметь код tooconvert hello WebhookData tooa объект PowerShell.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-128">You must have code tooconvert hello WebhookData tooa PowerShell object.</span></span>

    `$SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value`

    <span data-ttu-id="e3e6b-129">*$SearchResults* будет массивом объектов, каждый объект содержит hello поля со значениями из результатов поиска</span><span class="sxs-lookup"><span data-stu-id="e3e6b-129">*$SearchResults* will be an array of objects; each object contains hello fields with values from one search result</span></span>

### <a name="webhookdata-inconsistencies-between-hello-webhook-option-and-runbook-option"></a><span data-ttu-id="e3e6b-130">WebhookData несоответствия между hello веб-перехватчика и runbook</span><span class="sxs-lookup"><span data-stu-id="e3e6b-130">WebhookData inconsistencies between hello webhook option and runbook option</span></span>

* <span data-ttu-id="e3e6b-131">При настройке оповещений toocall веб-перехватчика, введите URL-адрес веб-перехватчика, созданных для модуля runbook и нажмите кнопку hello **тестирования веб-перехватчика** кнопки.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-131">When configuring an alert toocall a Webhook, enter a webhook URL you created for a runbook, and click hello **Test Webhook** button.</span></span>  <span data-ttu-id="e3e6b-132">Hello результирующий WebhookData отправляемых toohello runbook не содержит либо *. SearchResult* или *. SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-132">hello resulting WebhookData sent toohello runbook does not contain either *.SearchResult* or *.SearchResults*.</span></span>

*  <span data-ttu-id="e3e6b-133">При сохранении этого предупреждения, когда предупреждение hello триггеров и вызывает веб-перехватчика hello hello WebhookData отправляемых toohello runbook содержит *. SearchResult*.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-133">If you save that alert, when hello alert triggers and calls hello webhook, hello WebhookData sent toohello runbook contains *.SearchResult*.</span></span>
* <span data-ttu-id="e3e6b-134">Если создать предупреждение и настроить его toocall runbook (который также создает веб-перехватчика), когда hello предупреждения триггеры, он отправляет WebhookData toohello runbook, который содержит *. SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-134">If you create an alert, and configure it toocall a runbook (which also creates a webhook), when hello alert triggers it sends WebhookData toohello runbook that contains *.SearchResults*.</span></span>

<span data-ttu-id="e3e6b-135">Поэтому в приведенном выше примере кода hello, нужно будет tooget *. SearchResult* Если предупреждение hello вызывает веб-перехватчика и потребуется tooget *. SearchResults* Если предупреждение hello вызывает runbook напрямую.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-135">Thus in hello code example above, you will need tooget *.SearchResult* if hello alert calls a webhook, and will need tooget *.SearchResults* if hello alert calls a runbook directly.</span></span>

## <a name="example-walkthrough"></a><span data-ttu-id="e3e6b-136">Пошаговое руководство по примеру</span><span class="sxs-lookup"><span data-stu-id="e3e6b-136">Example walkthrough</span></span>

<span data-ttu-id="e3e6b-137">Мы покажем, как это работает, используя следующий пример графический runbook, который используется для запуска службы Windows hello.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-137">We will demonstrate how this works by using hello following example graphical runbook, which starts a Windows service.</span></span><br><br> ![Графический модуль Runbook запуска службы Windows](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice.png)<br>

<span data-ttu-id="e3e6b-139">Hello runbook имеет один входной параметр типа **объекта** , вызываемого **WebhookData** и включает в себя данные веб-перехватчика hello, передаваемые от предупреждения содержащего hello *. SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-139">hello runbook has one input parameter of type **Object** that is called **WebhookData** and includes hello webhook data passed from hello alert containing *.SearchResults*.</span></span><br><br> <span data-ttu-id="e3e6b-140">![Входные параметры модуля Runbook](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice-inputparameter.png)</span><span class="sxs-lookup"><span data-stu-id="e3e6b-140">![Runbook input parameters](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice-inputparameter.png)</span></span><br>

<span data-ttu-id="e3e6b-141">Например, в службе анализа журналов мы создали два пользовательских полей, *SvcDisplayName_CF* и *SvcState_CF*, tooextract hello отображаемое имя и hello состояния службы hello службы (т. е. запущенной или остановленной) из события hello записывается toohello журнал системных событий.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-141">For this example, in Log Analytics we created two custom fields, *SvcDisplayName_CF* and *SvcState_CF*, tooextract hello service display name and hello state of hello service (i.e. running or stopped) from hello event written toohello System event log.</span></span>  <span data-ttu-id="e3e6b-142">Затем мы создать правило генерации оповещений с hello, следующий запрос поиска: `Type=Event SvcDisplayName_CF="Print Spooler" SvcState_CF="stopped"` , чтобы мы можно обнаружить при остановке службы диспетчера очереди печати hello на системы Windows hello.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-142">We then create an alert rule with hello following search query: `Type=Event SvcDisplayName_CF="Print Spooler" SvcState_CF="stopped"` so that we can detect when hello Print Spooler service is stopped on hello Windows system.</span></span>  <span data-ttu-id="e3e6b-143">Он может быть любой службы, представляющие интерес, но в этом примере мы ссылаются на один hello существующих служб, которые входят в состав ОС Windows hello.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-143">It can be any service of interest, but for this example we are referencing one of hello pre-existing services that are included with hello Windows OS.</span></span>  <span data-ttu-id="e3e6b-144">действие предупреждения Hello настроенных tooexecute наших runbook, используемых в этом примере и запустите на hello гибридную рабочую роль Runbook, которой включены на целевых системах hello.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-144">hello alert action is configured tooexecute our runbook used in this example and run on hello Hybrid Runbook Worker, which are enabled on hello target systems.</span></span>   

<span data-ttu-id="e3e6b-145">Действие runbook кода Hello **получить имя службы из LA** преобразует строку в формате JSON hello в тип объекта и фильтр для элемента hello *SvcDisplayName_CF* tooextract hello отображаемое имя hello Службы Windows и передать этот на следующее действие hello, который проверит hello служба остановлена перед выполнением toorestart его.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-145">hello runbook code activity **Get Service Name from LA** will convert hello JSON-formatted string into an object type and filter on hello item *SvcDisplayName_CF* tooextract hello display name of hello Windows service and pass this onto hello next activity which will verify hello service is stopped before attempting toorestart it.</span></span>  <span data-ttu-id="e3e6b-146">*SvcDisplayName_CF* — [настраиваемое поле](../log-analytics/log-analytics-custom-fields.md) созданные в службе анализа журналов toodemonstrate в этом примере.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-146">*SvcDisplayName_CF* is a [custom field](../log-analytics/log-analytics-custom-fields.md) created in Log Analytics toodemonstrate this example.</span></span>

    $SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value
    $SearchResults.SvcDisplayName_CF  

<span data-ttu-id="e3e6b-147">При остановке службы hello, правило оповещения hello в службе анализа журналов обнаружит совпадения и запустить hello runbook и отправить runbook toohello hello контекст предупреждения.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-147">When hello service stops, hello alert rule in Log Analytics will detect a match and trigger hello runbook and send hello alert context toohello runbook.</span></span> <span data-ttu-id="e3e6b-148">Hello runbook вступят в действие tooverify hello служба остановлена, и если поэтому попытка toorestart hello службы и для проверки правильной работы и hello вывода результатов.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-148">hello runbook will take action tooverify hello service is stopped, and if so attempt toorestart hello service and verify it started correctly and output hello results.</span></span>     

<span data-ttu-id="e3e6b-149">Можно также при отсутствии рабочую область OMS tooyour связанной учетной записи автоматизации можно настроить правила оповещений hello с tootrigger hello веб-перехватчика действие runbook и настроить hello runbook tooconvert hello строку в формате JSON и фильтр *. SearchResult* следующие hello рекомендации, приведенные выше.</span><span class="sxs-lookup"><span data-stu-id="e3e6b-149">Alternatively if you don't have your Automation account linked tooyour OMS workspace, you would configure hello alert rule with a webhook action tootrigger hello runbook and configure hello runbook tooconvert hello JSON-formatted string and filter on *.SearchResult* following hello guidance mentioned earlier.</span></span>    

## <a name="next-steps"></a><span data-ttu-id="e3e6b-150">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="e3e6b-150">Next steps</span></span>

* <span data-ttu-id="e3e6b-151">toolearn Дополнительные об оповещениях в службе анализа журналов и как увидеть toocreate, [предупреждения в службе анализа журналов](../log-analytics/log-analytics-alerts.md).</span><span class="sxs-lookup"><span data-stu-id="e3e6b-151">toolearn more about alerts in Log Analytics and how toocreate one, see [Alerts in Log Analytics](../log-analytics/log-analytics-alerts.md).</span></span>

* <span data-ttu-id="e3e6b-152">tootrigger модули Runbook с помощью веб-перехватчика. в статье toounderstand [веб-службы автоматизации Azure привязок](automation-webhooks.md).</span><span class="sxs-lookup"><span data-stu-id="e3e6b-152">toounderstand how tootrigger runbooks using a webhook, see [Azure Automation webhooks](automation-webhooks.md).</span></span>

---
title: "Непрерывное развертывание с помощью Azure Automation DSC и Chocolatey | Документация Майкрософт"
description: "Непрерывное развертывание DevOps с помощью Automation DSC Azure и диспетчера пакетов Chocolatey.  Пример с полным шаблоном ARM в формате JSON и исходным кодом PowerShell."
services: automation
documentationcenter: 
author: eslesar
manager: carmonm
editor: tysonn
ms.assetid: c0baa411-eb76-4f91-8d14-68f68b4805b6
ms.service: automation
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: na
ms.date: 10/29/2016
ms.author: golive
ms.openlocfilehash: f23d7374a8954a0a95853fa9e00b54a8d9c468c4
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="usage-example-continuous-deployment-to-virtual-machines-using-automation-dsc-and-chocolatey"></a><span data-ttu-id="02fe9-104">Пример использования. Непрерывное развертывание на виртуальных машинах с помощью Automation DSC и Chocolatey</span><span class="sxs-lookup"><span data-stu-id="02fe9-104">Usage Example: Continuous deployment to Virtual Machines using Automation DSC and Chocolatey</span></span>
<span data-ttu-id="02fe9-105">В среде DevOps существует множество средств, которые упрощают различные аспекты процесса непрерывной интеграции.</span><span class="sxs-lookup"><span data-stu-id="02fe9-105">In a DevOps world there are many tools to assist with various points in the Continuous Integration pipeline.</span></span>  <span data-ttu-id="02fe9-106">Платформа для настройки требуемого состояния службы автоматизации Azure (далее — Automation DSC Azure) — это долгожданная новая функция, которую могут использовать команды разработчиков DevOps.</span><span class="sxs-lookup"><span data-stu-id="02fe9-106">Azure Automation Desired State Configuration (DSC) is a welcome new addition to the options that DevOps teams can employ.</span></span>  <span data-ttu-id="02fe9-107">В этой статье показана настройка непрерывного развертывания для компьютера Windows.</span><span class="sxs-lookup"><span data-stu-id="02fe9-107">This article demonstrates setting up Continuous Deployment (CD) for a Windows computer.</span></span>  <span data-ttu-id="02fe9-108">Применение этого метода можно легко расширить, включив любое количество компьютеров Windows, необходимое для роли (например, веб-сайта), а также дополнительные роли.</span><span class="sxs-lookup"><span data-stu-id="02fe9-108">You can easily extend the technique to include as many Windows computers as necessary in the role (a web site, for example), and from there to additional roles as well.</span></span>

![Непрерывное развертывание для виртуальных машин IaaS](./media/automation-dsc-cd-chocolatey/cdforiaasvm.png)

## <a name="at-a-high-level"></a><span data-ttu-id="02fe9-110">На высоком уровне</span><span class="sxs-lookup"><span data-stu-id="02fe9-110">At a high level</span></span>
<span data-ttu-id="02fe9-111">Эта схема включает немало действий, но, к счастью, их можно разбить на два основных процесса:</span><span class="sxs-lookup"><span data-stu-id="02fe9-111">There is quite a bit going on here, but fortunately it can be broken into two main processes:</span></span> 

* <span data-ttu-id="02fe9-112">написание и тестирование кода, после чего следуют создание и публикация пакетов установки для основной и вспомогательной версий системы;</span><span class="sxs-lookup"><span data-stu-id="02fe9-112">Writing code and testing it, then creating and publishing installation packages for major and minor versions of the system.</span></span> 
* <span data-ttu-id="02fe9-113">создание виртуальных машин, которые установят и выполнят код в пакетах, и управление этими виртуальными машинами.</span><span class="sxs-lookup"><span data-stu-id="02fe9-113">Creating and managing VMs that will install and execute the code in the packages.</span></span>  

<span data-ttu-id="02fe9-114">Выполнив эти основные процессы, можно переходить к автоматическому обновлению пакета, который выполняется на любой отдельно взятой виртуальной машине, по мере создания и развертывания новых версий.</span><span class="sxs-lookup"><span data-stu-id="02fe9-114">Once both of these core processes are in place, it’s a short step to automatically update the package running on any particular VM as new versions are created and deployed.</span></span>

## <a name="component-overview"></a><span data-ttu-id="02fe9-115">Обзор компонентов</span><span class="sxs-lookup"><span data-stu-id="02fe9-115">Component overview</span></span>
<span data-ttu-id="02fe9-116">Диспетчеры пакетов, такие как [apt-get](https://en.wikipedia.org/wiki/Advanced_Packaging_Tool) , хорошо известны среди разработчиков Linux и гораздо меньше — среди тех, кто работает с Windows.</span><span class="sxs-lookup"><span data-stu-id="02fe9-116">Package managers such as [apt-get](https://en.wikipedia.org/wiki/Advanced_Packaging_Tool) are pretty well known in the Linux world, but not so much in the Windows world.</span></span>  <span data-ttu-id="02fe9-117">К таким диспетчерам пакетов относится [Chocolatey](https://chocolatey.org/), общие сведения о котором изложены в записи [блога](http://www.hanselman.com/blog/IsTheWindowsUserReadyForAptget.aspx) Скотта Ханселмана (Scott Hanselman).</span><span class="sxs-lookup"><span data-stu-id="02fe9-117">[Chocolatey](https://chocolatey.org/) is such a thing, and Scott Hanselman’s [blog](http://www.hanselman.com/blog/IsTheWindowsUserReadyForAptget.aspx) on the topic is a great intro.</span></span>  <span data-ttu-id="02fe9-118">В двух словах, Chocolatey позволяет устанавливать пакеты из центрального репозитория пакетов в системе Windows с помощью командной строки.</span><span class="sxs-lookup"><span data-stu-id="02fe9-118">In a nutshell, Chocolatey allows you to install packages from a central repository of packages into a Windows system using the command line.</span></span>  <span data-ttu-id="02fe9-119">Вы можете создать собственный репозиторий и управлять им, а Chocolatey будет устанавливать пакеты из любого указанного вами количества репозиториев.</span><span class="sxs-lookup"><span data-stu-id="02fe9-119">You can create and manage your own repository, and Chocolatey can install packages from any number of repositories that you designate.</span></span>

<span data-ttu-id="02fe9-120">Настройка требуемого состояния (DSC) ([обзор](https://technet.microsoft.com/library/dn249912.aspx)) — это средство PowerShell, которое позволяет объявить конфигурацию, необходимую для компьютера.</span><span class="sxs-lookup"><span data-stu-id="02fe9-120">Desired State Configuration (DSC) ([overview](https://technet.microsoft.com/library/dn249912.aspx)) is a PowerShell tool that allows you to declare the configuration that you want for a machine.</span></span>  <span data-ttu-id="02fe9-121">Например, вы можете указать, что нужно установить Chocolatey и IIS, открыть порт 80 и установить версию 1.0.0 вашего веб-сайта.</span><span class="sxs-lookup"><span data-stu-id="02fe9-121">For example, you can say, “I want Chocolatey installed, I want IIS installed, I want port 80 opened, I want version 1.0.0 of my website installed.”</span></span>  <span data-ttu-id="02fe9-122">Локальный диспетчер конфигураций DSC реализует эту конфигурацию.</span><span class="sxs-lookup"><span data-stu-id="02fe9-122">The DSC Local Configuration Manager (LCM) implements that configuration.</span></span> <span data-ttu-id="02fe9-123">Опрашивающий сервер DSC содержит хранилище конфигураций для компьютеров.</span><span class="sxs-lookup"><span data-stu-id="02fe9-123">A DSC Pull Server holds a repository of configurations for your machines.</span></span> <span data-ttu-id="02fe9-124">Локальный диспетчер конфигураций на каждом компьютере периодически проверяет, совпадает ли его конфигурация с сохраненной конфигурацией.</span><span class="sxs-lookup"><span data-stu-id="02fe9-124">The LCM on each machine checks in periodically to see if its configuration matches the stored configuration.</span></span> <span data-ttu-id="02fe9-125">Он либо сообщает о состоянии, либо пытается привести компьютер в соответствие с сохраненной конфигурацией.</span><span class="sxs-lookup"><span data-stu-id="02fe9-125">It can either report status or attempt to bring the machine back into alignment with the stored configuration.</span></span> <span data-ttu-id="02fe9-126">Сохраненную конфигурацию на опрашивающем сервере можно изменить, чтобы привести компьютер или набор компьютеров в соответствие с измененной конфигурацией.</span><span class="sxs-lookup"><span data-stu-id="02fe9-126">You can edit the stored configuration on the pull server to cause a machine or set of machines to come into alignment with the changed configuration.</span></span>

<span data-ttu-id="02fe9-127">Служба автоматизации Azure — это управляемая служба в Microsoft Azure, которая позволяет автоматизировать различные задачи с помощью модулей Runbook, узлов, учетных данных, ресурсов и активов, таких как расписания и глобальные переменные.</span><span class="sxs-lookup"><span data-stu-id="02fe9-127">Azure Automation is a managed service in Microsoft Azure that allows you to automate various tasks using runbooks, nodes, credentials, resources and assets such as schedules and global variables.</span></span> <span data-ttu-id="02fe9-128">Automation DSC Azure расширяет возможности автоматизации, которые теперь включают средства DSC PowerShell.</span><span class="sxs-lookup"><span data-stu-id="02fe9-128">Azure Automation DSC extends this automation capability to include PowerShell DSC tools.</span></span>  <span data-ttu-id="02fe9-129">Вот прекрасный [обзор](automation-dsc-overview.md)на эту тему.</span><span class="sxs-lookup"><span data-stu-id="02fe9-129">Here’s a great [overview](automation-dsc-overview.md).</span></span>

<span data-ttu-id="02fe9-130">Ресурс DSC — это модуль кода, который имеет определенные возможности, такие как управление сетевыми подключениями, Active Directory или SQL Server.</span><span class="sxs-lookup"><span data-stu-id="02fe9-130">A DSC Resource is a module of code that has specific capabilities, such as managing networking, Active Directory, or SQL Server.</span></span>  <span data-ttu-id="02fe9-131">Ресурс DSC Chocolatey может получать доступ к серверу NuGet, загружать и устанавливать пакеты и т. д.</span><span class="sxs-lookup"><span data-stu-id="02fe9-131">The Chocolatey DSC Resource knows how to access a NuGet Server (among others), download packages, install packages, and so on.</span></span>  <span data-ttu-id="02fe9-132">Имеется также множество других ресурсов DSC, доступных в [коллекции PowerShell](http://www.powershellgallery.com/packages?q=dsc+resources&prerelease=&sortOrder=package-title).</span><span class="sxs-lookup"><span data-stu-id="02fe9-132">There are many other DSC Resources in the [PowerShell Gallery](http://www.powershellgallery.com/packages?q=dsc+resources&prerelease=&sortOrder=package-title).</span></span>  <span data-ttu-id="02fe9-133">Эти модули установлены на опрашивающем сервере Automation DSC Azure (вручную), поэтому их можно использовать в ваших конфигурациях.</span><span class="sxs-lookup"><span data-stu-id="02fe9-133">These modules are installed into your Azure Automation DSC Pull Server (by you) so they can be used by your configurations.</span></span>

<span data-ttu-id="02fe9-134">Шаблоны Resource Manager предоставляют декларативный способ создания инфраструктуры с помощью сетей, подсетей, сетевой безопасности и маршрутизации, подсистем балансировки нагрузки, сетевых карт, виртуальных машин и т. д.</span><span class="sxs-lookup"><span data-stu-id="02fe9-134">Resource Manager templates provide a declarative way of generating your infrastructure - things like networks, subnets, network security and routing, load balancers, NICs, VMs, and so on.</span></span>  <span data-ttu-id="02fe9-135">В этой [статье](../azure-resource-manager/resource-manager-deployment-model.md) сравнивается декларативная модель развертывания с помощью Resource Manager и принудительная модель развертывания управления службами Azure (ASM или классическая). Кроме того, в этой статье рассматриваются основные поставщики ресурсов, вычислительные ресурсы, ресурсы хранилища и сетевые ресурсы.</span><span class="sxs-lookup"><span data-stu-id="02fe9-135">Here’s an [article](../azure-resource-manager/resource-manager-deployment-model.md) that compares the Resource Manager deployment model (declarative) with the Azure Service Management (ASM, or classic) deployment model (imperative), and discusses the core resource providers, compute, storage and network.</span></span>

<span data-ttu-id="02fe9-136">Одна из ключевых особенностей шаблона Resource Manager заключается в возможности установить на виртуальной машине расширение виртуальной машины во время подготовки.</span><span class="sxs-lookup"><span data-stu-id="02fe9-136">One key feature of an Resource Manager template is its ability to install a VM extension into the VM as it’s provisioned.</span></span>  <span data-ttu-id="02fe9-137">Расширение VM предоставляет определенные возможности, такие как выполнение пользовательского сценария, установка антивирусного программного обеспечения или выполнение сценария конфигурации DSC.</span><span class="sxs-lookup"><span data-stu-id="02fe9-137">A VM extension has specific capabilities such as running a custom script, installing anti-virus software, or running a DSC configuration script.</span></span>  <span data-ttu-id="02fe9-138">Существует много других типов расширений VM.</span><span class="sxs-lookup"><span data-stu-id="02fe9-138">There are many other types of VM extensions.</span></span>

## <a name="quick-trip-around-the-diagram"></a><span data-ttu-id="02fe9-139">Краткий обзор схемы</span><span class="sxs-lookup"><span data-stu-id="02fe9-139">Quick trip around the diagram</span></span>
<span data-ttu-id="02fe9-140">Если начинать сначала, вы пишете код, выполняете сборку и тестирование, а затем создаете пакет установки.</span><span class="sxs-lookup"><span data-stu-id="02fe9-140">Starting at the top, you write your code, build and test, then create an installation package.</span></span>  <span data-ttu-id="02fe9-141">Chocolatey может обрабатывать пакеты установки различных типов, например MSI, MSU и ZIP.</span><span class="sxs-lookup"><span data-stu-id="02fe9-141">Chocolatey can handle various types of installation packages, such as MSI, MSU, ZIP.</span></span>  <span data-ttu-id="02fe9-142">Кроме того, в вашем распоряжении имеются все возможности PowerShell для фактической установки, если возможностей Chocolatey недостаточно.</span><span class="sxs-lookup"><span data-stu-id="02fe9-142">And you have the full power of PowerShell to do the actual installation if Chocolatey’s native capabilities aren’t quite up to it.</span></span>  <span data-ttu-id="02fe9-143">Поместите пакет в легкодоступное место — репозиторий пакетов.</span><span class="sxs-lookup"><span data-stu-id="02fe9-143">Put the package into someplace reachable – a package repository.</span></span>  <span data-ttu-id="02fe9-144">Он может располагаться где угодно. Например, в этом примере используется общая папка в учетной записи хранилища больших двоичных объектов Azure.</span><span class="sxs-lookup"><span data-stu-id="02fe9-144">This usage example uses a public folder in an Azure blob storage account, but it can be anywhere.</span></span>  <span data-ttu-id="02fe9-145">Chocolatey работает непосредственно с серверами NuGet и некоторыми другими серверами в рамках управления метаданными пакета.</span><span class="sxs-lookup"><span data-stu-id="02fe9-145">Chocolatey works natively with NuGet servers and a few others for management of package metadata.</span></span>  <span data-ttu-id="02fe9-146">Возможные варианты описаны в [этой статье](https://github.com/chocolatey/choco/wiki/How-To-Host-Feed).</span><span class="sxs-lookup"><span data-stu-id="02fe9-146">[This article](https://github.com/chocolatey/choco/wiki/How-To-Host-Feed) describes the options.</span></span>  <span data-ttu-id="02fe9-147">В этом примере используется NuGet.</span><span class="sxs-lookup"><span data-stu-id="02fe9-147">This usage example uses NuGet.</span></span>  <span data-ttu-id="02fe9-148">Nuspec — это метаданные о пакетах.</span><span class="sxs-lookup"><span data-stu-id="02fe9-148">A Nuspec is metadata about your packages.</span></span>  <span data-ttu-id="02fe9-149">Метаданные Nuspec «компилируются» в файлы NuPkg и хранятся на сервере NuGet.</span><span class="sxs-lookup"><span data-stu-id="02fe9-149">The Nuspec’s are “compiled” into NuPkg’s and stored in a NuGet server.</span></span>  <span data-ttu-id="02fe9-150">Когда конфигурация запрашивает пакет по имени и ссылается на сервер NuGet, ресурс DSC Chocolatey (установленный на виртуальной машине) извлекает пакет и устанавливает его автоматически.</span><span class="sxs-lookup"><span data-stu-id="02fe9-150">When your configuration requests a package by name, and references a NuGet server, the Chocolatey DSC Resource (now on the VM) grabs the package and installs it for you.</span></span>  <span data-ttu-id="02fe9-151">Можно также запросить определенную версию пакета.</span><span class="sxs-lookup"><span data-stu-id="02fe9-151">You can also request a specific version of a package.</span></span>

<span data-ttu-id="02fe9-152">В левой нижней части схемы упоминается шаблон диспетчера ресурсов Azure (ARM).</span><span class="sxs-lookup"><span data-stu-id="02fe9-152">In the bottom left portion of the picture, there is an Azure Resource Manager (ARM) template.</span></span>  <span data-ttu-id="02fe9-153">В этом примере расширение VM регистрирует виртуальную машину на опрашивающем сервере Automation DSC Azure как узел.</span><span class="sxs-lookup"><span data-stu-id="02fe9-153">In this usage example, the VM extension registers the VM with the Azure Automation DSC Pull Server (that is, a pull server) as a Node.</span></span>  <span data-ttu-id="02fe9-154">Конфигурация хранится на опрашивающем сервере.</span><span class="sxs-lookup"><span data-stu-id="02fe9-154">The configuration is stored in the pull server.</span></span>  <span data-ttu-id="02fe9-155">На самом деле это двойное хранение: в виде обычного текста и в виде компиляции в MOF-файле (для тех, кто имеет опыт работы с такими файлами).  На портале MOF-файл указывается как «конфигурация узла» (а не просто «конфигурация»).</span><span class="sxs-lookup"><span data-stu-id="02fe9-155">Actually, it’s stored twice: once as plain text and once compiled as an MOF file (for those that know about such things.)  In the portal, the MOF is a “node configuration” (as opposed to simply “configuration”).</span></span>  <span data-ttu-id="02fe9-156">Это связанный с узлом артефакт, сообщающий узлу его конфигурацию.</span><span class="sxs-lookup"><span data-stu-id="02fe9-156">It’s the artifact that’s associated with a Node so the node will know its configuration.</span></span>  <span data-ttu-id="02fe9-157">Ниже объясняется, как назначить узлу конфигурацию узла.</span><span class="sxs-lookup"><span data-stu-id="02fe9-157">Details below show how to assign the node configuration to the node.</span></span>

<span data-ttu-id="02fe9-158">Скорее всего, вы уже выполнили действия в верхней части схемы или большую их часть.</span><span class="sxs-lookup"><span data-stu-id="02fe9-158">Presumably you’re already doing the bit at the top, or most of it.</span></span>  <span data-ttu-id="02fe9-159">Создание метаданных Nuspec, их компиляция и сохранение на сервере NuGet — несложная задача.</span><span class="sxs-lookup"><span data-stu-id="02fe9-159">Creating the nuspec, compiling and storing it in a NuGet server is a small thing.</span></span>  <span data-ttu-id="02fe9-160">Кроме того, вы уже управляете виртуальными машинами.</span><span class="sxs-lookup"><span data-stu-id="02fe9-160">And you’re already managing VMs.</span></span>  <span data-ttu-id="02fe9-161">Чтобы выполнить следующий шаг для непрерывного развертывания, необходимо настроить опрашивающий сервер (один раз), зарегистрировать на нем узлы (один раз), а также создать и сохранить на нем конфигурацию (первоначально).</span><span class="sxs-lookup"><span data-stu-id="02fe9-161">Taking the next step to continuous deployment requires setting up the pull server (once), registering your nodes with it (once), and creating and storing the configuration there (initially).</span></span>  <span data-ttu-id="02fe9-162">Затем, по мере обновления и развертывания пакетов в репозитории, обновляйте конфигурацию и конфигурацию узлов на опрашивающем сервере (повторяйте при необходимости).</span><span class="sxs-lookup"><span data-stu-id="02fe9-162">Then as packages are upgraded and deployed to the repository, refresh the Configuration and Node Configuration in the pull server (repeat as needed).</span></span>

<span data-ttu-id="02fe9-163">Начинать работу с шаблона ARM не обязательно.</span><span class="sxs-lookup"><span data-stu-id="02fe9-163">If you’re not starting with an ARM template, that’s also OK.</span></span>  <span data-ttu-id="02fe9-164">Существуют командлеты PowerShell, которые помогут вам зарегистрировать виртуальные машины на опрашивающем сервере и выполнить все остальные действия.</span><span class="sxs-lookup"><span data-stu-id="02fe9-164">There are PowerShell cmdlets designed to help you register your VMs with the pull server and all of the rest.</span></span> <span data-ttu-id="02fe9-165">Дополнительные сведения см. в статье [Подключение компьютеров для управления с помощью Azure Automation DSC](automation-dsc-onboarding.md).</span><span class="sxs-lookup"><span data-stu-id="02fe9-165">For more details, see this article: [Onboarding machines for management by Azure Automation DSC](automation-dsc-onboarding.md)</span></span>

## <a name="step-1-setting-up-the-pull-server-and-automation-account"></a><span data-ttu-id="02fe9-166">Шаг 1. Настройка опрашивающего сервера и учетной записи службы автоматизации</span><span class="sxs-lookup"><span data-stu-id="02fe9-166">Step 1: Setting up the pull server and automation account</span></span>
<span data-ttu-id="02fe9-167">В командной строке PowerShell с аутентификацией (Add-AzureRmAccount) выполните следующую команду (настройка опрашивающего сервера может занять несколько минут):</span><span class="sxs-lookup"><span data-stu-id="02fe9-167">At an authenticated (Add-AzureRmAccount) PowerShell command line:  (can take a few minutes while the pull server is set up)</span></span>

    New-AzureRmResourceGroup –Name MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES
    New-AzureRmAutomationAccount –ResourceGroupName MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES –Name MY-AUTOMATION-ACCOUNT 

<span data-ttu-id="02fe9-168">Учетная запись службы автоматизации может располагаться в любом регионе (расположении) из следующего списка: восточная часть США 2, юго-центральный регион США, Виргиния (для обслуживания государственных организаций США), Западная Европа, Юго-Восточная Азия, восточная Япония, центральная Индия, юго-восточная Австралия, Центральная Канада и Северная Европа.</span><span class="sxs-lookup"><span data-stu-id="02fe9-168">You can put your automation account into any of the following regions (aka location):  East US 2, South Central US, US Gov Virginia, West Europe, Southeast Asia, Japan East, Central India and Australia Southeast, Canada Central, North Europe.</span></span>

## <a name="step-2-vm-extension-tweaks-to-the-arm-template"></a><span data-ttu-id="02fe9-169">Шаг 2. Оптимизация расширения VM в шаблоне ARM</span><span class="sxs-lookup"><span data-stu-id="02fe9-169">Step 2: VM extension tweaks to the ARM template</span></span>
<span data-ttu-id="02fe9-170">Сведения о регистрации виртуальных машин (с помощью расширения VM PowerShell DSC) можно найти в этом [кратком руководстве по шаблонам Azure](https://github.com/Azure/azure-quickstart-templates/tree/master/dsc-extension-azure-automation-pullserver).</span><span class="sxs-lookup"><span data-stu-id="02fe9-170">Details for VM registration (using the PowerShell DSC VM extension) provided in this [Azure Quickstart Template](https://github.com/Azure/azure-quickstart-templates/tree/master/dsc-extension-azure-automation-pullserver).</span></span>  <span data-ttu-id="02fe9-171">На этом шаге новая виртуальная машина регистрируется на опрашивающем сервере в списке узлов DSC.</span><span class="sxs-lookup"><span data-stu-id="02fe9-171">This step registers your new VM with the pull server in the list of DSC Nodes.</span></span>  <span data-ttu-id="02fe9-172">В рамках этой регистрации указывается конфигурация узла, применяемая к узлу.</span><span class="sxs-lookup"><span data-stu-id="02fe9-172">Part of this registration is specifying the node configuration to be applied to the node.</span></span>  <span data-ttu-id="02fe9-173">Эта конфигурация узла может пока отсутствовать на опрашивающем сервере, поэтому вполне нормально, что впервые она указывается на шаге 4.</span><span class="sxs-lookup"><span data-stu-id="02fe9-173">This node configuration doesn't have to exist yet in the pull server, so it's OK that Step 4 is where this is done for the first time.</span></span>  <span data-ttu-id="02fe9-174">Однако на данном шаге 2 нужно принять решение об имени узла и имени конфигурации.</span><span class="sxs-lookup"><span data-stu-id="02fe9-174">But here in Step 2 you do need to have decided the name of the node and the name of the configuration.</span></span>  <span data-ttu-id="02fe9-175">В этом примере использования узел называется isvbox, а конфигурация — ISVBoxConfig.</span><span class="sxs-lookup"><span data-stu-id="02fe9-175">In this usage example, the node is 'isvbox' and the configuration is 'ISVBoxConfig'.</span></span>  <span data-ttu-id="02fe9-176">Поэтому имя конфигурации узла (указываемое в DeploymentTemplate.json) имеет значение ISVBoxConfig.isvbox.</span><span class="sxs-lookup"><span data-stu-id="02fe9-176">So the node configuration name (to be specified in DeploymentTemplate.json) is 'ISVBoxConfig.isvbox'.</span></span>  

## <a name="step-3-adding-required-dsc-resources-to-the-pull-server"></a><span data-ttu-id="02fe9-177">Шаг 3. Добавление требуемых ресурсов DSC на опрашивающий сервер</span><span class="sxs-lookup"><span data-stu-id="02fe9-177">Step 3: Adding required DSC resources to the pull server</span></span>
<span data-ttu-id="02fe9-178">Коллекция PowerShell содержит средства для установки ресурсов DSC в учетной записи службы автоматизации Azure.</span><span class="sxs-lookup"><span data-stu-id="02fe9-178">The PowerShell Gallery is instrumented to install DSC resources into your Azure Automation account.</span></span>  <span data-ttu-id="02fe9-179">Перейдите к нужному ресурсу и нажмите кнопку «Развернуть в службе автоматизации Azure».</span><span class="sxs-lookup"><span data-stu-id="02fe9-179">Navigate to the resource you want and click the “Deploy to Azure Automation” button.</span></span>

![Пример из коллекции PowerShell](./media/automation-dsc-cd-chocolatey/xNetworking.PNG)

<span data-ttu-id="02fe9-181">Недавно на портал Azure добавлена возможность получать новые модули и обновлять имеющиеся.</span><span class="sxs-lookup"><span data-stu-id="02fe9-181">Another technique recently added to the Azure Portal allows you to pull in new modules or update existing modules.</span></span> <span data-ttu-id="02fe9-182">Щелкните ресурс учетной записи службы автоматизации, плитку "Ресурсы" и, наконец, плитку "Модули".</span><span class="sxs-lookup"><span data-stu-id="02fe9-182">Click through the Automation Account resource, the Assets tile, and finally the Modules tile.</span></span>  <span data-ttu-id="02fe9-183">Значок "Обзор коллекции" позволяет просмотреть список модулей в коллекции, перейти к подробным сведениям и в конечном итоге импортировать модуль в учетную запись службы автоматизации.</span><span class="sxs-lookup"><span data-stu-id="02fe9-183">The Browse Gallery icon allows you to see the list of modules in the gallery, drill down into details and ultimately import into your Automation Account.</span></span> <span data-ttu-id="02fe9-184">Это отличный способ периодически обновлять модули.</span><span class="sxs-lookup"><span data-stu-id="02fe9-184">This is a great way to keep your modules up to date from time to time.</span></span> <span data-ttu-id="02fe9-185">Кроме того, во время импорта проверяется наличие зависимостей от других модулей, чтобы обеспечить полную синхронизацию.</span><span class="sxs-lookup"><span data-stu-id="02fe9-185">And, the import feature checks dependencies with other modules to ensure nothing gets out of sync.</span></span>

<span data-ttu-id="02fe9-186">Также это можно сделать вручную.</span><span class="sxs-lookup"><span data-stu-id="02fe9-186">Or, there’s the manual approach.</span></span>  <span data-ttu-id="02fe9-187">Структура папок модуля интеграции PowerShell для компьютеров Windows немного отличается от структуры папок, ожидаемой службой автоматизации Azure.</span><span class="sxs-lookup"><span data-stu-id="02fe9-187">The folder structure of a PowerShell Integration Module for a Windows computer is a little different from the folder structure expected by the Azure Automation.</span></span>  <span data-ttu-id="02fe9-188">Некоторые параметры вам придется настроить самостоятельно.</span><span class="sxs-lookup"><span data-stu-id="02fe9-188">This requires a little tweaking on your part.</span></span>  <span data-ttu-id="02fe9-189">Но эту процедуру нужно выполнить только один раз для каждого ресурса (если вы не планируете обновлять его в будущем), и в ней нет ничего сложного.  Дополнительные сведения о разработке модулей интеграции PowerShell см. в статье [Authoring Integration Modules for Azure Automation](https://azure.microsoft.com/blog/authoring-integration-modules-for-azure-automation/) (Разработка модулей интеграции для службы автоматизации Azure).</span><span class="sxs-lookup"><span data-stu-id="02fe9-189">But it’s not hard, and it’s done only once per resource (unless you want to upgrade it in future.)  For more information on authoring PowerShell Integration Modules, see this article: [Authoring Integration Modules for Azure Automation](https://azure.microsoft.com/blog/authoring-integration-modules-for-azure-automation/)</span></span>

* <span data-ttu-id="02fe9-190">Установите модуль, необходимый на рабочей станции, следующим образом:</span><span class="sxs-lookup"><span data-stu-id="02fe9-190">Install the module that you need on your workstation, as follows:</span></span>
  * <span data-ttu-id="02fe9-191">Установите [Windows Management Framework 5](http://aka.ms/wmf5latest) (не требуется для Windows 10).</span><span class="sxs-lookup"><span data-stu-id="02fe9-191">Install [Windows Management Framework, v5](http://aka.ms/wmf5latest) (not needed for Windows 10)</span></span>
  * <span data-ttu-id="02fe9-192">`Install-Module –Name MODULE-NAME` <— извлекает модуль из коллекции PowerShell.</span><span class="sxs-lookup"><span data-stu-id="02fe9-192">`Install-Module –Name MODULE-NAME`    <—grabs the module from the PowerShell Gallery</span></span> 
* <span data-ttu-id="02fe9-193">Скопируйте папку модуля из `c:\Program Files\WindowsPowerShell\Modules\MODULE-NAME` во временную папку.</span><span class="sxs-lookup"><span data-stu-id="02fe9-193">Copy the module folder from `c:\Program Files\WindowsPowerShell\Modules\MODULE-NAME` to a temp folder</span></span> 
* <span data-ttu-id="02fe9-194">Удалите примеры и документацию из основной папки.</span><span class="sxs-lookup"><span data-stu-id="02fe9-194">Delete samples and documentation from the main folder</span></span> 
* <span data-ttu-id="02fe9-195">Упакуйте основную папку, присвоив ZIP-файлу такое же имя, как у папки.</span><span class="sxs-lookup"><span data-stu-id="02fe9-195">Zip the main folder, naming the ZIP file exactly the same as the folder</span></span> 
* <span data-ttu-id="02fe9-196">Поместите ZIP-файл в легкодоступное расположение HTTP, например хранилище BLOB-объектов в учетной записи службы хранилища Azure.</span><span class="sxs-lookup"><span data-stu-id="02fe9-196">Put the ZIP file into a reachable HTTP location, such as blob storage in an Azure Storage Account.</span></span>
* <span data-ttu-id="02fe9-197">Выполните эту команду PowerShell:</span><span class="sxs-lookup"><span data-stu-id="02fe9-197">Run this PowerShell:</span></span>
  
      New-AzureRmAutomationModule `
          -ResourceGroupName MY-AUTOMATION-RG -AutomationAccountName MY-AUTOMATION-ACCOUNT `
          -Name MODULE-NAME –ContentLink "https://STORAGE-URI/CONTAINERNAME/MODULE-NAME.zip"

<span data-ttu-id="02fe9-198">Приведенный здесь пример выполняет эти действия для cChoco и xNetworking.</span><span class="sxs-lookup"><span data-stu-id="02fe9-198">The included example performs these steps for cChoco and xNetworking.</span></span> <span data-ttu-id="02fe9-199">Ознакомьтесь с [примечаниями](#notes) по особенностям работы с cChoco.</span><span class="sxs-lookup"><span data-stu-id="02fe9-199">See the [Notes](#notes) for special handling for cChoco.</span></span>

## <a name="step-4-adding-the-node-configuration-to-the-pull-server"></a><span data-ttu-id="02fe9-200">Шаг 4. Добавление конфигурации узла к опрашивающему серверу</span><span class="sxs-lookup"><span data-stu-id="02fe9-200">Step 4: Adding the node configuration to the pull server</span></span>
<span data-ttu-id="02fe9-201">В первоначальном импорте конфигурации на опрашивающий сервер и ее компиляции нет ничего особенного.</span><span class="sxs-lookup"><span data-stu-id="02fe9-201">There’s nothing special about the first time you import your configuration into the pull server and compile.</span></span>  <span data-ttu-id="02fe9-202">Все последующие операции импорта и компиляции с этой конфигурацией выполняются аналогичным образом.</span><span class="sxs-lookup"><span data-stu-id="02fe9-202">All subsequent import/compiles of the same configuration look exactly the same.</span></span>  <span data-ttu-id="02fe9-203">Каждый раз, когда вам нужно обновить пакет и передать его в рабочую среду, выполняйте этот шаг, предварительно проверив правильность файла конфигурации (включая новую версию пакета).</span><span class="sxs-lookup"><span data-stu-id="02fe9-203">Each time you update your package and need to push it out to production you do this step after ensuring the configuration file is correct – including the new version of your package.</span></span>  <span data-ttu-id="02fe9-204">Вот файл конфигурации и команда PowerShell:</span><span class="sxs-lookup"><span data-stu-id="02fe9-204">Here’s the configuration file and PowerShell:</span></span>

<span data-ttu-id="02fe9-205">ISVBoxConfig.ps1:</span><span class="sxs-lookup"><span data-stu-id="02fe9-205">ISVBoxConfig.ps1:</span></span>

    Configuration ISVBoxConfig 
    { 
        Import-DscResource -ModuleName cChoco 
        Import-DscResource -ModuleName xNetworking

        Node "isvbox" {   

            cChocoInstaller installChoco 
            { 
                InstallDir = "C:\choco" 
            }

            WindowsFeature installIIS 
            { 
                Ensure="Present" 
                Name="Web-Server" 
            }

            xFirewall WebFirewallRule 
            { 
                Direction = "Inbound" 
                Name = "Web-Server-TCP-In" 
                DisplayName = "Web Server (TCP-In)" 
                Description = "IIS allow incoming web site traffic." 
                DisplayGroup = "IIS Incoming Traffic" 
                State = "Enabled" 
                Access = "Allow" 
                Protocol = "TCP" 
                LocalPort = "80" 
                Ensure = "Present" 
            }

            cChocoPackageInstaller trivialWeb 
            {            
                Name = "trivialweb" 
                Version = "1.0.0" 
                Source = “MY-NUGET-V2-SERVER-ADDRESS” 
                DependsOn = "[cChocoInstaller]installChoco", 
                "[WindowsFeature]installIIS" 
            } 
        }    
    }

<span data-ttu-id="02fe9-206">New-ConfigurationScript.ps1:</span><span class="sxs-lookup"><span data-stu-id="02fe9-206">New-ConfigurationScript.ps1:</span></span>

    Import-AzureRmAutomationDscConfiguration ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -SourcePath C:\temp\AzureAutomationDsc\ISVBoxConfig.ps1 ` 
        -Published –Force

    $jobData = Start-AzureRmAutomationDscCompilationJob ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -ConfigurationName ISVBoxConfig 

    $compilationJobId = $jobData.Id

    Get-AzureRmAutomationDscCompilationJob ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -Id $compilationJobId

<span data-ttu-id="02fe9-207">В результате этих действий на опрашивающем сервере будет создана новая конфигурация узла с именем ISVBoxConfig.isvbox.</span><span class="sxs-lookup"><span data-stu-id="02fe9-207">These steps result in a new node configuration named “ISVBoxConfig.isvbox” being placed on the pull server.</span></span>  <span data-ttu-id="02fe9-208">Имя конфигурации узла задается в формате «имя_конфигурации.имя_узла».</span><span class="sxs-lookup"><span data-stu-id="02fe9-208">The node configuration name is built as “configurationName.nodeName”.</span></span>

## <a name="step-5-creating-and-maintaining-package-metadata"></a><span data-ttu-id="02fe9-209">Шаг 5. Создание и поддержка метаданных пакета</span><span class="sxs-lookup"><span data-stu-id="02fe9-209">Step 5: Creating and maintaining package metadata</span></span>
<span data-ttu-id="02fe9-210">Для описания каждого пакета, который помещается в репозиторий пакетов, необходимы метаданные Nuspec.</span><span class="sxs-lookup"><span data-stu-id="02fe9-210">For each package that you put into the package repository, you need a nuspec that describes it.</span></span>  <span data-ttu-id="02fe9-211">Эти метаданные Nuspec следует компилировать и хранить на сервере NuGet.</span><span class="sxs-lookup"><span data-stu-id="02fe9-211">That nuspec must be compiled and stored in your NuGet server.</span></span> <span data-ttu-id="02fe9-212">Этот процесс описан [здесь](http://docs.nuget.org/create/creating-and-publishing-a-package).</span><span class="sxs-lookup"><span data-stu-id="02fe9-212">This process is described [here](http://docs.nuget.org/create/creating-and-publishing-a-package).</span></span>  <span data-ttu-id="02fe9-213">В качестве сервера NuGet можно использовать сайт MyGet.org.</span><span class="sxs-lookup"><span data-stu-id="02fe9-213">You can use MyGet.org as a NuGet server.</span></span>  <span data-ttu-id="02fe9-214">Это платная служба, но начальные единицы хранения предоставляются бесплатно.</span><span class="sxs-lookup"><span data-stu-id="02fe9-214">They sell this service, but have a starter SKU that’s free.</span></span>  <span data-ttu-id="02fe9-215">На сайте NuGet.org вы найдете инструкции по установке сервера NuGet для закрытых пакетов.</span><span class="sxs-lookup"><span data-stu-id="02fe9-215">At NuGet.org you’ll find instructions on installing your own NuGet server for your private packages.</span></span>

## <a name="step-6-tying-it-all-together"></a><span data-ttu-id="02fe9-216">Шаг 6. Сборка</span><span class="sxs-lookup"><span data-stu-id="02fe9-216">Step 6: Tying it all together</span></span>
<span data-ttu-id="02fe9-217">Каждый раз, когда версия проходит контроль качества и утверждается для развертывания, создается пакет, а nuspec и nupkg обновляются и развертываются на сервере NuGet.</span><span class="sxs-lookup"><span data-stu-id="02fe9-217">Each time a version passes QA and is approved for deployment, the package is created, nuspec and nupkg updated and deployed to the NuGet server.</span></span>  <span data-ttu-id="02fe9-218">Кроме того, чтобы обеспечить согласованность с новым номером версии, необходимо обновить конфигурацию (описанный выше шаг 4).</span><span class="sxs-lookup"><span data-stu-id="02fe9-218">In addition, the configuration (Step 4 above) must be updated to agree with the new version number.</span></span>  <span data-ttu-id="02fe9-219">Ее необходимо отправить на опрашивающий сервер и скомпилировать.</span><span class="sxs-lookup"><span data-stu-id="02fe9-219">It must be sent to the pull server and compiled.</span></span>  <span data-ttu-id="02fe9-220">С этого момента именно виртуальные машины, зависящие от этой конфигурации, отвечают за получение обновления и его установку.</span><span class="sxs-lookup"><span data-stu-id="02fe9-220">From that point on, it's up to the VMs that depend on that configuration to pull the update and install it.</span></span>  <span data-ttu-id="02fe9-221">Каждое такое обновление довольно просто и представляет собой одну-две строки кода PowerShell.</span><span class="sxs-lookup"><span data-stu-id="02fe9-221">Each of these updates are simple - just a line or two of PowerShell.</span></span>  <span data-ttu-id="02fe9-222">В случае с Visual Studio Team Services некоторые из них инкапсулированы в задачи сборки, которые могут быть соединены в цепочку внутри сборки.</span><span class="sxs-lookup"><span data-stu-id="02fe9-222">In the case of Visual Studio Team Services, some of them are encapsulated in build tasks that can be chained together in a build.</span></span>  <span data-ttu-id="02fe9-223">Дополнительные сведения см. в [этой статье](https://www.visualstudio.com/en-us/docs/alm-devops-feature-index#continuous-delivery).</span><span class="sxs-lookup"><span data-stu-id="02fe9-223">This [article](https://www.visualstudio.com/en-us/docs/alm-devops-feature-index#continuous-delivery) provides more details.</span></span>  <span data-ttu-id="02fe9-224">В этом [репозитории GitHub](https://github.com/Microsoft/vso-agent-tasks) описаны различные доступные задачи сборки.</span><span class="sxs-lookup"><span data-stu-id="02fe9-224">This [GitHub repo](https://github.com/Microsoft/vso-agent-tasks) details the various available build tasks.</span></span>

## <a name="notes"></a><span data-ttu-id="02fe9-225">Примечания</span><span class="sxs-lookup"><span data-stu-id="02fe9-225">Notes</span></span>
<span data-ttu-id="02fe9-226">В начале этого примера создается виртуальная машина с помощью универсального образа Windows Server 2012 R2 из коллекции Azure.</span><span class="sxs-lookup"><span data-stu-id="02fe9-226">This usage example starts with a VM from a generic Windows Server 2012 R2 image from the Azure gallery.</span></span>  <span data-ttu-id="02fe9-227">Ее можно запустить из любого сохраненного образа, а затем настроить, используя конфигурацию DSC.</span><span class="sxs-lookup"><span data-stu-id="02fe9-227">You can start from any stored image and then tweak from there with the DSC configuration.</span></span>  <span data-ttu-id="02fe9-228">Однако изменение конфигурации, встроенной в образ, требует гораздо больше усилий, чем динамическое обновление конфигурации с помощью DSC.</span><span class="sxs-lookup"><span data-stu-id="02fe9-228">However, changing configuration that is baked into an image is much harder than dynamically updating the configuration using DSC.</span></span>

<span data-ttu-id="02fe9-229">Для использования этого метода на виртуальных машинах не обязательно использовать шаблон ARM и расширение VM.</span><span class="sxs-lookup"><span data-stu-id="02fe9-229">You don’t have to use an ARM template and the VM extension to use this technique with your VMs.</span></span>  <span data-ttu-id="02fe9-230">Кроме того, виртуальные машины на которых должно выполняться непрерывное развертывание, не обязательно должны размещаться Azure.</span><span class="sxs-lookup"><span data-stu-id="02fe9-230">And your VMs don’t have to be on Azure to be under CD management.</span></span>  <span data-ttu-id="02fe9-231">На виртуальной машине достаточно установить Chocolatey и настроить локальный диспетчер конфигураций, чтобы указать для нее расположение опрашивающего сервера.</span><span class="sxs-lookup"><span data-stu-id="02fe9-231">All that’s necessary is that Chocolatey be installed and the LCM configured on the VM so it knows where the pull server is.</span></span>  

<span data-ttu-id="02fe9-232">Конечно, на время обновления пакета на виртуальной машине в рабочей среде эту виртуальную машину придется вывести из эксплуатации.</span><span class="sxs-lookup"><span data-stu-id="02fe9-232">Of course, when you update a package on a VM that’s in production, you need to take that VM out of rotation while the update is installed.</span></span>  <span data-ttu-id="02fe9-233">Это можно сделать разными способами.</span><span class="sxs-lookup"><span data-stu-id="02fe9-233">How you do this varies widely.</span></span>  <span data-ttu-id="02fe9-234">Например, на виртуальной машине, которая находится под контролем балансировщика нагрузки Azure, можно добавить настраиваемый зонд.</span><span class="sxs-lookup"><span data-stu-id="02fe9-234">For example, with a VM behind an Azure Load Balancer, you can add a Custom Probe.</span></span>  <span data-ttu-id="02fe9-235">При обновлении виртуальной машины конечная точка зонда должна возвращать значение 400.</span><span class="sxs-lookup"><span data-stu-id="02fe9-235">While updating the VM, have the probe endpoint return a 400.</span></span>  <span data-ttu-id="02fe9-236">Настройка, необходимая для этого изменения, может содержаться в вашей конфигурации, и после завершения обновления вы сможете снова переключиться на возвращение значения 200.</span><span class="sxs-lookup"><span data-stu-id="02fe9-236">The tweak necessary to cause this change can be inside your configuration, as can the tweak to switch it back to returning a 200 once the update is complete.</span></span>

<span data-ttu-id="02fe9-237">Полный исходный код для этого примера хранится в [этом проекте Visual Studio](https://github.com/sebastus/ARM/tree/master/CDIaaSVM) на сайте GitHub.</span><span class="sxs-lookup"><span data-stu-id="02fe9-237">Full source for this usage example is in [this Visual Studio project](https://github.com/sebastus/ARM/tree/master/CDIaaSVM) on GitHub.</span></span>

## <a name="related-articles"></a><span data-ttu-id="02fe9-238">Связанные статьи</span><span class="sxs-lookup"><span data-stu-id="02fe9-238">Related Articles</span></span>
* [<span data-ttu-id="02fe9-239">Обзор DSC службы автоматизации Azure</span><span class="sxs-lookup"><span data-stu-id="02fe9-239">Azure Automation DSC Overview</span></span>](automation-dsc-overview.md)
* [<span data-ttu-id="02fe9-240">Командлеты Automation DSC Azure</span><span class="sxs-lookup"><span data-stu-id="02fe9-240">Azure Automation DSC cmdlets</span></span>](https://msdn.microsoft.com/library/mt244122.aspx)
* [<span data-ttu-id="02fe9-241">Подключение компьютеров для управления с помощью Azure Automation DSC</span><span class="sxs-lookup"><span data-stu-id="02fe9-241">Onboarding machines for management by Azure Automation DSC</span></span>](automation-dsc-onboarding.md)


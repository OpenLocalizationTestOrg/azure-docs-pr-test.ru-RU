---
title: "Выходные данные и сообщения Runbook в службе автоматизации Azure | Документация Майкрософт"
description: "Описывает способы создания и извлечения выходных данных и сообщений об ошибках из модулей Runbook в службе автоматизации Azure."
services: automation
documentationcenter: 
author: georgewallace
manager: jwhit
editor: tysonn
ms.assetid: 13a414f5-0e2c-4be2-9558-a3e3ec84b6b2
ms.service: automation
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 11/11/2016
ms.author: magoedte;bwren
ms.openlocfilehash: 415eddaec9702a42ceee51858a39840fcd6a202b
ms.sourcegitcommit: 3f33787645e890ff3b73c4b3a28d90d5f814e46c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/03/2018
---
# <a name="runbook-output-and-messages-in-azure-automation"></a>Выходные данные и сообщения Runbook в службе автоматизации Azure
В большинстве модулей Runbook службы автоматизации Azure имеют определенную форму выходных данных, таких как сообщение об ошибке для пользователя или сложный объект, предназначенный для использования другим рабочим процессом. Windows PowerShell предоставляет [несколько потоков](http://blogs.technet.com/heyscriptingguy/archive/2014/03/30/understanding-streams-redirection-and-write-host-in-powershell.aspx) для отправки выходных данных из сценария или рабочего процесса. Служба автоматизации Azure по-разному работает с каждым из этих потоков, и необходимо следовать рекомендациям по их использованию при создании Runbook.

Ниже приводится краткое описание каждого из потоков и их поведение на портале Azure при выполнении опубликованного модуля runbook и последующем [тестировании модуля runbook](automation-testing-runbook.md). В последующих разделах приведены дополнительные сведения о каждом потоке.

| Поток | ОПИСАНИЕ | Опубликовано | Тест |
|:--- |:--- |:--- |:--- |
| Выходные данные |Объекты, предназначенные для использования другими Runbook. |Записывается в журнал заданий. |Отображается в области вывода теста. |
| Предупреждение |Предупреждающее сообщение, предназначенное для пользователя. |Записывается в журнал заданий. |Отображается в области вывода теста. |
| Ошибка |Сообщение об ошибке, предназначенное для пользователя. В отличие от исключения, по умолчанию Runbook продолжит работу после сообщения об ошибке. |Записывается в журнал заданий. |Отображается в области вывода теста. |
| Подробная информация |Сообщения, содержащие общую или отладочную информацию. |Записывается в журнал заданий только в том случае, если для Runbook включено подробное ведение журнала. |Отображается в области вывода теста только в том случае, если в Runbook для $VerbosePreference задано значение Continue. |
| Ход выполнения |До и после каждого действия в Runbook автоматически создаются записи. Модулю Runbook не следует пытаться создать свои собственные записи хода выполнения, так как они предназначены для интерактивного пользователя. |Записывается в журнал заданий только в том случае, если для Runbook включено ведение журнала хода выполнения. |Не отображается в области вывода теста. |
| Отладка |Сообщения, предназначенные для интерактивного пользователя. Не следует использовать в Runbook. |Не записывается в журнал заданий. |Не записывается в область вывода теста. |

## <a name="output-stream"></a>Поток вывода
Поток вывода предназначен для вывода объектов, созданных сценарием или рабочим процессом, когда он работает правильно. В службе автоматизации Azure этот поток в основном используется для объектов, которые предназначены для использования [родительским Runbook, вызывающим текущий Runbook](automation-child-runbooks.md). Если вы [используете встроенный вызов Runbook](automation-child-runbooks.md#invoking-a-child-runbook-using-inline-execution) из родительского Runbook, он возвращает данные из потока вывода в родительский Runbook. Для передачи информации пользователю следует использовать только поток вывода, если известно, что Runbook никогда не будет вызван другим Runbook. Однако в обычном случае для передачи информации пользователю рекомендуется использовать [подробный поток](#Verbose) .

Можно записать данные в поток вывода с помощью [Write-Output](http://technet.microsoft.com/library/hh849921.aspx) или поместив объект в отдельную строку в Runbook.

    #The following lines both write an object to the output stream.
    Write-Output –InputObject $object
    $object

### <a name="output-from-a-function"></a>Выходные данные функции
При записи в поток вывода в функции, которая находится в Runbook, выходные данные передаются обратно в Runbook. Если Runbook присваивает эти выходные данные переменной, то они не записываются в поток вывода. При записи в любые другие потоки в функции записывает в соответствующий поток для модуля runbook.

Рассмотрим следующий пример модуля runbook.

    Workflow Test-Runbook
    {
        Write-Verbose "Verbose outside of function" -Verbose
        Write-Output "Output outside of function"
        $functionOutput = Test-Function
        $functionOutput

    Function Test-Function
     {
        Write-Verbose "Verbose inside of function" -Verbose
        Write-Output "Output inside of function"
      }
    }


Поток вывода для задания Runbook будет следующим:

    Output inside of function
    Output outside of function

Подробный поток для задания Runbook будет следующим:

    Verbose outside of function
    Verbose inside of function

После публикации модуля Runbook и перед его запуском вам нужно включить подробное ведение журнала в параметрах модуля, чтобы получить выходной поток подробных сведений.

### <a name="declaring-output-data-type"></a>Объявление типа выходных данных
Рабочий процесс может указать тип выходных данных с помощью [атрибута OutputType](http://technet.microsoft.com/library/hh847785.aspx). Этот атрибут не оказывает влияния во время выполнения, но содержит указание об ожидаемых выходных данных Runbook для автора Runbook во время разработки. По мере набора инструментов для модулей Runbook, важность объявления типов выходных данных во время разработки увеличивается по важности. Поэтому рекомендуется включать это объявление во все создаваемые вами Runbook.

Вот список с примерами типов выходных данных:

* System.String
* System.Int32
* System.Collections.Hashtable
* Microsoft.Azure.Commands.Compute.Models.PSVirtualMachine

Следующий пример Runbook выводит строковый объект и включает в себя объявление типа выходных данных. Если Runbook выводит массив определенного типа, все равно следует указать его тип, а не массив типа.

    Workflow Test-Runbook
    {
       [OutputType([string])]

       $output = "This is some string output."
       Write-Output $output
    }

Чтобы объявить тип выходных данных в модулях Runbook графический или графического рабочего процесса PowerShell, можно выбрать **входной и выходной** пункт меню и укажите название тип выходных данных. Мы рекомендуем использовать полное имя класса .NET, чтобы упростить идентификацию при использовании ссылок из родительского модуля. Таким образом все свойства этого класса предоставляются шине данных в модуле Runbook, обеспечивая более гибкие возможности их использования в рамках условной логики, ведения журнала, а также создания ссылок со значениями для других действий в модуле Runbook.<br> ![Runbook: раздел "Входные и выходные данные"](media/automation-runbook-output-and-messages/runbook-menu-input-and-output-option.png)

В следующем примере с использованием двух графических модулей Runbook мы покажем, как это работает. Если применить модель разработки модульной runbook, у нас есть один runbook, который служит в качестве *шаблона Runbook проверки подлинности* управление проверкой подлинности с помощью Azure, используя учетную запись запуска от имени. Второй модуль Runbook (обычно он реализует основную логику для автоматизации сценария) выполняет *шаблон аутентификации Runbook* , а затем выводит результаты в **тестовую** область выходных данных.  В обычных условиях этот модуль Runbook выполнял бы какие-то действия в отношении ресурса, используя выходные данные дочернего модуля Runbook.    

Ниже представлена основная логика модуля Runbook **AuthenticateTo-Azure**.<br> ![Runbook: пример шаблона аутентификации](media/automation-runbook-output-and-messages/runbook-authentication-template.png).  

Она включает тип выходных данных *Microsoft.Azure.Commands.Profile.Models.PSAzureContext*, который возвращает свойства профиля аутентификации.<br> ![Runbook: пример типа выходных данных](media/automation-runbook-output-and-messages/runbook-input-and-output-add-blade.png) 

Хотя этот runbook прост, есть один элемент конфигурации для вызова здесь. Последнее действие — выполнение командлета **Write-Output** и запись данных профиля в переменную $_ с помощью выражения PowerShell для параметра **Inputobject**, который необходим для этого командлета.  

Для второго модуля Runbook (с именем *Test-ChildOutputType*) в нашем примере предусмотрены два действия.<br> ![Runbook: пример типа выходных данных дочернего модуля](media/automation-runbook-output-and-messages/runbook-display-authentication-results-example.png) 

Первое действие вызывает модуль Runbook **AuthenticateTo-Azure**, а второе — выполняет командлет **Write-Verbose** с использованием **источника данных** для **выходных данных действия** и значения **Context.Subscription.SubscriptionName** для **пути к полю** (определяет выходные данные контекста из модуля **AuthenticateTo-Azure**).<br> ![Командлет Write-Verbose: источник данных параметров](media/automation-runbook-output-and-messages/runbook-write-verbose-parameters-config.png)    

Результат — имя подписки.<br> ![Runbook: результаты командлета Test-ChildOutputType](media/automation-runbook-output-and-messages/runbook-test-childoutputtype-results.png)

Замечание о поведении элемента управления "Тип выходных данных". Когда вы вводите значение в поле "Тип выходных данных" в колонке свойств входных и выходных данных, щелкните рядом с элементом управления, чтобы он распознал эту запись.  

## <a name="message-streams"></a>Потоки сообщений
В отличие от потока вывода потоки сообщений предназначены для передачи информации пользователю. Существует несколько потоков сообщений для различных типов информации, и каждый по-разному обрабатываются службой автоматизации Azure.

### <a name="warning-and-error-streams"></a>Потоки предупреждений и ошибок
Потоки предупреждений и ошибок предназначены для ведения журнала проблем, возникающих в Runbook. Они записываются в журнал заданий при выполнении runbook и включаются в тестовую область вывода на портале Azure при тестировании модуля runbook. По умолчанию Runbook продолжит выполнение после предупреждения или ошибки. Можно указать, что Runbook должен быть приостановлен при предупреждении или ошибке, задав [привилегированную переменную](#PreferenceVariables) в Runbook перед созданием сообщения. Например, чтобы приостановить Runbook при ошибке, как при исключении, присвойте **$ErrorActionPreference** значение Stop.

Создайте предупреждение или сообщение об ошибке с помощью командлета [Write-Warning](https://technet.microsoft.com/library/hh849931.aspx) или [Write-Error](http://technet.microsoft.com/library/hh849962.aspx). Действия также могут записывать данные в эти потоки.

    #The following lines create a warning message and then an error message that will suspend the runbook.

    $ErrorActionPreference = "Stop"
    Write-Warning –Message "This is a warning message."
    Write-Error –Message "This is an error message that will stop the runbook because of the preference variable."

### <a name="verbose-stream"></a>Подробный поток
Поток подробных сообщений предназначен для общей информации о работе Runbook. Так как в Runbook недоступен [поток отладки](#Debug), подробные сообщения следует использовать для отладки. По умолчанию подробные сообщения из опубликованных Runbook не будут сохраняться в журнале заданий. Чтобы сохранить подробные сообщения, настройте опубликованные модули Runbook в подробные записи журнала на вкладке Настройка модуля Runbook на портале Azure. В большинстве случаев для Runbook следует оставить значение по умолчанию, при котором подробные записи не добавляются в журнал. Это обусловлено вопросами производительности. Включайте этот параметр только для устранения неполадок и отладки Runbook.

При [тестировании Runbook](automation-testing-runbook.md)подробные сообщения не отображаются, даже если для Runbook настроено добавление подробных записей в журнал. Для отображения подробных сообщений при [тестировании Runbook](automation-testing-runbook.md)необходимо переменной $VerbosePreference присвоить значение Continue. Эта переменная задана подробные сообщения отображаются в области вывода теста на портале Azure.

Для создания подробного сообщения используется командлет [Write-Verbose](http://technet.microsoft.com/library/hh849951.aspx) .

    #The following line creates a verbose message.

    Write-Verbose –Message "This is a verbose message."

### <a name="debug-stream"></a>Поток отладки
Поток отладки предназначен для использования интерактивным пользователем и не должен использоваться в модулях Runbook.

## <a name="progress-records"></a>Записи о ходе выполнения
Если настроить Runbook для ведения журнала хода выполнения (на вкладке "Настройка" Runbook на портале Azure), то до и после выполнения каждого действия в журнал заданий будет добавляться соответствующая запись. В большинстве случаев для Runbook следует оставить значение по умолчанию, при котором записи о ходе выполнения не добавляются в журнал. Это позволит получить максимальную производительность. Включайте этот параметр только для устранения неполадок и отладки Runbook. При тестировании Runbook сообщения о ходе выполнения не отображаются, даже если для него настроено добавление записей о ходе выполнения в журнал.

Командлет [Write-Progress](http://technet.microsoft.com/library/hh849902.aspx) недействителен в Runbook, так как предназначен для использования интерактивным пользователем.

## <a name="preference-variables"></a>Привилегированные переменные
Windows PowerShell использует [привилегированные переменные](http://technet.microsoft.com/library/hh847796.aspx), чтобы определить, как реагировать на данные, отправляемые в различные потоки вывода. Эти переменные можно задать в модуле runbook для управления как реагирует на данные, отправленные в разные потоки.

В следующей таблице перечислены привилегированные переменные, которые могут использоваться в модулях Runbook, а также их допустимые значения и значения по умолчанию. Обратите внимание, что эта таблица содержит только значения, которые являются допустимыми в Runbook. Дополнительные значения привилегированных переменных допускаются при использовании в Windows PowerShell за пределами службы автоматизации Azure.

| Переменная | По умолчанию | Допустимые значения |
|:--- |:--- |:--- |
| WarningPreference |Continue |Остановить<br>Continue<br>SilentlyContinue |
| ErrorActionPreference |Continue |Остановить<br>Continue<br>SilentlyContinue |
| VerbosePreference |SilentlyContinue |Остановить<br>Continue<br>SilentlyContinue |

В следующей таблице представлено поведение для соответствующих значений привилегированных переменных, допустимых в Runbook.

| Значение | Поведение |
|:--- |:--- |
| Continue |Записывает сообщение в журнал и продолжает выполнение Runbook. |
| SilentlyContinue |Продолжает выполнение Runbook без добавления сообщения в журнал. То есть сообщение игнорируется. |
| Stop |Записывает сообщение в журнал и приостанавливает выполнение Runbook. |

## <a name="retrieving-runbook-output-and-messages"></a>Извлечение выходных данных и сообщений Runbook
### <a name="azure-portal"></a>Портал Azure
На портале Azure на вкладке "Задания" Runbook можно просмотреть подробную информацию о задании Runbook. Сводка задания отображаются входные параметры и [выходной поток](#Output) Помимо общих сведений о задании и любые исключения, если они имели место. Журнал содержит сообщения от [выходной поток](#Output) и [потоки предупреждений и ошибок](#WarningError) в дополнение к [Verbose Stream](#Verbose) и [записи о ходе выполнения](#Progress) Если модуль runbook настроен для записи подробных сообщений и записи о ходе выполнения.

### <a name="windows-powershell"></a>Windows PowerShell
В Windows PowerShell выходные данные и сообщения из Runbook можно извлечь с помощью командлета [Get AzureAutomationJobOutput](https://msdn.microsoft.com/library/mt603476.aspx) . Для этого командлета требуется идентификатор задания, также у него есть параметр Stream, в котором указывается возвращаемый поток. Можно указать значение Any для возврата всех потоков для задания.

В следующем примере запускается пример Runbook и ожидается его завершение. После завершения его поток вывода собирается из задания.

    $job = Start-AzureRmAutomationRunbook -ResourceGroupName "ResourceGroup01" `
    –AutomationAccountName "MyAutomationAccount" –Name "Test-Runbook"

    $doLoop = $true
    While ($doLoop) {
       $job = Get-AzureRmAutomationJob -ResourceGroupName "ResourceGroup01" `
       –AutomationAccountName "MyAutomationAccount" -Id $job.JobId
       $status = $job.Status
       $doLoop = (($status -ne "Completed") -and ($status -ne "Failed") -and ($status -ne "Suspended") -and ($status -ne "Stopped"))
    }

    Get-AzureRmAutomationJobOutput -ResourceGroupName "ResourceGroup01" `
    –AutomationAccountName "MyAutomationAccount" -Id $job.JobId –Stream Output
    
    # For more detailed job output, pipe the output of Get-AzureRmAutomationJobOutput to Get-AzureRmAutomationJobOutputRecord
    Get-AzureRmAutomationJobOutput -ResourceGroupName "ResourceGroup01" `
    –AutomationAccountName "MyAutomationAccount" -Id $job.JobId –Stream Any | Get-AzureRmAutomationJobOutputRecord
    

### <a name="graphical-authoring"></a>Графическая разработка
Для графических модулей Runbook дополнительное ведение журнала доступно в виде трассировки на уровне действий.  Существует два уровня трассировки: базовая и подробная.  Базовая трассировка включает время начала и окончания каждого действия в модуле Runbook, а также сведения обо всех повторных действиях, включая число попыток и время начала.  Подробная трассировка включает те же данные, что и базовая, плюс входные и выходные данные каждого действия.  В настоящее время записи трассировки ведутся с использованием подробного потока, поэтому при включении трассировки необходимо также включать подробное ведение журнала.  Для графических модулей Runbook с включенной трассировкой ведение записей о ходе выполнения не требуется, поскольку базовая трассировка не только решает эту задачу, но и является более информативной.

![Представление потоков заданий графической разработки](media/automation-runbook-output-and-messages/job-streams-view-blade.png)

На приведенном выше снимке экрана видно, что при включении подробного журнала и трассировки для графических модулей Runbook представление потоков заданий в рабочей среде содержит гораздо больше данных.  Эти дополнительные сведения могут пригодиться во время поиска и устранения неисправностей, связанных с модулем Runbook. Включайте их только для этой цели, в обычном режиме подобная детализация не требуется. Записи трассировки могут быть очень многочисленными.  С трассировкой графический runbook, можно получить на действия в зависимости от настройки трассировки обычный или подробный двух до четырех записей.  Если эти данные не требуются для контроля за выполнением модуля Runbook в целях устранения неисправностей, трассировку можно отключить.

**Чтобы включить трассировку на уровне действий, выполните указанные ниже действия.**

1. На портале Azure выберите свою учетную запись в службе автоматизации.
2. Щелкните плитку **Модули Runbook** , чтобы открыть список модулей Runbook.
3. В колонке "Модули Runbook" выберите графический модуль Runbook.
4. В колонке "Параметры" для выбранного модуля Runbook щелкните **Ведение журнала и трассировка**.
5. Ведение журнала и трассировки колонке под подробные записи в журнале, щелкните **на** включите подробное ведение журнала и в разделе трассировка на уровне активности, установите уровень трассировки **основные** или **Detailed** в зависимости от уровня трассировки требуется.<br>
   
   ![Колонка ведения журналов и трассировки графической разработки](media/automation-runbook-output-and-messages/logging-and-tracing-settings-blade.png)

### <a name="microsoft-operations-management-suite-oms-log-analytics"></a>Log Analytics в Microsoft Operations Management Suite (OMS)
Служба автоматизации может отправлять состояние задания Runbook и потоки заданий в рабочую область Log Analytics в Microsoft Operations Management Suite (OMS).  С помощью Log Analytics можно:

* получить информацию о заданиях службы автоматизации; 
* активировать отправку электронного сообщения или оповещения в соответствии с состоянием задания Runbook (например, сбой или приостановка); 
* создавать сложные запросы для потоков заданий; 
* коррелировать задания и учетные записи службы автоматизации; 
* визуализировать журнал задания по прошествии времени.    

Дополнительные сведения о настройке интеграции с Log Analytics для сбора, сопоставления и действия по данным заданий см. в статье [Пересылка состояния задания и потоков заданий из службы автоматизации в Log Analytics (OMS)](automation-manage-send-joblogs-log-analytics.md).

## <a name="next-steps"></a>Дальнейшие действия
* Чтобы узнать больше о выполнении модулей Runbook, отслеживании заданий Runbook и других технических деталях, ознакомьтесь с [отслеживанием задания Runbook](automation-runbook-execution.md)
* Дополнительные сведения о создании и использовании дочерних модулей Runbook см. в статье [Дочерние модули Runbook в службе автоматизации Azure](automation-child-runbooks.md).


---
title: "Устранение неполадок при изменениях на виртуальной машине Azure | Документация Майкрософт"
description: "Использование Отслеживания изменений для устранения неполадок при изменениях на виртуальной машине Azure."
services: automation
keywords: change, tracking, automation
author: jennyhunter-msft
ms.author: jehunte
ms.date: 12/14/2017
ms.topic: tutorial
ms.custom: mvc
manager: carmonm
ms.openlocfilehash: 0aefa175d676bd7e98841d3a1e9ff5a8c90b7deb
ms.sourcegitcommit: 9292e15fc80cc9df3e62731bafdcb0bb98c256e1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/10/2018
---
# <a name="troubleshoot-changes-in-your-environment"></a>Устранение неполадок при изменениях в среде

Из этого руководства вы узнаете, как устранять неполадки, возникающие при изменениях на виртуальной машине Azure. Включив функцию отслеживания изменений, вы сможете контролировать изменения в программном обеспечении, файлах, управляющих программах, службах и разделах реестра Windows на компьютере.
Контроль таких изменений поможет вам точно определять причину проблем с работоспособностью в сетевой среде.

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * подключить виртуальную машину к решениям для отслеживания изменений и инвентаризации;
> * Поиск остановленных служб в журналах изменений
> * Настройка функции отслеживания изменений
> * Настройка подключения к журналу действий
> * Активация события
> * Просмотр изменений

## <a name="prerequisites"></a>Необходимые компоненты

Для работы с этим учебником необходимы указанные ниже компоненты.

* Подписка Azure. Если у вас ее нет, [активируйте преимущества для подписчиков MSDN](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/) или [зарегистрируйте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* [Учетная запись службы автоматизации](automation-offering-get-started.md) для хранения runbook наблюдателя, runbook действия и задачи наблюдателя.
* [Виртуальная машина](../virtual-machines/windows/quick-create-portal.md) для подключения.

## <a name="log-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу http://portal.azure.com.

## <a name="enable-change-tracking-and-inventory"></a>Включение службы отслеживания изменений и инвентаризации

Чтобы выполнить задачи в этом руководстве, вам прежде всего нужно настроить для виртуальной машины службу отслеживания изменений и инвентаризации. Если вы ранее настроили для этой виртуальной машины другую систему автоматизации, этот шаг можно пропустить.

1. В меню слева выберите **Виртуальные машины**, затем выберите виртуальную машину из списка.
1. В меню слева в разделе **Операции** выберите **Инвентаризация**. Откроется страница **Включение отслеживания изменений и инвентаризации**.

Выполняется проверка, включено ли отслеживание изменений и инвентаризация для этой виртуальной машины.
При этом проверяется рабочее пространство Log Analytics и связанная учетная запись службы автоматизации, а также наличие решения в рабочей области.

Рабочая область [Log Analytics](../log-analytics/log-analytics-overview.md?toc=%2fazure%2fautomation%2ftoc.json) используется для сбора данных, созданных такими компонентами и службами, как "Инвентаризация".
Рабочая область предоставляет единое расположение для проверки и анализа данных из нескольких источников.

В процессе проверки также проверяется подготовка виртуальной машины с помощью Microsoft Monitoring Agent (MMA) и гибридной рабочей роли.
Этот агент позволяет взаимодействовать с виртуальной машиной и получать сведения об установленном программном обеспечении.
В процессе проверки также определяется, была ли виртуальная машина подготовлена с помощью Microsoft Monitoring Agent (MMA) и гибридной рабочей роли службы автоматизации.

Если предварительные условия не выполнены, появится баннер, с помощью которого можно будет включить решение.

![Баннер настройки развертывания для службы отслеживания изменений и инвентаризации](./media/automation-tutorial-troubleshoot-changes/enableinventory.png)

Щелкните этот баннер, чтобы включить решение.
Если проверка выявит, что отсутствует один из следующих компонентов, он будет автоматически добавлен:

* [Рабочая область Log Analytics](../log-analytics/log-analytics-overview.md?toc=%2fazure%2fautomation%2ftoc.json).
* [Автоматизация](./automation-offering-get-started.md)
* [Гибридная рабочая роль runbook](./automation-hybrid-runbook-worker.md) включена на виртуальной машине.

Теперь откроется экран **Отслеживание изменений и инвентаризация**. Настройте расположение, рабочую область Log Analytics и учетную запись службы автоматизации, затем нажмите кнопку **Включить**. Если эти поля неактивны и выделены серым цветом, то для этой виртуальной машины настроено другое решение автоматизации, а значит необходимо использовать ту же рабочую область и ту же учетную запись службы автоматизации.

![Окно включения службы отслеживания изменений](./media/automation-tutorial-troubleshoot-changes/installed-software-enable.png)

Включение решения может занять до 15 минут. В это время не закрывайте окно браузера.
Когда решение будет включено, сведения об установленном программном обеспечении и изменениях на виртуальной машине начнут передаваться в Log Analytics.
На получение данных для анализа может уйти от 30 минут до 6 часов.


## <a name="using-change-tracking-in-log-analytics"></a>Использование службы отслеживания изменений в Log Analytics

Функция отслеживания изменений создает данные журнала, отправляемые в Log Analytics. Чтобы найти журналы с помощью запросов, выберите **Log Analytics** в верхней части окна **Отслеживание изменений**.
Данные об отслеживании изменений хранятся в типе **ConfigurationChange**. Следующий пример запроса к службе Log Analytics возвращает все остановленные службы Windows.

```
ConfigurationChange
| where ConfigChangeType == "WindowsServices" and SvcState == "Stopped"
```

Дополнительные сведения о поиске по файлам журналов в Log Analytics см. в статье [Что такое Log Analytics?](https://docs.loganalytics.io/index)

## <a name="configure-change-tracking"></a>Настройка отслеживания изменений

Отслеживание изменений позволяет контролировать изменения конфигурации на виртуальной машине. Следующие действия позволяют настроить отслеживание для файлов и разделов реестра.
 
Чтобы выбрать, какие файлы и разделы реестра нужно собирать и отслеживать, выберите действие **Изменение параметров** в верхней части страницы **Отслеживание изменений**.

> [!NOTE]
> Инвентаризация и Отслеживание изменений используют одни и те же параметры сбора настроек, которые настраиваются на уровне рабочей области.

В окне **Конфигурация рабочей области** добавьте разделы реестра Windows, файлы Windows или файлы Linux, которые нужно отслеживать, как описано в следующих трех разделах.

### <a name="add-a-windows-registry-key"></a>Добавление раздела реестра Windows

1. На вкладке **Реестр Windows** выберите **Добавить**.
    Откроется окно **Добавление реестра Windows для отслеживания изменений**.

   ![Добавление реестра для отслеживания изменений](./media/automation-vm-change-tracking/change-add-registry.png)

2. Для параметра **Включено** установите значение **True**.
3. В поле **Имя элемента** введите понятное имя.
4. (Необязательно.) В поле **Группа** введите имя группы.
5. В поле **Раздел реестра Windows** добавьте имя раздела реестра для отслеживания.
6. Щелкните **Сохранить**.

### <a name="add-a-windows-file"></a>Добавление файлов Windows

1. На вкладке **Файлы Windows** выберите **Добавить**. Откроется окно **Добавление файла Windows для отслеживания изменений**.

   ![Добавление файла Windows для отслеживания изменений](./media/automation-vm-change-tracking/change-add-win-file.png)

2. Для параметра **Включено** установите значение **True**.
3. В поле **Имя элемента** введите понятное имя.
4. (Необязательно.) В поле **Группа** введите имя группы.
5. В поле **Укажите путь** введите полный путь и имя файла для отслеживания.
6. Щелкните **Сохранить**.

### <a name="add-a-linux-file"></a>Добавление файла Linux

1. На вкладке **Файлы Linux** выберите **Добавить**. Откроется окно **Добавление файла Linux для отслеживания изменений**.

   ![Добавление файла Linux для отслеживания изменений](./media/automation-vm-change-tracking/change-add-linux-file.png)

2. Для параметра **Включено** установите значение **True**.
3. В поле **Имя элемента** введите понятное имя.
4. (Необязательно.) В поле **Группа** введите имя группы.
5. В поле **Укажите путь** введите полный путь и имя файла для отслеживания.
6. В поле **Тип пути** выберите **Файл** или **Каталог**.
7. В разделе **Рекурсия** выберите **Вкл.** для отслеживания изменений указанного пути и всех файлов и путей в нем. Чтобы отслеживать только выбранный файл или путь, выберите **Выкл**.
8. В разделе **Использовать sudo** выберите **Вкл.**, чтобы отслеживать файлы, для доступа к которым необходимо выполнить команду `sudo`. В противном случае выберите **Выкл.**
9. Щелкните **Сохранить**.

## <a name="enable-activity-log-connection"></a>Настройка подключения к журналу действий

На странице **Отслеживание изменений** на виртуальной машине выберите **Управление подключением журнала действий**. Эта операция открывает страницу **Журнал действий Azure**. Выберите **Подключить**, чтобы подключить журнал действий Azure для виртуальной машины к службе отслеживания изменений.

Включив этот параметр, перейдите к странице **Обзор** для виртуальной машины и выберите действие **Остановить**, чтобы остановить виртуальную машину. Подтвердите остановку, выбрав **Да** при появлении соответствующего запроса. Когда освобождение виртуальной машины завершится, выберите **Запустить**, чтобы снова запустить ее.

Остановка и запуск виртуальной машины регистрируются как события в журнале действий. Вернитесь к странице **Отслеживание изменений**. Выберите вкладку **События** в нижней части страницы. Через некоторое время события отобразятся на диаграмме и в таблице. Как и на предыдущем шаге, вы можете выбрать любое из этих событий, чтобы просмотреть подробные сведения о нем.

![Просмотр сведений об изменениях на портале](./media/automation-tutorial-troubleshoot-changes/viewevents.png)

## <a name="view-changes"></a>Просмотр изменений

После того, как вы включите службу отслеживания изменений и инвентаризации, вы сможете увидеть собранные результаты на странице **Отслеживание изменений**.

На виртуальной машине выберите элемент **Отслеживание изменений** в разделе **Операции**.

![Снимок экрана, на котором показан список изменений виртуальной машины](./media/automation-tutorial-troubleshoot-changes/change-tracking-list.png)

Здесь отображаются изменения, произошедшие за определенное время.
Когда вы добавите соединение с журналом действий, график в верхней части отобразит события из журнала действий Azure.
Каждая строка гистограммы соответствует определенному типу отслеживаемых изменений.
К этим типам относятся управляющие программы Linux, файлы, разделы реестра Windows, программное обеспечение и службы Windows.
Вкладка "Изменения" отображает сведения об изменениях, отсортированные по времени в обратном порядке (первыми показаны самые последние).
На вкладке **События** представлена таблица с событиями подключенных журналов событий и сведениями о них, начиная с самых последних.

В этом примере результатов вы можете заметить, что в систему внесено несколько изменений, в том числе относящихся к службам и программному обеспечению. Фильтры в верхней части страницы позволяют выбрать результаты по **типу изменений** или диапазону времени.

Выберите строку изменения **WindowsServices**, чтобы открыть окно **Сведения об изменении**. В окне сведений об изменении представлена информация о конкретном изменении, а также соответствующие значения до и после изменения. Этот пример сообщает об остановке службы защиты программного обеспечения.

![Просмотр сведений об изменениях на портале](./media/automation-tutorial-troubleshoot-changes/change-details.png)

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * подключить виртуальную машину к решениям для отслеживания изменений и инвентаризации;
> * Поиск остановленных служб в журналах изменений
> * Настройка функции отслеживания изменений
> * Настройка подключения к журналу действий
> * Активация события
> * Просмотр изменений

См. дополнительные сведения о решении для отслеживания изменений и инвентаризации, чтобы получить дополнительные сведения.

> [!div class="nextstepaction"]
> [Change management and Inventory solution](../log-analytics/log-analytics-change-tracking.md?toc=%2fazure%2fautomation%2ftoc.json) (Решение для управления изменениями и инвентаризации)

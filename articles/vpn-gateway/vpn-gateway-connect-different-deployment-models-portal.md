---
title: "Подключение классических виртуальных сетей к виртуальным сетям Resource Manager с помощью портала | Документация Майкрософт"
description: "Узнайте, как создать VPN-подключение между классическими виртуальными сетями и виртуальными сетями Resource Manager с помощью VPN-шлюза и портала"
services: vpn-gateway
documentationcenter: na
author: cherylmc
manager: timlt
editor: 
tags: azure-service-management,azure-resource-manager
ms.assetid: 5a90498c-4520-4bd3-a833-ad85924ecaf9
ms.service: vpn-gateway
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 04/21/2017
ms.author: cherylmc
ms.openlocfilehash: ad5700f1a85567a3e7f4ef80b778183929cb0d68
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="connect-virtual-networks-from-different-deployment-models-using-the-portal"></a>Подключение виртуальных сетей из разных моделей развертывания с помощью портала

Эта статья описывает, как подключить классические виртуальные сети к виртуальным сетям Resource Manager, чтобы ресурсы, находящиеся в разных моделях развертывания, могли взаимодействовать между собой. В описанных здесь действиях в основном используется портал Azure, однако эту конфигурацию можно создать и с помощью PowerShell, выбрав соответствующую статью в списке.

> [!div class="op_single_selector"]
> * [Портал](vpn-gateway-connect-different-deployment-models-portal.md)
> * [PowerShell](vpn-gateway-connect-different-deployment-models-powershell.md)
> 
> 

Подключение к классической виртуальной сети к виртуальной сети Resource Manager похоже на подключение виртуальной сети к локальному сайту. В обоих типах подключений используется VPN-шлюз для создания защищенного туннеля, использующего IPsec/IKE. Подключение можно создать между виртуальными сетями, которые находятся в разных подписках и разных регионах. Вы также можете создать подключение между виртуальными сетями, которые уже подключены к локальным сетям. В этом случае для них должен быть настроен динамический шлюз или шлюз на основе маршрутов. Дополнительные сведения о подключениях типа "виртуальная сеть — виртуальная сеть" см. в разделе [Часто задаваемые вопросы о подключениях типа "виртуальная сеть — виртуальная сеть"](#faq) в конце этой статьи. 

Если виртуальные сети находятся в одном регионе, их можно соединить между собой с помощью пиринга. При пиринговой связи между виртуальными сетями VPN-шлюз не используется. Дополнительную информацию см. в статье [Пиринговая связь между виртуальными сетями](../virtual-network/virtual-network-peering-overview.md). 

### <a name="before"></a>Перед началом работы

* Предполагается, что обе виртуальные сети уже созданы. Если вы используете эту статью в качестве упражнения и у вас нет виртуальных сетей, в шагах есть ссылки, которые помогут вам их создать.
* Убедитесь, что диапазоны адресов для виртуальных сетей не перекрываются между собой или с другими диапазонами подключений, к которым могут быть подключены шлюзы.
* Установите последнюю версию командлетов PowerShell для Resource Manager и управления службами (классическая модель). В этой статье мы используем как портал Azure, так и PowerShell. Для создания подключения от классической виртуальной сети к виртуальной сети Resource Manager требуется PowerShell. Дополнительные сведения см. в статье [Установка и настройка Azure PowerShell](/powershell/azure/overview). 

### <a name="values"></a>Примеры настроек

Эти значения можно использовать для создания тестовой среды или для лучшего понимания примеров в этой статье.

**Классическая виртуальная сеть**

Имя виртуальной сети = ClassicVNet <br>
Адресное пространство: 10.0.0.0/24. <br>
Подсеть-1 = 10.0.0.0/27 <br>
Группа ресурсов: RG1. <br>
Расположение: Западная часть США <br>
Подсеть шлюза: 10.0.0.32/28. <br>
Локальный сайт: RMVNetLocal. <br>

**Виртуальная сеть Resource Manager**

Имя виртуальной сети = RMVNet <br>
Адресное пространство: 192.168.0.0/16. <br>
Подсеть-1 = 192.168.1.0/24 <br>
Шлюз подсети = 192.168.0.0/26 <br>
Группа ресурсов = RG1 <br>
Расположение = восточная часть США <br>
Имя шлюза виртуальной сети = RMGateway <br>
Тип шлюза: VPN <br>
Тип VPN: на основе маршрутов <br>
Имя общего IP-адреса шлюза = rmgwpip <br>
Шлюз локальной сети = ClassicVNetLocal <br>
Имя подключения = RMtoClassic

### <a name="connection-overview"></a>Общие сведения о подключении

Для этой конфигурации вы создадите подключение к VPN-шлюзу через VPN-туннель IPsec/IKE между виртуальными сетями. При настройке необходимо убедиться в том, что никакие из диапазонов виртуальных сетей или диапазонов локальных сетей, к которым они подключены, никак не перекрываются между собой.

В таблице ниже показан пример, как определяются виртуальные сети и локальные веб-сайты.

| Виртуальная сеть | Пространство адресов | Регион | Подключается к сайту локальной сети |
|:--- |:--- |:--- |:--- |
| ClassicVNet |(10.0.0.0/24) |Запад США | RMVNetLocal (192.168.0.0/16) |
| RMVNet | (192.168.0.0/16) |Восток США |ClassicVNetLocal (10.0.0.0/24) |

## <a name="classicvnet"></a>Раздел 1. Настройка классической виртуальной сети

В этом разделе вы создадите локальную сеть (локальный сайт) и шлюз виртуальной сети для классической виртуальной сети. Если у вас нет классической виртуальной сети и вы выполняете действия из этой статьи в качестве упражнения, вы можете создать виртуальную сеть с помощью [этой статьи](../virtual-network/virtual-networks-create-vnet-classic-pportal.md), используя [примеры](#values) значений параметров выше.

Если вы создаете классическую виртуальную сеть с помощью портала, открывайте колонку виртуальной сети с помощью приведенных ниже инструкций. В противном случае команда создания классической виртуальной сети не отобразится.

1. Нажмите кнопку "+", чтобы открыть колонку "Создать".
2. В поле "Поиск по Marketplace" введите запрос "Виртуальная сеть". Если вместо этого вы выберете "Сети" -> "Виртуальная сеть", команда создания классической виртуальной сети не отобразится.
3. Найдите в результатах поиска запись "Виртуальная сеть" и щелкните ее. Откроется колонка "Виртуальная сеть". 
4. В колонке виртуальной сети выберите "Классическая", чтобы создать классическую виртуальную сеть. 

Если у вас уже есть виртуальная сеть с VPN-шлюзом, убедитесь, что шлюз динамический. Если шлюз статический, необходимо сначала удалить этот VPN-шлюз, а затем продолжить.

Снимки экрана приведены в качестве примеров. Обязательно подставьте собственные значения или воспользуйтесь значениями из [примера](#values).

### 1. <a name="local"></a>Настройка локального сайта

Откройте [портал Azure](https://ms.portal.azure.com) и войдите в систему, используя свою учетную запись Azure.

1. Перейдите к колонке **Все ресурсы** и найдите **ClassicVNet** в списке.
2. В колонке **Обзор** вразделе **VPN-подключения** щелкните значок **шлюза**, чтобы создать шлюз.

    ![Настройка VPN-шлюза](./media/vpn-gateway-connect-different-deployment-models-portal/gatewaygraphic.png "Настройка VPN-шлюза")
3. В колонке **Новое VPN-подключение** для параметра **Тип подключения** выберите значение **Сеть-сеть**.
4. Для параметра **Локальный сайт** щелкните **Настроить обязательные параметры**. Откроется колонка **Локальный сайт**.
5. В колонке **Локальный сайт** введите имя, которое будет использоваться для виртуальной сети Resource Manager. Например, RMVNetLocal.
6. Если у VPN-шлюза для виртуальной сети Resource Manager уже есть общедоступный IP-адрес, укажите его в поле **IP-адрес VPN-шлюза**. Если вы выполняете эти шаги в качестве упражнения или у вас еще нет шлюза для виртуальной сети Resource Manager, можно использовать заполнитель IP-адреса. Убедитесь, что для заполнителя IP-адреса используется допустимый формат. Позднее необходимо будет заменить его общедоступным IP-адресом шлюза виртуальной сети Resource Manager.
7. В поле **Client Address Space** (адресное пространство клиента) укажите значения адресных пространств IP-адресов виртуальной сети Resource Manager. Этот параметр используется, чтобы определить адресные пространства для маршрутизации в виртуальную сеть Resource Manager.
8. Нажмите кнопку **ОК**, чтобы сохранить значения и вернуться к колонке **Новое VPN-подключение**.

### <a name="classicgw"></a>2. Создание шлюза виртуальной сети

1. В колонке **Новое VPN-подключение** установите флажок **Немедленно создать шлюз** и щелкните **Дополнительная настройка шлюза**, чтобы открыть колонку **Настройка шлюза**. 

    ![Открытие колонки настройки шлюза](./media/vpn-gateway-connect-different-deployment-models-portal/optionalgatewayconfiguration.png "Открытие колонки настройки шлюза")
2. Щелкните **Подсеть - настроить обязательные параметры**, чтобы открыть колонку **Добавление подсети**. Вы увидите, что в поле **Имя** уже задано обязательное значение **GatewaySubnet**.
3. **Диапазон адресов** определяет диапазон подсети шлюза. Несмотря на то что можно создать подсеть шлюза с диапазоном адресов /29 (3 адреса), мы советуем создать подсеть шлюза с большим числом доступных IP-адресов. Это поможет учесть будущие конфигурации, которые могут потребовать больше доступных IP-адресов. Если это возможно, используйте диапазон /27 или /28. Если вы выполняете эти шаги в качестве упражнения, вы можете использовать [примеры](#values) значений. Нажмите кнопку **ОК**, чтобы создать подсеть шлюза.
4. В колонке **Настройка шлюза** отображается значение **Размер**, которое относится к номеру SKU шлюза. Выберите номер SKU для своего VPN-шлюза.
5. Убедитесь, что параметр **Тип маршрутизации** имеет значение **Динамическая**, и нажмите кнопку **ОК** для возврата к колонке **VPN-подключения**.
6. В колонке **VPN-подключения** нажмите кнопку **ОК**, чтобы создать VPN-шлюз. Создание VPN-шлюза может занять до 45 минут.

### <a name="ip"></a>3. Копирование общедоступного IP-адреса шлюза виртуальной сети

После создания шлюза виртуальной сети можно просмотреть его IP-адрес. 

1. Перейдите к классической виртуальной сети и щелкните **Обзор**.
2. Щелкните **VPN-подключения**, чтобы открыть колонку "VPN-подключения". В колонке "VPN-подключения" можно увидеть общедоступный IP-адрес. Это общедоступный IP-адрес, назначенный вашему шлюзу виртуальной сети. 
3. Запишите или скопируйте его. Он понадобится позже, при работе с параметрами конфигурации локального сетевого шлюза Resource Manager. Можно также просмотреть состояние подключений шлюза. Обратите внимание, что созданный вами сайт локальной сети отображен в состоянии "Подключение". Это состояние изменится после создания подключений.
4. Скопировав IP-адрес шлюза, закройте колонку.

## <a name="rmvnet"></a>Раздел 2. Настройка параметров виртуальной сети Resource Manager

В этом разделе вы создадите шлюз виртуальной сети и шлюз локальной сети для виртуальной сети Resource Manager. Если у вас нет виртуальной сети Resource Manager и вы выполняете действия из этой статьи в качестве упражнения, вы можете создать виртуальную сеть с помощью [этой статьи](../virtual-network/virtual-networks-create-vnet-arm-pportal.md), используя [примеры](#values) значений параметров выше.

Снимки экрана приведены в качестве примеров. Обязательно подставьте собственные значения или воспользуйтесь значениями из [примера](#values).

### <a name="1-create-a-gateway-subnet"></a>1. Создание подсети шлюза

Чтобы создать шлюз виртуальной сети, сначала нужно создать подсеть шлюза. Создайте подсеть шлюза с диапазоном адресов /28 или больше. (/ 27, /26, и т. д.)

[!INCLUDE [vpn-gateway-no-nsg-include](../../includes/vpn-gateway-no-nsg-include.md)]

[!INCLUDE [vpn-gateway-add-gwsubnet-rm-portal](../../includes/vpn-gateway-add-gwsubnet-rm-portal-include.md)]

### <a name="creategw"></a>2. Создание шлюза виртуальной сети

[!INCLUDE [vpn-gateway-add-gw-rm-portal](../../includes/vpn-gateway-add-gw-rm-portal-include.md)]

### <a name="createlng"></a>3. Создание локального сетевого шлюза

Шлюз локальной сети задает диапазон адресов и общедоступный IP-адрес, связанный с классической виртуальной сетью и ее шлюзом.

При выполнении этих действий в качестве упражнения см. следующие параметры:

| Виртуальная сеть | Пространство адресов | Регион | Подключается к сайту локальной сети |Общедоступный IP-адрес|
|:--- |:--- |:--- |:--- |:--- |
| ClassicVNet |(10.0.0.0/24) |Запад США | RMVNetLocal (192.168.0.0/16) |Общедоступный IP-адрес, назначенный шлюзу ClassicVNet|
| RMVNet | (192.168.0.0/16) |Восток США |ClassicVNetLocal (10.0.0.0/24) |Общедоступный IP-адрес, назначенный шлюзу RMVNet|

[!INCLUDE [vpn-gateway-add-lng-rm-portal](../../includes/vpn-gateway-add-lng-rm-portal-include.md)]

## <a name="modifylng"></a>Раздел 3. Изменение параметров локального сайта виртуальной сети

В этом разделе вы замените заполнитель IP-адреса, указанный при настройке параметров локального сайта, на IP-адрес VPN-шлюза Resource Manager. В этом разделе используются классические командлеты PowerShell (управление службами).

1. На портале Azure перейдите к классической виртуальной сети.
2. В колонке своей виртуальной сети щелкните **Обзор**.
3. В разделе **VPN-подключения** щелкните имя своего локального сайта на схеме.

    ![VPN-подключения](./media/vpn-gateway-connect-different-deployment-models-portal/vpnconnections.png "VPN-подключения")
4. В колонке **VPN-подключения типа «сеть-сеть»** щелкните имя сайта.

    ![Имя сайта](./media/vpn-gateway-connect-different-deployment-models-portal/sitetosite3.png "Имя локального сайта")
5. В колонке подключения для локального сайта щелкните его имя, чтобы открыть колонку **Локальный сайт**.

    ![Открытие локального сайта](./media/vpn-gateway-connect-different-deployment-models-portal/openlocal.png "Открытие локального сайта")
6. В колонке **Локальный сайт** замените **IP-адрес VPN-шлюза** IP-адресом шлюза Resource Manager.

    ![IP-адрес шлюза](./media/vpn-gateway-connect-different-deployment-models-portal/gwipaddress.png "IP-адрес шлюза")
7. Нажмите кнопку **ОК**, чтобы обновить IP-адрес.

## <a name="RMtoclassic"></a>Раздел 4. Создание подключения между виртуальной сетью Resource Managиr к классической виртуальной сетью

На этих шагах вы с помощью портала Azure настроите подключение от виртуальной сети Resource Manager к классической виртуальной сети.

1. В колонке **Все ресурсы** найдите шлюз локальной сети. В нашем примере это **ClassicVNetLocal**.
2. Щелкните **Конфигурация** и убедитесь, что значение IP-адреса соответствует VPN-шлюзу для классической виртуальной сети. Обновите его при необходимости, а затем щелкните **Сохранить**. Закройте колонку.
3. В колонке **Все ресурсы** щелкните шлюз локальной сети.
4. Щелкните **Подключения**, чтобы открыть колонку "Подключения".
5. В колонке **Подключения** щелкните **+**, чтобы добавить подключение.
6. В колонке **Добавление подключения** укажите имя для своего подключения. Например, RMtoClassic.
7. В этой колонке уже выбрано подключение **Сеть-сеть**.
8. Выберите шлюз виртуальной сети, который необходимо связать с этим сайтом.
9. Создайте **общий ключ**. Этот ключ также используется в подключении, которое вы создали от классической виртуальной сети к виртуальной сети Resource Manager. Вы можете создать ключ или ввести свой. В нашем примере мы использовали abc123, но вы можете (это рекомендуется) создать и использовать что-нибудь посложнее.
10. Нажмите кнопку **ОК**, чтобы создать подключение.

##<a name="classictoRM"></a>Раздел 5. Создание подключения между классической виртуальной сетью и виртуальной сетью Resource Manager

На этих шагах вы настроите подключение от классической виртуальной сети к виртуальной сети Resource Manager. Для этого понадобится PowerShell. Это подключение невозможно создать на портале. Убедитесь, что командлеты PowerShell Resource Manager и классические командлеты PowerShell установлены.

### <a name="1-connect-to-your-azure-account"></a>1. Подключение к учетной записи Azure

Запустите консоль PowerShell с повышенными правами и войдите в свою учетную запись Azure. Следующий командлет запрашивает учетные данные входа для вашей учетной записи Azure. После выполнения входа он скачивает параметры учетной записи, чтобы они были доступны в Azure PowerShell.

```powershell
Login-AzureRmAccount
```
   
Если у вас есть несколько подписок, запросите их список.

```powershell
Get-AzureRmSubscription
```

Укажите подписку, которую нужно использовать. 

```powershell
Select-AzureRmSubscription -SubscriptionName "Name of subscription"
```

Добавьте свою учетную запись Azure, чтобы использовать классические командлеты PowerShell. Используйте для этого следующую команду:

```powershell
Add-AzureAccount
```

### <a name="2-view-the-network-configuration-file-values"></a>2) Просмотр значений в файле конфигурации сети

При создании виртуальной сети на портале Azure полное имя, которое используется Azure, не отображается на портале. Например, если виртуальная сеть отображается на портале Azure с именем ClassicVNet, то в файле конфигурации сети она может иметь гораздо более длинное имя. Это имя может выглядеть примерно как Group ClassicRG ClassicVNet. На этих шагах вы скачаете файл конфигурации сети и просмотрите значения в нем.

Создайте каталог на компьютере, а затем экспортируйте в него файл конфигурации сети. В этом примере файл конфигурации сети экспортируется в каталог C:\AzureNet.

```powershell
Get-AzureVNetConfig -ExportToFile C:\AzureNet\NetworkConfig.xml
```

Откройте файл в текстовом редакторе и просмотрите имя для классической виртуальной сети. При выполнении командлетов PowerShell используйте имена из файла конфигурации сети.

- Имена виртуальных сетей перечислены как **VirtualNetworkSite name =**.
- Имена веб-сайтов перечислены как **VirtualNetworkSite name =**.

### <a name="3-create-the-connection"></a>3. Создание подключения

Установите общий ключ и создайте подключение от классической виртуальной сети к виртуальной сети Resource Manager. Общий ключ невозможно задать с помощью портала. Эти шаги следует выполнять при входе с помощью классической версии командлетов PowerShell. Чтобы сделать это, используйте командлет **Add-AzureAccount**. В противном случае вы не сможете задать "-AzureVNetGatewayKey".

- В этом примере **-VNetName** — это имя классической виртуальной сети, указанное в файле конфигурации сети. 
- **- LocalNetworkSiteName** — это имя для локального сайта, указанное в файле конфигурации сети.
- **-SharedKey** — это значение, которое следует создать и задать. В этом примере мы использовали *abc123*, но можно создать что-нибудь посложнее. Важно, чтобы заданное здесь значение совпадало со значением, которое вы указали при создании подключения от виртуальной сети Resource Manager к классической виртуальной сети.

```powershell
Set-AzureVNetGatewayKey -VNetName "Group ClassicRG ClassicVNet" `
-LocalNetworkSiteName "172B9E16_RMVNetLocal" -SharedKey abc123
```

##<a name="verify"></a>Раздел 6. Проверка подключений

Подключения можно проверить на портале Azure или с помощью PowerShell. При проверке может потребоваться подождать пару минут, пока подключение не будет создано. В случае успешного подключения его состояние изменится с "Подключение" на "Подключено".

### <a name="to-verify-the-connection-from-your-classic-vnet-to-your-resource-manager-vnet"></a>Проверка подключения классической виртуальной сети к виртуальной сети Resource Manager

[!INCLUDE [vpn-gateway-verify-connection-azureportal-classic](../../includes/vpn-gateway-verify-connection-azureportal-classic-include.md)]

###<a name="to-verify-the-connection-from-your-resource-manager-vnet-to-your-classic-vnet"></a>Проверка подключения виртуальной сети Resource Manager к классической виртуальной сети

[!INCLUDE [vpn-gateway-verify-connection-portal-rm](../../includes/vpn-gateway-verify-connection-portal-rm-include.md)]

## <a name="faq"></a>Часто задаваемые вопросы о подключениях типа "виртуальная сеть — виртуальная сеть"

[!INCLUDE [vpn-gateway-vnet-vnet-faq](../../includes/vpn-gateway-faq-vnet-vnet-include.md)]

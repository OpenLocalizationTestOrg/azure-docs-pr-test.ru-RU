---
title: "Использование службы \"Сетка событий Azure\" для автоматического изменения размера переданных изображений | Документация Майкрософт"
description: "Служба \"Сетка событий Azure\" может быть активирована при передаче больших двоичных объектов в службу хранилища Azure. Это можно использовать для отправки файлов изображений, которые передаются в службу хранилища Azure, в другие службы, например службу \"Функции Azure\", для изменения размера и других улучшений."
services: event-grid
author: ggailey777
manager: cfowler
editor: 
ms.service: event-grid
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: tutorial
ms.date: 10/20/2017
ms.author: glenga
ms.custom: mvc
ms.openlocfilehash: 22eafca56eb5677c63a833d298799b725c50f768
ms.sourcegitcommit: 7136d06474dd20bb8ef6a821c8d7e31edf3a2820
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/05/2017
---
# <a name="automate-resizing-uploaded-images-using-event-grid"></a>Автоматическое изменение размера переданных изображений с помощью службы "Сетка событий"

[Сетка событий Azure](overview.md) — это служба обработки событий для облака. Служба "Сетка событий" дает возможность создавать подписки на события, порождаемые службами Azure или сторонними ресурсами.  

Это руководство — вторая часть из цикла руководств по службе хранилища. Оно дополняет [предыдущее руководство по службе хранилища][previous-tutorial] и содержит сведения о том, как добавить автоматическое бессерверное создание эскизов с помощью служб "Функции Azure" и "Сетка событий Azure". Служба "Сетка событий" позволяет службе [Функции Azure](..\azure-functions\functions-overview.md) реагировать на события [хранилища BLOB-объектов Azure](..\storage\blobs\storage-blobs-introduction.md) и создавать эскизы передаваемых изображений. Подписка на событие создается для события создания хранилища BLOB-объектов. При добавлении большого двоичного объекта в конкретный контейнер хранилища BLOB-объектов вызывается конечная точка функции. Данные, передаваемые посредством привязки функции из службы "Сетка событий", используются для доступа к большому двоичному объекту и создания эскизов. 

Для добавления возможностей изменения размера в существующее приложение для передачи изображений можно использовать Azure CLI и портал Azure.

![Опубликованное веб-приложение в браузере Edge](./media/resize-images-on-storage-blob-upload-event/tutorial-completed.png)

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * создание общей учетной записи хранения Azure;
> * развертывание бессерверного кода с помощью службы "Функции Azure";
> * создание подписки на событие хранилища BLOB-объектов в службе "Сетка событий".

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством:

+ Необходимо выполнить инструкции из предыдущего руководства по хранилищу BLOB-объектов: [Upload image data in the cloud with Azure Storage][previous-tutorial] (Передача данных изображений в облако с помощью службы хранилища Azure). 

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

Если вы решили установить и использовать интерфейс командной строки локально, то для работы с этим руководством вам понадобится Azure CLI 2.0.14 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0]( /cli/azure/install-azure-cli). 

Если вы не используете Cloud Shell, сначала выполните вход с помощью `az login`.

## <a name="create-an-azure-storage-account"></a>Создание учетной записи хранения Azure

Для службы "Функции Azure" требуется общая учетная запись хранения. Создайте отдельную общую учетную запись хранения в группе ресурсов с помощью команды [az storage account create](/cli/azure/storage/account#create).

Имя учетной записи хранения должно содержать от 3 до 24 символов и состоять только из цифр и строчных букв. 

В следующей команде замените `<general_storage_account>` глобально уникальным именем общей учетной записи хранения везде, где встречается этот заполнитель. 

```azurecli-interactive
az storage account create --name <general_storage_account> \
--location westcentralus --resource-group myResourceGroup \
--sku Standard_LRS --kind storage
```

## <a name="create-a-function-app"></a>Создание приложения-функции  

Для выполнения функций вам понадобится приложение-функция, предоставляющее среду для выполнения кода функции без сервера. Создайте приложение-функцию с помощью команды [az functionapp create](/cli/azure/functionapp#create). 

В следующей команде замените `<function_app>` уникальным именем своего приложения-функции везде, где встречается этот заполнитель. `<function_app>` используется по умолчанию в качестве домена DNS для приложения-функции. Поэтому это имя должно быть уникальным для всех приложений в Azure. В данном случае `<general_storage_account>` — это имя созданной общей учетной записи хранения.  

```azurecli-interactive
az functionapp create --name <function_app> --storage-account  <general_storage_account>  \
--resource-group myResourceGroup --consumption-plan-location westcentralus
```

Теперь необходимо настроить приложение-функцию для подключения к хранилищу BLOB-объектов. 

## <a name="configure-the-function-app"></a>Настройка приложения-функции

Для подключения к учетной записи хранения BLOB-объектов функции требуется строка подключения. В данном случае `<blob_storage_account>` — это имя учетной записи хранения BLOB-объектов, созданной при изучении предыдущего руководства. Получите строку подключения, выполнив команду [az storage account show-connection-string](/cli/azure/storage/account#show-connection-string). Кроме того, в качестве имени контейнера эскизов изображений нужно задать `thumbs`. Добавьте эти параметры приложения в приложение-функцию с помощью команды [az functionapp config appsettings set](/cli/azure/functionapp/config/appsettings#set).

```azurecli-interactive
storageConnectionString=$(az storage account show-connection-string \
--resource-group myResourceGroup --name <blob_storage_account> \
--query connectionString --output tsv)

az functionapp config appsettings set --name <function_app> \
--resource-group myResourceGroup \
--settings myblobstorage_STORAGE=$storageConnectionString \
myContainerName=thumbs
```

Теперь можно развернуть проект кода функции в этом приложении-функции.

## <a name="deploy-the-function-code"></a>Развертывание кода функции 

Функция C#, которая изменяет размер изображения, доступна в этом [примере репозитория GitHub](https://github.com/Azure-Samples/function-image-upload-resize). Разверните этот проект кода функции в приложение-функцию с помощью команды [az functionapp deployment source config](/cli/azure/functionapp/deployment/source#config). 

В следующей команде `<function_app>` — это приложение-функция, созданное в предыдущем сценарии.

```azurecli-interactive
az functionapp deployment source config --name <function_app> \
--resource-group myResourceGroup --branch master --manual-integration \
--repo-url https://github.com/Azure-Samples/function-image-upload-resize
```

Функция изменения размера изображения активируется подпиской на событие создания большого двоичного объекта. Данные, передаваемые в триггер, содержат URL-адрес большого двоичного объекта, который, в свою очередь, передается во входную привязку для получения переданного изображения из хранилища BLOB-объектов. Функция создает эскиз и записывает результирующий поток в отдельный контейнер в хранилище BLOB-объектов. Чтобы узнать больше об этой функции, ознакомьтесь с [файлом сведений в примере репозитория](https://github.com/Azure-Samples/function-image-upload-resize/blob/master/README.md).
 
Код проекта функция развертывается непосредственно из общедоступного примера репозитория. Чтобы узнать больше о параметрах развертывания службы "Функции Azure", ознакомьтесь с разделом [Непрерывное развертывание для Функций Azure](../azure-functions/functions-continuous-deployment.md).

## <a name="create-your-event-subscription"></a>Создание подписки на событие

Подписка на событие определяет, какие создаваемые поставщиком события необходимо отправлять в конкретную конечную точку. В данном случае конечная точка предоставляется функцией. Чтобы создать подписку на событие из функции, выполните следующие действия на портале Azure. 

1. На [портале Azure](https://portal.azure.com) щелкните стрелку в нижнем левом углу, чтобы развернуть все службы, введите `functions` в поле **Фильтр**, а затем щелкните **Приложения-функции**. 

    ![Переход к приложениям-функциям на портале Azure](./media/resize-images-on-storage-blob-upload-event/portal-find-functions.png)

2. Разверните приложение-функцию, выберите функцию **imageresizerfunc**, а затем выберите **Добавить подписку сетки событий**.

    ![Переход к приложениям-функциям на портале Azure](./media/resize-images-on-storage-blob-upload-event/add-event-subscription.png)

3. Задайте значения параметров подписки на событие, указанные в таблице.

    ![Создание подписки на событие из функции на портале Azure](./media/resize-images-on-storage-blob-upload-event/event-subscription-create-flow.png)

    | Настройка      | Рекомендуемое значение  | Описание                                        |
    | ------------ |  ------- | -------------------------------------------------- |
    | **Имя** | imageresizersub | Имя, которое идентифицирует новую подписку на событие. | 
    | **Тип раздела** |  учетные записи хранения; | Выберите поставщик событий учетной записи хранения. | 
    | **Подписка** | Ваша подписка | По умолчанию должна быть выбрана ваша текущая подписка.   |
    | **Группа ресурсов** | myResourceGroup | Щелкните **Использовать существующую** и выберите группу ресурсов, используемую в этом разделе.  |
    | **Экземпляр** |  `<blob_storage_account>` |  Выберите учетную запись хранения BLOB-объектов, созданную вами. |
    | **Типы событий** | Blob created | Снимите флажки всех типов, кроме **Blob created** (Большой двоичный объект создан). Только события типа `Microsoft.Storage.BlobCreated` будут передаваться в функцию.| 
    | **Конечная точка подписчика** | autogenerated | Используйте URL-адрес конечной точки, созданный автоматически. | 
    | **Фильтр префиксов** | /blobServices/default/containers/images/blobs/ | Это значение фильтрует события службы хранилища, выбирая только события контейнера **images**.| 

4. Нажмите кнопку **Создать**, чтобы добавить подписку на событие. Будет создана подписка на событие, которая вызывает функцию **imageresizerfunc** при добавлении большого двоичного объекта в контейнер **images**. Изображения измененного размера добавляются в контейнер **thumbs**.

Теперь, когда внутренние службы настроены, следует проверить функциональные возможности изменения размера изображений в примере веб-приложения. 

## <a name="test-the-sample-app"></a>Поверка примера приложения

Чтобы проверить изменение размера изображений в веб-приложении, перейдите на URL-адрес опубликованного приложения. URL-адрес приложения по умолчанию: `https://<web_app>.azurewebsites.net`.

Щелкните область **Upload photos** (Передача фотографий), чтобы выбрать и передать файл. Можно также перетащить фотографию в эту область. 

Обратите внимание, что после того, как переданное изображение исчезнет, его копия появится в карусели **Generated thumbnails** (Созданные эскизы). Функция изменила размер этого изображения, после чего оно было добавлено в контейнер thumbs и скачано веб-клиентом. 

![Опубликованное веб-приложение в браузере Edge](./media/resize-images-on-storage-blob-upload-event/tutorial-completed.png) 

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * создание общей учетной записи хранения Azure;
> * развертывание бессерверного кода с помощью службы "Функции Azure";
> * создание подписки на событие хранилища BLOB-объектов в службе "Сетка событий".

Перейдите к третьей части цикла руководств по службе хранилища, чтобы узнать, как защитить доступ к учетной записи хранения.

> [!div class="nextstepaction"]
> [Безопасный доступ к данным приложения в облаке](../storage/blobs/storage-secure-access-application.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json)


+ Чтобы узнать больше о службе "Сетка событий", ознакомьтесь с разделом [Общие сведения о службе "Сетка событий Azure"](overview.md). 
+ Чтобы ознакомиться с еще одним руководством по возможностям службы "Функции Azure", прочитайте в статью [Создание функции, интегрируемой с Azure Logic Apps](..\azure-functions\functions-twitter-email.md). 

[previous-tutorial]: ../storage/blobs/storage-upload-process-images.md
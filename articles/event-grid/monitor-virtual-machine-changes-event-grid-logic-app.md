---
title: "Отслеживание изменений виртуальной машины с помощью Azure Logic Apps и службы \"Сетка событий Azure\" | Документация Майкрософт"
description: "Проверка наличия изменений конфигурации в виртуальных машинах с помощью службы \"Сетка событий Azure\" и Logic Apps."
keywords: "приложения логики, сетки событий, виртуальная машина, VM"
services: logic-apps
author: ecfan
manager: anneta
ms.assetid: 
ms.workload: logic-apps
ms.service: logic-apps
ms.topic: article
ms.date: 08/16/2017
ms.author: LADocs; estfan
ms.openlocfilehash: 4d4c16860dbec10162797a13c8f9f57106abd17f
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="monitor-virtual-machine-changes-with-azure-event-grid-and-logic-apps"></a>Отслеживание изменений виртуальной машины с помощью Azure Logic Apps и службы "Сетка событий Azure"

Можно запускать автоматический [рабочий процесс приложения логики](../logic-apps/logic-apps-what-are-logic-apps.md) при определенных событиях, которые происходят с ресурсами Azure или сторонними ресурсами. Эти ресурсы могут публиковать данные события в службу [Сетка событий Azure](../event-grid/overview.md). В свою очередь, служба "Сетка событий" передает эти события подписчикам, использующим очереди, веб-привязки или [концентраторы событий](../event-hubs/event-hubs-what-is-event-hubs.md) в качестве конечных точек. В качестве подписчика приложение логики может ожидать эти события из службы "Сетка событий" перед запуском автоматических рабочих процессов для выполнения задач без написания кода.

Для примера ниже приведено несколько событий, которые издатели могут отправлять подписчикам через службу "Сетка событий Azure".

* Создание, чтение, обновление или удаление ресурса. Например, можно отслеживать изменения, за которые может взиматься плата по подписке Azure и которые могут отразиться на вашем счете. 
* Добавление или удаление пользователя в подписке Azure.
* Ваше приложение выполняет определенное действие.
* В очереди появляется новое сообщение.

В этом руководстве описывается создание приложения логики, которое отслеживает изменения в виртуальной машине и отправляет сообщения электронной почты об этих изменениях. При создании приложения логики с подпиской на события ресурса Azure события передаются из этого ресурса в приложение логики с помощью службы "Сетка событий". В этом руководстве описывается создание приложения логики:

![Обзор: отслеживание виртуальной машины с помощью службы "Сетка событий" и приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/monitor-virtual-machine-event-grid-logic-app-overview.png)

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Создание приложения логики, отслеживающего события с помощью службы "Сетка событий".
> * Добавление условия, проверяющего наличие изменений виртуальной машины.
> * Отправка электронного сообщения при изменении виртуальной машины.

## <a name="prerequisites"></a>Предварительные требования

* Учетная запись электронной почты [любого поставщика электронной почты, поддерживаемого Azure Logic Apps](../connectors/apis-list.md), например Office 365 Outlook, Outlook.com или Gmail, для отправки уведомлений. В этом руководстве используется Office 365 Outlook.

* [Виртуальная машина](https://azure.microsoft.com/services/virtual-machines). Создайте виртуальную машину, используя [сведения из документации по виртуальным машинам](https://docs.microsoft.com/azure/virtual-machines/), если вы еще не сделали этого. Чтобы настроить виртуальную машину для публикации событий, [не нужны никакие дополнительные действия](../event-grid/overview.md).

## <a name="create-a-logic-app-that-monitors-events-from-an-event-grid"></a>Создание приложения логики, отслеживающего события с помощью службы "Сетка событий"

Сначала создайте приложение логики и добавьте триггер службы "Сетка событий", отслеживающий группу ресурсов для виртуальной машины. 

1. Выполните вход на [портал Azure](https://portal.azure.com). 

2. В верхнем левом углу главного меню Azure выберите **Создать** > **Enterprise Integration** (Интеграция Enterprise) > **Приложение логики**.

   ![Создание приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/azure-portal-create-logic-app.png)

3. Создайте приложение логики с параметрами, указанными в следующей таблице:

   ![Ввод данных приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/create-logic-app-for-event-grid.png)

   | Настройка | Рекомендуемое значение | Описание | 
   | ------- | --------------- | ----------- | 
   | **Имя** | *{имя_вашего_приложения_логики}* | Укажите уникальное имя приложения логики. | 
   | **Подписка** | *{ваша_подписка_Azure}* | Выберите одну подписку Azure для всех служб в этом руководстве. | 
   | **Группа ресурсов** | *{ваша_группа_ресурсов_Azure}* | Выберите одну группу ресурсов Azure для всех служб в этом руководстве. | 
   | **Расположение** | *{ваш_регион_Azure}* | Выберите один регион для всех служб в этом руководстве. | 
   | | | 

4. По завершении установите флажок **Закрепить на панели мониторинга** и нажмите кнопку **Создать**.

   Вы создали ресурс Azure для приложения логики. 
   После того, как Azure развернет приложение логики, конструктор Logic Apps отобразит несколько распространенных шаблонов, чтоб вы могли быстрее приступить к работе.

   > [!NOTE] 
   > Если выбрать параметр **Закрепить на панели мониторинга**, приложение логики автоматически откроется в конструкторе Logic Apps. В противном случае вы можете вручную найти и открыть свое приложение логики.

5. Теперь выберите шаблон приложения логики. В разделе **Шаблоны** выберите **Пустое приложение логики**. Это позволит создать приложение логики с нуля.

   ![Выбор шаблона приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/choose-logic-app-template.png)

   Теперь конструктор Logic Apps показывает [*соединители*](../connectors/apis-list.md) и [*триггеры*](../logic-apps/logic-apps-what-are-logic-apps.md#logic-app-concepts), которые можно использовать для запуска приложения логики, а также действия, которые можно добавить после триггера для выполнения задач. Триггер — это событие, которое создает экземпляр приложения логики и запускает рабочий процесс приложения логики. 
   Первым элементом в приложении логики должен быть триггер.

6. В поле поиска введите "event grid" в качестве фильтра. Выберите триггер **Azure Event Grid - On a resource event** (Сетка событий Azure — для события ресурса).

   ![Выбор триггера "Azure Event Grid - On a resource event" (Сетка событий Azure — для события ресурса)](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-event-grid-trigger.png)

7. При появлении запроса войдите в службу "Сетка событий Azure", используя учетные данные Azure.

   ![Вход с помощью учетных данных Azure](./media/monitor-virtual-machine-changes-event-grid-logic-app/sign-in-event-grid.png)

   > [!NOTE]
   > Если вы вошли с помощью личной учетной записи Майкрософт, например @outlook.com или @hotmail.com, триггер службы "Сетка событий" может отображаться неправильно. Чтобы избежать этого, выберите [подключение с помощью субъекта-службы](/azure-resource-manager/resource-group-create-service-principal-portal.md) или выполните аутентификацию в качестве участника Azure Active Directory, связанного с подпиской Azure, например *имя_пользователя*@emailoutlook.onmicrosoft.com.

8. Теперь подпишите приложение логики на события издателя. Укажите сведения о подписке на события, как указано в следующей таблице:

   ![Ввод сведений подписки на события](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-event-grid-trigger-details-generic.png)

   | Настройка | Рекомендуемое значение | Описание | 
   | ------- | --------------- | ----------- | 
   | **Подписка** | *{подписка_Azure_виртуальной_машины}* | Выберите подписку Azure издателя событий. Для работы с этим руководством выберите для виртуальной машины подписку Azure. | 
   | **Тип ресурса** | Microsoft.Resources.resourceGroups | Выберите тип ресурса издателя событий. Для работы с этим руководством выберите указанное значение, чтобы приложение логики отслеживало только группы ресурсов. | 
   | **Имя ресурса** | *{имя_группы_ресурсов_виртуальной_машины}* | Выберите имя ресурса издателя. Для работы с этим руководством выберите имя группы ресурсов виртуальной машины. | 
   | Чтобы настроить необязательные параметры, щелкните **Показать расширенные параметры**. | *{просмотрите описания}* | * **Prefix Filter** (Фильтр по префиксу): для этого руководства оставьте данный параметр пустым. Фильтр по умолчанию соответствует всем значениям. Тем не менее можно указать строку префикса в качестве фильтра, например путь и параметр для определенного ресурса. <p>* **Suffix Filter** (Фильтр по суффиксу): для этого руководства оставьте данный параметр пустым. Фильтр по умолчанию соответствует всем значениям. Тем не менее можно указать строку суффикса в качестве фильтра, например расширение имени файла, если вас интересуют только определенные типы файлов.<p>* **Имя подписки.** Укажите уникальное имя подписки на события. |
   | | | 

   Когда все будет готово, триггер службы "Сетка событий" должен выглядеть следующим образом:
   
   ![Сведения о примере триггера службы "Сетка событий"](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-event-grid-trigger-details.png)

9. Сохраните приложение логики. На панели инструментов конструктора нажмите кнопку **Сохранить**. Чтобы свернуть и скрыть сведения о действии в приложении логики, выберите заголовок окна действия.

   ![Сохранение приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-event-grid-save.png)

   При сохранении приложения логики с триггером службы "Сетка событий" Azure автоматически создает подписку на события для приложения логики выбранного ресурса. Таким образом, когда ресурс публикует событие в службе "Сетка событий", она автоматически отправляет это событие в приложение логики. Это событие активирует приложение логики, а затем создает и запускает экземпляр рабочего процесса, который определяется на следующих шагах.

Теперь приложение логики активно и ожидает передачи данных событий службы "Сетка событий". Оно не будет выполнять никаких действий, пока они не будут добавлены в рабочий процесс. 

## <a name="add-a-condition-that-checks-for-virtual-machine-changes"></a>Добавление условия, которое проверяет наличие изменений виртуальной машины

Чтобы запускать рабочий процесс приложения логики только в том случае, когда происходит определенное событие, добавьте условие, проверяющее наличие операций записи виртуальной машины. Если это условие имеет значение true, приложение логики отправляет вам электронное сообщение со сведениями об обновленной виртуальной машине.

1. В конструкторе Logic Apps выберите для триггера службы "Сетка событий" **Новый шаг** > **Добавить условие**.

   ![Добавление условия в приложение логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-event-grid-add-condition-step.png)

   Конструктор Logic Apps добавляет пустое условие в рабочий процесс, включая пути действий для выполнения согласно значениям условия True и False.

   ![Пустое условие](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-add-empty-condition.png)

2. В поле **Условие** выберите **Edit in advanced mode** (Изменить в расширенном режиме).
Введите следующее выражение:

   `@equals(triggerBody()?['data']['operationName'], 'Microsoft.Compute/virtualMachines/write')`

   Теперь условие выглядит как в следующем примере:

   ![Пустое условие](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-condition-expression.png)

   Это выражение проверяет событие `body` на наличие объекта `data`, у которого свойство `operationName` соответствует операции `Microsoft.Compute/virtualMachines/write`. 
   Узнайте больше о [схеме событий службы "Сетка событий"](../event-grid/event-schema.md).

3. Чтобы указать описание условия, нажмите кнопку с **многоточием** (**…**) на фигуре условия, а затем выберите **Переименовать**.

   > [!NOTE] 
   > Указанные ниже примеры этого руководства также содержат описания выполнения действий в рабочем процессе приложения логики.

4. Теперь выберите **Edit in basic mode** (Изменить в простом режиме), чтобы выражение автоматически было разрешено указанным ниже образом:

   ![Условие приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-condition-1.png)

5. Сохраните приложение логики.

## <a name="send-email-when-your-virtual-machine-changes"></a>Отправка электронного сообщения при изменении виртуальной машины

Теперь добавьте [*действие*](../logic-apps/logic-apps-what-are-logic-apps.md#logic-app-concepts), чтобы получать электронное сообщение, когда заданное условие имеет значение true.

1. В поле **If true** (При значении True) условия выберите **Добавить действие**.

   ![Добавление действия для условия со значением true](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-condition-2.png)

2. В поле поиска введите слово "почта" в качестве фильтра. Найдите и выберите соединитель, соответствующий поставщику услуг электронной почты. Затем выберите действие "отправить сообщение" для соединителя. Например: 

   * Если у вас рабочая или учебная учетная запись, то выберите соединитель Office 365 Outlook. 
   * Для личных учетных записей Майкрософт выберите соединитель Outlook.com. 
   * Для учетных записей Gmail выберите соединитель Gmail. 

   Мы собираемся использовать соединитель Office 365 Outlook. 
   Если вы используете другой поставщик, то действия будут аналогичными, но пользовательский интерфейс может отличаться. 

   ![Выбор действия "отправить сообщение"](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-send-email.png)

3. Если подключение к вашему поставщику услуг электронной почты не установлено, войдите в учетную запись электронной почты в ответ на запрос аутентификации.

4. Введите данные электронной почты, как показано в указанной ниже таблице:

   ![Пустое действие электронной почты](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-empty-email-action.png)

   > [!TIP]
   > Чтобы выбрать поля, доступные в рабочем процессе, щелкните в поле ввода, чтобы открыть список **Динамическое содержимое**, или выберите **Add dynamic content** (Добавить динамическое содержимое). Выберите **Дополнительно** для каждого раздела в списке, чтобы отобразить дополнительные поля. Чтобы закрыть список **Динамическое содержимое**, выберите **Add dynamic content** (Добавить динамическое содержимое).

   | Настройка | Рекомендуемое значение | Описание | 
   | ------- | --------------- | ----------- | 
   | **To** | *{электронный_адрес_получателя}* |Введите электронный адрес получателя. Для тестировании можете использовать свой собственный адрес. | 
   | **Тема** | Обновленный ресурс: **Тема**| Введите содержимое темы электронного сообщения. В рамках этого руководства введите предложенный текст и выберите поле события **Тема**. Здесь тема электронного сообщения содержит имя обновленного ресурса (виртуальная машина). | 
   | **Текст** | Группа ресурсов: **Раздел** <p>Тип события: **Тип события**<p>Идентификатор события: **Идентификатор**<p>Время: **Время события** | Введите содержимое текста сообщения электронной почты. Введите предложенный текст и выберите поля **Раздел**, **Тип события**, **Идентификатор** и **Время события**, чтобы электронное сообщение содержало имя группы ресурсов, тип, метку времени и идентификатор события для обновления. <p>Чтобы добавить пустые строки в содержимое, нажмите Shift + ВВОД. | 
   | | | 

   > [!NOTE] 
   > Если выбрать поле, которое представляет массив, конструктор автоматически добавит цикл **For each** для действия, которое ссылается на массив. Таким образом приложение логики будет выполнять это действие для каждого элемента массива.

   Теперь действие отправки электронного сообщения может выглядеть следующим образом.

   ![Выбор выходных данных для включения в электронное сообщение](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-send-email-details.png)

   Готовое приложение логики может выглядеть следующим образом:

   ![Готовое приложение логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-completed.png)

5. Сохраните приложение логики. Чтобы свернуть и скрыть сведения о каждом действии в приложении логики, выберите заголовок окна действия.

   ![Сохранение приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-event-grid-save-completed.png)

   Теперь приложение логики активно, но ожидает изменений в виртуальной машине, прежде чем что-либо выполнить. 
   Чтобы проверить приложение логики, перейдите следующему разделу.

## <a name="test-your-logic-app-workflow"></a>Проверка рабочего процесса приложения логики

1. Чтобы проверить, получает ли приложение логики указанные события, обновите виртуальную машину. 

   Например, можно изменить размер виртуальной машины на портале Azure или [с помощью Azure PowerShell](../virtual-machines/windows/resize-vm.md). 

   Через несколько секунд вы должны получить электронное сообщение. Например:

   ![Электронное сообщение об обновлении виртуальной машины](./media/monitor-virtual-machine-changes-event-grid-logic-app/email.png)

2. Чтобы просмотреть журнал триггера и выполнения приложения логики, в меню приложения выберите **Обзор**. Чтобы просмотреть дополнительные сведения о выполнении, выберите строку для этого выполнения.

   ![Журнал выполнения приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-run-history.png)

3. Чтобы просмотреть входные и выходные данные каждого действия, разверните действие, которое необходимо просмотреть. Эти сведения помогут вам диагностировать и устранить проблемы в приложении логики.
 
   ![Информация журнала выполнения приложения логики](./media/monitor-virtual-machine-changes-event-grid-logic-app/logic-app-run-history-details.png)

Поздравляем! Вы создали и запустили приложение логики, которое отслеживает события ресурса с помощью службы "Сетка событий" и отправляет вам электронные сообщения при возникновении этих событий. Вы также узнали, как можно легко создать рабочие процессы, позволяющие автоматизировать и интегрировать системы и облачные службы.

## <a name="clean-up-resources"></a>Очистка ресурсов

В этом руководстве используются ресурсы и выполняются действия, подлежащие оплате по подписке Azure. Завершив проверку и работу с руководством, обязательно отключите или удалите все ресурсы, за использование которых не имеете намерения платить.

Вы можете остановить выполнение приложения логики и отправку электронных сообщений, не удаляя приложение. В меню приложения логики щелкните **Обзор**. На панели инструментов щелкните **Отключить**.

![Отключение приложения логики.](./media/monitor-virtual-machine-changes-event-grid-logic-app/turn-off-disable-logic-app.png)

## <a name="faq"></a>Часто задаваемые вопросы

**Вопрос**. Какие другие задачи мониторинга виртуальных машин можно выполнять с помощью службы "Сетка событий" и приложений логики? </br>
**Ответ**. Можно отслеживать другие изменения в конфигурации, например:

* виртуальная машина получает права доступа RBAC (управление доступом на основе ролей);
* вносятся изменения в группу безопасности сети (NSG) сетевого интерфейса;
* добавляются или удаляются диски виртуальной машины;
* сетевому адаптеру виртуальной машины назначается общедоступный IP-адрес.

## <a name="next-steps"></a>Дальнейшие действия

* [Обзор службы Сетка событий Azure](../event-grid/overview.md)
* [Основные понятия службы "Сетка событий Azure"](../event-grid/concepts.md)
* [Создание и перенаправление пользовательского события со службой "Сетка событий Azure"](../event-grid/custom-event-quickstart.md)
* [Схема событий службы "Сетка событий Azure"](../event-grid/event-schema.md)
* [Azure Logic Apps](../logic-apps/logic-apps-what-are-logic-apps.md)
* [Настройка рабочего процесса с помощью встроенного шаблона или схемы для быстрого начала работы](../logic-apps/logic-apps-use-logic-app-templates.md)
---
title: "Подключение устройства с помощью C в mbed | Документация Майкрософт"
description: "Описывает, как подключить устройство к предварительно настроенному решению для удаленного мониторинга из набора Azure IoT Suite с помощью приложения на C, запущенного на устройстве mbed."
services: 
suite: iot-suite
documentationcenter: na
author: dominicbetts
manager: timlt
editor: 
ms.assetid: 9551075e-dcf9-488f-943e-d0eb0e6260be
ms.service: iot-suite
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 05/22/2017
ms.author: dobett
ROBOTS: NOINDEX
ms.openlocfilehash: ef7b78f85a787f8fbe22c0e26aa34f0cd1685d58
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="connect-your-device-to-the-remote-monitoring-preconfigured-solution-mbed"></a>Подключение устройства к предварительно настроенному решению для удаленного мониторинга (mbed)

## <a name="scenario-overview"></a>Обзор сценария
В этом примере создается устройство, которое отправляет следующие данные телеметрии в [предварительно настроенное решение][lnk-what-are-preconfig-solutions] для удаленного мониторинга:

* наружная температура;
* внутренняя температура;
* влажность.

В целях упрощения код на устройстве генерирует образцы значений, но мы рекомендуем расширить пример и подключить к устройству реальные датчики и отправить реальные данные телеметрии.

Устройство также может отвечать на методы, вызываемые из панели мониторинга решения, и значения требуемых свойств, заданные на панели мониторинга решения.

Для работы с этим руководством требуется активная учетная запись Azure. Если ее нет, можно создать бесплатную пробную учетную запись всего за несколько минут. Дополнительные сведения см. в статье о [бесплатной пробной версии Azure][lnk-free-trial].

## <a name="before-you-start"></a>Перед началом работы
До написания кода для устройства необходимо подготовить свое предварительно настроенное решение для удаленного мониторинга, а затем подготовить в нем новое пользовательское устройство.

### <a name="provision-your-remote-monitoring-preconfigured-solution"></a>Подготовка предварительно настроенного решения для удаленного мониторинга
Созданное в этом руководстве устройство отправляет данные в экземпляр предварительно настроенного решения для [удаленного мониторинга][lnk-remote-monitoring]. Если вы еще не подготовили это решение в своей учетной записи Azure, то выполните следующие действия:

1. Чтобы создать решение, на странице <https://www.azureiotsuite.com/> щелкните знак **+**.
2. На панели **Удаленный мониторинг** щелкните **Выбрать**.
3. На странице **Create Remote monitoring solution** (Создание решения для удаленного мониторинга) введите **имя решения** по своему усмотрению, выберите **регион** для развертывания и подписку Azure, которую нужно использовать. Затем щелкните **Создать решение**.
4. Дождитесь завершения процесса подготовки.

> [!WARNING]
> В предварительно настроенных решениях используются платные службы Azure. Закончив работу с предварительно настроенным решением, не забудьте удалить его из подписки, чтобы избежать ненужных расходов. На странице <https://www.azureiotsuite.com/> можно полностью удалить предварительно настроенное решение из подписки.
> 
> 

После завершения подготовки решения для удаленного мониторинга щелкните **Запустить** , чтобы открыть панель мониторинга этого решения в браузере.

![Панель мониторинга решения][img-dashboard]

### <a name="provision-your-device-in-the-remote-monitoring-solution"></a>Подготовка устройства в решении для удаленного мониторинга
> [!NOTE]
> Если вы уже подготовили устройство в решении, пропустите этот шаг. При создании клиентского приложения необходимо знать учетные данные устройства.
> 
> 

Чтобы устройство смогло подключиться к предварительно настроенному решению, оно должно пройти идентификацию в центре IoT с использованием допустимых учетных данных. Учетные данные устройства можно получить на панели мониторинга решения. Вы добавите их в клиентское приложение далее в этом учебнике.

Чтобы добавить устройство в решение для удаленного мониторинга, выполните следующие действия на панели мониторинга решения:

1. В левом нижнем углу панели мониторинга щелкните **Добавить устройство**.
   
   ![Добавление устройства][1]
2. На панели **Пользовательское устройство** нажмите кнопку **Добавить**.
   
   ![Добавление пользовательского устройства][2]
3. Установите переключатель **Позвольте мне определить собственный идентификатор устройства**. Введите идентификатор устройства, например **mydevice**, и нажмите кнопку **Проверить идентификатор**, чтобы убедиться, что такое имя не используется. Затем нажмите кнопку **Создать**, чтобы подготовить устройство.
   
   ![Добавление идентификатора устройства][3]
4. Запишите учетные данные (идентификатор устройства, имя узла в Центре Интернета вещей и ключ устройства). Эти значения потребуются клиентскому приложению при подключении к решению для удаленного мониторинга. Затем нажмите кнопку **Done**(Готово).
   
    ![Просмотр учетных данных устройства][4]
5. Выберите устройство в списке устройств на панели мониторинга решения. Затем на панели **Сведения об устройстве** щелкните **Включить устройство**. Теперь текущее состояние устройства — **Работает**. Решение для удаленного мониторинга теперь может получать данные телеметрии с устройства и вызывать методы на устройстве.

[img-dashboard]: ./media/iot-suite-connecting-devices-mbed/dashboard.png
[1]: ./media/iot-suite-connecting-devices-mbed/suite0.png
[2]: ./media/iot-suite-connecting-devices-mbed/suite1.png
[3]: ./media/iot-suite-connecting-devices-mbed/suite2.png
[4]: ./media/iot-suite-connecting-devices-mbed/suite3.png

[lnk-what-are-preconfig-solutions]: iot-suite-what-are-preconfigured-solutions.md
[lnk-remote-monitoring]: iot-suite-remote-monitoring-sample-walkthrough.md
[lnk-free-trial]: http://azure.microsoft.com/pricing/free-trial/

## <a name="build-and-run-the-c-sample-solution"></a>Выполнение сборки и запуск примера решения на C

Ниже перечислены инструкции по подключению устройства [Freescale FRDM-K64F с поддержкой mbed][lnk-mbed-home] к решению для удаленного мониторинга.

### <a name="connect-the-mbed-device-to-your-network-and-desktop-machine"></a>Подключение устройства mbed к сети и настольному компьютеру

1. Подключите устройство mbed к сети, используя кабель Ethernet. Это необходимо, так как примеру приложения требуется доступ к Интернету.

1. Чтобы подключить устройство mbed к настольному компьютеру, см. статью о [начале работы с mbed][lnk-mbed-getstarted].

1. Если настольный компьютер работает под управлением Windows, см. раздел о [настройке компьютера][lnk-mbed-pcconnect] для настройки доступа к устройству mbed через последовательный порт.

### <a name="create-an-mbed-project-and-import-the-sample-code"></a>Создание проекта mbed и импорт примера кода

Выполните следующие действия, чтобы добавить пример кода в проект mbed. Мы импортируем начальный проект для удаленного мониторинга, а затем изменим проект для использования протокола MQTT вместо протокола AMQP. В настоящее время необходимо, чтобы протокол MQTT использовал функции управления устройствами Центра Интернета вещей.

1. Откройте в веб-браузере [сайт для разработчиков](https://developer.mbed.org/)на портале mbed.org. Если у вас еще нет учетной записи, зарегистрируйтесь (бесплатно). Если учетная запись есть, используйте ее для входа. Щелкните **Compiler** (Компилятор) в правом верхнем углу страницы. Отобразится интерфейс *Workspace* (Рабочая область).

1. Убедитесь, что в правом верхнем углу окна отображается аппаратная платформа, которую вы используете. В противном случае щелкните значок и выберите другую платформу.

1. Щелкните **Импорт** в главном меню. Щелкните ссылку **Click here to import from URL** (Щелкните здесь, чтобы импортировать с URL-адреса).
   
    ![Запуск импорта в рабочую область mbed][6]

1. Во всплывающем окне введите ссылку на пример кода https://developer.mbed.org/users/AzureIoTClient/code/remote_monitoring/, а затем нажмите кнопку **Import** (Импорт).
   
    ![Импорт примера кода в рабочую область mbed][7]

1. В окне компилятора mbed вы увидите, что при импорте проекта также импортируются различные библиотеки. Некоторые из них предоставляются и обслуживаются командой разработчиков Центра Интернета вещей Azure ([azureiot_common](https://developer.mbed.org/users/AzureIoTClient/code/azureiot_common/), [iothub_client](https://developer.mbed.org/users/AzureIoTClient/code/iothub_client/), [iothub_amqp_transport](https://developer.mbed.org/users/AzureIoTClient/code/iothub_amqp_transport/), [azure_uamqp](https://developer.mbed.org/users/AzureIoTClient/code/azure_uamqp/)), остальные являются библиотеками сторонних производителей, доступными в каталоге библиотек mbed.
   
    ![Просмотр проекта mbed][8]

1. В **рабочей области программы** щелкните правой кнопкой мыши библиотеку **iothub\_amqp\_transport**, выберите **Delete** (Удалить) и нажмите кнопку **ОК** для подтверждения.

1. В **рабочей области программы** щелкните правой кнопкой мыши библиотеку **azure\_amqp\_c**, выберите **Delete** (Удалить) и нажмите кнопку **ОК** для подтверждения.

1. В **рабочей области программы** щелкните правой кнопкой мыши проект **remote_monitoring**, выберите **Import Library** (Импортировать библиотеку), а затем — **From URL** (С URL-адреса).
   
    ![Запуск импорта библиотеки в рабочую область mbed][6]

1. Во всплывающем окне введите ссылку на библиотеку транспорта MQTT https://developer.mbed.org/users/AzureIoTClient/code/iothub\_mqtt\_transport/, а затем нажмите кнопку **Import** (Импорт).
   
    ![Импорт библиотеки в рабочую область mbed][12]

1. Повторите предыдущий шаг, чтобы добавить библиотеку MQTT с URL-адреса https://developer.mbed.org/users/AzureIoTClient/code/azure\_umqtt\_c/.

1. Теперь рабочая область выглядит так:

    ![Просмотр рабочей области mbed][13]

1. Откройте файл remote\_monitoring\remote_monitoring.c и замените имеющиеся инструкции `#include` следующим кодом:

    ```c
    #include "iothubtransportmqtt.h"
    #include "schemalib.h"
    #include "iothub_client.h"
    #include "serializer_devicetwin.h"
    #include "schemaserializer.h"
    #include "azure_c_shared_utility/threadapi.h"
    #include "azure_c_shared_utility/platform.h"
    #include "parson.h"

    #ifdef MBED_BUILD_TIMESTAMP
    #include "certs.h"
    #endif // MBED_BUILD_TIMESTAMP
    ```
1. Удалить весь остальной код из файла remote\_monitoring\remote\_monitoring.c.

[!INCLUDE [iot-suite-connecting-code](../../includes/iot-suite-connecting-code.md)]

## <a name="build-and-run-the-sample"></a>Сборка и запуск примера

Добавьте код для вызова функции **remote\_monitoring\_run**, а затем создайте и запустите приложение устройства.

1. Добавьте функцию **main**, вставив следующий код в конце файла remote\_monitoring.c для вызова функции **remote\_monitoring\_run**:
   
    ```c
    int main()
    {
      remote_monitoring_run();
      return 0;
    }
    ```

1. Щелкните **Скомпилировать**, чтобы собрать программу. Вы можете проигнорировать все предупреждения. Однако если при сборке возникают ошибки, исправьте их, прежде чем продолжить.

1. Если сборка выполнена успешно, то на веб-сайте компилятора mbed создается BIN-файл с именем вашего проекта и загружается на локальный компьютер. Скопируйте BIN-файл на устройство. При сохранении BIN-файла на устройство происходит перезапуск устройства и запуск программы, содержащейся в BIN-файле. Программу можно вручную перезапустить в любое время, нажав кнопку сброса на устройстве mbed.

1. Подключитесь к устройству с помощью клиентского SSH-приложения, такого как PuTTY. Вы можете посмотреть, какой последовательный порт использует устройство, в диспетчере устройств Windows.
   
    ![][11]

1. В PuTTY выберите тип подключения **Serial** (Последовательный). Устройство обычно подключается со скоростью 9600 бод, поэтому введите 9600 в поле **Speed** (Скорость). Затем щелкните **Открыть**.

1. Начнется выполнение программы. Если программа не запускается автоматически при подключении, возможно, нужно перезагрузить плату (для этого нажмите клавиши Ctrl+Break или кнопку сброса на плате).
   
    ![][10]

[!INCLUDE [iot-suite-visualize-connecting](../../includes/iot-suite-visualize-connecting.md)]

[6]: ./media/iot-suite-connecting-devices-mbed/mbed1.png
[7]: ./media/iot-suite-connecting-devices-mbed/mbed2a.png
[8]: ./media/iot-suite-connecting-devices-mbed/mbed3a.png
[10]: ./media/iot-suite-connecting-devices-mbed/putty.png
[11]: ./media/iot-suite-connecting-devices-mbed/mbed6.png
[12]: ./media/iot-suite-connecting-devices-mbed/mbed7.png
[13]: ./media/iot-suite-connecting-devices-mbed/mbed8.png

[lnk-mbed-home]: https://developer.mbed.org/platforms/FRDM-K64F/
[lnk-mbed-getstarted]: https://developer.mbed.org/platforms/FRDM-K64F/#getting-started-with-mbed
[lnk-mbed-pcconnect]: https://developer.mbed.org/platforms/FRDM-K64F/#pc-configuration

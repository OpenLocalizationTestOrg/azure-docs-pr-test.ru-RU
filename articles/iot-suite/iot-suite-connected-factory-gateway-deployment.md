---
title: "Развертывание шлюза для подключенной фабрики Azure IoT Suite | Документация Майкрософт"
description: "Узнайте, как развернуть шлюз в ОС Windows или Linux, чтобы обеспечить подключение к предварительно настроенному решению подключенной фабрики."
services: 
suite: iot-suite
documentationcenter: na
author: dominicbetts
manager: timlt
editor: 
ms.service: iot-suite
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/24/2017
ms.author: dobett
ms.openlocfilehash: b0e6ae705911d7c18643c77b7fe08fdffffa5eb1
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="deploy-a-gateway-on-windows-or-linux-for-the-connected-factory-preconfigured-solution"></a><span data-ttu-id="6f656-103">Развертывание шлюза в ОС Windows или Linux для предварительно настроенного решения подключенной фабрики</span><span class="sxs-lookup"><span data-stu-id="6f656-103">Deploy a gateway on Windows or Linux for the connected factory preconfigured solution</span></span>

<span data-ttu-id="6f656-104">Программное обеспечение, необходимое для развертывания шлюза для предварительно настроенного решения подключенной фабрики, состоит из двух компонентов:</span><span class="sxs-lookup"><span data-stu-id="6f656-104">The software required to deploy a gateway for the connected factory preconfigured solution has two components:</span></span>

* <span data-ttu-id="6f656-105">*Прокси-сервер OPC* устанавливает подключение к Центру Интернета вещей.</span><span class="sxs-lookup"><span data-stu-id="6f656-105">The *OPC Proxy* establishes a connection to IoT Hub.</span></span> <span data-ttu-id="6f656-106">Затем *прокси-сервер OPC* ожидает команду и контрольные сообщения от встроенного браузера OPC, работающего на портале решения подключенной фабрики.</span><span class="sxs-lookup"><span data-stu-id="6f656-106">The *OPC Proxy* then waits for command and control messages from the integrated OPC Browser that runs in the connected factory solution portal.</span></span>
* <span data-ttu-id="6f656-107">*Издатель OPC* соединяется с существующими локальными серверами OPC UA и пересылает сообщения телеметрии от них в Центр Интернета вещей.</span><span class="sxs-lookup"><span data-stu-id="6f656-107">The *OPC Publisher* connects to existing on-premises OPC UA servers and forwards telemetry messages from them to IoT Hub.</span></span>

<span data-ttu-id="6f656-108">Оба компонента имеют открытый исходный код и доступны в виде файлов с исходным кодом на GitHub и в качестве контейнеров Docker:</span><span class="sxs-lookup"><span data-stu-id="6f656-108">Both components are open-source and are available as source on GitHub and as Docker containers:</span></span>

| <span data-ttu-id="6f656-109">GitHub</span><span class="sxs-lookup"><span data-stu-id="6f656-109">GitHub</span></span> | <span data-ttu-id="6f656-110">DockerHub</span><span class="sxs-lookup"><span data-stu-id="6f656-110">DockerHub</span></span> |
| ------ | --------- |
| <span data-ttu-id="6f656-111">[Издатель OPC][lnk-publisher-github]</span><span class="sxs-lookup"><span data-stu-id="6f656-111">[OPC Publisher][lnk-publisher-github]</span></span> | <span data-ttu-id="6f656-112">[Издатель OPC][lnk-publisher-docker]</span><span class="sxs-lookup"><span data-stu-id="6f656-112">[OPC Publisher][lnk-publisher-docker]</span></span> |
| <span data-ttu-id="6f656-113">[Прокси-сервер OPC][lnk-proxy-github]</span><span class="sxs-lookup"><span data-stu-id="6f656-113">[OPC Proxy][lnk-proxy-github]</span></span> | <span data-ttu-id="6f656-114">[Прокси-сервер OPC][lnk-proxy-docker]</span><span class="sxs-lookup"><span data-stu-id="6f656-114">[OPC Proxy][lnk-proxy-docker]</span></span> |

<span data-ttu-id="6f656-115">Для этих компонентов не требуется общедоступный IP-адрес или заглушка в брандмауэре шлюза.</span><span class="sxs-lookup"><span data-stu-id="6f656-115">No public-facing IP address or holes in the gateway firewall are required for either component.</span></span> <span data-ttu-id="6f656-116">Прокси-сервер OPC и издатель OPC используют только исходящие порты 443, 5671 и 8883.</span><span class="sxs-lookup"><span data-stu-id="6f656-116">The OPC Proxy and OPC Publisher use only outbound ports 443, 5671, and 8883.</span></span>

<span data-ttu-id="6f656-117">Описанные в этой статье действия показывают, как развернуть шлюз с помощью Docker в ОС [Windows](#windows-deployment) или [Linux](#linux-deployment).</span><span class="sxs-lookup"><span data-stu-id="6f656-117">The steps in this article show you how to deploy a gateway using Docker on either [Windows](#windows-deployment) or [Linux](#linux-deployment).</span></span> <span data-ttu-id="6f656-118">Шлюз обеспечивает подключение к предварительно настроенному решению подключенной фабрики.</span><span class="sxs-lookup"><span data-stu-id="6f656-118">The gateway enables connectivity to the connected factory preconfigured solution.</span></span>

> [!NOTE]
> <span data-ttu-id="6f656-119">[Edge Интернета вещей Azure] — это программное обеспечение шлюза, выполняемое в контейнере Docker.</span><span class="sxs-lookup"><span data-stu-id="6f656-119">The gateway software that runs in the Docker container is [Azure IoT Edge].</span></span>

## <a name="windows-deployment"></a><span data-ttu-id="6f656-120">Развертывание в ОС Windows</span><span class="sxs-lookup"><span data-stu-id="6f656-120">Windows deployment</span></span>

> [!NOTE]
> <span data-ttu-id="6f656-121">Если у вас еще нет устройства шлюза, то корпорация Майкрософт рекомендует приобрести коммерческий шлюз у одного из наших партнеров.</span><span class="sxs-lookup"><span data-stu-id="6f656-121">If you don't yet have a gateway device, Microsoft recommends you buy a commercial gateway from one of our partners.</span></span> <span data-ttu-id="6f656-122">Посетите [каталог устройств Azure IoT], который содержит список устройств шлюза, совместимых с решением подключенной фабрики.</span><span class="sxs-lookup"><span data-stu-id="6f656-122">Visit the [Azure IoT device catalog] for a list of gateway devices compatible with the connected factory solution.</span></span> <span data-ttu-id="6f656-123">Настройте шлюз, следуя приложенным к устройству инструкциям.</span><span class="sxs-lookup"><span data-stu-id="6f656-123">Follow the instructions that come with the device to set up the gateway.</span></span> <span data-ttu-id="6f656-124">Также можно воспользоваться приведенными ниже инструкциями, чтобы вручную настроить один из существующих шлюзов.</span><span class="sxs-lookup"><span data-stu-id="6f656-124">Alternatively, use the following instructions to manually set up one of your existing gateways.</span></span>

### <a name="install-docker"></a><span data-ttu-id="6f656-125">Установка Docker</span><span class="sxs-lookup"><span data-stu-id="6f656-125">Install Docker</span></span>

<span data-ttu-id="6f656-126">Установите [Docker для Windows] на устройстве шлюза, работающем под управлением Windows.</span><span class="sxs-lookup"><span data-stu-id="6f656-126">Install [Docker for Windows] on your Windows-based gateway device.</span></span> <span data-ttu-id="6f656-127">Во время установки Docker в ОС Windows выберите на хост-компьютере диск, который будет использоваться совместно с Docker.</span><span class="sxs-lookup"><span data-stu-id="6f656-127">During Windows Docker setup, select a drive on your host machine to share with Docker.</span></span> <span data-ttu-id="6f656-128">На следующем снимке экрана показано, как в системе Windows совместно используется диск D:</span><span class="sxs-lookup"><span data-stu-id="6f656-128">The following screenshot shows sharing the D drive on your Windows system:</span></span>

![Установка Docker][img-install-docker]

<span data-ttu-id="6f656-130">Затем создайте папку с именем **docker** в корне общего диска.</span><span class="sxs-lookup"><span data-stu-id="6f656-130">Then create a folder called **docker** in the root of the shared drive.</span></span>
<span data-ttu-id="6f656-131">Можно также выполнить этот шаг после установки Docker из меню **Параметры**.</span><span class="sxs-lookup"><span data-stu-id="6f656-131">You can also perform this step after installing docker from the **Settings** menu.</span></span>

### <a name="configure-the-gateway"></a><span data-ttu-id="6f656-132">Настройка шлюза</span><span class="sxs-lookup"><span data-stu-id="6f656-132">Configure the gateway</span></span>

1. <span data-ttu-id="6f656-133">Для завершения развертывания шлюза необходима строка подключения **iothubowner** развертывания подключенной фабрики Azure IoT Suite.</span><span class="sxs-lookup"><span data-stu-id="6f656-133">You need the **iothubowner** connection string of your Azure IoT Suite connected factory deployment to complete the gateway deployment.</span></span> <span data-ttu-id="6f656-134">На [портале Azure] перейдите в Центр Интернета вещей в группе ресурсов, созданной при развертывании решения подключенной фабрики.</span><span class="sxs-lookup"><span data-stu-id="6f656-134">In the [Azure portal], navigate to your IoT Hub in the resource group created when you deployed the connected factory solution.</span></span> <span data-ttu-id="6f656-135">Щелкните **Политики общего доступа** для доступа к строке подключения **iothubowner**:</span><span class="sxs-lookup"><span data-stu-id="6f656-135">Click **Shared access policies** to access the **iothubowner** connection string:</span></span>

    ![Поиск строки подключения Центра Интернета вещей][img-hub-connection]

    <span data-ttu-id="6f656-137">Скопируйте значение поля **Строка подключения — первичный ключ**.</span><span class="sxs-lookup"><span data-stu-id="6f656-137">Copy the **Connection string--primary key** value.</span></span>

1. <span data-ttu-id="6f656-138">Настройте шлюз для своего Центра Интернета вещей. Для этого **один раз** запустите из командной строки два модуля шлюза, используя следующую команду:</span><span class="sxs-lookup"><span data-stu-id="6f656-138">Configure the gateway for your IoT Hub by running the two gateway modules **once** from a command prompt with:</span></span>

    `docker run -it --rm -h <ApplicationName> -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v //D/docker:/root/.dotnet/corefx/cryptography/x509stores microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName> "<IoTHubOwnerConnectionString>"`

    `docker run -it --rm -v //D/docker:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -i -c "<IoTHubOwnerConnectionString>" -D /mapped/cs.db`

    * <span data-ttu-id="6f656-139">**&lt;ApplicationName&gt;** — это имя, которое дается издателю OPC UA в формате **publisher.&lt;полное доменное имя&gt;**.</span><span class="sxs-lookup"><span data-stu-id="6f656-139">**&lt;ApplicationName&gt;** is the name to give to your OPC UA Publisher in the format **publisher.&lt;your fully qualified domain name&gt;**.</span></span> <span data-ttu-id="6f656-140">Например, если сеть фабрики имеет название **myfactorynetwork.com**, то **ApplicationName** будет иметь значение **publisher.myfactorynetwork.com**.</span><span class="sxs-lookup"><span data-stu-id="6f656-140">For example, if your factory network is called **myfactorynetwork.com**, the **ApplicationName** value is **publisher.myfactorynetwork.com**.</span></span>
    * <span data-ttu-id="6f656-141">**&lt;IoTHubOwnerConnectionString&gt;** — это строка подключения **iothubowner**, которую вы скопировали на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="6f656-141">**&lt;IoTHubOwnerConnectionString&gt;** is the **iothubowner** connection string you copied in the previous step.</span></span> <span data-ttu-id="6f656-142">Эта строка подключения используется только на этом шаге и больше не потребуется.</span><span class="sxs-lookup"><span data-stu-id="6f656-142">This connection string is only used in this step, you don’t need it in the following steps:</span></span>

    <span data-ttu-id="6f656-143">В дальнейшем для хранения двух сертификатов X.509, используемых модулями шлюза, используется сопоставленная папка D:\\папка_docker (аргумент `-v`).</span><span class="sxs-lookup"><span data-stu-id="6f656-143">You use the mapped D:\\docker folder (the `-v` argument) later to persist the two X.509 certificates that the gateway modules use.</span></span>

### <a name="run-the-gateway"></a><span data-ttu-id="6f656-144">Запуск шлюза</span><span class="sxs-lookup"><span data-stu-id="6f656-144">Run the gateway</span></span>

1. <span data-ttu-id="6f656-145">Перезапустите шлюз с помощью следующих команд:</span><span class="sxs-lookup"><span data-stu-id="6f656-145">Restart the gateway using the following commands:</span></span>

    `docker run -it --rm -h <ApplicationName> --expose 62222 -p 62222:62222 -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/Logs -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v //D/docker:/shared -v //D/docker:/root/.dotnet/corefx/cryptography/x509stores -e _GW_PNFP="/shared/publishednodes.JSON" microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName>`

    `docker run -it --rm -v //D/docker:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -D /mapped/cs.db`

1. <span data-ttu-id="6f656-146">По соображениям безопасности два сертификата X.509, сохраненные в папке D:\\docker, содержат закрытый ключ.</span><span class="sxs-lookup"><span data-stu-id="6f656-146">For security reasons, the two X.509 certificates persisted in the D:\\docker folder contain the private key.</span></span> <span data-ttu-id="6f656-147">Предоставьте доступ к этой папке только учетным данным, которые используются для запуска контейнера Docker (обычно это учетные данные **администратора**).</span><span class="sxs-lookup"><span data-stu-id="6f656-147">Limit access to this folder to the credentials (typically **Administrators**) you use to run the Docker container.</span></span> <span data-ttu-id="6f656-148">Щелкните правой кнопкой мыши папку D:\\docker, выберите **Свойства** > **Безопасность** > **Изменить**.</span><span class="sxs-lookup"><span data-stu-id="6f656-148">Right-click the D:\\docker folder, choose **Properties**, then **Security**, and then **Edit**.</span></span> <span data-ttu-id="6f656-149">Предоставьте **администраторам** полный доступ и удалите всех остальных:</span><span class="sxs-lookup"><span data-stu-id="6f656-149">Give **Administrators** full control and remove everyone else:</span></span>

    ![Предоставление прав общей папке Docker][img-docker-share]

1. <span data-ttu-id="6f656-151">Проверьте сетевое подключение.</span><span class="sxs-lookup"><span data-stu-id="6f656-151">Verify network connectivity.</span></span> <span data-ttu-id="6f656-152">В окне командной строки введите команду `ping publisher.<your fully qualified domain name>`, чтобы проверить связь со шлюзом.</span><span class="sxs-lookup"><span data-stu-id="6f656-152">From a command prompt, enter the command `ping publisher.<your fully qualified domain name>` to ping your gateway.</span></span> <span data-ttu-id="6f656-153">Если точка назначения недоступна, добавьте IP-адрес и имя шлюза в файл hosts на шлюзе.</span><span class="sxs-lookup"><span data-stu-id="6f656-153">If the destination is unreachable, add the IP address and name of your gateway to the hosts file on your gateway.</span></span> <span data-ttu-id="6f656-154">Файл hosts находится в папке **Windows\\System32\\drivers\\etc**.</span><span class="sxs-lookup"><span data-stu-id="6f656-154">The hosts file is located in the **Windows\\System32\\drivers\\etc** folder.</span></span>

1. <span data-ttu-id="6f656-155">Затем попытайтесь подключиться к издателю, используя локальный клиент OPC UA, запущенный на шлюзе.</span><span class="sxs-lookup"><span data-stu-id="6f656-155">Next, try to connect to the publisher using a local OPC UA client running on the gateway.</span></span> <span data-ttu-id="6f656-156">URL-адрес конечной точки OPC UA — `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span><span class="sxs-lookup"><span data-stu-id="6f656-156">The OPC UA endpoint URL is `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span></span> <span data-ttu-id="6f656-157">Если у вас нет клиента OPC UA, скачайте и используйте [клиент OPC UA с открытым кодом].</span><span class="sxs-lookup"><span data-stu-id="6f656-157">If you don't have an OPC UA client, you can download and use an [open-source OPC UA client].</span></span>

1. <span data-ttu-id="6f656-158">После успешного выполнения этих локальных проверок перейдите на страницу **Connect your own OPC UA Server** (Подключение собственного сервера OPC UA) на портале решения подключенной фабрики.</span><span class="sxs-lookup"><span data-stu-id="6f656-158">When you have successfully completed these local tests, browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="6f656-159">Введите URL-адрес конечной точки издателя (`tcp://publisher.<your fully qualified domain name>:62222`) и нажмите кнопку **Подключить**.</span><span class="sxs-lookup"><span data-stu-id="6f656-159">Enter the publisher endpoint URL (`tcp://publisher.<your fully qualified domain name>:62222`) and click **Connect**.</span></span> <span data-ttu-id="6f656-160">После отображения предупреждения о сертификате щелкните **Продолжить**.</span><span class="sxs-lookup"><span data-stu-id="6f656-160">You get a certificate warning, then click **Proceed.**</span></span> <span data-ttu-id="6f656-161">Затем отобразится сообщение об ошибке, информирующее о том, что издатель не воспринимает веб-клиент UA как доверенный.</span><span class="sxs-lookup"><span data-stu-id="6f656-161">Next you get an error that the publisher doesn’t trust the UA Web Client.</span></span> <span data-ttu-id="6f656-162">Чтобы устранить эту ошибку, скопируйте сертификат **UA Web Client** из папки **D:\\docker\\Rejected Certificates\\certs** в папку **D:\\docker\\UA Applications\\certs** на шлюзе.</span><span class="sxs-lookup"><span data-stu-id="6f656-162">To resolve this error, copy the **UA Web Client** certificate from the **D:\\docker\\Rejected Certificates\\certs** folder to the **D:\\docker\\UA Applications\\certs** folder on the gateway.</span></span> <span data-ttu-id="6f656-163">Перезапускать шлюз не требуется.</span><span class="sxs-lookup"><span data-stu-id="6f656-163">You do not need to restart of the gateway.</span></span> <span data-ttu-id="6f656-164">Повторите этот шаг.</span><span class="sxs-lookup"><span data-stu-id="6f656-164">Repeat this step.</span></span> <span data-ttu-id="6f656-165">Теперь вы можете подключиться к шлюзу из облака, а также вы готовы добавить серверы OPC UA в решение.</span><span class="sxs-lookup"><span data-stu-id="6f656-165">You can now connect to the gateway from the cloud, and you are ready to add OPC UA servers to the solution.</span></span>

### <a name="add-your-opc-ua-servers"></a><span data-ttu-id="6f656-166">Добавление серверов OPC UA</span><span class="sxs-lookup"><span data-stu-id="6f656-166">Add your OPC UA servers</span></span>

1. <span data-ttu-id="6f656-167">Перейдите на страницу **Connect your own OPC UA Server** (Подключение собственного сервера OPC UA) на портале решения подключенной фабрики.</span><span class="sxs-lookup"><span data-stu-id="6f656-167">Browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="6f656-168">Выполните те же шаги, что и в предыдущем разделе, чтобы установить отношения доверия между порталом подключенной фабрики и сервером OPC UA.</span><span class="sxs-lookup"><span data-stu-id="6f656-168">Follow the same steps as in the preceding section to establish trust between the connected factory portal and the OPC UA server.</span></span> <span data-ttu-id="6f656-169">Этот шаг устанавливает взаимное доверие между сертификатами с портала подключенной фабрики и сервера OPC UA и создает подключение.</span><span class="sxs-lookup"><span data-stu-id="6f656-169">This step establishes a mutual trust of the certificates from the connected factory portal and the OPC UA server and creates a connection.</span></span>

1. <span data-ttu-id="6f656-170">Просмотрите дерево узлов сервера OPC UA, щелкните правой кнопкой мыши узлы OPC и выберите **Опубликовать**.</span><span class="sxs-lookup"><span data-stu-id="6f656-170">Browse the OPC UA nodes tree of your OPC UA server, right-click the OPC nodes, and select **publish**.</span></span> <span data-ttu-id="6f656-171">Чтобы публикация работала таким образом, сервер OPC UA и издатель должны находиться в одной сети.</span><span class="sxs-lookup"><span data-stu-id="6f656-171">For publishing to work this way, the OPC UA server and the publisher must be on the same network.</span></span> <span data-ttu-id="6f656-172">Другими словами, если полное доменное имя издателя — **publisher.mydomain.com**, то полное доменное имя сервера OPC UA должно быть, например, **myopcuaserver.mydomain.com**.</span><span class="sxs-lookup"><span data-stu-id="6f656-172">In other words, if the fully qualified domain name of the publisher is **publisher.mydomain.com** then the fully qualified domain name of the OPC UA server must be, for example, **myopcuaserver.mydomain.com**.</span></span> <span data-ttu-id="6f656-173">Если ваши настройки отличаются, можно вручную добавить узлы в файл publishesnodes.json, который находится в папке **D:\\docker**.</span><span class="sxs-lookup"><span data-stu-id="6f656-173">If your setup is different, you can manually add nodes to the publishesnodes.json file found in the **D:\\docker** folder.</span></span> <span data-ttu-id="6f656-174">Файл publishesnodes.json автоматически создается при первой успешной публикации узла OPC.</span><span class="sxs-lookup"><span data-stu-id="6f656-174">The publishesnodes.json file is automatically generated on the first successful publish of an OPC node.</span></span>

1. <span data-ttu-id="6f656-175">Телеметрия теперь поступает с устройства шлюза.</span><span class="sxs-lookup"><span data-stu-id="6f656-175">Telemetry now flows from the gateway device.</span></span> <span data-ttu-id="6f656-176">Данные телеметрии можно просмотреть в представлении **Factory Locations** (Расположения фабрик) портала подключенной фабрики в разделе **New Factory** (Новая фабрика).</span><span class="sxs-lookup"><span data-stu-id="6f656-176">You can view the telemetry in the **Factory Locations** view of the connected factory portal under **New Factory**.</span></span>

## <a name="linux-deployment"></a><span data-ttu-id="6f656-177">Развертывание в ОС Linux</span><span class="sxs-lookup"><span data-stu-id="6f656-177">Linux deployment</span></span>

> [!NOTE]
> <span data-ttu-id="6f656-178">Если у вас еще нет устройства шлюза, то корпорация Майкрософт рекомендует приобрести коммерческий шлюз у одного из наших партнеров.</span><span class="sxs-lookup"><span data-stu-id="6f656-178">If you don't yet have a gateway device, Microsoft recommends you buy a commercial gateway from one of our partners.</span></span> <span data-ttu-id="6f656-179">Посетите [каталог устройств Azure IoT], который содержит список устройств шлюза, совместимых с решением подключенной фабрики.</span><span class="sxs-lookup"><span data-stu-id="6f656-179">Visit the [Azure IoT device catalog] for a list of gateway devices compatible with the connected factory solution.</span></span> <span data-ttu-id="6f656-180">Настройте шлюз, следуя приложенным к устройству инструкциям.</span><span class="sxs-lookup"><span data-stu-id="6f656-180">Follow the instructions that come with the device to set up the gateway.</span></span> <span data-ttu-id="6f656-181">Также можно воспользоваться приведенными ниже инструкциями, чтобы вручную настроить один из существующих шлюзов.</span><span class="sxs-lookup"><span data-stu-id="6f656-181">Alternatively, use the following instructions to manually set up one of your existing gateways.</span></span>

<span data-ttu-id="6f656-182">[Установите Docker] на устройстве шлюза, работающем под управлением Linux.</span><span class="sxs-lookup"><span data-stu-id="6f656-182">[Install Docker] on your Linux gateway device.</span></span>

### <a name="configure-the-gateway"></a><span data-ttu-id="6f656-183">Настройка шлюза</span><span class="sxs-lookup"><span data-stu-id="6f656-183">Configure the gateway</span></span>

1. <span data-ttu-id="6f656-184">Для завершения развертывания шлюза необходима строка подключения **iothubowner** развертывания подключенной фабрики Azure IoT Suite.</span><span class="sxs-lookup"><span data-stu-id="6f656-184">You need the **iothubowner** connection string of your Azure IoT Suite connected factory deployment to complete the gateway deployment.</span></span> <span data-ttu-id="6f656-185">На [портале Azure] перейдите в Центр Интернета вещей в группе ресурсов, созданной при развертывании решения подключенной фабрики.</span><span class="sxs-lookup"><span data-stu-id="6f656-185">In the [Azure portal], navigate to your IoT Hub in the resource group created when you deployed the connected factory solution.</span></span> <span data-ttu-id="6f656-186">Щелкните **Политики общего доступа** для доступа к строке подключения **iothubowner**:</span><span class="sxs-lookup"><span data-stu-id="6f656-186">Click **Shared access policies** to access the **iothubowner** connection string:</span></span>

    ![Поиск строки подключения Центра Интернета вещей][img-hub-connection]

    <span data-ttu-id="6f656-188">Скопируйте значение поля **Строка подключения — первичный ключ**.</span><span class="sxs-lookup"><span data-stu-id="6f656-188">Copy the **Connection string--primary key** value.</span></span>

1. <span data-ttu-id="6f656-189">Настройте шлюз для своего Центра Интернета вещей. Для этого **один раз** запустите из оболочки два модуля шлюза, используя следующую команду:</span><span class="sxs-lookup"><span data-stu-id="6f656-189">Configure the gateway for your IoT Hub by running the two gateway modules **once** from a shell with:</span></span>

    `sudo docker run -it --rm -h <ApplicationName> -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/ -v /shared:/root/.dotnet/corefx/cryptography/x509stores microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName> "<IoTHubOwnerConnectionString>"`

    `sudo docker run --rm -it -v /shared:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -i -c "<IoTHubOwnerConnectionString>" -D /mapped/cs.db`

    * <span data-ttu-id="6f656-190">**&lt;ApplicationName&gt;** — это имя приложения OPC UA, которое шлюз создает в формате **publisher.&lt;ваше полное доменное имя&gt;**.</span><span class="sxs-lookup"><span data-stu-id="6f656-190">**&lt;ApplicationName&gt;** is the name of the OPC UA application the gateway creates in the format **publisher.&lt;your fully qualified domain name&gt;**.</span></span> <span data-ttu-id="6f656-191">Например, **publisher.microsoft.com**.</span><span class="sxs-lookup"><span data-stu-id="6f656-191">For example, **publisher.microsoft.com**.</span></span>
    * <span data-ttu-id="6f656-192">**&lt;IoTHubOwnerConnectionString&gt;** — это строка подключения **iothubowner**, которую вы скопировали на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="6f656-192">**&lt;IoTHubOwnerConnectionString&gt;** is the **iothubowner** connection string you copied in the previous step.</span></span> <span data-ttu-id="6f656-193">Эта строка подключения используется только на этом шаге и больше не потребуется.</span><span class="sxs-lookup"><span data-stu-id="6f656-193">This connection string is only used in this step, you don’t need it in the following steps:</span></span>

    <span data-ttu-id="6f656-194">В дальнейшем для хранения двух сертификатов X.509, используемых модулями шлюза, используется папка **/shared** (аргумент `-v`).</span><span class="sxs-lookup"><span data-stu-id="6f656-194">You use the **/shared** folder (the `-v` argument) later to persist the two X.509 certificates that the gateway modules use.</span></span>

### <a name="run-the-gateway"></a><span data-ttu-id="6f656-195">Запуск шлюза</span><span class="sxs-lookup"><span data-stu-id="6f656-195">Run the gateway</span></span>

1. <span data-ttu-id="6f656-196">Перезапустите шлюз с помощью следующих команд:</span><span class="sxs-lookup"><span data-stu-id="6f656-196">Restart the gateway using the following commands:</span></span>

    `sudo docker run -it -h <ApplicationName> --expose 62222 -p 62222:62222 –-rm -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/Logs -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v /shared:/shared -v /shared:/root/.dotnet/corefx/cryptography/x509stores -e _GW_PNFP="/shared/publishednodes.JSON" microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName>`

    `sudo docker run -it -v /shared:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -D /mapped/cs.db`

1. <span data-ttu-id="6f656-197">По соображениям безопасности два сертификата X.509, хранящиеся в папке **/shared**, содержат закрытый ключ.</span><span class="sxs-lookup"><span data-stu-id="6f656-197">For security reasons, the two X.509 certificates persisted in the **/shared** folder contain the private key.</span></span> <span data-ttu-id="6f656-198">Предоставьте доступ к этой папке только учетным данным, которые используются для запуска контейнера Docker.</span><span class="sxs-lookup"><span data-stu-id="6f656-198">Limit access to this folder to the credentials you use to run the Docker container.</span></span> <span data-ttu-id="6f656-199">Чтобы задать разрешения только для **корня**, используйте команду оболочки `chmod` для папки.</span><span class="sxs-lookup"><span data-stu-id="6f656-199">To set the permissions for **root** only, use the `chmod` shell command on the folder.</span></span>

1. <span data-ttu-id="6f656-200">Проверьте сетевое подключение.</span><span class="sxs-lookup"><span data-stu-id="6f656-200">Verify network connectivity.</span></span> <span data-ttu-id="6f656-201">В оболочке введите команду `ping publisher.<your fully qualified domain name>`, чтобы проверить связь со шлюзом.</span><span class="sxs-lookup"><span data-stu-id="6f656-201">From a shell, enter the command `ping publisher.<your fully qualified domain name>` to ping your gateway.</span></span> <span data-ttu-id="6f656-202">Если точка назначения недоступна, то добавьте IP-адрес и имя шлюза в файл hosts на шлюзе.</span><span class="sxs-lookup"><span data-stu-id="6f656-202">If the destination is unreachable, add the IP address and name of your gateway to your hosts file on your gateway.</span></span> <span data-ttu-id="6f656-203">Файл hosts находится в папке **/etc**.</span><span class="sxs-lookup"><span data-stu-id="6f656-203">The hosts file is located in the **/etc** folder.</span></span>

1. <span data-ttu-id="6f656-204">Затем попытайтесь подключиться к издателю, используя локальный клиент OPC UA, запущенный на шлюзе.</span><span class="sxs-lookup"><span data-stu-id="6f656-204">Next, try to connect to the publisher using a local OPC UA client running on the gateway.</span></span> <span data-ttu-id="6f656-205">URL-адрес конечной точки OPC UA — `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span><span class="sxs-lookup"><span data-stu-id="6f656-205">The OPC UA endpoint URL is `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span></span> <span data-ttu-id="6f656-206">Если у вас нет клиента OPC UA, скачайте и используйте [клиент OPC UA с открытым кодом].</span><span class="sxs-lookup"><span data-stu-id="6f656-206">If you don't have an OPC UA client, you can download and use an [open-source OPC UA client].</span></span>

1. <span data-ttu-id="6f656-207">После успешного выполнения этих локальных проверок перейдите на страницу **Connect your own OPC UA Server** (Подключение собственного сервера OPC UA) на портале решения подключенной фабрики.</span><span class="sxs-lookup"><span data-stu-id="6f656-207">When you have successfully completed these local tests, browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="6f656-208">Введите URL-адрес конечной точки издателя (`tcp://publisher.<your fully qualified domain name>:62222`) и нажмите кнопку **Подключить**.</span><span class="sxs-lookup"><span data-stu-id="6f656-208">Enter the publisher endpoint URL (`tcp://publisher.<your fully qualified domain name>:62222`) and click **Connect**.</span></span> <span data-ttu-id="6f656-209">После отображения предупреждения о сертификате щелкните **Продолжить**.</span><span class="sxs-lookup"><span data-stu-id="6f656-209">You get a certificate warning, then click **Proceed.**</span></span> <span data-ttu-id="6f656-210">Затем отобразится сообщение об ошибке, информирующее о том, что издатель не воспринимает веб-клиент UA как доверенный.</span><span class="sxs-lookup"><span data-stu-id="6f656-210">Next you get an error that the publisher doesn’t trust the UA Web Client.</span></span> <span data-ttu-id="6f656-211">Чтобы устранить эту ошибку, скопируйте сертификат **UA Web Client** из папки **/shared/Rejected Certificates/certs** в папку **/shared/UA Applications/certs** на шлюзе.</span><span class="sxs-lookup"><span data-stu-id="6f656-211">To resolve this error, copy the **UA Web Client** certificate from the **/shared/Rejected Certificates/certs** folder to the **/shared/UA Applications/certs** folder on the gateway.</span></span> <span data-ttu-id="6f656-212">Перезапускать шлюз не требуется.</span><span class="sxs-lookup"><span data-stu-id="6f656-212">You do not need to restart of the gateway.</span></span> <span data-ttu-id="6f656-213">Повторите этот шаг.</span><span class="sxs-lookup"><span data-stu-id="6f656-213">Repeat this step.</span></span> <span data-ttu-id="6f656-214">Теперь вы можете подключиться к шлюзу из облака, а также вы готовы добавить серверы OPC UA в решение.</span><span class="sxs-lookup"><span data-stu-id="6f656-214">You can now connect to the gateway from the cloud, and you are ready to add OPC UA servers to the solution.</span></span>

### <a name="add-your-opc-ua-servers"></a><span data-ttu-id="6f656-215">Добавление серверов OPC UA</span><span class="sxs-lookup"><span data-stu-id="6f656-215">Add your OPC UA servers</span></span>

1. <span data-ttu-id="6f656-216">Перейдите на страницу **Connect your own OPC UA Server** (Подключение собственного сервера OPC UA) на портале решения подключенной фабрики.</span><span class="sxs-lookup"><span data-stu-id="6f656-216">Browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="6f656-217">Выполните те же шаги, что и в предыдущем разделе, чтобы установить отношения доверия между порталом подключенной фабрики и сервером OPC UA.</span><span class="sxs-lookup"><span data-stu-id="6f656-217">Follow the same steps as in the preceding section to establish trust between the connected factory portal and the OPC UA server.</span></span> <span data-ttu-id="6f656-218">Этот шаг устанавливает взаимное доверие между сертификатами с портала подключенной фабрики и сервера OPC UA и создает подключение.</span><span class="sxs-lookup"><span data-stu-id="6f656-218">This step establishes a mutual trust of the certificates from the connected factory portal and the OPC UA server and creates a connection.</span></span>

1. <span data-ttu-id="6f656-219">Просмотрите дерево узлов сервера OPC UA, щелкните правой кнопкой мыши узлы OPC и выберите **Опубликовать**.</span><span class="sxs-lookup"><span data-stu-id="6f656-219">Browse the OPC UA nodes tree of your OPC UA server, right-click the OPC nodes, and select **publish**.</span></span> <span data-ttu-id="6f656-220">Чтобы публикация работала таким образом, сервер OPC UA и издатель должны находиться в одной сети.</span><span class="sxs-lookup"><span data-stu-id="6f656-220">For publishing to work this way, the OPC UA server and the publisher must be on the same network.</span></span> <span data-ttu-id="6f656-221">Другими словами, если полное доменное имя издателя — **publisher.mydomain.com**, то полное доменное имя сервера OPC UA должно быть, например, **myopcuaserver.mydomain.com**.</span><span class="sxs-lookup"><span data-stu-id="6f656-221">In other words, if the fully qualified domain name of the publisher is **publisher.mydomain.com** then the fully qualified domain name of the OPC UA server must be, for example, **myopcuaserver.mydomain.com**.</span></span> <span data-ttu-id="6f656-222">Если ваши настройки отличаются, можно вручную добавить узлы в файл publishesnodes.json, который находится в папке **/shared**.</span><span class="sxs-lookup"><span data-stu-id="6f656-222">If your setup is different, you can manually add nodes to the publishesnodes.json file found in the **/shared** folder.</span></span> <span data-ttu-id="6f656-223">Файл publishesnodes.json автоматически создается при первой успешной публикации узла OPC.</span><span class="sxs-lookup"><span data-stu-id="6f656-223">The publishesnodes.json is automatically generated on the first successful publish of an OPC node.</span></span>

1. <span data-ttu-id="6f656-224">Телеметрия теперь поступает с устройства шлюза.</span><span class="sxs-lookup"><span data-stu-id="6f656-224">Telemetry now flows from the gateway device.</span></span> <span data-ttu-id="6f656-225">Данные телеметрии можно просмотреть в представлении **Factory Locations** (Расположения фабрик) портала подключенной фабрики в разделе **New Factory** (Новая фабрика).</span><span class="sxs-lookup"><span data-stu-id="6f656-225">You can view the telemetry in the **Factory Locations** view of the connected factory portal under **New Factory**.</span></span>

## <a name="next-steps"></a><span data-ttu-id="6f656-226">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="6f656-226">Next steps</span></span>

<span data-ttu-id="6f656-227">Дополнительные сведения об архитектуре предварительно настроенного решения подключенной фабрики см. в статье [Общие сведения о наборе Azure IoT Suite][lnk-walkthrough].</span><span class="sxs-lookup"><span data-stu-id="6f656-227">To learn more about the architecture of the connected factory preconfigured solution, see [Connected factory preconfigured solution walkthrough][lnk-walkthrough].</span></span>

[img-install-docker]: ./media/iot-suite-connected-factory-gateway-deployment/image1.png
[img-hub-connection]: ./media/iot-suite-connected-factory-gateway-deployment/image2.png
[img-docker-share]: ./media/iot-suite-connected-factory-gateway-deployment/image3.png

<span data-ttu-id="6f656-228">[Docker для Windows]: https://www.docker.com/docker-windows</span><span class="sxs-lookup"><span data-stu-id="6f656-228">[Docker for Windows]: https://www.docker.com/docker-windows</span></span>
<span data-ttu-id="6f656-229">[каталог устройств Azure IoT]: https://catalog.azureiotsuite.com/?q=opc</span><span class="sxs-lookup"><span data-stu-id="6f656-229">[Azure IoT device catalog]: https://catalog.azureiotsuite.com/?q=opc</span></span>
<span data-ttu-id="6f656-230">[портале Azure]: http://portal.azure.com/</span><span class="sxs-lookup"><span data-stu-id="6f656-230">[Azure portal]: http://portal.azure.com/</span></span>
<span data-ttu-id="6f656-231">[клиент OPC UA с открытым кодом]: https://github.com/OPCFoundation/UA-.NETStandardLibrary/tree/master/SampleApplications/Samples/Client.Net4</span><span class="sxs-lookup"><span data-stu-id="6f656-231">[open-source OPC UA client]: https://github.com/OPCFoundation/UA-.NETStandardLibrary/tree/master/SampleApplications/Samples/Client.Net4</span></span>
<span data-ttu-id="6f656-232">[Установите Docker]: https://www.docker.com/community-edition#/download</span><span class="sxs-lookup"><span data-stu-id="6f656-232">[Install Docker]: https://www.docker.com/community-edition#/download</span></span>
[lnk-walkthrough]: iot-suite-connected-factory-sample-walkthrough.md
<span data-ttu-id="6f656-233">[Edge Интернета вещей Azure]: https://github.com/Azure/iot-edge (Edge Интернета вещей Azure)</span><span class="sxs-lookup"><span data-stu-id="6f656-233">[Azure IoT Edge]: https://github.com/Azure/iot-edge</span></span>

[lnk-publisher-github]: https://github.com/Azure/iot-edge-opc-publisher
[lnk-publisher-docker]: https://hub.docker.com/r/microsoft/iot-gateway-opc-ua
[lnk-proxy-github]: https://github.com/Azure/iot-edge-opc-proxy
[lnk-proxy-docker]: https://hub.docker.com/r/microsoft/iot-gateway-opc-ua-proxy
---
title: "пользовательские зондов подсистемы балансировки aaaLoad и мониторинга состояния работоспособности | Документы Microsoft"
description: "Узнайте, как пользовательские toouse проверяет наличие экземпляров toomonitor подсистемы балансировки нагрузки Azure за подсистемой балансировки нагрузки"
services: load-balancer
documentationcenter: na
author: kumudd
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 46b152c5-6a27-4bfc-bea3-05de9ce06a57
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/24/2016
ms.author: kumud
ms.openlocfilehash: 3dfcfcd2d5cffa58b160cb38d63acffbd997d452
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="understand-load-balancer-probes"></a><span data-ttu-id="174ab-103">Проверки балансировщика нагрузки</span><span class="sxs-lookup"><span data-stu-id="174ab-103">Understand load balancer probes</span></span>

<span data-ttu-id="174ab-104">Подсистема балансировки нагрузки Azure предлагает hello возможность toomonitor hello работоспособностью экземпляров серверов с использованием зонды.</span><span class="sxs-lookup"><span data-stu-id="174ab-104">Azure Load Balancer offers hello capability toomonitor hello health of server instances by using probes.</span></span> <span data-ttu-id="174ab-105">При сбое toorespond зонда подсистемы балансировки нагрузки перестает отправлять новый экземпляр неработоспособен toohello подключений.</span><span class="sxs-lookup"><span data-stu-id="174ab-105">When a probe fails toorespond, Load Balancer stops sending new connections toohello unhealthy instance.</span></span> <span data-ttu-id="174ab-106">существующие подключения Hello не затрагиваются и новые соединения отправляются toohealthy экземпляров.</span><span class="sxs-lookup"><span data-stu-id="174ab-106">hello existing connections are not affected, and new connections are sent toohealthy instances.</span></span>

<span data-ttu-id="174ab-107">Роли облачной службы (рабочие роли и веб-роли) используют гостевой агент для мониторинга проб.</span><span class="sxs-lookup"><span data-stu-id="174ab-107">Cloud service roles (worker roles and web roles) use a guest agent for probe monitoring.</span></span> <span data-ttu-id="174ab-108">При использовании виртуальных машин за балансировщиком нагрузки необходимо настроить пользовательские проверки TCP или HTTP.</span><span class="sxs-lookup"><span data-stu-id="174ab-108">TCP or HTTP custom probes must be configured when you use virtual machines behind Load Balancer.</span></span>

## <a name="understand-probe-count-and-timeout"></a><span data-ttu-id="174ab-109">Общие сведения о количестве проверок и времени ожидания</span><span class="sxs-lookup"><span data-stu-id="174ab-109">Understand probe count and timeout</span></span>

<span data-ttu-id="174ab-110">Поведение проверки зависит от следующих параметров:</span><span class="sxs-lookup"><span data-stu-id="174ab-110">Probe behavior depends on:</span></span>

* <span data-ttu-id="174ab-111">Число успешно датчики, позволяющие toobe экземпляра, помеченные как Hello.</span><span class="sxs-lookup"><span data-stu-id="174ab-111">hello number of successful probes that allow an instance toobe labeled as up.</span></span>
* <span data-ttu-id="174ab-112">Количество неудачных зондов, вызывающие toobe экземпляра с меткой нерабочими Hello.</span><span class="sxs-lookup"><span data-stu-id="174ab-112">hello number of failed probes that cause an instance toobe labeled as down.</span></span>

<span data-ttu-id="174ab-113">Hello тайм-аута и частота значение, заданное в SuccessFailCount определить, является ли экземпляр подтверждена toobe не выполняется или.</span><span class="sxs-lookup"><span data-stu-id="174ab-113">hello timeout and frequency value set in  SuccessFailCount determine whether an instance is confirmed toobe running or not running.</span></span> <span data-ttu-id="174ab-114">В hello портал Azure время ожидания hello задано значение hello раз tootwo частоты hello.</span><span class="sxs-lookup"><span data-stu-id="174ab-114">In hello Azure portal, hello timeout is set tootwo times hello value of hello frequency.</span></span>

<span data-ttu-id="174ab-115">Hello проверки конфигурации всех экземпляров с балансировкой нагрузки для конечной точки (то есть набор с балансировкой нагрузки), должна быть hello таким же.</span><span class="sxs-lookup"><span data-stu-id="174ab-115">hello probe configuration of all load-balanced instances for an endpoint (that is, a load-balanced set) must be hello same.</span></span> <span data-ttu-id="174ab-116">Это означает, что нельзя указать другой проверки конфигурации для каждого экземпляра роли или виртуальной машины в hello же размещенной службы для сочетания определенной конечной точкой.</span><span class="sxs-lookup"><span data-stu-id="174ab-116">This means you cannot have a different probe configuration for each role instance or virtual machine in hello same hosted service for a particular endpoint combination.</span></span> <span data-ttu-id="174ab-117">Например, каждый экземпляр должен иметь два одинаковых локальных порта и времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="174ab-117">For example, each instance must have identical local ports and timeouts.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="174ab-118">Зонд подсистемы балансировки нагрузки использует hello IP-адреса 168.63.129.16.</span><span class="sxs-lookup"><span data-stu-id="174ab-118">A Load Balancer probe uses hello IP address 168.63.129.16.</span></span> <span data-ttu-id="174ab-119">Этот общедоступный IP-адрес облегчает доступ к ресурсам платформы toointernal для hello перевести your владельцем-IP-адреса сценария Azure виртуальной сети.</span><span class="sxs-lookup"><span data-stu-id="174ab-119">This public IP address facilitates communication toointernal platform resources for hello bring-your-own-IP Azure Virtual Network scenario.</span></span> <span data-ttu-id="174ab-120">Hello виртуальный открытый IP-адреса 168.63.129.16 используется во всех регионах и не меняется.</span><span class="sxs-lookup"><span data-stu-id="174ab-120">hello virtual public IP address 168.63.129.16 is used in all regions and will not change.</span></span> <span data-ttu-id="174ab-121">Рекомендуется разрешить этот IP-адрес во всех политиках локального брандмауэра.</span><span class="sxs-lookup"><span data-stu-id="174ab-121">We recommend that you allow this IP address in any local firewall policies.</span></span> <span data-ttu-id="174ab-122">Он не должен рассматриваться угрозу безопасности, так как только hello внутренней платформы Azure может получать сообщения с этого адреса.</span><span class="sxs-lookup"><span data-stu-id="174ab-122">It should not be considered a security risk because only hello internal Azure platform can source a message from that address.</span></span> <span data-ttu-id="174ab-123">Если этого не сделать, будет непредвиденное поведение в различных сценариях, как настройка hello же диапазон IP-адресов 168.63.129.16 и повторяющийся IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="174ab-123">If you do not do this, there will be unexpected behavior in a variety of scenarios like configuring hello same IP address range of 168.63.129.16 and having duplicated IP addresses.</span></span>

## <a name="learn-about-hello-types-of-probes"></a><span data-ttu-id="174ab-124">Сведения о типах hello зонды</span><span class="sxs-lookup"><span data-stu-id="174ab-124">Learn about hello types of probes</span></span>

### <a name="guest-agent-probe"></a><span data-ttu-id="174ab-125">Проверка гостевого агента</span><span class="sxs-lookup"><span data-stu-id="174ab-125">Guest agent probe</span></span>

<span data-ttu-id="174ab-126">Эта проверка доступна только для облачных служб Azure.</span><span class="sxs-lookup"><span data-stu-id="174ab-126">This probe is available for Azure Cloud Services only.</span></span> <span data-ttu-id="174ab-127">Подсистема балансировки нагрузки использует hello агент гостевой виртуальной машине hello и прослушивает и отвечает только тогда, когда hello ответ HTTP 200 OK экземпляр находится в состоянии готовности hello (то есть в другом состоянии например Busy, повторный запуск или остановка).</span><span class="sxs-lookup"><span data-stu-id="174ab-127">Load Balancer utilizes hello guest agent inside hello virtual machine, and then listens and responds with an HTTP 200 OK response only when hello instance is in hello Ready state (that is, not in another state such as Busy, Recycling, or Stopping).</span></span>

<span data-ttu-id="174ab-128">Дополнительные сведения см. в разделе [Настройка hello файл определения службы (csdef) для проверки работоспособности](https://msdn.microsoft.com/library/azure/ee758710.aspx) или [приступить к созданию балансировки нагрузки с выходом в Интернет для облачных служб](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span><span class="sxs-lookup"><span data-stu-id="174ab-128">For more information, see [Configuring hello service definition file (csdef) for health probes](https://msdn.microsoft.com/library/azure/ee758710.aspx) or [Get started creating an Internet-facing load balancer for cloud services](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span></span>

### <a name="what-makes-a-guest-agent-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="174ab-129">В каком случае проверка гостевого агента отметит экземпляр как неработоспособный?</span><span class="sxs-lookup"><span data-stu-id="174ab-129">What makes a guest agent probe mark an instance as unhealthy?</span></span>

<span data-ttu-id="174ab-130">При сбое toorespond с HTTP 200 OK hello гостевого агента метки подсистемы балансировки нагрузки hello hello экземпляра не отвечает и отправке трафика toothat экземпляр останавливается.</span><span class="sxs-lookup"><span data-stu-id="174ab-130">If hello guest agent fails toorespond with HTTP 200 OK, hello load balancer marks hello instance as unresponsive and stops sending traffic toothat instance.</span></span> <span data-ttu-id="174ab-131">Подсистема балансировки нагрузки Hello продолжается tooping hello экземпляра.</span><span class="sxs-lookup"><span data-stu-id="174ab-131">hello load balancer continues tooping hello instance.</span></span> <span data-ttu-id="174ab-132">Если hello агент даст ответ HTTP 200, балансировки нагрузки hello снова отправляет трафик toothat экземпляра.</span><span class="sxs-lookup"><span data-stu-id="174ab-132">If hello guest agent responds with an HTTP 200, hello load balancer sends traffic toothat instance again.</span></span>

<span data-ttu-id="174ab-133">При использовании веб-роли код hello веб-сайта обычно выполняется в w3wp.exe, который не отслеживается hello фабрики Azure или гостевого агента.</span><span class="sxs-lookup"><span data-stu-id="174ab-133">When you use a web role, hello website code typically runs in w3wp.exe, which is not monitored by hello Azure fabric or guest agent.</span></span> <span data-ttu-id="174ab-134">Это означает, что ошибки в w3wp.exe (например, ответы HTTP 500) не будет обнаруженную toohello гостевого агента, а hello балансировки нагрузки не будет этот экземпляр из ротации.</span><span class="sxs-lookup"><span data-stu-id="174ab-134">This means that failures in w3wp.exe (for example, HTTP 500 responses) will not be reported toohello guest agent, and hello load balancer will not take that instance out of rotation.</span></span>

### <a name="http-custom-probe"></a><span data-ttu-id="174ab-135">Пользовательская проверка HTTP</span><span class="sxs-lookup"><span data-stu-id="174ab-135">HTTP custom probe</span></span>

<span data-ttu-id="174ab-136">пользовательский зонд подсистемы балансировки нагрузки HTTP Hello переопределяет зонд гостевого агента hello по умолчанию, это означает, что можно создать собственную пользовательскую логику toodetermine hello работоспособности экземпляра роли hello.</span><span class="sxs-lookup"><span data-stu-id="174ab-136">hello custom HTTP Load Balancer probe overrides hello default guest agent probe, which means that you can create your own custom logic toodetermine hello health of hello role instance.</span></span> <span data-ttu-id="174ab-137">Подсистема балансировки нагрузки Hello зондами каждые 15 секунд конечной точки по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="174ab-137">hello load balancer probes your endpoint every 15 seconds, by default.</span></span> <span data-ttu-id="174ab-138">экземпляр Hello считается toobe в hello балансировки нагрузки, если ответ HTTP 200 в течение периода ожидания hello (31 секунды по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="174ab-138">hello instance is considered toobe in hello load balancer rotation if it responds with an HTTP 200 within hello timeout period (31 seconds by default).</span></span>

<span data-ttu-id="174ab-139">Это может быть полезно использовать tooimplement экземпляров tooremove собственную логику из балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="174ab-139">This can be useful if you want tooimplement your own logic tooremove instances from load balancer rotation.</span></span> <span data-ttu-id="174ab-140">Например можно принять решение tooremove экземпляра, если он превышает 90% загрузки ЦП и возвращает статус отличный от 200.</span><span class="sxs-lookup"><span data-stu-id="174ab-140">For example, you could decide tooremove an instance if it is above 90% CPU and returns a non-200 status.</span></span> <span data-ttu-id="174ab-141">Если у вас есть веб-ролей, использующих w3wp.exe, это также означает, вы получаете автоматический мониторинг веб-сайта, так как ошибки в коде веб-сайт возвращают зонд подсистемы балансировки нагрузки toohello состояние отличный от 200.</span><span class="sxs-lookup"><span data-stu-id="174ab-141">If you have web roles that use w3wp.exe, this also means you get automatic monitoring of your website, because failures in your website code will return a non-200 status toohello load balancer probe.</span></span>

> [!NOTE]
> <span data-ttu-id="174ab-142">пользовательский зонд Hello HTTP поддерживает относительные пути и только для протокола HTTP.</span><span class="sxs-lookup"><span data-stu-id="174ab-142">hello HTTP custom probe supports relative paths and HTTP protocol only.</span></span> <span data-ttu-id="174ab-143">HTTPS не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="174ab-143">HTTPS is not supported.</span></span>

### <a name="what-makes-an-http-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="174ab-144">В каком случае пользовательская проверка HTTP отметит экземпляр как неработоспособный?</span><span class="sxs-lookup"><span data-stu-id="174ab-144">What makes an HTTP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="174ab-145">Hello приложения HTTP возвращает код ответа HTTP, отличным от 200 (например, 403, 404 или 500).</span><span class="sxs-lookup"><span data-stu-id="174ab-145">hello HTTP application returns an HTTP response code other than 200 (for example, 403, 404, or 500).</span></span> <span data-ttu-id="174ab-146">Это подтверждающее, приложение hello экземпляра следует вывести из обслуживания прямо сейчас.</span><span class="sxs-lookup"><span data-stu-id="174ab-146">This is a positive acknowledgment that hello application instance should be taken out of service right away.</span></span>
* <span data-ttu-id="174ab-147">Hello HTTP-сервер не отвечает на всех после периода ожидания hello.</span><span class="sxs-lookup"><span data-stu-id="174ab-147">hello HTTP server does not respond at all after hello timeout period.</span></span> <span data-ttu-id="174ab-148">В зависимости от значения времени ожидания hello, имеет значение, это может означать, несколько зонд запрашивает go без ответа перед hello зонд получает помечен как не выполняется (то есть до SuccessFailCount зонды отправляются).</span><span class="sxs-lookup"><span data-stu-id="174ab-148">Depending on hello timeout value that is set, this might mean that multiple probe requests go unanswered before hello probe gets marked as not running (that is, before SuccessFailCount probes are sent).</span></span>
* <span data-ttu-id="174ab-149">Hello сервера закрывает соединение hello через TCP reset.</span><span class="sxs-lookup"><span data-stu-id="174ab-149">hello server closes hello connection via a TCP reset.</span></span>

### <a name="tcp-custom-probe"></a><span data-ttu-id="174ab-150">Пользовательская проверка TCP</span><span class="sxs-lookup"><span data-stu-id="174ab-150">TCP custom probe</span></span>

<span data-ttu-id="174ab-151">TCP-зонды инициировать подключение, выполнив трехэтапного hello определенный порт.</span><span class="sxs-lookup"><span data-stu-id="174ab-151">TCP probes initiate a connection by performing a three-way handshake with hello defined port.</span></span>

### <a name="what-makes-a-tcp-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="174ab-152">В каком случае пользовательская проверка TCP отметит экземпляр как неработоспособный?</span><span class="sxs-lookup"><span data-stu-id="174ab-152">What makes a TCP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="174ab-153">Hello TCP сервер не отвечает на всех после периода ожидания hello.</span><span class="sxs-lookup"><span data-stu-id="174ab-153">hello TCP server does not respond at all after hello timeout period.</span></span> <span data-ttu-id="174ab-154">При проверки hello не будет помечена как не запущена зависит от hello количество неудачных пробных запросы, которые были настроенных toogo без ответа, прежде чем помечать hello проверки не выполняется.</span><span class="sxs-lookup"><span data-stu-id="174ab-154">When hello probe is marked as not running depends on hello number of failed probe requests that were configured toogo unanswered before marking hello probe as not running.</span></span>
* <span data-ttu-id="174ab-155">Hello зонд получает TCP, восстановить из экземпляра роли hello.</span><span class="sxs-lookup"><span data-stu-id="174ab-155">hello probe receives a TCP reset from hello role instance.</span></span>

<span data-ttu-id="174ab-156">Дополнительные сведения о настройке пробы работоспособности HTTP или пробы TCP см. в статье [Создание балансировщика нагрузки для Интернета в Resource Manager с помощью PowerShell](load-balancer-get-started-internet-arm-ps.md).</span><span class="sxs-lookup"><span data-stu-id="174ab-156">For more information about configuring an HTTP health probe or a TCP probe, see [Get started creating an Internet-facing load balancer in Resource Manager using PowerShell](load-balancer-get-started-internet-arm-ps.md).</span></span>

## <a name="add-healthy-instances-back-into-load-balancer-rotation"></a><span data-ttu-id="174ab-157">Добавление работоспособных экземпляров в смену подсистемы балансировки нагрузки</span><span class="sxs-lookup"><span data-stu-id="174ab-157">Add healthy instances back into load balancer rotation</span></span>

<span data-ttu-id="174ab-158">Проверки TCP и HTTP считаются Исправен и пометить hello экземпляра роли, что если работоспособности:</span><span class="sxs-lookup"><span data-stu-id="174ab-158">TCP and HTTP probes are considered healthy and mark hello role instance as healthy when:</span></span>

* <span data-ttu-id="174ab-159">Подсистема балансировки нагрузки Hello возвращает положительное пробы hello первого времени hello загрузке виртуальной Машины.</span><span class="sxs-lookup"><span data-stu-id="174ab-159">hello load balancer gets a positive probe hello first time hello VM boots.</span></span>
* <span data-ttu-id="174ab-160">Номер Hello SuccessFailCount (описанную ранее) определяет значение hello успешно зондов, экземпляр роли требуется toomark hello работоспособен.</span><span class="sxs-lookup"><span data-stu-id="174ab-160">hello number SuccessFailCount (described earlier) defines hello value of successful probes that are required toomark hello role instance as healthy.</span></span> <span data-ttu-id="174ab-161">Если экземпляр роли был удален, hello число проб успешной, последующие равняться или превышать значение hello экземпляра SuccessFailCount toomark hello роли как запущенные.</span><span class="sxs-lookup"><span data-stu-id="174ab-161">If a role instance was removed, hello number of successful, successive probes must equal or exceed hello value of SuccessFailCount toomark hello role instance as running.</span></span>

> [!NOTE]
> <span data-ttu-id="174ab-162">Если нагрузка колеблется hello работоспособности экземпляра роли, подсистемы балансировки нагрузки hello больше ожидает перед добавлением экземпляра роли hello обратно в работоспособное состояние hello.</span><span class="sxs-lookup"><span data-stu-id="174ab-162">If hello health of a role instance is fluctuating, hello load balancer waits longer before putting hello role instance back in hello healthy state.</span></span> <span data-ttu-id="174ab-163">Это делается посредством пользователь hello tooprotect политики и инфраструктуры hello.</span><span class="sxs-lookup"><span data-stu-id="174ab-163">This is done via policy tooprotect hello user and hello infrastructure.</span></span>

## <a name="use-log-analytics-for-load-balancer"></a><span data-ttu-id="174ab-164">Использование службы анализа журналов для балансировщика нагрузки</span><span class="sxs-lookup"><span data-stu-id="174ab-164">Use log analytics for Load Balancer</span></span>

<span data-ttu-id="174ab-165">Можно использовать [аналитика журналов для подсистемы балансировки нагрузки](load-balancer-monitor-log.md) toocheck на hello проверки работоспособности состояния и пробы count.</span><span class="sxs-lookup"><span data-stu-id="174ab-165">You can use [log analytics for Load Balancer](load-balancer-monitor-log.md) toocheck on hello probe health status and probe count.</span></span> <span data-ttu-id="174ab-166">Ведение журналов может использоваться с Power BI или оперативной аналитики Azure tooprovide статистические данные о состоянии работоспособности подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="174ab-166">Logging can be used with Power BI or Azure Operational Insights tooprovide statistics about Load Balancer health status.</span></span>

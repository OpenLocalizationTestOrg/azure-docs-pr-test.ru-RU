---
title: "Пользовательские проверки балансировщика нагрузки и мониторинг состояния работоспособности | Документация Майкрософт"
description: "Узнайте, как выполнять мониторинг экземпляров за балансировщиком нагрузки с помощью пользовательских проверок для балансировщика нагрузки Azure"
services: load-balancer
documentationcenter: na
author: kumudd
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 46b152c5-6a27-4bfc-bea3-05de9ce06a57
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/24/2016
ms.author: kumud
ms.openlocfilehash: cab028fed58d544a56f2f6b12b72364c7baf4d86
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="understand-load-balancer-probes"></a><span data-ttu-id="7ab10-103">Проверки балансировщика нагрузки</span><span class="sxs-lookup"><span data-stu-id="7ab10-103">Understand load balancer probes</span></span>

<span data-ttu-id="7ab10-104">Балансировщик нагрузки Azure позволяет отслеживать работоспособность различных экземпляров сервера с помощью проверок.</span><span class="sxs-lookup"><span data-stu-id="7ab10-104">Azure Load Balancer offers the capability to monitor the health of server instances by using probes.</span></span> <span data-ttu-id="7ab10-105">Если проверка не отвечает, балансировщик нагрузки Azure прекращает отправлять новое подключение неработоспособным экземплярам.</span><span class="sxs-lookup"><span data-stu-id="7ab10-105">When a probe fails to respond, Load Balancer stops sending new connections to the unhealthy instance.</span></span> <span data-ttu-id="7ab10-106">Существующие подключения не затрагиваются, а новые подключения отправляются в работоспособные экземпляры.</span><span class="sxs-lookup"><span data-stu-id="7ab10-106">The existing connections are not affected, and new connections are sent to healthy instances.</span></span>

<span data-ttu-id="7ab10-107">Роли облачной службы (рабочие роли и веб-роли) используют гостевой агент для мониторинга проб.</span><span class="sxs-lookup"><span data-stu-id="7ab10-107">Cloud service roles (worker roles and web roles) use a guest agent for probe monitoring.</span></span> <span data-ttu-id="7ab10-108">При использовании виртуальных машин за балансировщиком нагрузки необходимо настроить пользовательские проверки TCP или HTTP.</span><span class="sxs-lookup"><span data-stu-id="7ab10-108">TCP or HTTP custom probes must be configured when you use virtual machines behind Load Balancer.</span></span>

## <a name="understand-probe-count-and-timeout"></a><span data-ttu-id="7ab10-109">Общие сведения о количестве проверок и времени ожидания</span><span class="sxs-lookup"><span data-stu-id="7ab10-109">Understand probe count and timeout</span></span>

<span data-ttu-id="7ab10-110">Поведение проверки зависит от следующих параметров:</span><span class="sxs-lookup"><span data-stu-id="7ab10-110">Probe behavior depends on:</span></span>

* <span data-ttu-id="7ab10-111">Количество успешных проверок, достаточное для того, чтобы пометить экземпляр как работоспособный.</span><span class="sxs-lookup"><span data-stu-id="7ab10-111">The number of successful probes that allow an instance to be labeled as up.</span></span>
* <span data-ttu-id="7ab10-112">Количество неудачных проверок, достаточное для того, чтобы пометить экземпляр как неработоспособный.</span><span class="sxs-lookup"><span data-stu-id="7ab10-112">The number of failed probes that cause an instance to be labeled as down.</span></span>

<span data-ttu-id="7ab10-113">Время ожидания и частота, заданные в SuccessFailCount, определяют, считается ли экземпляр запущенным или незапущенным.</span><span class="sxs-lookup"><span data-stu-id="7ab10-113">The timeout and frequency value set in  SuccessFailCount determine whether an instance is confirmed to be running or not running.</span></span> <span data-ttu-id="7ab10-114">На портале Azure в качестве значения времени ожидания задается удвоенное значение частоты.</span><span class="sxs-lookup"><span data-stu-id="7ab10-114">In the Azure portal, the timeout is set to two times the value of the frequency.</span></span>

<span data-ttu-id="7ab10-115">Все экземпляры с балансировкой нагрузки для конечной точки (набор с балансировкой нагрузки) должны иметь одинаковую конфигурацию проверки.</span><span class="sxs-lookup"><span data-stu-id="7ab10-115">The probe configuration of all load-balanced instances for an endpoint (that is, a load-balanced set) must be the same.</span></span> <span data-ttu-id="7ab10-116">Это значит, что нельзя иметь различную конфигурацию проверок для каждого экземпляра роли или виртуальной машины в одной и той же размещенной службе для конкретного сочетания конечных точек.</span><span class="sxs-lookup"><span data-stu-id="7ab10-116">This means you cannot have a different probe configuration for each role instance or virtual machine in the same hosted service for a particular endpoint combination.</span></span> <span data-ttu-id="7ab10-117">Например, каждый экземпляр должен иметь два одинаковых локальных порта и времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="7ab10-117">For example, each instance must have identical local ports and timeouts.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="7ab10-118">Проверка балансировщика нагрузки использует IP-адрес 168.63.129.16.</span><span class="sxs-lookup"><span data-stu-id="7ab10-118">A Load Balancer probe uses the IP address 168.63.129.16.</span></span> <span data-ttu-id="7ab10-119">Этот общедоступный IP-адрес упрощает взаимодействие с ресурсами внутренней платформы при использовании виртуальной сети Azure с собственным IP-адресом.</span><span class="sxs-lookup"><span data-stu-id="7ab10-119">This public IP address facilitates communication to internal platform resources for the bring-your-own-IP Azure Virtual Network scenario.</span></span> <span data-ttu-id="7ab10-120">Общедоступный виртуальный IP-адрес 168.63.129.16 действует во всех регионах и не изменяется.</span><span class="sxs-lookup"><span data-stu-id="7ab10-120">The virtual public IP address 168.63.129.16 is used in all regions and will not change.</span></span> <span data-ttu-id="7ab10-121">Рекомендуется разрешить этот IP-адрес во всех политиках локального брандмауэра.</span><span class="sxs-lookup"><span data-stu-id="7ab10-121">We recommend that you allow this IP address in any local firewall policies.</span></span> <span data-ttu-id="7ab10-122">Этот адрес не должен считаться угрозой для безопасности, так как источником сообщений с него может быть только внутренняя платформа Azure.</span><span class="sxs-lookup"><span data-stu-id="7ab10-122">It should not be considered a security risk because only the internal Azure platform can source a message from that address.</span></span> <span data-ttu-id="7ab10-123">Если этого не сделать, возникнет непредвиденное поведение в различных сценариях, например, настройка того же диапазона IP-адресов 168.63.129.16 и наличие повторяющихся IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="7ab10-123">If you do not do this, there will be unexpected behavior in a variety of scenarios like configuring the same IP address range of 168.63.129.16 and having duplicated IP addresses.</span></span>

## <a name="learn-about-the-types-of-probes"></a><span data-ttu-id="7ab10-124">Сведения о типах проверки</span><span class="sxs-lookup"><span data-stu-id="7ab10-124">Learn about the types of probes</span></span>

### <a name="guest-agent-probe"></a><span data-ttu-id="7ab10-125">Проверка гостевого агента</span><span class="sxs-lookup"><span data-stu-id="7ab10-125">Guest agent probe</span></span>

<span data-ttu-id="7ab10-126">Эта проверка доступна только для облачных служб Azure.</span><span class="sxs-lookup"><span data-stu-id="7ab10-126">This probe is available for Azure Cloud Services only.</span></span> <span data-ttu-id="7ab10-127">Подсистема балансировки нагрузки использует гостевой агент в виртуальной машине и затем выполняет прослушивание и отправляет ответ HTTP с кодом 200 (OK), только когда экземпляр находится в состоянии "Готов" (т. е. экземпляр не находится в другом состоянии, таком как "Занят", "Перезапуск" или "Остановка").</span><span class="sxs-lookup"><span data-stu-id="7ab10-127">Load Balancer utilizes the guest agent inside the virtual machine, and then listens and responds with an HTTP 200 OK response only when the instance is in the Ready state (that is, not in another state such as Busy, Recycling, or Stopping).</span></span>

<span data-ttu-id="7ab10-128">Дополнительные сведения см. в статьях [Azure Service Configuration Schema (.cscfg File)](https://msdn.microsoft.com/library/azure/ee758710.aspx) (Схема конфигурации службы Azure (CSCFG-файл)) и [Приступая к работе по созданию балансировщика нагрузки для Интернета для облачных служб](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span><span class="sxs-lookup"><span data-stu-id="7ab10-128">For more information, see [Configuring the service definition file (csdef) for health probes](https://msdn.microsoft.com/library/azure/ee758710.aspx) or [Get started creating an Internet-facing load balancer for cloud services](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span></span>

### <a name="what-makes-a-guest-agent-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="7ab10-129">В каком случае проверка гостевого агента отметит экземпляр как неработоспособный?</span><span class="sxs-lookup"><span data-stu-id="7ab10-129">What makes a guest agent probe mark an instance as unhealthy?</span></span>

<span data-ttu-id="7ab10-130">Если гостевой агент не отправляет ответ HTTP с кодом 200 (ОК), подсистема балансировки нагрузки отмечает экземпляр как неработоспособный и перестает отправлять к нему трафик.</span><span class="sxs-lookup"><span data-stu-id="7ab10-130">If the guest agent fails to respond with HTTP 200 OK, the load balancer marks the instance as unresponsive and stops sending traffic to that instance.</span></span> <span data-ttu-id="7ab10-131">Балансировщик нагрузки продолжит проверять связь с этим экземпляром.</span><span class="sxs-lookup"><span data-stu-id="7ab10-131">The load balancer continues to ping the instance.</span></span> <span data-ttu-id="7ab10-132">Если гостевой агент отправляет ответ HTTP с кодом 200 (ОК), подсистема балансировки нагрузки снова начинает отправлять трафик к этому экземпляру.</span><span class="sxs-lookup"><span data-stu-id="7ab10-132">If the guest agent responds with an HTTP 200, the load balancer sends traffic to that instance again.</span></span>

<span data-ttu-id="7ab10-133">При использовании веб-роли код веб-сайта обычно выполняется в процессе w3wp.exe, который не отслеживается структурой Azure или гостевым агентом.</span><span class="sxs-lookup"><span data-stu-id="7ab10-133">When you use a web role, the website code typically runs in w3wp.exe, which is not monitored by the Azure fabric or guest agent.</span></span> <span data-ttu-id="7ab10-134">Это означает, что ошибки в процессе w3wp.exe (например, ответы HTTP с кодом 500) не будут передаваться гостевому агенту и подсистема балансировки нагрузки не узнает о том, что экземпляр перестал использоваться.</span><span class="sxs-lookup"><span data-stu-id="7ab10-134">This means that failures in w3wp.exe (for example, HTTP 500 responses) will not be reported to the guest agent, and the load balancer will not take that instance out of rotation.</span></span>

### <a name="http-custom-probe"></a><span data-ttu-id="7ab10-135">Пользовательская проверка HTTP</span><span class="sxs-lookup"><span data-stu-id="7ab10-135">HTTP custom probe</span></span>

<span data-ttu-id="7ab10-136">Пользовательская проверка балансировщика нагрузки HTTP переопределяет проверку гостевого агента по умолчанию и позволяет создать собственную пользовательскую логику для определения работоспособности экземпляра роли.</span><span class="sxs-lookup"><span data-stu-id="7ab10-136">The custom HTTP Load Balancer probe overrides the default guest agent probe, which means that you can create your own custom logic to determine the health of the role instance.</span></span> <span data-ttu-id="7ab10-137">Подсистема балансировки нагрузки по умолчанию проверяет конечную точку каждые 15 секунд.</span><span class="sxs-lookup"><span data-stu-id="7ab10-137">The load balancer probes your endpoint every 15 seconds, by default.</span></span> <span data-ttu-id="7ab10-138">Считается, что экземпляр используется подсистемой балансировки нагрузки, если он дает ответ HTTP с кодом 200 в течение времени ожидания (по умолчанию 31 секунда).</span><span class="sxs-lookup"><span data-stu-id="7ab10-138">The instance is considered to be in the load balancer rotation if it responds with an HTTP 200 within the timeout period (31 seconds by default).</span></span>

<span data-ttu-id="7ab10-139">Это может быть полезно для реализации собственной логики для удаления экземпляров из смены подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="7ab10-139">This can be useful if you want to implement your own logic to remove instances from load balancer rotation.</span></span> <span data-ttu-id="7ab10-140">Например, можно удалить экземпляр, если он использует более 90 % ресурсов ЦП и возвращает состояние, отличное от кода 200.</span><span class="sxs-lookup"><span data-stu-id="7ab10-140">For example, you could decide to remove an instance if it is above 90% CPU and returns a non-200 status.</span></span> <span data-ttu-id="7ab10-141">Для веб-ролей, использующих w3wp.exe, также предоставляется автоматический мониторинг веб-сайта, так как при возникновении ошибок в коде веб-сайта пробе подсистемы балансировки нагрузки будет возвращено состояние, отличное от 200.</span><span class="sxs-lookup"><span data-stu-id="7ab10-141">If you have web roles that use w3wp.exe, this also means you get automatic monitoring of your website, because failures in your website code will return a non-200 status to the load balancer probe.</span></span>

> [!NOTE]
> <span data-ttu-id="7ab10-142">Пользовательская проверка HTTP поддерживает относительные пути и только HTTP-протокол.</span><span class="sxs-lookup"><span data-stu-id="7ab10-142">The HTTP custom probe supports relative paths and HTTP protocol only.</span></span> <span data-ttu-id="7ab10-143">HTTPS не поддерживается.</span><span class="sxs-lookup"><span data-stu-id="7ab10-143">HTTPS is not supported.</span></span>

### <a name="what-makes-an-http-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="7ab10-144">В каком случае пользовательская проверка HTTP отметит экземпляр как неработоспособный?</span><span class="sxs-lookup"><span data-stu-id="7ab10-144">What makes an HTTP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="7ab10-145">Приложение HTTP возвращает код ответа HTTP, отличный от 200 (например 403, 404 или 500).</span><span class="sxs-lookup"><span data-stu-id="7ab10-145">The HTTP application returns an HTTP response code other than 200 (for example, 403, 404, or 500).</span></span> <span data-ttu-id="7ab10-146">Это означает, что экземпляр приложения необходимо вывести из использования прямо сейчас.</span><span class="sxs-lookup"><span data-stu-id="7ab10-146">This is a positive acknowledgment that the application instance should be taken out of service right away.</span></span>
* <span data-ttu-id="7ab10-147">HTTP-сервер вообще не отвечает по истечении времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="7ab10-147">The HTTP server does not respond at all after the timeout period.</span></span> <span data-ttu-id="7ab10-148">В зависимости от установленного времени ожидания это может означать, что множество запросов на проверку остаются без ответа, перед тем как проверка отмечает экземпляр как неработоспособный (то есть перед отправкой количества проверок, равного SuccessFailCount).</span><span class="sxs-lookup"><span data-stu-id="7ab10-148">Depending on the timeout value that is set, this might mean that multiple probe requests go unanswered before the probe gets marked as not running (that is, before SuccessFailCount probes are sent).</span></span>
* <span data-ttu-id="7ab10-149">Сервер закрывает подключение путем сброса TCP-соединения.</span><span class="sxs-lookup"><span data-stu-id="7ab10-149">The server closes the connection via a TCP reset.</span></span>

### <a name="tcp-custom-probe"></a><span data-ttu-id="7ab10-150">Пользовательская проверка TCP</span><span class="sxs-lookup"><span data-stu-id="7ab10-150">TCP custom probe</span></span>

<span data-ttu-id="7ab10-151">Проверки TCP инициализируют подключение, выполняя трехстороннее подтверждение на определенном порту.</span><span class="sxs-lookup"><span data-stu-id="7ab10-151">TCP probes initiate a connection by performing a three-way handshake with the defined port.</span></span>

### <a name="what-makes-a-tcp-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="7ab10-152">В каком случае пользовательская проверка TCP отметит экземпляр как неработоспособный?</span><span class="sxs-lookup"><span data-stu-id="7ab10-152">What makes a TCP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="7ab10-153">TCP-сервер вообще не отвечает по истечении времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="7ab10-153">The TCP server does not respond at all after the timeout period.</span></span> <span data-ttu-id="7ab10-154">Когда проверка отмечена как неработоспособная в зависимости от количества неудачных запросов на проверку, достаточного для того, чтобы проверка была помечена как неработоспособная.</span><span class="sxs-lookup"><span data-stu-id="7ab10-154">When the probe is marked as not running depends on the number of failed probe requests that were configured to go unanswered before marking the probe as not running.</span></span>
* <span data-ttu-id="7ab10-155">Проверка получает сброс TCP-соединения от экземпляра роли.</span><span class="sxs-lookup"><span data-stu-id="7ab10-155">The probe receives a TCP reset from the role instance.</span></span>

<span data-ttu-id="7ab10-156">Дополнительные сведения о настройке пробы работоспособности HTTP или пробы TCP см. в статье [Создание балансировщика нагрузки для Интернета в Resource Manager с помощью PowerShell](load-balancer-get-started-internet-arm-ps.md).</span><span class="sxs-lookup"><span data-stu-id="7ab10-156">For more information about configuring an HTTP health probe or a TCP probe, see [Get started creating an Internet-facing load balancer in Resource Manager using PowerShell](load-balancer-get-started-internet-arm-ps.md).</span></span>

## <a name="add-healthy-instances-back-into-load-balancer-rotation"></a><span data-ttu-id="7ab10-157">Добавление работоспособных экземпляров в смену подсистемы балансировки нагрузки</span><span class="sxs-lookup"><span data-stu-id="7ab10-157">Add healthy instances back into load balancer rotation</span></span>

<span data-ttu-id="7ab10-158">Проверки TCP и HTTP считаются допустимыми и отмечают экземпляр роли как работоспособный в следующих случаях:</span><span class="sxs-lookup"><span data-stu-id="7ab10-158">TCP and HTTP probes are considered healthy and mark the role instance as healthy when:</span></span>

* <span data-ttu-id="7ab10-159">Подсистема балансировки нагрузки получает положительную пробу при первой загрузке виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="7ab10-159">The load balancer gets a positive probe the first time the VM boots.</span></span>
* <span data-ttu-id="7ab10-160">Количество успешных проверок, необходимых для отметки экземпляра роли как работоспособного, определяется параметром SuccessFailCount (см. выше).</span><span class="sxs-lookup"><span data-stu-id="7ab10-160">The number SuccessFailCount (described earlier) defines the value of successful probes that are required to mark the role instance as healthy.</span></span> <span data-ttu-id="7ab10-161">Если экземпляр роли был удален, то для пометки экземпляра роли как неработоспособного количество последующих успешных проверок должно быть не меньше значения SuccessFailCount.</span><span class="sxs-lookup"><span data-stu-id="7ab10-161">If a role instance was removed, the number of successful, successive probes must equal or exceed the value of SuccessFailCount to mark the role instance as running.</span></span>

> [!NOTE]
> <span data-ttu-id="7ab10-162">Если состояние работоспособности экземпляра роли постоянно меняется, подсистема балансировки нагрузки ожидает более длительное время перед переводом экземпляра роли обратно в работоспособное состояние.</span><span class="sxs-lookup"><span data-stu-id="7ab10-162">If the health of a role instance is fluctuating, the load balancer waits longer before putting the role instance back in the healthy state.</span></span> <span data-ttu-id="7ab10-163">Для этого используется политика, позволяющая защитить пользователей и инфраструктуру.</span><span class="sxs-lookup"><span data-stu-id="7ab10-163">This is done via policy to protect the user and the infrastructure.</span></span>

## <a name="use-log-analytics-for-load-balancer"></a><span data-ttu-id="7ab10-164">Использование службы анализа журналов для балансировщика нагрузки</span><span class="sxs-lookup"><span data-stu-id="7ab10-164">Use log analytics for Load Balancer</span></span>

<span data-ttu-id="7ab10-165">Для проверки состояния работоспособности проверок и количества проверок можно использовать [службу анализа журналов для балансировщика нагрузки](load-balancer-monitor-log.md) .</span><span class="sxs-lookup"><span data-stu-id="7ab10-165">You can use [log analytics for Load Balancer](load-balancer-monitor-log.md) to check on the probe health status and probe count.</span></span> <span data-ttu-id="7ab10-166">Функция ведения журналов в Power BI или Azure Operational Insights позволяет получать статистические данные о работоспособности балансировщика нагрузки.</span><span class="sxs-lookup"><span data-stu-id="7ab10-166">Logging can be used with Power BI or Azure Operational Insights to provide statistics about Load Balancer health status.</span></span>

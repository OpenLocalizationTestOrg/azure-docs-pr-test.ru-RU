---
title: "пользовательские зондов подсистемы балансировки aaaLoad и мониторинга состояния работоспособности | Документы Microsoft"
description: "Узнайте, как пользовательские toouse проверяет наличие экземпляров toomonitor подсистемы балансировки нагрузки Azure за подсистемой балансировки нагрузки"
services: load-balancer
documentationcenter: na
author: kumudd
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 46b152c5-6a27-4bfc-bea3-05de9ce06a57
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/24/2016
ms.author: kumud
ms.openlocfilehash: 3dfcfcd2d5cffa58b160cb38d63acffbd997d452
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="understand-load-balancer-probes"></a>Проверки балансировщика нагрузки

Подсистема балансировки нагрузки Azure предлагает hello возможность toomonitor hello работоспособностью экземпляров серверов с использованием зонды. При сбое toorespond зонда подсистемы балансировки нагрузки перестает отправлять новый экземпляр неработоспособен toohello подключений. существующие подключения Hello не затрагиваются и новые соединения отправляются toohealthy экземпляров.

Роли облачной службы (рабочие роли и веб-роли) используют гостевой агент для мониторинга проб. При использовании виртуальных машин за балансировщиком нагрузки необходимо настроить пользовательские проверки TCP или HTTP.

## <a name="understand-probe-count-and-timeout"></a>Общие сведения о количестве проверок и времени ожидания

Поведение проверки зависит от следующих параметров:

* Число успешно датчики, позволяющие toobe экземпляра, помеченные как Hello.
* Количество неудачных зондов, вызывающие toobe экземпляра с меткой нерабочими Hello.

Hello тайм-аута и частота значение, заданное в SuccessFailCount определить, является ли экземпляр подтверждена toobe не выполняется или. В hello портал Azure время ожидания hello задано значение hello раз tootwo частоты hello.

Hello проверки конфигурации всех экземпляров с балансировкой нагрузки для конечной точки (то есть набор с балансировкой нагрузки), должна быть hello таким же. Это означает, что нельзя указать другой проверки конфигурации для каждого экземпляра роли или виртуальной машины в hello же размещенной службы для сочетания определенной конечной точкой. Например, каждый экземпляр должен иметь два одинаковых локальных порта и времени ожидания.

> [!IMPORTANT]
> Зонд подсистемы балансировки нагрузки использует hello IP-адреса 168.63.129.16. Этот общедоступный IP-адрес облегчает доступ к ресурсам платформы toointernal для hello перевести your владельцем-IP-адреса сценария Azure виртуальной сети. Hello виртуальный открытый IP-адреса 168.63.129.16 используется во всех регионах и не меняется. Рекомендуется разрешить этот IP-адрес во всех политиках локального брандмауэра. Он не должен рассматриваться угрозу безопасности, так как только hello внутренней платформы Azure может получать сообщения с этого адреса. Если этого не сделать, будет непредвиденное поведение в различных сценариях, как настройка hello же диапазон IP-адресов 168.63.129.16 и повторяющийся IP-адресов.

## <a name="learn-about-hello-types-of-probes"></a>Сведения о типах hello зонды

### <a name="guest-agent-probe"></a>Проверка гостевого агента

Эта проверка доступна только для облачных служб Azure. Подсистема балансировки нагрузки использует hello агент гостевой виртуальной машине hello и прослушивает и отвечает только тогда, когда hello ответ HTTP 200 OK экземпляр находится в состоянии готовности hello (то есть в другом состоянии например Busy, повторный запуск или остановка).

Дополнительные сведения см. в разделе [Настройка hello файл определения службы (csdef) для проверки работоспособности](https://msdn.microsoft.com/library/azure/ee758710.aspx) или [приступить к созданию балансировки нагрузки с выходом в Интернет для облачных служб](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).

### <a name="what-makes-a-guest-agent-probe-mark-an-instance-as-unhealthy"></a>В каком случае проверка гостевого агента отметит экземпляр как неработоспособный?

При сбое toorespond с HTTP 200 OK hello гостевого агента метки подсистемы балансировки нагрузки hello hello экземпляра не отвечает и отправке трафика toothat экземпляр останавливается. Подсистема балансировки нагрузки Hello продолжается tooping hello экземпляра. Если hello агент даст ответ HTTP 200, балансировки нагрузки hello снова отправляет трафик toothat экземпляра.

При использовании веб-роли код hello веб-сайта обычно выполняется в w3wp.exe, который не отслеживается hello фабрики Azure или гостевого агента. Это означает, что ошибки в w3wp.exe (например, ответы HTTP 500) не будет обнаруженную toohello гостевого агента, а hello балансировки нагрузки не будет этот экземпляр из ротации.

### <a name="http-custom-probe"></a>Пользовательская проверка HTTP

пользовательский зонд подсистемы балансировки нагрузки HTTP Hello переопределяет зонд гостевого агента hello по умолчанию, это означает, что можно создать собственную пользовательскую логику toodetermine hello работоспособности экземпляра роли hello. Подсистема балансировки нагрузки Hello зондами каждые 15 секунд конечной точки по умолчанию. экземпляр Hello считается toobe в hello балансировки нагрузки, если ответ HTTP 200 в течение периода ожидания hello (31 секунды по умолчанию).

Это может быть полезно использовать tooimplement экземпляров tooremove собственную логику из балансировки нагрузки. Например можно принять решение tooremove экземпляра, если он превышает 90% загрузки ЦП и возвращает статус отличный от 200. Если у вас есть веб-ролей, использующих w3wp.exe, это также означает, вы получаете автоматический мониторинг веб-сайта, так как ошибки в коде веб-сайт возвращают зонд подсистемы балансировки нагрузки toohello состояние отличный от 200.

> [!NOTE]
> пользовательский зонд Hello HTTP поддерживает относительные пути и только для протокола HTTP. HTTPS не поддерживается.

### <a name="what-makes-an-http-custom-probe-mark-an-instance-as-unhealthy"></a>В каком случае пользовательская проверка HTTP отметит экземпляр как неработоспособный?

* Hello приложения HTTP возвращает код ответа HTTP, отличным от 200 (например, 403, 404 или 500). Это подтверждающее, приложение hello экземпляра следует вывести из обслуживания прямо сейчас.
* Hello HTTP-сервер не отвечает на всех после периода ожидания hello. В зависимости от значения времени ожидания hello, имеет значение, это может означать, несколько зонд запрашивает go без ответа перед hello зонд получает помечен как не выполняется (то есть до SuccessFailCount зонды отправляются).
* Hello сервера закрывает соединение hello через TCP reset.

### <a name="tcp-custom-probe"></a>Пользовательская проверка TCP

TCP-зонды инициировать подключение, выполнив трехэтапного hello определенный порт.

### <a name="what-makes-a-tcp-custom-probe-mark-an-instance-as-unhealthy"></a>В каком случае пользовательская проверка TCP отметит экземпляр как неработоспособный?

* Hello TCP сервер не отвечает на всех после периода ожидания hello. При проверки hello не будет помечена как не запущена зависит от hello количество неудачных пробных запросы, которые были настроенных toogo без ответа, прежде чем помечать hello проверки не выполняется.
* Hello зонд получает TCP, восстановить из экземпляра роли hello.

Дополнительные сведения о настройке пробы работоспособности HTTP или пробы TCP см. в статье [Создание балансировщика нагрузки для Интернета в Resource Manager с помощью PowerShell](load-balancer-get-started-internet-arm-ps.md).

## <a name="add-healthy-instances-back-into-load-balancer-rotation"></a>Добавление работоспособных экземпляров в смену подсистемы балансировки нагрузки

Проверки TCP и HTTP считаются Исправен и пометить hello экземпляра роли, что если работоспособности:

* Подсистема балансировки нагрузки Hello возвращает положительное пробы hello первого времени hello загрузке виртуальной Машины.
* Номер Hello SuccessFailCount (описанную ранее) определяет значение hello успешно зондов, экземпляр роли требуется toomark hello работоспособен. Если экземпляр роли был удален, hello число проб успешной, последующие равняться или превышать значение hello экземпляра SuccessFailCount toomark hello роли как запущенные.

> [!NOTE]
> Если нагрузка колеблется hello работоспособности экземпляра роли, подсистемы балансировки нагрузки hello больше ожидает перед добавлением экземпляра роли hello обратно в работоспособное состояние hello. Это делается посредством пользователь hello tooprotect политики и инфраструктуры hello.

## <a name="use-log-analytics-for-load-balancer"></a>Использование службы анализа журналов для балансировщика нагрузки

Можно использовать [аналитика журналов для подсистемы балансировки нагрузки](load-balancer-monitor-log.md) toocheck на hello проверки работоспособности состояния и пробы count. Ведение журналов может использоваться с Power BI или оперативной аналитики Azure tooprovide статистические данные о состоянии работоспособности подсистемы балансировки нагрузки.

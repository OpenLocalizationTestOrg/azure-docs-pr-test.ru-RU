---
title: "Общие сведения об исходящих подключениях в Azure | Документация Майкрософт"
description: "В этой статье рассказывается о том, как Azure обеспечивает взаимодействие виртуальных машин с общедоступными службами Интернета."
services: load-balancer
documentationcenter: na
author: kumudd
manager: timlt
editor: 
ms.assetid: 5f666f2a-3a63-405a-abcd-b2e34d40e001
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 5/31/2017
ms.author: kumud
ms.openlocfilehash: 03cb14b5710b6dd17599a3c4eab21380c76c2b40
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="understanding-outbound-connections-in-azure"></a>Общие сведения об исходящих подключениях в Azure

Виртуальные машины в Azure могут взаимодействовать с конечными точками за пределами Azure в пространстве общедоступных IP-адресов. Когда виртуальная машина инициирует исходящий поток к месту назначения в пространстве общедоступных IP-адресов, Azure сопоставляет частный IP-адрес виртуальной машины с общедоступным IP-адресом и разрешает обратный трафик на виртуальную машину.

Azure предоставляет три различных способа установления исходящего подключения. Каждый из них имеет свои возможности и ограничения. Ознакомьтесь со всеми методами, чтобы выбрать из них тот, который соответствует вашим потребностям.

| Сценарий | Метод | Примечание. |
| --- | --- | --- |
| Автономная виртуальная машина (без подсистемы балансировки нагрузки, без общедоступного IP-адреса уровня экземпляра) |SNAT по умолчанию |Azure сопоставляет общедоступный IP-адрес для SNAT |
| Виртуальная машина с балансировкой нагрузки (без общедоступного IP-адреса уровня экземпляра) |SNAT с использованием подсистемы балансировки нагрузки |Azure использует общедоступный IP-адрес подсистемы балансировки нагрузки для SNAT |
| Виртуальная машина с общедоступным IP-адресом уровня экземпляра (с подсистемой балансировки нагрузки или без нее) |SNAT не используется |Azure использует общедоступный IP-адрес, назначенный для виртуальной машины |

Если виртуальная машина не должна взаимодействовать с конечными точками за пределами Azure в пространстве общедоступных IP-адресов, можно использовать группы безопасности сети (NSG) для блокирования доступа. Использование групп безопасности сети подробно рассматривается в разделе [Запрет подключения к общедоступным сетям](#preventing-public-connectivity).

## <a name="standalone-vm-with-no-instance-level-public-ip-address"></a>Автономная виртуальная машина без общедоступного IP-адреса уровня экземпляра

В этом сценарии виртуальная машина не является частью пула Azure Load Balancer, и ей не назначен общедоступный IP-адрес уровня экземпляра (ILPIP). Когда виртуальная машина создает исходящий поток, Azure преобразует частный исходный IP-адрес исходящего потока в общедоступный исходный IP-адрес. Общедоступный IP-адрес, используемый для этого исходящего потока, настроить нельзя, и он не учитывается в ограничениях подписки на ресурсы общедоступного IP-адреса. Для выполнения этой функции Azure использует преобразование адресов исходной сети (SNAT). Для определения отдельных потоков, исходящих от виртуальной машины, используются временные порты общедоступного IP-адреса. При создании потоков SNAT динамически выделяет временные порты. В этом контексте временные порты, используемые для SNAT, называются портами SNAT.

Порты SNAT представляют собой ограниченный ресурс, который может быть исчерпан. Важно понимать, как они используются. Для одного потока к конечному IP-адресу используется один порт SNAT. При наличии нескольких потоков к одному и тому же конечному IP-адресу каждый поток использует один порт SNAT. Это гарантирует уникальность потоков от одного и того же общедоступного IP-адреса к одному и тому же конечному IP-адресу. Несколько потоков, каждый из которых направляется на разные конечные IP-адреса, используют один порт SNAT для одного назначения. Конечный IP-адрес делает эти потоки уникальными.

Можно использовать [службу Log Analytics для подсистемы балансировки нагрузки](load-balancer-monitor-log.md) и [журналы оповещений о событиях для отслеживания сообщений о нехватке портов SNAT](load-balancer-monitor-log.md#alert-event-log). Если ресурс портов SNAT исчерпан, исходящие потоки прекращаются, пока существующие потоки не освободят порты SNAT. В подсистеме балансировки нагрузки используется время ожидания в режиме простоя длительностью 4 минуты для освобождения портов SNAT.

## <a name="load-balanced-vm-with-no-instance-level-public-ip-address"></a>Виртуальная машина с балансировкой нагрузки без общедоступного IP-адреса уровня экземпляра

В этом сценарии виртуальная машина является частью пула Azure Load Balancer.  Виртуальной машине не назначен общедоступный IP-адрес. Для ресурса балансировщика нагрузки необходимо настроить правило для связывания общедоступного IP-адреса внешнего интерфейса с внутренним пулом.  Если не выполнить эту настройку, поведение будет таким, каким оно описано в разделе выше для [автономной виртуальной машины без общедоступного IP-адреса уровня экземпляра](load-balancer-outbound-connections.md#standalone-vm-with-no-instance-level-public-ip-address).

Когда виртуальная машина с балансировкой нагрузки создает исходящий поток, Azure преобразует частный исходный IP-адрес исходящего потока в общедоступный IP-адрес интерфейса общедоступной подсистемы балансировки нагрузки. Для выполнения этой функции Azure использует преобразование адресов исходной сети (SNAT). Для определения отдельных потоков, исходящих от виртуальной машины, используются временные порты общедоступного IP-адреса подсистемы балансировки нагрузки. При создании исходящих потоков SNAT динамически выделяет временные порты. В этом контексте временные порты, используемые для SNAT, называются портами SNAT.

Порты SNAT представляют собой ограниченный ресурс, который может быть исчерпан. Важно понимать, как они используются. Для одного потока к конечному IP-адресу используется один порт SNAT. При наличии нескольких потоков к одному и тому же конечному IP-адресу каждый поток использует один порт SNAT. Это гарантирует уникальность потоков от одного и того же общедоступного IP-адреса к одному и тому же конечному IP-адресу. Несколько потоков, каждый из которых направляется на разные конечные IP-адреса, используют один порт SNAT для одного назначения. Конечный IP-адрес делает эти потоки уникальными.

Можно использовать [службу Log Analytics для подсистемы балансировки нагрузки](load-balancer-monitor-log.md) и [журналы оповещений о событиях для отслеживания сообщений о нехватке портов SNAT](load-balancer-monitor-log.md#alert-event-log). Если ресурс портов SNAT исчерпан, исходящие потоки прекращаются, пока существующие потоки не освободят порты SNAT. В подсистеме балансировки нагрузки используется время ожидания в режиме простоя длительностью 4 минуты для освобождения портов SNAT.

## <a name="vm-with-an-instance-level-public-ip-address-with-or-without-load-balancer"></a>Виртуальная машина с общедоступным IP-адресом уровня экземпляра (с подсистемой балансировки нагрузки или без нее)

В этом случае виртуальной машине назначен общедоступный IP-адрес уровня экземпляра (ILPIP). Не имеет значения, используется ли на виртуальной машины балансировка нагрузки или нет. При использовании адреса ILPIP преобразование SNAT не используется. Виртуальная машина использует ILPIP для всех исходящих потоков. Если приложение инициирует большое количество исходящих потоков и возникает нехватка SNAT, рекомендуется назначить ILPIP, чтобы избежать ограничений SNAT.

## <a name="discovering-the-public-ip-used-by-a-given-vm"></a>Обнаружение общедоступного IP-адреса, используемого виртуальной машиной

Существует много способов определить общедоступный исходный IP-адрес исходящего подключения. OpenDNS — это служба, которая может показать общедоступный IP-адрес виртуальной машины. С помощью команды nslookup можно отправить к сопоставителю OpenDNS запрос DNS для имени myip.opendns.com. Служба возвращает исходный IP-адрес, который был использован для отправки запроса. При выполнении следующего запроса, поступившего с виртуальной машины, ответ будет содержать общедоступный IP-адрес, используемый для этой виртуальной машины.

    nslookup myip.opendns.com resolver1.opendns.com

## <a name="preventing-public-connectivity"></a>Запрет подключения к общедоступным сетям

Иногда создание виртуальной машиной исходящих потоков может быть нежелательным. Кроме того, вам может понадобиться ограничить пункты назначения, доступные для исходящих потоков. В таком случае можно использовать [группы безопасности сети (NSG)](../virtual-network/virtual-networks-nsg.md). При использовании NSG для виртуальной машины с балансировкой нагрузки необходимо обратить внимание на [теги по умолчанию](../virtual-network/virtual-networks-nsg.md#default-tags) и [правила по умолчанию](../virtual-network/virtual-networks-nsg.md#default-rules).

Следует убедиться, что виртуальная машина может получать запросы проверки состояния работоспособности из Azure Load Balancer. Если NSG блокирует такие запросы от тега по умолчанию AZURE_LOADBALANCER, запрос завершается сбоем, а виртуальная машина помечается как отключенная. Подсистема балансировки нагрузки прекращает отправку новых потоков на эту виртуальную машину.

## <a name="limitations"></a>Ограничения

Если [несколько (общедоступных) IP-адресов связано с подсистемой балансировки нагрузки](load-balancer-multivip-overview.md), то любой из этих общедоступных IP-адресов может использоваться для исходящих потоков.

Azure использует алгоритм для определения количества доступных портов SNAT с учетом размера пула.  Этот алгоритм на данный момент нельзя настраивать.

Очень важно помнить, что количество доступных портов SNAT не преобразуется автоматически в количество подключений. Выше описаны особенности распределения SNAT-портов и управления этим ограниченным ресурсом.

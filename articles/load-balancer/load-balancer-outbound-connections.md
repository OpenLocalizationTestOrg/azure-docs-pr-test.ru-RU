---
title: "Общие сведения об исходящих подключениях в Azure | Документация Майкрософт"
description: "В этой статье рассказывается о том, как Azure обеспечивает взаимодействие виртуальных машин с общедоступными службами Интернета."
services: load-balancer
documentationcenter: na
author: KumudD
manager: jeconnoc
editor: 
ms.assetid: 5f666f2a-3a63-405a-abcd-b2e34d40e001
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/25/2017
ms.author: kumud
ms.openlocfilehash: b8e225ba4374c73dbabac3dddab9ba37fa798a5a
ms.sourcegitcommit: 176c575aea7602682afd6214880aad0be6167c52
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/09/2018
---
# <a name="understanding-outbound-connections-in-azure"></a>Общие сведения об исходящих подключениях в Azure

[!INCLUDE [load-balancer-basic-sku-include.md](../../includes/load-balancer-basic-sku-include.md)]

Виртуальные машины в Azure могут взаимодействовать с конечными точками за пределами Azure в пространстве общедоступных IP-адресов. Когда виртуальная машина инициирует исходящий поток к месту назначения в пространстве общедоступных IP-адресов, Azure сопоставляет частный IP-адрес виртуальной машины с общедоступным IP-адресом и разрешает обратный трафик на виртуальную машину.

Azure предоставляет три различных способа установления исходящего подключения. Каждый из них имеет свои возможности и ограничения. Ознакомьтесь со всеми методами, чтобы выбрать из них тот, который соответствует вашим потребностям.

| Сценарий | Метод | Примечание |
| --- | --- | --- |
| Автономная виртуальная машина (без подсистемы балансировки нагрузки, без общедоступного IP-адреса уровня экземпляра) |SNAT по умолчанию |Azure сопоставляет общедоступный IP-адрес для SNAT |
| Виртуальная машина с балансировкой нагрузки (без общедоступного IP-адреса уровня экземпляра) |SNAT с использованием подсистемы балансировки нагрузки |Azure использует общедоступный IP-адрес подсистемы балансировки нагрузки для SNAT |
| Виртуальная машина с общедоступным IP-адресом уровня экземпляра (с подсистемой балансировки нагрузки или без нее) |SNAT не используется |Azure использует общедоступный IP-адрес, назначенный для виртуальной машины |

Если виртуальная машина не должна взаимодействовать с конечными точками за пределами Azure в пространстве общедоступных IP-адресов, можно использовать группы безопасности сети (NSG) для блокирования доступа. Использование групп безопасности сети подробно рассматривается в разделе [Запрет подключения к общедоступным сетям](#preventing-public-connectivity).

## <a name="standalone-vm-with-no-instance-level-public-ip-address"></a>Автономная виртуальная машина без общедоступного IP-адреса уровня экземпляра

В этом сценарии виртуальная машина не является частью пула Azure Load Balancer, и ей не назначен общедоступный IP-адрес уровня экземпляра (ILPIP). Когда виртуальная машина создает исходящий поток, Azure преобразует частный исходный IP-адрес исходящего потока в общедоступный исходный IP-адрес. Общедоступный IP-адрес, используемый для этого исходящего потока, настроить нельзя, и он не учитывается в ограничениях подписки на ресурсы общедоступного IP-адреса. Для выполнения этой функции Azure использует преобразование адресов исходной сети (SNAT). Для определения отдельных потоков, исходящих от виртуальной машины, используются временные порты общедоступного IP-адреса. При создании потоков SNAT динамически выделяет временные порты. В этом контексте временные порты, используемые для SNAT, называются портами SNAT.

Порты SNAT представляют собой ограниченный ресурс, который может быть исчерпан. Важно понимать, как они используются. Для одного потока к отдельному конечному IP-адресу используется один порт SNAT. При наличии нескольких потоков к одним и тем же конечным IP-адресу и порту каждый поток использует отдельный порт SNAT. Это гарантирует уникальность потоков с одного и того же общедоступного IP-адреса к одним и тем же конечным IP-адресу и порту. Несколько потоков, каждый из которых направляется на разные конечные IP-адрес и порт, используют отдельный порт SNAT. Конечные IP-адрес и порт делают эти потоки уникальными.

Вы можете использовать [службу Log Analytics для подсистемы балансировки нагрузки](load-balancer-monitor-log.md) и [журналы оповещений о событиях для отслеживания сообщений о нехватке портов SNAT](load-balancer-monitor-log.md#alert-event-log), чтобы отслеживать работоспособность исходящих подключений. Если ресурс портов SNAT исчерпан, исходящие потоки прекращаются, пока существующие потоки не освободят порты SNAT. В подсистеме балансировки нагрузки используется время ожидания в режиме простоя длительностью 4 минуты для освобождения портов SNAT.  Ознакомьтесь с разделами [Виртуальная машина с общедоступным IP-адресом уровня экземпляра (с подсистемой балансировки нагрузки или без нее)](#vm-with-an-instance-level-public-ip-address-with-or-without-load-balancer) и [Управление нехваткой SNAT](#snatexhaust).

## <a name="load-balanced-vm-with-no-instance-level-public-ip-address"></a>Виртуальная машина с балансировкой нагрузки без общедоступного IP-адреса уровня экземпляра

В этом сценарии виртуальная машина является частью пула Azure Load Balancer.  Виртуальной машине не назначен общедоступный IP-адрес. Для ресурса Load Balancer необходимо настроить правило балансировки нагрузки для связывания общедоступного IP-адреса внешнего интерфейса с внутренним пулом. Если не выполнить эту настройку, реакция на событие будет такой, как описано в разделе выше для [изолированной виртуальной машины без общедоступного IP-адреса уровня экземпляра](load-balancer-outbound-connections.md#standalone-vm-with-no-instance-level-public-ip-address).

Когда виртуальная машина с балансировкой нагрузки создает исходящий поток, Azure преобразует частный исходный IP-адрес исходящего потока в общедоступный IP-адрес интерфейса общедоступной подсистемы балансировки нагрузки. Для выполнения этой функции Azure использует преобразование адресов исходной сети (SNAT). Для определения отдельных потоков, исходящих от виртуальной машины, используются временные порты общедоступного IP-адреса подсистемы балансировки нагрузки. При создании исходящих потоков SNAT динамически выделяет временные порты. В этом контексте временные порты, используемые для SNAT, называются портами SNAT.

Порты SNAT представляют собой ограниченный ресурс, который может быть исчерпан. Важно понимать, как они используются. Для одного потока к конечным IP-адресу и порту используется один порт SNAT. При наличии нескольких потоков к одним и тем же конечным IP-адресу и порту каждый поток использует отдельный порт SNAT. Это гарантирует уникальность потоков с одного и того же общедоступного IP-адреса к одним и тем же конечным IP-адресу и порту. Несколько потоков, каждый из которых направляется на разные конечные IP-адрес и порт, используют отдельный порт SNAT. Конечные IP-адрес и порт делают эти потоки уникальными.

Вы можете использовать [службу Log Analytics для подсистемы балансировки нагрузки](load-balancer-monitor-log.md) и [журналы оповещений о событиях для отслеживания сообщений о нехватке портов SNAT](load-balancer-monitor-log.md#alert-event-log), чтобы отслеживать работоспособность исходящих подключений. Если ресурс портов SNAT исчерпан, исходящие потоки прекращаются, пока существующие потоки не освободят порты SNAT. В подсистеме балансировки нагрузки используется время ожидания в режиме простоя длительностью 4 минуты для освобождения портов SNAT.  Ознакомьтесь с разделом ниже, включая раздел [Управление нехваткой SNAT](#snatexhaust).

## <a name="vm-with-an-instance-level-public-ip-address-with-or-without-load-balancer"></a>Виртуальная машина с общедоступным IP-адресом уровня экземпляра (с подсистемой балансировки нагрузки или без нее)

В этом случае виртуальной машине назначен общедоступный IP-адрес уровня экземпляра (ILPIP). Не имеет значения, используется ли на виртуальной машины балансировка нагрузки или нет. При использовании адреса ILPIP преобразование SNAT не используется. Виртуальная машина использует ILPIP для всех исходящих потоков. Если приложение инициирует большое количество исходящих потоков и возникает нехватка SNAT, рекомендуется назначить ILPIP, чтобы устранить ограничения SNAT.

## <a name="discovering-the-public-ip-used-by-a-given-vm"></a>Обнаружение общедоступного IP-адреса, используемого виртуальной машиной

Существует много способов определить общедоступный исходный IP-адрес исходящего подключения. OpenDNS — это служба, которая может показать общедоступный IP-адрес виртуальной машины. С помощью команды nslookup можно отправить к сопоставителю OpenDNS запрос DNS для имени myip.opendns.com. Служба возвращает исходный IP-адрес, который был использован для отправки запроса. При выполнении следующего запроса, поступившего с виртуальной машины, ответ будет содержать общедоступный IP-адрес, используемый для этой виртуальной машины.

    nslookup myip.opendns.com resolver1.opendns.com

## <a name="preventing-public-connectivity"></a>Запрет подключения к общедоступным сетям

Иногда создание виртуальной машиной исходящих потоков может быть нежелательным. Кроме того, вам может понадобиться ограничить пункты назначения, доступные для исходящих потоков или назначения, инициирующие входящие потоки. В таком случае можно использовать [группы безопасности сети (NSG)](../virtual-network/virtual-networks-nsg.md), чтобы управлять пунктами назначений, доступными для виртуальной машины, а также выбором общедоступных назначений, способных инициировать входящие потоки. При использовании NSG для виртуальной машины с балансировкой нагрузки необходимо обратить внимание на [теги по умолчанию](../virtual-network/virtual-networks-nsg.md#default-tags) и [правила по умолчанию](../virtual-network/virtual-networks-nsg.md#default-rules).

Следует убедиться, что виртуальная машина может получать запросы проверки состояния работоспособности из Azure Load Balancer. Если NSG блокирует такие запросы от тега по умолчанию AZURE_LOADBALANCER, запрос завершается сбоем, а виртуальная машина помечается как отключенная. Подсистема балансировки нагрузки прекращает отправку новых потоков на эту виртуальную машину.

## <a name="snatexhaust"></a>Управление нехваткой SNAT

Временные порты, используемые для SNAT, являются ограниченными ресурсами, что подробно описывается в разделах [Автономная виртуальная машина без общедоступного IP-адреса уровня экземпляра](#standalone-vm-with-no-instance-level-public-ip-address) и [Виртуальная машина с балансировкой нагрузки без общедоступного IP-адреса уровня экземпляра](#standalone-vm-with-no-instance-level-public-ip-address).

При инициировании множества исходящих TCP- или UDP-подключений к тем же конечным IP-адресу и порту они будут завершаться сбоем или же вы будете получать уведомления от службы поддержки о нехватке портов SNAT. У вас есть несколько вариантов устранения этой проблемы.  Ознакомьтесь с ними, чтобы выбрать нужный для своего сценария.  Возможно один или несколько вариантов помогут вам решить проблему.

### <a name="modify-application-to-reuse-connections"></a>Изменение приложения для повторного использования подключений 
Вы можете снизить потребность во временных портах, используемых для SNAT, повторно используя подключения в приложении.  Это особенно касается таких для протоколов, как HTTP/1.1, в которых подключения используются повторно по умолчанию.  В свою очередь, это может положительно повлиять на другие протоколы, использующие HTTP в качестве транспорта (например, REST).  Повторное использование всегда лучше, чем отдельные, атомарные TCP-подключения для каждого запроса. Оно позволяет повысить производительность и эффективность транзакций TCP.

### <a name="modify-application-to-use-connection-pooling"></a>Изменение приложения для использования пулов подключений
Можно использовать в приложении схему пула подключений, при которой внутренний механизм распределяет запросы по фиксированному набору подключений (каждое из которых повторно используется, если это возможно).  Этого ограничивает количество используемых временных портов и делает среду более предсказуемой.  Это может также повысить пропускную способность запросов, позволяя одновременно выполнять несколько операций, когда отдельное подключение блокируется, ожидая результата операции.  Возможно, пулы подключений уже существуют в платформе, которая используется вами для разработки приложения или параметров конфигурации приложения.  Их можно объединить с повторным использованием подключений. В этом случае для обработки нескольких запросов можно будет использовать фиксированное, прогнозируемое число портов для одних и тех же конечных IP-адреса и порта, а также воспользоваться преимуществами повышенной эффективности транзакций TCP, сокращающей задержки и использование ресурсов.

### <a name="modify-application-to-use-less-aggressive-retry-logic"></a>Изменение приложения для использования менее "жесткой" логики повторных попыток
При нехватке временных портов для SNAT или сбоях приложения "агрессивная" логика повтора или логика повтора методом подбора без логики отхода и времени сохранения не позволяет устранить проблему нехватки. Вы можете снизить потребность во временных портах, используя менее "жесткую" логику повторных попыток.   Для временных портов установлено время ожидания простоя 4 минуты (не регулируется) и если повторные попытки слишком частые, нехватка будет наблюдаться в любом случае.  Поэтому знать, как и как часто приложение повторяет транзакции, очень важно для проектирования.

### <a name="assign-an-instance-level-public-ip-to-each-vm"></a>Назначение общедоступного IP-адреса на уровне экземпляра для каждой виртуальной машины
При таком изменении назначается [общедоступный IP-адрес на уровне экземпляра для виртуальной машины](#vm-with-an-instance-level-public-ip-address-with-or-without-load-balancer).  Все временные порты общедоступного IP-адреса, используемые для каждой виртуальной машины, доступны для каждой из них (в отличие от сценариев, где временные порты общедоступного IP-адреса используются совместно со всеми виртуальными машинами, связанными с соответствующим внутренним пулом).  Существуют преимущества и недостатки, которые необходимо учитывать, например дополнительные затраты на IP-адреса и возможное влияние добавления в список разрешений большого количества отдельных IP-адресов.

## <a name="limitations"></a>Ограничения

Если [несколько (общедоступных) IP-адресов связано с подсистемой балансировки нагрузки](load-balancer-multivip-overview.md), то любой из этих общедоступных IP-адресов может использоваться для исходящих потоков.

Azure использует алгоритм для определения количества доступных портов SNAT с учетом размера пула.  Этот алгоритм на данный момент нельзя настраивать.

Для исходящих подключений задано время ожидания простоя 4 минуты.  Это время не регулируется.

Очень важно помнить, что количество доступных портов SNAT не преобразуется автоматически в количество подключений. В разделах выше описаны особенности распределения портов SNAT и [управления этим ограниченным ресурсом](#snatexhaust).

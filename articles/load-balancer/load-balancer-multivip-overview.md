---
title: "Несколько виртуальных IP-адресов для Azure Load Balancer | Документация Майкрософт"
description: "Обзор функции нескольких виртуальных IP-адресов для Azure Load Balancer"
services: load-balancer
documentationcenter: na
author: chkuhtz
manager: narayan
editor: 
ms.assetid: 748e50cd-3087-4c2e-a9e1-ac0ecce4f869
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/11/2016
ms.author: chkuhtz
ms.openlocfilehash: d9e88b859020be2a96a57a01e5624052ed134b64
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="multiple-vips-for-azure-load-balancer"></a><span data-ttu-id="9cc70-103">Несколько виртуальных IP-адресов для Azure Load Balancer</span><span class="sxs-lookup"><span data-stu-id="9cc70-103">Multiple VIPs for Azure Load Balancer</span></span>

<span data-ttu-id="9cc70-104">Azure Load Balancer позволяет выполнять балансировку нагрузки между службами на нескольких портах, нескольких IP-адресах или обоими этими способами.</span><span class="sxs-lookup"><span data-stu-id="9cc70-104">Azure Load Balancer allows you to load balance services on multiple ports, multiple IP addresses, or both.</span></span> <span data-ttu-id="9cc70-105">Вы можете воспользоваться определениями общедоступного и внутреннего балансировщика нагрузки для выполнения балансировки потоков в наборе виртуальных машин.</span><span class="sxs-lookup"><span data-stu-id="9cc70-105">You can use public and internal load balancer definitions to load balance flows across a set of VMs.</span></span>

<span data-ttu-id="9cc70-106">В этой статье описываются основные принципы данной функции, важные понятия и ограничения.</span><span class="sxs-lookup"><span data-stu-id="9cc70-106">This article describes the fundamentals of this ability, important concepts, and constraints.</span></span> <span data-ttu-id="9cc70-107">Если вы собираетесь размещать службы только на одном IP-адресе, то см. упрощенные инструкции для настройки [общедоступного](load-balancer-get-started-internet-portal.md) или [внутреннего](load-balancer-get-started-ilb-arm-portal.md) балансировщика нагрузки.</span><span class="sxs-lookup"><span data-stu-id="9cc70-107">If you only intend to expose services on one IP address, you can find simplified instructions for [public](load-balancer-get-started-internet-portal.md) or [internal](load-balancer-get-started-ilb-arm-portal.md) load balancer configurations.</span></span> <span data-ttu-id="9cc70-108">Добавление нескольких виртуальных IP-адресов является действием, дополняющим конфигурацию с одним виртуальным IP-адресом.</span><span class="sxs-lookup"><span data-stu-id="9cc70-108">Adding Multiple VIPs is incremental to a single VIP configuration.</span></span> <span data-ttu-id="9cc70-109">С помощью принципов, изложенных в этой статье, можно в любой момент расширить упрощенную конфигурацию.</span><span class="sxs-lookup"><span data-stu-id="9cc70-109">Using the concepts in this article, you can expand a simplified configuration at any time.</span></span>

<span data-ttu-id="9cc70-110">При определении Azure Load Balancer интерфейсная и внутренняя конфигурации связываются правилами.</span><span class="sxs-lookup"><span data-stu-id="9cc70-110">When you define an Azure Load Balancer, a frontend and a backend configuration are connected with rules.</span></span> <span data-ttu-id="9cc70-111">Проба работоспособности, на которую ссылается правило, позволяет определить, как новые потоки направляются на узел во внутреннем пуле.</span><span class="sxs-lookup"><span data-stu-id="9cc70-111">The health probe referenced by the rule is used to determine how new flows are sent to a node in the backend pool.</span></span> <span data-ttu-id="9cc70-112">Внешний интерфейс определяется с помощью виртуального IP-адреса, который является сочетанием 3 кортежей: IP-адреса (общедоступного или внутреннего), транспортного протокола (UDP или TCP) и номера порта.</span><span class="sxs-lookup"><span data-stu-id="9cc70-112">The frontend is defined by a Virtual IP (VIP), which is a 3-tuple comprised of an IP address (public or internal), a transport protocol (UDP or TCP), and a port number.</span></span> <span data-ttu-id="9cc70-113">Выделенный IP-адрес (DIP) — это IP-адрес в виртуальной сетевой карте Azure, подключенной к виртуальной машине во внутреннем пуле.</span><span class="sxs-lookup"><span data-stu-id="9cc70-113">A DIP is an IP address on an Azure virtual NIC attached to a VM in the backend pool.</span></span>

<span data-ttu-id="9cc70-114">В следующей таблице приведены некоторые примеры интерфейсных конфигураций:</span><span class="sxs-lookup"><span data-stu-id="9cc70-114">The following table contains some example frontend configurations:</span></span>

| <span data-ttu-id="9cc70-115">Виртуальный IP-адрес</span><span class="sxs-lookup"><span data-stu-id="9cc70-115">VIP</span></span> | <span data-ttu-id="9cc70-116">IP-адрес</span><span class="sxs-lookup"><span data-stu-id="9cc70-116">IP address</span></span> | <span data-ttu-id="9cc70-117">protocol</span><span class="sxs-lookup"><span data-stu-id="9cc70-117">protocol</span></span> | <span data-ttu-id="9cc70-118">порт</span><span class="sxs-lookup"><span data-stu-id="9cc70-118">port</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="9cc70-119">1</span><span class="sxs-lookup"><span data-stu-id="9cc70-119">1</span></span> |<span data-ttu-id="9cc70-120">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="9cc70-120">65.52.0.1</span></span> |<span data-ttu-id="9cc70-121">TCP</span><span class="sxs-lookup"><span data-stu-id="9cc70-121">TCP</span></span> |<span data-ttu-id="9cc70-122">80</span><span class="sxs-lookup"><span data-stu-id="9cc70-122">80</span></span> |
| <span data-ttu-id="9cc70-123">2</span><span class="sxs-lookup"><span data-stu-id="9cc70-123">2</span></span> |<span data-ttu-id="9cc70-124">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="9cc70-124">65.52.0.1</span></span> |<span data-ttu-id="9cc70-125">TCP</span><span class="sxs-lookup"><span data-stu-id="9cc70-125">TCP</span></span> |<span data-ttu-id="9cc70-126">*8080*</span><span class="sxs-lookup"><span data-stu-id="9cc70-126">*8080*</span></span> |
| <span data-ttu-id="9cc70-127">3</span><span class="sxs-lookup"><span data-stu-id="9cc70-127">3</span></span> |<span data-ttu-id="9cc70-128">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="9cc70-128">65.52.0.1</span></span> |<span data-ttu-id="9cc70-129">*UDP*</span><span class="sxs-lookup"><span data-stu-id="9cc70-129">*UDP*</span></span> |<span data-ttu-id="9cc70-130">80</span><span class="sxs-lookup"><span data-stu-id="9cc70-130">80</span></span> |
| <span data-ttu-id="9cc70-131">4</span><span class="sxs-lookup"><span data-stu-id="9cc70-131">4</span></span> |<span data-ttu-id="9cc70-132">*65.52.0.2*</span><span class="sxs-lookup"><span data-stu-id="9cc70-132">*65.52.0.2*</span></span> |<span data-ttu-id="9cc70-133">TCP</span><span class="sxs-lookup"><span data-stu-id="9cc70-133">TCP</span></span> |<span data-ttu-id="9cc70-134">80</span><span class="sxs-lookup"><span data-stu-id="9cc70-134">80</span></span> |

<span data-ttu-id="9cc70-135">В таблице представлены четыре разных внешних интерфейса.</span><span class="sxs-lookup"><span data-stu-id="9cc70-135">The table shows four different frontends.</span></span> <span data-ttu-id="9cc70-136">Внешние интерфейсы 1, 2 и 3 — это один виртуальный IP-адрес с несколькими правилами.</span><span class="sxs-lookup"><span data-stu-id="9cc70-136">Frontends #1, #2 and #3 are a single VIP with multiple rules.</span></span> <span data-ttu-id="9cc70-137">Используется один IP-адрес, но порт или протокол отличаются для каждого внешнего интерфейса.</span><span class="sxs-lookup"><span data-stu-id="9cc70-137">The same IP address is used but the port or protocol is different for each frontend.</span></span> <span data-ttu-id="9cc70-138">Внешние интерфейсы 1 и 4 являются примерами нескольких виртуальных IP-адресов, так как в них один интерфейсный протокол и один порт повторно используются для разных виртуальных IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="9cc70-138">Frontends #1 and #4 are an example of Multiple VIPs, where the same frontend protocol and port are reused across multiple VIPs.</span></span>

<span data-ttu-id="9cc70-139">Azure Load Balancer обеспечивает гибкость при определении правил балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="9cc70-139">Azure Load Balancer provides flexibility in defining the load balancing rules.</span></span> <span data-ttu-id="9cc70-140">Правило объявляет, каким образом адрес и порт во внешнем интерфейсе сопоставляются с адресом и портом назначения в серверной части.</span><span class="sxs-lookup"><span data-stu-id="9cc70-140">A rule declares how an address and port on the frontend is mapped to the destination address and port on the backend.</span></span> <span data-ttu-id="9cc70-141">Будут ли внутренние порты повторно использоваться в нескольких правилах зависит от типа правил.</span><span class="sxs-lookup"><span data-stu-id="9cc70-141">Whether or not backend ports are reused across rules depends on the type of the rule.</span></span> <span data-ttu-id="9cc70-142">Каждый тип правил имеет определенные требования, которые могут повлиять на конфигурацию узла и конструкцию пробы.</span><span class="sxs-lookup"><span data-stu-id="9cc70-142">Each type of rule has specific requirements that can affect host configuration and probe design.</span></span> <span data-ttu-id="9cc70-143">Существует два типа правил:</span><span class="sxs-lookup"><span data-stu-id="9cc70-143">There are two types of rules:</span></span>

1. <span data-ttu-id="9cc70-144">Правило по умолчанию, в котором внутренние порты повторно не используются.</span><span class="sxs-lookup"><span data-stu-id="9cc70-144">The default rule with no backend port reuse</span></span>
2. <span data-ttu-id="9cc70-145">Правило плавающего IP-адреса, в котором внутренние порты используются повторно.</span><span class="sxs-lookup"><span data-stu-id="9cc70-145">The Floating IP rule where backend ports are reused</span></span>

<span data-ttu-id="9cc70-146">Azure Load Balancer позволяет сочетать оба типа правил в одной конфигурации балансировщика нагрузки.</span><span class="sxs-lookup"><span data-stu-id="9cc70-146">Azure Load Balancer allows you to mix both rule types on the same load balancer configuration.</span></span> <span data-ttu-id="9cc70-147">Балансировщик нагрузки может использовать их одновременно для определенной виртуальной машины или в любой комбинации; главное, чтобы соблюдались ограничения правила.</span><span class="sxs-lookup"><span data-stu-id="9cc70-147">The load balancer can use them simultaneously for a given VM, or any combination, as long as you abide by the constraints of the rule.</span></span> <span data-ttu-id="9cc70-148">Выбор типа правил зависит от требований вашего приложения и сложности поддержки созданной конфигурации.</span><span class="sxs-lookup"><span data-stu-id="9cc70-148">Which rule type you choose depends on the requirements of your application and the complexity of supporting that configuration.</span></span> <span data-ttu-id="9cc70-149">Следует оценить, какие типы правил лучше подходят для конкретного сценария.</span><span class="sxs-lookup"><span data-stu-id="9cc70-149">You should evaluate which rule types are best for your scenario.</span></span>

<span data-ttu-id="9cc70-150">Мы рассмотрим возможные сценарии далее в этой статье, а начнем с поведения по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="9cc70-150">We explore these scenarios further by starting with the default behavior.</span></span>

## <a name="rule-type-1-no-backend-port-reuse"></a><span data-ttu-id="9cc70-151">Тип правил 1: внутренние порты повторно не используются</span><span class="sxs-lookup"><span data-stu-id="9cc70-151">Rule type #1: No backend port reuse</span></span>

![Иллюстрация нескольких виртуальных IP-адресов](./media/load-balancer-multivip-overview/load-balancer-multivip.png)

<span data-ttu-id="9cc70-153">В этом сценарии интерфейсные виртуальные IP-адреса настроены следующим образом:</span><span class="sxs-lookup"><span data-stu-id="9cc70-153">In this scenario, the frontend VIPs are configured as follows:</span></span>

| <span data-ttu-id="9cc70-154">Виртуальный IP-адрес</span><span class="sxs-lookup"><span data-stu-id="9cc70-154">VIP</span></span> | <span data-ttu-id="9cc70-155">IP-адрес</span><span class="sxs-lookup"><span data-stu-id="9cc70-155">IP address</span></span> | <span data-ttu-id="9cc70-156">protocol</span><span class="sxs-lookup"><span data-stu-id="9cc70-156">protocol</span></span> | <span data-ttu-id="9cc70-157">порт</span><span class="sxs-lookup"><span data-stu-id="9cc70-157">port</span></span> |
| --- | --- | --- | --- |
| ![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="9cc70-159">1</span><span class="sxs-lookup"><span data-stu-id="9cc70-159">1</span></span> |<span data-ttu-id="9cc70-160">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="9cc70-160">65.52.0.1</span></span> |<span data-ttu-id="9cc70-161">TCP</span><span class="sxs-lookup"><span data-stu-id="9cc70-161">TCP</span></span> |<span data-ttu-id="9cc70-162">80</span><span class="sxs-lookup"><span data-stu-id="9cc70-162">80</span></span> |
| ![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="9cc70-164">2</span><span class="sxs-lookup"><span data-stu-id="9cc70-164">2</span></span> |<span data-ttu-id="9cc70-165">*65.52.0.2*</span><span class="sxs-lookup"><span data-stu-id="9cc70-165">*65.52.0.2*</span></span> |<span data-ttu-id="9cc70-166">TCP</span><span class="sxs-lookup"><span data-stu-id="9cc70-166">TCP</span></span> |<span data-ttu-id="9cc70-167">80</span><span class="sxs-lookup"><span data-stu-id="9cc70-167">80</span></span> |

<span data-ttu-id="9cc70-168">Выделенный IP-адрес (DIP) — это назначение входящего потока.</span><span class="sxs-lookup"><span data-stu-id="9cc70-168">The DIP is the destination of the inbound flow.</span></span> <span data-ttu-id="9cc70-169">Во внутреннем пуле каждая виртуальная машина размещает нужную службу на уникальном порте в DIP.</span><span class="sxs-lookup"><span data-stu-id="9cc70-169">In the backend pool, each VM exposes the desired service on a unique port on a DIP.</span></span> <span data-ttu-id="9cc70-170">Эта служба связывается с внешним интерфейсом посредством определения правил.</span><span class="sxs-lookup"><span data-stu-id="9cc70-170">This service is associated with the frontend through a rule definition.</span></span>

<span data-ttu-id="9cc70-171">Мы определим два правила:</span><span class="sxs-lookup"><span data-stu-id="9cc70-171">We define two rules:</span></span>

| <span data-ttu-id="9cc70-172">правило;</span><span class="sxs-lookup"><span data-stu-id="9cc70-172">Rule</span></span> | <span data-ttu-id="9cc70-173">Сопоставить внешний интерфейс</span><span class="sxs-lookup"><span data-stu-id="9cc70-173">Map frontend</span></span> | <span data-ttu-id="9cc70-174">С внутренним пулом</span><span class="sxs-lookup"><span data-stu-id="9cc70-174">To backend pool</span></span> |
| --- | --- | --- |
| <span data-ttu-id="9cc70-175">1</span><span class="sxs-lookup"><span data-stu-id="9cc70-175">1</span></span> |![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="9cc70-177">VIP1:80</span><span class="sxs-lookup"><span data-stu-id="9cc70-177">VIP1:80</span></span> |![серверная часть](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="9cc70-179">DIP1:80,</span><span class="sxs-lookup"><span data-stu-id="9cc70-179">DIP1:80,</span></span> ![серверная часть](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="9cc70-181">DIP2:80</span><span class="sxs-lookup"><span data-stu-id="9cc70-181">DIP2:80</span></span> |
| <span data-ttu-id="9cc70-182">2</span><span class="sxs-lookup"><span data-stu-id="9cc70-182">2</span></span> |![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="9cc70-184">VIP2:80</span><span class="sxs-lookup"><span data-stu-id="9cc70-184">VIP2:80</span></span> |![серверная часть](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="9cc70-186">DIP1:81,</span><span class="sxs-lookup"><span data-stu-id="9cc70-186">DIP1:81,</span></span> ![серверная часть](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="9cc70-188">DIP2:81</span><span class="sxs-lookup"><span data-stu-id="9cc70-188">DIP2:81</span></span> |

<span data-ttu-id="9cc70-189">Полное сопоставление в Azure Load Balancer теперь выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="9cc70-189">The complete mapping in Azure Load Balancer is now as follows:</span></span>

| <span data-ttu-id="9cc70-190">правило;</span><span class="sxs-lookup"><span data-stu-id="9cc70-190">Rule</span></span> | <span data-ttu-id="9cc70-191">Виртуальный IP-адрес (VIP)</span><span class="sxs-lookup"><span data-stu-id="9cc70-191">VIP IP address</span></span> | <span data-ttu-id="9cc70-192">protocol</span><span class="sxs-lookup"><span data-stu-id="9cc70-192">protocol</span></span> | <span data-ttu-id="9cc70-193">порт</span><span class="sxs-lookup"><span data-stu-id="9cc70-193">port</span></span> | <span data-ttu-id="9cc70-194">Место назначения</span><span class="sxs-lookup"><span data-stu-id="9cc70-194">Destination</span></span> | <span data-ttu-id="9cc70-195">порт</span><span class="sxs-lookup"><span data-stu-id="9cc70-195">port</span></span> |
| --- | --- | --- | --- | --- | --- |
| ![правило;](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="9cc70-197">1</span><span class="sxs-lookup"><span data-stu-id="9cc70-197">1</span></span> |<span data-ttu-id="9cc70-198">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="9cc70-198">65.52.0.1</span></span> |<span data-ttu-id="9cc70-199">TCP</span><span class="sxs-lookup"><span data-stu-id="9cc70-199">TCP</span></span> |<span data-ttu-id="9cc70-200">80</span><span class="sxs-lookup"><span data-stu-id="9cc70-200">80</span></span> |<span data-ttu-id="9cc70-201">Выделенный IP-адрес (DIP)</span><span class="sxs-lookup"><span data-stu-id="9cc70-201">DIP IP Address</span></span> |<span data-ttu-id="9cc70-202">80</span><span class="sxs-lookup"><span data-stu-id="9cc70-202">80</span></span> |
| ![правило;](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="9cc70-204">2</span><span class="sxs-lookup"><span data-stu-id="9cc70-204">2</span></span> |<span data-ttu-id="9cc70-205">65.52.0.2</span><span class="sxs-lookup"><span data-stu-id="9cc70-205">65.52.0.2</span></span> |<span data-ttu-id="9cc70-206">TCP</span><span class="sxs-lookup"><span data-stu-id="9cc70-206">TCP</span></span> |<span data-ttu-id="9cc70-207">80</span><span class="sxs-lookup"><span data-stu-id="9cc70-207">80</span></span> |<span data-ttu-id="9cc70-208">Выделенный IP-адрес (DIP)</span><span class="sxs-lookup"><span data-stu-id="9cc70-208">DIP IP Address</span></span> |<span data-ttu-id="9cc70-209">81</span><span class="sxs-lookup"><span data-stu-id="9cc70-209">81</span></span> |

<span data-ttu-id="9cc70-210">Каждое правило должно создавать поток с уникальным сочетанием конечного IP-адреса и конечного порта.</span><span class="sxs-lookup"><span data-stu-id="9cc70-210">Each rule must produce a flow with a unique combination of destination IP address and destination port.</span></span> <span data-ttu-id="9cc70-211">Изменив конечный порт потока, можно с помощью нескольких правил направить потоки на один DIP на разных портах.</span><span class="sxs-lookup"><span data-stu-id="9cc70-211">By varying the destination port of the flow, multiple rules can deliver flows to the same DIP on different ports.</span></span>

<span data-ttu-id="9cc70-212">Пробы работоспособности всегда направлены на DIP виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="9cc70-212">Health probes are always directed to the DIP of a VM.</span></span> <span data-ttu-id="9cc70-213">Убедитесь, что проба отражает состояние работоспособности виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="9cc70-213">You must ensure you that your probe reflects the health of the VM.</span></span>

## <a name="rule-type-2-backend-port-reuse-by-using-floating-ip"></a><span data-ttu-id="9cc70-214">Тип правил 2: внутренние порты используются повторно с помощью плавающего IP-адреса</span><span class="sxs-lookup"><span data-stu-id="9cc70-214">Rule type #2: backend port reuse by using Floating IP</span></span>

<span data-ttu-id="9cc70-215">Azure Load Balancer обеспечивает гибкость, позволяя повторно использовать интерфейсный порт на нескольких виртуальных IP-адресах независимо от того, какой тип правил используется.</span><span class="sxs-lookup"><span data-stu-id="9cc70-215">Azure Load Balancer provides the flexibility to reuse the frontend port across multiple VIPs regardless of the rule type used.</span></span> <span data-ttu-id="9cc70-216">Кроме того, в некоторых сценариях приложений использование одного порта несколькими экземплярами приложения на одной виртуальной машине во внутреннем пуле является предпочтительным или обязательным.</span><span class="sxs-lookup"><span data-stu-id="9cc70-216">Additionally, some application scenarios prefer or require the same port to be used by multiple application instances on a single VM in the backend pool.</span></span> <span data-ttu-id="9cc70-217">К распространенным примерам повторного использования портов относятся виртуальные сетевые устройства, кластеризация для обеспечения высокой доступности и размещение нескольких конечных точек TLS без повторного шифрования.</span><span class="sxs-lookup"><span data-stu-id="9cc70-217">Common examples of port reuse include clustering for high availability, network virtual appliances, and exposing multiple TLS endpoints without re-encryption.</span></span>

<span data-ttu-id="9cc70-218">Если вы хотите, чтобы внутренний порт повторно использовался в нескольких правилах, то в определении правила необходимо активировать плавающий IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="9cc70-218">If you want to reuse the backend port across multiple rules, you must enable Floating IP in the rule definition.</span></span>

<span data-ttu-id="9cc70-219">Плавающий IP-адрес — это часть метода, известного как прямой ответ от сервера (DSR).</span><span class="sxs-lookup"><span data-stu-id="9cc70-219">Floating IP is a portion of what is known as Direct Server Return (DSR).</span></span> <span data-ttu-id="9cc70-220">DSR состоит из двух частей: топологии потока и схемы сопоставления IP-адресов.</span><span class="sxs-lookup"><span data-stu-id="9cc70-220">DSR consists of two parts: a flow topology and an IP address mapping scheme.</span></span> <span data-ttu-id="9cc70-221">На уровне платформы Azure Load Balancer всегда работает в топологии потока DSR независимо от того, активирован ли плавающий IP-адрес.</span><span class="sxs-lookup"><span data-stu-id="9cc70-221">At a platform level, Azure Load Balancer always operates in a DSR flow topology regardless of whether Floating IP is enabled or not.</span></span> <span data-ttu-id="9cc70-222">Это означает, что исходящая часть потока всегда правильно перезаписывается в поток непосредственно обратно в источник.</span><span class="sxs-lookup"><span data-stu-id="9cc70-222">This means that the outbound part of a flow is always correctly rewritten to flow directly back to the origin.</span></span>

<span data-ttu-id="9cc70-223">Для удобства применения Azure предоставляет традиционную схему сопоставления IP-адресов балансировки нагрузки, используя тип правил по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="9cc70-223">With the default rule type, Azure exposes a traditional load balancing IP address mapping scheme for ease of use.</span></span> <span data-ttu-id="9cc70-224">Активация плавающего IP-адреса изменяет схему сопоставления IP-адресов для обеспечения дополнительной гибкости, как описано ниже.</span><span class="sxs-lookup"><span data-stu-id="9cc70-224">Enabling Floating IP changes the IP address mapping scheme to allow for additional flexibility as explained below.</span></span>

<span data-ttu-id="9cc70-225">Эта конфигурация представлена на следующей схеме:</span><span class="sxs-lookup"><span data-stu-id="9cc70-225">The following diagram illustrates this configuration:</span></span>

![Иллюстрация нескольких виртуальных IP-адресов](./media/load-balancer-multivip-overview/load-balancer-multivip-dsr.png)

<span data-ttu-id="9cc70-227">В этом сценарии каждая виртуальная машина во внутреннем пуле имеет три сетевых интерфейса:</span><span class="sxs-lookup"><span data-stu-id="9cc70-227">For this scenario, every VM in the backend pool has three network interfaces:</span></span>

* <span data-ttu-id="9cc70-228">DIP: виртуальная сетевая карта, связанная с виртуальной машиной (IP-конфигурация ресурса сетевой карты Azure).</span><span class="sxs-lookup"><span data-stu-id="9cc70-228">DIP: a Virtual NIC associated with the VM (IP configuration of Azure's NIC resource)</span></span>
* <span data-ttu-id="9cc70-229">VIP1: интерфейс замыкания на себя в гостевой ОС, настроенной с IP-адресом VIP1.</span><span class="sxs-lookup"><span data-stu-id="9cc70-229">VIP1: a loopback interface within guest OS that is configured with IP address of VIP1</span></span>
* <span data-ttu-id="9cc70-230">VIP2: интерфейс замыкания на себя в гостевой ОС, настроенной с IP-адресом VIP2.</span><span class="sxs-lookup"><span data-stu-id="9cc70-230">VIP2: a loopback interface within guest OS that is configured with IP address of VIP2</span></span>

> [!IMPORTANT]
> <span data-ttu-id="9cc70-231">Настройка логических интерфейсов выполняется в гостевой ОС.</span><span class="sxs-lookup"><span data-stu-id="9cc70-231">The configuration of the logical interfaces is performed within the guest OS.</span></span> <span data-ttu-id="9cc70-232">Эта настройка не выполняется и не управляется Azure.</span><span class="sxs-lookup"><span data-stu-id="9cc70-232">This configuration is not performed or managed by Azure.</span></span> <span data-ttu-id="9cc70-233">Без данной настройки правила не будут функционировать.</span><span class="sxs-lookup"><span data-stu-id="9cc70-233">Without this configuration, the rules will not function.</span></span> <span data-ttu-id="9cc70-234">Определения проб работоспособности используют выделенный IP-адрес (DIP) виртуальной машины, а не логический виртуальный IP-адрес (VIP).</span><span class="sxs-lookup"><span data-stu-id="9cc70-234">Health probe definitions use the DIP of the VM rather than the logical VIP.</span></span> <span data-ttu-id="9cc70-235">Поэтому служба должна предоставлять на порте DIP ответы проб, которые отражают состояние службы, предлагаемое на логическом виртуальном IP-адресе.</span><span class="sxs-lookup"><span data-stu-id="9cc70-235">Therefore, your service must provide probe responses on a DIP port that reflect the status of the service offered on the logical VIP.</span></span>

<span data-ttu-id="9cc70-236">Предположим, что интерфейсная конфигурация такая же, как в предыдущем сценарии:</span><span class="sxs-lookup"><span data-stu-id="9cc70-236">Let's assume the same frontend configuration as in the previous scenario:</span></span>

| <span data-ttu-id="9cc70-237">Виртуальный IP-адрес</span><span class="sxs-lookup"><span data-stu-id="9cc70-237">VIP</span></span> | <span data-ttu-id="9cc70-238">IP-адрес</span><span class="sxs-lookup"><span data-stu-id="9cc70-238">IP address</span></span> | <span data-ttu-id="9cc70-239">protocol</span><span class="sxs-lookup"><span data-stu-id="9cc70-239">protocol</span></span> | <span data-ttu-id="9cc70-240">порт</span><span class="sxs-lookup"><span data-stu-id="9cc70-240">port</span></span> |
| --- | --- | --- | --- |
| ![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="9cc70-242">1</span><span class="sxs-lookup"><span data-stu-id="9cc70-242">1</span></span> |<span data-ttu-id="9cc70-243">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="9cc70-243">65.52.0.1</span></span> |<span data-ttu-id="9cc70-244">TCP</span><span class="sxs-lookup"><span data-stu-id="9cc70-244">TCP</span></span> |<span data-ttu-id="9cc70-245">80</span><span class="sxs-lookup"><span data-stu-id="9cc70-245">80</span></span> |
| ![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="9cc70-247">2</span><span class="sxs-lookup"><span data-stu-id="9cc70-247">2</span></span> |<span data-ttu-id="9cc70-248">*65.52.0.2*</span><span class="sxs-lookup"><span data-stu-id="9cc70-248">*65.52.0.2*</span></span> |<span data-ttu-id="9cc70-249">TCP</span><span class="sxs-lookup"><span data-stu-id="9cc70-249">TCP</span></span> |<span data-ttu-id="9cc70-250">80</span><span class="sxs-lookup"><span data-stu-id="9cc70-250">80</span></span> |

<span data-ttu-id="9cc70-251">Мы определим два правила:</span><span class="sxs-lookup"><span data-stu-id="9cc70-251">We define two rules:</span></span>

| <span data-ttu-id="9cc70-252">правило;</span><span class="sxs-lookup"><span data-stu-id="9cc70-252">Rule</span></span> | <span data-ttu-id="9cc70-253">Сопоставить внешний интерфейс</span><span class="sxs-lookup"><span data-stu-id="9cc70-253">Map frontend</span></span> | <span data-ttu-id="9cc70-254">С внутренним пулом</span><span class="sxs-lookup"><span data-stu-id="9cc70-254">To backend pool</span></span> |
| --- | --- | --- |
| <span data-ttu-id="9cc70-255">1</span><span class="sxs-lookup"><span data-stu-id="9cc70-255">1</span></span> |![правило;](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="9cc70-257">VIP1:80</span><span class="sxs-lookup"><span data-stu-id="9cc70-257">VIP1:80</span></span> |![серверная часть](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="9cc70-259">VIP1:80 (на виртуальной машине 1 и виртуальной машине 2)</span><span class="sxs-lookup"><span data-stu-id="9cc70-259">VIP1:80 (in VM1 and VM2)</span></span> |
| <span data-ttu-id="9cc70-260">2</span><span class="sxs-lookup"><span data-stu-id="9cc70-260">2</span></span> |![правило;](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="9cc70-262">VIP2:80</span><span class="sxs-lookup"><span data-stu-id="9cc70-262">VIP2:80</span></span> |![серверная часть](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="9cc70-264">VIP2:80 (на виртуальной машине 1 и виртуальной машине 2)</span><span class="sxs-lookup"><span data-stu-id="9cc70-264">VIP2:80 (in VM1 and VM2)</span></span> |

<span data-ttu-id="9cc70-265">Следующая таблица демонстрирует полное сопоставление в балансировщике нагрузки:</span><span class="sxs-lookup"><span data-stu-id="9cc70-265">The following table shows the complete mapping in the load balancer:</span></span>

| <span data-ttu-id="9cc70-266">правило;</span><span class="sxs-lookup"><span data-stu-id="9cc70-266">Rule</span></span> | <span data-ttu-id="9cc70-267">Виртуальный IP-адрес (VIP)</span><span class="sxs-lookup"><span data-stu-id="9cc70-267">VIP IP address</span></span> | <span data-ttu-id="9cc70-268">protocol</span><span class="sxs-lookup"><span data-stu-id="9cc70-268">protocol</span></span> | <span data-ttu-id="9cc70-269">порт</span><span class="sxs-lookup"><span data-stu-id="9cc70-269">port</span></span> | <span data-ttu-id="9cc70-270">Место назначения</span><span class="sxs-lookup"><span data-stu-id="9cc70-270">Destination</span></span> | <span data-ttu-id="9cc70-271">порт</span><span class="sxs-lookup"><span data-stu-id="9cc70-271">port</span></span> |
| --- | --- | --- | --- | --- | --- |
| ![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="9cc70-273">1</span><span class="sxs-lookup"><span data-stu-id="9cc70-273">1</span></span> |<span data-ttu-id="9cc70-274">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="9cc70-274">65.52.0.1</span></span> |<span data-ttu-id="9cc70-275">TCP</span><span class="sxs-lookup"><span data-stu-id="9cc70-275">TCP</span></span> |<span data-ttu-id="9cc70-276">80</span><span class="sxs-lookup"><span data-stu-id="9cc70-276">80</span></span> |<span data-ttu-id="9cc70-277">совпадает с виртуальным IP-адресом (65.52.0.1)</span><span class="sxs-lookup"><span data-stu-id="9cc70-277">same as VIP (65.52.0.1)</span></span> |<span data-ttu-id="9cc70-278">совпадает с виртуальным IP-адресом (80)</span><span class="sxs-lookup"><span data-stu-id="9cc70-278">same as VIP (80)</span></span> |
| ![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="9cc70-280">2</span><span class="sxs-lookup"><span data-stu-id="9cc70-280">2</span></span> |<span data-ttu-id="9cc70-281">65.52.0.2</span><span class="sxs-lookup"><span data-stu-id="9cc70-281">65.52.0.2</span></span> |<span data-ttu-id="9cc70-282">TCP</span><span class="sxs-lookup"><span data-stu-id="9cc70-282">TCP</span></span> |<span data-ttu-id="9cc70-283">80</span><span class="sxs-lookup"><span data-stu-id="9cc70-283">80</span></span> |<span data-ttu-id="9cc70-284">совпадает с виртуальным IP-адресом (65.52.0.2)</span><span class="sxs-lookup"><span data-stu-id="9cc70-284">same as VIP (65.52.0.2)</span></span> |<span data-ttu-id="9cc70-285">совпадает с виртуальным IP-адресом (80)</span><span class="sxs-lookup"><span data-stu-id="9cc70-285">same as VIP (80)</span></span> |

<span data-ttu-id="9cc70-286">Местом назначения входящего потока является виртуальный IP-адрес в интерфейсе замыкания на себя на виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="9cc70-286">The destination of the inbound flow is the VIP address on the loopback interface in the VM.</span></span> <span data-ttu-id="9cc70-287">Каждое правило должно создавать поток с уникальным сочетанием конечного IP-адреса и конечного порта.</span><span class="sxs-lookup"><span data-stu-id="9cc70-287">Each rule must produce a flow with a unique combination of destination IP address and destination port.</span></span> <span data-ttu-id="9cc70-288">Изменив конечный IP-адрес потока, можно разрешить повторное использование портов на одной виртуальной машине.</span><span class="sxs-lookup"><span data-stu-id="9cc70-288">By varying the destination IP address of the flow, port reuse is possible on the same VM.</span></span> <span data-ttu-id="9cc70-289">Служба предоставляется балансировщику нагрузки через привязку к виртуальному IP-адресу и порту соответствующего интерфейса замыкания на себя.</span><span class="sxs-lookup"><span data-stu-id="9cc70-289">Your service is exposed to the load balancer by binding it to the VIP’s IP address and port of the respective loopback interface.</span></span>

<span data-ttu-id="9cc70-290">Обратите внимание, что в этом примере не изменяется конечный порт.</span><span class="sxs-lookup"><span data-stu-id="9cc70-290">Notice that this example does not change the destination port.</span></span> <span data-ttu-id="9cc70-291">Несмотря на то, что этот сценарий использует плавающий IP-адрес, Azure Load Balancer также поддерживает определение правила, которое перезаписывает внутренний конечный порт и делает его отличным от интерфейсного конечного порта.</span><span class="sxs-lookup"><span data-stu-id="9cc70-291">Even though this is a Floating IP scenario, Azure Load Balancer also supports defining a rule to rewrite the backend destination port and to make it different from the frontend destination port.</span></span>

<span data-ttu-id="9cc70-292">Тип правил с плавающим IP-адресом лежит в основе нескольких шаблонов конфигураций балансировщика нагрузки.</span><span class="sxs-lookup"><span data-stu-id="9cc70-292">The Floating IP rule type is the foundation of several load balancer configuration patterns.</span></span> <span data-ttu-id="9cc70-293">Одним из примеров, доступных в данный момент, является конфигурация [SQL AlwaysOn with Multiple Listeners](../virtual-machines/windows/sql/virtual-machines-windows-portal-sql-ps-alwayson-int-listener.md) (SQL AlwaysOn с несколькими прослушивателями).</span><span class="sxs-lookup"><span data-stu-id="9cc70-293">One example that is currently available is the [SQL AlwaysOn with Multiple Listeners](../virtual-machines/windows/sql/virtual-machines-windows-portal-sql-ps-alwayson-int-listener.md) configuration.</span></span> <span data-ttu-id="9cc70-294">В будущем мы опишем больше сценариев.</span><span class="sxs-lookup"><span data-stu-id="9cc70-294">Over time, we will document more of these scenarios.</span></span>

## <a name="limitations"></a><span data-ttu-id="9cc70-295">Ограничения</span><span class="sxs-lookup"><span data-stu-id="9cc70-295">Limitations</span></span>

* <span data-ttu-id="9cc70-296">Конфигурации с несколькими виртуальными IP-адресами поддерживаются только при использовании виртуальных машин IaaS.</span><span class="sxs-lookup"><span data-stu-id="9cc70-296">Multiple VIP configurations are only supported with IaaS VMs.</span></span>
* <span data-ttu-id="9cc70-297">Если применяется правило с плавающим IP-адресом, то для исходящих потоков в приложении должен использоваться выделенный IP-адрес (DIP).</span><span class="sxs-lookup"><span data-stu-id="9cc70-297">With the Floating IP rule, your application must use the DIP for outbound flows.</span></span> <span data-ttu-id="9cc70-298">Если приложение имеет привязку к виртуальному IP-адресу, настроенному в интерфейсе замыкания на себя в гостевой ОС, то функция SNAT недоступна для перезаписи исходящего потока, и поэтому поток завершается сбоем.</span><span class="sxs-lookup"><span data-stu-id="9cc70-298">If your application binds to the VIP address configured on the loopback interface in the guest OS, then SNAT is not available to rewrite the outbound flow and the flow fails.</span></span>
* <span data-ttu-id="9cc70-299">Общедоступные IP-адреса оказывают влияние на выставление счетов.</span><span class="sxs-lookup"><span data-stu-id="9cc70-299">Public IP addresses have an effect on billing.</span></span> <span data-ttu-id="9cc70-300">Дополнительные сведения см. в статье [Цены на IP-адреса](https://azure.microsoft.com/pricing/details/ip-addresses/).</span><span class="sxs-lookup"><span data-stu-id="9cc70-300">For more information, see [IP Address pricing](https://azure.microsoft.com/pricing/details/ip-addresses/)</span></span>
* <span data-ttu-id="9cc70-301">Действуют ограничения подписки.</span><span class="sxs-lookup"><span data-stu-id="9cc70-301">Subscription limits apply.</span></span> <span data-ttu-id="9cc70-302">Дополнительные сведения см. в разделе [Ограничения определенных служб](../azure-subscription-service-limits.md#networking-limits).</span><span class="sxs-lookup"><span data-stu-id="9cc70-302">For more information, see [Service limits](../azure-subscription-service-limits.md#networking-limits) for details.</span></span>

---
title: "Установка локального шлюза данных в Azure Logic Apps | Документация Майкрософт"
description: "Прежде чем получить доступ к локальным источникам данных, установите локальный шлюз данных для быстрой передачи и шифрования данных между локальными источниками данных и приложениями логики."
keywords: "доступ к данным, локальный, передача данных, шифрование, источники данных"
services: logic-apps
documentationcenter: 
author: jeffhollan
manager: anneta
editor: 
ms.assetid: 47e3024e-88a0-4017-8484-8f392faec89d
ms.service: logic-apps
ms.devlang: 
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: integration
ms.date: 09/14/2017
ms.author: LADocs; millopis; estfan
ms.openlocfilehash: b3c1e2afadea91f010c3e4b43206b6d30a75ec38
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="install-the-on-premises-data-gateway-for-azure-logic-apps"></a>Установка локального шлюза данных для Azure Logic Apps

Чтобы приложения логики могли обращаться к локальным источникам данных, нужно установить и настроить локальный шлюза данных. Этот шлюз используется в качестве моста, обеспечивающего быструю передачу для шифрование данных между локальными системами и приложениями логики. Шлюз ретранслирует данные из локальных источников по шифрованным каналам через служебную шину Azure. Весь трафик поступает как безопасный исходящий трафик от агента шлюза. Дополнительные сведения см. в разделе [Как работает шлюз](#gateway-cloud-service).

Шлюз поддерживает подключения к таким локальным источникам данных:

*   BizTalk Server 2016
*   DB2  
*   Файловая система
*   Informix
*   Магический квадрант
*   MySQL
*   База данных Oracle
*   PostgreSQL
*   сервер приложений SAP; 
*   сервер сообщений SAP;
*   SharePoint
*   SQL Server
*   Teradata

Ниже описывается, как установить локальный шлюз данных перед [настройкой подключения между шлюзом и приложениями логики](./logic-apps-gateway-connection.md). Дополнительные сведения о поддерживаемых соединителях см. статье [Список соединителей](https://docs.microsoft.com/azure/connectors/apis-list). 

Сведения о том, как использовать шлюз с другими службами, см. в следующих статьях:

*   [Локальный шлюз данных](https://powerbi.microsoft.com/documentation/powerbi-gateway-onprem/)
*   [Локальный шлюз данных](../analysis-services/analysis-services-gateway.md)
*   [Управление локальным шлюзом данных в Microsoft Flow](https://flow.microsoft.com/documentation/gateway-manage/)
*   [Управление локальным шлюзом данных в PowerApps](https://powerapps.microsoft.com/tutorials/gateway-management/)

<a name="requirements"></a>

## <a name="requirements"></a>Требования

**Минимальные**:

* .NET Framework 4.5;
* 64-разрядная версия Windows 7 или Windows Server 2008 R2 (или более поздняя версия).

**Рекомендуемые**:

* 8-ядерный ЦП;
* 8 ГБ ОЗУ;
* 64-разрядная версия Windows 2012 R2 (или более поздняя версия).

**Важные сведения**:

* Локальный шлюз данных должен быть установлен только на локальном компьютере.
Нельзя устанавливать его на контроллере домена.

   > [!TIP]
   > Не нужно устанавливать шлюз на компьютере, на котором размещен источник данных. Чтобы свести к минимуму задержки, шлюз можно установить как можно ближе к источнику данных или даже на том же компьютере, если только у вас есть соответствующие разрешения.

* Не стоит устанавливать шлюз на компьютере, который может выключиться, перейти в спящий режим или не сможет подключиться к Интернету. Все эти обстоятельства помешают выполнению шлюза. Кроме того, может наблюдаться снижение производительности шлюза при использовании беспроводной сети.

* Во время установки необходимо войти с помощью [рабочей или учебной учетной записи](https://docs.microsoft.com/azure/active-directory/sign-up-organization), управляемой Azure Active Directory, а не учетной записи Майкрософт.

  > [!TIP]
  > Если вы хотите использовать учетную запись Майкрософт, которая содержит Visual Studio с подпиской MSDN, то сначала [создайте каталог (клиент) в Azure Active Directory](../active-directory/develop/active-directory-howto-tenant.md) с помощью своей учетной записи Майкрософт или используйте каталог по умолчанию. Добавьте в каталог пользователя с паролем, а затем предоставьте этому пользователю доступ к своей подписке. Затем вы можете войти в систему во время установки шлюза, используя эти имя пользователя и пароль.

  Ту же рабочую или учебную учетную запись необходимо использовать позже на портале Azure при создании и связывании ресурса шлюза с установкой шлюза. Затем выберите этот ресурс шлюза при создании подключения между своим приложением логики и локальным источником данных. [Почему необходимо использовать рабочую или учебную учетную запись Azure AD?](#why-azure-work-school-account)

  > [!TIP]
  > Если вы зарегистрировались для использования предложения Office 365 и не предоставили действительный рабочий электронный адрес, то ваш адрес входа может выглядеть так: jeff@contoso.onmicrosoft.com. 

* При наличии шлюза, который был настроен с помощью установщика версии ниже 14.16.6317.4, вы не сможете изменить расположение шлюза, запустив установщик более последней версии. Тем не менее, можно использовать последнюю версию установщика, чтобы настроить новый шлюз с требуемым расположением.
  
  Если у вас есть установщик шлюза версии ниже 14.16.6317.4, но вы еще не установили шлюз, можно скачать и использовать последнюю версию установщика.

<a name="install-gateway"></a>

## <a name="install-the-data-gateway"></a>Установка шлюза данных

1.  [Скачайте и запустите установщик шлюза на локальном компьютере](http://go.microsoft.com/fwlink/?LinkID=820931&clcid=0x409).

2. Просмотрите и примите условия использования и заявление о конфиденциальности.

3. Укажите путь на локальном компьютере для установки шлюза.

4. При появлении запроса войдите в Azure с рабочей или учебной учетной записью (но не с учетной записью Майкрософт).

   ![Войдите с помощью рабочей или учебной учетной записи Azure и](./media/logic-apps-gateway-install/sign-in-gateway-install.png)

5. зарегистрируйте установленный шлюз с помощью [облачной службы шлюза](#gateway-cloud-service). Выберите **Регистрация нового шлюза на этом компьютере**.

   Облачная служба шлюза шифрует и хранит учетные данные источников данных и сведения о шлюзах. 
   Эта служба также передает запросы и их результаты между приложением логики, локальным шлюзом данных и локальными источниками данных.

6. Укажите имя установленного шлюза. Создайте ключ восстановления, а затем подтвердите его. 

   > [!IMPORTANT] 
   > Ключ восстановления должен содержать по крайней мере 8 знаков. Сохраните его в надежном месте. Этот ключ потребуется также, когда возникнет необходимость перенести, восстановить или перехватить имеющийся шлюз.

   1. Чтобы изменить регион по умолчанию для облачной службы шлюза и служебной шины Azure, используемый для установки шлюза, выберите **Изменить регион**.

      ![Изменение региона](./media/logic-apps-gateway-install/change-region-gateway-install.png)

      По умолчанию используется регион, связанный с вашим клиентом Azure AD.

   2. На следующей панели откройте **Выберите регион**, чтобы выбрать другой регион.

      ![Выберите другой регион](./media/logic-apps-gateway-install/select-region-gateway-install.png)

      Например, можно выбрать регион, в котором размещено ваше приложение логики, или регион, ближайший к локальному источнику данных, что позволит уменьшить задержки. Ресурс шлюза и приложение логики могут размещаться в разных расположениях.

      > [!IMPORTANT]
      > После установки изменить выбранный регион будет невозможно. Данный регион также определяет и ограничивает расположение, в котором вы можете создать ресурс Azure для шлюза. Поэтому при создании ресурса шлюза в Azure убедитесь, что расположение этого ресурса соответствует региону, выбранному во время установки шлюза.
      > 
      > Если в дальнейшем потребуется использовать для шлюза другой регион, необходимо будет настроить новый шлюз.

   3. Когда вы будете готовы, нажмите кнопку **Готово**.

7. Теперь выполните приведенные ниже инструкции на портале Azure, чтобы [создать ресурс Azure для шлюза](../logic-apps/logic-apps-gateway-connection.md). 

Дополнительные сведения см. в разделе [Как работает шлюз](#gateway-cloud-service).

## <a name="migrate-restore-or-take-over-an-existing-gateway"></a>Перенос, восстановление или перехват существующего шлюза

Для выполнения этих задач необходим ключ восстановления, который был указан во время установки шлюза.

1. В меню "Пуск" компьютера выберите **Локальный шлюз данных**.

2. После открытия установщика войдите с помощью той же рабочей или учебной учетной записи Azure, которая использовалась при установке шлюза.

3. Выберите **Migrate, restore, or take over an existing gateway** (Перенос, восстановление или перехват имеющегося шлюза).

4. Укажите имя и ключ восстановления для шлюза, который вы хотите перенести, восстановить или перехватить.

<a name="windows-service-account"></a>

## <a name="windows-service-account"></a>Учетная запись службы Windows

Локальный шлюз данных работает как служба Windows и настроен для использования `NT SERVICE\PBIEgwService` в качестве учетных данных входа службы Windows. По умолчанию шлюзу предоставляется право "входа в качестве службы" для компьютера, на котором он установлен. Для создания и обслуживания шлюза на портале Azure учетная запись службы Windows должна иметь по крайней мере разрешения **участника**. 

> [!NOTE]
> Учетная запись службы Windows отличается от учетной записи, которая использовалась для подключения к локальным источникам данных, и от рабочей или учебной учетной записи, которая использовалась для входа в облачные службы.

<a name="restart-gateway"></a>

## <a name="restart-the-gateway"></a>Перезапуск шлюза

Как и любая другая служба Windows, служба шлюза может быть запущена и остановлена различными способами. Например, можно открыть командную строку с дополнительными разрешениями на компьютере, на котором выполняется шлюз, и выполнить одну из команд, приведенных ниже.

* Чтобы остановить службу, выполните указанную ниже команду.
  
    `net stop PBIEgwService`

* Чтобы запустить службу, выполните указанную ниже команду.
  
    `net start PBIEgwService`

## <a name="configure-a-firewall-or-proxy"></a>Настройка брандмауэра или прокси-сервера

Шлюз создает исходящее подключение к [служебной шине Azure](https://azure.microsoft.com/services/service-bus/). Сведения о том, как предоставить данные прокси-сервера для шлюза, см. в статье [Настройка параметров прокси-сервера для локального шлюза данных](https://powerbi.microsoft.com/documentation/powerbi-gateway-proxy/).

Чтобы проверить, не блокирует ли брандмауэр или прокси-сервер подключения, проверьте, действительно ли компьютер может подключиться к Интернету и [служебной шине Azure](https://azure.microsoft.com/services/service-bus/). В командной строке PowerShell выполните следующую команду.

`Test-NetConnection -ComputerName watchdog.servicebus.windows.net -Port 9350`

> [!NOTE]
> Эта команда только проверяет возможность подключения к сети и служебной шине Azure. Поэтому данная команда не относится к шлюзу или облачной службе шлюза, которая шифрует и хранит учетные данные и сведения о шлюзах. 
>
> Кроме того, эта команда используется только в Windows Server 2012 R2 или более поздней версии и Windows 8.1 или более поздней версии. В более ранних версиях ОС для проверки возможности подключения можно использовать Telnet. Узнайте больше о [служебной шине Azure и гибридных решениях](../service-bus-messaging/service-bus-fundamentals-hybrid-solutions.md).

Результаты должны выглядеть примерно как в приведенном примере.

```text
ComputerName           : watchdog.servicebus.windows.net
RemoteAddress          : 70.37.104.240
RemotePort             : 5672
InterfaceAlias         : vEthernet (Broadcom NetXtreme Gigabit Ethernet - Virtual Switch)
SourceAddress          : 10.120.60.105
PingSucceeded          : False
PingReplyDetails (RTT) : 0 ms
TcpTestSucceeded       : True
```

Если значение **TcpTestSucceeded** не равно **True**, возможно, подключения блокируются брандмауэром. Чтобы обеспечить исчерпывающие сведения, замените значения параметров **ComputerName** и **Port** значениями, приведенными ниже в подразделе [Настройка портов](#configure-ports).

Брандмауэр может также блокировать подключения, устанавливаемые служебной шиной Azure с центрами обработки данных Azure. В этом случае разрешите (разблокируйте) все IP-адреса этих центров обработки данных в своем регионе. Чтобы узнать эти IP-адреса, [получите список IP-адресов Azure здесь](https://www.microsoft.com/download/details.aspx?id=41653).

## <a name="configure-ports"></a>Настройка портов

Шлюз создает исходящее подключение к [служебной шине Azure](https://azure.microsoft.com/services/service-bus/) и осуществляет связь через исходящие порты: TCP-порты 443 (по умолчанию), 5671, 5672 и 9350–9354. Шлюзу не требуются входящие порты. Узнайте больше о [служебной шине Azure и гибридных решениях](../service-bus-messaging/service-bus-fundamentals-hybrid-solutions.md).

| ДОМЕННЫЕ ИМЕНА | ИСХОДЯЩИЕ ПОРТЫ | ОПИСАНИЕ |
| --- | --- | --- |
| *.analysis.windows.net | 443 | HTTPS | 
| *.login.windows.net | 443 | HTTPS | 
| *.servicebus.windows.net | 5671–5672 | Протокол AMQP | 
| *.servicebus.windows.net | 443, 9350–9354 | Прослушиватели ретрансляции служебной шины по протоколу TCP (порт 443 требуется для получения маркера контроля доступа). | 
| *.frontend.clouddatahub.net | 443 | HTTPS | 
| *.core.windows.net | 443 | HTTPS | 
| login.microsoftonline.com | 443 | HTTPS | 
| *.msftncsi.com | 443 | Используется для проверки подключения к Интернету, если шлюз недоступен для службы Power BI. | 

Если требуется утвердить IP-адреса, а не домены, то можно скачать и использовать [список диапазонов IP-адресов центров обработки данных Microsoft Azure](https://www.microsoft.com/download/details.aspx?id=41653). В некоторых случаях подключения к служебной шине Azure будут устанавливаться по IP-адресу, а не полному доменному имени.

<a name="gateway-cloud-service"></a>
## <a name="how-does-the-data-gateway-work"></a>Как работает шлюз данных?

Шлюз данных обеспечивает быстрый и безопасный обмен данными между приложением логики, облачной службой шлюза и локальным источником данных. 

![diagram-for-on-premises-data-gateway-flow](./media/logic-apps-gateway-install/how-on-premises-data-gateway-works-flow-diagram.png)

Когда пользователь в облаке взаимодействует с элементом, подключенным к локальному источнику данных, происходит следующее.

1. Облачная служба шлюза создает запрос, а также зашифрованные учетные данные для источника данных, и отправляет запрос в очередь для обработки шлюзом.

2. Облачная служба шлюза анализирует запрос и отправляет его в служебную шину Azure.

3. Локальный шлюз данных опрашивает служебную шину Azure, чтобы проверить наличие ожидающих запросов.

4. Шлюз получает запрос, расшифровывает учетные данные и подключается к источникам данных, используя эти учетные данные.

5. Затем шлюз отправляет запрос к источнику данных для выполнения.

6. Результаты отправляются из источника данных обратно в шлюз, а затем — в облачную службу шлюза. Затем облачная служба шлюза использует эти результаты.

<a name="faq"></a>
## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="general"></a>Общие сведения

**Вопрос**. Нужно ли устанавливать шлюз для источников данных в облаке, например SQL Azure? <br/>
**Ответ**. Нет. Шлюз подключается только к локальным источникам данных.

**Вопрос**. Нужно ли устанавливать шлюз на том же компьютере, на котором находится источник данных? <br/>
**Ответ**. Нет. Шлюз подключается к источнику данных, используя предоставленные сведения о подключении. В этом смысле шлюз можно рассматривать как клиентское приложение. Ему просто необходима возможность подключения к серверу, имя которого было предоставлено.

<a name="why-azure-work-school-account"></a>

**Вопрос**. Почему для входа необходимо использовать рабочую или учебную учетную запись Azure? <br/>
**Ответ**. При установке локального шлюза данных вы можете использовать только рабочую или учебную учетную запись Azure. Учетная запись для входа хранится в клиенте, которым управляет Azure Active Directory (Azure AD). Как правило, имя участника-пользователя учетной записи Azure AD совпадает с адресом электронной почты.

**Вопрос**. Где хранятся мои учетные данные? <br/>
**Ответ**. Учетные данные, введенные для источника данных, хранятся в облачной службе шлюза в зашифрованном виде. Расшифровываются они в локальном шлюзе данных.

**Вопрос**. Есть ли какие-либо требования к пропускной способности сети? <br/>
**Ответ**. Пропускная способность сети должна быть высокой. Все среды разные и объем отправляемых данных влияет на результаты. Гарантировать определенный уровень пропускной способности между локальной средой и центрами обработки данных Azure может помочь применение ExpressRoute.
Измерить текущую пропускную способность можно с помощью стороннего инструмента — приложения Azure Speed Test.

**Вопрос**. Что такое задержка при выполнении запросов к источнику данных из шлюза? Какая архитектура подойдет лучше всего? <br/>
**Ответ**. Чтобы уменьшить задержки в сети, необходимо установить шлюз как можно ближе к источнику данных. Вы можете установить шлюз на фактический источник данных, что сведет к минимуму соответствующие задержки. Для этого также стоит рассмотреть центры обработки данных. Например, если служба использует центр обработки данных в западной части США, а SQL Server размещен на виртуальной машине Azure, то эту виртуальную машину лучше также разместить в западной части США. Это позволит свести к минимуму задержки и избежать затрат на исходящий трафик виртуальной машины Azure.

**Вопрос**. Как результаты отправляются обратно в облако? <br/>
**Ответ**. Результаты отправляются с помощью служебной шины Azure.

**Вопрос**. Устанавливаются ли какие-либо входящие подключения к шлюзу из облака? <br/>
**Ответ**. Нет. Шлюз использует исходящие подключения к служебной шине Azure.

**Вопрос**. Что делать, если мной заблокированы исходящие подключения? Что нужно открыть? <br/>
**Ответ**. Проверьте порты и узлы, которые использует шлюз.

**Вопрос**. Как на самом деле называется служба Windows?<br/>
**Ответ**. В списке служб шлюз называется "Служба Power BI Enterprise Gateway".

**Вопрос**. Может ли служба Windows шлюза работать с учетной записью Azure Active Directory? <br/>
**Ответ**. Нет. Службе Windows требуется действительная учетная запись Windows. По умолчанию служба будет выполняться с идентификатором безопасности службы NT SERVICE\PBIEgwService.

### <a name="high-availability-and-disaster-recovery"></a>Высокий уровень доступности и аварийное восстановление

**Вопрос**. Какие варианты доступны для аварийного восстановления? <br/>
**Ответ**. Вы можете использовать ключ восстановления для восстановления или переноса шлюза. Ключ восстановления указывается при установке шлюза.

**Вопрос**. В чем заключается преимущество ключа восстановления? <br/>
**Ответ.** Он позволяет перенести шлюз или восстановить его параметры после аварии.

**Вопрос**. Существуют ли какие-либо планы по реализации сценариев высокого уровня доступности с помощью шлюза? <br/>
**Ответ**. Это входит в наши планы, однако со сроками в этом отношении мы еще не определились.

## <a name="troubleshooting"></a>Устранение неполадок

[!INCLUDE [existing-gateway-location-changed](../../includes/logic-apps-existing-gateway-location-changed.md)]

**Вопрос**. Как узнать, какие запросы отправляются к локальному источнику данных? <br/>
**Ответ**. Вы можете включить трассировку запросов, в том числе и отправляемых. Не забудьте вернуть исходное значение трассировки запросов после устранения неполадок. При включенной трассировке запросов создаются журналы большего размера.

Кроме того, можно рассмотреть инструменты трассировки запросов, доступные для вашего источника данных. Например, можно использовать расширенные события или SQL Profiler для SQL Server и служб Analysis Services.

**Вопрос**. Где находятся журналы шлюза? <br/>
**Ответ**. См. раздел "Средства" далее в этой статье.

### <a name="update-to-the-latest-version"></a>Обновление до последней версии

При использовании устаревшей версии шлюза может возникать ряд проблем. Рекомендуем убедиться, что используется последняя версия. Если шлюз не обновлялся месяц или дольше, то можно установить его последнюю версию и проверить, получится ли воспроизвести проблему.

### <a name="error-failed-to-add-user-to-group--2147463168-pbiegwservice-performance-log-users"></a>Error: Failed to add user to group. (Ошибка: не удалось добавить пользователя в группу.) (-2147463168 PBIEgwService Performance Log Users ) (-2147463168 пользователей журналов производительности PBIEgwService)

Эта ошибка появляется, если вы пытаетесь установить шлюз на контроллер домена, который не поддерживается. Убедитесь, что развертывание шлюза происходит на компьютере, который не является контроллером домена.

## <a name="tools"></a>Средства

### <a name="collect-logs-from-the-gateway-configurer"></a>Сбор журналов из конфигуратора шлюза

Вы можете собирать несколько журналов для шлюза. Всегда начинайте с журналов!

#### <a name="installer-logs"></a>Журналы установщика

`%localappdata%\Temp\Power_BI_Gateway_–Enterprise.log`

#### <a name="configuration-logs"></a>Журналы конфигурации

`%localappdata%\Microsoft\Power BI Enterprise Gateway\GatewayConfigurator.log`

#### <a name="enterprise-gateway-service-logs"></a>Журналы службы корпоративного шлюза

`C:\Users\PBIEgwService\AppData\Local\Microsoft\Power BI Enterprise Gateway\EnterpriseGateway.log`

#### <a name="event-logs"></a>Журналы событий

Журналы шлюза управления данными и PowerBIGateway находятся в разделе **Журналы приложения и служб**.

### <a name="fiddler-trace"></a>Трассировки Fiddler

[Fiddler](http://www.telerik.com/fiddler) — это бесплатный инструмент от компании Telerik, который отслеживает трафик HTTP. Вы можете просматривать данные с помощью службы Power BI с клиентского компьютера. Эта служба позволит выявить ошибки и другие сопутствующие сведения.

## <a name="next-steps"></a>Дальнейшие действия
    
* [Подключение к локальным данным из приложений логики](../logic-apps/logic-apps-gateway-connection.md)
* [Возможности интеграции Enterprise](../logic-apps/logic-apps-enterprise-integration-overview.md)
* [Список соединителей](../connectors/apis-list.md)

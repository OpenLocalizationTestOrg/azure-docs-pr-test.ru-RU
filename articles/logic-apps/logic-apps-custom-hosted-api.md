---
title: "Развертывание, вызов и проверка подлинности веб-интерфейсов API и интерфейсов REST API для приложений логики Azure | Документация Майкрософт"
description: "Развертывание, проверка подлинности и вызов веб-интерфейсов API и интерфейсов REST API в рабочих процессах для интеграции системы с приложениями логики Azure"
keywords: "веб-интерфейсы API, интерфейсы REST API, соединители, рабочие процессы, интеграция системы, проверка подлинности"
services: logic-apps
author: stepsic-microsoft-com
manager: anneta
editor: 
documentationcenter: 
ms.assetid: f113005d-0ba6-496b-8230-c1eadbd6dbb9
ms.service: logic-apps
ms.workload: integration
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/26/2017
ms.author: LADocs; stepsic
ms.openlocfilehash: 88c62d5ab046d8cf4bce5d23b776e517bb0e1d87
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="deploy-call-and-authenticate-custom-apis-as-connectors-for-logic-apps"></a>Развертывание, вызов и проверка подлинности пользовательских API в качестве соединителей для приложений логики

После [создания пользовательских API](./logic-apps-create-api-app.md), которые предоставляют действия или триггеры, используемые в рабочих процессах приложений логики, необходимо развернуть эти API, прежде чем их вызывать. Хотя из приложения логики можно вызвать любой API, для получения наилучших результатов добавьте [метаданные Swagger](http://swagger.io/specification/), которые описывают операции и параметры вашего API. Этот файл Swagger позволяет улучшить работу API и упростить его интеграцию с приложениями логики.

API-интерфейсы можно развернуть в качестве [веб-приложений](../app-service-web/app-service-web-overview.md), но лучше их развернуть в качестве [приложений API](../app-service-api/app-service-api-apps-why-best-platform.md), что облегчит создание, размещение и использование API-интерфейсов как в облаке, так и в локальной среде. Не нужно изменять код в API-интерфейсах, просто разверните свой код в приложении API. API-интерфейсы можно разместить в [службе приложений Azure](../app-service/app-service-value-prop-what-is.md). Это служба PaaS (платформа как услуга), предоставляющая один из лучших и самых удобных способов размещения API с максимальным уровнем масштабирования.

Для проверки подлинности вызовов из приложений логики к API-интерфейсам настройте Azure Active Directory на портале Azure, чтобы не обновлять код. Вы можете также применить обязательную проверку подлинности с помощью кода API.

## <a name="deploy-your-api-as-a-web-app-or-api-app"></a>Развертывание API в качестве веб-приложения или приложения API

Прежде чем вызвать настраиваемый API из приложения логики, разверните его в качестве веб-приложения или приложения API в службе приложений Azure. Также задайте свойства определения API и включите [общий доступ к ресурсам независимо от источника (CORS)](../app-service-api/app-service-api-cors-consume-javascript.md#corsconfig) для веб-приложения или приложения API, чтобы конструктор приложений логики мог считать документ Swagger.

1. На портале Azure выберите веб-приложение или приложение API.

2. В открывшейся колонке в разделе **API** выберите **Определение API**. Задайте в качестве значения параметра **Расположение определения API** URL-адрес файла swagger.json.

   Как правило, URL-адрес отображается в таком формате: `https://{name}.azurewebsites.net/swagger/docs/v1)`

   ![Ссылка на файл Swagger для настраиваемого API](media/logic-apps-custom-hosted-api/custom-api-swagger-url.png)

3. В разделе **API** выберите **CORS**. Задайте для параметра **Разрешенные источники** политики CORS значение **"*"** (разрешить все).

   Этот параметр разрешает запросы из конструктора приложений логики.

   ![Разрешение запросов из конструктора приложений логики для настраиваемого API](media/logic-apps-custom-hosted-api/custom-api-cors.png)

Дополнительные сведения вы найдете в следующих статьях:

* [Использование метаданных и пользовательского интерфейса API Swagger](../app-service-api/app-service-api-dotnet-get-started.md#use-swagger-api-metadata-and-ui)
* [Приступая к работе с приложениями API, ASP.NET и Swagger в службе приложений Azure](../app-service-api/app-service-api-dotnet-get-started.md)

## <a name="call-your-custom-api-from-logic-app-workflows"></a>Вызов настраиваемого API из рабочих процессов приложения логики

После настройки CORS и свойств определения API триггеры и действия в пользовательском API должны стать доступными, чтобы вы могли включить их в рабочий процесс приложения логики. 

*  Чтобы просмотреть веб-сайты с URL-адресом Swagger, просмотрите веб-сайты, относящиеся к вашей подписке, в конструкторе приложений логики.

*  Чтобы просмотреть доступные действия и входные данные, указав документ Swagger, используйте действие [HTTP и Swagger](../connectors/connectors-native-http-swagger.md).

*  Чтобы вызвать любой API, даже тот, который не имеет документа Swagger или не предоставляет его, всегда можно создать запрос с помощью [действия HTTP](../connectors/connectors-native-http.md).

## <a name="authenticate-calls-to-your-custom-api"></a>Проверка подлинности вызовов к настраиваемому API

Защитить вызовы к настраиваемому API можно следующими способами:

* [Без изменения кода.](#no-code) Защитите API с помощью [Azure Active Directory (Azure AD)](../active-directory/active-directory-whatis.md) на портале Azure, чтобы не обновлять код и не развертывать API повторно.

  > [!NOTE]
  > По умолчанию проверка подлинности Azure AD, которую можно включить на портале Azure, не обеспечивает детального уровня авторизации. Например, при такой проверке подлинности API блокируется только для конкретного арендатора, а не для определенного пользователя или приложения. 

* [Обновление кода API.](#update-code). Защитите API, применив [проверку подлинности на основе сертификата](#certificate), [обычную проверку подлинности](#basic) или [проверку подлинности Azure AD](#azure-ad-code) с помощью кода.

<a name="no-code"></a>

### <a name="authenticate-calls-to-your-api-without-changing-code"></a>Проверка подлинности вызовов к API без изменения кода

Вот основные действия для применения этого метода:

1. Создайте два [удостоверения приложений Azure Active Directory (Azure AD)](../app-service-api/app-service-api-dotnet-service-principal-auth.md): одно для приложения логики, а другое — для веб-приложения или приложения API.

2. Чтобы проверить подлинность вызовов к API, используйте учетные данные (идентификатор и секрет клиента) [субъекта-службы](../app-service-api/app-service-api-dotnet-service-principal-auth.md), связанного с удостоверением приложения Azure AD для приложения логики.

3. Добавьте идентификаторы приложений в определение приложения логики.

#### <a name="part-1-create-an-azure-ad-application-identity-for-your-logic-app"></a>Часть 1. Создание удостоверения приложения Azure AD для приложения логики

Приложение логики использует это удостоверение приложения Azure AD для проверки подлинности в Azure AD. Для вашего каталога это удостоверение необходимо настроить только один раз. Например, вы можете использовать одно удостоверение для всех приложений логики или создать отдельные удостоверения для каждого из них. Эти удостоверения можно настроить на портале Azure, на [классическом портале Azure](#app-identity-logic-classic) или с помощью [PowerShell](#powershell).

**Создание удостоверения для приложения логики на портале Azure**

1. На [портале Azure](https://portal.azure.com "https://portal.azure.com") выберите **Azure Active Directory**. 

2. Убедитесь, что вы открыли каталог своего веб-приложения или приложения API.

   > [!TIP]
   > Для перехода между каталогами щелкните свой профиль и выберите другой каталог. Или выберите **Обзор** > **Переключение каталога**.

3. В разделе **Управление** в меню каталога выберите **Регистрация приложений** > **Регистрация нового приложения**.

   > [!TIP]
   > По умолчанию в списке регистрации приложений отображаются записи о регистрации всех приложений в каталоге. Чтобы просмотреть записи о регистрации только своих приложений, рядом с полем поиска выберите **Мои приложения**. 

   ![Создание регистрации приложения](./media/logic-apps-custom-hosted-api/new-app-registration-azure-portal.png)

4. Присвойте имя удостоверению приложения, оставьте для параметра **Тип приложения** значение **Веб-приложение или API**, укажите уникальную строку в формате домена в поле **URL-адрес для входа** и нажмите кнопку **Создать**.

   ![Указание имени и URL-адреса входа для удостоверения приложения](./media/logic-apps-custom-hosted-api/logic-app-identity-azure-portal.png)

   Удостоверение приложения, созданное для приложения логики, теперь отображается в списке регистрации приложений.

   ![Удостоверение приложения логики](./media/logic-apps-custom-hosted-api/logic-app-identity-created.png)

5. В списке регистрации приложений выберите новое удостоверение приложения. Скопируйте и сохраните **идентификатор приложения**, чтобы использовать его в качестве идентификатора клиента для приложения логики в части 3.

   ![Копирование и сохранение идентификатора приложения для приложения логики](./media/logic-apps-custom-hosted-api/logic-app-application-id.png)

6. Если параметры удостоверения приложения не отображаются, щелкните **Параметры** или **Все параметры**.

7. В разделе **Доступ через API** выберите **Ключи**. В поле **Описание** введите имя для ключа. Выберите **срок действия** ключа в соответствующем поле.

   Ключ, который вы создаете, выступает в качестве "секрета" или пароля для удостоверения приложения логики.

   ![Создание ключа для удостоверения приложения логики](./media/logic-apps-custom-hosted-api/create-logic-app-identity-key-secret-password.png)

8. На панели инструментов нажмите кнопку **Сохранить**. Ключ отобразится в разделе **Значение**. 
**Скопируйте и сохраните ключ** для дальнейшего использования, так как он будет скрыт, если вы выйдете из колонки ключа.

   При настройке приложения логики в части 3 потребуется указать этот ключ в качестве "секрета" или пароля.

   ![Копирование и сохранение ключа для дальнейшего использования](./media/logic-apps-custom-hosted-api/logic-app-copy-key-secret-password.png)

<a name="app-identity-logic-classic"></a>

**Создание удостоверения приложения логики на классическом портале Azure**

1. На классическом портале Azure перейдите в раздел [**Azure Active Directory**](https://manage.windowsazure.com/#Workspaces/ActiveDirectoryExtension/directory).

2. Выберите каталог, который используется для веб-приложения или приложения API.

3. На вкладке **Приложения** щелкните **Добавить** в нижней части страницы.

4. Присвойте удостоверению приложения имя и щелкните **Далее** (стрелка вправо).

5. В разделе **Свойства приложения** укажите уникальную строку в формате домена для параметров **URL-адрес для входа** и **URI кода приложения** и щелкните **Завершено** (значок флажка).

6. На вкладке **Настройка** скопируйте и сохраните **идентификатор клиента**, чтобы использовать его для приложения логики в части 3.

7. В разделе **Ключи** откройте список **Выбрать длительность**. Выберите срок действия ключа.

   Ключ, который вы создаете, выступает в качестве "секрета" или пароля для удостоверения приложения логики.

8. В нижней части страницы нажмите кнопку **Сохранить**. Возможно, потребуется подождать несколько секунд.

9. Скопируйте и сохраните ключ, который отображается в разделе **Ключи**. 

   При настройке приложения логики в части 3 потребуется указать этот ключ в качестве "секрета" или пароля.

Дополнительные сведения см. в статье [Настройка приложения службы приложений для использования службы входа Azure Active Directory](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md).

<a name="powershell"></a>

**Создание удостоверения приложения логики в PowerShell**

Эту задачу можно выполнить в Azure Resource Manager с помощью PowerShell. Выполните следующие команды в PowerShell:

1. `Switch-AzureMode AzureResourceManager`

2. `Add-AzureAccount`

3. `New-AzureADApplication -DisplayName "MyLogicAppID" -HomePage "http://mydomain.tld" -IdentifierUris "http://mydomain.tld" -Password "identity-password"`

4. Скопируйте использованные ранее **идентификатор клиента** (GUID для клиента Azure AD), **идентификатор приложения** и пароль.

Дополнительные сведения см. в статье [Использование Azure PowerShell для создания субъекта-службы и доступа к ресурсам](../azure-resource-manager/resource-group-authenticate-service-principal.md).

#### <a name="part-2-create-an-azure-ad-application-identity-for-your-web-app-or-api-app"></a>Часть 2. Создание удостоверения приложения Azure AD для веб-приложения или приложения API

Если веб-приложение или приложение API уже развернуты, можно включить проверку подлинности и создать удостоверение приложения на портале Azure. В противном случае вы можете [включить проверку подлинности при развертывании с использованием шаблона Azure Resource Manager](#authen-deploy). 

**Создание удостоверения приложения и включение проверки подлинности для развернутых приложений на портале Azure**

1. На [портале Azure](https://portal.azure.com "https://portal.azure.com") найдите и выберите свое веб-приложение или приложение API. 

2. В разделе **Параметры** выберите **Аутентификация или авторизация**. В разделе **Проверка подлинности службы приложений** включите проверку подлинности, нажав кнопку **Вкл.** В разделе **Поставщики проверки подлинности** щелкните **Azure Active Directory**.

   ![Включение проверки подлинности](./media/logic-apps-custom-hosted-api/custom-web-api-app-authentication.png)

3. Теперь создайте удостоверение приложения для веб-приложения или приложения API, как показано ниже. В колонке **Параметры Azure Active Directory** для параметра **Режим управления** установите значение **Экспресс**. Щелкните **Создать новое приложение AD**. Присвойте удостоверению приложения имя и нажмите кнопку **ОК**. 

   ![Создание удостоверения приложения для веб-приложения или приложения API](./media/logic-apps-custom-hosted-api/custom-api-application-identity.png)

4. В колонке **Проверка подлинности/авторизация** нажмите кнопку **Сохранить**.

Теперь необходимо найти идентификаторы клиента и арендатора для удостоверения приложения, связанного с веб-приложением или приложением API. Используйте эти идентификаторы в части 3. Выполните следующие шаги на портале Azure или на [классическом портале Azure](#find-id-classic).

**Поиск идентификаторов клиента и арендатора удостоверения для веб-приложения или приложения API на портале Azure**

1. В разделе **Поставщики проверки подлинности** щелкните **Azure Active Directory**. 

   ![Выбор элемента Azure Active Directory](./media/logic-apps-custom-hosted-api/custom-api-app-identity-client-id-tenant-id.png)

2. В колонке **Параметры Azure Active Directory** для параметра **Режим управления** установите значение **Расширенный**.

3. Скопируйте **идентификатор клиента** и сохраните этот GUID для использования в части 3.

   > [!TIP] 
   > Если **идентификатор клиента** и **URL-адрес издателя** не отображаются, обновите портал Azure и повторите шаг 1.

4. В разделе **URL-адрес издателя** скопируйте и сохраните только GUID для части 3. При необходимости вы также можете использовать этот GUID в шаблоне развертывания веб-приложения или приложения API.

   Этот GUID — идентификатор определенного арендатора (ИД арендатора), который должен отображаться в следующем URL-адресе: `https://sts.windows.net/{GUID}`

5. Не сохраняя изменений, закройте колонку **Параметры Azure Active Directory**.

<a name="find-id-classic"></a>

**Поиск идентификаторов клиента и арендатора удостоверения для веб-приложения или приложения API на классическом портале Azure**

1. На классическом портале Azure перейдите в раздел [**Azure Active Directory**](https://manage.windowsazure.com/#Workspaces/ActiveDirectoryExtension/directory).

2.  Выберите каталог, используемый для веб-приложения или приложения API.

3. В поле **поиска** найдите и выберите удостоверение для веб-приложения или приложения API.

4. На вкладке **Настройка** скопируйте **идентификатор клиента** и сохраните этот GUID для использования в части 3.

5. Получив идентификатор клиента, в нижней части вкладки **Настройка** щелкните **Просмотр конечных точек**.

6. Скопируйте URL-адрес **документа метаданных федерации** и перейдите по этому адресу.

7. В открывшемся документе метаданных найдите корневой элемент **EntityDescriptor ID** с атрибутом **entityID** в таком формате: `https://sts.windows.net/{GUID}` 

      GUID в этом атрибуте — идентификатор определенного арендатора (ИД арендатора).

8. Скопируйте ИД арендатора и сохраните его для использования в части 3, а также в шаблоне развертывания веб-приложения или приложения API (при необходимости).

Дополнительные сведения см. в следующих статьях:

* [Проверка подлинности пользователя для приложений API в службе приложений Azure](../app-service-api/app-service-api-dotnet-user-principal-auth.md)
* [Проверка подлинности и авторизация в службе приложений Azure](../app-service/app-service-authentication-overview.md)

<a name="authen-deploy"></a>

**Проверка подлинности и авторизация в службе приложений Azure**

Вам все же потребуется создать удостоверение приложения Azure AD для веб-приложения или приложения API, которое отличается от удостоверения приложения логики. Чтобы создать удостоверение приложения, выполните шаги на портале Azure, приведенные в части 2. Вы также можете выполнить шаги, приведенные в части 1, но при этом обязательно укажите фактическое значение `https://{URL}` веб-приложения или приложения API для параметров **URL-адрес для входа** и **URI кода приложения**. В этих шагах необходимо сохранить идентификаторы клиента и арендатора, чтобы использовать их в шаблоне развертывания приложения и в части 3.

> [!NOTE]
> При создании удостоверения приложения Azure AD для веб-приложения или приложения API необходимо использовать портал Azure или классический портал Azure, а не PowerShell. Командлет PowerShell не поддерживает настройку необходимых разрешений для входа пользователей на веб-сайт.

Получив идентификаторы клиента и арендатора, добавьте их в шаблон развертывания в качестве подресурса веб-приложения или приложения API.

   ```
   "resources": [
       {
           "apiVersion": "2015-08-01",
           "name": "web",
           "type": "config",
           "dependsOn": ["[concat('Microsoft.Web/sites/','parameters('webAppName'))]"],
           "properties": {
               "siteAuthEnabled": true,
               "siteAuthSettings": {
                 "clientId": "{client-ID}",
                 "issuer": "https://sts.windows.net/{tenant-ID}/",
               }
           }
       }
   ]
   ```

Чтобы автоматически развернуть пустое веб-приложение и приложение логики и включить проверку подлинности с помощью Azure Active Directory, просмотрите полный шаблон [здесь](https://github.com/Azure/azure-quickstart-templates/tree/master/201-logic-app-custom-api/azuredeploy.json) или щелкните **Развертывание в Azure**:

[![Развертывание в Azure](media/logic-apps-custom-hosted-api/deploybutton.png)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F201-logic-app-custom-api%2Fazuredeploy.json)

#### <a name="part-3-populate-the-authorization-section-in-your-logic-app"></a>Часть 3. Заполнение раздела авторизации в приложении логики

В предыдущем шаблоне этот раздел авторизации уже настроен. Но если вы разрабатываете приложение логики полностью самостоятельно, вам потребуется включить весь раздел авторизации.

Откройте определение приложения логики в представлении кода, перейдите к разделу действия **HTTP**, найдите раздел **Авторизация** и добавьте следующую строку:

`{"tenant": "{tenant-ID}", "audience": "{client-ID-from-Part-2-web-app-or-API app}", "clientId": "{client-ID-from-Part-1-logic-app}", "secret": "{key-from-Part-1-logic-app}", "type": "ActiveDirectoryOAuth" }`

| Элемент | Описание |
| ------- | ----------- |
| tenant |GUID для арендатора Azure AD. |
| audience |обязательный параметр. GUID целевого ресурса, к которому требуется доступ, — идентификатор клиента из удостоверения приложения для веб-приложения или приложения API. |
| clientid |GUID клиента, запрашивающего доступ, — идентификатор клиента из удостоверения приложения логики. |
| secret |обязательный параметр. Ключ или пароль из удостоверения приложения для клиента, который запрашивает маркер доступа. |
| Тип |Тип проверки подлинности. Для аутентификации ActiveDirectoryOAuth это значение равно `ActiveDirectoryOAuth`. |

Например:

```
{
   ...
   "actions": {
      "some-action": {
         "conditions": [],
         "inputs": {
            "method": "post",
            "uri": "https://your-api-azurewebsites.net/api/your-method",
            "authentication": {
               "tenant": "tenant-ID",
               "audience": "client-ID-from-azure-ad-app-for-web-app-or-api-app",
               "clientId": "client-ID-from-azure-ad-app-for-logic-app",
               "secret": "key-from-azure-ad-app-for-logic-app",
               "type": "ActiveDirectoryOAuth"
            }
         },
      }
   }
}
```

<a name="update-code"></a>

### <a name="secure-api-calls-through-code"></a>Безопасные вызовы API с помощью кода

<a name="certificate"></a>

#### <a name="certificate-authentication"></a>Проверка подлинности на основе сертификата

Вы можете использовать сертификаты клиента для проверки входящих запросов из приложения логики к веб-приложению или приложению API. Чтобы узнать, как настроить код, см. статью о [настройке взаимной проверки подлинности TLS](../app-service-web/app-service-web-configure-tls-mutual-auth.md).

В разделе **Авторизация** добавьте следующую строку: 

`{"type": "clientcertificate", "password": "password", "pfx": "long-pfx-key"}`

| Элемент | Описание |
| ------- | ----------- |
| type |обязательный параметр. Тип проверки подлинности. Для SSL-сертификатов клиента используйте значение `ClientCertificate`. |
| пароль |обязательный параметр. Пароль для доступа к сертификату клиента (PFX-файл). |
| pfx |обязательный параметр. Содержимое сертификата клиента в кодировке Base64 (PFX-файл). |

<a name="basic"></a>

#### <a name="basic-authentication"></a>Обычная аутентификация

Для проверки входящих запросов из приложения логики к веб-приложениям или приложениям API можно использовать обычную проверку подлинности: имя пользователя и пароль. Обычная проверка подлинности — это универсальный вариант, который подходит для веб-приложений и приложений API, написанных на любых языках программирования.

В разделе **Авторизация** добавьте следующую строку:

`{"type": "basic", "username": "username", "password": "password"}`.

| Элемент | Описание |
| --- | --- |
| type |обязательный параметр. Тип проверки подлинности. Для обычной проверки подлинности используйте значение `Basic`. |
| Имя пользователя |обязательный параметр. Имя пользователя для проверки подлинности. |
| пароль |обязательный параметр. Пароль для проверки подлинности. |

<a name="azure-ad-code"></a>

#### <a name="azure-active-directory-authentication-through-code"></a>Проверка подлинности Azure Active Directory с помощью кода

По умолчанию проверка подлинности Azure AD, которую можно включить на портале Azure, не обеспечивает детального уровня авторизации. Например, при такой проверке подлинности API блокируется только для конкретного арендатора, а не для определенного пользователя или приложения. 

Чтобы ограничить доступ через API к приложению логики с помощью кода, извлеките заголовок, который содержит маркер JSON Web Token (JWT). Проверяйте удостоверение вызывающей стороны и отклоняйте запросы, не отвечающие требованиям.

Чтобы реализовать проверку подлинности полностью в коде, не используя портал Azure, ознакомьтесь со статьей [Проверка подлинности в приложении Azure с помощью локального каталога Active Directory](../app-service-web/web-sites-authentication-authorization.md).

Чтобы создать удостоверение для приложения логики и с его помощью вызвать API, вам потребуется выполнить приведенные выше шаги.

## <a name="next-steps"></a>Дальнейшие действия

* [Проверка производительности и включение ведения журналов и оповещений системы диагностики для рабочих процессов в приложениях логики](logic-apps-monitor-your-logic-apps.md)
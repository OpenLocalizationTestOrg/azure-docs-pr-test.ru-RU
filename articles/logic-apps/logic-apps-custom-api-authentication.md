---
title: "Добавление аутентификации в пользовательские API в Azure Logic Apps | Документация Майкрософт"
description: "Настройка аутентификации для вызовов к пользовательским API из приложений логики"
author: ecfan
manager: anneta
editor: 
services: logic-apps
documentationcenter: 
ms.assetid: 
ms.service: logic-apps
ms.workload: logic-apps
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 09/22/2017
ms.author: LADocs; estfan
ms.openlocfilehash: 2528f4318d92bbfdc1008795876f0240a5e3e4f6
ms.sourcegitcommit: f8437edf5de144b40aed00af5c52a20e35d10ba1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/03/2017
---
# <a name="secure-calls-to-your-custom-apis-from-logic-apps"></a>Защита вызовов к пользовательским API из приложений логики

Для защиты вызовов к интерфейсам API настройте аутентификацию Azure Active Directory (Azure AD) на портале Azure, чтобы не обновлять код. Вы можете также применить обязательную проверку подлинности с помощью кода API.

## <a name="authentication-options-for-your-api"></a>Параметры аутентификации для API

Защитить вызовы к настраиваемому API можно следующими способами:

* [Без изменения кода.](#no-code) Защитите API с помощью [Azure Active Directory (Azure AD)](../active-directory/active-directory-whatis.md) на портале Azure, чтобы не обновлять код и не развертывать API повторно.

  > [!NOTE]
  > По умолчанию проверка подлинности Azure AD, которую можно включить на портале Azure, не обеспечивает детального уровня авторизации. Например, при такой проверке подлинности API блокируется только для конкретного арендатора, а не для определенного пользователя или приложения. 

* [Обновление кода API](#update-code). Защитите API, применив [проверку подлинности на основе сертификата](#certificate), [обычную проверку подлинности](#basic) или [проверку подлинности Azure AD](#azure-ad-code) с помощью кода.

<a name="no-code"></a>

### <a name="authenticate-calls-to-your-api-without-changing-code"></a>Проверка подлинности вызовов к API без изменения кода

Вот основные действия для применения этого метода:

1. Создайте два удостоверения приложений Azure Active Directory (Azure AD): одно для приложения логики, а другое — для веб-приложения или приложения API.

2. Для аутентификации вызовов к API используйте учетные данные (идентификатор и секрет клиента) субъекта-службы, связанного с удостоверением приложения Azure AD для приложения логики.

3. Добавьте идентификаторы приложений в определение приложения логики.

#### <a name="part-1-create-an-azure-ad-application-identity-for-your-logic-app"></a>Часть 1. Создание удостоверения приложения Azure AD для приложения логики

Приложение логики использует это удостоверение приложения Azure AD для проверки подлинности в Azure AD. Для вашего каталога это удостоверение необходимо настроить только один раз. Например, вы можете использовать одно удостоверение для всех приложений логики или создать отдельные удостоверения для каждого из них. Вы можете настроить эти удостоверения на портале Azure или с помощью [PowerShell](#powershell).

**Создание удостоверения для приложения логики на портале Azure**

1. На [портале Azure](https://portal.azure.com "https://portal.azure.com") выберите **Azure Active Directory**. 

2. Убедитесь, что вы открыли каталог своего веб-приложения или приложения API.

   > [!TIP]
   > Для перехода между каталогами щелкните свой профиль и выберите другой каталог. Или выберите **Обзор** > **Переключение каталога**.

3. В разделе **Управление** в меню каталога выберите **Регистрация приложений** > **Регистрация нового приложения**.

   > [!TIP]
   > По умолчанию в списке регистрации приложений отображаются записи о регистрации всех приложений в каталоге. Чтобы просмотреть записи о регистрации только своих приложений, рядом с полем поиска выберите **Мои приложения**. 

   ![Создание регистрации приложения](./media/logic-apps-custom-api-authentication/new-app-registration-azure-portal.png)

4. Присвойте имя удостоверению приложения, оставьте для параметра **Тип приложения** значение **Веб-приложение или API**, укажите уникальную строку в формате домена в поле **URL-адрес для входа** и нажмите кнопку **Создать**.

   ![Указание имени и URL-адреса входа для удостоверения приложения](./media/logic-apps-custom-api-authentication/logic-app-identity-azure-portal.png)

   Удостоверение приложения, созданное для приложения логики, теперь отображается в списке регистрации приложений.

   ![Удостоверение приложения логики](./media/logic-apps-custom-api-authentication/logic-app-identity-created.png)

5. В списке регистрации приложений выберите новое удостоверение приложения. Скопируйте и сохраните **идентификатор приложения**, чтобы использовать его в качестве идентификатора клиента для приложения логики в части 3.

   ![Копирование и сохранение идентификатора приложения для приложения логики](./media/logic-apps-custom-api-authentication/logic-app-application-id.png)

6. Если параметры удостоверения приложения не отображаются, щелкните **Параметры** или **Все параметры**.

7. В разделе **Доступ через API** выберите **Ключи**. В поле **Описание** введите имя для ключа. Выберите **срок действия** ключа в соответствующем поле.

   Ключ, который вы создаете, выступает в качестве "секрета" или пароля для удостоверения приложения логики.

   ![Создание ключа для удостоверения приложения логики](./media/logic-apps-custom-api-authentication/create-logic-app-identity-key-secret-password.png)

8. На панели инструментов нажмите кнопку **Сохранить**. Ключ отобразится в разделе **Значение**. 
**Скопируйте и сохраните ключ** для дальнейшего использования, так как он будет скрыт, если вы покинете страницу **Ключи**.

   При настройке приложения логики в части 3 потребуется указать этот ключ в качестве "секрета" или пароля.

   ![Копирование и сохранение ключа для дальнейшего использования](./media/logic-apps-custom-api-authentication/logic-app-copy-key-secret-password.png)

<a name="powershell"></a>

**Создание удостоверения приложения логики в PowerShell**

Эту задачу можно выполнить в Azure Resource Manager с помощью PowerShell. Выполните следующие команды в PowerShell:

1. `Switch-AzureMode AzureResourceManager`

2. `Add-AzureAccount`

3. `New-AzureADApplication -DisplayName "MyLogicAppID" -HomePage "http://mydomain.tld" -IdentifierUris "http://mydomain.tld" -Password "identity-password"`

4. Скопируйте использованные ранее **идентификатор клиента** (GUID для клиента Azure AD), **идентификатор приложения** и пароль.

Дополнительные сведения см. в статье [Использование Azure PowerShell для создания субъекта-службы и доступа к ресурсам](../azure-resource-manager/resource-group-authenticate-service-principal.md).

#### <a name="part-2-create-an-azure-ad-application-identity-for-your-web-app-or-api-app"></a>Часть 2. Создание удостоверения приложения Azure AD для веб-приложения или приложения API

Если веб-приложение или приложение API уже развернуты, можно включить проверку подлинности и создать удостоверение приложения на портале Azure. В противном случае вы можете [включить проверку подлинности при развертывании с использованием шаблона Azure Resource Manager](#authen-deploy). 

**Создание удостоверения приложения и включение проверки подлинности для развернутых приложений на портале Azure**

1. На [портале Azure](https://portal.azure.com "https://portal.azure.com") найдите и выберите свое веб-приложение или приложение API. 

2. В разделе **Параметры** выберите **Аутентификация или авторизация**. В разделе **Проверка подлинности службы приложений** включите проверку подлинности, нажав кнопку **Вкл.** В разделе **Поставщики проверки подлинности** щелкните **Azure Active Directory**.

   ![Включение проверки подлинности](./media/logic-apps-custom-api-authentication/custom-web-api-app-authentication.png)

3. Теперь создайте удостоверение приложения для веб-приложения или приложения API, как показано ниже. На странице **Параметры Azure Active Directory** для параметра **Режим управления** установите значение **Экспресс**. Щелкните **Создать новое приложение AD**. Присвойте удостоверению приложения имя и нажмите кнопку **ОК**. 

   ![Создание удостоверения приложения для веб-приложения или приложения API](./media/logic-apps-custom-api-authentication/custom-api-application-identity.png)

4. На странице **Аутентификация или авторизация** щелкните **Сохранить**.

Теперь необходимо найти идентификаторы клиента и арендатора для удостоверения приложения, связанного с веб-приложением или приложением API. Используйте эти идентификаторы в части 3. Выполните следующие шаги на портале Azure.

**Поиск идентификаторов клиента и арендатора удостоверения для веб-приложения или приложения API на портале Azure**

1. В разделе **Поставщики проверки подлинности** щелкните **Azure Active Directory**. 

   ![Выбор элемента Azure Active Directory](./media/logic-apps-custom-api-authentication/custom-api-app-identity-client-id-tenant-id.png)

2. На странице **Параметры Azure Active Directory** для параметра **Режим управления** установите значение **Расширенный**.

3. Скопируйте **идентификатор клиента** и сохраните этот GUID для использования в части 3.

   > [!TIP] 
   > Если **идентификатор клиента** и **URL-адрес издателя** не отображаются, обновите портал Azure и повторите шаг 1.

4. В разделе **URL-адрес издателя** скопируйте и сохраните только GUID для части 3. При необходимости вы также можете использовать этот GUID в шаблоне развертывания веб-приложения или приложения API.

   Этот GUID — идентификатор определенного арендатора (ИД арендатора), который должен отображаться в следующем URL-адресе: `https://sts.windows.net/{GUID}`

5. Не сохраняя изменений, закройте страницу **Параметры Azure Active Directory**.

<a name="authen-deploy"></a>

**Проверка подлинности и авторизация в службе приложений Azure**

Вам все же потребуется создать удостоверение приложения Azure AD для веб-приложения или приложения API, которое отличается от удостоверения приложения логики. Чтобы создать удостоверение приложения, выполните шаги на портале Azure, приведенные в части 2. 

Вы также можете выполнить шаги, приведенные в части 1, но при этом обязательно укажите фактическое значение `https://{URL}` веб-приложения или приложения API для параметров **URL-адрес для входа** и **URI кода приложения**. В этих шагах необходимо сохранить идентификаторы клиента и арендатора, чтобы использовать их в шаблоне развертывания приложения и в части 3.

> [!NOTE]
> При создании удостоверения приложения Azure AD для веб-приложения или приложения API необходимо использовать портал Azure, а не PowerShell. Командлет PowerShell не поддерживает настройку необходимых разрешений для входа пользователей на веб-сайт.

Получив идентификаторы клиента и арендатора, добавьте их в шаблон развертывания в качестве подресурса веб-приложения или приложения API.

``` json
"resources": [ {
    "apiVersion": "2015-08-01",
    "name": "web",
    "type": "config",
    "dependsOn": ["[concat('Microsoft.Web/sites/','parameters('webAppName'))]"],
    "properties": {
        "siteAuthEnabled": true,
        "siteAuthSettings": {
            "clientId": "{client-ID}",
            "issuer": "https://sts.windows.net/{tenant-ID}/",
        }
    }
} ]
```

Чтобы автоматически развернуть пустое веб-приложение и приложение логики и включить проверку подлинности с помощью Azure Active Directory, просмотрите полный шаблон [здесь](https://github.com/Azure/azure-quickstart-templates/tree/master/201-logic-app-custom-api/azuredeploy.json) или щелкните **Развертывание в Azure**:

[![Развертывание в Azure](media/logic-apps-custom-api-authentication/deploybutton.png)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F201-logic-app-custom-api%2Fazuredeploy.json)

#### <a name="part-3-populate-the-authorization-section-in-your-logic-app"></a>Часть 3. Заполнение раздела авторизации в приложении логики

В предыдущем шаблоне этот раздел авторизации уже настроен. Но если вы разрабатываете приложение логики полностью самостоятельно, вам потребуется включить весь раздел авторизации.

Откройте определение приложения логики в представлении кода, перейдите к разделу действия **HTTP**, найдите раздел **Авторизация** и добавьте следующую строку:

`{"tenant": "{tenant-ID}", "audience": "{client-ID-from-Part-2-web-app-or-API app}", "clientId": "{client-ID-from-Part-1-logic-app}", "secret": "{key-from-Part-1-logic-app}", "type": "ActiveDirectoryOAuth" }`

| Элемент | Обязательно | Описание | 
| ------- | -------- | ----------- | 
| tenant | Да | GUID для арендатора Azure AD. | 
| audience | Да | GUID целевого ресурса, к которому требуется доступ, являющийся идентификатором клиента из удостоверения приложения для веб-приложения или приложения API. | 
| clientid | Да | GUID клиента, запрашивающего доступ, являющийся идентификатором клиента из удостоверения приложения логики. | 
| secret | Да | Ключ или пароль из удостоверения приложения для клиента, который запрашивает маркер доступа. | 
| type | Да | Тип проверки подлинности. Для аутентификации ActiveDirectoryOAuth это значение равно `ActiveDirectoryOAuth`. | 
|||| 

Например:

``` json
{
   "actions": {
      "some-action": {
         "conditions": [],
         "inputs": {
            "method": "post",
            "uri": "https://your-api-azurewebsites.net/api/your-method",
            "authentication": {
               "tenant": "tenant-ID",
               "audience": "client-ID-from-azure-ad-app-for-web-app-or-api-app",
               "clientId": "client-ID-from-azure-ad-app-for-logic-app",
               "secret": "key-from-azure-ad-app-for-logic-app",
               "type": "ActiveDirectoryOAuth"
            }
         },
      }
   }
}
```

<a name="update-code"></a>

### <a name="secure-api-calls-through-code"></a>Безопасные вызовы API с помощью кода

<a name="certificate"></a>

#### <a name="certificate-authentication"></a>Проверка подлинности на основе сертификата

Вы можете использовать сертификаты клиента для проверки входящих запросов из приложения логики к веб-приложению или приложению API. Чтобы узнать, как настроить код, см. статью о [настройке взаимной проверки подлинности TLS](../app-service/app-service-web-configure-tls-mutual-auth.md).

В разделе **Авторизация** добавьте следующую строку: 

`{"type": "clientcertificate", "password": "password", "pfx": "long-pfx-key"}`

| Элемент | Обязательно | Description (Описание) | 
| ------- | -------- | ----------- | 
| type | Да | Тип проверки подлинности. Для SSL-сертификатов клиента используйте значение `ClientCertificate`. | 
| пароль | Да | Пароль для доступа к сертификату клиента (PFX-файл). | 
| pfx | Да | Содержимое сертификата клиента в кодировке Base64 (PFX-файл). | 
|||| 

<a name="basic"></a>

#### <a name="basic-authentication"></a>Обычная аутентификация

Для проверки входящих запросов из приложения логики к веб-приложениям или приложениям API можно использовать обычную проверку подлинности: имя пользователя и пароль. Обычная проверка подлинности — это универсальный вариант, который подходит для веб-приложений и приложений API, написанных на любых языках программирования.

В разделе **Авторизация** добавьте следующую строку:

`{"type": "basic", "username": "username", "password": "password"}`.

| Элемент | Обязательно | Description (Описание) | 
| ------- | -------- | ----------- | 
| type | Да | Тип аутентификации, который будет использоваться. Для обычной проверки подлинности используйте значение `Basic`. | 
| Имя пользователя | Да | Имя пользователя, которое будет использоваться для аутентификации. | 
| пароль | Да | Пароль, который будет использоваться для аутентификации. | 
|||| 

<a name="azure-ad-code"></a>

#### <a name="azure-active-directory-authentication-through-code"></a>Проверка подлинности Azure Active Directory с помощью кода

По умолчанию проверка подлинности Azure AD, которую можно включить на портале Azure, не обеспечивает детального уровня авторизации. Например, при такой проверке подлинности API блокируется только для конкретного арендатора, а не для определенного пользователя или приложения. 

Чтобы ограничить доступ через API к приложению логики с помощью кода, извлеките заголовок, который содержит маркер JSON Web Token (JWT). Проверяйте удостоверение вызывающей стороны и отклоняйте запросы, не отвечающие требованиям.

<!-- Going further, to implement this authentication entirely in your own code, 
and not use the Azure portal, learn how to 
[authenticate with on-premises Active Directory in your Azure app](../app-service/app-service-authentication-overview.md).

To create an application identity for your logic app and use that identity to call your API, 
you must follow the previous steps. -->

## <a name="next-steps"></a>Дальнейшие действия

* [Deploy and call custom APIs from logic app workflows](../logic-apps/logic-apps-custom-api-host-deploy-call.md) (Развертывание и вызов пользовательских API из рабочих процессов приложения логики)
---
title: "aaaAMQP 1.0 руководства по Azure Service Bus и концентраторы событий протокола | Документы Microsoft"
description: "Руководство по tooexpressions протокола и описание AMQP 1.0 в Azure Service Bus и концентраторы событий"
services: service-bus-messaging,event-hubs
documentationcenter: .net
author: clemensv
manager: timlt
editor: 
ms.assetid: d2d3d540-8760-426a-ad10-d5128ce0ae24
ms.service: service-bus-messaging
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/07/2017
ms.author: clemensv;hillaryc;sethm
ms.openlocfilehash: 882ce0fc84af11d9f61bc95dc3e4db0b67b2b020
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# Руководство по использованию протокола AMQP 1.0 в служебной шине и концентраторах событий Azure

Hello Advanced Message 1.0 протокола очередей — это стандартизированный протокол кадрирования и передачи асинхронно, безопасно и надежно передачи сообщений между двумя сторонами. Это основной протокол hello сообщениями на основе Azure Service Bus и концентраторы событий Azure. Обе службы также поддерживают протокол HTTPS. Hello собственный SBMP протокол, который также поддерживается постепенно вытесняется пользу AMQP.

AMQP 1.0 — результат hello широкому ряду отраслевых совместной работы, совместной работе поставщиков по промежуточного слоя, например Microsoft и Red Hat с большим числом пользователей по промежуточного слоя обмена сообщениями, например прослеживаются JP Morgan, представляющий отрасли hello финансовых служб. Форум, посвященный технической стандартизации Hello спецификации протокола и расширения AMQP hello является OASIS и полученных формальных утверждения международным стандартом как ISO/IEC 19494.

## Цели

В этой статье кратко описаны основные понятия hello hello AMQP 1.0 спецификация обмена сообщениями, вместе с небольшой набор спецификаций расширения черновика, были ли закрыты в настоящее время в Технический комитет OASIS AMQP hello и объясняется, каким образом Azure Service Bus реализует и на эти спецификации.

Hello предназначена для любого разработчика, с помощью любой существующий комплект клиент AMQP 1.0 на любой платформе toobe может toointeract с Azure Service Bus через протокол AMQP 1.0.

Распространенные стеки общего назначения AMQP 1.0, например Apache Proton или AMQP.NET Lite, уже реализуют все основные жесты AMQP 1.0. Иногда эти базовые жесты упаковываются с API высокого уровня; Apache Proton даже предлагает два, hello императивного API Messenger и hello реактивный реактор API.

В hello после обсуждения предполагается, что управления hello AMQP подключения, сеансы и обработка ссылки и hello кадра передач и управления потоком обрабатываются стеком hello соответствующих (такие как Apache Proton-C) и не требуют много при наличии конкретных внимания со стороны разработчиков приложений. Абстрактно предполагается существование hello несколько примитивов API как tooconnect возможность hello и toocreate определенные виды *отправителя* и *получателя* объектов абстракции, которые затем имеют некоторые фигуры `send()`и `receive()` операций, соответственно.

Расширенные возможности служебной шины Azure, например просмотр сообщений или управление сеансами, описываются в контексте AMQP, а также как многоуровневая псевдореализация на базе этой предполагаемой абстракции API.

## Что такое AMQP?

AMQP — это протокол передачи и кадрирования. Под кадрированием подразумевается предоставление структуры для потоков двоичных данных, которые передаются в любом направлении в рамках сетевого подключения. Структура Hello предоставляет разграничение для различных блоков данных, называемый *кадров*, toobe, обмен которыми осуществляется между сторонами hello подключен. возможности передачи Hello убедитесь в том, что обе взаимодействующие стороны можно установить общего понимания должны передачи кадров и когда передача должны считаться завершенным.

В отличие от более ранних версий просроченных черновые версии созданных hello AMQP рабочая группа, все еще используется несколько посредников протокол AMQP 1.0 окончательного и стандартизованной hello рабочая группа не определить наличие hello брокера сообщений или любой конкретной топологии для сущности внутри брокер обмена сообщениями.

протокол Hello может использоваться для симметричного одноранговая сеть обмена данными для взаимодействия с посредникам, поддерживающие очереди и сущностей, публикации и подписки, как и в Azure Service Bus. Он может также использоваться для взаимодействия с инфраструктуры обмена сообщениями где шаблоны взаимодействия hello отличаются от обычных очередей как случае hello с концентраторов событий Azure. Концентратор событий действует как очередь событий, отправленных tooit, но более работает как служба хранилища с последовательным хранением при события считываются из него; он немного напоминает накопитель на магнитной ленте. Hello клиент выбирает смещение в потоке данных hello и затем передает все события из этого смещения toohello последней доступной.

Hello протокол AMQP 1.0 — спроектированный toobe расширяемым, обеспечивая дальнейшие спецификации tooenhance его возможности. Это показано три расширения спецификации Hello в этом документе. Для связи через существующую инфраструктуру HTTPS-соединения WebSocket, где Настройка hello собственного AMQP TCP-портов может быть затруднен определяет спецификацию привязки как toolayer AMQP через WebSockets. Для взаимодействия с hello инфраструктуры обмена сообщениями в запрос ответ образом для целей управления или tooprovide дополнительные функциональные возможности, hello AMQP управления спецификация определяет примитивы hello необходимые основные взаимодействия. Для интеграции федеративной авторизации model, определяет hello спецификация AMQP на основе безопасности утверждений как tooassociate и обновлять маркерах авторизации, связанные со ссылками.

## Основные сценарии использования протокола AMQP

В этом разделе объясняется использование basic hello AMQP 1.0 с Azure Service Bus, который включает создание соединения, сеансы и ссылки и передачи tooand сообщений от сущности служебной шины, такие как очереди, разделы и подписки.

Hello наиболее полномочный источник toolearn о работе AMQP — hello AMQP 1.0 спецификация, но спецификации hello написано tooprecisely руководство по реализации и не tooteach протокол hello. В этом разделе рассматриваются все термины, необходимые для описания использования протокола AMQP 1.0 в служебной шине. Для более подробный tooAMQP Общие сведения, а также подробное обсуждение AMQP 1.0, можно просматривать [этот курс видео][this video course].

### Подключения и сеансы

Взаимодействие программы hello вызовов AMQP *контейнеры*; эти содержат *узлы*, который hello обмениваются сущностей внутри этих контейнеров. Таким узлом может выступать очередь. AMQP позволяет мультиплексирование, чтобы можно было использовать одно соединение для многих пути обмена данными между узлами. Например, клиент приложения можно одновременно получать из одной очереди и tooanother очереди отправки через hello же сетевое подключение.

![][1]

Таким образом, Hello сетевое подключение привязанный hello контейнере. Он инициируется контейнером hello в роли клиента hello, делая контейнер tooa сокета подключения исходящих TCP в роль получателя hello, которая прослушивает и принимает входящие подключения TCP. Подтверждение соединения Hello включает согласования версия протокола hello, объявления и согласования hello использование безопасности транспортного уровня (TLS/SSL), а также подтверждения подлинности и авторизации в области hello подключения, которая основана на SASL.

Azure Service Bus требует использования TLS hello в любое время. Он поддерживает подключения через TCP-порт 5671, согласно которому сначала кнопке с TLS перед вводом подтверждения протокола AMQP hello hello TCP-соединение и также поддерживает соединения через TCP-порт 5672, при котором сервер hello немедленно обеспечивает обязательное обновление с помощью модели предписанные AMQP hello tooTLS соединения. Привязка AMQP WebSockets Hello создает туннель через TCP-порт 443, затем эквивалентные tooAMQP 5671 подключений.

После настройки подключения hello и TLS, Service Bus предоставляет два варианта механизма SASL.

* ОБЫЧНЫЙ SASL обычно используется для передачи имени пользователя и пароля сервер tooa учетные данные. В служебной шине нет учетных записей, но есть связанные с ключом именованные [правила безопасности общего доступа](service-bus-sas.md), которые присваивают права. Hello имя правила используется в качестве имени пользователя hello и ключа hello (как текст в кодировке base64) используется в качестве пароля hello. Hello права, связанные с hello выбранного правила, указывающие hello операции, разрешенные для подключения hello.
* АНОНИМНЫЕ SASL используется для обхода SASL авторизации, при hello клиенту модели (CBS) на основе безопасности утверждений hello toouse, см. ниже. Этот параметр клиента подключиться анонимно в течение некоторого времени во время которого hello клиент может взаимодействовать с конечной точкой CBS hello и подтверждения CBS hello должна быть завершена.

После установления подключения транспорта hello hello контейнеры, каждого объявления hello максимальный размер кадра их пойти toohandle и после тайм-аут простоя они будут одностороннем отключиться, если отсутствует действие hello подключения.

Они также объявляют количество поддерживаемых параллельных каналов. Канал представляет собой путь передачи однонаправленный, Исходящие, виртуальный поверх hello соединения. Сеанс принимает канала из каждого пути обмена данными между tooform двунаправленные взаимосвязанных контейнеры hello.

Сеансы имеют модели управления потоками на основе окна. При создании сеанса каждой стороны, объявляет количество кадров является пойти tooaccept в его окна приема. Как hello сторон exchange кадров, переданных кадров заполнения окна и передачи остановку при заполнении окна hello и пока окно hello сбрасывается или раскрыть с помощью hello *потока performative* (*performative*— термин hello AMQP для уровня протокола жесты обмениваются hello двух сторон).

Эта модель под управлением window является аналогом toohello TCP концепция управления потоками на основе окна, но на уровне сеанса hello hello сокета. Hello протокола поддержка нескольких одновременных сеансов нет понятия, чтобы трафик с высоким приоритетом может быть которые заходили за регулированию обычный трафика, как в полосе express канал.

Сейчас в служебной шине Azure для каждого подключения используется только один сеанс. Hello Service Bus максимальное — размер кадра-262 144 байт (256 КБ) для Service Bus Standard и концентраторов событий. Для служебной шины уровня Premium он составляет 1 048 576 (1 МБ). Service Bus не накладывает любого конкретного регулирования windows уровня сеанса, но сбрасывает hello окна регулярно в рамках управления потоками на уровне ссылок (см. [hello следующий раздел](#links)).

Подключения, каналы и сеансы являются временными. Если базовое соединение hello сворачивает подключений, необходимо заново TLS-туннеля, контекст авторизации SASL и сеансов.

### Ссылки

AMQP обеспечивает передачу сообщений через связи. Ссылка представляет собой путь к связи, созданные за сеанс, позволяющий передачи сообщений в одном направлении; согласование состояние передачи Hello — по ссылке hello и двунаправленные между сторонами hello подключен.

![][2]

В любое время и через существующий сеанс, что делает AMQP отличается от многих других протоколов, включая HTTP и MQTT, где монопольного прав создания стороны hello инициации hello передач и пути передачи ссылок могут быть созданы либо контейнером подключение через сокет Hello.

контейнер инициации связи Hello запрашивает hello противоположного tooaccept контейнера ссылку и он выбирает роль отправителя или получателя. Таким образом контейнер может инициировать создание однонаправленный или путей двунаправленный обмен данными с последний hello, смоделированная в виде пары ссылок.

У связей есть имена, и они сопоставлены с узлами. Как уже говорилось в начале hello, узлы являются hello связи сущности внутри контейнера.

В Service Bus узел является непосредственно эквивалентные tooa очереди, темы, подписки или в подочередь недоставленных сообщений из очереди или подписки. имени узла Hello в AMQP таким образом указывается hello относительное имя сущности hello внутри пространства имен Service Bus hello. Имя очереди (например, **myqueue**) является также именем узла AMQP этой очереди. Подписки раздела следует соглашение hello HTTP API, выполняется сортировка в коллекцию ресурсов «подписки» и таким образом, подписки **sub** или раздел **mytopic** имеет имя узла hello AMQP **mytopic/подписки/sub**.

Hello подключающегося клиента также является обязательным toouse имя локального узла для создания ссылок; Service Bus не предписания о эти имена узлов и не распознает их. Стеки клиент AMQP 1.0 обычно используют схему tooassure, эти имена временных узлов являются уникальными в области hello hello клиента.

### Передачи

Как только связь будет установлена, через нее можно передавать сообщения. В AMQP, передачи выполняется с помощью жеста явную протокола (hello *передачи* performative), перемещает сообщение из отправителя tooreceiver по каналу. Передача завершена при его «сопоставления», это означает, что обе стороны установлено общего понимания результата hello их переноса.

![][3]

В простейшем случае hello hello отправителя можно выбрать toosend сообщения «предварительно сопоставить», то есть клиент hello не интересуют результат hello и приемника hello не предоставляет любых отзывов о hello результат операции hello. Этот режим поддерживается служебной шины на уровне протокола AMQP hello, но не представлены в любой из интерфейсов API клиента hello.

Hello регулярного случаем является отправляются несопоставленных, что получатель hello, то указывает принятия или отклонения, использование hello *disposition* performative. Отклонения происходит, когда получатель hello не может принять сообщение hello по любой причине и отклонения приветственное сообщение содержит сведения о причине hello, являющийся ошибка структуры, определяемой AMQP. Если сообщения отклоняются из-за ошибки toointernal внутри Service Bus, hello служба возвращает Дополнительные сведения в этой структуре, который может использоваться для предоставления подсказки toosupport службу диагностики, если запросы на поддержку. Дополнительные сведения об ошибках приведены далее.

— Это особая форма отклонения hello *выпущена* состояние указывает, что приемник hello имеет без передачи toohello технические угроза, но также не представляет интереса в сопоставлении hello передачи. Что случая существует, например, при получении сообщения доставляются tooa клиента служебной шины и hello клиент выбирает слишком «прервать» приветственное сообщение, так как он не может выполнять рабочие hello, возникающие в результате обработки сообщения hello; доставка сообщений Hello сам не является ошибочным. Вариация этого состояния — hello *изменить* состояние, которое позволяет сообщение toohello изменения, как он освобождается. Это состояние сейчас не используется в служебной шине.

Hello спецификация AMQP 1.0 определяет дополнительные расстановки состояние — *получил*, в частности, которое помогает toohandle восстановления связи. Восстановление связи позволяет реконструкцию hello состояния ссылки и все ожидающие поставок на основе нового соединения и сеанса, когда предыдущий hello и сеансов были потеряны.

Service Bus не поддерживает восстановление связи; Если клиент hello теряет hello подключения tooService шины с сообщением об несопоставленных перенос ожидающего, теряется, передачи сообщений и hello клиента необходимо повторно подключиться, заново установить связь hello и повторите передачу hello.

Таким образом Service Bus и концентраторы событий поддерживают «по крайней мере один раз» передачи hello отправителя можно быть уверенным, для сообщения hello хранятся и приняты, когда не поддерживают передачу на уровне AMQP, где hello системы будет предпринята попытка toorecover hello «ровно один раз» Здравствуйте, связи и продолжить дублирования tooavoid состояние доставки hello toonegotiate передачи сообщений hello.

отправляет toocompensate для возможный дубликат, Service Bus поддерживает обнаружение дубликатов в качестве дополнительного компонента в очереди и разделы. Записи обнаружения повторяющихся сообщений hello идентификаторы сообщений всех входящих сообщений в период времени, определяемого пользователем, а затем автоматически удаляет все сообщения отправляются с hello одинаковые идентификаторы сообщений в этой же период.

### Управление потоком

Кроме управления потоками на уровне сеанса toohello модель, рассмотренных ранее, каждая ссылка имеет свою собственную модель потока управления. Управление потоком уровня сеанса контейнера hello защищает от необходимости toohandle слишком много кадров на один раз, управление потоком на уровне ссылок помещает приложения hello, ответственный за сколько сообщений планирует toohandle по ссылке, а также при.

![][4]

В канале передачи может происходить, только если hello отправителя достаточно *связать кредит*. Кредит связи представляет собой счетчик, заданные с помощью hello приемника hello *потока* performative, который имеет область tooa ссылку. Когда отправитель hello назначается кредит ссылку, попытается toouse вверх, кредит по доставке сообщений. Каждый уменьшает доставки сообщений hello оставшийся кредит ссылку на 1. При использовании кредит ссылку hello остановить доставок.

Когда Service Bus в роль получателя hello, его мгновенно предоставляет отправителя hello кредит можно в полной мере ссылку, чтобы сразу можно отправлять сообщения. Кредит ссылки используется, Service Bus периодически отправляет *потока* сальдо по кредиту performative toohello отправителя tooupdate hello ссылку.

В роли отправителя hello Service Bus отправляет сообщения toouse копирование кредит необработанных ссылку.

Вызов «получения» на уровне hello API транслирует *потока* performative были отправлены доступных tooService потребляет шины клиентом hello и Service Bus, сначала кредита путем перевода hello, разблокировать сообщения из очереди hello, заблокировав ее, и его передачи. Если сообщение не доступны для доставки, ожидающих кредит по любую ссылку установить определенную сущность остается записанные в порядке их поступления, что сообщения блокируются и переданы как они становятся доступными, toouse необработанных кредит.

блокировки сообщений Hello освобождается, когда передача hello сопоставляется в один из режимов терминалов hello *принят*, *Отклонено*, или *выпущена*. приветственное сообщение удаляется из Service Bus при hello конечного состояния *приняты*. Она остается в Service Bus и доставляется toohello Далее приемника достижении hello передачи любого hello других состояний. Service Bus автоматически перемещает приветственное сообщение в очередь недоставленных сообщений hello сущности при достижении hello максимальное число доставок разрешен для сущности hello из-за toorepeated отклонений или выпусков.

Несмотря на то, что hello интерфейсов API служебной шины не предоставляет такой параметр сегодня непосредственно, клиент протокола AMQP более низкого уровня может использовать hello ссылку кредит модели tooturn hello «запросу style» взаимодействие выдавать одну единицу кредит на каждый запрос на получение в модель «принудительной style» путем выдачи большое количество ссылок кредиты и затем получать сообщения, как только они становятся доступными без каких-либо дальнейших действий. Принудительная поддерживается с помощью hello [MessagingFactory.PrefetchCount](/dotnet/api/microsoft.servicebus.messaging.messagingfactory#Microsoft_ServiceBus_Messaging_MessagingFactory_PrefetchCount) или [MessageReceiver.PrefetchCount](/dotnet/api/microsoft.servicebus.messaging.messagereceiver#Microsoft_ServiceBus_Messaging_MessageReceiver_PrefetchCount) параметры свойств. Если они не равны нулю, клиент AMQP hello использует его в качестве кредит ссылку hello.

В этом контексте он является важным toounderstand, hello часов hello истечение срока действия блокировки hello на приветственное сообщение внутри сущности hello начинается, когда hello сообщение берется из сущности hello не при размещать приветственное сообщение hello сети. Всякий раз, когда клиент hello указывает готовность tooreceive сообщений путем выдачи кредит ссылку, он является таким образом ожидаемый toobe активно извлечение сообщения hello сети и быть готовы toohandle их. В противном случае блокировка сообщения hello может истечь, прежде чем даже доставки сообщения hello. Использование Hello ссылку кредит потока управления непосредственно должны отражать toodeal немедленно готовности hello с получателем toohello доступные сообщения доставлялись.

Таким образом hello следующих разделах Схематическое Обзор hello performative потока во время взаимодействия с разных API. В каждом разделе описывается отдельная логическая операция. Некоторые из этих взаимодействий могут быть "ленивыми", то есть выполняться только по требованию. Создание отправителя сообщения взаимодействия сети не может вызвать, пока не будет отправлено первое сообщение hello или запрошенный.

стрелки Hello в следующей таблице hello показывают performative направление hello.

#### Создание получателя сообщения

| Клиент | Служебная шина |
| --- | --- |
| --> attach(<br/>name={имя ссылки},<br/>handle={числовой дескриптор},<br/>role=**receiver**,<br/>source={имя сущности},<br/>target={идентификатор связи клиента}<br/>) |Клиент присоединяет tooentity как получатель |
| Присоединение конца связи hello ответов Service Bus |<-- attach(<br/>name={имя ссылки},<br/>handle={числовой дескриптор},<br/>role=**sender**,<br/>source={имя сущности},<br/>target={идентификатор связи клиента}<br/>) |

#### Создание отправителя сообщения

| Клиент | Служебная шина |
| --- | --- |
| --> attach(<br/>name={имя ссылки},<br/>handle={числовой дескриптор},<br/>role=**sender**,<br/>source={идентификатор связи клиента},<br/>target={имя сущности}<br/>) |Нет действий |
| Нет действий |<-- attach(<br/>name={имя ссылки},<br/>handle={числовой дескриптор},<br/>role=**receiver**,<br/>source={идентификатор связи клиента},<br/>target={имя сущности}<br/>) |

#### Создание отправителя сообщения (ошибка)

| Клиент | Служебная шина |
| --- | --- |
| --> attach(<br/>name={имя ссылки},<br/>handle={числовой дескриптор},<br/>role=**sender**,<br/>source={идентификатор связи клиента},<br/>target={имя сущности}<br/>) |Нет действий |
| Нет действий |<-- attach(<br/>name={имя ссылки},<br/>handle={числовой дескриптор},<br/>role=**receiver**,<br/>source=null,<br/>target=null<br/>)<br/><br/><-- detach(<br/>handle={числовой дескриптор},<br/>closed=**true**,<br/>error={сведения об ошибке}<br/>) |

#### Закрытие получателя или отправителя сообщений

| Клиент | Служебная шина |
| --- | --- |
| --> detach(<br/>handle={числовой дескриптор},<br/>closed=**true**<br/>) |Нет действий |
| Нет действий |<-- detach(<br/>handle={числовой дескриптор},<br/>closed=**true**<br/>) |

#### Отправка (успешно)

| Клиент | Служебная шина |
| --- | --- |
| --> transfer(<br/>delivery-id={числовой дескриптор},<br/>delivery-tag={двоичный дескриптор},<br/>settled=**false**,,more=**false**,<br/>state=**null**,<br/>resume=**false**<br/>) |Нет действий |
| Нет действий |<-- disposition(<br/>role=receiver,<br/>first={идентификатор доставки},<br/>last={идентификатор доставки},<br/>settled=**true**,<br/>state=**accepted**<br/>) |

#### Отправка (ошибка)

| Клиент | Служебная шина |
| --- | --- |
| --> transfer(<br/>delivery-id={числовой дескриптор},<br/>delivery-tag={двоичный дескриптор},<br/>settled=**false**,,more=**false**,<br/>state=**null**,<br/>resume=**false**<br/>) |Нет действий |
| Нет действий |<-- disposition(<br/>role=receiver,<br/>first={идентификатор доставки},<br/>last={идентификатор доставки},<br/>settled=**true**,<br/>state=**rejected**(<br/>error={сведения об ошибке}<br/>)<br/>) |

#### Получение

| Клиент | Служебная шина |
| --- | --- |
| --> flow(<br/>link-credit=1<br/>) |Нет действий |
| Нет действий |< transfer(<br/>delivery-id={числовой дескриптор},<br/>delivery-tag={двоичный дескриптор},<br/>settled=**false**,<br/>more=**false**,<br/>state=**null**,<br/>resume=**false**<br/>) |
| --> disposition(<br/>role=**receiver**,<br/>first={идентификатор доставки},<br/>last={идентификатор доставки},<br/>settled=**true**,<br/>state=**accepted**<br/>) |Нет действий |

#### Получение нескольких сообщений

| Клиент | Служебная шина |
| --- | --- |
| --> flow(<br/>link-credit=3<br/>) |Нет действий |
| Нет действий |< transfer(<br/>delivery-id={числовой дескриптор},<br/>delivery-tag={двоичный дескриптор},<br/>settled=**false**,<br/>more=**false**,<br/>state=**null**,<br/>resume=**false**<br/>) |
| Нет действий |< transfer(<br/>delivery-id={числовой дескриптор+1},<br/>delivery-tag={двоичный дескриптор},<br/>settled=**false**,<br/>more=**false**,<br/>state=**null**,<br/>resume=**false**<br/>) |
| Нет действий |< transfer(<br/>delivery-id={числовой дескриптор+2},<br/>delivery-tag={двоичный дескриптор},<br/>settled=**false**,<br/>more=**false**,<br/>state=**null**,<br/>resume=**false**<br/>) |
| --> disposition(<br/>role=receiver,<br/>first={идентификатор доставки},<br/>last={идентификатор доставки+2},<br/>settled=**true**,<br/>state=**accepted**<br/>) |Нет действий |

### Сообщения

Hello следующих разделах описаны свойства из hello стандартные разделы сообщение AMQP, используемые с Service Bus и их сопоставлении toohello набор API служебной шины.

#### Верхний колонтитул

| Имя поля | Использование | Имя API |
| --- | --- | --- |
| durable |- |- |
| priority |- |- |
| ttl |Время toolive это сообщение |[TimeToLive](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_TimeToLive) |
| first-acquirer |- |- |
| delivery-count |- |[DeliveryCount](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_DeliveryCount) |

#### properties

| Имя поля | Использование | Имя API |
| --- | --- | --- |
| message-id |Определяемый приложением идентификатор свободной формы для этого сообщения. Используется для обнаружения дубликатов. |[MessageId](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_MessageId) |
| user-id |Определяемый приложением идентификатор пользователя, который не интерпретируется служебной шиной. |Не доступны через API служебной шины hello. |
| слишком|Определяемый приложением идентификатор назначения, который не интерпретируется служебной шиной. |[To](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_To) |
| subject |Определяемый приложением идентификатор назначения сообщения, который не интерпретируется служебной шиной. |[Label](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_Label) |
| ответ слишком|Определяемый приложением индикатор пути ответа, который не интерпретируется служебной шиной. |[ReplyTo](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_ReplyTo) |
| correlation-id |Определяемый приложением идентификатор корреляции, который не интерпретируется служебной шиной. |[CorrelationId](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_CorrelationId) |
| content-type |Определяемые приложением индикатор типа содержимого для текста hello, не обрабатываются Service Bus. |[ContentType](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_ContentType) |
| content-encoding |Определяемые приложением content-encoding индикатор текста hello, не обрабатываются Service Bus. |Не доступны через API служебной шины hello. |
| absolute-expiry-time |Объявляет в какой абсолютный мгновенных hello истекает срок действия сообщения. Игнорируется во входных данных (отмечается значение TTL заголовка), учитывается в выходных данных. |[ExpiresAtUtc](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_ExpiresAtUtc) |
| creation-time |Объявляет в какой hello время создания сообщения. Не используется служебной шиной. |Не доступны через API служебной шины hello. |
| group-id |Определяемый приложением идентификатор связанного набора сообщений. Используется для сеансов служебной шины. |[SessionId](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_SessionId) |
| group-sequence |Счетчик идентификации hello относительный порядковый номер сообщения hello в сеансе. Игнорируется служебной шиной. |Не доступны через API служебной шины hello. |
| reply-to-group-id |- |[ReplyToSessionId](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_ReplyToSessionId) |

## Расширенные возможности служебной шины

В этом разделе рассматриваются возможности для выполнения Azure Service Bus, основанных на tooAMQP расширения черновика, в настоящее время разрабатывается в Технический комитет OASIS hello для AMQP. Service Bus реализует hello последние версии этих черновики и принимает изменения, представленные как черновики этих перейти в состояние standard.

> [!NOTE]
> Дополнительные операции обмена сообщениями служебной шины поддерживаются с помощью шаблона "запрос — ответ". Hello подробные сведения об этих операциях описаны в документе hello [AMQP 1.0 в шине обслуживания: на основе запроса ответа операции](service-bus-amqp-request-response.md).
> 
> 

### Управление AMQP

Спецификация AMQP management Hello — hello первый расширений черновик hello в данном разделе. Эта спецификация определяет набор жестов протокола уровень над hello протокола AMQP, позволяющие действия с сообщениями инфраструктуры через AMQP hello. Спецификация Hello определяет универсальных операций, таких как *создать*, *чтения*, *обновление*, и *удалить* для управления сущностями внутри инфраструктура обмена сообщениями и набор операций запроса.

Все жесты требуют взаимодействия запрос ответ между клиентом hello и hello инфраструктуры обмена сообщениями, и поэтому hello спецификация определяет, как toomodel, реализуемый шаблона на основе AMQP: hello клиент подключается toohello обмена сообщениями инфраструктура, инициирует сеанс, а затем создает пару ссылки. На одну ссылку клиента hello выступает в качестве отправителя и на других hello выступает в качестве получателя, тем самым создавая пару ссылки, которая может действовать как двунаправленный канал.

| Логическая операция | Клиент | Service Bus |
| --- | --- | --- |
| Создание пути "запрос-ответ" |--> attach(<br/>name={*имя связи*},<br/>handle={*числовой дескриптор*},<br/>role=**sender**,<br/>source=**null**,<br/>target=”myentity/$management”<br/>) |Нет действий |
| Создание пути "запрос-ответ" |Нет действий |\<-- attach(<br/>name={*имя связи*},<br/>handle={*числовой дескриптор*},<br/>role=**receiver**,<br/>source=null,<br/>target=”myentity”<br/>) |
| Создание пути "запрос-ответ" |--> attach(<br/>name={*имя связи*},<br/>handle={*числовой дескриптор*},<br/>role=**receiver**,<br/>source=”myentity/$management”,<br/>target=”myclient$id”<br/>) | |
| Создание пути "запрос-ответ" |Нет действий |\<-- attach(<br/>name={*имя связи*},<br/>handle={*числовой дескриптор*},<br/>role=**sender**,<br/>source=”myentity”,<br/>target=”myclient$id”<br/>) |

Наличие этой пары ссылки, реализация hello запрос ответ является прямолинейной: запроса является сообщение, отправленное tooan сущности внутри инфраструктуры обмена сообщениями hello, поддерживающее этот шаблон. В этот запрос сообщение hello *ответить* в hello *свойства* раздел имеет значение toohello *целевой* идентификатор hello ссылки на какой ответ toodeliver hello. Обработка сущности Hello обрабатывает запрос hello и доставляет hello ответ через hello свяжите которого *целевой* соответствует hello указывает идентификатор *ответить* идентификатор.

шаблон Hello очевидно, что необходимо, контейнер клиента hello и hello идентификатор, формируемый клиентом для назначения ответ hello уникальным на всех клиентах, а также по соображениям безопасности, также сложно toopredict.

обмен сообщениями Hello используется для протокола управления hello и для других протоколов, используйте hello, подход и происходит на уровне приложения hello. они не определяют новые жесты уровня протокола AMQP. Это сделано намеренно, чтобы приложения могли сразу применять эти расширения с совместимыми стеками AMQP 1.0.

Service Bus не реализует в настоящее время любой hello основные функции управления спецификации hello, но базовые функции на основе безопасности утверждений hello и почти всех определенных спецификацией управления hello шаблону запрос/ответ hello Здравствуйте, расширенные возможности, описанные в следующих разделах hello.

### Авторизация на основе утверждений

Спецификация черновик Hello основе авторизации утверждений AMQP (CBS) основана на шаблону запрос/ответ спецификация управления hello и описывает обобщенную модель для как toouse федеративной маркеров безопасности с помощью AMQP.

модель безопасности по умолчанию Hello AMQP, рассматриваемые в введение hello основан на SASL и интегрируется с подтверждения соединения hello AMQP. С помощью SASL преимущество hello, он предоставляет расширяемую модель, для которого были определены набор механизмов, из которого можно использовать любой протокол, формально полагается на SASL. Эти механизмы позволяют «PLAIN» для передачи имен пользователей и пароли, безопасность на уровне tooTLS toobind «EXTERNAL», «ANONYMOUS» отсутствие hello tooexpress явной проверки подлинности и авторизации, а также различными дополнительные механизмы, позволяющие При передаче учетных данных при проверке подлинности и авторизации или маркеры.

Интеграция SASL в протоколе AMQP имеет два недостатка:

* Все учетные данные и токены, с областью toohello соединения. Инфраструктура обмена сообщениями может потребоваться tooprovide друг друга управление доступом на основе сущностей; Например позволяя hello носителя токена toosend tooqueue A, но не tooqueue б. С hello контекст авторизации, прикрепленные к hello соединения они невозможно toouse одно подключение и еще используются токены различный уровень доступа для очереди A и B. очереди
* Как правило, маркеры доступа действительны в течение ограниченного периода времени. Этого действия требуются токены повторного запроса tooperiodically hello пользователя и предоставляет возможность toohello поставщика маркера toorefuse выдает новый маркер, если были изменены разрешения на доступ пользователя hello. Подключения AMQP могут быть действительными в течение продолжительного периода времени. Hello SASL модели только предоставляет tooset вероятность токен во время соединения, что означает, что либо hello инфраструктуры обмена сообщениями имеет toodisconnect hello клиента после истечения срока действия маркера hello, или ему tooaccept hello риск предоставления дальнейшей связи с Клиент кто имеет права доступа был отозван в промежуточный hello.

Hello спецификация AMQP CBS, реализуемый Service Bus позволяет элегантное решение для обоих этих неполадок: позволяет клиенту маркеры доступа tooassociate с каждым узлом и tooupdate те маркеры, до истечения срока действия, не прерывая работу потока сообщений hello.

Управление виртуальными узел, с именем определяет CBS *$cbs*, toobe, предоставляемые hello инфраструктуры обмена сообщениями. узел управления Hello принимает маркеры от имени других узлов в инфраструктуре сообщений hello.

жест протокола Hello — обмена запрос ответ, в соответствии с определением спецификации управления hello. Что означает hello клиент устанавливает пару ссылки с hello *$cbs* узел, а затем передает запрос на hello исходящие связи, а затем ожидает ответа hello на hello входящие связи.

приветственное сообщение запроса имеет следующие свойства приложения hello.

| Ключ | Необязательно | Тип значения | Содержимое значения |
| --- | --- | --- | --- |
| операция |Нет |строка |**put-token** |
| type |Нет |string |тип был помещен маркер hello Hello. |
| name |Нет |string |применяет toowhich hello Hello «аудитории» токена. |
| expiration |Да |Timestamp |время окончания действия маркера hello Hello. |

Hello *имя* свойство, обозначающее hello сущности, с которой hello маркера должны быть связаны. В Service Bus, он hello путь toohello очереди или раздела или подписки. Hello *тип* свойство определяет тип токена hello:

| Тип маркера | Описание маркера | Тип текста | Примечания |
| --- | --- | --- | --- |
| amqp:jwt |JSON Web Token (JWT) |Значение AMQP (строка) |Пока недоступно. |
| amqp:swt |Простой веб-маркер (SWT) |Значение AMQP (строка) |Поддерживается только для маркеров SWT, выданных AAD или ACS |
| servicebus.windows.net:sastoken |Маркер SAS служебной шины |Значение AMQP (строка) |- |

Маркеры предоставляют права. Служебная шина распознает три основных вида прав: право "Отправление" позволяет отправлять, право "Прослушивание" — принимать, а право "Управление" — управлять объектами. Маркеры SWT, выданные AAD или ACS, явно включают в себя эти права в качестве утверждений. Маркеры Service Bus SAS см. toorules настраивается на приветствия имен или сущности, и эти правила должны быть настроены права. Токен подписывания hello с hello ключ, связанный с этим правилом таким образом делает hello маркера express hello соответствующие права. Hello маркером, связанным с сущности, используя *put токен* разрешает hello подключен toointeract клиента с сущностью hello каждого маркера права hello. Ссылку, где клиент hello принимает hello *отправителя* роли требуется право; hello «Отправка» на hello *получателя* роли требуется право «Прослушивание» hello.

Hello ответное сообщение имеет hello Далее *свойства приложения* значения

| Ключ | Необязательно | Тип значения | Содержимое значения |
| --- | --- | --- | --- |
| status-code |Нет |int |Код ответа HTTP **[RFC2616]**. |
| status-description |Да |string |Описание состояния hello. |

Hello клиент может вызывать *put токен* несколько раз и для любой сущности в инфраструктуру обмена сообщениями hello. токены Hello, toohello заданной области текущего клиента и привязана hello текущего соединения, означающее hello сервер удаляет все сохраненные токены при разрыве соединения hello.

Текущая реализация Service Bus Hello CBS допускает только в сочетании с hello метод SASL «ANONYMOUS». Соединение SSL/TLS всегда должна существовать подтверждения предыдущих toohello SASL.

механизм АНОНИМНОГО Hello таким образом должны поддерживаться hello выбранный клиент AMQP 1.0. Анонимный доступ означает, что hello подтверждения начального соединения, включая создание начальной сеанса hello происходит без знать, кто создает hello подключения Service Bus.

После установления соединения hello и сеанса присоединение hello связывает toohello *$cbs* узла и отправка hello *put токен* запроса являются hello только разрешенные операции. Необходимо задать допустимый маркер успешно используют *put токен* запроса для некоторых сущностей узла в течение 20 секунд после установления соединения hello, в противном случае hello одностороннем разрыве соединения с Service Bus.

для отслеживания истечения срока действия токена впоследствии отвечает клиент Hello. По истечении срока действия маркера Service Bus немедленно удаляет все ссылки для hello подключения toohello соответствующие сущности. tooprevent hello, клиент может заменить токен hello hello узла на новый в любое время с помощью виртуального hello *$cbs* hello управления узел с таким же *put токен* жестов и без получение в hello способ полезных данных hello трафик, перемещается на другой ссылки.

## Дальнейшие действия

toolearn Дополнительные сведения о AMQP, посетите hello ссылкам:

* [Протокол AMQP служебной шины — обзор]
* [Поддержка AMQP 1.0 для секционированных очередей и разделов служебной шины]
* [Протокол AMQP служебной шины для Windows Server]

[this video course]: https://www.youtube.com/playlist?list=PLmE4bZU0qx-wAP02i0I7PJWvDWoCytEjD
[1]: ./media/service-bus-amqp-protocol-guide/amqp1.png
[2]: ./media/service-bus-amqp-protocol-guide/amqp2.png
[3]: ./media/service-bus-amqp-protocol-guide/amqp3.png
[4]: ./media/service-bus-amqp-protocol-guide/amqp4.png

[Протокол AMQP служебной шины — обзор]: service-bus-amqp-overview.md
[Поддержка AMQP 1.0 для секционированных очередей и разделов служебной шины]: service-bus-partitioned-queues-and-topics-amqp-overview.md
[Протокол AMQP служебной шины для Windows Server]: https://msdn.microsoft.com/library/dn574799.aspx

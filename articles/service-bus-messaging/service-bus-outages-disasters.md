---
title: "приложения Azure Service Bus aaaInsulating от сбоев и аварий | Документы Microsoft"
description: "Описание методов, можно использовать tooprotect приложений от возможных перебоев Service Bus."
services: service-bus-messaging
documentationcenter: na
author: sethmanheim
manager: timlt
editor: tysonn
ms.assetid: fd9fa8ab-f4c4-43f7-974f-c876df1614d4
ms.service: service-bus-messaging
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 04/12/2017
ms.author: sethm
ms.openlocfilehash: 349b4968456c9f15375753d83495246f5a3ddfdb
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2017
---
# <a name="best-practices-for-insulating-applications-against-service-bus-outages-and-disasters"></a>Рекомендации по изолированию приложений от простоев и аварий служебной шины
Критически важные приложения должны работать постоянно даже при наличии hello незапланированных простоях или авариях. В этом разделе описаны методы, которые можно использовать приложения Service Bus tooprotect от потенциальных простоя службы или аварии.

Сбой определяется как Временная недоступность hello Azure Service Bus. Hello может затронуть некоторые компоненты Service Bus, например хранилище сообщений, или даже hello весь центр обработки данных. После устранения проблемы hello Service Bus снова становится доступной. Как правило, простой не приводит к утрате сообщений или других данных. Примером сбоя компонента является недоступность определенного хранилища сообщений hello. Примером сбоя центра обработки данных является отказ электроснабжения hello центра обработки данных или неисправность сетевого коммутатора. Сбой может длиться от нескольких минут tooa несколько дней.

Авария определяется как hello безвозвратная потеря единицы масштабирования служебной шины или центра обработки данных. Hello центра обработки данных может включать или не будут доступны еще раз. Авария обычно вызывает потерю некоторых или всех сообщений или других данных. Примеры аварий — пожар, наводнение или землетрясение.

## <a name="current-architecture"></a>Текущая архитектура
Шина обслуживания использует несколько хранилищ toostore сообщений, отправляемых tooqueues или разделы. Несекционированной очереди или разделу назначается tooone хранилище обмена сообщениями. Если это хранилище сообщений недоступно, все операции с этой очередью или разделом завершатся с ошибкой.

Все сущности обмена сообщениями служебной шины (очереди, разделы, ретрансляторы) располагаются в пространстве имен службы, которое связывается с центром обработки данных. Service Bus не поддерживает автоматическую географическую репликацию данных, и не позволяет toospan пространства имен нескольких центрах обработки данных.

## <a name="protecting-against-acs-outages"></a>Защита от простоев ACS
Если вы используете учетные данные ACS и ACS становится недоступной, клиенты больше не смогут получать маркеры. Клиенты, имеющие маркер hello момент сбоя ACS, можно продолжить toouse Service Bus, до истечения срока действия маркеров hello. Срок действия маркера по умолчанию Hello составляет 3 часа.

tooprotect от сбоев ACS использовать маркеры подписи общего доступа (SAS). В этом случае hello клиент проверяет подлинность непосредственно с Service Bus, подписывая самостоятельно созданный маркер секретным ключом. Вызовы tooACS больше не требуются. Дополнительные сведения о токенах SAS см. в статье [Аутентификация и авторизация в служебной шине][Service Bus authentication].

## <a name="protecting-queues-and-topics-against-messaging-store-failures"></a>Защита очередей и разделов от сбоев хранилища сообщений
Несекционированной очереди или разделу назначается tooone хранилище обмена сообщениями. Если это хранилище сообщений недоступно, все операции с этой очередью или разделом завершатся с ошибкой. Объект секционированные очереди на hello другой стороны, состоит из нескольких фрагментов. Все они хранятся в разных хранилищах сообщений. При отправке сообщения tooa секционированной очереди или раздела Service Bus назначает tooone сообщение hello hello фрагментов. В случае недоступности соответствующее хранилище сообщений hello Service Bus записывает hello tooa различных фрагментов сообщений, если это возможно. Дополнительные сведения о секционированных сущностях см. в статье [Секционированные сущности обмена сообщениями][Partitioned messaging entities].

## <a name="protecting-against-datacenter-outages-or-disasters"></a>Защита от простоев или аварий центра обработки данных
tooallow для отработки отказа между двумя центрами обработки данных, можно создать пространство имен службы служебной шины в каждом центре обработки данных. Например, hello пространства имен службы Service Bus **contosoPrimary.servicebus.windows.net** может находиться в регионе США или центральном hello, и **contosoSecondary.servicebus.windows.net**может находиться в hello нам южном или центральном регионе. Если сущность обмена сообщениями служебной шины должен быть доступен в hello наличие сбоя центра обработки данных, можно создать сущность в обоих пространствах имен.

Дополнительные сведения см. в разделе статьи «Сбой служебной шины в центре обработки данных Azure» hello [асинхронного обмена сообщениями, шаблонов и высокий уровень доступности][Asynchronous messaging patterns and high availability].

## <a name="protecting-relay-endpoints-against-datacenter-outages-or-disasters"></a>Защита конечных точек ретрансляции от простоев или аварий центра обработки данных
Географическая репликация конечных точек ретрансляции обеспечивает службу, предоставляющую toobe для конечной точки ретрансляции, доступным при наличии hello перебоев в работе службы. tooachieve георепликации, hello службы необходимо создать две конечных точки ретрансляции в разных пространствах имен. пространства имен Hello должны находиться в разных центрах обработки данных и hello две конечные точки должны иметь разные имена. Например, первичная конечная точка может быть доступна как **contosoPrimary.servicebus.windows.net/myPrimaryService**, а ее вторичный аналог — как **contosoSecondary.servicebus.windows.net/mySecondaryService**.

Затем служба Здравствуй прослушивает обе конечные точки, и клиент может вызывать службу hello через конечную точку. Клиентское приложение случайным образом выбирает ретрансляции hello как hello основной конечной точки и отправляет его запрос toohello активной конечной точки. Если hello операция завершается ошибкой с кодом ошибки, эта ошибка означает, что этой конечной точки ретрансляции hello недоступен. приложение Hello открывает канал toohello резервной конечной точке и снова отправляет запрос hello. На этом этапе hello активных и резервных конечных точек hello переключения ролей: hello клиентское приложение считает hello старого активную конечную точку toobe hello новой резервной конечной точкой, а старой резервной конечной точке toobe hello hello новой активной конечной точкой. Если сбоя обеих операций отправки, роли hello hello двух сущностей остаются без изменений и возвращается сообщение об ошибке.

Hello [георепликация с использованием Service Bus с ретрансляцией сообщения] [ Geo-replication with Service Bus relayed Messages] образце показано, как tooreplicate ретрансляции.

## <a name="protecting-queues-and-topics-against-datacenter-outages-or-disasters"></a>Защита очередей и разделов от простоев или аварий центра обработки данных
tooachieve устойчивости к сбоям ЦОД при с помощью обмена сообщениями через посредника, Service Bus поддерживает два подхода: *active* и *пассивный* репликации. Для каждого подхода Если очередь или раздел должны оставаться доступными в hello наличие сбоя центра обработки данных можно создать ее в обоих пространствах имен. Обе сущности могут иметь hello таким же именем. Например, первичная очередь может быть доступна как **contosoPrimary.servicebus.windows.net/myQueue**, а ее вторичный аналог — как **contosoSecondary.servicebus.windows.net/myQueue**.

Если приложение hello не требует постоянного взаимодействия отправителя и получателя, приложение hello можно реализовать надежная очередь на стороне клиента tooprevent потери и tooshield hello отправителя сообщения из любой временных ошибок Service Bus.

## <a name="active-replication"></a>Активная репликация
При активной репликации для каждой операции используются объекты в обоих пространствах имен. Любой клиент, отправляющий сообщение отправляет hello две копии одного сообщения. Hello первая копия отправляется toohello основная сущность (например, **contosoPrimary.servicebus.windows.net/sales**), и вторую копию hello приветственное сообщение отправляется toohello дополнительный объект (например,  **contosoSecondary.servicebus.windows.net/sales**).

Клиент получает сообщения из обеих очередей. процессы приемника Hello hello первую копию сообщения и hello вторая копия пропускается. toosuppress дубликатов сообщений hello отправитель должен помечать все сообщения, с уникальным идентификатором. Обе копии сообщения hello должен быть помечен hello такой же идентификатор. Можно использовать hello [BrokeredMessage.MessageId] [ BrokeredMessage.MessageId] или [BrokeredMessage.Label] [ BrokeredMessage.Label] свойства или типа hello tootag пользовательских свойств Сообщение. Hello получатель должен иметь список уже полученных им сообщений.

Hello [георепликации с сообщениями через посредника Service Bus] [ Geo-replication with Service Bus Brokered Messages] образце показана активная репликация сущностей обмена сообщениями.

> [!NOTE]
> Hello активная репликация удваивает количество hello операций, поэтому этот подход может привести toohigher затрат.
> 
> 

## <a name="passive-replication"></a>Пассивная репликация
В случае сбоя освободить hello пассивная репликация использует только один из двух сущностей обмена сообщениями hello. Клиент отправляет сообщение hello: toohello активной сущности. Если операция hello на hello активной сущности завершается неудачей с кодом ошибки, указывающее hello центра обработки данных, что узлы hello активной сущности могут быть недоступны, hello клиент отправляет копию сущности резервного копирования toohello сообщение hello. На этом этапе hello active и сущности резервного копирования hello переключения ролей: hello отправляющий клиент принимает hello старого активной сущности toobe hello новую резервную сущность и hello старая резервная сущность является новой активной сущности hello. Если сбоя обеих операций отправки, роли hello hello двух сущностей остаются без изменений и возвращается сообщение об ошибке.

Клиент получает сообщения из обеих очередей. Поскольку есть вероятность, что hello получатель получит две копии hello сообщение, hello получатель должен отслеживать повторяющихся сообщений. Можно подавить дублирует hello так же, как описано для активной репликации.

В целом пассивная репликация экономичнее активной, поскольку в большинстве случаев выполняется только одна операция. Задержки, пропускной способности и денежное выражение стоимости являются идентичными toohello сценариях без репликации.

При использовании пассивной репликации в hello следующие сценарии сообщения может быть потерян или получены дважды:

* **Задержка или потеря сообщений**: предположим, что hello отправитель успешно отправил сообщение m1 toohello основная очередь и затем hello очереди становится недоступным, прежде чем hello получатель получит m1. Hello отправитель отправляет последующие сообщения очереди получателя m2 toohello. Если основная очередь hello временно недоступна, получатель hello получает m1 после hello очередь снова станет доступной. В случае аварии hello получатель может никогда не получить m1.
* **Двойное получение**: предположим, что hello отправитель отправляет сообщения m toohello основная очередь. Шина обслуживания успешно обрабатывает m, но завершается сбоем toosend ответа. После hello отправить операции истечением времени ожидания, отправитель hello отправляет идентичную копию дополнительной очереди toohello m. Если получатель hello может tooreceive hello первую копию m до hello основной очереди, hello получатель получит обе копии m в приблизительно hello то же время. Если hello получатель не может tooreceive hello первую копию m до hello основной очереди, получатель hello сначала получит только hello вторая копия m, но затем получает вторая копия m, когда hello основная очередь станет доступна.

Hello [георепликация с использованием Service Bus через посредника сообщений] [ Geo-replication with Service Bus Brokered Messages] образце показана пассивная репликация сущностей обмена сообщениями.

## <a name="next-steps"></a>Дальнейшие действия
toolearn Дополнительные сведения о аварийного восстановления, см. в этих статьях:

* [Обзор обеспечения непрерывности бизнес-процессов с помощью базы данных SQL Azure][Azure SQL Database Business Continuity]
* [Проектирование устойчивых приложений для Azure][Azure resiliency technical guidance]

[Service Bus Authentication]: service-bus-authentication-and-authorization.md
[Partitioned messaging entities]: service-bus-partitioning.md
[Asynchronous messaging patterns and high availability]: service-bus-async-messaging.md#failure-of-service-bus-within-an-azure-datacenter
[Geo-replication with Service Bus Relayed Messages]: http://code.msdn.microsoft.com/Geo-replication-with-16dbfecd
[BrokeredMessage.MessageId]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_MessageId
[BrokeredMessage.Label]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_Label
[Geo-replication with Service Bus Brokered Messages]: http://code.msdn.microsoft.com/Geo-replication-with-f5688664
[Azure SQL Database Business Continuity]: ../sql-database/sql-database-business-continuity.md
[Azure resiliency technical guidance]: /azure/architecture/resiliency

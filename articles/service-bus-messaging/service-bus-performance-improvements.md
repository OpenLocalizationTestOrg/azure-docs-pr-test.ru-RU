---
title: "Рекомендации по повышению производительности с помощью служебной шины Azure | Документация Майкрософт"
description: "В этой статье описывается использование служебной шины Azure для оптимизации производительности при обмене сообщениями в брокере."
services: service-bus-messaging
documentationcenter: na
author: sethmanheim
manager: timlt
editor: 
ms.assetid: e756c15d-31fc-45c0-8df4-0bca0da10bb2
ms.service: service-bus-messaging
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 05/10/2017
ms.author: sethm
ms.openlocfilehash: e6a0e480f7748f12f5e566cf4059b5b2c4242c09
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2017
---
# <a name="best-practices-for-performance-improvements-using-service-bus-messaging"></a><span data-ttu-id="faffd-103">Рекомендации по повышению производительности с помощью обмена сообщениями через служебную шину</span><span class="sxs-lookup"><span data-stu-id="faffd-103">Best Practices for performance improvements using Service Bus Messaging</span></span>

<span data-ttu-id="faffd-104">В этой статье описывается использование [обмена данными через служебную шину Azure](https://azure.microsoft.com/services/service-bus/) для оптимизации производительности при обмене сообщениями в брокере.</span><span class="sxs-lookup"><span data-stu-id="faffd-104">This article describes how to use [Azure Service Bus messaging](https://azure.microsoft.com/services/service-bus/) to optimize performance when exchanging brokered messages.</span></span> <span data-ttu-id="faffd-105">В первой части статьи описываются различные механизмы, которые можно использовать для повышения производительности.</span><span class="sxs-lookup"><span data-stu-id="faffd-105">The first part of this topic describes the different mechanisms that are offered to help increase performance.</span></span> <span data-ttu-id="faffd-106">Во второй части приведены инструкции по эффективному использованию служебной шины для достижения максимальной производительности при определенных условиях.</span><span class="sxs-lookup"><span data-stu-id="faffd-106">The second part provides guidance on how to use Service Bus in a way that can offer the best performance in a given scenario.</span></span>

<span data-ttu-id="faffd-107">В этой статье термин "клиент" означает любую сущность, которая обращается к служебной шине.</span><span class="sxs-lookup"><span data-stu-id="faffd-107">Throughout this topic, the term "client" refers to any entity that accesses Service Bus.</span></span> <span data-ttu-id="faffd-108">Клиент может быть как отправителем, так и получателем.</span><span class="sxs-lookup"><span data-stu-id="faffd-108">A client can take the role of a sender or a receiver.</span></span> <span data-ttu-id="faffd-109">Термин "отправитель" используется в отношении клиента очереди или раздела служебной шины, который отправляет сообщения в очередь или раздел.</span><span class="sxs-lookup"><span data-stu-id="faffd-109">The term "sender" is used for a Service Bus queue or topic client that sends messages to a Service Bus queue or topic.</span></span> <span data-ttu-id="faffd-110">Термин "получатель" используется в отношении клиента очереди или подписки служебной шины, который получает сообщения из очереди или подписки.</span><span class="sxs-lookup"><span data-stu-id="faffd-110">The term "receiver" refers to a Service Bus queue or subscription client that receives messages from a Service Bus queue or subscription.</span></span>

<span data-ttu-id="faffd-111">В разделах ниже описывается ряд способов, которые используются служебной шиной для повышения производительности.</span><span class="sxs-lookup"><span data-stu-id="faffd-111">These sections introduce several concepts that Service Bus uses to help boost performance.</span></span>

## <a name="protocols"></a><span data-ttu-id="faffd-112">Протоколы</span><span class="sxs-lookup"><span data-stu-id="faffd-112">Protocols</span></span>
<span data-ttu-id="faffd-113">Служебная шина позволяет клиентам отправлять и получать сообщения с помощью трех протоколов.</span><span class="sxs-lookup"><span data-stu-id="faffd-113">Service Bus enables clients to send and receive messages via one of three protocols:</span></span>

1. <span data-ttu-id="faffd-114">Протокол AMQP</span><span class="sxs-lookup"><span data-stu-id="faffd-114">Advanced Message Queuing Protocol (AMQP)</span></span>
2. <span data-ttu-id="faffd-115">Протокол SBMP</span><span class="sxs-lookup"><span data-stu-id="faffd-115">Service Bus Messaging Protocol (SBMP)</span></span>
3. <span data-ttu-id="faffd-116">HTTP</span><span class="sxs-lookup"><span data-stu-id="faffd-116">HTTP</span></span>

<span data-ttu-id="faffd-117">Протоколы AMQP и SBMP более эффективны, так как они поддерживают подключение к служебной шине, пока существует фабрика обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="faffd-117">AMQP and SBMP are more efficient, because they maintain the connection to Service Bus as long as the messaging factory exists.</span></span> <span data-ttu-id="faffd-118">Он также реализует функции пакетной обработки и предварительной выборки.</span><span class="sxs-lookup"><span data-stu-id="faffd-118">It also implements batching and prefetching.</span></span> <span data-ttu-id="faffd-119">Если явно не указано иное, в этой статье предполагается использование протокола AMQP или SBMP.</span><span class="sxs-lookup"><span data-stu-id="faffd-119">Unless explicitly mentioned, all content in this topic assumes the use of AMQP or SBMP.</span></span>

## <a name="reusing-factories-and-clients"></a><span data-ttu-id="faffd-120">Повторное использование фабрик и клиентов</span><span class="sxs-lookup"><span data-stu-id="faffd-120">Reusing factories and clients</span></span>
<span data-ttu-id="faffd-121">Клиентские объекты служебной шины, такие как [QueueClient][QueueClient] или [MessageSender][MessageSender], создаются с помощью объекта [MessagingFactory][MessagingFactory]. Этот объект также обеспечивает внутреннее управление подключениями.</span><span class="sxs-lookup"><span data-stu-id="faffd-121">Service Bus client objects, such as [QueueClient][QueueClient] or [MessageSender][MessageSender], are created through a [MessagingFactory][MessagingFactory] object, which also provides internal management of connections.</span></span> <span data-ttu-id="faffd-122">Не следует закрывать фабрики обмена сообщениями или клиенты очередей, разделов и подписок после отправки сообщения, а затем повторно создавать их при отправке следующего сообщения.</span><span class="sxs-lookup"><span data-stu-id="faffd-122">You should not close messaging factories or queue, topic, and subscription clients after you send a message, and then re-create them when you send the next message.</span></span> <span data-ttu-id="faffd-123">При закрытии фабрики обмена сообщениями удаляется подключение к службе служебной шины, а при повторном создании фабрики устанавливается новое подключение.</span><span class="sxs-lookup"><span data-stu-id="faffd-123">Closing a messaging factory deletes the connection to the Service Bus service, and a new connection is established when recreating the factory.</span></span> <span data-ttu-id="faffd-124">Установка подключения является ресурсоемкой операцией, которую можно исключить, если повторно использовать одну и ту же фабрику и клиентские объекты для нескольких операций.</span><span class="sxs-lookup"><span data-stu-id="faffd-124">Establishing a connection is an expensive operation that you can avoid by re-using the same factory and client objects for multiple operations.</span></span> <span data-ttu-id="faffd-125">Объект [QueueClient][QueueClient] можно безопасно использовать для отправки сообщений из параллельных асинхронных операций и нескольких потоков.</span><span class="sxs-lookup"><span data-stu-id="faffd-125">You can safely use the [QueueClient][QueueClient] object for sending messages from concurrent asynchronous operations and multiple threads.</span></span> 

## <a name="concurrent-operations"></a><span data-ttu-id="faffd-126">Параллельные операции</span><span class="sxs-lookup"><span data-stu-id="faffd-126">Concurrent operations</span></span>
<span data-ttu-id="faffd-127">Выполнение любой операции (отправка, получение, удаление и т. д.) занимает определенное время.</span><span class="sxs-lookup"><span data-stu-id="faffd-127">Performing an operation (send, receive, delete, etc.) takes some time.</span></span> <span data-ttu-id="faffd-128">В это время входит обработка операции службой Service Bus, а также задержка запроса и ответа.</span><span class="sxs-lookup"><span data-stu-id="faffd-128">This time includes the processing of the operation by the Service Bus service in addition to the latency of the request and the reply.</span></span> <span data-ttu-id="faffd-129">Чтобы увеличить количество операций в единицу времени, необходимо выполнять их параллельно.</span><span class="sxs-lookup"><span data-stu-id="faffd-129">To increase the number of operations per time, operations must execute concurrently.</span></span> <span data-ttu-id="faffd-130">Это можно сделать несколькими способами.</span><span class="sxs-lookup"><span data-stu-id="faffd-130">You can do this in several different ways:</span></span>

* <span data-ttu-id="faffd-131">**Асинхронные операции**. Клиент планирует действия за счет асинхронных операций.</span><span class="sxs-lookup"><span data-stu-id="faffd-131">**Asynchronous operations**: the client schedules operations by performing asynchronous operations.</span></span> <span data-ttu-id="faffd-132">Следующий запрос запускается до завершения предыдущего запроса.</span><span class="sxs-lookup"><span data-stu-id="faffd-132">The next request is started before the previous request is completed.</span></span> <span data-ttu-id="faffd-133">Вот пример асинхронной операции отправки:</span><span class="sxs-lookup"><span data-stu-id="faffd-133">The following is an example of an asynchronous send operation:</span></span>
  
 ```csharp
  BrokeredMessage m1 = new BrokeredMessage(body);
  BrokeredMessage m2 = new BrokeredMessage(body);
  
  Task send1 = queueClient.SendAsync(m1).ContinueWith((t) => 
    {
      Console.WriteLine("Sent message #1");
    });
  Task send2 = queueClient.SendAsync(m2).ContinueWith((t) => 
    {
      Console.WriteLine("Sent message #2");
    });
  Task.WaitAll(send1, send2);
  Console.WriteLine("All messages sent");
  ```
  
  <span data-ttu-id="faffd-134">Вот пример асинхронной операции получения:</span><span class="sxs-lookup"><span data-stu-id="faffd-134">This is an example of an asynchronous receive operation:</span></span>
  
  ```csharp
  Task receive1 = queueClient.ReceiveAsync().ContinueWith(ProcessReceivedMessage);
  Task receive2 = queueClient.ReceiveAsync().ContinueWith(ProcessReceivedMessage);
  
  Task.WaitAll(receive1, receive2);
  Console.WriteLine("All messages received");
  
  async void ProcessReceivedMessage(Task<BrokeredMessage> t)
  {
    BrokeredMessage m = t.Result;
    Console.WriteLine("{0} received", m.Label);
    await m.CompleteAsync();
    Console.WriteLine("{0} complete", m.Label);
  }
  ```
* <span data-ttu-id="faffd-135">**Несколько фабрик**. Все клиенты (отправители и получатели), созданные одной фабрикой, используют одно TCP-подключение.</span><span class="sxs-lookup"><span data-stu-id="faffd-135">**Multiple factories**: all clients (senders in addition to receivers) that are created by the same factory share one TCP connection.</span></span> <span data-ttu-id="faffd-136">Максимальная пропускная способность для сообщений ограничена числом операций, проходящих через это TCP-подключение.</span><span class="sxs-lookup"><span data-stu-id="faffd-136">The maximum message throughput is limited by the number of operations that can go through this TCP connection.</span></span> <span data-ttu-id="faffd-137">Пропускная способность отдельной фабрики в значительной степени зависит от времени кругового пути TCP и размера сообщения.</span><span class="sxs-lookup"><span data-stu-id="faffd-137">The throughput that can be obtained with a single factory varies greatly with TCP round-trip times and message size.</span></span> <span data-ttu-id="faffd-138">Чтобы увеличить пропускную способность, следует использовать несколько фабрик обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="faffd-138">To obtain higher throughput rates, you should use multiple messaging factories.</span></span>

## <a name="receive-mode"></a><span data-ttu-id="faffd-139">Режим получения</span><span class="sxs-lookup"><span data-stu-id="faffd-139">Receive mode</span></span>
<span data-ttu-id="faffd-140">При создании клиента очереди или подписки вы можете выбрать режим получения: *блокировка для просмотра* или *получение и удаление*.</span><span class="sxs-lookup"><span data-stu-id="faffd-140">When creating a queue or subscription client, you can specify a receive mode: *Peek-lock* or *Receive and Delete*.</span></span> <span data-ttu-id="faffd-141">По умолчанию используется режим [блокировки для просмотра][PeekLock].</span><span class="sxs-lookup"><span data-stu-id="faffd-141">The default receive mode is [PeekLock][PeekLock].</span></span> <span data-ttu-id="faffd-142">В этом режиме клиент отправляет запрос на получение сообщения из служебной шины.</span><span class="sxs-lookup"><span data-stu-id="faffd-142">When operating in this mode, the client sends a request to receive a message from Service Bus.</span></span> <span data-ttu-id="faffd-143">После получения сообщения клиент отправляет запрос на завершение сообщения.</span><span class="sxs-lookup"><span data-stu-id="faffd-143">After the client has received the message, it sends a request to complete the message.</span></span>

<span data-ttu-id="faffd-144">Если установить режим [получения и удаления][ReceiveAndDelete], оба этих действия объединяются в один запрос.</span><span class="sxs-lookup"><span data-stu-id="faffd-144">When setting the receive mode to [ReceiveAndDelete][ReceiveAndDelete], both steps are combined in a single request.</span></span> <span data-ttu-id="faffd-145">В результате уменьшается общее количество операций, что может повысить общую пропускную способность для сообщений.</span><span class="sxs-lookup"><span data-stu-id="faffd-145">This reduces the overall number of operations, and can improve the overall message throughput.</span></span> <span data-ttu-id="faffd-146">Однако такое повышение производительности сопряжено с риском потери сообщений.</span><span class="sxs-lookup"><span data-stu-id="faffd-146">This performance gain comes at the risk of losing messages.</span></span>

<span data-ttu-id="faffd-147">Служебная шина не поддерживает транзакции для операций получения и удаления.</span><span class="sxs-lookup"><span data-stu-id="faffd-147">Service Bus does not support transactions for receive-and-delete operations.</span></span> <span data-ttu-id="faffd-148">Кроме того, иногда требуется семантика блокировки для просмотра (например, если клиенту необходимо отложить сообщение или [пометить его как недоставленное](service-bus-dead-letter-queues.md)).</span><span class="sxs-lookup"><span data-stu-id="faffd-148">In addition, peek-lock semantics are required for any scenarios in which the client wants to defer or [dead-letter](service-bus-dead-letter-queues.md) a message.</span></span>

## <a name="client-side-batching"></a><span data-ttu-id="faffd-149">Пакетная обработка на стороне клиента</span><span class="sxs-lookup"><span data-stu-id="faffd-149">Client-side batching</span></span>
<span data-ttu-id="faffd-150">Пакетная обработка на стороне клиента позволяет клиенту очереди или раздела задержать отправку сообщения на определенный период времени.</span><span class="sxs-lookup"><span data-stu-id="faffd-150">Client-side batching enables a queue or topic client to delay the sending of a message for a certain period of time.</span></span> <span data-ttu-id="faffd-151">Если в течение этого времени клиент будет отправлять дополнительные сообщения, они будут переданы в одном пакете.</span><span class="sxs-lookup"><span data-stu-id="faffd-151">If the client sends additional messages during this time period, it transmits the messages in a single batch.</span></span> <span data-ttu-id="faffd-152">Кроме того, пакетная обработка на стороне клиента очереди или подписки позволяет объединить несколько запросов на **завершение** в один.</span><span class="sxs-lookup"><span data-stu-id="faffd-152">Client-side batching also causes a queue or subscription client to batch multiple **Complete** requests into a single request.</span></span> <span data-ttu-id="faffd-153">Пакетная обработка возможна только для асинхронных операций **отправки** и **завершения**.</span><span class="sxs-lookup"><span data-stu-id="faffd-153">Batching is only available for asynchronous **Send** and **Complete** operations.</span></span> <span data-ttu-id="faffd-154">Синхронные операции отправляются в службу служебной шины незамедлительно.</span><span class="sxs-lookup"><span data-stu-id="faffd-154">Synchronous operations are immediately sent to the Service Bus service.</span></span> <span data-ttu-id="faffd-155">Пакетная обработка недоступна для операций просмотра или получения. Также пакетную обработку нельзя использовать для объединения операций нескольких клиентов.</span><span class="sxs-lookup"><span data-stu-id="faffd-155">Batching does not occur for peek or receive operations, nor does batching occur across clients.</span></span>

<span data-ttu-id="faffd-156">По умолчанию интервал пакетной обработки в клиенте составляет 20 мс.</span><span class="sxs-lookup"><span data-stu-id="faffd-156">By default, a client uses a batch interval of 20ms.</span></span> <span data-ttu-id="faffd-157">Интервал пакетной обработки можно изменить с помощью свойства [BatchFlushInterval][BatchFlushInterval], которое задается перед созданием фабрики обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="faffd-157">You can change the batch interval by setting the [BatchFlushInterval][BatchFlushInterval] property before creating the messaging factory.</span></span> <span data-ttu-id="faffd-158">Этот параметр влияет на все клиенты, создаваемые этой фабрикой.</span><span class="sxs-lookup"><span data-stu-id="faffd-158">This setting affects all clients that are created by this factory.</span></span>

<span data-ttu-id="faffd-159">Чтобы отключить пакетную обработку, задайте для свойства [BatchFlushInterval][BatchFlushInterval] значение **TimeSpan.Zero**.</span><span class="sxs-lookup"><span data-stu-id="faffd-159">To disable batching, set the [BatchFlushInterval][BatchFlushInterval] property to **TimeSpan.Zero**.</span></span> <span data-ttu-id="faffd-160">Например:</span><span class="sxs-lookup"><span data-stu-id="faffd-160">For example:</span></span>

```csharp
MessagingFactorySettings mfs = new MessagingFactorySettings();
mfs.TokenProvider = tokenProvider;
mfs.NetMessagingTransportSettings.BatchFlushInterval = TimeSpan.FromSeconds(0.05);
MessagingFactory messagingFactory = MessagingFactory.Create(namespaceUri, mfs);
```

<span data-ttu-id="faffd-161">Пакетная обработка не влияет на количество оплачиваемых операций обмена сообщениями и доступна только для протокола клиента служебной шины.</span><span class="sxs-lookup"><span data-stu-id="faffd-161">Batching does not affect the number of billable messaging operations, and is available only for the Service Bus client protocol.</span></span> <span data-ttu-id="faffd-162">Протокол HTTP не поддерживает пакетную обработку.</span><span class="sxs-lookup"><span data-stu-id="faffd-162">The HTTP protocol does not support batching.</span></span>

## <a name="batching-store-access"></a><span data-ttu-id="faffd-163">Пакетный доступ к хранилищу</span><span class="sxs-lookup"><span data-stu-id="faffd-163">Batching store access</span></span>
<span data-ttu-id="faffd-164">Чтобы увеличить пропускную способность очереди, раздела или подписки, служебная шина объединяет несколько сообщений в пакеты, когда записывает их в свое внутреннее хранилище.</span><span class="sxs-lookup"><span data-stu-id="faffd-164">To increase the throughput of a queue, topic, or subscription, Service Bus batches multiple messages when it writes to its internal store.</span></span> <span data-ttu-id="faffd-165">Если эта функция включена для очереди или раздела, сообщения записываются в хранилище в пакетном режиме.</span><span class="sxs-lookup"><span data-stu-id="faffd-165">If enabled on a queue or topic, writing messages into the store will be batched.</span></span> <span data-ttu-id="faffd-166">Если эта функция включена для очереди или подписки, сообщения будут удаляться из хранилища в пакетном режиме.</span><span class="sxs-lookup"><span data-stu-id="faffd-166">If enabled on a queue or subscription, deleting messages from the store will be batched.</span></span> <span data-ttu-id="faffd-167">Если пакетный доступ к хранилищу включен для сущности, служебная шина будет задерживать операцию записи для этой сущности на период до 20 мс.</span><span class="sxs-lookup"><span data-stu-id="faffd-167">If batched store access is enabled for an entity, Service Bus delays a store write operation regarding that entity by up to 20ms.</span></span> <span data-ttu-id="faffd-168">Последующие операции с хранилищем, выполняемые в течение этого периода, добавляются в пакет.</span><span class="sxs-lookup"><span data-stu-id="faffd-168">Additional store operations that occur during this interval are added to the batch.</span></span> <span data-ttu-id="faffd-169">Пакетный доступ к хранилищу влияет только на операции **отправки** и **завершения**. Операции получения не затрагиваются.</span><span class="sxs-lookup"><span data-stu-id="faffd-169">Batched store access only affects **Send** and **Complete** operations; receive operations are not affected.</span></span> <span data-ttu-id="faffd-170">Пакетный доступ к хранилищу является свойством сущности.</span><span class="sxs-lookup"><span data-stu-id="faffd-170">Batched store access is a property on an entity.</span></span> <span data-ttu-id="faffd-171">Пакетная обработка применяется ко всем сущностям, для которых включен пакетный доступ к хранилищу.</span><span class="sxs-lookup"><span data-stu-id="faffd-171">Batching occurs across all entities that enable batched store access.</span></span>

<span data-ttu-id="faffd-172">При создании новой очереди, раздела или подписки пакетный доступ к хранилищу включен по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="faffd-172">When creating a new queue, topic or subscription, batched store access is enabled by default.</span></span> <span data-ttu-id="faffd-173">Чтобы отключить пакетный доступ к хранилищу, задайте для свойства [EnableBatchedOperations][EnableBatchedOperations] значение **false** перед созданием сущности.</span><span class="sxs-lookup"><span data-stu-id="faffd-173">To disable batched store access, set the [EnableBatchedOperations][EnableBatchedOperations] property to **false** before creating the entity.</span></span> <span data-ttu-id="faffd-174">Например:</span><span class="sxs-lookup"><span data-stu-id="faffd-174">For example:</span></span>

```csharp
QueueDescription qd = new QueueDescription();
qd.EnableBatchedOperations = false;
Queue q = namespaceManager.CreateQueue(qd);
```

<span data-ttu-id="faffd-175">Пакетный доступ к хранилищу не влияет на количество оплачиваемых операций обмена сообщениями и является свойством очереди, раздела или подписки.</span><span class="sxs-lookup"><span data-stu-id="faffd-175">Batched store access does not affect the number of billable messaging operations, and is a property of a queue, topic, or subscription.</span></span> <span data-ttu-id="faffd-176">Он не зависит от режима получения и протокола, используемого для подключения между клиентом и службой служебной шины.</span><span class="sxs-lookup"><span data-stu-id="faffd-176">It is independent of the receive mode and the protocol that is used between a client and the Service Bus service.</span></span>

## <a name="prefetching"></a><span data-ttu-id="faffd-177">Предварительная выборка</span><span class="sxs-lookup"><span data-stu-id="faffd-177">Prefetching</span></span>
<span data-ttu-id="faffd-178">Предварительная выборка позволяет клиенту очереди или подписки загружать дополнительные сообщения из службы при выполнении операции получения.</span><span class="sxs-lookup"><span data-stu-id="faffd-178">Prefetching enables the queue or subscription client to load additional messages from the service when it performs a receive operation.</span></span> <span data-ttu-id="faffd-179">Клиент сохраняет эти сообщения в локальном кэше.</span><span class="sxs-lookup"><span data-stu-id="faffd-179">The client stores these messages in a local cache.</span></span> <span data-ttu-id="faffd-180">Размер кэша определяется свойствами [QueueClient.PrefetchCount][QueueClient.PrefetchCount] или [SubscriptionClient.PrefetchCount][SubscriptionClient.PrefetchCount].</span><span class="sxs-lookup"><span data-stu-id="faffd-180">The size of the cache is determined by the [QueueClient.PrefetchCount][QueueClient.PrefetchCount] or [SubscriptionClient.PrefetchCount][SubscriptionClient.PrefetchCount] properties.</span></span> <span data-ttu-id="faffd-181">В каждом клиенте с включенной предварительной выборкой создается собственный кэш.</span><span class="sxs-lookup"><span data-stu-id="faffd-181">Each client that enables prefetching maintains its own cache.</span></span> <span data-ttu-id="faffd-182">Кэш не может использоваться одновременно несколькими клиентами.</span><span class="sxs-lookup"><span data-stu-id="faffd-182">A cache is not shared across clients.</span></span> <span data-ttu-id="faffd-183">Если клиент инициирует операцию получения и его кэш пуст, служба передает пакет сообщений.</span><span class="sxs-lookup"><span data-stu-id="faffd-183">If the client initiates a receive operation and its cache is empty, the service transmits a batch of messages.</span></span> <span data-ttu-id="faffd-184">Размер пакета равен размеру кэша или 256 КБ (в зависимости от того, какое значение меньше).</span><span class="sxs-lookup"><span data-stu-id="faffd-184">The size of the batch equals the size of the cache or 256 KB, whichever is smaller.</span></span> <span data-ttu-id="faffd-185">Если клиент инициирует операцию получения и в кэше имеется сообщение, это сообщение извлекается из кэша.</span><span class="sxs-lookup"><span data-stu-id="faffd-185">If the client initiates a receive operation and the cache contains a message, the message is taken from the cache.</span></span>

<span data-ttu-id="faffd-186">При использовании предварительной выборки сообщений служба блокирует выбранное сообщение.</span><span class="sxs-lookup"><span data-stu-id="faffd-186">When a message is prefetched, the service locks the prefetched message.</span></span> <span data-ttu-id="faffd-187">В результате это сообщение не может быть получено другим получателем.</span><span class="sxs-lookup"><span data-stu-id="faffd-187">By doing this, the prefetched message cannot be received by a different receiver.</span></span> <span data-ttu-id="faffd-188">Если получатель не может завершить сообщение до истечения периода блокировки, сообщение станет доступным другим получателям.</span><span class="sxs-lookup"><span data-stu-id="faffd-188">If the receiver cannot complete the message before the lock expires, the message becomes available to other receivers.</span></span> <span data-ttu-id="faffd-189">Копия предварительно выбранного сообщения остается в кэше.</span><span class="sxs-lookup"><span data-stu-id="faffd-189">The prefetched copy of the message remains in the cache.</span></span> <span data-ttu-id="faffd-190">Если получатель обратится к кэшированной копии, срок действия которой истек, то при попытке завершить это сообщение будет создано исключение.</span><span class="sxs-lookup"><span data-stu-id="faffd-190">The receiver that consumes the expired cached copy will receive an exception when it tries to complete that message.</span></span> <span data-ttu-id="faffd-191">По умолчанию период блокировки сообщения составляет 60 секунд.</span><span class="sxs-lookup"><span data-stu-id="faffd-191">By default, the message lock expires after 60 seconds.</span></span> <span data-ttu-id="faffd-192">Это значение можно увеличить до 5 минут.</span><span class="sxs-lookup"><span data-stu-id="faffd-192">This value can be extended to 5 minutes.</span></span> <span data-ttu-id="faffd-193">Во избежание использования сообщений с истекшим сроком действия размер кэша всегда должен быть меньше, чем количество сообщений, которые могут быть использованы клиентом в течение периода блокировки.</span><span class="sxs-lookup"><span data-stu-id="faffd-193">To prevent the consumption of expired messages, the cache size should always be smaller than the number of messages that can be consumed by a client within the lock time-out interval.</span></span>

<span data-ttu-id="faffd-194">Если не менять стандартный период блокировки (60 секунд), то для свойства [SubscriptionClient.PrefetchCount][SubscriptionClient.PrefetchCount] рекомендуется установить значение, в 20 раз превышающее максимальную скорость обработки всех получателей фабрики.</span><span class="sxs-lookup"><span data-stu-id="faffd-194">When using the default lock expiration of 60 seconds, a good value for [SubscriptionClient.PrefetchCount][SubscriptionClient.PrefetchCount] is 20 times the maximum processing rates of all receivers of the factory.</span></span> <span data-ttu-id="faffd-195">Например, фабрика создает трех получателей, каждый из которых может обработать до 10 сообщений в секунду.</span><span class="sxs-lookup"><span data-stu-id="faffd-195">For example, a factory creates 3 receivers, and each receiver can process up to 10 messages per second.</span></span> <span data-ttu-id="faffd-196">Число объектов предварительной выборки не должно превышать 20 х 3 х 10 = 600.</span><span class="sxs-lookup"><span data-stu-id="faffd-196">The prefetch count should not exceed 20 X 3 X 10 = 600.</span></span> <span data-ttu-id="faffd-197">По умолчанию свойство [QueueClient.PrefetchCount][QueueClient.PrefetchCount] имеет значение 0. Это означает, что предварительная выборка сообщений из службы отключена.</span><span class="sxs-lookup"><span data-stu-id="faffd-197">By default, [QueueClient.PrefetchCount][QueueClient.PrefetchCount] is set to 0, which means that no additional messages are fetched from the service.</span></span>

<span data-ttu-id="faffd-198">Предварительная выборка сообщений увеличивает совокупную пропускную способность очереди или подписки, так как уменьшает общее количество операций с сообщениями (так называемых круговых путей).</span><span class="sxs-lookup"><span data-stu-id="faffd-198">Prefetching messages increases the overall throughput for a queue or subscription because it reduces the overall number of message operations, or round trips.</span></span> <span data-ttu-id="faffd-199">Тем не менее предварительная выборка первого сообщения займет больше времени (из-за увеличенного размера сообщения).</span><span class="sxs-lookup"><span data-stu-id="faffd-199">Fetching the first message, however, will take longer (due to the increased message size).</span></span> <span data-ttu-id="faffd-200">Получение предварительно выбранных сообщений будет выполняться быстрее, так как эти сообщения уже загружены клиентом.</span><span class="sxs-lookup"><span data-stu-id="faffd-200">Receiving prefetched messages will be faster because these messages have already been downloaded by the client.</span></span>

<span data-ttu-id="faffd-201">Свойство срока жизни сообщения проверяется сервером в момент отправки сообщения клиенту.</span><span class="sxs-lookup"><span data-stu-id="faffd-201">The time-to-live (TTL) property of a message is checked by the server at the time the server sends the message to the client.</span></span> <span data-ttu-id="faffd-202">При получении сообщения клиент не проверяет свойство срока жизни сообщения.</span><span class="sxs-lookup"><span data-stu-id="faffd-202">The client does not check the message’s TTL property when the message is received.</span></span> <span data-ttu-id="faffd-203">Сообщение может быть получено клиентом во время кэширования, даже если срок жизни сообщения истек.</span><span class="sxs-lookup"><span data-stu-id="faffd-203">Instead, the message can be received even if the message’s TTL has passed while the message was cached by the client.</span></span>

<span data-ttu-id="faffd-204">Предварительная выборка не влияет на количество оплачиваемых операций обмена сообщениями и доступна только для протокола клиента служебной шины.</span><span class="sxs-lookup"><span data-stu-id="faffd-204">Prefetching does not affect the number of billable messaging operations, and is available only for the Service Bus client protocol.</span></span> <span data-ttu-id="faffd-205">Протокол HTTP не поддерживает предварительную выборку.</span><span class="sxs-lookup"><span data-stu-id="faffd-205">The HTTP protocol does not support prefetching.</span></span> <span data-ttu-id="faffd-206">Предварительная выборка доступна как для синхронных, так и для асинхронных операций получения.</span><span class="sxs-lookup"><span data-stu-id="faffd-206">Prefetching is available for both synchronous and asynchronous receive operations.</span></span>

## <a name="express-queues-and-topics"></a><span data-ttu-id="faffd-207">Экспресс-очереди и экспресс-разделы</span><span class="sxs-lookup"><span data-stu-id="faffd-207">Express queues and topics</span></span>

<span data-ttu-id="faffd-208">Экспресс-сущности обеспечивают высокую пропускную способность и уменьшают частоту задержек. Они поддерживаются только на уровне обмена сообщениями "Стандартный".</span><span class="sxs-lookup"><span data-stu-id="faffd-208">Express entities enable high throughput and reduced latency scenarios, and are supported only in the Standard messaging tier.</span></span> <span data-ttu-id="faffd-209">Сущности, созданные в [пространстве имен уровня "Премиум"](service-bus-premium-messaging.md), не поддерживают параметр "Экспресс".</span><span class="sxs-lookup"><span data-stu-id="faffd-209">Entities created in [Premium namespaces](service-bus-premium-messaging.md) do not support the express option.</span></span> <span data-ttu-id="faffd-210">Если при использовании экспресс-сущностей сообщение отправляется в очередь или раздел, оно не помещается сразу же в хранилище сообщений.</span><span class="sxs-lookup"><span data-stu-id="faffd-210">With express entities, if a message is sent to a queue or topic, the message is not immediately stored in the messaging store.</span></span> <span data-ttu-id="faffd-211">Вместо этого оно сохраняется в кэше, расположенном в памяти.</span><span class="sxs-lookup"><span data-stu-id="faffd-211">Instead, it is cached in memory.</span></span> <span data-ttu-id="faffd-212">Если сообщение остается в очереди больше нескольких секунд, оно автоматически записывается в постоянное хранилище. Это делается для защиты от потери данных в случае сбоя.</span><span class="sxs-lookup"><span data-stu-id="faffd-212">If a message remains in the queue for more than a few seconds, it is automatically written to stable storage, thus protecting it against loss due to an outage.</span></span> <span data-ttu-id="faffd-213">Запись сообщения в кэш памяти повышает пропускную способность и сокращает задержки, так как в этом случае во время отправки сообщения исключается доступ к постоянному хранилищу.</span><span class="sxs-lookup"><span data-stu-id="faffd-213">Writing the message into a memory cache increases throughput and reduces latency because there is no access to stable storage at the time the message is sent.</span></span> <span data-ttu-id="faffd-214">Сообщения, обработанные в течение нескольких секунд, не записываются в хранилище обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="faffd-214">Messages that are consumed within a few seconds are not written to the messaging store.</span></span> <span data-ttu-id="faffd-215">В следующем примере создается экспресс-раздел.</span><span class="sxs-lookup"><span data-stu-id="faffd-215">The following example creates an express topic.</span></span>

```csharp
TopicDescription td = new TopicDescription(TopicName);
td.EnableExpress = true;
namespaceManager.CreateTopic(td);
```

<span data-ttu-id="faffd-216">Если в экспресс-сущность отправляется сообщение с критически важной информацией, которая не должна быть потеряна, то отправитель может дать команду служебной шине принудительно записать сообщение в постоянное хранилище. Для этого свойству [ForcePersistence][ForcePersistence] задается значение **true**.</span><span class="sxs-lookup"><span data-stu-id="faffd-216">If a message containing critical information that must not be lost is sent to an express entity, the sender can force Service Bus to immediately persist the message to stable storage by setting the [ForcePersistence][ForcePersistence] property to **true**.</span></span>

> [!NOTE]
> <span data-ttu-id="faffd-217">Транзакции не поддерживаются экспресс-сущностями.</span><span class="sxs-lookup"><span data-stu-id="faffd-217">Express entities do not support transactions.</span></span>

## <a name="use-of-partitioned-queues-or-topics"></a><span data-ttu-id="faffd-218">Использование секционированных очередей или разделов</span><span class="sxs-lookup"><span data-stu-id="faffd-218">Use of partitioned queues or topics</span></span>
<span data-ttu-id="faffd-219">Для обработки и хранения всех сообщений для сущности сообщений (очереди или раздела) внутри служебной шины используется один узел и хранилище обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="faffd-219">Internally, Service Bus uses the same node and messaging store to process and store all messages for a messaging entity (queue or topic).</span></span> <span data-ttu-id="faffd-220">С другой стороны, секционирование очередей или разделов позволяет распределять их между несколькими узлами и хранилищами обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="faffd-220">A partitioned queue or topic, on the other hand, is distributed across multiple nodes and messaging stores.</span></span> <span data-ttu-id="faffd-221">Секционированные очереди и разделы не только повышают пропускную способность в сравнении с обычными очередями и разделами, но также обеспечивают высочайший уровень доступности.</span><span class="sxs-lookup"><span data-stu-id="faffd-221">Partitioned queues and topics not only yield a higher throughput than regular queues and topics, they also exhibit superior availability.</span></span> <span data-ttu-id="faffd-222">Чтобы создать секционированную сущность, задайте для свойства [EnablePartitioning][EnablePartitioning] значение **true**, как показано в следующем примере.</span><span class="sxs-lookup"><span data-stu-id="faffd-222">To create a partitioned entity, set the [EnablePartitioning][EnablePartitioning] property to **true**, as shown in the following example.</span></span> <span data-ttu-id="faffd-223">Дополнительные сведения о секционированных сущностях см. в статье [Секционированные сущности обмена сообщениями][Partitioned messaging entities].</span><span class="sxs-lookup"><span data-stu-id="faffd-223">For more information about partitioned entities, see [Partitioned messaging entities][Partitioned messaging entities].</span></span>

```csharp
// Create partitioned queue.
QueueDescription qd = new QueueDescription(QueueName);
qd.EnablePartitioning = true;
namespaceManager.CreateQueue(qd);
```

## <a name="use-of-multiple-queues"></a><span data-ttu-id="faffd-224">Использование нескольких очередей</span><span class="sxs-lookup"><span data-stu-id="faffd-224">Use of multiple queues</span></span>

<span data-ttu-id="faffd-225">Если использование секционированной очереди или раздела невозможно или если ожидаемую нагрузку невозможно будет обработать с помощью одной секционированной очереди или раздела, необходимо использовать несколько сущностей обмена сообщениями.</span><span class="sxs-lookup"><span data-stu-id="faffd-225">If it is not possible to use a partitioned queue or topic, or the expected load cannot be handled by a single partitioned queue or topic, you must use multiple messaging entities.</span></span> <span data-ttu-id="faffd-226">При использовании нескольких сущностей создайте выделенный клиент для каждой сущности. Не используйте один клиент для всех сущностей.</span><span class="sxs-lookup"><span data-stu-id="faffd-226">When using multiple entities, create a dedicated client for each entity, instead of using the same client for all entities.</span></span>

## <a name="development-and-testing-features"></a><span data-ttu-id="faffd-227">Возможности для разработки и тестирования</span><span class="sxs-lookup"><span data-stu-id="faffd-227">Development and testing features</span></span>

<span data-ttu-id="faffd-228">В служебной шине доступна одна функция, используемая специально для разработки, которую **никогда не следует использовать в рабочих конфигурациях**: [TopicDescription.EnableFilteringMessagesBeforePublishing][].</span><span class="sxs-lookup"><span data-stu-id="faffd-228">Service Bus has one feature that is used specifically for development which **should never be used in production configurations**: [TopicDescription.EnableFilteringMessagesBeforePublishing][].</span></span>

<span data-ttu-id="faffd-229">При добавлении новых правил или фильтров в раздел вы можете использовать функцию [TopicDescription.EnableFilteringMessagesBeforePublishing][], чтобы проверить правильность работы выражения нового фильтра.</span><span class="sxs-lookup"><span data-stu-id="faffd-229">When new rules or filters are added to the topic, you can use [TopicDescription.EnableFilteringMessagesBeforePublishing][] to verify that the new filter expression is working as expected.</span></span>

## <a name="scenarios"></a><span data-ttu-id="faffd-230">Сценарии</span><span class="sxs-lookup"><span data-stu-id="faffd-230">Scenarios</span></span>
<span data-ttu-id="faffd-231">Далее описываются стандартные сценарии обмена сообщениями и приводятся рекомендации по настройкам служебной шины.</span><span class="sxs-lookup"><span data-stu-id="faffd-231">The following sections describe typical messaging scenarios and outline the preferred Service Bus settings.</span></span> <span data-ttu-id="faffd-232">Пропускная способность бывает небольшой (менее 1 сообщения в секунду), средней (1 сообщение в секунду или больше, но не более 100 сообщений в секунду) и высокой (100 сообщений в секунду или больше).</span><span class="sxs-lookup"><span data-stu-id="faffd-232">Throughput rates are classified as small (less than 1 message/second), moderate (1 message/second or greater but less than 100 messages/second) and high (100 messages/second or greater).</span></span> <span data-ttu-id="faffd-233">Количество клиентов бывает небольшим (5 и меньше), средним (более 5, но не более 20) и большим (более 20).</span><span class="sxs-lookup"><span data-stu-id="faffd-233">The number of clients are classified as small (5 or fewer), moderate (more than 5 but less than or equal to 20), and large (more than 20).</span></span>

### <a name="high-throughput-queue"></a><span data-ttu-id="faffd-234">Очередь с высокой пропускной способностью</span><span class="sxs-lookup"><span data-stu-id="faffd-234">High-throughput queue</span></span>
<span data-ttu-id="faffd-235">Цель: максимально повысить пропускную способность одной очереди.</span><span class="sxs-lookup"><span data-stu-id="faffd-235">Goal: Maximize the throughput of a single queue.</span></span> <span data-ttu-id="faffd-236">Количество отправителей и получателей: небольшое.</span><span class="sxs-lookup"><span data-stu-id="faffd-236">The number of senders and receivers is small.</span></span>

* <span data-ttu-id="faffd-237">Используйте секционированную очередь для повышения производительности и доступности.</span><span class="sxs-lookup"><span data-stu-id="faffd-237">Use a partitioned queue for improved performance and availability.</span></span>
* <span data-ttu-id="faffd-238">Чтобы увеличить общую скорость отправки сообщений в очередь, используйте несколько фабрик обмена сообщениями для создания отправителей.</span><span class="sxs-lookup"><span data-stu-id="faffd-238">To increase the overall send rate into the queue, use multiple message factories to create senders.</span></span> <span data-ttu-id="faffd-239">Для каждого отправителя используйте асинхронные операции или разделение на потоки.</span><span class="sxs-lookup"><span data-stu-id="faffd-239">For each sender, use asynchronous operations or multiple threads.</span></span>
* <span data-ttu-id="faffd-240">Чтобы увеличить общую скорость получения сообщений из очереди, используйте несколько фабрик обмена сообщениями для создания получателей.</span><span class="sxs-lookup"><span data-stu-id="faffd-240">To increase the overall receive rate from the queue, use multiple message factories to create receivers.</span></span>
* <span data-ttu-id="faffd-241">Используйте асинхронные операции, чтобы воспользоваться преимуществами пакетной обработки на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="faffd-241">Use asynchronous operations to take advantage of client-side batching.</span></span>
* <span data-ttu-id="faffd-242">Установите интервал пакетной обработки на 50 мс, чтобы уменьшить число передач по протоколу клиента служебной шины.</span><span class="sxs-lookup"><span data-stu-id="faffd-242">Set the batching interval to 50ms to reduce the number of Service Bus client protocol transmissions.</span></span> <span data-ttu-id="faffd-243">Если используется несколько отправителей, увеличьте интервал пакетной обработки до 100 мс.</span><span class="sxs-lookup"><span data-stu-id="faffd-243">If multiple senders are used, increase the batching interval to 100ms.</span></span>
* <span data-ttu-id="faffd-244">Не отключайте пакетный доступ к хранилищу.</span><span class="sxs-lookup"><span data-stu-id="faffd-244">Leave batched store access enabled.</span></span> <span data-ttu-id="faffd-245">Это повысит общую скорость записи сообщений в очередь.</span><span class="sxs-lookup"><span data-stu-id="faffd-245">This increases the overall rate at which messages can be written into the queue.</span></span>
* <span data-ttu-id="faffd-246">Для количества элементов предварительной выборки установите значение, в 20 раз превышающее максимальную скорость обработки всех получателей фабрики.</span><span class="sxs-lookup"><span data-stu-id="faffd-246">Set the prefetch count to 20 times the maximum processing rates of all receivers of a factory.</span></span> <span data-ttu-id="faffd-247">Это снизит число передач по протоколу клиента служебной шины.</span><span class="sxs-lookup"><span data-stu-id="faffd-247">This reduces the number of Service Bus client protocol transmissions.</span></span>

### <a name="multiple-high-throughput-queues"></a><span data-ttu-id="faffd-248">Несколько очередей с высокой пропускной способностью</span><span class="sxs-lookup"><span data-stu-id="faffd-248">Multiple high-throughput queues</span></span>
<span data-ttu-id="faffd-249">Цель: максимально повысить общую пропускную способность нескольких очередей.</span><span class="sxs-lookup"><span data-stu-id="faffd-249">Goal: Maximize overall throughput of multiple queues.</span></span> <span data-ttu-id="faffd-250">Пропускная способность одной очереди: средняя или высокая.</span><span class="sxs-lookup"><span data-stu-id="faffd-250">The throughput of an individual queue is moderate or high.</span></span>

<span data-ttu-id="faffd-251">Чтобы максимально повысить пропускную способность нескольких очередей, примените настройки, максимально повышающие пропускную способность одной очереди.</span><span class="sxs-lookup"><span data-stu-id="faffd-251">To obtain maximum throughput across multiple queues, use the settings outlined to maximize the throughput of a single queue.</span></span> <span data-ttu-id="faffd-252">Кроме того, используйте несколько фабрик для создания клиентов, которые отправляют или получают сообщения из разных очередей.</span><span class="sxs-lookup"><span data-stu-id="faffd-252">In addition, use different factories to create clients that send or receive from different queues.</span></span>

### <a name="low-latency-queue"></a><span data-ttu-id="faffd-253">Очередь с небольшой задержкой</span><span class="sxs-lookup"><span data-stu-id="faffd-253">Low latency queue</span></span>
<span data-ttu-id="faffd-254">Цель: минимизировать совокупное время задержки в очереди или разделе.</span><span class="sxs-lookup"><span data-stu-id="faffd-254">Goal: Minimize end-to-end latency of a queue or topic.</span></span> <span data-ttu-id="faffd-255">Количество отправителей и получателей: небольшое.</span><span class="sxs-lookup"><span data-stu-id="faffd-255">The number of senders and receivers is small.</span></span> <span data-ttu-id="faffd-256">Пропускная способность очереди: низкая или средняя.</span><span class="sxs-lookup"><span data-stu-id="faffd-256">The throughput of the queue is small or moderate.</span></span>

* <span data-ttu-id="faffd-257">Используйте секционированную очередь для повышения доступности.</span><span class="sxs-lookup"><span data-stu-id="faffd-257">Use a partitioned queue for improved availability.</span></span>
* <span data-ttu-id="faffd-258">Отключите пакетную обработку на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="faffd-258">Disable client-side batching.</span></span> <span data-ttu-id="faffd-259">Клиент будет немедленно отправлять сообщения.</span><span class="sxs-lookup"><span data-stu-id="faffd-259">The client immediately sends a message.</span></span>
* <span data-ttu-id="faffd-260">Отключите пакетный доступ к хранилищу.</span><span class="sxs-lookup"><span data-stu-id="faffd-260">Disable batched store access.</span></span> <span data-ttu-id="faffd-261">Служба будет немедленно записывать сообщения в хранилище.</span><span class="sxs-lookup"><span data-stu-id="faffd-261">The service immediately writes the message to the store.</span></span>
* <span data-ttu-id="faffd-262">При использовании одного клиента измените количество элементов предварительной выборки на значение, в 20 раз превышающее скорость обработки получателя.</span><span class="sxs-lookup"><span data-stu-id="faffd-262">If using a single client, set the prefetch count to 20 times the processing rate of the receiver.</span></span> <span data-ttu-id="faffd-263">Если в очередь одновременно поступает несколько сообщений, протокол клиента служебной шины передаст их все одновременно.</span><span class="sxs-lookup"><span data-stu-id="faffd-263">If multiple messages arrive at the queue at the same time, the Service Bus client protocol transmits them all at the same time.</span></span> <span data-ttu-id="faffd-264">Когда клиент получит следующее сообщение, оно уже будет в локальном кэше.</span><span class="sxs-lookup"><span data-stu-id="faffd-264">When the client receives the next message, that message is already in the local cache.</span></span> <span data-ttu-id="faffd-265">Размер кэша должен быть небольшим.</span><span class="sxs-lookup"><span data-stu-id="faffd-265">The cache should be small.</span></span>
* <span data-ttu-id="faffd-266">При использовании нескольких клиентов установите количество элементов предварительной выборки на 0.</span><span class="sxs-lookup"><span data-stu-id="faffd-266">If using multiple clients, set the prefetch count to 0.</span></span> <span data-ttu-id="faffd-267">В результате второй клиент сможет получить второе сообщение, пока первый клиент будет обрабатывать первое сообщение.</span><span class="sxs-lookup"><span data-stu-id="faffd-267">By doing this, the second client can receive the second message while the first client is still processing the first message.</span></span>

### <a name="queue-with-a-large-number-of-senders"></a><span data-ttu-id="faffd-268">Очередь с большим числом отправителей</span><span class="sxs-lookup"><span data-stu-id="faffd-268">Queue with a large number of senders</span></span>
<span data-ttu-id="faffd-269">Цель: максимально повысить пропускную способность очереди или раздела с большим количеством отправителей.</span><span class="sxs-lookup"><span data-stu-id="faffd-269">Goal: Maximize throughput of a queue or topic with a large number of senders.</span></span> <span data-ttu-id="faffd-270">Каждый отправитель отправляет сообщения со средней скоростью.</span><span class="sxs-lookup"><span data-stu-id="faffd-270">Each sender sends messages with a moderate rate.</span></span> <span data-ttu-id="faffd-271">Количество получателей: небольшое.</span><span class="sxs-lookup"><span data-stu-id="faffd-271">The number of receivers is small.</span></span>

<span data-ttu-id="faffd-272">В служебной шине можно открыть до 1000 параллельных подключений к сущности обмена сообщениями (или до 5000 при использовании протокола AMQP).</span><span class="sxs-lookup"><span data-stu-id="faffd-272">Service Bus enables up to 1000 concurrent connections to a messaging entity (or 5000 using AMQP).</span></span> <span data-ttu-id="faffd-273">Это ограничение установлено на уровне пространства имен. Очереди, разделы и подписки ограничены максимальным числом параллельных подключений для соответствующего пространства имен.</span><span class="sxs-lookup"><span data-stu-id="faffd-273">This limit is enforced at the namespace level, and queues/topics/subscriptions are capped by the limit of concurrent connections per namespace.</span></span> <span data-ttu-id="faffd-274">В случае очередей это значение распределяется между отправителями и получателями.</span><span class="sxs-lookup"><span data-stu-id="faffd-274">For queues, this number is shared between senders and receivers.</span></span> <span data-ttu-id="faffd-275">Если отправителям требуются все 1000 подключений, замените очередь одним разделом и одной подпиской.</span><span class="sxs-lookup"><span data-stu-id="faffd-275">If all 1000 connections are required for senders, you should replace the queue with a topic and a single subscription.</span></span> <span data-ttu-id="faffd-276">Раздел допускает до 1000 параллельных подключений от отправителей, тогда как подписка допускает 1000 дополнительных параллельных подключений от получателей.</span><span class="sxs-lookup"><span data-stu-id="faffd-276">A topic accepts up to 1000 concurrent connections from senders, whereas the subscription accepts an additional 1000 concurrent connections from receivers.</span></span> <span data-ttu-id="faffd-277">Если количество параллельных отправителей превышает 1000, то они должны отправлять сообщения на протокол служебной шины по протоколу HTTP.</span><span class="sxs-lookup"><span data-stu-id="faffd-277">If more than 1000 concurrent senders are required, the senders should send messages to the Service Bus protocol via HTTP.</span></span>

<span data-ttu-id="faffd-278">Чтобы максимально повысить пропускную способность, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="faffd-278">To maximize throughput, do the following:</span></span>

* <span data-ttu-id="faffd-279">Используйте секционированную очередь для повышения производительности и доступности.</span><span class="sxs-lookup"><span data-stu-id="faffd-279">Use a partitioned queue for improved performance and availability.</span></span>
* <span data-ttu-id="faffd-280">Если каждый отправитель размещается в отдельном процессе, используйте одну фабрику для этого процесса.</span><span class="sxs-lookup"><span data-stu-id="faffd-280">If each sender resides in a different process, use only a single factory per process.</span></span>
* <span data-ttu-id="faffd-281">Используйте асинхронные операции, чтобы воспользоваться преимуществами пакетной обработки на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="faffd-281">Use asynchronous operations to take advantage of client-side batching.</span></span>
* <span data-ttu-id="faffd-282">Установите интервал пакетной обработки на 20 мс, чтобы уменьшить число передач по протоколу клиента служебной шины.</span><span class="sxs-lookup"><span data-stu-id="faffd-282">Use the default batching interval of 20ms to reduce the number of Service Bus client protocol transmissions.</span></span>
* <span data-ttu-id="faffd-283">Не отключайте пакетный доступ к хранилищу.</span><span class="sxs-lookup"><span data-stu-id="faffd-283">Leave batched store access enabled.</span></span> <span data-ttu-id="faffd-284">Это повысит общую скорость записи сообщений в очередь или раздел.</span><span class="sxs-lookup"><span data-stu-id="faffd-284">This increases the overall rate at which messages can be written into the queue or topic.</span></span>
* <span data-ttu-id="faffd-285">Для количества элементов предварительной выборки установите значение, в 20 раз превышающее максимальную скорость обработки всех получателей фабрики.</span><span class="sxs-lookup"><span data-stu-id="faffd-285">Set the prefetch count to 20 times the maximum processing rates of all receivers of a factory.</span></span> <span data-ttu-id="faffd-286">Это снизит число передач по протоколу клиента служебной шины.</span><span class="sxs-lookup"><span data-stu-id="faffd-286">This reduces the number of Service Bus client protocol transmissions.</span></span>

### <a name="queue-with-a-large-number-of-receivers"></a><span data-ttu-id="faffd-287">Очередь с большим числом получателей</span><span class="sxs-lookup"><span data-stu-id="faffd-287">Queue with a large number of receivers</span></span>
<span data-ttu-id="faffd-288">Цель: максимально повысить скорость получения в очереди или подписке с большим количеством получателей.</span><span class="sxs-lookup"><span data-stu-id="faffd-288">Goal: Maximize the receive rate of a queue or subscription with a large number of receivers.</span></span> <span data-ttu-id="faffd-289">Каждый получатель получает сообщения со средней скоростью.</span><span class="sxs-lookup"><span data-stu-id="faffd-289">Each receiver receives messages at a moderate rate.</span></span> <span data-ttu-id="faffd-290">Количество отправителей: небольшое.</span><span class="sxs-lookup"><span data-stu-id="faffd-290">The number of senders is small.</span></span>

<span data-ttu-id="faffd-291">В служебной шине можно открыть до 1000 параллельных подключений к сущности.</span><span class="sxs-lookup"><span data-stu-id="faffd-291">Service Bus enables up to 1000 concurrent connections to an entity.</span></span> <span data-ttu-id="faffd-292">Если для очереди требуется более 1000 получателей, замените очередь одним разделом и несколькими подписками.</span><span class="sxs-lookup"><span data-stu-id="faffd-292">If a queue requires more than 1000 receivers, you should replace the queue with a topic and multiple subscriptions.</span></span> <span data-ttu-id="faffd-293">Каждая подписка поддерживает до 1000 параллельных подключений.</span><span class="sxs-lookup"><span data-stu-id="faffd-293">Each subscription can support up to 1000 concurrent connections.</span></span> <span data-ttu-id="faffd-294">Кроме того, получатели могут обращаться к очереди через протокол HTTP.</span><span class="sxs-lookup"><span data-stu-id="faffd-294">Alternatively, receivers can access the queue via the HTTP protocol.</span></span>

<span data-ttu-id="faffd-295">Чтобы максимально повысить пропускную способность, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="faffd-295">To maximize throughput, do the following:</span></span>

* <span data-ttu-id="faffd-296">Используйте секционированную очередь для повышения производительности и доступности.</span><span class="sxs-lookup"><span data-stu-id="faffd-296">Use a partitioned queue for improved performance and availability.</span></span>
* <span data-ttu-id="faffd-297">Если каждый получатель размещается в отдельном процессе, используйте одну фабрику для этого процесса.</span><span class="sxs-lookup"><span data-stu-id="faffd-297">If each receiver resides in a different process, use only a single factory per process.</span></span>
* <span data-ttu-id="faffd-298">Получатели могут использовать синхронные и асинхронные операции.</span><span class="sxs-lookup"><span data-stu-id="faffd-298">Receivers can use synchronous or asynchronous operations.</span></span> <span data-ttu-id="faffd-299">Учитывая среднюю скорость получения отдельного получателя, пакетная обработка на стороне клиента в отношении запросов на завершение не повлияет на пропускную способность получателя.</span><span class="sxs-lookup"><span data-stu-id="faffd-299">Given the moderate receive rate of an individual receiver, client-side batching of a Complete request does not affect receiver throughput.</span></span>
* <span data-ttu-id="faffd-300">Не отключайте пакетный доступ к хранилищу.</span><span class="sxs-lookup"><span data-stu-id="faffd-300">Leave batched store access enabled.</span></span> <span data-ttu-id="faffd-301">Это снизит общую нагрузку на сущность.</span><span class="sxs-lookup"><span data-stu-id="faffd-301">This reduces the overall load of the entity.</span></span> <span data-ttu-id="faffd-302">Кроме того, это понизит общую скорость записи сообщений в очередь или раздел.</span><span class="sxs-lookup"><span data-stu-id="faffd-302">It also reduces the overall rate at which messages can be written into the queue or topic.</span></span>
* <span data-ttu-id="faffd-303">Для количества элементов предварительной выборки установите небольшое значение (например, PrefetchCount = 10).</span><span class="sxs-lookup"><span data-stu-id="faffd-303">Set the prefetch count to a small value (for example, PrefetchCount = 10).</span></span> <span data-ttu-id="faffd-304">Это позволит избежать ситуации, когда одни получатели простаивают, а другие получают множество кэшированных сообщений.</span><span class="sxs-lookup"><span data-stu-id="faffd-304">This prevents receivers from being idle while other receivers have large numbers of messages cached.</span></span>

### <a name="topic-with-a-small-number-of-subscriptions"></a><span data-ttu-id="faffd-305">Раздел с небольшим количеством подписок</span><span class="sxs-lookup"><span data-stu-id="faffd-305">Topic with a small number of subscriptions</span></span>
<span data-ttu-id="faffd-306">Цель: максимально повысить пропускную способность раздела с небольшим количеством подписок.</span><span class="sxs-lookup"><span data-stu-id="faffd-306">Goal: Maximize the throughput of a topic with a small number of subscriptions.</span></span> <span data-ttu-id="faffd-307">Сообщение получается несколькими подписками. Это означает, что общая скорость получения во всех подписках будет больше, чем скорость отправки.</span><span class="sxs-lookup"><span data-stu-id="faffd-307">A message is received by many subscriptions, which means the combined receive rate over all subscriptions is larger than the send rate.</span></span> <span data-ttu-id="faffd-308">Количество отправителей: небольшое.</span><span class="sxs-lookup"><span data-stu-id="faffd-308">The number of senders is small.</span></span> <span data-ttu-id="faffd-309">Получателей в каждой подписке так же немного.</span><span class="sxs-lookup"><span data-stu-id="faffd-309">The number of receivers per subscription is small.</span></span>

<span data-ttu-id="faffd-310">Чтобы максимально повысить пропускную способность, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="faffd-310">To maximize throughput, do the following:</span></span>

* <span data-ttu-id="faffd-311">Используйте секционированный раздел для повышения уровня доступности и производительности.</span><span class="sxs-lookup"><span data-stu-id="faffd-311">Use a partitioned topic for improved performance and availability.</span></span>
* <span data-ttu-id="faffd-312">Чтобы увеличить общую скорость отправки сообщений в раздел, используйте несколько фабрик обмена сообщениями для создания отправителей.</span><span class="sxs-lookup"><span data-stu-id="faffd-312">To increase the overall send rate into the topic, use multiple message factories to create senders.</span></span> <span data-ttu-id="faffd-313">Для каждого отправителя используйте асинхронные операции или разделение на потоки.</span><span class="sxs-lookup"><span data-stu-id="faffd-313">For each sender, use asynchronous operations or multiple threads.</span></span>
* <span data-ttu-id="faffd-314">Чтобы увеличить общую скорость получения сообщений из подписки, используйте несколько фабрик обмена сообщениями для создания получателей.</span><span class="sxs-lookup"><span data-stu-id="faffd-314">To increase the overall receive rate from a subscription, use multiple message factories to create receivers.</span></span> <span data-ttu-id="faffd-315">Для каждого получателя используйте асинхронные операции или разделение на потоки.</span><span class="sxs-lookup"><span data-stu-id="faffd-315">For each receiver, use asynchronous operations or multiple threads.</span></span>
* <span data-ttu-id="faffd-316">Используйте асинхронные операции, чтобы воспользоваться преимуществами пакетной обработки на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="faffd-316">Use asynchronous operations to take advantage of client-side batching.</span></span>
* <span data-ttu-id="faffd-317">Установите интервал пакетной обработки на 20 мс, чтобы уменьшить число передач по протоколу клиента служебной шины.</span><span class="sxs-lookup"><span data-stu-id="faffd-317">Use the default batching interval of 20ms to reduce the number of Service Bus client protocol transmissions.</span></span>
* <span data-ttu-id="faffd-318">Не отключайте пакетный доступ к хранилищу.</span><span class="sxs-lookup"><span data-stu-id="faffd-318">Leave batched store access enabled.</span></span> <span data-ttu-id="faffd-319">Это повысит общую скорость записи сообщений в раздел.</span><span class="sxs-lookup"><span data-stu-id="faffd-319">This increases the overall rate at which messages can be written into the topic.</span></span>
* <span data-ttu-id="faffd-320">Для количества элементов предварительной выборки установите значение, в 20 раз превышающее максимальную скорость обработки всех получателей фабрики.</span><span class="sxs-lookup"><span data-stu-id="faffd-320">Set the prefetch count to 20 times the maximum processing rates of all receivers of a factory.</span></span> <span data-ttu-id="faffd-321">Это снизит число передач по протоколу клиента служебной шины.</span><span class="sxs-lookup"><span data-stu-id="faffd-321">This reduces the number of Service Bus client protocol transmissions.</span></span>

### <a name="topic-with-a-large-number-of-subscriptions"></a><span data-ttu-id="faffd-322">Раздел с большим количеством подписок</span><span class="sxs-lookup"><span data-stu-id="faffd-322">Topic with a large number of subscriptions</span></span>
<span data-ttu-id="faffd-323">Цель: максимально повысить пропускную способность раздела с большим количеством подписок.</span><span class="sxs-lookup"><span data-stu-id="faffd-323">Goal: Maximize the throughput of a topic with a large number of subscriptions.</span></span> <span data-ttu-id="faffd-324">Сообщение направляется нескольким подпискам. Это означает, что общая скорость получения во всех подписках будет значительно больше, чем скорость отправки.</span><span class="sxs-lookup"><span data-stu-id="faffd-324">A message is received by many subscriptions, which means the combined receive rate over all subscriptions is much larger than the send rate.</span></span> <span data-ttu-id="faffd-325">Количество отправителей: небольшое.</span><span class="sxs-lookup"><span data-stu-id="faffd-325">The number of senders is small.</span></span> <span data-ttu-id="faffd-326">Получателей в каждой подписке так же немного.</span><span class="sxs-lookup"><span data-stu-id="faffd-326">The number of receivers per subscription is small.</span></span>

<span data-ttu-id="faffd-327">Разделы с большим количеством подписок обычно обеспечивают низкую общую пропускную способность, если все сообщения направляются во все подписки.</span><span class="sxs-lookup"><span data-stu-id="faffd-327">Topics with a large number of subscriptions typically expose a low overall throughput if all messages are routed to all subscriptions.</span></span> <span data-ttu-id="faffd-328">Это связано с тем, что получение каждого сообщения выполняется много раз, а все содержащиеся в разделе сообщения и все подписки раздела хранятся в одном хранилище.</span><span class="sxs-lookup"><span data-stu-id="faffd-328">This is caused by the fact that each message is received many times, and all messages that are contained in a topic and all its subscriptions are stored in the same store.</span></span> <span data-ttu-id="faffd-329">Предполагается, что количество отправителей и получателей в каждой подписке небольшое.</span><span class="sxs-lookup"><span data-stu-id="faffd-329">It is assumed that the number of senders and number of receivers per subscription is small.</span></span> <span data-ttu-id="faffd-330">Служебная шина поддерживает до 2000 подписок на раздел.</span><span class="sxs-lookup"><span data-stu-id="faffd-330">Service Bus supports up to 2,000 subscriptions per topic.</span></span>

<span data-ttu-id="faffd-331">Чтобы максимально повысить пропускную способность, выполните следующие действия.</span><span class="sxs-lookup"><span data-stu-id="faffd-331">To maximize throughput, do the following:</span></span>

* <span data-ttu-id="faffd-332">Используйте секционированный раздел для повышения уровня доступности и производительности.</span><span class="sxs-lookup"><span data-stu-id="faffd-332">Use a partitioned topic for improved performance and availability.</span></span>
* <span data-ttu-id="faffd-333">Используйте асинхронные операции, чтобы воспользоваться преимуществами пакетной обработки на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="faffd-333">Use asynchronous operations to take advantage of client-side batching.</span></span>
* <span data-ttu-id="faffd-334">Установите интервал пакетной обработки на 20 мс, чтобы уменьшить число передач по протоколу клиента служебной шины.</span><span class="sxs-lookup"><span data-stu-id="faffd-334">Use the default batching interval of 20ms to reduce the number of Service Bus client protocol transmissions.</span></span>
* <span data-ttu-id="faffd-335">Не отключайте пакетный доступ к хранилищу.</span><span class="sxs-lookup"><span data-stu-id="faffd-335">Leave batched store access enabled.</span></span> <span data-ttu-id="faffd-336">Это повысит общую скорость записи сообщений в раздел.</span><span class="sxs-lookup"><span data-stu-id="faffd-336">This increases the overall rate at which messages can be written into the topic.</span></span>
* <span data-ttu-id="faffd-337">Для количества элементов предварительной выборки установите значение, в 20 раз превышающее ожидаемую скорость получения в секундах.</span><span class="sxs-lookup"><span data-stu-id="faffd-337">Set the prefetch count to 20 times the expected receive rate in seconds.</span></span> <span data-ttu-id="faffd-338">Это снизит число передач по протоколу клиента служебной шины.</span><span class="sxs-lookup"><span data-stu-id="faffd-338">This reduces the number of Service Bus client protocol transmissions.</span></span>

## <a name="next-steps"></a><span data-ttu-id="faffd-339">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="faffd-339">Next steps</span></span>
<span data-ttu-id="faffd-340">Дополнительные сведения об оптимизации производительности служебной шины см. в статье [Секционированные сущности обмена сообщениями][Partitioned messaging entities].</span><span class="sxs-lookup"><span data-stu-id="faffd-340">To learn more about optimizing Service Bus performance, see [Partitioned messaging entities][Partitioned messaging entities].</span></span>

[QueueClient]: /dotnet/api/microsoft.servicebus.messaging.queueclient
[MessageSender]: /dotnet/api/microsoft.servicebus.messaging.messagesender
[MessagingFactory]: /dotnet/api/microsoft.servicebus.messaging.messagingfactory
[PeekLock]: /dotnet/api/microsoft.servicebus.messaging.receivemode
[ReceiveAndDelete]: /dotnet/api/microsoft.servicebus.messaging.receivemode
[BatchFlushInterval]: /dotnet/api/microsoft.servicebus.messaging.netmessagingtransportsettings.batchflushinterval#Microsoft_ServiceBus_Messaging_NetMessagingTransportSettings_BatchFlushInterval
[EnableBatchedOperations]: /dotnet/api/microsoft.servicebus.messaging.queuedescription.enablebatchedoperations#Microsoft_ServiceBus_Messaging_QueueDescription_EnableBatchedOperations
[QueueClient.PrefetchCount]: /dotnet/api/microsoft.servicebus.messaging.queueclient.prefetchcount#Microsoft_ServiceBus_Messaging_QueueClient_PrefetchCount
[SubscriptionClient.PrefetchCount]: /dotnet/api/microsoft.servicebus.messaging.subscriptionclient.prefetchcount#Microsoft_ServiceBus_Messaging_SubscriptionClient_PrefetchCount
[ForcePersistence]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage.forcepersistence#Microsoft_ServiceBus_Messaging_BrokeredMessage_ForcePersistence
[EnablePartitioning]: /dotnet/api/microsoft.servicebus.messaging.queuedescription.enablepartitioning#Microsoft_ServiceBus_Messaging_QueueDescription_EnablePartitioning
[Partitioned messaging entities]: service-bus-partitioning.md
<span data-ttu-id="faffd-341">[TopicDescription.EnableFilteringMessagesBeforePublishing]: /dotnet/api/microsoft.servicebus.messaging.topicdescription.enablefilteringmessagesbeforepublishing#Microsoft_ServiceBus_Messaging_TopicDescription_EnableFilteringMessagesBeforePublishing</span><span class="sxs-lookup"><span data-stu-id="faffd-341">[TopicDescription.EnableFilteringMessagesBeforePublishing]: /dotnet/api/microsoft.servicebus.messaging.topicdescription.enablefilteringmessagesbeforepublishing#Microsoft_ServiceBus_Messaging_TopicDescription_EnableFilteringMessagesBeforePublishing</span></span>

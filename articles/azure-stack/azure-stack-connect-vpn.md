---
title: "Подключиться к Azure с помощью VPN стек Azure"
description: "Способ подключения виртуальных сетей в Azure стека виртуальных сетей в Azure с помощью VPN."
services: azure-stack
documentationcenter: 
author: ScottNapolitan
manager: 
editor: 
ms.assetid: 
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 9/25/2017
ms.author: victorh
ms.openlocfilehash: c06eb0bb44bdfeab956e9b5051786b5bc631acf5
ms.sourcegitcommit: 90e2cced6a773b1b52f999ba73cd8877305d270b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/13/2017
---
# <a name="connect-azure-stack-to-azure-using-vpn"></a>Подключиться к Azure с помощью VPN стек Azure

*Применяется к: стек Azure интегрированных систем*

В этой статье показано, как создать сеть сеть VPN для подключения к виртуальной сети в Azure виртуальную сеть в Azure стека.

### <a name="connection-diagram"></a>Схема подключения
На следующей диаграмме показаны конфигурации соединения должны выглядеть после завершения:

![Сайт сайт конфигурации VPN-подключения](media/azure-stack-connect-vpn/image2.png)

### <a name="before-you-begin"></a>Перед началом работы
Чтобы завершить настройку подключения, убедитесь, что у вас есть следующие элементы перед началом:

* Стек Azure интегрирован развертывания систем (с несколькими узлами), напрямую подключенном к Интернету. Это означает, что внешний общедоступный IP-адрес диапазона должен быть напрямую доступный из Интернета.
* Действительная подписка Azure.  Если у вас нет подписки Azure, можно создать [освободить учетная запись Azure здесь](https://azure.microsoft.com/free/?b=17.06).

## <a name="network-example-values-table"></a>Таблица значений пример сети
Пример значения сети таблицы показывает образцы значений, которые используются в этой статье. Эти значения можно использовать или можно ссылаться на них, чтобы лучше понять примеры в этой статье.

**Таблица значений пример сети**
|   |Azure Stack|Таблицы Azure|
|---------|---------|---------|
|Имя виртуальной сети     |Виртуальная сеть Azs|AzureVNet |
|Адресное пространство виртуальной сети |10.1.0.0/16|10.100.0.0/16|
|Имя подсети     |FrontEnd|FrontEnd|
|Диапазон адресов подсети|10.1.0.0/24 |10.100.0.0/24 |
|Подсеть шлюза     |10.1.1.0/24|10.100.1.0/24|

## <a name="create-the-network-resources-in-azure"></a>Создание сетевого ресурса в Azure

Сначала создается сетевым ресурсам Azure. Ниже показано, как создать ресурсы с помощью [портал Azure](http://portal.azure.com/).

### <a name="create-the-virtual-network-and-vm-subnet"></a>Создание виртуальной сети и подсети виртуальной машины

1. Войдите в [портал Azure](http://portal.azure.com/) с помощью учетной записи Azure.
2. На портале пользователей выберите **New**.
3. Последовательно выберите пункты **Marketplace**, а затем выберите **сети**.
4. Выберите **виртуальная сеть**.
5. Используйте сведения из таблицы конфигурации сети для определения значения для Azure **имя**, **адресное пространство**, **имя подсети**, и **адрес подсети диапазон**.
6. Для **группы ресурсов**, создать новую группу ресурсов или, если это уже сделано, установите **использовать существующие**.
7. Выберите **расположение** из виртуальной сети.  Если вы используете примеры значений, выберите **Восток США** или при желании указать другое расположение.
8. Кроме того, установите флажок **Закрепить на панели мониторинга**.
9. Нажмите кнопку **Создать**.

### <a name="create-the-gateway-subnet"></a>Создание подсети шлюза
1. Открытие ресурса виртуальной сети, вы создали (**AzureVNet**) из панели мониторинга.
2. На **параметры** выберите **подсети**.
3. Выберите **подсеть шлюза** Чтобы добавить подсеть шлюза виртуальной сети.
4. Подсети присвоено имя **GatewaySubnet** по умолчанию.
   Подсети шлюза являются специальными, и для правильной работы им должно быть присвоено конкретное имя.
5. В **диапазона адресов** поле, убедитесь, что адрес **10.100.0.0/24**.
6. Выберите **ОК** Создание подсеть шлюза.

### <a name="create-the-virtual-network-gateway"></a>Создание шлюза виртуальной сети
1. На портале Azure выберите **New**.  
2. Последовательно выберите пункты **Marketplace**, а затем выберите **сети**.
3. В списке сетевых ресурсов, выберите **шлюз виртуальной сети**.
4. В **имя**, тип **Azure GW**.
5. Чтобы выбрать виртуальную сеть, выберите **виртуальная сеть**. Выберите **AzureVnet** из списка.
6. Выберите **общедоступный IP-адрес**. Когда **выберите общедоступный IP-адрес** откроется раздел, выберите **создать новый**.
7. В **имя**, тип **Azure GW-PiP**, а затем выберите **ОК**.
8. По умолчанию для **тип VPN**, **на основе маршрутов** выбран.
    Сохранить **на основе маршрутов** тип VPN.
9. Убедитесь, что для параметров **Подписка** и **Расположение** выбраны правильные значения. Вы можете закрепить ресурсов на панель мониторинга. Нажмите кнопку **Создать**.

### <a name="create-the-local-network-gateway-resource"></a>Создать ресурс шлюза локальной сети

1. На портале Azure выберите **New**. 
4. Последовательно выберите пункты **Marketplace**, а затем выберите **сети**.
5. В списке ресурсов выберите **шлюз локальной сети**.
6. В **имя**, тип **Azs-GW**.
7. В **IP-адрес**, введите общедоступный IP-адрес для вашего стека шлюзом виртуальной сети Azure, перечисленные выше в таблице конфигурации сети.
8. В **адресное пространство**, из стека Azure введите **10.0.10.0/23** адресное пространство для **AzureVNet**.
9. Убедитесь, что ваш **подписки**, **группы ресурсов**, и **расположение** верны, а затем выберите **создать**.

## <a name="create-the-connection"></a>Создание подключения
1. На портале пользователей выберите **New**. 
2. Последовательно выберите пункты **Marketplace**, а затем выберите **сети**.
3. В списке ресурсов выберите **соединения**.
4. На **основные** раздел параметров для **тип подключения**, выберите **-сайтами (IPSec)**.
5. Выберите **подписки**, **группы ресурсов**, и **расположение**, а затем выберите **ОК**.
6. На **параметры** выберите **шлюз виртуальной сети**, а затем выберите **Azure-GW**.
7. Выберите **шлюз локальной сети**, а затем выберите **Azs-GW**.
8. В **имя подключения**, тип **Azure Azs**.
9. В **общий ключ (PSK)**, тип **12345**. Если выбрать другое значение, помните, что он *должен* соответствует значению для общий ключ, созданный на другом конце соединения. Нажмите кнопку **ОК**.
10. Просмотрите **Сводка** статьи, а затем выберите **ОК**.

## <a name="create-a-virtual-machine"></a>Создание виртуальной машины
Создание виртуальной машины в Azure теперь и поместить его в вашей подсети виртуальной Машины в виртуальной сети.

1. На портале Azure выберите **New**.
2. Последовательно выберите пункты **Marketplace**, а затем выберите **вычислений**.
3. В списке образов виртуальных машин, выберите **Eval центра обработки данных Windows Server 2016** изображения.
4. На **основы** раздела, для **имя**, тип **AzureVM**.
5. Введите допустимое имя пользователя и пароль. Используйте эту учетную запись для входа в виртуальную машину после ее создания.
6. Предоставляют **подписки**, **группы ресурсов**, и **расположение**, а затем выберите **ОК**.
7. На **размер** выберите размер виртуальной машины для данного экземпляра, затем выберите **выберите**.
8. На **параметры** раздела, можно принять значения по умолчанию. Убедитесь, что **AzureVnet** выбран виртуальной сети и убедитесь, что подсеть **10.0.20.0/24**. Нажмите кнопку **ОК**.
9. Проверьте параметры на **Сводка** статьи, а затем выберите **ОК**.

## <a name="create-the-network-resources-in-azure-stack"></a>Создание сетевого ресурса в стек Azure
Далее нужно создать в Azure стека сетевых ресурсов.

### <a name="sign-in-as-a-user"></a>Войдите как пользователь
Администратор службы сможете войти как пользователь для тестирования планов, предложения и подписки, которые пользователи могут использовать. Если вы уже нет, [создать учетную запись пользователя](azure-stack-add-new-user-aad.md) перед входом.

### <a name="create-the-virtual-network-and-vm-subnet"></a>Создание виртуальной сети и подсети виртуальной машины
1. Используйте учетную запись пользователя для входа на пользовательский портал.
2. На портале пользователей выберите **New**.

    ![Создайте новую виртуальную сеть](media/azure-stack-create-vpn-connection-one-node-tp2/image3.png)

3. Последовательно выберите пункты **Marketplace**, а затем выберите **сети**.
4. Выберите **виртуальная сеть**.
5. Для **имя**, **адресное пространство**, **имя подсети**, и **диапазон адресов подсети**, используйте значения из таблицы конфигурации сети.
6. В **подписки**, отображается подписки, которое было создано ранее.
7. Для **группы ресурсов**, можно создать группу ресурсов или если это уже сделано, установите **использовать существующие**.
8. Проверьте значение расположения по умолчанию.
9. Кроме того, установите флажок **Закрепить на панели мониторинга**.
10. Нажмите кнопку **Создать**.

### <a name="create-the-gateway-subnet"></a>Создание подсети шлюза
1. На панели мониторинга откройте созданный ресурс виртуальной сети Azs виртуальной сети.
2. На **параметры** выберите **подсети**.
3. Чтобы добавить подсеть шлюза виртуальной сети, выберите **подсеть шлюза**.
   
    ![Добавить подсеть шлюза](media/azure-stack-create-vpn-connection-one-node-tp2/image4.png)

4. По умолчанию присвоено имя подсети **GatewaySubnet**.
   Шлюз подсети имеют специальное назначение. Для правильной работы функций, они должны использовать *GatewaySubnet* имя.
5. В **диапазона адресов**, убедитесь, что адрес **10.1.1.0/24**.
6. Выберите **ОК** Создание подсеть шлюза.

### <a name="create-the-virtual-network-gateway"></a>Создание шлюза виртуальной сети
1. На портале Azure стека выбрать **New**. 
2. Последовательно выберите пункты **Marketplace**, а затем выберите **сети**.
3. В списке сетевых ресурсов, выберите **шлюз виртуальной сети**.
4. В **имя**, тип **Azs-GW**.
5. Выберите **виртуальная сеть** элемент, чтобы выбрать виртуальную сеть.
   Выберите **Azs VNet** из списка.
6. Выберите **общедоступный IP-адрес** элемента меню. Когда **выберите общедоступный IP-адрес** откроется раздел, выберите **создать новый**.
7. В **имя**, тип **Azs GW-PiP**, а затем выберите **ОК**.
8.  По умолчанию для **тип VPN**, **на основе маршрутов** выбран.
    Сохранить **на основе маршрутов** тип VPN.
9. Убедитесь, что для параметров **Подписка** и **Расположение** выбраны правильные значения. Вы можете закрепить ресурсов на панель мониторинга. Нажмите кнопку **Создать**.

### <a name="create-the-local-network-gateway"></a>Создание шлюза локальной сети
Понятие *шлюз локальной сети* стека Azure момент немного отличается от развертывания Azure.

При развертывании Azure шлюза локальной сети представляет локально (в расположении пользователя) физического устройства, используемого для подключения к шлюзу виртуальной сети в Azure. В стек Azure обоих концах соединения являются шлюзами виртуальной сети!

Представьте себе ситуацию, общем можно выполнить, ресурс шлюза локальной сети всегда указывает удаленный шлюз на другом конце соединения. 

### <a name="create-the-local-network-gateway-resource"></a>Создать ресурс шлюза локальной сети
1. Войдите на портал Azure стека.
2. На портале пользователей выберите **New**.
3. Последовательно выберите пункты **Marketplace**, а затем выберите **сети**.
4. В списке ресурсов выберите **шлюз локальной сети**.
5. В **имя**, тип **Azure GW**.
6. В **IP-адрес**, введите общедоступный IP-адрес для шлюза виртуальной сети в Azure **Azure GW-PiP**. Этот адрес появляется в таблице конфигурации сети.
7. В **адресное пространство**, адресное пространство виртуальной сети Azure, который вы создали, введите **10.0.20.0/23**.
8. Убедитесь, что ваш **подписки**, **группы ресурсов**, и **расположение** верны, а затем выберите **создать**.

### <a name="create-the-connection"></a>Создание подключения
1. На портале пользователей выберите **New**.
2. Последовательно выберите пункты **Marketplace**, а затем выберите **сети**.
3. В списке ресурсов выберите **соединения**.
4. На **основы** раздел параметров для **тип подключения**выберите **-сайтами (IPSec)**.
5. Выберите **подписки**, **группы ресурсов**, и **расположение**, а затем выберите **ОК**.
6. На **параметры** выберите **шлюз виртуальной сети**, а затем выберите **Azs-GW**.
7. Выберите **шлюз локальной сети**, а затем выберите **Azure GW**.
8. В **имя подключения**, тип **Azs Azure**.
9. В **общий ключ (PSK)**, тип **12345**, а затем выберите **ОК**.
10. На **Сводка** выберите **ОК**.

### <a name="create-a-vm"></a>Создание виртуальной машины
Для проверки данных, проходящий через VPN-подключение, необходимо создать виртуальные машины на каждом конце для отправки и получения данных через туннель VPN. 

1. На портале Azure выберите **New**.
2. Последовательно выберите пункты **Marketplace**, а затем выберите **вычислений**.
3. В списке образов виртуальных машин, выберите **Eval центра обработки данных Windows Server 2016** изображения.
4. На **основы** раздела **имя**, тип **Azs ВМ**.
5. Введите допустимое имя пользователя и пароль. Используйте эту учетную запись для входа в виртуальную Машину после ее создания.
6. Предоставляют **подписки**, **группы ресурсов**, и **расположение**, а затем выберите **ОК**.
7. На **размер** статьи для данного экземпляра, выберите размер виртуальной машины, а затем выберите **выберите**.
8. На **параметры** статьи, примите параметры по умолчанию. Убедитесь, что **Azs VNet** выбранной виртуальной сети. Убедитесь, что подсеть **10.1.0.0/24**. Нажмите кнопку **ОК**.
9. На **Сводка** Проверьте параметры, затем выберите **ОК**.


## <a name="test-the-connection"></a>Проверка подключения
Теперь, когда устанавливается соединение сайт сайт, следует проверить, что может получить трафик через него. Чтобы проверить, войдите в одной из виртуальных машин, которые созданы в стек Azure. Затем проверьте связь виртуальной машины, созданной в Azure. 

Чтобы отправить трафик через подключение сайт сайт, обратитесь по адресу прямой IP-адрес (DIP) виртуальной машины на удаленной подсети не виртуальных IP-адресов. Для этого найдите DIP-адрес на другой стороне соединения. Сохраните адрес для дальнейшего использования.

### <a name="sign-in-to-the-user-vm-in-azure-stack"></a>Вход для пользователя виртуальной Машины в стек Azure
1. Войдите на портал Azure стека.
2. На панели навигации слева выберите **виртуальные машины**.
3. В списке виртуальных машин, найдите **Azs ВМ** , созданного ранее и выберите его.
4. В разделе для виртуальной машины, нажмите кнопку **Connect**, а затем откройте файл Azs VM.rdp.
   
     ![Кнопка "Подключить"](media/azure-stack-create-vpn-connection-one-node-tp2/image17.png)
5. Войдите с помощью учетной записи, настроенной при создании виртуальной машины.
6. Откройте повышенными **Windows PowerShell** окна.
7. Введите **ipconfig /all**.
8. Найдите в выходных данных, **IPv4-адрес**, а затем сохраните адрес для дальнейшего использования. Это адрес, который будет проверять связь из Azure. В примере среды этот адрес — **10.0.10.4**, но в вашей среде он может быть другим. Он должен находиться в **10.0.10.0/24** подсети, созданной ранее.
9. Чтобы создать правило брандмауэра, которое позволяет реагировать на запросы проверки связи виртуальную машину, выполните следующую команду PowerShell:

   ```powershell
   New-NetFirewallRule `
    –DisplayName “Allow ICMPv4-In” `
    –Protocol ICMPv4
   ```

### <a name="sign-in-to-the-tenant-vm-in-azure"></a>Войдите в клиент виртуальную Машину в Azure
1. Войдите на портал Azure.
2. На панели навигации слева щелкните **виртуальные машины**.
3. В списке виртуальных машин, найти **виртуальной Машины Azure** , созданного ранее и выберите его.
4. В разделе для виртуальной машины, нажмите кнопку **Connect**.
5. Войдите с помощью учетной записи, настроенной при создании виртуальной машины.
6. Откройте повышенными **Windows PowerShell** окна.
7. Введите **ipconfig /all**.
8. Вы увидите IPv4-адрес, который попадает в **10.0.20.0/24**. В среде примере является адрес **10.0.20.4**, но ваш адрес может различаться.
9. Чтобы создать правило брандмауэра, которое позволяет реагировать на запросы проверки связи виртуальную машину, выполните следующую команду PowerShell:

   ```powershell
   New-NetFirewallRule `
    –DisplayName “Allow ICMPv4-In” `
    –Protocol ICMPv4
   ```

10. На виртуальной машине в Azure проверьте связь с виртуальной машины в стек Azure через туннель. Чтобы сделать это, проверьте связь DIP, записанное на Azs-VM.
   В среде примере это **10.0.10.4**, но необходимо обязательно обратитесь по адресу, записанное в лаборатории. Вы увидите результат, который выглядит как следующий снимок экрана:
   
    ![Успешная проверка связи](media/azure-stack-create-vpn-connection-one-node-tp2/image19b.png)
11. Ответ от удаленной виртуальной машины указывает успешного завершения проверки. Можно закрыть окна виртуальной машины. Можно проверить подключение, можно попробовать другие виды передачах данных, таких как копирование файлов.

### <a name="viewing-data-transfer-statistics-through-the-gateway-connection"></a>Просмотр статистики передачи данных через подключение шлюза
Если вы хотите знать, сколько данных проходит через сайт сайт подключения, эта информация доступна на **подключения** раздела. Этот тест также является другим способом, чтобы убедиться, что ping, который вы только что отправлен на самом деле пошло через VPN-подключение.

1. Во время выполнен вход пользователя виртуальной машины в Azure стека, используйте учетную запись пользователя для входа на пользовательский портал.
2. Последовательно выберите пункты **все ресурсы**, а затем выберите **Azs Azure** соединения. **Подключения** отображается.
4. На **подключения** статьи, статистика для **данные в** и **исходящие данные** отображаются. На следующем снимке экрана больших чисел достигается за счет передачи дополнительных файлов. Вы увидите некоторые ненулевых значений.
   
    ![Данные, in и out](media/azure-stack-connect-vpn/Connection.png)

## <a name="next-steps"></a>Дальнейшие действия

[Развертывание приложений для Azure и Azure стека](azure-stack-solution-pipeline.md)
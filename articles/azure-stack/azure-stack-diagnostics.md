---
title: "Диагностика в стек Azure | Документы Microsoft"
description: "Сведения о сборе файлов журнала диагностики в стек Azure"
services: azure-stack
documentationcenter: 
author: adshar
manager: 
editor: 
ms.assetid: 
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 7/10/2017
ms.author: adshar
ms.openlocfilehash: 70004cfd83360ac4c66fd4c90632d341709d2e6f
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2017
---
# <a name="azure-stack-diagnostics-tools"></a>Средства диагностики Azure стека
 
Стек Azure имеет большое количество компонентов совместной работы и взаимодействия друг с другом. Все эти компоненты создают свои собственные уникальные журналы, это означает, что выявить проблемы, может быстро стать сложной задачи, особенно для ошибок, поступающих из нескольких взаимодействующих компонентов Azure стека. 

Наши средства диагностики помогают убедитесь, что механизм сбора журналов проста и эффективна. На следующей схеме показано влияние журнала средства сбора данных в работе стека Azure:

![Средства сбора данных журнала](media/azure-stack-diagnostics/image01.png)
 
 
## <a name="trace-collector"></a>Сборщиком трассировки
 
По умолчанию включен сборщик трассировки. Он непрерывно в фоновом режиме и собирает все журналы трассировки событий для Windows (ETW) из служб компонентов на стек Azure и сохраняет их на общие локальной общей папкой. 

Ниже приведены важные сведения о сборщике данных трассировки.
 
* Сборщиком трассировки выполняется постоянно с ограничениями размера по умолчанию. Значение по умолчанию, максимальный размер, допустимый для каждого файла (200 МБ) — **не** пороговый размер. Периодически происходит проверка размера (в настоящее время каждые 10 минут) и, если текущий файл > = 200 МБ, он сохраняется и создается новый файл. Также есть (8 ГБ настраиваемое) ограничение на размер всего файла, созданные для сеанса событий. По достижении этого предела самые старые файлы будут удалены при создании новых.
* Ограничено возраст 5 дней в журналы. Это ограничение может быть настроен. 
* Каждый компонент определяет свойства конфигурации трассировки с использованием файла JSON. Файлы JSON хранятся в `C:\TraceCollector\Configuration`. При необходимости эти файлы можно изменять для изменения ограничения по размеру и возраст сбора журналов. Изменения в эти файлы требуют перезапуска *сборщик трассировки стека Microsoft Azure* службу, чтобы изменения вступили в силу.
* Следующий пример является файл трассировки конфигурации JSON для операций FabricRingServices из XRP ВМ: 

```
{
    "LogFile": 
    {
        "SessionName": "FabricRingServicesOperationsLogSession",
        "FileName": "\\\\SU1FileServer\\SU1_ManagementLibrary_1\\Diagnostics\\FabricRingServices\\Operations\\AzureStack.Common.Infrastructure.Operations.etl",
        "RollTimeStamp": "00:00:00",
        "MaxDaysOfFiles": "5",
        "MaxSizeInMB": "200",
        "TotalSizeInMB": "5120"
    },
    "EventSources":
    [
        {"Name": "Microsoft-AzureStack-Common-Infrastructure-ResourceManager" },
        {"Name": "Microsoft-OperationManager-EventSource" },
        {"Name": "Microsoft-Operation-EventSource" }
    ]
}
```

* **MaxDaysOfFiles**

    Этот параметр управляет возраста версий файлов. Старые файлы журнала будут удалены.
* **MaxSizeInMB**

    Этот параметр определяет пороговое значение размера для одного файла. Если достигнуто, создается новый ETL-файла.
* **TotalSizeInMB**

    Этот параметр определяет общий объем .etl файлы, созданные из сеанса событий. Если общий размер файлов превышает это значение параметра, старые файлы будут удалены.
  
## <a name="log-collection-tool"></a>Средство сбора журналов
 
Команда PowerShell `Get-AzureStackLog` может использоваться для сбора журналов из всех компонентов в среде Azure стека. Она сохраняет их в ZIP-файлы в расположении определяемой пользователем. Наша группа технической поддержки должен журналов для помощи в устранении проблемы, может потребоваться для запуска этого средства.

> [!CAUTION]
> Эти файлы журнала могут содержать личные сведения (PII). Это учитывать перед отправкой любых файлов журнала открыто.
 
В настоящее время мы собирать следующие типы журналов:
*   **Журналы развертывания Azure стека**
*   **Журналы событий Windows**
*   **Журналы panther**

     Для устранения неполадок создания виртуальной Машины.
*   **Журнал кластера**
*   **Журналы диагностики хранилища**
*   **Журналы трассировки событий Windows**

    Эти сборщиком трассировки, которые хранятся в общей папке, откуда `Get-AzureStackLog` извлекает их.
 
Определить все журналы, которые собираются из всех компонентов, можете `<Logs>` теги в файле конфигурации клиента, расположенный `C:\EceStore\<Guid>\<GuidWithMaxFileSize>`.
 
### <a name="to-run-get-azurestacklog"></a>Для запуска Get AzureStackLog
1.  Войдите в систему как AzureStack\AzureStackAdmin на узле.
2.  Откройте окно PowerShell от имени администратора.
3.  Запустите `Get-AzureStackLog`.  

    **Примеры**

    - Собирать все журналы для всех ролей:

        `Get-AzureStackLog -OutputPath C:\AzureStackLogs`

    - Соберите журналы из VirtualMachines и BareMetal роли:

        `Get-AzureStackLog -OutputPath C:\AzureStackLogs -FilterByRole VirtualMachines,BareMetal`

    - Соберите журналы из VirtualMachines и BareMetal роли, с датой фильтрации для файлов журнала последние 8 часов:

        `Get-AzureStackLog -OutputPath C:\AzureStackLogs -FilterByRole VirtualMachines,BareMetal -FromDate (Get-Date).AddHours(-8) -ToDate (Get-Date)`

Если `FromDate` и `ToDate` параметры не указаны, сбора журналов за последние 4 часа по умолчанию.

В настоящее время можно использовать `FilterByRole` параметр коллекцию фильтров журнала для следующих ролей:

|   |   |   |
| - | - | - |
| `ACSMigrationService`     | `ACSMonitoringService`   | `ACSSettingsService` |
| `ACS`                     | `ACSFabric`              | `ACSFrontEnd`        |
| `ACSTableMaster`          | `ACSTableServer`         | `ACSWac`             |
| `ADFS`                    | `ASAppGateway`           | `BareMetal`          |
| `BRP`                     | `CA`                     | `CPI`                |
| `CRP`                     | `DeploymentMachine`      | `DHCP`               |
|`Domain`                   | `ECE`                    | `ECESeedRing`        |        
| `FabricRing`              | `FabricRingServices`     | `FRP`                |
|` Gateway`                 | `HealthMonitoring`       | `HRP`                |               
| `IBC`                     | `InfraServiceController` | `KeyVaultAdminResourceProvider`|
| `KeyVaultControlPlane`    | `KeyVaultDataPlane`      | `NC`                 |            
| `NonPrivilegedAppGateway` | `NRP`                    | `SeedRing`           |
| `SeedRingServices`        | `SLB`                    | `SQL`                |     
| `SRP`                     | `Storage`                | `StorageController`  |
| `URP`                     | `UsageBridge`            | `VirtualMachines`    |  
| `WAS`                     | `WASPUBLIC`              | `WDS`                |


Обратите внимание на несколько моментов:

* Это команда принимает некоторое время для сбора журналов, в зависимости от роли, которую журналы собираются. Ключевых факторов включают промежуток времени, указанный для сбора журналов, а также номера узлов в среде Azure стека.
* После завершения сбора журналов, проверьте новой папки, созданные в `-OutputPath` параметр, указанный в команде.
* Файл с именем `Get-AzureStackLog_Output.log` создается в папке, содержащей ZIP-файлы и содержит выходные данные команды, который может использоваться для устранения сбоев сбор данных журналов.
* Каждая роль имеет журналов внутри отдельных ZIP-файл. 
* Чтобы изучить конкретный сбой, журналы могут быть необходимы из более чем одного компонента.
    -   Журналы событий для всех виртуальных машин инфраструктуры и системы собираются в *VirtualMachines* роли.
    -   Системы и журналы событий для всех узлов сохраняются в *BareMetal* роли.
    -   Отказоустойчивый кластер и Hyper-V журналы событий сохраняются в *хранения* роли.
    -   ACS журналы собираются в *хранения* и *ACS* ролей.
* Дополнительные сведения можно ссылаться в файл конфигурации клиента. Исследовать `<Logs>` теги для различных ролей.

> [!NOTE]
> Мы задать ограничения на размер и возраст в журналы, собранные как очень важно, чтобы обеспечить эффективное использование дискового пространства, чтобы убедиться в том, что не получают переполняющее с журналами. Вышесказанного, когда диагностики неполадок часто достаточно входит, больше не существует из-за этих ограничений применяется принудительно. Следовательно, это **настоятельно рекомендуется** , вы разгрузить журналов внешних дисковое пространство (учетной записи хранилища в Azure открытый, дополнительные локальное устройство хранения данных и т.д.) каждые 8 – 12 часов и сохранять их существует 1-3 месяцев в зависимости от требований.


## <a name="next-steps"></a>Дальнейшие действия
[Microsoft Azure Stack troubleshooting (Устранение неполадок, связанных с Microsoft Azure Stack)](azure-stack-troubleshooting.md)

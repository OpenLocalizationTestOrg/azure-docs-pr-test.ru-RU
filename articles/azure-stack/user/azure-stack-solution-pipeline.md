---
title: "Развертывание приложения в Azure и Azure Stack | Документация Майкрософт"
description: "Узнайте, как развертывать приложения в Azure и Azure Stack с помощью гибридного конвейера CI/CD."
services: azure-stack
documentationcenter: 
author: HeathL17
manager: byronr
editor: 
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: tutorial
ms.date: 09/25/2017
ms.author: helaw
ms.custom: mvc
ms.openlocfilehash: 83bb401d5d65cd2c34015a1a14673363aeee81d7
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="deploy-apps-to-azure-and-azure-stack"></a>Развертывание приложений в Azure и Azure Stack
*Область применения: интегрированные системы Azure Stack и комплект разработки Azure Stack*

Гибридный конвейер [непрерывной интеграции](https://www.visualstudio.com/learn/what-is-continuous-integration/)/[непрерывной поставки](https://www.visualstudio.com/learn/what-is-continuous-delivery/) (CI/CD) позволяет создавать, тестировать и развертывать приложение в различные облака.  В этом руководстве создается пример среды, чтобы узнать, как с помощью гибридного конвейера CI/CD можно:
 
> [!div class="checklist"]
> * Запустить новую сборку на основе зафиксированного кода из репозитория Visual Studio Team Services (VSTS).
> * Автоматически развернуть созданный код в Azure для пользовательского приемочного тестирования.
> * Как только ваш код прошел тестирование, автоматически развернуть его в Azure Stack. 


## <a name="prerequisites"></a>Предварительные требования
Для создания гибридного конвейера CI/CD требуется несколько компонентов, а для подготовки может потребоваться некоторое время.  Если у вас уже есть некоторые из этих компонентов, перед началом убедитесь, что они отвечают требованиям.

В этой статье также предполагается, что у вас есть определенный набор знаний об Azure и Azure Stack. Если вы хотите узнать больше, прежде чем продолжить, ознакомьтесь с такими статьями:

- [Введение в Azure](https://docs.microsoft.com/azure/fundamentals-introduction-to-azure).
- [Основные понятия Azure Stack](../azure-stack-key-features.md).

### <a name="azure"></a>Таблицы Azure
 - Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.
 - Создайте [веб-приложение](../../app-service/environment/app-service-web-how-to-create-a-web-app-in-an-ase.md) и настройте его для [публикации по FTP](../../app-service/app-service-deploy-ftp.md).  Запишите новый URL-адрес веб-приложения, так как он будет использоваться позднее.


### <a name="azure-stack"></a>Azure Stack
 - [Разверните Azure Stack](../azure-stack-run-powershell-script.md).  Обычно установка занимает несколько часов, поэтому планируйте ее соответствующим образом.
 - Разверните службы PaaS [службы приложений](../azure-stack-app-service-deploy.md) в Azure Stack.
 - Создайте веб-приложение и настройте его для [публикации по FTP](../azure-stack-app-service-enable-ftp.md).  Запишите новый URL-адрес веб-приложения, так как он будет использоваться позднее.  

### <a name="developer-tools"></a>Инструменты для разработчиков
 - Создайте [рабочую область VSTS](https://www.visualstudio.com/docs/setup-admin/team-services/sign-up-for-visual-studio-team-services).  Во время процесса регистрации создается проект с именем MyFirstProject.  
 - [Установите Visual Studio 2017](https://docs.microsoft.com/visualstudio/install/install-visual-studio) и [войдите в VSTS](https://www.visualstudio.com/docs/setup-admin/team-services/connect-to-visual-studio-team-services#connect-and-share-code-from-visual-studio).
 - Подключитесь к проекту и [локально клонируйте](https://www.visualstudio.com/docs/git/gitquickstart) его.
 - Создайте [пул агентов](https://www.visualstudio.com/docs/build/concepts/agents/pools-queues#creating-agent-pools-and-queues) в VSTS.
 - Установите Visual Studio и разверните [агент сборки VSTS](https://www.visualstudio.com/docs/build/actions/agents/v2-windows) на виртуальную машину в Azure Stack. 
 

## <a name="create-app--push-to-vsts"></a>Создание приложения и отправка его в VSTS

### <a name="create-application"></a>Создание приложения
В этом разделе создается простое приложение ASP.NET, которое затем отправляется в VSTS.  Эти шаги представляют обычный рабочий процесс разработчики, который может быть адаптирован для средств и языков разработки. 

1.  Откройте Visual Studio.
2.  В Team Explorer в области **Решения...** щелкните **Создать**.
3.  Выберите **Visual C#** > **Интернет** > **Веб-приложение ASP.NET (.NET Framework)**.
4.  Укажите имя приложения и нажмите кнопку **ОК**.
5.  На следующем экране оставьте значения по умолчанию (веб-формы), а затем нажмите кнопку **ОК**.

### <a name="commit-and-push-changes-to-vsts"></a>Фиксирование и отправка изменений в VSTS
1.  С помощью Team Explorer в Visual Studio выберите раскрывающийся список и щелкните **Изменения**.
2.  Введите сообщение о фиксации и выберите **Зафиксировать все**. Вам будет предложено сохранить файл решения, щелкните "Да", чтобы сохранить все.
3.  После фиксации Visual Studio предлагает синхронизировать изменения в проект. Выберите **Синхронизация**.

    ![Изображение, где показан экран фиксации после фиксации](./media/azure-stack-solution-pipeline/image1.png)

4.  На вкладке "Синхронизация" в разделе *исходящих фиксаций* вы увидите новые фиксации.  Выберите **Отправить** для синхронизации изменений в VSTS.

    ![Изображение, отображающее шаги синхронизации](./media/azure-stack-solution-pipeline/image2.png)

### <a name="review-code-in-vsts"></a>Проверка кода в VSTS
После фиксации изменения и отправки в VSTS проверьте код на портале VSTS.  Выберите **Код**, а затем в раскрывающемся меню щелкните **Файлы**.  Вы увидите созданное решение.

## <a name="create-build-definition"></a>Создание определения сборки
Процесс сборки определяет, как приложение создается и упаковывается для развертывания при каждой фиксации изменений кода. В нашем примере используется включенный шаблон для настройки процесса сборки приложения ASP.NET, хотя эту конфигурацию можно адаптировать в зависимости от приложения.

1.  Войдите в рабочую область VSTS в веб-браузере.
2.  В баннере выберите **Build & Release** (Сборка и выпуск), а затем — **Сборки**.
3.  Выберите **+ Новое определение**.
4.  В списке шаблонов выберите **ASP.NET (предварительная версия)**, а затем **Применить**.
5.  На шаге *Построить решение* измените поле *Аргументы MSBuild*:

    `/p:DeployOnBuild=True /p:WebPublishMethod=FileSystem /p:DeployDefaultTarget=WebPublish /p:publishUrl="$(build.artifactstagingdirectory)\\"`

6.  Выберите вкладку **Параметры**, а затем выберите очередь агента для агента сборки, развернутого на виртуальной машине в Azure Stack. 
7.  Выберите вкладку **Триггеры** и включите **Непрерывная интеграция**.
7.  Щелкните **Сохранить и поместить в очередь**, а затем в раскрывающемся списке выберите **Сохранить**. 

## <a name="create-release-definition"></a>Создание определения выпуска
Процесс выпуска определяет, как сборки из предыдущего шага развертываются в среде.  В этом руководстве мы публикуем приложение ASP.NET с помощью FTP в веб-приложение Azure. Чтобы настроить выпуск в Azure, сделайте следующее:

1.  В баннере VSTS выберите **Build & Release** (Сборка и выпуск), а затем — **Выпуски**.
2.  Щелкните зеленую кнопку **+ Новое определение**.
3.  Выберите **Пусто** и нажмите кнопку **Далее**.
4.  Установите флажок *Непрерывное развертывание* и щелкните **Создать**.

Теперь, когда вы создали пустое определение выпуска и связали его со сборкой, добавьте шаги для среды Azure:

1.  Нажмите зеленую кнопку **+**, чтобы добавить задачи.
2.  Выберите **Все**, а затем из списка добавьте **Отправка по FTP** и выберите **Закрыть**.
3.  Выберите задание **Отправка по FTP**, которое было только что добавлено, и настройте следующие параметры:
    
    | Параметр | Значение |
    | ----- | ----- |
    |Метод проверки подлинности| Введите учетные данные.|
    |URL-адрес сервера | URL-адрес FTP веб-приложения, полученный с портала Azure. |
    |Имя пользователя | Имя пользователя, настроенное при создании учетных данных FTP для веб-приложения. |
    |Пароль | Пароль, созданный при установке учетных данных FTP для веб-приложения.|
    |Исходный каталог | $(System.DefaultWorkingDirectory)\**\ |
    |Удаленный каталог | /site/wwwroot/ |
    |Сохранять пути к файлам | Включено (флажок установлен).|

4.  Нажмите кнопку **Сохранить**

Наконец, настройте определение выпуска для использования пула агентов, содержащего развернутый агент, выполнив следующие действия:
1.  Выберите определение выпуска и нажмите кнопку **Изменить**.
2.  Выберите **Выполнение в агенте** в центральном столбце.  В столбце справа выберите очередь агента, содержащую агент сборки, выполняющийся в Azure Stack.  
    ![Изображение, отображающее конфигурацию определения выпуска для использования конкретной очереди](./media/azure-stack-solution-pipeline/image3.png)


## <a name="deploy-your-app-to-azure"></a>Развертывание приложения в Azure
На этом шаге используется созданный конвейер CI/CD для развертывания приложения ASP.NET в веб-приложение в Azure. 

1.  В баннере в VSTS выберите **Build & Release** (Сборка и выпуск), а затем — **Сборки**.
2.  Щелкните **...** в ранее созданном определении сборки и выберите **Поставить новую сборку в очередь**.
3.  Примите значения по умолчанию и нажмите кнопку **ОК**.  Сборка начинается, и отображается прогресс.
4.  После завершения сборки можно отслеживать состояние, выбрав **Build & Release** (Сборка и выпуск), а затем — **Выпуски**.
5.  После завершения сборки посетите веб-сайт, используя URL-адрес, записанный при создании веб-приложения.    


## <a name="add-azure-stack-to-pipeline"></a>Добавление Azure Stack в конвейер
Теперь, когда вы протестировали конвейер CI/CD, выполнив развертывание в Azure, пришло время добавить Azure Stack в конвейер.  На следующих шагах создается новая среда и добавляется задание отправки по FTP для развертывания приложения в Azure Stack.  Также добавляется подтверждение выпуска, которое служит способом имитации выхода в выпуске кода в Azure Stack.  

1.  В определении выпуска выберите **+Добавить окружение** и **Создать среду**.
2.  Выберите **Пусто** и нажмите кнопку **Далее**.
3.  Выберите **Конкретные пользователи** и укажите учетную запись.  Нажмите кнопку **Создать**.
4.  Переименуйте среду, выбрав имеющееся имя и введя *Azure Stack*.
5.  Теперь выделите среду Azure Stack, а затем выберите **Добавить задачи**.
6.  Выберите задачу **Отправка по FTP**, а затем щелкните **Добавить** и **Закрыть**.


### <a name="configure-ftp-task"></a>Настройка задачи FTP
После создания выпуска нужно настроить шаги, необходимые для публикации в веб-приложении в Azure Stack.  Настройте задачу для Azure Stack также, как была настроена задача отправки по FTP в Azure:

1.  Выберите задание **Отправка по FTP**, которое было только что добавлено, и настройте следующие параметры:
    
    | Параметр | Значение |
    | -----     | ----- |
    |Метод проверки подлинности| Введите учетные данные.|
    |URL-адрес сервера | URL-адрес FTP веб-приложения, полученный с портала Azure Stack. |
    |Имя пользователя | Имя пользователя, настроенное при создании учетных данных FTP для веб-приложения. |
    |Пароль | Пароль, созданный при установке учетных данных FTP для веб-приложения.|
    |Исходный каталог | $(System.DefaultWorkingDirectory)\**\ |
    |Удаленный каталог | /site/wwwroot/|
    |Сохранять пути к файлам | Включено (флажок установлен).|

2.  Нажмите кнопку **Сохранить**

Наконец, настройте определение выпуска для использования пула агентов, содержащего развернутый агент, выполнив следующие действия:
1.  Выберите определение выпуска и нажмите кнопку **Изменить**.
2.  Выберите **Выполнение в агенте** в центральном столбце. В столбце справа выберите очередь агента, содержащую агент сборки, выполняющийся в Azure Stack.  
    ![Изображение, отображающее конфигурацию определения выпуска для использования конкретной очереди](./media/azure-stack-solution-pipeline/image3.png)

## <a name="deploy-new-code"></a>Развертывание нового кода
Теперь можно протестировать конвейер CI/CD, выполнив последний шаг — публикацию в Azure Stack.  В этом разделе изменяется нижний колонтитул сайта и запускается развертывание по конвейеру.  Затем изменения будут развернуты в Azure для проверки. После утверждения выпуска они будут опубликованы в Azure Stack.

1. В Visual Studio откройте файл *site.master* и измените следующую строку:
    
    `
        <p>&copy; <%: DateTime.Now.Year %> - My ASP.NET Application</p>
    `

    на такой:

    `
        <p>&copy; <%: DateTime.Now.Year %> - My ASP.NET Application delivered by VSTS, Azure, and Azure Stack</p>
    `
3.  Зафиксируйте изменения и выполните синхронизацию с VSTS.  
4.  В рабочей области VSTS проверьте состояние сборки, выбрав **Build & Release** (Сборка и выпуск) > **Сборка**.
5.  Вы увидите выполнение сборки.  Дважды щелкните состояние, чтобы отслеживать ход выполнения сборки.  После появления в консоли сообщения "Готовая сборка" перейдите к проверке выпуска в разделе **Build & Release** (Сборка и выпуск) > **Выпуск**.  Дважды щелкните выпуск.
6.  Появится уведомление о том, что выпуск необходимо проверить. Проверьте URL-адрес веб-приложения и убедитесь, что новые изменения присутствуют.  Утвердите выпуск в VSTS.
    ![Изображение, отображающее конфигурацию определения выпуска для использования конкретной очереди](./media/azure-stack-solution-pipeline/image4.png)
    
7.  Убедитесь, что публикация в Azure Stack завершена, посетив веб-сайт, используя URL-адрес, указанный при создании веб-приложения.
    ![Изображение, показывающее приложение ASP.NET с измененным нижним колонтитулом](./media/azure-stack-solution-pipeline/image5.png)


Теперь новый гибридный конвейер CI/CD можно использовать в качестве строительного блока для других шаблонов гибридных облаков.

## <a name="next-steps"></a>Дальнейшие действия
Из этого руководства вы узнали, как создавать гибридные конвейеры CI/CD, которые:

> [!div class="checklist"]
> * запускают новую сборку на основе зафиксированного кода из репозитория Visual Studio Team Services (VSTS);
> * автоматически развертывают созданный код в Azure для пользовательского приемочного тестирования;
> * после тестирования кода автоматически развертывают его в Azure Stack. 

Теперь, когда у вас есть гибридный конвейер CI/CD, вы можете изучить разработку приложений для Azure Stack.

> [!div class="nextstepaction"]
> [Разработка для Azure Stack](azure-stack-developer.md)



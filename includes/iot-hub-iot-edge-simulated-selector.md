> [!div class="op_single_selector"]
> * [Linux](../articles/iot-hub/iot-hub-linux-iot-edge-simulated-device.md)
> * [Windows](../articles/iot-hub/iot-hub-windows-iot-edge-simulated-device.md)

В пошаговом руководстве с [примером отправки в облако виртуальных устройств] показано, как с помощью [Azure IoT Edge][lnk-sdk] отправлять данные телеметрии, передаваемые с виртуальных устройств в облако, в Центр Интернета вещей.

В этом руководстве рассматриваются следующие темы.

* **Архитектура**: данные об архитектуре в [примером отправки в облако виртуальных устройств].
* **Сборка и запуск**: шаги, необходимые для сборки и запуска примера.

## <a name="architecture"></a>Архитектура

[примером отправки в облако виртуальных устройств] показывает, как создать шлюз, который отправляет данные телеметрии из виртуальных устройств в Центр Интернета вещей. Возможно, устройству не удастся подключиться непосредственно к Центру Интернета вещей, так как устройство:

* не использует протокол связи, поддерживаемый Центром Интернета вещей;
* не имеет достаточно возможностей, чтобы запомнить удостоверение, присвоенное ему Центром Интернета вещей.

Шлюз IoT Edge позволяет решить эти проблемы одним из указанных ниже способов.

* Шлюз распознает протокол, используемый устройством, получает данные телеметрии, передаваемые с устройства в облако, и пересылает эти сообщения в Центр Интернета вещей по протоколу, поддерживаемому этим центром.

* Шлюз сопоставляет удостоверения Центра Интернета вещей и действует как прокси-сервер, когда устройство отправляет сообщения в Центр Интернета вещей.

На следующей схеме представлены основные компоненты примера, включая модули Edge Интернета вещей:

![][1]

Модули не передают сообщения друг другу напрямую. Модули публикуют сообщения во внутренний брокер передачи сообщений, который передает их в другие модули с помощью механизма подписки. Дополнительные сведения см. в статье [Explore Azure IoT Edge architecture on Linux][lnk-gw-getstarted] (Обзор архитектуры Edge Интернета вещей в Linux).

### <a name="protocol-ingestion-module"></a>Модуль получения протокола

Этот модуль является отправной точкой для приема данных с устройств через шлюз и их передачи в облако. В примере модуль:

1. моделирует данные температуры (при использовании физических устройств модуль считывает данные с физических устройств);
1. создает сообщение;
1. помещает смоделированные данные температуры в содержимое сообщения;
1. добавляет в сообщение свойство с фиктивным MAC-адресом;
1. делает сообщение доступными для следующего модуля в цепочке.

Модуль с именем **Protocol X ingestion** (Получение протокола X) в предыдущей схеме называется **виртуальным устройством** в исходном коде.

### <a name="mac-lt-gt-iot-hub-id-module"></a>MAC &lt;-&gt; Модуль идентификатора центра Интернета вещей

Этот модуль проверяет сообщения, которые содержат свойства MAC-адреса. В этом примере модуль получения протокола добавляет свойство MAC-адреса. Если модуль обнаруживает такое свойство, он добавляет в сообщение другое свойство с ключом устройства Центра Интернета вещей. Затем сообщение становится доступными для следующего модуля в цепочке.

Разработчик устанавливает сопоставление MAC-адресов с удостоверениями Центра Интернета вещей, чтобы связать виртуальные устройства с удостоверениями. Разработчик добавляет сопоставление вручную как часть конфигурации модуля.

> [!NOTE]
> В этом примере MAC-адрес используется как уникальный идентификатор устройства и сопоставляет его с удостоверением устройства в центре IoT. В то же время вы можете написать собственный модуль, где будет использоваться другой уникальный идентификатор. Например, устройства могут иметь уникальные серийные номера или данные телеметрии могут содержать уникальное внедренные имена устройств.

### <a name="iot-hub-communication-module"></a>Модуль связи центра IoT

Этот модуль принимает сообщения со свойством ключа Центра Интернета вещей, назначенным предыдущим модулем. Модуль отправляет содержимое сообщения Центра Интернета вещей при помощи протокола HTTP. HTTP — один из трех протоколов, понятных для центра IoT.

Вместо установки подключения для каждого виртуального устройства этот модуль устанавливает одиночное подключение HTTP между шлюзом и Центром Интернета вещей. Затем через это подключение модуль мультиплексирует подключения всех виртуальных устройств. Такой подход позволяет подключить множество устройств при помощи одного шлюза.

## <a name="before-you-get-started"></a>Необходимые условия

Перед началом работы необходимо выполнить следующие действия:

* [Создайте Центр Интернета вещей][lnk-create-hub] в подписке Azure (для выполнения указаний данного пошагового руководства необходимо имя центра). Если у вас нет учетной записи, можно создать [бесплатную учетную запись][lnk-free-trial] всего за несколько минут.
* Добавьте в центр IoT два устройства и запишите их идентификаторы и ключи устройств. Для добавления устройств в Центр Интернета вещей, созданный на предыдущем шаге, и получения их ключей, можно использовать такие средства, как [обозреватель устройств][lnk-device-explorer] или [iothub-explorer][lnk-iothub-explorer].

![][2]

<!-- Images -->
[1]: media/iot-hub-iot-edge-simulated-selector/image1.png
[2]: media/iot-hub-iot-edge-simulated-selector/image2.png

<!-- Links -->
[примером отправки в облако виртуальных устройств]: https://github.com/Azure/iot-edge/blob/master/samples/simulated_device_cloud_upload/README.md
[lnk-sdk]: https://github.com/Azure/iot-edge
[lnk-gw-getstarted]: ../articles/iot-hub/iot-hub-linux-iot-edge-get-started.md
[lnk-free-trial]: https://azure.microsoft.com/pricing/free-trial/
[lnk-device-explorer]: https://github.com/Azure/azure-iot-sdk-csharp/tree/master/tools/DeviceExplorer
[lnk-iothub-explorer]: https://github.com/Azure/iothub-explorer/blob/master/readme.md
[lnk-create-hub]: ../articles/iot-hub/iot-hub-create-through-portal.md
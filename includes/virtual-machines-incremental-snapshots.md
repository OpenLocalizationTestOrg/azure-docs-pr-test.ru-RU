# <a name="back-up-azure-unmanaged-vm-disks-with-incremental-snapshots"></a>Архивация неуправляемых дисков виртуальной машины Azure с помощью добавочных моментальных снимков
## <a name="overview"></a>Обзор
Хранилище Azure предоставляет возможность hello tootake моментальные снимки больших двоичных объектов. Моментальные снимки записать состояние hello большого двоичного объекта на момент времени. В этой статье мы расскажем, как поддерживать резервные копии дисков виртуальной машины с помощью моментальных снимков. Этот метод можно использовать при выборе не toouse резервного копирования Azure и служба восстановления и пожеланий toocreate пользовательской стратегией резервного копирования для дисков виртуальной машины.

Диски виртуальной машины Azure хранятся в службе хранилища Azure как страничные BLOB-объекты. Так как здесь описывается стратегию резервного копирования для дисков виртуальной машины в этой статье мы называем toosnapshots в контексте hello страничные большие двоичные объекты. toolearn Дополнительные сведения о моментальных снимков, см. слишком[создание моментального снимка большого двоичного объекта](https://docs.microsoft.com/rest/api/storageservices/Creating-a-Snapshot-of-a-Blob).

## <a name="what-is-a-snapshot"></a>Что такое моментальный снимок?
Моментальный снимок большого двоичного объекта — это доступная только для чтения версия большого двоичного объекта, созданная в определенный момент времени. После создания моментального снимка его можно читать, копировать или удалять, но нельзя изменять. Моментальные снимки обеспечивают tooback способом копирования большого двоичного объекта, как оно отображается в момент времени. До версии 2015-04-05 REST имели возможность hello toocopy полный моментальные снимки. С hello REST версии 2015-07-08 и более поздних версий, можно также можно скопировать добавочных моментальных снимков.

## <a name="full-snapshot-copy"></a>Копирование полных моментальных снимков
Моментальные снимки могут быть скопированы tooanother учетной записи хранения в качестве резервных копий больших двоичных объектов tookeep hello базового большого двоичного объекта. Также можно скопировать моментальный снимок через его базовый большой двоичный объект, как восстановление tooan hello большой двоичный объект более ранней версии. При копировании из одной tooanother учетной записи хранилища моментального снимка он занимает hello же пространства как большой двоичный объект базовой страницы приветствия. Таким образом копирование всего моментальных снимков из одного tooanother учетной записи хранилища работает медленно и занимает меньше места в hello целевой учетной записи хранения.

> [!NOTE]
> При копировании hello базового большого двоичного объекта tooanother назначения hello снимков hello BLOB-объекта не копируются вместе с ним. Аналогичным образом при перезаписи базового BLOB-объекта с копией, моментальные снимки, связанные с hello базового большого двоичного объекта не затрагиваются и остаются неизменными, под именем hello базового большого двоичного объекта.
> 
> 

### <a name="back-up-disks-using-snapshots"></a>Архивация дисков с помощью моментальных снимков
В рамках стратегии резервного копирования для дисков виртуальной машины можно периодическое создание большого двоичного объекта диска или страницу приветствия и скопировать их tooanother учетной записи хранилища с помощью таких средств, как [копирования BLOB-объекта](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob) операции или [AzCopy](../articles/storage/common/storage-use-azcopy.md). Можно скопировать моментальный снимок tooa страницы BLOB-объект назначения с другим именем. Hello результирующий целевой страничный большой двоичный объект является большой двоичный объект для записи страницы и моментальный снимок не. Далее в этой статье описаны шаги tootake резервных копий с использованием моментальных снимков дисков виртуальной машины.

### <a name="restore-disks-using-snapshots"></a>Восстановление дисков с помощью моментальных снимков
Когда время toorestore вашей tooa диска стабильная версия, ранее записанные в одной из резервных копий моментальных снимков hello, можно скопировать моментальный снимок на большой двоичный объект базовой страницы приветствия. После hello моментального снимка большого двоичного объекта повышенного уровня toohello базовой страницы, hello моментальный снимок остается, но его исходник перезаписывается копией, можно как для чтения и записи. Далее в этой статье описаны шаги toorestore предыдущей версии на диске из ее моментального снимка.

### <a name="implementing-full-snapshot-copy"></a>Реализация копирования полных моментальных снимков
Копирование полного моментального снимка можно реализовать, выполнив следующие hello

* Во-первых, сделайте снимок hello базового BLOB-объекта с помощью hello [моментального снимка большого двоичного объекта](https://docs.microsoft.com/rest/api/storageservices/Snapshot-Blob) операции.
* Затем копия hello моментального снимка tooa целевого хранилища учетной записи с помощью [копирования BLOB-объекта](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob).
* Повторите этот процесс toomaintain резервные копии базового большого двоичного объекта.

## <a name="incremental-snapshot-copy"></a>Копирование добавочных моментальных снимков
Новая функция Hello hello [GetPageRanges](https://docs.microsoft.com/rest/api/storageservices/Get-Page-Ranges) API-Интерфейс обеспечивает гораздо лучшую tooback способом, копирование моментальных снимков hello страничные большие двоичные объекты или дисков. Hello API возвращает hello список изменений между hello базового большого двоичного объекта и моментальные снимки hello, уменьшающий hello объем хранилища используется для резервного копирования hello учетной записи. Hello API поддерживает страничные большие двоичные объекты в хранилище Premium, а также стандартное хранилище. С помощью этого API можно создавать более быстрые и эффективные решения резервного копирования для виртуальных машин Azure. Этот API будет hello REST версии 2015-07-08 и более поздних версий.

Добавочное копирование моментального снимка допускает toocopy из одного хранилища учетной записи tooanother hello разность,

* между базовым большим двоичным объектом и его моментальным снимком ИЛИ
* Любые два снимка hello базового большого двоичного объекта

Если выполняются следующие условия hello,

* Hello BLOB-объект был создан Jan 1 2016 г. или более поздней версии.
* Hello большой двоичный объект не был перезаписан с [PutPage](https://docs.microsoft.com/rest/api/storageservices/Put-Page) или [копирования BLOB-объекта](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob) между двумя моментальными снимками.

**Примечание**. Эта функция доступна для страничных BLOB-объектов Azure класса Premium или "Стандартный".

При наличии пользовательские стратегии резервного копирования с использованием моментальных снимков, копирование моментальных снимков hello из одного tooanother учетной записи хранения может выполняться медленно и может использовать объем хранилища. Вместо копирования учетной записи для хранения резервных копий tooa всего моментального снимка hello, можно написать hello различие между последовательных моментальные снимки tooa резервного копирования страничного большого двоичного объекта. В этом случае hello время toocopy hello пространства toostore резервного копирования и значительно снижается.

### <a name="implementing-incremental-snapshot-copy"></a>Реализация копирования добавочных моментальных снимков
Можно реализовать копирования моментального снимка, выполнив следующие hello

* Создание снимка hello базового BLOB-объекта с помощью [моментального снимка большого двоичного объекта](https://docs.microsoft.com/rest/api/storageservices/Snapshot-Blob).
* Копировать hello моментального снимка toohello целевого хранилища резервных копий учетной записи с помощью [копирования BLOB-объекта](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob). Это большой двоичный объект резервной копии страницы приветствия. Создать моментальный снимок резервной копии страничным hello и сохраните ее в hello резервного копирования учетных записей.
* Создайте другой моментальный снимок hello базового BLOB-объекта с помощью моментального снимка большого двоичного объекта.
* Получить hello различие между моментальные снимки первый и второй hello hello базового BLOB-объекта с помощью [GetPageRanges](https://docs.microsoft.com/rest/api/storageservices/Get-Page-Ranges). Использовать новый параметр hello **prevsnapshot**, toospecify hello значение DateTime hello снимок tooget отличие hello. Если этот параметр присутствует, hello ответа REST включает только страницы hello, которые были изменены между целевой снимком и предыдущим снимком, включая страницы, снимите флажок.
* Используйте [PutPage](https://docs.microsoft.com/rest/api/storageservices/Put-Page) tooapply эти изменения toohello резервного копирования страничного большого двоичного объекта.
* Наконец снимок резервной копии страничным hello и их сохранения в учетной записи хранилища резервных копий hello.

В следующем разделе hello рассматриваются более подробно как можно сохранять резервные копии дисков, с помощью добавочного копирования моментального снимка

## <a name="scenario"></a>Сценарий
В этом разделе мы расскажем, как использовать пользовательскую стратегию резервного копирования для дисков виртуальной машины с помощью моментальных снимков.

Рассмотрим виртуальную машину Azure серии DS с подключенным диском P30 хранилища уровня "Премиум". диск Hello P30 называют *mypremiumdisk* хранятся в учетной записи хранения premium вызывается *mypremiumaccount*. Стандартная учетная запись хранения называется *mybackupstdaccount* используется для хранения резервной копии hello *mypremiumdisk*. Мы хотели бы tookeep моментального снимка из *mypremiumdisk* каждые 12 часов.

toolearn о создании учетной записи хранилища и диски, см. слишком[учетных записей хранилища Azure о](../articles/storage/storage-create-storage-account.md).

toolearn о резервном копировании виртуальных машинах Azure, см. слишком[резервных копий виртуальной Машины Azure плана](../articles/backup/backup-azure-vms-introduction.md).

## <a name="steps-toomaintain-backups-of-a-disk-using-incremental-snapshots"></a>Действия toomaintain резервных копий на диск с помощью добавочных моментальных снимков
Hello следующие шаги описывают как моментальные снимки tootake *mypremiumdisk* и сохранять резервные копии hello в *mybackupstdaccount*. Hello резервная копия является стандартной страничного большого двоичного объекта вызывается *mybackupstdpageblob*. Hello резервного копирования страничный большой двоичный объект всегда отражает hello же состояний в качестве hello последний моментальный снимок *mypremiumdisk*.

1. Создание hello резервного копирования страничного большого двоичного объекта для диска хранилища premium, с помощью снимка *mypremiumdisk* вызывается *mypremiumdisk_ss1*.
2. Скопируйте этот моментальный снимок toomybackupstdaccount как страничного большого двоичного объекта вызывается *mybackupstdpageblob*.
3. Создайте моментальный снимок *mybackupstdpageblob* с именем *mybackupstdpageblob_ss1* с помощью операции [создания моментального снимка BLOB-объекта](https://docs.microsoft.com/rest/api/storageservices/Snapshot-Blob) и сохраните его в *mybackupstdaccount*.
4. Во время резервного копирования hello, создайте другой моментальный снимок *mypremiumdisk*, например *mypremiumdisk_ss2*и сохранить ее в *mypremiumaccount*.
5. Получить hello добавочные изменения между снимками hello двух *mypremiumdisk_ss2* и *mypremiumdisk_ss1*, с использованием [GetPageRanges](https://docs.microsoft.com/rest/api/storageservices/Get-Page-Ranges) на  *mypremiumdisk_ss2* с hello **prevsnapshot** параметру отметка времени toohello *mypremiumdisk_ss1*. Записать эти добавочные изменения toohello резервного копирования страничного большого двоичного объекта *mybackupstdpageblob* в *mybackupstdaccount*. Если имеются удаленные диапазоны в hello добавочные изменения, должен быть снят из большого двоичного объекта резервного копирования страницы приветствия. Используйте [PutPage](https://docs.microsoft.com/rest/api/storageservices/Put-Page) toowrite добавочные изменения toohello резервного копирования страничного большого двоичного объекта.
6. Создать моментальный снимок резервной копии страничным hello *mybackupstdpageblob*, который называется *mybackupstdpageblob_ss2*. Удаление предыдущего снимка hello *mypremiumdisk_ss1* из учетной записи хранения premium.
7. Повторите шаги 4–6 в каждом окне архивации. Так вы сможете хранить архивы *mypremiumdisk* в учетной записи хранения класса "Стандартный".

![Архивация диска с помощью добавочных моментальных снимков](../articles/virtual-machines/windows/media/incremental-snapshots/storage-incremental-snapshots-1.png)

## <a name="steps-toorestore-a-disk-from-snapshots"></a>Действия toorestore диска из моментальных снимков
Здравствуйте, следующие действия, описывают, как toorestore hello диска premium *mypremiumdisk* tooan ранее моментального снимка из учетной записи хранилища резервных копий hello *mybackupstdaccount*.

1. Идентифицирует hello момент времени, на котором необходимо toorestore hello premium диска. Предположим, что моментального снимка *mybackupstdpageblob_ss2*, который хранится в учетной записи хранилища резервных копий hello *mybackupstdaccount*.
2. В mybackupstdaccount, повышение уровня моментального снимка hello *mybackupstdpageblob_ss2* как hello нового резервного копирования базовой страницы большого двоичного объекта *mybackupstdpageblobrestored*.
3. Создайте моментальный снимок восстановленного из резервной копии страничного BLOB-объекта с именем *mybackupstdpageblob_ss1*.
4. Страница hello восстановить копирования BLOB-объекта *mybackupstdpageblobrestored* из *mybackupstdaccount* слишком*mypremiumaccount* как новый диск premium hello  *mypremiumdiskrestored*.
5. Создайте моментальный снимок *mypremiumdiskrestored* с именем *mypremiumdiskrestored_ss1* для дальнейшего добавочного резервного копирования.
6. Точка ряда hello доменных служб Active Directory toohello восстановить диск виртуальной Машины *mypremiumdiskrestored* и отсоединения старой hello *mypremiumdisk* из hello виртуальной Машины.
7. Начать hello резервного копирования процесс, описанный в предыдущем разделе hello восстановить диск *mypremiumdiskrestored*, с помощью hello *mybackupstdpageblobrestored* как большой двоичный объект резервной копии страницы приветствия.

![Восстановление диска из моментальных снимков](../articles/virtual-machines/windows/media/incremental-snapshots/storage-incremental-snapshots-2.png)

## <a name="next-steps"></a>Дальнейшие действия
Используйте hello следующие ссылки toolearn больше о планировании инфраструктуры резервного копирования виртуальной Машины и создание моментальных снимков большого двоичного объекта.

* [Создание моментального снимка большого двоичного объекта](https://docs.microsoft.com/rest/api/storageservices/Creating-a-Snapshot-of-a-Blob)
* [Планирование инфраструктуры резервного копирования виртуальных машин в Azure](../articles/backup/backup-azure-vms-introduction.md)


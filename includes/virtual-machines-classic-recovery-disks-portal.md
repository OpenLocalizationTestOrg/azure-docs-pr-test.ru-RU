Если возникает ошибка загрузки или ошибка на диске виртуальной машины в Azure, возможно, следует устранить неполадки, связанные с самим виртуальным жестким диском. Например, такая ситуация может возникнуть из-за сбоя обновления приложения, который мешает успешно загрузить виртуальную машину. Из этой статьи вы узнаете, как с помощью портала Azure подключить виртуальный жесткий диск к другой виртуальной машине для устранения ошибок, а затем восстановить исходную виртуальную машину.


## <a name="recovery-process-overview"></a>Обзор процесса восстановления
Процесс устранения неполадок выглядит следующим образом.

1. Удалите виртуальную машину, на которой возникли проблемы, сохранив ее виртуальные жесткие диски.
2. Присоедините и подключите виртуальный жесткий диск к другой виртуальной машине для устранения неполадок.
3. Подключитесь к этой виртуальной машине. Измените файлы или запустите средства, которые требуются для устранения ошибок на исходном виртуальном жестком диске.
4. Отключите и отсоедините виртуальный жесткий диск от виртуальной машины, на которой выполняется устранение неполадок.
5. Создайте другую виртуальную машину, используя исходный виртуальный жесткий диск.

## <a name="delete-the-original-vm"></a>Удаление исходной виртуальной машины
Виртуальные жесткие диски и виртуальные машины — это разные ресурсы в Azure. Виртуальный жесткий диск является местом хранения операционной системы, приложений и конфигурации. Виртуальная машина — это просто метаданные, которые определяют размер или расположение объекта, а также ссылки на ресурсы, такие как виртуальные жесткие диски или виртуальные сетевые адаптеры. При присоединении виртуального жесткого диска к виртуальной машине для него регистрируется аренда. Диски данных можно присоединять и отсоединять во время работы виртуальной машины, но диск операционной системы отсоединить невозможно, пока ресурс виртуальной машины не будет удален. При аренде сохраняется привязка диска операционной системы к виртуальной машине, даже когда эта виртуальная машина остановлена или отменено ее распределение.

Для восстановления виртуальной машины нужно прежде всего удалить ресурс виртуальной машины. Удаление виртуальной машины не повлияет на виртуальные жесткие диски, размещенные в учетной записи хранения. После удаления виртуальной машины можно присоединить виртуальный жесткий диск к другой виртуальной машине, чтобы устранить ошибки. 

1. Войдите на [портал Azure](https://portal.azure.com). 
2. В меню слева щелкните **Виртуальные машины (классика)**.
3. Выберите виртуальную машину, на которой возникла проблема, щелкните **Диски** и найдите имя виртуального жесткого диска. 
4. Выберите виртуальный жесткий диск операционной системы и просмотрите сведения в поле **Расположение**, чтобы определить, в какой учетной записи хранения расположен этот виртуальный жесткий диск. В следующем примере имя учетной записи хранения указано непосредственно перед строкой .blob.core.windows.net.

    ```
    https://portalvhds73fmhrw5xkp43.blob.core.windows.net/vhds/SCCM2012-2015-08-28.vhd
    ```

    ![Изображение с данными о расположении виртуальной машины](./media/virtual-machines-classic-recovery-disks-portal/vm-location.png)

5. Щелкните имя виртуальной машины правой кнопкой мыши и выберите **Удалить**. Не выбирайте диски, когда удаляете виртуальную машину.
6. Создайте новую виртуальную машину восстановления. Эта виртуальная машина должна быть расположена в том же регионе и группе ресурсов (облачная служба), что и виртуальная машина, на которой возникла проблема.
7. Выберите виртуальную машину восстановления, а затем последовательно щелкните **Диски** > **Подключить существующий**.
8. Чтобы выбрать существующий виртуальный жесткий диск, щелкните его **VHD-файл**.

    ![Поиск существующего виртуального жесткого диска](./media/virtual-machines-classic-recovery-disks-portal/select-vhd-location.png)

9. Последовательно выберите учетную запись хранения, контейнер виртуального жесткого диска, виртуальный жесткий диск и нажмите кнопку **Выбрать**, чтобы подтвердить выбор.

    ![Выбор существующего виртуального жесткого диска](./media/virtual-machines-classic-recovery-disks-portal/select-vhd.png)

10. Выбрав существующий виртуальный жесткий диск, щелкните **ОК**, чтобы присоединить его.
11. Через несколько секунд на панели **Диски** для виртуальной машины отобразятся данные о подключении существующего виртуального жесткого диска в качестве диска данных.

    ![Существующий виртуальный жесткий диск присоединен как диск данных](./media/virtual-machines-classic-recovery-disks-portal/attached-disk.png)

## <a name="fix-issues-on-the-original-virtual-hard-disk"></a>Устранение неполадок на исходном виртуальном жестком диске
Теперь, когда существующий виртуальный жесткий диск подключен, вы можете выполнить любые необходимые действия по устранению неполадок и обслуживанию. После устранения проблем выполните следующие действия.

## <a name="unmount-and-detach-the-original-virtual-hard-disk"></a>Отключение и отсоединение исходного виртуального жесткого диска
После устранения ошибок отключите и отсоедините существующий виртуальный жесткий диск от виртуальной машины, на которой устранялись неполадки. Виртуальный жесткий диск невозможно использовать с другой виртуальной машиной, пока вы не отмените аренду, присоединяющую виртуальный жесткий диск к виртуальной машине для устранения неполадок.  

1. Войдите на [портал Azure](https://portal.azure.com). 
2. В меню слева выберите **Виртуальные машины (классика)**.
3. Найдите виртуальную машину восстановления. Выберите "Диски", щелкните диск правой кнопкой мыши и выберите **Отсоединить**.

## <a name="create-a-vm-from-the-original-hard-disk"></a>Создание виртуальной машины из исходного жесткого диска

Чтобы создать виртуальную машину из исходного виртуального жесткого диска, используйте [портал Azure](https://portal.azure.com).

1. Войдите на [портал Azure](https://portal.azure.com).
2. В верхней левой части портала щелкните **Создать** > **Среда выполнения приложений** > **Виртуальная машина** > **Из коллекции**.
3. В разделе **Выберите образ** щелкните **Мои диски**, а затем выберите исходный виртуальный жесткий диск. Просмотрите сведения о расположении. Это регион, в котором должна быть развернута виртуальная машина. Нажмите кнопку "Далее".
4. В разделе **Конфигурация виртуальной машины** введите имя виртуальной машины и выберите ее размер.

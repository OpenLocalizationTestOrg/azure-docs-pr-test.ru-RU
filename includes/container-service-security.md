# <a name="securing-docker-containers-in-azure-container-service"></a><span data-ttu-id="0774d-101">Защита контейнеров Docker в службе контейнеров Azure</span><span class="sxs-lookup"><span data-stu-id="0774d-101">Securing Docker containers in Azure Container Service</span></span>

<span data-ttu-id="0774d-102">В этой статье описываются рекомендации по защите контейнеров Docker, развернутых в службе контейнеров Azure.</span><span class="sxs-lookup"><span data-stu-id="0774d-102">This article introduces considerations and recommendations for securing Docker containers deployed in Azure Container Service.</span></span> <span data-ttu-id="0774d-103">Многие из этих рекомендаций применимы преимущественно к контейнерам Docker, развернутым в Azure или других средах.</span><span class="sxs-lookup"><span data-stu-id="0774d-103">Many of these considerations apply generally to Docker containers deployed in Azure or other environments.</span></span> 

## <a name="image-security"></a><span data-ttu-id="0774d-104">Безопасность образов</span><span class="sxs-lookup"><span data-stu-id="0774d-104">Image security</span></span>

<span data-ttu-id="0774d-105">Контейнеры состоят из образов, которые хранятся в одном или нескольких репозиториях.</span><span class="sxs-lookup"><span data-stu-id="0774d-105">Containers are built from images that are stored in one or more repositories.</span></span> <span data-ttu-id="0774d-106">Эти репозитории могут принадлежать общим или частным реестрам контейнеров.</span><span class="sxs-lookup"><span data-stu-id="0774d-106">These repositories can belong to public or private container registries.</span></span> <span data-ttu-id="0774d-107">Примером общего реестра является [Docker Hub](https://hub.docker.com/).</span><span class="sxs-lookup"><span data-stu-id="0774d-107">An example of a public registry is [Docker Hub](https://hub.docker.com/).</span></span> <span data-ttu-id="0774d-108">Примером частного реестра является [Docker Trusted Registry](https://docs.docker.com/datacenter/dtr/2.0/), который можно установить локально или в виртуальном частном облаке.</span><span class="sxs-lookup"><span data-stu-id="0774d-108">An example of a private registry is the [Docker Trusted Registry](https://docs.docker.com/datacenter/dtr/2.0/), which can be installed on-premises or in a virtual private cloud.</span></span> <span data-ttu-id="0774d-109">Существуют также частные службы реестров контейнеров на основе облака, включая [реестр контейнеров Azure](../articles/container-registry/container-registry-intro.md).</span><span class="sxs-lookup"><span data-stu-id="0774d-109">There are also cloud-based private container registry services including [Azure Container Registry](../articles/container-registry/container-registry-intro.md).</span></span>

### <a name="public-and-private-images"></a><span data-ttu-id="0774d-110">Общие и частные образы</span><span class="sxs-lookup"><span data-stu-id="0774d-110">Public and private images</span></span>
<span data-ttu-id="0774d-111">В целом, как и любой общедоступный опубликованный программный пакет, общедоступный образ контейнера не может гарантировать безопасность.</span><span class="sxs-lookup"><span data-stu-id="0774d-111">In general, as with any publicly published software package, a publicly available container image does not guarantee security.</span></span> <span data-ttu-id="0774d-112">Образы контейнеров состоят из нескольких программных слоев, у каждого из которых могут быть свои уязвимости.</span><span class="sxs-lookup"><span data-stu-id="0774d-112">Container images consist of multiple software layers, and each software layer could have vulnerabilities.</span></span> <span data-ttu-id="0774d-113">Очень важно понимать источник образа контейнера, включая владельца образа (чтобы можно было определить надежность источника), программные слои, из которых состоит этот образ, и версии программного обеспечения.</span><span class="sxs-lookup"><span data-stu-id="0774d-113">It is key to understand the origin of the container image, including the owner of the image (to determine if it is a reliable source or not), the software layers it consists of, and the software versions.</span></span> 

<span data-ttu-id="0774d-114">Например, если откроете официальный [репозиторий nginx](https://hub.docker.com/_/nginx/) на Docker Hub, а затем перейдете на вкладку **Теги**, вы увидите уязвимости для каждого образа, выделенные цветом.</span><span class="sxs-lookup"><span data-stu-id="0774d-114">For example, if you go to the official [nginx repository](https://hub.docker.com/_/nginx/) in Docker Hub and navigate to the **Tags** tab, you see color-coded vulnerabilities in each image.</span></span> <span data-ttu-id="0774d-115">Каждый цвет отражает уязвимость программного слоя образа.</span><span class="sxs-lookup"><span data-stu-id="0774d-115">Each color depicts the vulnerability of a software layer of the image.</span></span> <span data-ttu-id="0774d-116">Дополнительные сведения о сканировании уязвимостей на Docker Hub см. в записи блога, посвященной [обзору официальных репозиториев на Docker Hub](https://blog.docker.com/2015/06/understanding-official-repos-docker-hub/).</span><span class="sxs-lookup"><span data-stu-id="0774d-116">For more about vulnerability scanning in Docker Hub, see [Understanding official repos on Docker Hub](https://blog.docker.com/2015/06/understanding-official-repos-docker-hub/).</span></span>

![Образы Nginx на Docker Hub](./media/container-service-security/docker-hub-nginx.png)

<span data-ttu-id="0774d-118">Так как организации уделяют должное внимание безопасности, то чтобы защитить себя от рисков ее нарушения, для хранения и извлечения образов рекомендуется использовать частный реестр, например реестр контейнеров Azure или Docker Trusted Registry.</span><span class="sxs-lookup"><span data-stu-id="0774d-118">Enterprises care deeply about security, and to protect themselves from security attack should store and retrieve images from a private registry, such as Azure Container Registry or Docker Trusted Registry.</span></span> <span data-ttu-id="0774d-119">Кроме предоставления управляемого частного реестра, реестр контейнеров Azure также поддерживает [проверку подлинности на основе субъекта-службы](../articles/container-registry/container-registry-authentication.md) с помощью Azure Active Directory для базовых потоков аутентификации, включая доступ на основе ролей только для чтения, записи и разрешений владельца.</span><span class="sxs-lookup"><span data-stu-id="0774d-119">In addition to providing a managed private registry, Azure Container Registry supports [service principal-based authentication](../articles/container-registry/container-registry-authentication.md) through Azure Active Directory for basic authentication flows, including role-based access for read-only, write, and owner permissions.</span></span>

### <a name="image-security-scanning"></a><span data-ttu-id="0774d-120">Сканирование безопасности образов</span><span class="sxs-lookup"><span data-stu-id="0774d-120">Image security scanning</span></span>

<span data-ttu-id="0774d-121">Даже если вы используете частный реестр, мы советуем также использовать решения сканирования образов для дополнительной проверки безопасности.</span><span class="sxs-lookup"><span data-stu-id="0774d-121">Even when using a private registry, it is a good idea to use image scanning solutions for additional security validation.</span></span> <span data-ttu-id="0774d-122">Каждый программный слой в образе контейнера потенциально подвержен уязвимостям независимо от других слоев.</span><span class="sxs-lookup"><span data-stu-id="0774d-122">Each software layer in a container image is potentially prone to vulnerabilities independent of other layers in the container image.</span></span> <span data-ttu-id="0774d-123">Так как организации стали все больше склоняться к развертыванию производственных рабочих нагрузок на основе технологий контейнеров, сканирование образов для предотвращения угроз безопасности в организации получило широкое распространение.</span><span class="sxs-lookup"><span data-stu-id="0774d-123">As increasingly companies start deploying their production workloads based on container technologies, image scanning becomes important to ensure prevention of security threats against their organizations.</span></span> 

<span data-ttu-id="0774d-124">Помимо прочих, такие решения мониторинга безопасности и сканирования, как [Twistlock](https://www.twistlock.com/2016/11/07/twistlock-supports-azure-container-registry) и [Aqua Security](http://blog.aquasec.com/image-vulnerability-scanning-in-azure-container-registry), можно использовать для сканирования образов контейнера в частном реестре и определения потенциальных уязвимостей.</span><span class="sxs-lookup"><span data-stu-id="0774d-124">Security monitoring and scanning solutions such as [Twistlock](https://www.twistlock.com/2016/11/07/twistlock-supports-azure-container-registry) and [Aqua Security](http://blog.aquasec.com/image-vulnerability-scanning-in-azure-container-registry), among others, can be used to scan container images in a private registry and identify potential vulnerabilities.</span></span> <span data-ttu-id="0774d-125">Важно понимать уровень сканирования, который обеспечивают различные решения.</span><span class="sxs-lookup"><span data-stu-id="0774d-125">It is important to understand the depth of scanning that the different solutions provide.</span></span> <span data-ttu-id="0774d-126">Например, некоторые решения могут использовать перекрестную проверку слоев образа на наличие известных уязвимостей.</span><span class="sxs-lookup"><span data-stu-id="0774d-126">For example, some solutions might only cross-verify image layers against known vulnerabilities.</span></span> <span data-ttu-id="0774d-127">При этом они не смогут проверить программное обеспечение слоев образа, созданного на основе определенного программного обеспечения диспетчера пакетов.</span><span class="sxs-lookup"><span data-stu-id="0774d-127">These solutions might not be able to verify image-layer software built through certain package manager software.</span></span> <span data-ttu-id="0774d-128">Для других решений предусмотрена более глубокая интеграция сканирования, и они могут обнаружить уязвимости в любом комплекте программного обеспечения.</span><span class="sxs-lookup"><span data-stu-id="0774d-128">Other solutions have deeper scanning integration and can find vulnerabilities in any packaged software.</span></span>

### <a name="production-deployment-rules-and-audit"></a><span data-ttu-id="0774d-129">Правила развертывания в рабочей среде и аудит</span><span class="sxs-lookup"><span data-stu-id="0774d-129">Production deployment rules and audit</span></span>
<span data-ttu-id="0774d-130">Когда приложение развернуто в рабочей среде, необходимо задать несколько правил, чтобы убедиться, что образы, используемые в рабочих средах, безопасны и не содержат уязвимостей.</span><span class="sxs-lookup"><span data-stu-id="0774d-130">Once an application is deployed in production, it is essential to set a few rules to ensure that images used in production environments are secure and contain no vulnerabilities.</span></span>

* <span data-ttu-id="0774d-131">Обычно образы с уязвимостями (даже незначительными) не должны выполняться в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="0774d-131">As a rule, images with vulnerabilities, even minor, should not be allowed to run in a production environment.</span></span> <span data-ttu-id="0774d-132">Кроме того, все образы, развернутые в рабочей среде, в идеале нужно сохранить в частном реестре, из которого их можно извлечь.</span><span class="sxs-lookup"><span data-stu-id="0774d-132">In addition, all images deployed in production should ideally be saved in a private registry accessible to a select few.</span></span> <span data-ttu-id="0774d-133">Чтобы эффективно управлять рабочими образами, их количество должно быть ограничено.</span><span class="sxs-lookup"><span data-stu-id="0774d-133">It is also important to keep the number of production images small to ensure that they can be managed effectively.</span></span>

* <span data-ttu-id="0774d-134">Так как из общедоступного образа контейнера сложно выявить источник программного обеспечения, рекомендуется создавать образы из источника для обеспечения уверенности в источнике слоя.</span><span class="sxs-lookup"><span data-stu-id="0774d-134">Since it is hard to pinpoint the origin of software from a publicly available container image, it is a good practice to build images from source to ensure knowledge of the origin of the layer.</span></span> <span data-ttu-id="0774d-135">Когда в автоматически созданном образе контейнера появляется уязвимость, клиенты могут достаточно быстро устранить эту проблему.</span><span class="sxs-lookup"><span data-stu-id="0774d-135">When a vulnerability surfaces in a self-built container image, customers can find a quicker path to a resolution.</span></span> <span data-ttu-id="0774d-136">Что касается общедоступного образа, клиентам понадобится найти корень этого образа, чтобы исправить его, или же получить другой безопасный образ в издателе.</span><span class="sxs-lookup"><span data-stu-id="0774d-136">With a public image, customers would need to find the root of a public image to fix it or obtain another secure image from the publisher.</span></span>

* <span data-ttu-id="0774d-137">Тщательно сканированный образ, развернутый в рабочей среде, не обязательно будет обновляться в течение времени существования приложения.</span><span class="sxs-lookup"><span data-stu-id="0774d-137">A thoroughly scanned image deployed in production is not guaranteed to be up to date for the lifetime of the application.</span></span> <span data-ttu-id="0774d-138">Вы можете получить сообщения об уязвимостях системы безопасности для слоев образа, с которыми вы не сталкивались ранее или которые были представлены после развертывания в рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="0774d-138">Security vulnerabilities might be reported for layers of the image that were not previously known or were introduced after the production deployment.</span></span> <span data-ttu-id="0774d-139">Периодический аудит образов, развернутых в рабочей среде, необходим для определения устаревших образов или образов, которые давно не обновлялись.</span><span class="sxs-lookup"><span data-stu-id="0774d-139">Periodic auditing of images deployed in production is necessary to identify images that are out of date or have not been updated in a while.</span></span> <span data-ttu-id="0774d-140">Вы можете использовать "сине-зеленые" методы развертывания и последовательное обновление, чтобы обновлять образы контейнеров без простоя.</span><span class="sxs-lookup"><span data-stu-id="0774d-140">One might use blue-green deployment methodologies and rolling upgrade mechanisms to update container images without downtime.</span></span> <span data-ttu-id="0774d-141">Сканирование образа можно выполнить с помощью средств, описанных в разделе выше.</span><span class="sxs-lookup"><span data-stu-id="0774d-141">Image scanning can be done with tools described in the preceding section.</span></span> 

* <span data-ttu-id="0774d-142">Конвейер непрерывной интеграции для создания образов и интегрированная проверка безопасности позволяет поддерживать защищенные частные реестры с безопасными образами контейнеров.</span><span class="sxs-lookup"><span data-stu-id="0774d-142">A continuous integration (CI) pipeline to build images and integrated security scanning can help maintain secure private registries with secure container images.</span></span> <span data-ttu-id="0774d-143">Сканирование уязвимостей, встроенное в решение непрерывной интеграции, обеспечивает отправку прошедших все проверки образов в частный реестр, из которого развертываются производственные рабочие нагрузки.</span><span class="sxs-lookup"><span data-stu-id="0774d-143">The vulnerability scanning built into the CI solution ensures that images that pass all the tests are pushed to the private registry from which production workloads are deployed.</span></span> <span data-ttu-id="0774d-144">При сбое в конвейере непрерывной интеграции уязвимые образы не отправляются в частный реестр, используемый для развертываний производственных рабочих нагрузок.</span><span class="sxs-lookup"><span data-stu-id="0774d-144">A CI pipeline failure ensures that vulnerable images are not pushed into the private registry used for production workload deployments.</span></span> <span data-ttu-id="0774d-145">В случае значительного количества образов также запускается автоматическая проверка их безопасности.</span><span class="sxs-lookup"><span data-stu-id="0774d-145">It also automates image security scanning if there are a significant number of images.</span></span> <span data-ttu-id="0774d-146">Выполнение аудита образов вручную для обнаружения уязвимостей системы безопасности очень долгий процесс, подверженный ошибкам.</span><span class="sxs-lookup"><span data-stu-id="0774d-146">Otherwise, manually auditing images for security vulnerabilities can be painstakingly lengthy and error prone.</span></span>

## <a name="host-level-container-isolation"></a><span data-ttu-id="0774d-147">Изоляция контейнера на уровне узла</span><span class="sxs-lookup"><span data-stu-id="0774d-147">Host-level container isolation</span></span>
<span data-ttu-id="0774d-148">Когда клиент развертывает приложения контейнера в ресурсах Azure, они развертываются в группах ресурсов на уровне подписки и не являются мультитенантными.</span><span class="sxs-lookup"><span data-stu-id="0774d-148">When a customer deploys container applications on Azure resources, they are deployed at a subscription level in resource groups and are not multi-tenant.</span></span> <span data-ttu-id="0774d-149">Это значит, что если клиент предоставит доступ к подписке другим пользователям, границы между двумя развертываниями в одной подписке будут отсутствовать.</span><span class="sxs-lookup"><span data-stu-id="0774d-149">This means that if a customer shares a subscription with others, there are no boundaries that can be built between two deployments in the same subscription.</span></span> <span data-ttu-id="0774d-150">Таким образом, безопасность на уровне контейнера не гарантируется.</span><span class="sxs-lookup"><span data-stu-id="0774d-150">Therefore, container-level security is not guaranteed.</span></span> 

<span data-ttu-id="0774d-151">Также очень важно понимать, что контейнеры могут предоставлять доступ к ядру и ресурсам узла (в службе контейнеров Azure это виртуальная машина Azure в кластере).</span><span class="sxs-lookup"><span data-stu-id="0774d-151">It is also critical to understand that containers share the kernel and the resources of the host (which in Azure Container Service is an Azure VM in a cluster).</span></span> <span data-ttu-id="0774d-152">Следовательно, контейнеры, запущенные в рабочей среде, должны запускаться в непривилегированном пользовательском режиме.</span><span class="sxs-lookup"><span data-stu-id="0774d-152">Therefore, containers running in production must be run in non-privileged user mode.</span></span> <span data-ttu-id="0774d-153">Запуск контейнера с привилегиями суперпользователя может привести к компрометации всей среды.</span><span class="sxs-lookup"><span data-stu-id="0774d-153">Running a container with root privileges can compromise the entire environment.</span></span> <span data-ttu-id="0774d-154">Если к контейнеру предоставлен доступ на корневом уровне, злоумышленник может получить доступ ко всем привилегиям суперпользователя на узле.</span><span class="sxs-lookup"><span data-stu-id="0774d-154">With root-level access in a container, a hacker can gain access to the full root privileges on the host.</span></span> <span data-ttu-id="0774d-155">Кроме того, важно запускать контейнеры с файловыми системами только для чтения.</span><span class="sxs-lookup"><span data-stu-id="0774d-155">In addition, it is important to run containers with read-only file systems.</span></span> <span data-ttu-id="0774d-156">Это предотвратит написание вредоносных сценариев для файловой системы и получение доступа к другим файлам пользователями, у которых есть доступ к скомпрометированному контейнеру.</span><span class="sxs-lookup"><span data-stu-id="0774d-156">This prevents someone who has access to the compromised container to write malicious scripts to the file system and gain access to other files.</span></span> <span data-ttu-id="0774d-157">Точно так же важно ограничить ресурсы (память, ЦП и пропускную способность сети), выделенные контейнеру.</span><span class="sxs-lookup"><span data-stu-id="0774d-157">Similarly, it is important to limit the resources (such as memory, CPU, and network bandwidth) allocated to a container.</span></span> <span data-ttu-id="0774d-158">Это поможет предотвратить захват ресурсов злоумышленниками и осуществление незаконных действий, например мошенническое использование кредитной карты, добывание биткойнов, что также предотвратит запуск других контейнеров на узле или кластере.</span><span class="sxs-lookup"><span data-stu-id="0774d-158">This helps prevent hackers from hogging resources and pursuing illegal activities such as credit card fraud or bitcoin mining, which could prevent other containers from running on the host or cluster.</span></span>

## <a name="orchestrator-considerations"></a><span data-ttu-id="0774d-159">Оркестратор и вопросы безопасности</span><span class="sxs-lookup"><span data-stu-id="0774d-159">Orchestrator considerations</span></span>

<span data-ttu-id="0774d-160">Для каждого оркестратора, доступного в службе контейнеров Azure, предусмотрены свои рекомендации по безопасности.</span><span class="sxs-lookup"><span data-stu-id="0774d-160">Each orchestrator available in Azure Container Service has its own security considerations.</span></span> <span data-ttu-id="0774d-161">Например, вам необходимо ограничить прямой доступ SSH к узлам оркестратора в службе контейнеров.</span><span class="sxs-lookup"><span data-stu-id="0774d-161">For example, you should limit direct SSH access to orchestrator nodes in Container Service.</span></span> <span data-ttu-id="0774d-162">Вместо этого следует использовать пользовательский интерфейс каждого оркестратора или средства командной строки (например, `kubectl` для Kubernetes), чтобы управлять средой контейнера без доступа к узлам.</span><span class="sxs-lookup"><span data-stu-id="0774d-162">Instead, you should use each orchestrator's UI or command-line tools (such as `kubectl` for Kubernetes) to manage the container environment without accessing the hosts.</span></span> <span data-ttu-id="0774d-163">Дополнительные сведения см. в статье [Создание удаленного подключения к кластеру Kubernetes, DC/OS или Docker Swarm](../articles/container-service/kubernetes/container-service-connect.md).</span><span class="sxs-lookup"><span data-stu-id="0774d-163">For more information, see [Make a remote connection to a Kubernetes, DC/OS, or Docker Swarm cluster](../articles/container-service/kubernetes/container-service-connect.md).</span></span>

<span data-ttu-id="0774d-164">Дополнительные сведения о безопасности оркестратора см. в ресурсах ниже.</span><span class="sxs-lookup"><span data-stu-id="0774d-164">For additional orchestrator-specific security information, see the following resources:</span></span>

* <span data-ttu-id="0774d-165">**Kubernetes**: [Security Best Practices for Kubernetes Deployment](http://blog.kubernetes.io/2016/08/security-best-practices-kubernetes-deployment.html) (Рекомендации по безопасности для развертывания Kubernetes)</span><span class="sxs-lookup"><span data-stu-id="0774d-165">**Kubernetes**: [Security Best Practices for Kubernetes Deployment](http://blog.kubernetes.io/2016/08/security-best-practices-kubernetes-deployment.html)</span></span>

* <span data-ttu-id="0774d-166">**DC/OS**: [Securing Your Cluster](https://dcos.io/docs/1.8/administration/securing-your-cluster/) (Защита кластера)</span><span class="sxs-lookup"><span data-stu-id="0774d-166">**DC/OS**: [Securing Your Cluster](https://dcos.io/docs/1.8/administration/securing-your-cluster/)</span></span>

* <span data-ttu-id="0774d-167">**Docker Swarm**: [Docker Security](https://www.docker.com/docker-security) (Защита Docker)</span><span class="sxs-lookup"><span data-stu-id="0774d-167">**Docker Swarm**: [Docker Security](https://www.docker.com/docker-security)</span></span>

## <a name="next-steps"></a><span data-ttu-id="0774d-168">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="0774d-168">Next steps</span></span>

* <span data-ttu-id="0774d-169">Дополнительные сведения об архитектуре Docker и защите контейнера см. в руководстве [Introduction to Container Security. Understanding the isolation properties of Docker](https://www.docker.com/sites/default/files/WP_IntrotoContainerSecurity_08.19.2016.pdf) (Обзор безопасности контейнеров. Свойства изоляции Docker).</span><span class="sxs-lookup"><span data-stu-id="0774d-169">For more about Docker architecture and container security, see [Introduction to Container Security](https://www.docker.com/sites/default/files/WP_IntrotoContainerSecurity_08.19.2016.pdf).</span></span>

* <span data-ttu-id="0774d-170">Дополнительные сведения о безопасности платформы Azure см. на странице [центра безопасности Azure](https://www.microsoft.com/en-us/trustcenter/cloudservices/azure).</span><span class="sxs-lookup"><span data-stu-id="0774d-170">For information about Azure platform security, see the [Azure Security Center](https://www.microsoft.com/en-us/trustcenter/cloudservices/azure).</span></span>
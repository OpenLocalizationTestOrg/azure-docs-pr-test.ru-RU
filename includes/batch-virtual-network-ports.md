- Виртуальная сеть должна размещаться в том же **регионе** Azure и той же **подписке**, что и учетная запись пакетной службы.

- Для пулов, созданных с конфигурацией виртуальной машины, поддерживаются только виртуальные сети на основе Azure Resource Manager. Для пулов, созданных с конфигурацией облачных служб, поддерживаются только классические виртуальные сети. 
  
- Чтобы использовать классические виртуальные сети, `MicrosoftAzureBatch`субъекту-службе должна быть назначена роль`Classic Virtual Machine Contributor` управления доступом на основе ролей для указанной виртуальной сети. Для использования виртуальной сети на основе Azure Resource Manager не нужно настраивать дополнительные разрешения.

- Указанная для пула подсеть должна иметь достаточное количество свободных IP-адресов для всех виртуальных машин, предназначенных для пула, то есть сумму свойств `targetDedicatedNodes` и `targetLowPriorityNodes` этого пула. Если в подсети недостаточно свободных IP-адресов, пакетная служба ограничивает выделение вычислительных узлов для пула и генерирует ошибку изменения размера. 

- Чтобы на вычислительных узлах можно было назначать задачи, виртуальная сеть должна разрешать подключения из пакетной службы. Чтобы проверить это условие, убедитесь, что для виртуальной сети назначены группы безопасности сети. Если группа безопасности сети (NSG), связанная с назначенной подсетью, запрещает взаимодействие с вычислительными узлами, пакетная служба установит для вычислительных узлов состояние **Непригоден**. 

- Если указанной виртуальной сети уже назначены группы безопасности сети и (или) брандмауэр, настройте входящие и исходящие порты, как показано в следующих таблицах.


  |    Конечные порты    |    Исходный IP-адрес      |   Исходный порт    |    Добавляет ли пакетная служба группы NSG?    |    Требуется для использования виртуальной машины?    |    Действие пользователя   |
  |---------------------------|---------------------------|----------------------------|----------------------------|-------------------------------------|-----------------------|
  |   <ul><li>Для пулов, созданных с помощью конфигурации виртуальной машины: 29876, 29877</li><li>Для пулов, созданных с конфигурацией облачных служб: 10100, 20100, 30100</li></ul>        |    Только IP-адреса для ролей пакетной службы | * или 443 |    Да. Пакетная служба добавляет группы NSG на уровне сетевых интерфейсов (NIC), подключенных к виртуальным машинам. Группы NSG пропускают трафик только с IP-адресов для ролей пакетной службы. Даже если открыть эти порты для всего Интернета, трафик будет блокироваться в сетевом интерфейсе. |    Да  |  Указывать NSG не требуется, так как пакетная служба пропускает только трафик с IP-адресов пакетной службы. <br /><br /> Если вы все же укажете NSG, убедитесь, что эти порты открыты для входящего трафика. <br /><br /> При указании * в качестве исходного IP-адреса в группе NSG пакетная служба по-прежнему добавляет группы NSG на уровне сетевого интерфейса, подключенного к виртуальным машинам. |
  |    3389 (Windows), 22 (Linux)               |    Компьютеры пользователя, используемые для отладки и удаленного доступа к виртуальной машине.    |   *  | Нет                                    |    Нет                    |    Добавьте группы NSG, чтобы разрешить удаленный доступ к виртуальной машине по протоколу RDP и (или) SSH.   |                                


  |    Исходящие порты    |    Место назначения    |    Добавляет ли пакетная служба группы NSG?    |    Требуется для использования виртуальной машины?    |    Действие пользователя    |
  |------------------------|-------------------|----------------------------|-------------------------------------|------------------------|
  |    443    |    Хранилище Azure    |    Нет    |    Да    |    При добавлении групп NSG убедитесь, что этот порт открыт для исходящего трафика.    |

   Также убедитесь, что конечная точка службы хранилища Azure может разрешаться на всех пользовательских DNS-серверах, используемых в виртуальной сети. В частности, должны разрешаться URL-адреса в формате `<account>.table.core.windows.net`, `<account>.queue.core.windows.net` и `<account>.blob.core.windows.net`. 

   При добавлении NSG на основе Resource Manager можно использовать [теги служб](../articles/virtual-network/security-overview.md#service-tags), чтобы выбрать выбора IP-адреса хранилищ для исходящих соединений в определенном регионе. Обратите внимание, что IP-адреса хранилищ должны быть в том же регионе, что и учетная запись пакетной службы, а также виртуальная сеть. В настоящее время в отдельных регионах Azure теги служб предоставляются в предварительной версии.
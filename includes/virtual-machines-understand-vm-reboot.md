Иногда виртуальные машины Azure могут перезапускаться без видимой причины и без явных признаков того, что вы инициировали операцию перезапуск. В этой статье описываются действия и события, которые могут привести к перезапуску виртуальной машины, и приведены сведения о том, как избежать непредвиденного перезапуска и уменьшить последствия такого сбоя.

## <a name="configure-the-vms-for-high-availability"></a>Настройка виртуальных машин для обеспечения высокой доступности
Чтобы защитить приложение, выполняющееся в Azure, от перезапуска и простоя виртуальных машин, настройте виртуальные машины для обеспечения высокой доступности.

Чтобы обеспечить такой уровень избыточности приложения, мы рекомендуем включить две или несколько виртуальных машин в группу доступности. Эта конфигурация обеспечит доступность не менее одной виртуальной машины и достижение показателя 99,95 % в соответствии с [соглашением об уровне обслуживания Azure](https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_5/) при событиях запланированного и незапланированного обслуживания.

Дополнительные сведения о группах доступности см. в следующих статьях.

- [Управление доступностью виртуальных машин Windows в Azure](../articles/virtual-machines/windows/manage-availability.md)
- [Как настроить группу доступности для виртуальных машин Windows в классической модели развертывания](../articles/virtual-machines/windows/classic/configure-availability.md)

## <a name="resource-health-information"></a>Сведения о работоспособности ресурсов 
Служба работоспособности ресурсов Azure определяет состояние работоспособности отдельных ресурсов Azure и предоставляет рекомендации по устранению проблем. В облачной среде, где невозможно получить прямой доступ к серверам или элементам инфраструктуры, цель службы работоспособности ресурсов — уменьшить время, затрачиваемое на устранение неполадок. Особенно важно сократить время на поиск источника проблемы. Это может быть приложение или событие внутри платформы Azure. Дополнительные сведения см. в статье [Обзор службы работоспособности ресурсов Azure](../articles/resource-health/resource-health-overview.md).

## <a name="actions-and-events-that-can-cause-the-vm-to-reboot"></a>Действия и события, которые могут привести к перезапуску виртуальной машины

### <a name="planned-maintenance"></a>Плановое техническое обслуживание
Microsoft Azure периодически выполняет обновления своих систем по всему миру, чтобы повысить надежность, производительность и безопасность инфраструктуры узлов, в которой работают виртуальные машины. Многие обновления, в том числе обновления с сохранением памяти, выполняются без последствий для виртуальных машин и облачных служб.

Однако некоторые обновления требуют перезагрузки. В этом случае работа виртуальной машины завершается на время внесения исправлений в инфраструктуру, после чего снова возобновляется.

Чтобы понять, что такое плановое обслуживание Azure и как оно влияет на доступность виртуальных машин Linux, рекомендуем ознакомиться со статьями ниже. Из них вы узнаете о процессе планового обслуживания Azure, а также о планировании такого обслуживания, чтобы снизить в дальнейшем последствия простоя.

- [Плановое обслуживание виртуальных машин Windows](../articles/virtual-machines/windows/planned-maintenance.md)
- [Как запланировать плановое обслуживание на виртуальных машинах Azure](../articles/virtual-machines/windows/classic/planned-maintenance-schedule.md)

### <a name="memory-preserving-updates"></a>Обновления с сохранением памяти   
При применении таких обновлений в Microsoft Azure клиенты не заметят никаких изменений в работе виртуальных машин. Многие из этих обновлений предназначены для компонентов или служб, которые могут обновляться без влияния на запущенный экземпляр. Некоторые из этих обновлений предназначены для инфраструктуры платформы в операционной системе сервера виртуальных машин, и их можно применять без перезагрузки этих машин.

Эти обновления с сохранением памяти выполняются с помощью технологии, позволяющей использовать динамическую миграцию на месте. На время обновления виртуальная машина переводится в состояние *Приостановлена*. Это состояние сохраняет память в ОЗУ, пока операционная система сервера виртуальных машин получает необходимые обновления и исправления. Виртуальная машина возобновляет работу в течение 30 секунд с момента приостановки. После возобновления работы часы виртуальной машины автоматически синхронизируются.

Поскольку пауза была недолгой, такое развертывание обновлений позволяет снизить риск изменений в работе виртуальных машин. Но не все обновления можно развернуть таким образом. 

Обновления для нескольких экземпляров (для виртуальных машин в группе доступности) применяются для одного домена обновления за раз.

> [!NOTE]
> При использовании этого метода обновления могут возникнуть неполадки в компьютерах Linux с устаревшими версиями ядер. Чтобы избежать этого, обновите ядра до версии 3.10.0-327.10.1 или более поздней. Дополнительные сведения о неполадках после обновления узла (для виртуальной машины Linux Azure с ядром 3.10) см. на [этой странице](https://support.microsoft.com/help/3212236).     
    
### <a name="user-initiated-reboot-or-shutdown-actions"></a>Перезапуск, инициированный пользователем, и действия по завершению работы
 
Если перезапуск выполняется с помощью портала Azure, Azure PowerShell, интерфейса командной строки или API сброса, вы можете найти это событие в [журнале действий Azure](../articles/monitoring-and-diagnostics/monitoring-overview-activity-logs.md).

Если вы выполняете это действие из операционной системы виртуальной машины, это событие можно найти в журналах системы.

Другие сценарии, которые вызывают перезапуск виртуальной машины, включают в себя несколько действий по изменению конфигураций. Обычно пользователь получает предупреждение о том, что выполнение определенных действий приведет к перезапуску виртуальной машины. Примеры этих действий включают операции по изменению размера виртуальной машины, изменение пароля учетной записи администратора, а также настройку статического IP-адреса.

### <a name="azure-security-center-and-windows-update"></a>Центр безопасности Azure и Центр обновления Windows
Центр безопасности Azure ежедневно проверяет наличие обновлений операционной системы для виртуальных машин Windows и Linux. Центр безопасности получает список доступных критических обновлений и обновлений для системы безопасности из Центра обновления Windows или служб Windows Server Update Services в зависимости от того, какая служба настроена для виртуальной машины Windows. Центр безопасности также проверяет наличие последних обновлений для систем Linux. Если на виртуальной машине отсутствует обновление системы, центр безопасности рекомендует его применить. Применение этих системных обновлений контролируется с помощью центра безопасности на портале Azure. После применения некоторых обновлений может потребоваться перезапуск виртуальной машины. Дополнительные сведения см. в статье [Применение обновлений системы в центре безопасности Azure](../articles/security-center/security-center-apply-system-updates.md).

Как и локальные серверы, Azure не передает обновления из Центра обновления Windows на виртуальные машины Windows Azure, так как предполагается, что этими машинами управляет пользователь. При этом рекомендуется оставить включенной функцию автоматического обновления Windows. Автоматическая установка обновлений из Центра обновления Windows также может привести к перезапуску после применения этих обновлений. Дополнительные сведения см. на странице [Центр обновления Windows: вопросы и ответы](https://support.microsoft.com/help/12373/windows-update-faq).

### <a name="other-situations-affecting-the-availability-of-your-vm"></a>Другие ситуации, влияющие на доступность виртуальной машины
Существуют и другие причины, по которым Azure может приостановить использование виртуальной машины. Прежде чем работа виртуальной машины будет приостановлена, пользователи получат уведомление по почте, что даст им возможность предотвратить это событие, устранив причины. Например, виртуальная машина может стать недоступной из-за нарушений безопасности или истечения срока действия способа оплаты.

### <a name="host-server-faults"></a>Ошибки сервера узла 
Виртуальная машина размещается на физическом сервере, который работает внутри центра обработки данных Azure. Кроме запуска нескольких других компонентов Azure, физический сервер запускает агент, который называется агентом узла. Когда эти программные компоненты Azure на физическом сервере перестают отвечать на запросы, система мониторинга инициирует перезагрузку сервера узла, чтобы выполнить восстановление. Обычно виртуальная машина становится доступной в течение пяти минут и продолжает работу на прежнем узле.

Ошибки сервера обычно вызываются сбоями оборудования, например сбоем жесткого диска или твердотельного накопителя. Azure постоянно отслеживает эти случаи, определяет основные ошибки и развертывает обновления после выполнения исправлений и тестирования.

Так как некоторые ошибки сервера узла могут возникать конкретно для этого сервера, в случае неоднократного перезапуска виртуальной машины ситуацию можно исправить, если заново развернуть машину на другом сервере узла. Эту операцию можно запустить с помощью параметра **повторного развертывания** на странице сведений виртуальной машины или с помощью остановки и перезапуска виртуальной машины на портале Azure.

### <a name="auto-recovery"></a>Автоматическое восстановление
Если сервер узла невозможно перезапустить по какой-либо причине, платформа Azure инициирует действие автоматического восстановления, чтобы прекратить использование неисправного сервера узла для его дальнейшего изучения. 

Все виртуальные машины на этом узле автоматически переносятся на другой работоспособный сервер узла. Этот процесс обычно занимает 15 минут. Дополнительные сведения об автоматическом восстановлении см. в [этой записи блога](https://azure.microsoft.com/blog/service-healing-auto-recovery-of-virtual-machines).

### <a name="unplanned-maintenance"></a>Внеплановое обслуживание
В редких случаях рабочей группе Azure может потребоваться выполнить действия по обслуживанию для обеспечения общей работоспособности платформы Azure. Это может повлиять на доступность виртуальных машин и обычно приводит к автоматическому восстановлению, описанному выше.  

Внеплановое обслуживание включает в себя следующие действия:

- срочную дефрагментацию узла;
- срочные обновления сетевого коммутатора.

### <a name="vm-crashes"></a>Сбои виртуальных машин
Виртуальные машины могут перезапускаться из-за проблем в самой виртуальной машине. Рабочая нагрузка или роль, выполняющаяся на виртуальной машине, может инициировать проверку на наличие ошибок в операционной системе этой машины. Чтобы определить причину сбоя, просмотрите журналы системы и приложений для виртуальных машин Windows и последовательные журналы для виртуальных машин Linux.

### <a name="storage-related-forced-shutdowns"></a>Принудительное завершение работы, связанное с хранилищем
Виртуальные машины в Azure используют виртуальные диски для операционной системы и хранилища данных, размещенного в инфраструктуре хранилища Azure. Каждый раз, когда доступ к виртуальным машинам невозможно получить в течение 120 секунд или когда подключение между ними и связанными виртуальными дисками отсутствует более двух минут, платформа Azure выполняет принудительное завершение работы виртуальных машин, чтобы избежать повреждения данных. Виртуальные машины автоматически включаются после восстановления подключения к хранилищу. 

Они могут находиться в состоянии завершения работы как пяти минут, так и намного дольше. Ниже приведен один из случаев принудительного завершения работы, связанного с хранилищем. 

**Превышение ограничения количества операций ввода-вывода**

Запросы на операции ввода-вывода последовательно регулируются на основе допустимых объемов, установленных для этих операций (в секунду). Если эти объемы превышают установленные ограничения для диска, виртуальные машины могут временно завершить работу. Стандартный дисковый накопитель ограничен 500 операциями ввода-вывода в секунду. Чтобы устранить эту проблему, используйте чередование дисков или настройте дисковое пространство внутри гостевой виртуальной машины в зависимости от рабочей нагрузки. Дополнительные сведения см. на странице [настройки виртуальных машин Azure для обеспечения оптимальной производительности хранилища](http://blogs.msdn.com/b/mast/archive/2014/10/14/configuring-azure-virtual-machines-for-optimal-storage-performance.aspx).

Более высокие пределы для операций ввода-вывода доступны для хранилища Azure класса Premium (до 80 000 операций ввода-вывода в секунду). Дополнительные сведения см. в статье [Высокопроизводительное хранилище класса Premium и управляемые диски для виртуальных машин Azure](../articles/virtual-machines/windows/premium-storage.md).

### <a name="other-incidents"></a>Другие инциденты
В редких случаях распространенная проблема может повлиять на несколько серверов в центре обработки данных Azure. В этом случае команда разработчиков Azure отправляет соответствующим подписчикам уведомления по почте. Используйте [панель мониторинга работоспособности службы Azure](https://azure.microsoft.com/status/) и портал Azure, чтобы узнать о возможных сбоях, а также просмотреть прошлые инциденты.

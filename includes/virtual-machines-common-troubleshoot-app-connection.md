Если вам не удалось запустить приложение, выполняющееся в виртуальной машине Azure, или подключиться к нему, это может быть обусловлено разными причинами. Возможно, приложение не работает или не прослушивает ожидаемые порты, прослушивающий порт заблокирован или сетевые правила неправильно передают трафик в приложение. В этой статье описываются методы поиска и устранения неисправностей.

Если у вас возникают проблемы при подключении к виртуальной машине по протоколу RDP или SSH, сначала ознакомьтесь с одной из следующих статей:

* [Устранение неполадок с подключением к удаленному рабочему столу виртуальной машины Windows в службе Azure](../articles/virtual-machines/windows/troubleshoot-rdp-connection.md)
* [Устранение неполадок с подключением Secure Shell (SSH) к виртуальной машине Azure под управлением Linux](../articles/virtual-machines/linux/troubleshoot-ssh-connection.md)

> [!NOTE]
> В Azure предлагаются две модели развертывания для создания ресурсов и работы с ними: [модель диспетчера ресурсов и классическая модель](../articles/resource-manager-deployment-model.md). В этой статье описывается использование обеих моделей, но для большинства новых развертываний корпорация Майкрософт рекомендует использовать модель диспетчера ресурсов.

Если вам потребуется дополнительная помощь по любому из вопросов, рассматриваемых в статье, вы можете обратиться к экспертам по Azure на [форумах MSDN Azure и Stack Overflow](https://azure.microsoft.com/support/forums/). Кроме того, можно зарегистрировать обращение в службу поддержки Azure. Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/) и щелкните **Получить поддержку**.

## <a name="quick-start-troubleshooting-steps"></a>Действия по устранению неполадок
Если у вас возникают проблемы с подключением к приложению, попробуйте выполнить приведенные ниже шаги по их устранению. После каждого шага попробуйте подключиться к приложению еще раз.

* Перезапустите виртуальную машину.
* Повторно создайте конечную точку, правила брандмауэра и правила группы безопасности сети.
  * [Используйте управление группами безопасности сети (модель Resource Manager).](../articles/virtual-network/virtual-networks-create-nsg-arm-pportal.md)
  * [Используйте управление конечными точками облачных служб (классическая модель).](../articles/cloud-services/cloud-services-enable-communication-role-instances.md)
* Подключитесь из другого расположения, например из другой виртуальной сети Azure.
* Повторно разверните виртуальную машину.
  * [Повторное развертывание виртуальной машины Windows](../articles/virtual-machines/windows/redeploy-to-new-node.md)
  * [Повторное развертывание виртуальной машины Linux](../articles/virtual-machines/linux/redeploy-to-new-node.md)
* Повторно создайте виртуальную машину.

Дополнительные сведения см. в статье [Устранение неполадок подключения к конечной точке (сбои RDP, SSH, HTTP и другие сбои)](https://social.msdn.microsoft.com/Forums/azure/en-US/538a8f18-7c1f-4d6e-b81c-70c00e25c93d/troubleshooting-endpoint-connectivity-rdpsshhttp-etc-failures?forum=WAVirtualMachinesforWindows).

## <a name="detailed-troubleshooting-overview"></a>Подробный обзор устранения неисправностей
Существуют четыре основных области для устранения неполадок доступа к приложению, которое выполняется в виртуальной машине Azure.

![устранение неполадок, не удается запустить приложение](./media/virtual-machines-common-troubleshoot-app-connection/tshoot_app_access1.png)

1. Приложение, которое выполняется в виртуальной машине Azure.
   * Приложение работает правильно?
2. Виртуальная машина Azure
   * Виртуальная машина работает правильно и отвечает на запросы?
3. Конечные точки сети Azure.
   * Конечные точки облачной службы для виртуальных машин в классической модели развертывания.
   * Группы безопасности сети и правила преобразования сетевых адресов для входящих подключений для виртуальных машин в модели развертывания Resource Manager.
   * Может ли трафик передаваться от пользователей к виртуальной машине и приложению на ожидаемых портах?
4. Пограничное устройство Интернета.
   * Нет ли правил брандмауэра, которые препятствуют правильной передаче трафика?

Для клиентских компьютеров, которые получают доступ к приложению через подключение VPN типа «сеть-сеть» или ExpressRoute, проблемы в первую очередь могут возникать из-за приложения и виртуальной машины Azure.

Чтобы определить источник проблемы и исправить ее, выполните приведенные ниже действия.

## <a name="step-1-access-application-from-target-vm"></a>Шаг 1. Доступ к приложению с целевой виртуальной машины
Попробуйте обратиться к приложению с помощью соответствующей клиентской программы из виртуальной машины, на которой оно работает. Используйте имя локального узла, локальный IP-адрес или петлевой адрес (127.0.0.1).

![запуск приложения непосредственно из виртуальной машины](./media/virtual-machines-common-troubleshoot-app-connection/tshoot_app_access2.png)

Например, если приложение является веб-сервером, откройте браузер на виртуальной машине и попытайтесь перейти к веб-странице, размещенной на виртуальной машине.

Если доступ к приложению есть, перейдите к [шагу 2](#step2).

Если доступ к приложению получить не удается, проверьте следующие настройки.

* Приложение выполняется в целевой виртуальной машине.
* Приложение прослушивает ожидаемые порты TCP и UDP.

В виртуальных машин на основе Windows и Linux используйте команду **netstat -a** , чтобы отобразить активные порты прослушивания. Изучите выходные данные для ожидаемых портов, которые должно прослушивать приложение. При необходимости перезапустите приложение или настройте его для использования ожидаемых портов и попытайтесь снова получить доступ к приложению локально.

## <a id="step2"></a>Шаг 2. Доступ к приложению с другой виртуальной машины в той же виртуальной сети
Попробуйте обратиться к приложению из другой виртуальной машины в той же виртуальной сети, используя имя узла виртуальной машины или ее назначенный в Azure общедоступный, частный или предоставленный поставщиком интернет-услуг IP-адрес. Для виртуальных машин, созданных с помощью классической модели развертывания, не используйте общедоступный IP-адрес облачной службы.

![запуск приложения из другой виртуальной машины](./media/virtual-machines-common-troubleshoot-app-connection/tshoot_app_access3.png)

Например, если приложение является веб-сервером, попробуйте обратиться к веб-странице из браузера в другой виртуальной машине из той же виртуальной сети.

Если у вас есть доступ к приложению, перейдите к [шагу 3](#step3).

Если доступ к приложению получить не удается, проверьте следующие настройки.

* Брандмауэр узла в целевой виртуальной машине пропускает трафик входящих запросов и исходящих ответов.
* Программы для обнаружения вторжений или мониторинга сети, работающие в целевой виртуальной машине, разрешают прохождение сетевого трафика.
* Конечные точки облачных служб и группы безопасности сети разрешают прохождение трафика.
  * [Используйте управление конечными точками облачных служб (классическая модель).](../articles/cloud-services/cloud-services-enable-communication-role-instances.md)
  * [Используйте управление группами безопасности сети (модель Resource Manager).](../articles/virtual-network/virtual-networks-create-nsg-arm-pportal.md)
* Отдельный компонент, выполняющийся в виртуальной сети на пути между тестовой виртуальной машиной и вашей виртуальной машиной, такой, как, например, подсистема балансировки нагрузки или брандмауэр, разрешает прохождение трафика.

На виртуальной машине под управлением Windows используйте брандмауэр Windows в режиме повышенной безопасности для определения того, исключают ли правила брандмауэра входящий и исходящий трафик вашего приложения.

## <a id="step3"></a>Шаг 3. Доступ к приложению из-за пределов виртуальной сети
Попытайтесь обратиться к приложению с компьютера за пределами виртуальной сети, где находится виртуальная машина, в которой выполняется приложение, но не из сети исходного клиентского компьютера.

![запуск приложения с компьютера за пределами виртуальной сети](./media/virtual-machines-common-troubleshoot-app-connection/tshoot_app_access4.png)

Например, если приложение является веб-сервером, попробуйте получить доступ к веб-странице из браузера на компьютере, который находится не в виртуальной сети.

Если доступ к приложению получить не удается, проверьте следующие настройки.

* Для виртуальных машин, созданных с использованием классической модели развертывания:
  
  * Убедитесь, что конфигурация конечной точки для виртуальной машины разрешает входящий трафик, в частности протокол (TCP или UDP), а также номера общедоступных и частных портов.
  * Убедитесь, что списки управления доступом (ACL) для конечной точки не блокируют входящий трафик из Интернета.
  * Дополнительные сведения см. в статье [Настройка конечных точек виртуальной машины](../articles/virtual-machines/windows/classic/setup-endpoints.md?toc=%2fazure%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json).
* Для виртуальных машин, созданных с использованием модели развертывания с помощью Resource Manager:
  
  * Убедитесь, что конфигурация правила NAT для входящего трафика для виртуальной машины разрешает входящий трафик, в частности протокол (TCP или UDP), а также номера общедоступных и частных портов.
  * Убедитесь, что группы безопасности сети разрешают трафик входящих запросов и исходящих ответов.
  * Дополнительные сведения см. в статье [Группа безопасности сети](../articles/virtual-network/virtual-networks-nsg.md).

Если виртуальная машина или конечная точка входит в комплект балансировки нагрузки, сделайте следующее.

* Проверьте правильность протокола зонда (TCP или UDP) и номера порта.
* Если протокол зонда и порт отличаются от протокола и порта для комплекта балансировки нагрузки, сделайте следующее.
  * Проверьте, прослушивает ли приложение протокол пробы (TCP или UDP) и порт с этим номером (используйте **netstat -a** на целевой виртуальной машине).
  * Убедитесь, что брандмауэр узла на целевой виртуальной машине разрешает трафик входящих запросов и исходящих ответов пробы.

Если у вас есть доступ к приложению, убедитесь, что пограничное устройство Интернета разрешает следующее:

* трафик исходящих запросов приложения с клиентского компьютера в виртуальную машину Azure;
* трафик входящих ответов приложения из виртуальной машины Azure.

## <a name="step-4-if-you-cannot-access-the-application-use-ip-verify-to-check-the-settings"></a>Шаг 4. Проверка параметров доступа к приложению с помощью командлета проверки IP-потока 

Дополнительные сведения см. в статье [Обзор мониторинга сети Azure](https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-monitoring-overview). 

## <a name="additional-resources"></a>Дополнительные ресурсы
[Устранение неполадок с подключением к удаленному рабочему столу виртуальной машины Windows в службе Azure](../articles/virtual-machines/windows/troubleshoot-rdp-connection.md)

[Устранение неполадок с подключением Secure Shell (SSH) к виртуальной машине Azure под управлением Linux](../articles/virtual-machines/linux/troubleshoot-ssh-connection.md)

